<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6347495">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6347550">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6347604">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6347655">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="6348062">package</span>&nbsp;<span class="ident" id="6348070">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6348076">import</span>&nbsp;<span class="op" id="6348083">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348086">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348095">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348104">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348123">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348133">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348140">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348146">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348159">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348166">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348183">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348194">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348205">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348213">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="6348223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6348226">var</span>&nbsp;<span class="ident" id="6348230">debug</span>&nbsp;<span class="op" id="6348236">=</span>&nbsp;<span class="ident" id="6348238">debugT</span><span class="op" id="6348244">(</span><span class="builtintype" id="6348245">false</span><span class="op" id="6348250">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="6348253">type</span>&nbsp;<span class="ident" id="6348258">debugT</span>&nbsp;<span class="builtintype" id="6348265">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6348271">func</span>&nbsp;<span class="op" id="6348276">(</span><span class="ident" id="6348277">d</span>&nbsp;<span class="ident" id="6348279">debugT</span><span class="op" id="6348285">)</span>&nbsp;<span class="ident" id="6348287">Printf</span><span class="op" id="6348293">(</span><span class="ident" id="6348294">format</span>&nbsp;<span class="builtintype" id="6348301">string</span><span class="op" id="6348307">,</span>&nbsp;<span class="ident" id="6348309">args</span>&nbsp;<span class="op" id="6348314">...</span><span class="keyword" id="6348317">interface</span><span class="op" id="6348326">{</span><span class="op" id="6348327">}</span><span class="op" id="6348328">)</span>&nbsp;<span class="op" id="6348330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6348333">if</span>&nbsp;<span class="ident" id="6348336">d</span>&nbsp;<span class="op" id="6348338">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6348342">log</span><span class="op" id="6348345">.</span><span class="ident" id="6348346">Printf</span><span class="op" id="6348352">(</span><span class="ident" id="6348353">format</span><span class="op" id="6348359">,</span>&nbsp;<span class="ident" id="6348361">args</span><span class="op" id="6348365">...</span><span class="op" id="6348368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6348371">}</span><br>
<span class="lineno"></span><span class="op" id="6348373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6348376">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="6348423">type</span>&nbsp;<span class="ident" id="6348428">Message</span>&nbsp;<span class="keyword" id="6348436">struct</span>&nbsp;<span class="op" id="6348443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6348446">Header</span>&nbsp;<span class="ident" id="6348453">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6348461">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6348468">io</span><span class="op" id="6348470">.</span><span class="ident" id="6348471">Reader</span><br>
<span class="lineno"></span><span class="op" id="6348478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="6348481">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="6348520">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="6348593">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="6348616">func</span>&nbsp;<span class="ident" id="6348621">ReadMessage</span><span class="op" id="6348632">(</span><span class="ident" id="6348633">r</span>&nbsp;<span class="ident" id="6348635">io</span><span class="op" id="6348637">.</span><span class="ident" id="6348638">Reader</span><span class="op" id="6348644">)</span>&nbsp;<span class="op" id="6348646">(</span><span class="ident" id="6348647">msg</span>&nbsp;<span class="op" id="6348651">*</span><span class="ident" id="6348652">Message</span><span class="op" id="6348659">,</span>&nbsp;<span class="ident" id="6348661">err</span>&nbsp;<span class="builtintype" id="6348665">error</span><span class="op" id="6348670">)</span>&nbsp;<span class="op" id="6348672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6348675">tp</span>&nbsp;<span class="op" id="6348678">:=</span>&nbsp;<span class="ident" id="6348681">textproto</span><span class="op" id="6348690">.</span><span class="ident" id="6348691">NewReader</span><span class="op" id="6348700">(</span><span class="ident" id="6348701">bufio</span><span class="op" id="6348706">.</span><span class="ident" id="6348707">NewReader</span><span class="op" id="6348716">(</span><span class="ident" id="6348717">r</span><span class="op" id="6348718">)</span><span class="op" id="6348719">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6348723">hdr</span><span class="op" id="6348726">,</span>&nbsp;<span class="ident" id="6348728">err</span>&nbsp;<span class="op" id="6348732">:=</span>&nbsp;<span class="ident" id="6348735">tp</span><span class="op" id="6348737">.</span><span class="ident" id="6348738">ReadMIMEHeader</span><span class="op" id="6348752">(</span><span class="op" id="6348753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6348756">if</span>&nbsp;<span class="ident" id="6348759">err</span>&nbsp;<span class="op" id="6348763">!=</span>&nbsp;<span class="ident" id="6348766">nil</span>&nbsp;<span class="op" id="6348770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6348774">return</span>&nbsp;<span class="ident" id="6348781">nil</span><span class="op" id="6348784">,</span>&nbsp;<span class="ident" id="6348786">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6348791">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6348795">return</span>&nbsp;<span class="op" id="6348802">&amp;</span><span class="ident" id="6348803">Message</span><span class="op" id="6348810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6348814">Header</span><span class="op" id="6348820">:</span>&nbsp;<span class="ident" id="6348822">Header</span><span class="op" id="6348828">(</span><span class="ident" id="6348829">hdr</span><span class="op" id="6348832">)</span><span class="op" id="6348833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6348837">Body</span><span class="op" id="6348841">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6348845">tp</span><span class="op" id="6348847">.</span><span class="ident" id="6348848">R</span><span class="op" id="6348849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6348852">}</span><span class="op" id="6348853">,</span>&nbsp;<span class="ident" id="6348855">nil</span><br>
<span class="lineno">65</span><span class="op" id="6348859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6348862">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="6348909">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="6348938">var</span>&nbsp;<span class="ident" id="6348942">dateLayouts</span>&nbsp;<span class="op" id="6348954">[</span><span class="op" id="6348955">]</span><span class="builtintype" id="6348956">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="6348964">func</span>&nbsp;<span class="ident" id="6348969">init</span><span class="op" id="6348973">(</span><span class="op" id="6348974">)</span>&nbsp;<span class="op" id="6348976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6348979">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349033">dows</span>&nbsp;<span class="op" id="6349038">:=</span>&nbsp;<span class="op" id="6349041">[</span><span class="op" id="6349042">...</span><span class="op" id="6349045">]</span><span class="builtintype" id="6349046">string</span><span class="op" id="6349052">{</span><span class="string" id="6349053">&#34;&#34;</span><span class="op" id="6349055">,</span>&nbsp;<span class="string" id="6349057">&#34;Mon,&nbsp;&#34;</span><span class="op" id="6349064">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6349068">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349084">days</span>&nbsp;<span class="op" id="6349089">:=</span>&nbsp;<span class="op" id="6349092">[</span><span class="op" id="6349093">...</span><span class="op" id="6349096">]</span><span class="builtintype" id="6349097">string</span><span class="op" id="6349103">{</span><span class="string" id="6349104">&#34;2&#34;</span><span class="op" id="6349107">,</span>&nbsp;<span class="string" id="6349109">&#34;02&#34;</span><span class="op" id="6349113">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6349119">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349138">years</span>&nbsp;<span class="op" id="6349144">:=</span>&nbsp;<span class="op" id="6349147">[</span><span class="op" id="6349148">...</span><span class="op" id="6349151">]</span><span class="builtintype" id="6349152">string</span><span class="op" id="6349158">{</span><span class="string" id="6349159">&#34;2006&#34;</span><span class="op" id="6349165">,</span>&nbsp;<span class="string" id="6349167">&#34;06&#34;</span><span class="op" id="6349171">}</span>&nbsp;<span class="comment" id="6349173">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349202">seconds</span>&nbsp;<span class="op" id="6349210">:=</span>&nbsp;<span class="op" id="6349213">[</span><span class="op" id="6349214">...</span><span class="op" id="6349217">]</span><span class="builtintype" id="6349218">string</span><span class="op" id="6349224">{</span><span class="string" id="6349225">&#34;:05&#34;</span><span class="op" id="6349230">,</span>&nbsp;<span class="string" id="6349232">&#34;&#34;</span><span class="op" id="6349234">}</span>&nbsp;&nbsp;<span class="comment" id="6349237">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349248">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349301">zones</span>&nbsp;<span class="op" id="6349307">:=</span>&nbsp;<span class="op" id="6349310">[</span><span class="op" id="6349311">...</span><span class="op" id="6349314">]</span><span class="builtintype" id="6349315">string</span><span class="op" id="6349321">{</span><span class="string" id="6349322">&#34;-0700&#34;</span><span class="op" id="6349329">,</span>&nbsp;<span class="string" id="6349331">&#34;MST&#34;</span><span class="op" id="6349336">,</span>&nbsp;<span class="string" id="6349338">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="6349351">}</span>&nbsp;<span class="comment" id="6349353">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349400">for</span>&nbsp;<span class="ident" id="6349404">_</span><span class="op" id="6349405">,</span>&nbsp;<span class="ident" id="6349407">dow</span>&nbsp;<span class="op" id="6349411">:=</span>&nbsp;<span class="keyword" id="6349414">range</span>&nbsp;<span class="ident" id="6349420">dows</span>&nbsp;<span class="op" id="6349425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349429">for</span>&nbsp;<span class="ident" id="6349433">_</span><span class="op" id="6349434">,</span>&nbsp;<span class="ident" id="6349436">day</span>&nbsp;<span class="op" id="6349440">:=</span>&nbsp;<span class="keyword" id="6349443">range</span>&nbsp;<span class="ident" id="6349449">days</span>&nbsp;<span class="op" id="6349454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349459">for</span>&nbsp;<span class="ident" id="6349463">_</span><span class="op" id="6349464">,</span>&nbsp;<span class="ident" id="6349466">year</span>&nbsp;<span class="op" id="6349471">:=</span>&nbsp;<span class="keyword" id="6349474">range</span>&nbsp;<span class="ident" id="6349480">years</span>&nbsp;<span class="op" id="6349486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349492">for</span>&nbsp;<span class="ident" id="6349496">_</span><span class="op" id="6349497">,</span>&nbsp;<span class="ident" id="6349499">second</span>&nbsp;<span class="op" id="6349506">:=</span>&nbsp;<span class="keyword" id="6349509">range</span>&nbsp;<span class="ident" id="6349515">seconds</span>&nbsp;<span class="op" id="6349523">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349530">for</span>&nbsp;<span class="ident" id="6349534">_</span><span class="op" id="6349535">,</span>&nbsp;<span class="ident" id="6349537">zone</span>&nbsp;<span class="op" id="6349542">:=</span>&nbsp;<span class="keyword" id="6349545">range</span>&nbsp;<span class="ident" id="6349551">zones</span>&nbsp;<span class="op" id="6349557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349565">s</span>&nbsp;<span class="op" id="6349567">:=</span>&nbsp;<span class="ident" id="6349570">dow</span>&nbsp;<span class="op" id="6349574">+</span>&nbsp;<span class="ident" id="6349576">day</span>&nbsp;<span class="op" id="6349580">+</span>&nbsp;<span class="string" id="6349582">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="6349590">+</span>&nbsp;<span class="ident" id="6349592">year</span>&nbsp;<span class="op" id="6349597">+</span>&nbsp;<span class="string" id="6349599">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="6349608">+</span>&nbsp;<span class="ident" id="6349610">second</span>&nbsp;<span class="op" id="6349617">+</span>&nbsp;<span class="string" id="6349619">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="6349623">+</span>&nbsp;<span class="ident" id="6349625">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349636">dateLayouts</span>&nbsp;<span class="op" id="6349648">=</span>&nbsp;<span class="builtinfunc" id="6349650">append</span><span class="op" id="6349656">(</span><span class="ident" id="6349657">dateLayouts</span><span class="op" id="6349668">,</span>&nbsp;<span class="ident" id="6349670">s</span><span class="op" id="6349671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6349678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6349684">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6349689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6349693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6349696">}</span><br>
<span class="lineno"></span><span class="op" id="6349698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6349701">func</span>&nbsp;<span class="ident" id="6349706">parseDate</span><span class="op" id="6349715">(</span><span class="ident" id="6349716">date</span>&nbsp;<span class="builtintype" id="6349721">string</span><span class="op" id="6349727">)</span>&nbsp;<span class="op" id="6349729">(</span><span class="ident" id="6349730">time</span><span class="op" id="6349734">.</span><span class="ident" id="6349735">Time</span><span class="op" id="6349739">,</span>&nbsp;<span class="builtintype" id="6349741">error</span><span class="op" id="6349746">)</span>&nbsp;<span class="op" id="6349748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349751">for</span>&nbsp;<span class="ident" id="6349755">_</span><span class="op" id="6349756">,</span>&nbsp;<span class="ident" id="6349758">layout</span>&nbsp;<span class="op" id="6349765">:=</span>&nbsp;<span class="keyword" id="6349768">range</span>&nbsp;<span class="ident" id="6349774">dateLayouts</span>&nbsp;<span class="op" id="6349786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349790">t</span><span class="op" id="6349791">,</span>&nbsp;<span class="ident" id="6349793">err</span>&nbsp;<span class="op" id="6349797">:=</span>&nbsp;<span class="ident" id="6349800">time</span><span class="op" id="6349804">.</span><span class="ident" id="6349805">Parse</span><span class="op" id="6349810">(</span><span class="ident" id="6349811">layout</span><span class="op" id="6349817">,</span>&nbsp;<span class="ident" id="6349819">date</span><span class="op" id="6349823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349827">if</span>&nbsp;<span class="ident" id="6349830">err</span>&nbsp;<span class="op" id="6349834">==</span>&nbsp;<span class="ident" id="6349837">nil</span>&nbsp;<span class="op" id="6349841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349846">return</span>&nbsp;<span class="ident" id="6349853">t</span><span class="op" id="6349854">,</span>&nbsp;<span class="ident" id="6349856">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6349862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6349865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6349868">return</span>&nbsp;<span class="ident" id="6349875">time</span><span class="op" id="6349879">.</span><span class="ident" id="6349880">Time</span><span class="op" id="6349884">{</span><span class="op" id="6349885">}</span><span class="op" id="6349886">,</span>&nbsp;<span class="ident" id="6349888">errors</span><span class="op" id="6349894">.</span><span class="ident" id="6349895">New</span><span class="op" id="6349898">(</span><span class="string" id="6349899">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="6349933">)</span><br>
<span class="lineno"></span><span class="op" id="6349935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="6349938">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6350007">type</span>&nbsp;<span class="ident" id="6350012">Header</span>&nbsp;<span class="keyword" id="6350019">map</span><span class="op" id="6350022">[</span><span class="builtintype" id="6350023">string</span><span class="op" id="6350029">]</span><span class="op" id="6350030">[</span><span class="op" id="6350031">]</span><span class="builtintype" id="6350032">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6350040">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="6350099">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="6350166">func</span>&nbsp;<span class="op" id="6350171">(</span><span class="ident" id="6350172">h</span>&nbsp;<span class="ident" id="6350174">Header</span><span class="op" id="6350180">)</span>&nbsp;<span class="ident" id="6350182">Get</span><span class="op" id="6350185">(</span><span class="ident" id="6350186">key</span>&nbsp;<span class="builtintype" id="6350190">string</span><span class="op" id="6350196">)</span>&nbsp;<span class="builtintype" id="6350198">string</span>&nbsp;<span class="op" id="6350205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350208">return</span>&nbsp;<span class="ident" id="6350215">textproto</span><span class="op" id="6350224">.</span><span class="ident" id="6350225">MIMEHeader</span><span class="op" id="6350235">(</span><span class="ident" id="6350236">h</span><span class="op" id="6350237">)</span><span class="op" id="6350238">.</span><span class="ident" id="6350239">Get</span><span class="op" id="6350242">(</span><span class="ident" id="6350243">key</span><span class="op" id="6350246">)</span><br>
<span class="lineno"></span><span class="op" id="6350248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6350251">var</span>&nbsp;<span class="ident" id="6350255">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="6350275">=</span>&nbsp;<span class="ident" id="6350277">errors</span><span class="op" id="6350283">.</span><span class="ident" id="6350284">New</span><span class="op" id="6350287">(</span><span class="string" id="6350288">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="6350317">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6350320">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="6350358">func</span>&nbsp;<span class="op" id="6350363">(</span><span class="ident" id="6350364">h</span>&nbsp;<span class="ident" id="6350366">Header</span><span class="op" id="6350372">)</span>&nbsp;<span class="ident" id="6350374">Date</span><span class="op" id="6350378">(</span><span class="op" id="6350379">)</span>&nbsp;<span class="op" id="6350381">(</span><span class="ident" id="6350382">time</span><span class="op" id="6350386">.</span><span class="ident" id="6350387">Time</span><span class="op" id="6350391">,</span>&nbsp;<span class="builtintype" id="6350393">error</span><span class="op" id="6350398">)</span>&nbsp;<span class="op" id="6350400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350403">hdr</span>&nbsp;<span class="op" id="6350407">:=</span>&nbsp;<span class="ident" id="6350410">h</span><span class="op" id="6350411">.</span><span class="ident" id="6350412">Get</span><span class="op" id="6350415">(</span><span class="string" id="6350416">&#34;Date&#34;</span><span class="op" id="6350422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350425">if</span>&nbsp;<span class="ident" id="6350428">hdr</span>&nbsp;<span class="op" id="6350432">==</span>&nbsp;<span class="string" id="6350435">&#34;&#34;</span>&nbsp;<span class="op" id="6350438">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350442">return</span>&nbsp;<span class="ident" id="6350449">time</span><span class="op" id="6350453">.</span><span class="ident" id="6350454">Time</span><span class="op" id="6350458">{</span><span class="op" id="6350459">}</span><span class="op" id="6350460">,</span>&nbsp;<span class="ident" id="6350462">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350486">return</span>&nbsp;<span class="ident" id="6350493">parseDate</span><span class="op" id="6350502">(</span><span class="ident" id="6350503">hdr</span><span class="op" id="6350506">)</span><br>
<span class="lineno"></span><span class="op" id="6350508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="6350511">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="6350580">func</span>&nbsp;<span class="op" id="6350585">(</span><span class="ident" id="6350586">h</span>&nbsp;<span class="ident" id="6350588">Header</span><span class="op" id="6350594">)</span>&nbsp;<span class="ident" id="6350596">AddressList</span><span class="op" id="6350607">(</span><span class="ident" id="6350608">key</span>&nbsp;<span class="builtintype" id="6350612">string</span><span class="op" id="6350618">)</span>&nbsp;<span class="op" id="6350620">(</span><span class="op" id="6350621">[</span><span class="op" id="6350622">]</span><span class="op" id="6350623">*</span><span class="ident" id="6350624">Address</span><span class="op" id="6350631">,</span>&nbsp;<span class="builtintype" id="6350633">error</span><span class="op" id="6350638">)</span>&nbsp;<span class="op" id="6350640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350643">hdr</span>&nbsp;<span class="op" id="6350647">:=</span>&nbsp;<span class="ident" id="6350650">h</span><span class="op" id="6350651">.</span><span class="ident" id="6350652">Get</span><span class="op" id="6350655">(</span><span class="ident" id="6350656">key</span><span class="op" id="6350659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350662">if</span>&nbsp;<span class="ident" id="6350665">hdr</span>&nbsp;<span class="op" id="6350669">==</span>&nbsp;<span class="string" id="6350672">&#34;&#34;</span>&nbsp;<span class="op" id="6350675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350679">return</span>&nbsp;<span class="ident" id="6350686">nil</span><span class="op" id="6350689">,</span>&nbsp;<span class="ident" id="6350691">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350715">return</span>&nbsp;<span class="ident" id="6350722">ParseAddressList</span><span class="op" id="6350738">(</span><span class="ident" id="6350739">hdr</span><span class="op" id="6350742">)</span><br>
<span class="lineno"></span><span class="op" id="6350744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6350747">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="6350792">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="6350860">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="6350923">type</span>&nbsp;<span class="ident" id="6350928">Address</span>&nbsp;<span class="keyword" id="6350936">struct</span>&nbsp;<span class="op" id="6350943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350946">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6350954">string</span>&nbsp;<span class="comment" id="6350961">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350992">Address</span>&nbsp;<span class="builtintype" id="6351000">string</span>&nbsp;<span class="comment" id="6351007">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="6351022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6351025">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="6351098">func</span>&nbsp;<span class="ident" id="6351103">ParseAddress</span><span class="op" id="6351115">(</span><span class="ident" id="6351116">address</span>&nbsp;<span class="builtintype" id="6351124">string</span><span class="op" id="6351130">)</span>&nbsp;<span class="op" id="6351132">(</span><span class="op" id="6351133">*</span><span class="ident" id="6351134">Address</span><span class="op" id="6351141">,</span>&nbsp;<span class="builtintype" id="6351143">error</span><span class="op" id="6351148">)</span>&nbsp;<span class="op" id="6351150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351153">return</span>&nbsp;<span class="ident" id="6351160">newAddrParser</span><span class="op" id="6351173">(</span><span class="ident" id="6351174">address</span><span class="op" id="6351181">)</span><span class="op" id="6351182">.</span><span class="ident" id="6351183">parseAddress</span><span class="op" id="6351195">(</span><span class="op" id="6351196">)</span><br>
<span class="lineno">145</span><span class="op" id="6351198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6351201">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="6351269">func</span>&nbsp;<span class="ident" id="6351274">ParseAddressList</span><span class="op" id="6351290">(</span><span class="ident" id="6351291">list</span>&nbsp;<span class="builtintype" id="6351296">string</span><span class="op" id="6351302">)</span>&nbsp;<span class="op" id="6351304">(</span><span class="op" id="6351305">[</span><span class="op" id="6351306">]</span><span class="op" id="6351307">*</span><span class="ident" id="6351308">Address</span><span class="op" id="6351315">,</span>&nbsp;<span class="builtintype" id="6351317">error</span><span class="op" id="6351322">)</span>&nbsp;<span class="op" id="6351324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351327">return</span>&nbsp;<span class="ident" id="6351334">newAddrParser</span><span class="op" id="6351347">(</span><span class="ident" id="6351348">list</span><span class="op" id="6351352">)</span><span class="op" id="6351353">.</span><span class="ident" id="6351354">parseAddressList</span><span class="op" id="6351370">(</span><span class="op" id="6351371">)</span><br>
<span class="lineno">150</span><span class="op" id="6351373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6351376">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="6351435">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="6351490">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="6351542">func</span>&nbsp;<span class="op" id="6351547">(</span><span class="ident" id="6351548">a</span>&nbsp;<span class="op" id="6351550">*</span><span class="ident" id="6351551">Address</span><span class="op" id="6351558">)</span>&nbsp;<span class="ident" id="6351560">String</span><span class="op" id="6351566">(</span><span class="op" id="6351567">)</span>&nbsp;<span class="builtintype" id="6351569">string</span>&nbsp;<span class="op" id="6351576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351579">s</span>&nbsp;<span class="op" id="6351581">:=</span>&nbsp;<span class="string" id="6351584">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="6351588">+</span>&nbsp;<span class="ident" id="6351590">a</span><span class="op" id="6351591">.</span><span class="ident" id="6351592">Address</span>&nbsp;<span class="op" id="6351600">+</span>&nbsp;<span class="string" id="6351602">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351607">if</span>&nbsp;<span class="ident" id="6351610">a</span><span class="op" id="6351611">.</span><span class="ident" id="6351612">Name</span>&nbsp;<span class="op" id="6351617">==</span>&nbsp;<span class="string" id="6351620">&#34;&#34;</span>&nbsp;<span class="op" id="6351623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351627">return</span>&nbsp;<span class="ident" id="6351634">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351637">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6351640">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351702">allPrintable</span>&nbsp;<span class="op" id="6351715">:=</span>&nbsp;<span class="builtintype" id="6351718">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351724">for</span>&nbsp;<span class="ident" id="6351728">i</span>&nbsp;<span class="op" id="6351730">:=</span>&nbsp;<span class="num" id="6351733">0</span><span class="op" id="6351734">;</span>&nbsp;<span class="ident" id="6351736">i</span>&nbsp;<span class="op" id="6351738">&lt;</span>&nbsp;<span class="builtinfunc" id="6351740">len</span><span class="op" id="6351743">(</span><span class="ident" id="6351744">a</span><span class="op" id="6351745">.</span><span class="ident" id="6351746">Name</span><span class="op" id="6351750">)</span><span class="op" id="6351751">;</span>&nbsp;<span class="ident" id="6351753">i</span><span class="op" id="6351754">++</span>&nbsp;<span class="op" id="6351757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6351761">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6351803">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351842">if</span>&nbsp;<span class="op" id="6351845">!</span><span class="ident" id="6351846">isVchar</span><span class="op" id="6351853">(</span><span class="ident" id="6351854">a</span><span class="op" id="6351855">.</span><span class="ident" id="6351856">Name</span><span class="op" id="6351860">[</span><span class="ident" id="6351861">i</span><span class="op" id="6351862">]</span><span class="op" id="6351863">)</span>&nbsp;<span class="op" id="6351865">&amp;&amp;</span>&nbsp;<span class="op" id="6351868">!</span><span class="ident" id="6351869">isWSP</span><span class="op" id="6351874">(</span><span class="ident" id="6351875">a</span><span class="op" id="6351876">.</span><span class="ident" id="6351877">Name</span><span class="op" id="6351881">[</span><span class="ident" id="6351882">i</span><span class="op" id="6351883">]</span><span class="op" id="6351884">)</span>&nbsp;<span class="op" id="6351886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351891">allPrintable</span>&nbsp;<span class="op" id="6351904">=</span>&nbsp;<span class="builtintype" id="6351906">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351915">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351926">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351929">if</span>&nbsp;<span class="ident" id="6351932">allPrintable</span>&nbsp;<span class="op" id="6351945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351949">b</span>&nbsp;<span class="op" id="6351951">:=</span>&nbsp;<span class="ident" id="6351954">bytes</span><span class="op" id="6351959">.</span><span class="ident" id="6351960">NewBufferString</span><span class="op" id="6351975">(</span><span class="string" id="6351976">`&#34;`</span><span class="op" id="6351979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351983">for</span>&nbsp;<span class="ident" id="6351987">i</span>&nbsp;<span class="op" id="6351989">:=</span>&nbsp;<span class="num" id="6351992">0</span><span class="op" id="6351993">;</span>&nbsp;<span class="ident" id="6351995">i</span>&nbsp;<span class="op" id="6351997">&lt;</span>&nbsp;<span class="builtinfunc" id="6351999">len</span><span class="op" id="6352002">(</span><span class="ident" id="6352003">a</span><span class="op" id="6352004">.</span><span class="ident" id="6352005">Name</span><span class="op" id="6352009">)</span><span class="op" id="6352010">;</span>&nbsp;<span class="ident" id="6352012">i</span><span class="op" id="6352013">++</span>&nbsp;<span class="op" id="6352016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352021">if</span>&nbsp;<span class="op" id="6352024">!</span><span class="ident" id="6352025">isQtext</span><span class="op" id="6352032">(</span><span class="ident" id="6352033">a</span><span class="op" id="6352034">.</span><span class="ident" id="6352035">Name</span><span class="op" id="6352039">[</span><span class="ident" id="6352040">i</span><span class="op" id="6352041">]</span><span class="op" id="6352042">)</span>&nbsp;<span class="op" id="6352044">&amp;&amp;</span>&nbsp;<span class="op" id="6352047">!</span><span class="ident" id="6352048">isWSP</span><span class="op" id="6352053">(</span><span class="ident" id="6352054">a</span><span class="op" id="6352055">.</span><span class="ident" id="6352056">Name</span><span class="op" id="6352060">[</span><span class="ident" id="6352061">i</span><span class="op" id="6352062">]</span><span class="op" id="6352063">)</span>&nbsp;<span class="op" id="6352065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352071">b</span><span class="op" id="6352072">.</span><span class="ident" id="6352073">WriteByte</span><span class="op" id="6352082">(</span><span class="string" id="6352083">&#39;\\&#39;</span><span class="op" id="6352087">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352097">b</span><span class="op" id="6352098">.</span><span class="ident" id="6352099">WriteByte</span><span class="op" id="6352108">(</span><span class="ident" id="6352109">a</span><span class="op" id="6352110">.</span><span class="ident" id="6352111">Name</span><span class="op" id="6352115">[</span><span class="ident" id="6352116">i</span><span class="op" id="6352117">]</span><span class="op" id="6352118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352126">b</span><span class="op" id="6352127">.</span><span class="ident" id="6352128">WriteString</span><span class="op" id="6352139">(</span><span class="string" id="6352140">`&#34;&nbsp;`</span><span class="op" id="6352144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352148">b</span><span class="op" id="6352149">.</span><span class="ident" id="6352150">WriteString</span><span class="op" id="6352161">(</span><span class="ident" id="6352162">s</span><span class="op" id="6352163">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352167">return</span>&nbsp;<span class="ident" id="6352174">b</span><span class="op" id="6352175">.</span><span class="ident" id="6352176">String</span><span class="op" id="6352182">(</span><span class="op" id="6352183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6352190">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352213">b</span>&nbsp;<span class="op" id="6352215">:=</span>&nbsp;<span class="ident" id="6352218">bytes</span><span class="op" id="6352223">.</span><span class="ident" id="6352224">NewBufferString</span><span class="op" id="6352239">(</span><span class="string" id="6352240">&#34;=?utf-8?q?&#34;</span><span class="op" id="6352252">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352255">for</span>&nbsp;<span class="ident" id="6352259">i</span>&nbsp;<span class="op" id="6352261">:=</span>&nbsp;<span class="num" id="6352264">0</span><span class="op" id="6352265">;</span>&nbsp;<span class="ident" id="6352267">i</span>&nbsp;<span class="op" id="6352269">&lt;</span>&nbsp;<span class="builtinfunc" id="6352271">len</span><span class="op" id="6352274">(</span><span class="ident" id="6352275">a</span><span class="op" id="6352276">.</span><span class="ident" id="6352277">Name</span><span class="op" id="6352281">)</span><span class="op" id="6352282">;</span>&nbsp;<span class="ident" id="6352284">i</span><span class="op" id="6352285">++</span>&nbsp;<span class="op" id="6352288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352292">switch</span>&nbsp;<span class="ident" id="6352299">c</span>&nbsp;<span class="op" id="6352301">:=</span>&nbsp;<span class="ident" id="6352304">a</span><span class="op" id="6352305">.</span><span class="ident" id="6352306">Name</span><span class="op" id="6352310">[</span><span class="ident" id="6352311">i</span><span class="op" id="6352312">]</span><span class="op" id="6352313">;</span>&nbsp;<span class="op" id="6352315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352319">case</span>&nbsp;<span class="ident" id="6352324">c</span>&nbsp;<span class="op" id="6352326">==</span>&nbsp;<span class="string" id="6352329">&#39;&nbsp;&#39;</span><span class="op" id="6352332">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352337">b</span><span class="op" id="6352338">.</span><span class="ident" id="6352339">WriteByte</span><span class="op" id="6352348">(</span><span class="string" id="6352349">&#39;_&#39;</span><span class="op" id="6352352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352356">case</span>&nbsp;<span class="ident" id="6352361">isVchar</span><span class="op" id="6352368">(</span><span class="ident" id="6352369">c</span><span class="op" id="6352370">)</span>&nbsp;<span class="op" id="6352372">&amp;&amp;</span>&nbsp;<span class="ident" id="6352375">c</span>&nbsp;<span class="op" id="6352377">!=</span>&nbsp;<span class="string" id="6352380">&#39;=&#39;</span>&nbsp;<span class="op" id="6352384">&amp;&amp;</span>&nbsp;<span class="ident" id="6352387">c</span>&nbsp;<span class="op" id="6352389">!=</span>&nbsp;<span class="string" id="6352392">&#39;?&#39;</span>&nbsp;<span class="op" id="6352396">&amp;&amp;</span>&nbsp;<span class="ident" id="6352399">c</span>&nbsp;<span class="op" id="6352401">!=</span>&nbsp;<span class="string" id="6352404">&#39;_&#39;</span><span class="op" id="6352407">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352412">b</span><span class="op" id="6352413">.</span><span class="ident" id="6352414">WriteByte</span><span class="op" id="6352423">(</span><span class="ident" id="6352424">c</span><span class="op" id="6352425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352429">default</span><span class="op" id="6352436">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352441">fmt</span><span class="op" id="6352444">.</span><span class="ident" id="6352445">Fprintf</span><span class="op" id="6352452">(</span><span class="ident" id="6352453">b</span><span class="op" id="6352454">,</span>&nbsp;<span class="string" id="6352456">&#34;=%02X&#34;</span><span class="op" id="6352463">,</span>&nbsp;<span class="ident" id="6352465">c</span><span class="op" id="6352466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352473">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352476">b</span><span class="op" id="6352477">.</span><span class="ident" id="6352478">WriteString</span><span class="op" id="6352489">(</span><span class="string" id="6352490">&#34;?=&nbsp;&#34;</span><span class="op" id="6352495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352498">b</span><span class="op" id="6352499">.</span><span class="ident" id="6352500">WriteString</span><span class="op" id="6352511">(</span><span class="ident" id="6352512">s</span><span class="op" id="6352513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352516">return</span>&nbsp;<span class="ident" id="6352523">b</span><span class="op" id="6352524">.</span><span class="ident" id="6352525">String</span><span class="op" id="6352531">(</span><span class="op" id="6352532">)</span><br>
<span class="lineno"></span><span class="op" id="6352534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="6352537">type</span>&nbsp;<span class="ident" id="6352542">addrParser</span>&nbsp;<span class="op" id="6352553">[</span><span class="op" id="6352554">]</span><span class="builtintype" id="6352555">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6352561">func</span>&nbsp;<span class="ident" id="6352566">newAddrParser</span><span class="op" id="6352579">(</span><span class="ident" id="6352580">s</span>&nbsp;<span class="builtintype" id="6352582">string</span><span class="op" id="6352588">)</span>&nbsp;<span class="op" id="6352590">*</span><span class="ident" id="6352591">addrParser</span>&nbsp;<span class="op" id="6352602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352605">p</span>&nbsp;<span class="op" id="6352607">:=</span>&nbsp;<span class="ident" id="6352610">addrParser</span><span class="op" id="6352620">(</span><span class="ident" id="6352621">s</span><span class="op" id="6352622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352625">return</span>&nbsp;<span class="op" id="6352632">&amp;</span><span class="ident" id="6352633">p</span><br>
<span class="lineno">205</span><span class="op" id="6352635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6352638">func</span>&nbsp;<span class="op" id="6352643">(</span><span class="ident" id="6352644">p</span>&nbsp;<span class="op" id="6352646">*</span><span class="ident" id="6352647">addrParser</span><span class="op" id="6352657">)</span>&nbsp;<span class="ident" id="6352659">parseAddressList</span><span class="op" id="6352675">(</span><span class="op" id="6352676">)</span>&nbsp;<span class="op" id="6352678">(</span><span class="op" id="6352679">[</span><span class="op" id="6352680">]</span><span class="op" id="6352681">*</span><span class="ident" id="6352682">Address</span><span class="op" id="6352689">,</span>&nbsp;<span class="builtintype" id="6352691">error</span><span class="op" id="6352696">)</span>&nbsp;<span class="op" id="6352698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352701">var</span>&nbsp;<span class="ident" id="6352705">list</span>&nbsp;<span class="op" id="6352710">[</span><span class="op" id="6352711">]</span><span class="op" id="6352712">*</span><span class="ident" id="6352713">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352722">for</span>&nbsp;<span class="op" id="6352726">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352730">p</span><span class="op" id="6352731">.</span><span class="ident" id="6352732">skipSpace</span><span class="op" id="6352741">(</span><span class="op" id="6352742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352746">addr</span><span class="op" id="6352750">,</span>&nbsp;<span class="ident" id="6352752">err</span>&nbsp;<span class="op" id="6352756">:=</span>&nbsp;<span class="ident" id="6352759">p</span><span class="op" id="6352760">.</span><span class="ident" id="6352761">parseAddress</span><span class="op" id="6352773">(</span><span class="op" id="6352774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352778">if</span>&nbsp;<span class="ident" id="6352781">err</span>&nbsp;<span class="op" id="6352785">!=</span>&nbsp;<span class="ident" id="6352788">nil</span>&nbsp;<span class="op" id="6352792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352797">return</span>&nbsp;<span class="ident" id="6352804">nil</span><span class="op" id="6352807">,</span>&nbsp;<span class="ident" id="6352809">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352815">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352819">list</span>&nbsp;<span class="op" id="6352824">=</span>&nbsp;<span class="builtinfunc" id="6352826">append</span><span class="op" id="6352832">(</span><span class="ident" id="6352833">list</span><span class="op" id="6352837">,</span>&nbsp;<span class="ident" id="6352839">addr</span><span class="op" id="6352843">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352848">p</span><span class="op" id="6352849">.</span><span class="ident" id="6352850">skipSpace</span><span class="op" id="6352859">(</span><span class="op" id="6352860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352864">if</span>&nbsp;<span class="ident" id="6352867">p</span><span class="op" id="6352868">.</span><span class="ident" id="6352869">empty</span><span class="op" id="6352874">(</span><span class="op" id="6352875">)</span>&nbsp;<span class="op" id="6352877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352882">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352894">if</span>&nbsp;<span class="op" id="6352897">!</span><span class="ident" id="6352898">p</span><span class="op" id="6352899">.</span><span class="ident" id="6352900">consume</span><span class="op" id="6352907">(</span><span class="string" id="6352908">&#39;,&#39;</span><span class="op" id="6352911">)</span>&nbsp;<span class="op" id="6352913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352918">return</span>&nbsp;<span class="ident" id="6352925">nil</span><span class="op" id="6352928">,</span>&nbsp;<span class="ident" id="6352930">errors</span><span class="op" id="6352936">.</span><span class="ident" id="6352937">New</span><span class="op" id="6352940">(</span><span class="string" id="6352941">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="6352963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352970">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352973">return</span>&nbsp;<span class="ident" id="6352980">list</span><span class="op" id="6352984">,</span>&nbsp;<span class="ident" id="6352986">nil</span><br>
<span class="lineno"></span><span class="op" id="6352990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6352993">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6353061">func</span>&nbsp;<span class="op" id="6353066">(</span><span class="ident" id="6353067">p</span>&nbsp;<span class="op" id="6353069">*</span><span class="ident" id="6353070">addrParser</span><span class="op" id="6353080">)</span>&nbsp;<span class="ident" id="6353082">parseAddress</span><span class="op" id="6353094">(</span><span class="op" id="6353095">)</span>&nbsp;<span class="op" id="6353097">(</span><span class="ident" id="6353098">addr</span>&nbsp;<span class="op" id="6353103">*</span><span class="ident" id="6353104">Address</span><span class="op" id="6353111">,</span>&nbsp;<span class="ident" id="6353113">err</span>&nbsp;<span class="builtintype" id="6353117">error</span><span class="op" id="6353122">)</span>&nbsp;<span class="op" id="6353124">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353127">debug</span><span class="op" id="6353132">.</span><span class="ident" id="6353133">Printf</span><span class="op" id="6353139">(</span><span class="string" id="6353140">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="6353158">,</span>&nbsp;<span class="op" id="6353160">*</span><span class="ident" id="6353161">p</span><span class="op" id="6353162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353165">p</span><span class="op" id="6353166">.</span><span class="ident" id="6353167">skipSpace</span><span class="op" id="6353176">(</span><span class="op" id="6353177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353180">if</span>&nbsp;<span class="ident" id="6353183">p</span><span class="op" id="6353184">.</span><span class="ident" id="6353185">empty</span><span class="op" id="6353190">(</span><span class="op" id="6353191">)</span>&nbsp;<span class="op" id="6353193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353197">return</span>&nbsp;<span class="ident" id="6353204">nil</span><span class="op" id="6353207">,</span>&nbsp;<span class="ident" id="6353209">errors</span><span class="op" id="6353215">.</span><span class="ident" id="6353216">New</span><span class="op" id="6353219">(</span><span class="string" id="6353220">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="6353238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353241">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353245">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353281">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353333">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353393">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353449">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353493">spec</span><span class="op" id="6353497">,</span>&nbsp;<span class="ident" id="6353499">err</span>&nbsp;<span class="op" id="6353503">:=</span>&nbsp;<span class="ident" id="6353506">p</span><span class="op" id="6353507">.</span><span class="ident" id="6353508">consumeAddrSpec</span><span class="op" id="6353523">(</span><span class="op" id="6353524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353527">if</span>&nbsp;<span class="ident" id="6353530">err</span>&nbsp;<span class="op" id="6353534">==</span>&nbsp;<span class="ident" id="6353537">nil</span>&nbsp;<span class="op" id="6353541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353545">return</span>&nbsp;<span class="op" id="6353552">&amp;</span><span class="ident" id="6353553">Address</span><span class="op" id="6353560">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353565">Address</span><span class="op" id="6353572">:</span>&nbsp;<span class="ident" id="6353574">spec</span><span class="op" id="6353578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353582">}</span><span class="op" id="6353583">,</span>&nbsp;<span class="ident" id="6353585">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353593">debug</span><span class="op" id="6353598">.</span><span class="ident" id="6353599">Printf</span><span class="op" id="6353605">(</span><span class="string" id="6353606">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="6353642">,</span>&nbsp;<span class="ident" id="6353644">err</span><span class="op" id="6353647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353650">debug</span><span class="op" id="6353655">.</span><span class="ident" id="6353656">Printf</span><span class="op" id="6353662">(</span><span class="string" id="6353663">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="6353694">,</span>&nbsp;<span class="op" id="6353696">*</span><span class="ident" id="6353697">p</span><span class="op" id="6353698">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353702">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353719">var</span>&nbsp;<span class="ident" id="6353723">displayName</span>&nbsp;<span class="builtintype" id="6353735">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353743">if</span>&nbsp;<span class="ident" id="6353746">p</span><span class="op" id="6353747">.</span><span class="ident" id="6353748">peek</span><span class="op" id="6353752">(</span><span class="op" id="6353753">)</span>&nbsp;<span class="op" id="6353755">!=</span>&nbsp;<span class="string" id="6353758">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="6353762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353766">displayName</span><span class="op" id="6353777">,</span>&nbsp;<span class="ident" id="6353779">err</span>&nbsp;<span class="op" id="6353783">=</span>&nbsp;<span class="ident" id="6353785">p</span><span class="op" id="6353786">.</span><span class="ident" id="6353787">consumePhrase</span><span class="op" id="6353800">(</span><span class="op" id="6353801">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353805">if</span>&nbsp;<span class="ident" id="6353808">err</span>&nbsp;<span class="op" id="6353812">!=</span>&nbsp;<span class="ident" id="6353815">nil</span>&nbsp;<span class="op" id="6353819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353824">return</span>&nbsp;<span class="ident" id="6353831">nil</span><span class="op" id="6353834">,</span>&nbsp;<span class="ident" id="6353836">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353848">debug</span><span class="op" id="6353853">.</span><span class="ident" id="6353854">Printf</span><span class="op" id="6353860">(</span><span class="string" id="6353861">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="6353891">,</span>&nbsp;<span class="ident" id="6353893">displayName</span><span class="op" id="6353904">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353908">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353943">p</span><span class="op" id="6353944">.</span><span class="ident" id="6353945">skipSpace</span><span class="op" id="6353954">(</span><span class="op" id="6353955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353958">if</span>&nbsp;<span class="op" id="6353961">!</span><span class="ident" id="6353962">p</span><span class="op" id="6353963">.</span><span class="ident" id="6353964">consume</span><span class="op" id="6353971">(</span><span class="string" id="6353972">&#39;&lt;&#39;</span><span class="op" id="6353975">)</span>&nbsp;<span class="op" id="6353977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353981">return</span>&nbsp;<span class="ident" id="6353988">nil</span><span class="op" id="6353991">,</span>&nbsp;<span class="ident" id="6353993">errors</span><span class="op" id="6353999">.</span><span class="ident" id="6354000">New</span><span class="op" id="6354003">(</span><span class="string" id="6354004">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="6354025">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354031">spec</span><span class="op" id="6354035">,</span>&nbsp;<span class="ident" id="6354037">err</span>&nbsp;<span class="op" id="6354041">=</span>&nbsp;<span class="ident" id="6354043">p</span><span class="op" id="6354044">.</span><span class="ident" id="6354045">consumeAddrSpec</span><span class="op" id="6354060">(</span><span class="op" id="6354061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354064">if</span>&nbsp;<span class="ident" id="6354067">err</span>&nbsp;<span class="op" id="6354071">!=</span>&nbsp;<span class="ident" id="6354074">nil</span>&nbsp;<span class="op" id="6354078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354082">return</span>&nbsp;<span class="ident" id="6354089">nil</span><span class="op" id="6354092">,</span>&nbsp;<span class="ident" id="6354094">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354099">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354102">if</span>&nbsp;<span class="op" id="6354105">!</span><span class="ident" id="6354106">p</span><span class="op" id="6354107">.</span><span class="ident" id="6354108">consume</span><span class="op" id="6354115">(</span><span class="string" id="6354116">&#39;&gt;&#39;</span><span class="op" id="6354119">)</span>&nbsp;<span class="op" id="6354121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354125">return</span>&nbsp;<span class="ident" id="6354132">nil</span><span class="op" id="6354135">,</span>&nbsp;<span class="ident" id="6354137">errors</span><span class="op" id="6354143">.</span><span class="ident" id="6354144">New</span><span class="op" id="6354147">(</span><span class="string" id="6354148">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="6354175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354181">debug</span><span class="op" id="6354186">.</span><span class="ident" id="6354187">Printf</span><span class="op" id="6354193">(</span><span class="string" id="6354194">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="6354217">,</span>&nbsp;<span class="ident" id="6354219">spec</span><span class="op" id="6354223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354227">return</span>&nbsp;<span class="op" id="6354234">&amp;</span><span class="ident" id="6354235">Address</span><span class="op" id="6354242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354246">Name</span><span class="op" id="6354250">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354255">displayName</span><span class="op" id="6354266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354270">Address</span><span class="op" id="6354277">:</span>&nbsp;<span class="ident" id="6354279">spec</span><span class="op" id="6354283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354286">}</span><span class="op" id="6354287">,</span>&nbsp;<span class="ident" id="6354289">nil</span><br>
<span class="lineno"></span><span class="op" id="6354293">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="6354296">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6354369">func</span>&nbsp;<span class="op" id="6354374">(</span><span class="ident" id="6354375">p</span>&nbsp;<span class="op" id="6354377">*</span><span class="ident" id="6354378">addrParser</span><span class="op" id="6354388">)</span>&nbsp;<span class="ident" id="6354390">consumeAddrSpec</span><span class="op" id="6354405">(</span><span class="op" id="6354406">)</span>&nbsp;<span class="op" id="6354408">(</span><span class="ident" id="6354409">spec</span>&nbsp;<span class="builtintype" id="6354414">string</span><span class="op" id="6354420">,</span>&nbsp;<span class="ident" id="6354422">err</span>&nbsp;<span class="builtintype" id="6354426">error</span><span class="op" id="6354431">)</span>&nbsp;<span class="op" id="6354433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354436">debug</span><span class="op" id="6354441">.</span><span class="ident" id="6354442">Printf</span><span class="op" id="6354448">(</span><span class="string" id="6354449">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="6354470">,</span>&nbsp;<span class="op" id="6354472">*</span><span class="ident" id="6354473">p</span><span class="op" id="6354474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354478">orig</span>&nbsp;<span class="op" id="6354483">:=</span>&nbsp;<span class="op" id="6354486">*</span><span class="ident" id="6354487">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354490">defer</span>&nbsp;<span class="keyword" id="6354496">func</span><span class="op" id="6354500">(</span><span class="op" id="6354501">)</span>&nbsp;<span class="op" id="6354503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354507">if</span>&nbsp;<span class="ident" id="6354510">err</span>&nbsp;<span class="op" id="6354514">!=</span>&nbsp;<span class="ident" id="6354517">nil</span>&nbsp;<span class="op" id="6354521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354526">*</span><span class="ident" id="6354527">p</span>&nbsp;<span class="op" id="6354529">=</span>&nbsp;<span class="ident" id="6354531">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354538">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354541">}</span><span class="op" id="6354542">(</span><span class="op" id="6354543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6354547">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354589">var</span>&nbsp;<span class="ident" id="6354593">localPart</span>&nbsp;<span class="builtintype" id="6354603">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354611">p</span><span class="op" id="6354612">.</span><span class="ident" id="6354613">skipSpace</span><span class="op" id="6354622">(</span><span class="op" id="6354623">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354626">if</span>&nbsp;<span class="ident" id="6354629">p</span><span class="op" id="6354630">.</span><span class="ident" id="6354631">empty</span><span class="op" id="6354636">(</span><span class="op" id="6354637">)</span>&nbsp;<span class="op" id="6354639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354643">return</span>&nbsp;<span class="string" id="6354650">&#34;&#34;</span><span class="op" id="6354652">,</span>&nbsp;<span class="ident" id="6354654">errors</span><span class="op" id="6354660">.</span><span class="ident" id="6354661">New</span><span class="op" id="6354664">(</span><span class="string" id="6354665">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="6354685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354691">if</span>&nbsp;<span class="ident" id="6354694">p</span><span class="op" id="6354695">.</span><span class="ident" id="6354696">peek</span><span class="op" id="6354700">(</span><span class="op" id="6354701">)</span>&nbsp;<span class="op" id="6354703">==</span>&nbsp;<span class="string" id="6354706">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6354710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6354714">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354733">debug</span><span class="op" id="6354738">.</span><span class="ident" id="6354739">Printf</span><span class="op" id="6354745">(</span><span class="string" id="6354746">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="6354786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354790">localPart</span><span class="op" id="6354799">,</span>&nbsp;<span class="ident" id="6354801">err</span>&nbsp;<span class="op" id="6354805">=</span>&nbsp;<span class="ident" id="6354807">p</span><span class="op" id="6354808">.</span><span class="ident" id="6354809">consumeQuotedString</span><span class="op" id="6354828">(</span><span class="op" id="6354829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354832">}</span>&nbsp;<span class="keyword" id="6354834">else</span>&nbsp;<span class="op" id="6354839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6354843">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354857">debug</span><span class="op" id="6354862">.</span><span class="ident" id="6354863">Printf</span><span class="op" id="6354869">(</span><span class="string" id="6354870">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="6354905">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354909">localPart</span><span class="op" id="6354918">,</span>&nbsp;<span class="ident" id="6354920">err</span>&nbsp;<span class="op" id="6354924">=</span>&nbsp;<span class="ident" id="6354926">p</span><span class="op" id="6354927">.</span><span class="ident" id="6354928">consumeAtom</span><span class="op" id="6354939">(</span><span class="builtintype" id="6354940">true</span><span class="op" id="6354944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354950">if</span>&nbsp;<span class="ident" id="6354953">err</span>&nbsp;<span class="op" id="6354957">!=</span>&nbsp;<span class="ident" id="6354960">nil</span>&nbsp;<span class="op" id="6354964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354968">debug</span><span class="op" id="6354973">.</span><span class="ident" id="6354974">Printf</span><span class="op" id="6354980">(</span><span class="string" id="6354981">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6355010">,</span>&nbsp;<span class="ident" id="6355012">err</span><span class="op" id="6355015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355019">return</span>&nbsp;<span class="string" id="6355026">&#34;&#34;</span><span class="op" id="6355028">,</span>&nbsp;<span class="ident" id="6355030">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6355035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355039">if</span>&nbsp;<span class="op" id="6355042">!</span><span class="ident" id="6355043">p</span><span class="op" id="6355044">.</span><span class="ident" id="6355045">consume</span><span class="op" id="6355052">(</span><span class="string" id="6355053">&#39;@&#39;</span><span class="op" id="6355056">)</span>&nbsp;<span class="op" id="6355058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355062">return</span>&nbsp;<span class="string" id="6355069">&#34;&#34;</span><span class="op" id="6355071">,</span>&nbsp;<span class="ident" id="6355073">errors</span><span class="op" id="6355079">.</span><span class="ident" id="6355080">New</span><span class="op" id="6355083">(</span><span class="string" id="6355084">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="6355114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6355117">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6355121">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355160">var</span>&nbsp;<span class="ident" id="6355164">domain</span>&nbsp;<span class="builtintype" id="6355171">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6355179">p</span><span class="op" id="6355180">.</span><span class="ident" id="6355181">skipSpace</span><span class="op" id="6355190">(</span><span class="op" id="6355191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355194">if</span>&nbsp;<span class="ident" id="6355197">p</span><span class="op" id="6355198">.</span><span class="ident" id="6355199">empty</span><span class="op" id="6355204">(</span><span class="op" id="6355205">)</span>&nbsp;<span class="op" id="6355207">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355211">return</span>&nbsp;<span class="string" id="6355218">&#34;&#34;</span><span class="op" id="6355220">,</span>&nbsp;<span class="ident" id="6355222">errors</span><span class="op" id="6355228">.</span><span class="ident" id="6355229">New</span><span class="op" id="6355232">(</span><span class="string" id="6355233">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="6355263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6355266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6355269">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6355311">domain</span><span class="op" id="6355317">,</span>&nbsp;<span class="ident" id="6355319">err</span>&nbsp;<span class="op" id="6355323">=</span>&nbsp;<span class="ident" id="6355325">p</span><span class="op" id="6355326">.</span><span class="ident" id="6355327">consumeAtom</span><span class="op" id="6355338">(</span><span class="builtintype" id="6355339">true</span><span class="op" id="6355343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355346">if</span>&nbsp;<span class="ident" id="6355349">err</span>&nbsp;<span class="op" id="6355353">!=</span>&nbsp;<span class="ident" id="6355356">nil</span>&nbsp;<span class="op" id="6355360">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355364">return</span>&nbsp;<span class="string" id="6355371">&#34;&#34;</span><span class="op" id="6355373">,</span>&nbsp;<span class="ident" id="6355375">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6355380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355384">return</span>&nbsp;<span class="ident" id="6355391">localPart</span>&nbsp;<span class="op" id="6355401">+</span>&nbsp;<span class="string" id="6355403">&#34;@&#34;</span>&nbsp;<span class="op" id="6355407">+</span>&nbsp;<span class="ident" id="6355409">domain</span><span class="op" id="6355415">,</span>&nbsp;<span class="ident" id="6355417">nil</span><br>
<span class="lineno"></span><span class="op" id="6355421">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="6355424">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6355487">func</span>&nbsp;<span class="op" id="6355492">(</span><span class="ident" id="6355493">p</span>&nbsp;<span class="op" id="6355495">*</span><span class="ident" id="6355496">addrParser</span><span class="op" id="6355506">)</span>&nbsp;<span class="ident" id="6355508">consumePhrase</span><span class="op" id="6355521">(</span><span class="op" id="6355522">)</span>&nbsp;<span class="op" id="6355524">(</span><span class="ident" id="6355525">phrase</span>&nbsp;<span class="builtintype" id="6355532">string</span><span class="op" id="6355538">,</span>&nbsp;<span class="ident" id="6355540">err</span>&nbsp;<span class="builtintype" id="6355544">error</span><span class="op" id="6355549">)</span>&nbsp;<span class="op" id="6355551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6355554">debug</span><span class="op" id="6355559">.</span><span class="ident" id="6355560">Printf</span><span class="op" id="6355566">(</span><span class="string" id="6355567">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="6355588">,</span>&nbsp;<span class="op" id="6355590">*</span><span class="ident" id="6355591">p</span><span class="op" id="6355592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6355595">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355615">var</span>&nbsp;<span class="ident" id="6355619">words</span>&nbsp;<span class="op" id="6355625">[</span><span class="op" id="6355626">]</span><span class="builtintype" id="6355627">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355635">for</span>&nbsp;<span class="op" id="6355639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6355643">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355676">var</span>&nbsp;<span class="ident" id="6355680">word</span>&nbsp;<span class="builtintype" id="6355685">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6355694">p</span><span class="op" id="6355695">.</span><span class="ident" id="6355696">skipSpace</span><span class="op" id="6355705">(</span><span class="op" id="6355706">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355710">if</span>&nbsp;<span class="ident" id="6355713">p</span><span class="op" id="6355714">.</span><span class="ident" id="6355715">empty</span><span class="op" id="6355720">(</span><span class="op" id="6355721">)</span>&nbsp;<span class="op" id="6355723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355728">return</span>&nbsp;<span class="string" id="6355735">&#34;&#34;</span><span class="op" id="6355737">,</span>&nbsp;<span class="ident" id="6355739">errors</span><span class="op" id="6355745">.</span><span class="ident" id="6355746">New</span><span class="op" id="6355749">(</span><span class="string" id="6355750">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="6355772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6355776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6355780">if</span>&nbsp;<span class="ident" id="6355783">p</span><span class="op" id="6355784">.</span><span class="ident" id="6355785">peek</span><span class="op" id="6355789">(</span><span class="op" id="6355790">)</span>&nbsp;<span class="op" id="6355792">==</span>&nbsp;<span class="string" id="6355795">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6355799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6355804">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6355824">word</span><span class="op" id="6355828">,</span>&nbsp;<span class="ident" id="6355830">err</span>&nbsp;<span class="op" id="6355834">=</span>&nbsp;<span class="ident" id="6355836">p</span><span class="op" id="6355837">.</span><span class="ident" id="6355838">consumeQuotedString</span><span class="op" id="6355857">(</span><span class="op" id="6355858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6355862">}</span>&nbsp;<span class="keyword" id="6355864">else</span>&nbsp;<span class="op" id="6355869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6355874">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6355885">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6355945">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6355981">word</span><span class="op" id="6355985">,</span>&nbsp;<span class="ident" id="6355987">err</span>&nbsp;<span class="op" id="6355991">=</span>&nbsp;<span class="ident" id="6355993">p</span><span class="op" id="6355994">.</span><span class="ident" id="6355995">consumeAtom</span><span class="op" id="6356006">(</span><span class="builtintype" id="6356007">true</span><span class="op" id="6356011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6356015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6356020">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356099">if</span>&nbsp;<span class="ident" id="6356102">err</span>&nbsp;<span class="op" id="6356106">==</span>&nbsp;<span class="ident" id="6356109">nil</span>&nbsp;<span class="op" id="6356113">&amp;&amp;</span>&nbsp;<span class="ident" id="6356116">strings</span><span class="op" id="6356123">.</span><span class="ident" id="6356124">HasPrefix</span><span class="op" id="6356133">(</span><span class="ident" id="6356134">word</span><span class="op" id="6356138">,</span>&nbsp;<span class="string" id="6356140">&#34;=?&#34;</span><span class="op" id="6356144">)</span>&nbsp;<span class="op" id="6356146">&amp;&amp;</span>&nbsp;<span class="ident" id="6356149">strings</span><span class="op" id="6356156">.</span><span class="ident" id="6356157">HasSuffix</span><span class="op" id="6356166">(</span><span class="ident" id="6356167">word</span><span class="op" id="6356171">,</span>&nbsp;<span class="string" id="6356173">&#34;?=&#34;</span><span class="op" id="6356177">)</span>&nbsp;<span class="op" id="6356179">&amp;&amp;</span>&nbsp;<span class="ident" id="6356182">strings</span><span class="op" id="6356189">.</span><span class="ident" id="6356190">Count</span><span class="op" id="6356195">(</span><span class="ident" id="6356196">word</span><span class="op" id="6356200">,</span>&nbsp;<span class="string" id="6356202">&#34;?&#34;</span><span class="op" id="6356205">)</span>&nbsp;<span class="op" id="6356207">==</span>&nbsp;<span class="num" id="6356210">4</span>&nbsp;<span class="op" id="6356212">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6356217">word</span><span class="op" id="6356221">,</span>&nbsp;<span class="ident" id="6356223">err</span>&nbsp;<span class="op" id="6356227">=</span>&nbsp;<span class="ident" id="6356229">decodeRFC2047Word</span><span class="op" id="6356246">(</span><span class="ident" id="6356247">word</span><span class="op" id="6356251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6356255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356260">if</span>&nbsp;<span class="ident" id="6356263">err</span>&nbsp;<span class="op" id="6356267">!=</span>&nbsp;<span class="ident" id="6356270">nil</span>&nbsp;<span class="op" id="6356274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356279">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6356287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6356291">debug</span><span class="op" id="6356296">.</span><span class="ident" id="6356297">Printf</span><span class="op" id="6356303">(</span><span class="string" id="6356304">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="6356332">,</span>&nbsp;<span class="ident" id="6356334">word</span><span class="op" id="6356338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6356342">words</span>&nbsp;<span class="op" id="6356348">=</span>&nbsp;<span class="builtinfunc" id="6356350">append</span><span class="op" id="6356356">(</span><span class="ident" id="6356357">words</span><span class="op" id="6356362">,</span>&nbsp;<span class="ident" id="6356364">word</span><span class="op" id="6356368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6356371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6356374">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356424">if</span>&nbsp;<span class="ident" id="6356427">err</span>&nbsp;<span class="op" id="6356431">!=</span>&nbsp;<span class="ident" id="6356434">nil</span>&nbsp;<span class="op" id="6356438">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6356441">len</span><span class="op" id="6356444">(</span><span class="ident" id="6356445">words</span><span class="op" id="6356450">)</span>&nbsp;<span class="op" id="6356452">==</span>&nbsp;<span class="num" id="6356455">0</span>&nbsp;<span class="op" id="6356457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6356461">debug</span><span class="op" id="6356466">.</span><span class="ident" id="6356467">Printf</span><span class="op" id="6356473">(</span><span class="string" id="6356474">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="6356502">,</span>&nbsp;<span class="ident" id="6356504">err</span><span class="op" id="6356507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356511">return</span>&nbsp;<span class="string" id="6356518">&#34;&#34;</span><span class="op" id="6356520">,</span>&nbsp;<span class="ident" id="6356522">fmt</span><span class="op" id="6356525">.</span><span class="ident" id="6356526">Errorf</span><span class="op" id="6356532">(</span><span class="string" id="6356533">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="6356567">,</span>&nbsp;<span class="ident" id="6356569">err</span><span class="op" id="6356572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6356575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6356578">phrase</span>&nbsp;<span class="op" id="6356585">=</span>&nbsp;<span class="ident" id="6356587">strings</span><span class="op" id="6356594">.</span><span class="ident" id="6356595">Join</span><span class="op" id="6356599">(</span><span class="ident" id="6356600">words</span><span class="op" id="6356605">,</span>&nbsp;<span class="string" id="6356607">&#34;&nbsp;&#34;</span><span class="op" id="6356610">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356613">return</span>&nbsp;<span class="ident" id="6356620">phrase</span><span class="op" id="6356626">,</span>&nbsp;<span class="ident" id="6356628">nil</span><br>
<span class="lineno"></span><span class="op" id="6356632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6356635">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6356702">func</span>&nbsp;<span class="op" id="6356707">(</span><span class="ident" id="6356708">p</span>&nbsp;<span class="op" id="6356710">*</span><span class="ident" id="6356711">addrParser</span><span class="op" id="6356721">)</span>&nbsp;<span class="ident" id="6356723">consumeQuotedString</span><span class="op" id="6356742">(</span><span class="op" id="6356743">)</span>&nbsp;<span class="op" id="6356745">(</span><span class="ident" id="6356746">qs</span>&nbsp;<span class="builtintype" id="6356749">string</span><span class="op" id="6356755">,</span>&nbsp;<span class="ident" id="6356757">err</span>&nbsp;<span class="builtintype" id="6356761">error</span><span class="op" id="6356766">)</span>&nbsp;<span class="op" id="6356768">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6356771">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6356801">i</span>&nbsp;<span class="op" id="6356803">:=</span>&nbsp;<span class="num" id="6356806">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6356809">qsb</span>&nbsp;<span class="op" id="6356813">:=</span>&nbsp;<span class="builtinfunc" id="6356816">make</span><span class="op" id="6356820">(</span><span class="op" id="6356821">[</span><span class="op" id="6356822">]</span><span class="builtintype" id="6356823">byte</span><span class="op" id="6356827">,</span>&nbsp;<span class="num" id="6356829">0</span><span class="op" id="6356830">,</span>&nbsp;<span class="num" id="6356832">10</span><span class="op" id="6356834">)</span><br>
<span class="lineno"></span><span class="ident" id="6356836">Loop</span><span class="op" id="6356840">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356843">for</span>&nbsp;<span class="op" id="6356847">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356851">if</span>&nbsp;<span class="ident" id="6356854">i</span>&nbsp;<span class="op" id="6356856">&gt;=</span>&nbsp;<span class="ident" id="6356859">p</span><span class="op" id="6356860">.</span><span class="builtinfunc" id="6356861">len</span><span class="op" id="6356864">(</span><span class="op" id="6356865">)</span>&nbsp;<span class="op" id="6356867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356872">return</span>&nbsp;<span class="string" id="6356879">&#34;&#34;</span><span class="op" id="6356881">,</span>&nbsp;<span class="ident" id="6356883">errors</span><span class="op" id="6356889">.</span><span class="ident" id="6356890">New</span><span class="op" id="6356893">(</span><span class="string" id="6356894">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="6356924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6356928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356932">switch</span>&nbsp;<span class="ident" id="6356939">c</span>&nbsp;<span class="op" id="6356941">:=</span>&nbsp;<span class="op" id="6356944">(</span><span class="op" id="6356945">*</span><span class="ident" id="6356946">p</span><span class="op" id="6356947">)</span><span class="op" id="6356948">[</span><span class="ident" id="6356949">i</span><span class="op" id="6356950">]</span><span class="op" id="6356951">;</span>&nbsp;<span class="op" id="6356953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356957">case</span>&nbsp;<span class="ident" id="6356962">c</span>&nbsp;<span class="op" id="6356964">==</span>&nbsp;<span class="string" id="6356967">&#39;&#34;&#39;</span><span class="op" id="6356970">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356975">break</span>&nbsp;<span class="ident" id="6356981">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6356988">case</span>&nbsp;<span class="ident" id="6356993">c</span>&nbsp;<span class="op" id="6356995">==</span>&nbsp;<span class="string" id="6356998">&#39;\\&#39;</span><span class="op" id="6357002">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357007">if</span>&nbsp;<span class="ident" id="6357010">i</span><span class="op" id="6357011">+</span><span class="num" id="6357012">1</span>&nbsp;<span class="op" id="6357014">==</span>&nbsp;<span class="ident" id="6357017">p</span><span class="op" id="6357018">.</span><span class="builtinfunc" id="6357019">len</span><span class="op" id="6357022">(</span><span class="op" id="6357023">)</span>&nbsp;<span class="op" id="6357025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357031">return</span>&nbsp;<span class="string" id="6357038">&#34;&#34;</span><span class="op" id="6357040">,</span>&nbsp;<span class="ident" id="6357042">errors</span><span class="op" id="6357048">.</span><span class="ident" id="6357049">New</span><span class="op" id="6357052">(</span><span class="string" id="6357053">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="6357083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6357088">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6357093">qsb</span>&nbsp;<span class="op" id="6357097">=</span>&nbsp;<span class="builtinfunc" id="6357099">append</span><span class="op" id="6357105">(</span><span class="ident" id="6357106">qsb</span><span class="op" id="6357109">,</span>&nbsp;<span class="op" id="6357111">(</span><span class="op" id="6357112">*</span><span class="ident" id="6357113">p</span><span class="op" id="6357114">)</span><span class="op" id="6357115">[</span><span class="ident" id="6357116">i</span><span class="op" id="6357117">+</span><span class="num" id="6357118">1</span><span class="op" id="6357119">]</span><span class="op" id="6357120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6357125">i</span>&nbsp;<span class="op" id="6357127">+=</span>&nbsp;<span class="num" id="6357130">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357134">case</span>&nbsp;<span class="ident" id="6357139">isQtext</span><span class="op" id="6357146">(</span><span class="ident" id="6357147">c</span><span class="op" id="6357148">)</span><span class="op" id="6357149">,</span>&nbsp;<span class="ident" id="6357151">c</span>&nbsp;<span class="op" id="6357153">==</span>&nbsp;<span class="string" id="6357156">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="6357160">||</span>&nbsp;<span class="ident" id="6357163">c</span>&nbsp;<span class="op" id="6357165">==</span>&nbsp;<span class="string" id="6357168">&#39;\t&#39;</span><span class="op" id="6357172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6357177">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6357232">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6357272">qsb</span>&nbsp;<span class="op" id="6357276">=</span>&nbsp;<span class="builtinfunc" id="6357278">append</span><span class="op" id="6357284">(</span><span class="ident" id="6357285">qsb</span><span class="op" id="6357288">,</span>&nbsp;<span class="ident" id="6357290">c</span><span class="op" id="6357291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6357296">i</span><span class="op" id="6357297">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357302">default</span><span class="op" id="6357309">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357314">return</span>&nbsp;<span class="string" id="6357321">&#34;&#34;</span><span class="op" id="6357323">,</span>&nbsp;<span class="ident" id="6357325">fmt</span><span class="op" id="6357328">.</span><span class="ident" id="6357329">Errorf</span><span class="op" id="6357335">(</span><span class="string" id="6357336">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="6357378">,</span>&nbsp;<span class="ident" id="6357380">c</span><span class="op" id="6357381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6357385">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6357388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6357391">*</span><span class="ident" id="6357392">p</span>&nbsp;<span class="op" id="6357394">=</span>&nbsp;<span class="op" id="6357396">(</span><span class="op" id="6357397">*</span><span class="ident" id="6357398">p</span><span class="op" id="6357399">)</span><span class="op" id="6357400">[</span><span class="ident" id="6357401">i</span><span class="op" id="6357402">+</span><span class="num" id="6357403">1</span><span class="op" id="6357404">:</span><span class="op" id="6357405">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357408">return</span>&nbsp;<span class="builtintype" id="6357415">string</span><span class="op" id="6357421">(</span><span class="ident" id="6357422">qsb</span><span class="op" id="6357425">)</span><span class="op" id="6357426">,</span>&nbsp;<span class="ident" id="6357428">nil</span><br>
<span class="lineno"></span><span class="op" id="6357432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="6357435">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="6357493">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6357561">func</span>&nbsp;<span class="op" id="6357566">(</span><span class="ident" id="6357567">p</span>&nbsp;<span class="op" id="6357569">*</span><span class="ident" id="6357570">addrParser</span><span class="op" id="6357580">)</span>&nbsp;<span class="ident" id="6357582">consumeAtom</span><span class="op" id="6357593">(</span><span class="ident" id="6357594">dot</span>&nbsp;<span class="builtintype" id="6357598">bool</span><span class="op" id="6357602">)</span>&nbsp;<span class="op" id="6357604">(</span><span class="ident" id="6357605">atom</span>&nbsp;<span class="builtintype" id="6357610">string</span><span class="op" id="6357616">,</span>&nbsp;<span class="ident" id="6357618">err</span>&nbsp;<span class="builtintype" id="6357622">error</span><span class="op" id="6357627">)</span>&nbsp;<span class="op" id="6357629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357632">if</span>&nbsp;<span class="op" id="6357635">!</span><span class="ident" id="6357636">isAtext</span><span class="op" id="6357643">(</span><span class="ident" id="6357644">p</span><span class="op" id="6357645">.</span><span class="ident" id="6357646">peek</span><span class="op" id="6357650">(</span><span class="op" id="6357651">)</span><span class="op" id="6357652">,</span>&nbsp;<span class="builtintype" id="6357654">false</span><span class="op" id="6357659">)</span>&nbsp;<span class="op" id="6357661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357665">return</span>&nbsp;<span class="string" id="6357672">&#34;&#34;</span><span class="op" id="6357674">,</span>&nbsp;<span class="ident" id="6357676">errors</span><span class="op" id="6357682">.</span><span class="ident" id="6357683">New</span><span class="op" id="6357686">(</span><span class="string" id="6357687">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="6357709">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6357712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6357715">i</span>&nbsp;<span class="op" id="6357717">:=</span>&nbsp;<span class="num" id="6357720">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357723">for</span>&nbsp;<span class="op" id="6357727">;</span>&nbsp;<span class="ident" id="6357729">i</span>&nbsp;<span class="op" id="6357731">&lt;</span>&nbsp;<span class="ident" id="6357733">p</span><span class="op" id="6357734">.</span><span class="builtinfunc" id="6357735">len</span><span class="op" id="6357738">(</span><span class="op" id="6357739">)</span>&nbsp;<span class="op" id="6357741">&amp;&amp;</span>&nbsp;<span class="ident" id="6357744">isAtext</span><span class="op" id="6357751">(</span><span class="op" id="6357752">(</span><span class="op" id="6357753">*</span><span class="ident" id="6357754">p</span><span class="op" id="6357755">)</span><span class="op" id="6357756">[</span><span class="ident" id="6357757">i</span><span class="op" id="6357758">]</span><span class="op" id="6357759">,</span>&nbsp;<span class="ident" id="6357761">dot</span><span class="op" id="6357764">)</span><span class="op" id="6357765">;</span>&nbsp;<span class="ident" id="6357767">i</span><span class="op" id="6357768">++</span>&nbsp;<span class="op" id="6357771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6357774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6357777">atom</span><span class="op" id="6357781">,</span>&nbsp;<span class="op" id="6357783">*</span><span class="ident" id="6357784">p</span>&nbsp;<span class="op" id="6357786">=</span>&nbsp;<span class="builtintype" id="6357788">string</span><span class="op" id="6357794">(</span><span class="op" id="6357795">(</span><span class="op" id="6357796">*</span><span class="ident" id="6357797">p</span><span class="op" id="6357798">)</span><span class="op" id="6357799">[</span><span class="op" id="6357800">:</span><span class="ident" id="6357801">i</span><span class="op" id="6357802">]</span><span class="op" id="6357803">)</span><span class="op" id="6357804">,</span>&nbsp;<span class="op" id="6357806">(</span><span class="op" id="6357807">*</span><span class="ident" id="6357808">p</span><span class="op" id="6357809">)</span><span class="op" id="6357810">[</span><span class="ident" id="6357811">i</span><span class="op" id="6357812">:</span><span class="op" id="6357813">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357816">return</span>&nbsp;<span class="ident" id="6357823">atom</span><span class="op" id="6357827">,</span>&nbsp;<span class="ident" id="6357829">nil</span><br>
<span class="lineno"></span><span class="op" id="6357833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6357836">func</span>&nbsp;<span class="op" id="6357841">(</span><span class="ident" id="6357842">p</span>&nbsp;<span class="op" id="6357844">*</span><span class="ident" id="6357845">addrParser</span><span class="op" id="6357855">)</span>&nbsp;<span class="ident" id="6357857">consume</span><span class="op" id="6357864">(</span><span class="ident" id="6357865">c</span>&nbsp;<span class="builtintype" id="6357867">byte</span><span class="op" id="6357871">)</span>&nbsp;<span class="builtintype" id="6357873">bool</span>&nbsp;<span class="op" id="6357878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357881">if</span>&nbsp;<span class="ident" id="6357884">p</span><span class="op" id="6357885">.</span><span class="ident" id="6357886">empty</span><span class="op" id="6357891">(</span><span class="op" id="6357892">)</span>&nbsp;<span class="op" id="6357894">||</span>&nbsp;<span class="ident" id="6357897">p</span><span class="op" id="6357898">.</span><span class="ident" id="6357899">peek</span><span class="op" id="6357903">(</span><span class="op" id="6357904">)</span>&nbsp;<span class="op" id="6357906">!=</span>&nbsp;<span class="ident" id="6357909">c</span>&nbsp;<span class="op" id="6357911">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357915">return</span>&nbsp;<span class="builtintype" id="6357922">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6357929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6357932">*</span><span class="ident" id="6357933">p</span>&nbsp;<span class="op" id="6357935">=</span>&nbsp;<span class="op" id="6357937">(</span><span class="op" id="6357938">*</span><span class="ident" id="6357939">p</span><span class="op" id="6357940">)</span><span class="op" id="6357941">[</span><span class="num" id="6357942">1</span><span class="op" id="6357943">:</span><span class="op" id="6357944">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6357947">return</span>&nbsp;<span class="builtintype" id="6357954">true</span><br>
<span class="lineno"></span><span class="op" id="6357959">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="6357962">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="6358019">func</span>&nbsp;<span class="op" id="6358024">(</span><span class="ident" id="6358025">p</span>&nbsp;<span class="op" id="6358027">*</span><span class="ident" id="6358028">addrParser</span><span class="op" id="6358038">)</span>&nbsp;<span class="ident" id="6358040">skipSpace</span><span class="op" id="6358049">(</span><span class="op" id="6358050">)</span>&nbsp;<span class="op" id="6358052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6358055">*</span><span class="ident" id="6358056">p</span>&nbsp;<span class="op" id="6358058">=</span>&nbsp;<span class="ident" id="6358060">bytes</span><span class="op" id="6358065">.</span><span class="ident" id="6358066">TrimLeft</span><span class="op" id="6358074">(</span><span class="op" id="6358075">*</span><span class="ident" id="6358076">p</span><span class="op" id="6358077">,</span>&nbsp;<span class="string" id="6358079">&#34;&nbsp;\t&#34;</span><span class="op" id="6358084">)</span><br>
<span class="lineno"></span><span class="op" id="6358086">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="6358089">func</span>&nbsp;<span class="op" id="6358094">(</span><span class="ident" id="6358095">p</span>&nbsp;<span class="op" id="6358097">*</span><span class="ident" id="6358098">addrParser</span><span class="op" id="6358108">)</span>&nbsp;<span class="ident" id="6358110">peek</span><span class="op" id="6358114">(</span><span class="op" id="6358115">)</span>&nbsp;<span class="builtintype" id="6358117">byte</span>&nbsp;<span class="op" id="6358122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358125">return</span>&nbsp;<span class="op" id="6358132">(</span><span class="op" id="6358133">*</span><span class="ident" id="6358134">p</span><span class="op" id="6358135">)</span><span class="op" id="6358136">[</span><span class="num" id="6358137">0</span><span class="op" id="6358138">]</span><br>
<span class="lineno"></span><span class="op" id="6358140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6358143">func</span>&nbsp;<span class="op" id="6358148">(</span><span class="ident" id="6358149">p</span>&nbsp;<span class="op" id="6358151">*</span><span class="ident" id="6358152">addrParser</span><span class="op" id="6358162">)</span>&nbsp;<span class="ident" id="6358164">empty</span><span class="op" id="6358169">(</span><span class="op" id="6358170">)</span>&nbsp;<span class="builtintype" id="6358172">bool</span>&nbsp;<span class="op" id="6358177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358180">return</span>&nbsp;<span class="ident" id="6358187">p</span><span class="op" id="6358188">.</span><span class="builtinfunc" id="6358189">len</span><span class="op" id="6358192">(</span><span class="op" id="6358193">)</span>&nbsp;<span class="op" id="6358195">==</span>&nbsp;<span class="num" id="6358198">0</span><br>
<span class="lineno"></span><span class="op" id="6358200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6358203">func</span>&nbsp;<span class="op" id="6358208">(</span><span class="ident" id="6358209">p</span>&nbsp;<span class="op" id="6358211">*</span><span class="ident" id="6358212">addrParser</span><span class="op" id="6358222">)</span>&nbsp;<span class="builtinfunc" id="6358224">len</span><span class="op" id="6358227">(</span><span class="op" id="6358228">)</span>&nbsp;<span class="builtintype" id="6358230">int</span>&nbsp;<span class="op" id="6358234">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358237">return</span>&nbsp;<span class="builtinfunc" id="6358244">len</span><span class="op" id="6358247">(</span><span class="op" id="6358248">*</span><span class="ident" id="6358249">p</span><span class="op" id="6358250">)</span><br>
<span class="lineno"></span><span class="op" id="6358252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6358255">func</span>&nbsp;<span class="ident" id="6358260">decodeRFC2047Word</span><span class="op" id="6358277">(</span><span class="ident" id="6358278">s</span>&nbsp;<span class="builtintype" id="6358280">string</span><span class="op" id="6358286">)</span>&nbsp;<span class="op" id="6358288">(</span><span class="builtintype" id="6358289">string</span><span class="op" id="6358295">,</span>&nbsp;<span class="builtintype" id="6358297">error</span><span class="op" id="6358302">)</span>&nbsp;<span class="op" id="6358304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6358307">fields</span>&nbsp;<span class="op" id="6358314">:=</span>&nbsp;<span class="ident" id="6358317">strings</span><span class="op" id="6358324">.</span><span class="ident" id="6358325">Split</span><span class="op" id="6358330">(</span><span class="ident" id="6358331">s</span><span class="op" id="6358332">,</span>&nbsp;<span class="string" id="6358334">&#34;?&#34;</span><span class="op" id="6358337">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358340">if</span>&nbsp;<span class="builtinfunc" id="6358343">len</span><span class="op" id="6358346">(</span><span class="ident" id="6358347">fields</span><span class="op" id="6358353">)</span>&nbsp;<span class="op" id="6358355">!=</span>&nbsp;<span class="num" id="6358358">5</span>&nbsp;<span class="op" id="6358360">||</span>&nbsp;<span class="ident" id="6358363">fields</span><span class="op" id="6358369">[</span><span class="num" id="6358370">0</span><span class="op" id="6358371">]</span>&nbsp;<span class="op" id="6358373">!=</span>&nbsp;<span class="string" id="6358376">&#34;=&#34;</span>&nbsp;<span class="op" id="6358380">||</span>&nbsp;<span class="ident" id="6358383">fields</span><span class="op" id="6358389">[</span><span class="num" id="6358390">4</span><span class="op" id="6358391">]</span>&nbsp;<span class="op" id="6358393">!=</span>&nbsp;<span class="string" id="6358396">&#34;=&#34;</span>&nbsp;<span class="op" id="6358400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358404">return</span>&nbsp;<span class="string" id="6358411">&#34;&#34;</span><span class="op" id="6358413">,</span>&nbsp;<span class="ident" id="6358415">errors</span><span class="op" id="6358421">.</span><span class="ident" id="6358422">New</span><span class="op" id="6358425">(</span><span class="string" id="6358426">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="6358456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6358459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6358462">charset</span><span class="op" id="6358469">,</span>&nbsp;<span class="ident" id="6358471">enc</span>&nbsp;<span class="op" id="6358475">:=</span>&nbsp;<span class="ident" id="6358478">strings</span><span class="op" id="6358485">.</span><span class="ident" id="6358486">ToLower</span><span class="op" id="6358493">(</span><span class="ident" id="6358494">fields</span><span class="op" id="6358500">[</span><span class="num" id="6358501">1</span><span class="op" id="6358502">]</span><span class="op" id="6358503">)</span><span class="op" id="6358504">,</span>&nbsp;<span class="ident" id="6358506">strings</span><span class="op" id="6358513">.</span><span class="ident" id="6358514">ToLower</span><span class="op" id="6358521">(</span><span class="ident" id="6358522">fields</span><span class="op" id="6358528">[</span><span class="num" id="6358529">2</span><span class="op" id="6358530">]</span><span class="op" id="6358531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358534">if</span>&nbsp;<span class="ident" id="6358537">charset</span>&nbsp;<span class="op" id="6358545">!=</span>&nbsp;<span class="string" id="6358548">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="6358559">&amp;&amp;</span>&nbsp;<span class="ident" id="6358562">charset</span>&nbsp;<span class="op" id="6358570">!=</span>&nbsp;<span class="string" id="6358573">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="6358586">&amp;&amp;</span>&nbsp;<span class="ident" id="6358589">charset</span>&nbsp;<span class="op" id="6358597">!=</span>&nbsp;<span class="string" id="6358600">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="6358608">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358612">return</span>&nbsp;<span class="string" id="6358619">&#34;&#34;</span><span class="op" id="6358621">,</span>&nbsp;<span class="ident" id="6358623">fmt</span><span class="op" id="6358626">.</span><span class="ident" id="6358627">Errorf</span><span class="op" id="6358633">(</span><span class="string" id="6358634">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="6358661">,</span>&nbsp;<span class="ident" id="6358663">charset</span><span class="op" id="6358670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6358673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6358677">in</span>&nbsp;<span class="op" id="6358680">:=</span>&nbsp;<span class="ident" id="6358683">bytes</span><span class="op" id="6358688">.</span><span class="ident" id="6358689">NewBufferString</span><span class="op" id="6358704">(</span><span class="ident" id="6358705">fields</span><span class="op" id="6358711">[</span><span class="num" id="6358712">3</span><span class="op" id="6358713">]</span><span class="op" id="6358714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358717">var</span>&nbsp;<span class="ident" id="6358721">r</span>&nbsp;<span class="ident" id="6358723">io</span><span class="op" id="6358725">.</span><span class="ident" id="6358726">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358734">switch</span>&nbsp;<span class="ident" id="6358741">enc</span>&nbsp;<span class="op" id="6358745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358748">case</span>&nbsp;<span class="string" id="6358753">&#34;b&#34;</span><span class="op" id="6358756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6358760">r</span>&nbsp;<span class="op" id="6358762">=</span>&nbsp;<span class="ident" id="6358764">base64</span><span class="op" id="6358770">.</span><span class="ident" id="6358771">NewDecoder</span><span class="op" id="6358781">(</span><span class="ident" id="6358782">base64</span><span class="op" id="6358788">.</span><span class="ident" id="6358789">StdEncoding</span><span class="op" id="6358800">,</span>&nbsp;<span class="ident" id="6358802">in</span><span class="op" id="6358804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358807">case</span>&nbsp;<span class="string" id="6358812">&#34;q&#34;</span><span class="op" id="6358815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6358819">r</span>&nbsp;<span class="op" id="6358821">=</span>&nbsp;<span class="ident" id="6358823">qDecoder</span><span class="op" id="6358831">{</span><span class="ident" id="6358832">r</span><span class="op" id="6358833">:</span>&nbsp;<span class="ident" id="6358835">in</span><span class="op" id="6358837">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358840">default</span><span class="op" id="6358847">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358851">return</span>&nbsp;<span class="string" id="6358858">&#34;&#34;</span><span class="op" id="6358860">,</span>&nbsp;<span class="ident" id="6358862">fmt</span><span class="op" id="6358865">.</span><span class="ident" id="6358866">Errorf</span><span class="op" id="6358872">(</span><span class="string" id="6358873">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="6358910">,</span>&nbsp;<span class="ident" id="6358912">enc</span><span class="op" id="6358915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6358918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6358922">dec</span><span class="op" id="6358925">,</span>&nbsp;<span class="ident" id="6358927">err</span>&nbsp;<span class="op" id="6358931">:=</span>&nbsp;<span class="ident" id="6358934">ioutil</span><span class="op" id="6358940">.</span><span class="ident" id="6358941">ReadAll</span><span class="op" id="6358948">(</span><span class="ident" id="6358949">r</span><span class="op" id="6358950">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358953">if</span>&nbsp;<span class="ident" id="6358956">err</span>&nbsp;<span class="op" id="6358960">!=</span>&nbsp;<span class="ident" id="6358963">nil</span>&nbsp;<span class="op" id="6358967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358971">return</span>&nbsp;<span class="string" id="6358978">&#34;&#34;</span><span class="op" id="6358980">,</span>&nbsp;<span class="ident" id="6358982">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6358987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6358991">switch</span>&nbsp;<span class="ident" id="6358998">charset</span>&nbsp;<span class="op" id="6359006">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359009">case</span>&nbsp;<span class="string" id="6359014">&#34;us-ascii&#34;</span><span class="op" id="6359024">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359028">b</span>&nbsp;<span class="op" id="6359030">:=</span>&nbsp;<span class="builtinfunc" id="6359033">new</span><span class="op" id="6359036">(</span><span class="ident" id="6359037">bytes</span><span class="op" id="6359042">.</span><span class="ident" id="6359043">Buffer</span><span class="op" id="6359049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359053">for</span>&nbsp;<span class="ident" id="6359057">_</span><span class="op" id="6359058">,</span>&nbsp;<span class="ident" id="6359060">c</span>&nbsp;<span class="op" id="6359062">:=</span>&nbsp;<span class="keyword" id="6359065">range</span>&nbsp;<span class="ident" id="6359071">dec</span>&nbsp;<span class="op" id="6359075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359080">if</span>&nbsp;<span class="ident" id="6359083">c</span>&nbsp;<span class="op" id="6359085">&gt;=</span>&nbsp;<span class="num" id="6359088">0x80</span>&nbsp;<span class="op" id="6359093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359099">b</span><span class="op" id="6359100">.</span><span class="ident" id="6359101">WriteRune</span><span class="op" id="6359110">(</span><span class="ident" id="6359111">unicode</span><span class="op" id="6359118">.</span><span class="ident" id="6359119">ReplacementChar</span><span class="op" id="6359134">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359139">}</span>&nbsp;<span class="keyword" id="6359141">else</span>&nbsp;<span class="op" id="6359146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359152">b</span><span class="op" id="6359153">.</span><span class="ident" id="6359154">WriteRune</span><span class="op" id="6359163">(</span><span class="builtintype" id="6359164">rune</span><span class="op" id="6359168">(</span><span class="ident" id="6359169">c</span><span class="op" id="6359170">)</span><span class="op" id="6359171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359184">return</span>&nbsp;<span class="ident" id="6359191">b</span><span class="op" id="6359192">.</span><span class="ident" id="6359193">String</span><span class="op" id="6359199">(</span><span class="op" id="6359200">)</span><span class="op" id="6359201">,</span>&nbsp;<span class="ident" id="6359203">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359208">case</span>&nbsp;<span class="string" id="6359213">&#34;iso-8859-1&#34;</span><span class="op" id="6359225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359229">b</span>&nbsp;<span class="op" id="6359231">:=</span>&nbsp;<span class="builtinfunc" id="6359234">new</span><span class="op" id="6359237">(</span><span class="ident" id="6359238">bytes</span><span class="op" id="6359243">.</span><span class="ident" id="6359244">Buffer</span><span class="op" id="6359250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359254">for</span>&nbsp;<span class="ident" id="6359258">_</span><span class="op" id="6359259">,</span>&nbsp;<span class="ident" id="6359261">c</span>&nbsp;<span class="op" id="6359263">:=</span>&nbsp;<span class="keyword" id="6359266">range</span>&nbsp;<span class="ident" id="6359272">dec</span>&nbsp;<span class="op" id="6359276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359281">b</span><span class="op" id="6359282">.</span><span class="ident" id="6359283">WriteRune</span><span class="op" id="6359292">(</span><span class="builtintype" id="6359293">rune</span><span class="op" id="6359297">(</span><span class="ident" id="6359298">c</span><span class="op" id="6359299">)</span><span class="op" id="6359300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359304">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359308">return</span>&nbsp;<span class="ident" id="6359315">b</span><span class="op" id="6359316">.</span><span class="ident" id="6359317">String</span><span class="op" id="6359323">(</span><span class="op" id="6359324">)</span><span class="op" id="6359325">,</span>&nbsp;<span class="ident" id="6359327">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359332">case</span>&nbsp;<span class="string" id="6359337">&#34;utf-8&#34;</span><span class="op" id="6359344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359348">return</span>&nbsp;<span class="builtintype" id="6359355">string</span><span class="op" id="6359361">(</span><span class="ident" id="6359362">dec</span><span class="op" id="6359365">)</span><span class="op" id="6359366">,</span>&nbsp;<span class="ident" id="6359368">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6359376">panic</span><span class="op" id="6359381">(</span><span class="string" id="6359382">&#34;unreachable&#34;</span><span class="op" id="6359395">)</span><br>
<span class="lineno">490</span><span class="op" id="6359397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6359400">type</span>&nbsp;<span class="ident" id="6359405">qDecoder</span>&nbsp;<span class="keyword" id="6359414">struct</span>&nbsp;<span class="op" id="6359421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359424">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359432">io</span><span class="op" id="6359434">.</span><span class="ident" id="6359435">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359443">scratch</span>&nbsp;<span class="op" id="6359451">[</span><span class="num" id="6359452">2</span><span class="op" id="6359453">]</span><span class="builtintype" id="6359454">byte</span><br>
<span class="lineno">495</span><span class="op" id="6359459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6359462">func</span>&nbsp;<span class="op" id="6359467">(</span><span class="ident" id="6359468">qd</span>&nbsp;<span class="ident" id="6359471">qDecoder</span><span class="op" id="6359479">)</span>&nbsp;<span class="ident" id="6359481">Read</span><span class="op" id="6359485">(</span><span class="ident" id="6359486">p</span>&nbsp;<span class="op" id="6359488">[</span><span class="op" id="6359489">]</span><span class="builtintype" id="6359490">byte</span><span class="op" id="6359494">)</span>&nbsp;<span class="op" id="6359496">(</span><span class="ident" id="6359497">n</span>&nbsp;<span class="builtintype" id="6359499">int</span><span class="op" id="6359502">,</span>&nbsp;<span class="ident" id="6359504">err</span>&nbsp;<span class="builtintype" id="6359508">error</span><span class="op" id="6359513">)</span>&nbsp;<span class="op" id="6359515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6359518">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359566">if</span>&nbsp;<span class="builtinfunc" id="6359569">len</span><span class="op" id="6359572">(</span><span class="ident" id="6359573">p</span><span class="op" id="6359574">)</span>&nbsp;<span class="op" id="6359576">==</span>&nbsp;<span class="num" id="6359579">0</span>&nbsp;<span class="op" id="6359581">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359585">return</span>&nbsp;<span class="num" id="6359592">0</span><span class="op" id="6359593">,</span>&nbsp;<span class="ident" id="6359595">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359603">if</span>&nbsp;<span class="ident" id="6359606">_</span><span class="op" id="6359607">,</span>&nbsp;<span class="ident" id="6359609">err</span>&nbsp;<span class="op" id="6359613">:=</span>&nbsp;<span class="ident" id="6359616">qd</span><span class="op" id="6359618">.</span><span class="ident" id="6359619">r</span><span class="op" id="6359620">.</span><span class="ident" id="6359621">Read</span><span class="op" id="6359625">(</span><span class="ident" id="6359626">qd</span><span class="op" id="6359628">.</span><span class="ident" id="6359629">scratch</span><span class="op" id="6359636">[</span><span class="op" id="6359637">:</span><span class="num" id="6359638">1</span><span class="op" id="6359639">]</span><span class="op" id="6359640">)</span><span class="op" id="6359641">;</span>&nbsp;<span class="ident" id="6359643">err</span>&nbsp;<span class="op" id="6359647">!=</span>&nbsp;<span class="ident" id="6359650">nil</span>&nbsp;<span class="op" id="6359654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359658">return</span>&nbsp;<span class="num" id="6359665">0</span><span class="op" id="6359666">,</span>&nbsp;<span class="ident" id="6359668">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359673">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359676">switch</span>&nbsp;<span class="ident" id="6359683">c</span>&nbsp;<span class="op" id="6359685">:=</span>&nbsp;<span class="ident" id="6359688">qd</span><span class="op" id="6359690">.</span><span class="ident" id="6359691">scratch</span><span class="op" id="6359698">[</span><span class="num" id="6359699">0</span><span class="op" id="6359700">]</span><span class="op" id="6359701">;</span>&nbsp;<span class="op" id="6359703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359706">case</span>&nbsp;<span class="ident" id="6359711">c</span>&nbsp;<span class="op" id="6359713">==</span>&nbsp;<span class="string" id="6359716">&#39;=&#39;</span><span class="op" id="6359719">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359723">if</span>&nbsp;<span class="ident" id="6359726">_</span><span class="op" id="6359727">,</span>&nbsp;<span class="ident" id="6359729">err</span>&nbsp;<span class="op" id="6359733">:=</span>&nbsp;<span class="ident" id="6359736">io</span><span class="op" id="6359738">.</span><span class="ident" id="6359739">ReadFull</span><span class="op" id="6359747">(</span><span class="ident" id="6359748">qd</span><span class="op" id="6359750">.</span><span class="ident" id="6359751">r</span><span class="op" id="6359752">,</span>&nbsp;<span class="ident" id="6359754">qd</span><span class="op" id="6359756">.</span><span class="ident" id="6359757">scratch</span><span class="op" id="6359764">[</span><span class="op" id="6359765">:</span><span class="num" id="6359766">2</span><span class="op" id="6359767">]</span><span class="op" id="6359768">)</span><span class="op" id="6359769">;</span>&nbsp;<span class="ident" id="6359771">err</span>&nbsp;<span class="op" id="6359775">!=</span>&nbsp;<span class="ident" id="6359778">nil</span>&nbsp;<span class="op" id="6359782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359787">return</span>&nbsp;<span class="num" id="6359794">0</span><span class="op" id="6359795">,</span>&nbsp;<span class="ident" id="6359797">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359803">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359807">x</span><span class="op" id="6359808">,</span>&nbsp;<span class="ident" id="6359810">err</span>&nbsp;<span class="op" id="6359814">:=</span>&nbsp;<span class="ident" id="6359817">strconv</span><span class="op" id="6359824">.</span><span class="ident" id="6359825">ParseInt</span><span class="op" id="6359833">(</span><span class="builtintype" id="6359834">string</span><span class="op" id="6359840">(</span><span class="ident" id="6359841">qd</span><span class="op" id="6359843">.</span><span class="ident" id="6359844">scratch</span><span class="op" id="6359851">[</span><span class="op" id="6359852">:</span><span class="num" id="6359853">2</span><span class="op" id="6359854">]</span><span class="op" id="6359855">)</span><span class="op" id="6359856">,</span>&nbsp;<span class="num" id="6359858">16</span><span class="op" id="6359860">,</span>&nbsp;<span class="num" id="6359862">64</span><span class="op" id="6359864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359868">if</span>&nbsp;<span class="ident" id="6359871">err</span>&nbsp;<span class="op" id="6359875">!=</span>&nbsp;<span class="ident" id="6359878">nil</span>&nbsp;<span class="op" id="6359882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359887">return</span>&nbsp;<span class="num" id="6359894">0</span><span class="op" id="6359895">,</span>&nbsp;<span class="ident" id="6359897">fmt</span><span class="op" id="6359900">.</span><span class="ident" id="6359901">Errorf</span><span class="op" id="6359907">(</span><span class="string" id="6359908">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="6359945">,</span>&nbsp;<span class="ident" id="6359947">qd</span><span class="op" id="6359949">.</span><span class="ident" id="6359950">scratch</span><span class="op" id="6359957">[</span><span class="op" id="6359958">:</span><span class="num" id="6359959">2</span><span class="op" id="6359960">]</span><span class="op" id="6359961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6359965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359969">p</span><span class="op" id="6359970">[</span><span class="num" id="6359971">0</span><span class="op" id="6359972">]</span>&nbsp;<span class="op" id="6359974">=</span>&nbsp;<span class="builtintype" id="6359976">byte</span><span class="op" id="6359980">(</span><span class="ident" id="6359981">x</span><span class="op" id="6359982">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6359985">case</span>&nbsp;<span class="ident" id="6359990">c</span>&nbsp;<span class="op" id="6359992">==</span>&nbsp;<span class="string" id="6359995">&#39;_&#39;</span><span class="op" id="6359998">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360002">p</span><span class="op" id="6360003">[</span><span class="num" id="6360004">0</span><span class="op" id="6360005">]</span>&nbsp;<span class="op" id="6360007">=</span>&nbsp;<span class="string" id="6360009">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360014">default</span><span class="op" id="6360021">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360025">p</span><span class="op" id="6360026">[</span><span class="num" id="6360027">0</span><span class="op" id="6360028">]</span>&nbsp;<span class="op" id="6360030">=</span>&nbsp;<span class="ident" id="6360032">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6360035">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360038">return</span>&nbsp;<span class="num" id="6360045">1</span><span class="op" id="6360046">,</span>&nbsp;<span class="ident" id="6360048">nil</span><br>
<span class="lineno"></span><span class="op" id="6360052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6360055">var</span>&nbsp;<span class="ident" id="6360059">atextChars</span>&nbsp;<span class="op" id="6360070">=</span>&nbsp;<span class="op" id="6360072">[</span><span class="op" id="6360073">]</span><span class="builtintype" id="6360074">byte</span><span class="op" id="6360078">(</span><span class="string" id="6360079">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="6360108">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6360111">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="6360140">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6360143">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="6360156">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6360159">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="6360180">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360183">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="6360244">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="6360283">func</span>&nbsp;<span class="ident" id="6360288">isAtext</span><span class="op" id="6360295">(</span><span class="ident" id="6360296">c</span>&nbsp;<span class="builtintype" id="6360298">byte</span><span class="op" id="6360302">,</span>&nbsp;<span class="ident" id="6360304">dot</span>&nbsp;<span class="builtintype" id="6360308">bool</span><span class="op" id="6360312">)</span>&nbsp;<span class="builtintype" id="6360314">bool</span>&nbsp;<span class="op" id="6360319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360322">if</span>&nbsp;<span class="ident" id="6360325">dot</span>&nbsp;<span class="op" id="6360329">&amp;&amp;</span>&nbsp;<span class="ident" id="6360332">c</span>&nbsp;<span class="op" id="6360334">==</span>&nbsp;<span class="string" id="6360337">&#39;.&#39;</span>&nbsp;<span class="op" id="6360341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360345">return</span>&nbsp;<span class="builtintype" id="6360352">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6360358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360361">return</span>&nbsp;<span class="ident" id="6360368">bytes</span><span class="op" id="6360373">.</span><span class="ident" id="6360374">IndexByte</span><span class="op" id="6360383">(</span><span class="ident" id="6360384">atextChars</span><span class="op" id="6360394">,</span>&nbsp;<span class="ident" id="6360396">c</span><span class="op" id="6360397">)</span>&nbsp;<span class="op" id="6360399">&gt;=</span>&nbsp;<span class="num" id="6360402">0</span><br>
<span class="lineno">535</span><span class="op" id="6360404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360407">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="6360468">func</span>&nbsp;<span class="ident" id="6360473">isQtext</span><span class="op" id="6360480">(</span><span class="ident" id="6360481">c</span>&nbsp;<span class="builtintype" id="6360483">byte</span><span class="op" id="6360487">)</span>&nbsp;<span class="builtintype" id="6360489">bool</span>&nbsp;<span class="op" id="6360494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360497">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360551">if</span>&nbsp;<span class="ident" id="6360554">c</span>&nbsp;<span class="op" id="6360556">==</span>&nbsp;<span class="string" id="6360559">&#39;\\&#39;</span>&nbsp;<span class="op" id="6360564">||</span>&nbsp;<span class="ident" id="6360567">c</span>&nbsp;<span class="op" id="6360569">==</span>&nbsp;<span class="string" id="6360572">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6360576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360580">return</span>&nbsp;<span class="builtintype" id="6360587">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6360594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360597">return</span>&nbsp;<span class="string" id="6360604">&#39;!&#39;</span>&nbsp;<span class="op" id="6360608">&lt;=</span>&nbsp;<span class="ident" id="6360611">c</span>&nbsp;<span class="op" id="6360613">&amp;&amp;</span>&nbsp;<span class="ident" id="6360616">c</span>&nbsp;<span class="op" id="6360618">&lt;=</span>&nbsp;<span class="string" id="6360621">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="6360625">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="6360628">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="6360689">func</span>&nbsp;<span class="ident" id="6360694">isVchar</span><span class="op" id="6360701">(</span><span class="ident" id="6360702">c</span>&nbsp;<span class="builtintype" id="6360704">byte</span><span class="op" id="6360708">)</span>&nbsp;<span class="builtintype" id="6360710">bool</span>&nbsp;<span class="op" id="6360715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360718">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360753">return</span>&nbsp;<span class="string" id="6360760">&#39;!&#39;</span>&nbsp;<span class="op" id="6360764">&lt;=</span>&nbsp;<span class="ident" id="6360767">c</span>&nbsp;<span class="op" id="6360769">&amp;&amp;</span>&nbsp;<span class="ident" id="6360772">c</span>&nbsp;<span class="op" id="6360774">&lt;=</span>&nbsp;<span class="string" id="6360777">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="6360781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360784">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="6360835">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="6360893">func</span>&nbsp;<span class="ident" id="6360898">isWSP</span><span class="op" id="6360903">(</span><span class="ident" id="6360904">c</span>&nbsp;<span class="builtintype" id="6360906">byte</span><span class="op" id="6360910">)</span>&nbsp;<span class="builtintype" id="6360912">bool</span>&nbsp;<span class="op" id="6360917">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360920">return</span>&nbsp;<span class="ident" id="6360927">c</span>&nbsp;<span class="op" id="6360929">==</span>&nbsp;<span class="string" id="6360932">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="6360936">||</span>&nbsp;<span class="ident" id="6360939">c</span>&nbsp;<span class="op" id="6360941">==</span>&nbsp;<span class="string" id="6360944">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="6360949">}</span>
</div>
</body>
</html>
