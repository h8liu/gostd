<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1606542">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1606597">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1606651">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1606702">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1606723">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1606780">package</span>&nbsp;<span class="ident" id="1606788">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1606797">import</span>&nbsp;<span class="op" id="1606804">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1606807">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1606816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1606819">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1606894">var</span>&nbsp;<span class="ident" id="1606898">proflock</span>&nbsp;<span class="ident" id="1606907">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1606914">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1606993">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1607067">const</span>&nbsp;<span class="op" id="1607073">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607076">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607094">memProfile</span>&nbsp;<span class="ident" id="1607105">bucketType</span>&nbsp;<span class="op" id="1607116">=</span>&nbsp;<span class="num" id="1607118">1</span>&nbsp;<span class="op" id="1607120">+</span>&nbsp;<span class="ident" id="1607122">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607128">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607143">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607173">buckHashSize</span>&nbsp;<span class="op" id="1607186">=</span>&nbsp;<span class="num" id="1607188">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607197">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607240">maxStack</span>&nbsp;<span class="op" id="1607249">=</span>&nbsp;<span class="num" id="1607251">32</span><br>
<span class="lineno">30</span><span class="op" id="1607254">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607257">type</span>&nbsp;<span class="ident" id="1607262">bucketType</span>&nbsp;<span class="builtintype" id="1607273">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1607278">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1607334">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1607391">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1607451">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1607507">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1607553">//</span><br>
<span class="lineno">40</span><span class="comment" id="1607556">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1607597">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1607660">type</span>&nbsp;<span class="ident" id="1607665">bucket</span>&nbsp;<span class="keyword" id="1607672">struct</span>&nbsp;<span class="op" id="1607679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607682">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607690">*</span><span class="ident" id="1607691">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607699">allnext</span>&nbsp;<span class="op" id="1607707">*</span><span class="ident" id="1607708">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607716">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607724">bucketType</span>&nbsp;<span class="comment" id="1607735">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607764">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1607772">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607781">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1607789">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607798">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1607806">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1607814">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1607817">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1607884">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1607915">type</span>&nbsp;<span class="ident" id="1607920">memRecord</span>&nbsp;<span class="keyword" id="1607930">struct</span>&nbsp;<span class="op" id="1607937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607940">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608003">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608071">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608099">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608162">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608230">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608290">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608294">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608337">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608387">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608429">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608482">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608526">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1608538">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608547">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1608559">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608568">alloc_bytes</span>&nbsp;<span class="builtintype" id="1608580">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608589">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1608601">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608611">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608659">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1608676">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608685">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1608702">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608711">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1608728">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608737">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1608754">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608764">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608790">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1608809">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608818">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1608837">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608846">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1608865">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608874">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1608893">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1608901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1608904">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1608975">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1609008">type</span>&nbsp;<span class="ident" id="1609013">blockRecord</span>&nbsp;<span class="keyword" id="1609025">struct</span>&nbsp;<span class="op" id="1609032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609035">count</span>&nbsp;&nbsp;<span class="ident" id="1609042">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609049">cycles</span>&nbsp;<span class="ident" id="1609056">int64</span><br>
<span class="lineno"></span><span class="op" id="1609062">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1609065">var</span>&nbsp;<span class="op" id="1609069">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609072">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1609082">*</span><span class="ident" id="1609083">bucket</span>&nbsp;<span class="comment" id="1609090">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609117">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1609127">*</span><span class="ident" id="1609128">bucket</span>&nbsp;<span class="comment" id="1609135">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609164">buckhash</span>&nbsp;&nbsp;<span class="op" id="1609174">*</span><span class="op" id="1609175">[</span><span class="num" id="1609176">179999</span><span class="op" id="1609182">]</span><span class="op" id="1609183">*</span><span class="ident" id="1609184">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609192">bucketmem</span>&nbsp;<span class="builtintype" id="1609202">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1609210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609213">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1609294">func</span>&nbsp;<span class="ident" id="1609299">newBucket</span><span class="op" id="1609308">(</span><span class="ident" id="1609309">typ</span>&nbsp;<span class="ident" id="1609313">bucketType</span><span class="op" id="1609323">,</span>&nbsp;<span class="ident" id="1609325">nstk</span>&nbsp;<span class="builtintype" id="1609330">int</span><span class="op" id="1609333">)</span>&nbsp;<span class="op" id="1609335">*</span><span class="ident" id="1609336">bucket</span>&nbsp;<span class="op" id="1609343">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609346">size</span>&nbsp;<span class="op" id="1609351">:=</span>&nbsp;<span class="ident" id="1609354">unsafe</span><span class="op" id="1609360">.</span><span class="ident" id="1609361">Sizeof</span><span class="op" id="1609367">(</span><span class="ident" id="1609368">bucket</span><span class="op" id="1609374">{</span><span class="op" id="1609375">}</span><span class="op" id="1609376">)</span>&nbsp;<span class="op" id="1609378">+</span>&nbsp;<span class="builtintype" id="1609380">uintptr</span><span class="op" id="1609387">(</span><span class="ident" id="1609388">nstk</span><span class="op" id="1609392">)</span><span class="op" id="1609393">*</span><span class="ident" id="1609394">unsafe</span><span class="op" id="1609400">.</span><span class="ident" id="1609401">Sizeof</span><span class="op" id="1609407">(</span><span class="builtintype" id="1609408">uintptr</span><span class="op" id="1609415">(</span><span class="num" id="1609416">0</span><span class="op" id="1609417">)</span><span class="op" id="1609418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609421">switch</span>&nbsp;<span class="ident" id="1609428">typ</span>&nbsp;<span class="op" id="1609432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609435">default</span><span class="op" id="1609442">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609446">gothrow</span><span class="op" id="1609453">(</span><span class="string" id="1609454">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1609483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609486">case</span>&nbsp;<span class="ident" id="1609491">memProfile</span><span class="op" id="1609501">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609505">size</span>&nbsp;<span class="op" id="1609510">+=</span>&nbsp;<span class="ident" id="1609513">unsafe</span><span class="op" id="1609519">.</span><span class="ident" id="1609520">Sizeof</span><span class="op" id="1609526">(</span><span class="ident" id="1609527">memRecord</span><span class="op" id="1609536">{</span><span class="op" id="1609537">}</span><span class="op" id="1609538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609541">case</span>&nbsp;<span class="ident" id="1609546">blockProfile</span><span class="op" id="1609558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609562">size</span>&nbsp;<span class="op" id="1609567">+=</span>&nbsp;<span class="ident" id="1609570">unsafe</span><span class="op" id="1609576">.</span><span class="ident" id="1609577">Sizeof</span><span class="op" id="1609583">(</span><span class="ident" id="1609584">blockRecord</span><span class="op" id="1609595">{</span><span class="op" id="1609596">}</span><span class="op" id="1609597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609604">b</span>&nbsp;<span class="op" id="1609606">:=</span>&nbsp;<span class="op" id="1609609">(</span><span class="op" id="1609610">*</span><span class="ident" id="1609611">bucket</span><span class="op" id="1609617">)</span><span class="op" id="1609618">(</span><span class="ident" id="1609619">persistentalloc</span><span class="op" id="1609634">(</span><span class="ident" id="1609635">size</span><span class="op" id="1609639">,</span>&nbsp;<span class="num" id="1609641">0</span><span class="op" id="1609642">,</span>&nbsp;<span class="op" id="1609644">&amp;</span><span class="ident" id="1609645">memstats</span><span class="op" id="1609653">.</span><span class="ident" id="1609654">buckhash_sys</span><span class="op" id="1609666">)</span><span class="op" id="1609667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609670">bucketmem</span>&nbsp;<span class="op" id="1609680">+=</span>&nbsp;<span class="ident" id="1609683">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609689">b</span><span class="op" id="1609690">.</span><span class="ident" id="1609691">typ</span>&nbsp;<span class="op" id="1609695">=</span>&nbsp;<span class="ident" id="1609697">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609702">b</span><span class="op" id="1609703">.</span><span class="ident" id="1609704">nstk</span>&nbsp;<span class="op" id="1609709">=</span>&nbsp;<span class="builtintype" id="1609711">uintptr</span><span class="op" id="1609718">(</span><span class="ident" id="1609719">nstk</span><span class="op" id="1609723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609726">return</span>&nbsp;<span class="ident" id="1609733">b</span><br>
<span class="lineno">115</span><span class="op" id="1609735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609738">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1609787">func</span>&nbsp;<span class="op" id="1609792">(</span><span class="ident" id="1609793">b</span>&nbsp;<span class="op" id="1609795">*</span><span class="ident" id="1609796">bucket</span><span class="op" id="1609802">)</span>&nbsp;<span class="ident" id="1609804">stk</span><span class="op" id="1609807">(</span><span class="op" id="1609808">)</span>&nbsp;<span class="op" id="1609810">[</span><span class="op" id="1609811">]</span><span class="builtintype" id="1609812">uintptr</span>&nbsp;<span class="op" id="1609820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609823">stk</span>&nbsp;<span class="op" id="1609827">:=</span>&nbsp;<span class="op" id="1609830">(</span><span class="op" id="1609831">*</span><span class="op" id="1609832">[</span><span class="ident" id="1609833">maxStack</span><span class="op" id="1609841">]</span><span class="builtintype" id="1609842">uintptr</span><span class="op" id="1609849">)</span><span class="op" id="1609850">(</span><span class="ident" id="1609851">add</span><span class="op" id="1609854">(</span><span class="ident" id="1609855">unsafe</span><span class="op" id="1609861">.</span><span class="ident" id="1609862">Pointer</span><span class="op" id="1609869">(</span><span class="ident" id="1609870">b</span><span class="op" id="1609871">)</span><span class="op" id="1609872">,</span>&nbsp;<span class="ident" id="1609874">unsafe</span><span class="op" id="1609880">.</span><span class="ident" id="1609881">Sizeof</span><span class="op" id="1609887">(</span><span class="op" id="1609888">*</span><span class="ident" id="1609889">b</span><span class="op" id="1609890">)</span><span class="op" id="1609891">)</span><span class="op" id="1609892">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609895">return</span>&nbsp;<span class="ident" id="1609902">stk</span><span class="op" id="1609905">[</span><span class="op" id="1609906">:</span><span class="ident" id="1609907">b</span><span class="op" id="1609908">.</span><span class="ident" id="1609909">nstk</span><span class="op" id="1609913">:</span><span class="ident" id="1609914">b</span><span class="op" id="1609915">.</span><span class="ident" id="1609916">nstk</span><span class="op" id="1609920">]</span><br>
<span class="lineno"></span><span class="op" id="1609922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609925">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1609994">func</span>&nbsp;<span class="op" id="1609999">(</span><span class="ident" id="1610000">b</span>&nbsp;<span class="op" id="1610002">*</span><span class="ident" id="1610003">bucket</span><span class="op" id="1610009">)</span>&nbsp;<span class="ident" id="1610011">mp</span><span class="op" id="1610013">(</span><span class="op" id="1610014">)</span>&nbsp;<span class="op" id="1610016">*</span><span class="ident" id="1610017">memRecord</span>&nbsp;<span class="op" id="1610027">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610030">if</span>&nbsp;<span class="ident" id="1610033">b</span><span class="op" id="1610034">.</span><span class="ident" id="1610035">typ</span>&nbsp;<span class="op" id="1610039">!=</span>&nbsp;<span class="ident" id="1610042">memProfile</span>&nbsp;<span class="op" id="1610053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610057">gothrow</span><span class="op" id="1610064">(</span><span class="string" id="1610065">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1610087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610093">data</span>&nbsp;<span class="op" id="1610098">:=</span>&nbsp;<span class="ident" id="1610101">add</span><span class="op" id="1610104">(</span><span class="ident" id="1610105">unsafe</span><span class="op" id="1610111">.</span><span class="ident" id="1610112">Pointer</span><span class="op" id="1610119">(</span><span class="ident" id="1610120">b</span><span class="op" id="1610121">)</span><span class="op" id="1610122">,</span>&nbsp;<span class="ident" id="1610124">unsafe</span><span class="op" id="1610130">.</span><span class="ident" id="1610131">Sizeof</span><span class="op" id="1610137">(</span><span class="op" id="1610138">*</span><span class="ident" id="1610139">b</span><span class="op" id="1610140">)</span><span class="op" id="1610141">+</span><span class="ident" id="1610142">b</span><span class="op" id="1610143">.</span><span class="ident" id="1610144">nstk</span><span class="op" id="1610148">*</span><span class="ident" id="1610149">unsafe</span><span class="op" id="1610155">.</span><span class="ident" id="1610156">Sizeof</span><span class="op" id="1610162">(</span><span class="builtintype" id="1610163">uintptr</span><span class="op" id="1610170">(</span><span class="num" id="1610171">0</span><span class="op" id="1610172">)</span><span class="op" id="1610173">)</span><span class="op" id="1610174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610177">return</span>&nbsp;<span class="op" id="1610184">(</span><span class="op" id="1610185">*</span><span class="ident" id="1610186">memRecord</span><span class="op" id="1610195">)</span><span class="op" id="1610196">(</span><span class="ident" id="1610197">data</span><span class="op" id="1610201">)</span><br>
<span class="lineno">130</span><span class="op" id="1610203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610206">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1610279">func</span>&nbsp;<span class="op" id="1610284">(</span><span class="ident" id="1610285">b</span>&nbsp;<span class="op" id="1610287">*</span><span class="ident" id="1610288">bucket</span><span class="op" id="1610294">)</span>&nbsp;<span class="ident" id="1610296">bp</span><span class="op" id="1610298">(</span><span class="op" id="1610299">)</span>&nbsp;<span class="op" id="1610301">*</span><span class="ident" id="1610302">blockRecord</span>&nbsp;<span class="op" id="1610314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610317">if</span>&nbsp;<span class="ident" id="1610320">b</span><span class="op" id="1610321">.</span><span class="ident" id="1610322">typ</span>&nbsp;<span class="op" id="1610326">!=</span>&nbsp;<span class="ident" id="1610329">blockProfile</span>&nbsp;<span class="op" id="1610342">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610346">gothrow</span><span class="op" id="1610353">(</span><span class="string" id="1610354">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1610376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610382">data</span>&nbsp;<span class="op" id="1610387">:=</span>&nbsp;<span class="ident" id="1610390">add</span><span class="op" id="1610393">(</span><span class="ident" id="1610394">unsafe</span><span class="op" id="1610400">.</span><span class="ident" id="1610401">Pointer</span><span class="op" id="1610408">(</span><span class="ident" id="1610409">b</span><span class="op" id="1610410">)</span><span class="op" id="1610411">,</span>&nbsp;<span class="ident" id="1610413">unsafe</span><span class="op" id="1610419">.</span><span class="ident" id="1610420">Sizeof</span><span class="op" id="1610426">(</span><span class="op" id="1610427">*</span><span class="ident" id="1610428">b</span><span class="op" id="1610429">)</span><span class="op" id="1610430">+</span><span class="ident" id="1610431">b</span><span class="op" id="1610432">.</span><span class="ident" id="1610433">nstk</span><span class="op" id="1610437">*</span><span class="ident" id="1610438">unsafe</span><span class="op" id="1610444">.</span><span class="ident" id="1610445">Sizeof</span><span class="op" id="1610451">(</span><span class="builtintype" id="1610452">uintptr</span><span class="op" id="1610459">(</span><span class="num" id="1610460">0</span><span class="op" id="1610461">)</span><span class="op" id="1610462">)</span><span class="op" id="1610463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610466">return</span>&nbsp;<span class="op" id="1610473">(</span><span class="op" id="1610474">*</span><span class="ident" id="1610475">blockRecord</span><span class="op" id="1610486">)</span><span class="op" id="1610487">(</span><span class="ident" id="1610488">data</span><span class="op" id="1610492">)</span><br>
<span class="lineno"></span><span class="op" id="1610494">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1610497">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1610568">func</span>&nbsp;<span class="ident" id="1610573">stkbucket</span><span class="op" id="1610582">(</span><span class="ident" id="1610583">typ</span>&nbsp;<span class="ident" id="1610587">bucketType</span><span class="op" id="1610597">,</span>&nbsp;<span class="ident" id="1610599">size</span>&nbsp;<span class="builtintype" id="1610604">uintptr</span><span class="op" id="1610611">,</span>&nbsp;<span class="ident" id="1610613">stk</span>&nbsp;<span class="op" id="1610617">[</span><span class="op" id="1610618">]</span><span class="builtintype" id="1610619">uintptr</span><span class="op" id="1610626">,</span>&nbsp;<span class="ident" id="1610628">alloc</span>&nbsp;<span class="builtintype" id="1610634">bool</span><span class="op" id="1610638">)</span>&nbsp;<span class="op" id="1610640">*</span><span class="ident" id="1610641">bucket</span>&nbsp;<span class="op" id="1610648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610651">if</span>&nbsp;<span class="ident" id="1610654">buckhash</span>&nbsp;<span class="op" id="1610663">==</span>&nbsp;<span class="ident" id="1610666">nil</span>&nbsp;<span class="op" id="1610670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610674">buckhash</span>&nbsp;<span class="op" id="1610683">=</span>&nbsp;<span class="op" id="1610685">(</span><span class="op" id="1610686">*</span><span class="op" id="1610687">[</span><span class="ident" id="1610688">buckHashSize</span><span class="op" id="1610700">]</span><span class="op" id="1610701">*</span><span class="ident" id="1610702">bucket</span><span class="op" id="1610708">)</span><span class="op" id="1610709">(</span><span class="ident" id="1610710">sysAlloc</span><span class="op" id="1610718">(</span><span class="ident" id="1610719">unsafe</span><span class="op" id="1610725">.</span><span class="ident" id="1610726">Sizeof</span><span class="op" id="1610732">(</span><span class="op" id="1610733">*</span><span class="ident" id="1610734">buckhash</span><span class="op" id="1610742">)</span><span class="op" id="1610743">,</span>&nbsp;<span class="op" id="1610745">&amp;</span><span class="ident" id="1610746">memstats</span><span class="op" id="1610754">.</span><span class="ident" id="1610755">buckhash_sys</span><span class="op" id="1610767">)</span><span class="op" id="1610768">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610772">if</span>&nbsp;<span class="ident" id="1610775">buckhash</span>&nbsp;<span class="op" id="1610784">==</span>&nbsp;<span class="ident" id="1610787">nil</span>&nbsp;<span class="op" id="1610791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610796">gothrow</span><span class="op" id="1610803">(</span><span class="string" id="1610804">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1610837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610848">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610864">var</span>&nbsp;<span class="ident" id="1610868">h</span>&nbsp;<span class="builtintype" id="1610870">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610879">for</span>&nbsp;<span class="ident" id="1610883">_</span><span class="op" id="1610884">,</span>&nbsp;<span class="ident" id="1610886">pc</span>&nbsp;<span class="op" id="1610889">:=</span>&nbsp;<span class="keyword" id="1610892">range</span>&nbsp;<span class="ident" id="1610898">stk</span>&nbsp;<span class="op" id="1610902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610906">h</span>&nbsp;<span class="op" id="1610908">+=</span>&nbsp;<span class="ident" id="1610911">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610916">h</span>&nbsp;<span class="op" id="1610918">+=</span>&nbsp;<span class="ident" id="1610921">h</span>&nbsp;<span class="op" id="1610923">&lt;&lt;</span>&nbsp;<span class="num" id="1610926">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610931">h</span>&nbsp;<span class="op" id="1610933">^=</span>&nbsp;<span class="ident" id="1610936">h</span>&nbsp;<span class="op" id="1610938">&gt;&gt;</span>&nbsp;<span class="num" id="1610941">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1610947">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610964">h</span>&nbsp;<span class="op" id="1610966">+=</span>&nbsp;<span class="ident" id="1610969">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610975">h</span>&nbsp;<span class="op" id="1610977">+=</span>&nbsp;<span class="ident" id="1610980">h</span>&nbsp;<span class="op" id="1610982">&lt;&lt;</span>&nbsp;<span class="num" id="1610985">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610989">h</span>&nbsp;<span class="op" id="1610991">^=</span>&nbsp;<span class="ident" id="1610994">h</span>&nbsp;<span class="op" id="1610996">&gt;&gt;</span>&nbsp;<span class="num" id="1610999">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611002">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611015">h</span>&nbsp;<span class="op" id="1611017">+=</span>&nbsp;<span class="ident" id="1611020">h</span>&nbsp;<span class="op" id="1611022">&lt;&lt;</span>&nbsp;<span class="num" id="1611025">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611028">h</span>&nbsp;<span class="op" id="1611030">^=</span>&nbsp;<span class="ident" id="1611033">h</span>&nbsp;<span class="op" id="1611035">&gt;&gt;</span>&nbsp;<span class="num" id="1611038">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611043">i</span>&nbsp;<span class="op" id="1611045">:=</span>&nbsp;<span class="builtintype" id="1611048">int</span><span class="op" id="1611051">(</span><span class="ident" id="1611052">h</span>&nbsp;<span class="op" id="1611054">%</span>&nbsp;<span class="ident" id="1611056">buckHashSize</span><span class="op" id="1611068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611071">for</span>&nbsp;<span class="ident" id="1611075">b</span>&nbsp;<span class="op" id="1611077">:=</span>&nbsp;<span class="ident" id="1611080">buckhash</span><span class="op" id="1611088">[</span><span class="ident" id="1611089">i</span><span class="op" id="1611090">]</span><span class="op" id="1611091">;</span>&nbsp;<span class="ident" id="1611093">b</span>&nbsp;<span class="op" id="1611095">!=</span>&nbsp;<span class="ident" id="1611098">nil</span><span class="op" id="1611101">;</span>&nbsp;<span class="ident" id="1611103">b</span>&nbsp;<span class="op" id="1611105">=</span>&nbsp;<span class="ident" id="1611107">b</span><span class="op" id="1611108">.</span><span class="ident" id="1611109">next</span>&nbsp;<span class="op" id="1611114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611118">if</span>&nbsp;<span class="ident" id="1611121">b</span><span class="op" id="1611122">.</span><span class="ident" id="1611123">typ</span>&nbsp;<span class="op" id="1611127">==</span>&nbsp;<span class="ident" id="1611130">typ</span>&nbsp;<span class="op" id="1611134">&amp;&amp;</span>&nbsp;<span class="ident" id="1611137">b</span><span class="op" id="1611138">.</span><span class="ident" id="1611139">hash</span>&nbsp;<span class="op" id="1611144">==</span>&nbsp;<span class="ident" id="1611147">h</span>&nbsp;<span class="op" id="1611149">&amp;&amp;</span>&nbsp;<span class="ident" id="1611152">b</span><span class="op" id="1611153">.</span><span class="ident" id="1611154">size</span>&nbsp;<span class="op" id="1611159">==</span>&nbsp;<span class="ident" id="1611162">size</span>&nbsp;<span class="op" id="1611167">&amp;&amp;</span>&nbsp;<span class="ident" id="1611170">eqslice</span><span class="op" id="1611177">(</span><span class="ident" id="1611178">b</span><span class="op" id="1611179">.</span><span class="ident" id="1611180">stk</span><span class="op" id="1611183">(</span><span class="op" id="1611184">)</span><span class="op" id="1611185">,</span>&nbsp;<span class="ident" id="1611187">stk</span><span class="op" id="1611190">)</span>&nbsp;<span class="op" id="1611192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611197">return</span>&nbsp;<span class="ident" id="1611204">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611208">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611215">if</span>&nbsp;<span class="op" id="1611218">!</span><span class="ident" id="1611219">alloc</span>&nbsp;<span class="op" id="1611225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611229">return</span>&nbsp;<span class="ident" id="1611236">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611241">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611245">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611268">b</span>&nbsp;<span class="op" id="1611270">:=</span>&nbsp;<span class="ident" id="1611273">newBucket</span><span class="op" id="1611282">(</span><span class="ident" id="1611283">typ</span><span class="op" id="1611286">,</span>&nbsp;<span class="builtinfunc" id="1611288">len</span><span class="op" id="1611291">(</span><span class="ident" id="1611292">stk</span><span class="op" id="1611295">)</span><span class="op" id="1611296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1611299">copy</span><span class="op" id="1611303">(</span><span class="ident" id="1611304">b</span><span class="op" id="1611305">.</span><span class="ident" id="1611306">stk</span><span class="op" id="1611309">(</span><span class="op" id="1611310">)</span><span class="op" id="1611311">,</span>&nbsp;<span class="ident" id="1611313">stk</span><span class="op" id="1611316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611319">b</span><span class="op" id="1611320">.</span><span class="ident" id="1611321">hash</span>&nbsp;<span class="op" id="1611326">=</span>&nbsp;<span class="ident" id="1611328">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611331">b</span><span class="op" id="1611332">.</span><span class="ident" id="1611333">size</span>&nbsp;<span class="op" id="1611338">=</span>&nbsp;<span class="ident" id="1611340">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611346">b</span><span class="op" id="1611347">.</span><span class="ident" id="1611348">next</span>&nbsp;<span class="op" id="1611353">=</span>&nbsp;<span class="ident" id="1611355">buckhash</span><span class="op" id="1611363">[</span><span class="ident" id="1611364">i</span><span class="op" id="1611365">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611368">buckhash</span><span class="op" id="1611376">[</span><span class="ident" id="1611377">i</span><span class="op" id="1611378">]</span>&nbsp;<span class="op" id="1611380">=</span>&nbsp;<span class="ident" id="1611382">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611385">if</span>&nbsp;<span class="ident" id="1611388">typ</span>&nbsp;<span class="op" id="1611392">==</span>&nbsp;<span class="ident" id="1611395">memProfile</span>&nbsp;<span class="op" id="1611406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611410">b</span><span class="op" id="1611411">.</span><span class="ident" id="1611412">allnext</span>&nbsp;<span class="op" id="1611420">=</span>&nbsp;<span class="ident" id="1611422">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611433">mbuckets</span>&nbsp;<span class="op" id="1611442">=</span>&nbsp;<span class="ident" id="1611444">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611447">}</span>&nbsp;<span class="keyword" id="1611449">else</span>&nbsp;<span class="op" id="1611454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611458">b</span><span class="op" id="1611459">.</span><span class="ident" id="1611460">allnext</span>&nbsp;<span class="op" id="1611468">=</span>&nbsp;<span class="ident" id="1611470">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611481">bbuckets</span>&nbsp;<span class="op" id="1611490">=</span>&nbsp;<span class="ident" id="1611492">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611495">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611498">return</span>&nbsp;<span class="ident" id="1611505">b</span><br>
<span class="lineno"></span><span class="op" id="1611507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1611510">func</span>&nbsp;<span class="ident" id="1611515">sysAlloc</span><span class="op" id="1611523">(</span><span class="ident" id="1611524">n</span>&nbsp;<span class="builtintype" id="1611526">uintptr</span><span class="op" id="1611533">,</span>&nbsp;<span class="ident" id="1611535">stat</span>&nbsp;<span class="op" id="1611540">*</span><span class="ident" id="1611541">uint64</span><span class="op" id="1611547">)</span>&nbsp;<span class="ident" id="1611549">unsafe</span><span class="op" id="1611555">.</span><span class="ident" id="1611556">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1611565">func</span>&nbsp;<span class="ident" id="1611570">eqslice</span><span class="op" id="1611577">(</span><span class="ident" id="1611578">x</span><span class="op" id="1611579">,</span>&nbsp;<span class="ident" id="1611581">y</span>&nbsp;<span class="op" id="1611583">[</span><span class="op" id="1611584">]</span><span class="builtintype" id="1611585">uintptr</span><span class="op" id="1611592">)</span>&nbsp;<span class="builtintype" id="1611594">bool</span>&nbsp;<span class="op" id="1611599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611602">if</span>&nbsp;<span class="builtinfunc" id="1611605">len</span><span class="op" id="1611608">(</span><span class="ident" id="1611609">x</span><span class="op" id="1611610">)</span>&nbsp;<span class="op" id="1611612">!=</span>&nbsp;<span class="builtinfunc" id="1611615">len</span><span class="op" id="1611618">(</span><span class="ident" id="1611619">y</span><span class="op" id="1611620">)</span>&nbsp;<span class="op" id="1611622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611626">return</span>&nbsp;<span class="ident" id="1611633">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611643">for</span>&nbsp;<span class="ident" id="1611647">i</span><span class="op" id="1611648">,</span>&nbsp;<span class="ident" id="1611650">xi</span>&nbsp;<span class="op" id="1611653">:=</span>&nbsp;<span class="keyword" id="1611656">range</span>&nbsp;<span class="ident" id="1611662">x</span>&nbsp;<span class="op" id="1611664">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611668">if</span>&nbsp;<span class="ident" id="1611671">xi</span>&nbsp;<span class="op" id="1611674">!=</span>&nbsp;<span class="ident" id="1611677">y</span><span class="op" id="1611678">[</span><span class="ident" id="1611679">i</span><span class="op" id="1611680">]</span>&nbsp;<span class="op" id="1611682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611687">return</span>&nbsp;<span class="ident" id="1611694">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611708">return</span>&nbsp;<span class="ident" id="1611715">true</span><br>
<span class="lineno">205</span><span class="op" id="1611720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1611723">func</span>&nbsp;<span class="ident" id="1611728">mprof_GC</span><span class="op" id="1611736">(</span><span class="op" id="1611737">)</span>&nbsp;<span class="op" id="1611739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611742">for</span>&nbsp;<span class="ident" id="1611746">b</span>&nbsp;<span class="op" id="1611748">:=</span>&nbsp;<span class="ident" id="1611751">mbuckets</span><span class="op" id="1611759">;</span>&nbsp;<span class="ident" id="1611761">b</span>&nbsp;<span class="op" id="1611763">!=</span>&nbsp;<span class="ident" id="1611766">nil</span><span class="op" id="1611769">;</span>&nbsp;<span class="ident" id="1611771">b</span>&nbsp;<span class="op" id="1611773">=</span>&nbsp;<span class="ident" id="1611775">b</span><span class="op" id="1611776">.</span><span class="ident" id="1611777">allnext</span>&nbsp;<span class="op" id="1611785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611789">mp</span>&nbsp;<span class="op" id="1611792">:=</span>&nbsp;<span class="ident" id="1611795">b</span><span class="op" id="1611796">.</span><span class="ident" id="1611797">mp</span><span class="op" id="1611799">(</span><span class="op" id="1611800">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611804">mp</span><span class="op" id="1611806">.</span><span class="ident" id="1611807">allocs</span>&nbsp;<span class="op" id="1611814">+=</span>&nbsp;<span class="ident" id="1611817">mp</span><span class="op" id="1611819">.</span><span class="ident" id="1611820">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611834">mp</span><span class="op" id="1611836">.</span><span class="ident" id="1611837">frees</span>&nbsp;<span class="op" id="1611843">+=</span>&nbsp;<span class="ident" id="1611846">mp</span><span class="op" id="1611848">.</span><span class="ident" id="1611849">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611862">mp</span><span class="op" id="1611864">.</span><span class="ident" id="1611865">alloc_bytes</span>&nbsp;<span class="op" id="1611877">+=</span>&nbsp;<span class="ident" id="1611880">mp</span><span class="op" id="1611882">.</span><span class="ident" id="1611883">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611902">mp</span><span class="op" id="1611904">.</span><span class="ident" id="1611905">free_bytes</span>&nbsp;<span class="op" id="1611916">+=</span>&nbsp;<span class="ident" id="1611919">mp</span><span class="op" id="1611921">.</span><span class="ident" id="1611922">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611941">mp</span><span class="op" id="1611943">.</span><span class="ident" id="1611944">prev_allocs</span>&nbsp;<span class="op" id="1611956">=</span>&nbsp;<span class="ident" id="1611958">mp</span><span class="op" id="1611960">.</span><span class="ident" id="1611961">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611977">mp</span><span class="op" id="1611979">.</span><span class="ident" id="1611980">prev_frees</span>&nbsp;<span class="op" id="1611991">=</span>&nbsp;<span class="ident" id="1611993">mp</span><span class="op" id="1611995">.</span><span class="ident" id="1611996">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612011">mp</span><span class="op" id="1612013">.</span><span class="ident" id="1612014">prev_alloc_bytes</span>&nbsp;<span class="op" id="1612031">=</span>&nbsp;<span class="ident" id="1612033">mp</span><span class="op" id="1612035">.</span><span class="ident" id="1612036">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612057">mp</span><span class="op" id="1612059">.</span><span class="ident" id="1612060">prev_free_bytes</span>&nbsp;<span class="op" id="1612076">=</span>&nbsp;<span class="ident" id="1612078">mp</span><span class="op" id="1612080">.</span><span class="ident" id="1612081">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612102">mp</span><span class="op" id="1612104">.</span><span class="ident" id="1612105">recent_allocs</span>&nbsp;<span class="op" id="1612119">=</span>&nbsp;<span class="num" id="1612121">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612125">mp</span><span class="op" id="1612127">.</span><span class="ident" id="1612128">recent_frees</span>&nbsp;<span class="op" id="1612141">=</span>&nbsp;<span class="num" id="1612143">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612147">mp</span><span class="op" id="1612149">.</span><span class="ident" id="1612150">recent_alloc_bytes</span>&nbsp;<span class="op" id="1612169">=</span>&nbsp;<span class="num" id="1612171">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612175">mp</span><span class="op" id="1612177">.</span><span class="ident" id="1612178">recent_free_bytes</span>&nbsp;<span class="op" id="1612196">=</span>&nbsp;<span class="num" id="1612198">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612201">}</span><br>
<span class="lineno">225</span><span class="op" id="1612203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612206">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1612283">func</span>&nbsp;<span class="ident" id="1612288">mProf_GC</span><span class="op" id="1612296">(</span><span class="op" id="1612297">)</span>&nbsp;<span class="op" id="1612299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612302">lock</span><span class="op" id="1612306">(</span><span class="op" id="1612307">&amp;</span><span class="ident" id="1612308">proflock</span><span class="op" id="1612316">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612319">mprof_GC</span><span class="op" id="1612327">(</span><span class="op" id="1612328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612331">unlock</span><span class="op" id="1612337">(</span><span class="op" id="1612338">&amp;</span><span class="ident" id="1612339">proflock</span><span class="op" id="1612347">)</span><br>
<span class="lineno"></span><span class="op" id="1612349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612352">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1612400">func</span>&nbsp;<span class="ident" id="1612405">mProf_Malloc</span><span class="op" id="1612417">(</span><span class="ident" id="1612418">p</span>&nbsp;<span class="ident" id="1612420">unsafe</span><span class="op" id="1612426">.</span><span class="ident" id="1612427">Pointer</span><span class="op" id="1612434">,</span>&nbsp;<span class="ident" id="1612436">size</span>&nbsp;<span class="builtintype" id="1612441">uintptr</span><span class="op" id="1612448">)</span>&nbsp;<span class="op" id="1612450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612453">var</span>&nbsp;<span class="ident" id="1612457">stk</span>&nbsp;<span class="op" id="1612461">[</span><span class="ident" id="1612462">maxStack</span><span class="op" id="1612470">]</span><span class="builtintype" id="1612471">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612480">nstk</span>&nbsp;<span class="op" id="1612485">:=</span>&nbsp;<span class="ident" id="1612488">callers</span><span class="op" id="1612495">(</span><span class="num" id="1612496">4</span><span class="op" id="1612497">,</span>&nbsp;<span class="op" id="1612499">&amp;</span><span class="ident" id="1612500">stk</span><span class="op" id="1612503">[</span><span class="num" id="1612504">0</span><span class="op" id="1612505">]</span><span class="op" id="1612506">,</span>&nbsp;<span class="builtinfunc" id="1612508">len</span><span class="op" id="1612511">(</span><span class="ident" id="1612512">stk</span><span class="op" id="1612515">)</span><span class="op" id="1612516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612519">lock</span><span class="op" id="1612523">(</span><span class="op" id="1612524">&amp;</span><span class="ident" id="1612525">proflock</span><span class="op" id="1612533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612536">b</span>&nbsp;<span class="op" id="1612538">:=</span>&nbsp;<span class="ident" id="1612541">stkbucket</span><span class="op" id="1612550">(</span><span class="ident" id="1612551">memProfile</span><span class="op" id="1612561">,</span>&nbsp;<span class="ident" id="1612563">size</span><span class="op" id="1612567">,</span>&nbsp;<span class="ident" id="1612569">stk</span><span class="op" id="1612572">[</span><span class="op" id="1612573">:</span><span class="ident" id="1612574">nstk</span><span class="op" id="1612578">]</span><span class="op" id="1612579">,</span>&nbsp;<span class="ident" id="1612581">true</span><span class="op" id="1612585">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612588">mp</span>&nbsp;<span class="op" id="1612591">:=</span>&nbsp;<span class="ident" id="1612594">b</span><span class="op" id="1612595">.</span><span class="ident" id="1612596">mp</span><span class="op" id="1612598">(</span><span class="op" id="1612599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612602">mp</span><span class="op" id="1612604">.</span><span class="ident" id="1612605">recent_allocs</span><span class="op" id="1612618">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612622">mp</span><span class="op" id="1612624">.</span><span class="ident" id="1612625">recent_alloc_bytes</span>&nbsp;<span class="op" id="1612644">+=</span>&nbsp;<span class="ident" id="1612647">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612653">unlock</span><span class="op" id="1612659">(</span><span class="op" id="1612660">&amp;</span><span class="ident" id="1612661">proflock</span><span class="op" id="1612669">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612673">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612761">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612825">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612889">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612930">setprofilebucket</span><span class="op" id="1612946">(</span><span class="ident" id="1612947">p</span><span class="op" id="1612948">,</span>&nbsp;<span class="ident" id="1612950">b</span><span class="op" id="1612951">)</span><br>
<span class="lineno">250</span><span class="op" id="1612953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1612956">func</span>&nbsp;<span class="ident" id="1612961">setprofilebucket_m</span><span class="op" id="1612979">(</span><span class="op" id="1612980">)</span>&nbsp;<span class="comment" id="1612982">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1612994">func</span>&nbsp;<span class="ident" id="1612999">setprofilebucket</span><span class="op" id="1613015">(</span><span class="ident" id="1613016">p</span>&nbsp;<span class="ident" id="1613018">unsafe</span><span class="op" id="1613024">.</span><span class="ident" id="1613025">Pointer</span><span class="op" id="1613032">,</span>&nbsp;<span class="ident" id="1613034">b</span>&nbsp;<span class="op" id="1613036">*</span><span class="ident" id="1613037">bucket</span><span class="op" id="1613043">)</span>&nbsp;<span class="op" id="1613045">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613048">g</span>&nbsp;<span class="op" id="1613050">:=</span>&nbsp;<span class="ident" id="1613053">getg</span><span class="op" id="1613057">(</span><span class="op" id="1613058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613061">g</span><span class="op" id="1613062">.</span><span class="ident" id="1613063">m</span><span class="op" id="1613064">.</span><span class="ident" id="1613065">ptrarg</span><span class="op" id="1613071">[</span><span class="num" id="1613072">0</span><span class="op" id="1613073">]</span>&nbsp;<span class="op" id="1613075">=</span>&nbsp;<span class="ident" id="1613077">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613080">g</span><span class="op" id="1613081">.</span><span class="ident" id="1613082">m</span><span class="op" id="1613083">.</span><span class="ident" id="1613084">ptrarg</span><span class="op" id="1613090">[</span><span class="num" id="1613091">1</span><span class="op" id="1613092">]</span>&nbsp;<span class="op" id="1613094">=</span>&nbsp;<span class="ident" id="1613096">unsafe</span><span class="op" id="1613102">.</span><span class="ident" id="1613103">Pointer</span><span class="op" id="1613110">(</span><span class="ident" id="1613111">b</span><span class="op" id="1613112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613115">onM</span><span class="op" id="1613118">(</span><span class="ident" id="1613119">setprofilebucket_m</span><span class="op" id="1613137">)</span><br>
<span class="lineno"></span><span class="op" id="1613139">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1613142">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1613183">func</span>&nbsp;<span class="ident" id="1613188">mProf_Free</span><span class="op" id="1613198">(</span><span class="ident" id="1613199">b</span>&nbsp;<span class="op" id="1613201">*</span><span class="ident" id="1613202">bucket</span><span class="op" id="1613208">,</span>&nbsp;<span class="ident" id="1613210">size</span>&nbsp;<span class="builtintype" id="1613215">uintptr</span><span class="op" id="1613222">,</span>&nbsp;<span class="ident" id="1613224">freed</span>&nbsp;<span class="builtintype" id="1613230">bool</span><span class="op" id="1613234">)</span>&nbsp;<span class="op" id="1613236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613239">lock</span><span class="op" id="1613243">(</span><span class="op" id="1613244">&amp;</span><span class="ident" id="1613245">proflock</span><span class="op" id="1613253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613256">mp</span>&nbsp;<span class="op" id="1613259">:=</span>&nbsp;<span class="ident" id="1613262">b</span><span class="op" id="1613263">.</span><span class="ident" id="1613264">mp</span><span class="op" id="1613266">(</span><span class="op" id="1613267">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613270">if</span>&nbsp;<span class="ident" id="1613273">freed</span>&nbsp;<span class="op" id="1613279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613283">mp</span><span class="op" id="1613285">.</span><span class="ident" id="1613286">recent_frees</span><span class="op" id="1613298">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613303">mp</span><span class="op" id="1613305">.</span><span class="ident" id="1613306">recent_free_bytes</span>&nbsp;<span class="op" id="1613324">+=</span>&nbsp;<span class="ident" id="1613327">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613333">}</span>&nbsp;<span class="keyword" id="1613335">else</span>&nbsp;<span class="op" id="1613340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613344">mp</span><span class="op" id="1613346">.</span><span class="ident" id="1613347">prev_frees</span><span class="op" id="1613357">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613362">mp</span><span class="op" id="1613364">.</span><span class="ident" id="1613365">prev_free_bytes</span>&nbsp;<span class="op" id="1613381">+=</span>&nbsp;<span class="ident" id="1613384">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613393">unlock</span><span class="op" id="1613399">(</span><span class="op" id="1613400">&amp;</span><span class="ident" id="1613401">proflock</span><span class="op" id="1613409">)</span><br>
<span class="lineno"></span><span class="op" id="1613411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1613414">var</span>&nbsp;<span class="ident" id="1613418">blockprofilerate</span>&nbsp;<span class="ident" id="1613435">uint64</span>&nbsp;<span class="comment" id="1613442">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1613459">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1613533">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1613608">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1613680">//</span><br>
<span class="lineno"></span><span class="comment" id="1613683">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1613749">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1613800">func</span>&nbsp;<span class="ident" id="1613805">SetBlockProfileRate</span><span class="op" id="1613824">(</span><span class="ident" id="1613825">rate</span>&nbsp;<span class="builtintype" id="1613830">int</span><span class="op" id="1613833">)</span>&nbsp;<span class="op" id="1613835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613838">var</span>&nbsp;<span class="ident" id="1613842">r</span>&nbsp;<span class="ident" id="1613844">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613851">if</span>&nbsp;<span class="ident" id="1613854">rate</span>&nbsp;<span class="op" id="1613859">&lt;=</span>&nbsp;<span class="num" id="1613862">0</span>&nbsp;<span class="op" id="1613864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613868">r</span>&nbsp;<span class="op" id="1613870">=</span>&nbsp;<span class="num" id="1613872">0</span>&nbsp;<span class="comment" id="1613874">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613896">}</span>&nbsp;<span class="keyword" id="1613898">else</span>&nbsp;<span class="keyword" id="1613903">if</span>&nbsp;<span class="ident" id="1613906">rate</span>&nbsp;<span class="op" id="1613911">==</span>&nbsp;<span class="num" id="1613914">1</span>&nbsp;<span class="op" id="1613916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613920">r</span>&nbsp;<span class="op" id="1613922">=</span>&nbsp;<span class="num" id="1613924">1</span>&nbsp;<span class="comment" id="1613926">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613949">}</span>&nbsp;<span class="keyword" id="1613951">else</span>&nbsp;<span class="op" id="1613956">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613960">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614041">r</span>&nbsp;<span class="op" id="1614043">=</span>&nbsp;<span class="ident" id="1614045">int64</span><span class="op" id="1614050">(</span><span class="builtintype" id="1614051">float64</span><span class="op" id="1614058">(</span><span class="ident" id="1614059">rate</span><span class="op" id="1614063">)</span>&nbsp;<span class="op" id="1614065">*</span>&nbsp;<span class="builtintype" id="1614067">float64</span><span class="op" id="1614074">(</span><span class="ident" id="1614075">tickspersecond</span><span class="op" id="1614089">(</span><span class="op" id="1614090">)</span><span class="op" id="1614091">)</span>&nbsp;<span class="op" id="1614093">/</span>&nbsp;<span class="op" id="1614095">(</span><span class="num" id="1614096">1000</span>&nbsp;<span class="op" id="1614101">*</span>&nbsp;<span class="num" id="1614103">1000</span>&nbsp;<span class="op" id="1614108">*</span>&nbsp;<span class="num" id="1614110">1000</span><span class="op" id="1614114">)</span><span class="op" id="1614115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614119">if</span>&nbsp;<span class="ident" id="1614122">r</span>&nbsp;<span class="op" id="1614124">==</span>&nbsp;<span class="num" id="1614127">0</span>&nbsp;<span class="op" id="1614129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614134">r</span>&nbsp;<span class="op" id="1614136">=</span>&nbsp;<span class="num" id="1614138">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614142">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614149">atomicstore64</span><span class="op" id="1614162">(</span><span class="op" id="1614163">&amp;</span><span class="ident" id="1614164">blockprofilerate</span><span class="op" id="1614180">,</span>&nbsp;<span class="ident" id="1614182">uint64</span><span class="op" id="1614188">(</span><span class="ident" id="1614189">r</span><span class="op" id="1614190">)</span><span class="op" id="1614191">)</span><br>
<span class="lineno"></span><span class="op" id="1614193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1614196">func</span>&nbsp;<span class="ident" id="1614201">blockevent</span><span class="op" id="1614211">(</span><span class="ident" id="1614212">cycles</span>&nbsp;<span class="ident" id="1614219">int64</span><span class="op" id="1614224">,</span>&nbsp;<span class="ident" id="1614226">skip</span>&nbsp;<span class="builtintype" id="1614231">int</span><span class="op" id="1614234">)</span>&nbsp;<span class="op" id="1614236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614239">if</span>&nbsp;<span class="ident" id="1614242">cycles</span>&nbsp;<span class="op" id="1614249">&lt;=</span>&nbsp;<span class="num" id="1614252">0</span>&nbsp;<span class="op" id="1614254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614258">cycles</span>&nbsp;<span class="op" id="1614265">=</span>&nbsp;<span class="num" id="1614267">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614273">rate</span>&nbsp;<span class="op" id="1614278">:=</span>&nbsp;<span class="ident" id="1614281">int64</span><span class="op" id="1614286">(</span><span class="ident" id="1614287">atomicload64</span><span class="op" id="1614299">(</span><span class="op" id="1614300">&amp;</span><span class="ident" id="1614301">blockprofilerate</span><span class="op" id="1614317">)</span><span class="op" id="1614318">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614321">if</span>&nbsp;<span class="ident" id="1614324">rate</span>&nbsp;<span class="op" id="1614329">&lt;=</span>&nbsp;<span class="num" id="1614332">0</span>&nbsp;<span class="op" id="1614334">||</span>&nbsp;<span class="op" id="1614337">(</span><span class="ident" id="1614338">rate</span>&nbsp;<span class="op" id="1614343">&gt;</span>&nbsp;<span class="ident" id="1614345">cycles</span>&nbsp;<span class="op" id="1614352">&amp;&amp;</span>&nbsp;<span class="ident" id="1614355">int64</span><span class="op" id="1614360">(</span><span class="ident" id="1614361">fastrand1</span><span class="op" id="1614370">(</span><span class="op" id="1614371">)</span><span class="op" id="1614372">)</span><span class="op" id="1614373">%</span><span class="ident" id="1614374">rate</span>&nbsp;<span class="op" id="1614379">&gt;</span>&nbsp;<span class="ident" id="1614381">cycles</span><span class="op" id="1614387">)</span>&nbsp;<span class="op" id="1614389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614393">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614404">gp</span>&nbsp;<span class="op" id="1614407">:=</span>&nbsp;<span class="ident" id="1614410">getg</span><span class="op" id="1614414">(</span><span class="op" id="1614415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614418">var</span>&nbsp;<span class="ident" id="1614422">nstk</span>&nbsp;<span class="builtintype" id="1614427">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614432">var</span>&nbsp;<span class="ident" id="1614436">stk</span>&nbsp;<span class="op" id="1614440">[</span><span class="ident" id="1614441">maxStack</span><span class="op" id="1614449">]</span><span class="builtintype" id="1614450">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614459">if</span>&nbsp;<span class="ident" id="1614462">gp</span><span class="op" id="1614464">.</span><span class="ident" id="1614465">m</span><span class="op" id="1614466">.</span><span class="ident" id="1614467">curg</span>&nbsp;<span class="op" id="1614472">==</span>&nbsp;<span class="ident" id="1614475">nil</span>&nbsp;<span class="op" id="1614479">||</span>&nbsp;<span class="ident" id="1614482">gp</span><span class="op" id="1614484">.</span><span class="ident" id="1614485">m</span><span class="op" id="1614486">.</span><span class="ident" id="1614487">curg</span>&nbsp;<span class="op" id="1614492">==</span>&nbsp;<span class="ident" id="1614495">gp</span>&nbsp;<span class="op" id="1614498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614502">nstk</span>&nbsp;<span class="op" id="1614507">=</span>&nbsp;<span class="ident" id="1614509">callers</span><span class="op" id="1614516">(</span><span class="ident" id="1614517">skip</span><span class="op" id="1614521">,</span>&nbsp;<span class="op" id="1614523">&amp;</span><span class="ident" id="1614524">stk</span><span class="op" id="1614527">[</span><span class="num" id="1614528">0</span><span class="op" id="1614529">]</span><span class="op" id="1614530">,</span>&nbsp;<span class="builtinfunc" id="1614532">len</span><span class="op" id="1614535">(</span><span class="ident" id="1614536">stk</span><span class="op" id="1614539">)</span><span class="op" id="1614540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614543">}</span>&nbsp;<span class="keyword" id="1614545">else</span>&nbsp;<span class="op" id="1614550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614554">nstk</span>&nbsp;<span class="op" id="1614559">=</span>&nbsp;<span class="ident" id="1614561">gcallers</span><span class="op" id="1614569">(</span><span class="ident" id="1614570">gp</span><span class="op" id="1614572">.</span><span class="ident" id="1614573">m</span><span class="op" id="1614574">.</span><span class="ident" id="1614575">curg</span><span class="op" id="1614579">,</span>&nbsp;<span class="ident" id="1614581">skip</span><span class="op" id="1614585">,</span>&nbsp;<span class="op" id="1614587">&amp;</span><span class="ident" id="1614588">stk</span><span class="op" id="1614591">[</span><span class="num" id="1614592">0</span><span class="op" id="1614593">]</span><span class="op" id="1614594">,</span>&nbsp;<span class="builtinfunc" id="1614596">len</span><span class="op" id="1614599">(</span><span class="ident" id="1614600">stk</span><span class="op" id="1614603">)</span><span class="op" id="1614604">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614610">lock</span><span class="op" id="1614614">(</span><span class="op" id="1614615">&amp;</span><span class="ident" id="1614616">proflock</span><span class="op" id="1614624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614627">b</span>&nbsp;<span class="op" id="1614629">:=</span>&nbsp;<span class="ident" id="1614632">stkbucket</span><span class="op" id="1614641">(</span><span class="ident" id="1614642">blockProfile</span><span class="op" id="1614654">,</span>&nbsp;<span class="num" id="1614656">0</span><span class="op" id="1614657">,</span>&nbsp;<span class="ident" id="1614659">stk</span><span class="op" id="1614662">[</span><span class="op" id="1614663">:</span><span class="ident" id="1614664">nstk</span><span class="op" id="1614668">]</span><span class="op" id="1614669">,</span>&nbsp;<span class="ident" id="1614671">true</span><span class="op" id="1614675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614678">b</span><span class="op" id="1614679">.</span><span class="ident" id="1614680">bp</span><span class="op" id="1614682">(</span><span class="op" id="1614683">)</span><span class="op" id="1614684">.</span><span class="ident" id="1614685">count</span><span class="op" id="1614690">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614694">b</span><span class="op" id="1614695">.</span><span class="ident" id="1614696">bp</span><span class="op" id="1614698">(</span><span class="op" id="1614699">)</span><span class="op" id="1614700">.</span><span class="ident" id="1614701">cycles</span>&nbsp;<span class="op" id="1614708">+=</span>&nbsp;<span class="ident" id="1614711">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614719">unlock</span><span class="op" id="1614725">(</span><span class="op" id="1614726">&amp;</span><span class="ident" id="1614727">proflock</span><span class="op" id="1614735">)</span><br>
<span class="lineno"></span><span class="op" id="1614737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1614740">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1614774">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1614827">type</span>&nbsp;<span class="ident" id="1614832">StackRecord</span>&nbsp;<span class="keyword" id="1614844">struct</span>&nbsp;<span class="op" id="1614851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614854">Stack0</span>&nbsp;<span class="op" id="1614861">[</span><span class="num" id="1614862">32</span><span class="op" id="1614864">]</span><span class="builtintype" id="1614865">uintptr</span>&nbsp;<span class="comment" id="1614873">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1614927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1614930">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1614991">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1615016">func</span>&nbsp;<span class="op" id="1615021">(</span><span class="ident" id="1615022">r</span>&nbsp;<span class="op" id="1615024">*</span><span class="ident" id="1615025">StackRecord</span><span class="op" id="1615036">)</span>&nbsp;<span class="ident" id="1615038">Stack</span><span class="op" id="1615043">(</span><span class="op" id="1615044">)</span>&nbsp;<span class="op" id="1615046">[</span><span class="op" id="1615047">]</span><span class="builtintype" id="1615048">uintptr</span>&nbsp;<span class="op" id="1615056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615059">for</span>&nbsp;<span class="ident" id="1615063">i</span><span class="op" id="1615064">,</span>&nbsp;<span class="ident" id="1615066">v</span>&nbsp;<span class="op" id="1615068">:=</span>&nbsp;<span class="keyword" id="1615071">range</span>&nbsp;<span class="ident" id="1615077">r</span><span class="op" id="1615078">.</span><span class="ident" id="1615079">Stack0</span>&nbsp;<span class="op" id="1615086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615090">if</span>&nbsp;<span class="ident" id="1615093">v</span>&nbsp;<span class="op" id="1615095">==</span>&nbsp;<span class="num" id="1615098">0</span>&nbsp;<span class="op" id="1615100">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615105">return</span>&nbsp;<span class="ident" id="1615112">r</span><span class="op" id="1615113">.</span><span class="ident" id="1615114">Stack0</span><span class="op" id="1615120">[</span><span class="num" id="1615121">0</span><span class="op" id="1615122">:</span><span class="ident" id="1615123">i</span><span class="op" id="1615124">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615134">return</span>&nbsp;<span class="ident" id="1615141">r</span><span class="op" id="1615142">.</span><span class="ident" id="1615143">Stack0</span><span class="op" id="1615149">[</span><span class="num" id="1615150">0</span><span class="op" id="1615151">:</span><span class="op" id="1615152">]</span><br>
<span class="lineno"></span><span class="op" id="1615154">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1615157">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1615219">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1615276">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1615321">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1615375">//</span><br>
<span class="lineno"></span><span class="comment" id="1615378">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1615455">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1615515">//</span><br>
<span class="lineno"></span><span class="comment" id="1615518">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1615580">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1615643">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1615704">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1615765">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1615823">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1615853">var</span>&nbsp;<span class="ident" id="1615857">MemProfileRate</span>&nbsp;<span class="builtintype" id="1615872">int</span>&nbsp;<span class="op" id="1615876">=</span>&nbsp;<span class="num" id="1615878">512</span>&nbsp;<span class="op" id="1615882">*</span>&nbsp;<span class="num" id="1615884">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1615890">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1615949">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1615997">type</span>&nbsp;<span class="ident" id="1616002">MemProfileRecord</span>&nbsp;<span class="keyword" id="1616019">struct</span>&nbsp;<span class="op" id="1616026">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616029">AllocBytes</span><span class="op" id="1616039">,</span>&nbsp;<span class="ident" id="1616041">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616055">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616067">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616104">AllocObjects</span><span class="op" id="1616116">,</span>&nbsp;<span class="ident" id="1616118">FreeObjects</span>&nbsp;<span class="ident" id="1616130">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616142">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616181">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1616207">[</span><span class="num" id="1616208">32</span><span class="op" id="1616210">]</span><span class="builtintype" id="1616211">uintptr</span>&nbsp;<span class="comment" id="1616219">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1616273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1616276">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1616351">func</span>&nbsp;<span class="op" id="1616356">(</span><span class="ident" id="1616357">r</span>&nbsp;<span class="op" id="1616359">*</span><span class="ident" id="1616360">MemProfileRecord</span><span class="op" id="1616376">)</span>&nbsp;<span class="ident" id="1616378">InUseBytes</span><span class="op" id="1616388">(</span><span class="op" id="1616389">)</span>&nbsp;<span class="ident" id="1616391">int64</span>&nbsp;<span class="op" id="1616397">{</span>&nbsp;<span class="keyword" id="1616399">return</span>&nbsp;<span class="ident" id="1616406">r</span><span class="op" id="1616407">.</span><span class="ident" id="1616408">AllocBytes</span>&nbsp;<span class="op" id="1616419">-</span>&nbsp;<span class="ident" id="1616421">r</span><span class="op" id="1616422">.</span><span class="ident" id="1616423">FreeBytes</span>&nbsp;<span class="op" id="1616433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1616436">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1616519">func</span>&nbsp;<span class="op" id="1616524">(</span><span class="ident" id="1616525">r</span>&nbsp;<span class="op" id="1616527">*</span><span class="ident" id="1616528">MemProfileRecord</span><span class="op" id="1616544">)</span>&nbsp;<span class="ident" id="1616546">InUseObjects</span><span class="op" id="1616558">(</span><span class="op" id="1616559">)</span>&nbsp;<span class="ident" id="1616561">int64</span>&nbsp;<span class="op" id="1616567">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616570">return</span>&nbsp;<span class="ident" id="1616577">r</span><span class="op" id="1616578">.</span><span class="ident" id="1616579">AllocObjects</span>&nbsp;<span class="op" id="1616592">-</span>&nbsp;<span class="ident" id="1616594">r</span><span class="op" id="1616595">.</span><span class="ident" id="1616596">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1616608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1616611">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1616672">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1616697">func</span>&nbsp;<span class="op" id="1616702">(</span><span class="ident" id="1616703">r</span>&nbsp;<span class="op" id="1616705">*</span><span class="ident" id="1616706">MemProfileRecord</span><span class="op" id="1616722">)</span>&nbsp;<span class="ident" id="1616724">Stack</span><span class="op" id="1616729">(</span><span class="op" id="1616730">)</span>&nbsp;<span class="op" id="1616732">[</span><span class="op" id="1616733">]</span><span class="builtintype" id="1616734">uintptr</span>&nbsp;<span class="op" id="1616742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616745">for</span>&nbsp;<span class="ident" id="1616749">i</span><span class="op" id="1616750">,</span>&nbsp;<span class="ident" id="1616752">v</span>&nbsp;<span class="op" id="1616754">:=</span>&nbsp;<span class="keyword" id="1616757">range</span>&nbsp;<span class="ident" id="1616763">r</span><span class="op" id="1616764">.</span><span class="ident" id="1616765">Stack0</span>&nbsp;<span class="op" id="1616772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616776">if</span>&nbsp;<span class="ident" id="1616779">v</span>&nbsp;<span class="op" id="1616781">==</span>&nbsp;<span class="num" id="1616784">0</span>&nbsp;<span class="op" id="1616786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616791">return</span>&nbsp;<span class="ident" id="1616798">r</span><span class="op" id="1616799">.</span><span class="ident" id="1616800">Stack0</span><span class="op" id="1616806">[</span><span class="num" id="1616807">0</span><span class="op" id="1616808">:</span><span class="ident" id="1616809">i</span><span class="op" id="1616810">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616814">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616820">return</span>&nbsp;<span class="ident" id="1616827">r</span><span class="op" id="1616828">.</span><span class="ident" id="1616829">Stack0</span><span class="op" id="1616835">[</span><span class="num" id="1616836">0</span><span class="op" id="1616837">:</span><span class="op" id="1616838">]</span><br>
<span class="lineno"></span><span class="op" id="1616840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1616843">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1616921">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1616998">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1617067">//</span><br>
<span class="lineno"></span><span class="comment" id="1617070">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1617135">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1617194">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1617256">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1617294">//</span><br>
<span class="lineno"></span><span class="comment" id="1617297">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1617353">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1617408">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1617443">func</span>&nbsp;<span class="ident" id="1617448">MemProfile</span><span class="op" id="1617458">(</span><span class="ident" id="1617459">p</span>&nbsp;<span class="op" id="1617461">[</span><span class="op" id="1617462">]</span><span class="ident" id="1617463">MemProfileRecord</span><span class="op" id="1617479">,</span>&nbsp;<span class="ident" id="1617481">inuseZero</span>&nbsp;<span class="builtintype" id="1617491">bool</span><span class="op" id="1617495">)</span>&nbsp;<span class="op" id="1617497">(</span><span class="ident" id="1617498">n</span>&nbsp;<span class="builtintype" id="1617500">int</span><span class="op" id="1617503">,</span>&nbsp;<span class="ident" id="1617505">ok</span>&nbsp;<span class="builtintype" id="1617508">bool</span><span class="op" id="1617512">)</span>&nbsp;<span class="op" id="1617514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617517">lock</span><span class="op" id="1617521">(</span><span class="op" id="1617522">&amp;</span><span class="ident" id="1617523">proflock</span><span class="op" id="1617531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617534">clear</span>&nbsp;<span class="op" id="1617540">:=</span>&nbsp;<span class="ident" id="1617543">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617549">for</span>&nbsp;<span class="ident" id="1617553">b</span>&nbsp;<span class="op" id="1617555">:=</span>&nbsp;<span class="ident" id="1617558">mbuckets</span><span class="op" id="1617566">;</span>&nbsp;<span class="ident" id="1617568">b</span>&nbsp;<span class="op" id="1617570">!=</span>&nbsp;<span class="ident" id="1617573">nil</span><span class="op" id="1617576">;</span>&nbsp;<span class="ident" id="1617578">b</span>&nbsp;<span class="op" id="1617580">=</span>&nbsp;<span class="ident" id="1617582">b</span><span class="op" id="1617583">.</span><span class="ident" id="1617584">allnext</span>&nbsp;<span class="op" id="1617592">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617596">mp</span>&nbsp;<span class="op" id="1617599">:=</span>&nbsp;<span class="ident" id="1617602">b</span><span class="op" id="1617603">.</span><span class="ident" id="1617604">mp</span><span class="op" id="1617606">(</span><span class="op" id="1617607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617611">if</span>&nbsp;<span class="ident" id="1617614">inuseZero</span>&nbsp;<span class="op" id="1617624">||</span>&nbsp;<span class="ident" id="1617627">mp</span><span class="op" id="1617629">.</span><span class="ident" id="1617630">alloc_bytes</span>&nbsp;<span class="op" id="1617642">!=</span>&nbsp;<span class="ident" id="1617645">mp</span><span class="op" id="1617647">.</span><span class="ident" id="1617648">free_bytes</span>&nbsp;<span class="op" id="1617659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617664">n</span><span class="op" id="1617665">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617674">if</span>&nbsp;<span class="ident" id="1617677">mp</span><span class="op" id="1617679">.</span><span class="ident" id="1617680">allocs</span>&nbsp;<span class="op" id="1617687">!=</span>&nbsp;<span class="num" id="1617690">0</span>&nbsp;<span class="op" id="1617692">||</span>&nbsp;<span class="ident" id="1617695">mp</span><span class="op" id="1617697">.</span><span class="ident" id="1617698">frees</span>&nbsp;<span class="op" id="1617704">!=</span>&nbsp;<span class="num" id="1617707">0</span>&nbsp;<span class="op" id="1617709">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617714">clear</span>&nbsp;<span class="op" id="1617720">=</span>&nbsp;<span class="ident" id="1617722">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617736">if</span>&nbsp;<span class="ident" id="1617739">clear</span>&nbsp;<span class="op" id="1617745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617749">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617811">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617871">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617940">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618009">mprof_GC</span><span class="op" id="1618017">(</span><span class="op" id="1618018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618022">mprof_GC</span><span class="op" id="1618030">(</span><span class="op" id="1618031">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618035">n</span>&nbsp;<span class="op" id="1618037">=</span>&nbsp;<span class="num" id="1618039">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618043">for</span>&nbsp;<span class="ident" id="1618047">b</span>&nbsp;<span class="op" id="1618049">:=</span>&nbsp;<span class="ident" id="1618052">mbuckets</span><span class="op" id="1618060">;</span>&nbsp;<span class="ident" id="1618062">b</span>&nbsp;<span class="op" id="1618064">!=</span>&nbsp;<span class="ident" id="1618067">nil</span><span class="op" id="1618070">;</span>&nbsp;<span class="ident" id="1618072">b</span>&nbsp;<span class="op" id="1618074">=</span>&nbsp;<span class="ident" id="1618076">b</span><span class="op" id="1618077">.</span><span class="ident" id="1618078">allnext</span>&nbsp;<span class="op" id="1618086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618091">mp</span>&nbsp;<span class="op" id="1618094">:=</span>&nbsp;<span class="ident" id="1618097">b</span><span class="op" id="1618098">.</span><span class="ident" id="1618099">mp</span><span class="op" id="1618101">(</span><span class="op" id="1618102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618107">if</span>&nbsp;<span class="ident" id="1618110">inuseZero</span>&nbsp;<span class="op" id="1618120">||</span>&nbsp;<span class="ident" id="1618123">mp</span><span class="op" id="1618125">.</span><span class="ident" id="1618126">alloc_bytes</span>&nbsp;<span class="op" id="1618138">!=</span>&nbsp;<span class="ident" id="1618141">mp</span><span class="op" id="1618143">.</span><span class="ident" id="1618144">free_bytes</span>&nbsp;<span class="op" id="1618155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618161">n</span><span class="op" id="1618162">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618178">if</span>&nbsp;<span class="ident" id="1618181">n</span>&nbsp;<span class="op" id="1618183">&lt;=</span>&nbsp;<span class="builtinfunc" id="1618186">len</span><span class="op" id="1618189">(</span><span class="ident" id="1618190">p</span><span class="op" id="1618191">)</span>&nbsp;<span class="op" id="1618193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618197">ok</span>&nbsp;<span class="op" id="1618200">=</span>&nbsp;<span class="ident" id="1618202">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618209">idx</span>&nbsp;<span class="op" id="1618213">:=</span>&nbsp;<span class="num" id="1618216">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618220">for</span>&nbsp;<span class="ident" id="1618224">b</span>&nbsp;<span class="op" id="1618226">:=</span>&nbsp;<span class="ident" id="1618229">mbuckets</span><span class="op" id="1618237">;</span>&nbsp;<span class="ident" id="1618239">b</span>&nbsp;<span class="op" id="1618241">!=</span>&nbsp;<span class="ident" id="1618244">nil</span><span class="op" id="1618247">;</span>&nbsp;<span class="ident" id="1618249">b</span>&nbsp;<span class="op" id="1618251">=</span>&nbsp;<span class="ident" id="1618253">b</span><span class="op" id="1618254">.</span><span class="ident" id="1618255">allnext</span>&nbsp;<span class="op" id="1618263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618268">mp</span>&nbsp;<span class="op" id="1618271">:=</span>&nbsp;<span class="ident" id="1618274">b</span><span class="op" id="1618275">.</span><span class="ident" id="1618276">mp</span><span class="op" id="1618278">(</span><span class="op" id="1618279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618284">if</span>&nbsp;<span class="ident" id="1618287">inuseZero</span>&nbsp;<span class="op" id="1618297">||</span>&nbsp;<span class="ident" id="1618300">mp</span><span class="op" id="1618302">.</span><span class="ident" id="1618303">alloc_bytes</span>&nbsp;<span class="op" id="1618315">!=</span>&nbsp;<span class="ident" id="1618318">mp</span><span class="op" id="1618320">.</span><span class="ident" id="1618321">free_bytes</span>&nbsp;<span class="op" id="1618332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618338">record</span><span class="op" id="1618344">(</span><span class="op" id="1618345">&amp;</span><span class="ident" id="1618346">p</span><span class="op" id="1618347">[</span><span class="ident" id="1618348">idx</span><span class="op" id="1618351">]</span><span class="op" id="1618352">,</span>&nbsp;<span class="ident" id="1618354">b</span><span class="op" id="1618355">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618361">idx</span><span class="op" id="1618364">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618380">unlock</span><span class="op" id="1618386">(</span><span class="op" id="1618387">&amp;</span><span class="ident" id="1618388">proflock</span><span class="op" id="1618396">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618399">return</span><br>
<span class="lineno"></span><span class="op" id="1618406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1618409">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1618433">func</span>&nbsp;<span class="ident" id="1618438">record</span><span class="op" id="1618444">(</span><span class="ident" id="1618445">r</span>&nbsp;<span class="op" id="1618447">*</span><span class="ident" id="1618448">MemProfileRecord</span><span class="op" id="1618464">,</span>&nbsp;<span class="ident" id="1618466">b</span>&nbsp;<span class="op" id="1618468">*</span><span class="ident" id="1618469">bucket</span><span class="op" id="1618475">)</span>&nbsp;<span class="op" id="1618477">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618480">mp</span>&nbsp;<span class="op" id="1618483">:=</span>&nbsp;<span class="ident" id="1618486">b</span><span class="op" id="1618487">.</span><span class="ident" id="1618488">mp</span><span class="op" id="1618490">(</span><span class="op" id="1618491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618494">r</span><span class="op" id="1618495">.</span><span class="ident" id="1618496">AllocBytes</span>&nbsp;<span class="op" id="1618507">=</span>&nbsp;<span class="ident" id="1618509">int64</span><span class="op" id="1618514">(</span><span class="ident" id="1618515">mp</span><span class="op" id="1618517">.</span><span class="ident" id="1618518">alloc_bytes</span><span class="op" id="1618529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618532">r</span><span class="op" id="1618533">.</span><span class="ident" id="1618534">FreeBytes</span>&nbsp;<span class="op" id="1618544">=</span>&nbsp;<span class="ident" id="1618546">int64</span><span class="op" id="1618551">(</span><span class="ident" id="1618552">mp</span><span class="op" id="1618554">.</span><span class="ident" id="1618555">free_bytes</span><span class="op" id="1618565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618568">r</span><span class="op" id="1618569">.</span><span class="ident" id="1618570">AllocObjects</span>&nbsp;<span class="op" id="1618583">=</span>&nbsp;<span class="ident" id="1618585">int64</span><span class="op" id="1618590">(</span><span class="ident" id="1618591">mp</span><span class="op" id="1618593">.</span><span class="ident" id="1618594">allocs</span><span class="op" id="1618600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618603">r</span><span class="op" id="1618604">.</span><span class="ident" id="1618605">FreeObjects</span>&nbsp;<span class="op" id="1618617">=</span>&nbsp;<span class="ident" id="1618619">int64</span><span class="op" id="1618624">(</span><span class="ident" id="1618625">mp</span><span class="op" id="1618627">.</span><span class="ident" id="1618628">frees</span><span class="op" id="1618633">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1618636">copy</span><span class="op" id="1618640">(</span><span class="ident" id="1618641">r</span><span class="op" id="1618642">.</span><span class="ident" id="1618643">Stack0</span><span class="op" id="1618649">[</span><span class="op" id="1618650">:</span><span class="op" id="1618651">]</span><span class="op" id="1618652">,</span>&nbsp;<span class="ident" id="1618654">b</span><span class="op" id="1618655">.</span><span class="ident" id="1618656">stk</span><span class="op" id="1618659">(</span><span class="op" id="1618660">)</span><span class="op" id="1618661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618664">for</span>&nbsp;<span class="ident" id="1618668">i</span>&nbsp;<span class="op" id="1618670">:=</span>&nbsp;<span class="builtintype" id="1618673">int</span><span class="op" id="1618676">(</span><span class="ident" id="1618677">b</span><span class="op" id="1618678">.</span><span class="ident" id="1618679">nstk</span><span class="op" id="1618683">)</span><span class="op" id="1618684">;</span>&nbsp;<span class="ident" id="1618686">i</span>&nbsp;<span class="op" id="1618688">&lt;</span>&nbsp;<span class="builtinfunc" id="1618690">len</span><span class="op" id="1618693">(</span><span class="ident" id="1618694">r</span><span class="op" id="1618695">.</span><span class="ident" id="1618696">Stack0</span><span class="op" id="1618702">)</span><span class="op" id="1618703">;</span>&nbsp;<span class="ident" id="1618705">i</span><span class="op" id="1618706">++</span>&nbsp;<span class="op" id="1618709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618713">r</span><span class="op" id="1618714">.</span><span class="ident" id="1618715">Stack0</span><span class="op" id="1618721">[</span><span class="ident" id="1618722">i</span><span class="op" id="1618723">]</span>&nbsp;<span class="op" id="1618725">=</span>&nbsp;<span class="num" id="1618727">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618730">}</span><br>
<span class="lineno"></span><span class="op" id="1618732">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1618735">func</span>&nbsp;<span class="ident" id="1618740">iterate_memprof</span><span class="op" id="1618755">(</span><span class="ident" id="1618756">fn</span>&nbsp;<span class="keyword" id="1618759">func</span><span class="op" id="1618763">(</span><span class="op" id="1618764">*</span><span class="ident" id="1618765">bucket</span><span class="op" id="1618771">,</span>&nbsp;<span class="builtintype" id="1618773">uintptr</span><span class="op" id="1618780">,</span>&nbsp;<span class="op" id="1618782">*</span><span class="builtintype" id="1618783">uintptr</span><span class="op" id="1618790">,</span>&nbsp;<span class="builtintype" id="1618792">uintptr</span><span class="op" id="1618799">,</span>&nbsp;<span class="builtintype" id="1618801">uintptr</span><span class="op" id="1618808">,</span>&nbsp;<span class="builtintype" id="1618810">uintptr</span><span class="op" id="1618817">)</span><span class="op" id="1618818">)</span>&nbsp;<span class="op" id="1618820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618823">lock</span><span class="op" id="1618827">(</span><span class="op" id="1618828">&amp;</span><span class="ident" id="1618829">proflock</span><span class="op" id="1618837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618840">for</span>&nbsp;<span class="ident" id="1618844">b</span>&nbsp;<span class="op" id="1618846">:=</span>&nbsp;<span class="ident" id="1618849">mbuckets</span><span class="op" id="1618857">;</span>&nbsp;<span class="ident" id="1618859">b</span>&nbsp;<span class="op" id="1618861">!=</span>&nbsp;<span class="ident" id="1618864">nil</span><span class="op" id="1618867">;</span>&nbsp;<span class="ident" id="1618869">b</span>&nbsp;<span class="op" id="1618871">=</span>&nbsp;<span class="ident" id="1618873">b</span><span class="op" id="1618874">.</span><span class="ident" id="1618875">allnext</span>&nbsp;<span class="op" id="1618883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618887">mp</span>&nbsp;<span class="op" id="1618890">:=</span>&nbsp;<span class="ident" id="1618893">b</span><span class="op" id="1618894">.</span><span class="ident" id="1618895">mp</span><span class="op" id="1618897">(</span><span class="op" id="1618898">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618902">fn</span><span class="op" id="1618904">(</span><span class="ident" id="1618905">b</span><span class="op" id="1618906">,</span>&nbsp;<span class="builtintype" id="1618908">uintptr</span><span class="op" id="1618915">(</span><span class="ident" id="1618916">b</span><span class="op" id="1618917">.</span><span class="ident" id="1618918">nstk</span><span class="op" id="1618922">)</span><span class="op" id="1618923">,</span>&nbsp;<span class="op" id="1618925">&amp;</span><span class="ident" id="1618926">b</span><span class="op" id="1618927">.</span><span class="ident" id="1618928">stk</span><span class="op" id="1618931">(</span><span class="op" id="1618932">)</span><span class="op" id="1618933">[</span><span class="num" id="1618934">0</span><span class="op" id="1618935">]</span><span class="op" id="1618936">,</span>&nbsp;<span class="ident" id="1618938">b</span><span class="op" id="1618939">.</span><span class="ident" id="1618940">size</span><span class="op" id="1618944">,</span>&nbsp;<span class="ident" id="1618946">mp</span><span class="op" id="1618948">.</span><span class="ident" id="1618949">allocs</span><span class="op" id="1618955">,</span>&nbsp;<span class="ident" id="1618957">mp</span><span class="op" id="1618959">.</span><span class="ident" id="1618960">frees</span><span class="op" id="1618965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618971">unlock</span><span class="op" id="1618977">(</span><span class="op" id="1618978">&amp;</span><span class="ident" id="1618979">proflock</span><span class="op" id="1618987">)</span><br>
<span class="lineno"></span><span class="op" id="1618989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1618992">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1619051">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1619099">type</span>&nbsp;<span class="ident" id="1619104">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1619123">struct</span>&nbsp;<span class="op" id="1619130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619133">Count</span>&nbsp;&nbsp;<span class="ident" id="1619140">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619147">Cycles</span>&nbsp;<span class="ident" id="1619154">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619161">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1619173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619176">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1619258">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1619337">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1619408">//</span><br>
<span class="lineno"></span><span class="comment" id="1619411">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1619467">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1619524">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1619561">func</span>&nbsp;<span class="ident" id="1619566">BlockProfile</span><span class="op" id="1619578">(</span><span class="ident" id="1619579">p</span>&nbsp;<span class="op" id="1619581">[</span><span class="op" id="1619582">]</span><span class="ident" id="1619583">BlockProfileRecord</span><span class="op" id="1619601">)</span>&nbsp;<span class="op" id="1619603">(</span><span class="ident" id="1619604">n</span>&nbsp;<span class="builtintype" id="1619606">int</span><span class="op" id="1619609">,</span>&nbsp;<span class="ident" id="1619611">ok</span>&nbsp;<span class="builtintype" id="1619614">bool</span><span class="op" id="1619618">)</span>&nbsp;<span class="op" id="1619620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619623">lock</span><span class="op" id="1619627">(</span><span class="op" id="1619628">&amp;</span><span class="ident" id="1619629">proflock</span><span class="op" id="1619637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619640">for</span>&nbsp;<span class="ident" id="1619644">b</span>&nbsp;<span class="op" id="1619646">:=</span>&nbsp;<span class="ident" id="1619649">bbuckets</span><span class="op" id="1619657">;</span>&nbsp;<span class="ident" id="1619659">b</span>&nbsp;<span class="op" id="1619661">!=</span>&nbsp;<span class="ident" id="1619664">nil</span><span class="op" id="1619667">;</span>&nbsp;<span class="ident" id="1619669">b</span>&nbsp;<span class="op" id="1619671">=</span>&nbsp;<span class="ident" id="1619673">b</span><span class="op" id="1619674">.</span><span class="ident" id="1619675">allnext</span>&nbsp;<span class="op" id="1619683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619687">n</span><span class="op" id="1619688">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619692">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619695">if</span>&nbsp;<span class="ident" id="1619698">n</span>&nbsp;<span class="op" id="1619700">&lt;=</span>&nbsp;<span class="builtinfunc" id="1619703">len</span><span class="op" id="1619706">(</span><span class="ident" id="1619707">p</span><span class="op" id="1619708">)</span>&nbsp;<span class="op" id="1619710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619714">ok</span>&nbsp;<span class="op" id="1619717">=</span>&nbsp;<span class="ident" id="1619719">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619726">for</span>&nbsp;<span class="ident" id="1619730">b</span>&nbsp;<span class="op" id="1619732">:=</span>&nbsp;<span class="ident" id="1619735">bbuckets</span><span class="op" id="1619743">;</span>&nbsp;<span class="ident" id="1619745">b</span>&nbsp;<span class="op" id="1619747">!=</span>&nbsp;<span class="ident" id="1619750">nil</span><span class="op" id="1619753">;</span>&nbsp;<span class="ident" id="1619755">b</span>&nbsp;<span class="op" id="1619757">=</span>&nbsp;<span class="ident" id="1619759">b</span><span class="op" id="1619760">.</span><span class="ident" id="1619761">allnext</span>&nbsp;<span class="op" id="1619769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619774">bp</span>&nbsp;<span class="op" id="1619777">:=</span>&nbsp;<span class="ident" id="1619780">b</span><span class="op" id="1619781">.</span><span class="ident" id="1619782">bp</span><span class="op" id="1619784">(</span><span class="op" id="1619785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619790">r</span>&nbsp;<span class="op" id="1619792">:=</span>&nbsp;<span class="op" id="1619795">&amp;</span><span class="ident" id="1619796">p</span><span class="op" id="1619797">[</span><span class="num" id="1619798">0</span><span class="op" id="1619799">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619804">r</span><span class="op" id="1619805">.</span><span class="ident" id="1619806">Count</span>&nbsp;<span class="op" id="1619812">=</span>&nbsp;<span class="ident" id="1619814">int64</span><span class="op" id="1619819">(</span><span class="ident" id="1619820">bp</span><span class="op" id="1619822">.</span><span class="ident" id="1619823">count</span><span class="op" id="1619828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619833">r</span><span class="op" id="1619834">.</span><span class="ident" id="1619835">Cycles</span>&nbsp;<span class="op" id="1619842">=</span>&nbsp;<span class="ident" id="1619844">int64</span><span class="op" id="1619849">(</span><span class="ident" id="1619850">bp</span><span class="op" id="1619852">.</span><span class="ident" id="1619853">cycles</span><span class="op" id="1619859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619864">i</span>&nbsp;<span class="op" id="1619866">:=</span>&nbsp;<span class="builtinfunc" id="1619869">copy</span><span class="op" id="1619873">(</span><span class="ident" id="1619874">r</span><span class="op" id="1619875">.</span><span class="ident" id="1619876">Stack0</span><span class="op" id="1619882">[</span><span class="op" id="1619883">:</span><span class="op" id="1619884">]</span><span class="op" id="1619885">,</span>&nbsp;<span class="ident" id="1619887">b</span><span class="op" id="1619888">.</span><span class="ident" id="1619889">stk</span><span class="op" id="1619892">(</span><span class="op" id="1619893">)</span><span class="op" id="1619894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619899">for</span>&nbsp;<span class="op" id="1619903">;</span>&nbsp;<span class="ident" id="1619905">i</span>&nbsp;<span class="op" id="1619907">&lt;</span>&nbsp;<span class="builtinfunc" id="1619909">len</span><span class="op" id="1619912">(</span><span class="ident" id="1619913">r</span><span class="op" id="1619914">.</span><span class="ident" id="1619915">Stack0</span><span class="op" id="1619921">)</span><span class="op" id="1619922">;</span>&nbsp;<span class="ident" id="1619924">i</span><span class="op" id="1619925">++</span>&nbsp;<span class="op" id="1619928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619934">r</span><span class="op" id="1619935">.</span><span class="ident" id="1619936">Stack0</span><span class="op" id="1619942">[</span><span class="ident" id="1619943">i</span><span class="op" id="1619944">]</span>&nbsp;<span class="op" id="1619946">=</span>&nbsp;<span class="num" id="1619948">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619958">p</span>&nbsp;<span class="op" id="1619960">=</span>&nbsp;<span class="ident" id="1619962">p</span><span class="op" id="1619963">[</span><span class="num" id="1619964">1</span><span class="op" id="1619965">:</span><span class="op" id="1619966">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619976">unlock</span><span class="op" id="1619982">(</span><span class="op" id="1619983">&amp;</span><span class="ident" id="1619984">proflock</span><span class="op" id="1619992">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619995">return</span><br>
<span class="lineno"></span><span class="op" id="1620002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1620005">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1620093">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1620179">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1620257">//</span><br>
<span class="lineno"></span><span class="comment" id="1620260">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1620321">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1620365">func</span>&nbsp;<span class="ident" id="1620370">ThreadCreateProfile</span><span class="op" id="1620389">(</span><span class="ident" id="1620390">p</span>&nbsp;<span class="op" id="1620392">[</span><span class="op" id="1620393">]</span><span class="ident" id="1620394">StackRecord</span><span class="op" id="1620405">)</span>&nbsp;<span class="op" id="1620407">(</span><span class="ident" id="1620408">n</span>&nbsp;<span class="builtintype" id="1620410">int</span><span class="op" id="1620413">,</span>&nbsp;<span class="ident" id="1620415">ok</span>&nbsp;<span class="builtintype" id="1620418">bool</span><span class="op" id="1620422">)</span>&nbsp;<span class="op" id="1620424">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620427">first</span>&nbsp;<span class="op" id="1620433">:=</span>&nbsp;<span class="op" id="1620436">(</span><span class="op" id="1620437">*</span><span class="ident" id="1620438">m</span><span class="op" id="1620439">)</span><span class="op" id="1620440">(</span><span class="ident" id="1620441">atomicloadp</span><span class="op" id="1620452">(</span><span class="ident" id="1620453">unsafe</span><span class="op" id="1620459">.</span><span class="ident" id="1620460">Pointer</span><span class="op" id="1620467">(</span><span class="op" id="1620468">&amp;</span><span class="ident" id="1620469">allm</span><span class="op" id="1620473">)</span><span class="op" id="1620474">)</span><span class="op" id="1620475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620478">for</span>&nbsp;<span class="ident" id="1620482">mp</span>&nbsp;<span class="op" id="1620485">:=</span>&nbsp;<span class="ident" id="1620488">first</span><span class="op" id="1620493">;</span>&nbsp;<span class="ident" id="1620495">mp</span>&nbsp;<span class="op" id="1620498">!=</span>&nbsp;<span class="ident" id="1620501">nil</span><span class="op" id="1620504">;</span>&nbsp;<span class="ident" id="1620506">mp</span>&nbsp;<span class="op" id="1620509">=</span>&nbsp;<span class="ident" id="1620511">mp</span><span class="op" id="1620513">.</span><span class="ident" id="1620514">alllink</span>&nbsp;<span class="op" id="1620522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620526">n</span><span class="op" id="1620527">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620534">if</span>&nbsp;<span class="ident" id="1620537">n</span>&nbsp;<span class="op" id="1620539">&lt;=</span>&nbsp;<span class="builtinfunc" id="1620542">len</span><span class="op" id="1620545">(</span><span class="ident" id="1620546">p</span><span class="op" id="1620547">)</span>&nbsp;<span class="op" id="1620549">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620553">ok</span>&nbsp;<span class="op" id="1620556">=</span>&nbsp;<span class="ident" id="1620558">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620565">i</span>&nbsp;<span class="op" id="1620567">:=</span>&nbsp;<span class="num" id="1620570">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620574">for</span>&nbsp;<span class="ident" id="1620578">mp</span>&nbsp;<span class="op" id="1620581">:=</span>&nbsp;<span class="ident" id="1620584">first</span><span class="op" id="1620589">;</span>&nbsp;<span class="ident" id="1620591">mp</span>&nbsp;<span class="op" id="1620594">!=</span>&nbsp;<span class="ident" id="1620597">nil</span><span class="op" id="1620600">;</span>&nbsp;<span class="ident" id="1620602">mp</span>&nbsp;<span class="op" id="1620605">=</span>&nbsp;<span class="ident" id="1620607">mp</span><span class="op" id="1620609">.</span><span class="ident" id="1620610">alllink</span>&nbsp;<span class="op" id="1620618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620623">for</span>&nbsp;<span class="ident" id="1620627">s</span>&nbsp;<span class="op" id="1620629">:=</span>&nbsp;<span class="keyword" id="1620632">range</span>&nbsp;<span class="ident" id="1620638">mp</span><span class="op" id="1620640">.</span><span class="ident" id="1620641">createstack</span>&nbsp;<span class="op" id="1620653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620659">p</span><span class="op" id="1620660">[</span><span class="ident" id="1620661">i</span><span class="op" id="1620662">]</span><span class="op" id="1620663">.</span><span class="ident" id="1620664">Stack0</span><span class="op" id="1620670">[</span><span class="ident" id="1620671">s</span><span class="op" id="1620672">]</span>&nbsp;<span class="op" id="1620674">=</span>&nbsp;<span class="builtintype" id="1620676">uintptr</span><span class="op" id="1620683">(</span><span class="ident" id="1620684">mp</span><span class="op" id="1620686">.</span><span class="ident" id="1620687">createstack</span><span class="op" id="1620698">[</span><span class="ident" id="1620699">s</span><span class="op" id="1620700">]</span><span class="op" id="1620701">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620711">i</span><span class="op" id="1620712">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620723">return</span><br>
<span class="lineno">520</span><span class="op" id="1620730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1620733">var</span>&nbsp;<span class="ident" id="1620737">allgs</span>&nbsp;<span class="op" id="1620743">[</span><span class="op" id="1620744">]</span><span class="op" id="1620745">*</span><span class="ident" id="1620746">g</span>&nbsp;<span class="comment" id="1620748">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1620759">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1620851">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1620934">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1621009">//</span><br>
<span class="lineno"></span><span class="comment" id="1621012">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1621073">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1621114">func</span>&nbsp;<span class="ident" id="1621119">GoroutineProfile</span><span class="op" id="1621135">(</span><span class="ident" id="1621136">p</span>&nbsp;<span class="op" id="1621138">[</span><span class="op" id="1621139">]</span><span class="ident" id="1621140">StackRecord</span><span class="op" id="1621151">)</span>&nbsp;<span class="op" id="1621153">(</span><span class="ident" id="1621154">n</span>&nbsp;<span class="builtintype" id="1621156">int</span><span class="op" id="1621159">,</span>&nbsp;<span class="ident" id="1621161">ok</span>&nbsp;<span class="builtintype" id="1621164">bool</span><span class="op" id="1621168">)</span>&nbsp;<span class="op" id="1621170">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621174">n</span>&nbsp;<span class="op" id="1621176">=</span>&nbsp;<span class="ident" id="1621178">NumGoroutine</span><span class="op" id="1621190">(</span><span class="op" id="1621191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621194">if</span>&nbsp;<span class="ident" id="1621197">n</span>&nbsp;<span class="op" id="1621199">&lt;=</span>&nbsp;<span class="builtinfunc" id="1621202">len</span><span class="op" id="1621205">(</span><span class="ident" id="1621206">p</span><span class="op" id="1621207">)</span>&nbsp;<span class="op" id="1621209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621213">gp</span>&nbsp;<span class="op" id="1621216">:=</span>&nbsp;<span class="ident" id="1621219">getg</span><span class="op" id="1621223">(</span><span class="op" id="1621224">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621228">semacquire</span><span class="op" id="1621238">(</span><span class="op" id="1621239">&amp;</span><span class="ident" id="1621240">worldsema</span><span class="op" id="1621249">,</span>&nbsp;<span class="ident" id="1621251">false</span><span class="op" id="1621256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621260">gp</span><span class="op" id="1621262">.</span><span class="ident" id="1621263">m</span><span class="op" id="1621264">.</span><span class="ident" id="1621265">gcing</span>&nbsp;<span class="op" id="1621271">=</span>&nbsp;<span class="num" id="1621273">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621277">onM</span><span class="op" id="1621280">(</span><span class="ident" id="1621281">stoptheworld</span><span class="op" id="1621293">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621298">n</span>&nbsp;<span class="op" id="1621300">=</span>&nbsp;<span class="ident" id="1621302">NumGoroutine</span><span class="op" id="1621314">(</span><span class="op" id="1621315">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621319">if</span>&nbsp;<span class="ident" id="1621322">n</span>&nbsp;<span class="op" id="1621324">&lt;=</span>&nbsp;<span class="builtinfunc" id="1621327">len</span><span class="op" id="1621330">(</span><span class="ident" id="1621331">p</span><span class="op" id="1621332">)</span>&nbsp;<span class="op" id="1621334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621339">ok</span>&nbsp;<span class="op" id="1621342">=</span>&nbsp;<span class="ident" id="1621344">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621352">r</span>&nbsp;<span class="op" id="1621354">:=</span>&nbsp;<span class="ident" id="1621357">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621362">sp</span>&nbsp;<span class="op" id="1621365">:=</span>&nbsp;<span class="ident" id="1621368">getcallersp</span><span class="op" id="1621379">(</span><span class="ident" id="1621380">unsafe</span><span class="op" id="1621386">.</span><span class="ident" id="1621387">Pointer</span><span class="op" id="1621394">(</span><span class="op" id="1621395">&amp;</span><span class="ident" id="1621396">p</span><span class="op" id="1621397">)</span><span class="op" id="1621398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621403">pc</span>&nbsp;<span class="op" id="1621406">:=</span>&nbsp;<span class="ident" id="1621409">getcallerpc</span><span class="op" id="1621420">(</span><span class="ident" id="1621421">unsafe</span><span class="op" id="1621427">.</span><span class="ident" id="1621428">Pointer</span><span class="op" id="1621435">(</span><span class="op" id="1621436">&amp;</span><span class="ident" id="1621437">p</span><span class="op" id="1621438">)</span><span class="op" id="1621439">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621444">onM</span><span class="op" id="1621447">(</span><span class="keyword" id="1621448">func</span><span class="op" id="1621452">(</span><span class="op" id="1621453">)</span>&nbsp;<span class="op" id="1621455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621461">saveg</span><span class="op" id="1621466">(</span><span class="ident" id="1621467">pc</span><span class="op" id="1621469">,</span>&nbsp;<span class="ident" id="1621471">sp</span><span class="op" id="1621473">,</span>&nbsp;<span class="ident" id="1621475">gp</span><span class="op" id="1621477">,</span>&nbsp;<span class="op" id="1621479">&amp;</span><span class="ident" id="1621480">r</span><span class="op" id="1621481">[</span><span class="num" id="1621482">0</span><span class="op" id="1621483">]</span><span class="op" id="1621484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621489">}</span><span class="op" id="1621490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621495">r</span>&nbsp;<span class="op" id="1621497">=</span>&nbsp;<span class="ident" id="1621499">r</span><span class="op" id="1621500">[</span><span class="num" id="1621501">1</span><span class="op" id="1621502">:</span><span class="op" id="1621503">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621508">for</span>&nbsp;<span class="ident" id="1621512">_</span><span class="op" id="1621513">,</span>&nbsp;<span class="ident" id="1621515">gp1</span>&nbsp;<span class="op" id="1621519">:=</span>&nbsp;<span class="keyword" id="1621522">range</span>&nbsp;<span class="ident" id="1621528">allgs</span>&nbsp;<span class="op" id="1621534">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621540">if</span>&nbsp;<span class="ident" id="1621543">gp1</span>&nbsp;<span class="op" id="1621547">==</span>&nbsp;<span class="ident" id="1621550">gp</span>&nbsp;<span class="op" id="1621553">||</span>&nbsp;<span class="ident" id="1621556">readgstatus</span><span class="op" id="1621567">(</span><span class="ident" id="1621568">gp1</span><span class="op" id="1621571">)</span>&nbsp;<span class="op" id="1621573">==</span>&nbsp;<span class="ident" id="1621576">_Gdead</span>&nbsp;<span class="op" id="1621583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621590">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621609">saveg</span><span class="op" id="1621614">(</span><span class="op" id="1621615">^</span><span class="builtintype" id="1621616">uintptr</span><span class="op" id="1621623">(</span><span class="num" id="1621624">0</span><span class="op" id="1621625">)</span><span class="op" id="1621626">,</span>&nbsp;<span class="op" id="1621628">^</span><span class="builtintype" id="1621629">uintptr</span><span class="op" id="1621636">(</span><span class="num" id="1621637">0</span><span class="op" id="1621638">)</span><span class="op" id="1621639">,</span>&nbsp;<span class="ident" id="1621641">gp1</span><span class="op" id="1621644">,</span>&nbsp;<span class="op" id="1621646">&amp;</span><span class="ident" id="1621647">r</span><span class="op" id="1621648">[</span><span class="num" id="1621649">0</span><span class="op" id="1621650">]</span><span class="op" id="1621651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621657">r</span>&nbsp;<span class="op" id="1621659">=</span>&nbsp;<span class="ident" id="1621661">r</span><span class="op" id="1621662">[</span><span class="num" id="1621663">1</span><span class="op" id="1621664">:</span><span class="op" id="1621665">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621679">gp</span><span class="op" id="1621681">.</span><span class="ident" id="1621682">m</span><span class="op" id="1621683">.</span><span class="ident" id="1621684">gcing</span>&nbsp;<span class="op" id="1621690">=</span>&nbsp;<span class="num" id="1621692">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621696">semrelease</span><span class="op" id="1621706">(</span><span class="op" id="1621707">&amp;</span><span class="ident" id="1621708">worldsema</span><span class="op" id="1621717">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621721">onM</span><span class="op" id="1621724">(</span><span class="ident" id="1621725">starttheworld</span><span class="op" id="1621738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621745">return</span>&nbsp;<span class="ident" id="1621752">n</span><span class="op" id="1621753">,</span>&nbsp;<span class="ident" id="1621755">ok</span><br>
<span class="lineno"></span><span class="op" id="1621758">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1621761">func</span>&nbsp;<span class="ident" id="1621766">saveg</span><span class="op" id="1621771">(</span><span class="ident" id="1621772">pc</span><span class="op" id="1621774">,</span>&nbsp;<span class="ident" id="1621776">sp</span>&nbsp;<span class="builtintype" id="1621779">uintptr</span><span class="op" id="1621786">,</span>&nbsp;<span class="ident" id="1621788">gp</span>&nbsp;<span class="op" id="1621791">*</span><span class="ident" id="1621792">g</span><span class="op" id="1621793">,</span>&nbsp;<span class="ident" id="1621795">r</span>&nbsp;<span class="op" id="1621797">*</span><span class="ident" id="1621798">StackRecord</span><span class="op" id="1621809">)</span>&nbsp;<span class="op" id="1621811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621814">n</span>&nbsp;<span class="op" id="1621816">:=</span>&nbsp;<span class="ident" id="1621819">gentraceback</span><span class="op" id="1621831">(</span><span class="ident" id="1621832">pc</span><span class="op" id="1621834">,</span>&nbsp;<span class="ident" id="1621836">sp</span><span class="op" id="1621838">,</span>&nbsp;<span class="num" id="1621840">0</span><span class="op" id="1621841">,</span>&nbsp;<span class="ident" id="1621843">gp</span><span class="op" id="1621845">,</span>&nbsp;<span class="num" id="1621847">0</span><span class="op" id="1621848">,</span>&nbsp;<span class="op" id="1621850">&amp;</span><span class="ident" id="1621851">r</span><span class="op" id="1621852">.</span><span class="ident" id="1621853">Stack0</span><span class="op" id="1621859">[</span><span class="num" id="1621860">0</span><span class="op" id="1621861">]</span><span class="op" id="1621862">,</span>&nbsp;<span class="builtinfunc" id="1621864">len</span><span class="op" id="1621867">(</span><span class="ident" id="1621868">r</span><span class="op" id="1621869">.</span><span class="ident" id="1621870">Stack0</span><span class="op" id="1621876">)</span><span class="op" id="1621877">,</span>&nbsp;<span class="ident" id="1621879">nil</span><span class="op" id="1621882">,</span>&nbsp;<span class="ident" id="1621884">nil</span><span class="op" id="1621887">,</span>&nbsp;<span class="num" id="1621889">0</span><span class="op" id="1621890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621893">if</span>&nbsp;<span class="ident" id="1621896">n</span>&nbsp;<span class="op" id="1621898">&lt;</span>&nbsp;<span class="builtinfunc" id="1621900">len</span><span class="op" id="1621903">(</span><span class="ident" id="1621904">r</span><span class="op" id="1621905">.</span><span class="ident" id="1621906">Stack0</span><span class="op" id="1621912">)</span>&nbsp;<span class="op" id="1621914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621918">r</span><span class="op" id="1621919">.</span><span class="ident" id="1621920">Stack0</span><span class="op" id="1621926">[</span><span class="ident" id="1621927">n</span><span class="op" id="1621928">]</span>&nbsp;<span class="op" id="1621930">=</span>&nbsp;<span class="num" id="1621932">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621935">}</span><br>
<span class="lineno"></span><span class="op" id="1621937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1621940">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1622005">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1622056">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1622126">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1622181">func</span>&nbsp;<span class="ident" id="1622186">Stack</span><span class="op" id="1622191">(</span><span class="ident" id="1622192">buf</span>&nbsp;<span class="op" id="1622196">[</span><span class="op" id="1622197">]</span><span class="builtintype" id="1622198">byte</span><span class="op" id="1622202">,</span>&nbsp;<span class="ident" id="1622204">all</span>&nbsp;<span class="builtintype" id="1622208">bool</span><span class="op" id="1622212">)</span>&nbsp;<span class="builtintype" id="1622214">int</span>&nbsp;<span class="op" id="1622218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622221">mp</span>&nbsp;<span class="op" id="1622224">:=</span>&nbsp;<span class="ident" id="1622227">acquirem</span><span class="op" id="1622235">(</span><span class="op" id="1622236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622239">gp</span>&nbsp;<span class="op" id="1622242">:=</span>&nbsp;<span class="ident" id="1622245">mp</span><span class="op" id="1622247">.</span><span class="ident" id="1622248">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622254">if</span>&nbsp;<span class="ident" id="1622257">all</span>&nbsp;<span class="op" id="1622261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622265">semacquire</span><span class="op" id="1622275">(</span><span class="op" id="1622276">&amp;</span><span class="ident" id="1622277">worldsema</span><span class="op" id="1622286">,</span>&nbsp;<span class="ident" id="1622288">false</span><span class="op" id="1622293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622297">mp</span><span class="op" id="1622299">.</span><span class="ident" id="1622300">gcing</span>&nbsp;<span class="op" id="1622306">=</span>&nbsp;<span class="num" id="1622308">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622312">releasem</span><span class="op" id="1622320">(</span><span class="ident" id="1622321">mp</span><span class="op" id="1622323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622327">onM</span><span class="op" id="1622330">(</span><span class="ident" id="1622331">stoptheworld</span><span class="op" id="1622343">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622347">if</span>&nbsp;<span class="ident" id="1622350">mp</span>&nbsp;<span class="op" id="1622353">!=</span>&nbsp;<span class="ident" id="1622356">acquirem</span><span class="op" id="1622364">(</span><span class="op" id="1622365">)</span>&nbsp;<span class="op" id="1622367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622372">gothrow</span><span class="op" id="1622379">(</span><span class="string" id="1622380">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1622400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622411">n</span>&nbsp;<span class="op" id="1622413">:=</span>&nbsp;<span class="num" id="1622416">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622419">if</span>&nbsp;<span class="builtinfunc" id="1622422">len</span><span class="op" id="1622425">(</span><span class="ident" id="1622426">buf</span><span class="op" id="1622429">)</span>&nbsp;<span class="op" id="1622431">&gt;</span>&nbsp;<span class="num" id="1622433">0</span>&nbsp;<span class="op" id="1622435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622439">sp</span>&nbsp;<span class="op" id="1622442">:=</span>&nbsp;<span class="ident" id="1622445">getcallersp</span><span class="op" id="1622456">(</span><span class="ident" id="1622457">unsafe</span><span class="op" id="1622463">.</span><span class="ident" id="1622464">Pointer</span><span class="op" id="1622471">(</span><span class="op" id="1622472">&amp;</span><span class="ident" id="1622473">buf</span><span class="op" id="1622476">)</span><span class="op" id="1622477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622481">pc</span>&nbsp;<span class="op" id="1622484">:=</span>&nbsp;<span class="ident" id="1622487">getcallerpc</span><span class="op" id="1622498">(</span><span class="ident" id="1622499">unsafe</span><span class="op" id="1622505">.</span><span class="ident" id="1622506">Pointer</span><span class="op" id="1622513">(</span><span class="op" id="1622514">&amp;</span><span class="ident" id="1622515">buf</span><span class="op" id="1622518">)</span><span class="op" id="1622519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622523">onM</span><span class="op" id="1622526">(</span><span class="keyword" id="1622527">func</span><span class="op" id="1622531">(</span><span class="op" id="1622532">)</span>&nbsp;<span class="op" id="1622534">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622539">g0</span>&nbsp;<span class="op" id="1622542">:=</span>&nbsp;<span class="ident" id="1622545">getg</span><span class="op" id="1622549">(</span><span class="op" id="1622550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622555">g0</span><span class="op" id="1622557">.</span><span class="ident" id="1622558">writebuf</span>&nbsp;<span class="op" id="1622567">=</span>&nbsp;<span class="ident" id="1622569">buf</span><span class="op" id="1622572">[</span><span class="num" id="1622573">0</span><span class="op" id="1622574">:</span><span class="num" id="1622575">0</span><span class="op" id="1622576">:</span><span class="builtinfunc" id="1622577">len</span><span class="op" id="1622580">(</span><span class="ident" id="1622581">buf</span><span class="op" id="1622584">)</span><span class="op" id="1622585">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622590">goroutineheader</span><span class="op" id="1622605">(</span><span class="ident" id="1622606">gp</span><span class="op" id="1622608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622613">traceback</span><span class="op" id="1622622">(</span><span class="ident" id="1622623">pc</span><span class="op" id="1622625">,</span>&nbsp;<span class="ident" id="1622627">sp</span><span class="op" id="1622629">,</span>&nbsp;<span class="num" id="1622631">0</span><span class="op" id="1622632">,</span>&nbsp;<span class="ident" id="1622634">gp</span><span class="op" id="1622636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622641">if</span>&nbsp;<span class="ident" id="1622644">all</span>&nbsp;<span class="op" id="1622648">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622654">tracebackothers</span><span class="op" id="1622669">(</span><span class="ident" id="1622670">gp</span><span class="op" id="1622672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622682">n</span>&nbsp;<span class="op" id="1622684">=</span>&nbsp;<span class="builtinfunc" id="1622686">len</span><span class="op" id="1622689">(</span><span class="ident" id="1622690">g0</span><span class="op" id="1622692">.</span><span class="ident" id="1622693">writebuf</span><span class="op" id="1622701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622706">g0</span><span class="op" id="1622708">.</span><span class="ident" id="1622709">writebuf</span>&nbsp;<span class="op" id="1622718">=</span>&nbsp;<span class="ident" id="1622720">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622726">}</span><span class="op" id="1622727">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622734">if</span>&nbsp;<span class="ident" id="1622737">all</span>&nbsp;<span class="op" id="1622741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622745">mp</span><span class="op" id="1622747">.</span><span class="ident" id="1622748">gcing</span>&nbsp;<span class="op" id="1622754">=</span>&nbsp;<span class="num" id="1622756">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622760">semrelease</span><span class="op" id="1622770">(</span><span class="op" id="1622771">&amp;</span><span class="ident" id="1622772">worldsema</span><span class="op" id="1622781">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622785">onM</span><span class="op" id="1622788">(</span><span class="ident" id="1622789">starttheworld</span><span class="op" id="1622802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622808">releasem</span><span class="op" id="1622816">(</span><span class="ident" id="1622817">mp</span><span class="op" id="1622819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622822">return</span>&nbsp;<span class="ident" id="1622829">n</span><br>
<span class="lineno"></span><span class="op" id="1622831">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1622834">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622864">var</span>&nbsp;<span class="ident" id="1622868">tracelock</span>&nbsp;<span class="ident" id="1622878">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1622885">func</span>&nbsp;<span class="ident" id="1622890">tracealloc</span><span class="op" id="1622900">(</span><span class="ident" id="1622901">p</span>&nbsp;<span class="ident" id="1622903">unsafe</span><span class="op" id="1622909">.</span><span class="ident" id="1622910">Pointer</span><span class="op" id="1622917">,</span>&nbsp;<span class="ident" id="1622919">size</span>&nbsp;<span class="builtintype" id="1622924">uintptr</span><span class="op" id="1622931">,</span>&nbsp;<span class="ident" id="1622933">typ</span>&nbsp;<span class="op" id="1622937">*</span><span class="ident" id="1622938">_type</span><span class="op" id="1622943">)</span>&nbsp;<span class="op" id="1622945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622948">lock</span><span class="op" id="1622952">(</span><span class="op" id="1622953">&amp;</span><span class="ident" id="1622954">tracelock</span><span class="op" id="1622963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622966">gp</span>&nbsp;<span class="op" id="1622969">:=</span>&nbsp;<span class="ident" id="1622972">getg</span><span class="op" id="1622976">(</span><span class="op" id="1622977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622980">gp</span><span class="op" id="1622982">.</span><span class="ident" id="1622983">m</span><span class="op" id="1622984">.</span><span class="ident" id="1622985">traceback</span>&nbsp;<span class="op" id="1622995">=</span>&nbsp;<span class="num" id="1622997">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623000">if</span>&nbsp;<span class="ident" id="1623003">typ</span>&nbsp;<span class="op" id="1623007">==</span>&nbsp;<span class="ident" id="1623010">nil</span>&nbsp;<span class="op" id="1623014">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1623018">print</span><span class="op" id="1623023">(</span><span class="string" id="1623024">&#34;tracealloc(&#34;</span><span class="op" id="1623037">,</span>&nbsp;<span class="ident" id="1623039">p</span><span class="op" id="1623040">,</span>&nbsp;<span class="string" id="1623042">&#34;,&nbsp;&#34;</span><span class="op" id="1623046">,</span>&nbsp;<span class="ident" id="1623048">hex</span><span class="op" id="1623051">(</span><span class="ident" id="1623052">size</span><span class="op" id="1623056">)</span><span class="op" id="1623057">,</span>&nbsp;<span class="string" id="1623059">&#34;)\n&#34;</span><span class="op" id="1623064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623067">}</span>&nbsp;<span class="keyword" id="1623069">else</span>&nbsp;<span class="op" id="1623074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1623078">print</span><span class="op" id="1623083">(</span><span class="string" id="1623084">&#34;tracealloc(&#34;</span><span class="op" id="1623097">,</span>&nbsp;<span class="ident" id="1623099">p</span><span class="op" id="1623100">,</span>&nbsp;<span class="string" id="1623102">&#34;,&nbsp;&#34;</span><span class="op" id="1623106">,</span>&nbsp;<span class="ident" id="1623108">hex</span><span class="op" id="1623111">(</span><span class="ident" id="1623112">size</span><span class="op" id="1623116">)</span><span class="op" id="1623117">,</span>&nbsp;<span class="string" id="1623119">&#34;,&nbsp;&#34;</span><span class="op" id="1623123">,</span>&nbsp;<span class="op" id="1623125">*</span><span class="ident" id="1623126">typ</span><span class="op" id="1623129">.</span><span class="ident" id="1623130">_string</span><span class="op" id="1623137">,</span>&nbsp;<span class="string" id="1623139">&#34;)\n&#34;</span><span class="op" id="1623144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623150">if</span>&nbsp;<span class="ident" id="1623153">gp</span><span class="op" id="1623155">.</span><span class="ident" id="1623156">m</span><span class="op" id="1623157">.</span><span class="ident" id="1623158">curg</span>&nbsp;<span class="op" id="1623163">==</span>&nbsp;<span class="ident" id="1623166">nil</span>&nbsp;<span class="op" id="1623170">||</span>&nbsp;<span class="ident" id="1623173">gp</span>&nbsp;<span class="op" id="1623176">==</span>&nbsp;<span class="ident" id="1623179">gp</span><span class="op" id="1623181">.</span><span class="ident" id="1623182">m</span><span class="op" id="1623183">.</span><span class="ident" id="1623184">curg</span>&nbsp;<span class="op" id="1623189">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623193">goroutineheader</span><span class="op" id="1623208">(</span><span class="ident" id="1623209">gp</span><span class="op" id="1623211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623215">pc</span>&nbsp;<span class="op" id="1623218">:=</span>&nbsp;<span class="ident" id="1623221">getcallerpc</span><span class="op" id="1623232">(</span><span class="ident" id="1623233">unsafe</span><span class="op" id="1623239">.</span><span class="ident" id="1623240">Pointer</span><span class="op" id="1623247">(</span><span class="op" id="1623248">&amp;</span><span class="ident" id="1623249">p</span><span class="op" id="1623250">)</span><span class="op" id="1623251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623255">sp</span>&nbsp;<span class="op" id="1623258">:=</span>&nbsp;<span class="ident" id="1623261">getcallersp</span><span class="op" id="1623272">(</span><span class="ident" id="1623273">unsafe</span><span class="op" id="1623279">.</span><span class="ident" id="1623280">Pointer</span><span class="op" id="1623287">(</span><span class="op" id="1623288">&amp;</span><span class="ident" id="1623289">p</span><span class="op" id="1623290">)</span><span class="op" id="1623291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623295">onM</span><span class="op" id="1623298">(</span><span class="keyword" id="1623299">func</span><span class="op" id="1623303">(</span><span class="op" id="1623304">)</span>&nbsp;<span class="op" id="1623306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623311">traceback</span><span class="op" id="1623320">(</span><span class="ident" id="1623321">pc</span><span class="op" id="1623323">,</span>&nbsp;<span class="ident" id="1623325">sp</span><span class="op" id="1623327">,</span>&nbsp;<span class="num" id="1623329">0</span><span class="op" id="1623330">,</span>&nbsp;<span class="ident" id="1623332">gp</span><span class="op" id="1623334">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623338">}</span><span class="op" id="1623339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623342">}</span>&nbsp;<span class="keyword" id="1623344">else</span>&nbsp;<span class="op" id="1623349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623353">goroutineheader</span><span class="op" id="1623368">(</span><span class="ident" id="1623369">gp</span><span class="op" id="1623371">.</span><span class="ident" id="1623372">m</span><span class="op" id="1623373">.</span><span class="ident" id="1623374">curg</span><span class="op" id="1623378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623382">traceback</span><span class="op" id="1623391">(</span><span class="op" id="1623392">^</span><span class="builtintype" id="1623393">uintptr</span><span class="op" id="1623400">(</span><span class="num" id="1623401">0</span><span class="op" id="1623402">)</span><span class="op" id="1623403">,</span>&nbsp;<span class="op" id="1623405">^</span><span class="builtintype" id="1623406">uintptr</span><span class="op" id="1623413">(</span><span class="num" id="1623414">0</span><span class="op" id="1623415">)</span><span class="op" id="1623416">,</span>&nbsp;<span class="num" id="1623418">0</span><span class="op" id="1623419">,</span>&nbsp;<span class="ident" id="1623421">gp</span><span class="op" id="1623423">.</span><span class="ident" id="1623424">m</span><span class="op" id="1623425">.</span><span class="ident" id="1623426">curg</span><span class="op" id="1623430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623433">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1623436">print</span><span class="op" id="1623441">(</span><span class="string" id="1623442">&#34;\n&#34;</span><span class="op" id="1623446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623449">gp</span><span class="op" id="1623451">.</span><span class="ident" id="1623452">m</span><span class="op" id="1623453">.</span><span class="ident" id="1623454">traceback</span>&nbsp;<span class="op" id="1623464">=</span>&nbsp;<span class="num" id="1623466">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623469">unlock</span><span class="op" id="1623475">(</span><span class="op" id="1623476">&amp;</span><span class="ident" id="1623477">tracelock</span><span class="op" id="1623486">)</span><br>
<span class="lineno"></span><span class="op" id="1623488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1623491">func</span>&nbsp;<span class="ident" id="1623496">tracefree</span><span class="op" id="1623505">(</span><span class="ident" id="1623506">p</span>&nbsp;<span class="ident" id="1623508">unsafe</span><span class="op" id="1623514">.</span><span class="ident" id="1623515">Pointer</span><span class="op" id="1623522">,</span>&nbsp;<span class="ident" id="1623524">size</span>&nbsp;<span class="builtintype" id="1623529">uintptr</span><span class="op" id="1623536">)</span>&nbsp;<span class="op" id="1623538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623541">lock</span><span class="op" id="1623545">(</span><span class="op" id="1623546">&amp;</span><span class="ident" id="1623547">tracelock</span><span class="op" id="1623556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623559">gp</span>&nbsp;<span class="op" id="1623562">:=</span>&nbsp;<span class="ident" id="1623565">getg</span><span class="op" id="1623569">(</span><span class="op" id="1623570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623573">gp</span><span class="op" id="1623575">.</span><span class="ident" id="1623576">m</span><span class="op" id="1623577">.</span><span class="ident" id="1623578">traceback</span>&nbsp;<span class="op" id="1623588">=</span>&nbsp;<span class="num" id="1623590">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1623593">print</span><span class="op" id="1623598">(</span><span class="string" id="1623599">&#34;tracefree(&#34;</span><span class="op" id="1623611">,</span>&nbsp;<span class="ident" id="1623613">p</span><span class="op" id="1623614">,</span>&nbsp;<span class="string" id="1623616">&#34;,&nbsp;&#34;</span><span class="op" id="1623620">,</span>&nbsp;<span class="ident" id="1623622">hex</span><span class="op" id="1623625">(</span><span class="ident" id="1623626">size</span><span class="op" id="1623630">)</span><span class="op" id="1623631">,</span>&nbsp;<span class="string" id="1623633">&#34;)\n&#34;</span><span class="op" id="1623638">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623641">goroutineheader</span><span class="op" id="1623656">(</span><span class="ident" id="1623657">gp</span><span class="op" id="1623659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623662">pc</span>&nbsp;<span class="op" id="1623665">:=</span>&nbsp;<span class="ident" id="1623668">getcallerpc</span><span class="op" id="1623679">(</span><span class="ident" id="1623680">unsafe</span><span class="op" id="1623686">.</span><span class="ident" id="1623687">Pointer</span><span class="op" id="1623694">(</span><span class="op" id="1623695">&amp;</span><span class="ident" id="1623696">p</span><span class="op" id="1623697">)</span><span class="op" id="1623698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623701">sp</span>&nbsp;<span class="op" id="1623704">:=</span>&nbsp;<span class="ident" id="1623707">getcallersp</span><span class="op" id="1623718">(</span><span class="ident" id="1623719">unsafe</span><span class="op" id="1623725">.</span><span class="ident" id="1623726">Pointer</span><span class="op" id="1623733">(</span><span class="op" id="1623734">&amp;</span><span class="ident" id="1623735">p</span><span class="op" id="1623736">)</span><span class="op" id="1623737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623740">onM</span><span class="op" id="1623743">(</span><span class="keyword" id="1623744">func</span><span class="op" id="1623748">(</span><span class="op" id="1623749">)</span>&nbsp;<span class="op" id="1623751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623755">traceback</span><span class="op" id="1623764">(</span><span class="ident" id="1623765">pc</span><span class="op" id="1623767">,</span>&nbsp;<span class="ident" id="1623769">sp</span><span class="op" id="1623771">,</span>&nbsp;<span class="num" id="1623773">0</span><span class="op" id="1623774">,</span>&nbsp;<span class="ident" id="1623776">gp</span><span class="op" id="1623778">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623781">}</span><span class="op" id="1623782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1623785">print</span><span class="op" id="1623790">(</span><span class="string" id="1623791">&#34;\n&#34;</span><span class="op" id="1623795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623798">gp</span><span class="op" id="1623800">.</span><span class="ident" id="1623801">m</span><span class="op" id="1623802">.</span><span class="ident" id="1623803">traceback</span>&nbsp;<span class="op" id="1623813">=</span>&nbsp;<span class="num" id="1623815">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623818">unlock</span><span class="op" id="1623824">(</span><span class="op" id="1623825">&amp;</span><span class="ident" id="1623826">tracelock</span><span class="op" id="1623835">)</span><br>
<span class="lineno"></span><span class="op" id="1623837">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1623840">func</span>&nbsp;<span class="ident" id="1623845">tracegc</span><span class="op" id="1623852">(</span><span class="op" id="1623853">)</span>&nbsp;<span class="op" id="1623855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623858">lock</span><span class="op" id="1623862">(</span><span class="op" id="1623863">&amp;</span><span class="ident" id="1623864">tracelock</span><span class="op" id="1623873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623876">gp</span>&nbsp;<span class="op" id="1623879">:=</span>&nbsp;<span class="ident" id="1623882">getg</span><span class="op" id="1623886">(</span><span class="op" id="1623887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623890">gp</span><span class="op" id="1623892">.</span><span class="ident" id="1623893">m</span><span class="op" id="1623894">.</span><span class="ident" id="1623895">traceback</span>&nbsp;<span class="op" id="1623905">=</span>&nbsp;<span class="num" id="1623907">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1623910">print</span><span class="op" id="1623915">(</span><span class="string" id="1623916">&#34;tracegc()\n&#34;</span><span class="op" id="1623929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1623932">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623987">tracebackothers</span><span class="op" id="1624002">(</span><span class="ident" id="1624003">gp</span><span class="op" id="1624005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1624008">print</span><span class="op" id="1624013">(</span><span class="string" id="1624014">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1624029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1624032">print</span><span class="op" id="1624037">(</span><span class="string" id="1624038">&#34;\n&#34;</span><span class="op" id="1624042">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624045">gp</span><span class="op" id="1624047">.</span><span class="ident" id="1624048">m</span><span class="op" id="1624049">.</span><span class="ident" id="1624050">traceback</span>&nbsp;<span class="op" id="1624060">=</span>&nbsp;<span class="num" id="1624062">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624065">unlock</span><span class="op" id="1624071">(</span><span class="op" id="1624072">&amp;</span><span class="ident" id="1624073">tracelock</span><span class="op" id="1624082">)</span><br>
<span class="lineno"></span><span class="op" id="1624084">}</span>
</div>
</body>
</html>
