<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5713161">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5713216">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5713270">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5713321">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="5713390">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="5713404">//</span><br>
<span class="lineno"></span><span class="comment" id="5713407">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="5713478">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="5713539">//</span><br>
<span class="lineno"></span><span class="comment" id="5713542">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5713591">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="5713623">package</span>&nbsp;<span class="ident" id="5713631">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5713636">import</span>&nbsp;<span class="op" id="5713643">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5713646">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5713669">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5713679">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5713686">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5713692">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5713703">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5713711">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5713718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5713721">var</span>&nbsp;<span class="ident" id="5713725">drivers</span>&nbsp;<span class="op" id="5713733">=</span>&nbsp;<span class="builtinfunc" id="5713735">make</span><span class="op" id="5713739">(</span><span class="keyword" id="5713740">map</span><span class="op" id="5713743">[</span><span class="builtintype" id="5713744">string</span><span class="op" id="5713750">]</span><span class="ident" id="5713751">driver</span><span class="op" id="5713757">.</span><span class="ident" id="5713758">Driver</span><span class="op" id="5713764">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5713767">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5713835">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="5713906">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="5713920">func</span>&nbsp;<span class="ident" id="5713925">Register</span><span class="op" id="5713933">(</span><span class="ident" id="5713934">name</span>&nbsp;<span class="builtintype" id="5713939">string</span><span class="op" id="5713945">,</span>&nbsp;<span class="ident" id="5713947">driver</span>&nbsp;<span class="ident" id="5713954">driver</span><span class="op" id="5713960">.</span><span class="ident" id="5713961">Driver</span><span class="op" id="5713967">)</span>&nbsp;<span class="op" id="5713969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5713972">if</span>&nbsp;<span class="ident" id="5713975">driver</span>&nbsp;<span class="op" id="5713982">==</span>&nbsp;<span class="ident" id="5713985">nil</span>&nbsp;<span class="op" id="5713989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5713993">panic</span><span class="op" id="5713998">(</span><span class="string" id="5713999">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="5714028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714034">if</span>&nbsp;<span class="ident" id="5714037">_</span><span class="op" id="5714038">,</span>&nbsp;<span class="ident" id="5714040">dup</span>&nbsp;<span class="op" id="5714044">:=</span>&nbsp;<span class="ident" id="5714047">drivers</span><span class="op" id="5714054">[</span><span class="ident" id="5714055">name</span><span class="op" id="5714059">]</span><span class="op" id="5714060">;</span>&nbsp;<span class="ident" id="5714062">dup</span>&nbsp;<span class="op" id="5714066">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5714070">panic</span><span class="op" id="5714075">(</span><span class="string" id="5714076">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="5714117">+</span>&nbsp;<span class="ident" id="5714119">name</span><span class="op" id="5714123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714129">drivers</span><span class="op" id="5714136">[</span><span class="ident" id="5714137">name</span><span class="op" id="5714141">]</span>&nbsp;<span class="op" id="5714143">=</span>&nbsp;<span class="ident" id="5714145">driver</span><br>
<span class="lineno"></span><span class="op" id="5714152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5714155">func</span>&nbsp;<span class="ident" id="5714160">unregisterAllDrivers</span><span class="op" id="5714180">(</span><span class="op" id="5714181">)</span>&nbsp;<span class="op" id="5714183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5714186">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714201">drivers</span>&nbsp;<span class="op" id="5714209">=</span>&nbsp;<span class="builtinfunc" id="5714211">make</span><span class="op" id="5714215">(</span><span class="keyword" id="5714216">map</span><span class="op" id="5714219">[</span><span class="builtintype" id="5714220">string</span><span class="op" id="5714226">]</span><span class="ident" id="5714227">driver</span><span class="op" id="5714233">.</span><span class="ident" id="5714234">Driver</span><span class="op" id="5714240">)</span><br>
<span class="lineno"></span><span class="op" id="5714242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5714245">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="5714318">func</span>&nbsp;<span class="ident" id="5714323">Drivers</span><span class="op" id="5714330">(</span><span class="op" id="5714331">)</span>&nbsp;<span class="op" id="5714333">[</span><span class="op" id="5714334">]</span><span class="builtintype" id="5714335">string</span>&nbsp;<span class="op" id="5714342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714345">var</span>&nbsp;<span class="ident" id="5714349">list</span>&nbsp;<span class="op" id="5714354">[</span><span class="op" id="5714355">]</span><span class="builtintype" id="5714356">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714364">for</span>&nbsp;<span class="ident" id="5714368">name</span>&nbsp;<span class="op" id="5714373">:=</span>&nbsp;<span class="keyword" id="5714376">range</span>&nbsp;<span class="ident" id="5714382">drivers</span>&nbsp;<span class="op" id="5714390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714394">list</span>&nbsp;<span class="op" id="5714399">=</span>&nbsp;<span class="builtinfunc" id="5714401">append</span><span class="op" id="5714407">(</span><span class="ident" id="5714408">list</span><span class="op" id="5714412">,</span>&nbsp;<span class="ident" id="5714414">name</span><span class="op" id="5714418">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5714421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5714424">sort</span><span class="op" id="5714428">.</span><span class="ident" id="5714429">Strings</span><span class="op" id="5714436">(</span><span class="ident" id="5714437">list</span><span class="op" id="5714441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5714444">return</span>&nbsp;<span class="ident" id="5714451">list</span><br>
<span class="lineno"></span><span class="op" id="5714456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5714459">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5714529">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="5714601">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5714655">type</span>&nbsp;<span class="ident" id="5714660">RawBytes</span>&nbsp;<span class="op" id="5714669">[</span><span class="op" id="5714670">]</span><span class="builtintype" id="5714671">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5714677">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5714729">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5714779">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="5714820">//</span><br>
<span class="lineno"></span><span class="comment" id="5714823">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="5714844">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="5714915">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5714923">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5714940">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="5714963">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="5714976">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5714997">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5715003">//</span><br>
<span class="lineno"></span><span class="keyword" id="5715006">type</span>&nbsp;<span class="ident" id="5715011">NullString</span>&nbsp;<span class="keyword" id="5715022">struct</span>&nbsp;<span class="op" id="5715029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715032">String</span>&nbsp;<span class="builtintype" id="5715039">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715047">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="5715054">bool</span>&nbsp;<span class="comment" id="5715059">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5715098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5715101">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5715143">func</span>&nbsp;<span class="op" id="5715148">(</span><span class="ident" id="5715149">ns</span>&nbsp;<span class="op" id="5715152">*</span><span class="ident" id="5715153">NullString</span><span class="op" id="5715163">)</span>&nbsp;<span class="ident" id="5715165">Scan</span><span class="op" id="5715169">(</span><span class="ident" id="5715170">value</span>&nbsp;<span class="keyword" id="5715176">interface</span><span class="op" id="5715185">{</span><span class="op" id="5715186">}</span><span class="op" id="5715187">)</span>&nbsp;<span class="builtintype" id="5715189">error</span>&nbsp;<span class="op" id="5715195">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715198">if</span>&nbsp;<span class="ident" id="5715201">value</span>&nbsp;<span class="op" id="5715207">==</span>&nbsp;<span class="ident" id="5715210">nil</span>&nbsp;<span class="op" id="5715214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715218">ns</span><span class="op" id="5715220">.</span><span class="ident" id="5715221">String</span><span class="op" id="5715227">,</span>&nbsp;<span class="ident" id="5715229">ns</span><span class="op" id="5715231">.</span><span class="ident" id="5715232">Valid</span>&nbsp;<span class="op" id="5715238">=</span>&nbsp;<span class="string" id="5715240">&#34;&#34;</span><span class="op" id="5715242">,</span>&nbsp;<span class="builtintype" id="5715244">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715252">return</span>&nbsp;<span class="ident" id="5715259">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5715264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715267">ns</span><span class="op" id="5715269">.</span><span class="ident" id="5715270">Valid</span>&nbsp;<span class="op" id="5715276">=</span>&nbsp;<span class="builtintype" id="5715278">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715284">return</span>&nbsp;<span class="ident" id="5715291">convertAssign</span><span class="op" id="5715304">(</span><span class="op" id="5715305">&amp;</span><span class="ident" id="5715306">ns</span><span class="op" id="5715308">.</span><span class="ident" id="5715309">String</span><span class="op" id="5715315">,</span>&nbsp;<span class="ident" id="5715317">value</span><span class="op" id="5715322">)</span><br>
<span class="lineno"></span><span class="op" id="5715324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5715327">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5715376">func</span>&nbsp;<span class="op" id="5715381">(</span><span class="ident" id="5715382">ns</span>&nbsp;<span class="ident" id="5715385">NullString</span><span class="op" id="5715395">)</span>&nbsp;<span class="ident" id="5715397">Value</span><span class="op" id="5715402">(</span><span class="op" id="5715403">)</span>&nbsp;<span class="op" id="5715405">(</span><span class="ident" id="5715406">driver</span><span class="op" id="5715412">.</span><span class="ident" id="5715413">Value</span><span class="op" id="5715418">,</span>&nbsp;<span class="builtintype" id="5715420">error</span><span class="op" id="5715425">)</span>&nbsp;<span class="op" id="5715427">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715430">if</span>&nbsp;<span class="op" id="5715433">!</span><span class="ident" id="5715434">ns</span><span class="op" id="5715436">.</span><span class="ident" id="5715437">Valid</span>&nbsp;<span class="op" id="5715443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715447">return</span>&nbsp;<span class="ident" id="5715454">nil</span><span class="op" id="5715457">,</span>&nbsp;<span class="ident" id="5715459">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5715464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715467">return</span>&nbsp;<span class="ident" id="5715474">ns</span><span class="op" id="5715476">.</span><span class="ident" id="5715477">String</span><span class="op" id="5715483">,</span>&nbsp;<span class="ident" id="5715485">nil</span><br>
<span class="lineno"></span><span class="op" id="5715489">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5715492">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5715543">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5715592">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5715656">type</span>&nbsp;<span class="ident" id="5715661">NullInt64</span>&nbsp;<span class="keyword" id="5715671">struct</span>&nbsp;<span class="op" id="5715678">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715681">Int64</span>&nbsp;<span class="ident" id="5715687">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715694">Valid</span>&nbsp;<span class="builtintype" id="5715700">bool</span>&nbsp;<span class="comment" id="5715705">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5715743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5715746">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="5715788">func</span>&nbsp;<span class="op" id="5715793">(</span><span class="ident" id="5715794">n</span>&nbsp;<span class="op" id="5715796">*</span><span class="ident" id="5715797">NullInt64</span><span class="op" id="5715806">)</span>&nbsp;<span class="ident" id="5715808">Scan</span><span class="op" id="5715812">(</span><span class="ident" id="5715813">value</span>&nbsp;<span class="keyword" id="5715819">interface</span><span class="op" id="5715828">{</span><span class="op" id="5715829">}</span><span class="op" id="5715830">)</span>&nbsp;<span class="builtintype" id="5715832">error</span>&nbsp;<span class="op" id="5715838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715841">if</span>&nbsp;<span class="ident" id="5715844">value</span>&nbsp;<span class="op" id="5715850">==</span>&nbsp;<span class="ident" id="5715853">nil</span>&nbsp;<span class="op" id="5715857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715861">n</span><span class="op" id="5715862">.</span><span class="ident" id="5715863">Int64</span><span class="op" id="5715868">,</span>&nbsp;<span class="ident" id="5715870">n</span><span class="op" id="5715871">.</span><span class="ident" id="5715872">Valid</span>&nbsp;<span class="op" id="5715878">=</span>&nbsp;<span class="num" id="5715880">0</span><span class="op" id="5715881">,</span>&nbsp;<span class="builtintype" id="5715883">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715891">return</span>&nbsp;<span class="ident" id="5715898">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5715903">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5715906">n</span><span class="op" id="5715907">.</span><span class="ident" id="5715908">Valid</span>&nbsp;<span class="op" id="5715914">=</span>&nbsp;<span class="builtintype" id="5715916">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5715922">return</span>&nbsp;<span class="ident" id="5715929">convertAssign</span><span class="op" id="5715942">(</span><span class="op" id="5715943">&amp;</span><span class="ident" id="5715944">n</span><span class="op" id="5715945">.</span><span class="ident" id="5715946">Int64</span><span class="op" id="5715951">,</span>&nbsp;<span class="ident" id="5715953">value</span><span class="op" id="5715958">)</span><br>
<span class="lineno"></span><span class="op" id="5715960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5715963">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="5716012">func</span>&nbsp;<span class="op" id="5716017">(</span><span class="ident" id="5716018">n</span>&nbsp;<span class="ident" id="5716020">NullInt64</span><span class="op" id="5716029">)</span>&nbsp;<span class="ident" id="5716031">Value</span><span class="op" id="5716036">(</span><span class="op" id="5716037">)</span>&nbsp;<span class="op" id="5716039">(</span><span class="ident" id="5716040">driver</span><span class="op" id="5716046">.</span><span class="ident" id="5716047">Value</span><span class="op" id="5716052">,</span>&nbsp;<span class="builtintype" id="5716054">error</span><span class="op" id="5716059">)</span>&nbsp;<span class="op" id="5716061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716064">if</span>&nbsp;<span class="op" id="5716067">!</span><span class="ident" id="5716068">n</span><span class="op" id="5716069">.</span><span class="ident" id="5716070">Valid</span>&nbsp;<span class="op" id="5716076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716080">return</span>&nbsp;<span class="ident" id="5716087">nil</span><span class="op" id="5716090">,</span>&nbsp;<span class="ident" id="5716092">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5716097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716100">return</span>&nbsp;<span class="ident" id="5716107">n</span><span class="op" id="5716108">.</span><span class="ident" id="5716109">Int64</span><span class="op" id="5716114">,</span>&nbsp;<span class="ident" id="5716116">nil</span><br>
<span class="lineno">120</span><span class="op" id="5716120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5716123">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5716177">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5716228">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="5716292">type</span>&nbsp;<span class="ident" id="5716297">NullFloat64</span>&nbsp;<span class="keyword" id="5716309">struct</span>&nbsp;<span class="op" id="5716316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716319">Float64</span>&nbsp;<span class="builtintype" id="5716327">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716336">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5716344">bool</span>&nbsp;<span class="comment" id="5716349">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5716389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5716392">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5716434">func</span>&nbsp;<span class="op" id="5716439">(</span><span class="ident" id="5716440">n</span>&nbsp;<span class="op" id="5716442">*</span><span class="ident" id="5716443">NullFloat64</span><span class="op" id="5716454">)</span>&nbsp;<span class="ident" id="5716456">Scan</span><span class="op" id="5716460">(</span><span class="ident" id="5716461">value</span>&nbsp;<span class="keyword" id="5716467">interface</span><span class="op" id="5716476">{</span><span class="op" id="5716477">}</span><span class="op" id="5716478">)</span>&nbsp;<span class="builtintype" id="5716480">error</span>&nbsp;<span class="op" id="5716486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716489">if</span>&nbsp;<span class="ident" id="5716492">value</span>&nbsp;<span class="op" id="5716498">==</span>&nbsp;<span class="ident" id="5716501">nil</span>&nbsp;<span class="op" id="5716505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716509">n</span><span class="op" id="5716510">.</span><span class="ident" id="5716511">Float64</span><span class="op" id="5716518">,</span>&nbsp;<span class="ident" id="5716520">n</span><span class="op" id="5716521">.</span><span class="ident" id="5716522">Valid</span>&nbsp;<span class="op" id="5716528">=</span>&nbsp;<span class="num" id="5716530">0</span><span class="op" id="5716531">,</span>&nbsp;<span class="builtintype" id="5716533">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716541">return</span>&nbsp;<span class="ident" id="5716548">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5716553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716556">n</span><span class="op" id="5716557">.</span><span class="ident" id="5716558">Valid</span>&nbsp;<span class="op" id="5716564">=</span>&nbsp;<span class="builtintype" id="5716566">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716572">return</span>&nbsp;<span class="ident" id="5716579">convertAssign</span><span class="op" id="5716592">(</span><span class="op" id="5716593">&amp;</span><span class="ident" id="5716594">n</span><span class="op" id="5716595">.</span><span class="ident" id="5716596">Float64</span><span class="op" id="5716603">,</span>&nbsp;<span class="ident" id="5716605">value</span><span class="op" id="5716610">)</span><br>
<span class="lineno"></span><span class="op" id="5716612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5716615">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5716664">func</span>&nbsp;<span class="op" id="5716669">(</span><span class="ident" id="5716670">n</span>&nbsp;<span class="ident" id="5716672">NullFloat64</span><span class="op" id="5716683">)</span>&nbsp;<span class="ident" id="5716685">Value</span><span class="op" id="5716690">(</span><span class="op" id="5716691">)</span>&nbsp;<span class="op" id="5716693">(</span><span class="ident" id="5716694">driver</span><span class="op" id="5716700">.</span><span class="ident" id="5716701">Value</span><span class="op" id="5716706">,</span>&nbsp;<span class="builtintype" id="5716708">error</span><span class="op" id="5716713">)</span>&nbsp;<span class="op" id="5716715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716718">if</span>&nbsp;<span class="op" id="5716721">!</span><span class="ident" id="5716722">n</span><span class="op" id="5716723">.</span><span class="ident" id="5716724">Valid</span>&nbsp;<span class="op" id="5716730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716734">return</span>&nbsp;<span class="ident" id="5716741">nil</span><span class="op" id="5716744">,</span>&nbsp;<span class="ident" id="5716746">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5716751">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5716754">return</span>&nbsp;<span class="ident" id="5716761">n</span><span class="op" id="5716762">.</span><span class="ident" id="5716763">Float64</span><span class="op" id="5716770">,</span>&nbsp;<span class="ident" id="5716772">nil</span><br>
<span class="lineno"></span><span class="op" id="5716776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5716779">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5716827">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="5716875">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5716939">type</span>&nbsp;<span class="ident" id="5716944">NullBool</span>&nbsp;<span class="keyword" id="5716953">struct</span>&nbsp;<span class="op" id="5716960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716963">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="5716969">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5716975">Valid</span>&nbsp;<span class="builtintype" id="5716981">bool</span>&nbsp;<span class="comment" id="5716986">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5717023">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5717026">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5717068">func</span>&nbsp;<span class="op" id="5717073">(</span><span class="ident" id="5717074">n</span>&nbsp;<span class="op" id="5717076">*</span><span class="ident" id="5717077">NullBool</span><span class="op" id="5717085">)</span>&nbsp;<span class="ident" id="5717087">Scan</span><span class="op" id="5717091">(</span><span class="ident" id="5717092">value</span>&nbsp;<span class="keyword" id="5717098">interface</span><span class="op" id="5717107">{</span><span class="op" id="5717108">}</span><span class="op" id="5717109">)</span>&nbsp;<span class="builtintype" id="5717111">error</span>&nbsp;<span class="op" id="5717117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717120">if</span>&nbsp;<span class="ident" id="5717123">value</span>&nbsp;<span class="op" id="5717129">==</span>&nbsp;<span class="ident" id="5717132">nil</span>&nbsp;<span class="op" id="5717136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717140">n</span><span class="op" id="5717141">.</span><span class="ident" id="5717142">Bool</span><span class="op" id="5717146">,</span>&nbsp;<span class="ident" id="5717148">n</span><span class="op" id="5717149">.</span><span class="ident" id="5717150">Valid</span>&nbsp;<span class="op" id="5717156">=</span>&nbsp;<span class="builtintype" id="5717158">false</span><span class="op" id="5717163">,</span>&nbsp;<span class="builtintype" id="5717165">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717173">return</span>&nbsp;<span class="ident" id="5717180">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5717185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717188">n</span><span class="op" id="5717189">.</span><span class="ident" id="5717190">Valid</span>&nbsp;<span class="op" id="5717196">=</span>&nbsp;<span class="builtintype" id="5717198">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717204">return</span>&nbsp;<span class="ident" id="5717211">convertAssign</span><span class="op" id="5717224">(</span><span class="op" id="5717225">&amp;</span><span class="ident" id="5717226">n</span><span class="op" id="5717227">.</span><span class="ident" id="5717228">Bool</span><span class="op" id="5717232">,</span>&nbsp;<span class="ident" id="5717234">value</span><span class="op" id="5717239">)</span><br>
<span class="lineno"></span><span class="op" id="5717241">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5717244">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5717293">func</span>&nbsp;<span class="op" id="5717298">(</span><span class="ident" id="5717299">n</span>&nbsp;<span class="ident" id="5717301">NullBool</span><span class="op" id="5717309">)</span>&nbsp;<span class="ident" id="5717311">Value</span><span class="op" id="5717316">(</span><span class="op" id="5717317">)</span>&nbsp;<span class="op" id="5717319">(</span><span class="ident" id="5717320">driver</span><span class="op" id="5717326">.</span><span class="ident" id="5717327">Value</span><span class="op" id="5717332">,</span>&nbsp;<span class="builtintype" id="5717334">error</span><span class="op" id="5717339">)</span>&nbsp;<span class="op" id="5717341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717344">if</span>&nbsp;<span class="op" id="5717347">!</span><span class="ident" id="5717348">n</span><span class="op" id="5717349">.</span><span class="ident" id="5717350">Valid</span>&nbsp;<span class="op" id="5717356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717360">return</span>&nbsp;<span class="ident" id="5717367">nil</span><span class="op" id="5717370">,</span>&nbsp;<span class="ident" id="5717372">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5717377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5717380">return</span>&nbsp;<span class="ident" id="5717387">n</span><span class="op" id="5717388">.</span><span class="ident" id="5717389">Bool</span><span class="op" id="5717393">,</span>&nbsp;<span class="ident" id="5717395">nil</span><br>
<span class="lineno"></span><span class="op" id="5717399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5717402">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="5717443">type</span>&nbsp;<span class="ident" id="5717448">Scanner</span>&nbsp;<span class="keyword" id="5717456">interface</span>&nbsp;<span class="op" id="5717466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717469">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717518">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717522">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717583">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717601">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717605">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717618">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717633">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717645">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717659">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717673">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717690">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717719">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717723">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5717786">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5717819">Scan</span><span class="op" id="5717823">(</span><span class="ident" id="5717824">src</span>&nbsp;<span class="keyword" id="5717828">interface</span><span class="op" id="5717837">{</span><span class="op" id="5717838">}</span><span class="op" id="5717839">)</span>&nbsp;<span class="builtintype" id="5717841">error</span><br>
<span class="lineno"></span><span class="op" id="5717847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5717850">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="5717914">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5717985">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="5718020">var</span>&nbsp;<span class="ident" id="5718024">ErrNoRows</span>&nbsp;<span class="op" id="5718034">=</span>&nbsp;<span class="ident" id="5718036">errors</span><span class="op" id="5718042">.</span><span class="ident" id="5718043">New</span><span class="op" id="5718046">(</span><span class="string" id="5718047">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="5718075">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5718078">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="5718141">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="5718209">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="5718224">//</span><br>
<span class="lineno"></span><span class="comment" id="5718227">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5718294">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="5718365">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="5718435">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5718498">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5718561">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5718622">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="5718692">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="5718735">type</span>&nbsp;<span class="ident" id="5718740">DB</span>&nbsp;<span class="keyword" id="5718743">struct</span>&nbsp;<span class="op" id="5718750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718753">driver</span>&nbsp;<span class="ident" id="5718760">driver</span><span class="op" id="5718766">.</span><span class="ident" id="5718767">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718775">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5718782">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718791">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718804">sync</span><span class="op" id="5718808">.</span><span class="ident" id="5718809">Mutex</span>&nbsp;<span class="comment" id="5718815">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718845">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5718858">[</span><span class="op" id="5718859">]</span><span class="op" id="5718860">*</span><span class="ident" id="5718861">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718873">connRequests</span>&nbsp;<span class="op" id="5718886">[</span><span class="op" id="5718887">]</span><span class="keyword" id="5718888">chan</span>&nbsp;<span class="ident" id="5718893">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718906">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5718919">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5718924">pendingOpens</span>&nbsp;<span class="builtintype" id="5718937">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5718942">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5718990">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5719056">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5719135">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5719208">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719231">openerCh</span>&nbsp;<span class="keyword" id="5719240">chan</span>&nbsp;<span class="keyword" id="5719245">struct</span><span class="op" id="5719251">{</span><span class="op" id="5719252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719255">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5719264">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719270">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5719279">map</span><span class="op" id="5719282">[</span><span class="ident" id="5719283">finalCloser</span><span class="op" id="5719294">]</span><span class="ident" id="5719295">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719303">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="5719312">map</span><span class="op" id="5719315">[</span><span class="op" id="5719316">*</span><span class="ident" id="5719317">driverConn</span><span class="op" id="5719327">]</span><span class="builtintype" id="5719328">string</span>&nbsp;<span class="comment" id="5719335">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719381">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="5719390">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5719413">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719466">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="5719475">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5719498">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="5719522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5719525">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5719576">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="5719645">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="5719710">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="5719727">type</span>&nbsp;<span class="ident" id="5719732">driverConn</span>&nbsp;<span class="keyword" id="5719743">struct</span>&nbsp;<span class="op" id="5719750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719753">db</span>&nbsp;<span class="op" id="5719756">*</span><span class="ident" id="5719757">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719762">sync</span><span class="op" id="5719766">.</span><span class="ident" id="5719767">Mutex</span>&nbsp;&nbsp;<span class="comment" id="5719774">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719795">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5719807">driver</span><span class="op" id="5719813">.</span><span class="ident" id="5719814">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719820">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5719832">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719838">finalClosed</span>&nbsp;<span class="builtintype" id="5719850">bool</span>&nbsp;<span class="comment" id="5719855">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719884">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5719896">map</span><span class="op" id="5719899">[</span><span class="ident" id="5719900">driver</span><span class="op" id="5719906">.</span><span class="ident" id="5719907">Stmt</span><span class="op" id="5719911">]</span><span class="builtintype" id="5719912">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5719919">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719940">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5719951">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719957">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5719968">[</span><span class="op" id="5719969">]</span><span class="keyword" id="5719970">func</span><span class="op" id="5719974">(</span><span class="op" id="5719975">)</span>&nbsp;<span class="comment" id="5719977">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720035">dbmuClosed</span>&nbsp;<span class="builtintype" id="5720046">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5720055">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="5720111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5720114">func</span>&nbsp;<span class="op" id="5720119">(</span><span class="ident" id="5720120">dc</span>&nbsp;<span class="op" id="5720123">*</span><span class="ident" id="5720124">driverConn</span><span class="op" id="5720134">)</span>&nbsp;<span class="ident" id="5720136">releaseConn</span><span class="op" id="5720147">(</span><span class="ident" id="5720148">err</span>&nbsp;<span class="builtintype" id="5720152">error</span><span class="op" id="5720157">)</span>&nbsp;<span class="op" id="5720159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720162">dc</span><span class="op" id="5720164">.</span><span class="ident" id="5720165">db</span><span class="op" id="5720167">.</span><span class="ident" id="5720168">putConn</span><span class="op" id="5720175">(</span><span class="ident" id="5720176">dc</span><span class="op" id="5720178">,</span>&nbsp;<span class="ident" id="5720180">err</span><span class="op" id="5720183">)</span><br>
<span class="lineno"></span><span class="op" id="5720185">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5720188">func</span>&nbsp;<span class="op" id="5720193">(</span><span class="ident" id="5720194">dc</span>&nbsp;<span class="op" id="5720197">*</span><span class="ident" id="5720198">driverConn</span><span class="op" id="5720208">)</span>&nbsp;<span class="ident" id="5720210">removeOpenStmt</span><span class="op" id="5720224">(</span><span class="ident" id="5720225">si</span>&nbsp;<span class="ident" id="5720228">driver</span><span class="op" id="5720234">.</span><span class="ident" id="5720235">Stmt</span><span class="op" id="5720239">)</span>&nbsp;<span class="op" id="5720241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720244">dc</span><span class="op" id="5720246">.</span><span class="ident" id="5720247">Lock</span><span class="op" id="5720251">(</span><span class="op" id="5720252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720255">defer</span>&nbsp;<span class="ident" id="5720261">dc</span><span class="op" id="5720263">.</span><span class="ident" id="5720264">Unlock</span><span class="op" id="5720270">(</span><span class="op" id="5720271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5720274">delete</span><span class="op" id="5720280">(</span><span class="ident" id="5720281">dc</span><span class="op" id="5720283">.</span><span class="ident" id="5720284">openStmt</span><span class="op" id="5720292">,</span>&nbsp;<span class="ident" id="5720294">si</span><span class="op" id="5720296">)</span><br>
<span class="lineno">260</span><span class="op" id="5720298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5720301">func</span>&nbsp;<span class="op" id="5720306">(</span><span class="ident" id="5720307">dc</span>&nbsp;<span class="op" id="5720310">*</span><span class="ident" id="5720311">driverConn</span><span class="op" id="5720321">)</span>&nbsp;<span class="ident" id="5720323">prepareLocked</span><span class="op" id="5720336">(</span><span class="ident" id="5720337">query</span>&nbsp;<span class="builtintype" id="5720343">string</span><span class="op" id="5720349">)</span>&nbsp;<span class="op" id="5720351">(</span><span class="ident" id="5720352">driver</span><span class="op" id="5720358">.</span><span class="ident" id="5720359">Stmt</span><span class="op" id="5720363">,</span>&nbsp;<span class="builtintype" id="5720365">error</span><span class="op" id="5720370">)</span>&nbsp;<span class="op" id="5720372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720375">si</span><span class="op" id="5720377">,</span>&nbsp;<span class="ident" id="5720379">err</span>&nbsp;<span class="op" id="5720383">:=</span>&nbsp;<span class="ident" id="5720386">dc</span><span class="op" id="5720388">.</span><span class="ident" id="5720389">ci</span><span class="op" id="5720391">.</span><span class="ident" id="5720392">Prepare</span><span class="op" id="5720399">(</span><span class="ident" id="5720400">query</span><span class="op" id="5720405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720408">if</span>&nbsp;<span class="ident" id="5720411">err</span>&nbsp;<span class="op" id="5720415">==</span>&nbsp;<span class="ident" id="5720418">nil</span>&nbsp;<span class="op" id="5720422">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720426">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720493">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720523">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720528">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720585">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720648">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720705">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720710">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720766">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720815">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720860">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720904">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5720953">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5720999">if</span>&nbsp;<span class="ident" id="5721002">dc</span><span class="op" id="5721004">.</span><span class="ident" id="5721005">openStmt</span>&nbsp;<span class="op" id="5721014">==</span>&nbsp;<span class="ident" id="5721017">nil</span>&nbsp;<span class="op" id="5721021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721026">dc</span><span class="op" id="5721028">.</span><span class="ident" id="5721029">openStmt</span>&nbsp;<span class="op" id="5721038">=</span>&nbsp;<span class="builtinfunc" id="5721040">make</span><span class="op" id="5721044">(</span><span class="keyword" id="5721045">map</span><span class="op" id="5721048">[</span><span class="ident" id="5721049">driver</span><span class="op" id="5721055">.</span><span class="ident" id="5721056">Stmt</span><span class="op" id="5721060">]</span><span class="builtintype" id="5721061">bool</span><span class="op" id="5721065">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721073">dc</span><span class="op" id="5721075">.</span><span class="ident" id="5721076">openStmt</span><span class="op" id="5721084">[</span><span class="ident" id="5721085">si</span><span class="op" id="5721087">]</span>&nbsp;<span class="op" id="5721089">=</span>&nbsp;<span class="builtintype" id="5721091">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721100">return</span>&nbsp;<span class="ident" id="5721107">si</span><span class="op" id="5721109">,</span>&nbsp;<span class="ident" id="5721111">err</span><br>
<span class="lineno"></span><span class="op" id="5721115">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="5721118">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5721148">func</span>&nbsp;<span class="op" id="5721153">(</span><span class="ident" id="5721154">dc</span>&nbsp;<span class="op" id="5721157">*</span><span class="ident" id="5721158">driverConn</span><span class="op" id="5721168">)</span>&nbsp;<span class="ident" id="5721170">closeDBLocked</span><span class="op" id="5721183">(</span><span class="op" id="5721184">)</span>&nbsp;<span class="keyword" id="5721186">func</span><span class="op" id="5721190">(</span><span class="op" id="5721191">)</span>&nbsp;<span class="builtintype" id="5721193">error</span>&nbsp;<span class="op" id="5721199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721202">dc</span><span class="op" id="5721204">.</span><span class="ident" id="5721205">Lock</span><span class="op" id="5721209">(</span><span class="op" id="5721210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721213">defer</span>&nbsp;<span class="ident" id="5721219">dc</span><span class="op" id="5721221">.</span><span class="ident" id="5721222">Unlock</span><span class="op" id="5721228">(</span><span class="op" id="5721229">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721232">if</span>&nbsp;<span class="ident" id="5721235">dc</span><span class="op" id="5721237">.</span><span class="ident" id="5721238">closed</span>&nbsp;<span class="op" id="5721245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721249">return</span>&nbsp;<span class="keyword" id="5721256">func</span><span class="op" id="5721260">(</span><span class="op" id="5721261">)</span>&nbsp;<span class="builtintype" id="5721263">error</span>&nbsp;<span class="op" id="5721269">{</span>&nbsp;<span class="keyword" id="5721271">return</span>&nbsp;<span class="ident" id="5721278">errors</span><span class="op" id="5721284">.</span><span class="ident" id="5721285">New</span><span class="op" id="5721288">(</span><span class="string" id="5721289">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5721322">)</span>&nbsp;<span class="op" id="5721324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721330">dc</span><span class="op" id="5721332">.</span><span class="ident" id="5721333">closed</span>&nbsp;<span class="op" id="5721340">=</span>&nbsp;<span class="builtintype" id="5721342">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721348">return</span>&nbsp;<span class="ident" id="5721355">dc</span><span class="op" id="5721357">.</span><span class="ident" id="5721358">db</span><span class="op" id="5721360">.</span><span class="ident" id="5721361">removeDepLocked</span><span class="op" id="5721376">(</span><span class="ident" id="5721377">dc</span><span class="op" id="5721379">,</span>&nbsp;<span class="ident" id="5721381">dc</span><span class="op" id="5721383">)</span><br>
<span class="lineno">295</span><span class="op" id="5721385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5721388">func</span>&nbsp;<span class="op" id="5721393">(</span><span class="ident" id="5721394">dc</span>&nbsp;<span class="op" id="5721397">*</span><span class="ident" id="5721398">driverConn</span><span class="op" id="5721408">)</span>&nbsp;<span class="ident" id="5721410">Close</span><span class="op" id="5721415">(</span><span class="op" id="5721416">)</span>&nbsp;<span class="builtintype" id="5721418">error</span>&nbsp;<span class="op" id="5721424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721427">dc</span><span class="op" id="5721429">.</span><span class="ident" id="5721430">Lock</span><span class="op" id="5721434">(</span><span class="op" id="5721435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721438">if</span>&nbsp;<span class="ident" id="5721441">dc</span><span class="op" id="5721443">.</span><span class="ident" id="5721444">closed</span>&nbsp;<span class="op" id="5721451">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721455">dc</span><span class="op" id="5721457">.</span><span class="ident" id="5721458">Unlock</span><span class="op" id="5721464">(</span><span class="op" id="5721465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721469">return</span>&nbsp;<span class="ident" id="5721476">errors</span><span class="op" id="5721482">.</span><span class="ident" id="5721483">New</span><span class="op" id="5721486">(</span><span class="string" id="5721487">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5721520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721526">dc</span><span class="op" id="5721528">.</span><span class="ident" id="5721529">closed</span>&nbsp;<span class="op" id="5721536">=</span>&nbsp;<span class="builtintype" id="5721538">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721544">dc</span><span class="op" id="5721546">.</span><span class="ident" id="5721547">Unlock</span><span class="op" id="5721553">(</span><span class="op" id="5721554">)</span>&nbsp;<span class="comment" id="5721556">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5721616">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721669">dc</span><span class="op" id="5721671">.</span><span class="ident" id="5721672">db</span><span class="op" id="5721674">.</span><span class="ident" id="5721675">mu</span><span class="op" id="5721677">.</span><span class="ident" id="5721678">Lock</span><span class="op" id="5721682">(</span><span class="op" id="5721683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721686">dc</span><span class="op" id="5721688">.</span><span class="ident" id="5721689">dbmuClosed</span>&nbsp;<span class="op" id="5721700">=</span>&nbsp;<span class="builtintype" id="5721702">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721708">fn</span>&nbsp;<span class="op" id="5721711">:=</span>&nbsp;<span class="ident" id="5721714">dc</span><span class="op" id="5721716">.</span><span class="ident" id="5721717">db</span><span class="op" id="5721719">.</span><span class="ident" id="5721720">removeDepLocked</span><span class="op" id="5721735">(</span><span class="ident" id="5721736">dc</span><span class="op" id="5721738">,</span>&nbsp;<span class="ident" id="5721740">dc</span><span class="op" id="5721742">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721745">dc</span><span class="op" id="5721747">.</span><span class="ident" id="5721748">db</span><span class="op" id="5721750">.</span><span class="ident" id="5721751">mu</span><span class="op" id="5721753">.</span><span class="ident" id="5721754">Unlock</span><span class="op" id="5721760">(</span><span class="op" id="5721761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721764">return</span>&nbsp;<span class="ident" id="5721771">fn</span><span class="op" id="5721773">(</span><span class="op" id="5721774">)</span><br>
<span class="lineno"></span><span class="op" id="5721776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5721779">func</span>&nbsp;<span class="op" id="5721784">(</span><span class="ident" id="5721785">dc</span>&nbsp;<span class="op" id="5721788">*</span><span class="ident" id="5721789">driverConn</span><span class="op" id="5721799">)</span>&nbsp;<span class="ident" id="5721801">finalClose</span><span class="op" id="5721811">(</span><span class="op" id="5721812">)</span>&nbsp;<span class="builtintype" id="5721814">error</span>&nbsp;<span class="op" id="5721820">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721823">dc</span><span class="op" id="5721825">.</span><span class="ident" id="5721826">Lock</span><span class="op" id="5721830">(</span><span class="op" id="5721831">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721835">for</span>&nbsp;<span class="ident" id="5721839">si</span>&nbsp;<span class="op" id="5721842">:=</span>&nbsp;<span class="keyword" id="5721845">range</span>&nbsp;<span class="ident" id="5721851">dc</span><span class="op" id="5721853">.</span><span class="ident" id="5721854">openStmt</span>&nbsp;<span class="op" id="5721863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721867">si</span><span class="op" id="5721869">.</span><span class="ident" id="5721870">Close</span><span class="op" id="5721875">(</span><span class="op" id="5721876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721879">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721882">dc</span><span class="op" id="5721884">.</span><span class="ident" id="5721885">openStmt</span>&nbsp;<span class="op" id="5721894">=</span>&nbsp;<span class="ident" id="5721896">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721902">err</span>&nbsp;<span class="op" id="5721906">:=</span>&nbsp;<span class="ident" id="5721909">dc</span><span class="op" id="5721911">.</span><span class="ident" id="5721912">ci</span><span class="op" id="5721914">.</span><span class="ident" id="5721915">Close</span><span class="op" id="5721920">(</span><span class="op" id="5721921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721924">dc</span><span class="op" id="5721926">.</span><span class="ident" id="5721927">ci</span>&nbsp;<span class="op" id="5721930">=</span>&nbsp;<span class="ident" id="5721932">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721937">dc</span><span class="op" id="5721939">.</span><span class="ident" id="5721940">finalClosed</span>&nbsp;<span class="op" id="5721952">=</span>&nbsp;<span class="builtintype" id="5721954">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721960">dc</span><span class="op" id="5721962">.</span><span class="ident" id="5721963">Unlock</span><span class="op" id="5721969">(</span><span class="op" id="5721970">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721974">dc</span><span class="op" id="5721976">.</span><span class="ident" id="5721977">db</span><span class="op" id="5721979">.</span><span class="ident" id="5721980">mu</span><span class="op" id="5721982">.</span><span class="ident" id="5721983">Lock</span><span class="op" id="5721987">(</span><span class="op" id="5721988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721991">dc</span><span class="op" id="5721993">.</span><span class="ident" id="5721994">db</span><span class="op" id="5721996">.</span><span class="ident" id="5721997">numOpen</span><span class="op" id="5722004">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722008">dc</span><span class="op" id="5722010">.</span><span class="ident" id="5722011">db</span><span class="op" id="5722013">.</span><span class="ident" id="5722014">maybeOpenNewConnections</span><span class="op" id="5722037">(</span><span class="op" id="5722038">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722041">dc</span><span class="op" id="5722043">.</span><span class="ident" id="5722044">db</span><span class="op" id="5722046">.</span><span class="ident" id="5722047">mu</span><span class="op" id="5722049">.</span><span class="ident" id="5722050">Unlock</span><span class="op" id="5722056">(</span><span class="op" id="5722057">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722061">return</span>&nbsp;<span class="ident" id="5722068">err</span><br>
<span class="lineno"></span><span class="op" id="5722072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="5722075">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5722123">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5722190">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="5722212">type</span>&nbsp;<span class="ident" id="5722217">driverStmt</span>&nbsp;<span class="keyword" id="5722228">struct</span>&nbsp;<span class="op" id="5722235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722238">sync</span><span class="op" id="5722242">.</span><span class="ident" id="5722243">Locker</span>&nbsp;<span class="comment" id="5722250">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722270">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5722282">driver</span><span class="op" id="5722288">.</span><span class="ident" id="5722289">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5722294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5722297">func</span>&nbsp;<span class="op" id="5722302">(</span><span class="ident" id="5722303">ds</span>&nbsp;<span class="op" id="5722306">*</span><span class="ident" id="5722307">driverStmt</span><span class="op" id="5722317">)</span>&nbsp;<span class="ident" id="5722319">Close</span><span class="op" id="5722324">(</span><span class="op" id="5722325">)</span>&nbsp;<span class="builtintype" id="5722327">error</span>&nbsp;<span class="op" id="5722333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722336">ds</span><span class="op" id="5722338">.</span><span class="ident" id="5722339">Lock</span><span class="op" id="5722343">(</span><span class="op" id="5722344">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722347">defer</span>&nbsp;<span class="ident" id="5722353">ds</span><span class="op" id="5722355">.</span><span class="ident" id="5722356">Unlock</span><span class="op" id="5722362">(</span><span class="op" id="5722363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722366">return</span>&nbsp;<span class="ident" id="5722373">ds</span><span class="op" id="5722375">.</span><span class="ident" id="5722376">si</span><span class="op" id="5722378">.</span><span class="ident" id="5722379">Close</span><span class="op" id="5722384">(</span><span class="op" id="5722385">)</span><br>
<span class="lineno"></span><span class="op" id="5722387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5722390">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="5722444">type</span>&nbsp;<span class="ident" id="5722449">depSet</span>&nbsp;<span class="keyword" id="5722456">map</span><span class="op" id="5722459">[</span><span class="keyword" id="5722460">interface</span><span class="op" id="5722469">{</span><span class="op" id="5722470">}</span><span class="op" id="5722471">]</span><span class="builtintype" id="5722472">bool</span>&nbsp;<span class="comment" id="5722477">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5722499">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="5722564">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="5722598">type</span>&nbsp;<span class="ident" id="5722603">finalCloser</span>&nbsp;<span class="keyword" id="5722615">interface</span>&nbsp;<span class="op" id="5722625">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722628">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722691">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722748">finalClose</span><span class="op" id="5722758">(</span><span class="op" id="5722759">)</span>&nbsp;<span class="builtintype" id="5722761">error</span><br>
<span class="lineno"></span><span class="op" id="5722767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="5722770">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5722841">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="5722909">func</span>&nbsp;<span class="op" id="5722914">(</span><span class="ident" id="5722915">db</span>&nbsp;<span class="op" id="5722918">*</span><span class="ident" id="5722919">DB</span><span class="op" id="5722921">)</span>&nbsp;<span class="ident" id="5722923">addDep</span><span class="op" id="5722929">(</span><span class="ident" id="5722930">x</span>&nbsp;<span class="ident" id="5722932">finalCloser</span><span class="op" id="5722943">,</span>&nbsp;<span class="ident" id="5722945">dep</span>&nbsp;<span class="keyword" id="5722949">interface</span><span class="op" id="5722958">{</span><span class="op" id="5722959">}</span><span class="op" id="5722960">)</span>&nbsp;<span class="op" id="5722962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722965">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723029">db</span><span class="op" id="5723031">.</span><span class="ident" id="5723032">mu</span><span class="op" id="5723034">.</span><span class="ident" id="5723035">Lock</span><span class="op" id="5723039">(</span><span class="op" id="5723040">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723043">defer</span>&nbsp;<span class="ident" id="5723049">db</span><span class="op" id="5723051">.</span><span class="ident" id="5723052">mu</span><span class="op" id="5723054">.</span><span class="ident" id="5723055">Unlock</span><span class="op" id="5723061">(</span><span class="op" id="5723062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723065">db</span><span class="op" id="5723067">.</span><span class="ident" id="5723068">addDepLocked</span><span class="op" id="5723080">(</span><span class="ident" id="5723081">x</span><span class="op" id="5723082">,</span>&nbsp;<span class="ident" id="5723084">dep</span><span class="op" id="5723087">)</span><br>
<span class="lineno"></span><span class="op" id="5723089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5723092">func</span>&nbsp;<span class="op" id="5723097">(</span><span class="ident" id="5723098">db</span>&nbsp;<span class="op" id="5723101">*</span><span class="ident" id="5723102">DB</span><span class="op" id="5723104">)</span>&nbsp;<span class="ident" id="5723106">addDepLocked</span><span class="op" id="5723118">(</span><span class="ident" id="5723119">x</span>&nbsp;<span class="ident" id="5723121">finalCloser</span><span class="op" id="5723132">,</span>&nbsp;<span class="ident" id="5723134">dep</span>&nbsp;<span class="keyword" id="5723138">interface</span><span class="op" id="5723147">{</span><span class="op" id="5723148">}</span><span class="op" id="5723149">)</span>&nbsp;<span class="op" id="5723151">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723154">if</span>&nbsp;<span class="ident" id="5723157">db</span><span class="op" id="5723159">.</span><span class="ident" id="5723160">dep</span>&nbsp;<span class="op" id="5723164">==</span>&nbsp;<span class="ident" id="5723167">nil</span>&nbsp;<span class="op" id="5723171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723175">db</span><span class="op" id="5723177">.</span><span class="ident" id="5723178">dep</span>&nbsp;<span class="op" id="5723182">=</span>&nbsp;<span class="builtinfunc" id="5723184">make</span><span class="op" id="5723188">(</span><span class="keyword" id="5723189">map</span><span class="op" id="5723192">[</span><span class="ident" id="5723193">finalCloser</span><span class="op" id="5723204">]</span><span class="ident" id="5723205">depSet</span><span class="op" id="5723211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723217">xdep</span>&nbsp;<span class="op" id="5723222">:=</span>&nbsp;<span class="ident" id="5723225">db</span><span class="op" id="5723227">.</span><span class="ident" id="5723228">dep</span><span class="op" id="5723231">[</span><span class="ident" id="5723232">x</span><span class="op" id="5723233">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723236">if</span>&nbsp;<span class="ident" id="5723239">xdep</span>&nbsp;<span class="op" id="5723244">==</span>&nbsp;<span class="ident" id="5723247">nil</span>&nbsp;<span class="op" id="5723251">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723255">xdep</span>&nbsp;<span class="op" id="5723260">=</span>&nbsp;<span class="builtinfunc" id="5723262">make</span><span class="op" id="5723266">(</span><span class="ident" id="5723267">depSet</span><span class="op" id="5723273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723277">db</span><span class="op" id="5723279">.</span><span class="ident" id="5723280">dep</span><span class="op" id="5723283">[</span><span class="ident" id="5723284">x</span><span class="op" id="5723285">]</span>&nbsp;<span class="op" id="5723287">=</span>&nbsp;<span class="ident" id="5723289">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723298">xdep</span><span class="op" id="5723302">[</span><span class="ident" id="5723303">dep</span><span class="op" id="5723306">]</span>&nbsp;<span class="op" id="5723308">=</span>&nbsp;<span class="builtintype" id="5723310">true</span><br>
<span class="lineno"></span><span class="op" id="5723315">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5723318">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="5723370">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5723419">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5723489">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="5723537">func</span>&nbsp;<span class="op" id="5723542">(</span><span class="ident" id="5723543">db</span>&nbsp;<span class="op" id="5723546">*</span><span class="ident" id="5723547">DB</span><span class="op" id="5723549">)</span>&nbsp;<span class="ident" id="5723551">removeDep</span><span class="op" id="5723560">(</span><span class="ident" id="5723561">x</span>&nbsp;<span class="ident" id="5723563">finalCloser</span><span class="op" id="5723574">,</span>&nbsp;<span class="ident" id="5723576">dep</span>&nbsp;<span class="keyword" id="5723580">interface</span><span class="op" id="5723589">{</span><span class="op" id="5723590">}</span><span class="op" id="5723591">)</span>&nbsp;<span class="builtintype" id="5723593">error</span>&nbsp;<span class="op" id="5723599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723602">db</span><span class="op" id="5723604">.</span><span class="ident" id="5723605">mu</span><span class="op" id="5723607">.</span><span class="ident" id="5723608">Lock</span><span class="op" id="5723612">(</span><span class="op" id="5723613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723616">fn</span>&nbsp;<span class="op" id="5723619">:=</span>&nbsp;<span class="ident" id="5723622">db</span><span class="op" id="5723624">.</span><span class="ident" id="5723625">removeDepLocked</span><span class="op" id="5723640">(</span><span class="ident" id="5723641">x</span><span class="op" id="5723642">,</span>&nbsp;<span class="ident" id="5723644">dep</span><span class="op" id="5723647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723650">db</span><span class="op" id="5723652">.</span><span class="ident" id="5723653">mu</span><span class="op" id="5723655">.</span><span class="ident" id="5723656">Unlock</span><span class="op" id="5723662">(</span><span class="op" id="5723663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723666">return</span>&nbsp;<span class="ident" id="5723673">fn</span><span class="op" id="5723675">(</span><span class="op" id="5723676">)</span><br>
<span class="lineno">390</span><span class="op" id="5723678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5723681">func</span>&nbsp;<span class="op" id="5723686">(</span><span class="ident" id="5723687">db</span>&nbsp;<span class="op" id="5723690">*</span><span class="ident" id="5723691">DB</span><span class="op" id="5723693">)</span>&nbsp;<span class="ident" id="5723695">removeDepLocked</span><span class="op" id="5723710">(</span><span class="ident" id="5723711">x</span>&nbsp;<span class="ident" id="5723713">finalCloser</span><span class="op" id="5723724">,</span>&nbsp;<span class="ident" id="5723726">dep</span>&nbsp;<span class="keyword" id="5723730">interface</span><span class="op" id="5723739">{</span><span class="op" id="5723740">}</span><span class="op" id="5723741">)</span>&nbsp;<span class="keyword" id="5723743">func</span><span class="op" id="5723747">(</span><span class="op" id="5723748">)</span>&nbsp;<span class="builtintype" id="5723750">error</span>&nbsp;<span class="op" id="5723756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5723759">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723827">xdep</span><span class="op" id="5723831">,</span>&nbsp;<span class="ident" id="5723833">ok</span>&nbsp;<span class="op" id="5723836">:=</span>&nbsp;<span class="ident" id="5723839">db</span><span class="op" id="5723841">.</span><span class="ident" id="5723842">dep</span><span class="op" id="5723845">[</span><span class="ident" id="5723846">x</span><span class="op" id="5723847">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723850">if</span>&nbsp;<span class="op" id="5723853">!</span><span class="ident" id="5723854">ok</span>&nbsp;<span class="op" id="5723857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5723861">panic</span><span class="op" id="5723866">(</span><span class="ident" id="5723867">fmt</span><span class="op" id="5723870">.</span><span class="ident" id="5723871">Sprintf</span><span class="op" id="5723878">(</span><span class="string" id="5723879">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="5723915">,</span>&nbsp;<span class="ident" id="5723917">x</span><span class="op" id="5723918">)</span><span class="op" id="5723919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723926">l0</span>&nbsp;<span class="op" id="5723929">:=</span>&nbsp;<span class="builtinfunc" id="5723932">len</span><span class="op" id="5723935">(</span><span class="ident" id="5723936">xdep</span><span class="op" id="5723940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5723943">delete</span><span class="op" id="5723949">(</span><span class="ident" id="5723950">xdep</span><span class="op" id="5723954">,</span>&nbsp;<span class="ident" id="5723956">dep</span><span class="op" id="5723959">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723963">switch</span>&nbsp;<span class="builtinfunc" id="5723970">len</span><span class="op" id="5723973">(</span><span class="ident" id="5723974">xdep</span><span class="op" id="5723978">)</span>&nbsp;<span class="op" id="5723980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723983">case</span>&nbsp;<span class="ident" id="5723988">l0</span><span class="op" id="5723990">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5723994">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5724034">panic</span><span class="op" id="5724039">(</span><span class="ident" id="5724040">fmt</span><span class="op" id="5724043">.</span><span class="ident" id="5724044">Sprintf</span><span class="op" id="5724051">(</span><span class="string" id="5724052">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="5724089">,</span>&nbsp;<span class="ident" id="5724091">dep</span><span class="op" id="5724094">,</span>&nbsp;<span class="ident" id="5724096">x</span><span class="op" id="5724097">)</span><span class="op" id="5724098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724101">case</span>&nbsp;<span class="num" id="5724106">0</span><span class="op" id="5724107">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724111">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5724138">delete</span><span class="op" id="5724144">(</span><span class="ident" id="5724145">db</span><span class="op" id="5724147">.</span><span class="ident" id="5724148">dep</span><span class="op" id="5724151">,</span>&nbsp;<span class="ident" id="5724153">x</span><span class="op" id="5724154">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724158">return</span>&nbsp;<span class="ident" id="5724165">x</span><span class="op" id="5724166">.</span><span class="ident" id="5724167">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724179">default</span><span class="op" id="5724186">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724190">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724216">return</span>&nbsp;<span class="keyword" id="5724223">func</span><span class="op" id="5724227">(</span><span class="op" id="5724228">)</span>&nbsp;<span class="builtintype" id="5724230">error</span>&nbsp;<span class="op" id="5724236">{</span>&nbsp;<span class="keyword" id="5724238">return</span>&nbsp;<span class="ident" id="5724245">nil</span>&nbsp;<span class="op" id="5724249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5724252">}</span><br>
<span class="lineno">415</span><span class="op" id="5724254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5724257">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="5724329">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5724391">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="5724455">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="5724532">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="5724608">var</span>&nbsp;<span class="ident" id="5724612">connectionRequestQueueSize</span>&nbsp;<span class="op" id="5724639">=</span>&nbsp;<span class="num" id="5724641">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5724650">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="5724719">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5724789">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="5724834">//</span><br>
<span class="lineno"></span><span class="comment" id="5724837">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5724905">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="5724977">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5725047">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="5725081">//</span><br>
<span class="lineno"></span><span class="comment" id="5725084">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5725154">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="5725225">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="5725234">//</span><br>
<span class="lineno"></span><span class="comment" id="5725237">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5725306">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="5725372">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="5725438">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="5725453">func</span>&nbsp;<span class="ident" id="5725458">Open</span><span class="op" id="5725462">(</span><span class="ident" id="5725463">driverName</span><span class="op" id="5725473">,</span>&nbsp;<span class="ident" id="5725475">dataSourceName</span>&nbsp;<span class="builtintype" id="5725490">string</span><span class="op" id="5725496">)</span>&nbsp;<span class="op" id="5725498">(</span><span class="op" id="5725499">*</span><span class="ident" id="5725500">DB</span><span class="op" id="5725502">,</span>&nbsp;<span class="builtintype" id="5725504">error</span><span class="op" id="5725509">)</span>&nbsp;<span class="op" id="5725511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725514">driveri</span><span class="op" id="5725521">,</span>&nbsp;<span class="ident" id="5725523">ok</span>&nbsp;<span class="op" id="5725526">:=</span>&nbsp;<span class="ident" id="5725529">drivers</span><span class="op" id="5725536">[</span><span class="ident" id="5725537">driverName</span><span class="op" id="5725547">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5725550">if</span>&nbsp;<span class="op" id="5725553">!</span><span class="ident" id="5725554">ok</span>&nbsp;<span class="op" id="5725557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5725561">return</span>&nbsp;<span class="ident" id="5725568">nil</span><span class="op" id="5725571">,</span>&nbsp;<span class="ident" id="5725573">fmt</span><span class="op" id="5725576">.</span><span class="ident" id="5725577">Errorf</span><span class="op" id="5725583">(</span><span class="string" id="5725584">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="5725628">,</span>&nbsp;<span class="ident" id="5725630">driverName</span><span class="op" id="5725640">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5725643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725646">db</span>&nbsp;<span class="op" id="5725649">:=</span>&nbsp;<span class="op" id="5725652">&amp;</span><span class="ident" id="5725653">DB</span><span class="op" id="5725655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725659">driver</span><span class="op" id="5725665">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5725669">driveri</span><span class="op" id="5725676">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725680">dsn</span><span class="op" id="5725683">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5725690">dataSourceName</span><span class="op" id="5725704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725708">openerCh</span><span class="op" id="5725716">:</span>&nbsp;<span class="builtinfunc" id="5725718">make</span><span class="op" id="5725722">(</span><span class="keyword" id="5725723">chan</span>&nbsp;<span class="keyword" id="5725728">struct</span><span class="op" id="5725734">{</span><span class="op" id="5725735">}</span><span class="op" id="5725736">,</span>&nbsp;<span class="ident" id="5725738">connectionRequestQueueSize</span><span class="op" id="5725764">)</span><span class="op" id="5725765">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5725769">lastPut</span><span class="op" id="5725776">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5725779">make</span><span class="op" id="5725783">(</span><span class="keyword" id="5725784">map</span><span class="op" id="5725787">[</span><span class="op" id="5725788">*</span><span class="ident" id="5725789">driverConn</span><span class="op" id="5725799">]</span><span class="builtintype" id="5725800">string</span><span class="op" id="5725806">)</span><span class="op" id="5725807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5725810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5725813">go</span>&nbsp;<span class="ident" id="5725816">db</span><span class="op" id="5725818">.</span><span class="ident" id="5725819">connectionOpener</span><span class="op" id="5725835">(</span><span class="op" id="5725836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5725839">return</span>&nbsp;<span class="ident" id="5725846">db</span><span class="op" id="5725848">,</span>&nbsp;<span class="ident" id="5725850">nil</span><br>
<span class="lineno"></span><span class="op" id="5725854">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5725857">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="5725919">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5725962">func</span>&nbsp;<span class="op" id="5725967">(</span><span class="ident" id="5725968">db</span>&nbsp;<span class="op" id="5725971">*</span><span class="ident" id="5725972">DB</span><span class="op" id="5725974">)</span>&nbsp;<span class="ident" id="5725976">Ping</span><span class="op" id="5725980">(</span><span class="op" id="5725981">)</span>&nbsp;<span class="builtintype" id="5725983">error</span>&nbsp;<span class="op" id="5725989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5725992">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5726055">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5726114">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726128">dc</span><span class="op" id="5726130">,</span>&nbsp;<span class="ident" id="5726132">err</span>&nbsp;<span class="op" id="5726136">:=</span>&nbsp;<span class="ident" id="5726139">db</span><span class="op" id="5726141">.</span><span class="ident" id="5726142">conn</span><span class="op" id="5726146">(</span><span class="op" id="5726147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726150">if</span>&nbsp;<span class="ident" id="5726153">err</span>&nbsp;<span class="op" id="5726157">!=</span>&nbsp;<span class="ident" id="5726160">nil</span>&nbsp;<span class="op" id="5726164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726168">return</span>&nbsp;<span class="ident" id="5726175">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726183">db</span><span class="op" id="5726185">.</span><span class="ident" id="5726186">putConn</span><span class="op" id="5726193">(</span><span class="ident" id="5726194">dc</span><span class="op" id="5726196">,</span>&nbsp;<span class="ident" id="5726198">nil</span><span class="op" id="5726201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726204">return</span>&nbsp;<span class="ident" id="5726211">nil</span><br>
<span class="lineno"></span><span class="op" id="5726215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="5726218">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="5726278">//</span><br>
<span class="lineno"></span><span class="comment" id="5726281">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5726342">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5726392">func</span>&nbsp;<span class="op" id="5726397">(</span><span class="ident" id="5726398">db</span>&nbsp;<span class="op" id="5726401">*</span><span class="ident" id="5726402">DB</span><span class="op" id="5726404">)</span>&nbsp;<span class="ident" id="5726406">Close</span><span class="op" id="5726411">(</span><span class="op" id="5726412">)</span>&nbsp;<span class="builtintype" id="5726414">error</span>&nbsp;<span class="op" id="5726420">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726423">db</span><span class="op" id="5726425">.</span><span class="ident" id="5726426">mu</span><span class="op" id="5726428">.</span><span class="ident" id="5726429">Lock</span><span class="op" id="5726433">(</span><span class="op" id="5726434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726437">if</span>&nbsp;<span class="ident" id="5726440">db</span><span class="op" id="5726442">.</span><span class="ident" id="5726443">closed</span>&nbsp;<span class="op" id="5726450">{</span>&nbsp;<span class="comment" id="5726452">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726482">db</span><span class="op" id="5726484">.</span><span class="ident" id="5726485">mu</span><span class="op" id="5726487">.</span><span class="ident" id="5726488">Unlock</span><span class="op" id="5726494">(</span><span class="op" id="5726495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726499">return</span>&nbsp;<span class="ident" id="5726506">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726511">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5726514">close</span><span class="op" id="5726519">(</span><span class="ident" id="5726520">db</span><span class="op" id="5726522">.</span><span class="ident" id="5726523">openerCh</span><span class="op" id="5726531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726534">var</span>&nbsp;<span class="ident" id="5726538">err</span>&nbsp;<span class="builtintype" id="5726542">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726549">fns</span>&nbsp;<span class="op" id="5726553">:=</span>&nbsp;<span class="builtinfunc" id="5726556">make</span><span class="op" id="5726560">(</span><span class="op" id="5726561">[</span><span class="op" id="5726562">]</span><span class="keyword" id="5726563">func</span><span class="op" id="5726567">(</span><span class="op" id="5726568">)</span>&nbsp;<span class="builtintype" id="5726570">error</span><span class="op" id="5726575">,</span>&nbsp;<span class="num" id="5726577">0</span><span class="op" id="5726578">,</span>&nbsp;<span class="builtinfunc" id="5726580">len</span><span class="op" id="5726583">(</span><span class="ident" id="5726584">db</span><span class="op" id="5726586">.</span><span class="ident" id="5726587">freeConn</span><span class="op" id="5726595">)</span><span class="op" id="5726596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726599">for</span>&nbsp;<span class="ident" id="5726603">_</span><span class="op" id="5726604">,</span>&nbsp;<span class="ident" id="5726606">dc</span>&nbsp;<span class="op" id="5726609">:=</span>&nbsp;<span class="keyword" id="5726612">range</span>&nbsp;<span class="ident" id="5726618">db</span><span class="op" id="5726620">.</span><span class="ident" id="5726621">freeConn</span>&nbsp;<span class="op" id="5726630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726634">fns</span>&nbsp;<span class="op" id="5726638">=</span>&nbsp;<span class="builtinfunc" id="5726640">append</span><span class="op" id="5726646">(</span><span class="ident" id="5726647">fns</span><span class="op" id="5726650">,</span>&nbsp;<span class="ident" id="5726652">dc</span><span class="op" id="5726654">.</span><span class="ident" id="5726655">closeDBLocked</span><span class="op" id="5726668">(</span><span class="op" id="5726669">)</span><span class="op" id="5726670">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726676">db</span><span class="op" id="5726678">.</span><span class="ident" id="5726679">freeConn</span>&nbsp;<span class="op" id="5726688">=</span>&nbsp;<span class="ident" id="5726690">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726695">db</span><span class="op" id="5726697">.</span><span class="ident" id="5726698">closed</span>&nbsp;<span class="op" id="5726705">=</span>&nbsp;<span class="builtintype" id="5726707">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726713">for</span>&nbsp;<span class="ident" id="5726717">_</span><span class="op" id="5726718">,</span>&nbsp;<span class="ident" id="5726720">req</span>&nbsp;<span class="op" id="5726724">:=</span>&nbsp;<span class="keyword" id="5726727">range</span>&nbsp;<span class="ident" id="5726733">db</span><span class="op" id="5726735">.</span><span class="ident" id="5726736">connRequests</span>&nbsp;<span class="op" id="5726749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5726753">close</span><span class="op" id="5726758">(</span><span class="ident" id="5726759">req</span><span class="op" id="5726762">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726768">db</span><span class="op" id="5726770">.</span><span class="ident" id="5726771">mu</span><span class="op" id="5726773">.</span><span class="ident" id="5726774">Unlock</span><span class="op" id="5726780">(</span><span class="op" id="5726781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726784">for</span>&nbsp;<span class="ident" id="5726788">_</span><span class="op" id="5726789">,</span>&nbsp;<span class="ident" id="5726791">fn</span>&nbsp;<span class="op" id="5726794">:=</span>&nbsp;<span class="keyword" id="5726797">range</span>&nbsp;<span class="ident" id="5726803">fns</span>&nbsp;<span class="op" id="5726807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726811">err1</span>&nbsp;<span class="op" id="5726816">:=</span>&nbsp;<span class="ident" id="5726819">fn</span><span class="op" id="5726821">(</span><span class="op" id="5726822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726826">if</span>&nbsp;<span class="ident" id="5726829">err1</span>&nbsp;<span class="op" id="5726834">!=</span>&nbsp;<span class="ident" id="5726837">nil</span>&nbsp;<span class="op" id="5726841">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726846">err</span>&nbsp;<span class="op" id="5726850">=</span>&nbsp;<span class="ident" id="5726852">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5726862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726865">return</span>&nbsp;<span class="ident" id="5726872">err</span><br>
<span class="lineno"></span><span class="op" id="5726876">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5726879">const</span>&nbsp;<span class="ident" id="5726885">defaultMaxIdleConns</span>&nbsp;<span class="op" id="5726905">=</span>&nbsp;<span class="num" id="5726907">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5726910">func</span>&nbsp;<span class="op" id="5726915">(</span><span class="ident" id="5726916">db</span>&nbsp;<span class="op" id="5726919">*</span><span class="ident" id="5726920">DB</span><span class="op" id="5726922">)</span>&nbsp;<span class="ident" id="5726924">maxIdleConnsLocked</span><span class="op" id="5726942">(</span><span class="op" id="5726943">)</span>&nbsp;<span class="builtintype" id="5726945">int</span>&nbsp;<span class="op" id="5726949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5726952">n</span>&nbsp;<span class="op" id="5726954">:=</span>&nbsp;<span class="ident" id="5726957">db</span><span class="op" id="5726959">.</span><span class="ident" id="5726960">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726969">switch</span>&nbsp;<span class="op" id="5726976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5726979">case</span>&nbsp;<span class="ident" id="5726984">n</span>&nbsp;<span class="op" id="5726986">==</span>&nbsp;<span class="num" id="5726989">0</span><span class="op" id="5726990">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5726994">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727068">return</span>&nbsp;<span class="ident" id="5727075">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727096">case</span>&nbsp;<span class="ident" id="5727101">n</span>&nbsp;<span class="op" id="5727103">&lt;</span>&nbsp;<span class="num" id="5727105">0</span><span class="op" id="5727106">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727110">return</span>&nbsp;<span class="num" id="5727117">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727120">default</span><span class="op" id="5727127">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727131">return</span>&nbsp;<span class="ident" id="5727138">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5727141">}</span><br>
<span class="lineno"></span><span class="op" id="5727143">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="5727146">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5727216">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="5727236">//</span><br>
<span class="lineno"></span><span class="comment" id="5727239">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="5727311">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5727388">//</span><br>
<span class="lineno"></span><span class="comment" id="5727391">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="5727439">func</span>&nbsp;<span class="op" id="5727444">(</span><span class="ident" id="5727445">db</span>&nbsp;<span class="op" id="5727448">*</span><span class="ident" id="5727449">DB</span><span class="op" id="5727451">)</span>&nbsp;<span class="ident" id="5727453">SetMaxIdleConns</span><span class="op" id="5727468">(</span><span class="ident" id="5727469">n</span>&nbsp;<span class="builtintype" id="5727471">int</span><span class="op" id="5727474">)</span>&nbsp;<span class="op" id="5727476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727479">db</span><span class="op" id="5727481">.</span><span class="ident" id="5727482">mu</span><span class="op" id="5727484">.</span><span class="ident" id="5727485">Lock</span><span class="op" id="5727489">(</span><span class="op" id="5727490">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727493">if</span>&nbsp;<span class="ident" id="5727496">n</span>&nbsp;<span class="op" id="5727498">&gt;</span>&nbsp;<span class="num" id="5727500">0</span>&nbsp;<span class="op" id="5727502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727506">db</span><span class="op" id="5727508">.</span><span class="ident" id="5727509">maxIdle</span>&nbsp;<span class="op" id="5727517">=</span>&nbsp;<span class="ident" id="5727519">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5727522">}</span>&nbsp;<span class="keyword" id="5727524">else</span>&nbsp;<span class="op" id="5727529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5727533">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727559">db</span><span class="op" id="5727561">.</span><span class="ident" id="5727562">maxIdle</span>&nbsp;<span class="op" id="5727570">=</span>&nbsp;<span class="op" id="5727572">-</span><span class="num" id="5727573">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5727576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5727579">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727624">if</span>&nbsp;<span class="ident" id="5727627">db</span><span class="op" id="5727629">.</span><span class="ident" id="5727630">maxOpen</span>&nbsp;<span class="op" id="5727638">&gt;</span>&nbsp;<span class="num" id="5727640">0</span>&nbsp;<span class="op" id="5727642">&amp;&amp;</span>&nbsp;<span class="ident" id="5727645">db</span><span class="op" id="5727647">.</span><span class="ident" id="5727648">maxIdleConnsLocked</span><span class="op" id="5727666">(</span><span class="op" id="5727667">)</span>&nbsp;<span class="op" id="5727669">&gt;</span>&nbsp;<span class="ident" id="5727671">db</span><span class="op" id="5727673">.</span><span class="ident" id="5727674">maxOpen</span>&nbsp;<span class="op" id="5727682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727686">db</span><span class="op" id="5727688">.</span><span class="ident" id="5727689">maxIdle</span>&nbsp;<span class="op" id="5727697">=</span>&nbsp;<span class="ident" id="5727699">db</span><span class="op" id="5727701">.</span><span class="ident" id="5727702">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5727711">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727714">var</span>&nbsp;<span class="ident" id="5727718">closing</span>&nbsp;<span class="op" id="5727726">[</span><span class="op" id="5727727">]</span><span class="op" id="5727728">*</span><span class="ident" id="5727729">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727741">idleCount</span>&nbsp;<span class="op" id="5727751">:=</span>&nbsp;<span class="builtinfunc" id="5727754">len</span><span class="op" id="5727757">(</span><span class="ident" id="5727758">db</span><span class="op" id="5727760">.</span><span class="ident" id="5727761">freeConn</span><span class="op" id="5727769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727772">maxIdle</span>&nbsp;<span class="op" id="5727780">:=</span>&nbsp;<span class="ident" id="5727783">db</span><span class="op" id="5727785">.</span><span class="ident" id="5727786">maxIdleConnsLocked</span><span class="op" id="5727804">(</span><span class="op" id="5727805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727808">if</span>&nbsp;<span class="ident" id="5727811">idleCount</span>&nbsp;<span class="op" id="5727821">&gt;</span>&nbsp;<span class="ident" id="5727823">maxIdle</span>&nbsp;<span class="op" id="5727831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727835">closing</span>&nbsp;<span class="op" id="5727843">=</span>&nbsp;<span class="ident" id="5727845">db</span><span class="op" id="5727847">.</span><span class="ident" id="5727848">freeConn</span><span class="op" id="5727856">[</span><span class="ident" id="5727857">maxIdle</span><span class="op" id="5727864">:</span><span class="op" id="5727865">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727869">db</span><span class="op" id="5727871">.</span><span class="ident" id="5727872">freeConn</span>&nbsp;<span class="op" id="5727881">=</span>&nbsp;<span class="ident" id="5727883">db</span><span class="op" id="5727885">.</span><span class="ident" id="5727886">freeConn</span><span class="op" id="5727894">[</span><span class="op" id="5727895">:</span><span class="ident" id="5727896">maxIdle</span><span class="op" id="5727903">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5727906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727909">db</span><span class="op" id="5727911">.</span><span class="ident" id="5727912">mu</span><span class="op" id="5727914">.</span><span class="ident" id="5727915">Unlock</span><span class="op" id="5727921">(</span><span class="op" id="5727922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5727925">for</span>&nbsp;<span class="ident" id="5727929">_</span><span class="op" id="5727930">,</span>&nbsp;<span class="ident" id="5727932">c</span>&nbsp;<span class="op" id="5727934">:=</span>&nbsp;<span class="keyword" id="5727937">range</span>&nbsp;<span class="ident" id="5727943">closing</span>&nbsp;<span class="op" id="5727951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5727955">c</span><span class="op" id="5727956">.</span><span class="ident" id="5727957">Close</span><span class="op" id="5727962">(</span><span class="op" id="5727963">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5727966">}</span><br>
<span class="lineno"></span><span class="op" id="5727968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5727971">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="5728051">//</span><br>
<span class="lineno">550</span><span class="comment" id="5728054">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="5728129">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5728197">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5728219">//</span><br>
<span class="lineno"></span><span class="comment" id="5728222">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="5728294">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="5728327">func</span>&nbsp;<span class="op" id="5728332">(</span><span class="ident" id="5728333">db</span>&nbsp;<span class="op" id="5728336">*</span><span class="ident" id="5728337">DB</span><span class="op" id="5728339">)</span>&nbsp;<span class="ident" id="5728341">SetMaxOpenConns</span><span class="op" id="5728356">(</span><span class="ident" id="5728357">n</span>&nbsp;<span class="builtintype" id="5728359">int</span><span class="op" id="5728362">)</span>&nbsp;<span class="op" id="5728364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728367">db</span><span class="op" id="5728369">.</span><span class="ident" id="5728370">mu</span><span class="op" id="5728372">.</span><span class="ident" id="5728373">Lock</span><span class="op" id="5728377">(</span><span class="op" id="5728378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728381">db</span><span class="op" id="5728383">.</span><span class="ident" id="5728384">maxOpen</span>&nbsp;<span class="op" id="5728392">=</span>&nbsp;<span class="ident" id="5728394">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728397">if</span>&nbsp;<span class="ident" id="5728400">n</span>&nbsp;<span class="op" id="5728402">&lt;</span>&nbsp;<span class="num" id="5728404">0</span>&nbsp;<span class="op" id="5728406">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728410">db</span><span class="op" id="5728412">.</span><span class="ident" id="5728413">maxOpen</span>&nbsp;<span class="op" id="5728421">=</span>&nbsp;<span class="num" id="5728423">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5728426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728429">syncMaxIdle</span>&nbsp;<span class="op" id="5728441">:=</span>&nbsp;<span class="ident" id="5728444">db</span><span class="op" id="5728446">.</span><span class="ident" id="5728447">maxOpen</span>&nbsp;<span class="op" id="5728455">&gt;</span>&nbsp;<span class="num" id="5728457">0</span>&nbsp;<span class="op" id="5728459">&amp;&amp;</span>&nbsp;<span class="ident" id="5728462">db</span><span class="op" id="5728464">.</span><span class="ident" id="5728465">maxIdleConnsLocked</span><span class="op" id="5728483">(</span><span class="op" id="5728484">)</span>&nbsp;<span class="op" id="5728486">&gt;</span>&nbsp;<span class="ident" id="5728488">db</span><span class="op" id="5728490">.</span><span class="ident" id="5728491">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728500">db</span><span class="op" id="5728502">.</span><span class="ident" id="5728503">mu</span><span class="op" id="5728505">.</span><span class="ident" id="5728506">Unlock</span><span class="op" id="5728512">(</span><span class="op" id="5728513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728516">if</span>&nbsp;<span class="ident" id="5728519">syncMaxIdle</span>&nbsp;<span class="op" id="5728531">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728535">db</span><span class="op" id="5728537">.</span><span class="ident" id="5728538">SetMaxIdleConns</span><span class="op" id="5728553">(</span><span class="ident" id="5728554">n</span><span class="op" id="5728555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5728558">}</span><br>
<span class="lineno"></span><span class="op" id="5728560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5728563">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="5728591">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="5728666">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="5728725">func</span>&nbsp;<span class="op" id="5728730">(</span><span class="ident" id="5728731">db</span>&nbsp;<span class="op" id="5728734">*</span><span class="ident" id="5728735">DB</span><span class="op" id="5728737">)</span>&nbsp;<span class="ident" id="5728739">maybeOpenNewConnections</span><span class="op" id="5728762">(</span><span class="op" id="5728763">)</span>&nbsp;<span class="op" id="5728765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728768">numRequests</span>&nbsp;<span class="op" id="5728780">:=</span>&nbsp;<span class="builtinfunc" id="5728783">len</span><span class="op" id="5728786">(</span><span class="ident" id="5728787">db</span><span class="op" id="5728789">.</span><span class="ident" id="5728790">connRequests</span><span class="op" id="5728802">)</span>&nbsp;<span class="op" id="5728804">-</span>&nbsp;<span class="ident" id="5728806">db</span><span class="op" id="5728808">.</span><span class="ident" id="5728809">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728823">if</span>&nbsp;<span class="ident" id="5728826">db</span><span class="op" id="5728828">.</span><span class="ident" id="5728829">maxOpen</span>&nbsp;<span class="op" id="5728837">&gt;</span>&nbsp;<span class="num" id="5728839">0</span>&nbsp;<span class="op" id="5728841">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728845">numCanOpen</span>&nbsp;<span class="op" id="5728856">:=</span>&nbsp;<span class="ident" id="5728859">db</span><span class="op" id="5728861">.</span><span class="ident" id="5728862">maxOpen</span>&nbsp;<span class="op" id="5728870">-</span>&nbsp;<span class="op" id="5728872">(</span><span class="ident" id="5728873">db</span><span class="op" id="5728875">.</span><span class="ident" id="5728876">numOpen</span>&nbsp;<span class="op" id="5728884">+</span>&nbsp;<span class="ident" id="5728886">db</span><span class="op" id="5728888">.</span><span class="ident" id="5728889">pendingOpens</span><span class="op" id="5728901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728905">if</span>&nbsp;<span class="ident" id="5728908">numRequests</span>&nbsp;<span class="op" id="5728920">&gt;</span>&nbsp;<span class="ident" id="5728922">numCanOpen</span>&nbsp;<span class="op" id="5728933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728938">numRequests</span>&nbsp;<span class="op" id="5728950">=</span>&nbsp;<span class="ident" id="5728952">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5728965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5728968">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5728971">for</span>&nbsp;<span class="ident" id="5728975">numRequests</span>&nbsp;<span class="op" id="5728987">&gt;</span>&nbsp;<span class="num" id="5728989">0</span>&nbsp;<span class="op" id="5728991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5728995">db</span><span class="op" id="5728997">.</span><span class="ident" id="5728998">pendingOpens</span><span class="op" id="5729010">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729015">numRequests</span><span class="op" id="5729026">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729031">db</span><span class="op" id="5729033">.</span><span class="ident" id="5729034">openerCh</span>&nbsp;<span class="op" id="5729043">&lt;-</span>&nbsp;<span class="keyword" id="5729046">struct</span><span class="op" id="5729052">{</span><span class="op" id="5729053">}</span><span class="op" id="5729054">{</span><span class="op" id="5729055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729058">}</span><br>
<span class="lineno">585</span><span class="op" id="5729060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5729063">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="5729134">func</span>&nbsp;<span class="op" id="5729139">(</span><span class="ident" id="5729140">db</span>&nbsp;<span class="op" id="5729143">*</span><span class="ident" id="5729144">DB</span><span class="op" id="5729146">)</span>&nbsp;<span class="ident" id="5729148">connectionOpener</span><span class="op" id="5729164">(</span><span class="op" id="5729165">)</span>&nbsp;<span class="op" id="5729167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729170">for</span>&nbsp;<span class="keyword" id="5729174">range</span>&nbsp;<span class="ident" id="5729180">db</span><span class="op" id="5729182">.</span><span class="ident" id="5729183">openerCh</span>&nbsp;<span class="op" id="5729192">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729196">db</span><span class="op" id="5729198">.</span><span class="ident" id="5729199">openNewConnection</span><span class="op" id="5729216">(</span><span class="op" id="5729217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729220">}</span><br>
<span class="lineno"></span><span class="op" id="5729222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5729225">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="5729252">func</span>&nbsp;<span class="op" id="5729257">(</span><span class="ident" id="5729258">db</span>&nbsp;<span class="op" id="5729261">*</span><span class="ident" id="5729262">DB</span><span class="op" id="5729264">)</span>&nbsp;<span class="ident" id="5729266">openNewConnection</span><span class="op" id="5729283">(</span><span class="op" id="5729284">)</span>&nbsp;<span class="op" id="5729286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729289">ci</span><span class="op" id="5729291">,</span>&nbsp;<span class="ident" id="5729293">err</span>&nbsp;<span class="op" id="5729297">:=</span>&nbsp;<span class="ident" id="5729300">db</span><span class="op" id="5729302">.</span><span class="ident" id="5729303">driver</span><span class="op" id="5729309">.</span><span class="ident" id="5729310">Open</span><span class="op" id="5729314">(</span><span class="ident" id="5729315">db</span><span class="op" id="5729317">.</span><span class="ident" id="5729318">dsn</span><span class="op" id="5729321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729324">db</span><span class="op" id="5729326">.</span><span class="ident" id="5729327">mu</span><span class="op" id="5729329">.</span><span class="ident" id="5729330">Lock</span><span class="op" id="5729334">(</span><span class="op" id="5729335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729338">defer</span>&nbsp;<span class="ident" id="5729344">db</span><span class="op" id="5729346">.</span><span class="ident" id="5729347">mu</span><span class="op" id="5729349">.</span><span class="ident" id="5729350">Unlock</span><span class="op" id="5729356">(</span><span class="op" id="5729357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729360">if</span>&nbsp;<span class="ident" id="5729363">db</span><span class="op" id="5729365">.</span><span class="ident" id="5729366">closed</span>&nbsp;<span class="op" id="5729373">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729377">if</span>&nbsp;<span class="ident" id="5729380">err</span>&nbsp;<span class="op" id="5729384">==</span>&nbsp;<span class="ident" id="5729387">nil</span>&nbsp;<span class="op" id="5729391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729396">ci</span><span class="op" id="5729398">.</span><span class="ident" id="5729399">Close</span><span class="op" id="5729404">(</span><span class="op" id="5729405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729413">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729421">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729424">db</span><span class="op" id="5729426">.</span><span class="ident" id="5729427">pendingOpens</span><span class="op" id="5729439">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729443">if</span>&nbsp;<span class="ident" id="5729446">err</span>&nbsp;<span class="op" id="5729450">!=</span>&nbsp;<span class="ident" id="5729453">nil</span>&nbsp;<span class="op" id="5729457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729461">db</span><span class="op" id="5729463">.</span><span class="ident" id="5729464">putConnDBLocked</span><span class="op" id="5729479">(</span><span class="ident" id="5729480">nil</span><span class="op" id="5729483">,</span>&nbsp;<span class="ident" id="5729485">err</span><span class="op" id="5729488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729492">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729500">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729503">dc</span>&nbsp;<span class="op" id="5729506">:=</span>&nbsp;<span class="op" id="5729509">&amp;</span><span class="ident" id="5729510">driverConn</span><span class="op" id="5729520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729524">db</span><span class="op" id="5729526">:</span>&nbsp;<span class="ident" id="5729528">db</span><span class="op" id="5729530">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729534">ci</span><span class="op" id="5729536">:</span>&nbsp;<span class="ident" id="5729538">ci</span><span class="op" id="5729540">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5729546">if</span>&nbsp;<span class="ident" id="5729549">db</span><span class="op" id="5729551">.</span><span class="ident" id="5729552">putConnDBLocked</span><span class="op" id="5729567">(</span><span class="ident" id="5729568">dc</span><span class="op" id="5729570">,</span>&nbsp;<span class="ident" id="5729572">err</span><span class="op" id="5729575">)</span>&nbsp;<span class="op" id="5729577">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729581">db</span><span class="op" id="5729583">.</span><span class="ident" id="5729584">addDepLocked</span><span class="op" id="5729596">(</span><span class="ident" id="5729597">dc</span><span class="op" id="5729599">,</span>&nbsp;<span class="ident" id="5729601">dc</span><span class="op" id="5729603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729607">db</span><span class="op" id="5729609">.</span><span class="ident" id="5729610">numOpen</span><span class="op" id="5729617">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729621">}</span>&nbsp;<span class="keyword" id="5729623">else</span>&nbsp;<span class="op" id="5729628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729632">ci</span><span class="op" id="5729634">.</span><span class="ident" id="5729635">Close</span><span class="op" id="5729640">(</span><span class="op" id="5729641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5729644">}</span><br>
<span class="lineno">620</span><span class="op" id="5729646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5729649">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5729708">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5729777">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="5729838">type</span>&nbsp;<span class="ident" id="5729843">connRequest</span>&nbsp;<span class="keyword" id="5729855">struct</span>&nbsp;<span class="op" id="5729862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729865">conn</span>&nbsp;<span class="op" id="5729870">*</span><span class="ident" id="5729871">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5729883">err</span>&nbsp;&nbsp;<span class="builtintype" id="5729888">error</span><br>
<span class="lineno"></span><span class="op" id="5729894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="5729897">var</span>&nbsp;<span class="ident" id="5729901">errDBClosed</span>&nbsp;<span class="op" id="5729913">=</span>&nbsp;<span class="ident" id="5729915">errors</span><span class="op" id="5729921">.</span><span class="ident" id="5729922">New</span><span class="op" id="5729925">(</span><span class="string" id="5729926">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5729951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5729954">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="5730007">func</span>&nbsp;<span class="op" id="5730012">(</span><span class="ident" id="5730013">db</span>&nbsp;<span class="op" id="5730016">*</span><span class="ident" id="5730017">DB</span><span class="op" id="5730019">)</span>&nbsp;<span class="ident" id="5730021">conn</span><span class="op" id="5730025">(</span><span class="op" id="5730026">)</span>&nbsp;<span class="op" id="5730028">(</span><span class="op" id="5730029">*</span><span class="ident" id="5730030">driverConn</span><span class="op" id="5730040">,</span>&nbsp;<span class="builtintype" id="5730042">error</span><span class="op" id="5730047">)</span>&nbsp;<span class="op" id="5730049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730052">db</span><span class="op" id="5730054">.</span><span class="ident" id="5730055">mu</span><span class="op" id="5730057">.</span><span class="ident" id="5730058">Lock</span><span class="op" id="5730062">(</span><span class="op" id="5730063">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730066">if</span>&nbsp;<span class="ident" id="5730069">db</span><span class="op" id="5730071">.</span><span class="ident" id="5730072">closed</span>&nbsp;<span class="op" id="5730079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730083">db</span><span class="op" id="5730085">.</span><span class="ident" id="5730086">mu</span><span class="op" id="5730088">.</span><span class="ident" id="5730089">Unlock</span><span class="op" id="5730095">(</span><span class="op" id="5730096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730100">return</span>&nbsp;<span class="ident" id="5730107">nil</span><span class="op" id="5730110">,</span>&nbsp;<span class="ident" id="5730112">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730129">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730204">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730267">if</span>&nbsp;<span class="ident" id="5730270">db</span><span class="op" id="5730272">.</span><span class="ident" id="5730273">maxOpen</span>&nbsp;<span class="op" id="5730281">&gt;</span>&nbsp;<span class="num" id="5730283">0</span>&nbsp;<span class="op" id="5730285">&amp;&amp;</span>&nbsp;<span class="ident" id="5730288">db</span><span class="op" id="5730290">.</span><span class="ident" id="5730291">numOpen</span>&nbsp;<span class="op" id="5730299">&gt;=</span>&nbsp;<span class="ident" id="5730302">db</span><span class="op" id="5730304">.</span><span class="ident" id="5730305">maxOpen</span>&nbsp;<span class="op" id="5730313">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5730316">len</span><span class="op" id="5730319">(</span><span class="ident" id="5730320">db</span><span class="op" id="5730322">.</span><span class="ident" id="5730323">freeConn</span><span class="op" id="5730331">)</span>&nbsp;<span class="op" id="5730333">==</span>&nbsp;<span class="num" id="5730336">0</span>&nbsp;<span class="op" id="5730338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730342">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5730403">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730477">req</span>&nbsp;<span class="op" id="5730481">:=</span>&nbsp;<span class="builtinfunc" id="5730484">make</span><span class="op" id="5730488">(</span><span class="keyword" id="5730489">chan</span>&nbsp;<span class="ident" id="5730494">connRequest</span><span class="op" id="5730505">,</span>&nbsp;<span class="num" id="5730507">1</span><span class="op" id="5730508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730512">db</span><span class="op" id="5730514">.</span><span class="ident" id="5730515">connRequests</span>&nbsp;<span class="op" id="5730528">=</span>&nbsp;<span class="builtinfunc" id="5730530">append</span><span class="op" id="5730536">(</span><span class="ident" id="5730537">db</span><span class="op" id="5730539">.</span><span class="ident" id="5730540">connRequests</span><span class="op" id="5730552">,</span>&nbsp;<span class="ident" id="5730554">req</span><span class="op" id="5730557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730561">db</span><span class="op" id="5730563">.</span><span class="ident" id="5730564">maybeOpenNewConnections</span><span class="op" id="5730587">(</span><span class="op" id="5730588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730592">db</span><span class="op" id="5730594">.</span><span class="ident" id="5730595">mu</span><span class="op" id="5730597">.</span><span class="ident" id="5730598">Unlock</span><span class="op" id="5730604">(</span><span class="op" id="5730605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730609">ret</span>&nbsp;<span class="op" id="5730613">:=</span>&nbsp;<span class="op" id="5730616">&lt;-</span><span class="ident" id="5730618">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730624">return</span>&nbsp;<span class="ident" id="5730631">ret</span><span class="op" id="5730634">.</span><span class="ident" id="5730635">conn</span><span class="op" id="5730639">,</span>&nbsp;<span class="ident" id="5730641">ret</span><span class="op" id="5730644">.</span><span class="ident" id="5730645">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730654">if</span>&nbsp;<span class="ident" id="5730657">c</span>&nbsp;<span class="op" id="5730659">:=</span>&nbsp;<span class="builtinfunc" id="5730662">len</span><span class="op" id="5730665">(</span><span class="ident" id="5730666">db</span><span class="op" id="5730668">.</span><span class="ident" id="5730669">freeConn</span><span class="op" id="5730677">)</span><span class="op" id="5730678">;</span>&nbsp;<span class="ident" id="5730680">c</span>&nbsp;<span class="op" id="5730682">&gt;</span>&nbsp;<span class="num" id="5730684">0</span>&nbsp;<span class="op" id="5730686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730690">conn</span>&nbsp;<span class="op" id="5730695">:=</span>&nbsp;<span class="ident" id="5730698">db</span><span class="op" id="5730700">.</span><span class="ident" id="5730701">freeConn</span><span class="op" id="5730709">[</span><span class="num" id="5730710">0</span><span class="op" id="5730711">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5730715">copy</span><span class="op" id="5730719">(</span><span class="ident" id="5730720">db</span><span class="op" id="5730722">.</span><span class="ident" id="5730723">freeConn</span><span class="op" id="5730731">,</span>&nbsp;<span class="ident" id="5730733">db</span><span class="op" id="5730735">.</span><span class="ident" id="5730736">freeConn</span><span class="op" id="5730744">[</span><span class="num" id="5730745">1</span><span class="op" id="5730746">:</span><span class="op" id="5730747">]</span><span class="op" id="5730748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730752">db</span><span class="op" id="5730754">.</span><span class="ident" id="5730755">freeConn</span>&nbsp;<span class="op" id="5730764">=</span>&nbsp;<span class="ident" id="5730766">db</span><span class="op" id="5730768">.</span><span class="ident" id="5730769">freeConn</span><span class="op" id="5730777">[</span><span class="op" id="5730778">:</span><span class="ident" id="5730779">c</span><span class="op" id="5730780">-</span><span class="num" id="5730781">1</span><span class="op" id="5730782">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730786">conn</span><span class="op" id="5730790">.</span><span class="ident" id="5730791">inUse</span>&nbsp;<span class="op" id="5730797">=</span>&nbsp;<span class="builtintype" id="5730799">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730806">db</span><span class="op" id="5730808">.</span><span class="ident" id="5730809">mu</span><span class="op" id="5730811">.</span><span class="ident" id="5730812">Unlock</span><span class="op" id="5730818">(</span><span class="op" id="5730819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730823">return</span>&nbsp;<span class="ident" id="5730830">conn</span><span class="op" id="5730834">,</span>&nbsp;<span class="ident" id="5730836">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5730841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730845">db</span><span class="op" id="5730847">.</span><span class="ident" id="5730848">numOpen</span><span class="op" id="5730855">++</span>&nbsp;<span class="comment" id="5730858">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730877">db</span><span class="op" id="5730879">.</span><span class="ident" id="5730880">mu</span><span class="op" id="5730882">.</span><span class="ident" id="5730883">Unlock</span><span class="op" id="5730889">(</span><span class="op" id="5730890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730893">ci</span><span class="op" id="5730895">,</span>&nbsp;<span class="ident" id="5730897">err</span>&nbsp;<span class="op" id="5730901">:=</span>&nbsp;<span class="ident" id="5730904">db</span><span class="op" id="5730906">.</span><span class="ident" id="5730907">driver</span><span class="op" id="5730913">.</span><span class="ident" id="5730914">Open</span><span class="op" id="5730918">(</span><span class="ident" id="5730919">db</span><span class="op" id="5730921">.</span><span class="ident" id="5730922">dsn</span><span class="op" id="5730925">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5730928">if</span>&nbsp;<span class="ident" id="5730931">err</span>&nbsp;<span class="op" id="5730935">!=</span>&nbsp;<span class="ident" id="5730938">nil</span>&nbsp;<span class="op" id="5730942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730946">db</span><span class="op" id="5730948">.</span><span class="ident" id="5730949">mu</span><span class="op" id="5730951">.</span><span class="ident" id="5730952">Lock</span><span class="op" id="5730956">(</span><span class="op" id="5730957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5730961">db</span><span class="op" id="5730963">.</span><span class="ident" id="5730964">numOpen</span><span class="op" id="5730971">--</span>&nbsp;<span class="comment" id="5730974">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731008">db</span><span class="op" id="5731010">.</span><span class="ident" id="5731011">mu</span><span class="op" id="5731013">.</span><span class="ident" id="5731014">Unlock</span><span class="op" id="5731020">(</span><span class="op" id="5731021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731025">return</span>&nbsp;<span class="ident" id="5731032">nil</span><span class="op" id="5731035">,</span>&nbsp;<span class="ident" id="5731037">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731045">db</span><span class="op" id="5731047">.</span><span class="ident" id="5731048">mu</span><span class="op" id="5731050">.</span><span class="ident" id="5731051">Lock</span><span class="op" id="5731055">(</span><span class="op" id="5731056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731059">dc</span>&nbsp;<span class="op" id="5731062">:=</span>&nbsp;<span class="op" id="5731065">&amp;</span><span class="ident" id="5731066">driverConn</span><span class="op" id="5731076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731080">db</span><span class="op" id="5731082">:</span>&nbsp;<span class="ident" id="5731084">db</span><span class="op" id="5731086">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731090">ci</span><span class="op" id="5731092">:</span>&nbsp;<span class="ident" id="5731094">ci</span><span class="op" id="5731096">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731102">db</span><span class="op" id="5731104">.</span><span class="ident" id="5731105">addDepLocked</span><span class="op" id="5731117">(</span><span class="ident" id="5731118">dc</span><span class="op" id="5731120">,</span>&nbsp;<span class="ident" id="5731122">dc</span><span class="op" id="5731124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731127">dc</span><span class="op" id="5731129">.</span><span class="ident" id="5731130">inUse</span>&nbsp;<span class="op" id="5731136">=</span>&nbsp;<span class="builtintype" id="5731138">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731144">db</span><span class="op" id="5731146">.</span><span class="ident" id="5731147">mu</span><span class="op" id="5731149">.</span><span class="ident" id="5731150">Unlock</span><span class="op" id="5731156">(</span><span class="op" id="5731157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731160">return</span>&nbsp;<span class="ident" id="5731167">dc</span><span class="op" id="5731169">,</span>&nbsp;<span class="ident" id="5731171">nil</span><br>
<span class="lineno">680</span><span class="op" id="5731175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5731178">var</span>&nbsp;<span class="op" id="5731182">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731185">errConnClosed</span>&nbsp;<span class="op" id="5731199">=</span>&nbsp;<span class="ident" id="5731201">errors</span><span class="op" id="5731207">.</span><span class="ident" id="5731208">New</span><span class="op" id="5731211">(</span><span class="string" id="5731212">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5731267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731270">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5731284">=</span>&nbsp;<span class="ident" id="5731286">errors</span><span class="op" id="5731292">.</span><span class="ident" id="5731293">New</span><span class="op" id="5731296">(</span><span class="string" id="5731297">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="5731350">)</span><br>
<span class="lineno">685</span><span class="op" id="5731352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5731355">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5731427">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="5731444">//</span><br>
<span class="lineno">690</span><span class="comment" id="5731447">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5731523">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5731563">//</span><br>
<span class="lineno"></span><span class="comment" id="5731566">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5731623">func</span>&nbsp;<span class="op" id="5731628">(</span><span class="ident" id="5731629">db</span>&nbsp;<span class="op" id="5731632">*</span><span class="ident" id="5731633">DB</span><span class="op" id="5731635">)</span>&nbsp;<span class="ident" id="5731637">connIfFree</span><span class="op" id="5731647">(</span><span class="ident" id="5731648">wanted</span>&nbsp;<span class="op" id="5731655">*</span><span class="ident" id="5731656">driverConn</span><span class="op" id="5731666">)</span>&nbsp;<span class="op" id="5731668">(</span><span class="op" id="5731669">*</span><span class="ident" id="5731670">driverConn</span><span class="op" id="5731680">,</span>&nbsp;<span class="builtintype" id="5731682">error</span><span class="op" id="5731687">)</span>&nbsp;<span class="op" id="5731689">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731692">db</span><span class="op" id="5731694">.</span><span class="ident" id="5731695">mu</span><span class="op" id="5731697">.</span><span class="ident" id="5731698">Lock</span><span class="op" id="5731702">(</span><span class="op" id="5731703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731706">defer</span>&nbsp;<span class="ident" id="5731712">db</span><span class="op" id="5731714">.</span><span class="ident" id="5731715">mu</span><span class="op" id="5731717">.</span><span class="ident" id="5731718">Unlock</span><span class="op" id="5731724">(</span><span class="op" id="5731725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731728">if</span>&nbsp;<span class="ident" id="5731731">wanted</span><span class="op" id="5731737">.</span><span class="ident" id="5731738">dbmuClosed</span>&nbsp;<span class="op" id="5731749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731753">return</span>&nbsp;<span class="ident" id="5731760">nil</span><span class="op" id="5731763">,</span>&nbsp;<span class="ident" id="5731765">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731780">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731783">if</span>&nbsp;<span class="ident" id="5731786">wanted</span><span class="op" id="5731792">.</span><span class="ident" id="5731793">inUse</span>&nbsp;<span class="op" id="5731799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731803">return</span>&nbsp;<span class="ident" id="5731810">nil</span><span class="op" id="5731813">,</span>&nbsp;<span class="ident" id="5731815">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731831">idx</span>&nbsp;<span class="op" id="5731835">:=</span>&nbsp;<span class="op" id="5731838">-</span><span class="num" id="5731839">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731842">for</span>&nbsp;<span class="ident" id="5731846">ii</span><span class="op" id="5731848">,</span>&nbsp;<span class="ident" id="5731850">v</span>&nbsp;<span class="op" id="5731852">:=</span>&nbsp;<span class="keyword" id="5731855">range</span>&nbsp;<span class="ident" id="5731861">db</span><span class="op" id="5731863">.</span><span class="ident" id="5731864">freeConn</span>&nbsp;<span class="op" id="5731873">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731877">if</span>&nbsp;<span class="ident" id="5731880">v</span>&nbsp;<span class="op" id="5731882">==</span>&nbsp;<span class="ident" id="5731885">wanted</span>&nbsp;<span class="op" id="5731892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731897">idx</span>&nbsp;<span class="op" id="5731901">=</span>&nbsp;<span class="ident" id="5731903">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731909">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5731920">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5731923">if</span>&nbsp;<span class="ident" id="5731926">idx</span>&nbsp;<span class="op" id="5731930">&gt;=</span>&nbsp;<span class="num" id="5731933">0</span>&nbsp;<span class="op" id="5731935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5731939">db</span><span class="op" id="5731941">.</span><span class="ident" id="5731942">freeConn</span>&nbsp;<span class="op" id="5731951">=</span>&nbsp;<span class="builtinfunc" id="5731953">append</span><span class="op" id="5731959">(</span><span class="ident" id="5731960">db</span><span class="op" id="5731962">.</span><span class="ident" id="5731963">freeConn</span><span class="op" id="5731971">[</span><span class="op" id="5731972">:</span><span class="ident" id="5731973">idx</span><span class="op" id="5731976">]</span><span class="op" id="5731977">,</span>&nbsp;<span class="ident" id="5731979">db</span><span class="op" id="5731981">.</span><span class="ident" id="5731982">freeConn</span><span class="op" id="5731990">[</span><span class="ident" id="5731991">idx</span><span class="op" id="5731994">+</span><span class="num" id="5731995">1</span><span class="op" id="5731996">:</span><span class="op" id="5731997">]</span><span class="op" id="5731998">...</span><span class="op" id="5732001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732005">wanted</span><span class="op" id="5732011">.</span><span class="ident" id="5732012">inUse</span>&nbsp;<span class="op" id="5732018">=</span>&nbsp;<span class="builtintype" id="5732020">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732027">return</span>&nbsp;<span class="ident" id="5732034">wanted</span><span class="op" id="5732040">,</span>&nbsp;<span class="ident" id="5732042">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732047">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732050">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732120">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732197">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732266">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5732286">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732332">return</span>&nbsp;<span class="ident" id="5732339">nil</span><span class="op" id="5732342">,</span>&nbsp;<span class="ident" id="5732344">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="5732356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5732359">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="5732397">var</span>&nbsp;<span class="ident" id="5732401">putConnHook</span>&nbsp;<span class="keyword" id="5732413">func</span><span class="op" id="5732417">(</span><span class="op" id="5732418">*</span><span class="ident" id="5732419">DB</span><span class="op" id="5732421">,</span>&nbsp;<span class="op" id="5732423">*</span><span class="ident" id="5732424">driverConn</span><span class="op" id="5732434">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5732437">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="5732509">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5732581">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5732600">func</span>&nbsp;<span class="op" id="5732605">(</span><span class="ident" id="5732606">db</span>&nbsp;<span class="op" id="5732609">*</span><span class="ident" id="5732610">DB</span><span class="op" id="5732612">)</span>&nbsp;<span class="ident" id="5732614">noteUnusedDriverStatement</span><span class="op" id="5732639">(</span><span class="ident" id="5732640">c</span>&nbsp;<span class="op" id="5732642">*</span><span class="ident" id="5732643">driverConn</span><span class="op" id="5732653">,</span>&nbsp;<span class="ident" id="5732655">si</span>&nbsp;<span class="ident" id="5732658">driver</span><span class="op" id="5732664">.</span><span class="ident" id="5732665">Stmt</span><span class="op" id="5732669">)</span>&nbsp;<span class="op" id="5732671">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732674">db</span><span class="op" id="5732676">.</span><span class="ident" id="5732677">mu</span><span class="op" id="5732679">.</span><span class="ident" id="5732680">Lock</span><span class="op" id="5732684">(</span><span class="op" id="5732685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732688">defer</span>&nbsp;<span class="ident" id="5732694">db</span><span class="op" id="5732696">.</span><span class="ident" id="5732697">mu</span><span class="op" id="5732699">.</span><span class="ident" id="5732700">Unlock</span><span class="op" id="5732706">(</span><span class="op" id="5732707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732710">if</span>&nbsp;<span class="ident" id="5732713">c</span><span class="op" id="5732714">.</span><span class="ident" id="5732715">inUse</span>&nbsp;<span class="op" id="5732721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732725">c</span><span class="op" id="5732726">.</span><span class="ident" id="5732727">onPut</span>&nbsp;<span class="op" id="5732733">=</span>&nbsp;<span class="builtinfunc" id="5732735">append</span><span class="op" id="5732741">(</span><span class="ident" id="5732742">c</span><span class="op" id="5732743">.</span><span class="ident" id="5732744">onPut</span><span class="op" id="5732749">,</span>&nbsp;<span class="keyword" id="5732751">func</span><span class="op" id="5732755">(</span><span class="op" id="5732756">)</span>&nbsp;<span class="op" id="5732758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732763">si</span><span class="op" id="5732765">.</span><span class="ident" id="5732766">Close</span><span class="op" id="5732771">(</span><span class="op" id="5732772">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732776">}</span><span class="op" id="5732777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732780">}</span>&nbsp;<span class="keyword" id="5732782">else</span>&nbsp;<span class="op" id="5732787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732791">c</span><span class="op" id="5732792">.</span><span class="ident" id="5732793">Lock</span><span class="op" id="5732797">(</span><span class="op" id="5732798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732802">defer</span>&nbsp;<span class="ident" id="5732808">c</span><span class="op" id="5732809">.</span><span class="ident" id="5732810">Unlock</span><span class="op" id="5732816">(</span><span class="op" id="5732817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5732821">if</span>&nbsp;<span class="op" id="5732824">!</span><span class="ident" id="5732825">c</span><span class="op" id="5732826">.</span><span class="ident" id="5732827">finalClosed</span>&nbsp;<span class="op" id="5732839">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5732844">si</span><span class="op" id="5732846">.</span><span class="ident" id="5732847">Close</span><span class="op" id="5732852">(</span><span class="op" id="5732853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5732860">}</span><br>
<span class="lineno"></span><span class="op" id="5732862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="5732865">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="5732937">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="5732979">const</span>&nbsp;<span class="ident" id="5732985">debugGetPut</span>&nbsp;<span class="op" id="5732997">=</span>&nbsp;<span class="builtintype" id="5732999">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5733006">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="5733058">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5733128">func</span>&nbsp;<span class="op" id="5733133">(</span><span class="ident" id="5733134">db</span>&nbsp;<span class="op" id="5733137">*</span><span class="ident" id="5733138">DB</span><span class="op" id="5733140">)</span>&nbsp;<span class="ident" id="5733142">putConn</span><span class="op" id="5733149">(</span><span class="ident" id="5733150">dc</span>&nbsp;<span class="op" id="5733153">*</span><span class="ident" id="5733154">driverConn</span><span class="op" id="5733164">,</span>&nbsp;<span class="ident" id="5733166">err</span>&nbsp;<span class="builtintype" id="5733170">error</span><span class="op" id="5733175">)</span>&nbsp;<span class="op" id="5733177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733180">db</span><span class="op" id="5733182">.</span><span class="ident" id="5733183">mu</span><span class="op" id="5733185">.</span><span class="ident" id="5733186">Lock</span><span class="op" id="5733190">(</span><span class="op" id="5733191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733194">if</span>&nbsp;<span class="op" id="5733197">!</span><span class="ident" id="5733198">dc</span><span class="op" id="5733200">.</span><span class="ident" id="5733201">inUse</span>&nbsp;<span class="op" id="5733207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733211">if</span>&nbsp;<span class="ident" id="5733214">debugGetPut</span>&nbsp;<span class="op" id="5733226">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733231">fmt</span><span class="op" id="5733234">.</span><span class="ident" id="5733235">Printf</span><span class="op" id="5733241">(</span><span class="string" id="5733242">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="5733293">,</span>&nbsp;<span class="ident" id="5733295">dc</span><span class="op" id="5733297">,</span>&nbsp;<span class="ident" id="5733299">stack</span><span class="op" id="5733304">(</span><span class="op" id="5733305">)</span><span class="op" id="5733306">,</span>&nbsp;<span class="ident" id="5733308">db</span><span class="op" id="5733310">.</span><span class="ident" id="5733311">lastPut</span><span class="op" id="5733318">[</span><span class="ident" id="5733319">dc</span><span class="op" id="5733321">]</span><span class="op" id="5733322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5733330">panic</span><span class="op" id="5733335">(</span><span class="string" id="5733336">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="5733381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733387">if</span>&nbsp;<span class="ident" id="5733390">debugGetPut</span>&nbsp;<span class="op" id="5733402">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733406">db</span><span class="op" id="5733408">.</span><span class="ident" id="5733409">lastPut</span><span class="op" id="5733416">[</span><span class="ident" id="5733417">dc</span><span class="op" id="5733419">]</span>&nbsp;<span class="op" id="5733421">=</span>&nbsp;<span class="ident" id="5733423">stack</span><span class="op" id="5733428">(</span><span class="op" id="5733429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733435">dc</span><span class="op" id="5733437">.</span><span class="ident" id="5733438">inUse</span>&nbsp;<span class="op" id="5733444">=</span>&nbsp;<span class="builtintype" id="5733446">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733454">for</span>&nbsp;<span class="ident" id="5733458">_</span><span class="op" id="5733459">,</span>&nbsp;<span class="ident" id="5733461">fn</span>&nbsp;<span class="op" id="5733464">:=</span>&nbsp;<span class="keyword" id="5733467">range</span>&nbsp;<span class="ident" id="5733473">dc</span><span class="op" id="5733475">.</span><span class="ident" id="5733476">onPut</span>&nbsp;<span class="op" id="5733482">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733486">fn</span><span class="op" id="5733488">(</span><span class="op" id="5733489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733495">dc</span><span class="op" id="5733497">.</span><span class="ident" id="5733498">onPut</span>&nbsp;<span class="op" id="5733504">=</span>&nbsp;<span class="ident" id="5733506">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733512">if</span>&nbsp;<span class="ident" id="5733515">err</span>&nbsp;<span class="op" id="5733519">==</span>&nbsp;<span class="ident" id="5733522">driver</span><span class="op" id="5733528">.</span><span class="ident" id="5733529">ErrBadConn</span>&nbsp;<span class="op" id="5733540">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5733544">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5733578">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5733649">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5733718">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733742">db</span><span class="op" id="5733744">.</span><span class="ident" id="5733745">maybeOpenNewConnections</span><span class="op" id="5733768">(</span><span class="op" id="5733769">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733773">db</span><span class="op" id="5733775">.</span><span class="ident" id="5733776">mu</span><span class="op" id="5733778">.</span><span class="ident" id="5733779">Unlock</span><span class="op" id="5733785">(</span><span class="op" id="5733786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733790">dc</span><span class="op" id="5733792">.</span><span class="ident" id="5733793">Close</span><span class="op" id="5733798">(</span><span class="op" id="5733799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733803">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733814">if</span>&nbsp;<span class="ident" id="5733817">putConnHook</span>&nbsp;<span class="op" id="5733829">!=</span>&nbsp;<span class="ident" id="5733832">nil</span>&nbsp;<span class="op" id="5733836">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733840">putConnHook</span><span class="op" id="5733851">(</span><span class="ident" id="5733852">db</span><span class="op" id="5733854">,</span>&nbsp;<span class="ident" id="5733856">dc</span><span class="op" id="5733858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733864">added</span>&nbsp;<span class="op" id="5733870">:=</span>&nbsp;<span class="ident" id="5733873">db</span><span class="op" id="5733875">.</span><span class="ident" id="5733876">putConnDBLocked</span><span class="op" id="5733891">(</span><span class="ident" id="5733892">dc</span><span class="op" id="5733894">,</span>&nbsp;<span class="ident" id="5733896">nil</span><span class="op" id="5733899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733902">db</span><span class="op" id="5733904">.</span><span class="ident" id="5733905">mu</span><span class="op" id="5733907">.</span><span class="ident" id="5733908">Unlock</span><span class="op" id="5733914">(</span><span class="op" id="5733915">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5733919">if</span>&nbsp;<span class="op" id="5733922">!</span><span class="ident" id="5733923">added</span>&nbsp;<span class="op" id="5733929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5733933">dc</span><span class="op" id="5733935">.</span><span class="ident" id="5733936">Close</span><span class="op" id="5733941">(</span><span class="op" id="5733942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5733945">}</span><br>
<span class="lineno"></span><span class="op" id="5733947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="5733950">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="5734030">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="5734050">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5734124">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5734198">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="5734240">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5734286">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5734332">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5734403">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5734473">func</span>&nbsp;<span class="op" id="5734478">(</span><span class="ident" id="5734479">db</span>&nbsp;<span class="op" id="5734482">*</span><span class="ident" id="5734483">DB</span><span class="op" id="5734485">)</span>&nbsp;<span class="ident" id="5734487">putConnDBLocked</span><span class="op" id="5734502">(</span><span class="ident" id="5734503">dc</span>&nbsp;<span class="op" id="5734506">*</span><span class="ident" id="5734507">driverConn</span><span class="op" id="5734517">,</span>&nbsp;<span class="ident" id="5734519">err</span>&nbsp;<span class="builtintype" id="5734523">error</span><span class="op" id="5734528">)</span>&nbsp;<span class="builtintype" id="5734530">bool</span>&nbsp;<span class="op" id="5734535">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5734538">if</span>&nbsp;<span class="ident" id="5734541">c</span>&nbsp;<span class="op" id="5734543">:=</span>&nbsp;<span class="builtinfunc" id="5734546">len</span><span class="op" id="5734549">(</span><span class="ident" id="5734550">db</span><span class="op" id="5734552">.</span><span class="ident" id="5734553">connRequests</span><span class="op" id="5734565">)</span><span class="op" id="5734566">;</span>&nbsp;<span class="ident" id="5734568">c</span>&nbsp;<span class="op" id="5734570">&gt;</span>&nbsp;<span class="num" id="5734572">0</span>&nbsp;<span class="op" id="5734574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734578">req</span>&nbsp;<span class="op" id="5734582">:=</span>&nbsp;<span class="ident" id="5734585">db</span><span class="op" id="5734587">.</span><span class="ident" id="5734588">connRequests</span><span class="op" id="5734600">[</span><span class="num" id="5734601">0</span><span class="op" id="5734602">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5734606">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5734672">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5734726">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5734756">copy</span><span class="op" id="5734760">(</span><span class="ident" id="5734761">db</span><span class="op" id="5734763">.</span><span class="ident" id="5734764">connRequests</span><span class="op" id="5734776">,</span>&nbsp;<span class="ident" id="5734778">db</span><span class="op" id="5734780">.</span><span class="ident" id="5734781">connRequests</span><span class="op" id="5734793">[</span><span class="num" id="5734794">1</span><span class="op" id="5734795">:</span><span class="op" id="5734796">]</span><span class="op" id="5734797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734801">db</span><span class="op" id="5734803">.</span><span class="ident" id="5734804">connRequests</span>&nbsp;<span class="op" id="5734817">=</span>&nbsp;<span class="ident" id="5734819">db</span><span class="op" id="5734821">.</span><span class="ident" id="5734822">connRequests</span><span class="op" id="5734834">[</span><span class="op" id="5734835">:</span><span class="ident" id="5734836">c</span><span class="op" id="5734837">-</span><span class="num" id="5734838">1</span><span class="op" id="5734839">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5734843">if</span>&nbsp;<span class="ident" id="5734846">err</span>&nbsp;<span class="op" id="5734850">==</span>&nbsp;<span class="ident" id="5734853">nil</span>&nbsp;<span class="op" id="5734857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734862">dc</span><span class="op" id="5734864">.</span><span class="ident" id="5734865">inUse</span>&nbsp;<span class="op" id="5734871">=</span>&nbsp;<span class="builtintype" id="5734873">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5734880">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734884">req</span>&nbsp;<span class="op" id="5734888">&lt;-</span>&nbsp;<span class="ident" id="5734891">connRequest</span><span class="op" id="5734902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734907">conn</span><span class="op" id="5734911">:</span>&nbsp;<span class="ident" id="5734913">dc</span><span class="op" id="5734915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5734920">err</span><span class="op" id="5734923">:</span>&nbsp;&nbsp;<span class="ident" id="5734926">err</span><span class="op" id="5734929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5734933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5734937">return</span>&nbsp;<span class="builtintype" id="5734944">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5734950">}</span>&nbsp;<span class="keyword" id="5734952">else</span>&nbsp;<span class="keyword" id="5734957">if</span>&nbsp;<span class="ident" id="5734960">err</span>&nbsp;<span class="op" id="5734964">==</span>&nbsp;<span class="ident" id="5734967">nil</span>&nbsp;<span class="op" id="5734971">&amp;&amp;</span>&nbsp;<span class="op" id="5734974">!</span><span class="ident" id="5734975">db</span><span class="op" id="5734977">.</span><span class="ident" id="5734978">closed</span>&nbsp;<span class="op" id="5734985">&amp;&amp;</span>&nbsp;<span class="ident" id="5734988">db</span><span class="op" id="5734990">.</span><span class="ident" id="5734991">maxIdleConnsLocked</span><span class="op" id="5735009">(</span><span class="op" id="5735010">)</span>&nbsp;<span class="op" id="5735012">&gt;</span>&nbsp;<span class="builtinfunc" id="5735014">len</span><span class="op" id="5735017">(</span><span class="ident" id="5735018">db</span><span class="op" id="5735020">.</span><span class="ident" id="5735021">freeConn</span><span class="op" id="5735029">)</span>&nbsp;<span class="op" id="5735031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5735035">db</span><span class="op" id="5735037">.</span><span class="ident" id="5735038">freeConn</span>&nbsp;<span class="op" id="5735047">=</span>&nbsp;<span class="builtinfunc" id="5735049">append</span><span class="op" id="5735055">(</span><span class="ident" id="5735056">db</span><span class="op" id="5735058">.</span><span class="ident" id="5735059">freeConn</span><span class="op" id="5735067">,</span>&nbsp;<span class="ident" id="5735069">dc</span><span class="op" id="5735071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735075">return</span>&nbsp;<span class="builtintype" id="5735082">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5735088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735091">return</span>&nbsp;<span class="builtintype" id="5735098">false</span><br>
<span class="lineno">820</span><span class="op" id="5735104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5735107">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5735183">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5735235">const</span>&nbsp;<span class="ident" id="5735241">maxBadConnRetries</span>&nbsp;<span class="op" id="5735259">=</span>&nbsp;<span class="num" id="5735261">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="5735265">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="5735338">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5735405">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5735428">func</span>&nbsp;<span class="op" id="5735433">(</span><span class="ident" id="5735434">db</span>&nbsp;<span class="op" id="5735437">*</span><span class="ident" id="5735438">DB</span><span class="op" id="5735440">)</span>&nbsp;<span class="ident" id="5735442">Prepare</span><span class="op" id="5735449">(</span><span class="ident" id="5735450">query</span>&nbsp;<span class="builtintype" id="5735456">string</span><span class="op" id="5735462">)</span>&nbsp;<span class="op" id="5735464">(</span><span class="op" id="5735465">*</span><span class="ident" id="5735466">Stmt</span><span class="op" id="5735470">,</span>&nbsp;<span class="builtintype" id="5735472">error</span><span class="op" id="5735477">)</span>&nbsp;<span class="op" id="5735479">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735482">var</span>&nbsp;<span class="ident" id="5735486">stmt</span>&nbsp;<span class="op" id="5735491">*</span><span class="ident" id="5735492">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735498">var</span>&nbsp;<span class="ident" id="5735502">err</span>&nbsp;<span class="builtintype" id="5735506">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735513">for</span>&nbsp;<span class="ident" id="5735517">i</span>&nbsp;<span class="op" id="5735519">:=</span>&nbsp;<span class="num" id="5735522">0</span><span class="op" id="5735523">;</span>&nbsp;<span class="ident" id="5735525">i</span>&nbsp;<span class="op" id="5735527">&lt;</span>&nbsp;<span class="ident" id="5735529">maxBadConnRetries</span><span class="op" id="5735546">;</span>&nbsp;<span class="ident" id="5735548">i</span><span class="op" id="5735549">++</span>&nbsp;<span class="op" id="5735552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5735556">stmt</span><span class="op" id="5735560">,</span>&nbsp;<span class="ident" id="5735562">err</span>&nbsp;<span class="op" id="5735566">=</span>&nbsp;<span class="ident" id="5735568">db</span><span class="op" id="5735570">.</span><span class="ident" id="5735571">prepare</span><span class="op" id="5735578">(</span><span class="ident" id="5735579">query</span><span class="op" id="5735584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735588">if</span>&nbsp;<span class="ident" id="5735591">err</span>&nbsp;<span class="op" id="5735595">!=</span>&nbsp;<span class="ident" id="5735598">driver</span><span class="op" id="5735604">.</span><span class="ident" id="5735605">ErrBadConn</span>&nbsp;<span class="op" id="5735616">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735621">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5735629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5735632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5735635">return</span>&nbsp;<span class="ident" id="5735642">stmt</span><span class="op" id="5735646">,</span>&nbsp;<span class="ident" id="5735648">err</span><br>
<span class="lineno"></span><span class="op" id="5735652">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="5735655">func</span>&nbsp;<span class="op" id="5735660">(</span><span class="ident" id="5735661">db</span>&nbsp;<span class="op" id="5735664">*</span><span class="ident" id="5735665">DB</span><span class="op" id="5735667">)</span>&nbsp;<span class="ident" id="5735669">prepare</span><span class="op" id="5735676">(</span><span class="ident" id="5735677">query</span>&nbsp;<span class="builtintype" id="5735683">string</span><span class="op" id="5735689">)</span>&nbsp;<span class="op" id="5735691">(</span><span class="op" id="5735692">*</span><span class="ident" id="5735693">Stmt</span><span class="op" id="5735697">,</span>&nbsp;<span class="builtintype" id="5735699">error</span><span class="op" id="5735704">)</span>&nbsp;<span class="op" id="5735706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5735709">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5735759">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5735819">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5735875">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5735935">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5735998">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736059">dc</span><span class="op" id="5736061">,</span>&nbsp;<span class="ident" id="5736063">err</span>&nbsp;<span class="op" id="5736067">:=</span>&nbsp;<span class="ident" id="5736070">db</span><span class="op" id="5736072">.</span><span class="ident" id="5736073">conn</span><span class="op" id="5736077">(</span><span class="op" id="5736078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736081">if</span>&nbsp;<span class="ident" id="5736084">err</span>&nbsp;<span class="op" id="5736088">!=</span>&nbsp;<span class="ident" id="5736091">nil</span>&nbsp;<span class="op" id="5736095">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736099">return</span>&nbsp;<span class="ident" id="5736106">nil</span><span class="op" id="5736109">,</span>&nbsp;<span class="ident" id="5736111">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736119">dc</span><span class="op" id="5736121">.</span><span class="ident" id="5736122">Lock</span><span class="op" id="5736126">(</span><span class="op" id="5736127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736130">si</span><span class="op" id="5736132">,</span>&nbsp;<span class="ident" id="5736134">err</span>&nbsp;<span class="op" id="5736138">:=</span>&nbsp;<span class="ident" id="5736141">dc</span><span class="op" id="5736143">.</span><span class="ident" id="5736144">prepareLocked</span><span class="op" id="5736157">(</span><span class="ident" id="5736158">query</span><span class="op" id="5736163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736166">dc</span><span class="op" id="5736168">.</span><span class="ident" id="5736169">Unlock</span><span class="op" id="5736175">(</span><span class="op" id="5736176">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736179">if</span>&nbsp;<span class="ident" id="5736182">err</span>&nbsp;<span class="op" id="5736186">!=</span>&nbsp;<span class="ident" id="5736189">nil</span>&nbsp;<span class="op" id="5736193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736197">db</span><span class="op" id="5736199">.</span><span class="ident" id="5736200">putConn</span><span class="op" id="5736207">(</span><span class="ident" id="5736208">dc</span><span class="op" id="5736210">,</span>&nbsp;<span class="ident" id="5736212">err</span><span class="op" id="5736215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736219">return</span>&nbsp;<span class="ident" id="5736226">nil</span><span class="op" id="5736229">,</span>&nbsp;<span class="ident" id="5736231">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736239">stmt</span>&nbsp;<span class="op" id="5736244">:=</span>&nbsp;<span class="op" id="5736247">&amp;</span><span class="ident" id="5736248">Stmt</span><span class="op" id="5736252">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736256">db</span><span class="op" id="5736258">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5736263">db</span><span class="op" id="5736265">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736269">query</span><span class="op" id="5736274">:</span>&nbsp;<span class="ident" id="5736276">query</span><span class="op" id="5736281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736285">css</span><span class="op" id="5736288">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5736292">[</span><span class="op" id="5736293">]</span><span class="ident" id="5736294">connStmt</span><span class="op" id="5736302">{</span><span class="op" id="5736303">{</span><span class="ident" id="5736304">dc</span><span class="op" id="5736306">,</span>&nbsp;<span class="ident" id="5736308">si</span><span class="op" id="5736310">}</span><span class="op" id="5736311">}</span><span class="op" id="5736312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736318">db</span><span class="op" id="5736320">.</span><span class="ident" id="5736321">addDep</span><span class="op" id="5736327">(</span><span class="ident" id="5736328">stmt</span><span class="op" id="5736332">,</span>&nbsp;<span class="ident" id="5736334">stmt</span><span class="op" id="5736338">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736341">db</span><span class="op" id="5736343">.</span><span class="ident" id="5736344">putConn</span><span class="op" id="5736351">(</span><span class="ident" id="5736352">dc</span><span class="op" id="5736354">,</span>&nbsp;<span class="ident" id="5736356">nil</span><span class="op" id="5736359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736362">return</span>&nbsp;<span class="ident" id="5736369">stmt</span><span class="op" id="5736373">,</span>&nbsp;<span class="ident" id="5736375">nil</span><br>
<span class="lineno"></span><span class="op" id="5736379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5736382">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="5736435">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="5736496">func</span>&nbsp;<span class="op" id="5736501">(</span><span class="ident" id="5736502">db</span>&nbsp;<span class="op" id="5736505">*</span><span class="ident" id="5736506">DB</span><span class="op" id="5736508">)</span>&nbsp;<span class="ident" id="5736510">Exec</span><span class="op" id="5736514">(</span><span class="ident" id="5736515">query</span>&nbsp;<span class="builtintype" id="5736521">string</span><span class="op" id="5736527">,</span>&nbsp;<span class="ident" id="5736529">args</span>&nbsp;<span class="op" id="5736534">...</span><span class="keyword" id="5736537">interface</span><span class="op" id="5736546">{</span><span class="op" id="5736547">}</span><span class="op" id="5736548">)</span>&nbsp;<span class="op" id="5736550">(</span><span class="ident" id="5736551">Result</span><span class="op" id="5736557">,</span>&nbsp;<span class="builtintype" id="5736559">error</span><span class="op" id="5736564">)</span>&nbsp;<span class="op" id="5736566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736569">var</span>&nbsp;<span class="ident" id="5736573">res</span>&nbsp;<span class="ident" id="5736577">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736585">var</span>&nbsp;<span class="ident" id="5736589">err</span>&nbsp;<span class="builtintype" id="5736593">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736600">for</span>&nbsp;<span class="ident" id="5736604">i</span>&nbsp;<span class="op" id="5736606">:=</span>&nbsp;<span class="num" id="5736609">0</span><span class="op" id="5736610">;</span>&nbsp;<span class="ident" id="5736612">i</span>&nbsp;<span class="op" id="5736614">&lt;</span>&nbsp;<span class="ident" id="5736616">maxBadConnRetries</span><span class="op" id="5736633">;</span>&nbsp;<span class="ident" id="5736635">i</span><span class="op" id="5736636">++</span>&nbsp;<span class="op" id="5736639">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736643">res</span><span class="op" id="5736646">,</span>&nbsp;<span class="ident" id="5736648">err</span>&nbsp;<span class="op" id="5736652">=</span>&nbsp;<span class="ident" id="5736654">db</span><span class="op" id="5736656">.</span><span class="ident" id="5736657">exec</span><span class="op" id="5736661">(</span><span class="ident" id="5736662">query</span><span class="op" id="5736667">,</span>&nbsp;<span class="ident" id="5736669">args</span><span class="op" id="5736673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736677">if</span>&nbsp;<span class="ident" id="5736680">err</span>&nbsp;<span class="op" id="5736684">!=</span>&nbsp;<span class="ident" id="5736687">driver</span><span class="op" id="5736693">.</span><span class="ident" id="5736694">ErrBadConn</span>&nbsp;<span class="op" id="5736705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736710">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736721">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736724">return</span>&nbsp;<span class="ident" id="5736731">res</span><span class="op" id="5736734">,</span>&nbsp;<span class="ident" id="5736736">err</span><br>
<span class="lineno"></span><span class="op" id="5736740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5736743">func</span>&nbsp;<span class="op" id="5736748">(</span><span class="ident" id="5736749">db</span>&nbsp;<span class="op" id="5736752">*</span><span class="ident" id="5736753">DB</span><span class="op" id="5736755">)</span>&nbsp;<span class="ident" id="5736757">exec</span><span class="op" id="5736761">(</span><span class="ident" id="5736762">query</span>&nbsp;<span class="builtintype" id="5736768">string</span><span class="op" id="5736774">,</span>&nbsp;<span class="ident" id="5736776">args</span>&nbsp;<span class="op" id="5736781">[</span><span class="op" id="5736782">]</span><span class="keyword" id="5736783">interface</span><span class="op" id="5736792">{</span><span class="op" id="5736793">}</span><span class="op" id="5736794">)</span>&nbsp;<span class="op" id="5736796">(</span><span class="ident" id="5736797">res</span>&nbsp;<span class="ident" id="5736801">Result</span><span class="op" id="5736807">,</span>&nbsp;<span class="ident" id="5736809">err</span>&nbsp;<span class="builtintype" id="5736813">error</span><span class="op" id="5736818">)</span>&nbsp;<span class="op" id="5736820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736823">dc</span><span class="op" id="5736825">,</span>&nbsp;<span class="ident" id="5736827">err</span>&nbsp;<span class="op" id="5736831">:=</span>&nbsp;<span class="ident" id="5736834">db</span><span class="op" id="5736836">.</span><span class="ident" id="5736837">conn</span><span class="op" id="5736841">(</span><span class="op" id="5736842">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736845">if</span>&nbsp;<span class="ident" id="5736848">err</span>&nbsp;<span class="op" id="5736852">!=</span>&nbsp;<span class="ident" id="5736855">nil</span>&nbsp;<span class="op" id="5736859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736863">return</span>&nbsp;<span class="ident" id="5736870">nil</span><span class="op" id="5736873">,</span>&nbsp;<span class="ident" id="5736875">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736883">defer</span>&nbsp;<span class="keyword" id="5736889">func</span><span class="op" id="5736893">(</span><span class="op" id="5736894">)</span>&nbsp;<span class="op" id="5736896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736900">db</span><span class="op" id="5736902">.</span><span class="ident" id="5736903">putConn</span><span class="op" id="5736910">(</span><span class="ident" id="5736911">dc</span><span class="op" id="5736913">,</span>&nbsp;<span class="ident" id="5736915">err</span><span class="op" id="5736918">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5736921">}</span><span class="op" id="5736922">(</span><span class="op" id="5736923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5736927">if</span>&nbsp;<span class="ident" id="5736930">execer</span><span class="op" id="5736936">,</span>&nbsp;<span class="ident" id="5736938">ok</span>&nbsp;<span class="op" id="5736941">:=</span>&nbsp;<span class="ident" id="5736944">dc</span><span class="op" id="5736946">.</span><span class="ident" id="5736947">ci</span><span class="op" id="5736949">.</span><span class="op" id="5736950">(</span><span class="ident" id="5736951">driver</span><span class="op" id="5736957">.</span><span class="ident" id="5736958">Execer</span><span class="op" id="5736964">)</span><span class="op" id="5736965">;</span>&nbsp;<span class="ident" id="5736967">ok</span>&nbsp;<span class="op" id="5736970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5736974">dargs</span><span class="op" id="5736979">,</span>&nbsp;<span class="ident" id="5736981">err</span>&nbsp;<span class="op" id="5736985">:=</span>&nbsp;<span class="ident" id="5736988">driverArgs</span><span class="op" id="5736998">(</span><span class="ident" id="5736999">nil</span><span class="op" id="5737002">,</span>&nbsp;<span class="ident" id="5737004">args</span><span class="op" id="5737008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737012">if</span>&nbsp;<span class="ident" id="5737015">err</span>&nbsp;<span class="op" id="5737019">!=</span>&nbsp;<span class="ident" id="5737022">nil</span>&nbsp;<span class="op" id="5737026">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737031">return</span>&nbsp;<span class="ident" id="5737038">nil</span><span class="op" id="5737041">,</span>&nbsp;<span class="ident" id="5737043">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737053">dc</span><span class="op" id="5737055">.</span><span class="ident" id="5737056">Lock</span><span class="op" id="5737060">(</span><span class="op" id="5737061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737065">resi</span><span class="op" id="5737069">,</span>&nbsp;<span class="ident" id="5737071">err</span>&nbsp;<span class="op" id="5737075">:=</span>&nbsp;<span class="ident" id="5737078">execer</span><span class="op" id="5737084">.</span><span class="ident" id="5737085">Exec</span><span class="op" id="5737089">(</span><span class="ident" id="5737090">query</span><span class="op" id="5737095">,</span>&nbsp;<span class="ident" id="5737097">dargs</span><span class="op" id="5737102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737106">dc</span><span class="op" id="5737108">.</span><span class="ident" id="5737109">Unlock</span><span class="op" id="5737115">(</span><span class="op" id="5737116">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737120">if</span>&nbsp;<span class="ident" id="5737123">err</span>&nbsp;<span class="op" id="5737127">!=</span>&nbsp;<span class="ident" id="5737130">driver</span><span class="op" id="5737136">.</span><span class="ident" id="5737137">ErrSkip</span>&nbsp;<span class="op" id="5737145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737150">if</span>&nbsp;<span class="ident" id="5737153">err</span>&nbsp;<span class="op" id="5737157">!=</span>&nbsp;<span class="ident" id="5737160">nil</span>&nbsp;<span class="op" id="5737164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737170">return</span>&nbsp;<span class="ident" id="5737177">nil</span><span class="op" id="5737180">,</span>&nbsp;<span class="ident" id="5737182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737194">return</span>&nbsp;<span class="ident" id="5737201">driverResult</span><span class="op" id="5737213">{</span><span class="ident" id="5737214">dc</span><span class="op" id="5737216">,</span>&nbsp;<span class="ident" id="5737218">resi</span><span class="op" id="5737222">}</span><span class="op" id="5737223">,</span>&nbsp;<span class="ident" id="5737225">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737238">dc</span><span class="op" id="5737240">.</span><span class="ident" id="5737241">Lock</span><span class="op" id="5737245">(</span><span class="op" id="5737246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737249">si</span><span class="op" id="5737251">,</span>&nbsp;<span class="ident" id="5737253">err</span>&nbsp;<span class="op" id="5737257">:=</span>&nbsp;<span class="ident" id="5737260">dc</span><span class="op" id="5737262">.</span><span class="ident" id="5737263">ci</span><span class="op" id="5737265">.</span><span class="ident" id="5737266">Prepare</span><span class="op" id="5737273">(</span><span class="ident" id="5737274">query</span><span class="op" id="5737279">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737282">dc</span><span class="op" id="5737284">.</span><span class="ident" id="5737285">Unlock</span><span class="op" id="5737291">(</span><span class="op" id="5737292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737295">if</span>&nbsp;<span class="ident" id="5737298">err</span>&nbsp;<span class="op" id="5737302">!=</span>&nbsp;<span class="ident" id="5737305">nil</span>&nbsp;<span class="op" id="5737309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737313">return</span>&nbsp;<span class="ident" id="5737320">nil</span><span class="op" id="5737323">,</span>&nbsp;<span class="ident" id="5737325">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737333">defer</span>&nbsp;<span class="ident" id="5737339">withLock</span><span class="op" id="5737347">(</span><span class="ident" id="5737348">dc</span><span class="op" id="5737350">,</span>&nbsp;<span class="keyword" id="5737352">func</span><span class="op" id="5737356">(</span><span class="op" id="5737357">)</span>&nbsp;<span class="op" id="5737359">{</span>&nbsp;<span class="ident" id="5737361">si</span><span class="op" id="5737363">.</span><span class="ident" id="5737364">Close</span><span class="op" id="5737369">(</span><span class="op" id="5737370">)</span>&nbsp;<span class="op" id="5737372">}</span><span class="op" id="5737373">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737376">return</span>&nbsp;<span class="ident" id="5737383">resultFromStatement</span><span class="op" id="5737402">(</span><span class="ident" id="5737403">driverStmt</span><span class="op" id="5737413">{</span><span class="ident" id="5737414">dc</span><span class="op" id="5737416">,</span>&nbsp;<span class="ident" id="5737418">si</span><span class="op" id="5737420">}</span><span class="op" id="5737421">,</span>&nbsp;<span class="ident" id="5737423">args</span><span class="op" id="5737427">...</span><span class="op" id="5737430">)</span><br>
<span class="lineno"></span><span class="op" id="5737432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5737435">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="5737500">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="5737561">func</span>&nbsp;<span class="op" id="5737566">(</span><span class="ident" id="5737567">db</span>&nbsp;<span class="op" id="5737570">*</span><span class="ident" id="5737571">DB</span><span class="op" id="5737573">)</span>&nbsp;<span class="ident" id="5737575">Query</span><span class="op" id="5737580">(</span><span class="ident" id="5737581">query</span>&nbsp;<span class="builtintype" id="5737587">string</span><span class="op" id="5737593">,</span>&nbsp;<span class="ident" id="5737595">args</span>&nbsp;<span class="op" id="5737600">...</span><span class="keyword" id="5737603">interface</span><span class="op" id="5737612">{</span><span class="op" id="5737613">}</span><span class="op" id="5737614">)</span>&nbsp;<span class="op" id="5737616">(</span><span class="op" id="5737617">*</span><span class="ident" id="5737618">Rows</span><span class="op" id="5737622">,</span>&nbsp;<span class="builtintype" id="5737624">error</span><span class="op" id="5737629">)</span>&nbsp;<span class="op" id="5737631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737634">var</span>&nbsp;<span class="ident" id="5737638">rows</span>&nbsp;<span class="op" id="5737643">*</span><span class="ident" id="5737644">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737650">var</span>&nbsp;<span class="ident" id="5737654">err</span>&nbsp;<span class="builtintype" id="5737658">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737665">for</span>&nbsp;<span class="ident" id="5737669">i</span>&nbsp;<span class="op" id="5737671">:=</span>&nbsp;<span class="num" id="5737674">0</span><span class="op" id="5737675">;</span>&nbsp;<span class="ident" id="5737677">i</span>&nbsp;<span class="op" id="5737679">&lt;</span>&nbsp;<span class="ident" id="5737681">maxBadConnRetries</span><span class="op" id="5737698">;</span>&nbsp;<span class="ident" id="5737700">i</span><span class="op" id="5737701">++</span>&nbsp;<span class="op" id="5737704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737708">rows</span><span class="op" id="5737712">,</span>&nbsp;<span class="ident" id="5737714">err</span>&nbsp;<span class="op" id="5737718">=</span>&nbsp;<span class="ident" id="5737720">db</span><span class="op" id="5737722">.</span><span class="ident" id="5737723">query</span><span class="op" id="5737728">(</span><span class="ident" id="5737729">query</span><span class="op" id="5737734">,</span>&nbsp;<span class="ident" id="5737736">args</span><span class="op" id="5737740">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737744">if</span>&nbsp;<span class="ident" id="5737747">err</span>&nbsp;<span class="op" id="5737751">!=</span>&nbsp;<span class="ident" id="5737754">driver</span><span class="op" id="5737760">.</span><span class="ident" id="5737761">ErrBadConn</span>&nbsp;<span class="op" id="5737772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737777">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737791">return</span>&nbsp;<span class="ident" id="5737798">rows</span><span class="op" id="5737802">,</span>&nbsp;<span class="ident" id="5737804">err</span><br>
<span class="lineno">930</span><span class="op" id="5737808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5737811">func</span>&nbsp;<span class="op" id="5737816">(</span><span class="ident" id="5737817">db</span>&nbsp;<span class="op" id="5737820">*</span><span class="ident" id="5737821">DB</span><span class="op" id="5737823">)</span>&nbsp;<span class="ident" id="5737825">query</span><span class="op" id="5737830">(</span><span class="ident" id="5737831">query</span>&nbsp;<span class="builtintype" id="5737837">string</span><span class="op" id="5737843">,</span>&nbsp;<span class="ident" id="5737845">args</span>&nbsp;<span class="op" id="5737850">[</span><span class="op" id="5737851">]</span><span class="keyword" id="5737852">interface</span><span class="op" id="5737861">{</span><span class="op" id="5737862">}</span><span class="op" id="5737863">)</span>&nbsp;<span class="op" id="5737865">(</span><span class="op" id="5737866">*</span><span class="ident" id="5737867">Rows</span><span class="op" id="5737871">,</span>&nbsp;<span class="builtintype" id="5737873">error</span><span class="op" id="5737878">)</span>&nbsp;<span class="op" id="5737880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5737883">ci</span><span class="op" id="5737885">,</span>&nbsp;<span class="ident" id="5737887">err</span>&nbsp;<span class="op" id="5737891">:=</span>&nbsp;<span class="ident" id="5737894">db</span><span class="op" id="5737896">.</span><span class="ident" id="5737897">conn</span><span class="op" id="5737901">(</span><span class="op" id="5737902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737905">if</span>&nbsp;<span class="ident" id="5737908">err</span>&nbsp;<span class="op" id="5737912">!=</span>&nbsp;<span class="ident" id="5737915">nil</span>&nbsp;<span class="op" id="5737919">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737923">return</span>&nbsp;<span class="ident" id="5737930">nil</span><span class="op" id="5737933">,</span>&nbsp;<span class="ident" id="5737935">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5737940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5737944">return</span>&nbsp;<span class="ident" id="5737951">db</span><span class="op" id="5737953">.</span><span class="ident" id="5737954">queryConn</span><span class="op" id="5737963">(</span><span class="ident" id="5737964">ci</span><span class="op" id="5737966">,</span>&nbsp;<span class="ident" id="5737968">ci</span><span class="op" id="5737970">.</span><span class="ident" id="5737971">releaseConn</span><span class="op" id="5737982">,</span>&nbsp;<span class="ident" id="5737984">query</span><span class="op" id="5737989">,</span>&nbsp;<span class="ident" id="5737991">args</span><span class="op" id="5737995">)</span><br>
<span class="lineno"></span><span class="op" id="5737997">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="5738000">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5738055">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="5738116">func</span>&nbsp;<span class="op" id="5738121">(</span><span class="ident" id="5738122">db</span>&nbsp;<span class="op" id="5738125">*</span><span class="ident" id="5738126">DB</span><span class="op" id="5738128">)</span>&nbsp;<span class="ident" id="5738130">queryConn</span><span class="op" id="5738139">(</span><span class="ident" id="5738140">dc</span>&nbsp;<span class="op" id="5738143">*</span><span class="ident" id="5738144">driverConn</span><span class="op" id="5738154">,</span>&nbsp;<span class="ident" id="5738156">releaseConn</span>&nbsp;<span class="keyword" id="5738168">func</span><span class="op" id="5738172">(</span><span class="builtintype" id="5738173">error</span><span class="op" id="5738178">)</span><span class="op" id="5738179">,</span>&nbsp;<span class="ident" id="5738181">query</span>&nbsp;<span class="builtintype" id="5738187">string</span><span class="op" id="5738193">,</span>&nbsp;<span class="ident" id="5738195">args</span>&nbsp;<span class="op" id="5738200">[</span><span class="op" id="5738201">]</span><span class="keyword" id="5738202">interface</span><span class="op" id="5738211">{</span><span class="op" id="5738212">}</span><span class="op" id="5738213">)</span>&nbsp;<span class="op" id="5738215">(</span><span class="op" id="5738216">*</span><span class="ident" id="5738217">Rows</span><span class="op" id="5738221">,</span>&nbsp;<span class="builtintype" id="5738223">error</span><span class="op" id="5738228">)</span>&nbsp;<span class="op" id="5738230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738233">if</span>&nbsp;<span class="ident" id="5738236">queryer</span><span class="op" id="5738243">,</span>&nbsp;<span class="ident" id="5738245">ok</span>&nbsp;<span class="op" id="5738248">:=</span>&nbsp;<span class="ident" id="5738251">dc</span><span class="op" id="5738253">.</span><span class="ident" id="5738254">ci</span><span class="op" id="5738256">.</span><span class="op" id="5738257">(</span><span class="ident" id="5738258">driver</span><span class="op" id="5738264">.</span><span class="ident" id="5738265">Queryer</span><span class="op" id="5738272">)</span><span class="op" id="5738273">;</span>&nbsp;<span class="ident" id="5738275">ok</span>&nbsp;<span class="op" id="5738278">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738282">dargs</span><span class="op" id="5738287">,</span>&nbsp;<span class="ident" id="5738289">err</span>&nbsp;<span class="op" id="5738293">:=</span>&nbsp;<span class="ident" id="5738296">driverArgs</span><span class="op" id="5738306">(</span><span class="ident" id="5738307">nil</span><span class="op" id="5738310">,</span>&nbsp;<span class="ident" id="5738312">args</span><span class="op" id="5738316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738320">if</span>&nbsp;<span class="ident" id="5738323">err</span>&nbsp;<span class="op" id="5738327">!=</span>&nbsp;<span class="ident" id="5738330">nil</span>&nbsp;<span class="op" id="5738334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738339">releaseConn</span><span class="op" id="5738350">(</span><span class="ident" id="5738351">err</span><span class="op" id="5738354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738359">return</span>&nbsp;<span class="ident" id="5738366">nil</span><span class="op" id="5738369">,</span>&nbsp;<span class="ident" id="5738371">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5738377">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738381">dc</span><span class="op" id="5738383">.</span><span class="ident" id="5738384">Lock</span><span class="op" id="5738388">(</span><span class="op" id="5738389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738393">rowsi</span><span class="op" id="5738398">,</span>&nbsp;<span class="ident" id="5738400">err</span>&nbsp;<span class="op" id="5738404">:=</span>&nbsp;<span class="ident" id="5738407">queryer</span><span class="op" id="5738414">.</span><span class="ident" id="5738415">Query</span><span class="op" id="5738420">(</span><span class="ident" id="5738421">query</span><span class="op" id="5738426">,</span>&nbsp;<span class="ident" id="5738428">dargs</span><span class="op" id="5738433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738437">dc</span><span class="op" id="5738439">.</span><span class="ident" id="5738440">Unlock</span><span class="op" id="5738446">(</span><span class="op" id="5738447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738451">if</span>&nbsp;<span class="ident" id="5738454">err</span>&nbsp;<span class="op" id="5738458">!=</span>&nbsp;<span class="ident" id="5738461">driver</span><span class="op" id="5738467">.</span><span class="ident" id="5738468">ErrSkip</span>&nbsp;<span class="op" id="5738476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738481">if</span>&nbsp;<span class="ident" id="5738484">err</span>&nbsp;<span class="op" id="5738488">!=</span>&nbsp;<span class="ident" id="5738491">nil</span>&nbsp;<span class="op" id="5738495">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738501">releaseConn</span><span class="op" id="5738512">(</span><span class="ident" id="5738513">err</span><span class="op" id="5738516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738522">return</span>&nbsp;<span class="ident" id="5738529">nil</span><span class="op" id="5738532">,</span>&nbsp;<span class="ident" id="5738534">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5738541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738546">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5738607">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738631">rows</span>&nbsp;<span class="op" id="5738636">:=</span>&nbsp;<span class="op" id="5738639">&amp;</span><span class="ident" id="5738640">Rows</span><span class="op" id="5738644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738650">dc</span><span class="op" id="5738652">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5738663">dc</span><span class="op" id="5738665">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738671">releaseConn</span><span class="op" id="5738682">:</span>&nbsp;<span class="ident" id="5738684">releaseConn</span><span class="op" id="5738695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738701">rowsi</span><span class="op" id="5738706">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5738714">rowsi</span><span class="op" id="5738719">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5738724">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738729">return</span>&nbsp;<span class="ident" id="5738736">rows</span><span class="op" id="5738740">,</span>&nbsp;<span class="ident" id="5738742">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5738748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5738751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738755">dc</span><span class="op" id="5738757">.</span><span class="ident" id="5738758">Lock</span><span class="op" id="5738762">(</span><span class="op" id="5738763">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738766">si</span><span class="op" id="5738768">,</span>&nbsp;<span class="ident" id="5738770">err</span>&nbsp;<span class="op" id="5738774">:=</span>&nbsp;<span class="ident" id="5738777">dc</span><span class="op" id="5738779">.</span><span class="ident" id="5738780">ci</span><span class="op" id="5738782">.</span><span class="ident" id="5738783">Prepare</span><span class="op" id="5738790">(</span><span class="ident" id="5738791">query</span><span class="op" id="5738796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738799">dc</span><span class="op" id="5738801">.</span><span class="ident" id="5738802">Unlock</span><span class="op" id="5738808">(</span><span class="op" id="5738809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738812">if</span>&nbsp;<span class="ident" id="5738815">err</span>&nbsp;<span class="op" id="5738819">!=</span>&nbsp;<span class="ident" id="5738822">nil</span>&nbsp;<span class="op" id="5738826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738830">releaseConn</span><span class="op" id="5738841">(</span><span class="ident" id="5738842">err</span><span class="op" id="5738845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738849">return</span>&nbsp;<span class="ident" id="5738856">nil</span><span class="op" id="5738859">,</span>&nbsp;<span class="ident" id="5738861">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5738866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738870">ds</span>&nbsp;<span class="op" id="5738873">:=</span>&nbsp;<span class="ident" id="5738876">driverStmt</span><span class="op" id="5738886">{</span><span class="ident" id="5738887">dc</span><span class="op" id="5738889">,</span>&nbsp;<span class="ident" id="5738891">si</span><span class="op" id="5738893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738896">rowsi</span><span class="op" id="5738901">,</span>&nbsp;<span class="ident" id="5738903">err</span>&nbsp;<span class="op" id="5738907">:=</span>&nbsp;<span class="ident" id="5738910">rowsiFromStatement</span><span class="op" id="5738928">(</span><span class="ident" id="5738929">ds</span><span class="op" id="5738931">,</span>&nbsp;<span class="ident" id="5738933">args</span><span class="op" id="5738937">...</span><span class="op" id="5738940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5738943">if</span>&nbsp;<span class="ident" id="5738946">err</span>&nbsp;<span class="op" id="5738950">!=</span>&nbsp;<span class="ident" id="5738953">nil</span>&nbsp;<span class="op" id="5738957">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738961">dc</span><span class="op" id="5738963">.</span><span class="ident" id="5738964">Lock</span><span class="op" id="5738968">(</span><span class="op" id="5738969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738973">si</span><span class="op" id="5738975">.</span><span class="ident" id="5738976">Close</span><span class="op" id="5738981">(</span><span class="op" id="5738982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5738986">dc</span><span class="op" id="5738988">.</span><span class="ident" id="5738989">Unlock</span><span class="op" id="5738995">(</span><span class="op" id="5738996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739000">releaseConn</span><span class="op" id="5739011">(</span><span class="ident" id="5739012">err</span><span class="op" id="5739015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739019">return</span>&nbsp;<span class="ident" id="5739026">nil</span><span class="op" id="5739029">,</span>&nbsp;<span class="ident" id="5739031">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739040">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5739099">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739121">rows</span>&nbsp;<span class="op" id="5739126">:=</span>&nbsp;<span class="op" id="5739129">&amp;</span><span class="ident" id="5739130">Rows</span><span class="op" id="5739134">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739138">dc</span><span class="op" id="5739140">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5739151">dc</span><span class="op" id="5739153">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739157">releaseConn</span><span class="op" id="5739168">:</span>&nbsp;<span class="ident" id="5739170">releaseConn</span><span class="op" id="5739181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739185">rowsi</span><span class="op" id="5739190">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5739198">rowsi</span><span class="op" id="5739203">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739207">closeStmt</span><span class="op" id="5739216">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5739220">si</span><span class="op" id="5739222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739225">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739228">return</span>&nbsp;<span class="ident" id="5739235">rows</span><span class="op" id="5739239">,</span>&nbsp;<span class="ident" id="5739241">nil</span><br>
<span class="lineno"></span><span class="op" id="5739245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5739248">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5739321">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="5739390">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="5739422">func</span>&nbsp;<span class="op" id="5739427">(</span><span class="ident" id="5739428">db</span>&nbsp;<span class="op" id="5739431">*</span><span class="ident" id="5739432">DB</span><span class="op" id="5739434">)</span>&nbsp;<span class="ident" id="5739436">QueryRow</span><span class="op" id="5739444">(</span><span class="ident" id="5739445">query</span>&nbsp;<span class="builtintype" id="5739451">string</span><span class="op" id="5739457">,</span>&nbsp;<span class="ident" id="5739459">args</span>&nbsp;<span class="op" id="5739464">...</span><span class="keyword" id="5739467">interface</span><span class="op" id="5739476">{</span><span class="op" id="5739477">}</span><span class="op" id="5739478">)</span>&nbsp;<span class="op" id="5739480">*</span><span class="ident" id="5739481">Row</span>&nbsp;<span class="op" id="5739485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739488">rows</span><span class="op" id="5739492">,</span>&nbsp;<span class="ident" id="5739494">err</span>&nbsp;<span class="op" id="5739498">:=</span>&nbsp;<span class="ident" id="5739501">db</span><span class="op" id="5739503">.</span><span class="ident" id="5739504">Query</span><span class="op" id="5739509">(</span><span class="ident" id="5739510">query</span><span class="op" id="5739515">,</span>&nbsp;<span class="ident" id="5739517">args</span><span class="op" id="5739521">...</span><span class="op" id="5739524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739527">return</span>&nbsp;<span class="op" id="5739534">&amp;</span><span class="ident" id="5739535">Row</span><span class="op" id="5739538">{</span><span class="ident" id="5739539">rows</span><span class="op" id="5739543">:</span>&nbsp;<span class="ident" id="5739545">rows</span><span class="op" id="5739549">,</span>&nbsp;<span class="ident" id="5739551">err</span><span class="op" id="5739554">:</span>&nbsp;<span class="ident" id="5739556">err</span><span class="op" id="5739559">}</span><br>
<span class="lineno"></span><span class="op" id="5739561">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="5739564">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5739631">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="5739646">func</span>&nbsp;<span class="op" id="5739651">(</span><span class="ident" id="5739652">db</span>&nbsp;<span class="op" id="5739655">*</span><span class="ident" id="5739656">DB</span><span class="op" id="5739658">)</span>&nbsp;<span class="ident" id="5739660">Begin</span><span class="op" id="5739665">(</span><span class="op" id="5739666">)</span>&nbsp;<span class="op" id="5739668">(</span><span class="op" id="5739669">*</span><span class="ident" id="5739670">Tx</span><span class="op" id="5739672">,</span>&nbsp;<span class="builtintype" id="5739674">error</span><span class="op" id="5739679">)</span>&nbsp;<span class="op" id="5739681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739684">var</span>&nbsp;<span class="ident" id="5739688">tx</span>&nbsp;<span class="op" id="5739691">*</span><span class="ident" id="5739692">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739696">var</span>&nbsp;<span class="ident" id="5739700">err</span>&nbsp;<span class="builtintype" id="5739704">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739711">for</span>&nbsp;<span class="ident" id="5739715">i</span>&nbsp;<span class="op" id="5739717">:=</span>&nbsp;<span class="num" id="5739720">0</span><span class="op" id="5739721">;</span>&nbsp;<span class="ident" id="5739723">i</span>&nbsp;<span class="op" id="5739725">&lt;</span>&nbsp;<span class="ident" id="5739727">maxBadConnRetries</span><span class="op" id="5739744">;</span>&nbsp;<span class="ident" id="5739746">i</span><span class="op" id="5739747">++</span>&nbsp;<span class="op" id="5739750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739754">tx</span><span class="op" id="5739756">,</span>&nbsp;<span class="ident" id="5739758">err</span>&nbsp;<span class="op" id="5739762">=</span>&nbsp;<span class="ident" id="5739764">db</span><span class="op" id="5739766">.</span><span class="ident" id="5739767">begin</span><span class="op" id="5739772">(</span><span class="op" id="5739773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739777">if</span>&nbsp;<span class="ident" id="5739780">err</span>&nbsp;<span class="op" id="5739784">!=</span>&nbsp;<span class="ident" id="5739787">driver</span><span class="op" id="5739793">.</span><span class="ident" id="5739794">ErrBadConn</span>&nbsp;<span class="op" id="5739805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739810">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739824">return</span>&nbsp;<span class="ident" id="5739831">tx</span><span class="op" id="5739833">,</span>&nbsp;<span class="ident" id="5739835">err</span><br>
<span class="lineno"></span><span class="op" id="5739839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="5739842">func</span>&nbsp;<span class="op" id="5739847">(</span><span class="ident" id="5739848">db</span>&nbsp;<span class="op" id="5739851">*</span><span class="ident" id="5739852">DB</span><span class="op" id="5739854">)</span>&nbsp;<span class="ident" id="5739856">begin</span><span class="op" id="5739861">(</span><span class="op" id="5739862">)</span>&nbsp;<span class="op" id="5739864">(</span><span class="ident" id="5739865">tx</span>&nbsp;<span class="op" id="5739868">*</span><span class="ident" id="5739869">Tx</span><span class="op" id="5739871">,</span>&nbsp;<span class="ident" id="5739873">err</span>&nbsp;<span class="builtintype" id="5739877">error</span><span class="op" id="5739882">)</span>&nbsp;<span class="op" id="5739884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739887">dc</span><span class="op" id="5739889">,</span>&nbsp;<span class="ident" id="5739891">err</span>&nbsp;<span class="op" id="5739895">:=</span>&nbsp;<span class="ident" id="5739898">db</span><span class="op" id="5739900">.</span><span class="ident" id="5739901">conn</span><span class="op" id="5739905">(</span><span class="op" id="5739906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739909">if</span>&nbsp;<span class="ident" id="5739912">err</span>&nbsp;<span class="op" id="5739916">!=</span>&nbsp;<span class="ident" id="5739919">nil</span>&nbsp;<span class="op" id="5739923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739927">return</span>&nbsp;<span class="ident" id="5739934">nil</span><span class="op" id="5739937">,</span>&nbsp;<span class="ident" id="5739939">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5739944">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739947">dc</span><span class="op" id="5739949">.</span><span class="ident" id="5739950">Lock</span><span class="op" id="5739954">(</span><span class="op" id="5739955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739958">txi</span><span class="op" id="5739961">,</span>&nbsp;<span class="ident" id="5739963">err</span>&nbsp;<span class="op" id="5739967">:=</span>&nbsp;<span class="ident" id="5739970">dc</span><span class="op" id="5739972">.</span><span class="ident" id="5739973">ci</span><span class="op" id="5739975">.</span><span class="ident" id="5739976">Begin</span><span class="op" id="5739981">(</span><span class="op" id="5739982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5739985">dc</span><span class="op" id="5739987">.</span><span class="ident" id="5739988">Unlock</span><span class="op" id="5739994">(</span><span class="op" id="5739995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5739998">if</span>&nbsp;<span class="ident" id="5740001">err</span>&nbsp;<span class="op" id="5740005">!=</span>&nbsp;<span class="ident" id="5740008">nil</span>&nbsp;<span class="op" id="5740012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740016">db</span><span class="op" id="5740018">.</span><span class="ident" id="5740019">putConn</span><span class="op" id="5740026">(</span><span class="ident" id="5740027">dc</span><span class="op" id="5740029">,</span>&nbsp;<span class="ident" id="5740031">err</span><span class="op" id="5740034">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740038">return</span>&nbsp;<span class="ident" id="5740045">nil</span><span class="op" id="5740048">,</span>&nbsp;<span class="ident" id="5740050">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5740055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740058">return</span>&nbsp;<span class="op" id="5740065">&amp;</span><span class="ident" id="5740066">Tx</span><span class="op" id="5740068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740072">db</span><span class="op" id="5740074">:</span>&nbsp;&nbsp;<span class="ident" id="5740077">db</span><span class="op" id="5740079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740083">dc</span><span class="op" id="5740085">:</span>&nbsp;&nbsp;<span class="ident" id="5740088">dc</span><span class="op" id="5740090">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740094">txi</span><span class="op" id="5740097">:</span>&nbsp;<span class="ident" id="5740099">txi</span><span class="op" id="5740102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5740105">}</span><span class="op" id="5740106">,</span>&nbsp;<span class="ident" id="5740108">nil</span><br>
<span class="lineno"></span><span class="op" id="5740112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5740115">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="5740167">func</span>&nbsp;<span class="op" id="5740172">(</span><span class="ident" id="5740173">db</span>&nbsp;<span class="op" id="5740176">*</span><span class="ident" id="5740177">DB</span><span class="op" id="5740179">)</span>&nbsp;<span class="ident" id="5740181">Driver</span><span class="op" id="5740187">(</span><span class="op" id="5740188">)</span>&nbsp;<span class="ident" id="5740190">driver</span><span class="op" id="5740196">.</span><span class="ident" id="5740197">Driver</span>&nbsp;<span class="op" id="5740204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5740207">return</span>&nbsp;<span class="ident" id="5740214">db</span><span class="op" id="5740216">.</span><span class="ident" id="5740217">driver</span><br>
<span class="lineno"></span><span class="op" id="5740224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5740227">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="5740273">//</span><br>
<span class="lineno"></span><span class="comment" id="5740276">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="5740337">//</span><br>
<span class="lineno"></span><span class="comment" id="5740340">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5740401">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="5740437">type</span>&nbsp;<span class="ident" id="5740442">Tx</span>&nbsp;<span class="keyword" id="5740445">struct</span>&nbsp;<span class="op" id="5740452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740455">db</span>&nbsp;<span class="op" id="5740458">*</span><span class="ident" id="5740459">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5740464">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5740533">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740565">dc</span>&nbsp;&nbsp;<span class="op" id="5740569">*</span><span class="ident" id="5740570">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740582">txi</span>&nbsp;<span class="ident" id="5740586">driver</span><span class="op" id="5740592">.</span><span class="ident" id="5740593">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5740598">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5740662">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5740715">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740730">done</span>&nbsp;<span class="builtintype" id="5740735">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5740742">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5740819">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740870">stmts</span>&nbsp;<span class="keyword" id="5740876">struct</span>&nbsp;<span class="op" id="5740883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740887">sync</span><span class="op" id="5740891">.</span><span class="ident" id="5740892">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5740900">v</span>&nbsp;<span class="op" id="5740902">[</span><span class="op" id="5740903">]</span><span class="op" id="5740904">*</span><span class="ident" id="5740905">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5740911">}</span><br>
<span class="lineno"></span><span class="op" id="5740913">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="5740916">var</span>&nbsp;<span class="ident" id="5740920">ErrTxDone</span>&nbsp;<span class="op" id="5740930">=</span>&nbsp;<span class="ident" id="5740932">errors</span><span class="op" id="5740938">.</span><span class="ident" id="5740939">New</span><span class="op" id="5740942">(</span><span class="string" id="5740943">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="5741003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5741006">func</span>&nbsp;<span class="op" id="5741011">(</span><span class="ident" id="5741012">tx</span>&nbsp;<span class="op" id="5741015">*</span><span class="ident" id="5741016">Tx</span><span class="op" id="5741018">)</span>&nbsp;<span class="builtinfunc" id="5741020">close</span><span class="op" id="5741025">(</span><span class="op" id="5741026">)</span>&nbsp;<span class="op" id="5741028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741031">if</span>&nbsp;<span class="ident" id="5741034">tx</span><span class="op" id="5741036">.</span><span class="ident" id="5741037">done</span>&nbsp;<span class="op" id="5741042">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5741046">panic</span><span class="op" id="5741051">(</span><span class="string" id="5741052">&#34;double&nbsp;close&#34;</span><span class="op" id="5741066">)</span>&nbsp;<span class="comment" id="5741068">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5741087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741090">tx</span><span class="op" id="5741092">.</span><span class="ident" id="5741093">done</span>&nbsp;<span class="op" id="5741098">=</span>&nbsp;<span class="builtintype" id="5741100">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741106">tx</span><span class="op" id="5741108">.</span><span class="ident" id="5741109">db</span><span class="op" id="5741111">.</span><span class="ident" id="5741112">putConn</span><span class="op" id="5741119">(</span><span class="ident" id="5741120">tx</span><span class="op" id="5741122">.</span><span class="ident" id="5741123">dc</span><span class="op" id="5741125">,</span>&nbsp;<span class="ident" id="5741127">nil</span><span class="op" id="5741130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741133">tx</span><span class="op" id="5741135">.</span><span class="ident" id="5741136">dc</span>&nbsp;<span class="op" id="5741139">=</span>&nbsp;<span class="ident" id="5741141">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741146">tx</span><span class="op" id="5741148">.</span><span class="ident" id="5741149">txi</span>&nbsp;<span class="op" id="5741153">=</span>&nbsp;<span class="ident" id="5741155">nil</span><br>
<span class="lineno"></span><span class="op" id="5741159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5741162">func</span>&nbsp;<span class="op" id="5741167">(</span><span class="ident" id="5741168">tx</span>&nbsp;<span class="op" id="5741171">*</span><span class="ident" id="5741172">Tx</span><span class="op" id="5741174">)</span>&nbsp;<span class="ident" id="5741176">grabConn</span><span class="op" id="5741184">(</span><span class="op" id="5741185">)</span>&nbsp;<span class="op" id="5741187">(</span><span class="op" id="5741188">*</span><span class="ident" id="5741189">driverConn</span><span class="op" id="5741199">,</span>&nbsp;<span class="builtintype" id="5741201">error</span><span class="op" id="5741206">)</span>&nbsp;<span class="op" id="5741208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741211">if</span>&nbsp;<span class="ident" id="5741214">tx</span><span class="op" id="5741216">.</span><span class="ident" id="5741217">done</span>&nbsp;<span class="op" id="5741222">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741226">return</span>&nbsp;<span class="ident" id="5741233">nil</span><span class="op" id="5741236">,</span>&nbsp;<span class="ident" id="5741238">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5741249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741252">return</span>&nbsp;<span class="ident" id="5741259">tx</span><span class="op" id="5741261">.</span><span class="ident" id="5741262">dc</span><span class="op" id="5741264">,</span>&nbsp;<span class="ident" id="5741266">nil</span><br>
<span class="lineno"></span><span class="op" id="5741270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="5741273">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="5741324">func</span>&nbsp;<span class="op" id="5741329">(</span><span class="ident" id="5741330">tx</span>&nbsp;<span class="op" id="5741333">*</span><span class="ident" id="5741334">Tx</span><span class="op" id="5741336">)</span>&nbsp;<span class="ident" id="5741338">closePrepared</span><span class="op" id="5741351">(</span><span class="op" id="5741352">)</span>&nbsp;<span class="op" id="5741354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741357">tx</span><span class="op" id="5741359">.</span><span class="ident" id="5741360">stmts</span><span class="op" id="5741365">.</span><span class="ident" id="5741366">Lock</span><span class="op" id="5741370">(</span><span class="op" id="5741371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741374">for</span>&nbsp;<span class="ident" id="5741378">_</span><span class="op" id="5741379">,</span>&nbsp;<span class="ident" id="5741381">stmt</span>&nbsp;<span class="op" id="5741386">:=</span>&nbsp;<span class="keyword" id="5741389">range</span>&nbsp;<span class="ident" id="5741395">tx</span><span class="op" id="5741397">.</span><span class="ident" id="5741398">stmts</span><span class="op" id="5741403">.</span><span class="ident" id="5741404">v</span>&nbsp;<span class="op" id="5741406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741410">stmt</span><span class="op" id="5741414">.</span><span class="ident" id="5741415">Close</span><span class="op" id="5741420">(</span><span class="op" id="5741421">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5741424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741427">tx</span><span class="op" id="5741429">.</span><span class="ident" id="5741430">stmts</span><span class="op" id="5741435">.</span><span class="ident" id="5741436">Unlock</span><span class="op" id="5741442">(</span><span class="op" id="5741443">)</span><br>
<span class="lineno"></span><span class="op" id="5741445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5741448">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="5741483">func</span>&nbsp;<span class="op" id="5741488">(</span><span class="ident" id="5741489">tx</span>&nbsp;<span class="op" id="5741492">*</span><span class="ident" id="5741493">Tx</span><span class="op" id="5741495">)</span>&nbsp;<span class="ident" id="5741497">Commit</span><span class="op" id="5741503">(</span><span class="op" id="5741504">)</span>&nbsp;<span class="builtintype" id="5741506">error</span>&nbsp;<span class="op" id="5741512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741515">if</span>&nbsp;<span class="ident" id="5741518">tx</span><span class="op" id="5741520">.</span><span class="ident" id="5741521">done</span>&nbsp;<span class="op" id="5741526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741530">return</span>&nbsp;<span class="ident" id="5741537">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5741548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741551">defer</span>&nbsp;<span class="ident" id="5741557">tx</span><span class="op" id="5741559">.</span><span class="builtinfunc" id="5741560">close</span><span class="op" id="5741565">(</span><span class="op" id="5741566">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741569">tx</span><span class="op" id="5741571">.</span><span class="ident" id="5741572">dc</span><span class="op" id="5741574">.</span><span class="ident" id="5741575">Lock</span><span class="op" id="5741579">(</span><span class="op" id="5741580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741583">err</span>&nbsp;<span class="op" id="5741587">:=</span>&nbsp;<span class="ident" id="5741590">tx</span><span class="op" id="5741592">.</span><span class="ident" id="5741593">txi</span><span class="op" id="5741596">.</span><span class="ident" id="5741597">Commit</span><span class="op" id="5741603">(</span><span class="op" id="5741604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741607">tx</span><span class="op" id="5741609">.</span><span class="ident" id="5741610">dc</span><span class="op" id="5741612">.</span><span class="ident" id="5741613">Unlock</span><span class="op" id="5741619">(</span><span class="op" id="5741620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741623">if</span>&nbsp;<span class="ident" id="5741626">err</span>&nbsp;<span class="op" id="5741630">!=</span>&nbsp;<span class="ident" id="5741633">driver</span><span class="op" id="5741639">.</span><span class="ident" id="5741640">ErrBadConn</span>&nbsp;<span class="op" id="5741651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741655">tx</span><span class="op" id="5741657">.</span><span class="ident" id="5741658">closePrepared</span><span class="op" id="5741671">(</span><span class="op" id="5741672">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5741675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741678">return</span>&nbsp;<span class="ident" id="5741685">err</span><br>
<span class="lineno"></span><span class="op" id="5741689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5741692">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="5741728">func</span>&nbsp;<span class="op" id="5741733">(</span><span class="ident" id="5741734">tx</span>&nbsp;<span class="op" id="5741737">*</span><span class="ident" id="5741738">Tx</span><span class="op" id="5741740">)</span>&nbsp;<span class="ident" id="5741742">Rollback</span><span class="op" id="5741750">(</span><span class="op" id="5741751">)</span>&nbsp;<span class="builtintype" id="5741753">error</span>&nbsp;<span class="op" id="5741759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741762">if</span>&nbsp;<span class="ident" id="5741765">tx</span><span class="op" id="5741767">.</span><span class="ident" id="5741768">done</span>&nbsp;<span class="op" id="5741773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741777">return</span>&nbsp;<span class="ident" id="5741784">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5741795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741798">defer</span>&nbsp;<span class="ident" id="5741804">tx</span><span class="op" id="5741806">.</span><span class="builtinfunc" id="5741807">close</span><span class="op" id="5741812">(</span><span class="op" id="5741813">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741816">tx</span><span class="op" id="5741818">.</span><span class="ident" id="5741819">dc</span><span class="op" id="5741821">.</span><span class="ident" id="5741822">Lock</span><span class="op" id="5741826">(</span><span class="op" id="5741827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741830">err</span>&nbsp;<span class="op" id="5741834">:=</span>&nbsp;<span class="ident" id="5741837">tx</span><span class="op" id="5741839">.</span><span class="ident" id="5741840">txi</span><span class="op" id="5741843">.</span><span class="ident" id="5741844">Rollback</span><span class="op" id="5741852">(</span><span class="op" id="5741853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741856">tx</span><span class="op" id="5741858">.</span><span class="ident" id="5741859">dc</span><span class="op" id="5741861">.</span><span class="ident" id="5741862">Unlock</span><span class="op" id="5741868">(</span><span class="op" id="5741869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741872">if</span>&nbsp;<span class="ident" id="5741875">err</span>&nbsp;<span class="op" id="5741879">!=</span>&nbsp;<span class="ident" id="5741882">driver</span><span class="op" id="5741888">.</span><span class="ident" id="5741889">ErrBadConn</span>&nbsp;<span class="op" id="5741900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5741904">tx</span><span class="op" id="5741906">.</span><span class="ident" id="5741907">closePrepared</span><span class="op" id="5741920">(</span><span class="op" id="5741921">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5741924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5741927">return</span>&nbsp;<span class="ident" id="5741934">err</span><br>
<span class="lineno"></span><span class="op" id="5741938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5741941">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="5742011">//</span><br>
<span class="lineno"></span><span class="comment" id="5742014">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="5742090">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="5742157">//</span><br>
<span class="lineno"></span><span class="comment" id="5742160">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="5742235">func</span>&nbsp;<span class="op" id="5742240">(</span><span class="ident" id="5742241">tx</span>&nbsp;<span class="op" id="5742244">*</span><span class="ident" id="5742245">Tx</span><span class="op" id="5742247">)</span>&nbsp;<span class="ident" id="5742249">Prepare</span><span class="op" id="5742256">(</span><span class="ident" id="5742257">query</span>&nbsp;<span class="builtintype" id="5742263">string</span><span class="op" id="5742269">)</span>&nbsp;<span class="op" id="5742271">(</span><span class="op" id="5742272">*</span><span class="ident" id="5742273">Stmt</span><span class="op" id="5742277">,</span>&nbsp;<span class="builtintype" id="5742279">error</span><span class="op" id="5742284">)</span>&nbsp;<span class="op" id="5742286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742289">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742352">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742410">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742474">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742537">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742593">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742654">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742716">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742775">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742835">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742895">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5742954">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5743018">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743059">dc</span><span class="op" id="5743061">,</span>&nbsp;<span class="ident" id="5743063">err</span>&nbsp;<span class="op" id="5743067">:=</span>&nbsp;<span class="ident" id="5743070">tx</span><span class="op" id="5743072">.</span><span class="ident" id="5743073">grabConn</span><span class="op" id="5743081">(</span><span class="op" id="5743082">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5743085">if</span>&nbsp;<span class="ident" id="5743088">err</span>&nbsp;<span class="op" id="5743092">!=</span>&nbsp;<span class="ident" id="5743095">nil</span>&nbsp;<span class="op" id="5743099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5743103">return</span>&nbsp;<span class="ident" id="5743110">nil</span><span class="op" id="5743113">,</span>&nbsp;<span class="ident" id="5743115">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5743120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743124">dc</span><span class="op" id="5743126">.</span><span class="ident" id="5743127">Lock</span><span class="op" id="5743131">(</span><span class="op" id="5743132">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743135">si</span><span class="op" id="5743137">,</span>&nbsp;<span class="ident" id="5743139">err</span>&nbsp;<span class="op" id="5743143">:=</span>&nbsp;<span class="ident" id="5743146">dc</span><span class="op" id="5743148">.</span><span class="ident" id="5743149">ci</span><span class="op" id="5743151">.</span><span class="ident" id="5743152">Prepare</span><span class="op" id="5743159">(</span><span class="ident" id="5743160">query</span><span class="op" id="5743165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743168">dc</span><span class="op" id="5743170">.</span><span class="ident" id="5743171">Unlock</span><span class="op" id="5743177">(</span><span class="op" id="5743178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5743181">if</span>&nbsp;<span class="ident" id="5743184">err</span>&nbsp;<span class="op" id="5743188">!=</span>&nbsp;<span class="ident" id="5743191">nil</span>&nbsp;<span class="op" id="5743195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5743199">return</span>&nbsp;<span class="ident" id="5743206">nil</span><span class="op" id="5743209">,</span>&nbsp;<span class="ident" id="5743211">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5743216">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743220">stmt</span>&nbsp;<span class="op" id="5743225">:=</span>&nbsp;<span class="op" id="5743228">&amp;</span><span class="ident" id="5743229">Stmt</span><span class="op" id="5743233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743237">db</span><span class="op" id="5743239">:</span>&nbsp;<span class="ident" id="5743241">tx</span><span class="op" id="5743243">.</span><span class="ident" id="5743244">db</span><span class="op" id="5743246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743250">tx</span><span class="op" id="5743252">:</span>&nbsp;<span class="ident" id="5743254">tx</span><span class="op" id="5743256">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743260">txsi</span><span class="op" id="5743264">:</span>&nbsp;<span class="op" id="5743266">&amp;</span><span class="ident" id="5743267">driverStmt</span><span class="op" id="5743277">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743282">Locker</span><span class="op" id="5743288">:</span>&nbsp;<span class="ident" id="5743290">dc</span><span class="op" id="5743292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743297">si</span><span class="op" id="5743299">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5743305">si</span><span class="op" id="5743307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5743311">}</span><span class="op" id="5743312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743316">query</span><span class="op" id="5743321">:</span>&nbsp;<span class="ident" id="5743323">query</span><span class="op" id="5743328">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5743331">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743334">tx</span><span class="op" id="5743336">.</span><span class="ident" id="5743337">stmts</span><span class="op" id="5743342">.</span><span class="ident" id="5743343">Lock</span><span class="op" id="5743347">(</span><span class="op" id="5743348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743351">tx</span><span class="op" id="5743353">.</span><span class="ident" id="5743354">stmts</span><span class="op" id="5743359">.</span><span class="ident" id="5743360">v</span>&nbsp;<span class="op" id="5743362">=</span>&nbsp;<span class="builtinfunc" id="5743364">append</span><span class="op" id="5743370">(</span><span class="ident" id="5743371">tx</span><span class="op" id="5743373">.</span><span class="ident" id="5743374">stmts</span><span class="op" id="5743379">.</span><span class="ident" id="5743380">v</span><span class="op" id="5743381">,</span>&nbsp;<span class="ident" id="5743383">stmt</span><span class="op" id="5743387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5743390">tx</span><span class="op" id="5743392">.</span><span class="ident" id="5743393">stmts</span><span class="op" id="5743398">.</span><span class="ident" id="5743399">Unlock</span><span class="op" id="5743405">(</span><span class="op" id="5743406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5743409">return</span>&nbsp;<span class="ident" id="5743416">stmt</span><span class="op" id="5743420">,</span>&nbsp;<span class="ident" id="5743422">nil</span><br>
<span class="lineno"></span><span class="op" id="5743426">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="5743429">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="5743492">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5743518">//</span><br>
<span class="lineno"></span><span class="comment" id="5743521">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="5743533">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5743615">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5743623">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="5743649">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5743657">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="5743717">func</span>&nbsp;<span class="op" id="5743722">(</span><span class="ident" id="5743723">tx</span>&nbsp;<span class="op" id="5743726">*</span><span class="ident" id="5743727">Tx</span><span class="op" id="5743729">)</span>&nbsp;<span class="ident" id="5743731">Stmt</span><span class="op" id="5743735">(</span><span class="ident" id="5743736">stmt</span>&nbsp;<span class="op" id="5743741">*</span><span class="ident" id="5743742">Stmt</span><span class="op" id="5743746">)</span>&nbsp;<span class="op" id="5743748">*</span><span class="ident" id="5743749">Stmt</span>&nbsp;<span class="op" id="5743754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5743757">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5743819">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5743882">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5743937">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5743992">if</span>&nbsp;<span class="ident" id="5743995">tx</span><span class="op" id="5743997">.</span><span class="ident" id="5743998">db</span>&nbsp;<span class="op" id="5744001">!=</span>&nbsp;<span class="ident" id="5744004">stmt</span><span class="op" id="5744008">.</span><span class="ident" id="5744009">db</span>&nbsp;<span class="op" id="5744012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744016">return</span>&nbsp;<span class="op" id="5744023">&amp;</span><span class="ident" id="5744024">Stmt</span><span class="op" id="5744028">{</span><span class="ident" id="5744029">stickyErr</span><span class="op" id="5744038">:</span>&nbsp;<span class="ident" id="5744040">errors</span><span class="op" id="5744046">.</span><span class="ident" id="5744047">New</span><span class="op" id="5744050">(</span><span class="string" id="5744051">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="5744105">)</span><span class="op" id="5744106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5744109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744112">dc</span><span class="op" id="5744114">,</span>&nbsp;<span class="ident" id="5744116">err</span>&nbsp;<span class="op" id="5744120">:=</span>&nbsp;<span class="ident" id="5744123">tx</span><span class="op" id="5744125">.</span><span class="ident" id="5744126">grabConn</span><span class="op" id="5744134">(</span><span class="op" id="5744135">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744138">if</span>&nbsp;<span class="ident" id="5744141">err</span>&nbsp;<span class="op" id="5744145">!=</span>&nbsp;<span class="ident" id="5744148">nil</span>&nbsp;<span class="op" id="5744152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744156">return</span>&nbsp;<span class="op" id="5744163">&amp;</span><span class="ident" id="5744164">Stmt</span><span class="op" id="5744168">{</span><span class="ident" id="5744169">stickyErr</span><span class="op" id="5744178">:</span>&nbsp;<span class="ident" id="5744180">err</span><span class="op" id="5744183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5744186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744189">dc</span><span class="op" id="5744191">.</span><span class="ident" id="5744192">Lock</span><span class="op" id="5744196">(</span><span class="op" id="5744197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744200">si</span><span class="op" id="5744202">,</span>&nbsp;<span class="ident" id="5744204">err</span>&nbsp;<span class="op" id="5744208">:=</span>&nbsp;<span class="ident" id="5744211">dc</span><span class="op" id="5744213">.</span><span class="ident" id="5744214">ci</span><span class="op" id="5744216">.</span><span class="ident" id="5744217">Prepare</span><span class="op" id="5744224">(</span><span class="ident" id="5744225">stmt</span><span class="op" id="5744229">.</span><span class="ident" id="5744230">query</span><span class="op" id="5744235">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744238">dc</span><span class="op" id="5744240">.</span><span class="ident" id="5744241">Unlock</span><span class="op" id="5744247">(</span><span class="op" id="5744248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744251">txs</span>&nbsp;<span class="op" id="5744255">:=</span>&nbsp;<span class="op" id="5744258">&amp;</span><span class="ident" id="5744259">Stmt</span><span class="op" id="5744263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744267">db</span><span class="op" id="5744269">:</span>&nbsp;<span class="ident" id="5744271">tx</span><span class="op" id="5744273">.</span><span class="ident" id="5744274">db</span><span class="op" id="5744276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744280">tx</span><span class="op" id="5744282">:</span>&nbsp;<span class="ident" id="5744284">tx</span><span class="op" id="5744286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744290">txsi</span><span class="op" id="5744294">:</span>&nbsp;<span class="op" id="5744296">&amp;</span><span class="ident" id="5744297">driverStmt</span><span class="op" id="5744307">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744312">Locker</span><span class="op" id="5744318">:</span>&nbsp;<span class="ident" id="5744320">dc</span><span class="op" id="5744322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744327">si</span><span class="op" id="5744329">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5744335">si</span><span class="op" id="5744337">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5744341">}</span><span class="op" id="5744342">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744346">query</span><span class="op" id="5744351">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5744357">stmt</span><span class="op" id="5744361">.</span><span class="ident" id="5744362">query</span><span class="op" id="5744367">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744371">stickyErr</span><span class="op" id="5744380">:</span>&nbsp;<span class="ident" id="5744382">err</span><span class="op" id="5744385">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5744388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744391">tx</span><span class="op" id="5744393">.</span><span class="ident" id="5744394">stmts</span><span class="op" id="5744399">.</span><span class="ident" id="5744400">Lock</span><span class="op" id="5744404">(</span><span class="op" id="5744405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744408">tx</span><span class="op" id="5744410">.</span><span class="ident" id="5744411">stmts</span><span class="op" id="5744416">.</span><span class="ident" id="5744417">v</span>&nbsp;<span class="op" id="5744419">=</span>&nbsp;<span class="builtinfunc" id="5744421">append</span><span class="op" id="5744427">(</span><span class="ident" id="5744428">tx</span><span class="op" id="5744430">.</span><span class="ident" id="5744431">stmts</span><span class="op" id="5744436">.</span><span class="ident" id="5744437">v</span><span class="op" id="5744438">,</span>&nbsp;<span class="ident" id="5744440">txs</span><span class="op" id="5744443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744446">tx</span><span class="op" id="5744448">.</span><span class="ident" id="5744449">stmts</span><span class="op" id="5744454">.</span><span class="ident" id="5744455">Unlock</span><span class="op" id="5744461">(</span><span class="op" id="5744462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744465">return</span>&nbsp;<span class="ident" id="5744472">txs</span><br>
<span class="lineno">1215</span><span class="op" id="5744476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5744479">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="5744530">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="5744568">func</span>&nbsp;<span class="op" id="5744573">(</span><span class="ident" id="5744574">tx</span>&nbsp;<span class="op" id="5744577">*</span><span class="ident" id="5744578">Tx</span><span class="op" id="5744580">)</span>&nbsp;<span class="ident" id="5744582">Exec</span><span class="op" id="5744586">(</span><span class="ident" id="5744587">query</span>&nbsp;<span class="builtintype" id="5744593">string</span><span class="op" id="5744599">,</span>&nbsp;<span class="ident" id="5744601">args</span>&nbsp;<span class="op" id="5744606">...</span><span class="keyword" id="5744609">interface</span><span class="op" id="5744618">{</span><span class="op" id="5744619">}</span><span class="op" id="5744620">)</span>&nbsp;<span class="op" id="5744622">(</span><span class="ident" id="5744623">Result</span><span class="op" id="5744629">,</span>&nbsp;<span class="builtintype" id="5744631">error</span><span class="op" id="5744636">)</span>&nbsp;<span class="op" id="5744638">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744641">dc</span><span class="op" id="5744643">,</span>&nbsp;<span class="ident" id="5744645">err</span>&nbsp;<span class="op" id="5744649">:=</span>&nbsp;<span class="ident" id="5744652">tx</span><span class="op" id="5744654">.</span><span class="ident" id="5744655">grabConn</span><span class="op" id="5744663">(</span><span class="op" id="5744664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744667">if</span>&nbsp;<span class="ident" id="5744670">err</span>&nbsp;<span class="op" id="5744674">!=</span>&nbsp;<span class="ident" id="5744677">nil</span>&nbsp;<span class="op" id="5744681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744685">return</span>&nbsp;<span class="ident" id="5744692">nil</span><span class="op" id="5744695">,</span>&nbsp;<span class="ident" id="5744697">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5744702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744706">if</span>&nbsp;<span class="ident" id="5744709">execer</span><span class="op" id="5744715">,</span>&nbsp;<span class="ident" id="5744717">ok</span>&nbsp;<span class="op" id="5744720">:=</span>&nbsp;<span class="ident" id="5744723">dc</span><span class="op" id="5744725">.</span><span class="ident" id="5744726">ci</span><span class="op" id="5744728">.</span><span class="op" id="5744729">(</span><span class="ident" id="5744730">driver</span><span class="op" id="5744736">.</span><span class="ident" id="5744737">Execer</span><span class="op" id="5744743">)</span><span class="op" id="5744744">;</span>&nbsp;<span class="ident" id="5744746">ok</span>&nbsp;<span class="op" id="5744749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744753">dargs</span><span class="op" id="5744758">,</span>&nbsp;<span class="ident" id="5744760">err</span>&nbsp;<span class="op" id="5744764">:=</span>&nbsp;<span class="ident" id="5744767">driverArgs</span><span class="op" id="5744777">(</span><span class="ident" id="5744778">nil</span><span class="op" id="5744781">,</span>&nbsp;<span class="ident" id="5744783">args</span><span class="op" id="5744787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744791">if</span>&nbsp;<span class="ident" id="5744794">err</span>&nbsp;<span class="op" id="5744798">!=</span>&nbsp;<span class="ident" id="5744801">nil</span>&nbsp;<span class="op" id="5744805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744810">return</span>&nbsp;<span class="ident" id="5744817">nil</span><span class="op" id="5744820">,</span>&nbsp;<span class="ident" id="5744822">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5744828">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744832">dc</span><span class="op" id="5744834">.</span><span class="ident" id="5744835">Lock</span><span class="op" id="5744839">(</span><span class="op" id="5744840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744844">resi</span><span class="op" id="5744848">,</span>&nbsp;<span class="ident" id="5744850">err</span>&nbsp;<span class="op" id="5744854">:=</span>&nbsp;<span class="ident" id="5744857">execer</span><span class="op" id="5744863">.</span><span class="ident" id="5744864">Exec</span><span class="op" id="5744868">(</span><span class="ident" id="5744869">query</span><span class="op" id="5744874">,</span>&nbsp;<span class="ident" id="5744876">dargs</span><span class="op" id="5744881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5744885">dc</span><span class="op" id="5744887">.</span><span class="ident" id="5744888">Unlock</span><span class="op" id="5744894">(</span><span class="op" id="5744895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744899">if</span>&nbsp;<span class="ident" id="5744902">err</span>&nbsp;<span class="op" id="5744906">==</span>&nbsp;<span class="ident" id="5744909">nil</span>&nbsp;<span class="op" id="5744913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744918">return</span>&nbsp;<span class="ident" id="5744925">driverResult</span><span class="op" id="5744937">{</span><span class="ident" id="5744938">dc</span><span class="op" id="5744940">,</span>&nbsp;<span class="ident" id="5744942">resi</span><span class="op" id="5744946">}</span><span class="op" id="5744947">,</span>&nbsp;<span class="ident" id="5744949">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5744955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744959">if</span>&nbsp;<span class="ident" id="5744962">err</span>&nbsp;<span class="op" id="5744966">!=</span>&nbsp;<span class="ident" id="5744969">driver</span><span class="op" id="5744975">.</span><span class="ident" id="5744976">ErrSkip</span>&nbsp;<span class="op" id="5744984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5744989">return</span>&nbsp;<span class="ident" id="5744996">nil</span><span class="op" id="5744999">,</span>&nbsp;<span class="ident" id="5745001">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5745007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5745010">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5745014">dc</span><span class="op" id="5745016">.</span><span class="ident" id="5745017">Lock</span><span class="op" id="5745021">(</span><span class="op" id="5745022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5745025">si</span><span class="op" id="5745027">,</span>&nbsp;<span class="ident" id="5745029">err</span>&nbsp;<span class="op" id="5745033">:=</span>&nbsp;<span class="ident" id="5745036">dc</span><span class="op" id="5745038">.</span><span class="ident" id="5745039">ci</span><span class="op" id="5745041">.</span><span class="ident" id="5745042">Prepare</span><span class="op" id="5745049">(</span><span class="ident" id="5745050">query</span><span class="op" id="5745055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5745058">dc</span><span class="op" id="5745060">.</span><span class="ident" id="5745061">Unlock</span><span class="op" id="5745067">(</span><span class="op" id="5745068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5745071">if</span>&nbsp;<span class="ident" id="5745074">err</span>&nbsp;<span class="op" id="5745078">!=</span>&nbsp;<span class="ident" id="5745081">nil</span>&nbsp;<span class="op" id="5745085">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5745089">return</span>&nbsp;<span class="ident" id="5745096">nil</span><span class="op" id="5745099">,</span>&nbsp;<span class="ident" id="5745101">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5745106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5745109">defer</span>&nbsp;<span class="ident" id="5745115">withLock</span><span class="op" id="5745123">(</span><span class="ident" id="5745124">dc</span><span class="op" id="5745126">,</span>&nbsp;<span class="keyword" id="5745128">func</span><span class="op" id="5745132">(</span><span class="op" id="5745133">)</span>&nbsp;<span class="op" id="5745135">{</span>&nbsp;<span class="ident" id="5745137">si</span><span class="op" id="5745139">.</span><span class="ident" id="5745140">Close</span><span class="op" id="5745145">(</span><span class="op" id="5745146">)</span>&nbsp;<span class="op" id="5745148">}</span><span class="op" id="5745149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5745153">return</span>&nbsp;<span class="ident" id="5745160">resultFromStatement</span><span class="op" id="5745179">(</span><span class="ident" id="5745180">driverStmt</span><span class="op" id="5745190">{</span><span class="ident" id="5745191">dc</span><span class="op" id="5745193">,</span>&nbsp;<span class="ident" id="5745195">si</span><span class="op" id="5745197">}</span><span class="op" id="5745198">,</span>&nbsp;<span class="ident" id="5745200">args</span><span class="op" id="5745204">...</span><span class="op" id="5745207">)</span><br>
<span class="lineno">1250</span><span class="op" id="5745209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5745212">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="5745277">func</span>&nbsp;<span class="op" id="5745282">(</span><span class="ident" id="5745283">tx</span>&nbsp;<span class="op" id="5745286">*</span><span class="ident" id="5745287">Tx</span><span class="op" id="5745289">)</span>&nbsp;<span class="ident" id="5745291">Query</span><span class="op" id="5745296">(</span><span class="ident" id="5745297">query</span>&nbsp;<span class="builtintype" id="5745303">string</span><span class="op" id="5745309">,</span>&nbsp;<span class="ident" id="5745311">args</span>&nbsp;<span class="op" id="5745316">...</span><span class="keyword" id="5745319">interface</span><span class="op" id="5745328">{</span><span class="op" id="5745329">}</span><span class="op" id="5745330">)</span>&nbsp;<span class="op" id="5745332">(</span><span class="op" id="5745333">*</span><span class="ident" id="5745334">Rows</span><span class="op" id="5745338">,</span>&nbsp;<span class="builtintype" id="5745340">error</span><span class="op" id="5745345">)</span>&nbsp;<span class="op" id="5745347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5745350">dc</span><span class="op" id="5745352">,</span>&nbsp;<span class="ident" id="5745354">err</span>&nbsp;<span class="op" id="5745358">:=</span>&nbsp;<span class="ident" id="5745361">tx</span><span class="op" id="5745363">.</span><span class="ident" id="5745364">grabConn</span><span class="op" id="5745372">(</span><span class="op" id="5745373">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5745376">if</span>&nbsp;<span class="ident" id="5745379">err</span>&nbsp;<span class="op" id="5745383">!=</span>&nbsp;<span class="ident" id="5745386">nil</span>&nbsp;<span class="op" id="5745390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5745394">return</span>&nbsp;<span class="ident" id="5745401">nil</span><span class="op" id="5745404">,</span>&nbsp;<span class="ident" id="5745406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5745411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5745414">releaseConn</span>&nbsp;<span class="op" id="5745426">:=</span>&nbsp;<span class="keyword" id="5745429">func</span><span class="op" id="5745433">(</span><span class="builtintype" id="5745434">error</span><span class="op" id="5745439">)</span>&nbsp;<span class="op" id="5745441">{</span><span class="op" id="5745442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5745445">return</span>&nbsp;<span class="ident" id="5745452">tx</span><span class="op" id="5745454">.</span><span class="ident" id="5745455">db</span><span class="op" id="5745457">.</span><span class="ident" id="5745458">queryConn</span><span class="op" id="5745467">(</span><span class="ident" id="5745468">dc</span><span class="op" id="5745470">,</span>&nbsp;<span class="ident" id="5745472">releaseConn</span><span class="op" id="5745483">,</span>&nbsp;<span class="ident" id="5745485">query</span><span class="op" id="5745490">,</span>&nbsp;<span class="ident" id="5745492">args</span><span class="op" id="5745496">)</span><br>
<span class="lineno">1260</span><span class="op" id="5745498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5745501">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5745574">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5745643">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="5745675">func</span>&nbsp;<span class="op" id="5745680">(</span><span class="ident" id="5745681">tx</span>&nbsp;<span class="op" id="5745684">*</span><span class="ident" id="5745685">Tx</span><span class="op" id="5745687">)</span>&nbsp;<span class="ident" id="5745689">QueryRow</span><span class="op" id="5745697">(</span><span class="ident" id="5745698">query</span>&nbsp;<span class="builtintype" id="5745704">string</span><span class="op" id="5745710">,</span>&nbsp;<span class="ident" id="5745712">args</span>&nbsp;<span class="op" id="5745717">...</span><span class="keyword" id="5745720">interface</span><span class="op" id="5745729">{</span><span class="op" id="5745730">}</span><span class="op" id="5745731">)</span>&nbsp;<span class="op" id="5745733">*</span><span class="ident" id="5745734">Row</span>&nbsp;<span class="op" id="5745738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5745741">rows</span><span class="op" id="5745745">,</span>&nbsp;<span class="ident" id="5745747">err</span>&nbsp;<span class="op" id="5745751">:=</span>&nbsp;<span class="ident" id="5745754">tx</span><span class="op" id="5745756">.</span><span class="ident" id="5745757">Query</span><span class="op" id="5745762">(</span><span class="ident" id="5745763">query</span><span class="op" id="5745768">,</span>&nbsp;<span class="ident" id="5745770">args</span><span class="op" id="5745774">...</span><span class="op" id="5745777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5745780">return</span>&nbsp;<span class="op" id="5745787">&amp;</span><span class="ident" id="5745788">Row</span><span class="op" id="5745791">{</span><span class="ident" id="5745792">rows</span><span class="op" id="5745796">:</span>&nbsp;<span class="ident" id="5745798">rows</span><span class="op" id="5745802">,</span>&nbsp;<span class="ident" id="5745804">err</span><span class="op" id="5745807">:</span>&nbsp;<span class="ident" id="5745809">err</span><span class="op" id="5745812">}</span><br>
<span class="lineno"></span><span class="op" id="5745814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="5745817">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5745881">type</span>&nbsp;<span class="ident" id="5745886">connStmt</span>&nbsp;<span class="keyword" id="5745895">struct</span>&nbsp;<span class="op" id="5745902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5745905">dc</span>&nbsp;<span class="op" id="5745908">*</span><span class="ident" id="5745909">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5745921">si</span>&nbsp;<span class="ident" id="5745924">driver</span><span class="op" id="5745930">.</span><span class="ident" id="5745931">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5745936">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="5745939">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5746028">type</span>&nbsp;<span class="ident" id="5746033">Stmt</span>&nbsp;<span class="keyword" id="5746038">struct</span>&nbsp;<span class="op" id="5746045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5746048">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746063">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5746073">*</span><span class="ident" id="5746074">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5746080">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746103">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5746113">string</span>&nbsp;<span class="comment" id="5746120">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746146">stickyErr</span>&nbsp;<span class="builtintype" id="5746156">error</span>&nbsp;&nbsp;<span class="comment" id="5746163">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746222">closemu</span>&nbsp;<span class="ident" id="5746230">sync</span><span class="op" id="5746234">.</span><span class="ident" id="5746235">RWMutex</span>&nbsp;<span class="comment" id="5746243">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5746299">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746339">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5746344">*</span><span class="ident" id="5746345">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746349">txsi</span>&nbsp;<span class="op" id="5746354">*</span><span class="ident" id="5746355">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746368">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5746375">sync</span><span class="op" id="5746379">.</span><span class="ident" id="5746380">Mutex</span>&nbsp;<span class="comment" id="5746386">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746422">closed</span>&nbsp;<span class="builtintype" id="5746429">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5746436">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5746496">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5746556">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5746609">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746662">css</span>&nbsp;<span class="op" id="5746666">[</span><span class="op" id="5746667">]</span><span class="ident" id="5746668">connStmt</span><br>
<span class="lineno"></span><span class="op" id="5746677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5746680">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="5746747">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5746808">func</span>&nbsp;<span class="op" id="5746813">(</span><span class="ident" id="5746814">s</span>&nbsp;<span class="op" id="5746816">*</span><span class="ident" id="5746817">Stmt</span><span class="op" id="5746821">)</span>&nbsp;<span class="ident" id="5746823">Exec</span><span class="op" id="5746827">(</span><span class="ident" id="5746828">args</span>&nbsp;<span class="op" id="5746833">...</span><span class="keyword" id="5746836">interface</span><span class="op" id="5746845">{</span><span class="op" id="5746846">}</span><span class="op" id="5746847">)</span>&nbsp;<span class="op" id="5746849">(</span><span class="ident" id="5746850">Result</span><span class="op" id="5746856">,</span>&nbsp;<span class="builtintype" id="5746858">error</span><span class="op" id="5746863">)</span>&nbsp;<span class="op" id="5746865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746868">s</span><span class="op" id="5746869">.</span><span class="ident" id="5746870">closemu</span><span class="op" id="5746877">.</span><span class="ident" id="5746878">RLock</span><span class="op" id="5746883">(</span><span class="op" id="5746884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5746887">defer</span>&nbsp;<span class="ident" id="5746893">s</span><span class="op" id="5746894">.</span><span class="ident" id="5746895">closemu</span><span class="op" id="5746902">.</span><span class="ident" id="5746903">RUnlock</span><span class="op" id="5746910">(</span><span class="op" id="5746911">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5746915">var</span>&nbsp;<span class="ident" id="5746919">res</span>&nbsp;<span class="ident" id="5746923">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5746931">for</span>&nbsp;<span class="ident" id="5746935">i</span>&nbsp;<span class="op" id="5746937">:=</span>&nbsp;<span class="num" id="5746940">0</span><span class="op" id="5746941">;</span>&nbsp;<span class="ident" id="5746943">i</span>&nbsp;<span class="op" id="5746945">&lt;</span>&nbsp;<span class="ident" id="5746947">maxBadConnRetries</span><span class="op" id="5746964">;</span>&nbsp;<span class="ident" id="5746966">i</span><span class="op" id="5746967">++</span>&nbsp;<span class="op" id="5746970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5746974">dc</span><span class="op" id="5746976">,</span>&nbsp;<span class="ident" id="5746978">releaseConn</span><span class="op" id="5746989">,</span>&nbsp;<span class="ident" id="5746991">si</span><span class="op" id="5746993">,</span>&nbsp;<span class="ident" id="5746995">err</span>&nbsp;<span class="op" id="5746999">:=</span>&nbsp;<span class="ident" id="5747002">s</span><span class="op" id="5747003">.</span><span class="ident" id="5747004">connStmt</span><span class="op" id="5747012">(</span><span class="op" id="5747013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747017">if</span>&nbsp;<span class="ident" id="5747020">err</span>&nbsp;<span class="op" id="5747024">!=</span>&nbsp;<span class="ident" id="5747027">nil</span>&nbsp;<span class="op" id="5747031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747036">if</span>&nbsp;<span class="ident" id="5747039">err</span>&nbsp;<span class="op" id="5747043">==</span>&nbsp;<span class="ident" id="5747046">driver</span><span class="op" id="5747052">.</span><span class="ident" id="5747053">ErrBadConn</span>&nbsp;<span class="op" id="5747064">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747070">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5747082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747087">return</span>&nbsp;<span class="ident" id="5747094">nil</span><span class="op" id="5747097">,</span>&nbsp;<span class="ident" id="5747099">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5747105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747110">res</span><span class="op" id="5747113">,</span>&nbsp;<span class="ident" id="5747115">err</span>&nbsp;<span class="op" id="5747119">=</span>&nbsp;<span class="ident" id="5747121">resultFromStatement</span><span class="op" id="5747140">(</span><span class="ident" id="5747141">driverStmt</span><span class="op" id="5747151">{</span><span class="ident" id="5747152">dc</span><span class="op" id="5747154">,</span>&nbsp;<span class="ident" id="5747156">si</span><span class="op" id="5747158">}</span><span class="op" id="5747159">,</span>&nbsp;<span class="ident" id="5747161">args</span><span class="op" id="5747165">...</span><span class="op" id="5747168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747172">releaseConn</span><span class="op" id="5747183">(</span><span class="ident" id="5747184">err</span><span class="op" id="5747187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747191">if</span>&nbsp;<span class="ident" id="5747194">err</span>&nbsp;<span class="op" id="5747198">!=</span>&nbsp;<span class="ident" id="5747201">driver</span><span class="op" id="5747207">.</span><span class="ident" id="5747208">ErrBadConn</span>&nbsp;<span class="op" id="5747219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747224">return</span>&nbsp;<span class="ident" id="5747231">res</span><span class="op" id="5747234">,</span>&nbsp;<span class="ident" id="5747236">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5747242">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5747245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747248">return</span>&nbsp;<span class="ident" id="5747255">nil</span><span class="op" id="5747258">,</span>&nbsp;<span class="ident" id="5747260">driver</span><span class="op" id="5747266">.</span><span class="ident" id="5747267">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5747278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5747281">func</span>&nbsp;<span class="ident" id="5747286">resultFromStatement</span><span class="op" id="5747305">(</span><span class="ident" id="5747306">ds</span>&nbsp;<span class="ident" id="5747309">driverStmt</span><span class="op" id="5747319">,</span>&nbsp;<span class="ident" id="5747321">args</span>&nbsp;<span class="op" id="5747326">...</span><span class="keyword" id="5747329">interface</span><span class="op" id="5747338">{</span><span class="op" id="5747339">}</span><span class="op" id="5747340">)</span>&nbsp;<span class="op" id="5747342">(</span><span class="ident" id="5747343">Result</span><span class="op" id="5747349">,</span>&nbsp;<span class="builtintype" id="5747351">error</span><span class="op" id="5747356">)</span>&nbsp;<span class="op" id="5747358">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747361">ds</span><span class="op" id="5747363">.</span><span class="ident" id="5747364">Lock</span><span class="op" id="5747368">(</span><span class="op" id="5747369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747372">want</span>&nbsp;<span class="op" id="5747377">:=</span>&nbsp;<span class="ident" id="5747380">ds</span><span class="op" id="5747382">.</span><span class="ident" id="5747383">si</span><span class="op" id="5747385">.</span><span class="ident" id="5747386">NumInput</span><span class="op" id="5747394">(</span><span class="op" id="5747395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747398">ds</span><span class="op" id="5747400">.</span><span class="ident" id="5747401">Unlock</span><span class="op" id="5747407">(</span><span class="op" id="5747408">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5747412">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5747476">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5747550">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747579">if</span>&nbsp;<span class="ident" id="5747582">want</span>&nbsp;<span class="op" id="5747587">!=</span>&nbsp;<span class="op" id="5747590">-</span><span class="num" id="5747591">1</span>&nbsp;<span class="op" id="5747593">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5747596">len</span><span class="op" id="5747599">(</span><span class="ident" id="5747600">args</span><span class="op" id="5747604">)</span>&nbsp;<span class="op" id="5747606">!=</span>&nbsp;<span class="ident" id="5747609">want</span>&nbsp;<span class="op" id="5747614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747618">return</span>&nbsp;<span class="ident" id="5747625">nil</span><span class="op" id="5747628">,</span>&nbsp;<span class="ident" id="5747630">fmt</span><span class="op" id="5747633">.</span><span class="ident" id="5747634">Errorf</span><span class="op" id="5747640">(</span><span class="string" id="5747641">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5747677">,</span>&nbsp;<span class="ident" id="5747679">want</span><span class="op" id="5747683">,</span>&nbsp;<span class="builtinfunc" id="5747685">len</span><span class="op" id="5747688">(</span><span class="ident" id="5747689">args</span><span class="op" id="5747693">)</span><span class="op" id="5747694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5747697">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747701">dargs</span><span class="op" id="5747706">,</span>&nbsp;<span class="ident" id="5747708">err</span>&nbsp;<span class="op" id="5747712">:=</span>&nbsp;<span class="ident" id="5747715">driverArgs</span><span class="op" id="5747725">(</span><span class="op" id="5747726">&amp;</span><span class="ident" id="5747727">ds</span><span class="op" id="5747729">,</span>&nbsp;<span class="ident" id="5747731">args</span><span class="op" id="5747735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747738">if</span>&nbsp;<span class="ident" id="5747741">err</span>&nbsp;<span class="op" id="5747745">!=</span>&nbsp;<span class="ident" id="5747748">nil</span>&nbsp;<span class="op" id="5747752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747756">return</span>&nbsp;<span class="ident" id="5747763">nil</span><span class="op" id="5747766">,</span>&nbsp;<span class="ident" id="5747768">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5747773">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747777">ds</span><span class="op" id="5747779">.</span><span class="ident" id="5747780">Lock</span><span class="op" id="5747784">(</span><span class="op" id="5747785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747788">resi</span><span class="op" id="5747792">,</span>&nbsp;<span class="ident" id="5747794">err</span>&nbsp;<span class="op" id="5747798">:=</span>&nbsp;<span class="ident" id="5747801">ds</span><span class="op" id="5747803">.</span><span class="ident" id="5747804">si</span><span class="op" id="5747806">.</span><span class="ident" id="5747807">Exec</span><span class="op" id="5747811">(</span><span class="ident" id="5747812">dargs</span><span class="op" id="5747817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5747820">ds</span><span class="op" id="5747822">.</span><span class="ident" id="5747823">Unlock</span><span class="op" id="5747829">(</span><span class="op" id="5747830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747833">if</span>&nbsp;<span class="ident" id="5747836">err</span>&nbsp;<span class="op" id="5747840">!=</span>&nbsp;<span class="ident" id="5747843">nil</span>&nbsp;<span class="op" id="5747847">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747851">return</span>&nbsp;<span class="ident" id="5747858">nil</span><span class="op" id="5747861">,</span>&nbsp;<span class="ident" id="5747863">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5747868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5747871">return</span>&nbsp;<span class="ident" id="5747878">driverResult</span><span class="op" id="5747890">{</span><span class="ident" id="5747891">ds</span><span class="op" id="5747893">.</span><span class="ident" id="5747894">Locker</span><span class="op" id="5747900">,</span>&nbsp;<span class="ident" id="5747902">resi</span><span class="op" id="5747906">}</span><span class="op" id="5747907">,</span>&nbsp;<span class="ident" id="5747909">nil</span><br>
<span class="lineno"></span><span class="op" id="5747913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="5747916">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5747985">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5748051">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5748090">func</span>&nbsp;<span class="op" id="5748095">(</span><span class="ident" id="5748096">s</span>&nbsp;<span class="op" id="5748098">*</span><span class="ident" id="5748099">Stmt</span><span class="op" id="5748103">)</span>&nbsp;<span class="ident" id="5748105">connStmt</span><span class="op" id="5748113">(</span><span class="op" id="5748114">)</span>&nbsp;<span class="op" id="5748116">(</span><span class="ident" id="5748117">ci</span>&nbsp;<span class="op" id="5748120">*</span><span class="ident" id="5748121">driverConn</span><span class="op" id="5748131">,</span>&nbsp;<span class="ident" id="5748133">releaseConn</span>&nbsp;<span class="keyword" id="5748145">func</span><span class="op" id="5748149">(</span><span class="builtintype" id="5748150">error</span><span class="op" id="5748155">)</span><span class="op" id="5748156">,</span>&nbsp;<span class="ident" id="5748158">si</span>&nbsp;<span class="ident" id="5748161">driver</span><span class="op" id="5748167">.</span><span class="ident" id="5748168">Stmt</span><span class="op" id="5748172">,</span>&nbsp;<span class="ident" id="5748174">err</span>&nbsp;<span class="builtintype" id="5748178">error</span><span class="op" id="5748183">)</span>&nbsp;<span class="op" id="5748185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748188">if</span>&nbsp;<span class="ident" id="5748191">err</span>&nbsp;<span class="op" id="5748195">=</span>&nbsp;<span class="ident" id="5748197">s</span><span class="op" id="5748198">.</span><span class="ident" id="5748199">stickyErr</span><span class="op" id="5748208">;</span>&nbsp;<span class="ident" id="5748210">err</span>&nbsp;<span class="op" id="5748214">!=</span>&nbsp;<span class="ident" id="5748217">nil</span>&nbsp;<span class="op" id="5748221">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5748233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748236">s</span><span class="op" id="5748237">.</span><span class="ident" id="5748238">mu</span><span class="op" id="5748240">.</span><span class="ident" id="5748241">Lock</span><span class="op" id="5748245">(</span><span class="op" id="5748246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748249">if</span>&nbsp;<span class="ident" id="5748252">s</span><span class="op" id="5748253">.</span><span class="ident" id="5748254">closed</span>&nbsp;<span class="op" id="5748261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748265">s</span><span class="op" id="5748266">.</span><span class="ident" id="5748267">mu</span><span class="op" id="5748269">.</span><span class="ident" id="5748270">Unlock</span><span class="op" id="5748276">(</span><span class="op" id="5748277">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748281">err</span>&nbsp;<span class="op" id="5748285">=</span>&nbsp;<span class="ident" id="5748287">errors</span><span class="op" id="5748293">.</span><span class="ident" id="5748294">New</span><span class="op" id="5748297">(</span><span class="string" id="5748298">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5748324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748328">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5748336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5748340">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5748400">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748432">if</span>&nbsp;<span class="ident" id="5748435">s</span><span class="op" id="5748436">.</span><span class="ident" id="5748437">tx</span>&nbsp;<span class="op" id="5748440">!=</span>&nbsp;<span class="ident" id="5748443">nil</span>&nbsp;<span class="op" id="5748447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748451">s</span><span class="op" id="5748452">.</span><span class="ident" id="5748453">mu</span><span class="op" id="5748455">.</span><span class="ident" id="5748456">Unlock</span><span class="op" id="5748462">(</span><span class="op" id="5748463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748467">ci</span><span class="op" id="5748469">,</span>&nbsp;<span class="ident" id="5748471">err</span>&nbsp;<span class="op" id="5748475">=</span>&nbsp;<span class="ident" id="5748477">s</span><span class="op" id="5748478">.</span><span class="ident" id="5748479">tx</span><span class="op" id="5748481">.</span><span class="ident" id="5748482">grabConn</span><span class="op" id="5748490">(</span><span class="op" id="5748491">)</span>&nbsp;<span class="comment" id="5748493">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748534">if</span>&nbsp;<span class="ident" id="5748537">err</span>&nbsp;<span class="op" id="5748541">!=</span>&nbsp;<span class="ident" id="5748544">nil</span>&nbsp;<span class="op" id="5748548">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748553">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5748562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748566">releaseConn</span>&nbsp;<span class="op" id="5748578">=</span>&nbsp;<span class="keyword" id="5748580">func</span><span class="op" id="5748584">(</span><span class="builtintype" id="5748585">error</span><span class="op" id="5748590">)</span>&nbsp;<span class="op" id="5748592">{</span><span class="op" id="5748593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748597">return</span>&nbsp;<span class="ident" id="5748604">ci</span><span class="op" id="5748606">,</span>&nbsp;<span class="ident" id="5748608">releaseConn</span><span class="op" id="5748619">,</span>&nbsp;<span class="ident" id="5748621">s</span><span class="op" id="5748622">.</span><span class="ident" id="5748623">txsi</span><span class="op" id="5748627">.</span><span class="ident" id="5748628">si</span><span class="op" id="5748630">,</span>&nbsp;<span class="ident" id="5748632">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5748637">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748641">for</span>&nbsp;<span class="ident" id="5748645">i</span>&nbsp;<span class="op" id="5748647">:=</span>&nbsp;<span class="num" id="5748650">0</span><span class="op" id="5748651">;</span>&nbsp;<span class="ident" id="5748653">i</span>&nbsp;<span class="op" id="5748655">&lt;</span>&nbsp;<span class="builtinfunc" id="5748657">len</span><span class="op" id="5748660">(</span><span class="ident" id="5748661">s</span><span class="op" id="5748662">.</span><span class="ident" id="5748663">css</span><span class="op" id="5748666">)</span><span class="op" id="5748667">;</span>&nbsp;<span class="ident" id="5748669">i</span><span class="op" id="5748670">++</span>&nbsp;<span class="op" id="5748673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748677">v</span>&nbsp;<span class="op" id="5748679">:=</span>&nbsp;<span class="ident" id="5748682">s</span><span class="op" id="5748683">.</span><span class="ident" id="5748684">css</span><span class="op" id="5748687">[</span><span class="ident" id="5748688">i</span><span class="op" id="5748689">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748693">_</span><span class="op" id="5748694">,</span>&nbsp;<span class="ident" id="5748696">err</span>&nbsp;<span class="op" id="5748700">:=</span>&nbsp;<span class="ident" id="5748703">s</span><span class="op" id="5748704">.</span><span class="ident" id="5748705">db</span><span class="op" id="5748707">.</span><span class="ident" id="5748708">connIfFree</span><span class="op" id="5748718">(</span><span class="ident" id="5748719">v</span><span class="op" id="5748720">.</span><span class="ident" id="5748721">dc</span><span class="op" id="5748723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748727">if</span>&nbsp;<span class="ident" id="5748730">err</span>&nbsp;<span class="op" id="5748734">==</span>&nbsp;<span class="ident" id="5748737">nil</span>&nbsp;<span class="op" id="5748741">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748746">s</span><span class="op" id="5748747">.</span><span class="ident" id="5748748">mu</span><span class="op" id="5748750">.</span><span class="ident" id="5748751">Unlock</span><span class="op" id="5748757">(</span><span class="op" id="5748758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748763">return</span>&nbsp;<span class="ident" id="5748770">v</span><span class="op" id="5748771">.</span><span class="ident" id="5748772">dc</span><span class="op" id="5748774">,</span>&nbsp;<span class="ident" id="5748776">v</span><span class="op" id="5748777">.</span><span class="ident" id="5748778">dc</span><span class="op" id="5748780">.</span><span class="ident" id="5748781">releaseConn</span><span class="op" id="5748792">,</span>&nbsp;<span class="ident" id="5748794">v</span><span class="op" id="5748795">.</span><span class="ident" id="5748796">si</span><span class="op" id="5748798">,</span>&nbsp;<span class="ident" id="5748800">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5748806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5748810">if</span>&nbsp;<span class="ident" id="5748813">err</span>&nbsp;<span class="op" id="5748817">==</span>&nbsp;<span class="ident" id="5748820">errConnClosed</span>&nbsp;<span class="op" id="5748834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5748839">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748888">s</span><span class="op" id="5748889">.</span><span class="ident" id="5748890">css</span><span class="op" id="5748893">[</span><span class="ident" id="5748894">i</span><span class="op" id="5748895">]</span>&nbsp;<span class="op" id="5748897">=</span>&nbsp;<span class="ident" id="5748899">s</span><span class="op" id="5748900">.</span><span class="ident" id="5748901">css</span><span class="op" id="5748904">[</span><span class="builtinfunc" id="5748905">len</span><span class="op" id="5748908">(</span><span class="ident" id="5748909">s</span><span class="op" id="5748910">.</span><span class="ident" id="5748911">css</span><span class="op" id="5748914">)</span><span class="op" id="5748915">-</span><span class="num" id="5748916">1</span><span class="op" id="5748917">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748922">s</span><span class="op" id="5748923">.</span><span class="ident" id="5748924">css</span>&nbsp;<span class="op" id="5748928">=</span>&nbsp;<span class="ident" id="5748930">s</span><span class="op" id="5748931">.</span><span class="ident" id="5748932">css</span><span class="op" id="5748935">[</span><span class="op" id="5748936">:</span><span class="builtinfunc" id="5748937">len</span><span class="op" id="5748940">(</span><span class="ident" id="5748941">s</span><span class="op" id="5748942">.</span><span class="ident" id="5748943">css</span><span class="op" id="5748946">)</span><span class="op" id="5748947">-</span><span class="num" id="5748948">1</span><span class="op" id="5748949">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748954">i</span><span class="op" id="5748955">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5748960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5748964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5748967">s</span><span class="op" id="5748968">.</span><span class="ident" id="5748969">mu</span><span class="op" id="5748971">.</span><span class="ident" id="5748972">Unlock</span><span class="op" id="5748978">(</span><span class="op" id="5748979">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5748983">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5749060">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5749134">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5749147">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5749151">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749220">dc</span><span class="op" id="5749222">,</span>&nbsp;<span class="ident" id="5749224">err</span>&nbsp;<span class="op" id="5749228">:=</span>&nbsp;<span class="ident" id="5749231">s</span><span class="op" id="5749232">.</span><span class="ident" id="5749233">db</span><span class="op" id="5749235">.</span><span class="ident" id="5749236">conn</span><span class="op" id="5749240">(</span><span class="op" id="5749241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5749244">if</span>&nbsp;<span class="ident" id="5749247">err</span>&nbsp;<span class="op" id="5749251">!=</span>&nbsp;<span class="ident" id="5749254">nil</span>&nbsp;<span class="op" id="5749258">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5749262">return</span>&nbsp;<span class="ident" id="5749269">nil</span><span class="op" id="5749272">,</span>&nbsp;<span class="ident" id="5749274">nil</span><span class="op" id="5749277">,</span>&nbsp;<span class="ident" id="5749279">nil</span><span class="op" id="5749282">,</span>&nbsp;<span class="ident" id="5749284">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5749289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5749293">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5749361">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749421">s</span><span class="op" id="5749422">.</span><span class="ident" id="5749423">mu</span><span class="op" id="5749425">.</span><span class="ident" id="5749426">Lock</span><span class="op" id="5749430">(</span><span class="op" id="5749431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5749434">for</span>&nbsp;<span class="ident" id="5749438">_</span><span class="op" id="5749439">,</span>&nbsp;<span class="ident" id="5749441">v</span>&nbsp;<span class="op" id="5749443">:=</span>&nbsp;<span class="keyword" id="5749446">range</span>&nbsp;<span class="ident" id="5749452">s</span><span class="op" id="5749453">.</span><span class="ident" id="5749454">css</span>&nbsp;<span class="op" id="5749458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5749462">if</span>&nbsp;<span class="ident" id="5749465">v</span><span class="op" id="5749466">.</span><span class="ident" id="5749467">dc</span>&nbsp;<span class="op" id="5749470">==</span>&nbsp;<span class="ident" id="5749473">dc</span>&nbsp;<span class="op" id="5749476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749481">s</span><span class="op" id="5749482">.</span><span class="ident" id="5749483">mu</span><span class="op" id="5749485">.</span><span class="ident" id="5749486">Unlock</span><span class="op" id="5749492">(</span><span class="op" id="5749493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5749498">return</span>&nbsp;<span class="ident" id="5749505">dc</span><span class="op" id="5749507">,</span>&nbsp;<span class="ident" id="5749509">dc</span><span class="op" id="5749511">.</span><span class="ident" id="5749512">releaseConn</span><span class="op" id="5749523">,</span>&nbsp;<span class="ident" id="5749525">v</span><span class="op" id="5749526">.</span><span class="ident" id="5749527">si</span><span class="op" id="5749529">,</span>&nbsp;<span class="ident" id="5749531">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5749537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5749540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749543">s</span><span class="op" id="5749544">.</span><span class="ident" id="5749545">mu</span><span class="op" id="5749547">.</span><span class="ident" id="5749548">Unlock</span><span class="op" id="5749554">(</span><span class="op" id="5749555">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5749559">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749624">dc</span><span class="op" id="5749626">.</span><span class="ident" id="5749627">Lock</span><span class="op" id="5749631">(</span><span class="op" id="5749632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749635">si</span><span class="op" id="5749637">,</span>&nbsp;<span class="ident" id="5749639">err</span>&nbsp;<span class="op" id="5749643">=</span>&nbsp;<span class="ident" id="5749645">dc</span><span class="op" id="5749647">.</span><span class="ident" id="5749648">prepareLocked</span><span class="op" id="5749661">(</span><span class="ident" id="5749662">s</span><span class="op" id="5749663">.</span><span class="ident" id="5749664">query</span><span class="op" id="5749669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749672">dc</span><span class="op" id="5749674">.</span><span class="ident" id="5749675">Unlock</span><span class="op" id="5749681">(</span><span class="op" id="5749682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5749685">if</span>&nbsp;<span class="ident" id="5749688">err</span>&nbsp;<span class="op" id="5749692">!=</span>&nbsp;<span class="ident" id="5749695">nil</span>&nbsp;<span class="op" id="5749699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749703">s</span><span class="op" id="5749704">.</span><span class="ident" id="5749705">db</span><span class="op" id="5749707">.</span><span class="ident" id="5749708">putConn</span><span class="op" id="5749715">(</span><span class="ident" id="5749716">dc</span><span class="op" id="5749718">,</span>&nbsp;<span class="ident" id="5749720">err</span><span class="op" id="5749723">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5749727">return</span>&nbsp;<span class="ident" id="5749734">nil</span><span class="op" id="5749737">,</span>&nbsp;<span class="ident" id="5749739">nil</span><span class="op" id="5749742">,</span>&nbsp;<span class="ident" id="5749744">nil</span><span class="op" id="5749747">,</span>&nbsp;<span class="ident" id="5749749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5749754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749757">s</span><span class="op" id="5749758">.</span><span class="ident" id="5749759">mu</span><span class="op" id="5749761">.</span><span class="ident" id="5749762">Lock</span><span class="op" id="5749766">(</span><span class="op" id="5749767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749770">cs</span>&nbsp;<span class="op" id="5749773">:=</span>&nbsp;<span class="ident" id="5749776">connStmt</span><span class="op" id="5749784">{</span><span class="ident" id="5749785">dc</span><span class="op" id="5749787">,</span>&nbsp;<span class="ident" id="5749789">si</span><span class="op" id="5749791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749794">s</span><span class="op" id="5749795">.</span><span class="ident" id="5749796">css</span>&nbsp;<span class="op" id="5749800">=</span>&nbsp;<span class="builtinfunc" id="5749802">append</span><span class="op" id="5749808">(</span><span class="ident" id="5749809">s</span><span class="op" id="5749810">.</span><span class="ident" id="5749811">css</span><span class="op" id="5749814">,</span>&nbsp;<span class="ident" id="5749816">cs</span><span class="op" id="5749818">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5749821">s</span><span class="op" id="5749822">.</span><span class="ident" id="5749823">mu</span><span class="op" id="5749825">.</span><span class="ident" id="5749826">Unlock</span><span class="op" id="5749832">(</span><span class="op" id="5749833">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5749837">return</span>&nbsp;<span class="ident" id="5749844">dc</span><span class="op" id="5749846">,</span>&nbsp;<span class="ident" id="5749848">dc</span><span class="op" id="5749850">.</span><span class="ident" id="5749851">releaseConn</span><span class="op" id="5749862">,</span>&nbsp;<span class="ident" id="5749864">si</span><span class="op" id="5749866">,</span>&nbsp;<span class="ident" id="5749868">nil</span><br>
<span class="lineno"></span><span class="op" id="5749872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="5749875">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="5749945">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="5749990">func</span>&nbsp;<span class="op" id="5749995">(</span><span class="ident" id="5749996">s</span>&nbsp;<span class="op" id="5749998">*</span><span class="ident" id="5749999">Stmt</span><span class="op" id="5750003">)</span>&nbsp;<span class="ident" id="5750005">Query</span><span class="op" id="5750010">(</span><span class="ident" id="5750011">args</span>&nbsp;<span class="op" id="5750016">...</span><span class="keyword" id="5750019">interface</span><span class="op" id="5750028">{</span><span class="op" id="5750029">}</span><span class="op" id="5750030">)</span>&nbsp;<span class="op" id="5750032">(</span><span class="op" id="5750033">*</span><span class="ident" id="5750034">Rows</span><span class="op" id="5750038">,</span>&nbsp;<span class="builtintype" id="5750040">error</span><span class="op" id="5750045">)</span>&nbsp;<span class="op" id="5750047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750050">s</span><span class="op" id="5750051">.</span><span class="ident" id="5750052">closemu</span><span class="op" id="5750059">.</span><span class="ident" id="5750060">RLock</span><span class="op" id="5750065">(</span><span class="op" id="5750066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750069">defer</span>&nbsp;<span class="ident" id="5750075">s</span><span class="op" id="5750076">.</span><span class="ident" id="5750077">closemu</span><span class="op" id="5750084">.</span><span class="ident" id="5750085">RUnlock</span><span class="op" id="5750092">(</span><span class="op" id="5750093">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750097">var</span>&nbsp;<span class="ident" id="5750101">rowsi</span>&nbsp;<span class="ident" id="5750107">driver</span><span class="op" id="5750113">.</span><span class="ident" id="5750114">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750120">for</span>&nbsp;<span class="ident" id="5750124">i</span>&nbsp;<span class="op" id="5750126">:=</span>&nbsp;<span class="num" id="5750129">0</span><span class="op" id="5750130">;</span>&nbsp;<span class="ident" id="5750132">i</span>&nbsp;<span class="op" id="5750134">&lt;</span>&nbsp;<span class="ident" id="5750136">maxBadConnRetries</span><span class="op" id="5750153">;</span>&nbsp;<span class="ident" id="5750155">i</span><span class="op" id="5750156">++</span>&nbsp;<span class="op" id="5750159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750163">dc</span><span class="op" id="5750165">,</span>&nbsp;<span class="ident" id="5750167">releaseConn</span><span class="op" id="5750178">,</span>&nbsp;<span class="ident" id="5750180">si</span><span class="op" id="5750182">,</span>&nbsp;<span class="ident" id="5750184">err</span>&nbsp;<span class="op" id="5750188">:=</span>&nbsp;<span class="ident" id="5750191">s</span><span class="op" id="5750192">.</span><span class="ident" id="5750193">connStmt</span><span class="op" id="5750201">(</span><span class="op" id="5750202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750206">if</span>&nbsp;<span class="ident" id="5750209">err</span>&nbsp;<span class="op" id="5750213">!=</span>&nbsp;<span class="ident" id="5750216">nil</span>&nbsp;<span class="op" id="5750220">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750225">if</span>&nbsp;<span class="ident" id="5750228">err</span>&nbsp;<span class="op" id="5750232">==</span>&nbsp;<span class="ident" id="5750235">driver</span><span class="op" id="5750241">.</span><span class="ident" id="5750242">ErrBadConn</span>&nbsp;<span class="op" id="5750253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750259">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5750271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750276">return</span>&nbsp;<span class="ident" id="5750283">nil</span><span class="op" id="5750286">,</span>&nbsp;<span class="ident" id="5750288">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5750294">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750299">rowsi</span><span class="op" id="5750304">,</span>&nbsp;<span class="ident" id="5750306">err</span>&nbsp;<span class="op" id="5750310">=</span>&nbsp;<span class="ident" id="5750312">rowsiFromStatement</span><span class="op" id="5750330">(</span><span class="ident" id="5750331">driverStmt</span><span class="op" id="5750341">{</span><span class="ident" id="5750342">dc</span><span class="op" id="5750344">,</span>&nbsp;<span class="ident" id="5750346">si</span><span class="op" id="5750348">}</span><span class="op" id="5750349">,</span>&nbsp;<span class="ident" id="5750351">args</span><span class="op" id="5750355">...</span><span class="op" id="5750358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750362">if</span>&nbsp;<span class="ident" id="5750365">err</span>&nbsp;<span class="op" id="5750369">==</span>&nbsp;<span class="ident" id="5750372">nil</span>&nbsp;<span class="op" id="5750376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5750381">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5750442">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750466">rows</span>&nbsp;<span class="op" id="5750471">:=</span>&nbsp;<span class="op" id="5750474">&amp;</span><span class="ident" id="5750475">Rows</span><span class="op" id="5750479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750485">dc</span><span class="op" id="5750487">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5750492">dc</span><span class="op" id="5750494">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750500">rowsi</span><span class="op" id="5750505">:</span>&nbsp;<span class="ident" id="5750507">rowsi</span><span class="op" id="5750512">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5750518">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5750546">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750551">s</span><span class="op" id="5750552">.</span><span class="ident" id="5750553">db</span><span class="op" id="5750555">.</span><span class="ident" id="5750556">addDep</span><span class="op" id="5750562">(</span><span class="ident" id="5750563">s</span><span class="op" id="5750564">,</span>&nbsp;<span class="ident" id="5750566">rows</span><span class="op" id="5750570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750575">rows</span><span class="op" id="5750579">.</span><span class="ident" id="5750580">releaseConn</span>&nbsp;<span class="op" id="5750592">=</span>&nbsp;<span class="keyword" id="5750594">func</span><span class="op" id="5750598">(</span><span class="ident" id="5750599">err</span>&nbsp;<span class="builtintype" id="5750603">error</span><span class="op" id="5750608">)</span>&nbsp;<span class="op" id="5750610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750616">releaseConn</span><span class="op" id="5750627">(</span><span class="ident" id="5750628">err</span><span class="op" id="5750631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750637">s</span><span class="op" id="5750638">.</span><span class="ident" id="5750639">db</span><span class="op" id="5750641">.</span><span class="ident" id="5750642">removeDep</span><span class="op" id="5750651">(</span><span class="ident" id="5750652">s</span><span class="op" id="5750653">,</span>&nbsp;<span class="ident" id="5750655">rows</span><span class="op" id="5750659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5750664">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750669">return</span>&nbsp;<span class="ident" id="5750676">rows</span><span class="op" id="5750680">,</span>&nbsp;<span class="ident" id="5750682">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5750688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750693">releaseConn</span><span class="op" id="5750704">(</span><span class="ident" id="5750705">err</span><span class="op" id="5750708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750712">if</span>&nbsp;<span class="ident" id="5750715">err</span>&nbsp;<span class="op" id="5750719">!=</span>&nbsp;<span class="ident" id="5750722">driver</span><span class="op" id="5750728">.</span><span class="ident" id="5750729">ErrBadConn</span>&nbsp;<span class="op" id="5750740">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750745">return</span>&nbsp;<span class="ident" id="5750752">nil</span><span class="op" id="5750755">,</span>&nbsp;<span class="ident" id="5750757">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5750763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5750766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5750769">return</span>&nbsp;<span class="ident" id="5750776">nil</span><span class="op" id="5750779">,</span>&nbsp;<span class="ident" id="5750781">driver</span><span class="op" id="5750787">.</span><span class="ident" id="5750788">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5750799">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="5750802">func</span>&nbsp;<span class="ident" id="5750807">rowsiFromStatement</span><span class="op" id="5750825">(</span><span class="ident" id="5750826">ds</span>&nbsp;<span class="ident" id="5750829">driverStmt</span><span class="op" id="5750839">,</span>&nbsp;<span class="ident" id="5750841">args</span>&nbsp;<span class="op" id="5750846">...</span><span class="keyword" id="5750849">interface</span><span class="op" id="5750858">{</span><span class="op" id="5750859">}</span><span class="op" id="5750860">)</span>&nbsp;<span class="op" id="5750862">(</span><span class="ident" id="5750863">driver</span><span class="op" id="5750869">.</span><span class="ident" id="5750870">Rows</span><span class="op" id="5750874">,</span>&nbsp;<span class="builtintype" id="5750876">error</span><span class="op" id="5750881">)</span>&nbsp;<span class="op" id="5750883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750886">ds</span><span class="op" id="5750888">.</span><span class="ident" id="5750889">Lock</span><span class="op" id="5750893">(</span><span class="op" id="5750894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750897">want</span>&nbsp;<span class="op" id="5750902">:=</span>&nbsp;<span class="ident" id="5750905">ds</span><span class="op" id="5750907">.</span><span class="ident" id="5750908">si</span><span class="op" id="5750910">.</span><span class="ident" id="5750911">NumInput</span><span class="op" id="5750919">(</span><span class="op" id="5750920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5750923">ds</span><span class="op" id="5750925">.</span><span class="ident" id="5750926">Unlock</span><span class="op" id="5750932">(</span><span class="op" id="5750933">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5750937">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5751001">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5751075">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5751104">if</span>&nbsp;<span class="ident" id="5751107">want</span>&nbsp;<span class="op" id="5751112">!=</span>&nbsp;<span class="op" id="5751115">-</span><span class="num" id="5751116">1</span>&nbsp;<span class="op" id="5751118">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5751121">len</span><span class="op" id="5751124">(</span><span class="ident" id="5751125">args</span><span class="op" id="5751129">)</span>&nbsp;<span class="op" id="5751131">!=</span>&nbsp;<span class="ident" id="5751134">want</span>&nbsp;<span class="op" id="5751139">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5751143">return</span>&nbsp;<span class="ident" id="5751150">nil</span><span class="op" id="5751153">,</span>&nbsp;<span class="ident" id="5751155">fmt</span><span class="op" id="5751158">.</span><span class="ident" id="5751159">Errorf</span><span class="op" id="5751165">(</span><span class="string" id="5751166">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5751208">,</span>&nbsp;<span class="ident" id="5751210">want</span><span class="op" id="5751214">,</span>&nbsp;<span class="builtinfunc" id="5751216">len</span><span class="op" id="5751219">(</span><span class="ident" id="5751220">args</span><span class="op" id="5751224">)</span><span class="op" id="5751225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5751228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5751232">dargs</span><span class="op" id="5751237">,</span>&nbsp;<span class="ident" id="5751239">err</span>&nbsp;<span class="op" id="5751243">:=</span>&nbsp;<span class="ident" id="5751246">driverArgs</span><span class="op" id="5751256">(</span><span class="op" id="5751257">&amp;</span><span class="ident" id="5751258">ds</span><span class="op" id="5751260">,</span>&nbsp;<span class="ident" id="5751262">args</span><span class="op" id="5751266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5751269">if</span>&nbsp;<span class="ident" id="5751272">err</span>&nbsp;<span class="op" id="5751276">!=</span>&nbsp;<span class="ident" id="5751279">nil</span>&nbsp;<span class="op" id="5751283">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5751287">return</span>&nbsp;<span class="ident" id="5751294">nil</span><span class="op" id="5751297">,</span>&nbsp;<span class="ident" id="5751299">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5751304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5751308">ds</span><span class="op" id="5751310">.</span><span class="ident" id="5751311">Lock</span><span class="op" id="5751315">(</span><span class="op" id="5751316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5751319">rowsi</span><span class="op" id="5751324">,</span>&nbsp;<span class="ident" id="5751326">err</span>&nbsp;<span class="op" id="5751330">:=</span>&nbsp;<span class="ident" id="5751333">ds</span><span class="op" id="5751335">.</span><span class="ident" id="5751336">si</span><span class="op" id="5751338">.</span><span class="ident" id="5751339">Query</span><span class="op" id="5751344">(</span><span class="ident" id="5751345">dargs</span><span class="op" id="5751350">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5751353">ds</span><span class="op" id="5751355">.</span><span class="ident" id="5751356">Unlock</span><span class="op" id="5751362">(</span><span class="op" id="5751363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5751366">if</span>&nbsp;<span class="ident" id="5751369">err</span>&nbsp;<span class="op" id="5751373">!=</span>&nbsp;<span class="ident" id="5751376">nil</span>&nbsp;<span class="op" id="5751380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5751384">return</span>&nbsp;<span class="ident" id="5751391">nil</span><span class="op" id="5751394">,</span>&nbsp;<span class="ident" id="5751396">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5751401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5751404">return</span>&nbsp;<span class="ident" id="5751411">rowsi</span><span class="op" id="5751416">,</span>&nbsp;<span class="ident" id="5751418">nil</span><br>
<span class="lineno">1495</span><span class="op" id="5751422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5751425">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="5751499">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5751576">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="5751656">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="5751728">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="5751800">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="5751813">//</span><br>
<span class="lineno"></span><span class="comment" id="5751816">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="5751834">//</span><br>
<span class="lineno"></span><span class="comment" id="5751837">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5751857">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="5751910">func</span>&nbsp;<span class="op" id="5751915">(</span><span class="ident" id="5751916">s</span>&nbsp;<span class="op" id="5751918">*</span><span class="ident" id="5751919">Stmt</span><span class="op" id="5751923">)</span>&nbsp;<span class="ident" id="5751925">QueryRow</span><span class="op" id="5751933">(</span><span class="ident" id="5751934">args</span>&nbsp;<span class="op" id="5751939">...</span><span class="keyword" id="5751942">interface</span><span class="op" id="5751951">{</span><span class="op" id="5751952">}</span><span class="op" id="5751953">)</span>&nbsp;<span class="op" id="5751955">*</span><span class="ident" id="5751956">Row</span>&nbsp;<span class="op" id="5751960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5751963">rows</span><span class="op" id="5751967">,</span>&nbsp;<span class="ident" id="5751969">err</span>&nbsp;<span class="op" id="5751973">:=</span>&nbsp;<span class="ident" id="5751976">s</span><span class="op" id="5751977">.</span><span class="ident" id="5751978">Query</span><span class="op" id="5751983">(</span><span class="ident" id="5751984">args</span><span class="op" id="5751988">...</span><span class="op" id="5751991">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5751994">if</span>&nbsp;<span class="ident" id="5751997">err</span>&nbsp;<span class="op" id="5752001">!=</span>&nbsp;<span class="ident" id="5752004">nil</span>&nbsp;<span class="op" id="5752008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752012">return</span>&nbsp;<span class="op" id="5752019">&amp;</span><span class="ident" id="5752020">Row</span><span class="op" id="5752023">{</span><span class="ident" id="5752024">err</span><span class="op" id="5752027">:</span>&nbsp;<span class="ident" id="5752029">err</span><span class="op" id="5752032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5752035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752038">return</span>&nbsp;<span class="op" id="5752045">&amp;</span><span class="ident" id="5752046">Row</span><span class="op" id="5752049">{</span><span class="ident" id="5752050">rows</span><span class="op" id="5752054">:</span>&nbsp;<span class="ident" id="5752056">rows</span><span class="op" id="5752060">}</span><br>
<span class="lineno"></span><span class="op" id="5752062">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="5752065">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5752096">func</span>&nbsp;<span class="op" id="5752101">(</span><span class="ident" id="5752102">s</span>&nbsp;<span class="op" id="5752104">*</span><span class="ident" id="5752105">Stmt</span><span class="op" id="5752109">)</span>&nbsp;<span class="ident" id="5752111">Close</span><span class="op" id="5752116">(</span><span class="op" id="5752117">)</span>&nbsp;<span class="builtintype" id="5752119">error</span>&nbsp;<span class="op" id="5752125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752128">s</span><span class="op" id="5752129">.</span><span class="ident" id="5752130">closemu</span><span class="op" id="5752137">.</span><span class="ident" id="5752138">Lock</span><span class="op" id="5752142">(</span><span class="op" id="5752143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752146">defer</span>&nbsp;<span class="ident" id="5752152">s</span><span class="op" id="5752153">.</span><span class="ident" id="5752154">closemu</span><span class="op" id="5752161">.</span><span class="ident" id="5752162">Unlock</span><span class="op" id="5752168">(</span><span class="op" id="5752169">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752173">if</span>&nbsp;<span class="ident" id="5752176">s</span><span class="op" id="5752177">.</span><span class="ident" id="5752178">stickyErr</span>&nbsp;<span class="op" id="5752188">!=</span>&nbsp;<span class="ident" id="5752191">nil</span>&nbsp;<span class="op" id="5752195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752199">return</span>&nbsp;<span class="ident" id="5752206">s</span><span class="op" id="5752207">.</span><span class="ident" id="5752208">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5752219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752222">s</span><span class="op" id="5752223">.</span><span class="ident" id="5752224">mu</span><span class="op" id="5752226">.</span><span class="ident" id="5752227">Lock</span><span class="op" id="5752231">(</span><span class="op" id="5752232">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752235">if</span>&nbsp;<span class="ident" id="5752238">s</span><span class="op" id="5752239">.</span><span class="ident" id="5752240">closed</span>&nbsp;<span class="op" id="5752247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752251">s</span><span class="op" id="5752252">.</span><span class="ident" id="5752253">mu</span><span class="op" id="5752255">.</span><span class="ident" id="5752256">Unlock</span><span class="op" id="5752262">(</span><span class="op" id="5752263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752267">return</span>&nbsp;<span class="ident" id="5752274">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5752279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752282">s</span><span class="op" id="5752283">.</span><span class="ident" id="5752284">closed</span>&nbsp;<span class="op" id="5752291">=</span>&nbsp;<span class="builtintype" id="5752293">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752300">if</span>&nbsp;<span class="ident" id="5752303">s</span><span class="op" id="5752304">.</span><span class="ident" id="5752305">tx</span>&nbsp;<span class="op" id="5752308">!=</span>&nbsp;<span class="ident" id="5752311">nil</span>&nbsp;<span class="op" id="5752315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752319">s</span><span class="op" id="5752320">.</span><span class="ident" id="5752321">txsi</span><span class="op" id="5752325">.</span><span class="ident" id="5752326">Close</span><span class="op" id="5752331">(</span><span class="op" id="5752332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752336">s</span><span class="op" id="5752337">.</span><span class="ident" id="5752338">mu</span><span class="op" id="5752340">.</span><span class="ident" id="5752341">Unlock</span><span class="op" id="5752347">(</span><span class="op" id="5752348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752352">return</span>&nbsp;<span class="ident" id="5752359">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5752364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752367">s</span><span class="op" id="5752368">.</span><span class="ident" id="5752369">mu</span><span class="op" id="5752371">.</span><span class="ident" id="5752372">Unlock</span><span class="op" id="5752378">(</span><span class="op" id="5752379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752383">return</span>&nbsp;<span class="ident" id="5752390">s</span><span class="op" id="5752391">.</span><span class="ident" id="5752392">db</span><span class="op" id="5752394">.</span><span class="ident" id="5752395">removeDep</span><span class="op" id="5752404">(</span><span class="ident" id="5752405">s</span><span class="op" id="5752406">,</span>&nbsp;<span class="ident" id="5752408">s</span><span class="op" id="5752409">)</span><br>
<span class="lineno"></span><span class="op" id="5752411">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="5752414">func</span>&nbsp;<span class="op" id="5752419">(</span><span class="ident" id="5752420">s</span>&nbsp;<span class="op" id="5752422">*</span><span class="ident" id="5752423">Stmt</span><span class="op" id="5752427">)</span>&nbsp;<span class="ident" id="5752429">finalClose</span><span class="op" id="5752439">(</span><span class="op" id="5752440">)</span>&nbsp;<span class="builtintype" id="5752442">error</span>&nbsp;<span class="op" id="5752448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752451">s</span><span class="op" id="5752452">.</span><span class="ident" id="5752453">mu</span><span class="op" id="5752455">.</span><span class="ident" id="5752456">Lock</span><span class="op" id="5752460">(</span><span class="op" id="5752461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752464">defer</span>&nbsp;<span class="ident" id="5752470">s</span><span class="op" id="5752471">.</span><span class="ident" id="5752472">mu</span><span class="op" id="5752474">.</span><span class="ident" id="5752475">Unlock</span><span class="op" id="5752481">(</span><span class="op" id="5752482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752485">if</span>&nbsp;<span class="ident" id="5752488">s</span><span class="op" id="5752489">.</span><span class="ident" id="5752490">css</span>&nbsp;<span class="op" id="5752494">!=</span>&nbsp;<span class="ident" id="5752497">nil</span>&nbsp;<span class="op" id="5752501">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752505">for</span>&nbsp;<span class="ident" id="5752509">_</span><span class="op" id="5752510">,</span>&nbsp;<span class="ident" id="5752512">v</span>&nbsp;<span class="op" id="5752514">:=</span>&nbsp;<span class="keyword" id="5752517">range</span>&nbsp;<span class="ident" id="5752523">s</span><span class="op" id="5752524">.</span><span class="ident" id="5752525">css</span>&nbsp;<span class="op" id="5752529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752534">s</span><span class="op" id="5752535">.</span><span class="ident" id="5752536">db</span><span class="op" id="5752538">.</span><span class="ident" id="5752539">noteUnusedDriverStatement</span><span class="op" id="5752564">(</span><span class="ident" id="5752565">v</span><span class="op" id="5752566">.</span><span class="ident" id="5752567">dc</span><span class="op" id="5752569">,</span>&nbsp;<span class="ident" id="5752571">v</span><span class="op" id="5752572">.</span><span class="ident" id="5752573">si</span><span class="op" id="5752575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752580">v</span><span class="op" id="5752581">.</span><span class="ident" id="5752582">dc</span><span class="op" id="5752584">.</span><span class="ident" id="5752585">removeOpenStmt</span><span class="op" id="5752599">(</span><span class="ident" id="5752600">v</span><span class="op" id="5752601">.</span><span class="ident" id="5752602">si</span><span class="op" id="5752604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5752608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5752612">s</span><span class="op" id="5752613">.</span><span class="ident" id="5752614">css</span>&nbsp;<span class="op" id="5752618">=</span>&nbsp;<span class="ident" id="5752620">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5752625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5752628">return</span>&nbsp;<span class="ident" id="5752635">nil</span><br>
<span class="lineno"></span><span class="op" id="5752639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5752642">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="5752715">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="5752775">//</span><br>
<span class="lineno"></span><span class="comment" id="5752778">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5752821">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5752832">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="5752858">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5752883">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="5752905">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5752932">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="5752971">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="5752986">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5752995">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="5753065">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="5753076">type</span>&nbsp;<span class="ident" id="5753081">Rows</span>&nbsp;<span class="keyword" id="5753086">struct</span>&nbsp;<span class="op" id="5753093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753096">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5753108">*</span><span class="ident" id="5753109">driverConn</span>&nbsp;<span class="comment" id="5753120">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753176">releaseConn</span>&nbsp;<span class="keyword" id="5753188">func</span><span class="op" id="5753192">(</span><span class="builtintype" id="5753193">error</span><span class="op" id="5753198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753201">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5753213">driver</span><span class="op" id="5753219">.</span><span class="ident" id="5753220">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753227">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5753237">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753243">lastcols</span>&nbsp;&nbsp;<span class="op" id="5753253">[</span><span class="op" id="5753254">]</span><span class="ident" id="5753255">driver</span><span class="op" id="5753261">.</span><span class="ident" id="5753262">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753269">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5753279">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5753291">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753326">closeStmt</span>&nbsp;<span class="ident" id="5753336">driver</span><span class="op" id="5753342">.</span><span class="ident" id="5753343">Stmt</span>&nbsp;<span class="comment" id="5753348">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="5753391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5753394">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="5753469">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5753549">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="5753629">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="5753647">//</span><br>
<span class="lineno"></span><span class="comment" id="5753650">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="5753729">func</span>&nbsp;<span class="op" id="5753734">(</span><span class="ident" id="5753735">rs</span>&nbsp;<span class="op" id="5753738">*</span><span class="ident" id="5753739">Rows</span><span class="op" id="5753743">)</span>&nbsp;<span class="ident" id="5753745">Next</span><span class="op" id="5753749">(</span><span class="op" id="5753750">)</span>&nbsp;<span class="builtintype" id="5753752">bool</span>&nbsp;<span class="op" id="5753757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5753760">if</span>&nbsp;<span class="ident" id="5753763">rs</span><span class="op" id="5753765">.</span><span class="ident" id="5753766">closed</span>&nbsp;<span class="op" id="5753773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5753777">return</span>&nbsp;<span class="builtintype" id="5753784">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5753791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5753794">if</span>&nbsp;<span class="ident" id="5753797">rs</span><span class="op" id="5753799">.</span><span class="ident" id="5753800">lastcols</span>&nbsp;<span class="op" id="5753809">==</span>&nbsp;<span class="ident" id="5753812">nil</span>&nbsp;<span class="op" id="5753816">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753820">rs</span><span class="op" id="5753822">.</span><span class="ident" id="5753823">lastcols</span>&nbsp;<span class="op" id="5753832">=</span>&nbsp;<span class="builtinfunc" id="5753834">make</span><span class="op" id="5753838">(</span><span class="op" id="5753839">[</span><span class="op" id="5753840">]</span><span class="ident" id="5753841">driver</span><span class="op" id="5753847">.</span><span class="ident" id="5753848">Value</span><span class="op" id="5753853">,</span>&nbsp;<span class="builtinfunc" id="5753855">len</span><span class="op" id="5753858">(</span><span class="ident" id="5753859">rs</span><span class="op" id="5753861">.</span><span class="ident" id="5753862">rowsi</span><span class="op" id="5753867">.</span><span class="ident" id="5753868">Columns</span><span class="op" id="5753875">(</span><span class="op" id="5753876">)</span><span class="op" id="5753877">)</span><span class="op" id="5753878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5753881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753884">rs</span><span class="op" id="5753886">.</span><span class="ident" id="5753887">lasterr</span>&nbsp;<span class="op" id="5753895">=</span>&nbsp;<span class="ident" id="5753897">rs</span><span class="op" id="5753899">.</span><span class="ident" id="5753900">rowsi</span><span class="op" id="5753905">.</span><span class="ident" id="5753906">Next</span><span class="op" id="5753910">(</span><span class="ident" id="5753911">rs</span><span class="op" id="5753913">.</span><span class="ident" id="5753914">lastcols</span><span class="op" id="5753922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5753925">if</span>&nbsp;<span class="ident" id="5753928">rs</span><span class="op" id="5753930">.</span><span class="ident" id="5753931">lasterr</span>&nbsp;<span class="op" id="5753939">!=</span>&nbsp;<span class="ident" id="5753942">nil</span>&nbsp;<span class="op" id="5753946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5753950">rs</span><span class="op" id="5753952">.</span><span class="ident" id="5753953">Close</span><span class="op" id="5753958">(</span><span class="op" id="5753959">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5753963">return</span>&nbsp;<span class="builtintype" id="5753970">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5753977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5753980">return</span>&nbsp;<span class="builtintype" id="5753987">true</span><br>
<span class="lineno"></span><span class="op" id="5753992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="5753995">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="5754068">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5754126">func</span>&nbsp;<span class="op" id="5754131">(</span><span class="ident" id="5754132">rs</span>&nbsp;<span class="op" id="5754135">*</span><span class="ident" id="5754136">Rows</span><span class="op" id="5754140">)</span>&nbsp;<span class="ident" id="5754142">Err</span><span class="op" id="5754145">(</span><span class="op" id="5754146">)</span>&nbsp;<span class="builtintype" id="5754148">error</span>&nbsp;<span class="op" id="5754154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754157">if</span>&nbsp;<span class="ident" id="5754160">rs</span><span class="op" id="5754162">.</span><span class="ident" id="5754163">lasterr</span>&nbsp;<span class="op" id="5754171">==</span>&nbsp;<span class="ident" id="5754174">io</span><span class="op" id="5754176">.</span><span class="ident" id="5754177">EOF</span>&nbsp;<span class="op" id="5754181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754185">return</span>&nbsp;<span class="ident" id="5754192">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5754197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754200">return</span>&nbsp;<span class="ident" id="5754207">rs</span><span class="op" id="5754209">.</span><span class="ident" id="5754210">lasterr</span><br>
<span class="lineno"></span><span class="op" id="5754218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5754221">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="5754258">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="5754325">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5754378">func</span>&nbsp;<span class="op" id="5754383">(</span><span class="ident" id="5754384">rs</span>&nbsp;<span class="op" id="5754387">*</span><span class="ident" id="5754388">Rows</span><span class="op" id="5754392">)</span>&nbsp;<span class="ident" id="5754394">Columns</span><span class="op" id="5754401">(</span><span class="op" id="5754402">)</span>&nbsp;<span class="op" id="5754404">(</span><span class="op" id="5754405">[</span><span class="op" id="5754406">]</span><span class="builtintype" id="5754407">string</span><span class="op" id="5754413">,</span>&nbsp;<span class="builtintype" id="5754415">error</span><span class="op" id="5754420">)</span>&nbsp;<span class="op" id="5754422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754425">if</span>&nbsp;<span class="ident" id="5754428">rs</span><span class="op" id="5754430">.</span><span class="ident" id="5754431">closed</span>&nbsp;<span class="op" id="5754438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754442">return</span>&nbsp;<span class="ident" id="5754449">nil</span><span class="op" id="5754452">,</span>&nbsp;<span class="ident" id="5754454">errors</span><span class="op" id="5754460">.</span><span class="ident" id="5754461">New</span><span class="op" id="5754464">(</span><span class="string" id="5754465">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5754487">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5754490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754493">if</span>&nbsp;<span class="ident" id="5754496">rs</span><span class="op" id="5754498">.</span><span class="ident" id="5754499">rowsi</span>&nbsp;<span class="op" id="5754505">==</span>&nbsp;<span class="ident" id="5754508">nil</span>&nbsp;<span class="op" id="5754512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754516">return</span>&nbsp;<span class="ident" id="5754523">nil</span><span class="op" id="5754526">,</span>&nbsp;<span class="ident" id="5754528">errors</span><span class="op" id="5754534">.</span><span class="ident" id="5754535">New</span><span class="op" id="5754538">(</span><span class="string" id="5754539">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="5754563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5754566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5754569">return</span>&nbsp;<span class="ident" id="5754576">rs</span><span class="op" id="5754578">.</span><span class="ident" id="5754579">rowsi</span><span class="op" id="5754584">.</span><span class="ident" id="5754585">Columns</span><span class="op" id="5754592">(</span><span class="op" id="5754593">)</span><span class="op" id="5754594">,</span>&nbsp;<span class="ident" id="5754596">nil</span><br>
<span class="lineno">1620</span><span class="op" id="5754600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5754603">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="5754673">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="5754688">//</span><br>
<span class="lineno">1625</span><span class="comment" id="5754691">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="5754762">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="5754832">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="5754903">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5754971">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="5755012">//</span><br>
<span class="lineno"></span><span class="comment" id="5755015">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5755078">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5755148">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="5755217">func</span>&nbsp;<span class="op" id="5755222">(</span><span class="ident" id="5755223">rs</span>&nbsp;<span class="op" id="5755226">*</span><span class="ident" id="5755227">Rows</span><span class="op" id="5755231">)</span>&nbsp;<span class="ident" id="5755233">Scan</span><span class="op" id="5755237">(</span><span class="ident" id="5755238">dest</span>&nbsp;<span class="op" id="5755243">...</span><span class="keyword" id="5755246">interface</span><span class="op" id="5755255">{</span><span class="op" id="5755256">}</span><span class="op" id="5755257">)</span>&nbsp;<span class="builtintype" id="5755259">error</span>&nbsp;<span class="op" id="5755265">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755268">if</span>&nbsp;<span class="ident" id="5755271">rs</span><span class="op" id="5755273">.</span><span class="ident" id="5755274">closed</span>&nbsp;<span class="op" id="5755281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755285">return</span>&nbsp;<span class="ident" id="5755292">errors</span><span class="op" id="5755298">.</span><span class="ident" id="5755299">New</span><span class="op" id="5755302">(</span><span class="string" id="5755303">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5755325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5755328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755331">if</span>&nbsp;<span class="ident" id="5755334">rs</span><span class="op" id="5755336">.</span><span class="ident" id="5755337">lastcols</span>&nbsp;<span class="op" id="5755346">==</span>&nbsp;<span class="ident" id="5755349">nil</span>&nbsp;<span class="op" id="5755353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755357">return</span>&nbsp;<span class="ident" id="5755364">errors</span><span class="op" id="5755370">.</span><span class="ident" id="5755371">New</span><span class="op" id="5755374">(</span><span class="string" id="5755375">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="5755414">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5755417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755420">if</span>&nbsp;<span class="builtinfunc" id="5755423">len</span><span class="op" id="5755426">(</span><span class="ident" id="5755427">dest</span><span class="op" id="5755431">)</span>&nbsp;<span class="op" id="5755433">!=</span>&nbsp;<span class="builtinfunc" id="5755436">len</span><span class="op" id="5755439">(</span><span class="ident" id="5755440">rs</span><span class="op" id="5755442">.</span><span class="ident" id="5755443">lastcols</span><span class="op" id="5755451">)</span>&nbsp;<span class="op" id="5755453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755457">return</span>&nbsp;<span class="ident" id="5755464">fmt</span><span class="op" id="5755467">.</span><span class="ident" id="5755468">Errorf</span><span class="op" id="5755474">(</span><span class="string" id="5755475">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="5755531">,</span>&nbsp;<span class="builtinfunc" id="5755533">len</span><span class="op" id="5755536">(</span><span class="ident" id="5755537">rs</span><span class="op" id="5755539">.</span><span class="ident" id="5755540">lastcols</span><span class="op" id="5755548">)</span><span class="op" id="5755549">,</span>&nbsp;<span class="builtinfunc" id="5755551">len</span><span class="op" id="5755554">(</span><span class="ident" id="5755555">dest</span><span class="op" id="5755559">)</span><span class="op" id="5755560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5755563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755566">for</span>&nbsp;<span class="ident" id="5755570">i</span><span class="op" id="5755571">,</span>&nbsp;<span class="ident" id="5755573">sv</span>&nbsp;<span class="op" id="5755576">:=</span>&nbsp;<span class="keyword" id="5755579">range</span>&nbsp;<span class="ident" id="5755585">rs</span><span class="op" id="5755587">.</span><span class="ident" id="5755588">lastcols</span>&nbsp;<span class="op" id="5755597">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5755601">err</span>&nbsp;<span class="op" id="5755605">:=</span>&nbsp;<span class="ident" id="5755608">convertAssign</span><span class="op" id="5755621">(</span><span class="ident" id="5755622">dest</span><span class="op" id="5755626">[</span><span class="ident" id="5755627">i</span><span class="op" id="5755628">]</span><span class="op" id="5755629">,</span>&nbsp;<span class="ident" id="5755631">sv</span><span class="op" id="5755633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755637">if</span>&nbsp;<span class="ident" id="5755640">err</span>&nbsp;<span class="op" id="5755644">!=</span>&nbsp;<span class="ident" id="5755647">nil</span>&nbsp;<span class="op" id="5755651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755656">return</span>&nbsp;<span class="ident" id="5755663">fmt</span><span class="op" id="5755666">.</span><span class="ident" id="5755667">Errorf</span><span class="op" id="5755673">(</span><span class="string" id="5755674">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="5755714">,</span>&nbsp;<span class="ident" id="5755716">i</span><span class="op" id="5755717">,</span>&nbsp;<span class="ident" id="5755719">err</span><span class="op" id="5755722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5755726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5755729">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5755732">return</span>&nbsp;<span class="ident" id="5755739">nil</span><br>
<span class="lineno"></span><span class="op" id="5755743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5755746">var</span>&nbsp;<span class="ident" id="5755750">rowsCloseHook</span>&nbsp;<span class="keyword" id="5755764">func</span><span class="op" id="5755768">(</span><span class="op" id="5755769">*</span><span class="ident" id="5755770">Rows</span><span class="op" id="5755774">,</span>&nbsp;<span class="op" id="5755776">*</span><span class="builtintype" id="5755777">error</span><span class="op" id="5755782">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="5755785">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5755859">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5755936">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="5756013">func</span>&nbsp;<span class="op" id="5756018">(</span><span class="ident" id="5756019">rs</span>&nbsp;<span class="op" id="5756022">*</span><span class="ident" id="5756023">Rows</span><span class="op" id="5756027">)</span>&nbsp;<span class="ident" id="5756029">Close</span><span class="op" id="5756034">(</span><span class="op" id="5756035">)</span>&nbsp;<span class="builtintype" id="5756037">error</span>&nbsp;<span class="op" id="5756043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756046">if</span>&nbsp;<span class="ident" id="5756049">rs</span><span class="op" id="5756051">.</span><span class="ident" id="5756052">closed</span>&nbsp;<span class="op" id="5756059">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756063">return</span>&nbsp;<span class="ident" id="5756070">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756078">rs</span><span class="op" id="5756080">.</span><span class="ident" id="5756081">closed</span>&nbsp;<span class="op" id="5756088">=</span>&nbsp;<span class="builtintype" id="5756090">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756096">err</span>&nbsp;<span class="op" id="5756100">:=</span>&nbsp;<span class="ident" id="5756103">rs</span><span class="op" id="5756105">.</span><span class="ident" id="5756106">rowsi</span><span class="op" id="5756111">.</span><span class="ident" id="5756112">Close</span><span class="op" id="5756117">(</span><span class="op" id="5756118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756121">if</span>&nbsp;<span class="ident" id="5756124">fn</span>&nbsp;<span class="op" id="5756127">:=</span>&nbsp;<span class="ident" id="5756130">rowsCloseHook</span><span class="op" id="5756143">;</span>&nbsp;<span class="ident" id="5756145">fn</span>&nbsp;<span class="op" id="5756148">!=</span>&nbsp;<span class="ident" id="5756151">nil</span>&nbsp;<span class="op" id="5756155">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756159">fn</span><span class="op" id="5756161">(</span><span class="ident" id="5756162">rs</span><span class="op" id="5756164">,</span>&nbsp;<span class="op" id="5756166">&amp;</span><span class="ident" id="5756167">err</span><span class="op" id="5756170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756176">if</span>&nbsp;<span class="ident" id="5756179">rs</span><span class="op" id="5756181">.</span><span class="ident" id="5756182">closeStmt</span>&nbsp;<span class="op" id="5756192">!=</span>&nbsp;<span class="ident" id="5756195">nil</span>&nbsp;<span class="op" id="5756199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756203">rs</span><span class="op" id="5756205">.</span><span class="ident" id="5756206">closeStmt</span><span class="op" id="5756215">.</span><span class="ident" id="5756216">Close</span><span class="op" id="5756221">(</span><span class="op" id="5756222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756225">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756228">rs</span><span class="op" id="5756230">.</span><span class="ident" id="5756231">releaseConn</span><span class="op" id="5756242">(</span><span class="ident" id="5756243">err</span><span class="op" id="5756246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756249">return</span>&nbsp;<span class="ident" id="5756256">err</span><br>
<span class="lineno"></span><span class="op" id="5756260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5756263">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="5756328">type</span>&nbsp;<span class="ident" id="5756333">Row</span>&nbsp;<span class="keyword" id="5756337">struct</span>&nbsp;<span class="op" id="5756344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5756347">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756385">err</span>&nbsp;&nbsp;<span class="builtintype" id="5756390">error</span>&nbsp;<span class="comment" id="5756396">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5756433">rows</span>&nbsp;<span class="op" id="5756438">*</span><span class="ident" id="5756439">Rows</span><br>
<span class="lineno"></span><span class="op" id="5756444">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="5756447">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5756511">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="5756575">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="5756644">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="5756682">func</span>&nbsp;<span class="op" id="5756687">(</span><span class="ident" id="5756688">r</span>&nbsp;<span class="op" id="5756690">*</span><span class="ident" id="5756691">Row</span><span class="op" id="5756694">)</span>&nbsp;<span class="ident" id="5756696">Scan</span><span class="op" id="5756700">(</span><span class="ident" id="5756701">dest</span>&nbsp;<span class="op" id="5756706">...</span><span class="keyword" id="5756709">interface</span><span class="op" id="5756718">{</span><span class="op" id="5756719">}</span><span class="op" id="5756720">)</span>&nbsp;<span class="builtintype" id="5756722">error</span>&nbsp;<span class="op" id="5756728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756731">if</span>&nbsp;<span class="ident" id="5756734">r</span><span class="op" id="5756735">.</span><span class="ident" id="5756736">err</span>&nbsp;<span class="op" id="5756740">!=</span>&nbsp;<span class="ident" id="5756743">nil</span>&nbsp;<span class="op" id="5756747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5756751">return</span>&nbsp;<span class="ident" id="5756758">r</span><span class="op" id="5756759">.</span><span class="ident" id="5756760">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5756765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5756769">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5756830">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5756882">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5756938">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757000">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757064">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757125">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757189">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757250">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757306">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757368">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757429">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757492">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757508">defer</span>&nbsp;<span class="ident" id="5757514">r</span><span class="op" id="5757515">.</span><span class="ident" id="5757516">rows</span><span class="op" id="5757520">.</span><span class="ident" id="5757521">Close</span><span class="op" id="5757526">(</span><span class="op" id="5757527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757530">for</span>&nbsp;<span class="ident" id="5757534">_</span><span class="op" id="5757535">,</span>&nbsp;<span class="ident" id="5757537">dp</span>&nbsp;<span class="op" id="5757540">:=</span>&nbsp;<span class="keyword" id="5757543">range</span>&nbsp;<span class="ident" id="5757549">dest</span>&nbsp;<span class="op" id="5757554">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757558">if</span>&nbsp;<span class="ident" id="5757561">_</span><span class="op" id="5757562">,</span>&nbsp;<span class="ident" id="5757564">ok</span>&nbsp;<span class="op" id="5757567">:=</span>&nbsp;<span class="ident" id="5757570">dp</span><span class="op" id="5757572">.</span><span class="op" id="5757573">(</span><span class="op" id="5757574">*</span><span class="ident" id="5757575">RawBytes</span><span class="op" id="5757583">)</span><span class="op" id="5757584">;</span>&nbsp;<span class="ident" id="5757586">ok</span>&nbsp;<span class="op" id="5757589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757594">return</span>&nbsp;<span class="ident" id="5757601">errors</span><span class="op" id="5757607">.</span><span class="ident" id="5757608">New</span><span class="op" id="5757611">(</span><span class="string" id="5757612">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="5757653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5757657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5757660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757664">if</span>&nbsp;<span class="op" id="5757667">!</span><span class="ident" id="5757668">r</span><span class="op" id="5757669">.</span><span class="ident" id="5757670">rows</span><span class="op" id="5757674">.</span><span class="ident" id="5757675">Next</span><span class="op" id="5757679">(</span><span class="op" id="5757680">)</span>&nbsp;<span class="op" id="5757682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757686">if</span>&nbsp;<span class="ident" id="5757689">err</span>&nbsp;<span class="op" id="5757693">:=</span>&nbsp;<span class="ident" id="5757696">r</span><span class="op" id="5757697">.</span><span class="ident" id="5757698">rows</span><span class="op" id="5757702">.</span><span class="ident" id="5757703">Err</span><span class="op" id="5757706">(</span><span class="op" id="5757707">)</span><span class="op" id="5757708">;</span>&nbsp;<span class="ident" id="5757710">err</span>&nbsp;<span class="op" id="5757714">!=</span>&nbsp;<span class="ident" id="5757717">nil</span>&nbsp;<span class="op" id="5757721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757726">return</span>&nbsp;<span class="ident" id="5757733">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5757739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757743">return</span>&nbsp;<span class="ident" id="5757750">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5757761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757764">err</span>&nbsp;<span class="op" id="5757768">:=</span>&nbsp;<span class="ident" id="5757771">r</span><span class="op" id="5757772">.</span><span class="ident" id="5757773">rows</span><span class="op" id="5757777">.</span><span class="ident" id="5757778">Scan</span><span class="op" id="5757782">(</span><span class="ident" id="5757783">dest</span><span class="op" id="5757787">...</span><span class="op" id="5757790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757793">if</span>&nbsp;<span class="ident" id="5757796">err</span>&nbsp;<span class="op" id="5757800">!=</span>&nbsp;<span class="ident" id="5757803">nil</span>&nbsp;<span class="op" id="5757807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757811">return</span>&nbsp;<span class="ident" id="5757818">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5757823">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757826">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757897">if</span>&nbsp;<span class="ident" id="5757900">err</span>&nbsp;<span class="op" id="5757904">:=</span>&nbsp;<span class="ident" id="5757907">r</span><span class="op" id="5757908">.</span><span class="ident" id="5757909">rows</span><span class="op" id="5757913">.</span><span class="ident" id="5757914">Close</span><span class="op" id="5757919">(</span><span class="op" id="5757920">)</span><span class="op" id="5757921">;</span>&nbsp;<span class="ident" id="5757923">err</span>&nbsp;<span class="op" id="5757927">!=</span>&nbsp;<span class="ident" id="5757930">nil</span>&nbsp;<span class="op" id="5757934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757938">return</span>&nbsp;<span class="ident" id="5757945">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5757950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757954">return</span>&nbsp;<span class="ident" id="5757961">nil</span><br>
<span class="lineno"></span><span class="op" id="5757965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5757968">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5758016">type</span>&nbsp;<span class="ident" id="5758021">Result</span>&nbsp;<span class="keyword" id="5758028">interface</span>&nbsp;<span class="op" id="5758038">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758041">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758104">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758165">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758227">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758286">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758309">LastInsertId</span><span class="op" id="5758321">(</span><span class="op" id="5758322">)</span>&nbsp;<span class="op" id="5758324">(</span><span class="ident" id="5758325">int64</span><span class="op" id="5758330">,</span>&nbsp;<span class="builtintype" id="5758332">error</span><span class="op" id="5758337">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758341">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758400">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758462">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758491">RowsAffected</span><span class="op" id="5758503">(</span><span class="op" id="5758504">)</span>&nbsp;<span class="op" id="5758506">(</span><span class="ident" id="5758507">int64</span><span class="op" id="5758512">,</span>&nbsp;<span class="builtintype" id="5758514">error</span><span class="op" id="5758519">)</span><br>
<span class="lineno"></span><span class="op" id="5758521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5758524">type</span>&nbsp;<span class="ident" id="5758529">driverResult</span>&nbsp;<span class="keyword" id="5758542">struct</span>&nbsp;<span class="op" id="5758549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758552">sync</span><span class="op" id="5758556">.</span><span class="ident" id="5758557">Locker</span>&nbsp;<span class="comment" id="5758564">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758584">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5758596">driver</span><span class="op" id="5758602">.</span><span class="ident" id="5758603">Result</span><br>
<span class="lineno"></span><span class="op" id="5758610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5758613">func</span>&nbsp;<span class="op" id="5758618">(</span><span class="ident" id="5758619">dr</span>&nbsp;<span class="ident" id="5758622">driverResult</span><span class="op" id="5758634">)</span>&nbsp;<span class="ident" id="5758636">LastInsertId</span><span class="op" id="5758648">(</span><span class="op" id="5758649">)</span>&nbsp;<span class="op" id="5758651">(</span><span class="ident" id="5758652">int64</span><span class="op" id="5758657">,</span>&nbsp;<span class="builtintype" id="5758659">error</span><span class="op" id="5758664">)</span>&nbsp;<span class="op" id="5758666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758669">dr</span><span class="op" id="5758671">.</span><span class="ident" id="5758672">Lock</span><span class="op" id="5758676">(</span><span class="op" id="5758677">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758680">defer</span>&nbsp;<span class="ident" id="5758686">dr</span><span class="op" id="5758688">.</span><span class="ident" id="5758689">Unlock</span><span class="op" id="5758695">(</span><span class="op" id="5758696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758699">return</span>&nbsp;<span class="ident" id="5758706">dr</span><span class="op" id="5758708">.</span><span class="ident" id="5758709">resi</span><span class="op" id="5758713">.</span><span class="ident" id="5758714">LastInsertId</span><span class="op" id="5758726">(</span><span class="op" id="5758727">)</span><br>
<span class="lineno"></span><span class="op" id="5758729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5758732">func</span>&nbsp;<span class="op" id="5758737">(</span><span class="ident" id="5758738">dr</span>&nbsp;<span class="ident" id="5758741">driverResult</span><span class="op" id="5758753">)</span>&nbsp;<span class="ident" id="5758755">RowsAffected</span><span class="op" id="5758767">(</span><span class="op" id="5758768">)</span>&nbsp;<span class="op" id="5758770">(</span><span class="ident" id="5758771">int64</span><span class="op" id="5758776">,</span>&nbsp;<span class="builtintype" id="5758778">error</span><span class="op" id="5758783">)</span>&nbsp;<span class="op" id="5758785">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758788">dr</span><span class="op" id="5758790">.</span><span class="ident" id="5758791">Lock</span><span class="op" id="5758795">(</span><span class="op" id="5758796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758799">defer</span>&nbsp;<span class="ident" id="5758805">dr</span><span class="op" id="5758807">.</span><span class="ident" id="5758808">Unlock</span><span class="op" id="5758814">(</span><span class="op" id="5758815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758818">return</span>&nbsp;<span class="ident" id="5758825">dr</span><span class="op" id="5758827">.</span><span class="ident" id="5758828">resi</span><span class="op" id="5758832">.</span><span class="ident" id="5758833">RowsAffected</span><span class="op" id="5758845">(</span><span class="op" id="5758846">)</span><br>
<span class="lineno"></span><span class="op" id="5758848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="5758851">func</span>&nbsp;<span class="ident" id="5758856">stack</span><span class="op" id="5758861">(</span><span class="op" id="5758862">)</span>&nbsp;<span class="builtintype" id="5758864">string</span>&nbsp;<span class="op" id="5758871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758874">var</span>&nbsp;<span class="ident" id="5758878">buf</span>&nbsp;<span class="op" id="5758882">[</span><span class="num" id="5758883">2</span>&nbsp;<span class="op" id="5758885">&lt;&lt;</span>&nbsp;<span class="num" id="5758888">10</span><span class="op" id="5758890">]</span><span class="builtintype" id="5758891">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758897">return</span>&nbsp;<span class="builtintype" id="5758904">string</span><span class="op" id="5758910">(</span><span class="ident" id="5758911">buf</span><span class="op" id="5758914">[</span><span class="op" id="5758915">:</span><span class="ident" id="5758916">runtime</span><span class="op" id="5758923">.</span><span class="ident" id="5758924">Stack</span><span class="op" id="5758929">(</span><span class="ident" id="5758930">buf</span><span class="op" id="5758933">[</span><span class="op" id="5758934">:</span><span class="op" id="5758935">]</span><span class="op" id="5758936">,</span>&nbsp;<span class="builtintype" id="5758938">false</span><span class="op" id="5758943">)</span><span class="op" id="5758944">]</span><span class="op" id="5758945">)</span><br>
<span class="lineno"></span><span class="op" id="5758947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="5758950">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="5758985">func</span>&nbsp;<span class="ident" id="5758990">withLock</span><span class="op" id="5758998">(</span><span class="ident" id="5758999">lk</span>&nbsp;<span class="ident" id="5759002">sync</span><span class="op" id="5759006">.</span><span class="ident" id="5759007">Locker</span><span class="op" id="5759013">,</span>&nbsp;<span class="ident" id="5759015">fn</span>&nbsp;<span class="keyword" id="5759018">func</span><span class="op" id="5759022">(</span><span class="op" id="5759023">)</span><span class="op" id="5759024">)</span>&nbsp;<span class="op" id="5759026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759029">lk</span><span class="op" id="5759031">.</span><span class="ident" id="5759032">Lock</span><span class="op" id="5759036">(</span><span class="op" id="5759037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759040">fn</span><span class="op" id="5759042">(</span><span class="op" id="5759043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759046">lk</span><span class="op" id="5759048">.</span><span class="ident" id="5759049">Unlock</span><span class="op" id="5759055">(</span><span class="op" id="5759056">)</span><br>
<span class="lineno">1770</span><span class="op" id="5759058">}</span>
</div>
</body>
</html>
