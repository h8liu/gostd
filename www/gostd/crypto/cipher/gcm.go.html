<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3530343">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3530398">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3530452">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3530503">package</span>&nbsp;<span class="ident" id="3530511">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3530519">import</span>&nbsp;<span class="op" id="3530526">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3530529">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3530546">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3530555">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3530558">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="3530634">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3530643">type</span>&nbsp;<span class="ident" id="3530648">AEAD</span>&nbsp;<span class="keyword" id="3530653">interface</span>&nbsp;<span class="op" id="3530663">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530666">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530738">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530752">NonceSize</span><span class="op" id="3530761">(</span><span class="op" id="3530762">)</span>&nbsp;<span class="builtintype" id="3530764">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530770">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530839">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530869">Overhead</span><span class="op" id="3530877">(</span><span class="op" id="3530878">)</span>&nbsp;<span class="builtintype" id="3530880">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530886">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530951">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531024">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531095">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531122">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531126">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531185">Seal</span><span class="op" id="3531189">(</span><span class="ident" id="3531190">dst</span><span class="op" id="3531193">,</span>&nbsp;<span class="ident" id="3531195">nonce</span><span class="op" id="3531200">,</span>&nbsp;<span class="ident" id="3531202">plaintext</span><span class="op" id="3531211">,</span>&nbsp;<span class="ident" id="3531213">data</span>&nbsp;<span class="op" id="3531218">[</span><span class="op" id="3531219">]</span><span class="builtintype" id="3531220">byte</span><span class="op" id="3531224">)</span>&nbsp;<span class="op" id="3531226">[</span><span class="op" id="3531227">]</span><span class="builtintype" id="3531228">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531235">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531301">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531373">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531444">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531510">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531536">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531540">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531600">Open</span><span class="op" id="3531604">(</span><span class="ident" id="3531605">dst</span><span class="op" id="3531608">,</span>&nbsp;<span class="ident" id="3531610">nonce</span><span class="op" id="3531615">,</span>&nbsp;<span class="ident" id="3531617">ciphertext</span><span class="op" id="3531627">,</span>&nbsp;<span class="ident" id="3531629">data</span>&nbsp;<span class="op" id="3531634">[</span><span class="op" id="3531635">]</span><span class="builtintype" id="3531636">byte</span><span class="op" id="3531640">)</span>&nbsp;<span class="op" id="3531642">(</span><span class="op" id="3531643">[</span><span class="op" id="3531644">]</span><span class="builtintype" id="3531645">byte</span><span class="op" id="3531649">,</span>&nbsp;<span class="builtintype" id="3531651">error</span><span class="op" id="3531656">)</span><br>
<span class="lineno"></span><span class="op" id="3531658">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="3531661">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment" id="3531744">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3531822">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment" id="3531860">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment" id="3531921">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3531982">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="3532047">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3532111">type</span>&nbsp;<span class="ident" id="3532116">gcmFieldElement</span>&nbsp;<span class="keyword" id="3532132">struct</span>&nbsp;<span class="op" id="3532139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532142">low</span><span class="op" id="3532145">,</span>&nbsp;<span class="ident" id="3532147">high</span>&nbsp;<span class="ident" id="3532152">uint64</span><br>
<span class="lineno">50</span><span class="op" id="3532159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532162">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment" id="3532227">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword" id="3532322">type</span>&nbsp;<span class="ident" id="3532327">gcm</span>&nbsp;<span class="keyword" id="3532331">struct</span>&nbsp;<span class="op" id="3532338">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532341">cipher</span>&nbsp;<span class="ident" id="3532348">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3532355">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3532421">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532478">productTable</span>&nbsp;<span class="op" id="3532491">[</span><span class="num" id="3532492">16</span><span class="op" id="3532494">]</span><span class="ident" id="3532495">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op" id="3532511">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3532514">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword" id="3532596">func</span>&nbsp;<span class="ident" id="3532601">NewGCM</span><span class="op" id="3532607">(</span><span class="ident" id="3532608">cipher</span>&nbsp;<span class="ident" id="3532615">Block</span><span class="op" id="3532620">)</span>&nbsp;<span class="op" id="3532622">(</span><span class="ident" id="3532623">AEAD</span><span class="op" id="3532627">,</span>&nbsp;<span class="builtintype" id="3532629">error</span><span class="op" id="3532634">)</span>&nbsp;<span class="op" id="3532636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532639">if</span>&nbsp;<span class="ident" id="3532642">cipher</span><span class="op" id="3532648">.</span><span class="ident" id="3532649">BlockSize</span><span class="op" id="3532658">(</span><span class="op" id="3532659">)</span>&nbsp;<span class="op" id="3532661">!=</span>&nbsp;<span class="ident" id="3532664">gcmBlockSize</span>&nbsp;<span class="op" id="3532677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532681">return</span>&nbsp;<span class="ident" id="3532688">nil</span><span class="op" id="3532691">,</span>&nbsp;<span class="ident" id="3532693">errors</span><span class="op" id="3532699">.</span><span class="ident" id="3532700">New</span><span class="op" id="3532703">(</span><span class="string" id="3532704">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op" id="3532750">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532757">var</span>&nbsp;<span class="ident" id="3532761">key</span>&nbsp;<span class="op" id="3532765">[</span><span class="ident" id="3532766">gcmBlockSize</span><span class="op" id="3532778">]</span><span class="builtintype" id="3532779">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532785">cipher</span><span class="op" id="3532791">.</span><span class="ident" id="3532792">Encrypt</span><span class="op" id="3532799">(</span><span class="ident" id="3532800">key</span><span class="op" id="3532803">[</span><span class="op" id="3532804">:</span><span class="op" id="3532805">]</span><span class="op" id="3532806">,</span>&nbsp;<span class="ident" id="3532808">key</span><span class="op" id="3532811">[</span><span class="op" id="3532812">:</span><span class="op" id="3532813">]</span><span class="op" id="3532814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532818">g</span>&nbsp;<span class="op" id="3532820">:=</span>&nbsp;<span class="op" id="3532823">&amp;</span><span class="ident" id="3532824">gcm</span><span class="op" id="3532827">{</span><span class="ident" id="3532828">cipher</span><span class="op" id="3532834">:</span>&nbsp;<span class="ident" id="3532836">cipher</span><span class="op" id="3532842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3532846">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3532915">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3532980">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533049">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533119">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533189">x</span>&nbsp;<span class="op" id="3533191">:=</span>&nbsp;<span class="ident" id="3533194">gcmFieldElement</span><span class="op" id="3533209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533213">getUint64</span><span class="op" id="3533222">(</span><span class="ident" id="3533223">key</span><span class="op" id="3533226">[</span><span class="op" id="3533227">:</span><span class="num" id="3533228">8</span><span class="op" id="3533229">]</span><span class="op" id="3533230">)</span><span class="op" id="3533231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533235">getUint64</span><span class="op" id="3533244">(</span><span class="ident" id="3533245">key</span><span class="op" id="3533248">[</span><span class="num" id="3533249">8</span><span class="op" id="3533250">:</span><span class="op" id="3533251">]</span><span class="op" id="3533252">)</span><span class="op" id="3533253">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533259">g</span><span class="op" id="3533260">.</span><span class="ident" id="3533261">productTable</span><span class="op" id="3533273">[</span><span class="ident" id="3533274">reverseBits</span><span class="op" id="3533285">(</span><span class="num" id="3533286">1</span><span class="op" id="3533287">)</span><span class="op" id="3533288">]</span>&nbsp;<span class="op" id="3533290">=</span>&nbsp;<span class="ident" id="3533292">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533296">for</span>&nbsp;<span class="ident" id="3533300">i</span>&nbsp;<span class="op" id="3533302">:=</span>&nbsp;<span class="num" id="3533305">2</span><span class="op" id="3533306">;</span>&nbsp;<span class="ident" id="3533308">i</span>&nbsp;<span class="op" id="3533310">&lt;</span>&nbsp;<span class="num" id="3533312">16</span><span class="op" id="3533314">;</span>&nbsp;<span class="ident" id="3533316">i</span>&nbsp;<span class="op" id="3533318">+=</span>&nbsp;<span class="num" id="3533321">2</span>&nbsp;<span class="op" id="3533323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533327">g</span><span class="op" id="3533328">.</span><span class="ident" id="3533329">productTable</span><span class="op" id="3533341">[</span><span class="ident" id="3533342">reverseBits</span><span class="op" id="3533353">(</span><span class="ident" id="3533354">i</span><span class="op" id="3533355">)</span><span class="op" id="3533356">]</span>&nbsp;<span class="op" id="3533358">=</span>&nbsp;<span class="ident" id="3533360">gcmDouble</span><span class="op" id="3533369">(</span><span class="op" id="3533370">&amp;</span><span class="ident" id="3533371">g</span><span class="op" id="3533372">.</span><span class="ident" id="3533373">productTable</span><span class="op" id="3533385">[</span><span class="ident" id="3533386">reverseBits</span><span class="op" id="3533397">(</span><span class="ident" id="3533398">i</span><span class="op" id="3533399">/</span><span class="num" id="3533400">2</span><span class="op" id="3533401">)</span><span class="op" id="3533402">]</span><span class="op" id="3533403">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533407">g</span><span class="op" id="3533408">.</span><span class="ident" id="3533409">productTable</span><span class="op" id="3533421">[</span><span class="ident" id="3533422">reverseBits</span><span class="op" id="3533433">(</span><span class="ident" id="3533434">i</span><span class="op" id="3533435">+</span><span class="num" id="3533436">1</span><span class="op" id="3533437">)</span><span class="op" id="3533438">]</span>&nbsp;<span class="op" id="3533440">=</span>&nbsp;<span class="ident" id="3533442">gcmAdd</span><span class="op" id="3533448">(</span><span class="op" id="3533449">&amp;</span><span class="ident" id="3533450">g</span><span class="op" id="3533451">.</span><span class="ident" id="3533452">productTable</span><span class="op" id="3533464">[</span><span class="ident" id="3533465">reverseBits</span><span class="op" id="3533476">(</span><span class="ident" id="3533477">i</span><span class="op" id="3533478">)</span><span class="op" id="3533479">]</span><span class="op" id="3533480">,</span>&nbsp;<span class="op" id="3533482">&amp;</span><span class="ident" id="3533483">x</span><span class="op" id="3533484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533491">return</span>&nbsp;<span class="ident" id="3533498">g</span><span class="op" id="3533499">,</span>&nbsp;<span class="ident" id="3533501">nil</span><br>
<span class="lineno"></span><span class="op" id="3533505">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3533508">const</span>&nbsp;<span class="op" id="3533514">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533517">gcmBlockSize</span>&nbsp;<span class="op" id="3533530">=</span>&nbsp;<span class="num" id="3533532">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533536">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3533549">=</span>&nbsp;<span class="num" id="3533551">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533555">gcmNonceSize</span>&nbsp;<span class="op" id="3533568">=</span>&nbsp;<span class="num" id="3533570">12</span><br>
<span class="lineno">95</span><span class="op" id="3533573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3533576">func</span>&nbsp;<span class="op" id="3533581">(</span><span class="op" id="3533582">*</span><span class="ident" id="3533583">gcm</span><span class="op" id="3533586">)</span>&nbsp;<span class="ident" id="3533588">NonceSize</span><span class="op" id="3533597">(</span><span class="op" id="3533598">)</span>&nbsp;<span class="builtintype" id="3533600">int</span>&nbsp;<span class="op" id="3533604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533607">return</span>&nbsp;<span class="ident" id="3533614">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op" id="3533627">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3533630">func</span>&nbsp;<span class="op" id="3533635">(</span><span class="op" id="3533636">*</span><span class="ident" id="3533637">gcm</span><span class="op" id="3533640">)</span>&nbsp;<span class="ident" id="3533642">Overhead</span><span class="op" id="3533650">(</span><span class="op" id="3533651">)</span>&nbsp;<span class="builtintype" id="3533653">int</span>&nbsp;<span class="op" id="3533657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533660">return</span>&nbsp;<span class="ident" id="3533667">gcmTagSize</span><br>
<span class="lineno"></span><span class="op" id="3533678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="3533681">func</span>&nbsp;<span class="op" id="3533686">(</span><span class="ident" id="3533687">g</span>&nbsp;<span class="op" id="3533689">*</span><span class="ident" id="3533690">gcm</span><span class="op" id="3533693">)</span>&nbsp;<span class="ident" id="3533695">Seal</span><span class="op" id="3533699">(</span><span class="ident" id="3533700">dst</span><span class="op" id="3533703">,</span>&nbsp;<span class="ident" id="3533705">nonce</span><span class="op" id="3533710">,</span>&nbsp;<span class="ident" id="3533712">plaintext</span><span class="op" id="3533721">,</span>&nbsp;<span class="ident" id="3533723">data</span>&nbsp;<span class="op" id="3533728">[</span><span class="op" id="3533729">]</span><span class="builtintype" id="3533730">byte</span><span class="op" id="3533734">)</span>&nbsp;<span class="op" id="3533736">[</span><span class="op" id="3533737">]</span><span class="builtintype" id="3533738">byte</span>&nbsp;<span class="op" id="3533743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533746">if</span>&nbsp;<span class="builtinfunc" id="3533749">len</span><span class="op" id="3533752">(</span><span class="ident" id="3533753">nonce</span><span class="op" id="3533758">)</span>&nbsp;<span class="op" id="3533760">!=</span>&nbsp;<span class="ident" id="3533763">gcmNonceSize</span>&nbsp;<span class="op" id="3533776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3533780">panic</span><span class="op" id="3533785">(</span><span class="string" id="3533786">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3533831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533838">ret</span><span class="op" id="3533841">,</span>&nbsp;<span class="ident" id="3533843">out</span>&nbsp;<span class="op" id="3533847">:=</span>&nbsp;<span class="ident" id="3533850">sliceForAppend</span><span class="op" id="3533864">(</span><span class="ident" id="3533865">dst</span><span class="op" id="3533868">,</span>&nbsp;<span class="builtinfunc" id="3533870">len</span><span class="op" id="3533873">(</span><span class="ident" id="3533874">plaintext</span><span class="op" id="3533883">)</span><span class="op" id="3533884">+</span><span class="ident" id="3533885">gcmTagSize</span><span class="op" id="3533895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533899">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533930">var</span>&nbsp;<span class="ident" id="3533934">counter</span><span class="op" id="3533941">,</span>&nbsp;<span class="ident" id="3533943">tagMask</span>&nbsp;<span class="op" id="3533951">[</span><span class="ident" id="3533952">gcmBlockSize</span><span class="op" id="3533964">]</span><span class="builtintype" id="3533965">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3533971">copy</span><span class="op" id="3533975">(</span><span class="ident" id="3533976">counter</span><span class="op" id="3533983">[</span><span class="op" id="3533984">:</span><span class="op" id="3533985">]</span><span class="op" id="3533986">,</span>&nbsp;<span class="ident" id="3533988">nonce</span><span class="op" id="3533993">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533996">counter</span><span class="op" id="3534003">[</span><span class="ident" id="3534004">gcmBlockSize</span><span class="op" id="3534016">-</span><span class="num" id="3534017">1</span><span class="op" id="3534018">]</span>&nbsp;<span class="op" id="3534020">=</span>&nbsp;<span class="num" id="3534022">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534026">g</span><span class="op" id="3534027">.</span><span class="ident" id="3534028">cipher</span><span class="op" id="3534034">.</span><span class="ident" id="3534035">Encrypt</span><span class="op" id="3534042">(</span><span class="ident" id="3534043">tagMask</span><span class="op" id="3534050">[</span><span class="op" id="3534051">:</span><span class="op" id="3534052">]</span><span class="op" id="3534053">,</span>&nbsp;<span class="ident" id="3534055">counter</span><span class="op" id="3534062">[</span><span class="op" id="3534063">:</span><span class="op" id="3534064">]</span><span class="op" id="3534065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534068">gcmInc32</span><span class="op" id="3534076">(</span><span class="op" id="3534077">&amp;</span><span class="ident" id="3534078">counter</span><span class="op" id="3534085">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534089">g</span><span class="op" id="3534090">.</span><span class="ident" id="3534091">counterCrypt</span><span class="op" id="3534103">(</span><span class="ident" id="3534104">out</span><span class="op" id="3534107">,</span>&nbsp;<span class="ident" id="3534109">plaintext</span><span class="op" id="3534118">,</span>&nbsp;<span class="op" id="3534120">&amp;</span><span class="ident" id="3534121">counter</span><span class="op" id="3534128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534131">g</span><span class="op" id="3534132">.</span><span class="ident" id="3534133">auth</span><span class="op" id="3534137">(</span><span class="ident" id="3534138">out</span><span class="op" id="3534141">[</span><span class="builtinfunc" id="3534142">len</span><span class="op" id="3534145">(</span><span class="ident" id="3534146">plaintext</span><span class="op" id="3534155">)</span><span class="op" id="3534156">:</span><span class="op" id="3534157">]</span><span class="op" id="3534158">,</span>&nbsp;<span class="ident" id="3534160">out</span><span class="op" id="3534163">[</span><span class="op" id="3534164">:</span><span class="builtinfunc" id="3534165">len</span><span class="op" id="3534168">(</span><span class="ident" id="3534169">plaintext</span><span class="op" id="3534178">)</span><span class="op" id="3534179">]</span><span class="op" id="3534180">,</span>&nbsp;<span class="ident" id="3534182">data</span><span class="op" id="3534186">,</span>&nbsp;<span class="op" id="3534188">&amp;</span><span class="ident" id="3534189">tagMask</span><span class="op" id="3534196">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534200">return</span>&nbsp;<span class="ident" id="3534207">ret</span><br>
<span class="lineno"></span><span class="op" id="3534211">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="3534214">var</span>&nbsp;<span class="ident" id="3534218">errOpen</span>&nbsp;<span class="op" id="3534226">=</span>&nbsp;<span class="ident" id="3534228">errors</span><span class="op" id="3534234">.</span><span class="ident" id="3534235">New</span><span class="op" id="3534238">(</span><span class="string" id="3534239">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op" id="3534278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3534281">func</span>&nbsp;<span class="op" id="3534286">(</span><span class="ident" id="3534287">g</span>&nbsp;<span class="op" id="3534289">*</span><span class="ident" id="3534290">gcm</span><span class="op" id="3534293">)</span>&nbsp;<span class="ident" id="3534295">Open</span><span class="op" id="3534299">(</span><span class="ident" id="3534300">dst</span><span class="op" id="3534303">,</span>&nbsp;<span class="ident" id="3534305">nonce</span><span class="op" id="3534310">,</span>&nbsp;<span class="ident" id="3534312">ciphertext</span><span class="op" id="3534322">,</span>&nbsp;<span class="ident" id="3534324">data</span>&nbsp;<span class="op" id="3534329">[</span><span class="op" id="3534330">]</span><span class="builtintype" id="3534331">byte</span><span class="op" id="3534335">)</span>&nbsp;<span class="op" id="3534337">(</span><span class="op" id="3534338">[</span><span class="op" id="3534339">]</span><span class="builtintype" id="3534340">byte</span><span class="op" id="3534344">,</span>&nbsp;<span class="builtintype" id="3534346">error</span><span class="op" id="3534351">)</span>&nbsp;<span class="op" id="3534353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534356">if</span>&nbsp;<span class="builtinfunc" id="3534359">len</span><span class="op" id="3534362">(</span><span class="ident" id="3534363">nonce</span><span class="op" id="3534368">)</span>&nbsp;<span class="op" id="3534370">!=</span>&nbsp;<span class="ident" id="3534373">gcmNonceSize</span>&nbsp;<span class="op" id="3534386">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3534390">panic</span><span class="op" id="3534395">(</span><span class="string" id="3534396">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3534441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534448">if</span>&nbsp;<span class="builtinfunc" id="3534451">len</span><span class="op" id="3534454">(</span><span class="ident" id="3534455">ciphertext</span><span class="op" id="3534465">)</span>&nbsp;<span class="op" id="3534467">&lt;</span>&nbsp;<span class="ident" id="3534469">gcmTagSize</span>&nbsp;<span class="op" id="3534480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534484">return</span>&nbsp;<span class="ident" id="3534491">nil</span><span class="op" id="3534494">,</span>&nbsp;<span class="ident" id="3534496">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534508">tag</span>&nbsp;<span class="op" id="3534512">:=</span>&nbsp;<span class="ident" id="3534515">ciphertext</span><span class="op" id="3534525">[</span><span class="builtinfunc" id="3534526">len</span><span class="op" id="3534529">(</span><span class="ident" id="3534530">ciphertext</span><span class="op" id="3534540">)</span><span class="op" id="3534541">-</span><span class="ident" id="3534542">gcmTagSize</span><span class="op" id="3534552">:</span><span class="op" id="3534553">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534556">ciphertext</span>&nbsp;<span class="op" id="3534567">=</span>&nbsp;<span class="ident" id="3534569">ciphertext</span><span class="op" id="3534579">[</span><span class="op" id="3534580">:</span><span class="builtinfunc" id="3534581">len</span><span class="op" id="3534584">(</span><span class="ident" id="3534585">ciphertext</span><span class="op" id="3534595">)</span><span class="op" id="3534596">-</span><span class="ident" id="3534597">gcmTagSize</span><span class="op" id="3534607">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3534611">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534642">var</span>&nbsp;<span class="ident" id="3534646">counter</span><span class="op" id="3534653">,</span>&nbsp;<span class="ident" id="3534655">tagMask</span>&nbsp;<span class="op" id="3534663">[</span><span class="ident" id="3534664">gcmBlockSize</span><span class="op" id="3534676">]</span><span class="builtintype" id="3534677">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3534683">copy</span><span class="op" id="3534687">(</span><span class="ident" id="3534688">counter</span><span class="op" id="3534695">[</span><span class="op" id="3534696">:</span><span class="op" id="3534697">]</span><span class="op" id="3534698">,</span>&nbsp;<span class="ident" id="3534700">nonce</span><span class="op" id="3534705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534708">counter</span><span class="op" id="3534715">[</span><span class="ident" id="3534716">gcmBlockSize</span><span class="op" id="3534728">-</span><span class="num" id="3534729">1</span><span class="op" id="3534730">]</span>&nbsp;<span class="op" id="3534732">=</span>&nbsp;<span class="num" id="3534734">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534738">g</span><span class="op" id="3534739">.</span><span class="ident" id="3534740">cipher</span><span class="op" id="3534746">.</span><span class="ident" id="3534747">Encrypt</span><span class="op" id="3534754">(</span><span class="ident" id="3534755">tagMask</span><span class="op" id="3534762">[</span><span class="op" id="3534763">:</span><span class="op" id="3534764">]</span><span class="op" id="3534765">,</span>&nbsp;<span class="ident" id="3534767">counter</span><span class="op" id="3534774">[</span><span class="op" id="3534775">:</span><span class="op" id="3534776">]</span><span class="op" id="3534777">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534780">gcmInc32</span><span class="op" id="3534788">(</span><span class="op" id="3534789">&amp;</span><span class="ident" id="3534790">counter</span><span class="op" id="3534797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534801">var</span>&nbsp;<span class="ident" id="3534805">expectedTag</span>&nbsp;<span class="op" id="3534817">[</span><span class="ident" id="3534818">gcmTagSize</span><span class="op" id="3534828">]</span><span class="builtintype" id="3534829">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534835">g</span><span class="op" id="3534836">.</span><span class="ident" id="3534837">auth</span><span class="op" id="3534841">(</span><span class="ident" id="3534842">expectedTag</span><span class="op" id="3534853">[</span><span class="op" id="3534854">:</span><span class="op" id="3534855">]</span><span class="op" id="3534856">,</span>&nbsp;<span class="ident" id="3534858">ciphertext</span><span class="op" id="3534868">,</span>&nbsp;<span class="ident" id="3534870">data</span><span class="op" id="3534874">,</span>&nbsp;<span class="op" id="3534876">&amp;</span><span class="ident" id="3534877">tagMask</span><span class="op" id="3534884">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534888">if</span>&nbsp;<span class="ident" id="3534891">subtle</span><span class="op" id="3534897">.</span><span class="ident" id="3534898">ConstantTimeCompare</span><span class="op" id="3534917">(</span><span class="ident" id="3534918">expectedTag</span><span class="op" id="3534929">[</span><span class="op" id="3534930">:</span><span class="op" id="3534931">]</span><span class="op" id="3534932">,</span>&nbsp;<span class="ident" id="3534934">tag</span><span class="op" id="3534937">)</span>&nbsp;<span class="op" id="3534939">!=</span>&nbsp;<span class="num" id="3534942">1</span>&nbsp;<span class="op" id="3534944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534948">return</span>&nbsp;<span class="ident" id="3534955">nil</span><span class="op" id="3534958">,</span>&nbsp;<span class="ident" id="3534960">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534973">ret</span><span class="op" id="3534976">,</span>&nbsp;<span class="ident" id="3534978">out</span>&nbsp;<span class="op" id="3534982">:=</span>&nbsp;<span class="ident" id="3534985">sliceForAppend</span><span class="op" id="3534999">(</span><span class="ident" id="3535000">dst</span><span class="op" id="3535003">,</span>&nbsp;<span class="builtinfunc" id="3535005">len</span><span class="op" id="3535008">(</span><span class="ident" id="3535009">ciphertext</span><span class="op" id="3535019">)</span><span class="op" id="3535020">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535023">g</span><span class="op" id="3535024">.</span><span class="ident" id="3535025">counterCrypt</span><span class="op" id="3535037">(</span><span class="ident" id="3535038">out</span><span class="op" id="3535041">,</span>&nbsp;<span class="ident" id="3535043">ciphertext</span><span class="op" id="3535053">,</span>&nbsp;<span class="op" id="3535055">&amp;</span><span class="ident" id="3535056">counter</span><span class="op" id="3535063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535067">return</span>&nbsp;<span class="ident" id="3535074">ret</span><span class="op" id="3535077">,</span>&nbsp;<span class="ident" id="3535079">nil</span><br>
<span class="lineno"></span><span class="op" id="3535083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3535086">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword" id="3535154">func</span>&nbsp;<span class="ident" id="3535159">reverseBits</span><span class="op" id="3535170">(</span><span class="ident" id="3535171">i</span>&nbsp;<span class="builtintype" id="3535173">int</span><span class="op" id="3535176">)</span>&nbsp;<span class="builtintype" id="3535178">int</span>&nbsp;<span class="op" id="3535182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535185">i</span>&nbsp;<span class="op" id="3535187">=</span>&nbsp;<span class="op" id="3535189">(</span><span class="op" id="3535190">(</span><span class="ident" id="3535191">i</span>&nbsp;<span class="op" id="3535193">&lt;&lt;</span>&nbsp;<span class="num" id="3535196">2</span><span class="op" id="3535197">)</span>&nbsp;<span class="op" id="3535199">&amp;</span>&nbsp;<span class="num" id="3535201">0xc</span><span class="op" id="3535204">)</span>&nbsp;<span class="op" id="3535206">|</span>&nbsp;<span class="op" id="3535208">(</span><span class="op" id="3535209">(</span><span class="ident" id="3535210">i</span>&nbsp;<span class="op" id="3535212">&gt;&gt;</span>&nbsp;<span class="num" id="3535215">2</span><span class="op" id="3535216">)</span>&nbsp;<span class="op" id="3535218">&amp;</span>&nbsp;<span class="num" id="3535220">0x3</span><span class="op" id="3535223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535226">i</span>&nbsp;<span class="op" id="3535228">=</span>&nbsp;<span class="op" id="3535230">(</span><span class="op" id="3535231">(</span><span class="ident" id="3535232">i</span>&nbsp;<span class="op" id="3535234">&lt;&lt;</span>&nbsp;<span class="num" id="3535237">1</span><span class="op" id="3535238">)</span>&nbsp;<span class="op" id="3535240">&amp;</span>&nbsp;<span class="num" id="3535242">0xa</span><span class="op" id="3535245">)</span>&nbsp;<span class="op" id="3535247">|</span>&nbsp;<span class="op" id="3535249">(</span><span class="op" id="3535250">(</span><span class="ident" id="3535251">i</span>&nbsp;<span class="op" id="3535253">&gt;&gt;</span>&nbsp;<span class="num" id="3535256">1</span><span class="op" id="3535257">)</span>&nbsp;<span class="op" id="3535259">&amp;</span>&nbsp;<span class="num" id="3535261">0x5</span><span class="op" id="3535264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535267">return</span>&nbsp;<span class="ident" id="3535274">i</span><br>
<span class="lineno">165</span><span class="op" id="3535276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3535279">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword" id="3535344">func</span>&nbsp;<span class="ident" id="3535349">gcmAdd</span><span class="op" id="3535355">(</span><span class="ident" id="3535356">x</span><span class="op" id="3535357">,</span>&nbsp;<span class="ident" id="3535359">y</span>&nbsp;<span class="op" id="3535361">*</span><span class="ident" id="3535362">gcmFieldElement</span><span class="op" id="3535377">)</span>&nbsp;<span class="ident" id="3535379">gcmFieldElement</span>&nbsp;<span class="op" id="3535395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535398">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535452">return</span>&nbsp;<span class="ident" id="3535459">gcmFieldElement</span><span class="op" id="3535474">{</span><span class="ident" id="3535475">x</span><span class="op" id="3535476">.</span><span class="ident" id="3535477">low</span>&nbsp;<span class="op" id="3535481">^</span>&nbsp;<span class="ident" id="3535483">y</span><span class="op" id="3535484">.</span><span class="ident" id="3535485">low</span><span class="op" id="3535488">,</span>&nbsp;<span class="ident" id="3535490">x</span><span class="op" id="3535491">.</span><span class="ident" id="3535492">high</span>&nbsp;<span class="op" id="3535497">^</span>&nbsp;<span class="ident" id="3535499">y</span><span class="op" id="3535500">.</span><span class="ident" id="3535501">high</span><span class="op" id="3535505">}</span><br>
<span class="lineno"></span><span class="op" id="3535507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3535510">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword" id="3535582">func</span>&nbsp;<span class="ident" id="3535587">gcmDouble</span><span class="op" id="3535596">(</span><span class="ident" id="3535597">x</span>&nbsp;<span class="op" id="3535599">*</span><span class="ident" id="3535600">gcmFieldElement</span><span class="op" id="3535615">)</span>&nbsp;<span class="op" id="3535617">(</span><span class="ident" id="3535618">double</span>&nbsp;<span class="ident" id="3535625">gcmFieldElement</span><span class="op" id="3535640">)</span>&nbsp;<span class="op" id="3535642">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535645">msbSet</span>&nbsp;<span class="op" id="3535652">:=</span>&nbsp;<span class="ident" id="3535655">x</span><span class="op" id="3535656">.</span><span class="ident" id="3535657">high</span><span class="op" id="3535661">&amp;</span><span class="num" id="3535662">1</span>&nbsp;<span class="op" id="3535664">==</span>&nbsp;<span class="num" id="3535667">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535671">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535740">double</span><span class="op" id="3535746">.</span><span class="ident" id="3535747">high</span>&nbsp;<span class="op" id="3535752">=</span>&nbsp;<span class="ident" id="3535754">x</span><span class="op" id="3535755">.</span><span class="ident" id="3535756">high</span>&nbsp;<span class="op" id="3535761">&gt;&gt;</span>&nbsp;<span class="num" id="3535764">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535767">double</span><span class="op" id="3535773">.</span><span class="ident" id="3535774">high</span>&nbsp;<span class="op" id="3535779">|=</span>&nbsp;<span class="ident" id="3535782">x</span><span class="op" id="3535783">.</span><span class="ident" id="3535784">low</span>&nbsp;<span class="op" id="3535788">&lt;&lt;</span>&nbsp;<span class="num" id="3535791">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535795">double</span><span class="op" id="3535801">.</span><span class="ident" id="3535802">low</span>&nbsp;<span class="op" id="3535806">=</span>&nbsp;<span class="ident" id="3535808">x</span><span class="op" id="3535809">.</span><span class="ident" id="3535810">low</span>&nbsp;<span class="op" id="3535814">&gt;&gt;</span>&nbsp;<span class="num" id="3535817">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535821">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535886">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535954">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3536018">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3536091">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3536162">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3536233">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536242">if</span>&nbsp;<span class="ident" id="3536245">msbSet</span>&nbsp;<span class="op" id="3536252">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536256">double</span><span class="op" id="3536262">.</span><span class="ident" id="3536263">low</span>&nbsp;<span class="op" id="3536267">^=</span>&nbsp;<span class="num" id="3536270">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536294">return</span><br>
<span class="lineno"></span><span class="op" id="3536301">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="3536304">var</span>&nbsp;<span class="ident" id="3536308">gcmReductionTable</span>&nbsp;<span class="op" id="3536326">=</span>&nbsp;<span class="op" id="3536328">[</span><span class="op" id="3536329">]</span><span class="builtintype" id="3536330">uint16</span><span class="op" id="3536336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3536339">0x0000</span><span class="op" id="3536345">,</span>&nbsp;<span class="num" id="3536347">0x1c20</span><span class="op" id="3536353">,</span>&nbsp;<span class="num" id="3536355">0x3840</span><span class="op" id="3536361">,</span>&nbsp;<span class="num" id="3536363">0x2460</span><span class="op" id="3536369">,</span>&nbsp;<span class="num" id="3536371">0x7080</span><span class="op" id="3536377">,</span>&nbsp;<span class="num" id="3536379">0x6ca0</span><span class="op" id="3536385">,</span>&nbsp;<span class="num" id="3536387">0x48c0</span><span class="op" id="3536393">,</span>&nbsp;<span class="num" id="3536395">0x54e0</span><span class="op" id="3536401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3536404">0xe100</span><span class="op" id="3536410">,</span>&nbsp;<span class="num" id="3536412">0xfd20</span><span class="op" id="3536418">,</span>&nbsp;<span class="num" id="3536420">0xd940</span><span class="op" id="3536426">,</span>&nbsp;<span class="num" id="3536428">0xc560</span><span class="op" id="3536434">,</span>&nbsp;<span class="num" id="3536436">0x9180</span><span class="op" id="3536442">,</span>&nbsp;<span class="num" id="3536444">0x8da0</span><span class="op" id="3536450">,</span>&nbsp;<span class="num" id="3536452">0xa9c0</span><span class="op" id="3536458">,</span>&nbsp;<span class="num" id="3536460">0xb5e0</span><span class="op" id="3536466">,</span><br>
<span class="lineno"></span><span class="op" id="3536468">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3536471">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword" id="3536538">func</span>&nbsp;<span class="op" id="3536543">(</span><span class="ident" id="3536544">g</span>&nbsp;<span class="op" id="3536546">*</span><span class="ident" id="3536547">gcm</span><span class="op" id="3536550">)</span>&nbsp;<span class="ident" id="3536552">mul</span><span class="op" id="3536555">(</span><span class="ident" id="3536556">y</span>&nbsp;<span class="op" id="3536558">*</span><span class="ident" id="3536559">gcmFieldElement</span><span class="op" id="3536574">)</span>&nbsp;<span class="op" id="3536576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536579">var</span>&nbsp;<span class="ident" id="3536583">z</span>&nbsp;<span class="ident" id="3536585">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536603">for</span>&nbsp;<span class="ident" id="3536607">i</span>&nbsp;<span class="op" id="3536609">:=</span>&nbsp;<span class="num" id="3536612">0</span><span class="op" id="3536613">;</span>&nbsp;<span class="ident" id="3536615">i</span>&nbsp;<span class="op" id="3536617">&lt;</span>&nbsp;<span class="num" id="3536619">2</span><span class="op" id="3536620">;</span>&nbsp;<span class="ident" id="3536622">i</span><span class="op" id="3536623">++</span>&nbsp;<span class="op" id="3536626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536630">word</span>&nbsp;<span class="op" id="3536635">:=</span>&nbsp;<span class="ident" id="3536638">y</span><span class="op" id="3536639">.</span><span class="ident" id="3536640">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536647">if</span>&nbsp;<span class="ident" id="3536650">i</span>&nbsp;<span class="op" id="3536652">==</span>&nbsp;<span class="num" id="3536655">1</span>&nbsp;<span class="op" id="3536657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536662">word</span>&nbsp;<span class="op" id="3536667">=</span>&nbsp;<span class="ident" id="3536669">y</span><span class="op" id="3536670">.</span><span class="ident" id="3536671">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536677">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3536682">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3536745">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536789">for</span>&nbsp;<span class="ident" id="3536793">j</span>&nbsp;<span class="op" id="3536795">:=</span>&nbsp;<span class="num" id="3536798">0</span><span class="op" id="3536799">;</span>&nbsp;<span class="ident" id="3536801">j</span>&nbsp;<span class="op" id="3536803">&lt;</span>&nbsp;<span class="num" id="3536805">64</span><span class="op" id="3536807">;</span>&nbsp;<span class="ident" id="3536809">j</span>&nbsp;<span class="op" id="3536811">+=</span>&nbsp;<span class="num" id="3536814">4</span>&nbsp;<span class="op" id="3536816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536821">msw</span>&nbsp;<span class="op" id="3536825">:=</span>&nbsp;<span class="ident" id="3536828">z</span><span class="op" id="3536829">.</span><span class="ident" id="3536830">high</span>&nbsp;<span class="op" id="3536835">&amp;</span>&nbsp;<span class="num" id="3536837">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536844">z</span><span class="op" id="3536845">.</span><span class="ident" id="3536846">high</span>&nbsp;<span class="op" id="3536851">&gt;&gt;=</span>&nbsp;<span class="num" id="3536855">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536860">z</span><span class="op" id="3536861">.</span><span class="ident" id="3536862">high</span>&nbsp;<span class="op" id="3536867">|=</span>&nbsp;<span class="ident" id="3536870">z</span><span class="op" id="3536871">.</span><span class="ident" id="3536872">low</span>&nbsp;<span class="op" id="3536876">&lt;&lt;</span>&nbsp;<span class="num" id="3536879">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536885">z</span><span class="op" id="3536886">.</span><span class="ident" id="3536887">low</span>&nbsp;<span class="op" id="3536891">&gt;&gt;=</span>&nbsp;<span class="num" id="3536895">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536900">z</span><span class="op" id="3536901">.</span><span class="ident" id="3536902">low</span>&nbsp;<span class="op" id="3536906">^=</span>&nbsp;<span class="ident" id="3536909">uint64</span><span class="op" id="3536915">(</span><span class="ident" id="3536916">gcmReductionTable</span><span class="op" id="3536933">[</span><span class="ident" id="3536934">msw</span><span class="op" id="3536937">]</span><span class="op" id="3536938">)</span>&nbsp;<span class="op" id="3536940">&lt;&lt;</span>&nbsp;<span class="num" id="3536943">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3536950">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3536994">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3537045">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537062">t</span>&nbsp;<span class="op" id="3537064">:=</span>&nbsp;<span class="op" id="3537067">&amp;</span><span class="ident" id="3537068">g</span><span class="op" id="3537069">.</span><span class="ident" id="3537070">productTable</span><span class="op" id="3537082">[</span><span class="ident" id="3537083">word</span><span class="op" id="3537087">&amp;</span><span class="num" id="3537088">0xf</span><span class="op" id="3537091">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537097">z</span><span class="op" id="3537098">.</span><span class="ident" id="3537099">low</span>&nbsp;<span class="op" id="3537103">^=</span>&nbsp;<span class="ident" id="3537106">t</span><span class="op" id="3537107">.</span><span class="ident" id="3537108">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537115">z</span><span class="op" id="3537116">.</span><span class="ident" id="3537117">high</span>&nbsp;<span class="op" id="3537122">^=</span>&nbsp;<span class="ident" id="3537125">t</span><span class="op" id="3537126">.</span><span class="ident" id="3537127">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537135">word</span>&nbsp;<span class="op" id="3537140">&gt;&gt;=</span>&nbsp;<span class="num" id="3537144">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537151">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537155">*</span><span class="ident" id="3537156">y</span>&nbsp;<span class="op" id="3537158">=</span>&nbsp;<span class="ident" id="3537160">z</span><br>
<span class="lineno"></span><span class="op" id="3537162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3537165">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment" id="3537240">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword" id="3537316">func</span>&nbsp;<span class="op" id="3537321">(</span><span class="ident" id="3537322">g</span>&nbsp;<span class="op" id="3537324">*</span><span class="ident" id="3537325">gcm</span><span class="op" id="3537328">)</span>&nbsp;<span class="ident" id="3537330">updateBlocks</span><span class="op" id="3537342">(</span><span class="ident" id="3537343">y</span>&nbsp;<span class="op" id="3537345">*</span><span class="ident" id="3537346">gcmFieldElement</span><span class="op" id="3537361">,</span>&nbsp;<span class="ident" id="3537363">blocks</span>&nbsp;<span class="op" id="3537370">[</span><span class="op" id="3537371">]</span><span class="builtintype" id="3537372">byte</span><span class="op" id="3537376">)</span>&nbsp;<span class="op" id="3537378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537381">for</span>&nbsp;<span class="builtinfunc" id="3537385">len</span><span class="op" id="3537388">(</span><span class="ident" id="3537389">blocks</span><span class="op" id="3537395">)</span>&nbsp;<span class="op" id="3537397">&gt;</span>&nbsp;<span class="num" id="3537399">0</span>&nbsp;<span class="op" id="3537401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537405">y</span><span class="op" id="3537406">.</span><span class="ident" id="3537407">low</span>&nbsp;<span class="op" id="3537411">^=</span>&nbsp;<span class="ident" id="3537414">getUint64</span><span class="op" id="3537423">(</span><span class="ident" id="3537424">blocks</span><span class="op" id="3537430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537434">y</span><span class="op" id="3537435">.</span><span class="ident" id="3537436">high</span>&nbsp;<span class="op" id="3537441">^=</span>&nbsp;<span class="ident" id="3537444">getUint64</span><span class="op" id="3537453">(</span><span class="ident" id="3537454">blocks</span><span class="op" id="3537460">[</span><span class="num" id="3537461">8</span><span class="op" id="3537462">:</span><span class="op" id="3537463">]</span><span class="op" id="3537464">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537468">g</span><span class="op" id="3537469">.</span><span class="ident" id="3537470">mul</span><span class="op" id="3537473">(</span><span class="ident" id="3537474">y</span><span class="op" id="3537475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537479">blocks</span>&nbsp;<span class="op" id="3537486">=</span>&nbsp;<span class="ident" id="3537488">blocks</span><span class="op" id="3537494">[</span><span class="ident" id="3537495">gcmBlockSize</span><span class="op" id="3537507">:</span><span class="op" id="3537508">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537511">}</span><br>
<span class="lineno"></span><span class="op" id="3537513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment" id="3537516">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3537591">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword" id="3537665">func</span>&nbsp;<span class="op" id="3537670">(</span><span class="ident" id="3537671">g</span>&nbsp;<span class="op" id="3537673">*</span><span class="ident" id="3537674">gcm</span><span class="op" id="3537677">)</span>&nbsp;<span class="ident" id="3537679">update</span><span class="op" id="3537685">(</span><span class="ident" id="3537686">y</span>&nbsp;<span class="op" id="3537688">*</span><span class="ident" id="3537689">gcmFieldElement</span><span class="op" id="3537704">,</span>&nbsp;<span class="ident" id="3537706">data</span>&nbsp;<span class="op" id="3537711">[</span><span class="op" id="3537712">]</span><span class="builtintype" id="3537713">byte</span><span class="op" id="3537717">)</span>&nbsp;<span class="op" id="3537719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537722">fullBlocks</span>&nbsp;<span class="op" id="3537733">:=</span>&nbsp;<span class="op" id="3537736">(</span><span class="builtinfunc" id="3537737">len</span><span class="op" id="3537740">(</span><span class="ident" id="3537741">data</span><span class="op" id="3537745">)</span>&nbsp;<span class="op" id="3537747">&gt;&gt;</span>&nbsp;<span class="num" id="3537750">4</span><span class="op" id="3537751">)</span>&nbsp;<span class="op" id="3537753">&lt;&lt;</span>&nbsp;<span class="num" id="3537756">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537759">g</span><span class="op" id="3537760">.</span><span class="ident" id="3537761">updateBlocks</span><span class="op" id="3537773">(</span><span class="ident" id="3537774">y</span><span class="op" id="3537775">,</span>&nbsp;<span class="ident" id="3537777">data</span><span class="op" id="3537781">[</span><span class="op" id="3537782">:</span><span class="ident" id="3537783">fullBlocks</span><span class="op" id="3537793">]</span><span class="op" id="3537794">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537798">if</span>&nbsp;<span class="builtinfunc" id="3537801">len</span><span class="op" id="3537804">(</span><span class="ident" id="3537805">data</span><span class="op" id="3537809">)</span>&nbsp;<span class="op" id="3537811">!=</span>&nbsp;<span class="ident" id="3537814">fullBlocks</span>&nbsp;<span class="op" id="3537825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537829">var</span>&nbsp;<span class="ident" id="3537833">partialBlock</span>&nbsp;<span class="op" id="3537846">[</span><span class="ident" id="3537847">gcmBlockSize</span><span class="op" id="3537859">]</span><span class="builtintype" id="3537860">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3537867">copy</span><span class="op" id="3537871">(</span><span class="ident" id="3537872">partialBlock</span><span class="op" id="3537884">[</span><span class="op" id="3537885">:</span><span class="op" id="3537886">]</span><span class="op" id="3537887">,</span>&nbsp;<span class="ident" id="3537889">data</span><span class="op" id="3537893">[</span><span class="ident" id="3537894">fullBlocks</span><span class="op" id="3537904">:</span><span class="op" id="3537905">]</span><span class="op" id="3537906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537910">g</span><span class="op" id="3537911">.</span><span class="ident" id="3537912">updateBlocks</span><span class="op" id="3537924">(</span><span class="ident" id="3537925">y</span><span class="op" id="3537926">,</span>&nbsp;<span class="ident" id="3537928">partialBlock</span><span class="op" id="3537940">[</span><span class="op" id="3537941">:</span><span class="op" id="3537942">]</span><span class="op" id="3537943">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537946">}</span><br>
<span class="lineno"></span><span class="op" id="3537948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3537951">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3538029">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword" id="3538051">func</span>&nbsp;<span class="ident" id="3538056">gcmInc32</span><span class="op" id="3538064">(</span><span class="ident" id="3538065">counterBlock</span>&nbsp;<span class="op" id="3538078">*</span><span class="op" id="3538079">[</span><span class="num" id="3538080">16</span><span class="op" id="3538082">]</span><span class="builtintype" id="3538083">byte</span><span class="op" id="3538087">)</span>&nbsp;<span class="op" id="3538089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538092">for</span>&nbsp;<span class="ident" id="3538096">i</span>&nbsp;<span class="op" id="3538098">:=</span>&nbsp;<span class="ident" id="3538101">gcmBlockSize</span>&nbsp;<span class="op" id="3538114">-</span>&nbsp;<span class="num" id="3538116">1</span><span class="op" id="3538117">;</span>&nbsp;<span class="ident" id="3538119">i</span>&nbsp;<span class="op" id="3538121">&gt;=</span>&nbsp;<span class="ident" id="3538124">gcmBlockSize</span><span class="op" id="3538136">-</span><span class="num" id="3538137">4</span><span class="op" id="3538138">;</span>&nbsp;<span class="ident" id="3538140">i</span><span class="op" id="3538141">--</span>&nbsp;<span class="op" id="3538144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538148">counterBlock</span><span class="op" id="3538160">[</span><span class="ident" id="3538161">i</span><span class="op" id="3538162">]</span><span class="op" id="3538163">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538168">if</span>&nbsp;<span class="ident" id="3538171">counterBlock</span><span class="op" id="3538183">[</span><span class="ident" id="3538184">i</span><span class="op" id="3538185">]</span>&nbsp;<span class="op" id="3538187">!=</span>&nbsp;<span class="num" id="3538190">0</span>&nbsp;<span class="op" id="3538192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538197">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538208">}</span><br>
<span class="lineno"></span><span class="op" id="3538210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3538213">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment" id="3538291">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3538371">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3538450">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="3538525">func</span>&nbsp;<span class="ident" id="3538530">sliceForAppend</span><span class="op" id="3538544">(</span><span class="ident" id="3538545">in</span>&nbsp;<span class="op" id="3538548">[</span><span class="op" id="3538549">]</span><span class="builtintype" id="3538550">byte</span><span class="op" id="3538554">,</span>&nbsp;<span class="ident" id="3538556">n</span>&nbsp;<span class="builtintype" id="3538558">int</span><span class="op" id="3538561">)</span>&nbsp;<span class="op" id="3538563">(</span><span class="ident" id="3538564">head</span><span class="op" id="3538568">,</span>&nbsp;<span class="ident" id="3538570">tail</span>&nbsp;<span class="op" id="3538575">[</span><span class="op" id="3538576">]</span><span class="builtintype" id="3538577">byte</span><span class="op" id="3538581">)</span>&nbsp;<span class="op" id="3538583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538586">if</span>&nbsp;<span class="ident" id="3538589">total</span>&nbsp;<span class="op" id="3538595">:=</span>&nbsp;<span class="builtinfunc" id="3538598">len</span><span class="op" id="3538601">(</span><span class="ident" id="3538602">in</span><span class="op" id="3538604">)</span>&nbsp;<span class="op" id="3538606">+</span>&nbsp;<span class="ident" id="3538608">n</span><span class="op" id="3538609">;</span>&nbsp;<span class="builtinfunc" id="3538611">cap</span><span class="op" id="3538614">(</span><span class="ident" id="3538615">in</span><span class="op" id="3538617">)</span>&nbsp;<span class="op" id="3538619">&gt;=</span>&nbsp;<span class="ident" id="3538622">total</span>&nbsp;<span class="op" id="3538628">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538632">head</span>&nbsp;<span class="op" id="3538637">=</span>&nbsp;<span class="ident" id="3538639">in</span><span class="op" id="3538641">[</span><span class="op" id="3538642">:</span><span class="ident" id="3538643">total</span><span class="op" id="3538648">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538651">}</span>&nbsp;<span class="keyword" id="3538653">else</span>&nbsp;<span class="op" id="3538658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538662">head</span>&nbsp;<span class="op" id="3538667">=</span>&nbsp;<span class="builtinfunc" id="3538669">make</span><span class="op" id="3538673">(</span><span class="op" id="3538674">[</span><span class="op" id="3538675">]</span><span class="builtintype" id="3538676">byte</span><span class="op" id="3538680">,</span>&nbsp;<span class="ident" id="3538682">total</span><span class="op" id="3538687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3538691">copy</span><span class="op" id="3538695">(</span><span class="ident" id="3538696">head</span><span class="op" id="3538700">,</span>&nbsp;<span class="ident" id="3538702">in</span><span class="op" id="3538704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538707">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538710">tail</span>&nbsp;<span class="op" id="3538715">=</span>&nbsp;<span class="ident" id="3538717">head</span><span class="op" id="3538721">[</span><span class="builtinfunc" id="3538722">len</span><span class="op" id="3538725">(</span><span class="ident" id="3538726">in</span><span class="op" id="3538728">)</span><span class="op" id="3538729">:</span><span class="op" id="3538730">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538733">return</span><br>
<span class="lineno"></span><span class="op" id="3538740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3538743">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword" id="3538808">func</span>&nbsp;<span class="op" id="3538813">(</span><span class="ident" id="3538814">g</span>&nbsp;<span class="op" id="3538816">*</span><span class="ident" id="3538817">gcm</span><span class="op" id="3538820">)</span>&nbsp;<span class="ident" id="3538822">counterCrypt</span><span class="op" id="3538834">(</span><span class="ident" id="3538835">out</span><span class="op" id="3538838">,</span>&nbsp;<span class="ident" id="3538840">in</span>&nbsp;<span class="op" id="3538843">[</span><span class="op" id="3538844">]</span><span class="builtintype" id="3538845">byte</span><span class="op" id="3538849">,</span>&nbsp;<span class="ident" id="3538851">counter</span>&nbsp;<span class="op" id="3538859">*</span><span class="op" id="3538860">[</span><span class="ident" id="3538861">gcmBlockSize</span><span class="op" id="3538873">]</span><span class="builtintype" id="3538874">byte</span><span class="op" id="3538878">)</span>&nbsp;<span class="op" id="3538880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538883">var</span>&nbsp;<span class="ident" id="3538887">mask</span>&nbsp;<span class="op" id="3538892">[</span><span class="ident" id="3538893">gcmBlockSize</span><span class="op" id="3538905">]</span><span class="builtintype" id="3538906">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538913">for</span>&nbsp;<span class="builtinfunc" id="3538917">len</span><span class="op" id="3538920">(</span><span class="ident" id="3538921">in</span><span class="op" id="3538923">)</span>&nbsp;<span class="op" id="3538925">&gt;=</span>&nbsp;<span class="ident" id="3538928">gcmBlockSize</span>&nbsp;<span class="op" id="3538941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538945">g</span><span class="op" id="3538946">.</span><span class="ident" id="3538947">cipher</span><span class="op" id="3538953">.</span><span class="ident" id="3538954">Encrypt</span><span class="op" id="3538961">(</span><span class="ident" id="3538962">mask</span><span class="op" id="3538966">[</span><span class="op" id="3538967">:</span><span class="op" id="3538968">]</span><span class="op" id="3538969">,</span>&nbsp;<span class="ident" id="3538971">counter</span><span class="op" id="3538978">[</span><span class="op" id="3538979">:</span><span class="op" id="3538980">]</span><span class="op" id="3538981">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538985">gcmInc32</span><span class="op" id="3538993">(</span><span class="ident" id="3538994">counter</span><span class="op" id="3539001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539006">xorWords</span><span class="op" id="3539014">(</span><span class="ident" id="3539015">out</span><span class="op" id="3539018">,</span>&nbsp;<span class="ident" id="3539020">in</span><span class="op" id="3539022">,</span>&nbsp;<span class="ident" id="3539024">mask</span><span class="op" id="3539028">[</span><span class="op" id="3539029">:</span><span class="op" id="3539030">]</span><span class="op" id="3539031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539035">out</span>&nbsp;<span class="op" id="3539039">=</span>&nbsp;<span class="ident" id="3539041">out</span><span class="op" id="3539044">[</span><span class="ident" id="3539045">gcmBlockSize</span><span class="op" id="3539057">:</span><span class="op" id="3539058">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539062">in</span>&nbsp;<span class="op" id="3539065">=</span>&nbsp;<span class="ident" id="3539067">in</span><span class="op" id="3539069">[</span><span class="ident" id="3539070">gcmBlockSize</span><span class="op" id="3539082">:</span><span class="op" id="3539083">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3539086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539090">if</span>&nbsp;<span class="builtinfunc" id="3539093">len</span><span class="op" id="3539096">(</span><span class="ident" id="3539097">in</span><span class="op" id="3539099">)</span>&nbsp;<span class="op" id="3539101">&gt;</span>&nbsp;<span class="num" id="3539103">0</span>&nbsp;<span class="op" id="3539105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539109">g</span><span class="op" id="3539110">.</span><span class="ident" id="3539111">cipher</span><span class="op" id="3539117">.</span><span class="ident" id="3539118">Encrypt</span><span class="op" id="3539125">(</span><span class="ident" id="3539126">mask</span><span class="op" id="3539130">[</span><span class="op" id="3539131">:</span><span class="op" id="3539132">]</span><span class="op" id="3539133">,</span>&nbsp;<span class="ident" id="3539135">counter</span><span class="op" id="3539142">[</span><span class="op" id="3539143">:</span><span class="op" id="3539144">]</span><span class="op" id="3539145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539149">gcmInc32</span><span class="op" id="3539157">(</span><span class="ident" id="3539158">counter</span><span class="op" id="3539165">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539169">xorBytes</span><span class="op" id="3539177">(</span><span class="ident" id="3539178">out</span><span class="op" id="3539181">,</span>&nbsp;<span class="ident" id="3539183">in</span><span class="op" id="3539185">,</span>&nbsp;<span class="ident" id="3539187">mask</span><span class="op" id="3539191">[</span><span class="op" id="3539192">:</span><span class="op" id="3539193">]</span><span class="op" id="3539194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3539197">}</span><br>
<span class="lineno"></span><span class="op" id="3539199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3539202">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment" id="3539278">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3539319">func</span>&nbsp;<span class="op" id="3539324">(</span><span class="ident" id="3539325">g</span>&nbsp;<span class="op" id="3539327">*</span><span class="ident" id="3539328">gcm</span><span class="op" id="3539331">)</span>&nbsp;<span class="ident" id="3539333">auth</span><span class="op" id="3539337">(</span><span class="ident" id="3539338">out</span><span class="op" id="3539341">,</span>&nbsp;<span class="ident" id="3539343">ciphertext</span><span class="op" id="3539353">,</span>&nbsp;<span class="ident" id="3539355">additionalData</span>&nbsp;<span class="op" id="3539370">[</span><span class="op" id="3539371">]</span><span class="builtintype" id="3539372">byte</span><span class="op" id="3539376">,</span>&nbsp;<span class="ident" id="3539378">tagMask</span>&nbsp;<span class="op" id="3539386">*</span><span class="op" id="3539387">[</span><span class="ident" id="3539388">gcmTagSize</span><span class="op" id="3539398">]</span><span class="builtintype" id="3539399">byte</span><span class="op" id="3539403">)</span>&nbsp;<span class="op" id="3539405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539408">var</span>&nbsp;<span class="ident" id="3539412">y</span>&nbsp;<span class="ident" id="3539414">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539431">g</span><span class="op" id="3539432">.</span><span class="ident" id="3539433">update</span><span class="op" id="3539439">(</span><span class="op" id="3539440">&amp;</span><span class="ident" id="3539441">y</span><span class="op" id="3539442">,</span>&nbsp;<span class="ident" id="3539444">additionalData</span><span class="op" id="3539458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539461">g</span><span class="op" id="3539462">.</span><span class="ident" id="3539463">update</span><span class="op" id="3539469">(</span><span class="op" id="3539470">&amp;</span><span class="ident" id="3539471">y</span><span class="op" id="3539472">,</span>&nbsp;<span class="ident" id="3539474">ciphertext</span><span class="op" id="3539484">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539488">y</span><span class="op" id="3539489">.</span><span class="ident" id="3539490">low</span>&nbsp;<span class="op" id="3539494">^=</span>&nbsp;<span class="ident" id="3539497">uint64</span><span class="op" id="3539503">(</span><span class="builtinfunc" id="3539504">len</span><span class="op" id="3539507">(</span><span class="ident" id="3539508">additionalData</span><span class="op" id="3539522">)</span><span class="op" id="3539523">)</span>&nbsp;<span class="op" id="3539525">*</span>&nbsp;<span class="num" id="3539527">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539530">y</span><span class="op" id="3539531">.</span><span class="ident" id="3539532">high</span>&nbsp;<span class="op" id="3539537">^=</span>&nbsp;<span class="ident" id="3539540">uint64</span><span class="op" id="3539546">(</span><span class="builtinfunc" id="3539547">len</span><span class="op" id="3539550">(</span><span class="ident" id="3539551">ciphertext</span><span class="op" id="3539561">)</span><span class="op" id="3539562">)</span>&nbsp;<span class="op" id="3539564">*</span>&nbsp;<span class="num" id="3539566">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539570">g</span><span class="op" id="3539571">.</span><span class="ident" id="3539572">mul</span><span class="op" id="3539575">(</span><span class="op" id="3539576">&amp;</span><span class="ident" id="3539577">y</span><span class="op" id="3539578">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539582">putUint64</span><span class="op" id="3539591">(</span><span class="ident" id="3539592">out</span><span class="op" id="3539595">,</span>&nbsp;<span class="ident" id="3539597">y</span><span class="op" id="3539598">.</span><span class="ident" id="3539599">low</span><span class="op" id="3539602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539605">putUint64</span><span class="op" id="3539614">(</span><span class="ident" id="3539615">out</span><span class="op" id="3539618">[</span><span class="num" id="3539619">8</span><span class="op" id="3539620">:</span><span class="op" id="3539621">]</span><span class="op" id="3539622">,</span>&nbsp;<span class="ident" id="3539624">y</span><span class="op" id="3539625">.</span><span class="ident" id="3539626">high</span><span class="op" id="3539630">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539634">xorWords</span><span class="op" id="3539642">(</span><span class="ident" id="3539643">out</span><span class="op" id="3539646">,</span>&nbsp;<span class="ident" id="3539648">out</span><span class="op" id="3539651">,</span>&nbsp;<span class="ident" id="3539653">tagMask</span><span class="op" id="3539660">[</span><span class="op" id="3539661">:</span><span class="op" id="3539662">]</span><span class="op" id="3539663">)</span><br>
<span class="lineno">320</span><span class="op" id="3539665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3539668">func</span>&nbsp;<span class="ident" id="3539673">getUint64</span><span class="op" id="3539682">(</span><span class="ident" id="3539683">data</span>&nbsp;<span class="op" id="3539688">[</span><span class="op" id="3539689">]</span><span class="builtintype" id="3539690">byte</span><span class="op" id="3539694">)</span>&nbsp;<span class="ident" id="3539696">uint64</span>&nbsp;<span class="op" id="3539703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539706">r</span>&nbsp;<span class="op" id="3539708">:=</span>&nbsp;<span class="ident" id="3539711">uint64</span><span class="op" id="3539717">(</span><span class="ident" id="3539718">data</span><span class="op" id="3539722">[</span><span class="num" id="3539723">0</span><span class="op" id="3539724">]</span><span class="op" id="3539725">)</span><span class="op" id="3539726">&lt;&lt;</span><span class="num" id="3539728">56</span>&nbsp;<span class="op" id="3539731">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539735">uint64</span><span class="op" id="3539741">(</span><span class="ident" id="3539742">data</span><span class="op" id="3539746">[</span><span class="num" id="3539747">1</span><span class="op" id="3539748">]</span><span class="op" id="3539749">)</span><span class="op" id="3539750">&lt;&lt;</span><span class="num" id="3539752">48</span>&nbsp;<span class="op" id="3539755">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539759">uint64</span><span class="op" id="3539765">(</span><span class="ident" id="3539766">data</span><span class="op" id="3539770">[</span><span class="num" id="3539771">2</span><span class="op" id="3539772">]</span><span class="op" id="3539773">)</span><span class="op" id="3539774">&lt;&lt;</span><span class="num" id="3539776">40</span>&nbsp;<span class="op" id="3539779">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539783">uint64</span><span class="op" id="3539789">(</span><span class="ident" id="3539790">data</span><span class="op" id="3539794">[</span><span class="num" id="3539795">3</span><span class="op" id="3539796">]</span><span class="op" id="3539797">)</span><span class="op" id="3539798">&lt;&lt;</span><span class="num" id="3539800">32</span>&nbsp;<span class="op" id="3539803">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539807">uint64</span><span class="op" id="3539813">(</span><span class="ident" id="3539814">data</span><span class="op" id="3539818">[</span><span class="num" id="3539819">4</span><span class="op" id="3539820">]</span><span class="op" id="3539821">)</span><span class="op" id="3539822">&lt;&lt;</span><span class="num" id="3539824">24</span>&nbsp;<span class="op" id="3539827">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539831">uint64</span><span class="op" id="3539837">(</span><span class="ident" id="3539838">data</span><span class="op" id="3539842">[</span><span class="num" id="3539843">5</span><span class="op" id="3539844">]</span><span class="op" id="3539845">)</span><span class="op" id="3539846">&lt;&lt;</span><span class="num" id="3539848">16</span>&nbsp;<span class="op" id="3539851">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539855">uint64</span><span class="op" id="3539861">(</span><span class="ident" id="3539862">data</span><span class="op" id="3539866">[</span><span class="num" id="3539867">6</span><span class="op" id="3539868">]</span><span class="op" id="3539869">)</span><span class="op" id="3539870">&lt;&lt;</span><span class="num" id="3539872">8</span>&nbsp;<span class="op" id="3539874">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539878">uint64</span><span class="op" id="3539884">(</span><span class="ident" id="3539885">data</span><span class="op" id="3539889">[</span><span class="num" id="3539890">7</span><span class="op" id="3539891">]</span><span class="op" id="3539892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539895">return</span>&nbsp;<span class="ident" id="3539902">r</span><br>
<span class="lineno"></span><span class="op" id="3539904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3539907">func</span>&nbsp;<span class="ident" id="3539912">putUint64</span><span class="op" id="3539921">(</span><span class="ident" id="3539922">out</span>&nbsp;<span class="op" id="3539926">[</span><span class="op" id="3539927">]</span><span class="builtintype" id="3539928">byte</span><span class="op" id="3539932">,</span>&nbsp;<span class="ident" id="3539934">v</span>&nbsp;<span class="ident" id="3539936">uint64</span><span class="op" id="3539942">)</span>&nbsp;<span class="op" id="3539944">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539947">out</span><span class="op" id="3539950">[</span><span class="num" id="3539951">0</span><span class="op" id="3539952">]</span>&nbsp;<span class="op" id="3539954">=</span>&nbsp;<span class="builtintype" id="3539956">byte</span><span class="op" id="3539960">(</span><span class="ident" id="3539961">v</span>&nbsp;<span class="op" id="3539963">&gt;&gt;</span>&nbsp;<span class="num" id="3539966">56</span><span class="op" id="3539968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539971">out</span><span class="op" id="3539974">[</span><span class="num" id="3539975">1</span><span class="op" id="3539976">]</span>&nbsp;<span class="op" id="3539978">=</span>&nbsp;<span class="builtintype" id="3539980">byte</span><span class="op" id="3539984">(</span><span class="ident" id="3539985">v</span>&nbsp;<span class="op" id="3539987">&gt;&gt;</span>&nbsp;<span class="num" id="3539990">48</span><span class="op" id="3539992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539995">out</span><span class="op" id="3539998">[</span><span class="num" id="3539999">2</span><span class="op" id="3540000">]</span>&nbsp;<span class="op" id="3540002">=</span>&nbsp;<span class="builtintype" id="3540004">byte</span><span class="op" id="3540008">(</span><span class="ident" id="3540009">v</span>&nbsp;<span class="op" id="3540011">&gt;&gt;</span>&nbsp;<span class="num" id="3540014">40</span><span class="op" id="3540016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540019">out</span><span class="op" id="3540022">[</span><span class="num" id="3540023">3</span><span class="op" id="3540024">]</span>&nbsp;<span class="op" id="3540026">=</span>&nbsp;<span class="builtintype" id="3540028">byte</span><span class="op" id="3540032">(</span><span class="ident" id="3540033">v</span>&nbsp;<span class="op" id="3540035">&gt;&gt;</span>&nbsp;<span class="num" id="3540038">32</span><span class="op" id="3540040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540043">out</span><span class="op" id="3540046">[</span><span class="num" id="3540047">4</span><span class="op" id="3540048">]</span>&nbsp;<span class="op" id="3540050">=</span>&nbsp;<span class="builtintype" id="3540052">byte</span><span class="op" id="3540056">(</span><span class="ident" id="3540057">v</span>&nbsp;<span class="op" id="3540059">&gt;&gt;</span>&nbsp;<span class="num" id="3540062">24</span><span class="op" id="3540064">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540067">out</span><span class="op" id="3540070">[</span><span class="num" id="3540071">5</span><span class="op" id="3540072">]</span>&nbsp;<span class="op" id="3540074">=</span>&nbsp;<span class="builtintype" id="3540076">byte</span><span class="op" id="3540080">(</span><span class="ident" id="3540081">v</span>&nbsp;<span class="op" id="3540083">&gt;&gt;</span>&nbsp;<span class="num" id="3540086">16</span><span class="op" id="3540088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540091">out</span><span class="op" id="3540094">[</span><span class="num" id="3540095">6</span><span class="op" id="3540096">]</span>&nbsp;<span class="op" id="3540098">=</span>&nbsp;<span class="builtintype" id="3540100">byte</span><span class="op" id="3540104">(</span><span class="ident" id="3540105">v</span>&nbsp;<span class="op" id="3540107">&gt;&gt;</span>&nbsp;<span class="num" id="3540110">8</span><span class="op" id="3540111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540114">out</span><span class="op" id="3540117">[</span><span class="num" id="3540118">7</span><span class="op" id="3540119">]</span>&nbsp;<span class="op" id="3540121">=</span>&nbsp;<span class="builtintype" id="3540123">byte</span><span class="op" id="3540127">(</span><span class="ident" id="3540128">v</span><span class="op" id="3540129">)</span><br>
<span class="lineno"></span><span class="op" id="3540131">}</span>
</div>
</body>
</html>
