<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1626705">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1626760">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1626814">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1626865">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1626943">package</span>&nbsp;<span class="ident" id="1626951">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1626960">import</span>&nbsp;<span class="string" id="1626967">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1626977">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1627035">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1627118">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1627170">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1627261">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1627290">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1627376">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1627433">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1627512">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1627586">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1627637">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1627718">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1627797">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1627875">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1627961">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1628043">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1628101">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1628196">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1628238">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1628269">const</span>&nbsp;<span class="op" id="1628275">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628278">pdReady</span>&nbsp;<span class="builtintype" id="1628286">uintptr</span>&nbsp;<span class="op" id="1628294">=</span>&nbsp;<span class="num" id="1628296">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628299">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1628307">uintptr</span>&nbsp;<span class="op" id="1628315">=</span>&nbsp;<span class="num" id="1628317">2</span><br>
<span class="lineno"></span><span class="op" id="1628319">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1628322">const</span>&nbsp;<span class="ident" id="1628328">pollBlockSize</span>&nbsp;<span class="op" id="1628342">=</span>&nbsp;<span class="num" id="1628344">4</span>&nbsp;<span class="op" id="1628346">*</span>&nbsp;<span class="num" id="1628348">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1628354">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1628384">type</span>&nbsp;<span class="ident" id="1628389">pollDesc</span>&nbsp;<span class="keyword" id="1628398">struct</span>&nbsp;<span class="op" id="1628405">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628408">link</span>&nbsp;<span class="op" id="1628413">*</span><span class="ident" id="1628414">pollDesc</span>&nbsp;<span class="comment" id="1628423">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628470">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628560">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628657">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtime·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628753">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628832">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628874">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628946">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628999">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1629007">mutex</span>&nbsp;<span class="comment" id="1629013">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629048">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1629056">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629065">closing</span>&nbsp;<span class="builtintype" id="1629073">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629079">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1629087">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1629102">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629157">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1629165">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1629180">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629227">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1629235">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1629250">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629295">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1629303">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1629318">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629336">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1629344">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1629359">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629407">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1629415">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1629430">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629455">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1629463">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1629478">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629497">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1629505">unsafe</span><span class="op" id="1629511">.</span><span class="ident" id="1629512">Pointer</span>&nbsp;<span class="comment" id="1629520">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1629544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1629547">type</span>&nbsp;<span class="ident" id="1629552">pollCache</span>&nbsp;<span class="keyword" id="1629562">struct</span>&nbsp;<span class="op" id="1629569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629572">lock</span>&nbsp;&nbsp;<span class="ident" id="1629578">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629585">first</span>&nbsp;<span class="op" id="1629591">*</span><span class="ident" id="1629592">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629602">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629644">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629704">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629747">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629804">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1629878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1629881">var</span>&nbsp;<span class="ident" id="1629885">pollcache</span>&nbsp;<span class="ident" id="1629895">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1629906">func</span>&nbsp;<span class="ident" id="1629911">netpollServerInit</span><span class="op" id="1629928">(</span><span class="op" id="1629929">)</span>&nbsp;<span class="op" id="1629931">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629934">onM</span><span class="op" id="1629937">(</span><span class="ident" id="1629938">netpollinit</span><span class="op" id="1629949">)</span><br>
<span class="lineno"></span><span class="op" id="1629951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1629954">func</span>&nbsp;<span class="ident" id="1629959">netpollOpen</span><span class="op" id="1629970">(</span><span class="ident" id="1629971">fd</span>&nbsp;<span class="builtintype" id="1629974">uintptr</span><span class="op" id="1629981">)</span>&nbsp;<span class="op" id="1629983">(</span><span class="op" id="1629984">*</span><span class="ident" id="1629985">pollDesc</span><span class="op" id="1629993">,</span>&nbsp;<span class="builtintype" id="1629995">int</span><span class="op" id="1629998">)</span>&nbsp;<span class="op" id="1630000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630003">pd</span>&nbsp;<span class="op" id="1630006">:=</span>&nbsp;<span class="ident" id="1630009">pollcache</span><span class="op" id="1630018">.</span><span class="ident" id="1630019">alloc</span><span class="op" id="1630024">(</span><span class="op" id="1630025">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630028">lock</span><span class="op" id="1630032">(</span><span class="op" id="1630033">&amp;</span><span class="ident" id="1630034">pd</span><span class="op" id="1630036">.</span><span class="ident" id="1630037">lock</span><span class="op" id="1630041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630044">if</span>&nbsp;<span class="ident" id="1630047">pd</span><span class="op" id="1630049">.</span><span class="ident" id="1630050">wg</span>&nbsp;<span class="op" id="1630053">!=</span>&nbsp;<span class="num" id="1630056">0</span>&nbsp;<span class="op" id="1630058">&amp;&amp;</span>&nbsp;<span class="ident" id="1630061">pd</span><span class="op" id="1630063">.</span><span class="ident" id="1630064">wg</span>&nbsp;<span class="op" id="1630067">!=</span>&nbsp;<span class="ident" id="1630070">pdReady</span>&nbsp;<span class="op" id="1630078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630082">gothrow</span><span class="op" id="1630089">(</span><span class="string" id="1630090">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1630137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630143">if</span>&nbsp;<span class="ident" id="1630146">pd</span><span class="op" id="1630148">.</span><span class="ident" id="1630149">rg</span>&nbsp;<span class="op" id="1630152">!=</span>&nbsp;<span class="num" id="1630155">0</span>&nbsp;<span class="op" id="1630157">&amp;&amp;</span>&nbsp;<span class="ident" id="1630160">pd</span><span class="op" id="1630162">.</span><span class="ident" id="1630163">rg</span>&nbsp;<span class="op" id="1630166">!=</span>&nbsp;<span class="ident" id="1630169">pdReady</span>&nbsp;<span class="op" id="1630177">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630181">gothrow</span><span class="op" id="1630188">(</span><span class="string" id="1630189">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1630235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630241">pd</span><span class="op" id="1630243">.</span><span class="ident" id="1630244">fd</span>&nbsp;<span class="op" id="1630247">=</span>&nbsp;<span class="ident" id="1630249">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630253">pd</span><span class="op" id="1630255">.</span><span class="ident" id="1630256">closing</span>&nbsp;<span class="op" id="1630264">=</span>&nbsp;<span class="builtintype" id="1630266">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630273">pd</span><span class="op" id="1630275">.</span><span class="ident" id="1630276">seq</span><span class="op" id="1630279">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630283">pd</span><span class="op" id="1630285">.</span><span class="ident" id="1630286">rg</span>&nbsp;<span class="op" id="1630289">=</span>&nbsp;<span class="num" id="1630291">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630294">pd</span><span class="op" id="1630296">.</span><span class="ident" id="1630297">rd</span>&nbsp;<span class="op" id="1630300">=</span>&nbsp;<span class="num" id="1630302">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630305">pd</span><span class="op" id="1630307">.</span><span class="ident" id="1630308">wg</span>&nbsp;<span class="op" id="1630311">=</span>&nbsp;<span class="num" id="1630313">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630316">pd</span><span class="op" id="1630318">.</span><span class="ident" id="1630319">wd</span>&nbsp;<span class="op" id="1630322">=</span>&nbsp;<span class="num" id="1630324">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630327">unlock</span><span class="op" id="1630333">(</span><span class="op" id="1630334">&amp;</span><span class="ident" id="1630335">pd</span><span class="op" id="1630337">.</span><span class="ident" id="1630338">lock</span><span class="op" id="1630342">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630346">var</span>&nbsp;<span class="ident" id="1630350">errno</span>&nbsp;<span class="builtintype" id="1630356">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630363">onM</span><span class="op" id="1630366">(</span><span class="keyword" id="1630367">func</span><span class="op" id="1630371">(</span><span class="op" id="1630372">)</span>&nbsp;<span class="op" id="1630374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630378">errno</span>&nbsp;<span class="op" id="1630384">=</span>&nbsp;<span class="ident" id="1630386">netpollopen</span><span class="op" id="1630397">(</span><span class="ident" id="1630398">fd</span><span class="op" id="1630400">,</span>&nbsp;<span class="ident" id="1630402">pd</span><span class="op" id="1630404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630407">}</span><span class="op" id="1630408">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630411">return</span>&nbsp;<span class="ident" id="1630418">pd</span><span class="op" id="1630420">,</span>&nbsp;<span class="builtintype" id="1630422">int</span><span class="op" id="1630425">(</span><span class="ident" id="1630426">errno</span><span class="op" id="1630431">)</span><br>
<span class="lineno"></span><span class="op" id="1630433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1630436">func</span>&nbsp;<span class="ident" id="1630441">netpollClose</span><span class="op" id="1630453">(</span><span class="ident" id="1630454">pd</span>&nbsp;<span class="op" id="1630457">*</span><span class="ident" id="1630458">pollDesc</span><span class="op" id="1630466">)</span>&nbsp;<span class="op" id="1630468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630471">if</span>&nbsp;<span class="op" id="1630474">!</span><span class="ident" id="1630475">pd</span><span class="op" id="1630477">.</span><span class="ident" id="1630478">closing</span>&nbsp;<span class="op" id="1630486">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630490">gothrow</span><span class="op" id="1630497">(</span><span class="string" id="1630498">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1630531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630537">if</span>&nbsp;<span class="ident" id="1630540">pd</span><span class="op" id="1630542">.</span><span class="ident" id="1630543">wg</span>&nbsp;<span class="op" id="1630546">!=</span>&nbsp;<span class="num" id="1630549">0</span>&nbsp;<span class="op" id="1630551">&amp;&amp;</span>&nbsp;<span class="ident" id="1630554">pd</span><span class="op" id="1630556">.</span><span class="ident" id="1630557">wg</span>&nbsp;<span class="op" id="1630560">!=</span>&nbsp;<span class="ident" id="1630563">pdReady</span>&nbsp;<span class="op" id="1630571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630575">gothrow</span><span class="op" id="1630582">(</span><span class="string" id="1630583">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1630634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630637">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630640">if</span>&nbsp;<span class="ident" id="1630643">pd</span><span class="op" id="1630645">.</span><span class="ident" id="1630646">rg</span>&nbsp;<span class="op" id="1630649">!=</span>&nbsp;<span class="num" id="1630652">0</span>&nbsp;<span class="op" id="1630654">&amp;&amp;</span>&nbsp;<span class="ident" id="1630657">pd</span><span class="op" id="1630659">.</span><span class="ident" id="1630660">rg</span>&nbsp;<span class="op" id="1630663">!=</span>&nbsp;<span class="ident" id="1630666">pdReady</span>&nbsp;<span class="op" id="1630674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630678">gothrow</span><span class="op" id="1630685">(</span><span class="string" id="1630686">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1630736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630742">onM</span><span class="op" id="1630745">(</span><span class="keyword" id="1630746">func</span><span class="op" id="1630750">(</span><span class="op" id="1630751">)</span>&nbsp;<span class="op" id="1630753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630757">netpollclose</span><span class="op" id="1630769">(</span><span class="builtintype" id="1630770">uintptr</span><span class="op" id="1630777">(</span><span class="ident" id="1630778">pd</span><span class="op" id="1630780">.</span><span class="ident" id="1630781">fd</span><span class="op" id="1630783">)</span><span class="op" id="1630784">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630787">}</span><span class="op" id="1630788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630791">pollcache</span><span class="op" id="1630800">.</span><span class="ident" id="1630801">free</span><span class="op" id="1630805">(</span><span class="ident" id="1630806">pd</span><span class="op" id="1630808">)</span><br>
<span class="lineno"></span><span class="op" id="1630810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1630813">func</span>&nbsp;<span class="op" id="1630818">(</span><span class="ident" id="1630819">c</span>&nbsp;<span class="op" id="1630821">*</span><span class="ident" id="1630822">pollCache</span><span class="op" id="1630831">)</span>&nbsp;<span class="ident" id="1630833">free</span><span class="op" id="1630837">(</span><span class="ident" id="1630838">pd</span>&nbsp;<span class="op" id="1630841">*</span><span class="ident" id="1630842">pollDesc</span><span class="op" id="1630850">)</span>&nbsp;<span class="op" id="1630852">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630855">lock</span><span class="op" id="1630859">(</span><span class="op" id="1630860">&amp;</span><span class="ident" id="1630861">c</span><span class="op" id="1630862">.</span><span class="ident" id="1630863">lock</span><span class="op" id="1630867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630870">pd</span><span class="op" id="1630872">.</span><span class="ident" id="1630873">link</span>&nbsp;<span class="op" id="1630878">=</span>&nbsp;<span class="ident" id="1630880">c</span><span class="op" id="1630881">.</span><span class="ident" id="1630882">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630889">c</span><span class="op" id="1630890">.</span><span class="ident" id="1630891">first</span>&nbsp;<span class="op" id="1630897">=</span>&nbsp;<span class="ident" id="1630899">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630903">unlock</span><span class="op" id="1630909">(</span><span class="op" id="1630910">&amp;</span><span class="ident" id="1630911">c</span><span class="op" id="1630912">.</span><span class="ident" id="1630913">lock</span><span class="op" id="1630917">)</span><br>
<span class="lineno"></span><span class="op" id="1630919">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1630922">func</span>&nbsp;<span class="ident" id="1630927">netpollReset</span><span class="op" id="1630939">(</span><span class="ident" id="1630940">pd</span>&nbsp;<span class="op" id="1630943">*</span><span class="ident" id="1630944">pollDesc</span><span class="op" id="1630952">,</span>&nbsp;<span class="ident" id="1630954">mode</span>&nbsp;<span class="builtintype" id="1630959">int</span><span class="op" id="1630962">)</span>&nbsp;<span class="builtintype" id="1630964">int</span>&nbsp;<span class="op" id="1630968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630971">err</span>&nbsp;<span class="op" id="1630975">:=</span>&nbsp;<span class="ident" id="1630978">netpollcheckerr</span><span class="op" id="1630993">(</span><span class="ident" id="1630994">pd</span><span class="op" id="1630996">,</span>&nbsp;<span class="builtintype" id="1630998">int32</span><span class="op" id="1631003">(</span><span class="ident" id="1631004">mode</span><span class="op" id="1631008">)</span><span class="op" id="1631009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631012">if</span>&nbsp;<span class="ident" id="1631015">err</span>&nbsp;<span class="op" id="1631019">!=</span>&nbsp;<span class="num" id="1631022">0</span>&nbsp;<span class="op" id="1631024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631028">return</span>&nbsp;<span class="ident" id="1631035">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631043">if</span>&nbsp;<span class="ident" id="1631046">mode</span>&nbsp;<span class="op" id="1631051">==</span>&nbsp;<span class="string" id="1631054">&#39;r&#39;</span>&nbsp;<span class="op" id="1631058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631062">pd</span><span class="op" id="1631064">.</span><span class="ident" id="1631065">rg</span>&nbsp;<span class="op" id="1631068">=</span>&nbsp;<span class="num" id="1631070">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631073">}</span>&nbsp;<span class="keyword" id="1631075">else</span>&nbsp;<span class="keyword" id="1631080">if</span>&nbsp;<span class="ident" id="1631083">mode</span>&nbsp;<span class="op" id="1631088">==</span>&nbsp;<span class="string" id="1631091">&#39;w&#39;</span>&nbsp;<span class="op" id="1631095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631099">pd</span><span class="op" id="1631101">.</span><span class="ident" id="1631102">wg</span>&nbsp;<span class="op" id="1631105">=</span>&nbsp;<span class="num" id="1631107">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631113">return</span>&nbsp;<span class="num" id="1631120">0</span><br>
<span class="lineno"></span><span class="op" id="1631122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1631125">func</span>&nbsp;<span class="ident" id="1631130">netpollWait</span><span class="op" id="1631141">(</span><span class="ident" id="1631142">pd</span>&nbsp;<span class="op" id="1631145">*</span><span class="ident" id="1631146">pollDesc</span><span class="op" id="1631154">,</span>&nbsp;<span class="ident" id="1631156">mode</span>&nbsp;<span class="builtintype" id="1631161">int</span><span class="op" id="1631164">)</span>&nbsp;<span class="builtintype" id="1631166">int</span>&nbsp;<span class="op" id="1631170">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631173">err</span>&nbsp;<span class="op" id="1631177">:=</span>&nbsp;<span class="ident" id="1631180">netpollcheckerr</span><span class="op" id="1631195">(</span><span class="ident" id="1631196">pd</span><span class="op" id="1631198">,</span>&nbsp;<span class="builtintype" id="1631200">int32</span><span class="op" id="1631205">(</span><span class="ident" id="1631206">mode</span><span class="op" id="1631210">)</span><span class="op" id="1631211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631214">if</span>&nbsp;<span class="ident" id="1631217">err</span>&nbsp;<span class="op" id="1631221">!=</span>&nbsp;<span class="num" id="1631224">0</span>&nbsp;<span class="op" id="1631226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631230">return</span>&nbsp;<span class="ident" id="1631237">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631245">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631298">if</span>&nbsp;<span class="ident" id="1631301">GOOS</span>&nbsp;<span class="op" id="1631306">==</span>&nbsp;<span class="string" id="1631309">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1631319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631323">onM</span><span class="op" id="1631326">(</span><span class="keyword" id="1631327">func</span><span class="op" id="1631331">(</span><span class="op" id="1631332">)</span>&nbsp;<span class="op" id="1631334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631339">netpollarm</span><span class="op" id="1631349">(</span><span class="ident" id="1631350">pd</span><span class="op" id="1631352">,</span>&nbsp;<span class="ident" id="1631354">mode</span><span class="op" id="1631358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631362">}</span><span class="op" id="1631363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631366">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631369">for</span>&nbsp;<span class="op" id="1631373">!</span><span class="ident" id="1631374">netpollblock</span><span class="op" id="1631386">(</span><span class="ident" id="1631387">pd</span><span class="op" id="1631389">,</span>&nbsp;<span class="builtintype" id="1631391">int32</span><span class="op" id="1631396">(</span><span class="ident" id="1631397">mode</span><span class="op" id="1631401">)</span><span class="op" id="1631402">,</span>&nbsp;<span class="builtintype" id="1631404">false</span><span class="op" id="1631409">)</span>&nbsp;<span class="op" id="1631411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631415">err</span>&nbsp;<span class="op" id="1631419">=</span>&nbsp;<span class="ident" id="1631421">netpollcheckerr</span><span class="op" id="1631436">(</span><span class="ident" id="1631437">pd</span><span class="op" id="1631439">,</span>&nbsp;<span class="builtintype" id="1631441">int32</span><span class="op" id="1631446">(</span><span class="ident" id="1631447">mode</span><span class="op" id="1631451">)</span><span class="op" id="1631452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631456">if</span>&nbsp;<span class="ident" id="1631459">err</span>&nbsp;<span class="op" id="1631463">!=</span>&nbsp;<span class="num" id="1631466">0</span>&nbsp;<span class="op" id="1631468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631473">return</span>&nbsp;<span class="ident" id="1631480">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631486">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631490">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631545">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631609">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631655">return</span>&nbsp;<span class="num" id="1631662">0</span><br>
<span class="lineno">160</span><span class="op" id="1631664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1631667">func</span>&nbsp;<span class="ident" id="1631672">netpollWaitCanceled</span><span class="op" id="1631691">(</span><span class="ident" id="1631692">pd</span>&nbsp;<span class="op" id="1631695">*</span><span class="ident" id="1631696">pollDesc</span><span class="op" id="1631704">,</span>&nbsp;<span class="ident" id="1631706">mode</span>&nbsp;<span class="builtintype" id="1631711">int</span><span class="op" id="1631714">)</span>&nbsp;<span class="op" id="1631716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631719">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631794">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631874">for</span>&nbsp;<span class="op" id="1631878">!</span><span class="ident" id="1631879">netpollblock</span><span class="op" id="1631891">(</span><span class="ident" id="1631892">pd</span><span class="op" id="1631894">,</span>&nbsp;<span class="builtintype" id="1631896">int32</span><span class="op" id="1631901">(</span><span class="ident" id="1631902">mode</span><span class="op" id="1631906">)</span><span class="op" id="1631907">,</span>&nbsp;<span class="builtintype" id="1631909">true</span><span class="op" id="1631913">)</span>&nbsp;<span class="op" id="1631915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631918">}</span><br>
<span class="lineno"></span><span class="op" id="1631920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1631923">func</span>&nbsp;<span class="ident" id="1631928">netpollSetDeadline</span><span class="op" id="1631946">(</span><span class="ident" id="1631947">pd</span>&nbsp;<span class="op" id="1631950">*</span><span class="ident" id="1631951">pollDesc</span><span class="op" id="1631959">,</span>&nbsp;<span class="ident" id="1631961">d</span>&nbsp;<span class="ident" id="1631963">int64</span><span class="op" id="1631968">,</span>&nbsp;<span class="ident" id="1631970">mode</span>&nbsp;<span class="builtintype" id="1631975">int</span><span class="op" id="1631978">)</span>&nbsp;<span class="op" id="1631980">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631983">lock</span><span class="op" id="1631987">(</span><span class="op" id="1631988">&amp;</span><span class="ident" id="1631989">pd</span><span class="op" id="1631991">.</span><span class="ident" id="1631992">lock</span><span class="op" id="1631996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631999">if</span>&nbsp;<span class="ident" id="1632002">pd</span><span class="op" id="1632004">.</span><span class="ident" id="1632005">closing</span>&nbsp;<span class="op" id="1632013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632017">unlock</span><span class="op" id="1632023">(</span><span class="op" id="1632024">&amp;</span><span class="ident" id="1632025">pd</span><span class="op" id="1632027">.</span><span class="ident" id="1632028">lock</span><span class="op" id="1632032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632036">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632044">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632047">pd</span><span class="op" id="1632049">.</span><span class="ident" id="1632050">seq</span><span class="op" id="1632053">++</span>&nbsp;<span class="comment" id="1632056">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632086">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632112">if</span>&nbsp;<span class="ident" id="1632115">pd</span><span class="op" id="1632117">.</span><span class="ident" id="1632118">rt</span><span class="op" id="1632120">.</span><span class="ident" id="1632121">f</span>&nbsp;<span class="op" id="1632123">!=</span>&nbsp;<span class="ident" id="1632126">nil</span>&nbsp;<span class="op" id="1632130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632134">deltimer</span><span class="op" id="1632142">(</span><span class="op" id="1632143">&amp;</span><span class="ident" id="1632144">pd</span><span class="op" id="1632146">.</span><span class="ident" id="1632147">rt</span><span class="op" id="1632149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632153">pd</span><span class="op" id="1632155">.</span><span class="ident" id="1632156">rt</span><span class="op" id="1632158">.</span><span class="ident" id="1632159">f</span>&nbsp;<span class="op" id="1632161">=</span>&nbsp;<span class="ident" id="1632163">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632171">if</span>&nbsp;<span class="ident" id="1632174">pd</span><span class="op" id="1632176">.</span><span class="ident" id="1632177">wt</span><span class="op" id="1632179">.</span><span class="ident" id="1632180">f</span>&nbsp;<span class="op" id="1632182">!=</span>&nbsp;<span class="ident" id="1632185">nil</span>&nbsp;<span class="op" id="1632189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632193">deltimer</span><span class="op" id="1632201">(</span><span class="op" id="1632202">&amp;</span><span class="ident" id="1632203">pd</span><span class="op" id="1632205">.</span><span class="ident" id="1632206">wt</span><span class="op" id="1632208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632212">pd</span><span class="op" id="1632214">.</span><span class="ident" id="1632215">wt</span><span class="op" id="1632217">.</span><span class="ident" id="1632218">f</span>&nbsp;<span class="op" id="1632220">=</span>&nbsp;<span class="ident" id="1632222">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632227">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632230">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632252">if</span>&nbsp;<span class="ident" id="1632255">d</span>&nbsp;<span class="op" id="1632257">!=</span>&nbsp;<span class="num" id="1632260">0</span>&nbsp;<span class="op" id="1632262">&amp;&amp;</span>&nbsp;<span class="ident" id="1632265">d</span>&nbsp;<span class="op" id="1632267">&lt;=</span>&nbsp;<span class="ident" id="1632270">nanotime</span><span class="op" id="1632278">(</span><span class="op" id="1632279">)</span>&nbsp;<span class="op" id="1632281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632285">d</span>&nbsp;<span class="op" id="1632287">=</span>&nbsp;<span class="op" id="1632289">-</span><span class="num" id="1632290">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632296">if</span>&nbsp;<span class="ident" id="1632299">mode</span>&nbsp;<span class="op" id="1632304">==</span>&nbsp;<span class="string" id="1632307">&#39;r&#39;</span>&nbsp;<span class="op" id="1632311">||</span>&nbsp;<span class="ident" id="1632314">mode</span>&nbsp;<span class="op" id="1632319">==</span>&nbsp;<span class="string" id="1632322">&#39;r&#39;</span><span class="op" id="1632325">+</span><span class="string" id="1632326">&#39;w&#39;</span>&nbsp;<span class="op" id="1632330">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632334">pd</span><span class="op" id="1632336">.</span><span class="ident" id="1632337">rd</span>&nbsp;<span class="op" id="1632340">=</span>&nbsp;<span class="ident" id="1632342">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632348">if</span>&nbsp;<span class="ident" id="1632351">mode</span>&nbsp;<span class="op" id="1632356">==</span>&nbsp;<span class="string" id="1632359">&#39;w&#39;</span>&nbsp;<span class="op" id="1632363">||</span>&nbsp;<span class="ident" id="1632366">mode</span>&nbsp;<span class="op" id="1632371">==</span>&nbsp;<span class="string" id="1632374">&#39;r&#39;</span><span class="op" id="1632377">+</span><span class="string" id="1632378">&#39;w&#39;</span>&nbsp;<span class="op" id="1632382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632386">pd</span><span class="op" id="1632388">.</span><span class="ident" id="1632389">wd</span>&nbsp;<span class="op" id="1632392">=</span>&nbsp;<span class="ident" id="1632394">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632397">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632400">if</span>&nbsp;<span class="ident" id="1632403">pd</span><span class="op" id="1632405">.</span><span class="ident" id="1632406">rd</span>&nbsp;<span class="op" id="1632409">&gt;</span>&nbsp;<span class="num" id="1632411">0</span>&nbsp;<span class="op" id="1632413">&amp;&amp;</span>&nbsp;<span class="ident" id="1632416">pd</span><span class="op" id="1632418">.</span><span class="ident" id="1632419">rd</span>&nbsp;<span class="op" id="1632422">==</span>&nbsp;<span class="ident" id="1632425">pd</span><span class="op" id="1632427">.</span><span class="ident" id="1632428">wd</span>&nbsp;<span class="op" id="1632431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632435">pd</span><span class="op" id="1632437">.</span><span class="ident" id="1632438">rt</span><span class="op" id="1632440">.</span><span class="ident" id="1632441">f</span>&nbsp;<span class="op" id="1632443">=</span>&nbsp;<span class="ident" id="1632445">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632463">pd</span><span class="op" id="1632465">.</span><span class="ident" id="1632466">rt</span><span class="op" id="1632468">.</span><span class="ident" id="1632469">when</span>&nbsp;<span class="op" id="1632474">=</span>&nbsp;<span class="ident" id="1632476">pd</span><span class="op" id="1632478">.</span><span class="ident" id="1632479">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632484">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632526">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632593">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632661">pd</span><span class="op" id="1632663">.</span><span class="ident" id="1632664">rt</span><span class="op" id="1632666">.</span><span class="ident" id="1632667">arg</span>&nbsp;<span class="op" id="1632671">=</span>&nbsp;<span class="ident" id="1632673">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632678">pd</span><span class="op" id="1632680">.</span><span class="ident" id="1632681">rt</span><span class="op" id="1632683">.</span><span class="ident" id="1632684">seq</span>&nbsp;<span class="op" id="1632688">=</span>&nbsp;<span class="ident" id="1632690">pd</span><span class="op" id="1632692">.</span><span class="ident" id="1632693">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632699">addtimer</span><span class="op" id="1632707">(</span><span class="op" id="1632708">&amp;</span><span class="ident" id="1632709">pd</span><span class="op" id="1632711">.</span><span class="ident" id="1632712">rt</span><span class="op" id="1632714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632717">}</span>&nbsp;<span class="keyword" id="1632719">else</span>&nbsp;<span class="op" id="1632724">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632728">if</span>&nbsp;<span class="ident" id="1632731">pd</span><span class="op" id="1632733">.</span><span class="ident" id="1632734">rd</span>&nbsp;<span class="op" id="1632737">&gt;</span>&nbsp;<span class="num" id="1632739">0</span>&nbsp;<span class="op" id="1632741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632746">pd</span><span class="op" id="1632748">.</span><span class="ident" id="1632749">rt</span><span class="op" id="1632751">.</span><span class="ident" id="1632752">f</span>&nbsp;<span class="op" id="1632754">=</span>&nbsp;<span class="ident" id="1632756">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632779">pd</span><span class="op" id="1632781">.</span><span class="ident" id="1632782">rt</span><span class="op" id="1632784">.</span><span class="ident" id="1632785">when</span>&nbsp;<span class="op" id="1632790">=</span>&nbsp;<span class="ident" id="1632792">pd</span><span class="op" id="1632794">.</span><span class="ident" id="1632795">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632801">pd</span><span class="op" id="1632803">.</span><span class="ident" id="1632804">rt</span><span class="op" id="1632806">.</span><span class="ident" id="1632807">arg</span>&nbsp;<span class="op" id="1632811">=</span>&nbsp;<span class="ident" id="1632813">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632819">pd</span><span class="op" id="1632821">.</span><span class="ident" id="1632822">rt</span><span class="op" id="1632824">.</span><span class="ident" id="1632825">seq</span>&nbsp;<span class="op" id="1632829">=</span>&nbsp;<span class="ident" id="1632831">pd</span><span class="op" id="1632833">.</span><span class="ident" id="1632834">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632841">addtimer</span><span class="op" id="1632849">(</span><span class="op" id="1632850">&amp;</span><span class="ident" id="1632851">pd</span><span class="op" id="1632853">.</span><span class="ident" id="1632854">rt</span><span class="op" id="1632856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632864">if</span>&nbsp;<span class="ident" id="1632867">pd</span><span class="op" id="1632869">.</span><span class="ident" id="1632870">wd</span>&nbsp;<span class="op" id="1632873">&gt;</span>&nbsp;<span class="num" id="1632875">0</span>&nbsp;<span class="op" id="1632877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632882">pd</span><span class="op" id="1632884">.</span><span class="ident" id="1632885">wt</span><span class="op" id="1632887">.</span><span class="ident" id="1632888">f</span>&nbsp;<span class="op" id="1632890">=</span>&nbsp;<span class="ident" id="1632892">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632916">pd</span><span class="op" id="1632918">.</span><span class="ident" id="1632919">wt</span><span class="op" id="1632921">.</span><span class="ident" id="1632922">when</span>&nbsp;<span class="op" id="1632927">=</span>&nbsp;<span class="ident" id="1632929">pd</span><span class="op" id="1632931">.</span><span class="ident" id="1632932">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632938">pd</span><span class="op" id="1632940">.</span><span class="ident" id="1632941">wt</span><span class="op" id="1632943">.</span><span class="ident" id="1632944">arg</span>&nbsp;<span class="op" id="1632948">=</span>&nbsp;<span class="ident" id="1632950">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632956">pd</span><span class="op" id="1632958">.</span><span class="ident" id="1632959">wt</span><span class="op" id="1632961">.</span><span class="ident" id="1632962">seq</span>&nbsp;<span class="op" id="1632966">=</span>&nbsp;<span class="ident" id="1632968">pd</span><span class="op" id="1632970">.</span><span class="ident" id="1632971">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632978">addtimer</span><span class="op" id="1632986">(</span><span class="op" id="1632987">&amp;</span><span class="ident" id="1632988">pd</span><span class="op" id="1632990">.</span><span class="ident" id="1632991">wt</span><span class="op" id="1632993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633000">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633003">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633084">var</span>&nbsp;<span class="ident" id="1633088">rg</span><span class="op" id="1633090">,</span>&nbsp;<span class="ident" id="1633092">wg</span>&nbsp;<span class="op" id="1633095">*</span><span class="ident" id="1633096">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633099">atomicstorep</span><span class="op" id="1633111">(</span><span class="ident" id="1633112">unsafe</span><span class="op" id="1633118">.</span><span class="ident" id="1633119">Pointer</span><span class="op" id="1633126">(</span><span class="op" id="1633127">&amp;</span><span class="ident" id="1633128">wg</span><span class="op" id="1633130">)</span><span class="op" id="1633131">,</span>&nbsp;<span class="ident" id="1633133">nil</span><span class="op" id="1633136">)</span>&nbsp;<span class="comment" id="1633138">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633222">if</span>&nbsp;<span class="ident" id="1633225">pd</span><span class="op" id="1633227">.</span><span class="ident" id="1633228">rd</span>&nbsp;<span class="op" id="1633231">&lt;</span>&nbsp;<span class="num" id="1633233">0</span>&nbsp;<span class="op" id="1633235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633239">rg</span>&nbsp;<span class="op" id="1633242">=</span>&nbsp;<span class="ident" id="1633244">netpollunblock</span><span class="op" id="1633258">(</span><span class="ident" id="1633259">pd</span><span class="op" id="1633261">,</span>&nbsp;<span class="string" id="1633263">&#39;r&#39;</span><span class="op" id="1633266">,</span>&nbsp;<span class="builtintype" id="1633268">false</span><span class="op" id="1633273">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633279">if</span>&nbsp;<span class="ident" id="1633282">pd</span><span class="op" id="1633284">.</span><span class="ident" id="1633285">wd</span>&nbsp;<span class="op" id="1633288">&lt;</span>&nbsp;<span class="num" id="1633290">0</span>&nbsp;<span class="op" id="1633292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633296">wg</span>&nbsp;<span class="op" id="1633299">=</span>&nbsp;<span class="ident" id="1633301">netpollunblock</span><span class="op" id="1633315">(</span><span class="ident" id="1633316">pd</span><span class="op" id="1633318">,</span>&nbsp;<span class="string" id="1633320">&#39;w&#39;</span><span class="op" id="1633323">,</span>&nbsp;<span class="builtintype" id="1633325">false</span><span class="op" id="1633330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633336">unlock</span><span class="op" id="1633342">(</span><span class="op" id="1633343">&amp;</span><span class="ident" id="1633344">pd</span><span class="op" id="1633346">.</span><span class="ident" id="1633347">lock</span><span class="op" id="1633351">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633354">if</span>&nbsp;<span class="ident" id="1633357">rg</span>&nbsp;<span class="op" id="1633360">!=</span>&nbsp;<span class="ident" id="1633363">nil</span>&nbsp;<span class="op" id="1633367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633371">goready</span><span class="op" id="1633378">(</span><span class="ident" id="1633379">rg</span><span class="op" id="1633381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633387">if</span>&nbsp;<span class="ident" id="1633390">wg</span>&nbsp;<span class="op" id="1633393">!=</span>&nbsp;<span class="ident" id="1633396">nil</span>&nbsp;<span class="op" id="1633400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633404">goready</span><span class="op" id="1633411">(</span><span class="ident" id="1633412">wg</span><span class="op" id="1633414">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633417">}</span><br>
<span class="lineno"></span><span class="op" id="1633419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1633422">func</span>&nbsp;<span class="ident" id="1633427">netpollUnblock</span><span class="op" id="1633441">(</span><span class="ident" id="1633442">pd</span>&nbsp;<span class="op" id="1633445">*</span><span class="ident" id="1633446">pollDesc</span><span class="op" id="1633454">)</span>&nbsp;<span class="op" id="1633456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633459">lock</span><span class="op" id="1633463">(</span><span class="op" id="1633464">&amp;</span><span class="ident" id="1633465">pd</span><span class="op" id="1633467">.</span><span class="ident" id="1633468">lock</span><span class="op" id="1633472">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633475">if</span>&nbsp;<span class="ident" id="1633478">pd</span><span class="op" id="1633480">.</span><span class="ident" id="1633481">closing</span>&nbsp;<span class="op" id="1633489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633493">gothrow</span><span class="op" id="1633500">(</span><span class="string" id="1633501">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1633534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633540">pd</span><span class="op" id="1633542">.</span><span class="ident" id="1633543">closing</span>&nbsp;<span class="op" id="1633551">=</span>&nbsp;<span class="builtintype" id="1633553">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633559">pd</span><span class="op" id="1633561">.</span><span class="ident" id="1633562">seq</span><span class="op" id="1633565">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633569">var</span>&nbsp;<span class="ident" id="1633573">rg</span><span class="op" id="1633575">,</span>&nbsp;<span class="ident" id="1633577">wg</span>&nbsp;<span class="op" id="1633580">*</span><span class="ident" id="1633581">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633584">atomicstorep</span><span class="op" id="1633596">(</span><span class="ident" id="1633597">unsafe</span><span class="op" id="1633603">.</span><span class="ident" id="1633604">Pointer</span><span class="op" id="1633611">(</span><span class="op" id="1633612">&amp;</span><span class="ident" id="1633613">rg</span><span class="op" id="1633615">)</span><span class="op" id="1633616">,</span>&nbsp;<span class="ident" id="1633618">nil</span><span class="op" id="1633621">)</span>&nbsp;<span class="comment" id="1633623">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633708">rg</span>&nbsp;<span class="op" id="1633711">=</span>&nbsp;<span class="ident" id="1633713">netpollunblock</span><span class="op" id="1633727">(</span><span class="ident" id="1633728">pd</span><span class="op" id="1633730">,</span>&nbsp;<span class="string" id="1633732">&#39;r&#39;</span><span class="op" id="1633735">,</span>&nbsp;<span class="builtintype" id="1633737">false</span><span class="op" id="1633742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633745">wg</span>&nbsp;<span class="op" id="1633748">=</span>&nbsp;<span class="ident" id="1633750">netpollunblock</span><span class="op" id="1633764">(</span><span class="ident" id="1633765">pd</span><span class="op" id="1633767">,</span>&nbsp;<span class="string" id="1633769">&#39;w&#39;</span><span class="op" id="1633772">,</span>&nbsp;<span class="builtintype" id="1633774">false</span><span class="op" id="1633779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633782">if</span>&nbsp;<span class="ident" id="1633785">pd</span><span class="op" id="1633787">.</span><span class="ident" id="1633788">rt</span><span class="op" id="1633790">.</span><span class="ident" id="1633791">f</span>&nbsp;<span class="op" id="1633793">!=</span>&nbsp;<span class="ident" id="1633796">nil</span>&nbsp;<span class="op" id="1633800">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633804">deltimer</span><span class="op" id="1633812">(</span><span class="op" id="1633813">&amp;</span><span class="ident" id="1633814">pd</span><span class="op" id="1633816">.</span><span class="ident" id="1633817">rt</span><span class="op" id="1633819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633823">pd</span><span class="op" id="1633825">.</span><span class="ident" id="1633826">rt</span><span class="op" id="1633828">.</span><span class="ident" id="1633829">f</span>&nbsp;<span class="op" id="1633831">=</span>&nbsp;<span class="ident" id="1633833">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633841">if</span>&nbsp;<span class="ident" id="1633844">pd</span><span class="op" id="1633846">.</span><span class="ident" id="1633847">wt</span><span class="op" id="1633849">.</span><span class="ident" id="1633850">f</span>&nbsp;<span class="op" id="1633852">!=</span>&nbsp;<span class="ident" id="1633855">nil</span>&nbsp;<span class="op" id="1633859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633863">deltimer</span><span class="op" id="1633871">(</span><span class="op" id="1633872">&amp;</span><span class="ident" id="1633873">pd</span><span class="op" id="1633875">.</span><span class="ident" id="1633876">wt</span><span class="op" id="1633878">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633882">pd</span><span class="op" id="1633884">.</span><span class="ident" id="1633885">wt</span><span class="op" id="1633887">.</span><span class="ident" id="1633888">f</span>&nbsp;<span class="op" id="1633890">=</span>&nbsp;<span class="ident" id="1633892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633900">unlock</span><span class="op" id="1633906">(</span><span class="op" id="1633907">&amp;</span><span class="ident" id="1633908">pd</span><span class="op" id="1633910">.</span><span class="ident" id="1633911">lock</span><span class="op" id="1633915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633918">if</span>&nbsp;<span class="ident" id="1633921">rg</span>&nbsp;<span class="op" id="1633924">!=</span>&nbsp;<span class="ident" id="1633927">nil</span>&nbsp;<span class="op" id="1633931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633935">goready</span><span class="op" id="1633942">(</span><span class="ident" id="1633943">rg</span><span class="op" id="1633945">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633951">if</span>&nbsp;<span class="ident" id="1633954">wg</span>&nbsp;<span class="op" id="1633957">!=</span>&nbsp;<span class="ident" id="1633960">nil</span>&nbsp;<span class="op" id="1633964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633968">goready</span><span class="op" id="1633975">(</span><span class="ident" id="1633976">wg</span><span class="op" id="1633978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633981">}</span><br>
<span class="lineno"></span><span class="op" id="1633983">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1633986">func</span>&nbsp;<span class="ident" id="1633991">netpollfd</span><span class="op" id="1634000">(</span><span class="ident" id="1634001">pd</span>&nbsp;<span class="op" id="1634004">*</span><span class="ident" id="1634005">pollDesc</span><span class="op" id="1634013">)</span>&nbsp;<span class="builtintype" id="1634015">uintptr</span>&nbsp;<span class="op" id="1634023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634026">return</span>&nbsp;<span class="ident" id="1634033">pd</span><span class="op" id="1634035">.</span><span class="ident" id="1634036">fd</span><br>
<span class="lineno"></span><span class="op" id="1634039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1634042">func</span>&nbsp;<span class="ident" id="1634047">netpolluser</span><span class="op" id="1634058">(</span><span class="ident" id="1634059">pd</span>&nbsp;<span class="op" id="1634062">*</span><span class="ident" id="1634063">pollDesc</span><span class="op" id="1634071">)</span>&nbsp;<span class="op" id="1634073">*</span><span class="ident" id="1634074">unsafe</span><span class="op" id="1634080">.</span><span class="ident" id="1634081">Pointer</span>&nbsp;<span class="op" id="1634089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634092">return</span>&nbsp;<span class="op" id="1634099">&amp;</span><span class="ident" id="1634100">pd</span><span class="op" id="1634102">.</span><span class="ident" id="1634103">user</span><br>
<span class="lineno"></span><span class="op" id="1634108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1634111">func</span>&nbsp;<span class="ident" id="1634116">netpollclosing</span><span class="op" id="1634130">(</span><span class="ident" id="1634131">pd</span>&nbsp;<span class="op" id="1634134">*</span><span class="ident" id="1634135">pollDesc</span><span class="op" id="1634143">)</span>&nbsp;<span class="builtintype" id="1634145">bool</span>&nbsp;<span class="op" id="1634150">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634153">return</span>&nbsp;<span class="ident" id="1634160">pd</span><span class="op" id="1634162">.</span><span class="ident" id="1634163">closing</span><br>
<span class="lineno"></span><span class="op" id="1634171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1634174">func</span>&nbsp;<span class="ident" id="1634179">netpolllock</span><span class="op" id="1634190">(</span><span class="ident" id="1634191">pd</span>&nbsp;<span class="op" id="1634194">*</span><span class="ident" id="1634195">pollDesc</span><span class="op" id="1634203">)</span>&nbsp;<span class="op" id="1634205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634208">lock</span><span class="op" id="1634212">(</span><span class="op" id="1634213">&amp;</span><span class="ident" id="1634214">pd</span><span class="op" id="1634216">.</span><span class="ident" id="1634217">lock</span><span class="op" id="1634221">)</span><br>
<span class="lineno">280</span><span class="op" id="1634223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1634226">func</span>&nbsp;<span class="ident" id="1634231">netpollunlock</span><span class="op" id="1634244">(</span><span class="ident" id="1634245">pd</span>&nbsp;<span class="op" id="1634248">*</span><span class="ident" id="1634249">pollDesc</span><span class="op" id="1634257">)</span>&nbsp;<span class="op" id="1634259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634262">unlock</span><span class="op" id="1634268">(</span><span class="op" id="1634269">&amp;</span><span class="ident" id="1634270">pd</span><span class="op" id="1634272">.</span><span class="ident" id="1634273">lock</span><span class="op" id="1634277">)</span><br>
<span class="lineno"></span><span class="op" id="1634279">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1634282">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1634357">func</span>&nbsp;<span class="ident" id="1634362">netpollready</span><span class="op" id="1634374">(</span><span class="ident" id="1634375">gpp</span>&nbsp;<span class="op" id="1634379">*</span><span class="op" id="1634380">*</span><span class="ident" id="1634381">g</span><span class="op" id="1634382">,</span>&nbsp;<span class="ident" id="1634384">pd</span>&nbsp;<span class="op" id="1634387">*</span><span class="ident" id="1634388">pollDesc</span><span class="op" id="1634396">,</span>&nbsp;<span class="ident" id="1634398">mode</span>&nbsp;<span class="builtintype" id="1634403">int32</span><span class="op" id="1634408">)</span>&nbsp;<span class="op" id="1634410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634413">var</span>&nbsp;<span class="ident" id="1634417">rg</span><span class="op" id="1634419">,</span>&nbsp;<span class="ident" id="1634421">wg</span>&nbsp;<span class="op" id="1634424">*</span><span class="ident" id="1634425">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634428">if</span>&nbsp;<span class="ident" id="1634431">mode</span>&nbsp;<span class="op" id="1634436">==</span>&nbsp;<span class="string" id="1634439">&#39;r&#39;</span>&nbsp;<span class="op" id="1634443">||</span>&nbsp;<span class="ident" id="1634446">mode</span>&nbsp;<span class="op" id="1634451">==</span>&nbsp;<span class="string" id="1634454">&#39;r&#39;</span><span class="op" id="1634457">+</span><span class="string" id="1634458">&#39;w&#39;</span>&nbsp;<span class="op" id="1634462">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634466">rg</span>&nbsp;<span class="op" id="1634469">=</span>&nbsp;<span class="ident" id="1634471">netpollunblock</span><span class="op" id="1634485">(</span><span class="ident" id="1634486">pd</span><span class="op" id="1634488">,</span>&nbsp;<span class="string" id="1634490">&#39;r&#39;</span><span class="op" id="1634493">,</span>&nbsp;<span class="builtintype" id="1634495">true</span><span class="op" id="1634499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634505">if</span>&nbsp;<span class="ident" id="1634508">mode</span>&nbsp;<span class="op" id="1634513">==</span>&nbsp;<span class="string" id="1634516">&#39;w&#39;</span>&nbsp;<span class="op" id="1634520">||</span>&nbsp;<span class="ident" id="1634523">mode</span>&nbsp;<span class="op" id="1634528">==</span>&nbsp;<span class="string" id="1634531">&#39;r&#39;</span><span class="op" id="1634534">+</span><span class="string" id="1634535">&#39;w&#39;</span>&nbsp;<span class="op" id="1634539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634543">wg</span>&nbsp;<span class="op" id="1634546">=</span>&nbsp;<span class="ident" id="1634548">netpollunblock</span><span class="op" id="1634562">(</span><span class="ident" id="1634563">pd</span><span class="op" id="1634565">,</span>&nbsp;<span class="string" id="1634567">&#39;w&#39;</span><span class="op" id="1634570">,</span>&nbsp;<span class="builtintype" id="1634572">true</span><span class="op" id="1634576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634579">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634582">if</span>&nbsp;<span class="ident" id="1634585">rg</span>&nbsp;<span class="op" id="1634588">!=</span>&nbsp;<span class="ident" id="1634591">nil</span>&nbsp;<span class="op" id="1634595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634599">rg</span><span class="op" id="1634601">.</span><span class="ident" id="1634602">schedlink</span>&nbsp;<span class="op" id="1634612">=</span>&nbsp;<span class="op" id="1634614">*</span><span class="ident" id="1634615">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634621">*</span><span class="ident" id="1634622">gpp</span>&nbsp;<span class="op" id="1634626">=</span>&nbsp;<span class="ident" id="1634628">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634635">if</span>&nbsp;<span class="ident" id="1634638">wg</span>&nbsp;<span class="op" id="1634641">!=</span>&nbsp;<span class="ident" id="1634644">nil</span>&nbsp;<span class="op" id="1634648">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634652">wg</span><span class="op" id="1634654">.</span><span class="ident" id="1634655">schedlink</span>&nbsp;<span class="op" id="1634665">=</span>&nbsp;<span class="op" id="1634667">*</span><span class="ident" id="1634668">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634674">*</span><span class="ident" id="1634675">gpp</span>&nbsp;<span class="op" id="1634679">=</span>&nbsp;<span class="ident" id="1634681">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634685">}</span><br>
<span class="lineno"></span><span class="op" id="1634687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1634690">func</span>&nbsp;<span class="ident" id="1634695">netpollcheckerr</span><span class="op" id="1634710">(</span><span class="ident" id="1634711">pd</span>&nbsp;<span class="op" id="1634714">*</span><span class="ident" id="1634715">pollDesc</span><span class="op" id="1634723">,</span>&nbsp;<span class="ident" id="1634725">mode</span>&nbsp;<span class="builtintype" id="1634730">int32</span><span class="op" id="1634735">)</span>&nbsp;<span class="builtintype" id="1634737">int</span>&nbsp;<span class="op" id="1634741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634744">if</span>&nbsp;<span class="ident" id="1634747">pd</span><span class="op" id="1634749">.</span><span class="ident" id="1634750">closing</span>&nbsp;<span class="op" id="1634758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634762">return</span>&nbsp;<span class="num" id="1634769">1</span>&nbsp;<span class="comment" id="1634771">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634789">if</span>&nbsp;<span class="op" id="1634792">(</span><span class="ident" id="1634793">mode</span>&nbsp;<span class="op" id="1634798">==</span>&nbsp;<span class="string" id="1634801">&#39;r&#39;</span>&nbsp;<span class="op" id="1634805">&amp;&amp;</span>&nbsp;<span class="ident" id="1634808">pd</span><span class="op" id="1634810">.</span><span class="ident" id="1634811">rd</span>&nbsp;<span class="op" id="1634814">&lt;</span>&nbsp;<span class="num" id="1634816">0</span><span class="op" id="1634817">)</span>&nbsp;<span class="op" id="1634819">||</span>&nbsp;<span class="op" id="1634822">(</span><span class="ident" id="1634823">mode</span>&nbsp;<span class="op" id="1634828">==</span>&nbsp;<span class="string" id="1634831">&#39;w&#39;</span>&nbsp;<span class="op" id="1634835">&amp;&amp;</span>&nbsp;<span class="ident" id="1634838">pd</span><span class="op" id="1634840">.</span><span class="ident" id="1634841">wd</span>&nbsp;<span class="op" id="1634844">&lt;</span>&nbsp;<span class="num" id="1634846">0</span><span class="op" id="1634847">)</span>&nbsp;<span class="op" id="1634849">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634853">return</span>&nbsp;<span class="num" id="1634860">2</span>&nbsp;<span class="comment" id="1634862">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634880">return</span>&nbsp;<span class="num" id="1634887">0</span><br>
<span class="lineno"></span><span class="op" id="1634889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1634892">func</span>&nbsp;<span class="ident" id="1634897">netpollblockcommit</span><span class="op" id="1634915">(</span><span class="ident" id="1634916">gp</span>&nbsp;<span class="op" id="1634919">*</span><span class="ident" id="1634920">g</span><span class="op" id="1634921">,</span>&nbsp;<span class="ident" id="1634923">gpp</span>&nbsp;<span class="ident" id="1634927">unsafe</span><span class="op" id="1634933">.</span><span class="ident" id="1634934">Pointer</span><span class="op" id="1634941">)</span>&nbsp;<span class="builtintype" id="1634943">bool</span>&nbsp;<span class="op" id="1634948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634951">return</span>&nbsp;<span class="ident" id="1634958">casuintptr</span><span class="op" id="1634968">(</span><span class="op" id="1634969">(</span><span class="op" id="1634970">*</span><span class="builtintype" id="1634971">uintptr</span><span class="op" id="1634978">)</span><span class="op" id="1634979">(</span><span class="ident" id="1634980">gpp</span><span class="op" id="1634983">)</span><span class="op" id="1634984">,</span>&nbsp;<span class="ident" id="1634986">pdWait</span><span class="op" id="1634992">,</span>&nbsp;<span class="builtintype" id="1634994">uintptr</span><span class="op" id="1635001">(</span><span class="ident" id="1635002">unsafe</span><span class="op" id="1635008">.</span><span class="ident" id="1635009">Pointer</span><span class="op" id="1635016">(</span><span class="ident" id="1635017">gp</span><span class="op" id="1635019">)</span><span class="op" id="1635020">)</span><span class="op" id="1635021">)</span><br>
<span class="lineno"></span><span class="op" id="1635023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1635026">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1635089">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1635143">func</span>&nbsp;<span class="ident" id="1635148">netpollblock</span><span class="op" id="1635160">(</span><span class="ident" id="1635161">pd</span>&nbsp;<span class="op" id="1635164">*</span><span class="ident" id="1635165">pollDesc</span><span class="op" id="1635173">,</span>&nbsp;<span class="ident" id="1635175">mode</span>&nbsp;<span class="builtintype" id="1635180">int32</span><span class="op" id="1635185">,</span>&nbsp;<span class="ident" id="1635187">waitio</span>&nbsp;<span class="builtintype" id="1635194">bool</span><span class="op" id="1635198">)</span>&nbsp;<span class="builtintype" id="1635200">bool</span>&nbsp;<span class="op" id="1635205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635208">gpp</span>&nbsp;<span class="op" id="1635212">:=</span>&nbsp;<span class="op" id="1635215">&amp;</span><span class="ident" id="1635216">pd</span><span class="op" id="1635218">.</span><span class="ident" id="1635219">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635223">if</span>&nbsp;<span class="ident" id="1635226">mode</span>&nbsp;<span class="op" id="1635231">==</span>&nbsp;<span class="string" id="1635234">&#39;w&#39;</span>&nbsp;<span class="op" id="1635238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635242">gpp</span>&nbsp;<span class="op" id="1635246">=</span>&nbsp;<span class="op" id="1635248">&amp;</span><span class="ident" id="1635249">pd</span><span class="op" id="1635251">.</span><span class="ident" id="1635252">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635260">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635294">for</span>&nbsp;<span class="op" id="1635298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635302">old</span>&nbsp;<span class="op" id="1635306">:=</span>&nbsp;<span class="op" id="1635309">*</span><span class="ident" id="1635310">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635316">if</span>&nbsp;<span class="ident" id="1635319">old</span>&nbsp;<span class="op" id="1635323">==</span>&nbsp;<span class="ident" id="1635326">pdReady</span>&nbsp;<span class="op" id="1635334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635339">*</span><span class="ident" id="1635340">gpp</span>&nbsp;<span class="op" id="1635344">=</span>&nbsp;<span class="num" id="1635346">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635351">return</span>&nbsp;<span class="builtintype" id="1635358">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635369">if</span>&nbsp;<span class="ident" id="1635372">old</span>&nbsp;<span class="op" id="1635376">!=</span>&nbsp;<span class="num" id="1635379">0</span>&nbsp;<span class="op" id="1635381">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635386">gothrow</span><span class="op" id="1635393">(</span><span class="string" id="1635394">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1635421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635429">if</span>&nbsp;<span class="ident" id="1635432">casuintptr</span><span class="op" id="1635442">(</span><span class="ident" id="1635443">gpp</span><span class="op" id="1635446">,</span>&nbsp;<span class="num" id="1635448">0</span><span class="op" id="1635449">,</span>&nbsp;<span class="ident" id="1635451">pdWait</span><span class="op" id="1635457">)</span>&nbsp;<span class="op" id="1635459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635464">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635472">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635479">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635538">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635625">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635696">if</span>&nbsp;<span class="ident" id="1635699">waitio</span>&nbsp;<span class="op" id="1635706">||</span>&nbsp;<span class="ident" id="1635709">netpollcheckerr</span><span class="op" id="1635724">(</span><span class="ident" id="1635725">pd</span><span class="op" id="1635727">,</span>&nbsp;<span class="ident" id="1635729">mode</span><span class="op" id="1635733">)</span>&nbsp;<span class="op" id="1635735">==</span>&nbsp;<span class="num" id="1635738">0</span>&nbsp;<span class="op" id="1635740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635744">f</span>&nbsp;<span class="op" id="1635746">:=</span>&nbsp;<span class="ident" id="1635749">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635770">gopark</span><span class="op" id="1635776">(</span><span class="op" id="1635777">*</span><span class="op" id="1635778">*</span><span class="op" id="1635779">(</span><span class="op" id="1635780">*</span><span class="op" id="1635781">*</span><span class="ident" id="1635782">unsafe</span><span class="op" id="1635788">.</span><span class="ident" id="1635789">Pointer</span><span class="op" id="1635796">)</span><span class="op" id="1635797">(</span><span class="ident" id="1635798">unsafe</span><span class="op" id="1635804">.</span><span class="ident" id="1635805">Pointer</span><span class="op" id="1635812">(</span><span class="op" id="1635813">&amp;</span><span class="ident" id="1635814">f</span><span class="op" id="1635815">)</span><span class="op" id="1635816">)</span><span class="op" id="1635817">,</span>&nbsp;<span class="ident" id="1635819">unsafe</span><span class="op" id="1635825">.</span><span class="ident" id="1635826">Pointer</span><span class="op" id="1635833">(</span><span class="ident" id="1635834">gpp</span><span class="op" id="1635837">)</span><span class="op" id="1635838">,</span>&nbsp;<span class="string" id="1635840">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1635849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635855">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635912">old</span>&nbsp;<span class="op" id="1635916">:=</span>&nbsp;<span class="ident" id="1635919">xchguintptr</span><span class="op" id="1635930">(</span><span class="ident" id="1635931">gpp</span><span class="op" id="1635934">,</span>&nbsp;<span class="num" id="1635936">0</span><span class="op" id="1635937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635940">if</span>&nbsp;<span class="ident" id="1635943">old</span>&nbsp;<span class="op" id="1635947">&gt;</span>&nbsp;<span class="ident" id="1635949">pdWait</span>&nbsp;<span class="op" id="1635956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635960">gothrow</span><span class="op" id="1635967">(</span><span class="string" id="1635968">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1635999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636005">return</span>&nbsp;<span class="ident" id="1636012">old</span>&nbsp;<span class="op" id="1636016">==</span>&nbsp;<span class="ident" id="1636019">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1636027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636030">func</span>&nbsp;<span class="ident" id="1636035">netpollunblock</span><span class="op" id="1636049">(</span><span class="ident" id="1636050">pd</span>&nbsp;<span class="op" id="1636053">*</span><span class="ident" id="1636054">pollDesc</span><span class="op" id="1636062">,</span>&nbsp;<span class="ident" id="1636064">mode</span>&nbsp;<span class="builtintype" id="1636069">int32</span><span class="op" id="1636074">,</span>&nbsp;<span class="ident" id="1636076">ioready</span>&nbsp;<span class="builtintype" id="1636084">bool</span><span class="op" id="1636088">)</span>&nbsp;<span class="op" id="1636090">*</span><span class="ident" id="1636091">g</span>&nbsp;<span class="op" id="1636093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636096">gpp</span>&nbsp;<span class="op" id="1636100">:=</span>&nbsp;<span class="op" id="1636103">&amp;</span><span class="ident" id="1636104">pd</span><span class="op" id="1636106">.</span><span class="ident" id="1636107">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636111">if</span>&nbsp;<span class="ident" id="1636114">mode</span>&nbsp;<span class="op" id="1636119">==</span>&nbsp;<span class="string" id="1636122">&#39;w&#39;</span>&nbsp;<span class="op" id="1636126">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636130">gpp</span>&nbsp;<span class="op" id="1636134">=</span>&nbsp;<span class="op" id="1636136">&amp;</span><span class="ident" id="1636137">pd</span><span class="op" id="1636139">.</span><span class="ident" id="1636140">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636148">for</span>&nbsp;<span class="op" id="1636152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636156">old</span>&nbsp;<span class="op" id="1636160">:=</span>&nbsp;<span class="op" id="1636163">*</span><span class="ident" id="1636164">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636170">if</span>&nbsp;<span class="ident" id="1636173">old</span>&nbsp;<span class="op" id="1636177">==</span>&nbsp;<span class="ident" id="1636180">pdReady</span>&nbsp;<span class="op" id="1636188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636193">return</span>&nbsp;<span class="ident" id="1636200">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636210">if</span>&nbsp;<span class="ident" id="1636213">old</span>&nbsp;<span class="op" id="1636217">==</span>&nbsp;<span class="num" id="1636220">0</span>&nbsp;<span class="op" id="1636222">&amp;&amp;</span>&nbsp;<span class="op" id="1636225">!</span><span class="ident" id="1636226">ioready</span>&nbsp;<span class="op" id="1636234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636239">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636290">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636342">return</span>&nbsp;<span class="ident" id="1636349">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636359">var</span>&nbsp;<span class="builtinfunc" id="1636363">new</span>&nbsp;<span class="builtintype" id="1636367">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636377">if</span>&nbsp;<span class="ident" id="1636380">ioready</span>&nbsp;<span class="op" id="1636388">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1636393">new</span>&nbsp;<span class="op" id="1636397">=</span>&nbsp;<span class="ident" id="1636399">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636413">if</span>&nbsp;<span class="ident" id="1636416">casuintptr</span><span class="op" id="1636426">(</span><span class="ident" id="1636427">gpp</span><span class="op" id="1636430">,</span>&nbsp;<span class="ident" id="1636432">old</span><span class="op" id="1636435">,</span>&nbsp;<span class="builtinfunc" id="1636437">new</span><span class="op" id="1636440">)</span>&nbsp;<span class="op" id="1636442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636447">if</span>&nbsp;<span class="ident" id="1636450">old</span>&nbsp;<span class="op" id="1636454">==</span>&nbsp;<span class="ident" id="1636457">pdReady</span>&nbsp;<span class="op" id="1636465">||</span>&nbsp;<span class="ident" id="1636468">old</span>&nbsp;<span class="op" id="1636472">==</span>&nbsp;<span class="ident" id="1636475">pdWait</span>&nbsp;<span class="op" id="1636482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636488">old</span>&nbsp;<span class="op" id="1636492">=</span>&nbsp;<span class="num" id="1636494">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636504">return</span>&nbsp;<span class="op" id="1636511">(</span><span class="op" id="1636512">*</span><span class="ident" id="1636513">g</span><span class="op" id="1636514">)</span><span class="op" id="1636515">(</span><span class="ident" id="1636516">unsafe</span><span class="op" id="1636522">.</span><span class="ident" id="1636523">Pointer</span><span class="op" id="1636530">(</span><span class="ident" id="1636531">old</span><span class="op" id="1636534">)</span><span class="op" id="1636535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636542">}</span><br>
<span class="lineno"></span><span class="op" id="1636544">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1636547">func</span>&nbsp;<span class="ident" id="1636552">netpolldeadlineimpl</span><span class="op" id="1636571">(</span><span class="ident" id="1636572">pd</span>&nbsp;<span class="op" id="1636575">*</span><span class="ident" id="1636576">pollDesc</span><span class="op" id="1636584">,</span>&nbsp;<span class="ident" id="1636586">seq</span>&nbsp;<span class="builtintype" id="1636590">uintptr</span><span class="op" id="1636597">,</span>&nbsp;<span class="ident" id="1636599">read</span><span class="op" id="1636603">,</span>&nbsp;<span class="ident" id="1636605">write</span>&nbsp;<span class="builtintype" id="1636611">bool</span><span class="op" id="1636615">)</span>&nbsp;<span class="op" id="1636617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636620">lock</span><span class="op" id="1636624">(</span><span class="op" id="1636625">&amp;</span><span class="ident" id="1636626">pd</span><span class="op" id="1636628">.</span><span class="ident" id="1636629">lock</span><span class="op" id="1636633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636636">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636679">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636722">if</span>&nbsp;<span class="ident" id="1636725">seq</span>&nbsp;<span class="op" id="1636729">!=</span>&nbsp;<span class="ident" id="1636732">pd</span><span class="op" id="1636734">.</span><span class="ident" id="1636735">seq</span>&nbsp;<span class="op" id="1636739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636743">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636796">unlock</span><span class="op" id="1636802">(</span><span class="op" id="1636803">&amp;</span><span class="ident" id="1636804">pd</span><span class="op" id="1636806">.</span><span class="ident" id="1636807">lock</span><span class="op" id="1636811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636815">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636823">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636826">var</span>&nbsp;<span class="ident" id="1636830">rg</span>&nbsp;<span class="op" id="1636833">*</span><span class="ident" id="1636834">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636837">if</span>&nbsp;<span class="ident" id="1636840">read</span>&nbsp;<span class="op" id="1636845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636849">if</span>&nbsp;<span class="ident" id="1636852">pd</span><span class="op" id="1636854">.</span><span class="ident" id="1636855">rd</span>&nbsp;<span class="op" id="1636858">&lt;=</span>&nbsp;<span class="num" id="1636861">0</span>&nbsp;<span class="op" id="1636863">||</span>&nbsp;<span class="ident" id="1636866">pd</span><span class="op" id="1636868">.</span><span class="ident" id="1636869">rt</span><span class="op" id="1636871">.</span><span class="ident" id="1636872">f</span>&nbsp;<span class="op" id="1636874">==</span>&nbsp;<span class="ident" id="1636877">nil</span>&nbsp;<span class="op" id="1636881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636886">gothrow</span><span class="op" id="1636893">(</span><span class="string" id="1636894">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1636943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1636947">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636951">pd</span><span class="op" id="1636953">.</span><span class="ident" id="1636954">rd</span>&nbsp;<span class="op" id="1636957">=</span>&nbsp;<span class="op" id="1636959">-</span><span class="num" id="1636960">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636964">atomicstorep</span><span class="op" id="1636976">(</span><span class="ident" id="1636977">unsafe</span><span class="op" id="1636983">.</span><span class="ident" id="1636984">Pointer</span><span class="op" id="1636991">(</span><span class="op" id="1636992">&amp;</span><span class="ident" id="1636993">pd</span><span class="op" id="1636995">.</span><span class="ident" id="1636996">rt</span><span class="op" id="1636998">.</span><span class="ident" id="1636999">f</span><span class="op" id="1637000">)</span><span class="op" id="1637001">,</span>&nbsp;<span class="ident" id="1637003">nil</span><span class="op" id="1637006">)</span>&nbsp;<span class="comment" id="1637008">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637086">rg</span>&nbsp;<span class="op" id="1637089">=</span>&nbsp;<span class="ident" id="1637091">netpollunblock</span><span class="op" id="1637105">(</span><span class="ident" id="1637106">pd</span><span class="op" id="1637108">,</span>&nbsp;<span class="string" id="1637110">&#39;r&#39;</span><span class="op" id="1637113">,</span>&nbsp;<span class="builtintype" id="1637115">false</span><span class="op" id="1637120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637126">var</span>&nbsp;<span class="ident" id="1637130">wg</span>&nbsp;<span class="op" id="1637133">*</span><span class="ident" id="1637134">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637137">if</span>&nbsp;<span class="ident" id="1637140">write</span>&nbsp;<span class="op" id="1637146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637150">if</span>&nbsp;<span class="ident" id="1637153">pd</span><span class="op" id="1637155">.</span><span class="ident" id="1637156">wd</span>&nbsp;<span class="op" id="1637159">&lt;=</span>&nbsp;<span class="num" id="1637162">0</span>&nbsp;<span class="op" id="1637164">||</span>&nbsp;<span class="ident" id="1637167">pd</span><span class="op" id="1637169">.</span><span class="ident" id="1637170">wt</span><span class="op" id="1637172">.</span><span class="ident" id="1637173">f</span>&nbsp;<span class="op" id="1637175">==</span>&nbsp;<span class="ident" id="1637178">nil</span>&nbsp;<span class="op" id="1637182">&amp;&amp;</span>&nbsp;<span class="op" id="1637185">!</span><span class="ident" id="1637186">read</span>&nbsp;<span class="op" id="1637191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637196">gothrow</span><span class="op" id="1637203">(</span><span class="string" id="1637204">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1637254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637262">pd</span><span class="op" id="1637264">.</span><span class="ident" id="1637265">wd</span>&nbsp;<span class="op" id="1637268">=</span>&nbsp;<span class="op" id="1637270">-</span><span class="num" id="1637271">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637275">atomicstorep</span><span class="op" id="1637287">(</span><span class="ident" id="1637288">unsafe</span><span class="op" id="1637294">.</span><span class="ident" id="1637295">Pointer</span><span class="op" id="1637302">(</span><span class="op" id="1637303">&amp;</span><span class="ident" id="1637304">pd</span><span class="op" id="1637306">.</span><span class="ident" id="1637307">wt</span><span class="op" id="1637309">.</span><span class="ident" id="1637310">f</span><span class="op" id="1637311">)</span><span class="op" id="1637312">,</span>&nbsp;<span class="ident" id="1637314">nil</span><span class="op" id="1637317">)</span>&nbsp;<span class="comment" id="1637319">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637397">wg</span>&nbsp;<span class="op" id="1637400">=</span>&nbsp;<span class="ident" id="1637402">netpollunblock</span><span class="op" id="1637416">(</span><span class="ident" id="1637417">pd</span><span class="op" id="1637419">,</span>&nbsp;<span class="string" id="1637421">&#39;w&#39;</span><span class="op" id="1637424">,</span>&nbsp;<span class="builtintype" id="1637426">false</span><span class="op" id="1637431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637437">unlock</span><span class="op" id="1637443">(</span><span class="op" id="1637444">&amp;</span><span class="ident" id="1637445">pd</span><span class="op" id="1637447">.</span><span class="ident" id="1637448">lock</span><span class="op" id="1637452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637455">if</span>&nbsp;<span class="ident" id="1637458">rg</span>&nbsp;<span class="op" id="1637461">!=</span>&nbsp;<span class="ident" id="1637464">nil</span>&nbsp;<span class="op" id="1637468">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637472">goready</span><span class="op" id="1637479">(</span><span class="ident" id="1637480">rg</span><span class="op" id="1637482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637488">if</span>&nbsp;<span class="ident" id="1637491">wg</span>&nbsp;<span class="op" id="1637494">!=</span>&nbsp;<span class="ident" id="1637497">nil</span>&nbsp;<span class="op" id="1637501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637505">goready</span><span class="op" id="1637512">(</span><span class="ident" id="1637513">wg</span><span class="op" id="1637515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637518">}</span><br>
<span class="lineno">420</span><span class="op" id="1637520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1637523">func</span>&nbsp;<span class="ident" id="1637528">netpollDeadline</span><span class="op" id="1637543">(</span><span class="ident" id="1637544">arg</span>&nbsp;<span class="keyword" id="1637548">interface</span><span class="op" id="1637557">{</span><span class="op" id="1637558">}</span><span class="op" id="1637559">,</span>&nbsp;<span class="ident" id="1637561">seq</span>&nbsp;<span class="builtintype" id="1637565">uintptr</span><span class="op" id="1637572">)</span>&nbsp;<span class="op" id="1637574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637577">netpolldeadlineimpl</span><span class="op" id="1637596">(</span><span class="ident" id="1637597">arg</span><span class="op" id="1637600">.</span><span class="op" id="1637601">(</span><span class="op" id="1637602">*</span><span class="ident" id="1637603">pollDesc</span><span class="op" id="1637611">)</span><span class="op" id="1637612">,</span>&nbsp;<span class="ident" id="1637614">seq</span><span class="op" id="1637617">,</span>&nbsp;<span class="builtintype" id="1637619">true</span><span class="op" id="1637623">,</span>&nbsp;<span class="builtintype" id="1637625">true</span><span class="op" id="1637629">)</span><br>
<span class="lineno"></span><span class="op" id="1637631">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1637634">func</span>&nbsp;<span class="ident" id="1637639">netpollReadDeadline</span><span class="op" id="1637658">(</span><span class="ident" id="1637659">arg</span>&nbsp;<span class="keyword" id="1637663">interface</span><span class="op" id="1637672">{</span><span class="op" id="1637673">}</span><span class="op" id="1637674">,</span>&nbsp;<span class="ident" id="1637676">seq</span>&nbsp;<span class="builtintype" id="1637680">uintptr</span><span class="op" id="1637687">)</span>&nbsp;<span class="op" id="1637689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637692">netpolldeadlineimpl</span><span class="op" id="1637711">(</span><span class="ident" id="1637712">arg</span><span class="op" id="1637715">.</span><span class="op" id="1637716">(</span><span class="op" id="1637717">*</span><span class="ident" id="1637718">pollDesc</span><span class="op" id="1637726">)</span><span class="op" id="1637727">,</span>&nbsp;<span class="ident" id="1637729">seq</span><span class="op" id="1637732">,</span>&nbsp;<span class="builtintype" id="1637734">true</span><span class="op" id="1637738">,</span>&nbsp;<span class="builtintype" id="1637740">false</span><span class="op" id="1637745">)</span><br>
<span class="lineno"></span><span class="op" id="1637747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1637750">func</span>&nbsp;<span class="ident" id="1637755">netpollWriteDeadline</span><span class="op" id="1637775">(</span><span class="ident" id="1637776">arg</span>&nbsp;<span class="keyword" id="1637780">interface</span><span class="op" id="1637789">{</span><span class="op" id="1637790">}</span><span class="op" id="1637791">,</span>&nbsp;<span class="ident" id="1637793">seq</span>&nbsp;<span class="builtintype" id="1637797">uintptr</span><span class="op" id="1637804">)</span>&nbsp;<span class="op" id="1637806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637809">netpolldeadlineimpl</span><span class="op" id="1637828">(</span><span class="ident" id="1637829">arg</span><span class="op" id="1637832">.</span><span class="op" id="1637833">(</span><span class="op" id="1637834">*</span><span class="ident" id="1637835">pollDesc</span><span class="op" id="1637843">)</span><span class="op" id="1637844">,</span>&nbsp;<span class="ident" id="1637846">seq</span><span class="op" id="1637849">,</span>&nbsp;<span class="builtintype" id="1637851">false</span><span class="op" id="1637856">,</span>&nbsp;<span class="builtintype" id="1637858">true</span><span class="op" id="1637862">)</span><br>
<span class="lineno"></span><span class="op" id="1637864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1637867">func</span>&nbsp;<span class="op" id="1637872">(</span><span class="ident" id="1637873">c</span>&nbsp;<span class="op" id="1637875">*</span><span class="ident" id="1637876">pollCache</span><span class="op" id="1637885">)</span>&nbsp;<span class="ident" id="1637887">alloc</span><span class="op" id="1637892">(</span><span class="op" id="1637893">)</span>&nbsp;<span class="op" id="1637895">*</span><span class="ident" id="1637896">pollDesc</span>&nbsp;<span class="op" id="1637905">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637908">lock</span><span class="op" id="1637912">(</span><span class="op" id="1637913">&amp;</span><span class="ident" id="1637914">c</span><span class="op" id="1637915">.</span><span class="ident" id="1637916">lock</span><span class="op" id="1637920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637923">if</span>&nbsp;<span class="ident" id="1637926">c</span><span class="op" id="1637927">.</span><span class="ident" id="1637928">first</span>&nbsp;<span class="op" id="1637934">==</span>&nbsp;<span class="ident" id="1637937">nil</span>&nbsp;<span class="op" id="1637941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637945">const</span>&nbsp;<span class="ident" id="1637951">pdSize</span>&nbsp;<span class="op" id="1637958">=</span>&nbsp;<span class="ident" id="1637960">unsafe</span><span class="op" id="1637966">.</span><span class="ident" id="1637967">Sizeof</span><span class="op" id="1637973">(</span><span class="ident" id="1637974">pollDesc</span><span class="op" id="1637982">{</span><span class="op" id="1637983">}</span><span class="op" id="1637984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637988">n</span>&nbsp;<span class="op" id="1637990">:=</span>&nbsp;<span class="ident" id="1637993">pollBlockSize</span>&nbsp;<span class="op" id="1638007">/</span>&nbsp;<span class="ident" id="1638009">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638018">if</span>&nbsp;<span class="ident" id="1638021">n</span>&nbsp;<span class="op" id="1638023">==</span>&nbsp;<span class="num" id="1638026">0</span>&nbsp;<span class="op" id="1638028">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638033">n</span>&nbsp;<span class="op" id="1638035">=</span>&nbsp;<span class="num" id="1638037">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1638045">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1638101">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638140">mem</span>&nbsp;<span class="op" id="1638144">:=</span>&nbsp;<span class="ident" id="1638147">persistentalloc</span><span class="op" id="1638162">(</span><span class="ident" id="1638163">n</span><span class="op" id="1638164">*</span><span class="ident" id="1638165">pdSize</span><span class="op" id="1638171">,</span>&nbsp;<span class="num" id="1638173">0</span><span class="op" id="1638174">,</span>&nbsp;<span class="op" id="1638176">&amp;</span><span class="ident" id="1638177">memstats</span><span class="op" id="1638185">.</span><span class="ident" id="1638186">other_sys</span><span class="op" id="1638195">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638199">for</span>&nbsp;<span class="ident" id="1638203">i</span>&nbsp;<span class="op" id="1638205">:=</span>&nbsp;<span class="builtintype" id="1638208">uintptr</span><span class="op" id="1638215">(</span><span class="num" id="1638216">0</span><span class="op" id="1638217">)</span><span class="op" id="1638218">;</span>&nbsp;<span class="ident" id="1638220">i</span>&nbsp;<span class="op" id="1638222">&lt;</span>&nbsp;<span class="ident" id="1638224">n</span><span class="op" id="1638225">;</span>&nbsp;<span class="ident" id="1638227">i</span><span class="op" id="1638228">++</span>&nbsp;<span class="op" id="1638231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638236">pd</span>&nbsp;<span class="op" id="1638239">:=</span>&nbsp;<span class="op" id="1638242">(</span><span class="op" id="1638243">*</span><span class="ident" id="1638244">pollDesc</span><span class="op" id="1638252">)</span><span class="op" id="1638253">(</span><span class="ident" id="1638254">add</span><span class="op" id="1638257">(</span><span class="ident" id="1638258">mem</span><span class="op" id="1638261">,</span>&nbsp;<span class="ident" id="1638263">i</span><span class="op" id="1638264">*</span><span class="ident" id="1638265">pdSize</span><span class="op" id="1638271">)</span><span class="op" id="1638272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638277">pd</span><span class="op" id="1638279">.</span><span class="ident" id="1638280">link</span>&nbsp;<span class="op" id="1638285">=</span>&nbsp;<span class="ident" id="1638287">c</span><span class="op" id="1638288">.</span><span class="ident" id="1638289">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638298">c</span><span class="op" id="1638299">.</span><span class="ident" id="1638300">first</span>&nbsp;<span class="op" id="1638306">=</span>&nbsp;<span class="ident" id="1638308">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638313">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638319">pd</span>&nbsp;<span class="op" id="1638322">:=</span>&nbsp;<span class="ident" id="1638325">c</span><span class="op" id="1638326">.</span><span class="ident" id="1638327">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638334">c</span><span class="op" id="1638335">.</span><span class="ident" id="1638336">first</span>&nbsp;<span class="op" id="1638342">=</span>&nbsp;<span class="ident" id="1638344">pd</span><span class="op" id="1638346">.</span><span class="ident" id="1638347">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638353">unlock</span><span class="op" id="1638359">(</span><span class="op" id="1638360">&amp;</span><span class="ident" id="1638361">c</span><span class="op" id="1638362">.</span><span class="ident" id="1638363">lock</span><span class="op" id="1638367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638370">return</span>&nbsp;<span class="ident" id="1638377">pd</span><br>
<span class="lineno">455</span><span class="op" id="1638380">}</span>
</div>
</body>
</html>
