<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/ast</h2>
<ul>
<li><a href="/gostd/go/ast/ast.go.html">ast.go</a></li>
<li><a href="/gostd/go/ast/ast_test.go.html">ast_test.go</a></li>
<li><a href="/gostd/go/ast/commentmap.go.html">commentmap.go</a></li>
<li><a href="/gostd/go/ast/commentmap_test.go.html">commentmap_test.go</a></li>
<li><a href="/gostd/go/ast/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/ast/filter.go.html">filter.go</a></li>
<li><a href="/gostd/go/ast/filter_test.go.html">filter_test.go</a></li>
<li><a href="/gostd/go/ast/import.go.html">import.go</a></li>
<li><a href="/gostd/go/ast/print.go.html">print.go</a></li>
<li><a href="/gostd/go/ast/print_test.go.html">print_test.go</a></li>
<li><a href="/gostd/go/ast/resolve.go.html">resolve.go</a></li>
<li><a href="/gostd/go/ast/scope.go.html">scope.go</a></li>
<li><a href="/gostd/go/ast/walk.go.html">walk.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4719021">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4719076">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4719130">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4719181">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4719218">package</span>&nbsp;<span class="ident" id="4719226">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4719231">import</span>&nbsp;<span class="op" id="4719238">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4719241">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4719248">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4719262">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4719274">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="4719284">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4719287">type</span>&nbsp;<span class="ident" id="4719292">pkgBuilder</span>&nbsp;<span class="keyword" id="4719303">struct</span>&nbsp;<span class="op" id="4719310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719313">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4719320">*</span><span class="ident" id="4719321">token</span><span class="op" id="4719326">.</span><span class="ident" id="4719327">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719336">errors</span>&nbsp;<span class="ident" id="4719343">scanner</span><span class="op" id="4719350">.</span><span class="ident" id="4719351">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="4719361">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4719364">func</span>&nbsp;<span class="op" id="4719369">(</span><span class="ident" id="4719370">p</span>&nbsp;<span class="op" id="4719372">*</span><span class="ident" id="4719373">pkgBuilder</span><span class="op" id="4719383">)</span>&nbsp;<span class="builtintype" id="4719385">error</span><span class="op" id="4719390">(</span><span class="ident" id="4719391">pos</span>&nbsp;<span class="ident" id="4719395">token</span><span class="op" id="4719400">.</span><span class="ident" id="4719401">Pos</span><span class="op" id="4719404">,</span>&nbsp;<span class="ident" id="4719406">msg</span>&nbsp;<span class="builtintype" id="4719410">string</span><span class="op" id="4719416">)</span>&nbsp;<span class="op" id="4719418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719421">p</span><span class="op" id="4719422">.</span><span class="ident" id="4719423">errors</span><span class="op" id="4719429">.</span><span class="ident" id="4719430">Add</span><span class="op" id="4719433">(</span><span class="ident" id="4719434">p</span><span class="op" id="4719435">.</span><span class="ident" id="4719436">fset</span><span class="op" id="4719440">.</span><span class="ident" id="4719441">Position</span><span class="op" id="4719449">(</span><span class="ident" id="4719450">pos</span><span class="op" id="4719453">)</span><span class="op" id="4719454">,</span>&nbsp;<span class="ident" id="4719456">msg</span><span class="op" id="4719459">)</span><br>
<span class="lineno"></span><span class="op" id="4719461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="4719464">func</span>&nbsp;<span class="op" id="4719469">(</span><span class="ident" id="4719470">p</span>&nbsp;<span class="op" id="4719472">*</span><span class="ident" id="4719473">pkgBuilder</span><span class="op" id="4719483">)</span>&nbsp;<span class="ident" id="4719485">errorf</span><span class="op" id="4719491">(</span><span class="ident" id="4719492">pos</span>&nbsp;<span class="ident" id="4719496">token</span><span class="op" id="4719501">.</span><span class="ident" id="4719502">Pos</span><span class="op" id="4719505">,</span>&nbsp;<span class="ident" id="4719507">format</span>&nbsp;<span class="builtintype" id="4719514">string</span><span class="op" id="4719520">,</span>&nbsp;<span class="ident" id="4719522">args</span>&nbsp;<span class="op" id="4719527">...</span><span class="keyword" id="4719530">interface</span><span class="op" id="4719539">{</span><span class="op" id="4719540">}</span><span class="op" id="4719541">)</span>&nbsp;<span class="op" id="4719543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719546">p</span><span class="op" id="4719547">.</span><span class="builtintype" id="4719548">error</span><span class="op" id="4719553">(</span><span class="ident" id="4719554">pos</span><span class="op" id="4719557">,</span>&nbsp;<span class="ident" id="4719559">fmt</span><span class="op" id="4719562">.</span><span class="ident" id="4719563">Sprintf</span><span class="op" id="4719570">(</span><span class="ident" id="4719571">format</span><span class="op" id="4719577">,</span>&nbsp;<span class="ident" id="4719579">args</span><span class="op" id="4719583">...</span><span class="op" id="4719586">)</span><span class="op" id="4719587">)</span><br>
<span class="lineno"></span><span class="op" id="4719589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4719592">func</span>&nbsp;<span class="op" id="4719597">(</span><span class="ident" id="4719598">p</span>&nbsp;<span class="op" id="4719600">*</span><span class="ident" id="4719601">pkgBuilder</span><span class="op" id="4719611">)</span>&nbsp;<span class="ident" id="4719613">declare</span><span class="op" id="4719620">(</span><span class="ident" id="4719621">scope</span><span class="op" id="4719626">,</span>&nbsp;<span class="ident" id="4719628">altScope</span>&nbsp;<span class="op" id="4719637">*</span><span class="ident" id="4719638">Scope</span><span class="op" id="4719643">,</span>&nbsp;<span class="ident" id="4719645">obj</span>&nbsp;<span class="op" id="4719649">*</span><span class="ident" id="4719650">Object</span><span class="op" id="4719656">)</span>&nbsp;<span class="op" id="4719658">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719661">alt</span>&nbsp;<span class="op" id="4719665">:=</span>&nbsp;<span class="ident" id="4719668">scope</span><span class="op" id="4719673">.</span><span class="ident" id="4719674">Insert</span><span class="op" id="4719680">(</span><span class="ident" id="4719681">obj</span><span class="op" id="4719684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719687">if</span>&nbsp;<span class="ident" id="4719690">alt</span>&nbsp;<span class="op" id="4719694">==</span>&nbsp;<span class="ident" id="4719697">nil</span>&nbsp;<span class="op" id="4719701">&amp;&amp;</span>&nbsp;<span class="ident" id="4719704">altScope</span>&nbsp;<span class="op" id="4719713">!=</span>&nbsp;<span class="ident" id="4719716">nil</span>&nbsp;<span class="op" id="4719720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4719724">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719783">alt</span>&nbsp;<span class="op" id="4719787">=</span>&nbsp;<span class="ident" id="4719789">altScope</span><span class="op" id="4719797">.</span><span class="ident" id="4719798">Lookup</span><span class="op" id="4719804">(</span><span class="ident" id="4719805">obj</span><span class="op" id="4719808">.</span><span class="ident" id="4719809">Name</span><span class="op" id="4719813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719816">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719819">if</span>&nbsp;<span class="ident" id="4719822">alt</span>&nbsp;<span class="op" id="4719826">!=</span>&nbsp;<span class="ident" id="4719829">nil</span>&nbsp;<span class="op" id="4719833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719837">prevDecl</span>&nbsp;<span class="op" id="4719846">:=</span>&nbsp;<span class="string" id="4719849">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719854">if</span>&nbsp;<span class="ident" id="4719857">pos</span>&nbsp;<span class="op" id="4719861">:=</span>&nbsp;<span class="ident" id="4719864">alt</span><span class="op" id="4719867">.</span><span class="ident" id="4719868">Pos</span><span class="op" id="4719871">(</span><span class="op" id="4719872">)</span><span class="op" id="4719873">;</span>&nbsp;<span class="ident" id="4719875">pos</span><span class="op" id="4719878">.</span><span class="ident" id="4719879">IsValid</span><span class="op" id="4719886">(</span><span class="op" id="4719887">)</span>&nbsp;<span class="op" id="4719889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719894">prevDecl</span>&nbsp;<span class="op" id="4719903">=</span>&nbsp;<span class="ident" id="4719905">fmt</span><span class="op" id="4719908">.</span><span class="ident" id="4719909">Sprintf</span><span class="op" id="4719916">(</span><span class="string" id="4719917">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="4719949">,</span>&nbsp;<span class="ident" id="4719951">p</span><span class="op" id="4719952">.</span><span class="ident" id="4719953">fset</span><span class="op" id="4719957">.</span><span class="ident" id="4719958">Position</span><span class="op" id="4719966">(</span><span class="ident" id="4719967">pos</span><span class="op" id="4719970">)</span><span class="op" id="4719971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719975">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719979">p</span><span class="op" id="4719980">.</span><span class="builtintype" id="4719981">error</span><span class="op" id="4719986">(</span><span class="ident" id="4719987">obj</span><span class="op" id="4719990">.</span><span class="ident" id="4719991">Pos</span><span class="op" id="4719994">(</span><span class="op" id="4719995">)</span><span class="op" id="4719996">,</span>&nbsp;<span class="ident" id="4719998">fmt</span><span class="op" id="4720001">.</span><span class="ident" id="4720002">Sprintf</span><span class="op" id="4720009">(</span><span class="string" id="4720010">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="4720041">,</span>&nbsp;<span class="ident" id="4720043">obj</span><span class="op" id="4720046">.</span><span class="ident" id="4720047">Name</span><span class="op" id="4720051">,</span>&nbsp;<span class="ident" id="4720053">prevDecl</span><span class="op" id="4720061">)</span><span class="op" id="4720062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720065">}</span><br>
<span class="lineno"></span><span class="op" id="4720067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4720070">func</span>&nbsp;<span class="ident" id="4720075">resolve</span><span class="op" id="4720082">(</span><span class="ident" id="4720083">scope</span>&nbsp;<span class="op" id="4720089">*</span><span class="ident" id="4720090">Scope</span><span class="op" id="4720095">,</span>&nbsp;<span class="ident" id="4720097">ident</span>&nbsp;<span class="op" id="4720103">*</span><span class="ident" id="4720104">Ident</span><span class="op" id="4720109">)</span>&nbsp;<span class="builtintype" id="4720111">bool</span>&nbsp;<span class="op" id="4720116">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720119">for</span>&nbsp;<span class="op" id="4720123">;</span>&nbsp;<span class="ident" id="4720125">scope</span>&nbsp;<span class="op" id="4720131">!=</span>&nbsp;<span class="ident" id="4720134">nil</span><span class="op" id="4720137">;</span>&nbsp;<span class="ident" id="4720139">scope</span>&nbsp;<span class="op" id="4720145">=</span>&nbsp;<span class="ident" id="4720147">scope</span><span class="op" id="4720152">.</span><span class="ident" id="4720153">Outer</span>&nbsp;<span class="op" id="4720159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720163">if</span>&nbsp;<span class="ident" id="4720166">obj</span>&nbsp;<span class="op" id="4720170">:=</span>&nbsp;<span class="ident" id="4720173">scope</span><span class="op" id="4720178">.</span><span class="ident" id="4720179">Lookup</span><span class="op" id="4720185">(</span><span class="ident" id="4720186">ident</span><span class="op" id="4720191">.</span><span class="ident" id="4720192">Name</span><span class="op" id="4720196">)</span><span class="op" id="4720197">;</span>&nbsp;<span class="ident" id="4720199">obj</span>&nbsp;<span class="op" id="4720203">!=</span>&nbsp;<span class="ident" id="4720206">nil</span>&nbsp;<span class="op" id="4720210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720215">ident</span><span class="op" id="4720220">.</span><span class="ident" id="4720221">Obj</span>&nbsp;<span class="op" id="4720225">=</span>&nbsp;<span class="ident" id="4720227">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720234">return</span>&nbsp;<span class="builtintype" id="4720241">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720248">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720254">return</span>&nbsp;<span class="builtintype" id="4720261">false</span><br>
<span class="lineno"></span><span class="op" id="4720267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4720270">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="4720327">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="4720385">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="4720435">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4720495">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="4720564">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="4720629">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="4720694">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4720758">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="4720773">type</span>&nbsp;<span class="ident" id="4720778">Importer</span>&nbsp;<span class="keyword" id="4720787">func</span><span class="op" id="4720791">(</span><span class="ident" id="4720792">imports</span>&nbsp;<span class="keyword" id="4720800">map</span><span class="op" id="4720803">[</span><span class="builtintype" id="4720804">string</span><span class="op" id="4720810">]</span><span class="op" id="4720811">*</span><span class="ident" id="4720812">Object</span><span class="op" id="4720818">,</span>&nbsp;<span class="ident" id="4720820">path</span>&nbsp;<span class="builtintype" id="4720825">string</span><span class="op" id="4720831">)</span>&nbsp;<span class="op" id="4720833">(</span><span class="ident" id="4720834">pkg</span>&nbsp;<span class="op" id="4720838">*</span><span class="ident" id="4720839">Object</span><span class="op" id="4720845">,</span>&nbsp;<span class="ident" id="4720847">err</span>&nbsp;<span class="builtintype" id="4720851">error</span><span class="op" id="4720856">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4720859">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="4720938">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="4721017">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="4721097">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="4721174">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="4721251">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4721328">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="4721386">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="4721464">//</span><br>
<span class="lineno"></span><span class="keyword" id="4721467">func</span>&nbsp;<span class="ident" id="4721472">NewPackage</span><span class="op" id="4721482">(</span><span class="ident" id="4721483">fset</span>&nbsp;<span class="op" id="4721488">*</span><span class="ident" id="4721489">token</span><span class="op" id="4721494">.</span><span class="ident" id="4721495">FileSet</span><span class="op" id="4721502">,</span>&nbsp;<span class="ident" id="4721504">files</span>&nbsp;<span class="keyword" id="4721510">map</span><span class="op" id="4721513">[</span><span class="builtintype" id="4721514">string</span><span class="op" id="4721520">]</span><span class="op" id="4721521">*</span><span class="ident" id="4721522">File</span><span class="op" id="4721526">,</span>&nbsp;<span class="ident" id="4721528">importer</span>&nbsp;<span class="ident" id="4721537">Importer</span><span class="op" id="4721545">,</span>&nbsp;<span class="ident" id="4721547">universe</span>&nbsp;<span class="op" id="4721556">*</span><span class="ident" id="4721557">Scope</span><span class="op" id="4721562">)</span>&nbsp;<span class="op" id="4721564">(</span><span class="op" id="4721565">*</span><span class="ident" id="4721566">Package</span><span class="op" id="4721573">,</span>&nbsp;<span class="builtintype" id="4721575">error</span><span class="op" id="4721580">)</span>&nbsp;<span class="op" id="4721582">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721585">var</span>&nbsp;<span class="ident" id="4721589">p</span>&nbsp;<span class="ident" id="4721591">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721603">p</span><span class="op" id="4721604">.</span><span class="ident" id="4721605">fset</span>&nbsp;<span class="op" id="4721610">=</span>&nbsp;<span class="ident" id="4721612">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4721619">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721646">pkgName</span>&nbsp;<span class="op" id="4721654">:=</span>&nbsp;<span class="string" id="4721657">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721661">pkgScope</span>&nbsp;<span class="op" id="4721670">:=</span>&nbsp;<span class="ident" id="4721673">NewScope</span><span class="op" id="4721681">(</span><span class="ident" id="4721682">universe</span><span class="op" id="4721690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721693">for</span>&nbsp;<span class="ident" id="4721697">_</span><span class="op" id="4721698">,</span>&nbsp;<span class="ident" id="4721700">file</span>&nbsp;<span class="op" id="4721705">:=</span>&nbsp;<span class="keyword" id="4721708">range</span>&nbsp;<span class="ident" id="4721714">files</span>&nbsp;<span class="op" id="4721720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4721724">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721754">switch</span>&nbsp;<span class="ident" id="4721761">name</span>&nbsp;<span class="op" id="4721766">:=</span>&nbsp;<span class="ident" id="4721769">file</span><span class="op" id="4721773">.</span><span class="ident" id="4721774">Name</span><span class="op" id="4721778">.</span><span class="ident" id="4721779">Name</span><span class="op" id="4721783">;</span>&nbsp;<span class="op" id="4721785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721789">case</span>&nbsp;<span class="ident" id="4721794">pkgName</span>&nbsp;<span class="op" id="4721802">==</span>&nbsp;<span class="string" id="4721805">&#34;&#34;</span><span class="op" id="4721807">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721812">pkgName</span>&nbsp;<span class="op" id="4721820">=</span>&nbsp;<span class="ident" id="4721822">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721829">case</span>&nbsp;<span class="ident" id="4721834">name</span>&nbsp;<span class="op" id="4721839">!=</span>&nbsp;<span class="ident" id="4721842">pkgName</span><span class="op" id="4721849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721854">p</span><span class="op" id="4721855">.</span><span class="ident" id="4721856">errorf</span><span class="op" id="4721862">(</span><span class="ident" id="4721863">file</span><span class="op" id="4721867">.</span><span class="ident" id="4721868">Package</span><span class="op" id="4721875">,</span>&nbsp;<span class="string" id="4721877">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="4721902">,</span>&nbsp;<span class="ident" id="4721904">name</span><span class="op" id="4721908">,</span>&nbsp;<span class="ident" id="4721910">pkgName</span><span class="op" id="4721917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721922">continue</span>&nbsp;<span class="comment" id="4721931">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721953">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4721958">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722011">for</span>&nbsp;<span class="ident" id="4722015">_</span><span class="op" id="4722016">,</span>&nbsp;<span class="ident" id="4722018">obj</span>&nbsp;<span class="op" id="4722022">:=</span>&nbsp;<span class="keyword" id="4722025">range</span>&nbsp;<span class="ident" id="4722031">file</span><span class="op" id="4722035">.</span><span class="ident" id="4722036">Scope</span><span class="op" id="4722041">.</span><span class="ident" id="4722042">Objects</span>&nbsp;<span class="op" id="4722050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722055">p</span><span class="op" id="4722056">.</span><span class="ident" id="4722057">declare</span><span class="op" id="4722064">(</span><span class="ident" id="4722065">pkgScope</span><span class="op" id="4722073">,</span>&nbsp;<span class="ident" id="4722075">nil</span><span class="op" id="4722078">,</span>&nbsp;<span class="ident" id="4722080">obj</span><span class="op" id="4722083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722087">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722094">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722164">imports</span>&nbsp;<span class="op" id="4722172">:=</span>&nbsp;<span class="builtinfunc" id="4722175">make</span><span class="op" id="4722179">(</span><span class="keyword" id="4722180">map</span><span class="op" id="4722183">[</span><span class="builtintype" id="4722184">string</span><span class="op" id="4722190">]</span><span class="op" id="4722191">*</span><span class="ident" id="4722192">Object</span><span class="op" id="4722198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722202">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722264">for</span>&nbsp;<span class="ident" id="4722268">_</span><span class="op" id="4722269">,</span>&nbsp;<span class="ident" id="4722271">file</span>&nbsp;<span class="op" id="4722276">:=</span>&nbsp;<span class="keyword" id="4722279">range</span>&nbsp;<span class="ident" id="4722285">files</span>&nbsp;<span class="op" id="4722291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722295">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722349">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722388">if</span>&nbsp;<span class="ident" id="4722391">file</span><span class="op" id="4722395">.</span><span class="ident" id="4722396">Name</span><span class="op" id="4722400">.</span><span class="ident" id="4722401">Name</span>&nbsp;<span class="op" id="4722406">!=</span>&nbsp;<span class="ident" id="4722409">pkgName</span>&nbsp;<span class="op" id="4722417">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722422">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722438">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722486">importErrors</span>&nbsp;<span class="op" id="4722499">:=</span>&nbsp;<span class="builtintype" id="4722502">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722510">fileScope</span>&nbsp;<span class="op" id="4722520">:=</span>&nbsp;<span class="ident" id="4722523">NewScope</span><span class="op" id="4722531">(</span><span class="ident" id="4722532">pkgScope</span><span class="op" id="4722540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722544">for</span>&nbsp;<span class="ident" id="4722548">_</span><span class="op" id="4722549">,</span>&nbsp;<span class="ident" id="4722551">spec</span>&nbsp;<span class="op" id="4722556">:=</span>&nbsp;<span class="keyword" id="4722559">range</span>&nbsp;<span class="ident" id="4722565">file</span><span class="op" id="4722569">.</span><span class="ident" id="4722570">Imports</span>&nbsp;<span class="op" id="4722578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722583">if</span>&nbsp;<span class="ident" id="4722586">importer</span>&nbsp;<span class="op" id="4722595">==</span>&nbsp;<span class="ident" id="4722598">nil</span>&nbsp;<span class="op" id="4722602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722608">importErrors</span>&nbsp;<span class="op" id="4722621">=</span>&nbsp;<span class="builtintype" id="4722623">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722632">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722649">path</span><span class="op" id="4722653">,</span>&nbsp;<span class="ident" id="4722655">_</span>&nbsp;<span class="op" id="4722657">:=</span>&nbsp;<span class="ident" id="4722660">strconv</span><span class="op" id="4722667">.</span><span class="ident" id="4722668">Unquote</span><span class="op" id="4722675">(</span><span class="ident" id="4722676">spec</span><span class="op" id="4722680">.</span><span class="ident" id="4722681">Path</span><span class="op" id="4722685">.</span><span class="ident" id="4722686">Value</span><span class="op" id="4722691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722696">pkg</span><span class="op" id="4722699">,</span>&nbsp;<span class="ident" id="4722701">err</span>&nbsp;<span class="op" id="4722705">:=</span>&nbsp;<span class="ident" id="4722708">importer</span><span class="op" id="4722716">(</span><span class="ident" id="4722717">imports</span><span class="op" id="4722724">,</span>&nbsp;<span class="ident" id="4722726">path</span><span class="op" id="4722730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722735">if</span>&nbsp;<span class="ident" id="4722738">err</span>&nbsp;<span class="op" id="4722742">!=</span>&nbsp;<span class="ident" id="4722745">nil</span>&nbsp;<span class="op" id="4722749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722755">p</span><span class="op" id="4722756">.</span><span class="ident" id="4722757">errorf</span><span class="op" id="4722763">(</span><span class="ident" id="4722764">spec</span><span class="op" id="4722768">.</span><span class="ident" id="4722769">Path</span><span class="op" id="4722773">.</span><span class="ident" id="4722774">Pos</span><span class="op" id="4722777">(</span><span class="op" id="4722778">)</span><span class="op" id="4722779">,</span>&nbsp;<span class="string" id="4722781">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="4722807">,</span>&nbsp;<span class="ident" id="4722809">path</span><span class="op" id="4722813">,</span>&nbsp;<span class="ident" id="4722815">err</span><span class="op" id="4722818">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722824">importErrors</span>&nbsp;<span class="op" id="4722837">=</span>&nbsp;<span class="builtintype" id="4722839">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722848">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722865">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722925">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722986">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723049">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723098">name</span>&nbsp;<span class="op" id="4723103">:=</span>&nbsp;<span class="ident" id="4723106">pkg</span><span class="op" id="4723109">.</span><span class="ident" id="4723110">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723118">if</span>&nbsp;<span class="ident" id="4723121">spec</span><span class="op" id="4723125">.</span><span class="ident" id="4723126">Name</span>&nbsp;<span class="op" id="4723131">!=</span>&nbsp;<span class="ident" id="4723134">nil</span>&nbsp;<span class="op" id="4723138">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723144">name</span>&nbsp;<span class="op" id="4723149">=</span>&nbsp;<span class="ident" id="4723151">spec</span><span class="op" id="4723155">.</span><span class="ident" id="4723156">Name</span><span class="op" id="4723160">.</span><span class="ident" id="4723161">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723175">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723206">if</span>&nbsp;<span class="ident" id="4723209">name</span>&nbsp;<span class="op" id="4723214">==</span>&nbsp;<span class="string" id="4723217">&#34;.&#34;</span>&nbsp;<span class="op" id="4723221">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723227">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723271">for</span>&nbsp;<span class="ident" id="4723275">_</span><span class="op" id="4723276">,</span>&nbsp;<span class="ident" id="4723278">obj</span>&nbsp;<span class="op" id="4723282">:=</span>&nbsp;<span class="keyword" id="4723285">range</span>&nbsp;<span class="ident" id="4723291">pkg</span><span class="op" id="4723294">.</span><span class="ident" id="4723295">Data</span><span class="op" id="4723299">.</span><span class="op" id="4723300">(</span><span class="op" id="4723301">*</span><span class="ident" id="4723302">Scope</span><span class="op" id="4723307">)</span><span class="op" id="4723308">.</span><span class="ident" id="4723309">Objects</span>&nbsp;<span class="op" id="4723317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723324">p</span><span class="op" id="4723325">.</span><span class="ident" id="4723326">declare</span><span class="op" id="4723333">(</span><span class="ident" id="4723334">fileScope</span><span class="op" id="4723343">,</span>&nbsp;<span class="ident" id="4723345">pkgScope</span><span class="op" id="4723353">,</span>&nbsp;<span class="ident" id="4723355">obj</span><span class="op" id="4723358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723369">}</span>&nbsp;<span class="keyword" id="4723371">else</span>&nbsp;<span class="keyword" id="4723376">if</span>&nbsp;<span class="ident" id="4723379">name</span>&nbsp;<span class="op" id="4723384">!=</span>&nbsp;<span class="string" id="4723387">&#34;_&#34;</span>&nbsp;<span class="op" id="4723391">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723397">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723450">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723505">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723562">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723590">obj</span>&nbsp;<span class="op" id="4723594">:=</span>&nbsp;<span class="ident" id="4723597">NewObj</span><span class="op" id="4723603">(</span><span class="ident" id="4723604">Pkg</span><span class="op" id="4723607">,</span>&nbsp;<span class="ident" id="4723609">name</span><span class="op" id="4723613">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723619">obj</span><span class="op" id="4723622">.</span><span class="ident" id="4723623">Decl</span>&nbsp;<span class="op" id="4723628">=</span>&nbsp;<span class="ident" id="4723630">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723639">obj</span><span class="op" id="4723642">.</span><span class="ident" id="4723643">Data</span>&nbsp;<span class="op" id="4723648">=</span>&nbsp;<span class="ident" id="4723650">pkg</span><span class="op" id="4723653">.</span><span class="ident" id="4723654">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723663">p</span><span class="op" id="4723664">.</span><span class="ident" id="4723665">declare</span><span class="op" id="4723672">(</span><span class="ident" id="4723673">fileScope</span><span class="op" id="4723682">,</span>&nbsp;<span class="ident" id="4723684">pkgScope</span><span class="op" id="4723692">,</span>&nbsp;<span class="ident" id="4723694">obj</span><span class="op" id="4723697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723706">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723711">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723736">if</span>&nbsp;<span class="ident" id="4723739">importErrors</span>&nbsp;<span class="op" id="4723752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723757">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723816">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723875">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723934">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723973">pkgScope</span><span class="op" id="4723981">.</span><span class="ident" id="4723982">Outer</span>&nbsp;<span class="op" id="4723988">=</span>&nbsp;<span class="ident" id="4723990">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724000">i</span>&nbsp;<span class="op" id="4724002">:=</span>&nbsp;<span class="num" id="4724005">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724009">for</span>&nbsp;<span class="ident" id="4724013">_</span><span class="op" id="4724014">,</span>&nbsp;<span class="ident" id="4724016">ident</span>&nbsp;<span class="op" id="4724022">:=</span>&nbsp;<span class="keyword" id="4724025">range</span>&nbsp;<span class="ident" id="4724031">file</span><span class="op" id="4724035">.</span><span class="ident" id="4724036">Unresolved</span>&nbsp;<span class="op" id="4724047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724052">if</span>&nbsp;<span class="op" id="4724055">!</span><span class="ident" id="4724056">resolve</span><span class="op" id="4724063">(</span><span class="ident" id="4724064">fileScope</span><span class="op" id="4724073">,</span>&nbsp;<span class="ident" id="4724075">ident</span><span class="op" id="4724080">)</span>&nbsp;<span class="op" id="4724082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724088">p</span><span class="op" id="4724089">.</span><span class="ident" id="4724090">errorf</span><span class="op" id="4724096">(</span><span class="ident" id="4724097">ident</span><span class="op" id="4724102">.</span><span class="ident" id="4724103">Pos</span><span class="op" id="4724106">(</span><span class="op" id="4724107">)</span><span class="op" id="4724108">,</span>&nbsp;<span class="string" id="4724110">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="4724131">,</span>&nbsp;<span class="ident" id="4724133">ident</span><span class="op" id="4724138">.</span><span class="ident" id="4724139">Name</span><span class="op" id="4724143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724149">file</span><span class="op" id="4724153">.</span><span class="ident" id="4724154">Unresolved</span><span class="op" id="4724164">[</span><span class="ident" id="4724165">i</span><span class="op" id="4724166">]</span>&nbsp;<span class="op" id="4724168">=</span>&nbsp;<span class="ident" id="4724170">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724180">i</span><span class="op" id="4724181">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724196">file</span><span class="op" id="4724200">.</span><span class="ident" id="4724201">Unresolved</span>&nbsp;<span class="op" id="4724212">=</span>&nbsp;<span class="ident" id="4724214">file</span><span class="op" id="4724218">.</span><span class="ident" id="4724219">Unresolved</span><span class="op" id="4724229">[</span><span class="num" id="4724230">0</span><span class="op" id="4724231">:</span><span class="ident" id="4724232">i</span><span class="op" id="4724233">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724237">pkgScope</span><span class="op" id="4724245">.</span><span class="ident" id="4724246">Outer</span>&nbsp;<span class="op" id="4724252">=</span>&nbsp;<span class="ident" id="4724254">universe</span>&nbsp;<span class="comment" id="4724263">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724292">p</span><span class="op" id="4724293">.</span><span class="ident" id="4724294">errors</span><span class="op" id="4724300">.</span><span class="ident" id="4724301">Sort</span><span class="op" id="4724305">(</span><span class="op" id="4724306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724309">return</span>&nbsp;<span class="op" id="4724316">&amp;</span><span class="ident" id="4724317">Package</span><span class="op" id="4724324">{</span><span class="ident" id="4724325">pkgName</span><span class="op" id="4724332">,</span>&nbsp;<span class="ident" id="4724334">pkgScope</span><span class="op" id="4724342">,</span>&nbsp;<span class="ident" id="4724344">imports</span><span class="op" id="4724351">,</span>&nbsp;<span class="ident" id="4724353">files</span><span class="op" id="4724358">}</span><span class="op" id="4724359">,</span>&nbsp;<span class="ident" id="4724361">p</span><span class="op" id="4724362">.</span><span class="ident" id="4724363">errors</span><span class="op" id="4724369">.</span><span class="ident" id="4724370">Err</span><span class="op" id="4724373">(</span><span class="op" id="4724374">)</span><br>
<span class="lineno"></span><span class="op" id="4724376">}</span>
</div>
</body>
</html>
