<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/x509</h2>
<ul>
<li><a href="/gostd/crypto/x509/cert_pool.go.html">cert_pool.go</a></li>
<li><a href="/gostd/crypto/x509/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt.go.html">pem_decrypt.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt_test.go.html">pem_decrypt_test.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs1.go.html">pkcs1.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8.go.html">pkcs8.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8_test.go.html">pkcs8_test.go</a></li>
<li><a href="/gostd/crypto/x509/root.go.html">root.go</a></li>
<li><a href="/gostd/crypto/x509/root_unix.go.html">root_unix.go</a></li>
<li><a href="/gostd/crypto/x509/sec1.go.html">sec1.go</a></li>
<li><a href="/gostd/crypto/x509/sec1_test.go.html">sec1_test.go</a></li>
<li><a href="/gostd/crypto/x509/verify.go.html" class="current">verify.go</a></li>
<li><a href="/gostd/crypto/x509/verify_test.go.html">verify_test.go</a></li>
<li><a href="/gostd/crypto/x509/x509.go.html">x509.go</a></li>
<li><a href="/gostd/crypto/x509/x509_test.go.html">x509_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3920336">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3920391">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3920445">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3920496">package</span>&nbsp;<span class="ident" id="3920504">x509</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3920510">import</span>&nbsp;<span class="op" id="3920517">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3920520">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3920527">&#34;net&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3920534">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3920545">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3920556">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3920564">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3920579">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3920582">type</span>&nbsp;<span class="ident" id="3920587">InvalidReason</span>&nbsp;<span class="builtintype" id="3920601">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3920606">const</span>&nbsp;<span class="op" id="3920612">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920615">//&nbsp;NotAuthorizedToSign&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;another</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920687">//&nbsp;which&nbsp;isn&#39;t&nbsp;marked&nbsp;as&nbsp;a&nbsp;CA&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920731">NotAuthorizedToSign</span>&nbsp;<span class="ident" id="3920751">InvalidReason</span>&nbsp;<span class="op" id="3920765">=</span>&nbsp;<span class="ident" id="3920767">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920773">//&nbsp;Expired&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;has&nbsp;expired,&nbsp;based&nbsp;on&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920843">//&nbsp;given&nbsp;in&nbsp;the&nbsp;VerifyOptions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920875">Expired</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920884">//&nbsp;CANotAuthorizedForThisName&nbsp;results&nbsp;when&nbsp;an&nbsp;intermediate&nbsp;or&nbsp;root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3920952">//&nbsp;certificate&nbsp;has&nbsp;a&nbsp;name&nbsp;constraint&nbsp;which&nbsp;doesn&#39;t&nbsp;include&nbsp;the&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3921021">//&nbsp;being&nbsp;checked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921040">CANotAuthorizedForThisName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3921068">//&nbsp;TooManyIntermediates&nbsp;results&nbsp;when&nbsp;a&nbsp;path&nbsp;length&nbsp;constraint&nbsp;is</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3921134">//&nbsp;violated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921148">TooManyIntermediates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3921170">//&nbsp;IncompatibleUsage&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&#39;s&nbsp;key&nbsp;usage&nbsp;indicates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3921243">//&nbsp;that&nbsp;it&nbsp;may&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;a&nbsp;different&nbsp;purpose.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921297">IncompatibleUsage</span><br>
<span class="lineno">35</span><span class="op" id="3921315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3921318">//&nbsp;CertificateInvalidError&nbsp;results&nbsp;when&nbsp;an&nbsp;odd&nbsp;error&nbsp;occurs.&nbsp;Users&nbsp;of&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="3921393">//&nbsp;library&nbsp;probably&nbsp;want&nbsp;to&nbsp;handle&nbsp;all&nbsp;these&nbsp;errors&nbsp;uniformly.</span><br>
<span class="lineno"></span><span class="keyword" id="3921456">type</span>&nbsp;<span class="ident" id="3921461">CertificateInvalidError</span>&nbsp;<span class="keyword" id="3921485">struct</span>&nbsp;<span class="op" id="3921492">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921495">Cert</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3921502">*</span><span class="ident" id="3921503">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3921516">Reason</span>&nbsp;<span class="ident" id="3921523">InvalidReason</span><br>
<span class="lineno"></span><span class="op" id="3921537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3921540">func</span>&nbsp;<span class="op" id="3921545">(</span><span class="ident" id="3921546">e</span>&nbsp;<span class="ident" id="3921548">CertificateInvalidError</span><span class="op" id="3921571">)</span>&nbsp;<span class="ident" id="3921573">Error</span><span class="op" id="3921578">(</span><span class="op" id="3921579">)</span>&nbsp;<span class="builtintype" id="3921581">string</span>&nbsp;<span class="op" id="3921588">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921591">switch</span>&nbsp;<span class="ident" id="3921598">e</span><span class="op" id="3921599">.</span><span class="ident" id="3921600">Reason</span>&nbsp;<span class="op" id="3921607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921610">case</span>&nbsp;<span class="ident" id="3921615">NotAuthorizedToSign</span><span class="op" id="3921634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921638">return</span>&nbsp;<span class="string" id="3921645">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;other&nbsp;certificates&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921711">case</span>&nbsp;<span class="ident" id="3921716">Expired</span><span class="op" id="3921723">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921727">return</span>&nbsp;<span class="string" id="3921734">&#34;x509:&nbsp;certificate&nbsp;has&nbsp;expired&nbsp;or&nbsp;is&nbsp;not&nbsp;yet&nbsp;valid&#34;</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921787">case</span>&nbsp;<span class="ident" id="3921792">CANotAuthorizedForThisName</span><span class="op" id="3921818">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921822">return</span>&nbsp;<span class="string" id="3921829">&#34;x509:&nbsp;a&nbsp;root&nbsp;or&nbsp;intermediate&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;in&nbsp;this&nbsp;domain&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921914">case</span>&nbsp;<span class="ident" id="3921919">TooManyIntermediates</span><span class="op" id="3921939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3921943">return</span>&nbsp;<span class="string" id="3921950">&#34;x509:&nbsp;too&nbsp;many&nbsp;intermediates&nbsp;for&nbsp;path&nbsp;length&nbsp;constraint&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922009">case</span>&nbsp;<span class="ident" id="3922014">IncompatibleUsage</span><span class="op" id="3922031">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922035">return</span>&nbsp;<span class="string" id="3922042">&#34;x509:&nbsp;certificate&nbsp;specifies&nbsp;an&nbsp;incompatible&nbsp;key&nbsp;usage&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922102">return</span>&nbsp;<span class="string" id="3922109">&#34;x509:&nbsp;unknown&nbsp;error&#34;</span><br>
<span class="lineno"></span><span class="op" id="3922131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3922134">//&nbsp;HostnameError&nbsp;results&nbsp;when&nbsp;the&nbsp;set&nbsp;of&nbsp;authorized&nbsp;names&nbsp;doesn&#39;t&nbsp;match&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3922210">//&nbsp;requested&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3922229">type</span>&nbsp;<span class="ident" id="3922234">HostnameError</span>&nbsp;<span class="keyword" id="3922248">struct</span>&nbsp;<span class="op" id="3922255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922258">Certificate</span>&nbsp;<span class="op" id="3922270">*</span><span class="ident" id="3922271">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922284">Host</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3922296">string</span><br>
<span class="lineno">65</span><span class="op" id="3922303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3922306">func</span>&nbsp;<span class="op" id="3922311">(</span><span class="ident" id="3922312">h</span>&nbsp;<span class="ident" id="3922314">HostnameError</span><span class="op" id="3922327">)</span>&nbsp;<span class="ident" id="3922329">Error</span><span class="op" id="3922334">(</span><span class="op" id="3922335">)</span>&nbsp;<span class="builtintype" id="3922337">string</span>&nbsp;<span class="op" id="3922344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922347">c</span>&nbsp;<span class="op" id="3922349">:=</span>&nbsp;<span class="ident" id="3922352">h</span><span class="op" id="3922353">.</span><span class="ident" id="3922354">Certificate</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922368">var</span>&nbsp;<span class="ident" id="3922372">valid</span>&nbsp;<span class="builtintype" id="3922378">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922386">if</span>&nbsp;<span class="ident" id="3922389">ip</span>&nbsp;<span class="op" id="3922392">:=</span>&nbsp;<span class="ident" id="3922395">net</span><span class="op" id="3922398">.</span><span class="ident" id="3922399">ParseIP</span><span class="op" id="3922406">(</span><span class="ident" id="3922407">h</span><span class="op" id="3922408">.</span><span class="ident" id="3922409">Host</span><span class="op" id="3922413">)</span><span class="op" id="3922414">;</span>&nbsp;<span class="ident" id="3922416">ip</span>&nbsp;<span class="op" id="3922419">!=</span>&nbsp;<span class="builtintype" id="3922422">nil</span>&nbsp;<span class="op" id="3922426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3922430">//&nbsp;Trying&nbsp;to&nbsp;validate&nbsp;an&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922460">if</span>&nbsp;<span class="builtinfunc" id="3922463">len</span><span class="op" id="3922466">(</span><span class="ident" id="3922467">c</span><span class="op" id="3922468">.</span><span class="ident" id="3922469">IPAddresses</span><span class="op" id="3922480">)</span>&nbsp;<span class="op" id="3922482">==</span>&nbsp;<span class="num" id="3922485">0</span>&nbsp;<span class="op" id="3922487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922492">return</span>&nbsp;<span class="string" id="3922499">&#34;x509:&nbsp;cannot&nbsp;validate&nbsp;certificate&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3922540">+</span>&nbsp;<span class="ident" id="3922542">h</span><span class="op" id="3922543">.</span><span class="ident" id="3922544">Host</span>&nbsp;<span class="op" id="3922549">+</span>&nbsp;<span class="string" id="3922551">&#34;&nbsp;because&nbsp;it&nbsp;doesn&#39;t&nbsp;contain&nbsp;any&nbsp;IP&nbsp;SANs&#34;</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922599">for</span>&nbsp;<span class="ident" id="3922603">_</span><span class="op" id="3922604">,</span>&nbsp;<span class="ident" id="3922606">san</span>&nbsp;<span class="op" id="3922610">:=</span>&nbsp;<span class="keyword" id="3922613">range</span>&nbsp;<span class="ident" id="3922619">c</span><span class="op" id="3922620">.</span><span class="ident" id="3922621">IPAddresses</span>&nbsp;<span class="op" id="3922633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922638">if</span>&nbsp;<span class="builtinfunc" id="3922641">len</span><span class="op" id="3922644">(</span><span class="ident" id="3922645">valid</span><span class="op" id="3922650">)</span>&nbsp;<span class="op" id="3922652">&gt;</span>&nbsp;<span class="num" id="3922654">0</span>&nbsp;<span class="op" id="3922656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922662">valid</span>&nbsp;<span class="op" id="3922668">+=</span>&nbsp;<span class="string" id="3922671">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922679">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922684">valid</span>&nbsp;<span class="op" id="3922690">+=</span>&nbsp;<span class="ident" id="3922693">san</span><span class="op" id="3922696">.</span><span class="ident" id="3922697">String</span><span class="op" id="3922703">(</span><span class="op" id="3922704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922711">}</span>&nbsp;<span class="keyword" id="3922713">else</span>&nbsp;<span class="op" id="3922718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922722">if</span>&nbsp;<span class="builtinfunc" id="3922725">len</span><span class="op" id="3922728">(</span><span class="ident" id="3922729">c</span><span class="op" id="3922730">.</span><span class="ident" id="3922731">DNSNames</span><span class="op" id="3922739">)</span>&nbsp;<span class="op" id="3922741">&gt;</span>&nbsp;<span class="num" id="3922743">0</span>&nbsp;<span class="op" id="3922745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922750">valid</span>&nbsp;<span class="op" id="3922756">=</span>&nbsp;<span class="ident" id="3922758">strings</span><span class="op" id="3922765">.</span><span class="ident" id="3922766">Join</span><span class="op" id="3922770">(</span><span class="ident" id="3922771">c</span><span class="op" id="3922772">.</span><span class="ident" id="3922773">DNSNames</span><span class="op" id="3922781">,</span>&nbsp;<span class="string" id="3922783">&#34;,&nbsp;&#34;</span><span class="op" id="3922787">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922791">}</span>&nbsp;<span class="keyword" id="3922793">else</span>&nbsp;<span class="op" id="3922798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3922803">valid</span>&nbsp;<span class="op" id="3922809">=</span>&nbsp;<span class="ident" id="3922811">c</span><span class="op" id="3922812">.</span><span class="ident" id="3922813">Subject</span><span class="op" id="3922820">.</span><span class="ident" id="3922821">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3922837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3922840">return</span>&nbsp;<span class="string" id="3922847">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;valid&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3922881">+</span>&nbsp;<span class="ident" id="3922883">valid</span>&nbsp;<span class="op" id="3922889">+</span>&nbsp;<span class="string" id="3922891">&#34;,&nbsp;not&nbsp;&#34;</span>&nbsp;<span class="op" id="3922900">+</span>&nbsp;<span class="ident" id="3922902">h</span><span class="op" id="3922903">.</span><span class="ident" id="3922904">Host</span><br>
<span class="lineno">90</span><span class="op" id="3922909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3922912">//&nbsp;UnknownAuthorityError&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&nbsp;issuer&nbsp;is&nbsp;unknown</span><br>
<span class="lineno"></span><span class="keyword" id="3922984">type</span>&nbsp;<span class="ident" id="3922989">UnknownAuthorityError</span>&nbsp;<span class="keyword" id="3923011">struct</span>&nbsp;<span class="op" id="3923018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923021">cert</span>&nbsp;<span class="op" id="3923026">*</span><span class="ident" id="3923027">Certificate</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3923040">//&nbsp;hintErr&nbsp;contains&nbsp;an&nbsp;error&nbsp;that&nbsp;may&nbsp;be&nbsp;helpful&nbsp;in&nbsp;determining&nbsp;why&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3923112">//&nbsp;authority&nbsp;wasn&#39;t&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923140">hintErr</span>&nbsp;<span class="builtintype" id="3923148">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3923155">//&nbsp;hintCert&nbsp;contains&nbsp;a&nbsp;possible&nbsp;authority&nbsp;certificate&nbsp;that&nbsp;was&nbsp;rejected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3923228">//&nbsp;because&nbsp;of&nbsp;the&nbsp;error&nbsp;in&nbsp;hintErr.</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923265">hintCert</span>&nbsp;<span class="op" id="3923274">*</span><span class="ident" id="3923275">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3923287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3923290">func</span>&nbsp;<span class="op" id="3923295">(</span><span class="ident" id="3923296">e</span>&nbsp;<span class="ident" id="3923298">UnknownAuthorityError</span><span class="op" id="3923319">)</span>&nbsp;<span class="ident" id="3923321">Error</span><span class="op" id="3923326">(</span><span class="op" id="3923327">)</span>&nbsp;<span class="builtintype" id="3923329">string</span>&nbsp;<span class="op" id="3923336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923339">s</span>&nbsp;<span class="op" id="3923341">:=</span>&nbsp;<span class="string" id="3923344">&#34;x509:&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;unknown&nbsp;authority&#34;</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923393">if</span>&nbsp;<span class="ident" id="3923396">e</span><span class="op" id="3923397">.</span><span class="ident" id="3923398">hintErr</span>&nbsp;<span class="op" id="3923406">!=</span>&nbsp;<span class="builtintype" id="3923409">nil</span>&nbsp;<span class="op" id="3923413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923417">certName</span>&nbsp;<span class="op" id="3923426">:=</span>&nbsp;<span class="ident" id="3923429">e</span><span class="op" id="3923430">.</span><span class="ident" id="3923431">hintCert</span><span class="op" id="3923439">.</span><span class="ident" id="3923440">Subject</span><span class="op" id="3923447">.</span><span class="ident" id="3923448">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923461">if</span>&nbsp;<span class="builtinfunc" id="3923464">len</span><span class="op" id="3923467">(</span><span class="ident" id="3923468">certName</span><span class="op" id="3923476">)</span>&nbsp;<span class="op" id="3923478">==</span>&nbsp;<span class="num" id="3923481">0</span>&nbsp;<span class="op" id="3923483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923488">if</span>&nbsp;<span class="builtinfunc" id="3923491">len</span><span class="op" id="3923494">(</span><span class="ident" id="3923495">e</span><span class="op" id="3923496">.</span><span class="ident" id="3923497">hintCert</span><span class="op" id="3923505">.</span><span class="ident" id="3923506">Subject</span><span class="op" id="3923513">.</span><span class="ident" id="3923514">Organization</span><span class="op" id="3923526">)</span>&nbsp;<span class="op" id="3923528">&gt;</span>&nbsp;<span class="num" id="3923530">0</span>&nbsp;<span class="op" id="3923532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923538">certName</span>&nbsp;<span class="op" id="3923547">=</span>&nbsp;<span class="ident" id="3923549">e</span><span class="op" id="3923550">.</span><span class="ident" id="3923551">hintCert</span><span class="op" id="3923559">.</span><span class="ident" id="3923560">Subject</span><span class="op" id="3923567">.</span><span class="ident" id="3923568">Organization</span><span class="op" id="3923580">[</span><span class="num" id="3923581">0</span><span class="op" id="3923582">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3923587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923592">certName</span>&nbsp;<span class="op" id="3923601">=</span>&nbsp;<span class="string" id="3923603">&#34;serial:&#34;</span>&nbsp;<span class="op" id="3923613">+</span>&nbsp;<span class="ident" id="3923615">e</span><span class="op" id="3923616">.</span><span class="ident" id="3923617">hintCert</span><span class="op" id="3923625">.</span><span class="ident" id="3923626">SerialNumber</span><span class="op" id="3923638">.</span><span class="ident" id="3923639">String</span><span class="op" id="3923645">(</span><span class="op" id="3923646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3923650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923654">s</span>&nbsp;<span class="op" id="3923656">+=</span>&nbsp;<span class="ident" id="3923659">fmt</span><span class="op" id="3923662">.</span><span class="ident" id="3923663">Sprintf</span><span class="op" id="3923670">(</span><span class="string" id="3923671">&#34;&nbsp;(possibly&nbsp;because&nbsp;of&nbsp;%q&nbsp;while&nbsp;trying&nbsp;to&nbsp;verify&nbsp;candidate&nbsp;authority&nbsp;certificate&nbsp;%q)&#34;</span><span class="op" id="3923756">,</span>&nbsp;<span class="ident" id="3923758">e</span><span class="op" id="3923759">.</span><span class="ident" id="3923760">hintErr</span><span class="op" id="3923767">,</span>&nbsp;<span class="ident" id="3923769">certName</span><span class="op" id="3923777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3923780">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923783">return</span>&nbsp;<span class="ident" id="3923790">s</span><br>
<span class="lineno"></span><span class="op" id="3923792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3923795">//&nbsp;SystemRootsError&nbsp;results&nbsp;when&nbsp;we&nbsp;fail&nbsp;to&nbsp;load&nbsp;the&nbsp;system&nbsp;root&nbsp;certificates.</span><br>
<span class="lineno"></span><span class="keyword" id="3923874">type</span>&nbsp;<span class="ident" id="3923879">SystemRootsError</span>&nbsp;<span class="keyword" id="3923896">struct</span><span class="op" id="3923902">{</span><span class="op" id="3923903">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="3923906">func</span>&nbsp;<span class="op" id="3923911">(</span><span class="ident" id="3923912">SystemRootsError</span><span class="op" id="3923928">)</span>&nbsp;<span class="ident" id="3923930">Error</span><span class="op" id="3923935">(</span><span class="op" id="3923936">)</span>&nbsp;<span class="builtintype" id="3923938">string</span>&nbsp;<span class="op" id="3923945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3923948">return</span>&nbsp;<span class="string" id="3923955">&#34;x509:&nbsp;failed&nbsp;to&nbsp;load&nbsp;system&nbsp;roots&nbsp;and&nbsp;no&nbsp;roots&nbsp;provided&#34;</span><br>
<span class="lineno"></span><span class="op" id="3924013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="3924016">//&nbsp;VerifyOptions&nbsp;contains&nbsp;parameters&nbsp;for&nbsp;Certificate.Verify.&nbsp;It&#39;s&nbsp;a&nbsp;structure</span><br>
<span class="lineno"></span><span class="comment" id="3924094">//&nbsp;because&nbsp;other&nbsp;PKIX&nbsp;verification&nbsp;APIs&nbsp;have&nbsp;ended&nbsp;up&nbsp;needing&nbsp;many&nbsp;options.</span><br>
<span class="lineno"></span><span class="keyword" id="3924170">type</span>&nbsp;<span class="ident" id="3924175">VerifyOptions</span>&nbsp;<span class="keyword" id="3924189">struct</span>&nbsp;<span class="op" id="3924196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924199">DNSName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3924213">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924221">Intermediates</span>&nbsp;<span class="op" id="3924235">*</span><span class="ident" id="3924236">CertPool</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924246">Roots</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3924260">*</span><span class="ident" id="3924261">CertPool</span>&nbsp;<span class="comment" id="3924270">//&nbsp;if&nbsp;nil,&nbsp;the&nbsp;system&nbsp;roots&nbsp;are&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924308">CurrentTime</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3924322">time</span><span class="op" id="3924326">.</span><span class="ident" id="3924327">Time</span>&nbsp;<span class="comment" id="3924332">//&nbsp;if&nbsp;zero,&nbsp;the&nbsp;current&nbsp;time&nbsp;is&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3924370">//&nbsp;KeyUsage&nbsp;specifies&nbsp;which&nbsp;Extended&nbsp;Key&nbsp;Usage&nbsp;values&nbsp;are&nbsp;acceptable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3924441">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;means&nbsp;ExtKeyUsageServerAuth.&nbsp;Key&nbsp;usage&nbsp;is&nbsp;considered&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3924514">//&nbsp;constraint&nbsp;down&nbsp;the&nbsp;chain&nbsp;which&nbsp;mirrors&nbsp;Windows&nbsp;CryptoAPI&nbsp;behaviour,</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3924587">//&nbsp;but&nbsp;not&nbsp;the&nbsp;spec.&nbsp;To&nbsp;accept&nbsp;any&nbsp;key&nbsp;usage,&nbsp;include&nbsp;ExtKeyUsageAny.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924658">KeyUsages</span>&nbsp;<span class="op" id="3924668">[</span><span class="op" id="3924669">]</span><span class="ident" id="3924670">ExtKeyUsage</span><br>
<span class="lineno"></span><span class="op" id="3924682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3924685">const</span>&nbsp;<span class="op" id="3924691">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924694">leafCertificate</span>&nbsp;<span class="op" id="3924710">=</span>&nbsp;<span class="ident" id="3924712">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924718">intermediateCertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924743">rootCertificate</span><br>
<span class="lineno"></span><span class="op" id="3924759">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="3924762">//&nbsp;isValid&nbsp;performs&nbsp;validity&nbsp;checks&nbsp;on&nbsp;the&nbsp;c.</span><br>
<span class="lineno"></span><span class="keyword" id="3924808">func</span>&nbsp;<span class="op" id="3924813">(</span><span class="ident" id="3924814">c</span>&nbsp;<span class="op" id="3924816">*</span><span class="ident" id="3924817">Certificate</span><span class="op" id="3924828">)</span>&nbsp;<span class="ident" id="3924830">isValid</span><span class="op" id="3924837">(</span><span class="ident" id="3924838">certType</span>&nbsp;<span class="builtintype" id="3924847">int</span><span class="op" id="3924850">,</span>&nbsp;<span class="ident" id="3924852">currentChain</span>&nbsp;<span class="op" id="3924865">[</span><span class="op" id="3924866">]</span><span class="op" id="3924867">*</span><span class="ident" id="3924868">Certificate</span><span class="op" id="3924879">,</span>&nbsp;<span class="ident" id="3924881">opts</span>&nbsp;<span class="op" id="3924886">*</span><span class="ident" id="3924887">VerifyOptions</span><span class="op" id="3924900">)</span>&nbsp;<span class="builtintype" id="3924902">error</span>&nbsp;<span class="op" id="3924908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924911">now</span>&nbsp;<span class="op" id="3924915">:=</span>&nbsp;<span class="ident" id="3924918">opts</span><span class="op" id="3924922">.</span><span class="ident" id="3924923">CurrentTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924936">if</span>&nbsp;<span class="ident" id="3924939">now</span><span class="op" id="3924942">.</span><span class="ident" id="3924943">IsZero</span><span class="op" id="3924949">(</span><span class="op" id="3924950">)</span>&nbsp;<span class="op" id="3924952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924956">now</span>&nbsp;<span class="op" id="3924960">=</span>&nbsp;<span class="ident" id="3924962">time</span><span class="op" id="3924966">.</span><span class="ident" id="3924967">Now</span><span class="op" id="3924970">(</span><span class="op" id="3924971">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3924974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3924977">if</span>&nbsp;<span class="ident" id="3924980">now</span><span class="op" id="3924983">.</span><span class="ident" id="3924984">Before</span><span class="op" id="3924990">(</span><span class="ident" id="3924991">c</span><span class="op" id="3924992">.</span><span class="ident" id="3924993">NotBefore</span><span class="op" id="3925002">)</span>&nbsp;<span class="op" id="3925004">||</span>&nbsp;<span class="ident" id="3925007">now</span><span class="op" id="3925010">.</span><span class="ident" id="3925011">After</span><span class="op" id="3925016">(</span><span class="ident" id="3925017">c</span><span class="op" id="3925018">.</span><span class="ident" id="3925019">NotAfter</span><span class="op" id="3925027">)</span>&nbsp;<span class="op" id="3925029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925033">return</span>&nbsp;<span class="ident" id="3925040">CertificateInvalidError</span><span class="op" id="3925063">{</span><span class="ident" id="3925064">c</span><span class="op" id="3925065">,</span>&nbsp;<span class="ident" id="3925067">Expired</span><span class="op" id="3925074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925081">if</span>&nbsp;<span class="builtinfunc" id="3925084">len</span><span class="op" id="3925087">(</span><span class="ident" id="3925088">c</span><span class="op" id="3925089">.</span><span class="ident" id="3925090">PermittedDNSDomains</span><span class="op" id="3925109">)</span>&nbsp;<span class="op" id="3925111">&gt;</span>&nbsp;<span class="num" id="3925113">0</span>&nbsp;<span class="op" id="3925115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925119">ok</span>&nbsp;<span class="op" id="3925122">:=</span>&nbsp;<span class="builtintype" id="3925125">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925133">for</span>&nbsp;<span class="ident" id="3925137">_</span><span class="op" id="3925138">,</span>&nbsp;<span class="ident" id="3925140">domain</span>&nbsp;<span class="op" id="3925147">:=</span>&nbsp;<span class="keyword" id="3925150">range</span>&nbsp;<span class="ident" id="3925156">c</span><span class="op" id="3925157">.</span><span class="ident" id="3925158">PermittedDNSDomains</span>&nbsp;<span class="op" id="3925178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925183">if</span>&nbsp;<span class="ident" id="3925186">opts</span><span class="op" id="3925190">.</span><span class="ident" id="3925191">DNSName</span>&nbsp;<span class="op" id="3925199">==</span>&nbsp;<span class="ident" id="3925202">domain</span>&nbsp;<span class="op" id="3925209">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925216">(</span><span class="ident" id="3925217">strings</span><span class="op" id="3925224">.</span><span class="ident" id="3925225">HasSuffix</span><span class="op" id="3925234">(</span><span class="ident" id="3925235">opts</span><span class="op" id="3925239">.</span><span class="ident" id="3925240">DNSName</span><span class="op" id="3925247">,</span>&nbsp;<span class="ident" id="3925249">domain</span><span class="op" id="3925255">)</span>&nbsp;<span class="op" id="3925257">&amp;&amp;</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3925265">len</span><span class="op" id="3925268">(</span><span class="ident" id="3925269">opts</span><span class="op" id="3925273">.</span><span class="ident" id="3925274">DNSName</span><span class="op" id="3925281">)</span>&nbsp;<span class="op" id="3925283">&gt;=</span>&nbsp;<span class="num" id="3925286">1</span><span class="op" id="3925287">+</span><span class="builtinfunc" id="3925288">len</span><span class="op" id="3925291">(</span><span class="ident" id="3925292">domain</span><span class="op" id="3925298">)</span>&nbsp;<span class="op" id="3925300">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925308">opts</span><span class="op" id="3925312">.</span><span class="ident" id="3925313">DNSName</span><span class="op" id="3925320">[</span><span class="builtinfunc" id="3925321">len</span><span class="op" id="3925324">(</span><span class="ident" id="3925325">opts</span><span class="op" id="3925329">.</span><span class="ident" id="3925330">DNSName</span><span class="op" id="3925337">)</span><span class="op" id="3925338">-</span><span class="builtinfunc" id="3925339">len</span><span class="op" id="3925342">(</span><span class="ident" id="3925343">domain</span><span class="op" id="3925349">)</span><span class="op" id="3925350">-</span><span class="num" id="3925351">1</span><span class="op" id="3925352">]</span>&nbsp;<span class="op" id="3925354">==</span>&nbsp;<span class="string" id="3925357">&#39;.&#39;</span><span class="op" id="3925360">)</span>&nbsp;<span class="op" id="3925362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3925368">ok</span>&nbsp;<span class="op" id="3925371">=</span>&nbsp;<span class="builtintype" id="3925373">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925382">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925391">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925400">if</span>&nbsp;<span class="op" id="3925403">!</span><span class="ident" id="3925404">ok</span>&nbsp;<span class="op" id="3925407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3925412">return</span>&nbsp;<span class="ident" id="3925419">CertificateInvalidError</span><span class="op" id="3925442">{</span><span class="ident" id="3925443">c</span><span class="op" id="3925444">,</span>&nbsp;<span class="ident" id="3925446">CANotAuthorizedForThisName</span><span class="op" id="3925472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925476">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3925479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925483">//&nbsp;KeyUsage&nbsp;status&nbsp;flags&nbsp;are&nbsp;ignored.&nbsp;From&nbsp;Engineering&nbsp;Security,&nbsp;Peter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925555">//&nbsp;Gutmann:&nbsp;A&nbsp;European&nbsp;government&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signing&nbsp;certificates&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925628">//&nbsp;being&nbsp;valid&nbsp;for&nbsp;encryption&nbsp;only,&nbsp;but&nbsp;no-one&nbsp;noticed.&nbsp;Another</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925693">//&nbsp;European&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signature&nbsp;keys&nbsp;as&nbsp;not&nbsp;being&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925758">//&nbsp;signatures.&nbsp;A&nbsp;different&nbsp;CA&nbsp;marked&nbsp;its&nbsp;own&nbsp;trusted&nbsp;root&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925829">//&nbsp;as&nbsp;being&nbsp;invalid&nbsp;for&nbsp;certificate&nbsp;signing.&nbsp;&nbsp;Another&nbsp;national&nbsp;CA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925896">//&nbsp;distributed&nbsp;a&nbsp;certificate&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3925961">//&nbsp;country’s&nbsp;tax&nbsp;authority&nbsp;that&nbsp;was&nbsp;marked&nbsp;as&nbsp;only&nbsp;being&nbsp;usable&nbsp;for</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3926032">//&nbsp;digital&nbsp;signatures&nbsp;but&nbsp;not&nbsp;for&nbsp;encryption.&nbsp;Yet&nbsp;another&nbsp;CA&nbsp;reversed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3926103">//&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bit&nbsp;flags&nbsp;in&nbsp;the&nbsp;keyUsage&nbsp;due&nbsp;to&nbsp;confusion&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3926172">//&nbsp;encoding&nbsp;endianness,&nbsp;essentially&nbsp;setting&nbsp;a&nbsp;random&nbsp;keyUsage&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3926238">//&nbsp;certificates&nbsp;that&nbsp;it&nbsp;issued.&nbsp;Another&nbsp;CA&nbsp;created&nbsp;a&nbsp;self-invalidating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3926310">//&nbsp;certificate&nbsp;by&nbsp;adding&nbsp;a&nbsp;certificate&nbsp;policy&nbsp;statement&nbsp;stipulating</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3926379">//&nbsp;that&nbsp;the&nbsp;certificate&nbsp;had&nbsp;to&nbsp;be&nbsp;used&nbsp;strictly&nbsp;as&nbsp;specified&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3926448">//&nbsp;keyUsage,&nbsp;and&nbsp;a&nbsp;keyUsage&nbsp;containing&nbsp;a&nbsp;flag&nbsp;indicating&nbsp;that&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3926519">//&nbsp;encryption&nbsp;key&nbsp;could&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;Diffie-Hellman&nbsp;key&nbsp;agreement.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926592">if</span>&nbsp;<span class="ident" id="3926595">certType</span>&nbsp;<span class="op" id="3926604">==</span>&nbsp;<span class="ident" id="3926607">intermediateCertificate</span>&nbsp;<span class="op" id="3926631">&amp;&amp;</span>&nbsp;<span class="op" id="3926634">(</span><span class="op" id="3926635">!</span><span class="ident" id="3926636">c</span><span class="op" id="3926637">.</span><span class="ident" id="3926638">BasicConstraintsValid</span>&nbsp;<span class="op" id="3926660">||</span>&nbsp;<span class="op" id="3926663">!</span><span class="ident" id="3926664">c</span><span class="op" id="3926665">.</span><span class="ident" id="3926666">IsCA</span><span class="op" id="3926670">)</span>&nbsp;<span class="op" id="3926672">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926676">return</span>&nbsp;<span class="ident" id="3926683">CertificateInvalidError</span><span class="op" id="3926706">{</span><span class="ident" id="3926707">c</span><span class="op" id="3926708">,</span>&nbsp;<span class="ident" id="3926710">NotAuthorizedToSign</span><span class="op" id="3926729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3926732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926736">if</span>&nbsp;<span class="ident" id="3926739">c</span><span class="op" id="3926740">.</span><span class="ident" id="3926741">BasicConstraintsValid</span>&nbsp;<span class="op" id="3926763">&amp;&amp;</span>&nbsp;<span class="ident" id="3926766">c</span><span class="op" id="3926767">.</span><span class="ident" id="3926768">MaxPathLen</span>&nbsp;<span class="op" id="3926779">&gt;=</span>&nbsp;<span class="num" id="3926782">0</span>&nbsp;<span class="op" id="3926784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3926788">numIntermediates</span>&nbsp;<span class="op" id="3926805">:=</span>&nbsp;<span class="builtinfunc" id="3926808">len</span><span class="op" id="3926811">(</span><span class="ident" id="3926812">currentChain</span><span class="op" id="3926824">)</span>&nbsp;<span class="op" id="3926826">-</span>&nbsp;<span class="num" id="3926828">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926832">if</span>&nbsp;<span class="ident" id="3926835">numIntermediates</span>&nbsp;<span class="op" id="3926852">&gt;</span>&nbsp;<span class="ident" id="3926854">c</span><span class="op" id="3926855">.</span><span class="ident" id="3926856">MaxPathLen</span>&nbsp;<span class="op" id="3926867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926872">return</span>&nbsp;<span class="ident" id="3926879">CertificateInvalidError</span><span class="op" id="3926902">{</span><span class="ident" id="3926903">c</span><span class="op" id="3926904">,</span>&nbsp;<span class="ident" id="3926906">TooManyIntermediates</span><span class="op" id="3926926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3926930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3926933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3926937">return</span>&nbsp;<span class="builtintype" id="3926944">nil</span><br>
<span class="lineno"></span><span class="op" id="3926948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3926951">//&nbsp;Verify&nbsp;attempts&nbsp;to&nbsp;verify&nbsp;c&nbsp;by&nbsp;building&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;from&nbsp;c&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3927025">//&nbsp;certificate&nbsp;in&nbsp;opts.Roots,&nbsp;using&nbsp;certificates&nbsp;in&nbsp;opts.Intermediates&nbsp;if</span><br>
<span class="lineno">205</span><span class="comment" id="3927099">//&nbsp;needed.&nbsp;If&nbsp;successful,&nbsp;it&nbsp;returns&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;where&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="3927171">//&nbsp;element&nbsp;of&nbsp;the&nbsp;chain&nbsp;is&nbsp;c&nbsp;and&nbsp;the&nbsp;last&nbsp;element&nbsp;is&nbsp;from&nbsp;opts.Roots.</span><br>
<span class="lineno"></span><span class="comment" id="3927241">//</span><br>
<span class="lineno"></span><span class="comment" id="3927244">//&nbsp;If&nbsp;opts.Roots&nbsp;is&nbsp;nil&nbsp;and&nbsp;system&nbsp;roots&nbsp;are&nbsp;unavailable&nbsp;the&nbsp;returned&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3927320">//&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;SystemRootsError.</span><br>
<span class="lineno">210</span><span class="comment" id="3927357">//</span><br>
<span class="lineno"></span><span class="comment" id="3927360">//&nbsp;WARNING:&nbsp;this&nbsp;doesn&#39;t&nbsp;do&nbsp;any&nbsp;revocation&nbsp;checking.</span><br>
<span class="lineno"></span><span class="keyword" id="3927413">func</span>&nbsp;<span class="op" id="3927418">(</span><span class="ident" id="3927419">c</span>&nbsp;<span class="op" id="3927421">*</span><span class="ident" id="3927422">Certificate</span><span class="op" id="3927433">)</span>&nbsp;<span class="ident" id="3927435">Verify</span><span class="op" id="3927441">(</span><span class="ident" id="3927442">opts</span>&nbsp;<span class="ident" id="3927447">VerifyOptions</span><span class="op" id="3927460">)</span>&nbsp;<span class="op" id="3927462">(</span><span class="ident" id="3927463">chains</span>&nbsp;<span class="op" id="3927470">[</span><span class="op" id="3927471">]</span><span class="op" id="3927472">[</span><span class="op" id="3927473">]</span><span class="op" id="3927474">*</span><span class="ident" id="3927475">Certificate</span><span class="op" id="3927486">,</span>&nbsp;<span class="ident" id="3927488">err</span>&nbsp;<span class="builtintype" id="3927492">error</span><span class="op" id="3927497">)</span>&nbsp;<span class="op" id="3927499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3927502">//&nbsp;Use&nbsp;Windows&#39;s&nbsp;own&nbsp;verification&nbsp;and&nbsp;chain&nbsp;building.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927557">if</span>&nbsp;<span class="ident" id="3927560">opts</span><span class="op" id="3927564">.</span><span class="ident" id="3927565">Roots</span>&nbsp;<span class="op" id="3927571">==</span>&nbsp;<span class="builtintype" id="3927574">nil</span>&nbsp;<span class="op" id="3927578">&amp;&amp;</span>&nbsp;<span class="ident" id="3927581">runtime</span><span class="op" id="3927588">.</span><span class="ident" id="3927589">GOOS</span>&nbsp;<span class="op" id="3927594">==</span>&nbsp;<span class="string" id="3927597">&#34;windows&#34;</span>&nbsp;<span class="op" id="3927607">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927611">return</span>&nbsp;<span class="ident" id="3927618">c</span><span class="op" id="3927619">.</span><span class="ident" id="3927620">systemVerify</span><span class="op" id="3927632">(</span><span class="op" id="3927633">&amp;</span><span class="ident" id="3927634">opts</span><span class="op" id="3927638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3927641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927645">if</span>&nbsp;<span class="ident" id="3927648">opts</span><span class="op" id="3927652">.</span><span class="ident" id="3927653">Roots</span>&nbsp;<span class="op" id="3927659">==</span>&nbsp;<span class="builtintype" id="3927662">nil</span>&nbsp;<span class="op" id="3927666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927670">opts</span><span class="op" id="3927674">.</span><span class="ident" id="3927675">Roots</span>&nbsp;<span class="op" id="3927681">=</span>&nbsp;<span class="ident" id="3927683">systemRootsPool</span><span class="op" id="3927698">(</span><span class="op" id="3927699">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927703">if</span>&nbsp;<span class="ident" id="3927706">opts</span><span class="op" id="3927710">.</span><span class="ident" id="3927711">Roots</span>&nbsp;<span class="op" id="3927717">==</span>&nbsp;<span class="builtintype" id="3927720">nil</span>&nbsp;<span class="op" id="3927724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927729">return</span>&nbsp;<span class="builtintype" id="3927736">nil</span><span class="op" id="3927739">,</span>&nbsp;<span class="ident" id="3927741">SystemRootsError</span><span class="op" id="3927757">{</span><span class="op" id="3927758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3927762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3927765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927769">err</span>&nbsp;<span class="op" id="3927773">=</span>&nbsp;<span class="ident" id="3927775">c</span><span class="op" id="3927776">.</span><span class="ident" id="3927777">isValid</span><span class="op" id="3927784">(</span><span class="ident" id="3927785">leafCertificate</span><span class="op" id="3927800">,</span>&nbsp;<span class="builtintype" id="3927802">nil</span><span class="op" id="3927805">,</span>&nbsp;<span class="op" id="3927807">&amp;</span><span class="ident" id="3927808">opts</span><span class="op" id="3927812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927815">if</span>&nbsp;<span class="ident" id="3927818">err</span>&nbsp;<span class="op" id="3927822">!=</span>&nbsp;<span class="builtintype" id="3927825">nil</span>&nbsp;<span class="op" id="3927829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927833">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3927841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927845">if</span>&nbsp;<span class="builtinfunc" id="3927848">len</span><span class="op" id="3927851">(</span><span class="ident" id="3927852">opts</span><span class="op" id="3927856">.</span><span class="ident" id="3927857">DNSName</span><span class="op" id="3927864">)</span>&nbsp;<span class="op" id="3927866">&gt;</span>&nbsp;<span class="num" id="3927868">0</span>&nbsp;<span class="op" id="3927870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927874">err</span>&nbsp;<span class="op" id="3927878">=</span>&nbsp;<span class="ident" id="3927880">c</span><span class="op" id="3927881">.</span><span class="ident" id="3927882">VerifyHostname</span><span class="op" id="3927896">(</span><span class="ident" id="3927897">opts</span><span class="op" id="3927901">.</span><span class="ident" id="3927902">DNSName</span><span class="op" id="3927909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927913">if</span>&nbsp;<span class="ident" id="3927916">err</span>&nbsp;<span class="op" id="3927920">!=</span>&nbsp;<span class="builtintype" id="3927923">nil</span>&nbsp;<span class="op" id="3927927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3927932">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3927941">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3927944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3927948">candidateChains</span><span class="op" id="3927963">,</span>&nbsp;<span class="ident" id="3927965">err</span>&nbsp;<span class="op" id="3927969">:=</span>&nbsp;<span class="ident" id="3927972">c</span><span class="op" id="3927973">.</span><span class="ident" id="3927974">buildChains</span><span class="op" id="3927985">(</span><span class="builtinfunc" id="3927986">make</span><span class="op" id="3927990">(</span><span class="keyword" id="3927991">map</span><span class="op" id="3927994">[</span><span class="builtintype" id="3927995">int</span><span class="op" id="3927998">]</span><span class="op" id="3927999">[</span><span class="op" id="3928000">]</span><span class="op" id="3928001">[</span><span class="op" id="3928002">]</span><span class="op" id="3928003">*</span><span class="ident" id="3928004">Certificate</span><span class="op" id="3928015">)</span><span class="op" id="3928016">,</span>&nbsp;<span class="op" id="3928018">[</span><span class="op" id="3928019">]</span><span class="op" id="3928020">*</span><span class="ident" id="3928021">Certificate</span><span class="op" id="3928032">{</span><span class="ident" id="3928033">c</span><span class="op" id="3928034">}</span><span class="op" id="3928035">,</span>&nbsp;<span class="op" id="3928037">&amp;</span><span class="ident" id="3928038">opts</span><span class="op" id="3928042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928045">if</span>&nbsp;<span class="ident" id="3928048">err</span>&nbsp;<span class="op" id="3928052">!=</span>&nbsp;<span class="builtintype" id="3928055">nil</span>&nbsp;<span class="op" id="3928059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928063">return</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3928075">keyUsages</span>&nbsp;<span class="op" id="3928085">:=</span>&nbsp;<span class="ident" id="3928088">opts</span><span class="op" id="3928092">.</span><span class="ident" id="3928093">KeyUsages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928104">if</span>&nbsp;<span class="builtinfunc" id="3928107">len</span><span class="op" id="3928110">(</span><span class="ident" id="3928111">keyUsages</span><span class="op" id="3928120">)</span>&nbsp;<span class="op" id="3928122">==</span>&nbsp;<span class="num" id="3928125">0</span>&nbsp;<span class="op" id="3928127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3928131">keyUsages</span>&nbsp;<span class="op" id="3928141">=</span>&nbsp;<span class="op" id="3928143">[</span><span class="op" id="3928144">]</span><span class="ident" id="3928145">ExtKeyUsage</span><span class="op" id="3928156">{</span><span class="ident" id="3928157">ExtKeyUsageServerAuth</span><span class="op" id="3928178">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3928185">//&nbsp;If&nbsp;any&nbsp;key&nbsp;usage&nbsp;is&nbsp;acceptable&nbsp;then&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928237">for</span>&nbsp;<span class="ident" id="3928241">_</span><span class="op" id="3928242">,</span>&nbsp;<span class="ident" id="3928244">usage</span>&nbsp;<span class="op" id="3928250">:=</span>&nbsp;<span class="keyword" id="3928253">range</span>&nbsp;<span class="ident" id="3928259">keyUsages</span>&nbsp;<span class="op" id="3928269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928273">if</span>&nbsp;<span class="ident" id="3928276">usage</span>&nbsp;<span class="op" id="3928282">==</span>&nbsp;<span class="ident" id="3928285">ExtKeyUsageAny</span>&nbsp;<span class="op" id="3928300">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3928305">chains</span>&nbsp;<span class="op" id="3928312">=</span>&nbsp;<span class="ident" id="3928314">candidateChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928333">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928349">for</span>&nbsp;<span class="ident" id="3928353">_</span><span class="op" id="3928354">,</span>&nbsp;<span class="ident" id="3928356">candidate</span>&nbsp;<span class="op" id="3928366">:=</span>&nbsp;<span class="keyword" id="3928369">range</span>&nbsp;<span class="ident" id="3928375">candidateChains</span>&nbsp;<span class="op" id="3928391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928395">if</span>&nbsp;<span class="ident" id="3928398">checkChainForKeyUsage</span><span class="op" id="3928419">(</span><span class="ident" id="3928420">candidate</span><span class="op" id="3928429">,</span>&nbsp;<span class="ident" id="3928431">keyUsages</span><span class="op" id="3928440">)</span>&nbsp;<span class="op" id="3928442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3928447">chains</span>&nbsp;<span class="op" id="3928454">=</span>&nbsp;<span class="builtinfunc" id="3928456">append</span><span class="op" id="3928462">(</span><span class="ident" id="3928463">chains</span><span class="op" id="3928469">,</span>&nbsp;<span class="ident" id="3928471">candidate</span><span class="op" id="3928480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928487">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928491">if</span>&nbsp;<span class="builtinfunc" id="3928494">len</span><span class="op" id="3928497">(</span><span class="ident" id="3928498">chains</span><span class="op" id="3928504">)</span>&nbsp;<span class="op" id="3928506">==</span>&nbsp;<span class="num" id="3928509">0</span>&nbsp;<span class="op" id="3928511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3928515">err</span>&nbsp;<span class="op" id="3928519">=</span>&nbsp;<span class="ident" id="3928521">CertificateInvalidError</span><span class="op" id="3928544">{</span><span class="ident" id="3928545">c</span><span class="op" id="3928546">,</span>&nbsp;<span class="ident" id="3928548">IncompatibleUsage</span><span class="op" id="3928565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3928568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928572">return</span><br>
<span class="lineno"></span><span class="op" id="3928579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3928582">func</span>&nbsp;<span class="ident" id="3928587">appendToFreshChain</span><span class="op" id="3928605">(</span><span class="ident" id="3928606">chain</span>&nbsp;<span class="op" id="3928612">[</span><span class="op" id="3928613">]</span><span class="op" id="3928614">*</span><span class="ident" id="3928615">Certificate</span><span class="op" id="3928626">,</span>&nbsp;<span class="ident" id="3928628">cert</span>&nbsp;<span class="op" id="3928633">*</span><span class="ident" id="3928634">Certificate</span><span class="op" id="3928645">)</span>&nbsp;<span class="op" id="3928647">[</span><span class="op" id="3928648">]</span><span class="op" id="3928649">*</span><span class="ident" id="3928650">Certificate</span>&nbsp;<span class="op" id="3928662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3928665">n</span>&nbsp;<span class="op" id="3928667">:=</span>&nbsp;<span class="builtinfunc" id="3928670">make</span><span class="op" id="3928674">(</span><span class="op" id="3928675">[</span><span class="op" id="3928676">]</span><span class="op" id="3928677">*</span><span class="ident" id="3928678">Certificate</span><span class="op" id="3928689">,</span>&nbsp;<span class="builtinfunc" id="3928691">len</span><span class="op" id="3928694">(</span><span class="ident" id="3928695">chain</span><span class="op" id="3928700">)</span><span class="op" id="3928701">+</span><span class="num" id="3928702">1</span><span class="op" id="3928703">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3928706">copy</span><span class="op" id="3928710">(</span><span class="ident" id="3928711">n</span><span class="op" id="3928712">,</span>&nbsp;<span class="ident" id="3928714">chain</span><span class="op" id="3928719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3928722">n</span><span class="op" id="3928723">[</span><span class="builtinfunc" id="3928724">len</span><span class="op" id="3928727">(</span><span class="ident" id="3928728">chain</span><span class="op" id="3928733">)</span><span class="op" id="3928734">]</span>&nbsp;<span class="op" id="3928736">=</span>&nbsp;<span class="ident" id="3928738">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928744">return</span>&nbsp;<span class="ident" id="3928751">n</span><br>
<span class="lineno"></span><span class="op" id="3928753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="3928756">func</span>&nbsp;<span class="op" id="3928761">(</span><span class="ident" id="3928762">c</span>&nbsp;<span class="op" id="3928764">*</span><span class="ident" id="3928765">Certificate</span><span class="op" id="3928776">)</span>&nbsp;<span class="ident" id="3928778">buildChains</span><span class="op" id="3928789">(</span><span class="ident" id="3928790">cache</span>&nbsp;<span class="keyword" id="3928796">map</span><span class="op" id="3928799">[</span><span class="builtintype" id="3928800">int</span><span class="op" id="3928803">]</span><span class="op" id="3928804">[</span><span class="op" id="3928805">]</span><span class="op" id="3928806">[</span><span class="op" id="3928807">]</span><span class="op" id="3928808">*</span><span class="ident" id="3928809">Certificate</span><span class="op" id="3928820">,</span>&nbsp;<span class="ident" id="3928822">currentChain</span>&nbsp;<span class="op" id="3928835">[</span><span class="op" id="3928836">]</span><span class="op" id="3928837">*</span><span class="ident" id="3928838">Certificate</span><span class="op" id="3928849">,</span>&nbsp;<span class="ident" id="3928851">opts</span>&nbsp;<span class="op" id="3928856">*</span><span class="ident" id="3928857">VerifyOptions</span><span class="op" id="3928870">)</span>&nbsp;<span class="op" id="3928872">(</span><span class="ident" id="3928873">chains</span>&nbsp;<span class="op" id="3928880">[</span><span class="op" id="3928881">]</span><span class="op" id="3928882">[</span><span class="op" id="3928883">]</span><span class="op" id="3928884">*</span><span class="ident" id="3928885">Certificate</span><span class="op" id="3928896">,</span>&nbsp;<span class="ident" id="3928898">err</span>&nbsp;<span class="builtintype" id="3928902">error</span><span class="op" id="3928907">)</span>&nbsp;<span class="op" id="3928909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3928912">possibleRoots</span><span class="op" id="3928925">,</span>&nbsp;<span class="ident" id="3928927">failedRoot</span><span class="op" id="3928937">,</span>&nbsp;<span class="ident" id="3928939">rootErr</span>&nbsp;<span class="op" id="3928947">:=</span>&nbsp;<span class="ident" id="3928950">opts</span><span class="op" id="3928954">.</span><span class="ident" id="3928955">Roots</span><span class="op" id="3928960">.</span><span class="ident" id="3928961">findVerifiedParents</span><span class="op" id="3928980">(</span><span class="ident" id="3928981">c</span><span class="op" id="3928982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3928985">for</span>&nbsp;<span class="ident" id="3928989">_</span><span class="op" id="3928990">,</span>&nbsp;<span class="ident" id="3928992">rootNum</span>&nbsp;<span class="op" id="3929000">:=</span>&nbsp;<span class="keyword" id="3929003">range</span>&nbsp;<span class="ident" id="3929009">possibleRoots</span>&nbsp;<span class="op" id="3929023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929027">root</span>&nbsp;<span class="op" id="3929032">:=</span>&nbsp;<span class="ident" id="3929035">opts</span><span class="op" id="3929039">.</span><span class="ident" id="3929040">Roots</span><span class="op" id="3929045">.</span><span class="ident" id="3929046">certs</span><span class="op" id="3929051">[</span><span class="ident" id="3929052">rootNum</span><span class="op" id="3929059">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929063">err</span>&nbsp;<span class="op" id="3929067">=</span>&nbsp;<span class="ident" id="3929069">root</span><span class="op" id="3929073">.</span><span class="ident" id="3929074">isValid</span><span class="op" id="3929081">(</span><span class="ident" id="3929082">rootCertificate</span><span class="op" id="3929097">,</span>&nbsp;<span class="ident" id="3929099">currentChain</span><span class="op" id="3929111">,</span>&nbsp;<span class="ident" id="3929113">opts</span><span class="op" id="3929117">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929121">if</span>&nbsp;<span class="ident" id="3929124">err</span>&nbsp;<span class="op" id="3929128">!=</span>&nbsp;<span class="builtintype" id="3929131">nil</span>&nbsp;<span class="op" id="3929135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929140">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929155">chains</span>&nbsp;<span class="op" id="3929162">=</span>&nbsp;<span class="builtinfunc" id="3929164">append</span><span class="op" id="3929170">(</span><span class="ident" id="3929171">chains</span><span class="op" id="3929177">,</span>&nbsp;<span class="ident" id="3929179">appendToFreshChain</span><span class="op" id="3929197">(</span><span class="ident" id="3929198">currentChain</span><span class="op" id="3929210">,</span>&nbsp;<span class="ident" id="3929212">root</span><span class="op" id="3929216">)</span><span class="op" id="3929217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929220">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929224">possibleIntermediates</span><span class="op" id="3929245">,</span>&nbsp;<span class="ident" id="3929247">failedIntermediate</span><span class="op" id="3929265">,</span>&nbsp;<span class="ident" id="3929267">intermediateErr</span>&nbsp;<span class="op" id="3929283">:=</span>&nbsp;<span class="ident" id="3929286">opts</span><span class="op" id="3929290">.</span><span class="ident" id="3929291">Intermediates</span><span class="op" id="3929304">.</span><span class="ident" id="3929305">findVerifiedParents</span><span class="op" id="3929324">(</span><span class="ident" id="3929325">c</span><span class="op" id="3929326">)</span><br>
<span class="lineno"></span><span class="ident" id="3929328">nextIntermediate</span><span class="op" id="3929344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929347">for</span>&nbsp;<span class="ident" id="3929351">_</span><span class="op" id="3929352">,</span>&nbsp;<span class="ident" id="3929354">intermediateNum</span>&nbsp;<span class="op" id="3929370">:=</span>&nbsp;<span class="keyword" id="3929373">range</span>&nbsp;<span class="ident" id="3929379">possibleIntermediates</span>&nbsp;<span class="op" id="3929401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929405">intermediate</span>&nbsp;<span class="op" id="3929418">:=</span>&nbsp;<span class="ident" id="3929421">opts</span><span class="op" id="3929425">.</span><span class="ident" id="3929426">Intermediates</span><span class="op" id="3929439">.</span><span class="ident" id="3929440">certs</span><span class="op" id="3929445">[</span><span class="ident" id="3929446">intermediateNum</span><span class="op" id="3929461">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929465">for</span>&nbsp;<span class="ident" id="3929469">_</span><span class="op" id="3929470">,</span>&nbsp;<span class="ident" id="3929472">cert</span>&nbsp;<span class="op" id="3929477">:=</span>&nbsp;<span class="keyword" id="3929480">range</span>&nbsp;<span class="ident" id="3929486">currentChain</span>&nbsp;<span class="op" id="3929499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929504">if</span>&nbsp;<span class="ident" id="3929507">cert</span>&nbsp;<span class="op" id="3929512">==</span>&nbsp;<span class="ident" id="3929515">intermediate</span>&nbsp;<span class="op" id="3929528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929534">continue</span>&nbsp;<span class="ident" id="3929543">nextIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929567">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929571">err</span>&nbsp;<span class="op" id="3929575">=</span>&nbsp;<span class="ident" id="3929577">intermediate</span><span class="op" id="3929589">.</span><span class="ident" id="3929590">isValid</span><span class="op" id="3929597">(</span><span class="ident" id="3929598">intermediateCertificate</span><span class="op" id="3929621">,</span>&nbsp;<span class="ident" id="3929623">currentChain</span><span class="op" id="3929635">,</span>&nbsp;<span class="ident" id="3929637">opts</span><span class="op" id="3929641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929645">if</span>&nbsp;<span class="ident" id="3929648">err</span>&nbsp;<span class="op" id="3929652">!=</span>&nbsp;<span class="builtintype" id="3929655">nil</span>&nbsp;<span class="op" id="3929659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929664">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929679">var</span>&nbsp;<span class="ident" id="3929683">childChains</span>&nbsp;<span class="op" id="3929695">[</span><span class="op" id="3929696">]</span><span class="op" id="3929697">[</span><span class="op" id="3929698">]</span><span class="op" id="3929699">*</span><span class="ident" id="3929700">Certificate</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929714">childChains</span><span class="op" id="3929725">,</span>&nbsp;<span class="ident" id="3929727">ok</span>&nbsp;<span class="op" id="3929730">:=</span>&nbsp;<span class="ident" id="3929733">cache</span><span class="op" id="3929738">[</span><span class="ident" id="3929739">intermediateNum</span><span class="op" id="3929754">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929758">if</span>&nbsp;<span class="op" id="3929761">!</span><span class="ident" id="3929762">ok</span>&nbsp;<span class="op" id="3929765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929770">childChains</span><span class="op" id="3929781">,</span>&nbsp;<span class="ident" id="3929783">err</span>&nbsp;<span class="op" id="3929787">=</span>&nbsp;<span class="ident" id="3929789">intermediate</span><span class="op" id="3929801">.</span><span class="ident" id="3929802">buildChains</span><span class="op" id="3929813">(</span><span class="ident" id="3929814">cache</span><span class="op" id="3929819">,</span>&nbsp;<span class="ident" id="3929821">appendToFreshChain</span><span class="op" id="3929839">(</span><span class="ident" id="3929840">currentChain</span><span class="op" id="3929852">,</span>&nbsp;<span class="ident" id="3929854">intermediate</span><span class="op" id="3929866">)</span><span class="op" id="3929867">,</span>&nbsp;<span class="ident" id="3929869">opts</span><span class="op" id="3929873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929878">cache</span><span class="op" id="3929883">[</span><span class="ident" id="3929884">intermediateNum</span><span class="op" id="3929899">]</span>&nbsp;<span class="op" id="3929901">=</span>&nbsp;<span class="ident" id="3929903">childChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929917">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929921">chains</span>&nbsp;<span class="op" id="3929928">=</span>&nbsp;<span class="builtinfunc" id="3929930">append</span><span class="op" id="3929936">(</span><span class="ident" id="3929937">chains</span><span class="op" id="3929943">,</span>&nbsp;<span class="ident" id="3929945">childChains</span><span class="op" id="3929956">...</span><span class="op" id="3929959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3929966">if</span>&nbsp;<span class="builtinfunc" id="3929969">len</span><span class="op" id="3929972">(</span><span class="ident" id="3929973">chains</span><span class="op" id="3929979">)</span>&nbsp;<span class="op" id="3929981">&gt;</span>&nbsp;<span class="num" id="3929983">0</span>&nbsp;<span class="op" id="3929985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929989">err</span>&nbsp;<span class="op" id="3929993">=</span>&nbsp;<span class="builtintype" id="3929995">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930004">if</span>&nbsp;<span class="builtinfunc" id="3930007">len</span><span class="op" id="3930010">(</span><span class="ident" id="3930011">chains</span><span class="op" id="3930017">)</span>&nbsp;<span class="op" id="3930019">==</span>&nbsp;<span class="num" id="3930022">0</span>&nbsp;<span class="op" id="3930024">&amp;&amp;</span>&nbsp;<span class="ident" id="3930027">err</span>&nbsp;<span class="op" id="3930031">==</span>&nbsp;<span class="builtintype" id="3930034">nil</span>&nbsp;<span class="op" id="3930038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930042">hintErr</span>&nbsp;<span class="op" id="3930050">:=</span>&nbsp;<span class="ident" id="3930053">rootErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930063">hintCert</span>&nbsp;<span class="op" id="3930072">:=</span>&nbsp;<span class="ident" id="3930075">failedRoot</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930088">if</span>&nbsp;<span class="ident" id="3930091">hintErr</span>&nbsp;<span class="op" id="3930099">==</span>&nbsp;<span class="builtintype" id="3930102">nil</span>&nbsp;<span class="op" id="3930106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930111">hintErr</span>&nbsp;<span class="op" id="3930119">=</span>&nbsp;<span class="ident" id="3930121">intermediateErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930140">hintCert</span>&nbsp;<span class="op" id="3930149">=</span>&nbsp;<span class="ident" id="3930151">failedIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930176">err</span>&nbsp;<span class="op" id="3930180">=</span>&nbsp;<span class="ident" id="3930182">UnknownAuthorityError</span><span class="op" id="3930203">{</span><span class="ident" id="3930204">c</span><span class="op" id="3930205">,</span>&nbsp;<span class="ident" id="3930207">hintErr</span><span class="op" id="3930214">,</span>&nbsp;<span class="ident" id="3930216">hintCert</span><span class="op" id="3930224">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930231">return</span><br>
<span class="lineno"></span><span class="op" id="3930238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="keyword" id="3930241">func</span>&nbsp;<span class="ident" id="3930246">matchHostnames</span><span class="op" id="3930260">(</span><span class="ident" id="3930261">pattern</span><span class="op" id="3930268">,</span>&nbsp;<span class="ident" id="3930270">host</span>&nbsp;<span class="builtintype" id="3930275">string</span><span class="op" id="3930281">)</span>&nbsp;<span class="builtintype" id="3930283">bool</span>&nbsp;<span class="op" id="3930288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930291">if</span>&nbsp;<span class="builtinfunc" id="3930294">len</span><span class="op" id="3930297">(</span><span class="ident" id="3930298">pattern</span><span class="op" id="3930305">)</span>&nbsp;<span class="op" id="3930307">==</span>&nbsp;<span class="num" id="3930310">0</span>&nbsp;<span class="op" id="3930312">||</span>&nbsp;<span class="builtinfunc" id="3930315">len</span><span class="op" id="3930318">(</span><span class="ident" id="3930319">host</span><span class="op" id="3930323">)</span>&nbsp;<span class="op" id="3930325">==</span>&nbsp;<span class="num" id="3930328">0</span>&nbsp;<span class="op" id="3930330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930334">return</span>&nbsp;<span class="builtintype" id="3930341">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930352">patternParts</span>&nbsp;<span class="op" id="3930365">:=</span>&nbsp;<span class="ident" id="3930368">strings</span><span class="op" id="3930375">.</span><span class="ident" id="3930376">Split</span><span class="op" id="3930381">(</span><span class="ident" id="3930382">pattern</span><span class="op" id="3930389">,</span>&nbsp;<span class="string" id="3930391">&#34;.&#34;</span><span class="op" id="3930394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930397">hostParts</span>&nbsp;<span class="op" id="3930407">:=</span>&nbsp;<span class="ident" id="3930410">strings</span><span class="op" id="3930417">.</span><span class="ident" id="3930418">Split</span><span class="op" id="3930423">(</span><span class="ident" id="3930424">host</span><span class="op" id="3930428">,</span>&nbsp;<span class="string" id="3930430">&#34;.&#34;</span><span class="op" id="3930433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930437">if</span>&nbsp;<span class="builtinfunc" id="3930440">len</span><span class="op" id="3930443">(</span><span class="ident" id="3930444">patternParts</span><span class="op" id="3930456">)</span>&nbsp;<span class="op" id="3930458">!=</span>&nbsp;<span class="builtinfunc" id="3930461">len</span><span class="op" id="3930464">(</span><span class="ident" id="3930465">hostParts</span><span class="op" id="3930474">)</span>&nbsp;<span class="op" id="3930476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930480">return</span>&nbsp;<span class="builtintype" id="3930487">false</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930498">for</span>&nbsp;<span class="ident" id="3930502">i</span><span class="op" id="3930503">,</span>&nbsp;<span class="ident" id="3930505">patternPart</span>&nbsp;<span class="op" id="3930517">:=</span>&nbsp;<span class="keyword" id="3930520">range</span>&nbsp;<span class="ident" id="3930526">patternParts</span>&nbsp;<span class="op" id="3930539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930543">if</span>&nbsp;<span class="ident" id="3930546">patternPart</span>&nbsp;<span class="op" id="3930558">==</span>&nbsp;<span class="string" id="3930561">&#34;*&#34;</span>&nbsp;<span class="op" id="3930565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930570">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930585">if</span>&nbsp;<span class="ident" id="3930588">patternPart</span>&nbsp;<span class="op" id="3930600">!=</span>&nbsp;<span class="ident" id="3930603">hostParts</span><span class="op" id="3930612">[</span><span class="ident" id="3930613">i</span><span class="op" id="3930614">]</span>&nbsp;<span class="op" id="3930616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930621">return</span>&nbsp;<span class="builtintype" id="3930628">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930639">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930643">return</span>&nbsp;<span class="builtintype" id="3930650">true</span><br>
<span class="lineno"></span><span class="op" id="3930655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3930658">//&nbsp;toLowerCaseASCII&nbsp;returns&nbsp;a&nbsp;lower-case&nbsp;version&nbsp;of&nbsp;in.&nbsp;See&nbsp;RFC&nbsp;6125&nbsp;6.4.1.&nbsp;We&nbsp;use</span><br>
<span class="lineno">350</span><span class="comment" id="3930741">//&nbsp;an&nbsp;explicitly&nbsp;ASCII&nbsp;function&nbsp;to&nbsp;avoid&nbsp;any&nbsp;sharp&nbsp;corners&nbsp;resulting&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3930815">//&nbsp;performing&nbsp;Unicode&nbsp;operations&nbsp;on&nbsp;DNS&nbsp;labels.</span><br>
<span class="lineno"></span><span class="keyword" id="3930863">func</span>&nbsp;<span class="ident" id="3930868">toLowerCaseASCII</span><span class="op" id="3930884">(</span><span class="ident" id="3930885">in</span>&nbsp;<span class="builtintype" id="3930888">string</span><span class="op" id="3930894">)</span>&nbsp;<span class="builtintype" id="3930896">string</span>&nbsp;<span class="op" id="3930903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3930906">//&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;already&nbsp;lower-case&nbsp;then&nbsp;there&#39;s&nbsp;nothing&nbsp;to&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930974">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3930993">:=</span>&nbsp;<span class="builtintype" id="3930996">true</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931002">for</span>&nbsp;<span class="ident" id="3931006">_</span><span class="op" id="3931007">,</span>&nbsp;<span class="ident" id="3931009">c</span>&nbsp;<span class="op" id="3931011">:=</span>&nbsp;<span class="keyword" id="3931014">range</span>&nbsp;<span class="ident" id="3931020">in</span>&nbsp;<span class="op" id="3931023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931027">if</span>&nbsp;<span class="ident" id="3931030">c</span>&nbsp;<span class="op" id="3931032">==</span>&nbsp;<span class="ident" id="3931035">utf8</span><span class="op" id="3931039">.</span><span class="ident" id="3931040">RuneError</span>&nbsp;<span class="op" id="3931050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3931055">//&nbsp;If&nbsp;we&nbsp;get&nbsp;a&nbsp;UTF-8&nbsp;error&nbsp;then&nbsp;there&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3931105">//&nbsp;upper-case&nbsp;ASCII&nbsp;bytes&nbsp;in&nbsp;the&nbsp;invalid&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931159">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3931178">=</span>&nbsp;<span class="builtintype" id="3931180">false</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931189">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931201">if</span>&nbsp;<span class="string" id="3931204">&#39;A&#39;</span>&nbsp;<span class="op" id="3931208">&lt;=</span>&nbsp;<span class="ident" id="3931211">c</span>&nbsp;<span class="op" id="3931213">&amp;&amp;</span>&nbsp;<span class="ident" id="3931216">c</span>&nbsp;<span class="op" id="3931218">&lt;=</span>&nbsp;<span class="string" id="3931221">&#39;Z&#39;</span>&nbsp;<span class="op" id="3931225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931230">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3931249">=</span>&nbsp;<span class="builtintype" id="3931251">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931260">break</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931275">if</span>&nbsp;<span class="ident" id="3931278">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3931297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931301">return</span>&nbsp;<span class="ident" id="3931308">in</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931316">out</span>&nbsp;<span class="op" id="3931320">:=</span>&nbsp;<span class="op" id="3931323">[</span><span class="op" id="3931324">]</span><span class="builtintype" id="3931325">byte</span><span class="op" id="3931329">(</span><span class="ident" id="3931330">in</span><span class="op" id="3931332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931335">for</span>&nbsp;<span class="ident" id="3931339">i</span><span class="op" id="3931340">,</span>&nbsp;<span class="ident" id="3931342">c</span>&nbsp;<span class="op" id="3931344">:=</span>&nbsp;<span class="keyword" id="3931347">range</span>&nbsp;<span class="ident" id="3931353">out</span>&nbsp;<span class="op" id="3931357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931361">if</span>&nbsp;<span class="string" id="3931364">&#39;A&#39;</span>&nbsp;<span class="op" id="3931368">&lt;=</span>&nbsp;<span class="ident" id="3931371">c</span>&nbsp;<span class="op" id="3931373">&amp;&amp;</span>&nbsp;<span class="ident" id="3931376">c</span>&nbsp;<span class="op" id="3931378">&lt;=</span>&nbsp;<span class="string" id="3931381">&#39;Z&#39;</span>&nbsp;<span class="op" id="3931385">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931390">out</span><span class="op" id="3931393">[</span><span class="ident" id="3931394">i</span><span class="op" id="3931395">]</span>&nbsp;<span class="op" id="3931397">+=</span>&nbsp;<span class="string" id="3931400">&#39;a&#39;</span>&nbsp;<span class="op" id="3931404">-</span>&nbsp;<span class="string" id="3931406">&#39;A&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931418">return</span>&nbsp;<span class="builtintype" id="3931425">string</span><span class="op" id="3931431">(</span><span class="ident" id="3931432">out</span><span class="op" id="3931435">)</span><br>
<span class="lineno"></span><span class="op" id="3931437">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="3931440">//&nbsp;VerifyHostname&nbsp;returns&nbsp;nil&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;valid&nbsp;certificate&nbsp;for&nbsp;the&nbsp;named&nbsp;host.</span><br>
<span class="lineno"></span><span class="comment" id="3931518">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error&nbsp;describing&nbsp;the&nbsp;mismatch.</span><br>
<span class="lineno"></span><span class="keyword" id="3931576">func</span>&nbsp;<span class="op" id="3931581">(</span><span class="ident" id="3931582">c</span>&nbsp;<span class="op" id="3931584">*</span><span class="ident" id="3931585">Certificate</span><span class="op" id="3931596">)</span>&nbsp;<span class="ident" id="3931598">VerifyHostname</span><span class="op" id="3931612">(</span><span class="ident" id="3931613">h</span>&nbsp;<span class="builtintype" id="3931615">string</span><span class="op" id="3931621">)</span>&nbsp;<span class="builtintype" id="3931623">error</span>&nbsp;<span class="op" id="3931629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3931632">//&nbsp;IP&nbsp;addresses&nbsp;may&nbsp;be&nbsp;written&nbsp;in&nbsp;[&nbsp;].</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931672">candidateIP</span>&nbsp;<span class="op" id="3931684">:=</span>&nbsp;<span class="ident" id="3931687">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931690">if</span>&nbsp;<span class="builtinfunc" id="3931693">len</span><span class="op" id="3931696">(</span><span class="ident" id="3931697">h</span><span class="op" id="3931698">)</span>&nbsp;<span class="op" id="3931700">&gt;=</span>&nbsp;<span class="num" id="3931703">3</span>&nbsp;<span class="op" id="3931705">&amp;&amp;</span>&nbsp;<span class="ident" id="3931708">h</span><span class="op" id="3931709">[</span><span class="num" id="3931710">0</span><span class="op" id="3931711">]</span>&nbsp;<span class="op" id="3931713">==</span>&nbsp;<span class="string" id="3931716">&#39;[&#39;</span>&nbsp;<span class="op" id="3931720">&amp;&amp;</span>&nbsp;<span class="ident" id="3931723">h</span><span class="op" id="3931724">[</span><span class="builtinfunc" id="3931725">len</span><span class="op" id="3931728">(</span><span class="ident" id="3931729">h</span><span class="op" id="3931730">)</span><span class="op" id="3931731">-</span><span class="num" id="3931732">1</span><span class="op" id="3931733">]</span>&nbsp;<span class="op" id="3931735">==</span>&nbsp;<span class="string" id="3931738">&#39;]&#39;</span>&nbsp;<span class="op" id="3931742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931746">candidateIP</span>&nbsp;<span class="op" id="3931758">=</span>&nbsp;<span class="ident" id="3931760">h</span><span class="op" id="3931761">[</span><span class="num" id="3931762">1</span>&nbsp;<span class="op" id="3931764">:</span>&nbsp;<span class="builtinfunc" id="3931766">len</span><span class="op" id="3931769">(</span><span class="ident" id="3931770">h</span><span class="op" id="3931771">)</span><span class="op" id="3931772">-</span><span class="num" id="3931773">1</span><span class="op" id="3931774">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931780">if</span>&nbsp;<span class="ident" id="3931783">ip</span>&nbsp;<span class="op" id="3931786">:=</span>&nbsp;<span class="ident" id="3931789">net</span><span class="op" id="3931792">.</span><span class="ident" id="3931793">ParseIP</span><span class="op" id="3931800">(</span><span class="ident" id="3931801">candidateIP</span><span class="op" id="3931812">)</span><span class="op" id="3931813">;</span>&nbsp;<span class="ident" id="3931815">ip</span>&nbsp;<span class="op" id="3931818">!=</span>&nbsp;<span class="builtintype" id="3931821">nil</span>&nbsp;<span class="op" id="3931825">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3931829">//&nbsp;We&nbsp;only&nbsp;match&nbsp;IP&nbsp;addresses&nbsp;against&nbsp;IP&nbsp;SANs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3931878">//&nbsp;https://tools.ietf.org/html/rfc6125#appendix-B.2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931932">for</span>&nbsp;<span class="ident" id="3931936">_</span><span class="op" id="3931937">,</span>&nbsp;<span class="ident" id="3931939">candidate</span>&nbsp;<span class="op" id="3931949">:=</span>&nbsp;<span class="keyword" id="3931952">range</span>&nbsp;<span class="ident" id="3931958">c</span><span class="op" id="3931959">.</span><span class="ident" id="3931960">IPAddresses</span>&nbsp;<span class="op" id="3931972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931977">if</span>&nbsp;<span class="ident" id="3931980">ip</span><span class="op" id="3931982">.</span><span class="ident" id="3931983">Equal</span><span class="op" id="3931988">(</span><span class="ident" id="3931989">candidate</span><span class="op" id="3931998">)</span>&nbsp;<span class="op" id="3932000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932006">return</span>&nbsp;<span class="builtintype" id="3932013">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932028">return</span>&nbsp;<span class="ident" id="3932035">HostnameError</span><span class="op" id="3932048">{</span><span class="ident" id="3932049">c</span><span class="op" id="3932050">,</span>&nbsp;<span class="ident" id="3932052">candidateIP</span><span class="op" id="3932063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932070">lowered</span>&nbsp;<span class="op" id="3932078">:=</span>&nbsp;<span class="ident" id="3932081">toLowerCaseASCII</span><span class="op" id="3932097">(</span><span class="ident" id="3932098">h</span><span class="op" id="3932099">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932103">if</span>&nbsp;<span class="builtinfunc" id="3932106">len</span><span class="op" id="3932109">(</span><span class="ident" id="3932110">c</span><span class="op" id="3932111">.</span><span class="ident" id="3932112">DNSNames</span><span class="op" id="3932120">)</span>&nbsp;<span class="op" id="3932122">&gt;</span>&nbsp;<span class="num" id="3932124">0</span>&nbsp;<span class="op" id="3932126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932130">for</span>&nbsp;<span class="ident" id="3932134">_</span><span class="op" id="3932135">,</span>&nbsp;<span class="ident" id="3932137">match</span>&nbsp;<span class="op" id="3932143">:=</span>&nbsp;<span class="keyword" id="3932146">range</span>&nbsp;<span class="ident" id="3932152">c</span><span class="op" id="3932153">.</span><span class="ident" id="3932154">DNSNames</span>&nbsp;<span class="op" id="3932163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932168">if</span>&nbsp;<span class="ident" id="3932171">matchHostnames</span><span class="op" id="3932185">(</span><span class="ident" id="3932186">toLowerCaseASCII</span><span class="op" id="3932202">(</span><span class="ident" id="3932203">match</span><span class="op" id="3932208">)</span><span class="op" id="3932209">,</span>&nbsp;<span class="ident" id="3932211">lowered</span><span class="op" id="3932218">)</span>&nbsp;<span class="op" id="3932220">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932226">return</span>&nbsp;<span class="builtintype" id="3932233">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932248">//&nbsp;If&nbsp;Subject&nbsp;Alt&nbsp;Name&nbsp;is&nbsp;given,&nbsp;we&nbsp;ignore&nbsp;the&nbsp;common&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932309">}</span>&nbsp;<span class="keyword" id="3932311">else</span>&nbsp;<span class="keyword" id="3932316">if</span>&nbsp;<span class="ident" id="3932319">matchHostnames</span><span class="op" id="3932333">(</span><span class="ident" id="3932334">toLowerCaseASCII</span><span class="op" id="3932350">(</span><span class="ident" id="3932351">c</span><span class="op" id="3932352">.</span><span class="ident" id="3932353">Subject</span><span class="op" id="3932360">.</span><span class="ident" id="3932361">CommonName</span><span class="op" id="3932371">)</span><span class="op" id="3932372">,</span>&nbsp;<span class="ident" id="3932374">lowered</span><span class="op" id="3932381">)</span>&nbsp;<span class="op" id="3932383">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932387">return</span>&nbsp;<span class="builtintype" id="3932394">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932403">return</span>&nbsp;<span class="ident" id="3932410">HostnameError</span><span class="op" id="3932423">{</span><span class="ident" id="3932424">c</span><span class="op" id="3932425">,</span>&nbsp;<span class="ident" id="3932427">h</span><span class="op" id="3932428">}</span><br>
<span class="lineno"></span><span class="op" id="3932430">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span><span class="keyword" id="3932433">func</span>&nbsp;<span class="ident" id="3932438">checkChainForKeyUsage</span><span class="op" id="3932459">(</span><span class="ident" id="3932460">chain</span>&nbsp;<span class="op" id="3932466">[</span><span class="op" id="3932467">]</span><span class="op" id="3932468">*</span><span class="ident" id="3932469">Certificate</span><span class="op" id="3932480">,</span>&nbsp;<span class="ident" id="3932482">keyUsages</span>&nbsp;<span class="op" id="3932492">[</span><span class="op" id="3932493">]</span><span class="ident" id="3932494">ExtKeyUsage</span><span class="op" id="3932505">)</span>&nbsp;<span class="builtintype" id="3932507">bool</span>&nbsp;<span class="op" id="3932512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932515">usages</span>&nbsp;<span class="op" id="3932522">:=</span>&nbsp;<span class="builtinfunc" id="3932525">make</span><span class="op" id="3932529">(</span><span class="op" id="3932530">[</span><span class="op" id="3932531">]</span><span class="ident" id="3932532">ExtKeyUsage</span><span class="op" id="3932543">,</span>&nbsp;<span class="builtinfunc" id="3932545">len</span><span class="op" id="3932548">(</span><span class="ident" id="3932549">keyUsages</span><span class="op" id="3932558">)</span><span class="op" id="3932559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3932562">copy</span><span class="op" id="3932566">(</span><span class="ident" id="3932567">usages</span><span class="op" id="3932573">,</span>&nbsp;<span class="ident" id="3932575">keyUsages</span><span class="op" id="3932584">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932588">if</span>&nbsp;<span class="builtinfunc" id="3932591">len</span><span class="op" id="3932594">(</span><span class="ident" id="3932595">chain</span><span class="op" id="3932600">)</span>&nbsp;<span class="op" id="3932602">==</span>&nbsp;<span class="num" id="3932605">0</span>&nbsp;<span class="op" id="3932607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932611">return</span>&nbsp;<span class="builtintype" id="3932618">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932629">usagesRemaining</span>&nbsp;<span class="op" id="3932645">:=</span>&nbsp;<span class="builtinfunc" id="3932648">len</span><span class="op" id="3932651">(</span><span class="ident" id="3932652">usages</span><span class="op" id="3932658">)</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932662">//&nbsp;We&nbsp;walk&nbsp;down&nbsp;the&nbsp;list&nbsp;and&nbsp;cross&nbsp;out&nbsp;any&nbsp;usages&nbsp;that&nbsp;aren&#39;t&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932735">//&nbsp;by&nbsp;each&nbsp;certificate.&nbsp;If&nbsp;we&nbsp;cross&nbsp;out&nbsp;all&nbsp;the&nbsp;usages,&nbsp;then&nbsp;the&nbsp;chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932807">//&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="ident" id="3932828">NextCert</span><span class="op" id="3932836">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932839">for</span>&nbsp;<span class="ident" id="3932843">i</span>&nbsp;<span class="op" id="3932845">:=</span>&nbsp;<span class="builtinfunc" id="3932848">len</span><span class="op" id="3932851">(</span><span class="ident" id="3932852">chain</span><span class="op" id="3932857">)</span>&nbsp;<span class="op" id="3932859">-</span>&nbsp;<span class="num" id="3932861">1</span><span class="op" id="3932862">;</span>&nbsp;<span class="ident" id="3932864">i</span>&nbsp;<span class="op" id="3932866">&gt;=</span>&nbsp;<span class="num" id="3932869">0</span><span class="op" id="3932870">;</span>&nbsp;<span class="ident" id="3932872">i</span><span class="op" id="3932873">--</span>&nbsp;<span class="op" id="3932876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932880">cert</span>&nbsp;<span class="op" id="3932885">:=</span>&nbsp;<span class="ident" id="3932888">chain</span><span class="op" id="3932893">[</span><span class="ident" id="3932894">i</span><span class="op" id="3932895">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932899">if</span>&nbsp;<span class="builtinfunc" id="3932902">len</span><span class="op" id="3932905">(</span><span class="ident" id="3932906">cert</span><span class="op" id="3932910">.</span><span class="ident" id="3932911">ExtKeyUsage</span><span class="op" id="3932922">)</span>&nbsp;<span class="op" id="3932924">==</span>&nbsp;<span class="num" id="3932927">0</span>&nbsp;<span class="op" id="3932929">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3932932">len</span><span class="op" id="3932935">(</span><span class="ident" id="3932936">cert</span><span class="op" id="3932940">.</span><span class="ident" id="3932941">UnknownExtKeyUsage</span><span class="op" id="3932959">)</span>&nbsp;<span class="op" id="3932961">==</span>&nbsp;<span class="num" id="3932964">0</span>&nbsp;<span class="op" id="3932966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932971">//&nbsp;The&nbsp;certificate&nbsp;doesn&#39;t&nbsp;have&nbsp;any&nbsp;extended&nbsp;key&nbsp;usage&nbsp;specified.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933040">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933056">for</span>&nbsp;<span class="ident" id="3933060">_</span><span class="op" id="3933061">,</span>&nbsp;<span class="ident" id="3933063">usage</span>&nbsp;<span class="op" id="3933069">:=</span>&nbsp;<span class="keyword" id="3933072">range</span>&nbsp;<span class="ident" id="3933078">cert</span><span class="op" id="3933082">.</span><span class="ident" id="3933083">ExtKeyUsage</span>&nbsp;<span class="op" id="3933095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933100">if</span>&nbsp;<span class="ident" id="3933103">usage</span>&nbsp;<span class="op" id="3933109">==</span>&nbsp;<span class="ident" id="3933112">ExtKeyUsageAny</span>&nbsp;<span class="op" id="3933127">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933133">//&nbsp;The&nbsp;certificate&nbsp;is&nbsp;explicitly&nbsp;good&nbsp;for&nbsp;any&nbsp;usage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933190">continue</span>&nbsp;<span class="ident" id="3933199">NextCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933220">const</span>&nbsp;<span class="ident" id="3933226">invalidUsage</span>&nbsp;<span class="ident" id="3933239">ExtKeyUsage</span>&nbsp;<span class="op" id="3933251">=</span>&nbsp;<span class="op" id="3933253">-</span><span class="num" id="3933254">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933258">NextRequestedUsage</span><span class="op" id="3933276">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933280">for</span>&nbsp;<span class="ident" id="3933284">i</span><span class="op" id="3933285">,</span>&nbsp;<span class="ident" id="3933287">requestedUsage</span>&nbsp;<span class="op" id="3933302">:=</span>&nbsp;<span class="keyword" id="3933305">range</span>&nbsp;<span class="ident" id="3933311">usages</span>&nbsp;<span class="op" id="3933318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933323">if</span>&nbsp;<span class="ident" id="3933326">requestedUsage</span>&nbsp;<span class="op" id="3933341">==</span>&nbsp;<span class="ident" id="3933344">invalidUsage</span>&nbsp;<span class="op" id="3933357">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933363">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933381">for</span>&nbsp;<span class="ident" id="3933385">_</span><span class="op" id="3933386">,</span>&nbsp;<span class="ident" id="3933388">usage</span>&nbsp;<span class="op" id="3933394">:=</span>&nbsp;<span class="keyword" id="3933397">range</span>&nbsp;<span class="ident" id="3933403">cert</span><span class="op" id="3933407">.</span><span class="ident" id="3933408">ExtKeyUsage</span>&nbsp;<span class="op" id="3933420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933426">if</span>&nbsp;<span class="ident" id="3933429">requestedUsage</span>&nbsp;<span class="op" id="3933444">==</span>&nbsp;<span class="ident" id="3933447">usage</span>&nbsp;<span class="op" id="3933453">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933460">continue</span>&nbsp;<span class="ident" id="3933469">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933492">}</span>&nbsp;<span class="keyword" id="3933494">else</span>&nbsp;<span class="keyword" id="3933499">if</span>&nbsp;<span class="ident" id="3933502">requestedUsage</span>&nbsp;<span class="op" id="3933517">==</span>&nbsp;<span class="ident" id="3933520">ExtKeyUsageServerAuth</span>&nbsp;<span class="op" id="3933542">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933550">(</span><span class="ident" id="3933551">usage</span>&nbsp;<span class="op" id="3933557">==</span>&nbsp;<span class="ident" id="3933560">ExtKeyUsageNetscapeServerGatedCrypto</span>&nbsp;<span class="op" id="3933597">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933606">usage</span>&nbsp;<span class="op" id="3933612">==</span>&nbsp;<span class="ident" id="3933615">ExtKeyUsageMicrosoftServerGatedCrypto</span><span class="op" id="3933652">)</span>&nbsp;<span class="op" id="3933654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933661">//&nbsp;In&nbsp;order&nbsp;to&nbsp;support&nbsp;COMODO</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933696">//&nbsp;certificate&nbsp;chains,&nbsp;we&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933735">//&nbsp;accept&nbsp;Netscape&nbsp;or&nbsp;Microsoft&nbsp;SGC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933776">//&nbsp;usages&nbsp;as&nbsp;equal&nbsp;to&nbsp;ServerAuth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933815">continue</span>&nbsp;<span class="ident" id="3933824">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933847">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933858">usages</span><span class="op" id="3933864">[</span><span class="ident" id="3933865">i</span><span class="op" id="3933866">]</span>&nbsp;<span class="op" id="3933868">=</span>&nbsp;<span class="ident" id="3933870">invalidUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933886">usagesRemaining</span><span class="op" id="3933901">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933907">if</span>&nbsp;<span class="ident" id="3933910">usagesRemaining</span>&nbsp;<span class="op" id="3933926">==</span>&nbsp;<span class="num" id="3933929">0</span>&nbsp;<span class="op" id="3933931">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933937">return</span>&nbsp;<span class="builtintype" id="3933944">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933964">return</span>&nbsp;<span class="builtintype" id="3933971">true</span><br>
<span class="lineno"></span><span class="op" id="3933976">}</span>
</div>
</body>
</html>
