<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html" class="current">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5146627">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5146682">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5146736">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5146787">package</span>&nbsp;<span class="ident" id="5146795">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5146805">import</span>&nbsp;<span class="op" id="5146812">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5146815">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5146824">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5146831">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5146839">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5146845">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5146862">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="5146884">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5146887">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5146948">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="5147019">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="5147109">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="5147177">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="5147190">func</span>&nbsp;<span class="ident" id="5147195">escapeTemplate</span><span class="op" id="5147209">(</span><span class="ident" id="5147210">tmpl</span>&nbsp;<span class="op" id="5147215">*</span><span class="ident" id="5147216">Template</span><span class="op" id="5147224">,</span>&nbsp;<span class="ident" id="5147226">node</span>&nbsp;<span class="ident" id="5147231">parse</span><span class="op" id="5147236">.</span><span class="ident" id="5147237">Node</span><span class="op" id="5147241">,</span>&nbsp;<span class="ident" id="5147243">name</span>&nbsp;<span class="builtintype" id="5147248">string</span><span class="op" id="5147254">)</span>&nbsp;<span class="builtintype" id="5147256">error</span>&nbsp;<span class="op" id="5147262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147265">e</span>&nbsp;<span class="op" id="5147267">:=</span>&nbsp;<span class="ident" id="5147270">newEscaper</span><span class="op" id="5147280">(</span><span class="ident" id="5147281">tmpl</span><span class="op" id="5147285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147288">c</span><span class="op" id="5147289">,</span>&nbsp;<span class="ident" id="5147291">_</span>&nbsp;<span class="op" id="5147293">:=</span>&nbsp;<span class="ident" id="5147296">e</span><span class="op" id="5147297">.</span><span class="ident" id="5147298">escapeTree</span><span class="op" id="5147308">(</span><span class="ident" id="5147309">context</span><span class="op" id="5147316">{</span><span class="op" id="5147317">}</span><span class="op" id="5147318">,</span>&nbsp;<span class="ident" id="5147320">node</span><span class="op" id="5147324">,</span>&nbsp;<span class="ident" id="5147326">name</span><span class="op" id="5147330">,</span>&nbsp;<span class="num" id="5147332">0</span><span class="op" id="5147333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5147336">var</span>&nbsp;<span class="ident" id="5147340">err</span>&nbsp;<span class="builtintype" id="5147344">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5147351">if</span>&nbsp;<span class="ident" id="5147354">c</span><span class="op" id="5147355">.</span><span class="ident" id="5147356">err</span>&nbsp;<span class="op" id="5147360">!=</span>&nbsp;<span class="builtintype" id="5147363">nil</span>&nbsp;<span class="op" id="5147367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147371">err</span><span class="op" id="5147374">,</span>&nbsp;<span class="ident" id="5147376">c</span><span class="op" id="5147377">.</span><span class="ident" id="5147378">err</span><span class="op" id="5147381">.</span><span class="ident" id="5147382">Name</span>&nbsp;<span class="op" id="5147387">=</span>&nbsp;<span class="ident" id="5147389">c</span><span class="op" id="5147390">.</span><span class="ident" id="5147391">err</span><span class="op" id="5147394">,</span>&nbsp;<span class="ident" id="5147396">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5147402">}</span>&nbsp;<span class="keyword" id="5147404">else</span>&nbsp;<span class="keyword" id="5147409">if</span>&nbsp;<span class="ident" id="5147412">c</span><span class="op" id="5147413">.</span><span class="ident" id="5147414">state</span>&nbsp;<span class="op" id="5147420">!=</span>&nbsp;<span class="ident" id="5147423">stateText</span>&nbsp;<span class="op" id="5147433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147437">err</span>&nbsp;<span class="op" id="5147441">=</span>&nbsp;<span class="op" id="5147443">&amp;</span><span class="ident" id="5147444">Error</span><span class="op" id="5147449">{</span><span class="ident" id="5147450">ErrEndContext</span><span class="op" id="5147463">,</span>&nbsp;<span class="builtintype" id="5147465">nil</span><span class="op" id="5147468">,</span>&nbsp;<span class="ident" id="5147470">name</span><span class="op" id="5147474">,</span>&nbsp;<span class="num" id="5147476">0</span><span class="op" id="5147477">,</span>&nbsp;<span class="ident" id="5147479">fmt</span><span class="op" id="5147482">.</span><span class="ident" id="5147483">Sprintf</span><span class="op" id="5147490">(</span><span class="string" id="5147491">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="5147523">,</span>&nbsp;<span class="ident" id="5147525">c</span><span class="op" id="5147526">)</span><span class="op" id="5147527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5147530">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5147533">if</span>&nbsp;<span class="ident" id="5147536">err</span>&nbsp;<span class="op" id="5147540">!=</span>&nbsp;<span class="builtintype" id="5147543">nil</span>&nbsp;<span class="op" id="5147547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5147551">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5147595">if</span>&nbsp;<span class="ident" id="5147598">t</span>&nbsp;<span class="op" id="5147600">:=</span>&nbsp;<span class="ident" id="5147603">tmpl</span><span class="op" id="5147607">.</span><span class="ident" id="5147608">set</span><span class="op" id="5147611">[</span><span class="ident" id="5147612">name</span><span class="op" id="5147616">]</span><span class="op" id="5147617">;</span>&nbsp;<span class="ident" id="5147619">t</span>&nbsp;<span class="op" id="5147621">!=</span>&nbsp;<span class="builtintype" id="5147624">nil</span>&nbsp;<span class="op" id="5147628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147633">t</span><span class="op" id="5147634">.</span><span class="ident" id="5147635">escapeErr</span>&nbsp;<span class="op" id="5147645">=</span>&nbsp;<span class="ident" id="5147647">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147654">t</span><span class="op" id="5147655">.</span><span class="ident" id="5147656">text</span><span class="op" id="5147660">.</span><span class="ident" id="5147661">Tree</span>&nbsp;<span class="op" id="5147666">=</span>&nbsp;<span class="builtintype" id="5147668">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147675">t</span><span class="op" id="5147676">.</span><span class="ident" id="5147677">Tree</span>&nbsp;<span class="op" id="5147682">=</span>&nbsp;<span class="builtintype" id="5147684">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5147690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5147694">return</span>&nbsp;<span class="ident" id="5147701">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5147706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147709">e</span><span class="op" id="5147710">.</span><span class="ident" id="5147711">commit</span><span class="op" id="5147717">(</span><span class="op" id="5147718">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5147721">if</span>&nbsp;<span class="ident" id="5147724">t</span>&nbsp;<span class="op" id="5147726">:=</span>&nbsp;<span class="ident" id="5147729">tmpl</span><span class="op" id="5147733">.</span><span class="ident" id="5147734">set</span><span class="op" id="5147737">[</span><span class="ident" id="5147738">name</span><span class="op" id="5147742">]</span><span class="op" id="5147743">;</span>&nbsp;<span class="ident" id="5147745">t</span>&nbsp;<span class="op" id="5147747">!=</span>&nbsp;<span class="builtintype" id="5147750">nil</span>&nbsp;<span class="op" id="5147754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147758">t</span><span class="op" id="5147759">.</span><span class="ident" id="5147760">escapeErr</span>&nbsp;<span class="op" id="5147770">=</span>&nbsp;<span class="ident" id="5147772">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147783">t</span><span class="op" id="5147784">.</span><span class="ident" id="5147785">Tree</span>&nbsp;<span class="op" id="5147790">=</span>&nbsp;<span class="ident" id="5147792">t</span><span class="op" id="5147793">.</span><span class="ident" id="5147794">text</span><span class="op" id="5147798">.</span><span class="ident" id="5147799">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5147805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5147808">return</span>&nbsp;<span class="builtintype" id="5147815">nil</span><br>
<span class="lineno">45</span><span class="op" id="5147819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5147822">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5147896">var</span>&nbsp;<span class="ident" id="5147900">funcMap</span>&nbsp;<span class="op" id="5147908">=</span>&nbsp;<span class="ident" id="5147910">template</span><span class="op" id="5147918">.</span><span class="ident" id="5147919">FuncMap</span><span class="op" id="5147926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5147929">&#34;html_template_attrescaper&#34;</span><span class="op" id="5147956">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5147962">attrEscaper</span><span class="op" id="5147973">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5147976">&#34;html_template_commentescaper&#34;</span><span class="op" id="5148006">:</span>&nbsp;&nbsp;<span class="ident" id="5148009">commentEscaper</span><span class="op" id="5148023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148026">&#34;html_template_cssescaper&#34;</span><span class="op" id="5148052">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148059">cssEscaper</span><span class="op" id="5148069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148072">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5148102">:</span>&nbsp;&nbsp;<span class="ident" id="5148105">cssValueFilter</span><span class="op" id="5148119">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148122">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5148152">:</span>&nbsp;&nbsp;<span class="ident" id="5148155">htmlNameFilter</span><span class="op" id="5148169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148172">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5148199">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148205">htmlEscaper</span><span class="op" id="5148216">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148219">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5148250">:</span>&nbsp;<span class="ident" id="5148252">jsRegexpEscaper</span><span class="op" id="5148267">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148270">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5148298">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148303">jsStrEscaper</span><span class="op" id="5148315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148318">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5148346">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148351">jsValEscaper</span><span class="op" id="5148363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148366">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5148396">:</span>&nbsp;&nbsp;<span class="ident" id="5148399">htmlNospaceEscaper</span><span class="op" id="5148417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148420">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5148449">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5148453">rcdataEscaper</span><span class="op" id="5148466">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148469">&#34;html_template_urlescaper&#34;</span><span class="op" id="5148495">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148502">urlEscaper</span><span class="op" id="5148512">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148515">&#34;html_template_urlfilter&#34;</span><span class="op" id="5148540">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148548">urlFilter</span><span class="op" id="5148557">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148560">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5148589">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5148593">urlNormalizer</span><span class="op" id="5148606">,</span><br>
<span class="lineno"></span><span class="op" id="5148608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5148611">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="5148689">var</span>&nbsp;<span class="ident" id="5148693">equivEscapers</span>&nbsp;<span class="op" id="5148707">=</span>&nbsp;<span class="keyword" id="5148709">map</span><span class="op" id="5148712">[</span><span class="builtintype" id="5148713">string</span><span class="op" id="5148719">]</span><span class="builtintype" id="5148720">string</span><span class="op" id="5148726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148729">&#34;html_template_attrescaper&#34;</span><span class="op" id="5148756">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148761">&#34;html&#34;</span><span class="op" id="5148767">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148770">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5148797">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148802">&#34;html&#34;</span><span class="op" id="5148808">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148811">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5148841">:</span>&nbsp;<span class="string" id="5148843">&#34;html&#34;</span><span class="op" id="5148849">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148852">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5148881">:</span>&nbsp;&nbsp;<span class="string" id="5148884">&#34;html&#34;</span><span class="op" id="5148890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148893">&#34;html_template_urlescaper&#34;</span><span class="op" id="5148919">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148925">&#34;urlquery&#34;</span><span class="op" id="5148935">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5148938">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5148967">:</span>&nbsp;&nbsp;<span class="string" id="5148970">&#34;urlquery&#34;</span><span class="op" id="5148980">,</span><br>
<span class="lineno"></span><span class="op" id="5148982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="5148985">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="5149064">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5149093">type</span>&nbsp;<span class="ident" id="5149098">escaper</span>&nbsp;<span class="keyword" id="5149106">struct</span>&nbsp;<span class="op" id="5149113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149116">tmpl</span>&nbsp;<span class="op" id="5149121">*</span><span class="ident" id="5149122">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149132">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149203">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149254">output</span>&nbsp;<span class="keyword" id="5149261">map</span><span class="op" id="5149264">[</span><span class="builtintype" id="5149265">string</span><span class="op" id="5149271">]</span><span class="ident" id="5149272">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149281">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149354">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149407">derived</span>&nbsp;<span class="keyword" id="5149415">map</span><span class="op" id="5149418">[</span><span class="builtintype" id="5149419">string</span><span class="op" id="5149425">]</span><span class="op" id="5149426">*</span><span class="ident" id="5149427">template</span><span class="op" id="5149435">.</span><span class="ident" id="5149436">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149446">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149514">called</span>&nbsp;<span class="keyword" id="5149521">map</span><span class="op" id="5149524">[</span><span class="builtintype" id="5149525">string</span><span class="op" id="5149531">]</span><span class="builtintype" id="5149532">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149538">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149605">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149671">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149733">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5149751">map</span><span class="op" id="5149754">[</span><span class="op" id="5149755">*</span><span class="ident" id="5149756">parse</span><span class="op" id="5149761">.</span><span class="ident" id="5149762">ActionNode</span><span class="op" id="5149772">]</span><span class="op" id="5149773">[</span><span class="op" id="5149774">]</span><span class="builtintype" id="5149775">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149783">templateNodeEdits</span>&nbsp;<span class="keyword" id="5149801">map</span><span class="op" id="5149804">[</span><span class="op" id="5149805">*</span><span class="ident" id="5149806">parse</span><span class="op" id="5149811">.</span><span class="ident" id="5149812">TemplateNode</span><span class="op" id="5149824">]</span><span class="builtintype" id="5149825">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149833">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5149851">map</span><span class="op" id="5149854">[</span><span class="op" id="5149855">*</span><span class="ident" id="5149856">parse</span><span class="op" id="5149861">.</span><span class="ident" id="5149862">TextNode</span><span class="op" id="5149870">]</span><span class="op" id="5149871">[</span><span class="op" id="5149872">]</span><span class="builtintype" id="5149873">byte</span><br>
<span class="lineno"></span><span class="op" id="5149878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5149881">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5149938">func</span>&nbsp;<span class="ident" id="5149943">newEscaper</span><span class="op" id="5149953">(</span><span class="ident" id="5149954">t</span>&nbsp;<span class="op" id="5149956">*</span><span class="ident" id="5149957">Template</span><span class="op" id="5149965">)</span>&nbsp;<span class="op" id="5149967">*</span><span class="ident" id="5149968">escaper</span>&nbsp;<span class="op" id="5149976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5149979">return</span>&nbsp;<span class="op" id="5149986">&amp;</span><span class="ident" id="5149987">escaper</span><span class="op" id="5149994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149998">t</span><span class="op" id="5149999">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150003">map</span><span class="op" id="5150006">[</span><span class="builtintype" id="5150007">string</span><span class="op" id="5150013">]</span><span class="ident" id="5150014">context</span><span class="op" id="5150021">{</span><span class="op" id="5150022">}</span><span class="op" id="5150023">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150027">map</span><span class="op" id="5150030">[</span><span class="builtintype" id="5150031">string</span><span class="op" id="5150037">]</span><span class="op" id="5150038">*</span><span class="ident" id="5150039">template</span><span class="op" id="5150047">.</span><span class="ident" id="5150048">Template</span><span class="op" id="5150056">{</span><span class="op" id="5150057">}</span><span class="op" id="5150058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150062">map</span><span class="op" id="5150065">[</span><span class="builtintype" id="5150066">string</span><span class="op" id="5150072">]</span><span class="builtintype" id="5150073">bool</span><span class="op" id="5150077">{</span><span class="op" id="5150078">}</span><span class="op" id="5150079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150083">map</span><span class="op" id="5150086">[</span><span class="op" id="5150087">*</span><span class="ident" id="5150088">parse</span><span class="op" id="5150093">.</span><span class="ident" id="5150094">ActionNode</span><span class="op" id="5150104">]</span><span class="op" id="5150105">[</span><span class="op" id="5150106">]</span><span class="builtintype" id="5150107">string</span><span class="op" id="5150113">{</span><span class="op" id="5150114">}</span><span class="op" id="5150115">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150119">map</span><span class="op" id="5150122">[</span><span class="op" id="5150123">*</span><span class="ident" id="5150124">parse</span><span class="op" id="5150129">.</span><span class="ident" id="5150130">TemplateNode</span><span class="op" id="5150142">]</span><span class="builtintype" id="5150143">string</span><span class="op" id="5150149">{</span><span class="op" id="5150150">}</span><span class="op" id="5150151">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150155">map</span><span class="op" id="5150158">[</span><span class="op" id="5150159">*</span><span class="ident" id="5150160">parse</span><span class="op" id="5150165">.</span><span class="ident" id="5150166">TextNode</span><span class="op" id="5150174">]</span><span class="op" id="5150175">[</span><span class="op" id="5150176">]</span><span class="builtintype" id="5150177">byte</span><span class="op" id="5150181">{</span><span class="op" id="5150182">}</span><span class="op" id="5150183">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5150186">}</span><br>
<span class="lineno"></span><span class="op" id="5150188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150191">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5150272">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="5150348">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5150427">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="5150504">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="5150528">const</span>&nbsp;<span class="ident" id="5150534">filterFailsafe</span>&nbsp;<span class="op" id="5150549">=</span>&nbsp;<span class="string" id="5150551">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="5150563">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5150598">func</span>&nbsp;<span class="op" id="5150603">(</span><span class="ident" id="5150604">e</span>&nbsp;<span class="op" id="5150606">*</span><span class="ident" id="5150607">escaper</span><span class="op" id="5150614">)</span>&nbsp;<span class="ident" id="5150616">escape</span><span class="op" id="5150622">(</span><span class="ident" id="5150623">c</span>&nbsp;<span class="ident" id="5150625">context</span><span class="op" id="5150632">,</span>&nbsp;<span class="ident" id="5150634">n</span>&nbsp;<span class="ident" id="5150636">parse</span><span class="op" id="5150641">.</span><span class="ident" id="5150642">Node</span><span class="op" id="5150646">)</span>&nbsp;<span class="ident" id="5150648">context</span>&nbsp;<span class="op" id="5150656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150659">switch</span>&nbsp;<span class="ident" id="5150666">n</span>&nbsp;<span class="op" id="5150668">:=</span>&nbsp;<span class="ident" id="5150671">n</span><span class="op" id="5150672">.</span><span class="op" id="5150673">(</span><span class="keyword" id="5150674">type</span><span class="op" id="5150678">)</span>&nbsp;<span class="op" id="5150680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150683">case</span>&nbsp;<span class="op" id="5150688">*</span><span class="ident" id="5150689">parse</span><span class="op" id="5150694">.</span><span class="ident" id="5150695">ActionNode</span><span class="op" id="5150705">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150709">return</span>&nbsp;<span class="ident" id="5150716">e</span><span class="op" id="5150717">.</span><span class="ident" id="5150718">escapeAction</span><span class="op" id="5150730">(</span><span class="ident" id="5150731">c</span><span class="op" id="5150732">,</span>&nbsp;<span class="ident" id="5150734">n</span><span class="op" id="5150735">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150738">case</span>&nbsp;<span class="op" id="5150743">*</span><span class="ident" id="5150744">parse</span><span class="op" id="5150749">.</span><span class="ident" id="5150750">IfNode</span><span class="op" id="5150756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150760">return</span>&nbsp;<span class="ident" id="5150767">e</span><span class="op" id="5150768">.</span><span class="ident" id="5150769">escapeBranch</span><span class="op" id="5150781">(</span><span class="ident" id="5150782">c</span><span class="op" id="5150783">,</span>&nbsp;<span class="op" id="5150785">&amp;</span><span class="ident" id="5150786">n</span><span class="op" id="5150787">.</span><span class="ident" id="5150788">BranchNode</span><span class="op" id="5150798">,</span>&nbsp;<span class="string" id="5150800">&#34;if&#34;</span><span class="op" id="5150804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150807">case</span>&nbsp;<span class="op" id="5150812">*</span><span class="ident" id="5150813">parse</span><span class="op" id="5150818">.</span><span class="ident" id="5150819">ListNode</span><span class="op" id="5150827">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150831">return</span>&nbsp;<span class="ident" id="5150838">e</span><span class="op" id="5150839">.</span><span class="ident" id="5150840">escapeList</span><span class="op" id="5150850">(</span><span class="ident" id="5150851">c</span><span class="op" id="5150852">,</span>&nbsp;<span class="ident" id="5150854">n</span><span class="op" id="5150855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150858">case</span>&nbsp;<span class="op" id="5150863">*</span><span class="ident" id="5150864">parse</span><span class="op" id="5150869">.</span><span class="ident" id="5150870">RangeNode</span><span class="op" id="5150879">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150883">return</span>&nbsp;<span class="ident" id="5150890">e</span><span class="op" id="5150891">.</span><span class="ident" id="5150892">escapeBranch</span><span class="op" id="5150904">(</span><span class="ident" id="5150905">c</span><span class="op" id="5150906">,</span>&nbsp;<span class="op" id="5150908">&amp;</span><span class="ident" id="5150909">n</span><span class="op" id="5150910">.</span><span class="ident" id="5150911">BranchNode</span><span class="op" id="5150921">,</span>&nbsp;<span class="string" id="5150923">&#34;range&#34;</span><span class="op" id="5150930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150933">case</span>&nbsp;<span class="op" id="5150938">*</span><span class="ident" id="5150939">parse</span><span class="op" id="5150944">.</span><span class="ident" id="5150945">TemplateNode</span><span class="op" id="5150957">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150961">return</span>&nbsp;<span class="ident" id="5150968">e</span><span class="op" id="5150969">.</span><span class="ident" id="5150970">escapeTemplate</span><span class="op" id="5150984">(</span><span class="ident" id="5150985">c</span><span class="op" id="5150986">,</span>&nbsp;<span class="ident" id="5150988">n</span><span class="op" id="5150989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5150992">case</span>&nbsp;<span class="op" id="5150997">*</span><span class="ident" id="5150998">parse</span><span class="op" id="5151003">.</span><span class="ident" id="5151004">TextNode</span><span class="op" id="5151012">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151016">return</span>&nbsp;<span class="ident" id="5151023">e</span><span class="op" id="5151024">.</span><span class="ident" id="5151025">escapeText</span><span class="op" id="5151035">(</span><span class="ident" id="5151036">c</span><span class="op" id="5151037">,</span>&nbsp;<span class="ident" id="5151039">n</span><span class="op" id="5151040">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151043">case</span>&nbsp;<span class="op" id="5151048">*</span><span class="ident" id="5151049">parse</span><span class="op" id="5151054">.</span><span class="ident" id="5151055">WithNode</span><span class="op" id="5151063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151067">return</span>&nbsp;<span class="ident" id="5151074">e</span><span class="op" id="5151075">.</span><span class="ident" id="5151076">escapeBranch</span><span class="op" id="5151088">(</span><span class="ident" id="5151089">c</span><span class="op" id="5151090">,</span>&nbsp;<span class="op" id="5151092">&amp;</span><span class="ident" id="5151093">n</span><span class="op" id="5151094">.</span><span class="ident" id="5151095">BranchNode</span><span class="op" id="5151105">,</span>&nbsp;<span class="string" id="5151107">&#34;with&#34;</span><span class="op" id="5151113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5151116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5151119">panic</span><span class="op" id="5151124">(</span><span class="string" id="5151125">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="5151137">+</span>&nbsp;<span class="ident" id="5151139">n</span><span class="op" id="5151140">.</span><span class="ident" id="5151141">String</span><span class="op" id="5151147">(</span><span class="op" id="5151148">)</span>&nbsp;<span class="op" id="5151150">+</span>&nbsp;<span class="string" id="5151152">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="5151171">)</span><br>
<span class="lineno"></span><span class="op" id="5151173">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="5151176">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5151225">func</span>&nbsp;<span class="op" id="5151230">(</span><span class="ident" id="5151231">e</span>&nbsp;<span class="op" id="5151233">*</span><span class="ident" id="5151234">escaper</span><span class="op" id="5151241">)</span>&nbsp;<span class="ident" id="5151243">escapeAction</span><span class="op" id="5151255">(</span><span class="ident" id="5151256">c</span>&nbsp;<span class="ident" id="5151258">context</span><span class="op" id="5151265">,</span>&nbsp;<span class="ident" id="5151267">n</span>&nbsp;<span class="op" id="5151269">*</span><span class="ident" id="5151270">parse</span><span class="op" id="5151275">.</span><span class="ident" id="5151276">ActionNode</span><span class="op" id="5151286">)</span>&nbsp;<span class="ident" id="5151288">context</span>&nbsp;<span class="op" id="5151296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151299">if</span>&nbsp;<span class="builtinfunc" id="5151302">len</span><span class="op" id="5151305">(</span><span class="ident" id="5151306">n</span><span class="op" id="5151307">.</span><span class="ident" id="5151308">Pipe</span><span class="op" id="5151312">.</span><span class="ident" id="5151313">Decl</span><span class="op" id="5151317">)</span>&nbsp;<span class="op" id="5151319">!=</span>&nbsp;<span class="num" id="5151322">0</span>&nbsp;<span class="op" id="5151324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5151328">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151384">return</span>&nbsp;<span class="ident" id="5151391">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5151394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5151397">c</span>&nbsp;<span class="op" id="5151399">=</span>&nbsp;<span class="ident" id="5151401">nudge</span><span class="op" id="5151406">(</span><span class="ident" id="5151407">c</span><span class="op" id="5151408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5151411">s</span>&nbsp;<span class="op" id="5151413">:=</span>&nbsp;<span class="builtinfunc" id="5151416">make</span><span class="op" id="5151420">(</span><span class="op" id="5151421">[</span><span class="op" id="5151422">]</span><span class="builtintype" id="5151423">string</span><span class="op" id="5151429">,</span>&nbsp;<span class="num" id="5151431">0</span><span class="op" id="5151432">,</span>&nbsp;<span class="num" id="5151434">3</span><span class="op" id="5151435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151438">switch</span>&nbsp;<span class="ident" id="5151445">c</span><span class="op" id="5151446">.</span><span class="ident" id="5151447">state</span>&nbsp;<span class="op" id="5151453">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151456">case</span>&nbsp;<span class="ident" id="5151461">stateError</span><span class="op" id="5151471">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151475">return</span>&nbsp;<span class="ident" id="5151482">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151485">case</span>&nbsp;<span class="ident" id="5151490">stateURL</span><span class="op" id="5151498">,</span>&nbsp;<span class="ident" id="5151500">stateCSSDqStr</span><span class="op" id="5151513">,</span>&nbsp;<span class="ident" id="5151515">stateCSSSqStr</span><span class="op" id="5151528">,</span>&nbsp;<span class="ident" id="5151530">stateCSSDqURL</span><span class="op" id="5151543">,</span>&nbsp;<span class="ident" id="5151545">stateCSSSqURL</span><span class="op" id="5151558">,</span>&nbsp;<span class="ident" id="5151560">stateCSSURL</span><span class="op" id="5151571">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151575">switch</span>&nbsp;<span class="ident" id="5151582">c</span><span class="op" id="5151583">.</span><span class="ident" id="5151584">urlPart</span>&nbsp;<span class="op" id="5151592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151596">case</span>&nbsp;<span class="ident" id="5151601">urlPartNone</span><span class="op" id="5151612">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5151617">s</span>&nbsp;<span class="op" id="5151619">=</span>&nbsp;<span class="builtinfunc" id="5151621">append</span><span class="op" id="5151627">(</span><span class="ident" id="5151628">s</span><span class="op" id="5151629">,</span>&nbsp;<span class="string" id="5151631">&#34;html_template_urlfilter&#34;</span><span class="op" id="5151656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151661">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151675">case</span>&nbsp;<span class="ident" id="5151680">urlPartPreQuery</span><span class="op" id="5151695">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151700">switch</span>&nbsp;<span class="ident" id="5151707">c</span><span class="op" id="5151708">.</span><span class="ident" id="5151709">state</span>&nbsp;<span class="op" id="5151715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151720">case</span>&nbsp;<span class="ident" id="5151725">stateCSSDqStr</span><span class="op" id="5151738">,</span>&nbsp;<span class="ident" id="5151740">stateCSSSqStr</span><span class="op" id="5151753">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5151759">s</span>&nbsp;<span class="op" id="5151761">=</span>&nbsp;<span class="builtinfunc" id="5151763">append</span><span class="op" id="5151769">(</span><span class="ident" id="5151770">s</span><span class="op" id="5151771">,</span>&nbsp;<span class="string" id="5151773">&#34;html_template_cssescaper&#34;</span><span class="op" id="5151799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151804">default</span><span class="op" id="5151811">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5151817">s</span>&nbsp;<span class="op" id="5151819">=</span>&nbsp;<span class="builtinfunc" id="5151821">append</span><span class="op" id="5151827">(</span><span class="ident" id="5151828">s</span><span class="op" id="5151829">,</span>&nbsp;<span class="string" id="5151831">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5151860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5151865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151869">case</span>&nbsp;<span class="ident" id="5151874">urlPartQueryOrFrag</span><span class="op" id="5151892">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5151897">s</span>&nbsp;<span class="op" id="5151899">=</span>&nbsp;<span class="builtinfunc" id="5151901">append</span><span class="op" id="5151907">(</span><span class="ident" id="5151908">s</span><span class="op" id="5151909">,</span>&nbsp;<span class="string" id="5151911">&#34;html_template_urlescaper&#34;</span><span class="op" id="5151937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151941">case</span>&nbsp;<span class="ident" id="5151946">urlPartUnknown</span><span class="op" id="5151960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5151965">return</span>&nbsp;<span class="ident" id="5151972">context</span><span class="op" id="5151979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5151985">state</span><span class="op" id="5151990">:</span>&nbsp;<span class="ident" id="5151992">stateError</span><span class="op" id="5152002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152008">err</span><span class="op" id="5152011">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5152015">errorf</span><span class="op" id="5152021">(</span><span class="ident" id="5152022">ErrAmbigContext</span><span class="op" id="5152037">,</span>&nbsp;<span class="ident" id="5152039">n</span><span class="op" id="5152040">,</span>&nbsp;<span class="ident" id="5152042">n</span><span class="op" id="5152043">.</span><span class="ident" id="5152044">Line</span><span class="op" id="5152048">,</span>&nbsp;<span class="string" id="5152050">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="5152090">,</span>&nbsp;<span class="ident" id="5152092">n</span><span class="op" id="5152093">)</span><span class="op" id="5152094">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5152099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152103">default</span><span class="op" id="5152110">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5152115">panic</span><span class="op" id="5152120">(</span><span class="ident" id="5152121">c</span><span class="op" id="5152122">.</span><span class="ident" id="5152123">urlPart</span><span class="op" id="5152130">.</span><span class="ident" id="5152131">String</span><span class="op" id="5152137">(</span><span class="op" id="5152138">)</span><span class="op" id="5152139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5152143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152146">case</span>&nbsp;<span class="ident" id="5152151">stateJS</span><span class="op" id="5152158">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152162">s</span>&nbsp;<span class="op" id="5152164">=</span>&nbsp;<span class="builtinfunc" id="5152166">append</span><span class="op" id="5152172">(</span><span class="ident" id="5152173">s</span><span class="op" id="5152174">,</span>&nbsp;<span class="string" id="5152176">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5152204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5152208">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152258">c</span><span class="op" id="5152259">.</span><span class="ident" id="5152260">jsCtx</span>&nbsp;<span class="op" id="5152266">=</span>&nbsp;<span class="ident" id="5152268">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152280">case</span>&nbsp;<span class="ident" id="5152285">stateJSDqStr</span><span class="op" id="5152297">,</span>&nbsp;<span class="ident" id="5152299">stateJSSqStr</span><span class="op" id="5152311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152315">s</span>&nbsp;<span class="op" id="5152317">=</span>&nbsp;<span class="builtinfunc" id="5152319">append</span><span class="op" id="5152325">(</span><span class="ident" id="5152326">s</span><span class="op" id="5152327">,</span>&nbsp;<span class="string" id="5152329">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5152357">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152360">case</span>&nbsp;<span class="ident" id="5152365">stateJSRegexp</span><span class="op" id="5152378">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152382">s</span>&nbsp;<span class="op" id="5152384">=</span>&nbsp;<span class="builtinfunc" id="5152386">append</span><span class="op" id="5152392">(</span><span class="ident" id="5152393">s</span><span class="op" id="5152394">,</span>&nbsp;<span class="string" id="5152396">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5152427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152430">case</span>&nbsp;<span class="ident" id="5152435">stateCSS</span><span class="op" id="5152443">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152447">s</span>&nbsp;<span class="op" id="5152449">=</span>&nbsp;<span class="builtinfunc" id="5152451">append</span><span class="op" id="5152457">(</span><span class="ident" id="5152458">s</span><span class="op" id="5152459">,</span>&nbsp;<span class="string" id="5152461">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5152491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152494">case</span>&nbsp;<span class="ident" id="5152499">stateText</span><span class="op" id="5152508">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152512">s</span>&nbsp;<span class="op" id="5152514">=</span>&nbsp;<span class="builtinfunc" id="5152516">append</span><span class="op" id="5152522">(</span><span class="ident" id="5152523">s</span><span class="op" id="5152524">,</span>&nbsp;<span class="string" id="5152526">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5152553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152556">case</span>&nbsp;<span class="ident" id="5152561">stateRCDATA</span><span class="op" id="5152572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152576">s</span>&nbsp;<span class="op" id="5152578">=</span>&nbsp;<span class="builtinfunc" id="5152580">append</span><span class="op" id="5152586">(</span><span class="ident" id="5152587">s</span><span class="op" id="5152588">,</span>&nbsp;<span class="string" id="5152590">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5152619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152622">case</span>&nbsp;<span class="ident" id="5152627">stateAttr</span><span class="op" id="5152636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5152640">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152674">case</span>&nbsp;<span class="ident" id="5152679">stateAttrName</span><span class="op" id="5152692">,</span>&nbsp;<span class="ident" id="5152694">stateTag</span><span class="op" id="5152702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152706">c</span><span class="op" id="5152707">.</span><span class="ident" id="5152708">state</span>&nbsp;<span class="op" id="5152714">=</span>&nbsp;<span class="ident" id="5152716">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152732">s</span>&nbsp;<span class="op" id="5152734">=</span>&nbsp;<span class="builtinfunc" id="5152736">append</span><span class="op" id="5152742">(</span><span class="ident" id="5152743">s</span><span class="op" id="5152744">,</span>&nbsp;<span class="string" id="5152746">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5152776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152779">default</span><span class="op" id="5152786">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152790">if</span>&nbsp;<span class="ident" id="5152793">isComment</span><span class="op" id="5152802">(</span><span class="ident" id="5152803">c</span><span class="op" id="5152804">.</span><span class="ident" id="5152805">state</span><span class="op" id="5152810">)</span>&nbsp;<span class="op" id="5152812">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152817">s</span>&nbsp;<span class="op" id="5152819">=</span>&nbsp;<span class="builtinfunc" id="5152821">append</span><span class="op" id="5152827">(</span><span class="ident" id="5152828">s</span><span class="op" id="5152829">,</span>&nbsp;<span class="string" id="5152831">&#34;html_template_commentescaper&#34;</span><span class="op" id="5152861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5152865">}</span>&nbsp;<span class="keyword" id="5152867">else</span>&nbsp;<span class="op" id="5152872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5152877">panic</span><span class="op" id="5152882">(</span><span class="string" id="5152883">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="5152903">+</span>&nbsp;<span class="ident" id="5152905">c</span><span class="op" id="5152906">.</span><span class="ident" id="5152907">state</span><span class="op" id="5152912">.</span><span class="ident" id="5152913">String</span><span class="op" id="5152919">(</span><span class="op" id="5152920">)</span><span class="op" id="5152921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5152925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5152928">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152931">switch</span>&nbsp;<span class="ident" id="5152938">c</span><span class="op" id="5152939">.</span><span class="ident" id="5152940">delim</span>&nbsp;<span class="op" id="5152946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5152949">case</span>&nbsp;<span class="ident" id="5152954">delimNone</span><span class="op" id="5152963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5152967">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153018">case</span>&nbsp;<span class="ident" id="5153023">delimSpaceOrTagEnd</span><span class="op" id="5153041">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153045">s</span>&nbsp;<span class="op" id="5153047">=</span>&nbsp;<span class="builtinfunc" id="5153049">append</span><span class="op" id="5153055">(</span><span class="ident" id="5153056">s</span><span class="op" id="5153057">,</span>&nbsp;<span class="string" id="5153059">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5153089">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153092">default</span><span class="op" id="5153099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153103">s</span>&nbsp;<span class="op" id="5153105">=</span>&nbsp;<span class="builtinfunc" id="5153107">append</span><span class="op" id="5153113">(</span><span class="ident" id="5153114">s</span><span class="op" id="5153115">,</span>&nbsp;<span class="string" id="5153117">&#34;html_template_attrescaper&#34;</span><span class="op" id="5153144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5153147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153150">e</span><span class="op" id="5153151">.</span><span class="ident" id="5153152">editActionNode</span><span class="op" id="5153166">(</span><span class="ident" id="5153167">n</span><span class="op" id="5153168">,</span>&nbsp;<span class="ident" id="5153170">s</span><span class="op" id="5153171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153174">return</span>&nbsp;<span class="ident" id="5153181">c</span><br>
<span class="lineno">205</span><span class="op" id="5153183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5153186">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="5153271">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="5153334">func</span>&nbsp;<span class="ident" id="5153339">allIdents</span><span class="op" id="5153348">(</span><span class="ident" id="5153349">node</span>&nbsp;<span class="ident" id="5153354">parse</span><span class="op" id="5153359">.</span><span class="ident" id="5153360">Node</span><span class="op" id="5153364">)</span>&nbsp;<span class="op" id="5153366">[</span><span class="op" id="5153367">]</span><span class="builtintype" id="5153368">string</span>&nbsp;<span class="op" id="5153375">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153378">switch</span>&nbsp;<span class="ident" id="5153385">node</span>&nbsp;<span class="op" id="5153390">:=</span>&nbsp;<span class="ident" id="5153393">node</span><span class="op" id="5153397">.</span><span class="op" id="5153398">(</span><span class="keyword" id="5153399">type</span><span class="op" id="5153403">)</span>&nbsp;<span class="op" id="5153405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153408">case</span>&nbsp;<span class="op" id="5153413">*</span><span class="ident" id="5153414">parse</span><span class="op" id="5153419">.</span><span class="ident" id="5153420">IdentifierNode</span><span class="op" id="5153434">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153438">return</span>&nbsp;<span class="op" id="5153445">[</span><span class="op" id="5153446">]</span><span class="builtintype" id="5153447">string</span><span class="op" id="5153453">{</span><span class="ident" id="5153454">node</span><span class="op" id="5153458">.</span><span class="ident" id="5153459">Ident</span><span class="op" id="5153464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153467">case</span>&nbsp;<span class="op" id="5153472">*</span><span class="ident" id="5153473">parse</span><span class="op" id="5153478">.</span><span class="ident" id="5153479">FieldNode</span><span class="op" id="5153488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153492">return</span>&nbsp;<span class="ident" id="5153499">node</span><span class="op" id="5153503">.</span><span class="ident" id="5153504">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5153511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5153514">panic</span><span class="op" id="5153519">(</span><span class="string" id="5153520">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="5153557">)</span><br>
<span class="lineno"></span><span class="op" id="5153559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5153562">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="5153632">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="5153666">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="5153739">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5153816">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="5153890">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="5153920">func</span>&nbsp;<span class="ident" id="5153925">ensurePipelineContains</span><span class="op" id="5153947">(</span><span class="ident" id="5153948">p</span>&nbsp;<span class="op" id="5153950">*</span><span class="ident" id="5153951">parse</span><span class="op" id="5153956">.</span><span class="ident" id="5153957">PipeNode</span><span class="op" id="5153965">,</span>&nbsp;<span class="ident" id="5153967">s</span>&nbsp;<span class="op" id="5153969">[</span><span class="op" id="5153970">]</span><span class="builtintype" id="5153971">string</span><span class="op" id="5153977">)</span>&nbsp;<span class="op" id="5153979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153982">if</span>&nbsp;<span class="builtinfunc" id="5153985">len</span><span class="op" id="5153988">(</span><span class="ident" id="5153989">s</span><span class="op" id="5153990">)</span>&nbsp;<span class="op" id="5153992">==</span>&nbsp;<span class="num" id="5153995">0</span>&nbsp;<span class="op" id="5153997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154001">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154012">n</span>&nbsp;<span class="op" id="5154014">:=</span>&nbsp;<span class="builtinfunc" id="5154017">len</span><span class="op" id="5154020">(</span><span class="ident" id="5154021">p</span><span class="op" id="5154022">.</span><span class="ident" id="5154023">Cmds</span><span class="op" id="5154027">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5154030">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154088">idents</span>&nbsp;<span class="op" id="5154095">:=</span>&nbsp;<span class="ident" id="5154098">p</span><span class="op" id="5154099">.</span><span class="ident" id="5154100">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154106">for</span>&nbsp;<span class="ident" id="5154110">i</span>&nbsp;<span class="op" id="5154112">:=</span>&nbsp;<span class="ident" id="5154115">n</span>&nbsp;<span class="op" id="5154117">-</span>&nbsp;<span class="num" id="5154119">1</span><span class="op" id="5154120">;</span>&nbsp;<span class="ident" id="5154122">i</span>&nbsp;<span class="op" id="5154124">&gt;=</span>&nbsp;<span class="num" id="5154127">0</span><span class="op" id="5154128">;</span>&nbsp;<span class="ident" id="5154130">i</span><span class="op" id="5154131">--</span>&nbsp;<span class="op" id="5154134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154138">if</span>&nbsp;<span class="ident" id="5154141">cmd</span>&nbsp;<span class="op" id="5154145">:=</span>&nbsp;<span class="ident" id="5154148">p</span><span class="op" id="5154149">.</span><span class="ident" id="5154150">Cmds</span><span class="op" id="5154154">[</span><span class="ident" id="5154155">i</span><span class="op" id="5154156">]</span><span class="op" id="5154157">;</span>&nbsp;<span class="builtinfunc" id="5154159">len</span><span class="op" id="5154162">(</span><span class="ident" id="5154163">cmd</span><span class="op" id="5154166">.</span><span class="ident" id="5154167">Args</span><span class="op" id="5154171">)</span>&nbsp;<span class="op" id="5154173">!=</span>&nbsp;<span class="num" id="5154176">0</span>&nbsp;<span class="op" id="5154178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154183">if</span>&nbsp;<span class="ident" id="5154186">_</span><span class="op" id="5154187">,</span>&nbsp;<span class="ident" id="5154189">ok</span>&nbsp;<span class="op" id="5154192">:=</span>&nbsp;<span class="ident" id="5154195">cmd</span><span class="op" id="5154198">.</span><span class="ident" id="5154199">Args</span><span class="op" id="5154203">[</span><span class="num" id="5154204">0</span><span class="op" id="5154205">]</span><span class="op" id="5154206">.</span><span class="op" id="5154207">(</span><span class="op" id="5154208">*</span><span class="ident" id="5154209">parse</span><span class="op" id="5154214">.</span><span class="ident" id="5154215">IdentifierNode</span><span class="op" id="5154229">)</span><span class="op" id="5154230">;</span>&nbsp;<span class="ident" id="5154232">ok</span>&nbsp;<span class="op" id="5154235">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154241">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154261">idents</span>&nbsp;<span class="op" id="5154268">=</span>&nbsp;<span class="ident" id="5154270">p</span><span class="op" id="5154271">.</span><span class="ident" id="5154272">Cmds</span><span class="op" id="5154276">[</span><span class="ident" id="5154277">i</span><span class="op" id="5154278">+</span><span class="num" id="5154279">1</span><span class="op" id="5154280">:</span><span class="op" id="5154281">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154284">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154287">dups</span>&nbsp;<span class="op" id="5154292">:=</span>&nbsp;<span class="num" id="5154295">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154298">for</span>&nbsp;<span class="ident" id="5154302">_</span><span class="op" id="5154303">,</span>&nbsp;<span class="ident" id="5154305">idNode</span>&nbsp;<span class="op" id="5154312">:=</span>&nbsp;<span class="keyword" id="5154315">range</span>&nbsp;<span class="ident" id="5154321">idents</span>&nbsp;<span class="op" id="5154328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154332">for</span>&nbsp;<span class="ident" id="5154336">_</span><span class="op" id="5154337">,</span>&nbsp;<span class="ident" id="5154339">ident</span>&nbsp;<span class="op" id="5154345">:=</span>&nbsp;<span class="keyword" id="5154348">range</span>&nbsp;<span class="ident" id="5154354">allIdents</span><span class="op" id="5154363">(</span><span class="ident" id="5154364">idNode</span><span class="op" id="5154370">.</span><span class="ident" id="5154371">Args</span><span class="op" id="5154375">[</span><span class="num" id="5154376">0</span><span class="op" id="5154377">]</span><span class="op" id="5154378">)</span>&nbsp;<span class="op" id="5154380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154385">if</span>&nbsp;<span class="ident" id="5154388">escFnsEq</span><span class="op" id="5154396">(</span><span class="ident" id="5154397">s</span><span class="op" id="5154398">[</span><span class="ident" id="5154399">dups</span><span class="op" id="5154403">]</span><span class="op" id="5154404">,</span>&nbsp;<span class="ident" id="5154406">ident</span><span class="op" id="5154411">)</span>&nbsp;<span class="op" id="5154413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154419">dups</span><span class="op" id="5154423">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154430">if</span>&nbsp;<span class="ident" id="5154433">dups</span>&nbsp;<span class="op" id="5154438">==</span>&nbsp;<span class="builtinfunc" id="5154441">len</span><span class="op" id="5154444">(</span><span class="ident" id="5154445">s</span><span class="op" id="5154446">)</span>&nbsp;<span class="op" id="5154448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154455">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154475">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154481">newCmds</span>&nbsp;<span class="op" id="5154489">:=</span>&nbsp;<span class="builtinfunc" id="5154492">make</span><span class="op" id="5154496">(</span><span class="op" id="5154497">[</span><span class="op" id="5154498">]</span><span class="op" id="5154499">*</span><span class="ident" id="5154500">parse</span><span class="op" id="5154505">.</span><span class="ident" id="5154506">CommandNode</span><span class="op" id="5154517">,</span>&nbsp;<span class="ident" id="5154519">n</span><span class="op" id="5154520">-</span><span class="builtinfunc" id="5154521">len</span><span class="op" id="5154524">(</span><span class="ident" id="5154525">idents</span><span class="op" id="5154531">)</span><span class="op" id="5154532">,</span>&nbsp;<span class="ident" id="5154534">n</span><span class="op" id="5154535">+</span><span class="builtinfunc" id="5154536">len</span><span class="op" id="5154539">(</span><span class="ident" id="5154540">s</span><span class="op" id="5154541">)</span><span class="op" id="5154542">-</span><span class="ident" id="5154543">dups</span><span class="op" id="5154547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5154550">copy</span><span class="op" id="5154554">(</span><span class="ident" id="5154555">newCmds</span><span class="op" id="5154562">,</span>&nbsp;<span class="ident" id="5154564">p</span><span class="op" id="5154565">.</span><span class="ident" id="5154566">Cmds</span><span class="op" id="5154570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5154573">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154640">for</span>&nbsp;<span class="ident" id="5154644">_</span><span class="op" id="5154645">,</span>&nbsp;<span class="ident" id="5154647">idNode</span>&nbsp;<span class="op" id="5154654">:=</span>&nbsp;<span class="keyword" id="5154657">range</span>&nbsp;<span class="ident" id="5154663">idents</span>&nbsp;<span class="op" id="5154670">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154674">pos</span>&nbsp;<span class="op" id="5154678">:=</span>&nbsp;<span class="ident" id="5154681">idNode</span><span class="op" id="5154687">.</span><span class="ident" id="5154688">Args</span><span class="op" id="5154692">[</span><span class="num" id="5154693">0</span><span class="op" id="5154694">]</span><span class="op" id="5154695">.</span><span class="ident" id="5154696">Position</span><span class="op" id="5154704">(</span><span class="op" id="5154705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154709">for</span>&nbsp;<span class="ident" id="5154713">_</span><span class="op" id="5154714">,</span>&nbsp;<span class="ident" id="5154716">ident</span>&nbsp;<span class="op" id="5154722">:=</span>&nbsp;<span class="keyword" id="5154725">range</span>&nbsp;<span class="ident" id="5154731">allIdents</span><span class="op" id="5154740">(</span><span class="ident" id="5154741">idNode</span><span class="op" id="5154747">.</span><span class="ident" id="5154748">Args</span><span class="op" id="5154752">[</span><span class="num" id="5154753">0</span><span class="op" id="5154754">]</span><span class="op" id="5154755">)</span>&nbsp;<span class="op" id="5154757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154762">i</span>&nbsp;<span class="op" id="5154764">:=</span>&nbsp;<span class="ident" id="5154767">indexOfStr</span><span class="op" id="5154777">(</span><span class="ident" id="5154778">ident</span><span class="op" id="5154783">,</span>&nbsp;<span class="ident" id="5154785">s</span><span class="op" id="5154786">,</span>&nbsp;<span class="ident" id="5154788">escFnsEq</span><span class="op" id="5154796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154801">if</span>&nbsp;<span class="ident" id="5154804">i</span>&nbsp;<span class="op" id="5154806">!=</span>&nbsp;<span class="op" id="5154809">-</span><span class="num" id="5154810">1</span>&nbsp;<span class="op" id="5154812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154818">for</span>&nbsp;<span class="ident" id="5154822">_</span><span class="op" id="5154823">,</span>&nbsp;<span class="ident" id="5154825">name</span>&nbsp;<span class="op" id="5154830">:=</span>&nbsp;<span class="keyword" id="5154833">range</span>&nbsp;<span class="ident" id="5154839">s</span><span class="op" id="5154840">[</span><span class="op" id="5154841">:</span><span class="ident" id="5154842">i</span><span class="op" id="5154843">]</span>&nbsp;<span class="op" id="5154845">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154852">newCmds</span>&nbsp;<span class="op" id="5154860">=</span>&nbsp;<span class="ident" id="5154862">appendCmd</span><span class="op" id="5154871">(</span><span class="ident" id="5154872">newCmds</span><span class="op" id="5154879">,</span>&nbsp;<span class="ident" id="5154881">newIdentCmd</span><span class="op" id="5154892">(</span><span class="ident" id="5154893">name</span><span class="op" id="5154897">,</span>&nbsp;<span class="ident" id="5154899">pos</span><span class="op" id="5154902">)</span><span class="op" id="5154903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154915">s</span>&nbsp;<span class="op" id="5154917">=</span>&nbsp;<span class="ident" id="5154919">s</span><span class="op" id="5154920">[</span><span class="ident" id="5154921">i</span><span class="op" id="5154922">+</span><span class="num" id="5154923">1</span><span class="op" id="5154924">:</span><span class="op" id="5154925">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154934">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154938">newCmds</span>&nbsp;<span class="op" id="5154946">=</span>&nbsp;<span class="ident" id="5154948">appendCmd</span><span class="op" id="5154957">(</span><span class="ident" id="5154958">newCmds</span><span class="op" id="5154965">,</span>&nbsp;<span class="ident" id="5154967">idNode</span><span class="op" id="5154973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5154979">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155016">for</span>&nbsp;<span class="ident" id="5155020">_</span><span class="op" id="5155021">,</span>&nbsp;<span class="ident" id="5155023">name</span>&nbsp;<span class="op" id="5155028">:=</span>&nbsp;<span class="keyword" id="5155031">range</span>&nbsp;<span class="ident" id="5155037">s</span>&nbsp;<span class="op" id="5155039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155043">newCmds</span>&nbsp;<span class="op" id="5155051">=</span>&nbsp;<span class="ident" id="5155053">appendCmd</span><span class="op" id="5155062">(</span><span class="ident" id="5155063">newCmds</span><span class="op" id="5155070">,</span>&nbsp;<span class="ident" id="5155072">newIdentCmd</span><span class="op" id="5155083">(</span><span class="ident" id="5155084">name</span><span class="op" id="5155088">,</span>&nbsp;<span class="ident" id="5155090">p</span><span class="op" id="5155091">.</span><span class="ident" id="5155092">Position</span><span class="op" id="5155100">(</span><span class="op" id="5155101">)</span><span class="op" id="5155102">)</span><span class="op" id="5155103">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155109">p</span><span class="op" id="5155110">.</span><span class="ident" id="5155111">Cmds</span>&nbsp;<span class="op" id="5155116">=</span>&nbsp;<span class="ident" id="5155118">newCmds</span><br>
<span class="lineno"></span><span class="op" id="5155126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5155129">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="5155209">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="5155223">var</span>&nbsp;<span class="ident" id="5155227">redundantFuncs</span>&nbsp;<span class="op" id="5155242">=</span>&nbsp;<span class="keyword" id="5155244">map</span><span class="op" id="5155247">[</span><span class="builtintype" id="5155248">string</span><span class="op" id="5155254">]</span><span class="keyword" id="5155255">map</span><span class="op" id="5155258">[</span><span class="builtintype" id="5155259">string</span><span class="op" id="5155265">]</span><span class="builtintype" id="5155266">bool</span><span class="op" id="5155270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155273">&#34;html_template_commentescaper&#34;</span><span class="op" id="5155303">:</span>&nbsp;<span class="op" id="5155305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155309">&#34;html_template_attrescaper&#34;</span><span class="op" id="5155336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5155341">true</span><span class="op" id="5155345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155349">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5155379">:</span>&nbsp;<span class="builtintype" id="5155381">true</span><span class="op" id="5155385">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155389">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5155416">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5155421">true</span><span class="op" id="5155425">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155428">}</span><span class="op" id="5155429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155432">&#34;html_template_cssescaper&#34;</span><span class="op" id="5155458">:</span>&nbsp;<span class="op" id="5155460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155464">&#34;html_template_attrescaper&#34;</span><span class="op" id="5155491">:</span>&nbsp;<span class="builtintype" id="5155493">true</span><span class="op" id="5155497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155500">}</span><span class="op" id="5155501">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155504">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5155535">:</span>&nbsp;<span class="op" id="5155537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155541">&#34;html_template_attrescaper&#34;</span><span class="op" id="5155568">:</span>&nbsp;<span class="builtintype" id="5155570">true</span><span class="op" id="5155574">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155577">}</span><span class="op" id="5155578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155581">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5155609">:</span>&nbsp;<span class="op" id="5155611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155615">&#34;html_template_attrescaper&#34;</span><span class="op" id="5155642">:</span>&nbsp;<span class="builtintype" id="5155644">true</span><span class="op" id="5155648">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155651">}</span><span class="op" id="5155652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155655">&#34;html_template_urlescaper&#34;</span><span class="op" id="5155681">:</span>&nbsp;<span class="op" id="5155683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5155687">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5155716">:</span>&nbsp;<span class="builtintype" id="5155718">true</span><span class="op" id="5155722">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155725">}</span><span class="op" id="5155726">,</span><br>
<span class="lineno"></span><span class="op" id="5155728">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="5155731">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="5155805">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5155854">func</span>&nbsp;<span class="ident" id="5155859">appendCmd</span><span class="op" id="5155868">(</span><span class="ident" id="5155869">cmds</span>&nbsp;<span class="op" id="5155874">[</span><span class="op" id="5155875">]</span><span class="op" id="5155876">*</span><span class="ident" id="5155877">parse</span><span class="op" id="5155882">.</span><span class="ident" id="5155883">CommandNode</span><span class="op" id="5155894">,</span>&nbsp;<span class="ident" id="5155896">cmd</span>&nbsp;<span class="op" id="5155900">*</span><span class="ident" id="5155901">parse</span><span class="op" id="5155906">.</span><span class="ident" id="5155907">CommandNode</span><span class="op" id="5155918">)</span>&nbsp;<span class="op" id="5155920">[</span><span class="op" id="5155921">]</span><span class="op" id="5155922">*</span><span class="ident" id="5155923">parse</span><span class="op" id="5155928">.</span><span class="ident" id="5155929">CommandNode</span>&nbsp;<span class="op" id="5155941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155944">if</span>&nbsp;<span class="ident" id="5155947">n</span>&nbsp;<span class="op" id="5155949">:=</span>&nbsp;<span class="builtinfunc" id="5155952">len</span><span class="op" id="5155955">(</span><span class="ident" id="5155956">cmds</span><span class="op" id="5155960">)</span><span class="op" id="5155961">;</span>&nbsp;<span class="ident" id="5155963">n</span>&nbsp;<span class="op" id="5155965">!=</span>&nbsp;<span class="num" id="5155968">0</span>&nbsp;<span class="op" id="5155970">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155974">last</span><span class="op" id="5155978">,</span>&nbsp;<span class="ident" id="5155980">ok</span>&nbsp;<span class="op" id="5155983">:=</span>&nbsp;<span class="ident" id="5155986">cmds</span><span class="op" id="5155990">[</span><span class="ident" id="5155991">n</span><span class="op" id="5155992">-</span><span class="num" id="5155993">1</span><span class="op" id="5155994">]</span><span class="op" id="5155995">.</span><span class="ident" id="5155996">Args</span><span class="op" id="5156000">[</span><span class="num" id="5156001">0</span><span class="op" id="5156002">]</span><span class="op" id="5156003">.</span><span class="op" id="5156004">(</span><span class="op" id="5156005">*</span><span class="ident" id="5156006">parse</span><span class="op" id="5156011">.</span><span class="ident" id="5156012">IdentifierNode</span><span class="op" id="5156026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156030">next</span><span class="op" id="5156034">,</span>&nbsp;<span class="ident" id="5156036">_</span>&nbsp;<span class="op" id="5156038">:=</span>&nbsp;<span class="ident" id="5156041">cmd</span><span class="op" id="5156044">.</span><span class="ident" id="5156045">Args</span><span class="op" id="5156049">[</span><span class="num" id="5156050">0</span><span class="op" id="5156051">]</span><span class="op" id="5156052">.</span><span class="op" id="5156053">(</span><span class="op" id="5156054">*</span><span class="ident" id="5156055">parse</span><span class="op" id="5156060">.</span><span class="ident" id="5156061">IdentifierNode</span><span class="op" id="5156075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156079">if</span>&nbsp;<span class="ident" id="5156082">ok</span>&nbsp;<span class="op" id="5156085">&amp;&amp;</span>&nbsp;<span class="ident" id="5156088">redundantFuncs</span><span class="op" id="5156102">[</span><span class="ident" id="5156103">last</span><span class="op" id="5156107">.</span><span class="ident" id="5156108">Ident</span><span class="op" id="5156113">]</span><span class="op" id="5156114">[</span><span class="ident" id="5156115">next</span><span class="op" id="5156119">.</span><span class="ident" id="5156120">Ident</span><span class="op" id="5156125">]</span>&nbsp;<span class="op" id="5156127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156132">return</span>&nbsp;<span class="ident" id="5156139">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156146">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156152">return</span>&nbsp;<span class="builtinfunc" id="5156159">append</span><span class="op" id="5156165">(</span><span class="ident" id="5156166">cmds</span><span class="op" id="5156170">,</span>&nbsp;<span class="ident" id="5156172">cmd</span><span class="op" id="5156175">)</span><br>
<span class="lineno"></span><span class="op" id="5156177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5156180">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="5156260">func</span>&nbsp;<span class="ident" id="5156265">indexOfStr</span><span class="op" id="5156275">(</span><span class="ident" id="5156276">s</span>&nbsp;<span class="builtintype" id="5156278">string</span><span class="op" id="5156284">,</span>&nbsp;<span class="ident" id="5156286">strs</span>&nbsp;<span class="op" id="5156291">[</span><span class="op" id="5156292">]</span><span class="builtintype" id="5156293">string</span><span class="op" id="5156299">,</span>&nbsp;<span class="ident" id="5156301">eq</span>&nbsp;<span class="keyword" id="5156304">func</span><span class="op" id="5156308">(</span><span class="ident" id="5156309">a</span><span class="op" id="5156310">,</span>&nbsp;<span class="ident" id="5156312">b</span>&nbsp;<span class="builtintype" id="5156314">string</span><span class="op" id="5156320">)</span>&nbsp;<span class="builtintype" id="5156322">bool</span><span class="op" id="5156326">)</span>&nbsp;<span class="builtintype" id="5156328">int</span>&nbsp;<span class="op" id="5156332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156335">for</span>&nbsp;<span class="ident" id="5156339">i</span><span class="op" id="5156340">,</span>&nbsp;<span class="ident" id="5156342">t</span>&nbsp;<span class="op" id="5156344">:=</span>&nbsp;<span class="keyword" id="5156347">range</span>&nbsp;<span class="ident" id="5156353">strs</span>&nbsp;<span class="op" id="5156358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156362">if</span>&nbsp;<span class="ident" id="5156365">eq</span><span class="op" id="5156367">(</span><span class="ident" id="5156368">s</span><span class="op" id="5156369">,</span>&nbsp;<span class="ident" id="5156371">t</span><span class="op" id="5156372">)</span>&nbsp;<span class="op" id="5156374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156379">return</span>&nbsp;<span class="ident" id="5156386">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156390">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156396">return</span>&nbsp;<span class="op" id="5156403">-</span><span class="num" id="5156404">1</span><br>
<span class="lineno"></span><span class="op" id="5156406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5156409">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="5156480">func</span>&nbsp;<span class="ident" id="5156485">escFnsEq</span><span class="op" id="5156493">(</span><span class="ident" id="5156494">a</span><span class="op" id="5156495">,</span>&nbsp;<span class="ident" id="5156497">b</span>&nbsp;<span class="builtintype" id="5156499">string</span><span class="op" id="5156505">)</span>&nbsp;<span class="builtintype" id="5156507">bool</span>&nbsp;<span class="op" id="5156512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156515">if</span>&nbsp;<span class="ident" id="5156518">e</span>&nbsp;<span class="op" id="5156520">:=</span>&nbsp;<span class="ident" id="5156523">equivEscapers</span><span class="op" id="5156536">[</span><span class="ident" id="5156537">a</span><span class="op" id="5156538">]</span><span class="op" id="5156539">;</span>&nbsp;<span class="ident" id="5156541">e</span>&nbsp;<span class="op" id="5156543">!=</span>&nbsp;<span class="string" id="5156546">&#34;&#34;</span>&nbsp;<span class="op" id="5156549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156553">a</span>&nbsp;<span class="op" id="5156555">=</span>&nbsp;<span class="ident" id="5156557">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156563">if</span>&nbsp;<span class="ident" id="5156566">e</span>&nbsp;<span class="op" id="5156568">:=</span>&nbsp;<span class="ident" id="5156571">equivEscapers</span><span class="op" id="5156584">[</span><span class="ident" id="5156585">b</span><span class="op" id="5156586">]</span><span class="op" id="5156587">;</span>&nbsp;<span class="ident" id="5156589">e</span>&nbsp;<span class="op" id="5156591">!=</span>&nbsp;<span class="string" id="5156594">&#34;&#34;</span>&nbsp;<span class="op" id="5156597">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156601">b</span>&nbsp;<span class="op" id="5156603">=</span>&nbsp;<span class="ident" id="5156605">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156611">return</span>&nbsp;<span class="ident" id="5156618">a</span>&nbsp;<span class="op" id="5156620">==</span>&nbsp;<span class="ident" id="5156623">b</span><br>
<span class="lineno"></span><span class="op" id="5156625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="5156628">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5156699">func</span>&nbsp;<span class="ident" id="5156704">newIdentCmd</span><span class="op" id="5156715">(</span><span class="ident" id="5156716">identifier</span>&nbsp;<span class="builtintype" id="5156727">string</span><span class="op" id="5156733">,</span>&nbsp;<span class="ident" id="5156735">pos</span>&nbsp;<span class="ident" id="5156739">parse</span><span class="op" id="5156744">.</span><span class="ident" id="5156745">Pos</span><span class="op" id="5156748">)</span>&nbsp;<span class="op" id="5156750">*</span><span class="ident" id="5156751">parse</span><span class="op" id="5156756">.</span><span class="ident" id="5156757">CommandNode</span>&nbsp;<span class="op" id="5156769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156772">return</span>&nbsp;<span class="op" id="5156779">&amp;</span><span class="ident" id="5156780">parse</span><span class="op" id="5156785">.</span><span class="ident" id="5156786">CommandNode</span><span class="op" id="5156797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156801">NodeType</span><span class="op" id="5156809">:</span>&nbsp;<span class="ident" id="5156811">parse</span><span class="op" id="5156816">.</span><span class="ident" id="5156817">NodeCommand</span><span class="op" id="5156828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156832">Args</span><span class="op" id="5156836">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156842">[</span><span class="op" id="5156843">]</span><span class="ident" id="5156844">parse</span><span class="op" id="5156849">.</span><span class="ident" id="5156850">Node</span><span class="op" id="5156854">{</span><span class="ident" id="5156855">parse</span><span class="op" id="5156860">.</span><span class="ident" id="5156861">NewIdentifier</span><span class="op" id="5156874">(</span><span class="ident" id="5156875">identifier</span><span class="op" id="5156885">)</span><span class="op" id="5156886">.</span><span class="ident" id="5156887">SetTree</span><span class="op" id="5156894">(</span><span class="builtintype" id="5156895">nil</span><span class="op" id="5156898">)</span><span class="op" id="5156899">.</span><span class="ident" id="5156900">SetPos</span><span class="op" id="5156906">(</span><span class="ident" id="5156907">pos</span><span class="op" id="5156910">)</span><span class="op" id="5156911">}</span><span class="op" id="5156912">,</span>&nbsp;<span class="comment" id="5156914">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156933">}</span><br>
<span class="lineno"></span><span class="op" id="5156935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5156938">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5157013">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="5157052">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="5157077">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="5157095">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="5157174">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="5157193">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="5157252">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="5157315">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5157393">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5157425">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5157491">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="5157556">func</span>&nbsp;<span class="ident" id="5157561">nudge</span><span class="op" id="5157566">(</span><span class="ident" id="5157567">c</span>&nbsp;<span class="ident" id="5157569">context</span><span class="op" id="5157576">)</span>&nbsp;<span class="ident" id="5157578">context</span>&nbsp;<span class="op" id="5157586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157589">switch</span>&nbsp;<span class="ident" id="5157596">c</span><span class="op" id="5157597">.</span><span class="ident" id="5157598">state</span>&nbsp;<span class="op" id="5157604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157607">case</span>&nbsp;<span class="ident" id="5157612">stateTag</span><span class="op" id="5157620">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5157624">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157683">c</span><span class="op" id="5157684">.</span><span class="ident" id="5157685">state</span>&nbsp;<span class="op" id="5157691">=</span>&nbsp;<span class="ident" id="5157693">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157708">case</span>&nbsp;<span class="ident" id="5157713">stateBeforeValue</span><span class="op" id="5157729">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5157733">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157795">c</span><span class="op" id="5157796">.</span><span class="ident" id="5157797">state</span><span class="op" id="5157802">,</span>&nbsp;<span class="ident" id="5157804">c</span><span class="op" id="5157805">.</span><span class="ident" id="5157806">delim</span><span class="op" id="5157811">,</span>&nbsp;<span class="ident" id="5157813">c</span><span class="op" id="5157814">.</span><span class="ident" id="5157815">attr</span>&nbsp;<span class="op" id="5157820">=</span>&nbsp;<span class="ident" id="5157822">attrStartStates</span><span class="op" id="5157837">[</span><span class="ident" id="5157838">c</span><span class="op" id="5157839">.</span><span class="ident" id="5157840">attr</span><span class="op" id="5157844">]</span><span class="op" id="5157845">,</span>&nbsp;<span class="ident" id="5157847">delimSpaceOrTagEnd</span><span class="op" id="5157865">,</span>&nbsp;<span class="ident" id="5157867">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157877">case</span>&nbsp;<span class="ident" id="5157882">stateAfterName</span><span class="op" id="5157896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5157900">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157959">c</span><span class="op" id="5157960">.</span><span class="ident" id="5157961">state</span><span class="op" id="5157966">,</span>&nbsp;<span class="ident" id="5157968">c</span><span class="op" id="5157969">.</span><span class="ident" id="5157970">attr</span>&nbsp;<span class="op" id="5157975">=</span>&nbsp;<span class="ident" id="5157977">stateAttrName</span><span class="op" id="5157990">,</span>&nbsp;<span class="ident" id="5157992">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158005">return</span>&nbsp;<span class="ident" id="5158012">c</span><br>
<span class="lineno"></span><span class="op" id="5158014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="5158017">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5158092">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5158171">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="5158201">func</span>&nbsp;<span class="ident" id="5158206">join</span><span class="op" id="5158210">(</span><span class="ident" id="5158211">a</span><span class="op" id="5158212">,</span>&nbsp;<span class="ident" id="5158214">b</span>&nbsp;<span class="ident" id="5158216">context</span><span class="op" id="5158223">,</span>&nbsp;<span class="ident" id="5158225">node</span>&nbsp;<span class="ident" id="5158230">parse</span><span class="op" id="5158235">.</span><span class="ident" id="5158236">Node</span><span class="op" id="5158240">,</span>&nbsp;<span class="ident" id="5158242">nodeName</span>&nbsp;<span class="builtintype" id="5158251">string</span><span class="op" id="5158257">)</span>&nbsp;<span class="ident" id="5158259">context</span>&nbsp;<span class="op" id="5158267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158270">if</span>&nbsp;<span class="ident" id="5158273">a</span><span class="op" id="5158274">.</span><span class="ident" id="5158275">state</span>&nbsp;<span class="op" id="5158281">==</span>&nbsp;<span class="ident" id="5158284">stateError</span>&nbsp;<span class="op" id="5158295">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158299">return</span>&nbsp;<span class="ident" id="5158306">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158312">if</span>&nbsp;<span class="ident" id="5158315">b</span><span class="op" id="5158316">.</span><span class="ident" id="5158317">state</span>&nbsp;<span class="op" id="5158323">==</span>&nbsp;<span class="ident" id="5158326">stateError</span>&nbsp;<span class="op" id="5158337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158341">return</span>&nbsp;<span class="ident" id="5158348">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158351">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158354">if</span>&nbsp;<span class="ident" id="5158357">a</span><span class="op" id="5158358">.</span><span class="ident" id="5158359">eq</span><span class="op" id="5158361">(</span><span class="ident" id="5158362">b</span><span class="op" id="5158363">)</span>&nbsp;<span class="op" id="5158365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158369">return</span>&nbsp;<span class="ident" id="5158376">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158383">c</span>&nbsp;<span class="op" id="5158385">:=</span>&nbsp;<span class="ident" id="5158388">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158391">c</span><span class="op" id="5158392">.</span><span class="ident" id="5158393">urlPart</span>&nbsp;<span class="op" id="5158401">=</span>&nbsp;<span class="ident" id="5158403">b</span><span class="op" id="5158404">.</span><span class="ident" id="5158405">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158414">if</span>&nbsp;<span class="ident" id="5158417">c</span><span class="op" id="5158418">.</span><span class="ident" id="5158419">eq</span><span class="op" id="5158421">(</span><span class="ident" id="5158422">b</span><span class="op" id="5158423">)</span>&nbsp;<span class="op" id="5158425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158429">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158471">c</span><span class="op" id="5158472">.</span><span class="ident" id="5158473">urlPart</span>&nbsp;<span class="op" id="5158481">=</span>&nbsp;<span class="ident" id="5158483">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158500">return</span>&nbsp;<span class="ident" id="5158507">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158514">c</span>&nbsp;<span class="op" id="5158516">=</span>&nbsp;<span class="ident" id="5158518">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158521">c</span><span class="op" id="5158522">.</span><span class="ident" id="5158523">jsCtx</span>&nbsp;<span class="op" id="5158529">=</span>&nbsp;<span class="ident" id="5158531">b</span><span class="op" id="5158532">.</span><span class="ident" id="5158533">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158540">if</span>&nbsp;<span class="ident" id="5158543">c</span><span class="op" id="5158544">.</span><span class="ident" id="5158545">eq</span><span class="op" id="5158547">(</span><span class="ident" id="5158548">b</span><span class="op" id="5158549">)</span>&nbsp;<span class="op" id="5158551">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158555">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158595">c</span><span class="op" id="5158596">.</span><span class="ident" id="5158597">jsCtx</span>&nbsp;<span class="op" id="5158603">=</span>&nbsp;<span class="ident" id="5158605">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158620">return</span>&nbsp;<span class="ident" id="5158627">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158634">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158691">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158711">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158748">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158812">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158842">if</span>&nbsp;<span class="ident" id="5158845">c</span><span class="op" id="5158846">,</span>&nbsp;<span class="ident" id="5158848">d</span>&nbsp;<span class="op" id="5158850">:=</span>&nbsp;<span class="ident" id="5158853">nudge</span><span class="op" id="5158858">(</span><span class="ident" id="5158859">a</span><span class="op" id="5158860">)</span><span class="op" id="5158861">,</span>&nbsp;<span class="ident" id="5158863">nudge</span><span class="op" id="5158868">(</span><span class="ident" id="5158869">b</span><span class="op" id="5158870">)</span><span class="op" id="5158871">;</span>&nbsp;<span class="op" id="5158873">!</span><span class="op" id="5158874">(</span><span class="ident" id="5158875">c</span><span class="op" id="5158876">.</span><span class="ident" id="5158877">eq</span><span class="op" id="5158879">(</span><span class="ident" id="5158880">a</span><span class="op" id="5158881">)</span>&nbsp;<span class="op" id="5158883">&amp;&amp;</span>&nbsp;<span class="ident" id="5158886">d</span><span class="op" id="5158887">.</span><span class="ident" id="5158888">eq</span><span class="op" id="5158890">(</span><span class="ident" id="5158891">b</span><span class="op" id="5158892">)</span><span class="op" id="5158893">)</span>&nbsp;<span class="op" id="5158895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158899">if</span>&nbsp;<span class="ident" id="5158902">e</span>&nbsp;<span class="op" id="5158904">:=</span>&nbsp;<span class="ident" id="5158907">join</span><span class="op" id="5158911">(</span><span class="ident" id="5158912">c</span><span class="op" id="5158913">,</span>&nbsp;<span class="ident" id="5158915">d</span><span class="op" id="5158916">,</span>&nbsp;<span class="ident" id="5158918">node</span><span class="op" id="5158922">,</span>&nbsp;<span class="ident" id="5158924">nodeName</span><span class="op" id="5158932">)</span><span class="op" id="5158933">;</span>&nbsp;<span class="ident" id="5158935">e</span><span class="op" id="5158936">.</span><span class="ident" id="5158937">state</span>&nbsp;<span class="op" id="5158943">!=</span>&nbsp;<span class="ident" id="5158946">stateError</span>&nbsp;<span class="op" id="5158957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158962">return</span>&nbsp;<span class="ident" id="5158969">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158976">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158980">return</span>&nbsp;<span class="ident" id="5158987">context</span><span class="op" id="5158994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158998">state</span><span class="op" id="5159003">:</span>&nbsp;<span class="ident" id="5159005">stateError</span><span class="op" id="5159015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159019">err</span><span class="op" id="5159022">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5159026">errorf</span><span class="op" id="5159032">(</span><span class="ident" id="5159033">ErrBranchEnd</span><span class="op" id="5159045">,</span>&nbsp;<span class="ident" id="5159047">node</span><span class="op" id="5159051">,</span>&nbsp;<span class="num" id="5159053">0</span><span class="op" id="5159054">,</span>&nbsp;<span class="string" id="5159056">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="5159107">,</span>&nbsp;<span class="ident" id="5159109">nodeName</span><span class="op" id="5159117">,</span>&nbsp;<span class="ident" id="5159119">a</span><span class="op" id="5159120">,</span>&nbsp;<span class="ident" id="5159122">b</span><span class="op" id="5159123">)</span><span class="op" id="5159124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159127">}</span><br>
<span class="lineno">410</span><span class="op" id="5159129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5159132">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5159206">func</span>&nbsp;<span class="op" id="5159211">(</span><span class="ident" id="5159212">e</span>&nbsp;<span class="op" id="5159214">*</span><span class="ident" id="5159215">escaper</span><span class="op" id="5159222">)</span>&nbsp;<span class="ident" id="5159224">escapeBranch</span><span class="op" id="5159236">(</span><span class="ident" id="5159237">c</span>&nbsp;<span class="ident" id="5159239">context</span><span class="op" id="5159246">,</span>&nbsp;<span class="ident" id="5159248">n</span>&nbsp;<span class="op" id="5159250">*</span><span class="ident" id="5159251">parse</span><span class="op" id="5159256">.</span><span class="ident" id="5159257">BranchNode</span><span class="op" id="5159267">,</span>&nbsp;<span class="ident" id="5159269">nodeName</span>&nbsp;<span class="builtintype" id="5159278">string</span><span class="op" id="5159284">)</span>&nbsp;<span class="ident" id="5159286">context</span>&nbsp;<span class="op" id="5159294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159297">c0</span>&nbsp;<span class="op" id="5159300">:=</span>&nbsp;<span class="ident" id="5159303">e</span><span class="op" id="5159304">.</span><span class="ident" id="5159305">escapeList</span><span class="op" id="5159315">(</span><span class="ident" id="5159316">c</span><span class="op" id="5159317">,</span>&nbsp;<span class="ident" id="5159319">n</span><span class="op" id="5159320">.</span><span class="ident" id="5159321">List</span><span class="op" id="5159325">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159328">if</span>&nbsp;<span class="ident" id="5159331">nodeName</span>&nbsp;<span class="op" id="5159340">==</span>&nbsp;<span class="string" id="5159343">&#34;range&#34;</span>&nbsp;<span class="op" id="5159351">&amp;&amp;</span>&nbsp;<span class="ident" id="5159354">c0</span><span class="op" id="5159356">.</span><span class="ident" id="5159357">state</span>&nbsp;<span class="op" id="5159363">!=</span>&nbsp;<span class="ident" id="5159366">stateError</span>&nbsp;<span class="op" id="5159377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159381">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159450">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159519">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159551">c1</span><span class="op" id="5159553">,</span>&nbsp;<span class="ident" id="5159555">_</span>&nbsp;<span class="op" id="5159557">:=</span>&nbsp;<span class="ident" id="5159560">e</span><span class="op" id="5159561">.</span><span class="ident" id="5159562">escapeListConditionally</span><span class="op" id="5159585">(</span><span class="ident" id="5159586">c0</span><span class="op" id="5159588">,</span>&nbsp;<span class="ident" id="5159590">n</span><span class="op" id="5159591">.</span><span class="ident" id="5159592">List</span><span class="op" id="5159596">,</span>&nbsp;<span class="builtintype" id="5159598">nil</span><span class="op" id="5159601">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159605">c0</span>&nbsp;<span class="op" id="5159608">=</span>&nbsp;<span class="ident" id="5159610">join</span><span class="op" id="5159614">(</span><span class="ident" id="5159615">c0</span><span class="op" id="5159617">,</span>&nbsp;<span class="ident" id="5159619">c1</span><span class="op" id="5159621">,</span>&nbsp;<span class="ident" id="5159623">n</span><span class="op" id="5159624">,</span>&nbsp;<span class="ident" id="5159626">nodeName</span><span class="op" id="5159634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159638">if</span>&nbsp;<span class="ident" id="5159641">c0</span><span class="op" id="5159643">.</span><span class="ident" id="5159644">state</span>&nbsp;<span class="op" id="5159650">==</span>&nbsp;<span class="ident" id="5159653">stateError</span>&nbsp;<span class="op" id="5159664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159669">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159726">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159783">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159810">c0</span><span class="op" id="5159812">.</span><span class="ident" id="5159813">err</span><span class="op" id="5159816">.</span><span class="ident" id="5159817">Line</span>&nbsp;<span class="op" id="5159822">=</span>&nbsp;<span class="ident" id="5159824">n</span><span class="op" id="5159825">.</span><span class="ident" id="5159826">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159834">c0</span><span class="op" id="5159836">.</span><span class="ident" id="5159837">err</span><span class="op" id="5159840">.</span><span class="ident" id="5159841">Description</span>&nbsp;<span class="op" id="5159853">=</span>&nbsp;<span class="string" id="5159855">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="5159882">+</span>&nbsp;<span class="ident" id="5159884">c0</span><span class="op" id="5159886">.</span><span class="ident" id="5159887">err</span><span class="op" id="5159890">.</span><span class="ident" id="5159891">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159906">return</span>&nbsp;<span class="ident" id="5159913">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159921">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159924">c1</span>&nbsp;<span class="op" id="5159927">:=</span>&nbsp;<span class="ident" id="5159930">e</span><span class="op" id="5159931">.</span><span class="ident" id="5159932">escapeList</span><span class="op" id="5159942">(</span><span class="ident" id="5159943">c</span><span class="op" id="5159944">,</span>&nbsp;<span class="ident" id="5159946">n</span><span class="op" id="5159947">.</span><span class="ident" id="5159948">ElseList</span><span class="op" id="5159956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159959">return</span>&nbsp;<span class="ident" id="5159966">join</span><span class="op" id="5159970">(</span><span class="ident" id="5159971">c0</span><span class="op" id="5159973">,</span>&nbsp;<span class="ident" id="5159975">c1</span><span class="op" id="5159977">,</span>&nbsp;<span class="ident" id="5159979">n</span><span class="op" id="5159980">,</span>&nbsp;<span class="ident" id="5159982">nodeName</span><span class="op" id="5159990">)</span><br>
<span class="lineno"></span><span class="op" id="5159992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5159995">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="5160039">func</span>&nbsp;<span class="op" id="5160044">(</span><span class="ident" id="5160045">e</span>&nbsp;<span class="op" id="5160047">*</span><span class="ident" id="5160048">escaper</span><span class="op" id="5160055">)</span>&nbsp;<span class="ident" id="5160057">escapeList</span><span class="op" id="5160067">(</span><span class="ident" id="5160068">c</span>&nbsp;<span class="ident" id="5160070">context</span><span class="op" id="5160077">,</span>&nbsp;<span class="ident" id="5160079">n</span>&nbsp;<span class="op" id="5160081">*</span><span class="ident" id="5160082">parse</span><span class="op" id="5160087">.</span><span class="ident" id="5160088">ListNode</span><span class="op" id="5160096">)</span>&nbsp;<span class="ident" id="5160098">context</span>&nbsp;<span class="op" id="5160106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160109">if</span>&nbsp;<span class="ident" id="5160112">n</span>&nbsp;<span class="op" id="5160114">==</span>&nbsp;<span class="builtintype" id="5160117">nil</span>&nbsp;<span class="op" id="5160121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160125">return</span>&nbsp;<span class="ident" id="5160132">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5160135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160138">for</span>&nbsp;<span class="ident" id="5160142">_</span><span class="op" id="5160143">,</span>&nbsp;<span class="ident" id="5160145">m</span>&nbsp;<span class="op" id="5160147">:=</span>&nbsp;<span class="keyword" id="5160150">range</span>&nbsp;<span class="ident" id="5160156">n</span><span class="op" id="5160157">.</span><span class="ident" id="5160158">Nodes</span>&nbsp;<span class="op" id="5160164">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160168">c</span>&nbsp;<span class="op" id="5160170">=</span>&nbsp;<span class="ident" id="5160172">e</span><span class="op" id="5160173">.</span><span class="ident" id="5160174">escape</span><span class="op" id="5160180">(</span><span class="ident" id="5160181">c</span><span class="op" id="5160182">,</span>&nbsp;<span class="ident" id="5160184">m</span><span class="op" id="5160185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5160188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160191">return</span>&nbsp;<span class="ident" id="5160198">c</span><br>
<span class="lineno"></span><span class="op" id="5160200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="5160203">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5160279">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="5160351">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="5160431">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5160478">func</span>&nbsp;<span class="op" id="5160483">(</span><span class="ident" id="5160484">e</span>&nbsp;<span class="op" id="5160486">*</span><span class="ident" id="5160487">escaper</span><span class="op" id="5160494">)</span>&nbsp;<span class="ident" id="5160496">escapeListConditionally</span><span class="op" id="5160519">(</span><span class="ident" id="5160520">c</span>&nbsp;<span class="ident" id="5160522">context</span><span class="op" id="5160529">,</span>&nbsp;<span class="ident" id="5160531">n</span>&nbsp;<span class="op" id="5160533">*</span><span class="ident" id="5160534">parse</span><span class="op" id="5160539">.</span><span class="ident" id="5160540">ListNode</span><span class="op" id="5160548">,</span>&nbsp;<span class="ident" id="5160550">filter</span>&nbsp;<span class="keyword" id="5160557">func</span><span class="op" id="5160561">(</span><span class="op" id="5160562">*</span><span class="ident" id="5160563">escaper</span><span class="op" id="5160570">,</span>&nbsp;<span class="ident" id="5160572">context</span><span class="op" id="5160579">)</span>&nbsp;<span class="builtintype" id="5160581">bool</span><span class="op" id="5160585">)</span>&nbsp;<span class="op" id="5160587">(</span><span class="ident" id="5160588">context</span><span class="op" id="5160595">,</span>&nbsp;<span class="builtintype" id="5160597">bool</span><span class="op" id="5160601">)</span>&nbsp;<span class="op" id="5160603">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160606">e1</span>&nbsp;<span class="op" id="5160609">:=</span>&nbsp;<span class="ident" id="5160612">newEscaper</span><span class="op" id="5160622">(</span><span class="ident" id="5160623">e</span><span class="op" id="5160624">.</span><span class="ident" id="5160625">tmpl</span><span class="op" id="5160629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5160632">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160673">for</span>&nbsp;<span class="ident" id="5160677">k</span><span class="op" id="5160678">,</span>&nbsp;<span class="ident" id="5160680">v</span>&nbsp;<span class="op" id="5160682">:=</span>&nbsp;<span class="keyword" id="5160685">range</span>&nbsp;<span class="ident" id="5160691">e</span><span class="op" id="5160692">.</span><span class="ident" id="5160693">output</span>&nbsp;<span class="op" id="5160700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160704">e1</span><span class="op" id="5160706">.</span><span class="ident" id="5160707">output</span><span class="op" id="5160713">[</span><span class="ident" id="5160714">k</span><span class="op" id="5160715">]</span>&nbsp;<span class="op" id="5160717">=</span>&nbsp;<span class="ident" id="5160719">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5160722">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160725">c</span>&nbsp;<span class="op" id="5160727">=</span>&nbsp;<span class="ident" id="5160729">e1</span><span class="op" id="5160731">.</span><span class="ident" id="5160732">escapeList</span><span class="op" id="5160742">(</span><span class="ident" id="5160743">c</span><span class="op" id="5160744">,</span>&nbsp;<span class="ident" id="5160746">n</span><span class="op" id="5160747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160750">ok</span>&nbsp;<span class="op" id="5160753">:=</span>&nbsp;<span class="ident" id="5160756">filter</span>&nbsp;<span class="op" id="5160763">!=</span>&nbsp;<span class="builtintype" id="5160766">nil</span>&nbsp;<span class="op" id="5160770">&amp;&amp;</span>&nbsp;<span class="ident" id="5160773">filter</span><span class="op" id="5160779">(</span><span class="ident" id="5160780">e1</span><span class="op" id="5160782">,</span>&nbsp;<span class="ident" id="5160784">c</span><span class="op" id="5160785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160788">if</span>&nbsp;<span class="ident" id="5160791">ok</span>&nbsp;<span class="op" id="5160794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5160798">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160850">for</span>&nbsp;<span class="ident" id="5160854">k</span><span class="op" id="5160855">,</span>&nbsp;<span class="ident" id="5160857">v</span>&nbsp;<span class="op" id="5160859">:=</span>&nbsp;<span class="keyword" id="5160862">range</span>&nbsp;<span class="ident" id="5160868">e1</span><span class="op" id="5160870">.</span><span class="ident" id="5160871">output</span>&nbsp;<span class="op" id="5160878">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160883">e</span><span class="op" id="5160884">.</span><span class="ident" id="5160885">output</span><span class="op" id="5160891">[</span><span class="ident" id="5160892">k</span><span class="op" id="5160893">]</span>&nbsp;<span class="op" id="5160895">=</span>&nbsp;<span class="ident" id="5160897">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5160901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160905">for</span>&nbsp;<span class="ident" id="5160909">k</span><span class="op" id="5160910">,</span>&nbsp;<span class="ident" id="5160912">v</span>&nbsp;<span class="op" id="5160914">:=</span>&nbsp;<span class="keyword" id="5160917">range</span>&nbsp;<span class="ident" id="5160923">e1</span><span class="op" id="5160925">.</span><span class="ident" id="5160926">derived</span>&nbsp;<span class="op" id="5160934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160939">e</span><span class="op" id="5160940">.</span><span class="ident" id="5160941">derived</span><span class="op" id="5160948">[</span><span class="ident" id="5160949">k</span><span class="op" id="5160950">]</span>&nbsp;<span class="op" id="5160952">=</span>&nbsp;<span class="ident" id="5160954">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5160958">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160962">for</span>&nbsp;<span class="ident" id="5160966">k</span><span class="op" id="5160967">,</span>&nbsp;<span class="ident" id="5160969">v</span>&nbsp;<span class="op" id="5160971">:=</span>&nbsp;<span class="keyword" id="5160974">range</span>&nbsp;<span class="ident" id="5160980">e1</span><span class="op" id="5160982">.</span><span class="ident" id="5160983">called</span>&nbsp;<span class="op" id="5160990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160995">e</span><span class="op" id="5160996">.</span><span class="ident" id="5160997">called</span><span class="op" id="5161003">[</span><span class="ident" id="5161004">k</span><span class="op" id="5161005">]</span>&nbsp;<span class="op" id="5161007">=</span>&nbsp;<span class="ident" id="5161009">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161017">for</span>&nbsp;<span class="ident" id="5161021">k</span><span class="op" id="5161022">,</span>&nbsp;<span class="ident" id="5161024">v</span>&nbsp;<span class="op" id="5161026">:=</span>&nbsp;<span class="keyword" id="5161029">range</span>&nbsp;<span class="ident" id="5161035">e1</span><span class="op" id="5161037">.</span><span class="ident" id="5161038">actionNodeEdits</span>&nbsp;<span class="op" id="5161054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161059">e</span><span class="op" id="5161060">.</span><span class="ident" id="5161061">editActionNode</span><span class="op" id="5161075">(</span><span class="ident" id="5161076">k</span><span class="op" id="5161077">,</span>&nbsp;<span class="ident" id="5161079">v</span><span class="op" id="5161080">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161088">for</span>&nbsp;<span class="ident" id="5161092">k</span><span class="op" id="5161093">,</span>&nbsp;<span class="ident" id="5161095">v</span>&nbsp;<span class="op" id="5161097">:=</span>&nbsp;<span class="keyword" id="5161100">range</span>&nbsp;<span class="ident" id="5161106">e1</span><span class="op" id="5161108">.</span><span class="ident" id="5161109">templateNodeEdits</span>&nbsp;<span class="op" id="5161127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161132">e</span><span class="op" id="5161133">.</span><span class="ident" id="5161134">editTemplateNode</span><span class="op" id="5161150">(</span><span class="ident" id="5161151">k</span><span class="op" id="5161152">,</span>&nbsp;<span class="ident" id="5161154">v</span><span class="op" id="5161155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161163">for</span>&nbsp;<span class="ident" id="5161167">k</span><span class="op" id="5161168">,</span>&nbsp;<span class="ident" id="5161170">v</span>&nbsp;<span class="op" id="5161172">:=</span>&nbsp;<span class="keyword" id="5161175">range</span>&nbsp;<span class="ident" id="5161181">e1</span><span class="op" id="5161183">.</span><span class="ident" id="5161184">textNodeEdits</span>&nbsp;<span class="op" id="5161198">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161203">e</span><span class="op" id="5161204">.</span><span class="ident" id="5161205">editTextNode</span><span class="op" id="5161217">(</span><span class="ident" id="5161218">k</span><span class="op" id="5161219">,</span>&nbsp;<span class="ident" id="5161221">v</span><span class="op" id="5161222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161232">return</span>&nbsp;<span class="ident" id="5161239">c</span><span class="op" id="5161240">,</span>&nbsp;<span class="ident" id="5161242">ok</span><br>
<span class="lineno"></span><span class="op" id="5161245">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5161248">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5161300">func</span>&nbsp;<span class="op" id="5161305">(</span><span class="ident" id="5161306">e</span>&nbsp;<span class="op" id="5161308">*</span><span class="ident" id="5161309">escaper</span><span class="op" id="5161316">)</span>&nbsp;<span class="ident" id="5161318">escapeTemplate</span><span class="op" id="5161332">(</span><span class="ident" id="5161333">c</span>&nbsp;<span class="ident" id="5161335">context</span><span class="op" id="5161342">,</span>&nbsp;<span class="ident" id="5161344">n</span>&nbsp;<span class="op" id="5161346">*</span><span class="ident" id="5161347">parse</span><span class="op" id="5161352">.</span><span class="ident" id="5161353">TemplateNode</span><span class="op" id="5161365">)</span>&nbsp;<span class="ident" id="5161367">context</span>&nbsp;<span class="op" id="5161375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161378">c</span><span class="op" id="5161379">,</span>&nbsp;<span class="ident" id="5161381">name</span>&nbsp;<span class="op" id="5161386">:=</span>&nbsp;<span class="ident" id="5161389">e</span><span class="op" id="5161390">.</span><span class="ident" id="5161391">escapeTree</span><span class="op" id="5161401">(</span><span class="ident" id="5161402">c</span><span class="op" id="5161403">,</span>&nbsp;<span class="ident" id="5161405">n</span><span class="op" id="5161406">,</span>&nbsp;<span class="ident" id="5161408">n</span><span class="op" id="5161409">.</span><span class="ident" id="5161410">Name</span><span class="op" id="5161414">,</span>&nbsp;<span class="ident" id="5161416">n</span><span class="op" id="5161417">.</span><span class="ident" id="5161418">Line</span><span class="op" id="5161422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161425">if</span>&nbsp;<span class="ident" id="5161428">name</span>&nbsp;<span class="op" id="5161433">!=</span>&nbsp;<span class="ident" id="5161436">n</span><span class="op" id="5161437">.</span><span class="ident" id="5161438">Name</span>&nbsp;<span class="op" id="5161443">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161447">e</span><span class="op" id="5161448">.</span><span class="ident" id="5161449">editTemplateNode</span><span class="op" id="5161465">(</span><span class="ident" id="5161466">n</span><span class="op" id="5161467">,</span>&nbsp;<span class="ident" id="5161469">name</span><span class="op" id="5161473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161479">return</span>&nbsp;<span class="ident" id="5161486">c</span><br>
<span class="lineno"></span><span class="op" id="5161488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="5161491">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5161565">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="5161610">func</span>&nbsp;<span class="op" id="5161615">(</span><span class="ident" id="5161616">e</span>&nbsp;<span class="op" id="5161618">*</span><span class="ident" id="5161619">escaper</span><span class="op" id="5161626">)</span>&nbsp;<span class="ident" id="5161628">escapeTree</span><span class="op" id="5161638">(</span><span class="ident" id="5161639">c</span>&nbsp;<span class="ident" id="5161641">context</span><span class="op" id="5161648">,</span>&nbsp;<span class="ident" id="5161650">node</span>&nbsp;<span class="ident" id="5161655">parse</span><span class="op" id="5161660">.</span><span class="ident" id="5161661">Node</span><span class="op" id="5161665">,</span>&nbsp;<span class="ident" id="5161667">name</span>&nbsp;<span class="builtintype" id="5161672">string</span><span class="op" id="5161678">,</span>&nbsp;<span class="ident" id="5161680">line</span>&nbsp;<span class="builtintype" id="5161685">int</span><span class="op" id="5161688">)</span>&nbsp;<span class="op" id="5161690">(</span><span class="ident" id="5161691">context</span><span class="op" id="5161698">,</span>&nbsp;<span class="builtintype" id="5161700">string</span><span class="op" id="5161706">)</span>&nbsp;<span class="op" id="5161708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5161711">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5161785">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161801">dname</span>&nbsp;<span class="op" id="5161807">:=</span>&nbsp;<span class="ident" id="5161810">c</span><span class="op" id="5161811">.</span><span class="ident" id="5161812">mangle</span><span class="op" id="5161818">(</span><span class="ident" id="5161819">name</span><span class="op" id="5161823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161826">e</span><span class="op" id="5161827">.</span><span class="ident" id="5161828">called</span><span class="op" id="5161834">[</span><span class="ident" id="5161835">dname</span><span class="op" id="5161840">]</span>&nbsp;<span class="op" id="5161842">=</span>&nbsp;<span class="builtintype" id="5161844">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161850">if</span>&nbsp;<span class="ident" id="5161853">out</span><span class="op" id="5161856">,</span>&nbsp;<span class="ident" id="5161858">ok</span>&nbsp;<span class="op" id="5161861">:=</span>&nbsp;<span class="ident" id="5161864">e</span><span class="op" id="5161865">.</span><span class="ident" id="5161866">output</span><span class="op" id="5161872">[</span><span class="ident" id="5161873">dname</span><span class="op" id="5161878">]</span><span class="op" id="5161879">;</span>&nbsp;<span class="ident" id="5161881">ok</span>&nbsp;<span class="op" id="5161884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5161888">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161910">return</span>&nbsp;<span class="ident" id="5161917">out</span><span class="op" id="5161920">,</span>&nbsp;<span class="ident" id="5161922">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161932">t</span>&nbsp;<span class="op" id="5161934">:=</span>&nbsp;<span class="ident" id="5161937">e</span><span class="op" id="5161938">.</span><span class="ident" id="5161939">template</span><span class="op" id="5161947">(</span><span class="ident" id="5161948">name</span><span class="op" id="5161952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161955">if</span>&nbsp;<span class="ident" id="5161958">t</span>&nbsp;<span class="op" id="5161960">==</span>&nbsp;<span class="builtintype" id="5161963">nil</span>&nbsp;<span class="op" id="5161967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5161971">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5162052">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162107">if</span>&nbsp;<span class="ident" id="5162110">e</span><span class="op" id="5162111">.</span><span class="ident" id="5162112">tmpl</span><span class="op" id="5162116">.</span><span class="ident" id="5162117">set</span><span class="op" id="5162120">[</span><span class="ident" id="5162121">name</span><span class="op" id="5162125">]</span>&nbsp;<span class="op" id="5162127">!=</span>&nbsp;<span class="builtintype" id="5162130">nil</span>&nbsp;<span class="op" id="5162134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162139">return</span>&nbsp;<span class="ident" id="5162146">context</span><span class="op" id="5162153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162159">state</span><span class="op" id="5162164">:</span>&nbsp;<span class="ident" id="5162166">stateError</span><span class="op" id="5162176">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162182">err</span><span class="op" id="5162185">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5162189">errorf</span><span class="op" id="5162195">(</span><span class="ident" id="5162196">ErrNoSuchTemplate</span><span class="op" id="5162213">,</span>&nbsp;<span class="ident" id="5162215">node</span><span class="op" id="5162219">,</span>&nbsp;<span class="ident" id="5162221">line</span><span class="op" id="5162225">,</span>&nbsp;<span class="string" id="5162227">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="5162266">,</span>&nbsp;<span class="ident" id="5162268">name</span><span class="op" id="5162272">)</span><span class="op" id="5162273">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162278">}</span><span class="op" id="5162279">,</span>&nbsp;<span class="ident" id="5162281">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162293">return</span>&nbsp;<span class="ident" id="5162300">context</span><span class="op" id="5162307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162312">state</span><span class="op" id="5162317">:</span>&nbsp;<span class="ident" id="5162319">stateError</span><span class="op" id="5162329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162334">err</span><span class="op" id="5162337">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5162341">errorf</span><span class="op" id="5162347">(</span><span class="ident" id="5162348">ErrNoSuchTemplate</span><span class="op" id="5162365">,</span>&nbsp;<span class="ident" id="5162367">node</span><span class="op" id="5162371">,</span>&nbsp;<span class="ident" id="5162373">line</span><span class="op" id="5162377">,</span>&nbsp;<span class="string" id="5162379">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="5162400">,</span>&nbsp;<span class="ident" id="5162402">name</span><span class="op" id="5162406">)</span><span class="op" id="5162407">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162411">}</span><span class="op" id="5162412">,</span>&nbsp;<span class="ident" id="5162414">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162424">if</span>&nbsp;<span class="ident" id="5162427">dname</span>&nbsp;<span class="op" id="5162433">!=</span>&nbsp;<span class="ident" id="5162436">name</span>&nbsp;<span class="op" id="5162441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5162445">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5162516">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162580">dt</span>&nbsp;<span class="op" id="5162583">:=</span>&nbsp;<span class="ident" id="5162586">e</span><span class="op" id="5162587">.</span><span class="ident" id="5162588">template</span><span class="op" id="5162596">(</span><span class="ident" id="5162597">dname</span><span class="op" id="5162602">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162606">if</span>&nbsp;<span class="ident" id="5162609">dt</span>&nbsp;<span class="op" id="5162612">==</span>&nbsp;<span class="builtintype" id="5162615">nil</span>&nbsp;<span class="op" id="5162619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162624">dt</span>&nbsp;<span class="op" id="5162627">=</span>&nbsp;<span class="ident" id="5162629">template</span><span class="op" id="5162637">.</span><span class="ident" id="5162638">New</span><span class="op" id="5162641">(</span><span class="ident" id="5162642">dname</span><span class="op" id="5162647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162652">dt</span><span class="op" id="5162654">.</span><span class="ident" id="5162655">Tree</span>&nbsp;<span class="op" id="5162660">=</span>&nbsp;<span class="op" id="5162662">&amp;</span><span class="ident" id="5162663">parse</span><span class="op" id="5162668">.</span><span class="ident" id="5162669">Tree</span><span class="op" id="5162673">{</span><span class="ident" id="5162674">Name</span><span class="op" id="5162678">:</span>&nbsp;<span class="ident" id="5162680">dname</span><span class="op" id="5162685">,</span>&nbsp;<span class="ident" id="5162687">Root</span><span class="op" id="5162691">:</span>&nbsp;<span class="ident" id="5162693">t</span><span class="op" id="5162694">.</span><span class="ident" id="5162695">Root</span><span class="op" id="5162699">.</span><span class="ident" id="5162700">CopyList</span><span class="op" id="5162708">(</span><span class="op" id="5162709">)</span><span class="op" id="5162710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162715">e</span><span class="op" id="5162716">.</span><span class="ident" id="5162717">derived</span><span class="op" id="5162724">[</span><span class="ident" id="5162725">dname</span><span class="op" id="5162730">]</span>&nbsp;<span class="op" id="5162732">=</span>&nbsp;<span class="ident" id="5162734">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162739">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162743">t</span>&nbsp;<span class="op" id="5162745">=</span>&nbsp;<span class="ident" id="5162747">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162754">return</span>&nbsp;<span class="ident" id="5162761">e</span><span class="op" id="5162762">.</span><span class="ident" id="5162763">computeOutCtx</span><span class="op" id="5162776">(</span><span class="ident" id="5162777">c</span><span class="op" id="5162778">,</span>&nbsp;<span class="ident" id="5162780">t</span><span class="op" id="5162781">)</span><span class="op" id="5162782">,</span>&nbsp;<span class="ident" id="5162784">dname</span><br>
<span class="lineno"></span><span class="op" id="5162790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="5162793">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5162873">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="5162919">func</span>&nbsp;<span class="op" id="5162924">(</span><span class="ident" id="5162925">e</span>&nbsp;<span class="op" id="5162927">*</span><span class="ident" id="5162928">escaper</span><span class="op" id="5162935">)</span>&nbsp;<span class="ident" id="5162937">computeOutCtx</span><span class="op" id="5162950">(</span><span class="ident" id="5162951">c</span>&nbsp;<span class="ident" id="5162953">context</span><span class="op" id="5162960">,</span>&nbsp;<span class="ident" id="5162962">t</span>&nbsp;<span class="op" id="5162964">*</span><span class="ident" id="5162965">template</span><span class="op" id="5162973">.</span><span class="ident" id="5162974">Template</span><span class="op" id="5162982">)</span>&nbsp;<span class="ident" id="5162984">context</span>&nbsp;<span class="op" id="5162992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5162995">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163032">c1</span><span class="op" id="5163034">,</span>&nbsp;<span class="ident" id="5163036">ok</span>&nbsp;<span class="op" id="5163039">:=</span>&nbsp;<span class="ident" id="5163042">e</span><span class="op" id="5163043">.</span><span class="ident" id="5163044">escapeTemplateBody</span><span class="op" id="5163062">(</span><span class="ident" id="5163063">c</span><span class="op" id="5163064">,</span>&nbsp;<span class="ident" id="5163066">t</span><span class="op" id="5163067">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163070">if</span>&nbsp;<span class="op" id="5163073">!</span><span class="ident" id="5163074">ok</span>&nbsp;<span class="op" id="5163077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5163081">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163147">if</span>&nbsp;<span class="ident" id="5163150">c2</span><span class="op" id="5163152">,</span>&nbsp;<span class="ident" id="5163154">ok2</span>&nbsp;<span class="op" id="5163158">:=</span>&nbsp;<span class="ident" id="5163161">e</span><span class="op" id="5163162">.</span><span class="ident" id="5163163">escapeTemplateBody</span><span class="op" id="5163181">(</span><span class="ident" id="5163182">c1</span><span class="op" id="5163184">,</span>&nbsp;<span class="ident" id="5163186">t</span><span class="op" id="5163187">)</span><span class="op" id="5163188">;</span>&nbsp;<span class="ident" id="5163190">ok2</span>&nbsp;<span class="op" id="5163194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163199">c1</span><span class="op" id="5163201">,</span>&nbsp;<span class="ident" id="5163203">ok</span>&nbsp;<span class="op" id="5163206">=</span>&nbsp;<span class="ident" id="5163208">c2</span><span class="op" id="5163210">,</span>&nbsp;<span class="builtintype" id="5163212">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163219">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5163223">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163288">if</span>&nbsp;<span class="op" id="5163291">!</span><span class="ident" id="5163292">ok</span>&nbsp;<span class="op" id="5163295">&amp;&amp;</span>&nbsp;<span class="ident" id="5163298">c1</span><span class="op" id="5163300">.</span><span class="ident" id="5163301">state</span>&nbsp;<span class="op" id="5163307">!=</span>&nbsp;<span class="ident" id="5163310">stateError</span>&nbsp;<span class="op" id="5163321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163325">return</span>&nbsp;<span class="ident" id="5163332">context</span><span class="op" id="5163339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163344">state</span><span class="op" id="5163349">:</span>&nbsp;<span class="ident" id="5163351">stateError</span><span class="op" id="5163361">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163366">err</span><span class="op" id="5163369">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5163373">errorf</span><span class="op" id="5163379">(</span><span class="ident" id="5163380">ErrOutputContext</span><span class="op" id="5163396">,</span>&nbsp;<span class="ident" id="5163398">t</span><span class="op" id="5163399">.</span><span class="ident" id="5163400">Tree</span><span class="op" id="5163404">.</span><span class="ident" id="5163405">Root</span><span class="op" id="5163409">,</span>&nbsp;<span class="num" id="5163411">0</span><span class="op" id="5163412">,</span>&nbsp;<span class="string" id="5163414">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="5163461">,</span>&nbsp;<span class="ident" id="5163463">t</span><span class="op" id="5163464">.</span><span class="ident" id="5163465">Name</span><span class="op" id="5163469">(</span><span class="op" id="5163470">)</span><span class="op" id="5163471">)</span><span class="op" id="5163472">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163482">return</span>&nbsp;<span class="ident" id="5163489">c1</span><br>
<span class="lineno"></span><span class="op" id="5163492">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="5163495">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5163570">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5163647">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="5163674">func</span>&nbsp;<span class="op" id="5163679">(</span><span class="ident" id="5163680">e</span>&nbsp;<span class="op" id="5163682">*</span><span class="ident" id="5163683">escaper</span><span class="op" id="5163690">)</span>&nbsp;<span class="ident" id="5163692">escapeTemplateBody</span><span class="op" id="5163710">(</span><span class="ident" id="5163711">c</span>&nbsp;<span class="ident" id="5163713">context</span><span class="op" id="5163720">,</span>&nbsp;<span class="ident" id="5163722">t</span>&nbsp;<span class="op" id="5163724">*</span><span class="ident" id="5163725">template</span><span class="op" id="5163733">.</span><span class="ident" id="5163734">Template</span><span class="op" id="5163742">)</span>&nbsp;<span class="op" id="5163744">(</span><span class="ident" id="5163745">context</span><span class="op" id="5163752">,</span>&nbsp;<span class="builtintype" id="5163754">bool</span><span class="op" id="5163758">)</span>&nbsp;<span class="op" id="5163760">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163763">filter</span>&nbsp;<span class="op" id="5163770">:=</span>&nbsp;<span class="keyword" id="5163773">func</span><span class="op" id="5163777">(</span><span class="ident" id="5163778">e1</span>&nbsp;<span class="op" id="5163781">*</span><span class="ident" id="5163782">escaper</span><span class="op" id="5163789">,</span>&nbsp;<span class="ident" id="5163791">c1</span>&nbsp;<span class="ident" id="5163794">context</span><span class="op" id="5163801">)</span>&nbsp;<span class="builtintype" id="5163803">bool</span>&nbsp;<span class="op" id="5163808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163812">if</span>&nbsp;<span class="ident" id="5163815">c1</span><span class="op" id="5163817">.</span><span class="ident" id="5163818">state</span>&nbsp;<span class="op" id="5163824">==</span>&nbsp;<span class="ident" id="5163827">stateError</span>&nbsp;<span class="op" id="5163838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5163843">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163885">return</span>&nbsp;<span class="builtintype" id="5163892">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163900">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163904">if</span>&nbsp;<span class="op" id="5163907">!</span><span class="ident" id="5163908">e1</span><span class="op" id="5163910">.</span><span class="ident" id="5163911">called</span><span class="op" id="5163917">[</span><span class="ident" id="5163918">t</span><span class="op" id="5163919">.</span><span class="ident" id="5163920">Name</span><span class="op" id="5163924">(</span><span class="op" id="5163925">)</span><span class="op" id="5163926">]</span>&nbsp;<span class="op" id="5163928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5163933">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5163985">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164016">return</span>&nbsp;<span class="builtintype" id="5164023">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164030">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164034">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164096">return</span>&nbsp;<span class="ident" id="5164103">c</span><span class="op" id="5164104">.</span><span class="ident" id="5164105">eq</span><span class="op" id="5164107">(</span><span class="ident" id="5164108">c1</span><span class="op" id="5164110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164116">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164189">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164263">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164333">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164361">e</span><span class="op" id="5164362">.</span><span class="ident" id="5164363">output</span><span class="op" id="5164369">[</span><span class="ident" id="5164370">t</span><span class="op" id="5164371">.</span><span class="ident" id="5164372">Name</span><span class="op" id="5164376">(</span><span class="op" id="5164377">)</span><span class="op" id="5164378">]</span>&nbsp;<span class="op" id="5164380">=</span>&nbsp;<span class="ident" id="5164382">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164385">return</span>&nbsp;<span class="ident" id="5164392">e</span><span class="op" id="5164393">.</span><span class="ident" id="5164394">escapeListConditionally</span><span class="op" id="5164417">(</span><span class="ident" id="5164418">c</span><span class="op" id="5164419">,</span>&nbsp;<span class="ident" id="5164421">t</span><span class="op" id="5164422">.</span><span class="ident" id="5164423">Tree</span><span class="op" id="5164427">.</span><span class="ident" id="5164428">Root</span><span class="op" id="5164432">,</span>&nbsp;<span class="ident" id="5164434">filter</span><span class="op" id="5164440">)</span><br>
<span class="lineno"></span><span class="op" id="5164442">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="5164445">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5164519">var</span>&nbsp;<span class="ident" id="5164523">delimEnds</span>&nbsp;<span class="op" id="5164533">=</span>&nbsp;<span class="op" id="5164535">[</span><span class="op" id="5164536">...</span><span class="op" id="5164539">]</span><span class="builtintype" id="5164540">string</span><span class="op" id="5164546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164549">delimDoubleQuote</span><span class="op" id="5164565">:</span>&nbsp;<span class="string" id="5164567">`&#34;`</span><span class="op" id="5164570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164573">delimSingleQuote</span><span class="op" id="5164589">:</span>&nbsp;<span class="string" id="5164591">&#34;&#39;&#34;</span><span class="op" id="5164594">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164597">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164666">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164711">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164751">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164825">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164897">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164947">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164953">delimSpaceOrTagEnd</span><span class="op" id="5164971">:</span>&nbsp;<span class="string" id="5164973">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="5164985">,</span><br>
<span class="lineno"></span><span class="op" id="5164987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="5164990">var</span>&nbsp;<span class="ident" id="5164994">doctypeBytes</span>&nbsp;<span class="op" id="5165007">=</span>&nbsp;<span class="op" id="5165009">[</span><span class="op" id="5165010">]</span><span class="builtintype" id="5165011">byte</span><span class="op" id="5165015">(</span><span class="string" id="5165016">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="5165027">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5165030">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5165074">func</span>&nbsp;<span class="op" id="5165079">(</span><span class="ident" id="5165080">e</span>&nbsp;<span class="op" id="5165082">*</span><span class="ident" id="5165083">escaper</span><span class="op" id="5165090">)</span>&nbsp;<span class="ident" id="5165092">escapeText</span><span class="op" id="5165102">(</span><span class="ident" id="5165103">c</span>&nbsp;<span class="ident" id="5165105">context</span><span class="op" id="5165112">,</span>&nbsp;<span class="ident" id="5165114">n</span>&nbsp;<span class="op" id="5165116">*</span><span class="ident" id="5165117">parse</span><span class="op" id="5165122">.</span><span class="ident" id="5165123">TextNode</span><span class="op" id="5165131">)</span>&nbsp;<span class="ident" id="5165133">context</span>&nbsp;<span class="op" id="5165141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165144">s</span><span class="op" id="5165145">,</span>&nbsp;<span class="ident" id="5165147">written</span><span class="op" id="5165154">,</span>&nbsp;<span class="ident" id="5165156">i</span><span class="op" id="5165157">,</span>&nbsp;<span class="ident" id="5165159">b</span>&nbsp;<span class="op" id="5165161">:=</span>&nbsp;<span class="ident" id="5165164">n</span><span class="op" id="5165165">.</span><span class="ident" id="5165166">Text</span><span class="op" id="5165170">,</span>&nbsp;<span class="num" id="5165172">0</span><span class="op" id="5165173">,</span>&nbsp;<span class="num" id="5165175">0</span><span class="op" id="5165176">,</span>&nbsp;<span class="builtinfunc" id="5165178">new</span><span class="op" id="5165181">(</span><span class="ident" id="5165182">bytes</span><span class="op" id="5165187">.</span><span class="ident" id="5165188">Buffer</span><span class="op" id="5165194">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165197">for</span>&nbsp;<span class="ident" id="5165201">i</span>&nbsp;<span class="op" id="5165203">!=</span>&nbsp;<span class="builtinfunc" id="5165206">len</span><span class="op" id="5165209">(</span><span class="ident" id="5165210">s</span><span class="op" id="5165211">)</span>&nbsp;<span class="op" id="5165213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165217">c1</span><span class="op" id="5165219">,</span>&nbsp;<span class="ident" id="5165221">nread</span>&nbsp;<span class="op" id="5165227">:=</span>&nbsp;<span class="ident" id="5165230">contextAfterText</span><span class="op" id="5165246">(</span><span class="ident" id="5165247">c</span><span class="op" id="5165248">,</span>&nbsp;<span class="ident" id="5165250">s</span><span class="op" id="5165251">[</span><span class="ident" id="5165252">i</span><span class="op" id="5165253">:</span><span class="op" id="5165254">]</span><span class="op" id="5165255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165259">i1</span>&nbsp;<span class="op" id="5165262">:=</span>&nbsp;<span class="ident" id="5165265">i</span>&nbsp;<span class="op" id="5165267">+</span>&nbsp;<span class="ident" id="5165269">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165277">if</span>&nbsp;<span class="ident" id="5165280">c</span><span class="op" id="5165281">.</span><span class="ident" id="5165282">state</span>&nbsp;<span class="op" id="5165288">==</span>&nbsp;<span class="ident" id="5165291">stateText</span>&nbsp;<span class="op" id="5165301">||</span>&nbsp;<span class="ident" id="5165304">c</span><span class="op" id="5165305">.</span><span class="ident" id="5165306">state</span>&nbsp;<span class="op" id="5165312">==</span>&nbsp;<span class="ident" id="5165315">stateRCDATA</span>&nbsp;<span class="op" id="5165327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165332">end</span>&nbsp;<span class="op" id="5165336">:=</span>&nbsp;<span class="ident" id="5165339">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165345">if</span>&nbsp;<span class="ident" id="5165348">c1</span><span class="op" id="5165350">.</span><span class="ident" id="5165351">state</span>&nbsp;<span class="op" id="5165357">!=</span>&nbsp;<span class="ident" id="5165360">c</span><span class="op" id="5165361">.</span><span class="ident" id="5165362">state</span>&nbsp;<span class="op" id="5165368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165374">for</span>&nbsp;<span class="ident" id="5165378">j</span>&nbsp;<span class="op" id="5165380">:=</span>&nbsp;<span class="ident" id="5165383">end</span>&nbsp;<span class="op" id="5165387">-</span>&nbsp;<span class="num" id="5165389">1</span><span class="op" id="5165390">;</span>&nbsp;<span class="ident" id="5165392">j</span>&nbsp;<span class="op" id="5165394">&gt;=</span>&nbsp;<span class="ident" id="5165397">i</span><span class="op" id="5165398">;</span>&nbsp;<span class="ident" id="5165400">j</span><span class="op" id="5165401">--</span>&nbsp;<span class="op" id="5165404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165411">if</span>&nbsp;<span class="ident" id="5165414">s</span><span class="op" id="5165415">[</span><span class="ident" id="5165416">j</span><span class="op" id="5165417">]</span>&nbsp;<span class="op" id="5165419">==</span>&nbsp;<span class="string" id="5165422">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5165426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165434">end</span>&nbsp;<span class="op" id="5165438">=</span>&nbsp;<span class="ident" id="5165440">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165448">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165475">for</span>&nbsp;<span class="ident" id="5165479">j</span>&nbsp;<span class="op" id="5165481">:=</span>&nbsp;<span class="ident" id="5165484">i</span><span class="op" id="5165485">;</span>&nbsp;<span class="ident" id="5165487">j</span>&nbsp;<span class="op" id="5165489">&lt;</span>&nbsp;<span class="ident" id="5165491">end</span><span class="op" id="5165494">;</span>&nbsp;<span class="ident" id="5165496">j</span><span class="op" id="5165497">++</span>&nbsp;<span class="op" id="5165500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165506">if</span>&nbsp;<span class="ident" id="5165509">s</span><span class="op" id="5165510">[</span><span class="ident" id="5165511">j</span><span class="op" id="5165512">]</span>&nbsp;<span class="op" id="5165514">==</span>&nbsp;<span class="string" id="5165517">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5165521">&amp;&amp;</span>&nbsp;<span class="op" id="5165524">!</span><span class="ident" id="5165525">bytes</span><span class="op" id="5165530">.</span><span class="ident" id="5165531">HasPrefix</span><span class="op" id="5165540">(</span><span class="ident" id="5165541">bytes</span><span class="op" id="5165546">.</span><span class="ident" id="5165547">ToUpper</span><span class="op" id="5165554">(</span><span class="ident" id="5165555">s</span><span class="op" id="5165556">[</span><span class="ident" id="5165557">j</span><span class="op" id="5165558">:</span><span class="op" id="5165559">]</span><span class="op" id="5165560">)</span><span class="op" id="5165561">,</span>&nbsp;<span class="ident" id="5165563">doctypeBytes</span><span class="op" id="5165575">)</span>&nbsp;<span class="op" id="5165577">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165584">b</span><span class="op" id="5165585">.</span><span class="ident" id="5165586">Write</span><span class="op" id="5165591">(</span><span class="ident" id="5165592">s</span><span class="op" id="5165593">[</span><span class="ident" id="5165594">written</span><span class="op" id="5165601">:</span><span class="ident" id="5165602">j</span><span class="op" id="5165603">]</span><span class="op" id="5165604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165611">b</span><span class="op" id="5165612">.</span><span class="ident" id="5165613">WriteString</span><span class="op" id="5165624">(</span><span class="string" id="5165625">&#34;&amp;lt;&#34;</span><span class="op" id="5165631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165638">written</span>&nbsp;<span class="op" id="5165646">=</span>&nbsp;<span class="ident" id="5165648">j</span>&nbsp;<span class="op" id="5165650">+</span>&nbsp;<span class="num" id="5165652">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165663">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165667">}</span>&nbsp;<span class="keyword" id="5165669">else</span>&nbsp;<span class="keyword" id="5165674">if</span>&nbsp;<span class="ident" id="5165677">isComment</span><span class="op" id="5165686">(</span><span class="ident" id="5165687">c</span><span class="op" id="5165688">.</span><span class="ident" id="5165689">state</span><span class="op" id="5165694">)</span>&nbsp;<span class="op" id="5165696">&amp;&amp;</span>&nbsp;<span class="ident" id="5165699">c</span><span class="op" id="5165700">.</span><span class="ident" id="5165701">delim</span>&nbsp;<span class="op" id="5165707">==</span>&nbsp;<span class="ident" id="5165710">delimNone</span>&nbsp;<span class="op" id="5165720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165725">switch</span>&nbsp;<span class="ident" id="5165732">c</span><span class="op" id="5165733">.</span><span class="ident" id="5165734">state</span>&nbsp;<span class="op" id="5165740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165745">case</span>&nbsp;<span class="ident" id="5165750">stateJSBlockCmt</span><span class="op" id="5165765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5165771">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5165807">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5165856">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5165908">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5165958">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5166006">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5166055">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166086">if</span>&nbsp;<span class="ident" id="5166089">bytes</span><span class="op" id="5166094">.</span><span class="ident" id="5166095">IndexAny</span><span class="op" id="5166103">(</span><span class="ident" id="5166104">s</span><span class="op" id="5166105">[</span><span class="ident" id="5166106">written</span><span class="op" id="5166113">:</span><span class="ident" id="5166114">i1</span><span class="op" id="5166116">]</span><span class="op" id="5166117">,</span>&nbsp;<span class="string" id="5166119">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="5166137">)</span>&nbsp;<span class="op" id="5166139">!=</span>&nbsp;<span class="op" id="5166142">-</span><span class="num" id="5166143">1</span>&nbsp;<span class="op" id="5166145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166152">b</span><span class="op" id="5166153">.</span><span class="ident" id="5166154">WriteByte</span><span class="op" id="5166163">(</span><span class="string" id="5166164">&#39;\n&#39;</span><span class="op" id="5166168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166174">}</span>&nbsp;<span class="keyword" id="5166176">else</span>&nbsp;<span class="op" id="5166181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166188">b</span><span class="op" id="5166189">.</span><span class="ident" id="5166190">WriteByte</span><span class="op" id="5166199">(</span><span class="string" id="5166200">&#39;&nbsp;&#39;</span><span class="op" id="5166203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166209">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166214">case</span>&nbsp;<span class="ident" id="5166219">stateCSSBlockCmt</span><span class="op" id="5166235">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166241">b</span><span class="op" id="5166242">.</span><span class="ident" id="5166243">WriteByte</span><span class="op" id="5166252">(</span><span class="string" id="5166253">&#39;&nbsp;&#39;</span><span class="op" id="5166256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166266">written</span>&nbsp;<span class="op" id="5166274">=</span>&nbsp;<span class="ident" id="5166276">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166281">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166285">if</span>&nbsp;<span class="ident" id="5166288">c</span><span class="op" id="5166289">.</span><span class="ident" id="5166290">state</span>&nbsp;<span class="op" id="5166296">!=</span>&nbsp;<span class="ident" id="5166299">c1</span><span class="op" id="5166301">.</span><span class="ident" id="5166302">state</span>&nbsp;<span class="op" id="5166308">&amp;&amp;</span>&nbsp;<span class="ident" id="5166311">isComment</span><span class="op" id="5166320">(</span><span class="ident" id="5166321">c1</span><span class="op" id="5166323">.</span><span class="ident" id="5166324">state</span><span class="op" id="5166329">)</span>&nbsp;<span class="op" id="5166331">&amp;&amp;</span>&nbsp;<span class="ident" id="5166334">c1</span><span class="op" id="5166336">.</span><span class="ident" id="5166337">delim</span>&nbsp;<span class="op" id="5166343">==</span>&nbsp;<span class="ident" id="5166346">delimNone</span>&nbsp;<span class="op" id="5166356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5166361">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166427">cs</span>&nbsp;<span class="op" id="5166430">:=</span>&nbsp;<span class="ident" id="5166433">i1</span>&nbsp;<span class="op" id="5166436">-</span>&nbsp;<span class="num" id="5166438">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166443">if</span>&nbsp;<span class="ident" id="5166446">c1</span><span class="op" id="5166448">.</span><span class="ident" id="5166449">state</span>&nbsp;<span class="op" id="5166455">==</span>&nbsp;<span class="ident" id="5166458">stateHTMLCmt</span>&nbsp;<span class="op" id="5166471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5166477">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166515">cs</span>&nbsp;<span class="op" id="5166518">-=</span>&nbsp;<span class="num" id="5166521">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166531">b</span><span class="op" id="5166532">.</span><span class="ident" id="5166533">Write</span><span class="op" id="5166538">(</span><span class="ident" id="5166539">s</span><span class="op" id="5166540">[</span><span class="ident" id="5166541">written</span><span class="op" id="5166548">:</span><span class="ident" id="5166549">cs</span><span class="op" id="5166551">]</span><span class="op" id="5166552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166557">written</span>&nbsp;<span class="op" id="5166565">=</span>&nbsp;<span class="ident" id="5166567">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166572">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166576">if</span>&nbsp;<span class="ident" id="5166579">i</span>&nbsp;<span class="op" id="5166581">==</span>&nbsp;<span class="ident" id="5166584">i1</span>&nbsp;<span class="op" id="5166587">&amp;&amp;</span>&nbsp;<span class="ident" id="5166590">c</span><span class="op" id="5166591">.</span><span class="ident" id="5166592">state</span>&nbsp;<span class="op" id="5166598">==</span>&nbsp;<span class="ident" id="5166601">c1</span><span class="op" id="5166603">.</span><span class="ident" id="5166604">state</span>&nbsp;<span class="op" id="5166610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5166615">panic</span><span class="op" id="5166620">(</span><span class="ident" id="5166621">fmt</span><span class="op" id="5166624">.</span><span class="ident" id="5166625">Sprintf</span><span class="op" id="5166632">(</span><span class="string" id="5166633">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="5166672">,</span>&nbsp;<span class="ident" id="5166674">c</span><span class="op" id="5166675">,</span>&nbsp;<span class="ident" id="5166677">c1</span><span class="op" id="5166679">,</span>&nbsp;<span class="ident" id="5166681">s</span><span class="op" id="5166682">[</span><span class="op" id="5166683">:</span><span class="ident" id="5166684">i</span><span class="op" id="5166685">]</span><span class="op" id="5166686">,</span>&nbsp;<span class="ident" id="5166688">s</span><span class="op" id="5166689">[</span><span class="ident" id="5166690">i</span><span class="op" id="5166691">:</span><span class="op" id="5166692">]</span><span class="op" id="5166693">)</span><span class="op" id="5166694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166702">c</span><span class="op" id="5166703">,</span>&nbsp;<span class="ident" id="5166705">i</span>&nbsp;<span class="op" id="5166707">=</span>&nbsp;<span class="ident" id="5166709">c1</span><span class="op" id="5166711">,</span>&nbsp;<span class="ident" id="5166713">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166717">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166721">if</span>&nbsp;<span class="ident" id="5166724">written</span>&nbsp;<span class="op" id="5166732">!=</span>&nbsp;<span class="num" id="5166735">0</span>&nbsp;<span class="op" id="5166737">&amp;&amp;</span>&nbsp;<span class="ident" id="5166740">c</span><span class="op" id="5166741">.</span><span class="ident" id="5166742">state</span>&nbsp;<span class="op" id="5166748">!=</span>&nbsp;<span class="ident" id="5166751">stateError</span>&nbsp;<span class="op" id="5166762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166766">if</span>&nbsp;<span class="op" id="5166769">!</span><span class="ident" id="5166770">isComment</span><span class="op" id="5166779">(</span><span class="ident" id="5166780">c</span><span class="op" id="5166781">.</span><span class="ident" id="5166782">state</span><span class="op" id="5166787">)</span>&nbsp;<span class="op" id="5166789">||</span>&nbsp;<span class="ident" id="5166792">c</span><span class="op" id="5166793">.</span><span class="ident" id="5166794">delim</span>&nbsp;<span class="op" id="5166800">!=</span>&nbsp;<span class="ident" id="5166803">delimNone</span>&nbsp;<span class="op" id="5166813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166818">b</span><span class="op" id="5166819">.</span><span class="ident" id="5166820">Write</span><span class="op" id="5166825">(</span><span class="ident" id="5166826">n</span><span class="op" id="5166827">.</span><span class="ident" id="5166828">Text</span><span class="op" id="5166832">[</span><span class="ident" id="5166833">written</span><span class="op" id="5166840">:</span><span class="op" id="5166841">]</span><span class="op" id="5166842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166846">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166850">e</span><span class="op" id="5166851">.</span><span class="ident" id="5166852">editTextNode</span><span class="op" id="5166864">(</span><span class="ident" id="5166865">n</span><span class="op" id="5166866">,</span>&nbsp;<span class="ident" id="5166868">b</span><span class="op" id="5166869">.</span><span class="ident" id="5166870">Bytes</span><span class="op" id="5166875">(</span><span class="op" id="5166876">)</span><span class="op" id="5166877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166883">return</span>&nbsp;<span class="ident" id="5166890">c</span><br>
<span class="lineno"></span><span class="op" id="5166892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="5166895">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5166975">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="5167053">func</span>&nbsp;<span class="ident" id="5167058">contextAfterText</span><span class="op" id="5167074">(</span><span class="ident" id="5167075">c</span>&nbsp;<span class="ident" id="5167077">context</span><span class="op" id="5167084">,</span>&nbsp;<span class="ident" id="5167086">s</span>&nbsp;<span class="op" id="5167088">[</span><span class="op" id="5167089">]</span><span class="builtintype" id="5167090">byte</span><span class="op" id="5167094">)</span>&nbsp;<span class="op" id="5167096">(</span><span class="ident" id="5167097">context</span><span class="op" id="5167104">,</span>&nbsp;<span class="builtintype" id="5167106">int</span><span class="op" id="5167109">)</span>&nbsp;<span class="op" id="5167111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167114">if</span>&nbsp;<span class="ident" id="5167117">c</span><span class="op" id="5167118">.</span><span class="ident" id="5167119">delim</span>&nbsp;<span class="op" id="5167125">==</span>&nbsp;<span class="ident" id="5167128">delimNone</span>&nbsp;<span class="op" id="5167138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167142">c1</span><span class="op" id="5167144">,</span>&nbsp;<span class="ident" id="5167146">i</span>&nbsp;<span class="op" id="5167148">:=</span>&nbsp;<span class="ident" id="5167151">tSpecialTagEnd</span><span class="op" id="5167165">(</span><span class="ident" id="5167166">c</span><span class="op" id="5167167">,</span>&nbsp;<span class="ident" id="5167169">s</span><span class="op" id="5167170">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167174">if</span>&nbsp;<span class="ident" id="5167177">i</span>&nbsp;<span class="op" id="5167179">==</span>&nbsp;<span class="num" id="5167182">0</span>&nbsp;<span class="op" id="5167184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167189">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167245">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167295">return</span>&nbsp;<span class="ident" id="5167302">c1</span><span class="op" id="5167304">,</span>&nbsp;<span class="num" id="5167306">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167310">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167314">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167359">return</span>&nbsp;<span class="ident" id="5167366">transitionFunc</span><span class="op" id="5167380">[</span><span class="ident" id="5167381">c</span><span class="op" id="5167382">.</span><span class="ident" id="5167383">state</span><span class="op" id="5167388">]</span><span class="op" id="5167389">(</span><span class="ident" id="5167390">c</span><span class="op" id="5167391">,</span>&nbsp;<span class="ident" id="5167393">s</span><span class="op" id="5167394">[</span><span class="op" id="5167395">:</span><span class="ident" id="5167396">i</span><span class="op" id="5167397">]</span><span class="op" id="5167398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167405">i</span>&nbsp;<span class="op" id="5167407">:=</span>&nbsp;<span class="ident" id="5167410">bytes</span><span class="op" id="5167415">.</span><span class="ident" id="5167416">IndexAny</span><span class="op" id="5167424">(</span><span class="ident" id="5167425">s</span><span class="op" id="5167426">,</span>&nbsp;<span class="ident" id="5167428">delimEnds</span><span class="op" id="5167437">[</span><span class="ident" id="5167438">c</span><span class="op" id="5167439">.</span><span class="ident" id="5167440">delim</span><span class="op" id="5167445">]</span><span class="op" id="5167446">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167449">if</span>&nbsp;<span class="ident" id="5167452">i</span>&nbsp;<span class="op" id="5167454">==</span>&nbsp;<span class="op" id="5167457">-</span><span class="num" id="5167458">1</span>&nbsp;<span class="op" id="5167460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167464">i</span>&nbsp;<span class="op" id="5167466">=</span>&nbsp;<span class="builtinfunc" id="5167468">len</span><span class="op" id="5167471">(</span><span class="ident" id="5167472">s</span><span class="op" id="5167473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167479">if</span>&nbsp;<span class="ident" id="5167482">c</span><span class="op" id="5167483">.</span><span class="ident" id="5167484">delim</span>&nbsp;<span class="op" id="5167490">==</span>&nbsp;<span class="ident" id="5167493">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5167512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167516">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167593">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167641">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167699">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167765">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167815">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167868">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167913">if</span>&nbsp;<span class="ident" id="5167916">j</span>&nbsp;<span class="op" id="5167918">:=</span>&nbsp;<span class="ident" id="5167921">bytes</span><span class="op" id="5167926">.</span><span class="ident" id="5167927">IndexAny</span><span class="op" id="5167935">(</span><span class="ident" id="5167936">s</span><span class="op" id="5167937">[</span><span class="op" id="5167938">:</span><span class="ident" id="5167939">i</span><span class="op" id="5167940">]</span><span class="op" id="5167941">,</span>&nbsp;<span class="string" id="5167943">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="5167951">)</span><span class="op" id="5167952">;</span>&nbsp;<span class="ident" id="5167954">j</span>&nbsp;<span class="op" id="5167956">&gt;=</span>&nbsp;<span class="num" id="5167959">0</span>&nbsp;<span class="op" id="5167961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167966">return</span>&nbsp;<span class="ident" id="5167973">context</span><span class="op" id="5167980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167986">state</span><span class="op" id="5167991">:</span>&nbsp;<span class="ident" id="5167993">stateError</span><span class="op" id="5168003">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168009">err</span><span class="op" id="5168012">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5168016">errorf</span><span class="op" id="5168022">(</span><span class="ident" id="5168023">ErrBadHTML</span><span class="op" id="5168033">,</span>&nbsp;<span class="builtintype" id="5168035">nil</span><span class="op" id="5168038">,</span>&nbsp;<span class="num" id="5168040">0</span><span class="op" id="5168041">,</span>&nbsp;<span class="string" id="5168043">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="5168068">,</span>&nbsp;<span class="ident" id="5168070">s</span><span class="op" id="5168071">[</span><span class="ident" id="5168072">j</span><span class="op" id="5168073">:</span><span class="ident" id="5168074">j</span><span class="op" id="5168075">+</span><span class="num" id="5168076">1</span><span class="op" id="5168077">]</span><span class="op" id="5168078">,</span>&nbsp;<span class="ident" id="5168080">s</span><span class="op" id="5168081">[</span><span class="op" id="5168082">:</span><span class="ident" id="5168083">i</span><span class="op" id="5168084">]</span><span class="op" id="5168085">)</span><span class="op" id="5168086">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168091">}</span><span class="op" id="5168092">,</span>&nbsp;<span class="builtinfunc" id="5168094">len</span><span class="op" id="5168097">(</span><span class="ident" id="5168098">s</span><span class="op" id="5168099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168109">if</span>&nbsp;<span class="ident" id="5168112">i</span>&nbsp;<span class="op" id="5168114">==</span>&nbsp;<span class="builtinfunc" id="5168117">len</span><span class="op" id="5168120">(</span><span class="ident" id="5168121">s</span><span class="op" id="5168122">)</span>&nbsp;<span class="op" id="5168124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168128">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168162">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168220">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168271">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168326">for</span>&nbsp;<span class="ident" id="5168330">u</span>&nbsp;<span class="op" id="5168332">:=</span>&nbsp;<span class="op" id="5168335">[</span><span class="op" id="5168336">]</span><span class="builtintype" id="5168337">byte</span><span class="op" id="5168341">(</span><span class="ident" id="5168342">html</span><span class="op" id="5168346">.</span><span class="ident" id="5168347">UnescapeString</span><span class="op" id="5168361">(</span><span class="builtintype" id="5168362">string</span><span class="op" id="5168368">(</span><span class="ident" id="5168369">s</span><span class="op" id="5168370">)</span><span class="op" id="5168371">)</span><span class="op" id="5168372">)</span><span class="op" id="5168373">;</span>&nbsp;<span class="builtinfunc" id="5168375">len</span><span class="op" id="5168378">(</span><span class="ident" id="5168379">u</span><span class="op" id="5168380">)</span>&nbsp;<span class="op" id="5168382">!=</span>&nbsp;<span class="num" id="5168385">0</span><span class="op" id="5168386">;</span>&nbsp;<span class="op" id="5168388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168393">c1</span><span class="op" id="5168395">,</span>&nbsp;<span class="ident" id="5168397">i1</span>&nbsp;<span class="op" id="5168400">:=</span>&nbsp;<span class="ident" id="5168403">transitionFunc</span><span class="op" id="5168417">[</span><span class="ident" id="5168418">c</span><span class="op" id="5168419">.</span><span class="ident" id="5168420">state</span><span class="op" id="5168425">]</span><span class="op" id="5168426">(</span><span class="ident" id="5168427">c</span><span class="op" id="5168428">,</span>&nbsp;<span class="ident" id="5168430">u</span><span class="op" id="5168431">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168436">c</span><span class="op" id="5168437">,</span>&nbsp;<span class="ident" id="5168439">u</span>&nbsp;<span class="op" id="5168441">=</span>&nbsp;<span class="ident" id="5168443">c1</span><span class="op" id="5168445">,</span>&nbsp;<span class="ident" id="5168447">u</span><span class="op" id="5168448">[</span><span class="ident" id="5168449">i1</span><span class="op" id="5168451">:</span><span class="op" id="5168452">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168460">return</span>&nbsp;<span class="ident" id="5168467">c</span><span class="op" id="5168468">,</span>&nbsp;<span class="builtinfunc" id="5168470">len</span><span class="op" id="5168473">(</span><span class="ident" id="5168474">s</span><span class="op" id="5168475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168481">if</span>&nbsp;<span class="ident" id="5168484">c</span><span class="op" id="5168485">.</span><span class="ident" id="5168486">delim</span>&nbsp;<span class="op" id="5168492">!=</span>&nbsp;<span class="ident" id="5168495">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5168514">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168518">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168542">i</span><span class="op" id="5168543">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168550">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168612">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168646">return</span>&nbsp;<span class="ident" id="5168653">context</span><span class="op" id="5168660">{</span><span class="ident" id="5168661">state</span><span class="op" id="5168666">:</span>&nbsp;<span class="ident" id="5168668">stateTag</span><span class="op" id="5168676">,</span>&nbsp;<span class="ident" id="5168678">element</span><span class="op" id="5168685">:</span>&nbsp;<span class="ident" id="5168687">c</span><span class="op" id="5168688">.</span><span class="ident" id="5168689">element</span><span class="op" id="5168696">}</span><span class="op" id="5168697">,</span>&nbsp;<span class="ident" id="5168699">i</span><br>
<span class="lineno"></span><span class="op" id="5168701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5168704">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5168779">func</span>&nbsp;<span class="op" id="5168784">(</span><span class="ident" id="5168785">e</span>&nbsp;<span class="op" id="5168787">*</span><span class="ident" id="5168788">escaper</span><span class="op" id="5168795">)</span>&nbsp;<span class="ident" id="5168797">editActionNode</span><span class="op" id="5168811">(</span><span class="ident" id="5168812">n</span>&nbsp;<span class="op" id="5168814">*</span><span class="ident" id="5168815">parse</span><span class="op" id="5168820">.</span><span class="ident" id="5168821">ActionNode</span><span class="op" id="5168831">,</span>&nbsp;<span class="ident" id="5168833">cmds</span>&nbsp;<span class="op" id="5168838">[</span><span class="op" id="5168839">]</span><span class="builtintype" id="5168840">string</span><span class="op" id="5168846">)</span>&nbsp;<span class="op" id="5168848">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168851">if</span>&nbsp;<span class="ident" id="5168854">_</span><span class="op" id="5168855">,</span>&nbsp;<span class="ident" id="5168857">ok</span>&nbsp;<span class="op" id="5168860">:=</span>&nbsp;<span class="ident" id="5168863">e</span><span class="op" id="5168864">.</span><span class="ident" id="5168865">actionNodeEdits</span><span class="op" id="5168880">[</span><span class="ident" id="5168881">n</span><span class="op" id="5168882">]</span><span class="op" id="5168883">;</span>&nbsp;<span class="ident" id="5168885">ok</span>&nbsp;<span class="op" id="5168888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5168892">panic</span><span class="op" id="5168897">(</span><span class="ident" id="5168898">fmt</span><span class="op" id="5168901">.</span><span class="ident" id="5168902">Sprintf</span><span class="op" id="5168909">(</span><span class="string" id="5168910">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5168944">,</span>&nbsp;<span class="ident" id="5168946">n</span><span class="op" id="5168947">)</span><span class="op" id="5168948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168954">e</span><span class="op" id="5168955">.</span><span class="ident" id="5168956">actionNodeEdits</span><span class="op" id="5168971">[</span><span class="ident" id="5168972">n</span><span class="op" id="5168973">]</span>&nbsp;<span class="op" id="5168975">=</span>&nbsp;<span class="ident" id="5168977">cmds</span><br>
<span class="lineno"></span><span class="op" id="5168982">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="5168985">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5169065">func</span>&nbsp;<span class="op" id="5169070">(</span><span class="ident" id="5169071">e</span>&nbsp;<span class="op" id="5169073">*</span><span class="ident" id="5169074">escaper</span><span class="op" id="5169081">)</span>&nbsp;<span class="ident" id="5169083">editTemplateNode</span><span class="op" id="5169099">(</span><span class="ident" id="5169100">n</span>&nbsp;<span class="op" id="5169102">*</span><span class="ident" id="5169103">parse</span><span class="op" id="5169108">.</span><span class="ident" id="5169109">TemplateNode</span><span class="op" id="5169121">,</span>&nbsp;<span class="ident" id="5169123">callee</span>&nbsp;<span class="builtintype" id="5169130">string</span><span class="op" id="5169136">)</span>&nbsp;<span class="op" id="5169138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169141">if</span>&nbsp;<span class="ident" id="5169144">_</span><span class="op" id="5169145">,</span>&nbsp;<span class="ident" id="5169147">ok</span>&nbsp;<span class="op" id="5169150">:=</span>&nbsp;<span class="ident" id="5169153">e</span><span class="op" id="5169154">.</span><span class="ident" id="5169155">templateNodeEdits</span><span class="op" id="5169172">[</span><span class="ident" id="5169173">n</span><span class="op" id="5169174">]</span><span class="op" id="5169175">;</span>&nbsp;<span class="ident" id="5169177">ok</span>&nbsp;<span class="op" id="5169180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5169184">panic</span><span class="op" id="5169189">(</span><span class="ident" id="5169190">fmt</span><span class="op" id="5169193">.</span><span class="ident" id="5169194">Sprintf</span><span class="op" id="5169201">(</span><span class="string" id="5169202">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5169236">,</span>&nbsp;<span class="ident" id="5169238">n</span><span class="op" id="5169239">)</span><span class="op" id="5169240">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5169243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169246">e</span><span class="op" id="5169247">.</span><span class="ident" id="5169248">templateNodeEdits</span><span class="op" id="5169265">[</span><span class="ident" id="5169266">n</span><span class="op" id="5169267">]</span>&nbsp;<span class="op" id="5169269">=</span>&nbsp;<span class="ident" id="5169271">callee</span><br>
<span class="lineno"></span><span class="op" id="5169278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5169281">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="5169347">func</span>&nbsp;<span class="op" id="5169352">(</span><span class="ident" id="5169353">e</span>&nbsp;<span class="op" id="5169355">*</span><span class="ident" id="5169356">escaper</span><span class="op" id="5169363">)</span>&nbsp;<span class="ident" id="5169365">editTextNode</span><span class="op" id="5169377">(</span><span class="ident" id="5169378">n</span>&nbsp;<span class="op" id="5169380">*</span><span class="ident" id="5169381">parse</span><span class="op" id="5169386">.</span><span class="ident" id="5169387">TextNode</span><span class="op" id="5169395">,</span>&nbsp;<span class="ident" id="5169397">text</span>&nbsp;<span class="op" id="5169402">[</span><span class="op" id="5169403">]</span><span class="builtintype" id="5169404">byte</span><span class="op" id="5169408">)</span>&nbsp;<span class="op" id="5169410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169413">if</span>&nbsp;<span class="ident" id="5169416">_</span><span class="op" id="5169417">,</span>&nbsp;<span class="ident" id="5169419">ok</span>&nbsp;<span class="op" id="5169422">:=</span>&nbsp;<span class="ident" id="5169425">e</span><span class="op" id="5169426">.</span><span class="ident" id="5169427">textNodeEdits</span><span class="op" id="5169440">[</span><span class="ident" id="5169441">n</span><span class="op" id="5169442">]</span><span class="op" id="5169443">;</span>&nbsp;<span class="ident" id="5169445">ok</span>&nbsp;<span class="op" id="5169448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5169452">panic</span><span class="op" id="5169457">(</span><span class="ident" id="5169458">fmt</span><span class="op" id="5169461">.</span><span class="ident" id="5169462">Sprintf</span><span class="op" id="5169469">(</span><span class="string" id="5169470">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5169504">,</span>&nbsp;<span class="ident" id="5169506">n</span><span class="op" id="5169507">)</span><span class="op" id="5169508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5169511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169514">e</span><span class="op" id="5169515">.</span><span class="ident" id="5169516">textNodeEdits</span><span class="op" id="5169529">[</span><span class="ident" id="5169530">n</span><span class="op" id="5169531">]</span>&nbsp;<span class="op" id="5169533">=</span>&nbsp;<span class="ident" id="5169535">text</span><br>
<span class="lineno">735</span><span class="op" id="5169540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5169543">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="5169622">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5169687">func</span>&nbsp;<span class="op" id="5169692">(</span><span class="ident" id="5169693">e</span>&nbsp;<span class="op" id="5169695">*</span><span class="ident" id="5169696">escaper</span><span class="op" id="5169703">)</span>&nbsp;<span class="ident" id="5169705">commit</span><span class="op" id="5169711">(</span><span class="op" id="5169712">)</span>&nbsp;<span class="op" id="5169714">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169717">for</span>&nbsp;<span class="ident" id="5169721">name</span>&nbsp;<span class="op" id="5169726">:=</span>&nbsp;<span class="keyword" id="5169729">range</span>&nbsp;<span class="ident" id="5169735">e</span><span class="op" id="5169736">.</span><span class="ident" id="5169737">output</span>&nbsp;<span class="op" id="5169744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169748">e</span><span class="op" id="5169749">.</span><span class="ident" id="5169750">template</span><span class="op" id="5169758">(</span><span class="ident" id="5169759">name</span><span class="op" id="5169763">)</span><span class="op" id="5169764">.</span><span class="ident" id="5169765">Funcs</span><span class="op" id="5169770">(</span><span class="ident" id="5169771">funcMap</span><span class="op" id="5169778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5169781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169784">for</span>&nbsp;<span class="ident" id="5169788">_</span><span class="op" id="5169789">,</span>&nbsp;<span class="ident" id="5169791">t</span>&nbsp;<span class="op" id="5169793">:=</span>&nbsp;<span class="keyword" id="5169796">range</span>&nbsp;<span class="ident" id="5169802">e</span><span class="op" id="5169803">.</span><span class="ident" id="5169804">derived</span>&nbsp;<span class="op" id="5169812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169816">if</span>&nbsp;<span class="ident" id="5169819">_</span><span class="op" id="5169820">,</span>&nbsp;<span class="ident" id="5169822">err</span>&nbsp;<span class="op" id="5169826">:=</span>&nbsp;<span class="ident" id="5169829">e</span><span class="op" id="5169830">.</span><span class="ident" id="5169831">tmpl</span><span class="op" id="5169835">.</span><span class="ident" id="5169836">text</span><span class="op" id="5169840">.</span><span class="ident" id="5169841">AddParseTree</span><span class="op" id="5169853">(</span><span class="ident" id="5169854">t</span><span class="op" id="5169855">.</span><span class="ident" id="5169856">Name</span><span class="op" id="5169860">(</span><span class="op" id="5169861">)</span><span class="op" id="5169862">,</span>&nbsp;<span class="ident" id="5169864">t</span><span class="op" id="5169865">.</span><span class="ident" id="5169866">Tree</span><span class="op" id="5169870">)</span><span class="op" id="5169871">;</span>&nbsp;<span class="ident" id="5169873">err</span>&nbsp;<span class="op" id="5169877">!=</span>&nbsp;<span class="builtintype" id="5169880">nil</span>&nbsp;<span class="op" id="5169884">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5169889">panic</span><span class="op" id="5169894">(</span><span class="string" id="5169895">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="5169926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5169930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5169933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169936">for</span>&nbsp;<span class="ident" id="5169940">n</span><span class="op" id="5169941">,</span>&nbsp;<span class="ident" id="5169943">s</span>&nbsp;<span class="op" id="5169945">:=</span>&nbsp;<span class="keyword" id="5169948">range</span>&nbsp;<span class="ident" id="5169954">e</span><span class="op" id="5169955">.</span><span class="ident" id="5169956">actionNodeEdits</span>&nbsp;<span class="op" id="5169972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169976">ensurePipelineContains</span><span class="op" id="5169998">(</span><span class="ident" id="5169999">n</span><span class="op" id="5170000">.</span><span class="ident" id="5170001">Pipe</span><span class="op" id="5170005">,</span>&nbsp;<span class="ident" id="5170007">s</span><span class="op" id="5170008">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170014">for</span>&nbsp;<span class="ident" id="5170018">n</span><span class="op" id="5170019">,</span>&nbsp;<span class="ident" id="5170021">name</span>&nbsp;<span class="op" id="5170026">:=</span>&nbsp;<span class="keyword" id="5170029">range</span>&nbsp;<span class="ident" id="5170035">e</span><span class="op" id="5170036">.</span><span class="ident" id="5170037">templateNodeEdits</span>&nbsp;<span class="op" id="5170055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170059">n</span><span class="op" id="5170060">.</span><span class="ident" id="5170061">Name</span>&nbsp;<span class="op" id="5170066">=</span>&nbsp;<span class="ident" id="5170068">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170077">for</span>&nbsp;<span class="ident" id="5170081">n</span><span class="op" id="5170082">,</span>&nbsp;<span class="ident" id="5170084">s</span>&nbsp;<span class="op" id="5170086">:=</span>&nbsp;<span class="keyword" id="5170089">range</span>&nbsp;<span class="ident" id="5170095">e</span><span class="op" id="5170096">.</span><span class="ident" id="5170097">textNodeEdits</span>&nbsp;<span class="op" id="5170111">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170115">n</span><span class="op" id="5170116">.</span><span class="ident" id="5170117">Text</span>&nbsp;<span class="op" id="5170122">=</span>&nbsp;<span class="ident" id="5170124">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170127">}</span><br>
<span class="lineno"></span><span class="op" id="5170129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5170132">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="5170202">func</span>&nbsp;<span class="op" id="5170207">(</span><span class="ident" id="5170208">e</span>&nbsp;<span class="op" id="5170210">*</span><span class="ident" id="5170211">escaper</span><span class="op" id="5170218">)</span>&nbsp;<span class="ident" id="5170220">template</span><span class="op" id="5170228">(</span><span class="ident" id="5170229">name</span>&nbsp;<span class="builtintype" id="5170234">string</span><span class="op" id="5170240">)</span>&nbsp;<span class="op" id="5170242">*</span><span class="ident" id="5170243">template</span><span class="op" id="5170251">.</span><span class="ident" id="5170252">Template</span>&nbsp;<span class="op" id="5170261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170264">t</span>&nbsp;<span class="op" id="5170266">:=</span>&nbsp;<span class="ident" id="5170269">e</span><span class="op" id="5170270">.</span><span class="ident" id="5170271">tmpl</span><span class="op" id="5170275">.</span><span class="ident" id="5170276">text</span><span class="op" id="5170280">.</span><span class="ident" id="5170281">Lookup</span><span class="op" id="5170287">(</span><span class="ident" id="5170288">name</span><span class="op" id="5170292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170295">if</span>&nbsp;<span class="ident" id="5170298">t</span>&nbsp;<span class="op" id="5170300">==</span>&nbsp;<span class="builtintype" id="5170303">nil</span>&nbsp;<span class="op" id="5170307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170311">t</span>&nbsp;<span class="op" id="5170313">=</span>&nbsp;<span class="ident" id="5170315">e</span><span class="op" id="5170316">.</span><span class="ident" id="5170317">derived</span><span class="op" id="5170324">[</span><span class="ident" id="5170325">name</span><span class="op" id="5170329">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170332">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170335">return</span>&nbsp;<span class="ident" id="5170342">t</span><br>
<span class="lineno"></span><span class="op" id="5170344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5170347">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5170417">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="5170479">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5170559">func</span>&nbsp;<span class="ident" id="5170564">HTMLEscape</span><span class="op" id="5170574">(</span><span class="ident" id="5170575">w</span>&nbsp;<span class="ident" id="5170577">io</span><span class="op" id="5170579">.</span><span class="ident" id="5170580">Writer</span><span class="op" id="5170586">,</span>&nbsp;<span class="ident" id="5170588">b</span>&nbsp;<span class="op" id="5170590">[</span><span class="op" id="5170591">]</span><span class="builtintype" id="5170592">byte</span><span class="op" id="5170596">)</span>&nbsp;<span class="op" id="5170598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170601">template</span><span class="op" id="5170609">.</span><span class="ident" id="5170610">HTMLEscape</span><span class="op" id="5170620">(</span><span class="ident" id="5170621">w</span><span class="op" id="5170622">,</span>&nbsp;<span class="ident" id="5170624">b</span><span class="op" id="5170625">)</span><br>
<span class="lineno"></span><span class="op" id="5170627">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="5170630">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5170712">func</span>&nbsp;<span class="ident" id="5170717">HTMLEscapeString</span><span class="op" id="5170733">(</span><span class="ident" id="5170734">s</span>&nbsp;<span class="builtintype" id="5170736">string</span><span class="op" id="5170742">)</span>&nbsp;<span class="builtintype" id="5170744">string</span>&nbsp;<span class="op" id="5170751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170754">return</span>&nbsp;<span class="ident" id="5170761">template</span><span class="op" id="5170769">.</span><span class="ident" id="5170770">HTMLEscapeString</span><span class="op" id="5170786">(</span><span class="ident" id="5170787">s</span><span class="op" id="5170788">)</span><br>
<span class="lineno"></span><span class="op" id="5170790">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="5170793">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5170859">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5170895">func</span>&nbsp;<span class="ident" id="5170900">HTMLEscaper</span><span class="op" id="5170911">(</span><span class="ident" id="5170912">args</span>&nbsp;<span class="op" id="5170917">...</span><span class="keyword" id="5170920">interface</span><span class="op" id="5170929">{</span><span class="op" id="5170930">}</span><span class="op" id="5170931">)</span>&nbsp;<span class="builtintype" id="5170933">string</span>&nbsp;<span class="op" id="5170940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170943">return</span>&nbsp;<span class="ident" id="5170950">template</span><span class="op" id="5170958">.</span><span class="ident" id="5170959">HTMLEscaper</span><span class="op" id="5170970">(</span><span class="ident" id="5170971">args</span><span class="op" id="5170975">...</span><span class="op" id="5170978">)</span><br>
<span class="lineno">785</span><span class="op" id="5170980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5170983">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5171067">func</span>&nbsp;<span class="ident" id="5171072">JSEscape</span><span class="op" id="5171080">(</span><span class="ident" id="5171081">w</span>&nbsp;<span class="ident" id="5171083">io</span><span class="op" id="5171085">.</span><span class="ident" id="5171086">Writer</span><span class="op" id="5171092">,</span>&nbsp;<span class="ident" id="5171094">b</span>&nbsp;<span class="op" id="5171096">[</span><span class="op" id="5171097">]</span><span class="builtintype" id="5171098">byte</span><span class="op" id="5171102">)</span>&nbsp;<span class="op" id="5171104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171107">template</span><span class="op" id="5171115">.</span><span class="ident" id="5171116">JSEscape</span><span class="op" id="5171124">(</span><span class="ident" id="5171125">w</span><span class="op" id="5171126">,</span>&nbsp;<span class="ident" id="5171128">b</span><span class="op" id="5171129">)</span><br>
<span class="lineno">790</span><span class="op" id="5171131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5171134">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5171220">func</span>&nbsp;<span class="ident" id="5171225">JSEscapeString</span><span class="op" id="5171239">(</span><span class="ident" id="5171240">s</span>&nbsp;<span class="builtintype" id="5171242">string</span><span class="op" id="5171248">)</span>&nbsp;<span class="builtintype" id="5171250">string</span>&nbsp;<span class="op" id="5171257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171260">return</span>&nbsp;<span class="ident" id="5171267">template</span><span class="op" id="5171275">.</span><span class="ident" id="5171276">JSEscapeString</span><span class="op" id="5171290">(</span><span class="ident" id="5171291">s</span><span class="op" id="5171292">)</span><br>
<span class="lineno">795</span><span class="op" id="5171294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5171297">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5171367">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5171403">func</span>&nbsp;<span class="ident" id="5171408">JSEscaper</span><span class="op" id="5171417">(</span><span class="ident" id="5171418">args</span>&nbsp;<span class="op" id="5171423">...</span><span class="keyword" id="5171426">interface</span><span class="op" id="5171435">{</span><span class="op" id="5171436">}</span><span class="op" id="5171437">)</span>&nbsp;<span class="builtintype" id="5171439">string</span>&nbsp;<span class="op" id="5171446">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171449">return</span>&nbsp;<span class="ident" id="5171456">template</span><span class="op" id="5171464">.</span><span class="ident" id="5171465">JSEscaper</span><span class="op" id="5171474">(</span><span class="ident" id="5171475">args</span><span class="op" id="5171479">...</span><span class="op" id="5171482">)</span><br>
<span class="lineno"></span><span class="op" id="5171484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5171487">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5171565">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="5171631">func</span>&nbsp;<span class="ident" id="5171636">URLQueryEscaper</span><span class="op" id="5171651">(</span><span class="ident" id="5171652">args</span>&nbsp;<span class="op" id="5171657">...</span><span class="keyword" id="5171660">interface</span><span class="op" id="5171669">{</span><span class="op" id="5171670">}</span><span class="op" id="5171671">)</span>&nbsp;<span class="builtintype" id="5171673">string</span>&nbsp;<span class="op" id="5171680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171683">return</span>&nbsp;<span class="ident" id="5171690">template</span><span class="op" id="5171698">.</span><span class="ident" id="5171699">URLQueryEscaper</span><span class="op" id="5171714">(</span><span class="ident" id="5171715">args</span><span class="op" id="5171719">...</span><span class="op" id="5171722">)</span><br>
<span class="lineno"></span><span class="op" id="5171724">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
