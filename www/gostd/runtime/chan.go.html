<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1413379">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1413434">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1413488">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1413539">package</span>&nbsp;<span class="ident" id="1413547">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1413556">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1413614">import</span>&nbsp;<span class="string" id="1413621">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1413631">const</span>&nbsp;<span class="op" id="1413637">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413640">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1413650">=</span>&nbsp;<span class="num" id="1413652">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413655">hchanSize</span>&nbsp;<span class="op" id="1413665">=</span>&nbsp;<span class="ident" id="1413667">unsafe</span><span class="op" id="1413673">.</span><span class="ident" id="1413674">Sizeof</span><span class="op" id="1413680">(</span><span class="ident" id="1413681">hchan</span><span class="op" id="1413686">{</span><span class="op" id="1413687">}</span><span class="op" id="1413688">)</span>&nbsp;<span class="op" id="1413690">+</span>&nbsp;<span class="builtintype" id="1413692">uintptr</span><span class="op" id="1413699">(</span><span class="op" id="1413700">-</span><span class="builtintype" id="1413701">int</span><span class="op" id="1413704">(</span><span class="ident" id="1413705">unsafe</span><span class="op" id="1413711">.</span><span class="ident" id="1413712">Sizeof</span><span class="op" id="1413718">(</span><span class="ident" id="1413719">hchan</span><span class="op" id="1413724">{</span><span class="op" id="1413725">}</span><span class="op" id="1413726">)</span><span class="op" id="1413727">)</span><span class="op" id="1413728">&amp;</span><span class="op" id="1413729">(</span><span class="ident" id="1413730">maxAlign</span><span class="op" id="1413738">-</span><span class="num" id="1413739">1</span><span class="op" id="1413740">)</span><span class="op" id="1413741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413744">debugChan</span>&nbsp;<span class="op" id="1413754">=</span>&nbsp;<span class="builtintype" id="1413756">false</span><br>
<span class="lineno">15</span><span class="op" id="1413762">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1413765">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1413827">func</span>&nbsp;<span class="ident" id="1413832">makechan</span><span class="op" id="1413840">(</span><span class="ident" id="1413841">t</span>&nbsp;<span class="op" id="1413843">*</span><span class="ident" id="1413844">chantype</span><span class="op" id="1413852">,</span>&nbsp;<span class="ident" id="1413854">size</span>&nbsp;<span class="ident" id="1413859">int64</span><span class="op" id="1413864">)</span>&nbsp;<span class="op" id="1413866">*</span><span class="ident" id="1413867">hchan</span>&nbsp;<span class="op" id="1413873">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413876">elem</span>&nbsp;<span class="op" id="1413881">:=</span>&nbsp;<span class="ident" id="1413884">t</span><span class="op" id="1413885">.</span><span class="ident" id="1413886">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1413893">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1413931">if</span>&nbsp;<span class="ident" id="1413934">elem</span><span class="op" id="1413938">.</span><span class="ident" id="1413939">size</span>&nbsp;<span class="op" id="1413944">&gt;=</span>&nbsp;<span class="num" id="1413947">1</span><span class="op" id="1413948">&lt;&lt;</span><span class="num" id="1413950">16</span>&nbsp;<span class="op" id="1413953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1413957">gothrow</span><span class="op" id="1413964">(</span><span class="string" id="1413965">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1414005">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414011">if</span>&nbsp;<span class="ident" id="1414014">hchanSize</span><span class="op" id="1414023">%</span><span class="ident" id="1414024">maxAlign</span>&nbsp;<span class="op" id="1414033">!=</span>&nbsp;<span class="num" id="1414036">0</span>&nbsp;<span class="op" id="1414038">||</span>&nbsp;<span class="ident" id="1414041">elem</span><span class="op" id="1414045">.</span><span class="ident" id="1414046">align</span>&nbsp;<span class="op" id="1414052">&gt;</span>&nbsp;<span class="ident" id="1414054">maxAlign</span>&nbsp;<span class="op" id="1414063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414067">gothrow</span><span class="op" id="1414074">(</span><span class="string" id="1414075">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1414100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414106">if</span>&nbsp;<span class="ident" id="1414109">size</span>&nbsp;<span class="op" id="1414114">&lt;</span>&nbsp;<span class="num" id="1414116">0</span>&nbsp;<span class="op" id="1414118">||</span>&nbsp;<span class="ident" id="1414121">int64</span><span class="op" id="1414126">(</span><span class="builtintype" id="1414127">uintptr</span><span class="op" id="1414134">(</span><span class="ident" id="1414135">size</span><span class="op" id="1414139">)</span><span class="op" id="1414140">)</span>&nbsp;<span class="op" id="1414142">!=</span>&nbsp;<span class="ident" id="1414145">size</span>&nbsp;<span class="op" id="1414150">||</span>&nbsp;<span class="op" id="1414153">(</span><span class="ident" id="1414154">elem</span><span class="op" id="1414158">.</span><span class="ident" id="1414159">size</span>&nbsp;<span class="op" id="1414164">&gt;</span>&nbsp;<span class="num" id="1414166">0</span>&nbsp;<span class="op" id="1414168">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1414171">uintptr</span><span class="op" id="1414178">(</span><span class="ident" id="1414179">size</span><span class="op" id="1414183">)</span>&nbsp;<span class="op" id="1414185">&gt;</span>&nbsp;<span class="op" id="1414187">(</span><span class="ident" id="1414188">maxmem</span><span class="op" id="1414194">-</span><span class="ident" id="1414195">hchanSize</span><span class="op" id="1414204">)</span><span class="op" id="1414205">/</span><span class="builtintype" id="1414206">uintptr</span><span class="op" id="1414213">(</span><span class="ident" id="1414214">elem</span><span class="op" id="1414218">.</span><span class="ident" id="1414219">size</span><span class="op" id="1414223">)</span><span class="op" id="1414224">)</span>&nbsp;<span class="op" id="1414226">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1414230">panic</span><span class="op" id="1414235">(</span><span class="string" id="1414236">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1414265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414272">var</span>&nbsp;<span class="ident" id="1414276">c</span>&nbsp;<span class="op" id="1414278">*</span><span class="ident" id="1414279">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414286">if</span>&nbsp;<span class="ident" id="1414289">elem</span><span class="op" id="1414293">.</span><span class="ident" id="1414294">kind</span><span class="op" id="1414298">&amp;</span><span class="ident" id="1414299">kindNoPointers</span>&nbsp;<span class="op" id="1414314">!=</span>&nbsp;<span class="num" id="1414317">0</span>&nbsp;<span class="op" id="1414319">||</span>&nbsp;<span class="ident" id="1414322">size</span>&nbsp;<span class="op" id="1414327">==</span>&nbsp;<span class="num" id="1414330">0</span>&nbsp;<span class="op" id="1414332">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1414336">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1414370">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1414440">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1414506">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1414587">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414662">c</span>&nbsp;<span class="op" id="1414664">=</span>&nbsp;<span class="op" id="1414666">(</span><span class="op" id="1414667">*</span><span class="ident" id="1414668">hchan</span><span class="op" id="1414673">)</span><span class="op" id="1414674">(</span><span class="ident" id="1414675">mallocgc</span><span class="op" id="1414683">(</span><span class="ident" id="1414684">hchanSize</span><span class="op" id="1414693">+</span><span class="builtintype" id="1414694">uintptr</span><span class="op" id="1414701">(</span><span class="ident" id="1414702">size</span><span class="op" id="1414706">)</span><span class="op" id="1414707">*</span><span class="builtintype" id="1414708">uintptr</span><span class="op" id="1414715">(</span><span class="ident" id="1414716">elem</span><span class="op" id="1414720">.</span><span class="ident" id="1414721">size</span><span class="op" id="1414725">)</span><span class="op" id="1414726">,</span>&nbsp;<span class="ident" id="1414728">nil</span><span class="op" id="1414731">,</span>&nbsp;<span class="ident" id="1414733">flagNoScan</span><span class="op" id="1414743">)</span><span class="op" id="1414744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1414748">if</span>&nbsp;<span class="ident" id="1414751">size</span>&nbsp;<span class="op" id="1414756">&gt;</span>&nbsp;<span class="num" id="1414758">0</span>&nbsp;<span class="op" id="1414760">&amp;&amp;</span>&nbsp;<span class="ident" id="1414763">elem</span><span class="op" id="1414767">.</span><span class="ident" id="1414768">size</span>&nbsp;<span class="op" id="1414773">!=</span>&nbsp;<span class="num" id="1414776">0</span>&nbsp;<span class="op" id="1414778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414783">c</span><span class="op" id="1414784">.</span><span class="ident" id="1414785">buf</span>&nbsp;<span class="op" id="1414789">=</span>&nbsp;<span class="op" id="1414791">(</span><span class="op" id="1414792">*</span><span class="builtintype" id="1414793">uint8</span><span class="op" id="1414798">)</span><span class="op" id="1414799">(</span><span class="ident" id="1414800">add</span><span class="op" id="1414803">(</span><span class="ident" id="1414804">unsafe</span><span class="op" id="1414810">.</span><span class="ident" id="1414811">Pointer</span><span class="op" id="1414818">(</span><span class="ident" id="1414819">c</span><span class="op" id="1414820">)</span><span class="op" id="1414821">,</span>&nbsp;<span class="ident" id="1414823">hchanSize</span><span class="op" id="1414832">)</span><span class="op" id="1414833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414837">}</span>&nbsp;<span class="keyword" id="1414839">else</span>&nbsp;<span class="op" id="1414844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414849">c</span><span class="op" id="1414850">.</span><span class="ident" id="1414851">buf</span>&nbsp;<span class="op" id="1414855">=</span>&nbsp;<span class="op" id="1414857">(</span><span class="op" id="1414858">*</span><span class="builtintype" id="1414859">uint8</span><span class="op" id="1414864">)</span><span class="op" id="1414865">(</span><span class="ident" id="1414866">unsafe</span><span class="op" id="1414872">.</span><span class="ident" id="1414873">Pointer</span><span class="op" id="1414880">(</span><span class="ident" id="1414881">c</span><span class="op" id="1414882">)</span><span class="op" id="1414883">)</span>&nbsp;<span class="comment" id="1414885">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1414946">}</span>&nbsp;<span class="keyword" id="1414948">else</span>&nbsp;<span class="op" id="1414953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414957">c</span>&nbsp;<span class="op" id="1414959">=</span>&nbsp;<span class="builtinfunc" id="1414961">new</span><span class="op" id="1414964">(</span><span class="ident" id="1414965">hchan</span><span class="op" id="1414970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1414974">c</span><span class="op" id="1414975">.</span><span class="ident" id="1414976">buf</span>&nbsp;<span class="op" id="1414980">=</span>&nbsp;<span class="op" id="1414982">(</span><span class="op" id="1414983">*</span><span class="builtintype" id="1414984">uint8</span><span class="op" id="1414989">)</span><span class="op" id="1414990">(</span><span class="ident" id="1414991">newarray</span><span class="op" id="1414999">(</span><span class="ident" id="1415000">elem</span><span class="op" id="1415004">,</span>&nbsp;<span class="builtintype" id="1415006">uintptr</span><span class="op" id="1415013">(</span><span class="ident" id="1415014">size</span><span class="op" id="1415018">)</span><span class="op" id="1415019">)</span><span class="op" id="1415020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1415023">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415026">c</span><span class="op" id="1415027">.</span><span class="ident" id="1415028">elemsize</span>&nbsp;<span class="op" id="1415037">=</span>&nbsp;<span class="builtintype" id="1415039">uint16</span><span class="op" id="1415045">(</span><span class="ident" id="1415046">elem</span><span class="op" id="1415050">.</span><span class="ident" id="1415051">size</span><span class="op" id="1415055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415058">c</span><span class="op" id="1415059">.</span><span class="ident" id="1415060">elemtype</span>&nbsp;<span class="op" id="1415069">=</span>&nbsp;<span class="ident" id="1415071">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415077">c</span><span class="op" id="1415078">.</span><span class="ident" id="1415079">dataqsiz</span>&nbsp;<span class="op" id="1415088">=</span>&nbsp;<span class="builtintype" id="1415090">uint</span><span class="op" id="1415094">(</span><span class="ident" id="1415095">size</span><span class="op" id="1415099">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1415103">if</span>&nbsp;<span class="ident" id="1415106">debugChan</span>&nbsp;<span class="op" id="1415116">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1415120">print</span><span class="op" id="1415125">(</span><span class="string" id="1415126">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1415143">,</span>&nbsp;<span class="ident" id="1415145">c</span><span class="op" id="1415146">,</span>&nbsp;<span class="string" id="1415148">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1415161">,</span>&nbsp;<span class="ident" id="1415163">elem</span><span class="op" id="1415167">.</span><span class="ident" id="1415168">size</span><span class="op" id="1415172">,</span>&nbsp;<span class="string" id="1415174">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1415186">,</span>&nbsp;<span class="ident" id="1415188">elem</span><span class="op" id="1415192">.</span><span class="ident" id="1415193">alg</span><span class="op" id="1415196">,</span>&nbsp;<span class="string" id="1415198">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1415211">,</span>&nbsp;<span class="ident" id="1415213">size</span><span class="op" id="1415217">,</span>&nbsp;<span class="string" id="1415219">&#34;\n&#34;</span><span class="op" id="1415223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1415226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1415229">return</span>&nbsp;<span class="ident" id="1415236">c</span><br>
<span class="lineno"></span><span class="op" id="1415238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1415241">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1415301">func</span>&nbsp;<span class="ident" id="1415306">chanbuf</span><span class="op" id="1415313">(</span><span class="ident" id="1415314">c</span>&nbsp;<span class="op" id="1415316">*</span><span class="ident" id="1415317">hchan</span><span class="op" id="1415322">,</span>&nbsp;<span class="ident" id="1415324">i</span>&nbsp;<span class="builtintype" id="1415326">uint</span><span class="op" id="1415330">)</span>&nbsp;<span class="ident" id="1415332">unsafe</span><span class="op" id="1415338">.</span><span class="ident" id="1415339">Pointer</span>&nbsp;<span class="op" id="1415347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1415350">return</span>&nbsp;<span class="ident" id="1415357">add</span><span class="op" id="1415360">(</span><span class="ident" id="1415361">unsafe</span><span class="op" id="1415367">.</span><span class="ident" id="1415368">Pointer</span><span class="op" id="1415375">(</span><span class="ident" id="1415376">c</span><span class="op" id="1415377">.</span><span class="ident" id="1415378">buf</span><span class="op" id="1415381">)</span><span class="op" id="1415382">,</span>&nbsp;<span class="builtintype" id="1415384">uintptr</span><span class="op" id="1415391">(</span><span class="ident" id="1415392">i</span><span class="op" id="1415393">)</span><span class="op" id="1415394">*</span><span class="builtintype" id="1415395">uintptr</span><span class="op" id="1415402">(</span><span class="ident" id="1415403">c</span><span class="op" id="1415404">.</span><span class="ident" id="1415405">elemsize</span><span class="op" id="1415413">)</span><span class="op" id="1415414">)</span><br>
<span class="lineno"></span><span class="op" id="1415416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1415419">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1415464">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1415477">func</span>&nbsp;<span class="ident" id="1415482">chansend1</span><span class="op" id="1415491">(</span><span class="ident" id="1415492">t</span>&nbsp;<span class="op" id="1415494">*</span><span class="ident" id="1415495">chantype</span><span class="op" id="1415503">,</span>&nbsp;<span class="ident" id="1415505">c</span>&nbsp;<span class="op" id="1415507">*</span><span class="ident" id="1415508">hchan</span><span class="op" id="1415513">,</span>&nbsp;<span class="ident" id="1415515">elem</span>&nbsp;<span class="ident" id="1415520">unsafe</span><span class="op" id="1415526">.</span><span class="ident" id="1415527">Pointer</span><span class="op" id="1415534">)</span>&nbsp;<span class="op" id="1415536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1415539">chansend</span><span class="op" id="1415547">(</span><span class="ident" id="1415548">t</span><span class="op" id="1415549">,</span>&nbsp;<span class="ident" id="1415551">c</span><span class="op" id="1415552">,</span>&nbsp;<span class="ident" id="1415554">elem</span><span class="op" id="1415558">,</span>&nbsp;<span class="builtintype" id="1415560">true</span><span class="op" id="1415564">,</span>&nbsp;<span class="ident" id="1415566">getcallerpc</span><span class="op" id="1415577">(</span><span class="ident" id="1415578">unsafe</span><span class="op" id="1415584">.</span><span class="ident" id="1415585">Pointer</span><span class="op" id="1415592">(</span><span class="op" id="1415593">&amp;</span><span class="ident" id="1415594">t</span><span class="op" id="1415595">)</span><span class="op" id="1415596">)</span><span class="op" id="1415597">)</span><br>
<span class="lineno"></span><span class="op" id="1415599">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1415602">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1415936">func</span>&nbsp;<span class="ident" id="1415941">chansend</span><span class="op" id="1415949">(</span><span class="ident" id="1415950">t</span>&nbsp;<span class="op" id="1415952">*</span><span class="ident" id="1415953">chantype</span><span class="op" id="1415961">,</span>&nbsp;<span class="ident" id="1415963">c</span>&nbsp;<span class="op" id="1415965">*</span><span class="ident" id="1415966">hchan</span><span class="op" id="1415971">,</span>&nbsp;<span class="ident" id="1415973">ep</span>&nbsp;<span class="ident" id="1415976">unsafe</span><span class="op" id="1415982">.</span><span class="ident" id="1415983">Pointer</span><span class="op" id="1415990">,</span>&nbsp;<span class="ident" id="1415992">block</span>&nbsp;<span class="builtintype" id="1415998">bool</span><span class="op" id="1416002">,</span>&nbsp;<span class="ident" id="1416004">callerpc</span>&nbsp;<span class="builtintype" id="1416013">uintptr</span><span class="op" id="1416020">)</span>&nbsp;<span class="builtintype" id="1416022">bool</span>&nbsp;<span class="op" id="1416027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1416030">if</span>&nbsp;<span class="ident" id="1416033">raceenabled</span>&nbsp;<span class="op" id="1416045">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1416049">raceReadObjectPC</span><span class="op" id="1416065">(</span><span class="ident" id="1416066">t</span><span class="op" id="1416067">.</span><span class="ident" id="1416068">elem</span><span class="op" id="1416072">,</span>&nbsp;<span class="ident" id="1416074">ep</span><span class="op" id="1416076">,</span>&nbsp;<span class="ident" id="1416078">callerpc</span><span class="op" id="1416086">,</span>&nbsp;<span class="ident" id="1416088">funcPC</span><span class="op" id="1416094">(</span><span class="ident" id="1416095">chansend</span><span class="op" id="1416103">)</span><span class="op" id="1416104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1416107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1416111">if</span>&nbsp;<span class="ident" id="1416114">c</span>&nbsp;<span class="op" id="1416116">==</span>&nbsp;<span class="ident" id="1416119">nil</span>&nbsp;<span class="op" id="1416123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1416127">if</span>&nbsp;<span class="op" id="1416130">!</span><span class="ident" id="1416131">block</span>&nbsp;<span class="op" id="1416137">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1416142">return</span>&nbsp;<span class="builtintype" id="1416149">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1416157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1416161">gopark</span><span class="op" id="1416167">(</span><span class="ident" id="1416168">nil</span><span class="op" id="1416171">,</span>&nbsp;<span class="ident" id="1416173">nil</span><span class="op" id="1416176">,</span>&nbsp;<span class="string" id="1416178">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1416200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1416204">gothrow</span><span class="op" id="1416211">(</span><span class="string" id="1416212">&#34;unreachable&#34;</span><span class="op" id="1416225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1416228">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1416232">if</span>&nbsp;<span class="ident" id="1416235">debugChan</span>&nbsp;<span class="op" id="1416245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1416249">print</span><span class="op" id="1416254">(</span><span class="string" id="1416255">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1416272">,</span>&nbsp;<span class="ident" id="1416274">c</span><span class="op" id="1416275">,</span>&nbsp;<span class="string" id="1416277">&#34;\n&#34;</span><span class="op" id="1416281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1416284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1416288">if</span>&nbsp;<span class="ident" id="1416291">raceenabled</span>&nbsp;<span class="op" id="1416303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1416307">racereadpc</span><span class="op" id="1416317">(</span><span class="ident" id="1416318">unsafe</span><span class="op" id="1416324">.</span><span class="ident" id="1416325">Pointer</span><span class="op" id="1416332">(</span><span class="ident" id="1416333">c</span><span class="op" id="1416334">)</span><span class="op" id="1416335">,</span>&nbsp;<span class="ident" id="1416337">callerpc</span><span class="op" id="1416345">,</span>&nbsp;<span class="ident" id="1416347">funcPC</span><span class="op" id="1416353">(</span><span class="ident" id="1416354">chansend</span><span class="op" id="1416362">)</span><span class="op" id="1416363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1416366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416370">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416453">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416457">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416540">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416622">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416710">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416785">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416874">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1416955">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417042">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417087">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417091">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417177">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1417261">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417317">if</span>&nbsp;<span class="op" id="1417320">!</span><span class="ident" id="1417321">block</span>&nbsp;<span class="op" id="1417327">&amp;&amp;</span>&nbsp;<span class="ident" id="1417330">c</span><span class="op" id="1417331">.</span><span class="ident" id="1417332">closed</span>&nbsp;<span class="op" id="1417339">==</span>&nbsp;<span class="num" id="1417342">0</span>&nbsp;<span class="op" id="1417344">&amp;&amp;</span>&nbsp;<span class="op" id="1417347">(</span><span class="op" id="1417348">(</span><span class="ident" id="1417349">c</span><span class="op" id="1417350">.</span><span class="ident" id="1417351">dataqsiz</span>&nbsp;<span class="op" id="1417360">==</span>&nbsp;<span class="num" id="1417363">0</span>&nbsp;<span class="op" id="1417365">&amp;&amp;</span>&nbsp;<span class="ident" id="1417368">c</span><span class="op" id="1417369">.</span><span class="ident" id="1417370">recvq</span><span class="op" id="1417375">.</span><span class="ident" id="1417376">first</span>&nbsp;<span class="op" id="1417382">==</span>&nbsp;<span class="ident" id="1417385">nil</span><span class="op" id="1417388">)</span>&nbsp;<span class="op" id="1417390">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417395">(</span><span class="ident" id="1417396">c</span><span class="op" id="1417397">.</span><span class="ident" id="1417398">dataqsiz</span>&nbsp;<span class="op" id="1417407">&gt;</span>&nbsp;<span class="num" id="1417409">0</span>&nbsp;<span class="op" id="1417411">&amp;&amp;</span>&nbsp;<span class="ident" id="1417414">c</span><span class="op" id="1417415">.</span><span class="ident" id="1417416">qcount</span>&nbsp;<span class="op" id="1417423">==</span>&nbsp;<span class="ident" id="1417426">c</span><span class="op" id="1417427">.</span><span class="ident" id="1417428">dataqsiz</span><span class="op" id="1417436">)</span><span class="op" id="1417437">)</span>&nbsp;<span class="op" id="1417439">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417443">return</span>&nbsp;<span class="builtintype" id="1417450">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417461">var</span>&nbsp;<span class="ident" id="1417465">t0</span>&nbsp;<span class="ident" id="1417468">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417475">if</span>&nbsp;<span class="ident" id="1417478">blockprofilerate</span>&nbsp;<span class="op" id="1417495">&gt;</span>&nbsp;<span class="num" id="1417497">0</span>&nbsp;<span class="op" id="1417499">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417503">t0</span>&nbsp;<span class="op" id="1417506">=</span>&nbsp;<span class="ident" id="1417508">cputicks</span><span class="op" id="1417516">(</span><span class="op" id="1417517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417524">lock</span><span class="op" id="1417528">(</span><span class="op" id="1417529">&amp;</span><span class="ident" id="1417530">c</span><span class="op" id="1417531">.</span><span class="ident" id="1417532">lock</span><span class="op" id="1417536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417539">if</span>&nbsp;<span class="ident" id="1417542">c</span><span class="op" id="1417543">.</span><span class="ident" id="1417544">closed</span>&nbsp;<span class="op" id="1417551">!=</span>&nbsp;<span class="num" id="1417554">0</span>&nbsp;<span class="op" id="1417556">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417560">unlock</span><span class="op" id="1417566">(</span><span class="op" id="1417567">&amp;</span><span class="ident" id="1417568">c</span><span class="op" id="1417569">.</span><span class="ident" id="1417570">lock</span><span class="op" id="1417574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1417578">panic</span><span class="op" id="1417583">(</span><span class="string" id="1417584">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1417608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417615">if</span>&nbsp;<span class="ident" id="1417618">c</span><span class="op" id="1417619">.</span><span class="ident" id="1417620">dataqsiz</span>&nbsp;<span class="op" id="1417629">==</span>&nbsp;<span class="num" id="1417632">0</span>&nbsp;<span class="op" id="1417634">{</span>&nbsp;<span class="comment" id="1417636">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417661">sg</span>&nbsp;<span class="op" id="1417664">:=</span>&nbsp;<span class="ident" id="1417667">c</span><span class="op" id="1417668">.</span><span class="ident" id="1417669">recvq</span><span class="op" id="1417674">.</span><span class="ident" id="1417675">dequeue</span><span class="op" id="1417682">(</span><span class="op" id="1417683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417687">if</span>&nbsp;<span class="ident" id="1417690">sg</span>&nbsp;<span class="op" id="1417693">!=</span>&nbsp;<span class="ident" id="1417696">nil</span>&nbsp;<span class="op" id="1417700">{</span>&nbsp;<span class="comment" id="1417702">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417733">if</span>&nbsp;<span class="ident" id="1417736">raceenabled</span>&nbsp;<span class="op" id="1417748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417754">racesync</span><span class="op" id="1417762">(</span><span class="ident" id="1417763">c</span><span class="op" id="1417764">,</span>&nbsp;<span class="ident" id="1417766">sg</span><span class="op" id="1417768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417773">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417778">unlock</span><span class="op" id="1417784">(</span><span class="op" id="1417785">&amp;</span><span class="ident" id="1417786">c</span><span class="op" id="1417787">.</span><span class="ident" id="1417788">lock</span><span class="op" id="1417792">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417798">recvg</span>&nbsp;<span class="op" id="1417804">:=</span>&nbsp;<span class="ident" id="1417807">sg</span><span class="op" id="1417809">.</span><span class="ident" id="1417810">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417815">if</span>&nbsp;<span class="ident" id="1417818">sg</span><span class="op" id="1417820">.</span><span class="ident" id="1417821">elem</span>&nbsp;<span class="op" id="1417826">!=</span>&nbsp;<span class="ident" id="1417829">nil</span>&nbsp;<span class="op" id="1417833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417839">memmove</span><span class="op" id="1417846">(</span><span class="ident" id="1417847">unsafe</span><span class="op" id="1417853">.</span><span class="ident" id="1417854">Pointer</span><span class="op" id="1417861">(</span><span class="ident" id="1417862">sg</span><span class="op" id="1417864">.</span><span class="ident" id="1417865">elem</span><span class="op" id="1417869">)</span><span class="op" id="1417870">,</span>&nbsp;<span class="ident" id="1417872">ep</span><span class="op" id="1417874">,</span>&nbsp;<span class="builtintype" id="1417876">uintptr</span><span class="op" id="1417883">(</span><span class="ident" id="1417884">c</span><span class="op" id="1417885">.</span><span class="ident" id="1417886">elemsize</span><span class="op" id="1417894">)</span><span class="op" id="1417895">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417901">sg</span><span class="op" id="1417903">.</span><span class="ident" id="1417904">elem</span>&nbsp;<span class="op" id="1417909">=</span>&nbsp;<span class="ident" id="1417911">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1417918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417923">recvg</span><span class="op" id="1417928">.</span><span class="ident" id="1417929">param</span>&nbsp;<span class="op" id="1417935">=</span>&nbsp;<span class="ident" id="1417937">unsafe</span><span class="op" id="1417943">.</span><span class="ident" id="1417944">Pointer</span><span class="op" id="1417951">(</span><span class="ident" id="1417952">sg</span><span class="op" id="1417954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1417959">if</span>&nbsp;<span class="ident" id="1417962">sg</span><span class="op" id="1417964">.</span><span class="ident" id="1417965">releasetime</span>&nbsp;<span class="op" id="1417977">!=</span>&nbsp;<span class="num" id="1417980">0</span>&nbsp;<span class="op" id="1417982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1417988">sg</span><span class="op" id="1417990">.</span><span class="ident" id="1417991">releasetime</span>&nbsp;<span class="op" id="1418003">=</span>&nbsp;<span class="ident" id="1418005">cputicks</span><span class="op" id="1418013">(</span><span class="op" id="1418014">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418024">goready</span><span class="op" id="1418031">(</span><span class="ident" id="1418032">recvg</span><span class="op" id="1418037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418042">return</span>&nbsp;<span class="builtintype" id="1418049">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418061">if</span>&nbsp;<span class="op" id="1418064">!</span><span class="ident" id="1418065">block</span>&nbsp;<span class="op" id="1418071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418076">unlock</span><span class="op" id="1418082">(</span><span class="op" id="1418083">&amp;</span><span class="ident" id="1418084">c</span><span class="op" id="1418085">.</span><span class="ident" id="1418086">lock</span><span class="op" id="1418090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418095">return</span>&nbsp;<span class="builtintype" id="1418102">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418115">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418166">gp</span>&nbsp;<span class="op" id="1418169">:=</span>&nbsp;<span class="ident" id="1418172">getg</span><span class="op" id="1418176">(</span><span class="op" id="1418177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418181">mysg</span>&nbsp;<span class="op" id="1418186">:=</span>&nbsp;<span class="ident" id="1418189">acquireSudog</span><span class="op" id="1418201">(</span><span class="op" id="1418202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418206">mysg</span><span class="op" id="1418210">.</span><span class="ident" id="1418211">releasetime</span>&nbsp;<span class="op" id="1418223">=</span>&nbsp;<span class="num" id="1418225">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418229">if</span>&nbsp;<span class="ident" id="1418232">t0</span>&nbsp;<span class="op" id="1418235">!=</span>&nbsp;<span class="num" id="1418238">0</span>&nbsp;<span class="op" id="1418240">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418245">mysg</span><span class="op" id="1418249">.</span><span class="ident" id="1418250">releasetime</span>&nbsp;<span class="op" id="1418262">=</span>&nbsp;<span class="op" id="1418264">-</span><span class="num" id="1418265">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418273">mysg</span><span class="op" id="1418277">.</span><span class="ident" id="1418278">elem</span>&nbsp;<span class="op" id="1418283">=</span>&nbsp;<span class="ident" id="1418285">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418290">mysg</span><span class="op" id="1418294">.</span><span class="ident" id="1418295">waitlink</span>&nbsp;<span class="op" id="1418304">=</span>&nbsp;<span class="ident" id="1418306">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418312">gp</span><span class="op" id="1418314">.</span><span class="ident" id="1418315">waiting</span>&nbsp;<span class="op" id="1418323">=</span>&nbsp;<span class="ident" id="1418325">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418332">mysg</span><span class="op" id="1418336">.</span><span class="ident" id="1418337">g</span>&nbsp;<span class="op" id="1418339">=</span>&nbsp;<span class="ident" id="1418341">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418346">mysg</span><span class="op" id="1418350">.</span><span class="ident" id="1418351">selectdone</span>&nbsp;<span class="op" id="1418362">=</span>&nbsp;<span class="ident" id="1418364">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418370">gp</span><span class="op" id="1418372">.</span><span class="ident" id="1418373">param</span>&nbsp;<span class="op" id="1418379">=</span>&nbsp;<span class="ident" id="1418381">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418387">c</span><span class="op" id="1418388">.</span><span class="ident" id="1418389">sendq</span><span class="op" id="1418394">.</span><span class="ident" id="1418395">enqueue</span><span class="op" id="1418402">(</span><span class="ident" id="1418403">mysg</span><span class="op" id="1418407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418411">goparkunlock</span><span class="op" id="1418423">(</span><span class="op" id="1418424">&amp;</span><span class="ident" id="1418425">c</span><span class="op" id="1418426">.</span><span class="ident" id="1418427">lock</span><span class="op" id="1418431">,</span>&nbsp;<span class="string" id="1418433">&#34;chan&nbsp;send&#34;</span><span class="op" id="1418444">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418449">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418474">if</span>&nbsp;<span class="ident" id="1418477">mysg</span>&nbsp;<span class="op" id="1418482">!=</span>&nbsp;<span class="ident" id="1418485">gp</span><span class="op" id="1418487">.</span><span class="ident" id="1418488">waiting</span>&nbsp;<span class="op" id="1418496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418501">gothrow</span><span class="op" id="1418508">(</span><span class="string" id="1418509">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1418539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418543">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418547">gp</span><span class="op" id="1418549">.</span><span class="ident" id="1418550">waiting</span>&nbsp;<span class="op" id="1418558">=</span>&nbsp;<span class="ident" id="1418560">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418566">if</span>&nbsp;<span class="ident" id="1418569">gp</span><span class="op" id="1418571">.</span><span class="ident" id="1418572">param</span>&nbsp;<span class="op" id="1418578">==</span>&nbsp;<span class="ident" id="1418581">nil</span>&nbsp;<span class="op" id="1418585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418590">if</span>&nbsp;<span class="ident" id="1418593">c</span><span class="op" id="1418594">.</span><span class="ident" id="1418595">closed</span>&nbsp;<span class="op" id="1418602">==</span>&nbsp;<span class="num" id="1418605">0</span>&nbsp;<span class="op" id="1418607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418613">gothrow</span><span class="op" id="1418620">(</span><span class="string" id="1418621">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1418648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418653">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1418658">panic</span><span class="op" id="1418663">(</span><span class="string" id="1418664">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1418688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418696">gp</span><span class="op" id="1418698">.</span><span class="ident" id="1418699">param</span>&nbsp;<span class="op" id="1418705">=</span>&nbsp;<span class="ident" id="1418707">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418713">if</span>&nbsp;<span class="ident" id="1418716">mysg</span><span class="op" id="1418720">.</span><span class="ident" id="1418721">releasetime</span>&nbsp;<span class="op" id="1418733">&gt;</span>&nbsp;<span class="num" id="1418735">0</span>&nbsp;<span class="op" id="1418737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418742">blockevent</span><span class="op" id="1418752">(</span><span class="ident" id="1418753">int64</span><span class="op" id="1418758">(</span><span class="ident" id="1418759">mysg</span><span class="op" id="1418763">.</span><span class="ident" id="1418764">releasetime</span><span class="op" id="1418775">)</span><span class="op" id="1418776">-</span><span class="ident" id="1418777">t0</span><span class="op" id="1418779">,</span>&nbsp;<span class="num" id="1418781">2</span><span class="op" id="1418782">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418790">releaseSudog</span><span class="op" id="1418802">(</span><span class="ident" id="1418803">mysg</span><span class="op" id="1418807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418811">return</span>&nbsp;<span class="builtintype" id="1418818">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418828">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1418853">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418895">var</span>&nbsp;<span class="ident" id="1418899">t1</span>&nbsp;<span class="ident" id="1418902">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418909">for</span>&nbsp;<span class="ident" id="1418913">c</span><span class="op" id="1418914">.</span><span class="ident" id="1418915">qcount</span>&nbsp;<span class="op" id="1418922">&gt;=</span>&nbsp;<span class="ident" id="1418925">c</span><span class="op" id="1418926">.</span><span class="ident" id="1418927">dataqsiz</span>&nbsp;<span class="op" id="1418936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418940">if</span>&nbsp;<span class="op" id="1418943">!</span><span class="ident" id="1418944">block</span>&nbsp;<span class="op" id="1418950">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418955">unlock</span><span class="op" id="1418961">(</span><span class="op" id="1418962">&amp;</span><span class="ident" id="1418963">c</span><span class="op" id="1418964">.</span><span class="ident" id="1418965">lock</span><span class="op" id="1418969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1418974">return</span>&nbsp;<span class="builtintype" id="1418981">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1418989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1418993">gp</span>&nbsp;<span class="op" id="1418996">:=</span>&nbsp;<span class="ident" id="1418999">getg</span><span class="op" id="1419003">(</span><span class="op" id="1419004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419008">mysg</span>&nbsp;<span class="op" id="1419013">:=</span>&nbsp;<span class="ident" id="1419016">acquireSudog</span><span class="op" id="1419028">(</span><span class="op" id="1419029">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419033">mysg</span><span class="op" id="1419037">.</span><span class="ident" id="1419038">releasetime</span>&nbsp;<span class="op" id="1419050">=</span>&nbsp;<span class="num" id="1419052">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419056">if</span>&nbsp;<span class="ident" id="1419059">t0</span>&nbsp;<span class="op" id="1419062">!=</span>&nbsp;<span class="num" id="1419065">0</span>&nbsp;<span class="op" id="1419067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419072">mysg</span><span class="op" id="1419076">.</span><span class="ident" id="1419077">releasetime</span>&nbsp;<span class="op" id="1419089">=</span>&nbsp;<span class="op" id="1419091">-</span><span class="num" id="1419092">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419100">mysg</span><span class="op" id="1419104">.</span><span class="ident" id="1419105">g</span>&nbsp;<span class="op" id="1419107">=</span>&nbsp;<span class="ident" id="1419109">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419114">mysg</span><span class="op" id="1419118">.</span><span class="ident" id="1419119">elem</span>&nbsp;<span class="op" id="1419124">=</span>&nbsp;<span class="ident" id="1419126">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419132">mysg</span><span class="op" id="1419136">.</span><span class="ident" id="1419137">selectdone</span>&nbsp;<span class="op" id="1419148">=</span>&nbsp;<span class="ident" id="1419150">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419156">c</span><span class="op" id="1419157">.</span><span class="ident" id="1419158">sendq</span><span class="op" id="1419163">.</span><span class="ident" id="1419164">enqueue</span><span class="op" id="1419171">(</span><span class="ident" id="1419172">mysg</span><span class="op" id="1419176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419180">goparkunlock</span><span class="op" id="1419192">(</span><span class="op" id="1419193">&amp;</span><span class="ident" id="1419194">c</span><span class="op" id="1419195">.</span><span class="ident" id="1419196">lock</span><span class="op" id="1419200">,</span>&nbsp;<span class="string" id="1419202">&#34;chan&nbsp;send&#34;</span><span class="op" id="1419213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1419218">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419254">if</span>&nbsp;<span class="ident" id="1419257">mysg</span><span class="op" id="1419261">.</span><span class="ident" id="1419262">releasetime</span>&nbsp;<span class="op" id="1419274">&gt;</span>&nbsp;<span class="num" id="1419276">0</span>&nbsp;<span class="op" id="1419278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419283">t1</span>&nbsp;<span class="op" id="1419286">=</span>&nbsp;<span class="ident" id="1419288">mysg</span><span class="op" id="1419292">.</span><span class="ident" id="1419293">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419311">releaseSudog</span><span class="op" id="1419323">(</span><span class="ident" id="1419324">mysg</span><span class="op" id="1419328">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419332">lock</span><span class="op" id="1419336">(</span><span class="op" id="1419337">&amp;</span><span class="ident" id="1419338">c</span><span class="op" id="1419339">.</span><span class="ident" id="1419340">lock</span><span class="op" id="1419344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419348">if</span>&nbsp;<span class="ident" id="1419351">c</span><span class="op" id="1419352">.</span><span class="ident" id="1419353">closed</span>&nbsp;<span class="op" id="1419360">!=</span>&nbsp;<span class="num" id="1419363">0</span>&nbsp;<span class="op" id="1419365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419370">unlock</span><span class="op" id="1419376">(</span><span class="op" id="1419377">&amp;</span><span class="ident" id="1419378">c</span><span class="op" id="1419379">.</span><span class="ident" id="1419380">lock</span><span class="op" id="1419384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1419389">panic</span><span class="op" id="1419394">(</span><span class="string" id="1419395">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1419419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419423">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1419430">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419473">if</span>&nbsp;<span class="ident" id="1419476">raceenabled</span>&nbsp;<span class="op" id="1419488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419492">raceacquire</span><span class="op" id="1419503">(</span><span class="ident" id="1419504">chanbuf</span><span class="op" id="1419511">(</span><span class="ident" id="1419512">c</span><span class="op" id="1419513">,</span>&nbsp;<span class="ident" id="1419515">c</span><span class="op" id="1419516">.</span><span class="ident" id="1419517">sendx</span><span class="op" id="1419522">)</span><span class="op" id="1419523">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419527">racerelease</span><span class="op" id="1419538">(</span><span class="ident" id="1419539">chanbuf</span><span class="op" id="1419546">(</span><span class="ident" id="1419547">c</span><span class="op" id="1419548">,</span>&nbsp;<span class="ident" id="1419550">c</span><span class="op" id="1419551">.</span><span class="ident" id="1419552">sendx</span><span class="op" id="1419557">)</span><span class="op" id="1419558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419564">memmove</span><span class="op" id="1419571">(</span><span class="ident" id="1419572">chanbuf</span><span class="op" id="1419579">(</span><span class="ident" id="1419580">c</span><span class="op" id="1419581">,</span>&nbsp;<span class="ident" id="1419583">c</span><span class="op" id="1419584">.</span><span class="ident" id="1419585">sendx</span><span class="op" id="1419590">)</span><span class="op" id="1419591">,</span>&nbsp;<span class="ident" id="1419593">ep</span><span class="op" id="1419595">,</span>&nbsp;<span class="builtintype" id="1419597">uintptr</span><span class="op" id="1419604">(</span><span class="ident" id="1419605">c</span><span class="op" id="1419606">.</span><span class="ident" id="1419607">elemsize</span><span class="op" id="1419615">)</span><span class="op" id="1419616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419619">c</span><span class="op" id="1419620">.</span><span class="ident" id="1419621">sendx</span><span class="op" id="1419626">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419630">if</span>&nbsp;<span class="ident" id="1419633">c</span><span class="op" id="1419634">.</span><span class="ident" id="1419635">sendx</span>&nbsp;<span class="op" id="1419641">==</span>&nbsp;<span class="ident" id="1419644">c</span><span class="op" id="1419645">.</span><span class="ident" id="1419646">dataqsiz</span>&nbsp;<span class="op" id="1419655">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419659">c</span><span class="op" id="1419660">.</span><span class="ident" id="1419661">sendx</span>&nbsp;<span class="op" id="1419667">=</span>&nbsp;<span class="num" id="1419669">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419675">c</span><span class="op" id="1419676">.</span><span class="ident" id="1419677">qcount</span><span class="op" id="1419683">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1419688">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419719">sg</span>&nbsp;<span class="op" id="1419722">:=</span>&nbsp;<span class="ident" id="1419725">c</span><span class="op" id="1419726">.</span><span class="ident" id="1419727">recvq</span><span class="op" id="1419732">.</span><span class="ident" id="1419733">dequeue</span><span class="op" id="1419740">(</span><span class="op" id="1419741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419744">if</span>&nbsp;<span class="ident" id="1419747">sg</span>&nbsp;<span class="op" id="1419750">!=</span>&nbsp;<span class="ident" id="1419753">nil</span>&nbsp;<span class="op" id="1419757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419761">recvg</span>&nbsp;<span class="op" id="1419767">:=</span>&nbsp;<span class="ident" id="1419770">sg</span><span class="op" id="1419772">.</span><span class="ident" id="1419773">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419777">unlock</span><span class="op" id="1419783">(</span><span class="op" id="1419784">&amp;</span><span class="ident" id="1419785">c</span><span class="op" id="1419786">.</span><span class="ident" id="1419787">lock</span><span class="op" id="1419791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419795">if</span>&nbsp;<span class="ident" id="1419798">sg</span><span class="op" id="1419800">.</span><span class="ident" id="1419801">releasetime</span>&nbsp;<span class="op" id="1419813">!=</span>&nbsp;<span class="num" id="1419816">0</span>&nbsp;<span class="op" id="1419818">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419823">sg</span><span class="op" id="1419825">.</span><span class="ident" id="1419826">releasetime</span>&nbsp;<span class="op" id="1419838">=</span>&nbsp;<span class="ident" id="1419840">cputicks</span><span class="op" id="1419848">(</span><span class="op" id="1419849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419857">goready</span><span class="op" id="1419864">(</span><span class="ident" id="1419865">recvg</span><span class="op" id="1419870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419873">}</span>&nbsp;<span class="keyword" id="1419875">else</span>&nbsp;<span class="op" id="1419880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419884">unlock</span><span class="op" id="1419890">(</span><span class="op" id="1419891">&amp;</span><span class="ident" id="1419892">c</span><span class="op" id="1419893">.</span><span class="ident" id="1419894">lock</span><span class="op" id="1419898">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419904">if</span>&nbsp;<span class="ident" id="1419907">t1</span>&nbsp;<span class="op" id="1419910">&gt;</span>&nbsp;<span class="num" id="1419912">0</span>&nbsp;<span class="op" id="1419914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419918">blockevent</span><span class="op" id="1419928">(</span><span class="ident" id="1419929">t1</span><span class="op" id="1419931">-</span><span class="ident" id="1419932">t0</span><span class="op" id="1419934">,</span>&nbsp;<span class="num" id="1419936">2</span><span class="op" id="1419937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1419940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419943">return</span>&nbsp;<span class="builtintype" id="1419950">true</span><br>
<span class="lineno">255</span><span class="op" id="1419955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1419958">func</span>&nbsp;<span class="ident" id="1419963">closechan</span><span class="op" id="1419972">(</span><span class="ident" id="1419973">c</span>&nbsp;<span class="op" id="1419975">*</span><span class="ident" id="1419976">hchan</span><span class="op" id="1419981">)</span>&nbsp;<span class="op" id="1419983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1419986">if</span>&nbsp;<span class="ident" id="1419989">c</span>&nbsp;<span class="op" id="1419991">==</span>&nbsp;<span class="ident" id="1419994">nil</span>&nbsp;<span class="op" id="1419998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1420002">panic</span><span class="op" id="1420007">(</span><span class="string" id="1420008">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1420030">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420037">lock</span><span class="op" id="1420041">(</span><span class="op" id="1420042">&amp;</span><span class="ident" id="1420043">c</span><span class="op" id="1420044">.</span><span class="ident" id="1420045">lock</span><span class="op" id="1420049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420052">if</span>&nbsp;<span class="ident" id="1420055">c</span><span class="op" id="1420056">.</span><span class="ident" id="1420057">closed</span>&nbsp;<span class="op" id="1420064">!=</span>&nbsp;<span class="num" id="1420067">0</span>&nbsp;<span class="op" id="1420069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420073">unlock</span><span class="op" id="1420079">(</span><span class="op" id="1420080">&amp;</span><span class="ident" id="1420081">c</span><span class="op" id="1420082">.</span><span class="ident" id="1420083">lock</span><span class="op" id="1420087">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1420091">panic</span><span class="op" id="1420096">(</span><span class="string" id="1420097">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1420122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420129">if</span>&nbsp;<span class="ident" id="1420132">raceenabled</span>&nbsp;<span class="op" id="1420144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420148">callerpc</span>&nbsp;<span class="op" id="1420157">:=</span>&nbsp;<span class="ident" id="1420160">getcallerpc</span><span class="op" id="1420171">(</span><span class="ident" id="1420172">unsafe</span><span class="op" id="1420178">.</span><span class="ident" id="1420179">Pointer</span><span class="op" id="1420186">(</span><span class="op" id="1420187">&amp;</span><span class="ident" id="1420188">c</span><span class="op" id="1420189">)</span><span class="op" id="1420190">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420194">racewritepc</span><span class="op" id="1420205">(</span><span class="ident" id="1420206">unsafe</span><span class="op" id="1420212">.</span><span class="ident" id="1420213">Pointer</span><span class="op" id="1420220">(</span><span class="ident" id="1420221">c</span><span class="op" id="1420222">)</span><span class="op" id="1420223">,</span>&nbsp;<span class="ident" id="1420225">callerpc</span><span class="op" id="1420233">,</span>&nbsp;<span class="ident" id="1420235">funcPC</span><span class="op" id="1420241">(</span><span class="ident" id="1420242">closechan</span><span class="op" id="1420251">)</span><span class="op" id="1420252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420256">racerelease</span><span class="op" id="1420267">(</span><span class="ident" id="1420268">unsafe</span><span class="op" id="1420274">.</span><span class="ident" id="1420275">Pointer</span><span class="op" id="1420282">(</span><span class="ident" id="1420283">c</span><span class="op" id="1420284">)</span><span class="op" id="1420285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420292">c</span><span class="op" id="1420293">.</span><span class="ident" id="1420294">closed</span>&nbsp;<span class="op" id="1420301">=</span>&nbsp;<span class="num" id="1420303">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420307">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420331">for</span>&nbsp;<span class="op" id="1420335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420339">sg</span>&nbsp;<span class="op" id="1420342">:=</span>&nbsp;<span class="ident" id="1420345">c</span><span class="op" id="1420346">.</span><span class="ident" id="1420347">recvq</span><span class="op" id="1420352">.</span><span class="ident" id="1420353">dequeue</span><span class="op" id="1420360">(</span><span class="op" id="1420361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420365">if</span>&nbsp;<span class="ident" id="1420368">sg</span>&nbsp;<span class="op" id="1420371">==</span>&nbsp;<span class="ident" id="1420374">nil</span>&nbsp;<span class="op" id="1420378">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420383">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420395">gp</span>&nbsp;<span class="op" id="1420398">:=</span>&nbsp;<span class="ident" id="1420401">sg</span><span class="op" id="1420403">.</span><span class="ident" id="1420404">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420408">sg</span><span class="op" id="1420410">.</span><span class="ident" id="1420411">elem</span>&nbsp;<span class="op" id="1420416">=</span>&nbsp;<span class="ident" id="1420418">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420424">gp</span><span class="op" id="1420426">.</span><span class="ident" id="1420427">param</span>&nbsp;<span class="op" id="1420433">=</span>&nbsp;<span class="ident" id="1420435">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420441">if</span>&nbsp;<span class="ident" id="1420444">sg</span><span class="op" id="1420446">.</span><span class="ident" id="1420447">releasetime</span>&nbsp;<span class="op" id="1420459">!=</span>&nbsp;<span class="num" id="1420462">0</span>&nbsp;<span class="op" id="1420464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420469">sg</span><span class="op" id="1420471">.</span><span class="ident" id="1420472">releasetime</span>&nbsp;<span class="op" id="1420484">=</span>&nbsp;<span class="ident" id="1420486">cputicks</span><span class="op" id="1420494">(</span><span class="op" id="1420495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420503">goready</span><span class="op" id="1420510">(</span><span class="ident" id="1420511">gp</span><span class="op" id="1420513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420516">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420520">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420544">for</span>&nbsp;<span class="op" id="1420548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420552">sg</span>&nbsp;<span class="op" id="1420555">:=</span>&nbsp;<span class="ident" id="1420558">c</span><span class="op" id="1420559">.</span><span class="ident" id="1420560">sendq</span><span class="op" id="1420565">.</span><span class="ident" id="1420566">dequeue</span><span class="op" id="1420573">(</span><span class="op" id="1420574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420578">if</span>&nbsp;<span class="ident" id="1420581">sg</span>&nbsp;<span class="op" id="1420584">==</span>&nbsp;<span class="ident" id="1420587">nil</span>&nbsp;<span class="op" id="1420591">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420596">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420608">gp</span>&nbsp;<span class="op" id="1420611">:=</span>&nbsp;<span class="ident" id="1420614">sg</span><span class="op" id="1420616">.</span><span class="ident" id="1420617">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420621">sg</span><span class="op" id="1420623">.</span><span class="ident" id="1420624">elem</span>&nbsp;<span class="op" id="1420629">=</span>&nbsp;<span class="ident" id="1420631">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420637">gp</span><span class="op" id="1420639">.</span><span class="ident" id="1420640">param</span>&nbsp;<span class="op" id="1420646">=</span>&nbsp;<span class="ident" id="1420648">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1420654">if</span>&nbsp;<span class="ident" id="1420657">sg</span><span class="op" id="1420659">.</span><span class="ident" id="1420660">releasetime</span>&nbsp;<span class="op" id="1420672">!=</span>&nbsp;<span class="num" id="1420675">0</span>&nbsp;<span class="op" id="1420677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420682">sg</span><span class="op" id="1420684">.</span><span class="ident" id="1420685">releasetime</span>&nbsp;<span class="op" id="1420697">=</span>&nbsp;<span class="ident" id="1420699">cputicks</span><span class="op" id="1420707">(</span><span class="op" id="1420708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420716">goready</span><span class="op" id="1420723">(</span><span class="ident" id="1420724">gp</span><span class="op" id="1420726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1420729">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420732">unlock</span><span class="op" id="1420738">(</span><span class="op" id="1420739">&amp;</span><span class="ident" id="1420740">c</span><span class="op" id="1420741">.</span><span class="ident" id="1420742">lock</span><span class="op" id="1420746">)</span><br>
<span class="lineno"></span><span class="op" id="1420748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1420751">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1420795">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1420808">func</span>&nbsp;<span class="ident" id="1420813">chanrecv1</span><span class="op" id="1420822">(</span><span class="ident" id="1420823">t</span>&nbsp;<span class="op" id="1420825">*</span><span class="ident" id="1420826">chantype</span><span class="op" id="1420834">,</span>&nbsp;<span class="ident" id="1420836">c</span>&nbsp;<span class="op" id="1420838">*</span><span class="ident" id="1420839">hchan</span><span class="op" id="1420844">,</span>&nbsp;<span class="ident" id="1420846">elem</span>&nbsp;<span class="ident" id="1420851">unsafe</span><span class="op" id="1420857">.</span><span class="ident" id="1420858">Pointer</span><span class="op" id="1420865">)</span>&nbsp;<span class="op" id="1420867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420870">chanrecv</span><span class="op" id="1420878">(</span><span class="ident" id="1420879">t</span><span class="op" id="1420880">,</span>&nbsp;<span class="ident" id="1420882">c</span><span class="op" id="1420883">,</span>&nbsp;<span class="ident" id="1420885">elem</span><span class="op" id="1420889">,</span>&nbsp;<span class="builtintype" id="1420891">true</span><span class="op" id="1420895">)</span><br>
<span class="lineno"></span><span class="op" id="1420897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1420900">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1420913">func</span>&nbsp;<span class="ident" id="1420918">chanrecv2</span><span class="op" id="1420927">(</span><span class="ident" id="1420928">t</span>&nbsp;<span class="op" id="1420930">*</span><span class="ident" id="1420931">chantype</span><span class="op" id="1420939">,</span>&nbsp;<span class="ident" id="1420941">c</span>&nbsp;<span class="op" id="1420943">*</span><span class="ident" id="1420944">hchan</span><span class="op" id="1420949">,</span>&nbsp;<span class="ident" id="1420951">elem</span>&nbsp;<span class="ident" id="1420956">unsafe</span><span class="op" id="1420962">.</span><span class="ident" id="1420963">Pointer</span><span class="op" id="1420970">)</span>&nbsp;<span class="op" id="1420972">(</span><span class="ident" id="1420973">received</span>&nbsp;<span class="builtintype" id="1420982">bool</span><span class="op" id="1420986">)</span>&nbsp;<span class="op" id="1420988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420991">_</span><span class="op" id="1420992">,</span>&nbsp;<span class="ident" id="1420994">received</span>&nbsp;<span class="op" id="1421003">=</span>&nbsp;<span class="ident" id="1421005">chanrecv</span><span class="op" id="1421013">(</span><span class="ident" id="1421014">t</span><span class="op" id="1421015">,</span>&nbsp;<span class="ident" id="1421017">c</span><span class="op" id="1421018">,</span>&nbsp;<span class="ident" id="1421020">elem</span><span class="op" id="1421024">,</span>&nbsp;<span class="builtintype" id="1421026">true</span><span class="op" id="1421030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1421033">return</span><br>
<span class="lineno"></span><span class="op" id="1421040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1421043">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1421113">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1421171">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1421247">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1421314">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1421383">func</span>&nbsp;<span class="ident" id="1421388">chanrecv</span><span class="op" id="1421396">(</span><span class="ident" id="1421397">t</span>&nbsp;<span class="op" id="1421399">*</span><span class="ident" id="1421400">chantype</span><span class="op" id="1421408">,</span>&nbsp;<span class="ident" id="1421410">c</span>&nbsp;<span class="op" id="1421412">*</span><span class="ident" id="1421413">hchan</span><span class="op" id="1421418">,</span>&nbsp;<span class="ident" id="1421420">ep</span>&nbsp;<span class="ident" id="1421423">unsafe</span><span class="op" id="1421429">.</span><span class="ident" id="1421430">Pointer</span><span class="op" id="1421437">,</span>&nbsp;<span class="ident" id="1421439">block</span>&nbsp;<span class="builtintype" id="1421445">bool</span><span class="op" id="1421449">)</span>&nbsp;<span class="op" id="1421451">(</span><span class="ident" id="1421452">selected</span><span class="op" id="1421460">,</span>&nbsp;<span class="ident" id="1421462">received</span>&nbsp;<span class="builtintype" id="1421471">bool</span><span class="op" id="1421475">)</span>&nbsp;<span class="op" id="1421477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421480">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1421552">if</span>&nbsp;<span class="ident" id="1421555">debugChan</span>&nbsp;<span class="op" id="1421565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1421569">print</span><span class="op" id="1421574">(</span><span class="string" id="1421575">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1421592">,</span>&nbsp;<span class="ident" id="1421594">c</span><span class="op" id="1421595">,</span>&nbsp;<span class="string" id="1421597">&#34;\n&#34;</span><span class="op" id="1421601">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1421604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1421608">if</span>&nbsp;<span class="ident" id="1421611">c</span>&nbsp;<span class="op" id="1421613">==</span>&nbsp;<span class="ident" id="1421616">nil</span>&nbsp;<span class="op" id="1421620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1421624">if</span>&nbsp;<span class="op" id="1421627">!</span><span class="ident" id="1421628">block</span>&nbsp;<span class="op" id="1421634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1421639">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1421648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1421652">gopark</span><span class="op" id="1421658">(</span><span class="ident" id="1421659">nil</span><span class="op" id="1421662">,</span>&nbsp;<span class="ident" id="1421664">nil</span><span class="op" id="1421667">,</span>&nbsp;<span class="string" id="1421669">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1421694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1421698">gothrow</span><span class="op" id="1421705">(</span><span class="string" id="1421706">&#34;unreachable&#34;</span><span class="op" id="1421719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1421722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421726">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421809">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421813">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421898">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421980">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422040">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422119">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422197">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422275">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422323">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422327">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422411">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422460">if</span>&nbsp;<span class="op" id="1422463">!</span><span class="ident" id="1422464">block</span>&nbsp;<span class="op" id="1422470">&amp;&amp;</span>&nbsp;<span class="op" id="1422473">(</span><span class="ident" id="1422474">c</span><span class="op" id="1422475">.</span><span class="ident" id="1422476">dataqsiz</span>&nbsp;<span class="op" id="1422485">==</span>&nbsp;<span class="num" id="1422488">0</span>&nbsp;<span class="op" id="1422490">&amp;&amp;</span>&nbsp;<span class="ident" id="1422493">c</span><span class="op" id="1422494">.</span><span class="ident" id="1422495">sendq</span><span class="op" id="1422500">.</span><span class="ident" id="1422501">first</span>&nbsp;<span class="op" id="1422507">==</span>&nbsp;<span class="ident" id="1422510">nil</span>&nbsp;<span class="op" id="1422514">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422519">c</span><span class="op" id="1422520">.</span><span class="ident" id="1422521">dataqsiz</span>&nbsp;<span class="op" id="1422530">&gt;</span>&nbsp;<span class="num" id="1422532">0</span>&nbsp;<span class="op" id="1422534">&amp;&amp;</span>&nbsp;<span class="ident" id="1422537">atomicloaduint</span><span class="op" id="1422551">(</span><span class="op" id="1422552">&amp;</span><span class="ident" id="1422553">c</span><span class="op" id="1422554">.</span><span class="ident" id="1422555">qcount</span><span class="op" id="1422561">)</span>&nbsp;<span class="op" id="1422563">==</span>&nbsp;<span class="num" id="1422566">0</span><span class="op" id="1422567">)</span>&nbsp;<span class="op" id="1422569">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422574">atomicload</span><span class="op" id="1422584">(</span><span class="op" id="1422585">&amp;</span><span class="ident" id="1422586">c</span><span class="op" id="1422587">.</span><span class="ident" id="1422588">closed</span><span class="op" id="1422594">)</span>&nbsp;<span class="op" id="1422596">==</span>&nbsp;<span class="num" id="1422599">0</span>&nbsp;<span class="op" id="1422601">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422605">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1422613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422617">var</span>&nbsp;<span class="ident" id="1422621">t0</span>&nbsp;<span class="ident" id="1422624">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422631">if</span>&nbsp;<span class="ident" id="1422634">blockprofilerate</span>&nbsp;<span class="op" id="1422651">&gt;</span>&nbsp;<span class="num" id="1422653">0</span>&nbsp;<span class="op" id="1422655">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422659">t0</span>&nbsp;<span class="op" id="1422662">=</span>&nbsp;<span class="ident" id="1422664">cputicks</span><span class="op" id="1422672">(</span><span class="op" id="1422673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1422676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422680">lock</span><span class="op" id="1422684">(</span><span class="op" id="1422685">&amp;</span><span class="ident" id="1422686">c</span><span class="op" id="1422687">.</span><span class="ident" id="1422688">lock</span><span class="op" id="1422692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422695">if</span>&nbsp;<span class="ident" id="1422698">c</span><span class="op" id="1422699">.</span><span class="ident" id="1422700">dataqsiz</span>&nbsp;<span class="op" id="1422709">==</span>&nbsp;<span class="num" id="1422712">0</span>&nbsp;<span class="op" id="1422714">{</span>&nbsp;<span class="comment" id="1422716">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422741">if</span>&nbsp;<span class="ident" id="1422744">c</span><span class="op" id="1422745">.</span><span class="ident" id="1422746">closed</span>&nbsp;<span class="op" id="1422753">!=</span>&nbsp;<span class="num" id="1422756">0</span>&nbsp;<span class="op" id="1422758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422763">return</span>&nbsp;<span class="ident" id="1422770">recvclosed</span><span class="op" id="1422780">(</span><span class="ident" id="1422781">c</span><span class="op" id="1422782">,</span>&nbsp;<span class="ident" id="1422784">ep</span><span class="op" id="1422786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1422790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422795">sg</span>&nbsp;<span class="op" id="1422798">:=</span>&nbsp;<span class="ident" id="1422801">c</span><span class="op" id="1422802">.</span><span class="ident" id="1422803">sendq</span><span class="op" id="1422808">.</span><span class="ident" id="1422809">dequeue</span><span class="op" id="1422816">(</span><span class="op" id="1422817">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422821">if</span>&nbsp;<span class="ident" id="1422824">sg</span>&nbsp;<span class="op" id="1422827">!=</span>&nbsp;<span class="ident" id="1422830">nil</span>&nbsp;<span class="op" id="1422834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422839">if</span>&nbsp;<span class="ident" id="1422842">raceenabled</span>&nbsp;<span class="op" id="1422854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422860">racesync</span><span class="op" id="1422868">(</span><span class="ident" id="1422869">c</span><span class="op" id="1422870">,</span>&nbsp;<span class="ident" id="1422872">sg</span><span class="op" id="1422874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1422879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422884">unlock</span><span class="op" id="1422890">(</span><span class="op" id="1422891">&amp;</span><span class="ident" id="1422892">c</span><span class="op" id="1422893">.</span><span class="ident" id="1422894">lock</span><span class="op" id="1422898">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1422904">if</span>&nbsp;<span class="ident" id="1422907">ep</span>&nbsp;<span class="op" id="1422910">!=</span>&nbsp;<span class="ident" id="1422913">nil</span>&nbsp;<span class="op" id="1422917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422923">memmove</span><span class="op" id="1422930">(</span><span class="ident" id="1422931">ep</span><span class="op" id="1422933">,</span>&nbsp;<span class="ident" id="1422935">sg</span><span class="op" id="1422937">.</span><span class="ident" id="1422938">elem</span><span class="op" id="1422942">,</span>&nbsp;<span class="builtintype" id="1422944">uintptr</span><span class="op" id="1422951">(</span><span class="ident" id="1422952">c</span><span class="op" id="1422953">.</span><span class="ident" id="1422954">elemsize</span><span class="op" id="1422962">)</span><span class="op" id="1422963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1422968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422973">sg</span><span class="op" id="1422975">.</span><span class="ident" id="1422976">elem</span>&nbsp;<span class="op" id="1422981">=</span>&nbsp;<span class="ident" id="1422983">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422990">gp</span>&nbsp;<span class="op" id="1422993">:=</span>&nbsp;<span class="ident" id="1422996">sg</span><span class="op" id="1422998">.</span><span class="ident" id="1422999">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423004">gp</span><span class="op" id="1423006">.</span><span class="ident" id="1423007">param</span>&nbsp;<span class="op" id="1423013">=</span>&nbsp;<span class="ident" id="1423015">unsafe</span><span class="op" id="1423021">.</span><span class="ident" id="1423022">Pointer</span><span class="op" id="1423029">(</span><span class="ident" id="1423030">sg</span><span class="op" id="1423032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423037">if</span>&nbsp;<span class="ident" id="1423040">sg</span><span class="op" id="1423042">.</span><span class="ident" id="1423043">releasetime</span>&nbsp;<span class="op" id="1423055">!=</span>&nbsp;<span class="num" id="1423058">0</span>&nbsp;<span class="op" id="1423060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423066">sg</span><span class="op" id="1423068">.</span><span class="ident" id="1423069">releasetime</span>&nbsp;<span class="op" id="1423081">=</span>&nbsp;<span class="ident" id="1423083">cputicks</span><span class="op" id="1423091">(</span><span class="op" id="1423092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423097">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423102">goready</span><span class="op" id="1423109">(</span><span class="ident" id="1423110">gp</span><span class="op" id="1423112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423117">selected</span>&nbsp;<span class="op" id="1423126">=</span>&nbsp;<span class="builtintype" id="1423128">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423136">received</span>&nbsp;<span class="op" id="1423145">=</span>&nbsp;<span class="builtintype" id="1423147">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423155">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423164">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423169">if</span>&nbsp;<span class="op" id="1423172">!</span><span class="ident" id="1423173">block</span>&nbsp;<span class="op" id="1423179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423184">unlock</span><span class="op" id="1423190">(</span><span class="op" id="1423191">&amp;</span><span class="ident" id="1423192">c</span><span class="op" id="1423193">.</span><span class="ident" id="1423194">lock</span><span class="op" id="1423198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423203">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423212">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1423217">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423266">gp</span>&nbsp;<span class="op" id="1423269">:=</span>&nbsp;<span class="ident" id="1423272">getg</span><span class="op" id="1423276">(</span><span class="op" id="1423277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423281">mysg</span>&nbsp;<span class="op" id="1423286">:=</span>&nbsp;<span class="ident" id="1423289">acquireSudog</span><span class="op" id="1423301">(</span><span class="op" id="1423302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423306">mysg</span><span class="op" id="1423310">.</span><span class="ident" id="1423311">releasetime</span>&nbsp;<span class="op" id="1423323">=</span>&nbsp;<span class="num" id="1423325">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423329">if</span>&nbsp;<span class="ident" id="1423332">t0</span>&nbsp;<span class="op" id="1423335">!=</span>&nbsp;<span class="num" id="1423338">0</span>&nbsp;<span class="op" id="1423340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423345">mysg</span><span class="op" id="1423349">.</span><span class="ident" id="1423350">releasetime</span>&nbsp;<span class="op" id="1423362">=</span>&nbsp;<span class="op" id="1423364">-</span><span class="num" id="1423365">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423373">mysg</span><span class="op" id="1423377">.</span><span class="ident" id="1423378">elem</span>&nbsp;<span class="op" id="1423383">=</span>&nbsp;<span class="ident" id="1423385">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423390">mysg</span><span class="op" id="1423394">.</span><span class="ident" id="1423395">waitlink</span>&nbsp;<span class="op" id="1423404">=</span>&nbsp;<span class="ident" id="1423406">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423412">gp</span><span class="op" id="1423414">.</span><span class="ident" id="1423415">waiting</span>&nbsp;<span class="op" id="1423423">=</span>&nbsp;<span class="ident" id="1423425">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423432">mysg</span><span class="op" id="1423436">.</span><span class="ident" id="1423437">g</span>&nbsp;<span class="op" id="1423439">=</span>&nbsp;<span class="ident" id="1423441">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423446">mysg</span><span class="op" id="1423450">.</span><span class="ident" id="1423451">selectdone</span>&nbsp;<span class="op" id="1423462">=</span>&nbsp;<span class="ident" id="1423464">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423470">gp</span><span class="op" id="1423472">.</span><span class="ident" id="1423473">param</span>&nbsp;<span class="op" id="1423479">=</span>&nbsp;<span class="ident" id="1423481">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423487">c</span><span class="op" id="1423488">.</span><span class="ident" id="1423489">recvq</span><span class="op" id="1423494">.</span><span class="ident" id="1423495">enqueue</span><span class="op" id="1423502">(</span><span class="ident" id="1423503">mysg</span><span class="op" id="1423507">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423511">goparkunlock</span><span class="op" id="1423523">(</span><span class="op" id="1423524">&amp;</span><span class="ident" id="1423525">c</span><span class="op" id="1423526">.</span><span class="ident" id="1423527">lock</span><span class="op" id="1423531">,</span>&nbsp;<span class="string" id="1423533">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1423547">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1423552">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423576">if</span>&nbsp;<span class="ident" id="1423579">mysg</span>&nbsp;<span class="op" id="1423584">!=</span>&nbsp;<span class="ident" id="1423587">gp</span><span class="op" id="1423589">.</span><span class="ident" id="1423590">waiting</span>&nbsp;<span class="op" id="1423598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423603">gothrow</span><span class="op" id="1423610">(</span><span class="string" id="1423611">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1423641">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423649">gp</span><span class="op" id="1423651">.</span><span class="ident" id="1423652">waiting</span>&nbsp;<span class="op" id="1423660">=</span>&nbsp;<span class="ident" id="1423662">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423668">if</span>&nbsp;<span class="ident" id="1423671">mysg</span><span class="op" id="1423675">.</span><span class="ident" id="1423676">releasetime</span>&nbsp;<span class="op" id="1423688">&gt;</span>&nbsp;<span class="num" id="1423690">0</span>&nbsp;<span class="op" id="1423692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423697">blockevent</span><span class="op" id="1423707">(</span><span class="ident" id="1423708">mysg</span><span class="op" id="1423712">.</span><span class="ident" id="1423713">releasetime</span><span class="op" id="1423724">-</span><span class="ident" id="1423725">t0</span><span class="op" id="1423727">,</span>&nbsp;<span class="num" id="1423729">2</span><span class="op" id="1423730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423734">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423738">haveData</span>&nbsp;<span class="op" id="1423747">:=</span>&nbsp;<span class="ident" id="1423750">gp</span><span class="op" id="1423752">.</span><span class="ident" id="1423753">param</span>&nbsp;<span class="op" id="1423759">!=</span>&nbsp;<span class="ident" id="1423762">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423768">gp</span><span class="op" id="1423770">.</span><span class="ident" id="1423771">param</span>&nbsp;<span class="op" id="1423777">=</span>&nbsp;<span class="ident" id="1423779">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423785">releaseSudog</span><span class="op" id="1423797">(</span><span class="ident" id="1423798">mysg</span><span class="op" id="1423802">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423807">if</span>&nbsp;<span class="ident" id="1423810">haveData</span>&nbsp;<span class="op" id="1423819">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1423824">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423882">selected</span>&nbsp;<span class="op" id="1423891">=</span>&nbsp;<span class="builtintype" id="1423893">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423901">received</span>&nbsp;<span class="op" id="1423910">=</span>&nbsp;<span class="builtintype" id="1423912">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423920">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423929">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423934">lock</span><span class="op" id="1423938">(</span><span class="op" id="1423939">&amp;</span><span class="ident" id="1423940">c</span><span class="op" id="1423941">.</span><span class="ident" id="1423942">lock</span><span class="op" id="1423946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423950">if</span>&nbsp;<span class="ident" id="1423953">c</span><span class="op" id="1423954">.</span><span class="ident" id="1423955">closed</span>&nbsp;<span class="op" id="1423962">==</span>&nbsp;<span class="num" id="1423965">0</span>&nbsp;<span class="op" id="1423967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423972">gothrow</span><span class="op" id="1423979">(</span><span class="string" id="1423980">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1424007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424011">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424015">return</span>&nbsp;<span class="ident" id="1424022">recvclosed</span><span class="op" id="1424032">(</span><span class="ident" id="1424033">c</span><span class="op" id="1424034">,</span>&nbsp;<span class="ident" id="1424036">ep</span><span class="op" id="1424038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1424045">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1424070">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424103">var</span>&nbsp;<span class="ident" id="1424107">t1</span>&nbsp;<span class="ident" id="1424110">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424117">for</span>&nbsp;<span class="ident" id="1424121">c</span><span class="op" id="1424122">.</span><span class="ident" id="1424123">qcount</span>&nbsp;<span class="op" id="1424130">&lt;=</span>&nbsp;<span class="num" id="1424133">0</span>&nbsp;<span class="op" id="1424135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424139">if</span>&nbsp;<span class="ident" id="1424142">c</span><span class="op" id="1424143">.</span><span class="ident" id="1424144">closed</span>&nbsp;<span class="op" id="1424151">!=</span>&nbsp;<span class="num" id="1424154">0</span>&nbsp;<span class="op" id="1424156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424161">selected</span><span class="op" id="1424169">,</span>&nbsp;<span class="ident" id="1424171">received</span>&nbsp;<span class="op" id="1424180">=</span>&nbsp;<span class="ident" id="1424182">recvclosed</span><span class="op" id="1424192">(</span><span class="ident" id="1424193">c</span><span class="op" id="1424194">,</span>&nbsp;<span class="ident" id="1424196">ep</span><span class="op" id="1424198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424203">if</span>&nbsp;<span class="ident" id="1424206">t1</span>&nbsp;<span class="op" id="1424209">&gt;</span>&nbsp;<span class="num" id="1424211">0</span>&nbsp;<span class="op" id="1424213">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424219">blockevent</span><span class="op" id="1424229">(</span><span class="ident" id="1424230">t1</span><span class="op" id="1424232">-</span><span class="ident" id="1424233">t0</span><span class="op" id="1424235">,</span>&nbsp;<span class="num" id="1424237">2</span><span class="op" id="1424238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424248">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424262">if</span>&nbsp;<span class="op" id="1424265">!</span><span class="ident" id="1424266">block</span>&nbsp;<span class="op" id="1424272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424277">unlock</span><span class="op" id="1424283">(</span><span class="op" id="1424284">&amp;</span><span class="ident" id="1424285">c</span><span class="op" id="1424286">.</span><span class="ident" id="1424287">lock</span><span class="op" id="1424291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424296">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1424310">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424351">gp</span>&nbsp;<span class="op" id="1424354">:=</span>&nbsp;<span class="ident" id="1424357">getg</span><span class="op" id="1424361">(</span><span class="op" id="1424362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424366">mysg</span>&nbsp;<span class="op" id="1424371">:=</span>&nbsp;<span class="ident" id="1424374">acquireSudog</span><span class="op" id="1424386">(</span><span class="op" id="1424387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424391">mysg</span><span class="op" id="1424395">.</span><span class="ident" id="1424396">releasetime</span>&nbsp;<span class="op" id="1424408">=</span>&nbsp;<span class="num" id="1424410">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424414">if</span>&nbsp;<span class="ident" id="1424417">t0</span>&nbsp;<span class="op" id="1424420">!=</span>&nbsp;<span class="num" id="1424423">0</span>&nbsp;<span class="op" id="1424425">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424430">mysg</span><span class="op" id="1424434">.</span><span class="ident" id="1424435">releasetime</span>&nbsp;<span class="op" id="1424447">=</span>&nbsp;<span class="op" id="1424449">-</span><span class="num" id="1424450">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424458">mysg</span><span class="op" id="1424462">.</span><span class="ident" id="1424463">elem</span>&nbsp;<span class="op" id="1424468">=</span>&nbsp;<span class="ident" id="1424470">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424476">mysg</span><span class="op" id="1424480">.</span><span class="ident" id="1424481">g</span>&nbsp;<span class="op" id="1424483">=</span>&nbsp;<span class="ident" id="1424485">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424490">mysg</span><span class="op" id="1424494">.</span><span class="ident" id="1424495">selectdone</span>&nbsp;<span class="op" id="1424506">=</span>&nbsp;<span class="ident" id="1424508">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424515">c</span><span class="op" id="1424516">.</span><span class="ident" id="1424517">recvq</span><span class="op" id="1424522">.</span><span class="ident" id="1424523">enqueue</span><span class="op" id="1424530">(</span><span class="ident" id="1424531">mysg</span><span class="op" id="1424535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424539">goparkunlock</span><span class="op" id="1424551">(</span><span class="op" id="1424552">&amp;</span><span class="ident" id="1424553">c</span><span class="op" id="1424554">.</span><span class="ident" id="1424555">lock</span><span class="op" id="1424559">,</span>&nbsp;<span class="string" id="1424561">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1424575">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1424580">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424616">if</span>&nbsp;<span class="ident" id="1424619">mysg</span><span class="op" id="1424623">.</span><span class="ident" id="1424624">releasetime</span>&nbsp;<span class="op" id="1424636">&gt;</span>&nbsp;<span class="num" id="1424638">0</span>&nbsp;<span class="op" id="1424640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424645">t1</span>&nbsp;<span class="op" id="1424648">=</span>&nbsp;<span class="ident" id="1424650">mysg</span><span class="op" id="1424654">.</span><span class="ident" id="1424655">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424673">releaseSudog</span><span class="op" id="1424685">(</span><span class="ident" id="1424686">mysg</span><span class="op" id="1424690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424694">lock</span><span class="op" id="1424698">(</span><span class="op" id="1424699">&amp;</span><span class="ident" id="1424700">c</span><span class="op" id="1424701">.</span><span class="ident" id="1424702">lock</span><span class="op" id="1424706">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424713">if</span>&nbsp;<span class="ident" id="1424716">raceenabled</span>&nbsp;<span class="op" id="1424728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424732">raceacquire</span><span class="op" id="1424743">(</span><span class="ident" id="1424744">chanbuf</span><span class="op" id="1424751">(</span><span class="ident" id="1424752">c</span><span class="op" id="1424753">,</span>&nbsp;<span class="ident" id="1424755">c</span><span class="op" id="1424756">.</span><span class="ident" id="1424757">recvx</span><span class="op" id="1424762">)</span><span class="op" id="1424763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424767">racerelease</span><span class="op" id="1424778">(</span><span class="ident" id="1424779">chanbuf</span><span class="op" id="1424786">(</span><span class="ident" id="1424787">c</span><span class="op" id="1424788">,</span>&nbsp;<span class="ident" id="1424790">c</span><span class="op" id="1424791">.</span><span class="ident" id="1424792">recvx</span><span class="op" id="1424797">)</span><span class="op" id="1424798">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424804">if</span>&nbsp;<span class="ident" id="1424807">ep</span>&nbsp;<span class="op" id="1424810">!=</span>&nbsp;<span class="ident" id="1424813">nil</span>&nbsp;<span class="op" id="1424817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424821">memmove</span><span class="op" id="1424828">(</span><span class="ident" id="1424829">ep</span><span class="op" id="1424831">,</span>&nbsp;<span class="ident" id="1424833">chanbuf</span><span class="op" id="1424840">(</span><span class="ident" id="1424841">c</span><span class="op" id="1424842">,</span>&nbsp;<span class="ident" id="1424844">c</span><span class="op" id="1424845">.</span><span class="ident" id="1424846">recvx</span><span class="op" id="1424851">)</span><span class="op" id="1424852">,</span>&nbsp;<span class="builtintype" id="1424854">uintptr</span><span class="op" id="1424861">(</span><span class="ident" id="1424862">c</span><span class="op" id="1424863">.</span><span class="ident" id="1424864">elemsize</span><span class="op" id="1424872">)</span><span class="op" id="1424873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424879">memclr</span><span class="op" id="1424885">(</span><span class="ident" id="1424886">chanbuf</span><span class="op" id="1424893">(</span><span class="ident" id="1424894">c</span><span class="op" id="1424895">,</span>&nbsp;<span class="ident" id="1424897">c</span><span class="op" id="1424898">.</span><span class="ident" id="1424899">recvx</span><span class="op" id="1424904">)</span><span class="op" id="1424905">,</span>&nbsp;<span class="builtintype" id="1424907">uintptr</span><span class="op" id="1424914">(</span><span class="ident" id="1424915">c</span><span class="op" id="1424916">.</span><span class="ident" id="1424917">elemsize</span><span class="op" id="1424925">)</span><span class="op" id="1424926">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424930">c</span><span class="op" id="1424931">.</span><span class="ident" id="1424932">recvx</span><span class="op" id="1424937">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424941">if</span>&nbsp;<span class="ident" id="1424944">c</span><span class="op" id="1424945">.</span><span class="ident" id="1424946">recvx</span>&nbsp;<span class="op" id="1424952">==</span>&nbsp;<span class="ident" id="1424955">c</span><span class="op" id="1424956">.</span><span class="ident" id="1424957">dataqsiz</span>&nbsp;<span class="op" id="1424966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424970">c</span><span class="op" id="1424971">.</span><span class="ident" id="1424972">recvx</span>&nbsp;<span class="op" id="1424978">=</span>&nbsp;<span class="num" id="1424980">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424983">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424986">c</span><span class="op" id="1424987">.</span><span class="ident" id="1424988">qcount</span><span class="op" id="1424994">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1424999">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425041">sg</span>&nbsp;<span class="op" id="1425044">:=</span>&nbsp;<span class="ident" id="1425047">c</span><span class="op" id="1425048">.</span><span class="ident" id="1425049">sendq</span><span class="op" id="1425054">.</span><span class="ident" id="1425055">dequeue</span><span class="op" id="1425062">(</span><span class="op" id="1425063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425066">if</span>&nbsp;<span class="ident" id="1425069">sg</span>&nbsp;<span class="op" id="1425072">!=</span>&nbsp;<span class="ident" id="1425075">nil</span>&nbsp;<span class="op" id="1425079">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425083">gp</span>&nbsp;<span class="op" id="1425086">:=</span>&nbsp;<span class="ident" id="1425089">sg</span><span class="op" id="1425091">.</span><span class="ident" id="1425092">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425096">unlock</span><span class="op" id="1425102">(</span><span class="op" id="1425103">&amp;</span><span class="ident" id="1425104">c</span><span class="op" id="1425105">.</span><span class="ident" id="1425106">lock</span><span class="op" id="1425110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425114">if</span>&nbsp;<span class="ident" id="1425117">sg</span><span class="op" id="1425119">.</span><span class="ident" id="1425120">releasetime</span>&nbsp;<span class="op" id="1425132">!=</span>&nbsp;<span class="num" id="1425135">0</span>&nbsp;<span class="op" id="1425137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425142">sg</span><span class="op" id="1425144">.</span><span class="ident" id="1425145">releasetime</span>&nbsp;<span class="op" id="1425157">=</span>&nbsp;<span class="ident" id="1425159">cputicks</span><span class="op" id="1425167">(</span><span class="op" id="1425168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1425172">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425176">goready</span><span class="op" id="1425183">(</span><span class="ident" id="1425184">gp</span><span class="op" id="1425186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1425189">}</span>&nbsp;<span class="keyword" id="1425191">else</span>&nbsp;<span class="op" id="1425196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425200">unlock</span><span class="op" id="1425206">(</span><span class="op" id="1425207">&amp;</span><span class="ident" id="1425208">c</span><span class="op" id="1425209">.</span><span class="ident" id="1425210">lock</span><span class="op" id="1425214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1425217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425221">if</span>&nbsp;<span class="ident" id="1425224">t1</span>&nbsp;<span class="op" id="1425227">&gt;</span>&nbsp;<span class="num" id="1425229">0</span>&nbsp;<span class="op" id="1425231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425235">blockevent</span><span class="op" id="1425245">(</span><span class="ident" id="1425246">t1</span><span class="op" id="1425248">-</span><span class="ident" id="1425249">t0</span><span class="op" id="1425251">,</span>&nbsp;<span class="num" id="1425253">2</span><span class="op" id="1425254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1425257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425260">selected</span>&nbsp;<span class="op" id="1425269">=</span>&nbsp;<span class="builtintype" id="1425271">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425277">received</span>&nbsp;<span class="op" id="1425286">=</span>&nbsp;<span class="builtintype" id="1425288">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425294">return</span><br>
<span class="lineno"></span><span class="op" id="1425301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1425304">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1425370">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1425420">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1425482">func</span>&nbsp;<span class="ident" id="1425487">recvclosed</span><span class="op" id="1425497">(</span><span class="ident" id="1425498">c</span>&nbsp;<span class="op" id="1425500">*</span><span class="ident" id="1425501">hchan</span><span class="op" id="1425506">,</span>&nbsp;<span class="ident" id="1425508">ep</span>&nbsp;<span class="ident" id="1425511">unsafe</span><span class="op" id="1425517">.</span><span class="ident" id="1425518">Pointer</span><span class="op" id="1425525">)</span>&nbsp;<span class="op" id="1425527">(</span><span class="ident" id="1425528">selected</span><span class="op" id="1425536">,</span>&nbsp;<span class="ident" id="1425538">recevied</span>&nbsp;<span class="builtintype" id="1425547">bool</span><span class="op" id="1425551">)</span>&nbsp;<span class="op" id="1425553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425556">if</span>&nbsp;<span class="ident" id="1425559">raceenabled</span>&nbsp;<span class="op" id="1425571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425575">raceacquire</span><span class="op" id="1425586">(</span><span class="ident" id="1425587">unsafe</span><span class="op" id="1425593">.</span><span class="ident" id="1425594">Pointer</span><span class="op" id="1425601">(</span><span class="ident" id="1425602">c</span><span class="op" id="1425603">)</span><span class="op" id="1425604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1425607">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425610">unlock</span><span class="op" id="1425616">(</span><span class="op" id="1425617">&amp;</span><span class="ident" id="1425618">c</span><span class="op" id="1425619">.</span><span class="ident" id="1425620">lock</span><span class="op" id="1425624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425627">if</span>&nbsp;<span class="ident" id="1425630">ep</span>&nbsp;<span class="op" id="1425633">!=</span>&nbsp;<span class="ident" id="1425636">nil</span>&nbsp;<span class="op" id="1425640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425644">memclr</span><span class="op" id="1425650">(</span><span class="ident" id="1425651">ep</span><span class="op" id="1425653">,</span>&nbsp;<span class="builtintype" id="1425655">uintptr</span><span class="op" id="1425662">(</span><span class="ident" id="1425663">c</span><span class="op" id="1425664">.</span><span class="ident" id="1425665">elemsize</span><span class="op" id="1425673">)</span><span class="op" id="1425674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1425677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425680">return</span>&nbsp;<span class="builtintype" id="1425687">true</span><span class="op" id="1425691">,</span>&nbsp;<span class="builtintype" id="1425693">false</span><br>
<span class="lineno">525</span><span class="op" id="1425699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1425702">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1425725">//</span><br>
<span class="lineno"></span><span class="comment" id="1425728">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1425740">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1425756">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1425768">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1425780">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1425792">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">535</span><span class="comment" id="1425797">//</span><br>
<span class="lineno"></span><span class="comment" id="1425800">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1425806">//</span><br>
<span class="lineno"></span><span class="comment" id="1425809">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1425836">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1425848">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1425860">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1425872">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1425877">//</span><br>
<span class="lineno"></span><span class="keyword" id="1425880">func</span>&nbsp;<span class="ident" id="1425885">selectnbsend</span><span class="op" id="1425897">(</span><span class="ident" id="1425898">t</span>&nbsp;<span class="op" id="1425900">*</span><span class="ident" id="1425901">chantype</span><span class="op" id="1425909">,</span>&nbsp;<span class="ident" id="1425911">c</span>&nbsp;<span class="op" id="1425913">*</span><span class="ident" id="1425914">hchan</span><span class="op" id="1425919">,</span>&nbsp;<span class="ident" id="1425921">elem</span>&nbsp;<span class="ident" id="1425926">unsafe</span><span class="op" id="1425932">.</span><span class="ident" id="1425933">Pointer</span><span class="op" id="1425940">)</span>&nbsp;<span class="op" id="1425942">(</span><span class="ident" id="1425943">selected</span>&nbsp;<span class="builtintype" id="1425952">bool</span><span class="op" id="1425956">)</span>&nbsp;<span class="op" id="1425958">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425961">return</span>&nbsp;<span class="ident" id="1425968">chansend</span><span class="op" id="1425976">(</span><span class="ident" id="1425977">t</span><span class="op" id="1425978">,</span>&nbsp;<span class="ident" id="1425980">c</span><span class="op" id="1425981">,</span>&nbsp;<span class="ident" id="1425983">elem</span><span class="op" id="1425987">,</span>&nbsp;<span class="builtintype" id="1425989">false</span><span class="op" id="1425994">,</span>&nbsp;<span class="ident" id="1425996">getcallerpc</span><span class="op" id="1426007">(</span><span class="ident" id="1426008">unsafe</span><span class="op" id="1426014">.</span><span class="ident" id="1426015">Pointer</span><span class="op" id="1426022">(</span><span class="op" id="1426023">&amp;</span><span class="ident" id="1426024">t</span><span class="op" id="1426025">)</span><span class="op" id="1426026">)</span><span class="op" id="1426027">)</span><br>
<span class="lineno"></span><span class="op" id="1426029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1426032">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1426055">//</span><br>
<span class="lineno">550</span><span class="comment" id="1426058">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1426070">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1426087">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1426099">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1426111">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1426123">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1426128">//</span><br>
<span class="lineno"></span><span class="comment" id="1426131">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1426137">//</span><br>
<span class="lineno"></span><span class="comment" id="1426140">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1426168">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1426180">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1426192">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1426204">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1426209">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1426212">func</span>&nbsp;<span class="ident" id="1426217">selectnbrecv</span><span class="op" id="1426229">(</span><span class="ident" id="1426230">t</span>&nbsp;<span class="op" id="1426232">*</span><span class="ident" id="1426233">chantype</span><span class="op" id="1426241">,</span>&nbsp;<span class="ident" id="1426243">elem</span>&nbsp;<span class="ident" id="1426248">unsafe</span><span class="op" id="1426254">.</span><span class="ident" id="1426255">Pointer</span><span class="op" id="1426262">,</span>&nbsp;<span class="ident" id="1426264">c</span>&nbsp;<span class="op" id="1426266">*</span><span class="ident" id="1426267">hchan</span><span class="op" id="1426272">)</span>&nbsp;<span class="op" id="1426274">(</span><span class="ident" id="1426275">selected</span>&nbsp;<span class="builtintype" id="1426284">bool</span><span class="op" id="1426288">)</span>&nbsp;<span class="op" id="1426290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426293">selected</span><span class="op" id="1426301">,</span>&nbsp;<span class="ident" id="1426303">_</span>&nbsp;<span class="op" id="1426305">=</span>&nbsp;<span class="ident" id="1426307">chanrecv</span><span class="op" id="1426315">(</span><span class="ident" id="1426316">t</span><span class="op" id="1426317">,</span>&nbsp;<span class="ident" id="1426319">c</span><span class="op" id="1426320">,</span>&nbsp;<span class="ident" id="1426322">elem</span><span class="op" id="1426326">,</span>&nbsp;<span class="builtintype" id="1426328">false</span><span class="op" id="1426333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426336">return</span><br>
<span class="lineno"></span><span class="op" id="1426343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1426346">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1426369">//</span><br>
<span class="lineno"></span><span class="comment" id="1426372">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1426384">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1426405">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1426417">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1426429">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1426441">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1426446">//</span><br>
<span class="lineno"></span><span class="comment" id="1426449">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1426455">//</span><br>
<span class="lineno"></span><span class="comment" id="1426458">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1426504">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1426516">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1426528">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1426540">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1426545">//</span><br>
<span class="lineno"></span><span class="keyword" id="1426548">func</span>&nbsp;<span class="ident" id="1426553">selectnbrecv2</span><span class="op" id="1426566">(</span><span class="ident" id="1426567">t</span>&nbsp;<span class="op" id="1426569">*</span><span class="ident" id="1426570">chantype</span><span class="op" id="1426578">,</span>&nbsp;<span class="ident" id="1426580">elem</span>&nbsp;<span class="ident" id="1426585">unsafe</span><span class="op" id="1426591">.</span><span class="ident" id="1426592">Pointer</span><span class="op" id="1426599">,</span>&nbsp;<span class="ident" id="1426601">received</span>&nbsp;<span class="op" id="1426610">*</span><span class="builtintype" id="1426611">bool</span><span class="op" id="1426615">,</span>&nbsp;<span class="ident" id="1426617">c</span>&nbsp;<span class="op" id="1426619">*</span><span class="ident" id="1426620">hchan</span><span class="op" id="1426625">)</span>&nbsp;<span class="op" id="1426627">(</span><span class="ident" id="1426628">selected</span>&nbsp;<span class="builtintype" id="1426637">bool</span><span class="op" id="1426641">)</span>&nbsp;<span class="op" id="1426643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1426646">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426724">selected</span><span class="op" id="1426732">,</span>&nbsp;<span class="op" id="1426734">*</span><span class="ident" id="1426735">received</span>&nbsp;<span class="op" id="1426744">=</span>&nbsp;<span class="ident" id="1426746">chanrecv</span><span class="op" id="1426754">(</span><span class="ident" id="1426755">t</span><span class="op" id="1426756">,</span>&nbsp;<span class="ident" id="1426758">c</span><span class="op" id="1426759">,</span>&nbsp;<span class="ident" id="1426761">elem</span><span class="op" id="1426765">,</span>&nbsp;<span class="builtintype" id="1426767">false</span><span class="op" id="1426772">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426775">return</span><br>
<span class="lineno"></span><span class="op" id="1426782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1426785">func</span>&nbsp;<span class="ident" id="1426790">reflect_chansend</span><span class="op" id="1426806">(</span><span class="ident" id="1426807">t</span>&nbsp;<span class="op" id="1426809">*</span><span class="ident" id="1426810">chantype</span><span class="op" id="1426818">,</span>&nbsp;<span class="ident" id="1426820">c</span>&nbsp;<span class="op" id="1426822">*</span><span class="ident" id="1426823">hchan</span><span class="op" id="1426828">,</span>&nbsp;<span class="ident" id="1426830">elem</span>&nbsp;<span class="ident" id="1426835">unsafe</span><span class="op" id="1426841">.</span><span class="ident" id="1426842">Pointer</span><span class="op" id="1426849">,</span>&nbsp;<span class="ident" id="1426851">nb</span>&nbsp;<span class="builtintype" id="1426854">bool</span><span class="op" id="1426858">)</span>&nbsp;<span class="op" id="1426860">(</span><span class="ident" id="1426861">selected</span>&nbsp;<span class="builtintype" id="1426870">bool</span><span class="op" id="1426874">)</span>&nbsp;<span class="op" id="1426876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426879">return</span>&nbsp;<span class="ident" id="1426886">chansend</span><span class="op" id="1426894">(</span><span class="ident" id="1426895">t</span><span class="op" id="1426896">,</span>&nbsp;<span class="ident" id="1426898">c</span><span class="op" id="1426899">,</span>&nbsp;<span class="ident" id="1426901">elem</span><span class="op" id="1426905">,</span>&nbsp;<span class="op" id="1426907">!</span><span class="ident" id="1426908">nb</span><span class="op" id="1426910">,</span>&nbsp;<span class="ident" id="1426912">getcallerpc</span><span class="op" id="1426923">(</span><span class="ident" id="1426924">unsafe</span><span class="op" id="1426930">.</span><span class="ident" id="1426931">Pointer</span><span class="op" id="1426938">(</span><span class="op" id="1426939">&amp;</span><span class="ident" id="1426940">t</span><span class="op" id="1426941">)</span><span class="op" id="1426942">)</span><span class="op" id="1426943">)</span><br>
<span class="lineno">595</span><span class="op" id="1426945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1426948">func</span>&nbsp;<span class="ident" id="1426953">reflect_chanrecv</span><span class="op" id="1426969">(</span><span class="ident" id="1426970">t</span>&nbsp;<span class="op" id="1426972">*</span><span class="ident" id="1426973">chantype</span><span class="op" id="1426981">,</span>&nbsp;<span class="ident" id="1426983">c</span>&nbsp;<span class="op" id="1426985">*</span><span class="ident" id="1426986">hchan</span><span class="op" id="1426991">,</span>&nbsp;<span class="ident" id="1426993">nb</span>&nbsp;<span class="builtintype" id="1426996">bool</span><span class="op" id="1427000">,</span>&nbsp;<span class="ident" id="1427002">elem</span>&nbsp;<span class="ident" id="1427007">unsafe</span><span class="op" id="1427013">.</span><span class="ident" id="1427014">Pointer</span><span class="op" id="1427021">)</span>&nbsp;<span class="op" id="1427023">(</span><span class="ident" id="1427024">selected</span>&nbsp;<span class="builtintype" id="1427033">bool</span><span class="op" id="1427037">,</span>&nbsp;<span class="ident" id="1427039">received</span>&nbsp;<span class="builtintype" id="1427048">bool</span><span class="op" id="1427052">)</span>&nbsp;<span class="op" id="1427054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427057">return</span>&nbsp;<span class="ident" id="1427064">chanrecv</span><span class="op" id="1427072">(</span><span class="ident" id="1427073">t</span><span class="op" id="1427074">,</span>&nbsp;<span class="ident" id="1427076">c</span><span class="op" id="1427077">,</span>&nbsp;<span class="ident" id="1427079">elem</span><span class="op" id="1427083">,</span>&nbsp;<span class="op" id="1427085">!</span><span class="ident" id="1427086">nb</span><span class="op" id="1427088">)</span><br>
<span class="lineno"></span><span class="op" id="1427090">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1427093">func</span>&nbsp;<span class="ident" id="1427098">reflect_chanlen</span><span class="op" id="1427113">(</span><span class="ident" id="1427114">c</span>&nbsp;<span class="op" id="1427116">*</span><span class="ident" id="1427117">hchan</span><span class="op" id="1427122">)</span>&nbsp;<span class="builtintype" id="1427124">int</span>&nbsp;<span class="op" id="1427128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427131">if</span>&nbsp;<span class="ident" id="1427134">c</span>&nbsp;<span class="op" id="1427136">==</span>&nbsp;<span class="ident" id="1427139">nil</span>&nbsp;<span class="op" id="1427143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427147">return</span>&nbsp;<span class="num" id="1427154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427157">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427160">return</span>&nbsp;<span class="builtintype" id="1427167">int</span><span class="op" id="1427170">(</span><span class="ident" id="1427171">c</span><span class="op" id="1427172">.</span><span class="ident" id="1427173">qcount</span><span class="op" id="1427179">)</span><br>
<span class="lineno"></span><span class="op" id="1427181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1427184">func</span>&nbsp;<span class="ident" id="1427189">reflect_chancap</span><span class="op" id="1427204">(</span><span class="ident" id="1427205">c</span>&nbsp;<span class="op" id="1427207">*</span><span class="ident" id="1427208">hchan</span><span class="op" id="1427213">)</span>&nbsp;<span class="builtintype" id="1427215">int</span>&nbsp;<span class="op" id="1427219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427222">if</span>&nbsp;<span class="ident" id="1427225">c</span>&nbsp;<span class="op" id="1427227">==</span>&nbsp;<span class="ident" id="1427230">nil</span>&nbsp;<span class="op" id="1427234">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427238">return</span>&nbsp;<span class="num" id="1427245">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427251">return</span>&nbsp;<span class="builtintype" id="1427258">int</span><span class="op" id="1427261">(</span><span class="ident" id="1427262">c</span><span class="op" id="1427263">.</span><span class="ident" id="1427264">dataqsiz</span><span class="op" id="1427272">)</span><br>
<span class="lineno"></span><span class="op" id="1427274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1427277">func</span>&nbsp;<span class="op" id="1427282">(</span><span class="ident" id="1427283">q</span>&nbsp;<span class="op" id="1427285">*</span><span class="ident" id="1427286">waitq</span><span class="op" id="1427291">)</span>&nbsp;<span class="ident" id="1427293">enqueue</span><span class="op" id="1427300">(</span><span class="ident" id="1427301">sgp</span>&nbsp;<span class="op" id="1427305">*</span><span class="ident" id="1427306">sudog</span><span class="op" id="1427311">)</span>&nbsp;<span class="op" id="1427313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427316">sgp</span><span class="op" id="1427319">.</span><span class="ident" id="1427320">next</span>&nbsp;<span class="op" id="1427325">=</span>&nbsp;<span class="ident" id="1427327">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427332">if</span>&nbsp;<span class="ident" id="1427335">q</span><span class="op" id="1427336">.</span><span class="ident" id="1427337">first</span>&nbsp;<span class="op" id="1427343">==</span>&nbsp;<span class="ident" id="1427346">nil</span>&nbsp;<span class="op" id="1427350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427354">q</span><span class="op" id="1427355">.</span><span class="ident" id="1427356">first</span>&nbsp;<span class="op" id="1427362">=</span>&nbsp;<span class="ident" id="1427364">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427370">q</span><span class="op" id="1427371">.</span><span class="ident" id="1427372">last</span>&nbsp;<span class="op" id="1427377">=</span>&nbsp;<span class="ident" id="1427379">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427385">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427396">q</span><span class="op" id="1427397">.</span><span class="ident" id="1427398">last</span><span class="op" id="1427402">.</span><span class="ident" id="1427403">next</span>&nbsp;<span class="op" id="1427408">=</span>&nbsp;<span class="ident" id="1427410">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427415">q</span><span class="op" id="1427416">.</span><span class="ident" id="1427417">last</span>&nbsp;<span class="op" id="1427422">=</span>&nbsp;<span class="ident" id="1427424">sgp</span><br>
<span class="lineno"></span><span class="op" id="1427428">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1427431">func</span>&nbsp;<span class="op" id="1427436">(</span><span class="ident" id="1427437">q</span>&nbsp;<span class="op" id="1427439">*</span><span class="ident" id="1427440">waitq</span><span class="op" id="1427445">)</span>&nbsp;<span class="ident" id="1427447">dequeue</span><span class="op" id="1427454">(</span><span class="op" id="1427455">)</span>&nbsp;<span class="op" id="1427457">*</span><span class="ident" id="1427458">sudog</span>&nbsp;<span class="op" id="1427464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427467">for</span>&nbsp;<span class="op" id="1427471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427475">sgp</span>&nbsp;<span class="op" id="1427479">:=</span>&nbsp;<span class="ident" id="1427482">q</span><span class="op" id="1427483">.</span><span class="ident" id="1427484">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427492">if</span>&nbsp;<span class="ident" id="1427495">sgp</span>&nbsp;<span class="op" id="1427499">==</span>&nbsp;<span class="ident" id="1427502">nil</span>&nbsp;<span class="op" id="1427506">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427511">return</span>&nbsp;<span class="ident" id="1427518">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427528">q</span><span class="op" id="1427529">.</span><span class="ident" id="1427530">first</span>&nbsp;<span class="op" id="1427536">=</span>&nbsp;<span class="ident" id="1427538">sgp</span><span class="op" id="1427541">.</span><span class="ident" id="1427542">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427549">sgp</span><span class="op" id="1427552">.</span><span class="ident" id="1427553">next</span>&nbsp;<span class="op" id="1427558">=</span>&nbsp;<span class="ident" id="1427560">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427566">if</span>&nbsp;<span class="ident" id="1427569">q</span><span class="op" id="1427570">.</span><span class="ident" id="1427571">last</span>&nbsp;<span class="op" id="1427576">==</span>&nbsp;<span class="ident" id="1427579">sgp</span>&nbsp;<span class="op" id="1427583">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427588">q</span><span class="op" id="1427589">.</span><span class="ident" id="1427590">last</span>&nbsp;<span class="op" id="1427595">=</span>&nbsp;<span class="ident" id="1427597">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427608">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427680">if</span>&nbsp;<span class="ident" id="1427683">sgp</span><span class="op" id="1427686">.</span><span class="ident" id="1427687">selectdone</span>&nbsp;<span class="op" id="1427698">!=</span>&nbsp;<span class="ident" id="1427701">nil</span>&nbsp;<span class="op" id="1427705">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427710">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427742">if</span>&nbsp;<span class="op" id="1427745">*</span><span class="ident" id="1427746">sgp</span><span class="op" id="1427749">.</span><span class="ident" id="1427750">selectdone</span>&nbsp;<span class="op" id="1427761">!=</span>&nbsp;<span class="num" id="1427764">0</span>&nbsp;<span class="op" id="1427766">||</span>&nbsp;<span class="op" id="1427769">!</span><span class="ident" id="1427770">cas</span><span class="op" id="1427773">(</span><span class="ident" id="1427774">sgp</span><span class="op" id="1427777">.</span><span class="ident" id="1427778">selectdone</span><span class="op" id="1427788">,</span>&nbsp;<span class="num" id="1427790">0</span><span class="op" id="1427791">,</span>&nbsp;<span class="num" id="1427793">1</span><span class="op" id="1427794">)</span>&nbsp;<span class="op" id="1427796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427802">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427818">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427823">return</span>&nbsp;<span class="ident" id="1427830">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427835">}</span><br>
<span class="lineno"></span><span class="op" id="1427837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1427840">func</span>&nbsp;<span class="ident" id="1427845">racesync</span><span class="op" id="1427853">(</span><span class="ident" id="1427854">c</span>&nbsp;<span class="op" id="1427856">*</span><span class="ident" id="1427857">hchan</span><span class="op" id="1427862">,</span>&nbsp;<span class="ident" id="1427864">sg</span>&nbsp;<span class="op" id="1427867">*</span><span class="ident" id="1427868">sudog</span><span class="op" id="1427873">)</span>&nbsp;<span class="op" id="1427875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427878">racerelease</span><span class="op" id="1427889">(</span><span class="ident" id="1427890">chanbuf</span><span class="op" id="1427897">(</span><span class="ident" id="1427898">c</span><span class="op" id="1427899">,</span>&nbsp;<span class="num" id="1427901">0</span><span class="op" id="1427902">)</span><span class="op" id="1427903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427906">raceacquireg</span><span class="op" id="1427918">(</span><span class="ident" id="1427919">sg</span><span class="op" id="1427921">.</span><span class="ident" id="1427922">g</span><span class="op" id="1427923">,</span>&nbsp;<span class="ident" id="1427925">chanbuf</span><span class="op" id="1427932">(</span><span class="ident" id="1427933">c</span><span class="op" id="1427934">,</span>&nbsp;<span class="num" id="1427936">0</span><span class="op" id="1427937">)</span><span class="op" id="1427938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427941">racereleaseg</span><span class="op" id="1427953">(</span><span class="ident" id="1427954">sg</span><span class="op" id="1427956">.</span><span class="ident" id="1427957">g</span><span class="op" id="1427958">,</span>&nbsp;<span class="ident" id="1427960">chanbuf</span><span class="op" id="1427967">(</span><span class="ident" id="1427968">c</span><span class="op" id="1427969">,</span>&nbsp;<span class="num" id="1427971">0</span><span class="op" id="1427972">)</span><span class="op" id="1427973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427976">raceacquire</span><span class="op" id="1427987">(</span><span class="ident" id="1427988">chanbuf</span><span class="op" id="1427995">(</span><span class="ident" id="1427996">c</span><span class="op" id="1427997">,</span>&nbsp;<span class="num" id="1427999">0</span><span class="op" id="1428000">)</span><span class="op" id="1428001">)</span><br>
<span class="lineno">655</span><span class="op" id="1428003">}</span>
</div>
</body>
</html>
