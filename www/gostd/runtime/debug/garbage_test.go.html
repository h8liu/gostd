<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html" class="current">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7341712">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7341768">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7341822">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7341873">package</span>&nbsp;<span class="ident" id="7341881">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7341888">import</span>&nbsp;<span class="op" id="7341895">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7341898">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7341909">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7341920">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7341927">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7341930">func</span>&nbsp;<span class="ident" id="7341935">TestReadGCStats</span><span class="op" id="7341950">(</span><span class="ident" id="7341951">t</span>&nbsp;<span class="op" id="7341953">*</span><span class="ident" id="7341954">testing</span><span class="op" id="7341961">.</span><span class="ident" id="7341962">T</span><span class="op" id="7341963">)</span>&nbsp;<span class="op" id="7341965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7341968">defer</span>&nbsp;<span class="ident" id="7341974">SetGCPercent</span><span class="op" id="7341986">(</span><span class="ident" id="7341987">SetGCPercent</span><span class="op" id="7341999">(</span><span class="op" id="7342000">-</span><span class="num" id="7342001">1</span><span class="op" id="7342002">)</span><span class="op" id="7342003">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7342007">var</span>&nbsp;<span class="ident" id="7342011">stats</span>&nbsp;<span class="ident" id="7342017">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7342026">var</span>&nbsp;<span class="ident" id="7342030">mstats</span>&nbsp;<span class="ident" id="7342037">runtime</span><span class="op" id="7342044">.</span><span class="ident" id="7342045">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7342055">var</span>&nbsp;<span class="ident" id="7342059">min</span><span class="op" id="7342062">,</span>&nbsp;<span class="ident" id="7342064">max</span>&nbsp;<span class="ident" id="7342068">time</span><span class="op" id="7342072">.</span><span class="ident" id="7342073">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7342084">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7342140">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342208">stats</span><span class="op" id="7342213">.</span><span class="ident" id="7342214">PauseQuantiles</span>&nbsp;<span class="op" id="7342229">=</span>&nbsp;<span class="builtinfunc" id="7342231">make</span><span class="op" id="7342235">(</span><span class="op" id="7342236">[</span><span class="op" id="7342237">]</span><span class="ident" id="7342238">time</span><span class="op" id="7342242">.</span><span class="ident" id="7342243">Duration</span><span class="op" id="7342251">,</span>&nbsp;<span class="num" id="7342253">10</span><span class="op" id="7342255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342258">ReadGCStats</span><span class="op" id="7342269">(</span><span class="op" id="7342270">&amp;</span><span class="ident" id="7342271">stats</span><span class="op" id="7342276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342279">runtime</span><span class="op" id="7342286">.</span><span class="ident" id="7342287">GC</span><span class="op" id="7342289">(</span><span class="op" id="7342290">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7342294">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342360">ReadGCStats</span><span class="op" id="7342371">(</span><span class="op" id="7342372">&amp;</span><span class="ident" id="7342373">stats</span><span class="op" id="7342378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342381">runtime</span><span class="op" id="7342388">.</span><span class="ident" id="7342389">ReadMemStats</span><span class="op" id="7342401">(</span><span class="op" id="7342402">&amp;</span><span class="ident" id="7342403">mstats</span><span class="op" id="7342409">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7342413">if</span>&nbsp;<span class="ident" id="7342416">stats</span><span class="op" id="7342421">.</span><span class="ident" id="7342422">NumGC</span>&nbsp;<span class="op" id="7342428">!=</span>&nbsp;<span class="builtintype" id="7342431">int64</span><span class="op" id="7342436">(</span><span class="ident" id="7342437">mstats</span><span class="op" id="7342443">.</span><span class="ident" id="7342444">NumGC</span><span class="op" id="7342449">)</span>&nbsp;<span class="op" id="7342451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342455">t</span><span class="op" id="7342456">.</span><span class="ident" id="7342457">Errorf</span><span class="op" id="7342463">(</span><span class="string" id="7342464">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7342505">,</span>&nbsp;<span class="ident" id="7342507">stats</span><span class="op" id="7342512">.</span><span class="ident" id="7342513">NumGC</span><span class="op" id="7342518">,</span>&nbsp;<span class="ident" id="7342520">mstats</span><span class="op" id="7342526">.</span><span class="ident" id="7342527">NumGC</span><span class="op" id="7342532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7342535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7342538">if</span>&nbsp;<span class="ident" id="7342541">stats</span><span class="op" id="7342546">.</span><span class="ident" id="7342547">PauseTotal</span>&nbsp;<span class="op" id="7342558">!=</span>&nbsp;<span class="ident" id="7342561">time</span><span class="op" id="7342565">.</span><span class="ident" id="7342566">Duration</span><span class="op" id="7342574">(</span><span class="ident" id="7342575">mstats</span><span class="op" id="7342581">.</span><span class="ident" id="7342582">PauseTotalNs</span><span class="op" id="7342594">)</span>&nbsp;<span class="op" id="7342596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342600">t</span><span class="op" id="7342601">.</span><span class="ident" id="7342602">Errorf</span><span class="op" id="7342608">(</span><span class="string" id="7342609">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7342662">,</span>&nbsp;<span class="ident" id="7342664">stats</span><span class="op" id="7342669">.</span><span class="ident" id="7342670">PauseTotal</span><span class="op" id="7342680">,</span>&nbsp;<span class="ident" id="7342682">mstats</span><span class="op" id="7342688">.</span><span class="ident" id="7342689">PauseTotalNs</span><span class="op" id="7342701">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7342704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7342707">if</span>&nbsp;<span class="ident" id="7342710">stats</span><span class="op" id="7342715">.</span><span class="ident" id="7342716">LastGC</span><span class="op" id="7342722">.</span><span class="ident" id="7342723">UnixNano</span><span class="op" id="7342731">(</span><span class="op" id="7342732">)</span>&nbsp;<span class="op" id="7342734">!=</span>&nbsp;<span class="builtintype" id="7342737">int64</span><span class="op" id="7342742">(</span><span class="ident" id="7342743">mstats</span><span class="op" id="7342749">.</span><span class="ident" id="7342750">LastGC</span><span class="op" id="7342756">)</span>&nbsp;<span class="op" id="7342758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342762">t</span><span class="op" id="7342763">.</span><span class="ident" id="7342764">Errorf</span><span class="op" id="7342770">(</span><span class="string" id="7342771">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7342823">,</span>&nbsp;<span class="ident" id="7342825">stats</span><span class="op" id="7342830">.</span><span class="ident" id="7342831">LastGC</span><span class="op" id="7342837">.</span><span class="ident" id="7342838">UnixNano</span><span class="op" id="7342846">(</span><span class="op" id="7342847">)</span><span class="op" id="7342848">,</span>&nbsp;<span class="ident" id="7342850">mstats</span><span class="op" id="7342856">.</span><span class="ident" id="7342857">LastGC</span><span class="op" id="7342863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7342866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342869">n</span>&nbsp;<span class="op" id="7342871">:=</span>&nbsp;<span class="builtintype" id="7342874">int</span><span class="op" id="7342877">(</span><span class="ident" id="7342878">mstats</span><span class="op" id="7342884">.</span><span class="ident" id="7342885">NumGC</span><span class="op" id="7342890">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7342893">if</span>&nbsp;<span class="ident" id="7342896">n</span>&nbsp;<span class="op" id="7342898">&gt;</span>&nbsp;<span class="builtinfunc" id="7342900">len</span><span class="op" id="7342903">(</span><span class="ident" id="7342904">mstats</span><span class="op" id="7342910">.</span><span class="ident" id="7342911">PauseNs</span><span class="op" id="7342918">)</span>&nbsp;<span class="op" id="7342920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342924">n</span>&nbsp;<span class="op" id="7342926">=</span>&nbsp;<span class="builtinfunc" id="7342928">len</span><span class="op" id="7342931">(</span><span class="ident" id="7342932">mstats</span><span class="op" id="7342938">.</span><span class="ident" id="7342939">PauseNs</span><span class="op" id="7342946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7342949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7342952">if</span>&nbsp;<span class="builtinfunc" id="7342955">len</span><span class="op" id="7342958">(</span><span class="ident" id="7342959">stats</span><span class="op" id="7342964">.</span><span class="ident" id="7342965">Pause</span><span class="op" id="7342970">)</span>&nbsp;<span class="op" id="7342972">!=</span>&nbsp;<span class="ident" id="7342975">n</span>&nbsp;<span class="op" id="7342977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7342981">t</span><span class="op" id="7342982">.</span><span class="ident" id="7342983">Errorf</span><span class="op" id="7342989">(</span><span class="string" id="7342990">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7343022">,</span>&nbsp;<span class="builtinfunc" id="7343024">len</span><span class="op" id="7343027">(</span><span class="ident" id="7343028">stats</span><span class="op" id="7343033">.</span><span class="ident" id="7343034">Pause</span><span class="op" id="7343039">)</span><span class="op" id="7343040">,</span>&nbsp;<span class="ident" id="7343042">n</span><span class="op" id="7343043">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343046">}</span>&nbsp;<span class="keyword" id="7343048">else</span>&nbsp;<span class="op" id="7343053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343057">off</span>&nbsp;<span class="op" id="7343061">:=</span>&nbsp;<span class="op" id="7343064">(</span><span class="builtintype" id="7343065">int</span><span class="op" id="7343068">(</span><span class="ident" id="7343069">mstats</span><span class="op" id="7343075">.</span><span class="ident" id="7343076">NumGC</span><span class="op" id="7343081">)</span>&nbsp;<span class="op" id="7343083">+</span>&nbsp;<span class="builtinfunc" id="7343085">len</span><span class="op" id="7343088">(</span><span class="ident" id="7343089">mstats</span><span class="op" id="7343095">.</span><span class="ident" id="7343096">PauseNs</span><span class="op" id="7343103">)</span>&nbsp;<span class="op" id="7343105">-</span>&nbsp;<span class="num" id="7343107">1</span><span class="op" id="7343108">)</span>&nbsp;<span class="op" id="7343110">%</span>&nbsp;<span class="builtinfunc" id="7343112">len</span><span class="op" id="7343115">(</span><span class="ident" id="7343116">mstats</span><span class="op" id="7343122">.</span><span class="ident" id="7343123">PauseNs</span><span class="op" id="7343130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7343134">for</span>&nbsp;<span class="ident" id="7343138">i</span>&nbsp;<span class="op" id="7343140">:=</span>&nbsp;<span class="num" id="7343143">0</span><span class="op" id="7343144">;</span>&nbsp;<span class="ident" id="7343146">i</span>&nbsp;<span class="op" id="7343148">&lt;</span>&nbsp;<span class="ident" id="7343150">n</span><span class="op" id="7343151">;</span>&nbsp;<span class="ident" id="7343153">i</span><span class="op" id="7343154">++</span>&nbsp;<span class="op" id="7343157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343162">dt</span>&nbsp;<span class="op" id="7343165">:=</span>&nbsp;<span class="ident" id="7343168">stats</span><span class="op" id="7343173">.</span><span class="ident" id="7343174">Pause</span><span class="op" id="7343179">[</span><span class="ident" id="7343180">i</span><span class="op" id="7343181">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7343186">if</span>&nbsp;<span class="ident" id="7343189">dt</span>&nbsp;<span class="op" id="7343192">!=</span>&nbsp;<span class="ident" id="7343195">time</span><span class="op" id="7343199">.</span><span class="ident" id="7343200">Duration</span><span class="op" id="7343208">(</span><span class="ident" id="7343209">mstats</span><span class="op" id="7343215">.</span><span class="ident" id="7343216">PauseNs</span><span class="op" id="7343223">[</span><span class="ident" id="7343224">off</span><span class="op" id="7343227">]</span><span class="op" id="7343228">)</span>&nbsp;<span class="op" id="7343230">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343236">t</span><span class="op" id="7343237">.</span><span class="ident" id="7343238">Errorf</span><span class="op" id="7343244">(</span><span class="string" id="7343245">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7343276">,</span>&nbsp;<span class="ident" id="7343278">i</span><span class="op" id="7343279">,</span>&nbsp;<span class="ident" id="7343281">dt</span><span class="op" id="7343283">,</span>&nbsp;<span class="ident" id="7343285">mstats</span><span class="op" id="7343291">.</span><span class="ident" id="7343292">PauseNs</span><span class="op" id="7343299">[</span><span class="ident" id="7343300">off</span><span class="op" id="7343303">]</span><span class="op" id="7343304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7343314">if</span>&nbsp;<span class="ident" id="7343317">max</span>&nbsp;<span class="op" id="7343321">&lt;</span>&nbsp;<span class="ident" id="7343323">dt</span>&nbsp;<span class="op" id="7343326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343332">max</span>&nbsp;<span class="op" id="7343336">=</span>&nbsp;<span class="ident" id="7343338">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343344">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7343349">if</span>&nbsp;<span class="ident" id="7343352">min</span>&nbsp;<span class="op" id="7343356">&gt;</span>&nbsp;<span class="ident" id="7343358">dt</span>&nbsp;<span class="op" id="7343361">||</span>&nbsp;<span class="ident" id="7343364">i</span>&nbsp;<span class="op" id="7343366">==</span>&nbsp;<span class="num" id="7343369">0</span>&nbsp;<span class="op" id="7343371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343377">min</span>&nbsp;<span class="op" id="7343381">=</span>&nbsp;<span class="ident" id="7343383">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343394">off</span>&nbsp;<span class="op" id="7343398">=</span>&nbsp;<span class="op" id="7343400">(</span><span class="ident" id="7343401">off</span>&nbsp;<span class="op" id="7343405">+</span>&nbsp;<span class="builtinfunc" id="7343407">len</span><span class="op" id="7343410">(</span><span class="ident" id="7343411">mstats</span><span class="op" id="7343417">.</span><span class="ident" id="7343418">PauseNs</span><span class="op" id="7343425">)</span>&nbsp;<span class="op" id="7343427">-</span>&nbsp;<span class="num" id="7343429">1</span><span class="op" id="7343430">)</span>&nbsp;<span class="op" id="7343432">%</span>&nbsp;<span class="builtinfunc" id="7343434">len</span><span class="op" id="7343437">(</span><span class="ident" id="7343438">mstats</span><span class="op" id="7343444">.</span><span class="ident" id="7343445">PauseNs</span><span class="op" id="7343452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343456">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343463">q</span>&nbsp;<span class="op" id="7343465">:=</span>&nbsp;<span class="ident" id="7343468">stats</span><span class="op" id="7343473">.</span><span class="ident" id="7343474">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343490">nq</span>&nbsp;<span class="op" id="7343493">:=</span>&nbsp;<span class="builtinfunc" id="7343496">len</span><span class="op" id="7343499">(</span><span class="ident" id="7343500">q</span><span class="op" id="7343501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7343504">if</span>&nbsp;<span class="ident" id="7343507">q</span><span class="op" id="7343508">[</span><span class="num" id="7343509">0</span><span class="op" id="7343510">]</span>&nbsp;<span class="op" id="7343512">!=</span>&nbsp;<span class="ident" id="7343515">min</span>&nbsp;<span class="op" id="7343519">||</span>&nbsp;<span class="ident" id="7343522">q</span><span class="op" id="7343523">[</span><span class="ident" id="7343524">nq</span><span class="op" id="7343526">-</span><span class="num" id="7343527">1</span><span class="op" id="7343528">]</span>&nbsp;<span class="op" id="7343530">!=</span>&nbsp;<span class="ident" id="7343533">max</span>&nbsp;<span class="op" id="7343537">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343541">t</span><span class="op" id="7343542">.</span><span class="ident" id="7343543">Errorf</span><span class="op" id="7343549">(</span><span class="string" id="7343550">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="7343608">,</span>&nbsp;<span class="ident" id="7343610">q</span><span class="op" id="7343611">[</span><span class="num" id="7343612">0</span><span class="op" id="7343613">]</span><span class="op" id="7343614">,</span>&nbsp;<span class="ident" id="7343616">q</span><span class="op" id="7343617">[</span><span class="ident" id="7343618">nq</span><span class="op" id="7343620">-</span><span class="num" id="7343621">1</span><span class="op" id="7343622">]</span><span class="op" id="7343623">,</span>&nbsp;<span class="ident" id="7343625">min</span><span class="op" id="7343628">,</span>&nbsp;<span class="ident" id="7343630">max</span><span class="op" id="7343633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7343640">for</span>&nbsp;<span class="ident" id="7343644">i</span>&nbsp;<span class="op" id="7343646">:=</span>&nbsp;<span class="num" id="7343649">0</span><span class="op" id="7343650">;</span>&nbsp;<span class="ident" id="7343652">i</span>&nbsp;<span class="op" id="7343654">&lt;</span>&nbsp;<span class="ident" id="7343656">nq</span><span class="op" id="7343658">-</span><span class="num" id="7343659">1</span><span class="op" id="7343660">;</span>&nbsp;<span class="ident" id="7343662">i</span><span class="op" id="7343663">++</span>&nbsp;<span class="op" id="7343666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7343670">if</span>&nbsp;<span class="ident" id="7343673">q</span><span class="op" id="7343674">[</span><span class="ident" id="7343675">i</span><span class="op" id="7343676">]</span>&nbsp;<span class="op" id="7343678">&gt;</span>&nbsp;<span class="ident" id="7343680">q</span><span class="op" id="7343681">[</span><span class="ident" id="7343682">i</span><span class="op" id="7343683">+</span><span class="num" id="7343684">1</span><span class="op" id="7343685">]</span>&nbsp;<span class="op" id="7343687">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343692">t</span><span class="op" id="7343693">.</span><span class="ident" id="7343694">Errorf</span><span class="op" id="7343700">(</span><span class="string" id="7343701">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="7343760">,</span>&nbsp;<span class="ident" id="7343762">i</span><span class="op" id="7343763">,</span>&nbsp;<span class="ident" id="7343765">q</span><span class="op" id="7343766">[</span><span class="ident" id="7343767">i</span><span class="op" id="7343768">]</span><span class="op" id="7343769">,</span>&nbsp;<span class="ident" id="7343771">i</span><span class="op" id="7343772">+</span><span class="num" id="7343773">1</span><span class="op" id="7343774">,</span>&nbsp;<span class="ident" id="7343776">q</span><span class="op" id="7343777">[</span><span class="ident" id="7343778">i</span><span class="op" id="7343779">+</span><span class="num" id="7343780">1</span><span class="op" id="7343781">]</span><span class="op" id="7343782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7343793">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7343833">if</span>&nbsp;<span class="builtinfunc" id="7343836">len</span><span class="op" id="7343839">(</span><span class="ident" id="7343840">stats</span><span class="op" id="7343845">.</span><span class="ident" id="7343846">PauseEnd</span><span class="op" id="7343854">)</span>&nbsp;<span class="op" id="7343856">!=</span>&nbsp;<span class="ident" id="7343859">n</span>&nbsp;<span class="op" id="7343861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343865">t</span><span class="op" id="7343866">.</span><span class="ident" id="7343867">Fatalf</span><span class="op" id="7343873">(</span><span class="string" id="7343874">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7343909">,</span>&nbsp;<span class="builtinfunc" id="7343911">len</span><span class="op" id="7343914">(</span><span class="ident" id="7343915">stats</span><span class="op" id="7343920">.</span><span class="ident" id="7343921">PauseEnd</span><span class="op" id="7343929">)</span><span class="op" id="7343930">,</span>&nbsp;<span class="ident" id="7343932">n</span><span class="op" id="7343933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7343936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7343939">off</span>&nbsp;<span class="op" id="7343943">:=</span>&nbsp;<span class="op" id="7343946">(</span><span class="builtintype" id="7343947">int</span><span class="op" id="7343950">(</span><span class="ident" id="7343951">mstats</span><span class="op" id="7343957">.</span><span class="ident" id="7343958">NumGC</span><span class="op" id="7343963">)</span>&nbsp;<span class="op" id="7343965">+</span>&nbsp;<span class="builtinfunc" id="7343967">len</span><span class="op" id="7343970">(</span><span class="ident" id="7343971">mstats</span><span class="op" id="7343977">.</span><span class="ident" id="7343978">PauseEnd</span><span class="op" id="7343986">)</span>&nbsp;<span class="op" id="7343988">-</span>&nbsp;<span class="num" id="7343990">1</span><span class="op" id="7343991">)</span>&nbsp;<span class="op" id="7343993">%</span>&nbsp;<span class="builtinfunc" id="7343995">len</span><span class="op" id="7343998">(</span><span class="ident" id="7343999">mstats</span><span class="op" id="7344005">.</span><span class="ident" id="7344006">PauseEnd</span><span class="op" id="7344014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7344017">for</span>&nbsp;<span class="ident" id="7344021">i</span>&nbsp;<span class="op" id="7344023">:=</span>&nbsp;<span class="num" id="7344026">0</span><span class="op" id="7344027">;</span>&nbsp;<span class="ident" id="7344029">i</span>&nbsp;<span class="op" id="7344031">&lt;</span>&nbsp;<span class="ident" id="7344033">n</span><span class="op" id="7344034">;</span>&nbsp;<span class="ident" id="7344036">i</span><span class="op" id="7344037">++</span>&nbsp;<span class="op" id="7344040">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344044">dt</span>&nbsp;<span class="op" id="7344047">:=</span>&nbsp;<span class="ident" id="7344050">stats</span><span class="op" id="7344055">.</span><span class="ident" id="7344056">PauseEnd</span><span class="op" id="7344064">[</span><span class="ident" id="7344065">i</span><span class="op" id="7344066">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7344070">if</span>&nbsp;<span class="ident" id="7344073">dt</span><span class="op" id="7344075">.</span><span class="ident" id="7344076">UnixNano</span><span class="op" id="7344084">(</span><span class="op" id="7344085">)</span>&nbsp;<span class="op" id="7344087">!=</span>&nbsp;<span class="builtintype" id="7344090">int64</span><span class="op" id="7344095">(</span><span class="ident" id="7344096">mstats</span><span class="op" id="7344102">.</span><span class="ident" id="7344103">PauseEnd</span><span class="op" id="7344111">[</span><span class="ident" id="7344112">off</span><span class="op" id="7344115">]</span><span class="op" id="7344116">)</span>&nbsp;<span class="op" id="7344118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344123">t</span><span class="op" id="7344124">.</span><span class="ident" id="7344125">Errorf</span><span class="op" id="7344131">(</span><span class="string" id="7344132">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7344166">,</span>&nbsp;<span class="ident" id="7344168">i</span><span class="op" id="7344169">,</span>&nbsp;<span class="ident" id="7344171">dt</span><span class="op" id="7344173">,</span>&nbsp;<span class="ident" id="7344175">mstats</span><span class="op" id="7344181">.</span><span class="ident" id="7344182">PauseEnd</span><span class="op" id="7344190">[</span><span class="ident" id="7344191">off</span><span class="op" id="7344194">]</span><span class="op" id="7344195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7344199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344203">off</span>&nbsp;<span class="op" id="7344207">=</span>&nbsp;<span class="op" id="7344209">(</span><span class="ident" id="7344210">off</span>&nbsp;<span class="op" id="7344214">+</span>&nbsp;<span class="builtinfunc" id="7344216">len</span><span class="op" id="7344219">(</span><span class="ident" id="7344220">mstats</span><span class="op" id="7344226">.</span><span class="ident" id="7344227">PauseEnd</span><span class="op" id="7344235">)</span>&nbsp;<span class="op" id="7344237">-</span>&nbsp;<span class="num" id="7344239">1</span><span class="op" id="7344240">)</span>&nbsp;<span class="op" id="7344242">%</span>&nbsp;<span class="builtinfunc" id="7344244">len</span><span class="op" id="7344247">(</span><span class="ident" id="7344248">mstats</span><span class="op" id="7344254">.</span><span class="ident" id="7344255">PauseEnd</span><span class="op" id="7344263">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7344266">}</span><br>
<span class="lineno"></span><span class="op" id="7344268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7344271">var</span>&nbsp;<span class="ident" id="7344275">big</span>&nbsp;<span class="op" id="7344279">=</span>&nbsp;<span class="builtinfunc" id="7344281">make</span><span class="op" id="7344285">(</span><span class="op" id="7344286">[</span><span class="op" id="7344287">]</span><span class="builtintype" id="7344288">byte</span><span class="op" id="7344292">,</span>&nbsp;<span class="num" id="7344294">1</span><span class="op" id="7344295">&lt;&lt;</span><span class="num" id="7344297">20</span><span class="op" id="7344299">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="7344302">func</span>&nbsp;<span class="ident" id="7344307">TestFreeOSMemory</span><span class="op" id="7344323">(</span><span class="ident" id="7344324">t</span>&nbsp;<span class="op" id="7344326">*</span><span class="ident" id="7344327">testing</span><span class="op" id="7344334">.</span><span class="ident" id="7344335">T</span><span class="op" id="7344336">)</span>&nbsp;<span class="op" id="7344338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7344341">var</span>&nbsp;<span class="ident" id="7344345">ms1</span><span class="op" id="7344348">,</span>&nbsp;<span class="ident" id="7344350">ms2</span>&nbsp;<span class="ident" id="7344354">runtime</span><span class="op" id="7344361">.</span><span class="ident" id="7344362">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7344373">if</span>&nbsp;<span class="ident" id="7344376">big</span>&nbsp;<span class="op" id="7344380">==</span>&nbsp;<span class="builtintype" id="7344383">nil</span>&nbsp;<span class="op" id="7344387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344391">t</span><span class="op" id="7344392">.</span><span class="ident" id="7344393">Skip</span><span class="op" id="7344397">(</span><span class="string" id="7344398">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="7344444">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7344447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344450">big</span>&nbsp;<span class="op" id="7344454">=</span>&nbsp;<span class="builtintype" id="7344456">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344461">runtime</span><span class="op" id="7344468">.</span><span class="ident" id="7344469">GC</span><span class="op" id="7344471">(</span><span class="op" id="7344472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344475">runtime</span><span class="op" id="7344482">.</span><span class="ident" id="7344483">ReadMemStats</span><span class="op" id="7344495">(</span><span class="op" id="7344496">&amp;</span><span class="ident" id="7344497">ms1</span><span class="op" id="7344500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344503">FreeOSMemory</span><span class="op" id="7344515">(</span><span class="op" id="7344516">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344519">runtime</span><span class="op" id="7344526">.</span><span class="ident" id="7344527">ReadMemStats</span><span class="op" id="7344539">(</span><span class="op" id="7344540">&amp;</span><span class="ident" id="7344541">ms2</span><span class="op" id="7344544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7344547">if</span>&nbsp;<span class="ident" id="7344550">ms1</span><span class="op" id="7344553">.</span><span class="ident" id="7344554">HeapReleased</span>&nbsp;<span class="op" id="7344567">&gt;=</span>&nbsp;<span class="ident" id="7344570">ms2</span><span class="op" id="7344573">.</span><span class="ident" id="7344574">HeapReleased</span>&nbsp;<span class="op" id="7344587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344591">t</span><span class="op" id="7344592">.</span><span class="ident" id="7344593">Errorf</span><span class="op" id="7344599">(</span><span class="string" id="7344600">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="7344654">,</span>&nbsp;<span class="ident" id="7344656">ms1</span><span class="op" id="7344659">.</span><span class="ident" id="7344660">HeapReleased</span><span class="op" id="7344672">,</span>&nbsp;<span class="ident" id="7344674">ms2</span><span class="op" id="7344677">.</span><span class="ident" id="7344678">HeapReleased</span><span class="op" id="7344690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7344693">}</span><br>
<span class="lineno"></span><span class="op" id="7344695">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="7344698">func</span>&nbsp;<span class="ident" id="7344703">TestSetGCPercent</span><span class="op" id="7344719">(</span><span class="ident" id="7344720">t</span>&nbsp;<span class="op" id="7344722">*</span><span class="ident" id="7344723">testing</span><span class="op" id="7344730">.</span><span class="ident" id="7344731">T</span><span class="op" id="7344732">)</span>&nbsp;<span class="op" id="7344734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7344737">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7344801">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7344865">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344894">old</span>&nbsp;<span class="op" id="7344898">:=</span>&nbsp;<span class="ident" id="7344901">SetGCPercent</span><span class="op" id="7344913">(</span><span class="num" id="7344914">123</span><span class="op" id="7344917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7344920">new</span>&nbsp;<span class="op" id="7344924">:=</span>&nbsp;<span class="ident" id="7344927">SetGCPercent</span><span class="op" id="7344939">(</span><span class="ident" id="7344940">old</span><span class="op" id="7344943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7344946">if</span>&nbsp;<span class="builtinfunc" id="7344949">new</span>&nbsp;<span class="op" id="7344953">!=</span>&nbsp;<span class="num" id="7344956">123</span>&nbsp;<span class="op" id="7344960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7344964">t</span><span class="op" id="7344965">.</span><span class="ident" id="7344966">Errorf</span><span class="op" id="7344972">(</span><span class="string" id="7344973">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="7345024">,</span>&nbsp;<span class="builtinfunc" id="7345026">new</span><span class="op" id="7345029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7345032">}</span><br>
<span class="lineno">115</span><span class="op" id="7345034">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
