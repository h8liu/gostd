<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4548018">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4548073">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4548127">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4548178">package</span>&nbsp;<span class="ident" id="4548186">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4548193">import</span>&nbsp;<span class="op" id="4548200">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4548203">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4548210">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4548216">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4548223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4548226">const</span>&nbsp;<span class="op" id="4548232">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548235">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548254">=</span>&nbsp;<span class="num" id="4548256">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548259">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548278">=</span>&nbsp;<span class="num" id="4548280">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548283">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548302">=</span>&nbsp;<span class="num" id="4548304">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548307">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548326">=</span>&nbsp;<span class="num" id="4548328">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548331">DefaultCompression</span>&nbsp;<span class="op" id="4548350">=</span>&nbsp;<span class="op" id="4548352">-</span><span class="num" id="4548353">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548356">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548375">=</span>&nbsp;<span class="num" id="4548377">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548381">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548400">=</span>&nbsp;<span class="num" id="4548402">1</span>&nbsp;<span class="op" id="4548404">&lt;&lt;</span>&nbsp;<span class="ident" id="4548407">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548422">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548441">=</span>&nbsp;<span class="ident" id="4548443">windowSize</span>&nbsp;<span class="op" id="4548454">-</span>&nbsp;<span class="num" id="4548456">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548459">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4548478">=</span>&nbsp;<span class="num" id="4548480">15</span>&nbsp;&nbsp;<span class="comment" id="4548484">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548505">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548524">=</span>&nbsp;<span class="num" id="4548526">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4548530">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548583">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548602">=</span>&nbsp;<span class="num" id="4548604">258</span>&nbsp;<span class="comment" id="4548608">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548649">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548668">=</span>&nbsp;<span class="num" id="4548670">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4548674">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4548720">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4548795">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548835">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4548855">=</span>&nbsp;<span class="num" id="4548857">1</span>&nbsp;<span class="op" id="4548859">&lt;&lt;</span>&nbsp;<span class="num" id="4548862">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548866">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4548886">=</span>&nbsp;<span class="num" id="4548888">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548895">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548915">=</span>&nbsp;<span class="num" id="4548917">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548921">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548941">=</span>&nbsp;<span class="num" id="4548943">1</span>&nbsp;<span class="op" id="4548945">&lt;&lt;</span>&nbsp;<span class="ident" id="4548948">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548958">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4548978">=</span>&nbsp;<span class="op" id="4548980">(</span><span class="num" id="4548981">1</span>&nbsp;<span class="op" id="4548983">&lt;&lt;</span>&nbsp;<span class="ident" id="4548986">hashBits</span><span class="op" id="4548994">)</span>&nbsp;<span class="op" id="4548996">-</span>&nbsp;<span class="num" id="4548998">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549001">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4549021">=</span>&nbsp;<span class="op" id="4549023">(</span><span class="ident" id="4549024">hashBits</span>&nbsp;<span class="op" id="4549033">+</span>&nbsp;<span class="ident" id="4549035">minMatchLength</span>&nbsp;<span class="op" id="4549050">-</span>&nbsp;<span class="num" id="4549052">1</span><span class="op" id="4549053">)</span>&nbsp;<span class="op" id="4549055">/</span>&nbsp;<span class="ident" id="4549057">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549073">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4549093">=</span>&nbsp;<span class="num" id="4549095">1</span>&nbsp;<span class="op" id="4549097">&lt;&lt;</span>&nbsp;<span class="num" id="4549100">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549105">skipNever</span>&nbsp;<span class="op" id="4549115">=</span>&nbsp;<span class="ident" id="4549117">math</span><span class="op" id="4549121">.</span><span class="ident" id="4549122">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4549131">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4549134">type</span>&nbsp;<span class="ident" id="4549139">compressionLevel</span>&nbsp;<span class="keyword" id="4549156">struct</span>&nbsp;<span class="op" id="4549163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549166">good</span><span class="op" id="4549170">,</span>&nbsp;<span class="ident" id="4549172">lazy</span><span class="op" id="4549176">,</span>&nbsp;<span class="ident" id="4549178">nice</span><span class="op" id="4549182">,</span>&nbsp;<span class="ident" id="4549184">chain</span><span class="op" id="4549189">,</span>&nbsp;<span class="ident" id="4549191">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4549207">int</span><br>
<span class="lineno"></span><span class="op" id="4549211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4549214">var</span>&nbsp;<span class="ident" id="4549218">levels</span>&nbsp;<span class="op" id="4549225">=</span>&nbsp;<span class="op" id="4549227">[</span><span class="op" id="4549228">]</span><span class="ident" id="4549229">compressionLevel</span><span class="op" id="4549245">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549248">{</span><span class="op" id="4549249">}</span><span class="op" id="4549250">,</span>&nbsp;<span class="comment" id="4549252">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4549258">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549318">{</span><span class="num" id="4549319">3</span><span class="op" id="4549320">,</span>&nbsp;<span class="num" id="4549322">0</span><span class="op" id="4549323">,</span>&nbsp;<span class="num" id="4549325">8</span><span class="op" id="4549326">,</span>&nbsp;<span class="num" id="4549328">4</span><span class="op" id="4549329">,</span>&nbsp;<span class="num" id="4549331">4</span><span class="op" id="4549332">}</span><span class="op" id="4549333">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549336">{</span><span class="num" id="4549337">3</span><span class="op" id="4549338">,</span>&nbsp;<span class="num" id="4549340">0</span><span class="op" id="4549341">,</span>&nbsp;<span class="num" id="4549343">16</span><span class="op" id="4549345">,</span>&nbsp;<span class="num" id="4549347">8</span><span class="op" id="4549348">,</span>&nbsp;<span class="num" id="4549350">5</span><span class="op" id="4549351">}</span><span class="op" id="4549352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549355">{</span><span class="num" id="4549356">3</span><span class="op" id="4549357">,</span>&nbsp;<span class="num" id="4549359">0</span><span class="op" id="4549360">,</span>&nbsp;<span class="num" id="4549362">32</span><span class="op" id="4549364">,</span>&nbsp;<span class="num" id="4549366">32</span><span class="op" id="4549368">,</span>&nbsp;<span class="num" id="4549370">6</span><span class="op" id="4549371">}</span><span class="op" id="4549372">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4549375">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4549426">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549487">{</span><span class="num" id="4549488">4</span><span class="op" id="4549489">,</span>&nbsp;<span class="num" id="4549491">4</span><span class="op" id="4549492">,</span>&nbsp;<span class="num" id="4549494">16</span><span class="op" id="4549496">,</span>&nbsp;<span class="num" id="4549498">16</span><span class="op" id="4549500">,</span>&nbsp;<span class="ident" id="4549502">skipNever</span><span class="op" id="4549511">}</span><span class="op" id="4549512">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549515">{</span><span class="num" id="4549516">8</span><span class="op" id="4549517">,</span>&nbsp;<span class="num" id="4549519">16</span><span class="op" id="4549521">,</span>&nbsp;<span class="num" id="4549523">32</span><span class="op" id="4549525">,</span>&nbsp;<span class="num" id="4549527">32</span><span class="op" id="4549529">,</span>&nbsp;<span class="ident" id="4549531">skipNever</span><span class="op" id="4549540">}</span><span class="op" id="4549541">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549544">{</span><span class="num" id="4549545">8</span><span class="op" id="4549546">,</span>&nbsp;<span class="num" id="4549548">16</span><span class="op" id="4549550">,</span>&nbsp;<span class="num" id="4549552">128</span><span class="op" id="4549555">,</span>&nbsp;<span class="num" id="4549557">128</span><span class="op" id="4549560">,</span>&nbsp;<span class="ident" id="4549562">skipNever</span><span class="op" id="4549571">}</span><span class="op" id="4549572">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549575">{</span><span class="num" id="4549576">8</span><span class="op" id="4549577">,</span>&nbsp;<span class="num" id="4549579">32</span><span class="op" id="4549581">,</span>&nbsp;<span class="num" id="4549583">128</span><span class="op" id="4549586">,</span>&nbsp;<span class="num" id="4549588">256</span><span class="op" id="4549591">,</span>&nbsp;<span class="ident" id="4549593">skipNever</span><span class="op" id="4549602">}</span><span class="op" id="4549603">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549606">{</span><span class="num" id="4549607">32</span><span class="op" id="4549609">,</span>&nbsp;<span class="num" id="4549611">128</span><span class="op" id="4549614">,</span>&nbsp;<span class="num" id="4549616">258</span><span class="op" id="4549619">,</span>&nbsp;<span class="num" id="4549621">1024</span><span class="op" id="4549625">,</span>&nbsp;<span class="ident" id="4549627">skipNever</span><span class="op" id="4549636">}</span><span class="op" id="4549637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4549640">{</span><span class="num" id="4549641">32</span><span class="op" id="4549643">,</span>&nbsp;<span class="num" id="4549645">258</span><span class="op" id="4549648">,</span>&nbsp;<span class="num" id="4549650">258</span><span class="op" id="4549653">,</span>&nbsp;<span class="num" id="4549655">4096</span><span class="op" id="4549659">,</span>&nbsp;<span class="ident" id="4549661">skipNever</span><span class="op" id="4549670">}</span><span class="op" id="4549671">,</span><br>
<span class="lineno"></span><span class="op" id="4549673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4549676">type</span>&nbsp;<span class="ident" id="4549681">compressor</span>&nbsp;<span class="keyword" id="4549692">struct</span>&nbsp;<span class="op" id="4549699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549702">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549721">w</span>&nbsp;<span class="op" id="4549723">*</span><span class="ident" id="4549724">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4549743">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549769">fill</span>&nbsp;<span class="keyword" id="4549774">func</span><span class="op" id="4549778">(</span><span class="op" id="4549779">*</span><span class="ident" id="4549780">compressor</span><span class="op" id="4549790">,</span>&nbsp;<span class="op" id="4549792">[</span><span class="op" id="4549793">]</span><span class="builtintype" id="4549794">byte</span><span class="op" id="4549798">)</span>&nbsp;<span class="builtintype" id="4549800">int</span>&nbsp;<span class="comment" id="4549804">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549828">step</span>&nbsp;<span class="keyword" id="4549833">func</span><span class="op" id="4549837">(</span><span class="op" id="4549838">*</span><span class="ident" id="4549839">compressor</span><span class="op" id="4549849">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4549863">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549882">sync</span>&nbsp;<span class="builtintype" id="4549887">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4549917">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4549939">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4549961">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4550047">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4550109">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4550184">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550214">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4550225">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550230">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4550241">[</span><span class="op" id="4550242">]</span><span class="builtintype" id="4550243">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550248">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4550259">[</span><span class="op" id="4550260">]</span><span class="builtintype" id="4550261">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550266">hashOffset</span>&nbsp;<span class="builtintype" id="4550277">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4550283">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550345">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4550359">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550364">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4550378">[</span><span class="op" id="4550379">]</span><span class="builtintype" id="4550380">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550386">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4550400">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550405">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4550419">int</span>&nbsp;&nbsp;<span class="comment" id="4550424">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550468">byteAvailable</span>&nbsp;<span class="builtintype" id="4550482">bool</span>&nbsp;<span class="comment" id="4550487">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4550540">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550565">tokens</span>&nbsp;<span class="op" id="4550572">[</span><span class="op" id="4550573">]</span><span class="ident" id="4550574">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4550582">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550600">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4550615">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550620">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4550635">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550640">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4550655">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550660">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4550675">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550680">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4550695">error</span><br>
<span class="lineno"></span><span class="op" id="4550701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4550704">func</span>&nbsp;<span class="op" id="4550709">(</span><span class="ident" id="4550710">d</span>&nbsp;<span class="op" id="4550712">*</span><span class="ident" id="4550713">compressor</span><span class="op" id="4550723">)</span>&nbsp;<span class="ident" id="4550725">fillDeflate</span><span class="op" id="4550736">(</span><span class="ident" id="4550737">b</span>&nbsp;<span class="op" id="4550739">[</span><span class="op" id="4550740">]</span><span class="builtintype" id="4550741">byte</span><span class="op" id="4550745">)</span>&nbsp;<span class="builtintype" id="4550747">int</span>&nbsp;<span class="op" id="4550751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550754">if</span>&nbsp;<span class="ident" id="4550757">d</span><span class="op" id="4550758">.</span><span class="ident" id="4550759">index</span>&nbsp;<span class="op" id="4550765">&gt;=</span>&nbsp;<span class="num" id="4550768">2</span><span class="op" id="4550769">*</span><span class="ident" id="4550770">windowSize</span><span class="op" id="4550780">-</span><span class="op" id="4550781">(</span><span class="ident" id="4550782">minMatchLength</span><span class="op" id="4550796">+</span><span class="ident" id="4550797">maxMatchLength</span><span class="op" id="4550811">)</span>&nbsp;<span class="op" id="4550813">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4550817">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4550853">copy</span><span class="op" id="4550857">(</span><span class="ident" id="4550858">d</span><span class="op" id="4550859">.</span><span class="ident" id="4550860">window</span><span class="op" id="4550866">,</span>&nbsp;<span class="ident" id="4550868">d</span><span class="op" id="4550869">.</span><span class="ident" id="4550870">window</span><span class="op" id="4550876">[</span><span class="ident" id="4550877">windowSize</span><span class="op" id="4550887">:</span><span class="num" id="4550888">2</span><span class="op" id="4550889">*</span><span class="ident" id="4550890">windowSize</span><span class="op" id="4550900">]</span><span class="op" id="4550901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550905">d</span><span class="op" id="4550906">.</span><span class="ident" id="4550907">index</span>&nbsp;<span class="op" id="4550913">-=</span>&nbsp;<span class="ident" id="4550916">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550929">d</span><span class="op" id="4550930">.</span><span class="ident" id="4550931">windowEnd</span>&nbsp;<span class="op" id="4550941">-=</span>&nbsp;<span class="ident" id="4550944">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550957">if</span>&nbsp;<span class="ident" id="4550960">d</span><span class="op" id="4550961">.</span><span class="ident" id="4550962">blockStart</span>&nbsp;<span class="op" id="4550973">&gt;=</span>&nbsp;<span class="ident" id="4550976">windowSize</span>&nbsp;<span class="op" id="4550987">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550992">d</span><span class="op" id="4550993">.</span><span class="ident" id="4550994">blockStart</span>&nbsp;<span class="op" id="4551005">-=</span>&nbsp;<span class="ident" id="4551008">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551021">}</span>&nbsp;<span class="keyword" id="4551023">else</span>&nbsp;<span class="op" id="4551028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551033">d</span><span class="op" id="4551034">.</span><span class="ident" id="4551035">blockStart</span>&nbsp;<span class="op" id="4551046">=</span>&nbsp;<span class="ident" id="4551048">math</span><span class="op" id="4551052">.</span><span class="ident" id="4551053">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551068">d</span><span class="op" id="4551069">.</span><span class="ident" id="4551070">hashOffset</span>&nbsp;<span class="op" id="4551081">+=</span>&nbsp;<span class="ident" id="4551084">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551097">if</span>&nbsp;<span class="ident" id="4551100">d</span><span class="op" id="4551101">.</span><span class="ident" id="4551102">hashOffset</span>&nbsp;<span class="op" id="4551113">&gt;</span>&nbsp;<span class="ident" id="4551115">maxHashOffset</span>&nbsp;<span class="op" id="4551129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551134">delta</span>&nbsp;<span class="op" id="4551140">:=</span>&nbsp;<span class="ident" id="4551143">d</span><span class="op" id="4551144">.</span><span class="ident" id="4551145">hashOffset</span>&nbsp;<span class="op" id="4551156">-</span>&nbsp;<span class="num" id="4551158">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551163">d</span><span class="op" id="4551164">.</span><span class="ident" id="4551165">hashOffset</span>&nbsp;<span class="op" id="4551176">-=</span>&nbsp;<span class="ident" id="4551179">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551188">d</span><span class="op" id="4551189">.</span><span class="ident" id="4551190">chainHead</span>&nbsp;<span class="op" id="4551200">-=</span>&nbsp;<span class="ident" id="4551203">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551212">for</span>&nbsp;<span class="ident" id="4551216">i</span><span class="op" id="4551217">,</span>&nbsp;<span class="ident" id="4551219">v</span>&nbsp;<span class="op" id="4551221">:=</span>&nbsp;<span class="keyword" id="4551224">range</span>&nbsp;<span class="ident" id="4551230">d</span><span class="op" id="4551231">.</span><span class="ident" id="4551232">hashPrev</span>&nbsp;<span class="op" id="4551241">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551247">if</span>&nbsp;<span class="ident" id="4551250">v</span>&nbsp;<span class="op" id="4551252">&gt;</span>&nbsp;<span class="ident" id="4551254">delta</span>&nbsp;<span class="op" id="4551260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551267">d</span><span class="op" id="4551268">.</span><span class="ident" id="4551269">hashPrev</span><span class="op" id="4551277">[</span><span class="ident" id="4551278">i</span><span class="op" id="4551279">]</span>&nbsp;<span class="op" id="4551281">-=</span>&nbsp;<span class="ident" id="4551284">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551294">}</span>&nbsp;<span class="keyword" id="4551296">else</span>&nbsp;<span class="op" id="4551301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551308">d</span><span class="op" id="4551309">.</span><span class="ident" id="4551310">hashPrev</span><span class="op" id="4551318">[</span><span class="ident" id="4551319">i</span><span class="op" id="4551320">]</span>&nbsp;<span class="op" id="4551322">=</span>&nbsp;<span class="num" id="4551324">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551330">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551340">for</span>&nbsp;<span class="ident" id="4551344">i</span><span class="op" id="4551345">,</span>&nbsp;<span class="ident" id="4551347">v</span>&nbsp;<span class="op" id="4551349">:=</span>&nbsp;<span class="keyword" id="4551352">range</span>&nbsp;<span class="ident" id="4551358">d</span><span class="op" id="4551359">.</span><span class="ident" id="4551360">hashHead</span>&nbsp;<span class="op" id="4551369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551375">if</span>&nbsp;<span class="ident" id="4551378">v</span>&nbsp;<span class="op" id="4551380">&gt;</span>&nbsp;<span class="ident" id="4551382">delta</span>&nbsp;<span class="op" id="4551388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551395">d</span><span class="op" id="4551396">.</span><span class="ident" id="4551397">hashHead</span><span class="op" id="4551405">[</span><span class="ident" id="4551406">i</span><span class="op" id="4551407">]</span>&nbsp;<span class="op" id="4551409">-=</span>&nbsp;<span class="ident" id="4551412">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551422">}</span>&nbsp;<span class="keyword" id="4551424">else</span>&nbsp;<span class="op" id="4551429">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551436">d</span><span class="op" id="4551437">.</span><span class="ident" id="4551438">hashHead</span><span class="op" id="4551446">[</span><span class="ident" id="4551447">i</span><span class="op" id="4551448">]</span>&nbsp;<span class="op" id="4551450">=</span>&nbsp;<span class="num" id="4551452">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551470">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551473">n</span>&nbsp;<span class="op" id="4551475">:=</span>&nbsp;<span class="builtinfunc" id="4551478">copy</span><span class="op" id="4551482">(</span><span class="ident" id="4551483">d</span><span class="op" id="4551484">.</span><span class="ident" id="4551485">window</span><span class="op" id="4551491">[</span><span class="ident" id="4551492">d</span><span class="op" id="4551493">.</span><span class="ident" id="4551494">windowEnd</span><span class="op" id="4551503">:</span><span class="op" id="4551504">]</span><span class="op" id="4551505">,</span>&nbsp;<span class="ident" id="4551507">b</span><span class="op" id="4551508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551511">d</span><span class="op" id="4551512">.</span><span class="ident" id="4551513">windowEnd</span>&nbsp;<span class="op" id="4551523">+=</span>&nbsp;<span class="ident" id="4551526">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551529">return</span>&nbsp;<span class="ident" id="4551536">n</span><br>
<span class="lineno"></span><span class="op" id="4551538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4551541">func</span>&nbsp;<span class="op" id="4551546">(</span><span class="ident" id="4551547">d</span>&nbsp;<span class="op" id="4551549">*</span><span class="ident" id="4551550">compressor</span><span class="op" id="4551560">)</span>&nbsp;<span class="ident" id="4551562">writeBlock</span><span class="op" id="4551572">(</span><span class="ident" id="4551573">tokens</span>&nbsp;<span class="op" id="4551580">[</span><span class="op" id="4551581">]</span><span class="ident" id="4551582">token</span><span class="op" id="4551587">,</span>&nbsp;<span class="ident" id="4551589">index</span>&nbsp;<span class="builtintype" id="4551595">int</span><span class="op" id="4551598">,</span>&nbsp;<span class="ident" id="4551600">eof</span>&nbsp;<span class="builtintype" id="4551604">bool</span><span class="op" id="4551608">)</span>&nbsp;<span class="builtintype" id="4551610">error</span>&nbsp;<span class="op" id="4551616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551619">if</span>&nbsp;<span class="ident" id="4551622">index</span>&nbsp;<span class="op" id="4551628">&gt;</span>&nbsp;<span class="num" id="4551630">0</span>&nbsp;<span class="op" id="4551632">||</span>&nbsp;<span class="ident" id="4551635">eof</span>&nbsp;<span class="op" id="4551639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551643">var</span>&nbsp;<span class="ident" id="4551647">window</span>&nbsp;<span class="op" id="4551654">[</span><span class="op" id="4551655">]</span><span class="builtintype" id="4551656">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551663">if</span>&nbsp;<span class="ident" id="4551666">d</span><span class="op" id="4551667">.</span><span class="ident" id="4551668">blockStart</span>&nbsp;<span class="op" id="4551679">&lt;=</span>&nbsp;<span class="ident" id="4551682">index</span>&nbsp;<span class="op" id="4551688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551693">window</span>&nbsp;<span class="op" id="4551700">=</span>&nbsp;<span class="ident" id="4551702">d</span><span class="op" id="4551703">.</span><span class="ident" id="4551704">window</span><span class="op" id="4551710">[</span><span class="ident" id="4551711">d</span><span class="op" id="4551712">.</span><span class="ident" id="4551713">blockStart</span><span class="op" id="4551723">:</span><span class="ident" id="4551724">index</span><span class="op" id="4551729">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551737">d</span><span class="op" id="4551738">.</span><span class="ident" id="4551739">blockStart</span>&nbsp;<span class="op" id="4551750">=</span>&nbsp;<span class="ident" id="4551752">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4551760">d</span><span class="op" id="4551761">.</span><span class="ident" id="4551762">w</span><span class="op" id="4551763">.</span><span class="ident" id="4551764">writeBlock</span><span class="op" id="4551774">(</span><span class="ident" id="4551775">tokens</span><span class="op" id="4551781">,</span>&nbsp;<span class="ident" id="4551783">eof</span><span class="op" id="4551786">,</span>&nbsp;<span class="ident" id="4551788">window</span><span class="op" id="4551794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551798">return</span>&nbsp;<span class="ident" id="4551805">d</span><span class="op" id="4551806">.</span><span class="ident" id="4551807">w</span><span class="op" id="4551808">.</span><span class="ident" id="4551809">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4551814">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4551817">return</span>&nbsp;<span class="ident" id="4551824">nil</span><br>
<span class="lineno"></span><span class="op" id="4551828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4551831">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4551911">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4551973">func</span>&nbsp;<span class="op" id="4551978">(</span><span class="ident" id="4551979">d</span>&nbsp;<span class="op" id="4551981">*</span><span class="ident" id="4551982">compressor</span><span class="op" id="4551992">)</span>&nbsp;<span class="ident" id="4551994">findMatch</span><span class="op" id="4552003">(</span><span class="ident" id="4552004">pos</span>&nbsp;<span class="builtintype" id="4552008">int</span><span class="op" id="4552011">,</span>&nbsp;<span class="ident" id="4552013">prevHead</span>&nbsp;<span class="builtintype" id="4552022">int</span><span class="op" id="4552025">,</span>&nbsp;<span class="ident" id="4552027">prevLength</span>&nbsp;<span class="builtintype" id="4552038">int</span><span class="op" id="4552041">,</span>&nbsp;<span class="ident" id="4552043">lookahead</span>&nbsp;<span class="builtintype" id="4552053">int</span><span class="op" id="4552056">)</span>&nbsp;<span class="op" id="4552058">(</span><span class="ident" id="4552059">length</span><span class="op" id="4552065">,</span>&nbsp;<span class="ident" id="4552067">offset</span>&nbsp;<span class="builtintype" id="4552074">int</span><span class="op" id="4552077">,</span>&nbsp;<span class="ident" id="4552079">ok</span>&nbsp;<span class="builtintype" id="4552082">bool</span><span class="op" id="4552086">)</span>&nbsp;<span class="op" id="4552088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552091">minMatchLook</span>&nbsp;<span class="op" id="4552104">:=</span>&nbsp;<span class="ident" id="4552107">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552123">if</span>&nbsp;<span class="ident" id="4552126">lookahead</span>&nbsp;<span class="op" id="4552136">&lt;</span>&nbsp;<span class="ident" id="4552138">minMatchLook</span>&nbsp;<span class="op" id="4552151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552155">minMatchLook</span>&nbsp;<span class="op" id="4552168">=</span>&nbsp;<span class="ident" id="4552170">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552181">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552185">win</span>&nbsp;<span class="op" id="4552189">:=</span>&nbsp;<span class="ident" id="4552192">d</span><span class="op" id="4552193">.</span><span class="ident" id="4552194">window</span><span class="op" id="4552200">[</span><span class="num" id="4552201">0</span>&nbsp;<span class="op" id="4552203">:</span>&nbsp;<span class="ident" id="4552205">pos</span><span class="op" id="4552208">+</span><span class="ident" id="4552209">minMatchLook</span><span class="op" id="4552221">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4552225">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552283">nice</span>&nbsp;<span class="op" id="4552288">:=</span>&nbsp;<span class="builtinfunc" id="4552291">len</span><span class="op" id="4552294">(</span><span class="ident" id="4552295">win</span><span class="op" id="4552298">)</span>&nbsp;<span class="op" id="4552300">-</span>&nbsp;<span class="ident" id="4552302">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552307">if</span>&nbsp;<span class="ident" id="4552310">d</span><span class="op" id="4552311">.</span><span class="ident" id="4552312">nice</span>&nbsp;<span class="op" id="4552317">&lt;</span>&nbsp;<span class="ident" id="4552319">nice</span>&nbsp;<span class="op" id="4552324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552328">nice</span>&nbsp;<span class="op" id="4552333">=</span>&nbsp;<span class="ident" id="4552335">d</span><span class="op" id="4552336">.</span><span class="ident" id="4552337">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4552347">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552420">tries</span>&nbsp;<span class="op" id="4552426">:=</span>&nbsp;<span class="ident" id="4552429">d</span><span class="op" id="4552430">.</span><span class="ident" id="4552431">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552438">length</span>&nbsp;<span class="op" id="4552445">=</span>&nbsp;<span class="ident" id="4552447">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552459">if</span>&nbsp;<span class="ident" id="4552462">length</span>&nbsp;<span class="op" id="4552469">&gt;=</span>&nbsp;<span class="ident" id="4552472">d</span><span class="op" id="4552473">.</span><span class="ident" id="4552474">good</span>&nbsp;<span class="op" id="4552479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552483">tries</span>&nbsp;<span class="op" id="4552489">&gt;&gt;=</span>&nbsp;<span class="num" id="4552493">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552496">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552500">w0</span>&nbsp;<span class="op" id="4552503">:=</span>&nbsp;<span class="ident" id="4552506">win</span><span class="op" id="4552509">[</span><span class="ident" id="4552510">pos</span><span class="op" id="4552513">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552516">w1</span>&nbsp;<span class="op" id="4552519">:=</span>&nbsp;<span class="ident" id="4552522">win</span><span class="op" id="4552525">[</span><span class="ident" id="4552526">pos</span><span class="op" id="4552529">+</span><span class="num" id="4552530">1</span><span class="op" id="4552531">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552534">wEnd</span>&nbsp;<span class="op" id="4552539">:=</span>&nbsp;<span class="ident" id="4552542">win</span><span class="op" id="4552545">[</span><span class="ident" id="4552546">pos</span><span class="op" id="4552549">+</span><span class="ident" id="4552550">length</span><span class="op" id="4552556">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552559">minIndex</span>&nbsp;<span class="op" id="4552568">:=</span>&nbsp;<span class="ident" id="4552571">pos</span>&nbsp;<span class="op" id="4552575">-</span>&nbsp;<span class="ident" id="4552577">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552590">for</span>&nbsp;<span class="ident" id="4552594">i</span>&nbsp;<span class="op" id="4552596">:=</span>&nbsp;<span class="ident" id="4552599">prevHead</span><span class="op" id="4552607">;</span>&nbsp;<span class="ident" id="4552609">tries</span>&nbsp;<span class="op" id="4552615">&gt;</span>&nbsp;<span class="num" id="4552617">0</span><span class="op" id="4552618">;</span>&nbsp;<span class="ident" id="4552620">tries</span><span class="op" id="4552625">--</span>&nbsp;<span class="op" id="4552628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552632">if</span>&nbsp;<span class="ident" id="4552635">w0</span>&nbsp;<span class="op" id="4552638">==</span>&nbsp;<span class="ident" id="4552641">win</span><span class="op" id="4552644">[</span><span class="ident" id="4552645">i</span><span class="op" id="4552646">]</span>&nbsp;<span class="op" id="4552648">&amp;&amp;</span>&nbsp;<span class="ident" id="4552651">w1</span>&nbsp;<span class="op" id="4552654">==</span>&nbsp;<span class="ident" id="4552657">win</span><span class="op" id="4552660">[</span><span class="ident" id="4552661">i</span><span class="op" id="4552662">+</span><span class="num" id="4552663">1</span><span class="op" id="4552664">]</span>&nbsp;<span class="op" id="4552666">&amp;&amp;</span>&nbsp;<span class="ident" id="4552669">wEnd</span>&nbsp;<span class="op" id="4552674">==</span>&nbsp;<span class="ident" id="4552677">win</span><span class="op" id="4552680">[</span><span class="ident" id="4552681">i</span><span class="op" id="4552682">+</span><span class="ident" id="4552683">length</span><span class="op" id="4552689">]</span>&nbsp;<span class="op" id="4552691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4552696">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552781">n</span>&nbsp;<span class="op" id="4552783">:=</span>&nbsp;<span class="num" id="4552786">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552791">for</span>&nbsp;<span class="ident" id="4552795">pos</span><span class="op" id="4552798">+</span><span class="ident" id="4552799">n</span>&nbsp;<span class="op" id="4552801">&lt;</span>&nbsp;<span class="builtinfunc" id="4552803">len</span><span class="op" id="4552806">(</span><span class="ident" id="4552807">win</span><span class="op" id="4552810">)</span>&nbsp;<span class="op" id="4552812">&amp;&amp;</span>&nbsp;<span class="ident" id="4552815">win</span><span class="op" id="4552818">[</span><span class="ident" id="4552819">i</span><span class="op" id="4552820">+</span><span class="ident" id="4552821">n</span><span class="op" id="4552822">]</span>&nbsp;<span class="op" id="4552824">==</span>&nbsp;<span class="ident" id="4552827">win</span><span class="op" id="4552830">[</span><span class="ident" id="4552831">pos</span><span class="op" id="4552834">+</span><span class="ident" id="4552835">n</span><span class="op" id="4552836">]</span>&nbsp;<span class="op" id="4552838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552844">n</span><span class="op" id="4552845">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4552851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552856">if</span>&nbsp;<span class="ident" id="4552859">n</span>&nbsp;<span class="op" id="4552861">&gt;</span>&nbsp;<span class="ident" id="4552863">length</span>&nbsp;<span class="op" id="4552870">&amp;&amp;</span>&nbsp;<span class="op" id="4552873">(</span><span class="ident" id="4552874">n</span>&nbsp;<span class="op" id="4552876">&gt;</span>&nbsp;<span class="num" id="4552878">3</span>&nbsp;<span class="op" id="4552880">||</span>&nbsp;<span class="ident" id="4552883">pos</span><span class="op" id="4552886">-</span><span class="ident" id="4552887">i</span>&nbsp;<span class="op" id="4552889">&lt;=</span>&nbsp;<span class="num" id="4552892">4096</span><span class="op" id="4552896">)</span>&nbsp;<span class="op" id="4552898">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552904">length</span>&nbsp;<span class="op" id="4552911">=</span>&nbsp;<span class="ident" id="4552913">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552919">offset</span>&nbsp;<span class="op" id="4552926">=</span>&nbsp;<span class="ident" id="4552928">pos</span>&nbsp;<span class="op" id="4552932">-</span>&nbsp;<span class="ident" id="4552934">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4552940">ok</span>&nbsp;<span class="op" id="4552943">=</span>&nbsp;<span class="builtintype" id="4552945">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4552954">if</span>&nbsp;<span class="ident" id="4552957">n</span>&nbsp;<span class="op" id="4552959">&gt;=</span>&nbsp;<span class="ident" id="4552962">nice</span>&nbsp;<span class="op" id="4552967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4552974">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553047">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553063">wEnd</span>&nbsp;<span class="op" id="4553068">=</span>&nbsp;<span class="ident" id="4553070">win</span><span class="op" id="4553073">[</span><span class="ident" id="4553074">pos</span><span class="op" id="4553077">+</span><span class="ident" id="4553078">n</span><span class="op" id="4553079">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553088">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553092">if</span>&nbsp;<span class="ident" id="4553095">i</span>&nbsp;<span class="op" id="4553097">==</span>&nbsp;<span class="ident" id="4553100">minIndex</span>&nbsp;<span class="op" id="4553109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4553114">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553200">if</span>&nbsp;<span class="ident" id="4553203">i</span>&nbsp;<span class="op" id="4553205">=</span>&nbsp;<span class="ident" id="4553207">d</span><span class="op" id="4553208">.</span><span class="ident" id="4553209">hashPrev</span><span class="op" id="4553217">[</span><span class="ident" id="4553218">i</span><span class="op" id="4553219">&amp;</span><span class="ident" id="4553220">windowMask</span><span class="op" id="4553230">]</span>&nbsp;<span class="op" id="4553232">-</span>&nbsp;<span class="ident" id="4553234">d</span><span class="op" id="4553235">.</span><span class="ident" id="4553236">hashOffset</span><span class="op" id="4553246">;</span>&nbsp;<span class="ident" id="4553248">i</span>&nbsp;<span class="op" id="4553250">&lt;</span>&nbsp;<span class="ident" id="4553252">minIndex</span>&nbsp;<span class="op" id="4553261">||</span>&nbsp;<span class="ident" id="4553264">i</span>&nbsp;<span class="op" id="4553266">&lt;</span>&nbsp;<span class="num" id="4553268">0</span>&nbsp;<span class="op" id="4553270">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553275">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553289">return</span><br>
<span class="lineno"></span><span class="op" id="4553296">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4553299">func</span>&nbsp;<span class="op" id="4553304">(</span><span class="ident" id="4553305">d</span>&nbsp;<span class="op" id="4553307">*</span><span class="ident" id="4553308">compressor</span><span class="op" id="4553318">)</span>&nbsp;<span class="ident" id="4553320">writeStoredBlock</span><span class="op" id="4553336">(</span><span class="ident" id="4553337">buf</span>&nbsp;<span class="op" id="4553341">[</span><span class="op" id="4553342">]</span><span class="builtintype" id="4553343">byte</span><span class="op" id="4553347">)</span>&nbsp;<span class="builtintype" id="4553349">error</span>&nbsp;<span class="op" id="4553355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553358">if</span>&nbsp;<span class="ident" id="4553361">d</span><span class="op" id="4553362">.</span><span class="ident" id="4553363">w</span><span class="op" id="4553364">.</span><span class="ident" id="4553365">writeStoredHeader</span><span class="op" id="4553382">(</span><span class="builtinfunc" id="4553383">len</span><span class="op" id="4553386">(</span><span class="ident" id="4553387">buf</span><span class="op" id="4553390">)</span><span class="op" id="4553391">,</span>&nbsp;<span class="builtintype" id="4553393">false</span><span class="op" id="4553398">)</span><span class="op" id="4553399">;</span>&nbsp;<span class="ident" id="4553401">d</span><span class="op" id="4553402">.</span><span class="ident" id="4553403">w</span><span class="op" id="4553404">.</span><span class="ident" id="4553405">err</span>&nbsp;<span class="op" id="4553409">!=</span>&nbsp;<span class="ident" id="4553412">nil</span>&nbsp;<span class="op" id="4553416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553420">return</span>&nbsp;<span class="ident" id="4553427">d</span><span class="op" id="4553428">.</span><span class="ident" id="4553429">w</span><span class="op" id="4553430">.</span><span class="ident" id="4553431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553436">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553439">d</span><span class="op" id="4553440">.</span><span class="ident" id="4553441">w</span><span class="op" id="4553442">.</span><span class="ident" id="4553443">writeBytes</span><span class="op" id="4553453">(</span><span class="ident" id="4553454">buf</span><span class="op" id="4553457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553460">return</span>&nbsp;<span class="ident" id="4553467">d</span><span class="op" id="4553468">.</span><span class="ident" id="4553469">w</span><span class="op" id="4553470">.</span><span class="ident" id="4553471">err</span><br>
<span class="lineno"></span><span class="op" id="4553475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4553478">func</span>&nbsp;<span class="op" id="4553483">(</span><span class="ident" id="4553484">d</span>&nbsp;<span class="op" id="4553486">*</span><span class="ident" id="4553487">compressor</span><span class="op" id="4553497">)</span>&nbsp;<span class="ident" id="4553499">initDeflate</span><span class="op" id="4553510">(</span><span class="op" id="4553511">)</span>&nbsp;<span class="op" id="4553513">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553516">d</span><span class="op" id="4553517">.</span><span class="ident" id="4553518">hashHead</span>&nbsp;<span class="op" id="4553527">=</span>&nbsp;<span class="builtinfunc" id="4553529">make</span><span class="op" id="4553533">(</span><span class="op" id="4553534">[</span><span class="op" id="4553535">]</span><span class="builtintype" id="4553536">int</span><span class="op" id="4553539">,</span>&nbsp;<span class="ident" id="4553541">hashSize</span><span class="op" id="4553549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553552">d</span><span class="op" id="4553553">.</span><span class="ident" id="4553554">hashPrev</span>&nbsp;<span class="op" id="4553563">=</span>&nbsp;<span class="builtinfunc" id="4553565">make</span><span class="op" id="4553569">(</span><span class="op" id="4553570">[</span><span class="op" id="4553571">]</span><span class="builtintype" id="4553572">int</span><span class="op" id="4553575">,</span>&nbsp;<span class="ident" id="4553577">windowSize</span><span class="op" id="4553587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553590">d</span><span class="op" id="4553591">.</span><span class="ident" id="4553592">window</span>&nbsp;<span class="op" id="4553599">=</span>&nbsp;<span class="builtinfunc" id="4553601">make</span><span class="op" id="4553605">(</span><span class="op" id="4553606">[</span><span class="op" id="4553607">]</span><span class="builtintype" id="4553608">byte</span><span class="op" id="4553612">,</span>&nbsp;<span class="num" id="4553614">2</span><span class="op" id="4553615">*</span><span class="ident" id="4553616">windowSize</span><span class="op" id="4553626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553629">d</span><span class="op" id="4553630">.</span><span class="ident" id="4553631">hashOffset</span>&nbsp;<span class="op" id="4553642">=</span>&nbsp;<span class="num" id="4553644">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553647">d</span><span class="op" id="4553648">.</span><span class="ident" id="4553649">tokens</span>&nbsp;<span class="op" id="4553656">=</span>&nbsp;<span class="builtinfunc" id="4553658">make</span><span class="op" id="4553662">(</span><span class="op" id="4553663">[</span><span class="op" id="4553664">]</span><span class="ident" id="4553665">token</span><span class="op" id="4553670">,</span>&nbsp;<span class="num" id="4553672">0</span><span class="op" id="4553673">,</span>&nbsp;<span class="ident" id="4553675">maxFlateBlockTokens</span><span class="op" id="4553694">+</span><span class="num" id="4553695">1</span><span class="op" id="4553696">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553699">d</span><span class="op" id="4553700">.</span><span class="ident" id="4553701">length</span>&nbsp;<span class="op" id="4553708">=</span>&nbsp;<span class="ident" id="4553710">minMatchLength</span>&nbsp;<span class="op" id="4553725">-</span>&nbsp;<span class="num" id="4553727">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553730">d</span><span class="op" id="4553731">.</span><span class="ident" id="4553732">offset</span>&nbsp;<span class="op" id="4553739">=</span>&nbsp;<span class="num" id="4553741">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553744">d</span><span class="op" id="4553745">.</span><span class="ident" id="4553746">byteAvailable</span>&nbsp;<span class="op" id="4553760">=</span>&nbsp;<span class="builtintype" id="4553762">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553769">d</span><span class="op" id="4553770">.</span><span class="ident" id="4553771">index</span>&nbsp;<span class="op" id="4553777">=</span>&nbsp;<span class="num" id="4553779">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553782">d</span><span class="op" id="4553783">.</span><span class="ident" id="4553784">hash</span>&nbsp;<span class="op" id="4553789">=</span>&nbsp;<span class="num" id="4553791">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553794">d</span><span class="op" id="4553795">.</span><span class="ident" id="4553796">chainHead</span>&nbsp;<span class="op" id="4553806">=</span>&nbsp;<span class="op" id="4553808">-</span><span class="num" id="4553809">1</span><br>
<span class="lineno"></span><span class="op" id="4553811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4553814">func</span>&nbsp;<span class="op" id="4553819">(</span><span class="ident" id="4553820">d</span>&nbsp;<span class="op" id="4553822">*</span><span class="ident" id="4553823">compressor</span><span class="op" id="4553833">)</span>&nbsp;<span class="ident" id="4553835">deflate</span><span class="op" id="4553842">(</span><span class="op" id="4553843">)</span>&nbsp;<span class="op" id="4553845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553848">if</span>&nbsp;<span class="ident" id="4553851">d</span><span class="op" id="4553852">.</span><span class="ident" id="4553853">windowEnd</span><span class="op" id="4553862">-</span><span class="ident" id="4553863">d</span><span class="op" id="4553864">.</span><span class="ident" id="4553865">index</span>&nbsp;<span class="op" id="4553871">&lt;</span>&nbsp;<span class="ident" id="4553873">minMatchLength</span><span class="op" id="4553887">+</span><span class="ident" id="4553888">maxMatchLength</span>&nbsp;<span class="op" id="4553903">&amp;&amp;</span>&nbsp;<span class="op" id="4553906">!</span><span class="ident" id="4553907">d</span><span class="op" id="4553908">.</span><span class="ident" id="4553909">sync</span>&nbsp;<span class="op" id="4553914">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553918">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4553926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4553930">d</span><span class="op" id="4553931">.</span><span class="ident" id="4553932">maxInsertIndex</span>&nbsp;<span class="op" id="4553947">=</span>&nbsp;<span class="ident" id="4553949">d</span><span class="op" id="4553950">.</span><span class="ident" id="4553951">windowEnd</span>&nbsp;<span class="op" id="4553961">-</span>&nbsp;<span class="op" id="4553963">(</span><span class="ident" id="4553964">minMatchLength</span>&nbsp;<span class="op" id="4553979">-</span>&nbsp;<span class="num" id="4553981">1</span><span class="op" id="4553982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4553985">if</span>&nbsp;<span class="ident" id="4553988">d</span><span class="op" id="4553989">.</span><span class="ident" id="4553990">index</span>&nbsp;<span class="op" id="4553996">&lt;</span>&nbsp;<span class="ident" id="4553998">d</span><span class="op" id="4553999">.</span><span class="ident" id="4554000">maxInsertIndex</span>&nbsp;<span class="op" id="4554015">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554019">d</span><span class="op" id="4554020">.</span><span class="ident" id="4554021">hash</span>&nbsp;<span class="op" id="4554026">=</span>&nbsp;<span class="builtintype" id="4554028">int</span><span class="op" id="4554031">(</span><span class="ident" id="4554032">d</span><span class="op" id="4554033">.</span><span class="ident" id="4554034">window</span><span class="op" id="4554040">[</span><span class="ident" id="4554041">d</span><span class="op" id="4554042">.</span><span class="ident" id="4554043">index</span><span class="op" id="4554048">]</span><span class="op" id="4554049">)</span><span class="op" id="4554050">&lt;&lt;</span><span class="ident" id="4554052">hashShift</span>&nbsp;<span class="op" id="4554062">+</span>&nbsp;<span class="builtintype" id="4554064">int</span><span class="op" id="4554067">(</span><span class="ident" id="4554068">d</span><span class="op" id="4554069">.</span><span class="ident" id="4554070">window</span><span class="op" id="4554076">[</span><span class="ident" id="4554077">d</span><span class="op" id="4554078">.</span><span class="ident" id="4554079">index</span><span class="op" id="4554084">+</span><span class="num" id="4554085">1</span><span class="op" id="4554086">]</span><span class="op" id="4554087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4554093">Loop</span><span class="op" id="4554097">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554100">for</span>&nbsp;<span class="op" id="4554104">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554108">if</span>&nbsp;<span class="ident" id="4554111">d</span><span class="op" id="4554112">.</span><span class="ident" id="4554113">index</span>&nbsp;<span class="op" id="4554119">&gt;</span>&nbsp;<span class="ident" id="4554121">d</span><span class="op" id="4554122">.</span><span class="ident" id="4554123">windowEnd</span>&nbsp;<span class="op" id="4554133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4554138">panic</span><span class="op" id="4554143">(</span><span class="string" id="4554144">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4554163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554171">lookahead</span>&nbsp;<span class="op" id="4554181">:=</span>&nbsp;<span class="ident" id="4554184">d</span><span class="op" id="4554185">.</span><span class="ident" id="4554186">windowEnd</span>&nbsp;<span class="op" id="4554196">-</span>&nbsp;<span class="ident" id="4554198">d</span><span class="op" id="4554199">.</span><span class="ident" id="4554200">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554208">if</span>&nbsp;<span class="ident" id="4554211">lookahead</span>&nbsp;<span class="op" id="4554221">&lt;</span>&nbsp;<span class="ident" id="4554223">minMatchLength</span><span class="op" id="4554237">+</span><span class="ident" id="4554238">maxMatchLength</span>&nbsp;<span class="op" id="4554253">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554258">if</span>&nbsp;<span class="op" id="4554261">!</span><span class="ident" id="4554262">d</span><span class="op" id="4554263">.</span><span class="ident" id="4554264">sync</span>&nbsp;<span class="op" id="4554269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554275">break</span>&nbsp;<span class="ident" id="4554281">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554294">if</span>&nbsp;<span class="ident" id="4554297">d</span><span class="op" id="4554298">.</span><span class="ident" id="4554299">index</span>&nbsp;<span class="op" id="4554305">&gt;</span>&nbsp;<span class="ident" id="4554307">d</span><span class="op" id="4554308">.</span><span class="ident" id="4554309">windowEnd</span>&nbsp;<span class="op" id="4554319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4554325">panic</span><span class="op" id="4554330">(</span><span class="string" id="4554331">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4554350">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554360">if</span>&nbsp;<span class="ident" id="4554363">lookahead</span>&nbsp;<span class="op" id="4554373">==</span>&nbsp;<span class="num" id="4554376">0</span>&nbsp;<span class="op" id="4554378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4554384">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554426">if</span>&nbsp;<span class="ident" id="4554429">d</span><span class="op" id="4554430">.</span><span class="ident" id="4554431">byteAvailable</span>&nbsp;<span class="op" id="4554445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4554452">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554518">d</span><span class="op" id="4554519">.</span><span class="ident" id="4554520">tokens</span>&nbsp;<span class="op" id="4554527">=</span>&nbsp;<span class="builtinfunc" id="4554529">append</span><span class="op" id="4554535">(</span><span class="ident" id="4554536">d</span><span class="op" id="4554537">.</span><span class="ident" id="4554538">tokens</span><span class="op" id="4554544">,</span>&nbsp;<span class="ident" id="4554546">literalToken</span><span class="op" id="4554558">(</span><span class="builtintype" id="4554559">uint32</span><span class="op" id="4554565">(</span><span class="ident" id="4554566">d</span><span class="op" id="4554567">.</span><span class="ident" id="4554568">window</span><span class="op" id="4554574">[</span><span class="ident" id="4554575">d</span><span class="op" id="4554576">.</span><span class="ident" id="4554577">index</span><span class="op" id="4554582">-</span><span class="num" id="4554583">1</span><span class="op" id="4554584">]</span><span class="op" id="4554585">)</span><span class="op" id="4554586">)</span><span class="op" id="4554587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554594">d</span><span class="op" id="4554595">.</span><span class="ident" id="4554596">byteAvailable</span>&nbsp;<span class="op" id="4554610">=</span>&nbsp;<span class="builtintype" id="4554612">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554628">if</span>&nbsp;<span class="builtinfunc" id="4554631">len</span><span class="op" id="4554634">(</span><span class="ident" id="4554635">d</span><span class="op" id="4554636">.</span><span class="ident" id="4554637">tokens</span><span class="op" id="4554643">)</span>&nbsp;<span class="op" id="4554645">&gt;</span>&nbsp;<span class="num" id="4554647">0</span>&nbsp;<span class="op" id="4554649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554656">if</span>&nbsp;<span class="ident" id="4554659">d</span><span class="op" id="4554660">.</span><span class="ident" id="4554661">err</span>&nbsp;<span class="op" id="4554665">=</span>&nbsp;<span class="ident" id="4554667">d</span><span class="op" id="4554668">.</span><span class="ident" id="4554669">writeBlock</span><span class="op" id="4554679">(</span><span class="ident" id="4554680">d</span><span class="op" id="4554681">.</span><span class="ident" id="4554682">tokens</span><span class="op" id="4554688">,</span>&nbsp;<span class="ident" id="4554690">d</span><span class="op" id="4554691">.</span><span class="ident" id="4554692">index</span><span class="op" id="4554697">,</span>&nbsp;<span class="builtintype" id="4554699">false</span><span class="op" id="4554704">)</span><span class="op" id="4554705">;</span>&nbsp;<span class="ident" id="4554707">d</span><span class="op" id="4554708">.</span><span class="ident" id="4554709">err</span>&nbsp;<span class="op" id="4554713">!=</span>&nbsp;<span class="ident" id="4554716">nil</span>&nbsp;<span class="op" id="4554720">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554728">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554747">d</span><span class="op" id="4554748">.</span><span class="ident" id="4554749">tokens</span>&nbsp;<span class="op" id="4554756">=</span>&nbsp;<span class="ident" id="4554758">d</span><span class="op" id="4554759">.</span><span class="ident" id="4554760">tokens</span><span class="op" id="4554766">[</span><span class="op" id="4554767">:</span><span class="num" id="4554768">0</span><span class="op" id="4554769">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554781">break</span>&nbsp;<span class="ident" id="4554787">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4554799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4554803">if</span>&nbsp;<span class="ident" id="4554806">d</span><span class="op" id="4554807">.</span><span class="ident" id="4554808">index</span>&nbsp;<span class="op" id="4554814">&lt;</span>&nbsp;<span class="ident" id="4554816">d</span><span class="op" id="4554817">.</span><span class="ident" id="4554818">maxInsertIndex</span>&nbsp;<span class="op" id="4554833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4554838">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554860">d</span><span class="op" id="4554861">.</span><span class="ident" id="4554862">hash</span>&nbsp;<span class="op" id="4554867">=</span>&nbsp;<span class="op" id="4554869">(</span><span class="ident" id="4554870">d</span><span class="op" id="4554871">.</span><span class="ident" id="4554872">hash</span><span class="op" id="4554876">&lt;&lt;</span><span class="ident" id="4554878">hashShift</span>&nbsp;<span class="op" id="4554888">+</span>&nbsp;<span class="builtintype" id="4554890">int</span><span class="op" id="4554893">(</span><span class="ident" id="4554894">d</span><span class="op" id="4554895">.</span><span class="ident" id="4554896">window</span><span class="op" id="4554902">[</span><span class="ident" id="4554903">d</span><span class="op" id="4554904">.</span><span class="ident" id="4554905">index</span><span class="op" id="4554910">+</span><span class="num" id="4554911">2</span><span class="op" id="4554912">]</span><span class="op" id="4554913">)</span><span class="op" id="4554914">)</span>&nbsp;<span class="op" id="4554916">&amp;</span>&nbsp;<span class="ident" id="4554918">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554930">d</span><span class="op" id="4554931">.</span><span class="ident" id="4554932">chainHead</span>&nbsp;<span class="op" id="4554942">=</span>&nbsp;<span class="ident" id="4554944">d</span><span class="op" id="4554945">.</span><span class="ident" id="4554946">hashHead</span><span class="op" id="4554954">[</span><span class="ident" id="4554955">d</span><span class="op" id="4554956">.</span><span class="ident" id="4554957">hash</span><span class="op" id="4554961">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4554966">d</span><span class="op" id="4554967">.</span><span class="ident" id="4554968">hashPrev</span><span class="op" id="4554976">[</span><span class="ident" id="4554977">d</span><span class="op" id="4554978">.</span><span class="ident" id="4554979">index</span><span class="op" id="4554984">&amp;</span><span class="ident" id="4554985">windowMask</span><span class="op" id="4554995">]</span>&nbsp;<span class="op" id="4554997">=</span>&nbsp;<span class="ident" id="4554999">d</span><span class="op" id="4555000">.</span><span class="ident" id="4555001">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555014">d</span><span class="op" id="4555015">.</span><span class="ident" id="4555016">hashHead</span><span class="op" id="4555024">[</span><span class="ident" id="4555025">d</span><span class="op" id="4555026">.</span><span class="ident" id="4555027">hash</span><span class="op" id="4555031">]</span>&nbsp;<span class="op" id="4555033">=</span>&nbsp;<span class="ident" id="4555035">d</span><span class="op" id="4555036">.</span><span class="ident" id="4555037">index</span>&nbsp;<span class="op" id="4555043">+</span>&nbsp;<span class="ident" id="4555045">d</span><span class="op" id="4555046">.</span><span class="ident" id="4555047">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555064">prevLength</span>&nbsp;<span class="op" id="4555075">:=</span>&nbsp;<span class="ident" id="4555078">d</span><span class="op" id="4555079">.</span><span class="ident" id="4555080">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555089">prevOffset</span>&nbsp;<span class="op" id="4555100">:=</span>&nbsp;<span class="ident" id="4555103">d</span><span class="op" id="4555104">.</span><span class="ident" id="4555105">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555114">d</span><span class="op" id="4555115">.</span><span class="ident" id="4555116">length</span>&nbsp;<span class="op" id="4555123">=</span>&nbsp;<span class="ident" id="4555125">minMatchLength</span>&nbsp;<span class="op" id="4555140">-</span>&nbsp;<span class="num" id="4555142">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555146">d</span><span class="op" id="4555147">.</span><span class="ident" id="4555148">offset</span>&nbsp;<span class="op" id="4555155">=</span>&nbsp;<span class="num" id="4555157">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555161">minIndex</span>&nbsp;<span class="op" id="4555170">:=</span>&nbsp;<span class="ident" id="4555173">d</span><span class="op" id="4555174">.</span><span class="ident" id="4555175">index</span>&nbsp;<span class="op" id="4555181">-</span>&nbsp;<span class="ident" id="4555183">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555196">if</span>&nbsp;<span class="ident" id="4555199">minIndex</span>&nbsp;<span class="op" id="4555208">&lt;</span>&nbsp;<span class="num" id="4555210">0</span>&nbsp;<span class="op" id="4555212">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555217">minIndex</span>&nbsp;<span class="op" id="4555226">=</span>&nbsp;<span class="num" id="4555228">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555237">if</span>&nbsp;<span class="ident" id="4555240">d</span><span class="op" id="4555241">.</span><span class="ident" id="4555242">chainHead</span><span class="op" id="4555251">-</span><span class="ident" id="4555252">d</span><span class="op" id="4555253">.</span><span class="ident" id="4555254">hashOffset</span>&nbsp;<span class="op" id="4555265">&gt;=</span>&nbsp;<span class="ident" id="4555268">minIndex</span>&nbsp;<span class="op" id="4555277">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555283">(</span><span class="ident" id="4555284">d</span><span class="op" id="4555285">.</span><span class="ident" id="4555286">fastSkipHashing</span>&nbsp;<span class="op" id="4555302">!=</span>&nbsp;<span class="ident" id="4555305">skipNever</span>&nbsp;<span class="op" id="4555315">&amp;&amp;</span>&nbsp;<span class="ident" id="4555318">lookahead</span>&nbsp;<span class="op" id="4555328">&gt;</span>&nbsp;<span class="ident" id="4555330">minMatchLength</span><span class="op" id="4555344">-</span><span class="num" id="4555345">1</span>&nbsp;<span class="op" id="4555347">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555354">d</span><span class="op" id="4555355">.</span><span class="ident" id="4555356">fastSkipHashing</span>&nbsp;<span class="op" id="4555372">==</span>&nbsp;<span class="ident" id="4555375">skipNever</span>&nbsp;<span class="op" id="4555385">&amp;&amp;</span>&nbsp;<span class="ident" id="4555388">lookahead</span>&nbsp;<span class="op" id="4555398">&gt;</span>&nbsp;<span class="ident" id="4555400">prevLength</span>&nbsp;<span class="op" id="4555411">&amp;&amp;</span>&nbsp;<span class="ident" id="4555414">prevLength</span>&nbsp;<span class="op" id="4555425">&lt;</span>&nbsp;<span class="ident" id="4555427">d</span><span class="op" id="4555428">.</span><span class="ident" id="4555429">lazy</span><span class="op" id="4555433">)</span>&nbsp;<span class="op" id="4555435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555440">if</span>&nbsp;<span class="ident" id="4555443">newLength</span><span class="op" id="4555452">,</span>&nbsp;<span class="ident" id="4555454">newOffset</span><span class="op" id="4555463">,</span>&nbsp;<span class="ident" id="4555465">ok</span>&nbsp;<span class="op" id="4555468">:=</span>&nbsp;<span class="ident" id="4555471">d</span><span class="op" id="4555472">.</span><span class="ident" id="4555473">findMatch</span><span class="op" id="4555482">(</span><span class="ident" id="4555483">d</span><span class="op" id="4555484">.</span><span class="ident" id="4555485">index</span><span class="op" id="4555490">,</span>&nbsp;<span class="ident" id="4555492">d</span><span class="op" id="4555493">.</span><span class="ident" id="4555494">chainHead</span><span class="op" id="4555503">-</span><span class="ident" id="4555504">d</span><span class="op" id="4555505">.</span><span class="ident" id="4555506">hashOffset</span><span class="op" id="4555516">,</span>&nbsp;<span class="ident" id="4555518">minMatchLength</span><span class="op" id="4555532">-</span><span class="num" id="4555533">1</span><span class="op" id="4555534">,</span>&nbsp;<span class="ident" id="4555536">lookahead</span><span class="op" id="4555545">)</span><span class="op" id="4555546">;</span>&nbsp;<span class="ident" id="4555548">ok</span>&nbsp;<span class="op" id="4555551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555557">d</span><span class="op" id="4555558">.</span><span class="ident" id="4555559">length</span>&nbsp;<span class="op" id="4555566">=</span>&nbsp;<span class="ident" id="4555568">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555582">d</span><span class="op" id="4555583">.</span><span class="ident" id="4555584">offset</span>&nbsp;<span class="op" id="4555591">=</span>&nbsp;<span class="ident" id="4555593">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555606">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555614">if</span>&nbsp;<span class="ident" id="4555617">d</span><span class="op" id="4555618">.</span><span class="ident" id="4555619">fastSkipHashing</span>&nbsp;<span class="op" id="4555635">!=</span>&nbsp;<span class="ident" id="4555638">skipNever</span>&nbsp;<span class="op" id="4555648">&amp;&amp;</span>&nbsp;<span class="ident" id="4555651">d</span><span class="op" id="4555652">.</span><span class="ident" id="4555653">length</span>&nbsp;<span class="op" id="4555660">&gt;=</span>&nbsp;<span class="ident" id="4555663">minMatchLength</span>&nbsp;<span class="op" id="4555678">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555684">d</span><span class="op" id="4555685">.</span><span class="ident" id="4555686">fastSkipHashing</span>&nbsp;<span class="op" id="4555702">==</span>&nbsp;<span class="ident" id="4555705">skipNever</span>&nbsp;<span class="op" id="4555715">&amp;&amp;</span>&nbsp;<span class="ident" id="4555718">prevLength</span>&nbsp;<span class="op" id="4555729">&gt;=</span>&nbsp;<span class="ident" id="4555732">minMatchLength</span>&nbsp;<span class="op" id="4555747">&amp;&amp;</span>&nbsp;<span class="ident" id="4555750">d</span><span class="op" id="4555751">.</span><span class="ident" id="4555752">length</span>&nbsp;<span class="op" id="4555759">&lt;=</span>&nbsp;<span class="ident" id="4555762">prevLength</span>&nbsp;<span class="op" id="4555773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4555778">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4555849">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555894">if</span>&nbsp;<span class="ident" id="4555897">d</span><span class="op" id="4555898">.</span><span class="ident" id="4555899">fastSkipHashing</span>&nbsp;<span class="op" id="4555915">!=</span>&nbsp;<span class="ident" id="4555918">skipNever</span>&nbsp;<span class="op" id="4555928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555934">d</span><span class="op" id="4555935">.</span><span class="ident" id="4555936">tokens</span>&nbsp;<span class="op" id="4555943">=</span>&nbsp;<span class="builtinfunc" id="4555945">append</span><span class="op" id="4555951">(</span><span class="ident" id="4555952">d</span><span class="op" id="4555953">.</span><span class="ident" id="4555954">tokens</span><span class="op" id="4555960">,</span>&nbsp;<span class="ident" id="4555962">matchToken</span><span class="op" id="4555972">(</span><span class="builtintype" id="4555973">uint32</span><span class="op" id="4555979">(</span><span class="ident" id="4555980">d</span><span class="op" id="4555981">.</span><span class="ident" id="4555982">length</span><span class="op" id="4555988">-</span><span class="ident" id="4555989">minMatchLength</span><span class="op" id="4556003">)</span><span class="op" id="4556004">,</span>&nbsp;<span class="builtintype" id="4556006">uint32</span><span class="op" id="4556012">(</span><span class="ident" id="4556013">d</span><span class="op" id="4556014">.</span><span class="ident" id="4556015">offset</span><span class="op" id="4556021">-</span><span class="ident" id="4556022">minOffsetSize</span><span class="op" id="4556035">)</span><span class="op" id="4556036">)</span><span class="op" id="4556037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556042">}</span>&nbsp;<span class="keyword" id="4556044">else</span>&nbsp;<span class="op" id="4556049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556055">d</span><span class="op" id="4556056">.</span><span class="ident" id="4556057">tokens</span>&nbsp;<span class="op" id="4556064">=</span>&nbsp;<span class="builtinfunc" id="4556066">append</span><span class="op" id="4556072">(</span><span class="ident" id="4556073">d</span><span class="op" id="4556074">.</span><span class="ident" id="4556075">tokens</span><span class="op" id="4556081">,</span>&nbsp;<span class="ident" id="4556083">matchToken</span><span class="op" id="4556093">(</span><span class="builtintype" id="4556094">uint32</span><span class="op" id="4556100">(</span><span class="ident" id="4556101">prevLength</span><span class="op" id="4556111">-</span><span class="ident" id="4556112">minMatchLength</span><span class="op" id="4556126">)</span><span class="op" id="4556127">,</span>&nbsp;<span class="builtintype" id="4556129">uint32</span><span class="op" id="4556135">(</span><span class="ident" id="4556136">prevOffset</span><span class="op" id="4556146">-</span><span class="ident" id="4556147">minOffsetSize</span><span class="op" id="4556160">)</span><span class="op" id="4556161">)</span><span class="op" id="4556162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556167">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4556172">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4556243">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4556312">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4556381">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556394">if</span>&nbsp;<span class="ident" id="4556397">d</span><span class="op" id="4556398">.</span><span class="ident" id="4556399">length</span>&nbsp;<span class="op" id="4556406">&lt;=</span>&nbsp;<span class="ident" id="4556409">d</span><span class="op" id="4556410">.</span><span class="ident" id="4556411">fastSkipHashing</span>&nbsp;<span class="op" id="4556427">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556433">var</span>&nbsp;<span class="ident" id="4556437">newIndex</span>&nbsp;<span class="builtintype" id="4556446">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556454">if</span>&nbsp;<span class="ident" id="4556457">d</span><span class="op" id="4556458">.</span><span class="ident" id="4556459">fastSkipHashing</span>&nbsp;<span class="op" id="4556475">!=</span>&nbsp;<span class="ident" id="4556478">skipNever</span>&nbsp;<span class="op" id="4556488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556495">newIndex</span>&nbsp;<span class="op" id="4556504">=</span>&nbsp;<span class="ident" id="4556506">d</span><span class="op" id="4556507">.</span><span class="ident" id="4556508">index</span>&nbsp;<span class="op" id="4556514">+</span>&nbsp;<span class="ident" id="4556516">d</span><span class="op" id="4556517">.</span><span class="ident" id="4556518">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556529">}</span>&nbsp;<span class="keyword" id="4556531">else</span>&nbsp;<span class="op" id="4556536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556543">newIndex</span>&nbsp;<span class="op" id="4556552">=</span>&nbsp;<span class="ident" id="4556554">d</span><span class="op" id="4556555">.</span><span class="ident" id="4556556">index</span>&nbsp;<span class="op" id="4556562">+</span>&nbsp;<span class="ident" id="4556564">prevLength</span>&nbsp;<span class="op" id="4556575">-</span>&nbsp;<span class="num" id="4556577">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556589">for</span>&nbsp;<span class="ident" id="4556593">d</span><span class="op" id="4556594">.</span><span class="ident" id="4556595">index</span><span class="op" id="4556600">++</span><span class="op" id="4556602">;</span>&nbsp;<span class="ident" id="4556604">d</span><span class="op" id="4556605">.</span><span class="ident" id="4556606">index</span>&nbsp;<span class="op" id="4556612">&lt;</span>&nbsp;<span class="ident" id="4556614">newIndex</span><span class="op" id="4556622">;</span>&nbsp;<span class="ident" id="4556624">d</span><span class="op" id="4556625">.</span><span class="ident" id="4556626">index</span><span class="op" id="4556631">++</span>&nbsp;<span class="op" id="4556634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556641">if</span>&nbsp;<span class="ident" id="4556644">d</span><span class="op" id="4556645">.</span><span class="ident" id="4556646">index</span>&nbsp;<span class="op" id="4556652">&lt;</span>&nbsp;<span class="ident" id="4556654">d</span><span class="op" id="4556655">.</span><span class="ident" id="4556656">maxInsertIndex</span>&nbsp;<span class="op" id="4556671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556679">d</span><span class="op" id="4556680">.</span><span class="ident" id="4556681">hash</span>&nbsp;<span class="op" id="4556686">=</span>&nbsp;<span class="op" id="4556688">(</span><span class="ident" id="4556689">d</span><span class="op" id="4556690">.</span><span class="ident" id="4556691">hash</span><span class="op" id="4556695">&lt;&lt;</span><span class="ident" id="4556697">hashShift</span>&nbsp;<span class="op" id="4556707">+</span>&nbsp;<span class="builtintype" id="4556709">int</span><span class="op" id="4556712">(</span><span class="ident" id="4556713">d</span><span class="op" id="4556714">.</span><span class="ident" id="4556715">window</span><span class="op" id="4556721">[</span><span class="ident" id="4556722">d</span><span class="op" id="4556723">.</span><span class="ident" id="4556724">index</span><span class="op" id="4556729">+</span><span class="num" id="4556730">2</span><span class="op" id="4556731">]</span><span class="op" id="4556732">)</span><span class="op" id="4556733">)</span>&nbsp;<span class="op" id="4556735">&amp;</span>&nbsp;<span class="ident" id="4556737">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4556752">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4556800">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556855">d</span><span class="op" id="4556856">.</span><span class="ident" id="4556857">hashPrev</span><span class="op" id="4556865">[</span><span class="ident" id="4556866">d</span><span class="op" id="4556867">.</span><span class="ident" id="4556868">index</span><span class="op" id="4556873">&amp;</span><span class="ident" id="4556874">windowMask</span><span class="op" id="4556884">]</span>&nbsp;<span class="op" id="4556886">=</span>&nbsp;<span class="ident" id="4556888">d</span><span class="op" id="4556889">.</span><span class="ident" id="4556890">hashHead</span><span class="op" id="4556898">[</span><span class="ident" id="4556899">d</span><span class="op" id="4556900">.</span><span class="ident" id="4556901">hash</span><span class="op" id="4556905">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4556913">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556960">d</span><span class="op" id="4556961">.</span><span class="ident" id="4556962">hashHead</span><span class="op" id="4556970">[</span><span class="ident" id="4556971">d</span><span class="op" id="4556972">.</span><span class="ident" id="4556973">hash</span><span class="op" id="4556977">]</span>&nbsp;<span class="op" id="4556979">=</span>&nbsp;<span class="ident" id="4556981">d</span><span class="op" id="4556982">.</span><span class="ident" id="4556983">index</span>&nbsp;<span class="op" id="4556989">+</span>&nbsp;<span class="ident" id="4556991">d</span><span class="op" id="4556992">.</span><span class="ident" id="4556993">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557009">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557021">if</span>&nbsp;<span class="ident" id="4557024">d</span><span class="op" id="4557025">.</span><span class="ident" id="4557026">fastSkipHashing</span>&nbsp;<span class="op" id="4557042">==</span>&nbsp;<span class="ident" id="4557045">skipNever</span>&nbsp;<span class="op" id="4557055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557062">d</span><span class="op" id="4557063">.</span><span class="ident" id="4557064">byteAvailable</span>&nbsp;<span class="op" id="4557078">=</span>&nbsp;<span class="builtintype" id="4557080">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557091">d</span><span class="op" id="4557092">.</span><span class="ident" id="4557093">length</span>&nbsp;<span class="op" id="4557100">=</span>&nbsp;<span class="ident" id="4557102">minMatchLength</span>&nbsp;<span class="op" id="4557117">-</span>&nbsp;<span class="num" id="4557119">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557125">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557130">}</span>&nbsp;<span class="keyword" id="4557132">else</span>&nbsp;<span class="op" id="4557137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557143">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557215">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557243">d</span><span class="op" id="4557244">.</span><span class="ident" id="4557245">index</span>&nbsp;<span class="op" id="4557251">+=</span>&nbsp;<span class="ident" id="4557254">d</span><span class="op" id="4557255">.</span><span class="ident" id="4557256">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557267">if</span>&nbsp;<span class="ident" id="4557270">d</span><span class="op" id="4557271">.</span><span class="ident" id="4557272">index</span>&nbsp;<span class="op" id="4557278">&lt;</span>&nbsp;<span class="ident" id="4557280">d</span><span class="op" id="4557281">.</span><span class="ident" id="4557282">maxInsertIndex</span>&nbsp;<span class="op" id="4557297">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557304">d</span><span class="op" id="4557305">.</span><span class="ident" id="4557306">hash</span>&nbsp;<span class="op" id="4557311">=</span>&nbsp;<span class="op" id="4557313">(</span><span class="builtintype" id="4557314">int</span><span class="op" id="4557317">(</span><span class="ident" id="4557318">d</span><span class="op" id="4557319">.</span><span class="ident" id="4557320">window</span><span class="op" id="4557326">[</span><span class="ident" id="4557327">d</span><span class="op" id="4557328">.</span><span class="ident" id="4557329">index</span><span class="op" id="4557334">]</span><span class="op" id="4557335">)</span><span class="op" id="4557336">&lt;&lt;</span><span class="ident" id="4557338">hashShift</span>&nbsp;<span class="op" id="4557348">+</span>&nbsp;<span class="builtintype" id="4557350">int</span><span class="op" id="4557353">(</span><span class="ident" id="4557354">d</span><span class="op" id="4557355">.</span><span class="ident" id="4557356">window</span><span class="op" id="4557362">[</span><span class="ident" id="4557363">d</span><span class="op" id="4557364">.</span><span class="ident" id="4557365">index</span><span class="op" id="4557370">+</span><span class="num" id="4557371">1</span><span class="op" id="4557372">]</span><span class="op" id="4557373">)</span><span class="op" id="4557374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557390">if</span>&nbsp;<span class="builtinfunc" id="4557393">len</span><span class="op" id="4557396">(</span><span class="ident" id="4557397">d</span><span class="op" id="4557398">.</span><span class="ident" id="4557399">tokens</span><span class="op" id="4557405">)</span>&nbsp;<span class="op" id="4557407">==</span>&nbsp;<span class="ident" id="4557410">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4557430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557436">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557484">if</span>&nbsp;<span class="ident" id="4557487">d</span><span class="op" id="4557488">.</span><span class="ident" id="4557489">err</span>&nbsp;<span class="op" id="4557493">=</span>&nbsp;<span class="ident" id="4557495">d</span><span class="op" id="4557496">.</span><span class="ident" id="4557497">writeBlock</span><span class="op" id="4557507">(</span><span class="ident" id="4557508">d</span><span class="op" id="4557509">.</span><span class="ident" id="4557510">tokens</span><span class="op" id="4557516">,</span>&nbsp;<span class="ident" id="4557518">d</span><span class="op" id="4557519">.</span><span class="ident" id="4557520">index</span><span class="op" id="4557525">,</span>&nbsp;<span class="builtintype" id="4557527">false</span><span class="op" id="4557532">)</span><span class="op" id="4557533">;</span>&nbsp;<span class="ident" id="4557535">d</span><span class="op" id="4557536">.</span><span class="ident" id="4557537">err</span>&nbsp;<span class="op" id="4557541">!=</span>&nbsp;<span class="ident" id="4557544">nil</span>&nbsp;<span class="op" id="4557548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557555">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557572">d</span><span class="op" id="4557573">.</span><span class="ident" id="4557574">tokens</span>&nbsp;<span class="op" id="4557581">=</span>&nbsp;<span class="ident" id="4557583">d</span><span class="op" id="4557584">.</span><span class="ident" id="4557585">tokens</span><span class="op" id="4557591">[</span><span class="op" id="4557592">:</span><span class="num" id="4557593">0</span><span class="op" id="4557594">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557599">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557603">}</span>&nbsp;<span class="keyword" id="4557605">else</span>&nbsp;<span class="op" id="4557610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557615">if</span>&nbsp;<span class="ident" id="4557618">d</span><span class="op" id="4557619">.</span><span class="ident" id="4557620">fastSkipHashing</span>&nbsp;<span class="op" id="4557636">!=</span>&nbsp;<span class="ident" id="4557639">skipNever</span>&nbsp;<span class="op" id="4557649">||</span>&nbsp;<span class="ident" id="4557652">d</span><span class="op" id="4557653">.</span><span class="ident" id="4557654">byteAvailable</span>&nbsp;<span class="op" id="4557668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557674">i</span>&nbsp;<span class="op" id="4557676">:=</span>&nbsp;<span class="ident" id="4557679">d</span><span class="op" id="4557680">.</span><span class="ident" id="4557681">index</span>&nbsp;<span class="op" id="4557687">-</span>&nbsp;<span class="num" id="4557689">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557695">if</span>&nbsp;<span class="ident" id="4557698">d</span><span class="op" id="4557699">.</span><span class="ident" id="4557700">fastSkipHashing</span>&nbsp;<span class="op" id="4557716">!=</span>&nbsp;<span class="ident" id="4557719">skipNever</span>&nbsp;<span class="op" id="4557729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557736">i</span>&nbsp;<span class="op" id="4557738">=</span>&nbsp;<span class="ident" id="4557740">d</span><span class="op" id="4557741">.</span><span class="ident" id="4557742">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557758">d</span><span class="op" id="4557759">.</span><span class="ident" id="4557760">tokens</span>&nbsp;<span class="op" id="4557767">=</span>&nbsp;<span class="builtinfunc" id="4557769">append</span><span class="op" id="4557775">(</span><span class="ident" id="4557776">d</span><span class="op" id="4557777">.</span><span class="ident" id="4557778">tokens</span><span class="op" id="4557784">,</span>&nbsp;<span class="ident" id="4557786">literalToken</span><span class="op" id="4557798">(</span><span class="builtintype" id="4557799">uint32</span><span class="op" id="4557805">(</span><span class="ident" id="4557806">d</span><span class="op" id="4557807">.</span><span class="ident" id="4557808">window</span><span class="op" id="4557814">[</span><span class="ident" id="4557815">i</span><span class="op" id="4557816">]</span><span class="op" id="4557817">)</span><span class="op" id="4557818">)</span><span class="op" id="4557819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557825">if</span>&nbsp;<span class="builtinfunc" id="4557828">len</span><span class="op" id="4557831">(</span><span class="ident" id="4557832">d</span><span class="op" id="4557833">.</span><span class="ident" id="4557834">tokens</span><span class="op" id="4557840">)</span>&nbsp;<span class="op" id="4557842">==</span>&nbsp;<span class="ident" id="4557845">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4557865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557872">if</span>&nbsp;<span class="ident" id="4557875">d</span><span class="op" id="4557876">.</span><span class="ident" id="4557877">err</span>&nbsp;<span class="op" id="4557881">=</span>&nbsp;<span class="ident" id="4557883">d</span><span class="op" id="4557884">.</span><span class="ident" id="4557885">writeBlock</span><span class="op" id="4557895">(</span><span class="ident" id="4557896">d</span><span class="op" id="4557897">.</span><span class="ident" id="4557898">tokens</span><span class="op" id="4557904">,</span>&nbsp;<span class="ident" id="4557906">i</span><span class="op" id="4557907">+</span><span class="num" id="4557908">1</span><span class="op" id="4557909">,</span>&nbsp;<span class="builtintype" id="4557911">false</span><span class="op" id="4557916">)</span><span class="op" id="4557917">;</span>&nbsp;<span class="ident" id="4557919">d</span><span class="op" id="4557920">.</span><span class="ident" id="4557921">err</span>&nbsp;<span class="op" id="4557925">!=</span>&nbsp;<span class="ident" id="4557928">nil</span>&nbsp;<span class="op" id="4557932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4557940">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557959">d</span><span class="op" id="4557960">.</span><span class="ident" id="4557961">tokens</span>&nbsp;<span class="op" id="4557968">=</span>&nbsp;<span class="ident" id="4557970">d</span><span class="op" id="4557971">.</span><span class="ident" id="4557972">tokens</span><span class="op" id="4557978">[</span><span class="op" id="4557979">:</span><span class="num" id="4557980">0</span><span class="op" id="4557981">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4557992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557997">d</span><span class="op" id="4557998">.</span><span class="ident" id="4557999">index</span><span class="op" id="4558004">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558010">if</span>&nbsp;<span class="ident" id="4558013">d</span><span class="op" id="4558014">.</span><span class="ident" id="4558015">fastSkipHashing</span>&nbsp;<span class="op" id="4558031">==</span>&nbsp;<span class="ident" id="4558034">skipNever</span>&nbsp;<span class="op" id="4558044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558050">d</span><span class="op" id="4558051">.</span><span class="ident" id="4558052">byteAvailable</span>&nbsp;<span class="op" id="4558066">=</span>&nbsp;<span class="builtintype" id="4558068">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558083">}</span><br>
<span class="lineno">360</span><span class="op" id="4558085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4558088">func</span>&nbsp;<span class="op" id="4558093">(</span><span class="ident" id="4558094">d</span>&nbsp;<span class="op" id="4558096">*</span><span class="ident" id="4558097">compressor</span><span class="op" id="4558107">)</span>&nbsp;<span class="ident" id="4558109">fillStore</span><span class="op" id="4558118">(</span><span class="ident" id="4558119">b</span>&nbsp;<span class="op" id="4558121">[</span><span class="op" id="4558122">]</span><span class="builtintype" id="4558123">byte</span><span class="op" id="4558127">)</span>&nbsp;<span class="builtintype" id="4558129">int</span>&nbsp;<span class="op" id="4558133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558136">n</span>&nbsp;<span class="op" id="4558138">:=</span>&nbsp;<span class="builtinfunc" id="4558141">copy</span><span class="op" id="4558145">(</span><span class="ident" id="4558146">d</span><span class="op" id="4558147">.</span><span class="ident" id="4558148">window</span><span class="op" id="4558154">[</span><span class="ident" id="4558155">d</span><span class="op" id="4558156">.</span><span class="ident" id="4558157">windowEnd</span><span class="op" id="4558166">:</span><span class="op" id="4558167">]</span><span class="op" id="4558168">,</span>&nbsp;<span class="ident" id="4558170">b</span><span class="op" id="4558171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558174">d</span><span class="op" id="4558175">.</span><span class="ident" id="4558176">windowEnd</span>&nbsp;<span class="op" id="4558186">+=</span>&nbsp;<span class="ident" id="4558189">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558192">return</span>&nbsp;<span class="ident" id="4558199">n</span><br>
<span class="lineno"></span><span class="op" id="4558201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4558204">func</span>&nbsp;<span class="op" id="4558209">(</span><span class="ident" id="4558210">d</span>&nbsp;<span class="op" id="4558212">*</span><span class="ident" id="4558213">compressor</span><span class="op" id="4558223">)</span>&nbsp;<span class="ident" id="4558225">store</span><span class="op" id="4558230">(</span><span class="op" id="4558231">)</span>&nbsp;<span class="op" id="4558233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558236">if</span>&nbsp;<span class="ident" id="4558239">d</span><span class="op" id="4558240">.</span><span class="ident" id="4558241">windowEnd</span>&nbsp;<span class="op" id="4558251">&gt;</span>&nbsp;<span class="num" id="4558253">0</span>&nbsp;<span class="op" id="4558255">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558259">d</span><span class="op" id="4558260">.</span><span class="ident" id="4558261">err</span>&nbsp;<span class="op" id="4558265">=</span>&nbsp;<span class="ident" id="4558267">d</span><span class="op" id="4558268">.</span><span class="ident" id="4558269">writeStoredBlock</span><span class="op" id="4558285">(</span><span class="ident" id="4558286">d</span><span class="op" id="4558287">.</span><span class="ident" id="4558288">window</span><span class="op" id="4558294">[</span><span class="op" id="4558295">:</span><span class="ident" id="4558296">d</span><span class="op" id="4558297">.</span><span class="ident" id="4558298">windowEnd</span><span class="op" id="4558307">]</span><span class="op" id="4558308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558314">d</span><span class="op" id="4558315">.</span><span class="ident" id="4558316">windowEnd</span>&nbsp;<span class="op" id="4558326">=</span>&nbsp;<span class="num" id="4558328">0</span><br>
<span class="lineno"></span><span class="op" id="4558330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4558333">func</span>&nbsp;<span class="op" id="4558338">(</span><span class="ident" id="4558339">d</span>&nbsp;<span class="op" id="4558341">*</span><span class="ident" id="4558342">compressor</span><span class="op" id="4558352">)</span>&nbsp;<span class="ident" id="4558354">write</span><span class="op" id="4558359">(</span><span class="ident" id="4558360">b</span>&nbsp;<span class="op" id="4558362">[</span><span class="op" id="4558363">]</span><span class="builtintype" id="4558364">byte</span><span class="op" id="4558368">)</span>&nbsp;<span class="op" id="4558370">(</span><span class="ident" id="4558371">n</span>&nbsp;<span class="builtintype" id="4558373">int</span><span class="op" id="4558376">,</span>&nbsp;<span class="ident" id="4558378">err</span>&nbsp;<span class="builtintype" id="4558382">error</span><span class="op" id="4558387">)</span>&nbsp;<span class="op" id="4558389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558392">n</span>&nbsp;<span class="op" id="4558394">=</span>&nbsp;<span class="builtinfunc" id="4558396">len</span><span class="op" id="4558399">(</span><span class="ident" id="4558400">b</span><span class="op" id="4558401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558404">b</span>&nbsp;<span class="op" id="4558406">=</span>&nbsp;<span class="ident" id="4558408">b</span><span class="op" id="4558409">[</span><span class="ident" id="4558410">d</span><span class="op" id="4558411">.</span><span class="ident" id="4558412">fill</span><span class="op" id="4558416">(</span><span class="ident" id="4558417">d</span><span class="op" id="4558418">,</span>&nbsp;<span class="ident" id="4558420">b</span><span class="op" id="4558421">)</span><span class="op" id="4558422">:</span><span class="op" id="4558423">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558426">for</span>&nbsp;<span class="builtinfunc" id="4558430">len</span><span class="op" id="4558433">(</span><span class="ident" id="4558434">b</span><span class="op" id="4558435">)</span>&nbsp;<span class="op" id="4558437">&gt;</span>&nbsp;<span class="num" id="4558439">0</span>&nbsp;<span class="op" id="4558441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558445">d</span><span class="op" id="4558446">.</span><span class="ident" id="4558447">step</span><span class="op" id="4558451">(</span><span class="ident" id="4558452">d</span><span class="op" id="4558453">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558457">b</span>&nbsp;<span class="op" id="4558459">=</span>&nbsp;<span class="ident" id="4558461">b</span><span class="op" id="4558462">[</span><span class="ident" id="4558463">d</span><span class="op" id="4558464">.</span><span class="ident" id="4558465">fill</span><span class="op" id="4558469">(</span><span class="ident" id="4558470">d</span><span class="op" id="4558471">,</span>&nbsp;<span class="ident" id="4558473">b</span><span class="op" id="4558474">)</span><span class="op" id="4558475">:</span><span class="op" id="4558476">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558482">return</span>&nbsp;<span class="ident" id="4558489">n</span><span class="op" id="4558490">,</span>&nbsp;<span class="ident" id="4558492">d</span><span class="op" id="4558493">.</span><span class="ident" id="4558494">err</span><br>
<span class="lineno"></span><span class="op" id="4558498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4558501">func</span>&nbsp;<span class="op" id="4558506">(</span><span class="ident" id="4558507">d</span>&nbsp;<span class="op" id="4558509">*</span><span class="ident" id="4558510">compressor</span><span class="op" id="4558520">)</span>&nbsp;<span class="ident" id="4558522">syncFlush</span><span class="op" id="4558531">(</span><span class="op" id="4558532">)</span>&nbsp;<span class="builtintype" id="4558534">error</span>&nbsp;<span class="op" id="4558540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558543">d</span><span class="op" id="4558544">.</span><span class="ident" id="4558545">sync</span>&nbsp;<span class="op" id="4558550">=</span>&nbsp;<span class="builtintype" id="4558552">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558558">d</span><span class="op" id="4558559">.</span><span class="ident" id="4558560">step</span><span class="op" id="4558564">(</span><span class="ident" id="4558565">d</span><span class="op" id="4558566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558569">if</span>&nbsp;<span class="ident" id="4558572">d</span><span class="op" id="4558573">.</span><span class="ident" id="4558574">err</span>&nbsp;<span class="op" id="4558578">==</span>&nbsp;<span class="ident" id="4558581">nil</span>&nbsp;<span class="op" id="4558585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558589">d</span><span class="op" id="4558590">.</span><span class="ident" id="4558591">w</span><span class="op" id="4558592">.</span><span class="ident" id="4558593">writeStoredHeader</span><span class="op" id="4558610">(</span><span class="num" id="4558611">0</span><span class="op" id="4558612">,</span>&nbsp;<span class="builtintype" id="4558614">false</span><span class="op" id="4558619">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558623">d</span><span class="op" id="4558624">.</span><span class="ident" id="4558625">w</span><span class="op" id="4558626">.</span><span class="ident" id="4558627">flush</span><span class="op" id="4558632">(</span><span class="op" id="4558633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558637">d</span><span class="op" id="4558638">.</span><span class="ident" id="4558639">err</span>&nbsp;<span class="op" id="4558643">=</span>&nbsp;<span class="ident" id="4558645">d</span><span class="op" id="4558646">.</span><span class="ident" id="4558647">w</span><span class="op" id="4558648">.</span><span class="ident" id="4558649">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558657">d</span><span class="op" id="4558658">.</span><span class="ident" id="4558659">sync</span>&nbsp;<span class="op" id="4558664">=</span>&nbsp;<span class="builtintype" id="4558666">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558673">return</span>&nbsp;<span class="ident" id="4558680">d</span><span class="op" id="4558681">.</span><span class="ident" id="4558682">err</span><br>
<span class="lineno">395</span><span class="op" id="4558686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4558689">func</span>&nbsp;<span class="op" id="4558694">(</span><span class="ident" id="4558695">d</span>&nbsp;<span class="op" id="4558697">*</span><span class="ident" id="4558698">compressor</span><span class="op" id="4558708">)</span>&nbsp;<span class="ident" id="4558710">init</span><span class="op" id="4558714">(</span><span class="ident" id="4558715">w</span>&nbsp;<span class="ident" id="4558717">io</span><span class="op" id="4558719">.</span><span class="ident" id="4558720">Writer</span><span class="op" id="4558726">,</span>&nbsp;<span class="ident" id="4558728">level</span>&nbsp;<span class="builtintype" id="4558734">int</span><span class="op" id="4558737">)</span>&nbsp;<span class="op" id="4558739">(</span><span class="ident" id="4558740">err</span>&nbsp;<span class="builtintype" id="4558744">error</span><span class="op" id="4558749">)</span>&nbsp;<span class="op" id="4558751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558754">d</span><span class="op" id="4558755">.</span><span class="ident" id="4558756">w</span>&nbsp;<span class="op" id="4558758">=</span>&nbsp;<span class="ident" id="4558760">newHuffmanBitWriter</span><span class="op" id="4558779">(</span><span class="ident" id="4558780">w</span><span class="op" id="4558781">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558785">switch</span>&nbsp;<span class="op" id="4558792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558795">case</span>&nbsp;<span class="ident" id="4558800">level</span>&nbsp;<span class="op" id="4558806">==</span>&nbsp;<span class="ident" id="4558809">NoCompression</span><span class="op" id="4558822">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558826">d</span><span class="op" id="4558827">.</span><span class="ident" id="4558828">window</span>&nbsp;<span class="op" id="4558835">=</span>&nbsp;<span class="builtinfunc" id="4558837">make</span><span class="op" id="4558841">(</span><span class="op" id="4558842">[</span><span class="op" id="4558843">]</span><span class="builtintype" id="4558844">byte</span><span class="op" id="4558848">,</span>&nbsp;<span class="ident" id="4558850">maxStoreBlockSize</span><span class="op" id="4558867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558871">d</span><span class="op" id="4558872">.</span><span class="ident" id="4558873">fill</span>&nbsp;<span class="op" id="4558878">=</span>&nbsp;<span class="op" id="4558880">(</span><span class="op" id="4558881">*</span><span class="ident" id="4558882">compressor</span><span class="op" id="4558892">)</span><span class="op" id="4558893">.</span><span class="ident" id="4558894">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558906">d</span><span class="op" id="4558907">.</span><span class="ident" id="4558908">step</span>&nbsp;<span class="op" id="4558913">=</span>&nbsp;<span class="op" id="4558915">(</span><span class="op" id="4558916">*</span><span class="ident" id="4558917">compressor</span><span class="op" id="4558927">)</span><span class="op" id="4558928">.</span><span class="ident" id="4558929">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558936">case</span>&nbsp;<span class="ident" id="4558941">level</span>&nbsp;<span class="op" id="4558947">==</span>&nbsp;<span class="ident" id="4558950">DefaultCompression</span><span class="op" id="4558968">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558972">level</span>&nbsp;<span class="op" id="4558978">=</span>&nbsp;<span class="num" id="4558980">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558984">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558997">case</span>&nbsp;<span class="num" id="4559002">1</span>&nbsp;<span class="op" id="4559004">&lt;=</span>&nbsp;<span class="ident" id="4559007">level</span>&nbsp;<span class="op" id="4559013">&amp;&amp;</span>&nbsp;<span class="ident" id="4559016">level</span>&nbsp;<span class="op" id="4559022">&lt;=</span>&nbsp;<span class="num" id="4559025">9</span><span class="op" id="4559026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559030">d</span><span class="op" id="4559031">.</span><span class="ident" id="4559032">compressionLevel</span>&nbsp;<span class="op" id="4559049">=</span>&nbsp;<span class="ident" id="4559051">levels</span><span class="op" id="4559057">[</span><span class="ident" id="4559058">level</span><span class="op" id="4559063">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559067">d</span><span class="op" id="4559068">.</span><span class="ident" id="4559069">initDeflate</span><span class="op" id="4559080">(</span><span class="op" id="4559081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559085">d</span><span class="op" id="4559086">.</span><span class="ident" id="4559087">fill</span>&nbsp;<span class="op" id="4559092">=</span>&nbsp;<span class="op" id="4559094">(</span><span class="op" id="4559095">*</span><span class="ident" id="4559096">compressor</span><span class="op" id="4559106">)</span><span class="op" id="4559107">.</span><span class="ident" id="4559108">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559122">d</span><span class="op" id="4559123">.</span><span class="ident" id="4559124">step</span>&nbsp;<span class="op" id="4559129">=</span>&nbsp;<span class="op" id="4559131">(</span><span class="op" id="4559132">*</span><span class="ident" id="4559133">compressor</span><span class="op" id="4559143">)</span><span class="op" id="4559144">.</span><span class="ident" id="4559145">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559154">default</span><span class="op" id="4559161">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559165">return</span>&nbsp;<span class="ident" id="4559172">fmt</span><span class="op" id="4559175">.</span><span class="ident" id="4559176">Errorf</span><span class="op" id="4559182">(</span><span class="string" id="4559183">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4559249">,</span>&nbsp;<span class="ident" id="4559251">level</span><span class="op" id="4559256">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559262">return</span>&nbsp;<span class="ident" id="4559269">nil</span><br>
<span class="lineno"></span><span class="op" id="4559273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4559276">var</span>&nbsp;<span class="ident" id="4559280">zeroes</span>&nbsp;<span class="op" id="4559287">[</span><span class="num" id="4559288">32</span><span class="op" id="4559290">]</span><span class="builtintype" id="4559291">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4559295">var</span>&nbsp;<span class="ident" id="4559299">bzeroes</span>&nbsp;<span class="op" id="4559307">[</span><span class="num" id="4559308">256</span><span class="op" id="4559311">]</span><span class="builtintype" id="4559312">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4559318">func</span>&nbsp;<span class="op" id="4559323">(</span><span class="ident" id="4559324">d</span>&nbsp;<span class="op" id="4559326">*</span><span class="ident" id="4559327">compressor</span><span class="op" id="4559337">)</span>&nbsp;<span class="ident" id="4559339">reset</span><span class="op" id="4559344">(</span><span class="ident" id="4559345">w</span>&nbsp;<span class="ident" id="4559347">io</span><span class="op" id="4559349">.</span><span class="ident" id="4559350">Writer</span><span class="op" id="4559356">)</span>&nbsp;<span class="op" id="4559358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559361">d</span><span class="op" id="4559362">.</span><span class="ident" id="4559363">w</span><span class="op" id="4559364">.</span><span class="ident" id="4559365">reset</span><span class="op" id="4559370">(</span><span class="ident" id="4559371">w</span><span class="op" id="4559372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559375">d</span><span class="op" id="4559376">.</span><span class="ident" id="4559377">sync</span>&nbsp;<span class="op" id="4559382">=</span>&nbsp;<span class="builtintype" id="4559384">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559391">d</span><span class="op" id="4559392">.</span><span class="ident" id="4559393">err</span>&nbsp;<span class="op" id="4559397">=</span>&nbsp;<span class="ident" id="4559399">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559404">switch</span>&nbsp;<span class="ident" id="4559411">d</span><span class="op" id="4559412">.</span><span class="ident" id="4559413">compressionLevel</span><span class="op" id="4559429">.</span><span class="ident" id="4559430">chain</span>&nbsp;<span class="op" id="4559436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559439">case</span>&nbsp;<span class="num" id="4559444">0</span><span class="op" id="4559445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4559449">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559479">for</span>&nbsp;<span class="ident" id="4559483">i</span>&nbsp;<span class="op" id="4559485">:=</span>&nbsp;<span class="keyword" id="4559488">range</span>&nbsp;<span class="ident" id="4559494">d</span><span class="op" id="4559495">.</span><span class="ident" id="4559496">window</span>&nbsp;<span class="op" id="4559503">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559508">d</span><span class="op" id="4559509">.</span><span class="ident" id="4559510">window</span><span class="op" id="4559516">[</span><span class="ident" id="4559517">i</span><span class="op" id="4559518">]</span>&nbsp;<span class="op" id="4559520">=</span>&nbsp;<span class="num" id="4559522">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559530">d</span><span class="op" id="4559531">.</span><span class="ident" id="4559532">windowEnd</span>&nbsp;<span class="op" id="4559542">=</span>&nbsp;<span class="num" id="4559544">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559547">default</span><span class="op" id="4559554">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559558">d</span><span class="op" id="4559559">.</span><span class="ident" id="4559560">chainHead</span>&nbsp;<span class="op" id="4559570">=</span>&nbsp;<span class="op" id="4559572">-</span><span class="num" id="4559573">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559577">for</span>&nbsp;<span class="ident" id="4559581">s</span>&nbsp;<span class="op" id="4559583">:=</span>&nbsp;<span class="ident" id="4559586">d</span><span class="op" id="4559587">.</span><span class="ident" id="4559588">hashHead</span><span class="op" id="4559596">;</span>&nbsp;<span class="builtinfunc" id="4559598">len</span><span class="op" id="4559601">(</span><span class="ident" id="4559602">s</span><span class="op" id="4559603">)</span>&nbsp;<span class="op" id="4559605">&gt;</span>&nbsp;<span class="num" id="4559607">0</span><span class="op" id="4559608">;</span>&nbsp;<span class="op" id="4559610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559615">n</span>&nbsp;<span class="op" id="4559617">:=</span>&nbsp;<span class="builtinfunc" id="4559620">copy</span><span class="op" id="4559624">(</span><span class="ident" id="4559625">s</span><span class="op" id="4559626">,</span>&nbsp;<span class="ident" id="4559628">zeroes</span><span class="op" id="4559634">[</span><span class="op" id="4559635">:</span><span class="op" id="4559636">]</span><span class="op" id="4559637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559642">s</span>&nbsp;<span class="op" id="4559644">=</span>&nbsp;<span class="ident" id="4559646">s</span><span class="op" id="4559647">[</span><span class="ident" id="4559648">n</span><span class="op" id="4559649">:</span><span class="op" id="4559650">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559658">for</span>&nbsp;<span class="ident" id="4559662">s</span>&nbsp;<span class="op" id="4559664">:=</span>&nbsp;<span class="ident" id="4559667">d</span><span class="op" id="4559668">.</span><span class="ident" id="4559669">hashPrev</span><span class="op" id="4559677">;</span>&nbsp;<span class="builtinfunc" id="4559679">len</span><span class="op" id="4559682">(</span><span class="ident" id="4559683">s</span><span class="op" id="4559684">)</span>&nbsp;<span class="op" id="4559686">&gt;</span>&nbsp;<span class="num" id="4559688">0</span><span class="op" id="4559689">;</span>&nbsp;<span class="ident" id="4559691">s</span>&nbsp;<span class="op" id="4559693">=</span>&nbsp;<span class="ident" id="4559695">s</span><span class="op" id="4559696">[</span><span class="builtinfunc" id="4559697">len</span><span class="op" id="4559700">(</span><span class="ident" id="4559701">zeroes</span><span class="op" id="4559707">)</span><span class="op" id="4559708">:</span><span class="op" id="4559709">]</span>&nbsp;<span class="op" id="4559711">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4559716">copy</span><span class="op" id="4559720">(</span><span class="ident" id="4559721">s</span><span class="op" id="4559722">,</span>&nbsp;<span class="ident" id="4559724">zeroes</span><span class="op" id="4559730">[</span><span class="op" id="4559731">:</span><span class="op" id="4559732">]</span><span class="op" id="4559733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559741">d</span><span class="op" id="4559742">.</span><span class="ident" id="4559743">hashOffset</span>&nbsp;<span class="op" id="4559754">=</span>&nbsp;<span class="num" id="4559756">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559761">d</span><span class="op" id="4559762">.</span><span class="ident" id="4559763">index</span><span class="op" id="4559768">,</span>&nbsp;<span class="ident" id="4559770">d</span><span class="op" id="4559771">.</span><span class="ident" id="4559772">windowEnd</span>&nbsp;<span class="op" id="4559782">=</span>&nbsp;<span class="num" id="4559784">0</span><span class="op" id="4559785">,</span>&nbsp;<span class="num" id="4559787">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559791">for</span>&nbsp;<span class="ident" id="4559795">s</span>&nbsp;<span class="op" id="4559797">:=</span>&nbsp;<span class="ident" id="4559800">d</span><span class="op" id="4559801">.</span><span class="ident" id="4559802">window</span><span class="op" id="4559808">;</span>&nbsp;<span class="builtinfunc" id="4559810">len</span><span class="op" id="4559813">(</span><span class="ident" id="4559814">s</span><span class="op" id="4559815">)</span>&nbsp;<span class="op" id="4559817">&gt;</span>&nbsp;<span class="num" id="4559819">0</span><span class="op" id="4559820">;</span>&nbsp;<span class="op" id="4559822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559827">n</span>&nbsp;<span class="op" id="4559829">:=</span>&nbsp;<span class="builtinfunc" id="4559832">copy</span><span class="op" id="4559836">(</span><span class="ident" id="4559837">s</span><span class="op" id="4559838">,</span>&nbsp;<span class="ident" id="4559840">bzeroes</span><span class="op" id="4559847">[</span><span class="op" id="4559848">:</span><span class="op" id="4559849">]</span><span class="op" id="4559850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559855">s</span>&nbsp;<span class="op" id="4559857">=</span>&nbsp;<span class="ident" id="4559859">s</span><span class="op" id="4559860">[</span><span class="ident" id="4559861">n</span><span class="op" id="4559862">:</span><span class="op" id="4559863">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559871">d</span><span class="op" id="4559872">.</span><span class="ident" id="4559873">blockStart</span><span class="op" id="4559883">,</span>&nbsp;<span class="ident" id="4559885">d</span><span class="op" id="4559886">.</span><span class="ident" id="4559887">byteAvailable</span>&nbsp;<span class="op" id="4559901">=</span>&nbsp;<span class="num" id="4559903">0</span><span class="op" id="4559904">,</span>&nbsp;<span class="builtintype" id="4559906">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559915">d</span><span class="op" id="4559916">.</span><span class="ident" id="4559917">tokens</span>&nbsp;<span class="op" id="4559924">=</span>&nbsp;<span class="ident" id="4559926">d</span><span class="op" id="4559927">.</span><span class="ident" id="4559928">tokens</span><span class="op" id="4559934">[</span><span class="op" id="4559935">:</span><span class="ident" id="4559936">maxFlateBlockTokens</span><span class="op" id="4559955">+</span><span class="num" id="4559956">1</span><span class="op" id="4559957">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559961">for</span>&nbsp;<span class="ident" id="4559965">i</span>&nbsp;<span class="op" id="4559967">:=</span>&nbsp;<span class="num" id="4559970">0</span><span class="op" id="4559971">;</span>&nbsp;<span class="ident" id="4559973">i</span>&nbsp;<span class="op" id="4559975">&lt;=</span>&nbsp;<span class="ident" id="4559978">maxFlateBlockTokens</span><span class="op" id="4559997">;</span>&nbsp;<span class="ident" id="4559999">i</span><span class="op" id="4560000">++</span>&nbsp;<span class="op" id="4560003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560008">d</span><span class="op" id="4560009">.</span><span class="ident" id="4560010">tokens</span><span class="op" id="4560016">[</span><span class="ident" id="4560017">i</span><span class="op" id="4560018">]</span>&nbsp;<span class="op" id="4560020">=</span>&nbsp;<span class="num" id="4560022">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560026">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560030">d</span><span class="op" id="4560031">.</span><span class="ident" id="4560032">tokens</span>&nbsp;<span class="op" id="4560039">=</span>&nbsp;<span class="ident" id="4560041">d</span><span class="op" id="4560042">.</span><span class="ident" id="4560043">tokens</span><span class="op" id="4560049">[</span><span class="op" id="4560050">:</span><span class="num" id="4560051">0</span><span class="op" id="4560052">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560056">d</span><span class="op" id="4560057">.</span><span class="ident" id="4560058">length</span>&nbsp;<span class="op" id="4560065">=</span>&nbsp;<span class="ident" id="4560067">minMatchLength</span>&nbsp;<span class="op" id="4560082">-</span>&nbsp;<span class="num" id="4560084">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560088">d</span><span class="op" id="4560089">.</span><span class="ident" id="4560090">offset</span>&nbsp;<span class="op" id="4560097">=</span>&nbsp;<span class="num" id="4560099">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560103">d</span><span class="op" id="4560104">.</span><span class="ident" id="4560105">hash</span>&nbsp;<span class="op" id="4560110">=</span>&nbsp;<span class="num" id="4560112">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560116">d</span><span class="op" id="4560117">.</span><span class="ident" id="4560118">maxInsertIndex</span>&nbsp;<span class="op" id="4560133">=</span>&nbsp;<span class="num" id="4560135">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560138">}</span><br>
<span class="lineno"></span><span class="op" id="4560140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4560143">func</span>&nbsp;<span class="op" id="4560148">(</span><span class="ident" id="4560149">d</span>&nbsp;<span class="op" id="4560151">*</span><span class="ident" id="4560152">compressor</span><span class="op" id="4560162">)</span>&nbsp;<span class="builtinfunc" id="4560164">close</span><span class="op" id="4560169">(</span><span class="op" id="4560170">)</span>&nbsp;<span class="builtintype" id="4560172">error</span>&nbsp;<span class="op" id="4560178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560181">d</span><span class="op" id="4560182">.</span><span class="ident" id="4560183">sync</span>&nbsp;<span class="op" id="4560188">=</span>&nbsp;<span class="builtintype" id="4560190">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560196">d</span><span class="op" id="4560197">.</span><span class="ident" id="4560198">step</span><span class="op" id="4560202">(</span><span class="ident" id="4560203">d</span><span class="op" id="4560204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560207">if</span>&nbsp;<span class="ident" id="4560210">d</span><span class="op" id="4560211">.</span><span class="ident" id="4560212">err</span>&nbsp;<span class="op" id="4560216">!=</span>&nbsp;<span class="ident" id="4560219">nil</span>&nbsp;<span class="op" id="4560223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560227">return</span>&nbsp;<span class="ident" id="4560234">d</span><span class="op" id="4560235">.</span><span class="ident" id="4560236">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560244">if</span>&nbsp;<span class="ident" id="4560247">d</span><span class="op" id="4560248">.</span><span class="ident" id="4560249">w</span><span class="op" id="4560250">.</span><span class="ident" id="4560251">writeStoredHeader</span><span class="op" id="4560268">(</span><span class="num" id="4560269">0</span><span class="op" id="4560270">,</span>&nbsp;<span class="builtintype" id="4560272">true</span><span class="op" id="4560276">)</span><span class="op" id="4560277">;</span>&nbsp;<span class="ident" id="4560279">d</span><span class="op" id="4560280">.</span><span class="ident" id="4560281">w</span><span class="op" id="4560282">.</span><span class="ident" id="4560283">err</span>&nbsp;<span class="op" id="4560287">!=</span>&nbsp;<span class="ident" id="4560290">nil</span>&nbsp;<span class="op" id="4560294">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560298">return</span>&nbsp;<span class="ident" id="4560305">d</span><span class="op" id="4560306">.</span><span class="ident" id="4560307">w</span><span class="op" id="4560308">.</span><span class="ident" id="4560309">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560317">d</span><span class="op" id="4560318">.</span><span class="ident" id="4560319">w</span><span class="op" id="4560320">.</span><span class="ident" id="4560321">flush</span><span class="op" id="4560326">(</span><span class="op" id="4560327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560330">return</span>&nbsp;<span class="ident" id="4560337">d</span><span class="op" id="4560338">.</span><span class="ident" id="4560339">w</span><span class="op" id="4560340">.</span><span class="ident" id="4560341">err</span><br>
<span class="lineno"></span><span class="op" id="4560345">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4560348">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4560419">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4560494">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4560559">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4560629">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4560706">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4560728">//</span><br>
<span class="lineno"></span><span class="comment" id="4560731">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4560804">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4560853">func</span>&nbsp;<span class="ident" id="4560858">NewWriter</span><span class="op" id="4560867">(</span><span class="ident" id="4560868">w</span>&nbsp;<span class="ident" id="4560870">io</span><span class="op" id="4560872">.</span><span class="ident" id="4560873">Writer</span><span class="op" id="4560879">,</span>&nbsp;<span class="ident" id="4560881">level</span>&nbsp;<span class="builtintype" id="4560887">int</span><span class="op" id="4560890">)</span>&nbsp;<span class="op" id="4560892">(</span><span class="op" id="4560893">*</span><span class="ident" id="4560894">Writer</span><span class="op" id="4560900">,</span>&nbsp;<span class="builtintype" id="4560902">error</span><span class="op" id="4560907">)</span>&nbsp;<span class="op" id="4560909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560912">var</span>&nbsp;<span class="ident" id="4560916">dw</span>&nbsp;<span class="ident" id="4560919">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560927">if</span>&nbsp;<span class="ident" id="4560930">err</span>&nbsp;<span class="op" id="4560934">:=</span>&nbsp;<span class="ident" id="4560937">dw</span><span class="op" id="4560939">.</span><span class="ident" id="4560940">d</span><span class="op" id="4560941">.</span><span class="ident" id="4560942">init</span><span class="op" id="4560946">(</span><span class="ident" id="4560947">w</span><span class="op" id="4560948">,</span>&nbsp;<span class="ident" id="4560950">level</span><span class="op" id="4560955">)</span><span class="op" id="4560956">;</span>&nbsp;<span class="ident" id="4560958">err</span>&nbsp;<span class="op" id="4560962">!=</span>&nbsp;<span class="ident" id="4560965">nil</span>&nbsp;<span class="op" id="4560969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560973">return</span>&nbsp;<span class="ident" id="4560980">nil</span><span class="op" id="4560983">,</span>&nbsp;<span class="ident" id="4560985">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560990">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560993">return</span>&nbsp;<span class="op" id="4561000">&amp;</span><span class="ident" id="4561001">dw</span><span class="op" id="4561003">,</span>&nbsp;<span class="ident" id="4561005">nil</span><br>
<span class="lineno"></span><span class="op" id="4561009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4561012">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4561071">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4561136">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4561201">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4561261">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4561322">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4561342">func</span>&nbsp;<span class="ident" id="4561347">NewWriterDict</span><span class="op" id="4561360">(</span><span class="ident" id="4561361">w</span>&nbsp;<span class="ident" id="4561363">io</span><span class="op" id="4561365">.</span><span class="ident" id="4561366">Writer</span><span class="op" id="4561372">,</span>&nbsp;<span class="ident" id="4561374">level</span>&nbsp;<span class="builtintype" id="4561380">int</span><span class="op" id="4561383">,</span>&nbsp;<span class="ident" id="4561385">dict</span>&nbsp;<span class="op" id="4561390">[</span><span class="op" id="4561391">]</span><span class="builtintype" id="4561392">byte</span><span class="op" id="4561396">)</span>&nbsp;<span class="op" id="4561398">(</span><span class="op" id="4561399">*</span><span class="ident" id="4561400">Writer</span><span class="op" id="4561406">,</span>&nbsp;<span class="builtintype" id="4561408">error</span><span class="op" id="4561413">)</span>&nbsp;<span class="op" id="4561415">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561418">dw</span>&nbsp;<span class="op" id="4561421">:=</span>&nbsp;<span class="op" id="4561424">&amp;</span><span class="ident" id="4561425">dictWriter</span><span class="op" id="4561435">{</span><span class="ident" id="4561436">w</span><span class="op" id="4561437">,</span>&nbsp;<span class="builtintype" id="4561439">false</span><span class="op" id="4561444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561447">zw</span><span class="op" id="4561449">,</span>&nbsp;<span class="ident" id="4561451">err</span>&nbsp;<span class="op" id="4561455">:=</span>&nbsp;<span class="ident" id="4561458">NewWriter</span><span class="op" id="4561467">(</span><span class="ident" id="4561468">dw</span><span class="op" id="4561470">,</span>&nbsp;<span class="ident" id="4561472">level</span><span class="op" id="4561477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561480">if</span>&nbsp;<span class="ident" id="4561483">err</span>&nbsp;<span class="op" id="4561487">!=</span>&nbsp;<span class="ident" id="4561490">nil</span>&nbsp;<span class="op" id="4561494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561498">return</span>&nbsp;<span class="ident" id="4561505">nil</span><span class="op" id="4561508">,</span>&nbsp;<span class="ident" id="4561510">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561515">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561518">zw</span><span class="op" id="4561520">.</span><span class="ident" id="4561521">Write</span><span class="op" id="4561526">(</span><span class="ident" id="4561527">dict</span><span class="op" id="4561531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561534">zw</span><span class="op" id="4561536">.</span><span class="ident" id="4561537">Flush</span><span class="op" id="4561542">(</span><span class="op" id="4561543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561546">dw</span><span class="op" id="4561548">.</span><span class="ident" id="4561549">enabled</span>&nbsp;<span class="op" id="4561557">=</span>&nbsp;<span class="builtintype" id="4561559">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561565">zw</span><span class="op" id="4561567">.</span><span class="ident" id="4561568">dict</span>&nbsp;<span class="op" id="4561573">=</span>&nbsp;<span class="builtinfunc" id="4561575">append</span><span class="op" id="4561581">(</span><span class="ident" id="4561582">zw</span><span class="op" id="4561584">.</span><span class="ident" id="4561585">dict</span><span class="op" id="4561589">,</span>&nbsp;<span class="ident" id="4561591">dict</span><span class="op" id="4561595">...</span><span class="op" id="4561598">)</span>&nbsp;<span class="comment" id="4561600">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561643">return</span>&nbsp;<span class="ident" id="4561650">zw</span><span class="op" id="4561652">,</span>&nbsp;<span class="ident" id="4561654">err</span><br>
<span class="lineno">510</span><span class="op" id="4561658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4561661">type</span>&nbsp;<span class="ident" id="4561666">dictWriter</span>&nbsp;<span class="keyword" id="4561677">struct</span>&nbsp;<span class="op" id="4561684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561687">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4561695">io</span><span class="op" id="4561697">.</span><span class="ident" id="4561698">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561706">enabled</span>&nbsp;<span class="builtintype" id="4561714">bool</span><br>
<span class="lineno">515</span><span class="op" id="4561719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4561722">func</span>&nbsp;<span class="op" id="4561727">(</span><span class="ident" id="4561728">w</span>&nbsp;<span class="op" id="4561730">*</span><span class="ident" id="4561731">dictWriter</span><span class="op" id="4561741">)</span>&nbsp;<span class="ident" id="4561743">Write</span><span class="op" id="4561748">(</span><span class="ident" id="4561749">b</span>&nbsp;<span class="op" id="4561751">[</span><span class="op" id="4561752">]</span><span class="builtintype" id="4561753">byte</span><span class="op" id="4561757">)</span>&nbsp;<span class="op" id="4561759">(</span><span class="ident" id="4561760">n</span>&nbsp;<span class="builtintype" id="4561762">int</span><span class="op" id="4561765">,</span>&nbsp;<span class="ident" id="4561767">err</span>&nbsp;<span class="builtintype" id="4561771">error</span><span class="op" id="4561776">)</span>&nbsp;<span class="op" id="4561778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561781">if</span>&nbsp;<span class="ident" id="4561784">w</span><span class="op" id="4561785">.</span><span class="ident" id="4561786">enabled</span>&nbsp;<span class="op" id="4561794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561798">return</span>&nbsp;<span class="ident" id="4561805">w</span><span class="op" id="4561806">.</span><span class="ident" id="4561807">w</span><span class="op" id="4561808">.</span><span class="ident" id="4561809">Write</span><span class="op" id="4561814">(</span><span class="ident" id="4561815">b</span><span class="op" id="4561816">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561822">return</span>&nbsp;<span class="builtinfunc" id="4561829">len</span><span class="op" id="4561832">(</span><span class="ident" id="4561833">b</span><span class="op" id="4561834">)</span><span class="op" id="4561835">,</span>&nbsp;<span class="ident" id="4561837">nil</span><br>
<span class="lineno"></span><span class="op" id="4561841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4561844">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4561907">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4561969">type</span>&nbsp;<span class="ident" id="4561974">Writer</span>&nbsp;<span class="keyword" id="4561981">struct</span>&nbsp;<span class="op" id="4561988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561991">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4561996">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562008">dict</span>&nbsp;<span class="op" id="4562013">[</span><span class="op" id="4562014">]</span><span class="builtintype" id="4562015">byte</span><br>
<span class="lineno"></span><span class="op" id="4562020">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4562023">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4562082">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4562135">func</span>&nbsp;<span class="op" id="4562140">(</span><span class="ident" id="4562141">w</span>&nbsp;<span class="op" id="4562143">*</span><span class="ident" id="4562144">Writer</span><span class="op" id="4562150">)</span>&nbsp;<span class="ident" id="4562152">Write</span><span class="op" id="4562157">(</span><span class="ident" id="4562158">data</span>&nbsp;<span class="op" id="4562163">[</span><span class="op" id="4562164">]</span><span class="builtintype" id="4562165">byte</span><span class="op" id="4562169">)</span>&nbsp;<span class="op" id="4562171">(</span><span class="ident" id="4562172">n</span>&nbsp;<span class="builtintype" id="4562174">int</span><span class="op" id="4562177">,</span>&nbsp;<span class="ident" id="4562179">err</span>&nbsp;<span class="builtintype" id="4562183">error</span><span class="op" id="4562188">)</span>&nbsp;<span class="op" id="4562190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562193">return</span>&nbsp;<span class="ident" id="4562200">w</span><span class="op" id="4562201">.</span><span class="ident" id="4562202">d</span><span class="op" id="4562203">.</span><span class="ident" id="4562204">write</span><span class="op" id="4562209">(</span><span class="ident" id="4562210">data</span><span class="op" id="4562214">)</span><br>
<span class="lineno">535</span><span class="op" id="4562216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4562219">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4562290">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4562361">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4562421">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4562479">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4562551">//</span><br>
<span class="lineno"></span><span class="comment" id="4562554">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4562634">func</span>&nbsp;<span class="op" id="4562639">(</span><span class="ident" id="4562640">w</span>&nbsp;<span class="op" id="4562642">*</span><span class="ident" id="4562643">Writer</span><span class="op" id="4562649">)</span>&nbsp;<span class="ident" id="4562651">Flush</span><span class="op" id="4562656">(</span><span class="op" id="4562657">)</span>&nbsp;<span class="builtintype" id="4562659">error</span>&nbsp;<span class="op" id="4562665">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4562668">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4562697">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562749">return</span>&nbsp;<span class="ident" id="4562756">w</span><span class="op" id="4562757">.</span><span class="ident" id="4562758">d</span><span class="op" id="4562759">.</span><span class="ident" id="4562760">syncFlush</span><span class="op" id="4562769">(</span><span class="op" id="4562770">)</span><br>
<span class="lineno"></span><span class="op" id="4562772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4562775">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4562815">func</span>&nbsp;<span class="op" id="4562820">(</span><span class="ident" id="4562821">w</span>&nbsp;<span class="op" id="4562823">*</span><span class="ident" id="4562824">Writer</span><span class="op" id="4562830">)</span>&nbsp;<span class="ident" id="4562832">Close</span><span class="op" id="4562837">(</span><span class="op" id="4562838">)</span>&nbsp;<span class="builtintype" id="4562840">error</span>&nbsp;<span class="op" id="4562846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562849">return</span>&nbsp;<span class="ident" id="4562856">w</span><span class="op" id="4562857">.</span><span class="ident" id="4562858">d</span><span class="op" id="4562859">.</span><span class="builtinfunc" id="4562860">close</span><span class="op" id="4562865">(</span><span class="op" id="4562866">)</span><br>
<span class="lineno"></span><span class="op" id="4562868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4562871">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4562935">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4562995">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4563028">func</span>&nbsp;<span class="op" id="4563033">(</span><span class="ident" id="4563034">w</span>&nbsp;<span class="op" id="4563036">*</span><span class="ident" id="4563037">Writer</span><span class="op" id="4563043">)</span>&nbsp;<span class="ident" id="4563045">Reset</span><span class="op" id="4563050">(</span><span class="ident" id="4563051">dst</span>&nbsp;<span class="ident" id="4563055">io</span><span class="op" id="4563057">.</span><span class="ident" id="4563058">Writer</span><span class="op" id="4563064">)</span>&nbsp;<span class="op" id="4563066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563069">if</span>&nbsp;<span class="ident" id="4563072">dw</span><span class="op" id="4563074">,</span>&nbsp;<span class="ident" id="4563076">ok</span>&nbsp;<span class="op" id="4563079">:=</span>&nbsp;<span class="ident" id="4563082">w</span><span class="op" id="4563083">.</span><span class="ident" id="4563084">d</span><span class="op" id="4563085">.</span><span class="ident" id="4563086">w</span><span class="op" id="4563087">.</span><span class="ident" id="4563088">w</span><span class="op" id="4563089">.</span><span class="op" id="4563090">(</span><span class="op" id="4563091">*</span><span class="ident" id="4563092">dictWriter</span><span class="op" id="4563102">)</span><span class="op" id="4563103">;</span>&nbsp;<span class="ident" id="4563105">ok</span>&nbsp;<span class="op" id="4563108">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4563112">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563150">dw</span><span class="op" id="4563152">.</span><span class="ident" id="4563153">w</span>&nbsp;<span class="op" id="4563155">=</span>&nbsp;<span class="ident" id="4563157">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563163">w</span><span class="op" id="4563164">.</span><span class="ident" id="4563165">d</span><span class="op" id="4563166">.</span><span class="ident" id="4563167">reset</span><span class="op" id="4563172">(</span><span class="ident" id="4563173">dw</span><span class="op" id="4563175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563179">dw</span><span class="op" id="4563181">.</span><span class="ident" id="4563182">enabled</span>&nbsp;<span class="op" id="4563190">=</span>&nbsp;<span class="builtintype" id="4563192">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563200">w</span><span class="op" id="4563201">.</span><span class="ident" id="4563202">Write</span><span class="op" id="4563207">(</span><span class="ident" id="4563208">w</span><span class="op" id="4563209">.</span><span class="ident" id="4563210">dict</span><span class="op" id="4563214">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563218">w</span><span class="op" id="4563219">.</span><span class="ident" id="4563220">Flush</span><span class="op" id="4563225">(</span><span class="op" id="4563226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563230">dw</span><span class="op" id="4563232">.</span><span class="ident" id="4563233">enabled</span>&nbsp;<span class="op" id="4563241">=</span>&nbsp;<span class="builtintype" id="4563243">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563249">}</span>&nbsp;<span class="keyword" id="4563251">else</span>&nbsp;<span class="op" id="4563256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4563260">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563294">w</span><span class="op" id="4563295">.</span><span class="ident" id="4563296">d</span><span class="op" id="4563297">.</span><span class="ident" id="4563298">reset</span><span class="op" id="4563303">(</span><span class="ident" id="4563304">dst</span><span class="op" id="4563307">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563310">}</span><br>
<span class="lineno"></span><span class="op" id="4563312">}</span>
</div>
</body>
</html>
