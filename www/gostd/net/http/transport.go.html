<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5185296">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5185351">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5185405">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5185456">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="5185501">//</span><br>
<span class="lineno"></span><span class="comment" id="5185504">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="5185571">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5185617">package</span>&nbsp;<span class="ident" id="5185625">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5185631">import</span>&nbsp;<span class="op" id="5185638">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185641">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185650">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185667">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185681">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185691">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185698">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185704">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185711">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185718">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185729">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185735">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185746">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5185754">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5185761">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5185764">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5185834">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="5185905">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="5185976">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5186044">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5186081">var</span>&nbsp;<span class="ident" id="5186085">DefaultTransport</span>&nbsp;<span class="ident" id="5186102">RoundTripper</span>&nbsp;<span class="op" id="5186115">=</span>&nbsp;<span class="op" id="5186117">&amp;</span><span class="ident" id="5186118">Transport</span><span class="op" id="5186127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186130">Proxy</span><span class="op" id="5186135">:</span>&nbsp;<span class="ident" id="5186137">ProxyFromEnvironment</span><span class="op" id="5186157">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186160">Dial</span><span class="op" id="5186164">:</span>&nbsp;<span class="op" id="5186166">(</span><span class="op" id="5186167">&amp;</span><span class="ident" id="5186168">net</span><span class="op" id="5186171">.</span><span class="ident" id="5186172">Dialer</span><span class="op" id="5186178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186182">Timeout</span><span class="op" id="5186189">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="5186193">30</span>&nbsp;<span class="op" id="5186196">*</span>&nbsp;<span class="ident" id="5186198">time</span><span class="op" id="5186202">.</span><span class="ident" id="5186203">Second</span><span class="op" id="5186209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186213">KeepAlive</span><span class="op" id="5186222">:</span>&nbsp;<span class="num" id="5186224">30</span>&nbsp;<span class="op" id="5186227">*</span>&nbsp;<span class="ident" id="5186229">time</span><span class="op" id="5186233">.</span><span class="ident" id="5186234">Second</span><span class="op" id="5186240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186243">}</span><span class="op" id="5186244">)</span><span class="op" id="5186245">.</span><span class="ident" id="5186246">Dial</span><span class="op" id="5186250">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186253">TLSHandshakeTimeout</span><span class="op" id="5186272">:</span>&nbsp;<span class="num" id="5186274">10</span>&nbsp;<span class="op" id="5186277">*</span>&nbsp;<span class="ident" id="5186279">time</span><span class="op" id="5186283">.</span><span class="ident" id="5186284">Second</span><span class="op" id="5186290">,</span><br>
<span class="lineno">40</span><span class="op" id="5186292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5186295">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5186361">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="5186385">const</span>&nbsp;<span class="ident" id="5186391">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="5186418">=</span>&nbsp;<span class="num" id="5186420">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5186423">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="5186493">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="5186561">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="5186620">type</span>&nbsp;<span class="ident" id="5186625">Transport</span>&nbsp;<span class="keyword" id="5186635">struct</span>&nbsp;<span class="op" id="5186642">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186645">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186656">sync</span><span class="op" id="5186660">.</span><span class="ident" id="5186661">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186668">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5186679">bool</span>&nbsp;<span class="comment" id="5186684">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186731">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5186742">map</span><span class="op" id="5186745">[</span><span class="ident" id="5186746">connectMethodKey</span><span class="op" id="5186762">]</span><span class="op" id="5186763">[</span><span class="op" id="5186764">]</span><span class="op" id="5186765">*</span><span class="ident" id="5186766">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186779">idleConnCh</span>&nbsp;<span class="keyword" id="5186790">map</span><span class="op" id="5186793">[</span><span class="ident" id="5186794">connectMethodKey</span><span class="op" id="5186810">]</span><span class="keyword" id="5186811">chan</span>&nbsp;<span class="op" id="5186816">*</span><span class="ident" id="5186817">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186831">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186843">sync</span><span class="op" id="5186847">.</span><span class="ident" id="5186848">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186855">reqCanceler</span>&nbsp;<span class="keyword" id="5186867">map</span><span class="op" id="5186870">[</span><span class="op" id="5186871">*</span><span class="ident" id="5186872">Request</span><span class="op" id="5186879">]</span><span class="keyword" id="5186880">func</span><span class="op" id="5186884">(</span><span class="op" id="5186885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186889">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5186898">sync</span><span class="op" id="5186902">.</span><span class="ident" id="5186903">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186912">altProto</span>&nbsp;<span class="keyword" id="5186921">map</span><span class="op" id="5186924">[</span><span class="builtintype" id="5186925">string</span><span class="op" id="5186931">]</span><span class="ident" id="5186932">RoundTripper</span>&nbsp;<span class="comment" id="5186945">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5186991">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187052">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187110">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187158">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5187219">Proxy</span>&nbsp;<span class="keyword" id="5187225">func</span><span class="op" id="5187229">(</span><span class="op" id="5187230">*</span><span class="ident" id="5187231">Request</span><span class="op" id="5187238">)</span>&nbsp;<span class="op" id="5187240">(</span><span class="op" id="5187241">*</span><span class="ident" id="5187242">url</span><span class="op" id="5187245">.</span><span class="ident" id="5187246">URL</span><span class="op" id="5187249">,</span>&nbsp;<span class="builtintype" id="5187251">error</span><span class="op" id="5187256">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187260">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187322">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187343">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5187381">Dial</span>&nbsp;<span class="keyword" id="5187386">func</span><span class="op" id="5187390">(</span><span class="ident" id="5187391">network</span><span class="op" id="5187398">,</span>&nbsp;<span class="ident" id="5187400">addr</span>&nbsp;<span class="builtintype" id="5187405">string</span><span class="op" id="5187411">)</span>&nbsp;<span class="op" id="5187413">(</span><span class="ident" id="5187414">net</span><span class="op" id="5187417">.</span><span class="ident" id="5187418">Conn</span><span class="op" id="5187422">,</span>&nbsp;<span class="builtintype" id="5187424">error</span><span class="op" id="5187429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187433">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187494">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187546">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187550">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187608">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187612">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187671">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187732">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187796">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5187824">DialTLS</span>&nbsp;<span class="keyword" id="5187832">func</span><span class="op" id="5187836">(</span><span class="ident" id="5187837">network</span><span class="op" id="5187844">,</span>&nbsp;<span class="ident" id="5187846">addr</span>&nbsp;<span class="builtintype" id="5187851">string</span><span class="op" id="5187857">)</span>&nbsp;<span class="op" id="5187859">(</span><span class="ident" id="5187860">net</span><span class="op" id="5187863">.</span><span class="ident" id="5187864">Conn</span><span class="op" id="5187868">,</span>&nbsp;<span class="builtintype" id="5187870">error</span><span class="op" id="5187875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187879">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187943">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5188002">TLSClientConfig</span>&nbsp;<span class="op" id="5188018">*</span><span class="ident" id="5188019">tls</span><span class="op" id="5188022">.</span><span class="ident" id="5188023">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188032">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188104">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5188157">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="5188177">time</span><span class="op" id="5188181">.</span><span class="ident" id="5188182">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188193">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188260">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5188297">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="5188315">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188322">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188383">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188442">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188499">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188560">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188620">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188675">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188729">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5188747">DisableCompression</span>&nbsp;<span class="builtintype" id="5188766">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188773">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188837">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188882">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5188922">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="5188942">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5188948">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5189012">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5189073">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5189132">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5189194">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="5189216">time</span><span class="op" id="5189220">.</span><span class="ident" id="5189221">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5189232">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5189283">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="5189333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5189336">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5189402">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="5189462">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="5189529">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="5189597">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="5189610">//</span><br>
<span class="lineno"></span><span class="comment" id="5189613">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5189673">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="5189735">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="5189793">//</span><br>
<span class="lineno">130</span><span class="comment" id="5189796">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5189866">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="5189935">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="5189962">//</span><br>
<span class="lineno"></span><span class="comment" id="5189965">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="5190035">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5190101">func</span>&nbsp;<span class="ident" id="5190106">ProxyFromEnvironment</span><span class="op" id="5190126">(</span><span class="ident" id="5190127">req</span>&nbsp;<span class="op" id="5190131">*</span><span class="ident" id="5190132">Request</span><span class="op" id="5190139">)</span>&nbsp;<span class="op" id="5190141">(</span><span class="op" id="5190142">*</span><span class="ident" id="5190143">url</span><span class="op" id="5190146">.</span><span class="ident" id="5190147">URL</span><span class="op" id="5190150">,</span>&nbsp;<span class="builtintype" id="5190152">error</span><span class="op" id="5190157">)</span>&nbsp;<span class="op" id="5190159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190162">var</span>&nbsp;<span class="ident" id="5190166">proxy</span>&nbsp;<span class="builtintype" id="5190172">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190180">if</span>&nbsp;<span class="ident" id="5190183">req</span><span class="op" id="5190186">.</span><span class="ident" id="5190187">URL</span><span class="op" id="5190190">.</span><span class="ident" id="5190191">Scheme</span>&nbsp;<span class="op" id="5190198">==</span>&nbsp;<span class="string" id="5190201">&#34;https&#34;</span>&nbsp;<span class="op" id="5190209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5190213">proxy</span>&nbsp;<span class="op" id="5190219">=</span>&nbsp;<span class="ident" id="5190221">httpsProxyEnv</span><span class="op" id="5190234">.</span><span class="ident" id="5190235">Get</span><span class="op" id="5190238">(</span><span class="op" id="5190239">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5190242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190245">if</span>&nbsp;<span class="ident" id="5190248">proxy</span>&nbsp;<span class="op" id="5190254">==</span>&nbsp;<span class="string" id="5190257">&#34;&#34;</span>&nbsp;<span class="op" id="5190260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5190264">proxy</span>&nbsp;<span class="op" id="5190270">=</span>&nbsp;<span class="ident" id="5190272">httpProxyEnv</span><span class="op" id="5190284">.</span><span class="ident" id="5190285">Get</span><span class="op" id="5190288">(</span><span class="op" id="5190289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5190292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190295">if</span>&nbsp;<span class="ident" id="5190298">proxy</span>&nbsp;<span class="op" id="5190304">==</span>&nbsp;<span class="string" id="5190307">&#34;&#34;</span>&nbsp;<span class="op" id="5190310">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190314">return</span>&nbsp;<span class="ident" id="5190321">nil</span><span class="op" id="5190324">,</span>&nbsp;<span class="ident" id="5190326">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5190331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190334">if</span>&nbsp;<span class="op" id="5190337">!</span><span class="ident" id="5190338">useProxy</span><span class="op" id="5190346">(</span><span class="ident" id="5190347">canonicalAddr</span><span class="op" id="5190360">(</span><span class="ident" id="5190361">req</span><span class="op" id="5190364">.</span><span class="ident" id="5190365">URL</span><span class="op" id="5190368">)</span><span class="op" id="5190369">)</span>&nbsp;<span class="op" id="5190371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190375">return</span>&nbsp;<span class="ident" id="5190382">nil</span><span class="op" id="5190385">,</span>&nbsp;<span class="ident" id="5190387">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5190392">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5190395">proxyURL</span><span class="op" id="5190403">,</span>&nbsp;<span class="ident" id="5190405">err</span>&nbsp;<span class="op" id="5190409">:=</span>&nbsp;<span class="ident" id="5190412">url</span><span class="op" id="5190415">.</span><span class="ident" id="5190416">Parse</span><span class="op" id="5190421">(</span><span class="ident" id="5190422">proxy</span><span class="op" id="5190427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190430">if</span>&nbsp;<span class="ident" id="5190433">err</span>&nbsp;<span class="op" id="5190437">!=</span>&nbsp;<span class="ident" id="5190440">nil</span>&nbsp;<span class="op" id="5190444">||</span>&nbsp;<span class="op" id="5190447">!</span><span class="ident" id="5190448">strings</span><span class="op" id="5190455">.</span><span class="ident" id="5190456">HasPrefix</span><span class="op" id="5190465">(</span><span class="ident" id="5190466">proxyURL</span><span class="op" id="5190474">.</span><span class="ident" id="5190475">Scheme</span><span class="op" id="5190481">,</span>&nbsp;<span class="string" id="5190483">&#34;http&#34;</span><span class="op" id="5190489">)</span>&nbsp;<span class="op" id="5190491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5190495">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5190552">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5190603">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190653">if</span>&nbsp;<span class="ident" id="5190656">proxyURL</span><span class="op" id="5190664">,</span>&nbsp;<span class="ident" id="5190666">err</span>&nbsp;<span class="op" id="5190670">:=</span>&nbsp;<span class="ident" id="5190673">url</span><span class="op" id="5190676">.</span><span class="ident" id="5190677">Parse</span><span class="op" id="5190682">(</span><span class="string" id="5190683">&#34;http://&#34;</span>&nbsp;<span class="op" id="5190693">+</span>&nbsp;<span class="ident" id="5190695">proxy</span><span class="op" id="5190700">)</span><span class="op" id="5190701">;</span>&nbsp;<span class="ident" id="5190703">err</span>&nbsp;<span class="op" id="5190707">==</span>&nbsp;<span class="ident" id="5190710">nil</span>&nbsp;<span class="op" id="5190714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190719">return</span>&nbsp;<span class="ident" id="5190726">proxyURL</span><span class="op" id="5190734">,</span>&nbsp;<span class="ident" id="5190736">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5190742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5190745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190748">if</span>&nbsp;<span class="ident" id="5190751">err</span>&nbsp;<span class="op" id="5190755">!=</span>&nbsp;<span class="ident" id="5190758">nil</span>&nbsp;<span class="op" id="5190762">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190766">return</span>&nbsp;<span class="ident" id="5190773">nil</span><span class="op" id="5190776">,</span>&nbsp;<span class="ident" id="5190778">fmt</span><span class="op" id="5190781">.</span><span class="ident" id="5190782">Errorf</span><span class="op" id="5190788">(</span><span class="string" id="5190789">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="5190819">,</span>&nbsp;<span class="ident" id="5190821">proxy</span><span class="op" id="5190826">,</span>&nbsp;<span class="ident" id="5190828">err</span><span class="op" id="5190831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5190834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5190837">return</span>&nbsp;<span class="ident" id="5190844">proxyURL</span><span class="op" id="5190852">,</span>&nbsp;<span class="ident" id="5190854">nil</span><br>
<span class="lineno"></span><span class="op" id="5190858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="5190861">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="5190923">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="5190960">func</span>&nbsp;<span class="ident" id="5190965">ProxyURL</span><span class="op" id="5190973">(</span><span class="ident" id="5190974">fixedURL</span>&nbsp;<span class="op" id="5190983">*</span><span class="ident" id="5190984">url</span><span class="op" id="5190987">.</span><span class="ident" id="5190988">URL</span><span class="op" id="5190991">)</span>&nbsp;<span class="keyword" id="5190993">func</span><span class="op" id="5190997">(</span><span class="op" id="5190998">*</span><span class="ident" id="5190999">Request</span><span class="op" id="5191006">)</span>&nbsp;<span class="op" id="5191008">(</span><span class="op" id="5191009">*</span><span class="ident" id="5191010">url</span><span class="op" id="5191013">.</span><span class="ident" id="5191014">URL</span><span class="op" id="5191017">,</span>&nbsp;<span class="builtintype" id="5191019">error</span><span class="op" id="5191024">)</span>&nbsp;<span class="op" id="5191026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191029">return</span>&nbsp;<span class="keyword" id="5191036">func</span><span class="op" id="5191040">(</span><span class="op" id="5191041">*</span><span class="ident" id="5191042">Request</span><span class="op" id="5191049">)</span>&nbsp;<span class="op" id="5191051">(</span><span class="op" id="5191052">*</span><span class="ident" id="5191053">url</span><span class="op" id="5191056">.</span><span class="ident" id="5191057">URL</span><span class="op" id="5191060">,</span>&nbsp;<span class="builtintype" id="5191062">error</span><span class="op" id="5191067">)</span>&nbsp;<span class="op" id="5191069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191073">return</span>&nbsp;<span class="ident" id="5191080">fixedURL</span><span class="op" id="5191088">,</span>&nbsp;<span class="ident" id="5191090">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5191095">}</span><br>
<span class="lineno"></span><span class="op" id="5191097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5191100">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="5191161">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="5191197">type</span>&nbsp;<span class="ident" id="5191202">transportRequest</span>&nbsp;<span class="keyword" id="5191219">struct</span>&nbsp;<span class="op" id="5191226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5191229">*</span><span class="ident" id="5191230">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5191245">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5191285">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5191294">Header</span>&nbsp;<span class="comment" id="5191301">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="5191335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="5191338">func</span>&nbsp;<span class="op" id="5191343">(</span><span class="ident" id="5191344">tr</span>&nbsp;<span class="op" id="5191347">*</span><span class="ident" id="5191348">transportRequest</span><span class="op" id="5191364">)</span>&nbsp;<span class="ident" id="5191366">extraHeaders</span><span class="op" id="5191378">(</span><span class="op" id="5191379">)</span>&nbsp;<span class="ident" id="5191381">Header</span>&nbsp;<span class="op" id="5191388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191391">if</span>&nbsp;<span class="ident" id="5191394">tr</span><span class="op" id="5191396">.</span><span class="ident" id="5191397">extra</span>&nbsp;<span class="op" id="5191403">==</span>&nbsp;<span class="ident" id="5191406">nil</span>&nbsp;<span class="op" id="5191410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5191414">tr</span><span class="op" id="5191416">.</span><span class="ident" id="5191417">extra</span>&nbsp;<span class="op" id="5191423">=</span>&nbsp;<span class="builtinfunc" id="5191425">make</span><span class="op" id="5191429">(</span><span class="ident" id="5191430">Header</span><span class="op" id="5191436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5191439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191442">return</span>&nbsp;<span class="ident" id="5191449">tr</span><span class="op" id="5191451">.</span><span class="ident" id="5191452">extra</span><br>
<span class="lineno">185</span><span class="op" id="5191458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5191461">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="5191513">//</span><br>
<span class="lineno"></span><span class="comment" id="5191516">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="5191585">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5191640">func</span>&nbsp;<span class="op" id="5191645">(</span><span class="ident" id="5191646">t</span>&nbsp;<span class="op" id="5191648">*</span><span class="ident" id="5191649">Transport</span><span class="op" id="5191658">)</span>&nbsp;<span class="ident" id="5191660">RoundTrip</span><span class="op" id="5191669">(</span><span class="ident" id="5191670">req</span>&nbsp;<span class="op" id="5191674">*</span><span class="ident" id="5191675">Request</span><span class="op" id="5191682">)</span>&nbsp;<span class="op" id="5191684">(</span><span class="ident" id="5191685">resp</span>&nbsp;<span class="op" id="5191690">*</span><span class="ident" id="5191691">Response</span><span class="op" id="5191699">,</span>&nbsp;<span class="ident" id="5191701">err</span>&nbsp;<span class="builtintype" id="5191705">error</span><span class="op" id="5191710">)</span>&nbsp;<span class="op" id="5191712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191715">if</span>&nbsp;<span class="ident" id="5191718">req</span><span class="op" id="5191721">.</span><span class="ident" id="5191722">URL</span>&nbsp;<span class="op" id="5191726">==</span>&nbsp;<span class="ident" id="5191729">nil</span>&nbsp;<span class="op" id="5191733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5191737">req</span><span class="op" id="5191740">.</span><span class="ident" id="5191741">closeBody</span><span class="op" id="5191750">(</span><span class="op" id="5191751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191755">return</span>&nbsp;<span class="ident" id="5191762">nil</span><span class="op" id="5191765">,</span>&nbsp;<span class="ident" id="5191767">errors</span><span class="op" id="5191773">.</span><span class="ident" id="5191774">New</span><span class="op" id="5191777">(</span><span class="string" id="5191778">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="5191801">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5191804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191807">if</span>&nbsp;<span class="ident" id="5191810">req</span><span class="op" id="5191813">.</span><span class="ident" id="5191814">Header</span>&nbsp;<span class="op" id="5191821">==</span>&nbsp;<span class="ident" id="5191824">nil</span>&nbsp;<span class="op" id="5191828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5191832">req</span><span class="op" id="5191835">.</span><span class="ident" id="5191836">closeBody</span><span class="op" id="5191845">(</span><span class="op" id="5191846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191850">return</span>&nbsp;<span class="ident" id="5191857">nil</span><span class="op" id="5191860">,</span>&nbsp;<span class="ident" id="5191862">errors</span><span class="op" id="5191868">.</span><span class="ident" id="5191869">New</span><span class="op" id="5191872">(</span><span class="string" id="5191873">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="5191899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5191902">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191905">if</span>&nbsp;<span class="ident" id="5191908">req</span><span class="op" id="5191911">.</span><span class="ident" id="5191912">URL</span><span class="op" id="5191915">.</span><span class="ident" id="5191916">Scheme</span>&nbsp;<span class="op" id="5191923">!=</span>&nbsp;<span class="string" id="5191926">&#34;http&#34;</span>&nbsp;<span class="op" id="5191933">&amp;&amp;</span>&nbsp;<span class="ident" id="5191936">req</span><span class="op" id="5191939">.</span><span class="ident" id="5191940">URL</span><span class="op" id="5191943">.</span><span class="ident" id="5191944">Scheme</span>&nbsp;<span class="op" id="5191951">!=</span>&nbsp;<span class="string" id="5191954">&#34;https&#34;</span>&nbsp;<span class="op" id="5191962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5191966">t</span><span class="op" id="5191967">.</span><span class="ident" id="5191968">altMu</span><span class="op" id="5191973">.</span><span class="ident" id="5191974">RLock</span><span class="op" id="5191979">(</span><span class="op" id="5191980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5191984">var</span>&nbsp;<span class="ident" id="5191988">rt</span>&nbsp;<span class="ident" id="5191991">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192006">if</span>&nbsp;<span class="ident" id="5192009">t</span><span class="op" id="5192010">.</span><span class="ident" id="5192011">altProto</span>&nbsp;<span class="op" id="5192020">!=</span>&nbsp;<span class="ident" id="5192023">nil</span>&nbsp;<span class="op" id="5192027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192032">rt</span>&nbsp;<span class="op" id="5192035">=</span>&nbsp;<span class="ident" id="5192037">t</span><span class="op" id="5192038">.</span><span class="ident" id="5192039">altProto</span><span class="op" id="5192047">[</span><span class="ident" id="5192048">req</span><span class="op" id="5192051">.</span><span class="ident" id="5192052">URL</span><span class="op" id="5192055">.</span><span class="ident" id="5192056">Scheme</span><span class="op" id="5192062">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5192066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192070">t</span><span class="op" id="5192071">.</span><span class="ident" id="5192072">altMu</span><span class="op" id="5192077">.</span><span class="ident" id="5192078">RUnlock</span><span class="op" id="5192085">(</span><span class="op" id="5192086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192090">if</span>&nbsp;<span class="ident" id="5192093">rt</span>&nbsp;<span class="op" id="5192096">==</span>&nbsp;<span class="ident" id="5192099">nil</span>&nbsp;<span class="op" id="5192103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192108">req</span><span class="op" id="5192111">.</span><span class="ident" id="5192112">closeBody</span><span class="op" id="5192121">(</span><span class="op" id="5192122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192127">return</span>&nbsp;<span class="ident" id="5192134">nil</span><span class="op" id="5192137">,</span>&nbsp;<span class="op" id="5192139">&amp;</span><span class="ident" id="5192140">badStringError</span><span class="op" id="5192154">{</span><span class="string" id="5192155">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="5192184">,</span>&nbsp;<span class="ident" id="5192186">req</span><span class="op" id="5192189">.</span><span class="ident" id="5192190">URL</span><span class="op" id="5192193">.</span><span class="ident" id="5192194">Scheme</span><span class="op" id="5192200">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5192204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192208">return</span>&nbsp;<span class="ident" id="5192215">rt</span><span class="op" id="5192217">.</span><span class="ident" id="5192218">RoundTrip</span><span class="op" id="5192227">(</span><span class="ident" id="5192228">req</span><span class="op" id="5192231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5192234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192237">if</span>&nbsp;<span class="ident" id="5192240">req</span><span class="op" id="5192243">.</span><span class="ident" id="5192244">URL</span><span class="op" id="5192247">.</span><span class="ident" id="5192248">Host</span>&nbsp;<span class="op" id="5192253">==</span>&nbsp;<span class="string" id="5192256">&#34;&#34;</span>&nbsp;<span class="op" id="5192259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192263">req</span><span class="op" id="5192266">.</span><span class="ident" id="5192267">closeBody</span><span class="op" id="5192276">(</span><span class="op" id="5192277">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192281">return</span>&nbsp;<span class="ident" id="5192288">nil</span><span class="op" id="5192291">,</span>&nbsp;<span class="ident" id="5192293">errors</span><span class="op" id="5192299">.</span><span class="ident" id="5192300">New</span><span class="op" id="5192303">(</span><span class="string" id="5192304">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="5192334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5192337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192340">treq</span>&nbsp;<span class="op" id="5192345">:=</span>&nbsp;<span class="op" id="5192348">&amp;</span><span class="ident" id="5192349">transportRequest</span><span class="op" id="5192365">{</span><span class="ident" id="5192366">Request</span><span class="op" id="5192373">:</span>&nbsp;<span class="ident" id="5192375">req</span><span class="op" id="5192378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192381">cm</span><span class="op" id="5192383">,</span>&nbsp;<span class="ident" id="5192385">err</span>&nbsp;<span class="op" id="5192389">:=</span>&nbsp;<span class="ident" id="5192392">t</span><span class="op" id="5192393">.</span><span class="ident" id="5192394">connectMethodForRequest</span><span class="op" id="5192417">(</span><span class="ident" id="5192418">treq</span><span class="op" id="5192422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192425">if</span>&nbsp;<span class="ident" id="5192428">err</span>&nbsp;<span class="op" id="5192432">!=</span>&nbsp;<span class="ident" id="5192435">nil</span>&nbsp;<span class="op" id="5192439">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192443">req</span><span class="op" id="5192446">.</span><span class="ident" id="5192447">closeBody</span><span class="op" id="5192456">(</span><span class="op" id="5192457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192461">return</span>&nbsp;<span class="ident" id="5192468">nil</span><span class="op" id="5192471">,</span>&nbsp;<span class="ident" id="5192473">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5192478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5192482">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5192543">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5192607">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5192671">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192696">pconn</span><span class="op" id="5192701">,</span>&nbsp;<span class="ident" id="5192703">err</span>&nbsp;<span class="op" id="5192707">:=</span>&nbsp;<span class="ident" id="5192710">t</span><span class="op" id="5192711">.</span><span class="ident" id="5192712">getConn</span><span class="op" id="5192719">(</span><span class="ident" id="5192720">req</span><span class="op" id="5192723">,</span>&nbsp;<span class="ident" id="5192725">cm</span><span class="op" id="5192727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192730">if</span>&nbsp;<span class="ident" id="5192733">err</span>&nbsp;<span class="op" id="5192737">!=</span>&nbsp;<span class="ident" id="5192740">nil</span>&nbsp;<span class="op" id="5192744">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192748">t</span><span class="op" id="5192749">.</span><span class="ident" id="5192750">setReqCanceler</span><span class="op" id="5192764">(</span><span class="ident" id="5192765">req</span><span class="op" id="5192768">,</span>&nbsp;<span class="ident" id="5192770">nil</span><span class="op" id="5192773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5192777">req</span><span class="op" id="5192780">.</span><span class="ident" id="5192781">closeBody</span><span class="op" id="5192790">(</span><span class="op" id="5192791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192795">return</span>&nbsp;<span class="ident" id="5192802">nil</span><span class="op" id="5192805">,</span>&nbsp;<span class="ident" id="5192807">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5192812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5192816">return</span>&nbsp;<span class="ident" id="5192823">pconn</span><span class="op" id="5192828">.</span><span class="ident" id="5192829">roundTrip</span><span class="op" id="5192838">(</span><span class="ident" id="5192839">treq</span><span class="op" id="5192843">)</span><br>
<span class="lineno"></span><span class="op" id="5192845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5192848">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="5192906">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="5192972">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="5193037">//</span><br>
<span class="lineno"></span><span class="comment" id="5193040">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="5193101">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5193162">func</span>&nbsp;<span class="op" id="5193167">(</span><span class="ident" id="5193168">t</span>&nbsp;<span class="op" id="5193170">*</span><span class="ident" id="5193171">Transport</span><span class="op" id="5193180">)</span>&nbsp;<span class="ident" id="5193182">RegisterProtocol</span><span class="op" id="5193198">(</span><span class="ident" id="5193199">scheme</span>&nbsp;<span class="builtintype" id="5193206">string</span><span class="op" id="5193212">,</span>&nbsp;<span class="ident" id="5193214">rt</span>&nbsp;<span class="ident" id="5193217">RoundTripper</span><span class="op" id="5193229">)</span>&nbsp;<span class="op" id="5193231">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5193234">if</span>&nbsp;<span class="ident" id="5193237">scheme</span>&nbsp;<span class="op" id="5193244">==</span>&nbsp;<span class="string" id="5193247">&#34;http&#34;</span>&nbsp;<span class="op" id="5193254">||</span>&nbsp;<span class="ident" id="5193257">scheme</span>&nbsp;<span class="op" id="5193264">==</span>&nbsp;<span class="string" id="5193267">&#34;https&#34;</span>&nbsp;<span class="op" id="5193275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5193279">panic</span><span class="op" id="5193284">(</span><span class="string" id="5193285">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="5193297">+</span>&nbsp;<span class="ident" id="5193299">scheme</span>&nbsp;<span class="op" id="5193306">+</span>&nbsp;<span class="string" id="5193308">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="5193329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5193332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193335">t</span><span class="op" id="5193336">.</span><span class="ident" id="5193337">altMu</span><span class="op" id="5193342">.</span><span class="ident" id="5193343">Lock</span><span class="op" id="5193347">(</span><span class="op" id="5193348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5193351">defer</span>&nbsp;<span class="ident" id="5193357">t</span><span class="op" id="5193358">.</span><span class="ident" id="5193359">altMu</span><span class="op" id="5193364">.</span><span class="ident" id="5193365">Unlock</span><span class="op" id="5193371">(</span><span class="op" id="5193372">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5193375">if</span>&nbsp;<span class="ident" id="5193378">t</span><span class="op" id="5193379">.</span><span class="ident" id="5193380">altProto</span>&nbsp;<span class="op" id="5193389">==</span>&nbsp;<span class="ident" id="5193392">nil</span>&nbsp;<span class="op" id="5193396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193400">t</span><span class="op" id="5193401">.</span><span class="ident" id="5193402">altProto</span>&nbsp;<span class="op" id="5193411">=</span>&nbsp;<span class="builtinfunc" id="5193413">make</span><span class="op" id="5193417">(</span><span class="keyword" id="5193418">map</span><span class="op" id="5193421">[</span><span class="builtintype" id="5193422">string</span><span class="op" id="5193428">]</span><span class="ident" id="5193429">RoundTripper</span><span class="op" id="5193441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5193444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5193447">if</span>&nbsp;<span class="ident" id="5193450">_</span><span class="op" id="5193451">,</span>&nbsp;<span class="ident" id="5193453">exists</span>&nbsp;<span class="op" id="5193460">:=</span>&nbsp;<span class="ident" id="5193463">t</span><span class="op" id="5193464">.</span><span class="ident" id="5193465">altProto</span><span class="op" id="5193473">[</span><span class="ident" id="5193474">scheme</span><span class="op" id="5193480">]</span><span class="op" id="5193481">;</span>&nbsp;<span class="ident" id="5193483">exists</span>&nbsp;<span class="op" id="5193490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5193494">panic</span><span class="op" id="5193499">(</span><span class="string" id="5193500">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="5193512">+</span>&nbsp;<span class="ident" id="5193514">scheme</span>&nbsp;<span class="op" id="5193521">+</span>&nbsp;<span class="string" id="5193523">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="5193544">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5193547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193550">t</span><span class="op" id="5193551">.</span><span class="ident" id="5193552">altProto</span><span class="op" id="5193560">[</span><span class="ident" id="5193561">scheme</span><span class="op" id="5193567">]</span>&nbsp;<span class="op" id="5193569">=</span>&nbsp;<span class="ident" id="5193571">rt</span><br>
<span class="lineno"></span><span class="op" id="5193574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5193577">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="5193646">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5193710">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="5193783">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5193794">func</span>&nbsp;<span class="op" id="5193799">(</span><span class="ident" id="5193800">t</span>&nbsp;<span class="op" id="5193802">*</span><span class="ident" id="5193803">Transport</span><span class="op" id="5193812">)</span>&nbsp;<span class="ident" id="5193814">CloseIdleConnections</span><span class="op" id="5193834">(</span><span class="op" id="5193835">)</span>&nbsp;<span class="op" id="5193837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193840">t</span><span class="op" id="5193841">.</span><span class="ident" id="5193842">idleMu</span><span class="op" id="5193848">.</span><span class="ident" id="5193849">Lock</span><span class="op" id="5193853">(</span><span class="op" id="5193854">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193857">m</span>&nbsp;<span class="op" id="5193859">:=</span>&nbsp;<span class="ident" id="5193862">t</span><span class="op" id="5193863">.</span><span class="ident" id="5193864">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193874">t</span><span class="op" id="5193875">.</span><span class="ident" id="5193876">idleConn</span>&nbsp;<span class="op" id="5193885">=</span>&nbsp;<span class="ident" id="5193887">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193892">t</span><span class="op" id="5193893">.</span><span class="ident" id="5193894">idleConnCh</span>&nbsp;<span class="op" id="5193905">=</span>&nbsp;<span class="ident" id="5193907">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193912">t</span><span class="op" id="5193913">.</span><span class="ident" id="5193914">wantIdle</span>&nbsp;<span class="op" id="5193923">=</span>&nbsp;<span class="builtintype" id="5193925">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5193931">t</span><span class="op" id="5193932">.</span><span class="ident" id="5193933">idleMu</span><span class="op" id="5193939">.</span><span class="ident" id="5193940">Unlock</span><span class="op" id="5193946">(</span><span class="op" id="5193947">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5193950">for</span>&nbsp;<span class="ident" id="5193954">_</span><span class="op" id="5193955">,</span>&nbsp;<span class="ident" id="5193957">conns</span>&nbsp;<span class="op" id="5193963">:=</span>&nbsp;<span class="keyword" id="5193966">range</span>&nbsp;<span class="ident" id="5193972">m</span>&nbsp;<span class="op" id="5193974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5193978">for</span>&nbsp;<span class="ident" id="5193982">_</span><span class="op" id="5193983">,</span>&nbsp;<span class="ident" id="5193985">pconn</span>&nbsp;<span class="op" id="5193991">:=</span>&nbsp;<span class="keyword" id="5193994">range</span>&nbsp;<span class="ident" id="5194000">conns</span>&nbsp;<span class="op" id="5194006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194011">pconn</span><span class="op" id="5194016">.</span><span class="builtinfunc" id="5194017">close</span><span class="op" id="5194022">(</span><span class="op" id="5194023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5194027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5194030">}</span><br>
<span class="lineno">275</span><span class="op" id="5194032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5194035">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="5194096">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5194111">func</span>&nbsp;<span class="op" id="5194116">(</span><span class="ident" id="5194117">t</span>&nbsp;<span class="op" id="5194119">*</span><span class="ident" id="5194120">Transport</span><span class="op" id="5194129">)</span>&nbsp;<span class="ident" id="5194131">CancelRequest</span><span class="op" id="5194144">(</span><span class="ident" id="5194145">req</span>&nbsp;<span class="op" id="5194149">*</span><span class="ident" id="5194150">Request</span><span class="op" id="5194157">)</span>&nbsp;<span class="op" id="5194159">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194162">t</span><span class="op" id="5194163">.</span><span class="ident" id="5194164">reqMu</span><span class="op" id="5194169">.</span><span class="ident" id="5194170">Lock</span><span class="op" id="5194174">(</span><span class="op" id="5194175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194178">cancel</span>&nbsp;<span class="op" id="5194185">:=</span>&nbsp;<span class="ident" id="5194188">t</span><span class="op" id="5194189">.</span><span class="ident" id="5194190">reqCanceler</span><span class="op" id="5194201">[</span><span class="ident" id="5194202">req</span><span class="op" id="5194205">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194208">t</span><span class="op" id="5194209">.</span><span class="ident" id="5194210">reqMu</span><span class="op" id="5194215">.</span><span class="ident" id="5194216">Unlock</span><span class="op" id="5194222">(</span><span class="op" id="5194223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5194226">if</span>&nbsp;<span class="ident" id="5194229">cancel</span>&nbsp;<span class="op" id="5194236">!=</span>&nbsp;<span class="ident" id="5194239">nil</span>&nbsp;<span class="op" id="5194243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194247">cancel</span><span class="op" id="5194253">(</span><span class="op" id="5194254">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5194257">}</span><br>
<span class="lineno"></span><span class="op" id="5194259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5194262">//</span><br>
<span class="lineno"></span><span class="comment" id="5194265">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="5194308">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5194312">var</span>&nbsp;<span class="op" id="5194316">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194319">httpProxyEnv</span>&nbsp;<span class="op" id="5194332">=</span>&nbsp;<span class="op" id="5194334">&amp;</span><span class="ident" id="5194335">envOnce</span><span class="op" id="5194342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194346">names</span><span class="op" id="5194351">:</span>&nbsp;<span class="op" id="5194353">[</span><span class="op" id="5194354">]</span><span class="builtintype" id="5194355">string</span><span class="op" id="5194361">{</span><span class="string" id="5194362">&#34;HTTP_PROXY&#34;</span><span class="op" id="5194374">,</span>&nbsp;<span class="string" id="5194376">&#34;http_proxy&#34;</span><span class="op" id="5194388">}</span><span class="op" id="5194389">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5194392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194395">httpsProxyEnv</span>&nbsp;<span class="op" id="5194409">=</span>&nbsp;<span class="op" id="5194411">&amp;</span><span class="ident" id="5194412">envOnce</span><span class="op" id="5194419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194423">names</span><span class="op" id="5194428">:</span>&nbsp;<span class="op" id="5194430">[</span><span class="op" id="5194431">]</span><span class="builtintype" id="5194432">string</span><span class="op" id="5194438">{</span><span class="string" id="5194439">&#34;HTTPS_PROXY&#34;</span><span class="op" id="5194452">,</span>&nbsp;<span class="string" id="5194454">&#34;https_proxy&#34;</span><span class="op" id="5194467">}</span><span class="op" id="5194468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5194471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194474">noProxyEnv</span>&nbsp;<span class="op" id="5194485">=</span>&nbsp;<span class="op" id="5194487">&amp;</span><span class="ident" id="5194488">envOnce</span><span class="op" id="5194495">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194499">names</span><span class="op" id="5194504">:</span>&nbsp;<span class="op" id="5194506">[</span><span class="op" id="5194507">]</span><span class="builtintype" id="5194508">string</span><span class="op" id="5194514">{</span><span class="string" id="5194515">&#34;NO_PROXY&#34;</span><span class="op" id="5194525">,</span>&nbsp;<span class="string" id="5194527">&#34;no_proxy&#34;</span><span class="op" id="5194537">}</span><span class="op" id="5194538">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5194541">}</span><br>
<span class="lineno"></span><span class="op" id="5194543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5194546">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="5194614">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="5194679">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="5194698">type</span>&nbsp;<span class="ident" id="5194703">envOnce</span>&nbsp;<span class="keyword" id="5194711">struct</span>&nbsp;<span class="op" id="5194718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194721">names</span>&nbsp;<span class="op" id="5194727">[</span><span class="op" id="5194728">]</span><span class="builtintype" id="5194729">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194737">once</span>&nbsp;&nbsp;<span class="ident" id="5194743">sync</span><span class="op" id="5194747">.</span><span class="ident" id="5194748">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194754">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5194760">string</span><br>
<span class="lineno"></span><span class="op" id="5194767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5194770">func</span>&nbsp;<span class="op" id="5194775">(</span><span class="ident" id="5194776">e</span>&nbsp;<span class="op" id="5194778">*</span><span class="ident" id="5194779">envOnce</span><span class="op" id="5194786">)</span>&nbsp;<span class="ident" id="5194788">Get</span><span class="op" id="5194791">(</span><span class="op" id="5194792">)</span>&nbsp;<span class="builtintype" id="5194794">string</span>&nbsp;<span class="op" id="5194801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194804">e</span><span class="op" id="5194805">.</span><span class="ident" id="5194806">once</span><span class="op" id="5194810">.</span><span class="ident" id="5194811">Do</span><span class="op" id="5194813">(</span><span class="ident" id="5194814">e</span><span class="op" id="5194815">.</span><span class="ident" id="5194816">init</span><span class="op" id="5194820">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5194823">return</span>&nbsp;<span class="ident" id="5194830">e</span><span class="op" id="5194831">.</span><span class="ident" id="5194832">val</span><br>
<span class="lineno"></span><span class="op" id="5194836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5194839">func</span>&nbsp;<span class="op" id="5194844">(</span><span class="ident" id="5194845">e</span>&nbsp;<span class="op" id="5194847">*</span><span class="ident" id="5194848">envOnce</span><span class="op" id="5194855">)</span>&nbsp;<span class="ident" id="5194857">init</span><span class="op" id="5194861">(</span><span class="op" id="5194862">)</span>&nbsp;<span class="op" id="5194864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5194867">for</span>&nbsp;<span class="ident" id="5194871">_</span><span class="op" id="5194872">,</span>&nbsp;<span class="ident" id="5194874">n</span>&nbsp;<span class="op" id="5194876">:=</span>&nbsp;<span class="keyword" id="5194879">range</span>&nbsp;<span class="ident" id="5194885">e</span><span class="op" id="5194886">.</span><span class="ident" id="5194887">names</span>&nbsp;<span class="op" id="5194893">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5194897">e</span><span class="op" id="5194898">.</span><span class="ident" id="5194899">val</span>&nbsp;<span class="op" id="5194903">=</span>&nbsp;<span class="ident" id="5194905">os</span><span class="op" id="5194907">.</span><span class="ident" id="5194908">Getenv</span><span class="op" id="5194914">(</span><span class="ident" id="5194915">n</span><span class="op" id="5194916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5194920">if</span>&nbsp;<span class="ident" id="5194923">e</span><span class="op" id="5194924">.</span><span class="ident" id="5194925">val</span>&nbsp;<span class="op" id="5194929">!=</span>&nbsp;<span class="string" id="5194932">&#34;&#34;</span>&nbsp;<span class="op" id="5194935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5194940">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5194949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5194952">}</span><br>
<span class="lineno">325</span><span class="op" id="5194954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5194957">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="5194983">func</span>&nbsp;<span class="op" id="5194988">(</span><span class="ident" id="5194989">e</span>&nbsp;<span class="op" id="5194991">*</span><span class="ident" id="5194992">envOnce</span><span class="op" id="5194999">)</span>&nbsp;<span class="ident" id="5195001">reset</span><span class="op" id="5195006">(</span><span class="op" id="5195007">)</span>&nbsp;<span class="op" id="5195009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195012">e</span><span class="op" id="5195013">.</span><span class="ident" id="5195014">once</span>&nbsp;<span class="op" id="5195019">=</span>&nbsp;<span class="ident" id="5195021">sync</span><span class="op" id="5195025">.</span><span class="ident" id="5195026">Once</span><span class="op" id="5195030">{</span><span class="op" id="5195031">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195034">e</span><span class="op" id="5195035">.</span><span class="ident" id="5195036">val</span>&nbsp;<span class="op" id="5195040">=</span>&nbsp;<span class="string" id="5195042">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="5195045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5195048">func</span>&nbsp;<span class="op" id="5195053">(</span><span class="ident" id="5195054">t</span>&nbsp;<span class="op" id="5195056">*</span><span class="ident" id="5195057">Transport</span><span class="op" id="5195066">)</span>&nbsp;<span class="ident" id="5195068">connectMethodForRequest</span><span class="op" id="5195091">(</span><span class="ident" id="5195092">treq</span>&nbsp;<span class="op" id="5195097">*</span><span class="ident" id="5195098">transportRequest</span><span class="op" id="5195114">)</span>&nbsp;<span class="op" id="5195116">(</span><span class="ident" id="5195117">cm</span>&nbsp;<span class="ident" id="5195120">connectMethod</span><span class="op" id="5195133">,</span>&nbsp;<span class="ident" id="5195135">err</span>&nbsp;<span class="builtintype" id="5195139">error</span><span class="op" id="5195144">)</span>&nbsp;<span class="op" id="5195146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195149">cm</span><span class="op" id="5195151">.</span><span class="ident" id="5195152">targetScheme</span>&nbsp;<span class="op" id="5195165">=</span>&nbsp;<span class="ident" id="5195167">treq</span><span class="op" id="5195171">.</span><span class="ident" id="5195172">URL</span><span class="op" id="5195175">.</span><span class="ident" id="5195176">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195184">cm</span><span class="op" id="5195186">.</span><span class="ident" id="5195187">targetAddr</span>&nbsp;<span class="op" id="5195198">=</span>&nbsp;<span class="ident" id="5195200">canonicalAddr</span><span class="op" id="5195213">(</span><span class="ident" id="5195214">treq</span><span class="op" id="5195218">.</span><span class="ident" id="5195219">URL</span><span class="op" id="5195222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195225">if</span>&nbsp;<span class="ident" id="5195228">t</span><span class="op" id="5195229">.</span><span class="ident" id="5195230">Proxy</span>&nbsp;<span class="op" id="5195236">!=</span>&nbsp;<span class="ident" id="5195239">nil</span>&nbsp;<span class="op" id="5195243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195247">cm</span><span class="op" id="5195249">.</span><span class="ident" id="5195250">proxyURL</span><span class="op" id="5195258">,</span>&nbsp;<span class="ident" id="5195260">err</span>&nbsp;<span class="op" id="5195264">=</span>&nbsp;<span class="ident" id="5195266">t</span><span class="op" id="5195267">.</span><span class="ident" id="5195268">Proxy</span><span class="op" id="5195273">(</span><span class="ident" id="5195274">treq</span><span class="op" id="5195278">.</span><span class="ident" id="5195279">Request</span><span class="op" id="5195286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195292">return</span>&nbsp;<span class="ident" id="5195299">cm</span><span class="op" id="5195301">,</span>&nbsp;<span class="ident" id="5195303">err</span><br>
<span class="lineno">340</span><span class="op" id="5195307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5195310">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="5195369">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5195400">func</span>&nbsp;<span class="op" id="5195405">(</span><span class="ident" id="5195406">cm</span>&nbsp;<span class="op" id="5195409">*</span><span class="ident" id="5195410">connectMethod</span><span class="op" id="5195423">)</span>&nbsp;<span class="ident" id="5195425">proxyAuth</span><span class="op" id="5195434">(</span><span class="op" id="5195435">)</span>&nbsp;<span class="builtintype" id="5195437">string</span>&nbsp;<span class="op" id="5195444">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195447">if</span>&nbsp;<span class="ident" id="5195450">cm</span><span class="op" id="5195452">.</span><span class="ident" id="5195453">proxyURL</span>&nbsp;<span class="op" id="5195462">==</span>&nbsp;<span class="ident" id="5195465">nil</span>&nbsp;<span class="op" id="5195469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195473">return</span>&nbsp;<span class="string" id="5195480">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195487">if</span>&nbsp;<span class="ident" id="5195490">u</span>&nbsp;<span class="op" id="5195492">:=</span>&nbsp;<span class="ident" id="5195495">cm</span><span class="op" id="5195497">.</span><span class="ident" id="5195498">proxyURL</span><span class="op" id="5195506">.</span><span class="ident" id="5195507">User</span><span class="op" id="5195511">;</span>&nbsp;<span class="ident" id="5195513">u</span>&nbsp;<span class="op" id="5195515">!=</span>&nbsp;<span class="ident" id="5195518">nil</span>&nbsp;<span class="op" id="5195522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195526">username</span>&nbsp;<span class="op" id="5195535">:=</span>&nbsp;<span class="ident" id="5195538">u</span><span class="op" id="5195539">.</span><span class="ident" id="5195540">Username</span><span class="op" id="5195548">(</span><span class="op" id="5195549">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195553">password</span><span class="op" id="5195561">,</span>&nbsp;<span class="ident" id="5195563">_</span>&nbsp;<span class="op" id="5195565">:=</span>&nbsp;<span class="ident" id="5195568">u</span><span class="op" id="5195569">.</span><span class="ident" id="5195570">Password</span><span class="op" id="5195578">(</span><span class="op" id="5195579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195583">return</span>&nbsp;<span class="string" id="5195590">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="5195599">+</span>&nbsp;<span class="ident" id="5195601">basicAuth</span><span class="op" id="5195610">(</span><span class="ident" id="5195611">username</span><span class="op" id="5195619">,</span>&nbsp;<span class="ident" id="5195621">password</span><span class="op" id="5195629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195635">return</span>&nbsp;<span class="string" id="5195642">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="5195645">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="5195648">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="5195726">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5195744">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="5195812">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="5195830">func</span>&nbsp;<span class="op" id="5195835">(</span><span class="ident" id="5195836">t</span>&nbsp;<span class="op" id="5195838">*</span><span class="ident" id="5195839">Transport</span><span class="op" id="5195848">)</span>&nbsp;<span class="ident" id="5195850">putIdleConn</span><span class="op" id="5195861">(</span><span class="ident" id="5195862">pconn</span>&nbsp;<span class="op" id="5195868">*</span><span class="ident" id="5195869">persistConn</span><span class="op" id="5195880">)</span>&nbsp;<span class="builtintype" id="5195882">bool</span>&nbsp;<span class="op" id="5195887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195890">if</span>&nbsp;<span class="ident" id="5195893">t</span><span class="op" id="5195894">.</span><span class="ident" id="5195895">DisableKeepAlives</span>&nbsp;<span class="op" id="5195913">||</span>&nbsp;<span class="ident" id="5195916">t</span><span class="op" id="5195917">.</span><span class="ident" id="5195918">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="5195938">&lt;</span>&nbsp;<span class="num" id="5195940">0</span>&nbsp;<span class="op" id="5195942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5195946">pconn</span><span class="op" id="5195951">.</span><span class="builtinfunc" id="5195952">close</span><span class="op" id="5195957">(</span><span class="op" id="5195958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195962">return</span>&nbsp;<span class="builtintype" id="5195969">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5195976">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5195979">if</span>&nbsp;<span class="ident" id="5195982">pconn</span><span class="op" id="5195987">.</span><span class="ident" id="5195988">isBroken</span><span class="op" id="5195996">(</span><span class="op" id="5195997">)</span>&nbsp;<span class="op" id="5195999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196003">return</span>&nbsp;<span class="builtintype" id="5196010">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196020">key</span>&nbsp;<span class="op" id="5196024">:=</span>&nbsp;<span class="ident" id="5196027">pconn</span><span class="op" id="5196032">.</span><span class="ident" id="5196033">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196043">max</span>&nbsp;<span class="op" id="5196047">:=</span>&nbsp;<span class="ident" id="5196050">t</span><span class="op" id="5196051">.</span><span class="ident" id="5196052">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196073">if</span>&nbsp;<span class="ident" id="5196076">max</span>&nbsp;<span class="op" id="5196080">==</span>&nbsp;<span class="num" id="5196083">0</span>&nbsp;<span class="op" id="5196085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196089">max</span>&nbsp;<span class="op" id="5196093">=</span>&nbsp;<span class="ident" id="5196095">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196126">t</span><span class="op" id="5196127">.</span><span class="ident" id="5196128">idleMu</span><span class="op" id="5196134">.</span><span class="ident" id="5196135">Lock</span><span class="op" id="5196139">(</span><span class="op" id="5196140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196144">waitingDialer</span>&nbsp;<span class="op" id="5196158">:=</span>&nbsp;<span class="ident" id="5196161">t</span><span class="op" id="5196162">.</span><span class="ident" id="5196163">idleConnCh</span><span class="op" id="5196173">[</span><span class="ident" id="5196174">key</span><span class="op" id="5196177">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196180">select</span>&nbsp;<span class="op" id="5196187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196190">case</span>&nbsp;<span class="ident" id="5196195">waitingDialer</span>&nbsp;<span class="op" id="5196209">&lt;-</span>&nbsp;<span class="ident" id="5196212">pconn</span><span class="op" id="5196217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196221">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196274">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196330">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196376">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196433">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196501">t</span><span class="op" id="5196502">.</span><span class="ident" id="5196503">idleMu</span><span class="op" id="5196509">.</span><span class="ident" id="5196510">Unlock</span><span class="op" id="5196516">(</span><span class="op" id="5196517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196521">return</span>&nbsp;<span class="builtintype" id="5196528">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196534">default</span><span class="op" id="5196541">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196545">if</span>&nbsp;<span class="ident" id="5196548">waitingDialer</span>&nbsp;<span class="op" id="5196562">!=</span>&nbsp;<span class="ident" id="5196565">nil</span>&nbsp;<span class="op" id="5196569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196574">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5196624">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5196672">delete</span><span class="op" id="5196678">(</span><span class="ident" id="5196679">t</span><span class="op" id="5196680">.</span><span class="ident" id="5196681">idleConnCh</span><span class="op" id="5196691">,</span>&nbsp;<span class="ident" id="5196693">key</span><span class="op" id="5196696">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196706">if</span>&nbsp;<span class="ident" id="5196709">t</span><span class="op" id="5196710">.</span><span class="ident" id="5196711">wantIdle</span>&nbsp;<span class="op" id="5196720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196724">t</span><span class="op" id="5196725">.</span><span class="ident" id="5196726">idleMu</span><span class="op" id="5196732">.</span><span class="ident" id="5196733">Unlock</span><span class="op" id="5196739">(</span><span class="op" id="5196740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196744">pconn</span><span class="op" id="5196749">.</span><span class="builtinfunc" id="5196750">close</span><span class="op" id="5196755">(</span><span class="op" id="5196756">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196760">return</span>&nbsp;<span class="builtintype" id="5196767">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196777">if</span>&nbsp;<span class="ident" id="5196780">t</span><span class="op" id="5196781">.</span><span class="ident" id="5196782">idleConn</span>&nbsp;<span class="op" id="5196791">==</span>&nbsp;<span class="ident" id="5196794">nil</span>&nbsp;<span class="op" id="5196798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196802">t</span><span class="op" id="5196803">.</span><span class="ident" id="5196804">idleConn</span>&nbsp;<span class="op" id="5196813">=</span>&nbsp;<span class="builtinfunc" id="5196815">make</span><span class="op" id="5196819">(</span><span class="keyword" id="5196820">map</span><span class="op" id="5196823">[</span><span class="ident" id="5196824">connectMethodKey</span><span class="op" id="5196840">]</span><span class="op" id="5196841">[</span><span class="op" id="5196842">]</span><span class="op" id="5196843">*</span><span class="ident" id="5196844">persistConn</span><span class="op" id="5196855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196858">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196861">if</span>&nbsp;<span class="builtinfunc" id="5196864">len</span><span class="op" id="5196867">(</span><span class="ident" id="5196868">t</span><span class="op" id="5196869">.</span><span class="ident" id="5196870">idleConn</span><span class="op" id="5196878">[</span><span class="ident" id="5196879">key</span><span class="op" id="5196882">]</span><span class="op" id="5196883">)</span>&nbsp;<span class="op" id="5196885">&gt;=</span>&nbsp;<span class="ident" id="5196888">max</span>&nbsp;<span class="op" id="5196892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196896">t</span><span class="op" id="5196897">.</span><span class="ident" id="5196898">idleMu</span><span class="op" id="5196904">.</span><span class="ident" id="5196905">Unlock</span><span class="op" id="5196911">(</span><span class="op" id="5196912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5196916">pconn</span><span class="op" id="5196921">.</span><span class="builtinfunc" id="5196922">close</span><span class="op" id="5196927">(</span><span class="op" id="5196928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196932">return</span>&nbsp;<span class="builtintype" id="5196939">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5196946">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196949">for</span>&nbsp;<span class="ident" id="5196953">_</span><span class="op" id="5196954">,</span>&nbsp;<span class="ident" id="5196956">exist</span>&nbsp;<span class="op" id="5196962">:=</span>&nbsp;<span class="keyword" id="5196965">range</span>&nbsp;<span class="ident" id="5196971">t</span><span class="op" id="5196972">.</span><span class="ident" id="5196973">idleConn</span><span class="op" id="5196981">[</span><span class="ident" id="5196982">key</span><span class="op" id="5196985">]</span>&nbsp;<span class="op" id="5196987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5196991">if</span>&nbsp;<span class="ident" id="5196994">exist</span>&nbsp;<span class="op" id="5197000">==</span>&nbsp;<span class="ident" id="5197003">pconn</span>&nbsp;<span class="op" id="5197009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197014">log</span><span class="op" id="5197017">.</span><span class="ident" id="5197018">Fatalf</span><span class="op" id="5197024">(</span><span class="string" id="5197025">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="5197056">,</span>&nbsp;<span class="ident" id="5197058">pconn</span><span class="op" id="5197063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197070">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197073">t</span><span class="op" id="5197074">.</span><span class="ident" id="5197075">idleConn</span><span class="op" id="5197083">[</span><span class="ident" id="5197084">key</span><span class="op" id="5197087">]</span>&nbsp;<span class="op" id="5197089">=</span>&nbsp;<span class="builtinfunc" id="5197091">append</span><span class="op" id="5197097">(</span><span class="ident" id="5197098">t</span><span class="op" id="5197099">.</span><span class="ident" id="5197100">idleConn</span><span class="op" id="5197108">[</span><span class="ident" id="5197109">key</span><span class="op" id="5197112">]</span><span class="op" id="5197113">,</span>&nbsp;<span class="ident" id="5197115">pconn</span><span class="op" id="5197120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197123">t</span><span class="op" id="5197124">.</span><span class="ident" id="5197125">idleMu</span><span class="op" id="5197131">.</span><span class="ident" id="5197132">Unlock</span><span class="op" id="5197138">(</span><span class="op" id="5197139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197142">return</span>&nbsp;<span class="builtintype" id="5197149">true</span><br>
<span class="lineno"></span><span class="op" id="5197154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="5197157">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5197219">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="5197273">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5197341">func</span>&nbsp;<span class="op" id="5197346">(</span><span class="ident" id="5197347">t</span>&nbsp;<span class="op" id="5197349">*</span><span class="ident" id="5197350">Transport</span><span class="op" id="5197359">)</span>&nbsp;<span class="ident" id="5197361">getIdleConnCh</span><span class="op" id="5197374">(</span><span class="ident" id="5197375">cm</span>&nbsp;<span class="ident" id="5197378">connectMethod</span><span class="op" id="5197391">)</span>&nbsp;<span class="keyword" id="5197393">chan</span>&nbsp;<span class="op" id="5197398">*</span><span class="ident" id="5197399">persistConn</span>&nbsp;<span class="op" id="5197411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197414">if</span>&nbsp;<span class="ident" id="5197417">t</span><span class="op" id="5197418">.</span><span class="ident" id="5197419">DisableKeepAlives</span>&nbsp;<span class="op" id="5197437">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197441">return</span>&nbsp;<span class="ident" id="5197448">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197456">key</span>&nbsp;<span class="op" id="5197460">:=</span>&nbsp;<span class="ident" id="5197463">cm</span><span class="op" id="5197465">.</span><span class="ident" id="5197466">key</span><span class="op" id="5197469">(</span><span class="op" id="5197470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197473">t</span><span class="op" id="5197474">.</span><span class="ident" id="5197475">idleMu</span><span class="op" id="5197481">.</span><span class="ident" id="5197482">Lock</span><span class="op" id="5197486">(</span><span class="op" id="5197487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197490">defer</span>&nbsp;<span class="ident" id="5197496">t</span><span class="op" id="5197497">.</span><span class="ident" id="5197498">idleMu</span><span class="op" id="5197504">.</span><span class="ident" id="5197505">Unlock</span><span class="op" id="5197511">(</span><span class="op" id="5197512">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197515">t</span><span class="op" id="5197516">.</span><span class="ident" id="5197517">wantIdle</span>&nbsp;<span class="op" id="5197526">=</span>&nbsp;<span class="builtintype" id="5197528">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197535">if</span>&nbsp;<span class="ident" id="5197538">t</span><span class="op" id="5197539">.</span><span class="ident" id="5197540">idleConnCh</span>&nbsp;<span class="op" id="5197551">==</span>&nbsp;<span class="ident" id="5197554">nil</span>&nbsp;<span class="op" id="5197558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197562">t</span><span class="op" id="5197563">.</span><span class="ident" id="5197564">idleConnCh</span>&nbsp;<span class="op" id="5197575">=</span>&nbsp;<span class="builtinfunc" id="5197577">make</span><span class="op" id="5197581">(</span><span class="keyword" id="5197582">map</span><span class="op" id="5197585">[</span><span class="ident" id="5197586">connectMethodKey</span><span class="op" id="5197602">]</span><span class="keyword" id="5197603">chan</span>&nbsp;<span class="op" id="5197608">*</span><span class="ident" id="5197609">persistConn</span><span class="op" id="5197620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197626">ch</span><span class="op" id="5197628">,</span>&nbsp;<span class="ident" id="5197630">ok</span>&nbsp;<span class="op" id="5197633">:=</span>&nbsp;<span class="ident" id="5197636">t</span><span class="op" id="5197637">.</span><span class="ident" id="5197638">idleConnCh</span><span class="op" id="5197648">[</span><span class="ident" id="5197649">key</span><span class="op" id="5197652">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197655">if</span>&nbsp;<span class="op" id="5197658">!</span><span class="ident" id="5197659">ok</span>&nbsp;<span class="op" id="5197662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197666">ch</span>&nbsp;<span class="op" id="5197669">=</span>&nbsp;<span class="builtinfunc" id="5197671">make</span><span class="op" id="5197675">(</span><span class="keyword" id="5197676">chan</span>&nbsp;<span class="op" id="5197681">*</span><span class="ident" id="5197682">persistConn</span><span class="op" id="5197693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197697">t</span><span class="op" id="5197698">.</span><span class="ident" id="5197699">idleConnCh</span><span class="op" id="5197709">[</span><span class="ident" id="5197710">key</span><span class="op" id="5197713">]</span>&nbsp;<span class="op" id="5197715">=</span>&nbsp;<span class="ident" id="5197717">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197724">return</span>&nbsp;<span class="ident" id="5197731">ch</span><br>
<span class="lineno">435</span><span class="op" id="5197734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5197737">func</span>&nbsp;<span class="op" id="5197742">(</span><span class="ident" id="5197743">t</span>&nbsp;<span class="op" id="5197745">*</span><span class="ident" id="5197746">Transport</span><span class="op" id="5197755">)</span>&nbsp;<span class="ident" id="5197757">getIdleConn</span><span class="op" id="5197768">(</span><span class="ident" id="5197769">cm</span>&nbsp;<span class="ident" id="5197772">connectMethod</span><span class="op" id="5197785">)</span>&nbsp;<span class="op" id="5197787">(</span><span class="ident" id="5197788">pconn</span>&nbsp;<span class="op" id="5197794">*</span><span class="ident" id="5197795">persistConn</span><span class="op" id="5197806">)</span>&nbsp;<span class="op" id="5197808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197811">key</span>&nbsp;<span class="op" id="5197815">:=</span>&nbsp;<span class="ident" id="5197818">cm</span><span class="op" id="5197820">.</span><span class="ident" id="5197821">key</span><span class="op" id="5197824">(</span><span class="op" id="5197825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197828">t</span><span class="op" id="5197829">.</span><span class="ident" id="5197830">idleMu</span><span class="op" id="5197836">.</span><span class="ident" id="5197837">Lock</span><span class="op" id="5197841">(</span><span class="op" id="5197842">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197845">defer</span>&nbsp;<span class="ident" id="5197851">t</span><span class="op" id="5197852">.</span><span class="ident" id="5197853">idleMu</span><span class="op" id="5197859">.</span><span class="ident" id="5197860">Unlock</span><span class="op" id="5197866">(</span><span class="op" id="5197867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197870">if</span>&nbsp;<span class="ident" id="5197873">t</span><span class="op" id="5197874">.</span><span class="ident" id="5197875">idleConn</span>&nbsp;<span class="op" id="5197884">==</span>&nbsp;<span class="ident" id="5197887">nil</span>&nbsp;<span class="op" id="5197891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197895">return</span>&nbsp;<span class="ident" id="5197902">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197910">for</span>&nbsp;<span class="op" id="5197914">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5197918">pconns</span><span class="op" id="5197924">,</span>&nbsp;<span class="ident" id="5197926">ok</span>&nbsp;<span class="op" id="5197929">:=</span>&nbsp;<span class="ident" id="5197932">t</span><span class="op" id="5197933">.</span><span class="ident" id="5197934">idleConn</span><span class="op" id="5197942">[</span><span class="ident" id="5197943">key</span><span class="op" id="5197946">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197950">if</span>&nbsp;<span class="op" id="5197953">!</span><span class="ident" id="5197954">ok</span>&nbsp;<span class="op" id="5197957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197962">return</span>&nbsp;<span class="ident" id="5197969">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5197975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5197979">if</span>&nbsp;<span class="builtinfunc" id="5197982">len</span><span class="op" id="5197985">(</span><span class="ident" id="5197986">pconns</span><span class="op" id="5197992">)</span>&nbsp;<span class="op" id="5197994">==</span>&nbsp;<span class="num" id="5197997">1</span>&nbsp;<span class="op" id="5197999">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198004">pconn</span>&nbsp;<span class="op" id="5198010">=</span>&nbsp;<span class="ident" id="5198012">pconns</span><span class="op" id="5198018">[</span><span class="num" id="5198019">0</span><span class="op" id="5198020">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5198025">delete</span><span class="op" id="5198031">(</span><span class="ident" id="5198032">t</span><span class="op" id="5198033">.</span><span class="ident" id="5198034">idleConn</span><span class="op" id="5198042">,</span>&nbsp;<span class="ident" id="5198044">key</span><span class="op" id="5198047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198051">}</span>&nbsp;<span class="keyword" id="5198053">else</span>&nbsp;<span class="op" id="5198058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5198063">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5198108">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198127">pconn</span>&nbsp;<span class="op" id="5198133">=</span>&nbsp;<span class="ident" id="5198135">pconns</span><span class="op" id="5198141">[</span><span class="builtinfunc" id="5198142">len</span><span class="op" id="5198145">(</span><span class="ident" id="5198146">pconns</span><span class="op" id="5198152">)</span><span class="op" id="5198153">-</span><span class="num" id="5198154">1</span><span class="op" id="5198155">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198160">t</span><span class="op" id="5198161">.</span><span class="ident" id="5198162">idleConn</span><span class="op" id="5198170">[</span><span class="ident" id="5198171">key</span><span class="op" id="5198174">]</span>&nbsp;<span class="op" id="5198176">=</span>&nbsp;<span class="ident" id="5198178">pconns</span><span class="op" id="5198184">[</span><span class="op" id="5198185">:</span><span class="builtinfunc" id="5198186">len</span><span class="op" id="5198189">(</span><span class="ident" id="5198190">pconns</span><span class="op" id="5198196">)</span><span class="op" id="5198197">-</span><span class="num" id="5198198">1</span><span class="op" id="5198199">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198207">if</span>&nbsp;<span class="op" id="5198210">!</span><span class="ident" id="5198211">pconn</span><span class="op" id="5198216">.</span><span class="ident" id="5198217">isBroken</span><span class="op" id="5198225">(</span><span class="op" id="5198226">)</span>&nbsp;<span class="op" id="5198228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198233">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198245">}</span><br>
<span class="lineno"></span><span class="op" id="5198247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5198250">func</span>&nbsp;<span class="op" id="5198255">(</span><span class="ident" id="5198256">t</span>&nbsp;<span class="op" id="5198258">*</span><span class="ident" id="5198259">Transport</span><span class="op" id="5198268">)</span>&nbsp;<span class="ident" id="5198270">setReqCanceler</span><span class="op" id="5198284">(</span><span class="ident" id="5198285">r</span>&nbsp;<span class="op" id="5198287">*</span><span class="ident" id="5198288">Request</span><span class="op" id="5198295">,</span>&nbsp;<span class="ident" id="5198297">fn</span>&nbsp;<span class="keyword" id="5198300">func</span><span class="op" id="5198304">(</span><span class="op" id="5198305">)</span><span class="op" id="5198306">)</span>&nbsp;<span class="op" id="5198308">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198311">t</span><span class="op" id="5198312">.</span><span class="ident" id="5198313">reqMu</span><span class="op" id="5198318">.</span><span class="ident" id="5198319">Lock</span><span class="op" id="5198323">(</span><span class="op" id="5198324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198327">defer</span>&nbsp;<span class="ident" id="5198333">t</span><span class="op" id="5198334">.</span><span class="ident" id="5198335">reqMu</span><span class="op" id="5198340">.</span><span class="ident" id="5198341">Unlock</span><span class="op" id="5198347">(</span><span class="op" id="5198348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198351">if</span>&nbsp;<span class="ident" id="5198354">t</span><span class="op" id="5198355">.</span><span class="ident" id="5198356">reqCanceler</span>&nbsp;<span class="op" id="5198368">==</span>&nbsp;<span class="ident" id="5198371">nil</span>&nbsp;<span class="op" id="5198375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198379">t</span><span class="op" id="5198380">.</span><span class="ident" id="5198381">reqCanceler</span>&nbsp;<span class="op" id="5198393">=</span>&nbsp;<span class="builtinfunc" id="5198395">make</span><span class="op" id="5198399">(</span><span class="keyword" id="5198400">map</span><span class="op" id="5198403">[</span><span class="op" id="5198404">*</span><span class="ident" id="5198405">Request</span><span class="op" id="5198412">]</span><span class="keyword" id="5198413">func</span><span class="op" id="5198417">(</span><span class="op" id="5198418">)</span><span class="op" id="5198419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198422">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198425">if</span>&nbsp;<span class="ident" id="5198428">fn</span>&nbsp;<span class="op" id="5198431">!=</span>&nbsp;<span class="ident" id="5198434">nil</span>&nbsp;<span class="op" id="5198438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5198442">t</span><span class="op" id="5198443">.</span><span class="ident" id="5198444">reqCanceler</span><span class="op" id="5198455">[</span><span class="ident" id="5198456">r</span><span class="op" id="5198457">]</span>&nbsp;<span class="op" id="5198459">=</span>&nbsp;<span class="ident" id="5198461">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198465">}</span>&nbsp;<span class="keyword" id="5198467">else</span>&nbsp;<span class="op" id="5198472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5198476">delete</span><span class="op" id="5198482">(</span><span class="ident" id="5198483">t</span><span class="op" id="5198484">.</span><span class="ident" id="5198485">reqCanceler</span><span class="op" id="5198496">,</span>&nbsp;<span class="ident" id="5198498">r</span><span class="op" id="5198499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198502">}</span><br>
<span class="lineno">475</span><span class="op" id="5198504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5198507">func</span>&nbsp;<span class="op" id="5198512">(</span><span class="ident" id="5198513">t</span>&nbsp;<span class="op" id="5198515">*</span><span class="ident" id="5198516">Transport</span><span class="op" id="5198525">)</span>&nbsp;<span class="ident" id="5198527">dial</span><span class="op" id="5198531">(</span><span class="ident" id="5198532">network</span><span class="op" id="5198539">,</span>&nbsp;<span class="ident" id="5198541">addr</span>&nbsp;<span class="builtintype" id="5198546">string</span><span class="op" id="5198552">)</span>&nbsp;<span class="op" id="5198554">(</span><span class="ident" id="5198555">c</span>&nbsp;<span class="ident" id="5198557">net</span><span class="op" id="5198560">.</span><span class="ident" id="5198561">Conn</span><span class="op" id="5198565">,</span>&nbsp;<span class="ident" id="5198567">err</span>&nbsp;<span class="builtintype" id="5198571">error</span><span class="op" id="5198576">)</span>&nbsp;<span class="op" id="5198578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198581">if</span>&nbsp;<span class="ident" id="5198584">t</span><span class="op" id="5198585">.</span><span class="ident" id="5198586">Dial</span>&nbsp;<span class="op" id="5198591">!=</span>&nbsp;<span class="ident" id="5198594">nil</span>&nbsp;<span class="op" id="5198598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198602">return</span>&nbsp;<span class="ident" id="5198609">t</span><span class="op" id="5198610">.</span><span class="ident" id="5198611">Dial</span><span class="op" id="5198615">(</span><span class="ident" id="5198616">network</span><span class="op" id="5198623">,</span>&nbsp;<span class="ident" id="5198625">addr</span><span class="op" id="5198629">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5198632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5198635">return</span>&nbsp;<span class="ident" id="5198642">net</span><span class="op" id="5198645">.</span><span class="ident" id="5198646">Dial</span><span class="op" id="5198650">(</span><span class="ident" id="5198651">network</span><span class="op" id="5198658">,</span>&nbsp;<span class="ident" id="5198660">addr</span><span class="op" id="5198664">)</span><br>
<span class="lineno"></span><span class="op" id="5198666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5198669">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="5198687">var</span>&nbsp;<span class="ident" id="5198691">prePendingDial</span><span class="op" id="5198705">,</span>&nbsp;<span class="ident" id="5198707">postPendingDial</span>&nbsp;<span class="keyword" id="5198723">func</span><span class="op" id="5198727">(</span><span class="op" id="5198728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5198731">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5198795">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="5198867">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="5198943">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="5198977">func</span>&nbsp;<span class="op" id="5198982">(</span><span class="ident" id="5198983">t</span>&nbsp;<span class="op" id="5198985">*</span><span class="ident" id="5198986">Transport</span><span class="op" id="5198995">)</span>&nbsp;<span class="ident" id="5198997">getConn</span><span class="op" id="5199004">(</span><span class="ident" id="5199005">req</span>&nbsp;<span class="op" id="5199009">*</span><span class="ident" id="5199010">Request</span><span class="op" id="5199017">,</span>&nbsp;<span class="ident" id="5199019">cm</span>&nbsp;<span class="ident" id="5199022">connectMethod</span><span class="op" id="5199035">)</span>&nbsp;<span class="op" id="5199037">(</span><span class="op" id="5199038">*</span><span class="ident" id="5199039">persistConn</span><span class="op" id="5199050">,</span>&nbsp;<span class="builtintype" id="5199052">error</span><span class="op" id="5199057">)</span>&nbsp;<span class="op" id="5199059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199062">if</span>&nbsp;<span class="ident" id="5199065">pc</span>&nbsp;<span class="op" id="5199068">:=</span>&nbsp;<span class="ident" id="5199071">t</span><span class="op" id="5199072">.</span><span class="ident" id="5199073">getIdleConn</span><span class="op" id="5199084">(</span><span class="ident" id="5199085">cm</span><span class="op" id="5199087">)</span><span class="op" id="5199088">;</span>&nbsp;<span class="ident" id="5199090">pc</span>&nbsp;<span class="op" id="5199093">!=</span>&nbsp;<span class="ident" id="5199096">nil</span>&nbsp;<span class="op" id="5199100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199104">return</span>&nbsp;<span class="ident" id="5199111">pc</span><span class="op" id="5199113">,</span>&nbsp;<span class="ident" id="5199115">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199120">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199124">type</span>&nbsp;<span class="ident" id="5199129">dialRes</span>&nbsp;<span class="keyword" id="5199137">struct</span>&nbsp;<span class="op" id="5199144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199148">pc</span>&nbsp;&nbsp;<span class="op" id="5199152">*</span><span class="ident" id="5199153">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199167">err</span>&nbsp;<span class="builtintype" id="5199171">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199178">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199181">dialc</span>&nbsp;<span class="op" id="5199187">:=</span>&nbsp;<span class="builtinfunc" id="5199190">make</span><span class="op" id="5199194">(</span><span class="keyword" id="5199195">chan</span>&nbsp;<span class="ident" id="5199200">dialRes</span><span class="op" id="5199207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199211">handlePendingDial</span>&nbsp;<span class="op" id="5199229">:=</span>&nbsp;<span class="keyword" id="5199232">func</span><span class="op" id="5199236">(</span><span class="op" id="5199237">)</span>&nbsp;<span class="op" id="5199239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199243">if</span>&nbsp;<span class="ident" id="5199246">prePendingDial</span>&nbsp;<span class="op" id="5199261">!=</span>&nbsp;<span class="ident" id="5199264">nil</span>&nbsp;<span class="op" id="5199268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199273">prePendingDial</span><span class="op" id="5199287">(</span><span class="op" id="5199288">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199296">go</span>&nbsp;<span class="keyword" id="5199299">func</span><span class="op" id="5199303">(</span><span class="op" id="5199304">)</span>&nbsp;<span class="op" id="5199306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199311">if</span>&nbsp;<span class="ident" id="5199314">v</span>&nbsp;<span class="op" id="5199316">:=</span>&nbsp;<span class="op" id="5199319">&lt;-</span><span class="ident" id="5199321">dialc</span><span class="op" id="5199326">;</span>&nbsp;<span class="ident" id="5199328">v</span><span class="op" id="5199329">.</span><span class="ident" id="5199330">err</span>&nbsp;<span class="op" id="5199334">==</span>&nbsp;<span class="ident" id="5199337">nil</span>&nbsp;<span class="op" id="5199341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199347">t</span><span class="op" id="5199348">.</span><span class="ident" id="5199349">putIdleConn</span><span class="op" id="5199360">(</span><span class="ident" id="5199361">v</span><span class="op" id="5199362">.</span><span class="ident" id="5199363">pc</span><span class="op" id="5199365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199370">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199375">if</span>&nbsp;<span class="ident" id="5199378">postPendingDial</span>&nbsp;<span class="op" id="5199394">!=</span>&nbsp;<span class="ident" id="5199397">nil</span>&nbsp;<span class="op" id="5199401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199407">postPendingDial</span><span class="op" id="5199422">(</span><span class="op" id="5199423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199432">}</span><span class="op" id="5199433">(</span><span class="op" id="5199434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199437">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199441">cancelc</span>&nbsp;<span class="op" id="5199449">:=</span>&nbsp;<span class="builtinfunc" id="5199452">make</span><span class="op" id="5199456">(</span><span class="keyword" id="5199457">chan</span>&nbsp;<span class="keyword" id="5199462">struct</span><span class="op" id="5199468">{</span><span class="op" id="5199469">}</span><span class="op" id="5199470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199473">t</span><span class="op" id="5199474">.</span><span class="ident" id="5199475">setReqCanceler</span><span class="op" id="5199489">(</span><span class="ident" id="5199490">req</span><span class="op" id="5199493">,</span>&nbsp;<span class="keyword" id="5199495">func</span><span class="op" id="5199499">(</span><span class="op" id="5199500">)</span>&nbsp;<span class="op" id="5199502">{</span>&nbsp;<span class="builtinfunc" id="5199504">close</span><span class="op" id="5199509">(</span><span class="ident" id="5199510">cancelc</span><span class="op" id="5199517">)</span>&nbsp;<span class="op" id="5199519">}</span><span class="op" id="5199520">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199524">go</span>&nbsp;<span class="keyword" id="5199527">func</span><span class="op" id="5199531">(</span><span class="op" id="5199532">)</span>&nbsp;<span class="op" id="5199534">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199538">pc</span><span class="op" id="5199540">,</span>&nbsp;<span class="ident" id="5199542">err</span>&nbsp;<span class="op" id="5199546">:=</span>&nbsp;<span class="ident" id="5199549">t</span><span class="op" id="5199550">.</span><span class="ident" id="5199551">dialConn</span><span class="op" id="5199559">(</span><span class="ident" id="5199560">cm</span><span class="op" id="5199562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199566">dialc</span>&nbsp;<span class="op" id="5199572">&lt;-</span>&nbsp;<span class="ident" id="5199575">dialRes</span><span class="op" id="5199582">{</span><span class="ident" id="5199583">pc</span><span class="op" id="5199585">,</span>&nbsp;<span class="ident" id="5199587">err</span><span class="op" id="5199590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5199593">}</span><span class="op" id="5199594">(</span><span class="op" id="5199595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199599">idleConnCh</span>&nbsp;<span class="op" id="5199610">:=</span>&nbsp;<span class="ident" id="5199613">t</span><span class="op" id="5199614">.</span><span class="ident" id="5199615">getIdleConnCh</span><span class="op" id="5199628">(</span><span class="ident" id="5199629">cm</span><span class="op" id="5199631">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199634">select</span>&nbsp;<span class="op" id="5199641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199644">case</span>&nbsp;<span class="ident" id="5199649">v</span>&nbsp;<span class="op" id="5199651">:=</span>&nbsp;<span class="op" id="5199654">&lt;-</span><span class="ident" id="5199656">dialc</span><span class="op" id="5199661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5199665">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199689">return</span>&nbsp;<span class="ident" id="5199696">v</span><span class="op" id="5199697">.</span><span class="ident" id="5199698">pc</span><span class="op" id="5199700">,</span>&nbsp;<span class="ident" id="5199702">v</span><span class="op" id="5199703">.</span><span class="ident" id="5199704">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199709">case</span>&nbsp;<span class="ident" id="5199714">pc</span>&nbsp;<span class="op" id="5199717">:=</span>&nbsp;<span class="op" id="5199720">&lt;-</span><span class="ident" id="5199722">idleConnCh</span><span class="op" id="5199732">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5199736">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5199789">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5199840">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5199879">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5199929">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5199952">handlePendingDial</span><span class="op" id="5199969">(</span><span class="op" id="5199970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199974">return</span>&nbsp;<span class="ident" id="5199981">pc</span><span class="op" id="5199983">,</span>&nbsp;<span class="ident" id="5199985">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5199990">case</span>&nbsp;<span class="op" id="5199995">&lt;-</span><span class="ident" id="5199997">cancelc</span><span class="op" id="5200004">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200008">handlePendingDial</span><span class="op" id="5200025">(</span><span class="op" id="5200026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200030">return</span>&nbsp;<span class="ident" id="5200037">nil</span><span class="op" id="5200040">,</span>&nbsp;<span class="ident" id="5200042">errors</span><span class="op" id="5200048">.</span><span class="ident" id="5200049">New</span><span class="op" id="5200052">(</span><span class="string" id="5200053">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="5200110">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5200113">}</span><br>
<span class="lineno"></span><span class="op" id="5200115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5200118">func</span>&nbsp;<span class="op" id="5200123">(</span><span class="ident" id="5200124">t</span>&nbsp;<span class="op" id="5200126">*</span><span class="ident" id="5200127">Transport</span><span class="op" id="5200136">)</span>&nbsp;<span class="ident" id="5200138">dialConn</span><span class="op" id="5200146">(</span><span class="ident" id="5200147">cm</span>&nbsp;<span class="ident" id="5200150">connectMethod</span><span class="op" id="5200163">)</span>&nbsp;<span class="op" id="5200165">(</span><span class="op" id="5200166">*</span><span class="ident" id="5200167">persistConn</span><span class="op" id="5200178">,</span>&nbsp;<span class="builtintype" id="5200180">error</span><span class="op" id="5200185">)</span>&nbsp;<span class="op" id="5200187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200190">pconn</span>&nbsp;<span class="op" id="5200196">:=</span>&nbsp;<span class="op" id="5200199">&amp;</span><span class="ident" id="5200200">persistConn</span><span class="op" id="5200211">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200215">t</span><span class="op" id="5200216">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5200227">t</span><span class="op" id="5200228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200232">cacheKey</span><span class="op" id="5200240">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5200244">cm</span><span class="op" id="5200246">.</span><span class="ident" id="5200247">key</span><span class="op" id="5200250">(</span><span class="op" id="5200251">)</span><span class="op" id="5200252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200256">reqch</span><span class="op" id="5200261">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5200268">make</span><span class="op" id="5200272">(</span><span class="keyword" id="5200273">chan</span>&nbsp;<span class="ident" id="5200278">requestAndChan</span><span class="op" id="5200292">,</span>&nbsp;<span class="num" id="5200294">1</span><span class="op" id="5200295">)</span><span class="op" id="5200296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200300">writech</span><span class="op" id="5200307">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5200312">make</span><span class="op" id="5200316">(</span><span class="keyword" id="5200317">chan</span>&nbsp;<span class="ident" id="5200322">writeRequest</span><span class="op" id="5200334">,</span>&nbsp;<span class="num" id="5200336">1</span><span class="op" id="5200337">)</span><span class="op" id="5200338">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200342">closech</span><span class="op" id="5200349">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5200354">make</span><span class="op" id="5200358">(</span><span class="keyword" id="5200359">chan</span>&nbsp;<span class="keyword" id="5200364">struct</span><span class="op" id="5200370">{</span><span class="op" id="5200371">}</span><span class="op" id="5200372">)</span><span class="op" id="5200373">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200377">writeErrCh</span><span class="op" id="5200387">:</span>&nbsp;<span class="builtinfunc" id="5200389">make</span><span class="op" id="5200393">(</span><span class="keyword" id="5200394">chan</span>&nbsp;<span class="builtintype" id="5200399">error</span><span class="op" id="5200404">,</span>&nbsp;<span class="num" id="5200406">1</span><span class="op" id="5200407">)</span><span class="op" id="5200408">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5200411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200414">tlsDial</span>&nbsp;<span class="op" id="5200422">:=</span>&nbsp;<span class="ident" id="5200425">t</span><span class="op" id="5200426">.</span><span class="ident" id="5200427">DialTLS</span>&nbsp;<span class="op" id="5200435">!=</span>&nbsp;<span class="ident" id="5200438">nil</span>&nbsp;<span class="op" id="5200442">&amp;&amp;</span>&nbsp;<span class="ident" id="5200445">cm</span><span class="op" id="5200447">.</span><span class="ident" id="5200448">targetScheme</span>&nbsp;<span class="op" id="5200461">==</span>&nbsp;<span class="string" id="5200464">&#34;https&#34;</span>&nbsp;<span class="op" id="5200472">&amp;&amp;</span>&nbsp;<span class="ident" id="5200475">cm</span><span class="op" id="5200477">.</span><span class="ident" id="5200478">proxyURL</span>&nbsp;<span class="op" id="5200487">==</span>&nbsp;<span class="ident" id="5200490">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200495">if</span>&nbsp;<span class="ident" id="5200498">tlsDial</span>&nbsp;<span class="op" id="5200506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200510">var</span>&nbsp;<span class="ident" id="5200514">err</span>&nbsp;<span class="builtintype" id="5200518">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200526">pconn</span><span class="op" id="5200531">.</span><span class="ident" id="5200532">conn</span><span class="op" id="5200536">,</span>&nbsp;<span class="ident" id="5200538">err</span>&nbsp;<span class="op" id="5200542">=</span>&nbsp;<span class="ident" id="5200544">t</span><span class="op" id="5200545">.</span><span class="ident" id="5200546">DialTLS</span><span class="op" id="5200553">(</span><span class="string" id="5200554">&#34;tcp&#34;</span><span class="op" id="5200559">,</span>&nbsp;<span class="ident" id="5200561">cm</span><span class="op" id="5200563">.</span><span class="ident" id="5200564">addr</span><span class="op" id="5200568">(</span><span class="op" id="5200569">)</span><span class="op" id="5200570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200574">if</span>&nbsp;<span class="ident" id="5200577">err</span>&nbsp;<span class="op" id="5200581">!=</span>&nbsp;<span class="ident" id="5200584">nil</span>&nbsp;<span class="op" id="5200588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200593">return</span>&nbsp;<span class="ident" id="5200600">nil</span><span class="op" id="5200603">,</span>&nbsp;<span class="ident" id="5200605">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5200611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200615">if</span>&nbsp;<span class="ident" id="5200618">tc</span><span class="op" id="5200620">,</span>&nbsp;<span class="ident" id="5200622">ok</span>&nbsp;<span class="op" id="5200625">:=</span>&nbsp;<span class="ident" id="5200628">pconn</span><span class="op" id="5200633">.</span><span class="ident" id="5200634">conn</span><span class="op" id="5200638">.</span><span class="op" id="5200639">(</span><span class="op" id="5200640">*</span><span class="ident" id="5200641">tls</span><span class="op" id="5200644">.</span><span class="ident" id="5200645">Conn</span><span class="op" id="5200649">)</span><span class="op" id="5200650">;</span>&nbsp;<span class="ident" id="5200652">ok</span>&nbsp;<span class="op" id="5200655">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200660">cs</span>&nbsp;<span class="op" id="5200663">:=</span>&nbsp;<span class="ident" id="5200666">tc</span><span class="op" id="5200668">.</span><span class="ident" id="5200669">ConnectionState</span><span class="op" id="5200684">(</span><span class="op" id="5200685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200690">pconn</span><span class="op" id="5200695">.</span><span class="ident" id="5200696">tlsState</span>&nbsp;<span class="op" id="5200705">=</span>&nbsp;<span class="op" id="5200707">&amp;</span><span class="ident" id="5200708">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5200713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5200716">}</span>&nbsp;<span class="keyword" id="5200718">else</span>&nbsp;<span class="op" id="5200723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200727">conn</span><span class="op" id="5200731">,</span>&nbsp;<span class="ident" id="5200733">err</span>&nbsp;<span class="op" id="5200737">:=</span>&nbsp;<span class="ident" id="5200740">t</span><span class="op" id="5200741">.</span><span class="ident" id="5200742">dial</span><span class="op" id="5200746">(</span><span class="string" id="5200747">&#34;tcp&#34;</span><span class="op" id="5200752">,</span>&nbsp;<span class="ident" id="5200754">cm</span><span class="op" id="5200756">.</span><span class="ident" id="5200757">addr</span><span class="op" id="5200761">(</span><span class="op" id="5200762">)</span><span class="op" id="5200763">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200767">if</span>&nbsp;<span class="ident" id="5200770">err</span>&nbsp;<span class="op" id="5200774">!=</span>&nbsp;<span class="ident" id="5200777">nil</span>&nbsp;<span class="op" id="5200781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200786">if</span>&nbsp;<span class="ident" id="5200789">cm</span><span class="op" id="5200791">.</span><span class="ident" id="5200792">proxyURL</span>&nbsp;<span class="op" id="5200801">!=</span>&nbsp;<span class="ident" id="5200804">nil</span>&nbsp;<span class="op" id="5200808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200814">err</span>&nbsp;<span class="op" id="5200818">=</span>&nbsp;<span class="ident" id="5200820">fmt</span><span class="op" id="5200823">.</span><span class="ident" id="5200824">Errorf</span><span class="op" id="5200830">(</span><span class="string" id="5200831">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="5200871">,</span>&nbsp;<span class="ident" id="5200873">cm</span><span class="op" id="5200875">.</span><span class="ident" id="5200876">proxyURL</span><span class="op" id="5200884">,</span>&nbsp;<span class="ident" id="5200886">err</span><span class="op" id="5200889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5200894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200899">return</span>&nbsp;<span class="ident" id="5200906">nil</span><span class="op" id="5200909">,</span>&nbsp;<span class="ident" id="5200911">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5200917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5200921">pconn</span><span class="op" id="5200926">.</span><span class="ident" id="5200927">conn</span>&nbsp;<span class="op" id="5200932">=</span>&nbsp;<span class="ident" id="5200934">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5200940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5200944">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200961">switch</span>&nbsp;<span class="op" id="5200968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5200971">case</span>&nbsp;<span class="ident" id="5200976">cm</span><span class="op" id="5200978">.</span><span class="ident" id="5200979">proxyURL</span>&nbsp;<span class="op" id="5200988">==</span>&nbsp;<span class="ident" id="5200991">nil</span><span class="op" id="5200994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5200998">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201033">case</span>&nbsp;<span class="ident" id="5201038">cm</span><span class="op" id="5201040">.</span><span class="ident" id="5201041">targetScheme</span>&nbsp;<span class="op" id="5201054">==</span>&nbsp;<span class="string" id="5201057">&#34;http&#34;</span><span class="op" id="5201063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201067">pconn</span><span class="op" id="5201072">.</span><span class="ident" id="5201073">isProxy</span>&nbsp;<span class="op" id="5201081">=</span>&nbsp;<span class="builtintype" id="5201083">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201090">if</span>&nbsp;<span class="ident" id="5201093">pa</span>&nbsp;<span class="op" id="5201096">:=</span>&nbsp;<span class="ident" id="5201099">cm</span><span class="op" id="5201101">.</span><span class="ident" id="5201102">proxyAuth</span><span class="op" id="5201111">(</span><span class="op" id="5201112">)</span><span class="op" id="5201113">;</span>&nbsp;<span class="ident" id="5201115">pa</span>&nbsp;<span class="op" id="5201118">!=</span>&nbsp;<span class="string" id="5201121">&#34;&#34;</span>&nbsp;<span class="op" id="5201124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201129">pconn</span><span class="op" id="5201134">.</span><span class="ident" id="5201135">mutateHeaderFunc</span>&nbsp;<span class="op" id="5201152">=</span>&nbsp;<span class="keyword" id="5201154">func</span><span class="op" id="5201158">(</span><span class="ident" id="5201159">h</span>&nbsp;<span class="ident" id="5201161">Header</span><span class="op" id="5201167">)</span>&nbsp;<span class="op" id="5201169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201175">h</span><span class="op" id="5201176">.</span><span class="ident" id="5201177">Set</span><span class="op" id="5201180">(</span><span class="string" id="5201181">&#34;Proxy-Authorization&#34;</span><span class="op" id="5201202">,</span>&nbsp;<span class="ident" id="5201204">pa</span><span class="op" id="5201206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201215">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201218">case</span>&nbsp;<span class="ident" id="5201223">cm</span><span class="op" id="5201225">.</span><span class="ident" id="5201226">targetScheme</span>&nbsp;<span class="op" id="5201239">==</span>&nbsp;<span class="string" id="5201242">&#34;https&#34;</span><span class="op" id="5201249">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201253">conn</span>&nbsp;<span class="op" id="5201258">:=</span>&nbsp;<span class="ident" id="5201261">pconn</span><span class="op" id="5201266">.</span><span class="ident" id="5201267">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201274">connectReq</span>&nbsp;<span class="op" id="5201285">:=</span>&nbsp;<span class="op" id="5201288">&amp;</span><span class="ident" id="5201289">Request</span><span class="op" id="5201296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201301">Method</span><span class="op" id="5201307">:</span>&nbsp;<span class="string" id="5201309">&#34;CONNECT&#34;</span><span class="op" id="5201318">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201323">URL</span><span class="op" id="5201326">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5201331">&amp;</span><span class="ident" id="5201332">url</span><span class="op" id="5201335">.</span><span class="ident" id="5201336">URL</span><span class="op" id="5201339">{</span><span class="ident" id="5201340">Opaque</span><span class="op" id="5201346">:</span>&nbsp;<span class="ident" id="5201348">cm</span><span class="op" id="5201350">.</span><span class="ident" id="5201351">targetAddr</span><span class="op" id="5201361">}</span><span class="op" id="5201362">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201367">Host</span><span class="op" id="5201371">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5201375">cm</span><span class="op" id="5201377">.</span><span class="ident" id="5201378">targetAddr</span><span class="op" id="5201388">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201393">Header</span><span class="op" id="5201399">:</span>&nbsp;<span class="builtinfunc" id="5201401">make</span><span class="op" id="5201405">(</span><span class="ident" id="5201406">Header</span><span class="op" id="5201412">)</span><span class="op" id="5201413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201421">if</span>&nbsp;<span class="ident" id="5201424">pa</span>&nbsp;<span class="op" id="5201427">:=</span>&nbsp;<span class="ident" id="5201430">cm</span><span class="op" id="5201432">.</span><span class="ident" id="5201433">proxyAuth</span><span class="op" id="5201442">(</span><span class="op" id="5201443">)</span><span class="op" id="5201444">;</span>&nbsp;<span class="ident" id="5201446">pa</span>&nbsp;<span class="op" id="5201449">!=</span>&nbsp;<span class="string" id="5201452">&#34;&#34;</span>&nbsp;<span class="op" id="5201455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201460">connectReq</span><span class="op" id="5201470">.</span><span class="ident" id="5201471">Header</span><span class="op" id="5201477">.</span><span class="ident" id="5201478">Set</span><span class="op" id="5201481">(</span><span class="string" id="5201482">&#34;Proxy-Authorization&#34;</span><span class="op" id="5201503">,</span>&nbsp;<span class="ident" id="5201505">pa</span><span class="op" id="5201507">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201515">connectReq</span><span class="op" id="5201525">.</span><span class="ident" id="5201526">Write</span><span class="op" id="5201531">(</span><span class="ident" id="5201532">conn</span><span class="op" id="5201536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5201541">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5201561">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5201620">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201668">br</span>&nbsp;<span class="op" id="5201671">:=</span>&nbsp;<span class="ident" id="5201674">bufio</span><span class="op" id="5201679">.</span><span class="ident" id="5201680">NewReader</span><span class="op" id="5201689">(</span><span class="ident" id="5201690">conn</span><span class="op" id="5201694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201698">resp</span><span class="op" id="5201702">,</span>&nbsp;<span class="ident" id="5201704">err</span>&nbsp;<span class="op" id="5201708">:=</span>&nbsp;<span class="ident" id="5201711">ReadResponse</span><span class="op" id="5201723">(</span><span class="ident" id="5201724">br</span><span class="op" id="5201726">,</span>&nbsp;<span class="ident" id="5201728">connectReq</span><span class="op" id="5201738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201742">if</span>&nbsp;<span class="ident" id="5201745">err</span>&nbsp;<span class="op" id="5201749">!=</span>&nbsp;<span class="ident" id="5201752">nil</span>&nbsp;<span class="op" id="5201756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201761">conn</span><span class="op" id="5201765">.</span><span class="ident" id="5201766">Close</span><span class="op" id="5201771">(</span><span class="op" id="5201772">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201777">return</span>&nbsp;<span class="ident" id="5201784">nil</span><span class="op" id="5201787">,</span>&nbsp;<span class="ident" id="5201789">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201799">if</span>&nbsp;<span class="ident" id="5201802">resp</span><span class="op" id="5201806">.</span><span class="ident" id="5201807">StatusCode</span>&nbsp;<span class="op" id="5201818">!=</span>&nbsp;<span class="num" id="5201821">200</span>&nbsp;<span class="op" id="5201825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201830">f</span>&nbsp;<span class="op" id="5201832">:=</span>&nbsp;<span class="ident" id="5201835">strings</span><span class="op" id="5201842">.</span><span class="ident" id="5201843">SplitN</span><span class="op" id="5201849">(</span><span class="ident" id="5201850">resp</span><span class="op" id="5201854">.</span><span class="ident" id="5201855">Status</span><span class="op" id="5201861">,</span>&nbsp;<span class="string" id="5201863">&#34;&nbsp;&#34;</span><span class="op" id="5201866">,</span>&nbsp;<span class="num" id="5201868">2</span><span class="op" id="5201869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5201874">conn</span><span class="op" id="5201878">.</span><span class="ident" id="5201879">Close</span><span class="op" id="5201884">(</span><span class="op" id="5201885">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201890">return</span>&nbsp;<span class="ident" id="5201897">nil</span><span class="op" id="5201900">,</span>&nbsp;<span class="ident" id="5201902">errors</span><span class="op" id="5201908">.</span><span class="ident" id="5201909">New</span><span class="op" id="5201912">(</span><span class="ident" id="5201913">f</span><span class="op" id="5201914">[</span><span class="num" id="5201915">1</span><span class="op" id="5201916">]</span><span class="op" id="5201917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5201924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5201928">if</span>&nbsp;<span class="ident" id="5201931">cm</span><span class="op" id="5201933">.</span><span class="ident" id="5201934">targetScheme</span>&nbsp;<span class="op" id="5201947">==</span>&nbsp;<span class="string" id="5201950">&#34;https&#34;</span>&nbsp;<span class="op" id="5201958">&amp;&amp;</span>&nbsp;<span class="op" id="5201961">!</span><span class="ident" id="5201962">tlsDial</span>&nbsp;<span class="op" id="5201970">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5201974">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202040">cfg</span>&nbsp;<span class="op" id="5202044">:=</span>&nbsp;<span class="ident" id="5202047">t</span><span class="op" id="5202048">.</span><span class="ident" id="5202049">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202067">if</span>&nbsp;<span class="ident" id="5202070">cfg</span>&nbsp;<span class="op" id="5202074">==</span>&nbsp;<span class="ident" id="5202077">nil</span>&nbsp;<span class="op" id="5202081">||</span>&nbsp;<span class="ident" id="5202084">cfg</span><span class="op" id="5202087">.</span><span class="ident" id="5202088">ServerName</span>&nbsp;<span class="op" id="5202099">==</span>&nbsp;<span class="string" id="5202102">&#34;&#34;</span>&nbsp;<span class="op" id="5202105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202110">host</span>&nbsp;<span class="op" id="5202115">:=</span>&nbsp;<span class="ident" id="5202118">cm</span><span class="op" id="5202120">.</span><span class="ident" id="5202121">tlsHost</span><span class="op" id="5202128">(</span><span class="op" id="5202129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202134">if</span>&nbsp;<span class="ident" id="5202137">cfg</span>&nbsp;<span class="op" id="5202141">==</span>&nbsp;<span class="ident" id="5202144">nil</span>&nbsp;<span class="op" id="5202148">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202154">cfg</span>&nbsp;<span class="op" id="5202158">=</span>&nbsp;<span class="op" id="5202160">&amp;</span><span class="ident" id="5202161">tls</span><span class="op" id="5202164">.</span><span class="ident" id="5202165">Config</span><span class="op" id="5202171">{</span><span class="ident" id="5202172">ServerName</span><span class="op" id="5202182">:</span>&nbsp;<span class="ident" id="5202184">host</span><span class="op" id="5202188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202193">}</span>&nbsp;<span class="keyword" id="5202195">else</span>&nbsp;<span class="op" id="5202200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202206">clone</span>&nbsp;<span class="op" id="5202212">:=</span>&nbsp;<span class="op" id="5202215">*</span><span class="ident" id="5202216">cfg</span>&nbsp;<span class="comment" id="5202220">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202241">clone</span><span class="op" id="5202246">.</span><span class="ident" id="5202247">ServerName</span>&nbsp;<span class="op" id="5202258">=</span>&nbsp;<span class="ident" id="5202260">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202269">cfg</span>&nbsp;<span class="op" id="5202273">=</span>&nbsp;<span class="op" id="5202275">&amp;</span><span class="ident" id="5202276">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202293">plainConn</span>&nbsp;<span class="op" id="5202303">:=</span>&nbsp;<span class="ident" id="5202306">pconn</span><span class="op" id="5202311">.</span><span class="ident" id="5202312">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202319">tlsConn</span>&nbsp;<span class="op" id="5202327">:=</span>&nbsp;<span class="ident" id="5202330">tls</span><span class="op" id="5202333">.</span><span class="ident" id="5202334">Client</span><span class="op" id="5202340">(</span><span class="ident" id="5202341">plainConn</span><span class="op" id="5202350">,</span>&nbsp;<span class="ident" id="5202352">cfg</span><span class="op" id="5202355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202359">errc</span>&nbsp;<span class="op" id="5202364">:=</span>&nbsp;<span class="builtinfunc" id="5202367">make</span><span class="op" id="5202371">(</span><span class="keyword" id="5202372">chan</span>&nbsp;<span class="builtintype" id="5202377">error</span><span class="op" id="5202382">,</span>&nbsp;<span class="num" id="5202384">2</span><span class="op" id="5202385">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202389">var</span>&nbsp;<span class="ident" id="5202393">timer</span>&nbsp;<span class="op" id="5202399">*</span><span class="ident" id="5202400">time</span><span class="op" id="5202404">.</span><span class="ident" id="5202405">Timer</span>&nbsp;<span class="comment" id="5202411">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202444">if</span>&nbsp;<span class="ident" id="5202447">d</span>&nbsp;<span class="op" id="5202449">:=</span>&nbsp;<span class="ident" id="5202452">t</span><span class="op" id="5202453">.</span><span class="ident" id="5202454">TLSHandshakeTimeout</span><span class="op" id="5202473">;</span>&nbsp;<span class="ident" id="5202475">d</span>&nbsp;<span class="op" id="5202477">!=</span>&nbsp;<span class="num" id="5202480">0</span>&nbsp;<span class="op" id="5202482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202487">timer</span>&nbsp;<span class="op" id="5202493">=</span>&nbsp;<span class="ident" id="5202495">time</span><span class="op" id="5202499">.</span><span class="ident" id="5202500">AfterFunc</span><span class="op" id="5202509">(</span><span class="ident" id="5202510">d</span><span class="op" id="5202511">,</span>&nbsp;<span class="keyword" id="5202513">func</span><span class="op" id="5202517">(</span><span class="op" id="5202518">)</span>&nbsp;<span class="op" id="5202520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202526">errc</span>&nbsp;<span class="op" id="5202531">&lt;-</span>&nbsp;<span class="ident" id="5202534">tlsHandshakeTimeoutError</span><span class="op" id="5202558">{</span><span class="op" id="5202559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202564">}</span><span class="op" id="5202565">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202573">go</span>&nbsp;<span class="keyword" id="5202576">func</span><span class="op" id="5202580">(</span><span class="op" id="5202581">)</span>&nbsp;<span class="op" id="5202583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202588">err</span>&nbsp;<span class="op" id="5202592">:=</span>&nbsp;<span class="ident" id="5202595">tlsConn</span><span class="op" id="5202602">.</span><span class="ident" id="5202603">Handshake</span><span class="op" id="5202612">(</span><span class="op" id="5202613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202618">if</span>&nbsp;<span class="ident" id="5202621">timer</span>&nbsp;<span class="op" id="5202627">!=</span>&nbsp;<span class="ident" id="5202630">nil</span>&nbsp;<span class="op" id="5202634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202640">timer</span><span class="op" id="5202645">.</span><span class="ident" id="5202646">Stop</span><span class="op" id="5202650">(</span><span class="op" id="5202651">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202661">errc</span>&nbsp;<span class="op" id="5202666">&lt;-</span>&nbsp;<span class="ident" id="5202669">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202675">}</span><span class="op" id="5202676">(</span><span class="op" id="5202677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202681">if</span>&nbsp;<span class="ident" id="5202684">err</span>&nbsp;<span class="op" id="5202688">:=</span>&nbsp;<span class="op" id="5202691">&lt;-</span><span class="ident" id="5202693">errc</span><span class="op" id="5202697">;</span>&nbsp;<span class="ident" id="5202699">err</span>&nbsp;<span class="op" id="5202703">!=</span>&nbsp;<span class="ident" id="5202706">nil</span>&nbsp;<span class="op" id="5202710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202715">plainConn</span><span class="op" id="5202724">.</span><span class="ident" id="5202725">Close</span><span class="op" id="5202730">(</span><span class="op" id="5202731">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202736">return</span>&nbsp;<span class="ident" id="5202743">nil</span><span class="op" id="5202746">,</span>&nbsp;<span class="ident" id="5202748">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202758">if</span>&nbsp;<span class="op" id="5202761">!</span><span class="ident" id="5202762">cfg</span><span class="op" id="5202765">.</span><span class="ident" id="5202766">InsecureSkipVerify</span>&nbsp;<span class="op" id="5202785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202790">if</span>&nbsp;<span class="ident" id="5202793">err</span>&nbsp;<span class="op" id="5202797">:=</span>&nbsp;<span class="ident" id="5202800">tlsConn</span><span class="op" id="5202807">.</span><span class="ident" id="5202808">VerifyHostname</span><span class="op" id="5202822">(</span><span class="ident" id="5202823">cfg</span><span class="op" id="5202826">.</span><span class="ident" id="5202827">ServerName</span><span class="op" id="5202837">)</span><span class="op" id="5202838">;</span>&nbsp;<span class="ident" id="5202840">err</span>&nbsp;<span class="op" id="5202844">!=</span>&nbsp;<span class="ident" id="5202847">nil</span>&nbsp;<span class="op" id="5202851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202857">plainConn</span><span class="op" id="5202866">.</span><span class="ident" id="5202867">Close</span><span class="op" id="5202872">(</span><span class="op" id="5202873">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5202879">return</span>&nbsp;<span class="ident" id="5202886">nil</span><span class="op" id="5202889">,</span>&nbsp;<span class="ident" id="5202891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202906">cs</span>&nbsp;<span class="op" id="5202909">:=</span>&nbsp;<span class="ident" id="5202912">tlsConn</span><span class="op" id="5202919">.</span><span class="ident" id="5202920">ConnectionState</span><span class="op" id="5202935">(</span><span class="op" id="5202936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202940">pconn</span><span class="op" id="5202945">.</span><span class="ident" id="5202946">tlsState</span>&nbsp;<span class="op" id="5202955">=</span>&nbsp;<span class="op" id="5202957">&amp;</span><span class="ident" id="5202958">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202963">pconn</span><span class="op" id="5202968">.</span><span class="ident" id="5202969">conn</span>&nbsp;<span class="op" id="5202974">=</span>&nbsp;<span class="ident" id="5202976">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5202985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5202989">pconn</span><span class="op" id="5202994">.</span><span class="ident" id="5202995">br</span>&nbsp;<span class="op" id="5202998">=</span>&nbsp;<span class="ident" id="5203000">bufio</span><span class="op" id="5203005">.</span><span class="ident" id="5203006">NewReader</span><span class="op" id="5203015">(</span><span class="ident" id="5203016">noteEOFReader</span><span class="op" id="5203029">{</span><span class="ident" id="5203030">pconn</span><span class="op" id="5203035">.</span><span class="ident" id="5203036">conn</span><span class="op" id="5203040">,</span>&nbsp;<span class="op" id="5203042">&amp;</span><span class="ident" id="5203043">pconn</span><span class="op" id="5203048">.</span><span class="ident" id="5203049">sawEOF</span><span class="op" id="5203055">}</span><span class="op" id="5203056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203059">pconn</span><span class="op" id="5203064">.</span><span class="ident" id="5203065">bw</span>&nbsp;<span class="op" id="5203068">=</span>&nbsp;<span class="ident" id="5203070">bufio</span><span class="op" id="5203075">.</span><span class="ident" id="5203076">NewWriter</span><span class="op" id="5203085">(</span><span class="ident" id="5203086">pconn</span><span class="op" id="5203091">.</span><span class="ident" id="5203092">conn</span><span class="op" id="5203096">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203099">go</span>&nbsp;<span class="ident" id="5203102">pconn</span><span class="op" id="5203107">.</span><span class="ident" id="5203108">readLoop</span><span class="op" id="5203116">(</span><span class="op" id="5203117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203120">go</span>&nbsp;<span class="ident" id="5203123">pconn</span><span class="op" id="5203128">.</span><span class="ident" id="5203129">writeLoop</span><span class="op" id="5203138">(</span><span class="op" id="5203139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203142">return</span>&nbsp;<span class="ident" id="5203149">pconn</span><span class="op" id="5203154">,</span>&nbsp;<span class="ident" id="5203156">nil</span><br>
<span class="lineno"></span><span class="op" id="5203160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5203163">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="5203228">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5203291">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="5203347">func</span>&nbsp;<span class="ident" id="5203352">useProxy</span><span class="op" id="5203360">(</span><span class="ident" id="5203361">addr</span>&nbsp;<span class="builtintype" id="5203366">string</span><span class="op" id="5203372">)</span>&nbsp;<span class="builtintype" id="5203374">bool</span>&nbsp;<span class="op" id="5203379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203382">if</span>&nbsp;<span class="builtinfunc" id="5203385">len</span><span class="op" id="5203388">(</span><span class="ident" id="5203389">addr</span><span class="op" id="5203393">)</span>&nbsp;<span class="op" id="5203395">==</span>&nbsp;<span class="num" id="5203398">0</span>&nbsp;<span class="op" id="5203400">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203404">return</span>&nbsp;<span class="builtintype" id="5203411">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5203417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203420">host</span><span class="op" id="5203424">,</span>&nbsp;<span class="ident" id="5203426">_</span><span class="op" id="5203427">,</span>&nbsp;<span class="ident" id="5203429">err</span>&nbsp;<span class="op" id="5203433">:=</span>&nbsp;<span class="ident" id="5203436">net</span><span class="op" id="5203439">.</span><span class="ident" id="5203440">SplitHostPort</span><span class="op" id="5203453">(</span><span class="ident" id="5203454">addr</span><span class="op" id="5203458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203461">if</span>&nbsp;<span class="ident" id="5203464">err</span>&nbsp;<span class="op" id="5203468">!=</span>&nbsp;<span class="ident" id="5203471">nil</span>&nbsp;<span class="op" id="5203475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203479">return</span>&nbsp;<span class="builtintype" id="5203486">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5203493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203496">if</span>&nbsp;<span class="ident" id="5203499">host</span>&nbsp;<span class="op" id="5203504">==</span>&nbsp;<span class="string" id="5203507">&#34;localhost&#34;</span>&nbsp;<span class="op" id="5203519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203523">return</span>&nbsp;<span class="builtintype" id="5203530">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5203537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203540">if</span>&nbsp;<span class="ident" id="5203543">ip</span>&nbsp;<span class="op" id="5203546">:=</span>&nbsp;<span class="ident" id="5203549">net</span><span class="op" id="5203552">.</span><span class="ident" id="5203553">ParseIP</span><span class="op" id="5203560">(</span><span class="ident" id="5203561">host</span><span class="op" id="5203565">)</span><span class="op" id="5203566">;</span>&nbsp;<span class="ident" id="5203568">ip</span>&nbsp;<span class="op" id="5203571">!=</span>&nbsp;<span class="ident" id="5203574">nil</span>&nbsp;<span class="op" id="5203578">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203582">if</span>&nbsp;<span class="ident" id="5203585">ip</span><span class="op" id="5203587">.</span><span class="ident" id="5203588">IsLoopback</span><span class="op" id="5203598">(</span><span class="op" id="5203599">)</span>&nbsp;<span class="op" id="5203601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203606">return</span>&nbsp;<span class="builtintype" id="5203613">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5203621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5203624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203628">no_proxy</span>&nbsp;<span class="op" id="5203637">:=</span>&nbsp;<span class="ident" id="5203640">noProxyEnv</span><span class="op" id="5203650">.</span><span class="ident" id="5203651">Get</span><span class="op" id="5203654">(</span><span class="op" id="5203655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203658">if</span>&nbsp;<span class="ident" id="5203661">no_proxy</span>&nbsp;<span class="op" id="5203670">==</span>&nbsp;<span class="string" id="5203673">&#34;*&#34;</span>&nbsp;<span class="op" id="5203677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203681">return</span>&nbsp;<span class="builtintype" id="5203688">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5203695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203699">addr</span>&nbsp;<span class="op" id="5203704">=</span>&nbsp;<span class="ident" id="5203706">strings</span><span class="op" id="5203713">.</span><span class="ident" id="5203714">ToLower</span><span class="op" id="5203721">(</span><span class="ident" id="5203722">strings</span><span class="op" id="5203729">.</span><span class="ident" id="5203730">TrimSpace</span><span class="op" id="5203739">(</span><span class="ident" id="5203740">addr</span><span class="op" id="5203744">)</span><span class="op" id="5203745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203748">if</span>&nbsp;<span class="ident" id="5203751">hasPort</span><span class="op" id="5203758">(</span><span class="ident" id="5203759">addr</span><span class="op" id="5203763">)</span>&nbsp;<span class="op" id="5203765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203769">addr</span>&nbsp;<span class="op" id="5203774">=</span>&nbsp;<span class="ident" id="5203776">addr</span><span class="op" id="5203780">[</span><span class="op" id="5203781">:</span><span class="ident" id="5203782">strings</span><span class="op" id="5203789">.</span><span class="ident" id="5203790">LastIndex</span><span class="op" id="5203799">(</span><span class="ident" id="5203800">addr</span><span class="op" id="5203804">,</span>&nbsp;<span class="string" id="5203806">&#34;:&#34;</span><span class="op" id="5203809">)</span><span class="op" id="5203810">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5203813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203817">for</span>&nbsp;<span class="ident" id="5203821">_</span><span class="op" id="5203822">,</span>&nbsp;<span class="ident" id="5203824">p</span>&nbsp;<span class="op" id="5203826">:=</span>&nbsp;<span class="keyword" id="5203829">range</span>&nbsp;<span class="ident" id="5203835">strings</span><span class="op" id="5203842">.</span><span class="ident" id="5203843">Split</span><span class="op" id="5203848">(</span><span class="ident" id="5203849">no_proxy</span><span class="op" id="5203857">,</span>&nbsp;<span class="string" id="5203859">&#34;,&#34;</span><span class="op" id="5203862">)</span>&nbsp;<span class="op" id="5203864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203868">p</span>&nbsp;<span class="op" id="5203870">=</span>&nbsp;<span class="ident" id="5203872">strings</span><span class="op" id="5203879">.</span><span class="ident" id="5203880">ToLower</span><span class="op" id="5203887">(</span><span class="ident" id="5203888">strings</span><span class="op" id="5203895">.</span><span class="ident" id="5203896">TrimSpace</span><span class="op" id="5203905">(</span><span class="ident" id="5203906">p</span><span class="op" id="5203907">)</span><span class="op" id="5203908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203912">if</span>&nbsp;<span class="builtinfunc" id="5203915">len</span><span class="op" id="5203918">(</span><span class="ident" id="5203919">p</span><span class="op" id="5203920">)</span>&nbsp;<span class="op" id="5203922">==</span>&nbsp;<span class="num" id="5203925">0</span>&nbsp;<span class="op" id="5203927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203932">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5203943">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5203947">if</span>&nbsp;<span class="ident" id="5203950">hasPort</span><span class="op" id="5203957">(</span><span class="ident" id="5203958">p</span><span class="op" id="5203959">)</span>&nbsp;<span class="op" id="5203961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5203966">p</span>&nbsp;<span class="op" id="5203968">=</span>&nbsp;<span class="ident" id="5203970">p</span><span class="op" id="5203971">[</span><span class="op" id="5203972">:</span><span class="ident" id="5203973">strings</span><span class="op" id="5203980">.</span><span class="ident" id="5203981">LastIndex</span><span class="op" id="5203990">(</span><span class="ident" id="5203991">p</span><span class="op" id="5203992">,</span>&nbsp;<span class="string" id="5203994">&#34;:&#34;</span><span class="op" id="5203997">)</span><span class="op" id="5203998">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5204002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204006">if</span>&nbsp;<span class="ident" id="5204009">addr</span>&nbsp;<span class="op" id="5204014">==</span>&nbsp;<span class="ident" id="5204017">p</span>&nbsp;<span class="op" id="5204019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204024">return</span>&nbsp;<span class="builtintype" id="5204031">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5204039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204043">if</span>&nbsp;<span class="ident" id="5204046">p</span><span class="op" id="5204047">[</span><span class="num" id="5204048">0</span><span class="op" id="5204049">]</span>&nbsp;<span class="op" id="5204051">==</span>&nbsp;<span class="string" id="5204054">&#39;.&#39;</span>&nbsp;<span class="op" id="5204058">&amp;&amp;</span>&nbsp;<span class="op" id="5204061">(</span><span class="ident" id="5204062">strings</span><span class="op" id="5204069">.</span><span class="ident" id="5204070">HasSuffix</span><span class="op" id="5204079">(</span><span class="ident" id="5204080">addr</span><span class="op" id="5204084">,</span>&nbsp;<span class="ident" id="5204086">p</span><span class="op" id="5204087">)</span>&nbsp;<span class="op" id="5204089">||</span>&nbsp;<span class="ident" id="5204092">addr</span>&nbsp;<span class="op" id="5204097">==</span>&nbsp;<span class="ident" id="5204100">p</span><span class="op" id="5204101">[</span><span class="num" id="5204102">1</span><span class="op" id="5204103">:</span><span class="op" id="5204104">]</span><span class="op" id="5204105">)</span>&nbsp;<span class="op" id="5204107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5204112">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204173">return</span>&nbsp;<span class="builtintype" id="5204180">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5204188">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204192">if</span>&nbsp;<span class="ident" id="5204195">p</span><span class="op" id="5204196">[</span><span class="num" id="5204197">0</span><span class="op" id="5204198">]</span>&nbsp;<span class="op" id="5204200">!=</span>&nbsp;<span class="string" id="5204203">&#39;.&#39;</span>&nbsp;<span class="op" id="5204207">&amp;&amp;</span>&nbsp;<span class="ident" id="5204210">strings</span><span class="op" id="5204217">.</span><span class="ident" id="5204218">HasSuffix</span><span class="op" id="5204227">(</span><span class="ident" id="5204228">addr</span><span class="op" id="5204232">,</span>&nbsp;<span class="ident" id="5204234">p</span><span class="op" id="5204235">)</span>&nbsp;<span class="op" id="5204237">&amp;&amp;</span>&nbsp;<span class="ident" id="5204240">addr</span><span class="op" id="5204244">[</span><span class="builtinfunc" id="5204245">len</span><span class="op" id="5204248">(</span><span class="ident" id="5204249">addr</span><span class="op" id="5204253">)</span><span class="op" id="5204254">-</span><span class="builtinfunc" id="5204255">len</span><span class="op" id="5204258">(</span><span class="ident" id="5204259">p</span><span class="op" id="5204260">)</span><span class="op" id="5204261">-</span><span class="num" id="5204262">1</span><span class="op" id="5204263">]</span>&nbsp;<span class="op" id="5204265">==</span>&nbsp;<span class="string" id="5204268">&#39;.&#39;</span>&nbsp;<span class="op" id="5204272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5204277">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204324">return</span>&nbsp;<span class="builtintype" id="5204331">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5204339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5204342">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5204345">return</span>&nbsp;<span class="builtintype" id="5204352">true</span><br>
<span class="lineno"></span><span class="op" id="5204357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5204360">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="5204436">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="5204491">//</span><br>
<span class="lineno"></span><span class="comment" id="5204494">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="5204545">//</span><br>
<span class="lineno"></span><span class="comment" id="5204548">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="5204593">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="5204652">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="5204719">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="5204787">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="5204861">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5204939">//</span><br>
<span class="lineno">730</span><span class="comment" id="5204942">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="5204989">//</span><br>
<span class="lineno"></span><span class="keyword" id="5204992">type</span>&nbsp;<span class="ident" id="5204997">connectMethod</span>&nbsp;<span class="keyword" id="5205011">struct</span>&nbsp;<span class="op" id="5205018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205021">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5205034">*</span><span class="ident" id="5205035">url</span><span class="op" id="5205038">.</span><span class="ident" id="5205039">URL</span>&nbsp;<span class="comment" id="5205043">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205085">targetScheme</span>&nbsp;<span class="builtintype" id="5205098">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5205107">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205129">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5205142">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5205151">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="5205215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5205218">func</span>&nbsp;<span class="op" id="5205223">(</span><span class="ident" id="5205224">cm</span>&nbsp;<span class="op" id="5205227">*</span><span class="ident" id="5205228">connectMethod</span><span class="op" id="5205241">)</span>&nbsp;<span class="ident" id="5205243">key</span><span class="op" id="5205246">(</span><span class="op" id="5205247">)</span>&nbsp;<span class="ident" id="5205249">connectMethodKey</span>&nbsp;<span class="op" id="5205266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205269">proxyStr</span>&nbsp;<span class="op" id="5205278">:=</span>&nbsp;<span class="string" id="5205281">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205285">targetAddr</span>&nbsp;<span class="op" id="5205296">:=</span>&nbsp;<span class="ident" id="5205299">cm</span><span class="op" id="5205301">.</span><span class="ident" id="5205302">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205314">if</span>&nbsp;<span class="ident" id="5205317">cm</span><span class="op" id="5205319">.</span><span class="ident" id="5205320">proxyURL</span>&nbsp;<span class="op" id="5205329">!=</span>&nbsp;<span class="ident" id="5205332">nil</span>&nbsp;<span class="op" id="5205336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205340">proxyStr</span>&nbsp;<span class="op" id="5205349">=</span>&nbsp;<span class="ident" id="5205351">cm</span><span class="op" id="5205353">.</span><span class="ident" id="5205354">proxyURL</span><span class="op" id="5205362">.</span><span class="ident" id="5205363">String</span><span class="op" id="5205369">(</span><span class="op" id="5205370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205374">if</span>&nbsp;<span class="ident" id="5205377">cm</span><span class="op" id="5205379">.</span><span class="ident" id="5205380">targetScheme</span>&nbsp;<span class="op" id="5205393">==</span>&nbsp;<span class="string" id="5205396">&#34;http&#34;</span>&nbsp;<span class="op" id="5205403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205408">targetAddr</span>&nbsp;<span class="op" id="5205419">=</span>&nbsp;<span class="string" id="5205421">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5205426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5205429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205432">return</span>&nbsp;<span class="ident" id="5205439">connectMethodKey</span><span class="op" id="5205455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205459">proxy</span><span class="op" id="5205464">:</span>&nbsp;&nbsp;<span class="ident" id="5205467">proxyStr</span><span class="op" id="5205475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205479">scheme</span><span class="op" id="5205485">:</span>&nbsp;<span class="ident" id="5205487">cm</span><span class="op" id="5205489">.</span><span class="ident" id="5205490">targetScheme</span><span class="op" id="5205502">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205506">addr</span><span class="op" id="5205510">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5205514">targetAddr</span><span class="op" id="5205524">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5205527">}</span><br>
<span class="lineno"></span><span class="op" id="5205529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5205532">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="5205607">func</span>&nbsp;<span class="op" id="5205612">(</span><span class="ident" id="5205613">cm</span>&nbsp;<span class="op" id="5205616">*</span><span class="ident" id="5205617">connectMethod</span><span class="op" id="5205630">)</span>&nbsp;<span class="ident" id="5205632">addr</span><span class="op" id="5205636">(</span><span class="op" id="5205637">)</span>&nbsp;<span class="builtintype" id="5205639">string</span>&nbsp;<span class="op" id="5205646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205649">if</span>&nbsp;<span class="ident" id="5205652">cm</span><span class="op" id="5205654">.</span><span class="ident" id="5205655">proxyURL</span>&nbsp;<span class="op" id="5205664">!=</span>&nbsp;<span class="ident" id="5205667">nil</span>&nbsp;<span class="op" id="5205671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205675">return</span>&nbsp;<span class="ident" id="5205682">canonicalAddr</span><span class="op" id="5205695">(</span><span class="ident" id="5205696">cm</span><span class="op" id="5205698">.</span><span class="ident" id="5205699">proxyURL</span><span class="op" id="5205707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5205710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205713">return</span>&nbsp;<span class="ident" id="5205720">cm</span><span class="op" id="5205722">.</span><span class="ident" id="5205723">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="5205734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5205737">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5205798">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="5205818">func</span>&nbsp;<span class="op" id="5205823">(</span><span class="ident" id="5205824">cm</span>&nbsp;<span class="op" id="5205827">*</span><span class="ident" id="5205828">connectMethod</span><span class="op" id="5205841">)</span>&nbsp;<span class="ident" id="5205843">tlsHost</span><span class="op" id="5205850">(</span><span class="op" id="5205851">)</span>&nbsp;<span class="builtintype" id="5205853">string</span>&nbsp;<span class="op" id="5205860">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205863">h</span>&nbsp;<span class="op" id="5205865">:=</span>&nbsp;<span class="ident" id="5205868">cm</span><span class="op" id="5205870">.</span><span class="ident" id="5205871">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205883">if</span>&nbsp;<span class="ident" id="5205886">hasPort</span><span class="op" id="5205893">(</span><span class="ident" id="5205894">h</span><span class="op" id="5205895">)</span>&nbsp;<span class="op" id="5205897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5205901">h</span>&nbsp;<span class="op" id="5205903">=</span>&nbsp;<span class="ident" id="5205905">h</span><span class="op" id="5205906">[</span><span class="op" id="5205907">:</span><span class="ident" id="5205908">strings</span><span class="op" id="5205915">.</span><span class="ident" id="5205916">LastIndex</span><span class="op" id="5205925">(</span><span class="ident" id="5205926">h</span><span class="op" id="5205927">,</span>&nbsp;<span class="string" id="5205929">&#34;:&#34;</span><span class="op" id="5205932">)</span><span class="op" id="5205933">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5205936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5205939">return</span>&nbsp;<span class="ident" id="5205946">h</span><br>
<span class="lineno">770</span><span class="op" id="5205948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5205951">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5206019">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5206090">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="5206100">type</span>&nbsp;<span class="ident" id="5206105">connectMethodKey</span>&nbsp;<span class="keyword" id="5206122">struct</span>&nbsp;<span class="op" id="5206129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206132">proxy</span><span class="op" id="5206137">,</span>&nbsp;<span class="ident" id="5206139">scheme</span><span class="op" id="5206145">,</span>&nbsp;<span class="ident" id="5206147">addr</span>&nbsp;<span class="builtintype" id="5206152">string</span><br>
<span class="lineno"></span><span class="op" id="5206159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5206162">func</span>&nbsp;<span class="op" id="5206167">(</span><span class="ident" id="5206168">k</span>&nbsp;<span class="ident" id="5206170">connectMethodKey</span><span class="op" id="5206186">)</span>&nbsp;<span class="ident" id="5206188">String</span><span class="op" id="5206194">(</span><span class="op" id="5206195">)</span>&nbsp;<span class="builtintype" id="5206197">string</span>&nbsp;<span class="op" id="5206204">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5206207">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5206231">return</span>&nbsp;<span class="ident" id="5206238">fmt</span><span class="op" id="5206241">.</span><span class="ident" id="5206242">Sprintf</span><span class="op" id="5206249">(</span><span class="string" id="5206250">&#34;%s|%s|%s&#34;</span><span class="op" id="5206260">,</span>&nbsp;<span class="ident" id="5206262">k</span><span class="op" id="5206263">.</span><span class="ident" id="5206264">proxy</span><span class="op" id="5206269">,</span>&nbsp;<span class="ident" id="5206271">k</span><span class="op" id="5206272">.</span><span class="ident" id="5206273">scheme</span><span class="op" id="5206279">,</span>&nbsp;<span class="ident" id="5206281">k</span><span class="op" id="5206282">.</span><span class="ident" id="5206283">addr</span><span class="op" id="5206287">)</span><br>
<span class="lineno"></span><span class="op" id="5206289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5206292">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="5206352">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="5206409">type</span>&nbsp;<span class="ident" id="5206414">persistConn</span>&nbsp;<span class="keyword" id="5206426">struct</span>&nbsp;<span class="op" id="5206433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206436">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5206445">*</span><span class="ident" id="5206446">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206457">cacheKey</span>&nbsp;<span class="ident" id="5206466">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206484">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5206493">net</span><span class="op" id="5206496">.</span><span class="ident" id="5206497">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206503">tlsState</span>&nbsp;<span class="op" id="5206512">*</span><span class="ident" id="5206513">tls</span><span class="op" id="5206516">.</span><span class="ident" id="5206517">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206534">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5206543">*</span><span class="ident" id="5206544">bufio</span><span class="op" id="5206549">.</span><span class="ident" id="5206550">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5206563">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206577">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5206586">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5206606">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206662">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5206671">*</span><span class="ident" id="5206672">bufio</span><span class="op" id="5206677">.</span><span class="ident" id="5206678">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5206691">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206703">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5206712">chan</span>&nbsp;<span class="ident" id="5206717">requestAndChan</span>&nbsp;<span class="comment" id="5206732">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206775">writech</span>&nbsp;&nbsp;<span class="keyword" id="5206784">chan</span>&nbsp;<span class="ident" id="5206789">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5206804">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206848">closech</span>&nbsp;&nbsp;<span class="keyword" id="5206857">chan</span>&nbsp;<span class="keyword" id="5206862">struct</span><span class="op" id="5206868">{</span><span class="op" id="5206869">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5206877">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5206905">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="5206914">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5206920">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5206980">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5207042">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5207106">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207165">writeErrCh</span>&nbsp;<span class="keyword" id="5207176">chan</span>&nbsp;<span class="builtintype" id="5207181">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207189">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5207210">sync</span><span class="op" id="5207214">.</span><span class="ident" id="5207215">Mutex</span>&nbsp;<span class="comment" id="5207221">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207249">numExpectedResponses</span>&nbsp;<span class="builtintype" id="5207270">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207275">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5207296">bool</span>&nbsp;<span class="comment" id="5207301">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207334">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5207355">bool</span>&nbsp;<span class="comment" id="5207360">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5207440">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5207497">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5207560">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207617">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="5207634">func</span><span class="op" id="5207638">(</span><span class="ident" id="5207639">Header</span><span class="op" id="5207645">)</span><br>
<span class="lineno"></span><span class="op" id="5207647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5207650">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="5207722">func</span>&nbsp;<span class="op" id="5207727">(</span><span class="ident" id="5207728">pc</span>&nbsp;<span class="op" id="5207731">*</span><span class="ident" id="5207732">persistConn</span><span class="op" id="5207743">)</span>&nbsp;<span class="ident" id="5207745">isBroken</span><span class="op" id="5207753">(</span><span class="op" id="5207754">)</span>&nbsp;<span class="builtintype" id="5207756">bool</span>&nbsp;<span class="op" id="5207761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207764">pc</span><span class="op" id="5207766">.</span><span class="ident" id="5207767">lk</span><span class="op" id="5207769">.</span><span class="ident" id="5207770">Lock</span><span class="op" id="5207774">(</span><span class="op" id="5207775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207778">b</span>&nbsp;<span class="op" id="5207780">:=</span>&nbsp;<span class="ident" id="5207783">pc</span><span class="op" id="5207785">.</span><span class="ident" id="5207786">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207794">pc</span><span class="op" id="5207796">.</span><span class="ident" id="5207797">lk</span><span class="op" id="5207799">.</span><span class="ident" id="5207800">Unlock</span><span class="op" id="5207806">(</span><span class="op" id="5207807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207810">return</span>&nbsp;<span class="ident" id="5207817">b</span><br>
<span class="lineno">820</span><span class="op" id="5207819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5207822">func</span>&nbsp;<span class="op" id="5207827">(</span><span class="ident" id="5207828">pc</span>&nbsp;<span class="op" id="5207831">*</span><span class="ident" id="5207832">persistConn</span><span class="op" id="5207843">)</span>&nbsp;<span class="ident" id="5207845">cancelRequest</span><span class="op" id="5207858">(</span><span class="op" id="5207859">)</span>&nbsp;<span class="op" id="5207861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5207864">pc</span><span class="op" id="5207866">.</span><span class="ident" id="5207867">conn</span><span class="op" id="5207871">.</span><span class="ident" id="5207872">Close</span><span class="op" id="5207877">(</span><span class="op" id="5207878">)</span><br>
<span class="lineno"></span><span class="op" id="5207880">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="5207883">var</span>&nbsp;<span class="ident" id="5207887">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="5207908">func</span><span class="op" id="5207912">(</span><span class="builtintype" id="5207913">error</span><span class="op" id="5207918">)</span>&nbsp;<span class="builtintype" id="5207920">bool</span>&nbsp;<span class="comment" id="5207925">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5207951">func</span>&nbsp;<span class="ident" id="5207956">remoteSideClosed</span><span class="op" id="5207972">(</span><span class="ident" id="5207973">err</span>&nbsp;<span class="builtintype" id="5207977">error</span><span class="op" id="5207982">)</span>&nbsp;<span class="builtintype" id="5207984">bool</span>&nbsp;<span class="op" id="5207989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5207992">if</span>&nbsp;<span class="ident" id="5207995">err</span>&nbsp;<span class="op" id="5207999">==</span>&nbsp;<span class="ident" id="5208002">io</span><span class="op" id="5208004">.</span><span class="ident" id="5208005">EOF</span>&nbsp;<span class="op" id="5208009">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208013">return</span>&nbsp;<span class="builtintype" id="5208020">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208029">if</span>&nbsp;<span class="ident" id="5208032">remoteSideClosedFunc</span>&nbsp;<span class="op" id="5208053">!=</span>&nbsp;<span class="ident" id="5208056">nil</span>&nbsp;<span class="op" id="5208060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208064">return</span>&nbsp;<span class="ident" id="5208071">remoteSideClosedFunc</span><span class="op" id="5208091">(</span><span class="ident" id="5208092">err</span><span class="op" id="5208095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208098">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208101">return</span>&nbsp;<span class="builtintype" id="5208108">false</span><br>
<span class="lineno"></span><span class="op" id="5208114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5208117">func</span>&nbsp;<span class="op" id="5208122">(</span><span class="ident" id="5208123">pc</span>&nbsp;<span class="op" id="5208126">*</span><span class="ident" id="5208127">persistConn</span><span class="op" id="5208138">)</span>&nbsp;<span class="ident" id="5208140">readLoop</span><span class="op" id="5208148">(</span><span class="op" id="5208149">)</span>&nbsp;<span class="op" id="5208151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208154">alive</span>&nbsp;<span class="op" id="5208160">:=</span>&nbsp;<span class="builtintype" id="5208163">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208170">for</span>&nbsp;<span class="ident" id="5208174">alive</span>&nbsp;<span class="op" id="5208180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208184">pb</span><span class="op" id="5208186">,</span>&nbsp;<span class="ident" id="5208188">err</span>&nbsp;<span class="op" id="5208192">:=</span>&nbsp;<span class="ident" id="5208195">pc</span><span class="op" id="5208197">.</span><span class="ident" id="5208198">br</span><span class="op" id="5208200">.</span><span class="ident" id="5208201">Peek</span><span class="op" id="5208205">(</span><span class="num" id="5208206">1</span><span class="op" id="5208207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208212">pc</span><span class="op" id="5208214">.</span><span class="ident" id="5208215">lk</span><span class="op" id="5208217">.</span><span class="ident" id="5208218">Lock</span><span class="op" id="5208222">(</span><span class="op" id="5208223">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208227">if</span>&nbsp;<span class="ident" id="5208230">pc</span><span class="op" id="5208232">.</span><span class="ident" id="5208233">numExpectedResponses</span>&nbsp;<span class="op" id="5208254">==</span>&nbsp;<span class="num" id="5208257">0</span>&nbsp;<span class="op" id="5208259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208264">if</span>&nbsp;<span class="op" id="5208267">!</span><span class="ident" id="5208268">pc</span><span class="op" id="5208270">.</span><span class="ident" id="5208271">closed</span>&nbsp;<span class="op" id="5208278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208284">pc</span><span class="op" id="5208286">.</span><span class="ident" id="5208287">closeLocked</span><span class="op" id="5208298">(</span><span class="op" id="5208299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208305">if</span>&nbsp;<span class="builtinfunc" id="5208308">len</span><span class="op" id="5208311">(</span><span class="ident" id="5208312">pb</span><span class="op" id="5208314">)</span>&nbsp;<span class="op" id="5208316">&gt;</span>&nbsp;<span class="num" id="5208318">0</span>&nbsp;<span class="op" id="5208320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208327">log</span><span class="op" id="5208330">.</span><span class="ident" id="5208331">Printf</span><span class="op" id="5208337">(</span><span class="string" id="5208338">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="5208415">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5208423">string</span><span class="op" id="5208429">(</span><span class="ident" id="5208430">pb</span><span class="op" id="5208432">)</span><span class="op" id="5208433">,</span>&nbsp;<span class="ident" id="5208435">err</span><span class="op" id="5208438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208454">pc</span><span class="op" id="5208456">.</span><span class="ident" id="5208457">lk</span><span class="op" id="5208459">.</span><span class="ident" id="5208460">Unlock</span><span class="op" id="5208466">(</span><span class="op" id="5208467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208472">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208485">pc</span><span class="op" id="5208487">.</span><span class="ident" id="5208488">lk</span><span class="op" id="5208490">.</span><span class="ident" id="5208491">Unlock</span><span class="op" id="5208497">(</span><span class="op" id="5208498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208503">rc</span>&nbsp;<span class="op" id="5208506">:=</span>&nbsp;<span class="op" id="5208509">&lt;-</span><span class="ident" id="5208511">pc</span><span class="op" id="5208513">.</span><span class="ident" id="5208514">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208523">var</span>&nbsp;<span class="ident" id="5208527">resp</span>&nbsp;<span class="op" id="5208532">*</span><span class="ident" id="5208533">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208544">if</span>&nbsp;<span class="ident" id="5208547">err</span>&nbsp;<span class="op" id="5208551">==</span>&nbsp;<span class="ident" id="5208554">nil</span>&nbsp;<span class="op" id="5208558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208563">resp</span><span class="op" id="5208567">,</span>&nbsp;<span class="ident" id="5208569">err</span>&nbsp;<span class="op" id="5208573">=</span>&nbsp;<span class="ident" id="5208575">ReadResponse</span><span class="op" id="5208587">(</span><span class="ident" id="5208588">pc</span><span class="op" id="5208590">.</span><span class="ident" id="5208591">br</span><span class="op" id="5208593">,</span>&nbsp;<span class="ident" id="5208595">rc</span><span class="op" id="5208597">.</span><span class="ident" id="5208598">req</span><span class="op" id="5208601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208606">if</span>&nbsp;<span class="ident" id="5208609">err</span>&nbsp;<span class="op" id="5208613">==</span>&nbsp;<span class="ident" id="5208616">nil</span>&nbsp;<span class="op" id="5208620">&amp;&amp;</span>&nbsp;<span class="ident" id="5208623">resp</span><span class="op" id="5208627">.</span><span class="ident" id="5208628">StatusCode</span>&nbsp;<span class="op" id="5208639">==</span>&nbsp;<span class="num" id="5208642">100</span>&nbsp;<span class="op" id="5208646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5208652">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5208690">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5208751">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5208811">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5208877">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208925">resp</span><span class="op" id="5208929">,</span>&nbsp;<span class="ident" id="5208931">err</span>&nbsp;<span class="op" id="5208935">=</span>&nbsp;<span class="ident" id="5208937">ReadResponse</span><span class="op" id="5208949">(</span><span class="ident" id="5208950">pc</span><span class="op" id="5208952">.</span><span class="ident" id="5208953">br</span><span class="op" id="5208955">,</span>&nbsp;<span class="ident" id="5208957">rc</span><span class="op" id="5208959">.</span><span class="ident" id="5208960">req</span><span class="op" id="5208963">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5208972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5208977">if</span>&nbsp;<span class="ident" id="5208980">resp</span>&nbsp;<span class="op" id="5208985">!=</span>&nbsp;<span class="ident" id="5208988">nil</span>&nbsp;<span class="op" id="5208992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208997">resp</span><span class="op" id="5209001">.</span><span class="ident" id="5209002">TLS</span>&nbsp;<span class="op" id="5209006">=</span>&nbsp;<span class="ident" id="5209008">pc</span><span class="op" id="5209010">.</span><span class="ident" id="5209011">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209027">hasBody</span>&nbsp;<span class="op" id="5209035">:=</span>&nbsp;<span class="ident" id="5209038">resp</span>&nbsp;<span class="op" id="5209043">!=</span>&nbsp;<span class="ident" id="5209046">nil</span>&nbsp;<span class="op" id="5209050">&amp;&amp;</span>&nbsp;<span class="ident" id="5209053">rc</span><span class="op" id="5209055">.</span><span class="ident" id="5209056">req</span><span class="op" id="5209059">.</span><span class="ident" id="5209060">Method</span>&nbsp;<span class="op" id="5209067">!=</span>&nbsp;<span class="string" id="5209070">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5209077">&amp;&amp;</span>&nbsp;<span class="ident" id="5209080">resp</span><span class="op" id="5209084">.</span><span class="ident" id="5209085">ContentLength</span>&nbsp;<span class="op" id="5209099">!=</span>&nbsp;<span class="num" id="5209102">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209107">if</span>&nbsp;<span class="ident" id="5209110">err</span>&nbsp;<span class="op" id="5209114">!=</span>&nbsp;<span class="ident" id="5209117">nil</span>&nbsp;<span class="op" id="5209121">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209126">pc</span><span class="op" id="5209128">.</span><span class="builtinfunc" id="5209129">close</span><span class="op" id="5209134">(</span><span class="op" id="5209135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209139">}</span>&nbsp;<span class="keyword" id="5209141">else</span>&nbsp;<span class="op" id="5209146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209151">if</span>&nbsp;<span class="ident" id="5209154">rc</span><span class="op" id="5209156">.</span><span class="ident" id="5209157">addedGzip</span>&nbsp;<span class="op" id="5209167">&amp;&amp;</span>&nbsp;<span class="ident" id="5209170">hasBody</span>&nbsp;<span class="op" id="5209178">&amp;&amp;</span>&nbsp;<span class="ident" id="5209181">resp</span><span class="op" id="5209185">.</span><span class="ident" id="5209186">Header</span><span class="op" id="5209192">.</span><span class="ident" id="5209193">Get</span><span class="op" id="5209196">(</span><span class="string" id="5209197">&#34;Content-Encoding&#34;</span><span class="op" id="5209215">)</span>&nbsp;<span class="op" id="5209217">==</span>&nbsp;<span class="string" id="5209220">&#34;gzip&#34;</span>&nbsp;<span class="op" id="5209227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209233">resp</span><span class="op" id="5209237">.</span><span class="ident" id="5209238">Header</span><span class="op" id="5209244">.</span><span class="ident" id="5209245">Del</span><span class="op" id="5209248">(</span><span class="string" id="5209249">&#34;Content-Encoding&#34;</span><span class="op" id="5209267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209273">resp</span><span class="op" id="5209277">.</span><span class="ident" id="5209278">Header</span><span class="op" id="5209284">.</span><span class="ident" id="5209285">Del</span><span class="op" id="5209288">(</span><span class="string" id="5209289">&#34;Content-Length&#34;</span><span class="op" id="5209305">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209311">resp</span><span class="op" id="5209315">.</span><span class="ident" id="5209316">ContentLength</span>&nbsp;<span class="op" id="5209330">=</span>&nbsp;<span class="op" id="5209332">-</span><span class="num" id="5209333">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209339">resp</span><span class="op" id="5209343">.</span><span class="ident" id="5209344">Body</span>&nbsp;<span class="op" id="5209349">=</span>&nbsp;<span class="op" id="5209351">&amp;</span><span class="ident" id="5209352">gzipReader</span><span class="op" id="5209362">{</span><span class="ident" id="5209363">body</span><span class="op" id="5209367">:</span>&nbsp;<span class="ident" id="5209369">resp</span><span class="op" id="5209373">.</span><span class="ident" id="5209374">Body</span><span class="op" id="5209378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209388">resp</span><span class="op" id="5209392">.</span><span class="ident" id="5209393">Body</span>&nbsp;<span class="op" id="5209398">=</span>&nbsp;<span class="op" id="5209400">&amp;</span><span class="ident" id="5209401">bodyEOFSignal</span><span class="op" id="5209414">{</span><span class="ident" id="5209415">body</span><span class="op" id="5209419">:</span>&nbsp;<span class="ident" id="5209421">resp</span><span class="op" id="5209425">.</span><span class="ident" id="5209426">Body</span><span class="op" id="5209430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209434">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209439">if</span>&nbsp;<span class="ident" id="5209442">err</span>&nbsp;<span class="op" id="5209446">!=</span>&nbsp;<span class="ident" id="5209449">nil</span>&nbsp;<span class="op" id="5209453">||</span>&nbsp;<span class="ident" id="5209456">resp</span><span class="op" id="5209460">.</span><span class="ident" id="5209461">Close</span>&nbsp;<span class="op" id="5209467">||</span>&nbsp;<span class="ident" id="5209470">rc</span><span class="op" id="5209472">.</span><span class="ident" id="5209473">req</span><span class="op" id="5209476">.</span><span class="ident" id="5209477">Close</span>&nbsp;<span class="op" id="5209483">||</span>&nbsp;<span class="ident" id="5209486">resp</span><span class="op" id="5209490">.</span><span class="ident" id="5209491">StatusCode</span>&nbsp;<span class="op" id="5209502">&lt;=</span>&nbsp;<span class="num" id="5209505">199</span>&nbsp;<span class="op" id="5209509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209514">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209583">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209643">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209690">alive</span>&nbsp;<span class="op" id="5209696">=</span>&nbsp;<span class="builtintype" id="5209698">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209711">var</span>&nbsp;<span class="ident" id="5209715">waitForBodyRead</span>&nbsp;<span class="keyword" id="5209731">chan</span>&nbsp;<span class="builtintype" id="5209736">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209743">if</span>&nbsp;<span class="ident" id="5209746">hasBody</span>&nbsp;<span class="op" id="5209754">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209759">waitForBodyRead</span>&nbsp;<span class="op" id="5209775">=</span>&nbsp;<span class="builtinfunc" id="5209777">make</span><span class="op" id="5209781">(</span><span class="keyword" id="5209782">chan</span>&nbsp;<span class="builtintype" id="5209787">bool</span><span class="op" id="5209791">,</span>&nbsp;<span class="num" id="5209793">2</span><span class="op" id="5209794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209799">resp</span><span class="op" id="5209803">.</span><span class="ident" id="5209804">Body</span><span class="op" id="5209808">.</span><span class="op" id="5209809">(</span><span class="op" id="5209810">*</span><span class="ident" id="5209811">bodyEOFSignal</span><span class="op" id="5209824">)</span><span class="op" id="5209825">.</span><span class="ident" id="5209826">earlyCloseFn</span>&nbsp;<span class="op" id="5209839">=</span>&nbsp;<span class="keyword" id="5209841">func</span><span class="op" id="5209845">(</span><span class="op" id="5209846">)</span>&nbsp;<span class="builtintype" id="5209848">error</span>&nbsp;<span class="op" id="5209854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209860">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209900">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209939">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209953">waitForBodyRead</span>&nbsp;<span class="op" id="5209969">&lt;-</span>&nbsp;<span class="builtintype" id="5209972">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209982">return</span>&nbsp;<span class="ident" id="5209989">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210001">resp</span><span class="op" id="5210005">.</span><span class="ident" id="5210006">Body</span><span class="op" id="5210010">.</span><span class="op" id="5210011">(</span><span class="op" id="5210012">*</span><span class="ident" id="5210013">bodyEOFSignal</span><span class="op" id="5210026">)</span><span class="op" id="5210027">.</span><span class="ident" id="5210028">fn</span>&nbsp;<span class="op" id="5210031">=</span>&nbsp;<span class="keyword" id="5210033">func</span><span class="op" id="5210037">(</span><span class="ident" id="5210038">err</span>&nbsp;<span class="builtintype" id="5210042">error</span><span class="op" id="5210047">)</span>&nbsp;<span class="op" id="5210049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210055">waitForBodyRead</span>&nbsp;<span class="op" id="5210071">&lt;-</span>&nbsp;<span class="ident" id="5210074">alive</span>&nbsp;<span class="op" id="5210080">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210088">err</span>&nbsp;<span class="op" id="5210092">==</span>&nbsp;<span class="ident" id="5210095">nil</span>&nbsp;<span class="op" id="5210099">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210107">!</span><span class="ident" id="5210108">pc</span><span class="op" id="5210110">.</span><span class="ident" id="5210111">sawEOF</span>&nbsp;<span class="op" id="5210118">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210126">pc</span><span class="op" id="5210128">.</span><span class="ident" id="5210129">wroteRequest</span><span class="op" id="5210141">(</span><span class="op" id="5210142">)</span>&nbsp;<span class="op" id="5210144">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210152">pc</span><span class="op" id="5210154">.</span><span class="ident" id="5210155">t</span><span class="op" id="5210156">.</span><span class="ident" id="5210157">putIdleConn</span><span class="op" id="5210168">(</span><span class="ident" id="5210169">pc</span><span class="op" id="5210171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210176">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210185">if</span>&nbsp;<span class="ident" id="5210188">alive</span>&nbsp;<span class="op" id="5210194">&amp;&amp;</span>&nbsp;<span class="op" id="5210197">!</span><span class="ident" id="5210198">hasBody</span>&nbsp;<span class="op" id="5210206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210211">alive</span>&nbsp;<span class="op" id="5210217">=</span>&nbsp;<span class="op" id="5210219">!</span><span class="ident" id="5210220">pc</span><span class="op" id="5210222">.</span><span class="ident" id="5210223">sawEOF</span>&nbsp;<span class="op" id="5210230">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210237">pc</span><span class="op" id="5210239">.</span><span class="ident" id="5210240">wroteRequest</span><span class="op" id="5210252">(</span><span class="op" id="5210253">)</span>&nbsp;<span class="op" id="5210255">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210262">pc</span><span class="op" id="5210264">.</span><span class="ident" id="5210265">t</span><span class="op" id="5210266">.</span><span class="ident" id="5210267">putIdleConn</span><span class="op" id="5210278">(</span><span class="ident" id="5210279">pc</span><span class="op" id="5210281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210290">rc</span><span class="op" id="5210292">.</span><span class="ident" id="5210293">ch</span>&nbsp;<span class="op" id="5210296">&lt;-</span>&nbsp;<span class="ident" id="5210299">responseAndError</span><span class="op" id="5210315">{</span><span class="ident" id="5210316">resp</span><span class="op" id="5210320">,</span>&nbsp;<span class="ident" id="5210322">err</span><span class="op" id="5210325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5210330">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5210397">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210458">if</span>&nbsp;<span class="ident" id="5210461">waitForBodyRead</span>&nbsp;<span class="op" id="5210477">!=</span>&nbsp;<span class="ident" id="5210480">nil</span>&nbsp;<span class="op" id="5210484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210489">select</span>&nbsp;<span class="op" id="5210496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210501">case</span>&nbsp;<span class="ident" id="5210506">alive</span>&nbsp;<span class="op" id="5210512">=</span>&nbsp;<span class="op" id="5210514">&lt;-</span><span class="ident" id="5210516">waitForBodyRead</span><span class="op" id="5210531">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210536">case</span>&nbsp;<span class="op" id="5210541">&lt;-</span><span class="ident" id="5210543">pc</span><span class="op" id="5210545">.</span><span class="ident" id="5210546">closech</span><span class="op" id="5210553">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210559">alive</span>&nbsp;<span class="op" id="5210565">=</span>&nbsp;<span class="builtintype" id="5210567">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210585">pc</span><span class="op" id="5210587">.</span><span class="ident" id="5210588">t</span><span class="op" id="5210589">.</span><span class="ident" id="5210590">setReqCanceler</span><span class="op" id="5210604">(</span><span class="ident" id="5210605">rc</span><span class="op" id="5210607">.</span><span class="ident" id="5210608">req</span><span class="op" id="5210611">,</span>&nbsp;<span class="ident" id="5210613">nil</span><span class="op" id="5210616">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210621">if</span>&nbsp;<span class="op" id="5210624">!</span><span class="ident" id="5210625">alive</span>&nbsp;<span class="op" id="5210631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210636">pc</span><span class="op" id="5210638">.</span><span class="builtinfunc" id="5210639">close</span><span class="op" id="5210644">(</span><span class="op" id="5210645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210649">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210652">}</span><br>
<span class="lineno"></span><span class="op" id="5210654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5210657">func</span>&nbsp;<span class="op" id="5210662">(</span><span class="ident" id="5210663">pc</span>&nbsp;<span class="op" id="5210666">*</span><span class="ident" id="5210667">persistConn</span><span class="op" id="5210678">)</span>&nbsp;<span class="ident" id="5210680">writeLoop</span><span class="op" id="5210689">(</span><span class="op" id="5210690">)</span>&nbsp;<span class="op" id="5210692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210695">for</span>&nbsp;<span class="op" id="5210699">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210703">select</span>&nbsp;<span class="op" id="5210710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210714">case</span>&nbsp;<span class="ident" id="5210719">wr</span>&nbsp;<span class="op" id="5210722">:=</span>&nbsp;<span class="op" id="5210725">&lt;-</span><span class="ident" id="5210727">pc</span><span class="op" id="5210729">.</span><span class="ident" id="5210730">writech</span><span class="op" id="5210737">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210742">if</span>&nbsp;<span class="ident" id="5210745">pc</span><span class="op" id="5210747">.</span><span class="ident" id="5210748">isBroken</span><span class="op" id="5210756">(</span><span class="op" id="5210757">)</span>&nbsp;<span class="op" id="5210759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210765">wr</span><span class="op" id="5210767">.</span><span class="ident" id="5210768">ch</span>&nbsp;<span class="op" id="5210771">&lt;-</span>&nbsp;<span class="ident" id="5210774">errors</span><span class="op" id="5210780">.</span><span class="ident" id="5210781">New</span><span class="op" id="5210784">(</span><span class="string" id="5210785">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="5210838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210844">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210861">err</span>&nbsp;<span class="op" id="5210865">:=</span>&nbsp;<span class="ident" id="5210868">wr</span><span class="op" id="5210870">.</span><span class="ident" id="5210871">req</span><span class="op" id="5210874">.</span><span class="ident" id="5210875">Request</span><span class="op" id="5210882">.</span><span class="ident" id="5210883">write</span><span class="op" id="5210888">(</span><span class="ident" id="5210889">pc</span><span class="op" id="5210891">.</span><span class="ident" id="5210892">bw</span><span class="op" id="5210894">,</span>&nbsp;<span class="ident" id="5210896">pc</span><span class="op" id="5210898">.</span><span class="ident" id="5210899">isProxy</span><span class="op" id="5210906">,</span>&nbsp;<span class="ident" id="5210908">wr</span><span class="op" id="5210910">.</span><span class="ident" id="5210911">req</span><span class="op" id="5210914">.</span><span class="ident" id="5210915">extra</span><span class="op" id="5210920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210925">if</span>&nbsp;<span class="ident" id="5210928">err</span>&nbsp;<span class="op" id="5210932">==</span>&nbsp;<span class="ident" id="5210935">nil</span>&nbsp;<span class="op" id="5210939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210945">err</span>&nbsp;<span class="op" id="5210949">=</span>&nbsp;<span class="ident" id="5210951">pc</span><span class="op" id="5210953">.</span><span class="ident" id="5210954">bw</span><span class="op" id="5210956">.</span><span class="ident" id="5210957">Flush</span><span class="op" id="5210962">(</span><span class="op" id="5210963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210968">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210973">if</span>&nbsp;<span class="ident" id="5210976">err</span>&nbsp;<span class="op" id="5210980">!=</span>&nbsp;<span class="ident" id="5210983">nil</span>&nbsp;<span class="op" id="5210987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210993">pc</span><span class="op" id="5210995">.</span><span class="ident" id="5210996">markBroken</span><span class="op" id="5211006">(</span><span class="op" id="5211007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211013">wr</span><span class="op" id="5211015">.</span><span class="ident" id="5211016">req</span><span class="op" id="5211019">.</span><span class="ident" id="5211020">Request</span><span class="op" id="5211027">.</span><span class="ident" id="5211028">closeBody</span><span class="op" id="5211037">(</span><span class="op" id="5211038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211048">pc</span><span class="op" id="5211050">.</span><span class="ident" id="5211051">writeErrCh</span>&nbsp;<span class="op" id="5211062">&lt;-</span>&nbsp;<span class="ident" id="5211065">err</span>&nbsp;<span class="comment" id="5211069">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211118">wr</span><span class="op" id="5211120">.</span><span class="ident" id="5211121">ch</span>&nbsp;<span class="op" id="5211124">&lt;-</span>&nbsp;<span class="ident" id="5211127">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5211139">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211170">case</span>&nbsp;<span class="op" id="5211175">&lt;-</span><span class="ident" id="5211177">pc</span><span class="op" id="5211179">.</span><span class="ident" id="5211180">closech</span><span class="op" id="5211187">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211192">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211204">}</span><br>
<span class="lineno">965</span><span class="op" id="5211206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5211209">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="5211290">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="5211345">func</span>&nbsp;<span class="op" id="5211350">(</span><span class="ident" id="5211351">pc</span>&nbsp;<span class="op" id="5211354">*</span><span class="ident" id="5211355">persistConn</span><span class="op" id="5211366">)</span>&nbsp;<span class="ident" id="5211368">wroteRequest</span><span class="op" id="5211380">(</span><span class="op" id="5211381">)</span>&nbsp;<span class="builtintype" id="5211383">bool</span>&nbsp;<span class="op" id="5211388">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211391">select</span>&nbsp;<span class="op" id="5211398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211401">case</span>&nbsp;<span class="ident" id="5211406">err</span>&nbsp;<span class="op" id="5211410">:=</span>&nbsp;<span class="op" id="5211413">&lt;-</span><span class="ident" id="5211415">pc</span><span class="op" id="5211417">.</span><span class="ident" id="5211418">writeErrCh</span><span class="op" id="5211428">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211432">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211498">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211527">return</span>&nbsp;<span class="ident" id="5211534">err</span>&nbsp;<span class="op" id="5211538">==</span>&nbsp;<span class="ident" id="5211541">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211546">default</span><span class="op" id="5211553">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211557">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211620">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211683">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211750">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211805">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211810">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211874">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5211939">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212003">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212067">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212098">select</span>&nbsp;<span class="op" id="5212105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212109">case</span>&nbsp;<span class="ident" id="5212114">err</span>&nbsp;<span class="op" id="5212118">:=</span>&nbsp;<span class="op" id="5212121">&lt;-</span><span class="ident" id="5212123">pc</span><span class="op" id="5212125">.</span><span class="ident" id="5212126">writeErrCh</span><span class="op" id="5212136">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212141">return</span>&nbsp;<span class="ident" id="5212148">err</span>&nbsp;<span class="op" id="5212152">==</span>&nbsp;<span class="ident" id="5212155">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212161">case</span>&nbsp;<span class="op" id="5212166">&lt;-</span><span class="ident" id="5212168">time</span><span class="op" id="5212172">.</span><span class="ident" id="5212173">After</span><span class="op" id="5212178">(</span><span class="num" id="5212179">50</span>&nbsp;<span class="op" id="5212182">*</span>&nbsp;<span class="ident" id="5212184">time</span><span class="op" id="5212188">.</span><span class="ident" id="5212189">Millisecond</span><span class="op" id="5212200">)</span><span class="op" id="5212201">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212206">return</span>&nbsp;<span class="builtintype" id="5212213">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212224">}</span><br>
<span class="lineno"></span><span class="op" id="5212226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="5212229">type</span>&nbsp;<span class="ident" id="5212234">responseAndError</span>&nbsp;<span class="keyword" id="5212251">struct</span>&nbsp;<span class="op" id="5212258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212261">res</span>&nbsp;<span class="op" id="5212265">*</span><span class="ident" id="5212266">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212276">err</span>&nbsp;<span class="builtintype" id="5212280">error</span><br>
<span class="lineno"></span><span class="op" id="5212286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="5212289">type</span>&nbsp;<span class="ident" id="5212294">requestAndChan</span>&nbsp;<span class="keyword" id="5212309">struct</span>&nbsp;<span class="op" id="5212316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212319">req</span>&nbsp;<span class="op" id="5212323">*</span><span class="ident" id="5212324">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212333">ch</span>&nbsp;&nbsp;<span class="keyword" id="5212337">chan</span>&nbsp;<span class="ident" id="5212342">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212361">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212422">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5212479">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212517">addedGzip</span>&nbsp;<span class="builtintype" id="5212527">bool</span><br>
<span class="lineno"></span><span class="op" id="5212532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="5212535">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5212596">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="5212660">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5212726">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="5212736">type</span>&nbsp;<span class="ident" id="5212741">writeRequest</span>&nbsp;<span class="keyword" id="5212754">struct</span>&nbsp;<span class="op" id="5212761">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212764">req</span>&nbsp;<span class="op" id="5212768">*</span><span class="ident" id="5212769">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212787">ch</span>&nbsp;&nbsp;<span class="keyword" id="5212791">chan</span><span class="op" id="5212795">&lt;-</span>&nbsp;<span class="builtintype" id="5212798">error</span><br>
<span class="lineno"></span><span class="op" id="5212804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5212807">type</span>&nbsp;<span class="ident" id="5212812">httpError</span>&nbsp;<span class="keyword" id="5212822">struct</span>&nbsp;<span class="op" id="5212829">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212832">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5212840">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212848">timeout</span>&nbsp;<span class="builtintype" id="5212856">bool</span><br>
<span class="lineno"></span><span class="op" id="5212861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5212864">func</span>&nbsp;<span class="op" id="5212869">(</span><span class="ident" id="5212870">e</span>&nbsp;<span class="op" id="5212872">*</span><span class="ident" id="5212873">httpError</span><span class="op" id="5212882">)</span>&nbsp;<span class="ident" id="5212884">Error</span><span class="op" id="5212889">(</span><span class="op" id="5212890">)</span>&nbsp;<span class="builtintype" id="5212892">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5212901">{</span>&nbsp;<span class="keyword" id="5212903">return</span>&nbsp;<span class="ident" id="5212910">e</span><span class="op" id="5212911">.</span><span class="ident" id="5212912">err</span>&nbsp;<span class="op" id="5212916">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="5212918">func</span>&nbsp;<span class="op" id="5212923">(</span><span class="ident" id="5212924">e</span>&nbsp;<span class="op" id="5212926">*</span><span class="ident" id="5212927">httpError</span><span class="op" id="5212936">)</span>&nbsp;<span class="ident" id="5212938">Timeout</span><span class="op" id="5212945">(</span><span class="op" id="5212946">)</span>&nbsp;<span class="builtintype" id="5212948">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5212955">{</span>&nbsp;<span class="keyword" id="5212957">return</span>&nbsp;<span class="ident" id="5212964">e</span><span class="op" id="5212965">.</span><span class="ident" id="5212966">timeout</span>&nbsp;<span class="op" id="5212974">}</span><br>
<span class="lineno"></span><span class="keyword" id="5212976">func</span>&nbsp;<span class="op" id="5212981">(</span><span class="ident" id="5212982">e</span>&nbsp;<span class="op" id="5212984">*</span><span class="ident" id="5212985">httpError</span><span class="op" id="5212994">)</span>&nbsp;<span class="ident" id="5212996">Temporary</span><span class="op" id="5213005">(</span><span class="op" id="5213006">)</span>&nbsp;<span class="builtintype" id="5213008">bool</span>&nbsp;<span class="op" id="5213013">{</span>&nbsp;<span class="keyword" id="5213015">return</span>&nbsp;<span class="builtintype" id="5213022">true</span>&nbsp;<span class="op" id="5213027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5213030">var</span>&nbsp;<span class="ident" id="5213034">errTimeout</span>&nbsp;<span class="builtintype" id="5213045">error</span>&nbsp;<span class="op" id="5213051">=</span>&nbsp;<span class="op" id="5213053">&amp;</span><span class="ident" id="5213054">httpError</span><span class="op" id="5213063">{</span><span class="ident" id="5213064">err</span><span class="op" id="5213067">:</span>&nbsp;<span class="string" id="5213069">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="5213114">,</span>&nbsp;<span class="ident" id="5213116">timeout</span><span class="op" id="5213123">:</span>&nbsp;<span class="builtintype" id="5213125">true</span><span class="op" id="5213129">}</span><br>
<span class="lineno"></span><span class="keyword" id="5213131">var</span>&nbsp;<span class="ident" id="5213135">errClosed</span>&nbsp;<span class="builtintype" id="5213145">error</span>&nbsp;<span class="op" id="5213151">=</span>&nbsp;<span class="op" id="5213153">&amp;</span><span class="ident" id="5213154">httpError</span><span class="op" id="5213163">{</span><span class="ident" id="5213164">err</span><span class="op" id="5213167">:</span>&nbsp;<span class="string" id="5213169">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="5213226">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="5213229">func</span>&nbsp;<span class="op" id="5213234">(</span><span class="ident" id="5213235">pc</span>&nbsp;<span class="op" id="5213238">*</span><span class="ident" id="5213239">persistConn</span><span class="op" id="5213250">)</span>&nbsp;<span class="ident" id="5213252">roundTrip</span><span class="op" id="5213261">(</span><span class="ident" id="5213262">req</span>&nbsp;<span class="op" id="5213266">*</span><span class="ident" id="5213267">transportRequest</span><span class="op" id="5213283">)</span>&nbsp;<span class="op" id="5213285">(</span><span class="ident" id="5213286">resp</span>&nbsp;<span class="op" id="5213291">*</span><span class="ident" id="5213292">Response</span><span class="op" id="5213300">,</span>&nbsp;<span class="ident" id="5213302">err</span>&nbsp;<span class="builtintype" id="5213306">error</span><span class="op" id="5213311">)</span>&nbsp;<span class="op" id="5213313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213316">pc</span><span class="op" id="5213318">.</span><span class="ident" id="5213319">t</span><span class="op" id="5213320">.</span><span class="ident" id="5213321">setReqCanceler</span><span class="op" id="5213335">(</span><span class="ident" id="5213336">req</span><span class="op" id="5213339">.</span><span class="ident" id="5213340">Request</span><span class="op" id="5213347">,</span>&nbsp;<span class="ident" id="5213349">pc</span><span class="op" id="5213351">.</span><span class="ident" id="5213352">cancelRequest</span><span class="op" id="5213365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213368">pc</span><span class="op" id="5213370">.</span><span class="ident" id="5213371">lk</span><span class="op" id="5213373">.</span><span class="ident" id="5213374">Lock</span><span class="op" id="5213378">(</span><span class="op" id="5213379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213382">pc</span><span class="op" id="5213384">.</span><span class="ident" id="5213385">numExpectedResponses</span><span class="op" id="5213405">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213409">headerFn</span>&nbsp;<span class="op" id="5213418">:=</span>&nbsp;<span class="ident" id="5213421">pc</span><span class="op" id="5213423">.</span><span class="ident" id="5213424">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213442">pc</span><span class="op" id="5213444">.</span><span class="ident" id="5213445">lk</span><span class="op" id="5213447">.</span><span class="ident" id="5213448">Unlock</span><span class="op" id="5213454">(</span><span class="op" id="5213455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213459">if</span>&nbsp;<span class="ident" id="5213462">headerFn</span>&nbsp;<span class="op" id="5213471">!=</span>&nbsp;<span class="ident" id="5213474">nil</span>&nbsp;<span class="op" id="5213478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213482">headerFn</span><span class="op" id="5213490">(</span><span class="ident" id="5213491">req</span><span class="op" id="5213494">.</span><span class="ident" id="5213495">extraHeaders</span><span class="op" id="5213507">(</span><span class="op" id="5213508">)</span><span class="op" id="5213509">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213516">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213580">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213634">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213691">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213709">requestedGzip</span>&nbsp;<span class="op" id="5213723">:=</span>&nbsp;<span class="builtintype" id="5213726">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213733">if</span>&nbsp;<span class="op" id="5213736">!</span><span class="ident" id="5213737">pc</span><span class="op" id="5213739">.</span><span class="ident" id="5213740">t</span><span class="op" id="5213741">.</span><span class="ident" id="5213742">DisableCompression</span>&nbsp;<span class="op" id="5213761">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213766">req</span><span class="op" id="5213769">.</span><span class="ident" id="5213770">Header</span><span class="op" id="5213776">.</span><span class="ident" id="5213777">Get</span><span class="op" id="5213780">(</span><span class="string" id="5213781">&#34;Accept-Encoding&#34;</span><span class="op" id="5213798">)</span>&nbsp;<span class="op" id="5213800">==</span>&nbsp;<span class="string" id="5213803">&#34;&#34;</span>&nbsp;<span class="op" id="5213806">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213811">req</span><span class="op" id="5213814">.</span><span class="ident" id="5213815">Header</span><span class="op" id="5213821">.</span><span class="ident" id="5213822">Get</span><span class="op" id="5213825">(</span><span class="string" id="5213826">&#34;Range&#34;</span><span class="op" id="5213833">)</span>&nbsp;<span class="op" id="5213835">==</span>&nbsp;<span class="string" id="5213838">&#34;&#34;</span>&nbsp;<span class="op" id="5213841">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213846">req</span><span class="op" id="5213849">.</span><span class="ident" id="5213850">Method</span>&nbsp;<span class="op" id="5213857">!=</span>&nbsp;<span class="string" id="5213860">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5213867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213871">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213933">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5213975">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214030">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214035">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214091">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214119">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214165">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214201">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214206">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214270">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214336">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214382">requestedGzip</span>&nbsp;<span class="op" id="5214396">=</span>&nbsp;<span class="builtintype" id="5214398">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214405">req</span><span class="op" id="5214408">.</span><span class="ident" id="5214409">extraHeaders</span><span class="op" id="5214421">(</span><span class="op" id="5214422">)</span><span class="op" id="5214423">.</span><span class="ident" id="5214424">Set</span><span class="op" id="5214427">(</span><span class="string" id="5214428">&#34;Accept-Encoding&#34;</span><span class="op" id="5214445">,</span>&nbsp;<span class="string" id="5214447">&#34;gzip&#34;</span><span class="op" id="5214453">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5214456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214460">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214524">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214588">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214606">writeErrCh</span>&nbsp;<span class="op" id="5214617">:=</span>&nbsp;<span class="builtinfunc" id="5214620">make</span><span class="op" id="5214624">(</span><span class="keyword" id="5214625">chan</span>&nbsp;<span class="builtintype" id="5214630">error</span><span class="op" id="5214635">,</span>&nbsp;<span class="num" id="5214637">1</span><span class="op" id="5214638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214641">pc</span><span class="op" id="5214643">.</span><span class="ident" id="5214644">writech</span>&nbsp;<span class="op" id="5214652">&lt;-</span>&nbsp;<span class="ident" id="5214655">writeRequest</span><span class="op" id="5214667">{</span><span class="ident" id="5214668">req</span><span class="op" id="5214671">,</span>&nbsp;<span class="ident" id="5214673">writeErrCh</span><span class="op" id="5214683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214687">resc</span>&nbsp;<span class="op" id="5214692">:=</span>&nbsp;<span class="builtinfunc" id="5214695">make</span><span class="op" id="5214699">(</span><span class="keyword" id="5214700">chan</span>&nbsp;<span class="ident" id="5214705">responseAndError</span><span class="op" id="5214721">,</span>&nbsp;<span class="num" id="5214723">1</span><span class="op" id="5214724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214727">pc</span><span class="op" id="5214729">.</span><span class="ident" id="5214730">reqch</span>&nbsp;<span class="op" id="5214736">&lt;-</span>&nbsp;<span class="ident" id="5214739">requestAndChan</span><span class="op" id="5214753">{</span><span class="ident" id="5214754">req</span><span class="op" id="5214757">.</span><span class="ident" id="5214758">Request</span><span class="op" id="5214765">,</span>&nbsp;<span class="ident" id="5214767">resc</span><span class="op" id="5214771">,</span>&nbsp;<span class="ident" id="5214773">requestedGzip</span><span class="op" id="5214786">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214790">var</span>&nbsp;<span class="ident" id="5214794">re</span>&nbsp;<span class="ident" id="5214797">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214815">var</span>&nbsp;<span class="ident" id="5214819">pconnDeadCh</span>&nbsp;<span class="op" id="5214831">=</span>&nbsp;<span class="ident" id="5214833">pc</span><span class="op" id="5214835">.</span><span class="ident" id="5214836">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214845">var</span>&nbsp;<span class="ident" id="5214849">failTicker</span>&nbsp;<span class="op" id="5214860">&lt;-</span><span class="keyword" id="5214862">chan</span>&nbsp;<span class="ident" id="5214867">time</span><span class="op" id="5214871">.</span><span class="ident" id="5214872">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214878">var</span>&nbsp;<span class="ident" id="5214882">respHeaderTimer</span>&nbsp;<span class="op" id="5214898">&lt;-</span><span class="keyword" id="5214900">chan</span>&nbsp;<span class="ident" id="5214905">time</span><span class="op" id="5214909">.</span><span class="ident" id="5214910">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="5214915">WaitResponse</span><span class="op" id="5214927">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214930">for</span>&nbsp;<span class="op" id="5214934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214938">select</span>&nbsp;<span class="op" id="5214945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214949">case</span>&nbsp;<span class="ident" id="5214954">err</span>&nbsp;<span class="op" id="5214958">:=</span>&nbsp;<span class="op" id="5214961">&lt;-</span><span class="ident" id="5214963">writeErrCh</span><span class="op" id="5214973">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214978">if</span>&nbsp;<span class="ident" id="5214981">err</span>&nbsp;<span class="op" id="5214985">!=</span>&nbsp;<span class="ident" id="5214988">nil</span>&nbsp;<span class="op" id="5214992">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214998">re</span>&nbsp;<span class="op" id="5215001">=</span>&nbsp;<span class="ident" id="5215003">responseAndError</span><span class="op" id="5215019">{</span><span class="ident" id="5215020">nil</span><span class="op" id="5215023">,</span>&nbsp;<span class="ident" id="5215025">err</span><span class="op" id="5215028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215034">pc</span><span class="op" id="5215036">.</span><span class="builtinfunc" id="5215037">close</span><span class="op" id="5215042">(</span><span class="op" id="5215043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215049">break</span>&nbsp;<span class="ident" id="5215055">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215076">if</span>&nbsp;<span class="ident" id="5215079">d</span>&nbsp;<span class="op" id="5215081">:=</span>&nbsp;<span class="ident" id="5215084">pc</span><span class="op" id="5215086">.</span><span class="ident" id="5215087">t</span><span class="op" id="5215088">.</span><span class="ident" id="5215089">ResponseHeaderTimeout</span><span class="op" id="5215110">;</span>&nbsp;<span class="ident" id="5215112">d</span>&nbsp;<span class="op" id="5215114">&gt;</span>&nbsp;<span class="num" id="5215116">0</span>&nbsp;<span class="op" id="5215118">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215124">respHeaderTimer</span>&nbsp;<span class="op" id="5215140">=</span>&nbsp;<span class="ident" id="5215142">time</span><span class="op" id="5215146">.</span><span class="ident" id="5215147">After</span><span class="op" id="5215152">(</span><span class="ident" id="5215153">d</span><span class="op" id="5215154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215163">case</span>&nbsp;<span class="op" id="5215168">&lt;-</span><span class="ident" id="5215170">pconnDeadCh</span><span class="op" id="5215181">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215186">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215239">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215299">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215356">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215410">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215469">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215527">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215584">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215618">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215624">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215689">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215745">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215788">pconnDeadCh</span>&nbsp;<span class="op" id="5215800">=</span>&nbsp;<span class="ident" id="5215802">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5215836">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215857">failTicker</span>&nbsp;<span class="op" id="5215868">=</span>&nbsp;<span class="ident" id="5215870">time</span><span class="op" id="5215874">.</span><span class="ident" id="5215875">After</span><span class="op" id="5215880">(</span><span class="num" id="5215881">100</span>&nbsp;<span class="op" id="5215885">*</span>&nbsp;<span class="ident" id="5215887">time</span><span class="op" id="5215891">.</span><span class="ident" id="5215892">Millisecond</span><span class="op" id="5215903">)</span>&nbsp;<span class="comment" id="5215905">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215942">case</span>&nbsp;<span class="op" id="5215947">&lt;-</span><span class="ident" id="5215949">failTicker</span><span class="op" id="5215959">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215964">re</span>&nbsp;<span class="op" id="5215967">=</span>&nbsp;<span class="ident" id="5215969">responseAndError</span><span class="op" id="5215985">{</span><span class="ident" id="5215986">err</span><span class="op" id="5215989">:</span>&nbsp;<span class="ident" id="5215991">errClosed</span><span class="op" id="5216000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216005">break</span>&nbsp;<span class="ident" id="5216011">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216026">case</span>&nbsp;<span class="op" id="5216031">&lt;-</span><span class="ident" id="5216033">respHeaderTimer</span><span class="op" id="5216048">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216053">pc</span><span class="op" id="5216055">.</span><span class="builtinfunc" id="5216056">close</span><span class="op" id="5216061">(</span><span class="op" id="5216062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216067">re</span>&nbsp;<span class="op" id="5216070">=</span>&nbsp;<span class="ident" id="5216072">responseAndError</span><span class="op" id="5216088">{</span><span class="ident" id="5216089">err</span><span class="op" id="5216092">:</span>&nbsp;<span class="ident" id="5216094">errTimeout</span><span class="op" id="5216104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216109">break</span>&nbsp;<span class="ident" id="5216115">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216130">case</span>&nbsp;<span class="ident" id="5216135">re</span>&nbsp;<span class="op" id="5216138">=</span>&nbsp;<span class="op" id="5216140">&lt;-</span><span class="ident" id="5216142">resc</span><span class="op" id="5216146">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216151">break</span>&nbsp;<span class="ident" id="5216157">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216179">pc</span><span class="op" id="5216181">.</span><span class="ident" id="5216182">lk</span><span class="op" id="5216184">.</span><span class="ident" id="5216185">Lock</span><span class="op" id="5216189">(</span><span class="op" id="5216190">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216193">pc</span><span class="op" id="5216195">.</span><span class="ident" id="5216196">numExpectedResponses</span><span class="op" id="5216216">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216220">pc</span><span class="op" id="5216222">.</span><span class="ident" id="5216223">lk</span><span class="op" id="5216225">.</span><span class="ident" id="5216226">Unlock</span><span class="op" id="5216232">(</span><span class="op" id="5216233">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216237">if</span>&nbsp;<span class="ident" id="5216240">re</span><span class="op" id="5216242">.</span><span class="ident" id="5216243">err</span>&nbsp;<span class="op" id="5216247">!=</span>&nbsp;<span class="ident" id="5216250">nil</span>&nbsp;<span class="op" id="5216254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216258">pc</span><span class="op" id="5216260">.</span><span class="ident" id="5216261">t</span><span class="op" id="5216262">.</span><span class="ident" id="5216263">setReqCanceler</span><span class="op" id="5216277">(</span><span class="ident" id="5216278">req</span><span class="op" id="5216281">.</span><span class="ident" id="5216282">Request</span><span class="op" id="5216289">,</span>&nbsp;<span class="ident" id="5216291">nil</span><span class="op" id="5216294">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216300">return</span>&nbsp;<span class="ident" id="5216307">re</span><span class="op" id="5216309">.</span><span class="ident" id="5216310">res</span><span class="op" id="5216313">,</span>&nbsp;<span class="ident" id="5216315">re</span><span class="op" id="5216317">.</span><span class="ident" id="5216318">err</span><br>
<span class="lineno"></span><span class="op" id="5216322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5216325">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="5216390">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="5216455">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="5216505">func</span>&nbsp;<span class="op" id="5216510">(</span><span class="ident" id="5216511">pc</span>&nbsp;<span class="op" id="5216514">*</span><span class="ident" id="5216515">persistConn</span><span class="op" id="5216526">)</span>&nbsp;<span class="ident" id="5216528">markBroken</span><span class="op" id="5216538">(</span><span class="op" id="5216539">)</span>&nbsp;<span class="op" id="5216541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216544">pc</span><span class="op" id="5216546">.</span><span class="ident" id="5216547">lk</span><span class="op" id="5216549">.</span><span class="ident" id="5216550">Lock</span><span class="op" id="5216554">(</span><span class="op" id="5216555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216558">defer</span>&nbsp;<span class="ident" id="5216564">pc</span><span class="op" id="5216566">.</span><span class="ident" id="5216567">lk</span><span class="op" id="5216569">.</span><span class="ident" id="5216570">Unlock</span><span class="op" id="5216576">(</span><span class="op" id="5216577">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216580">pc</span><span class="op" id="5216582">.</span><span class="ident" id="5216583">broken</span>&nbsp;<span class="op" id="5216590">=</span>&nbsp;<span class="builtintype" id="5216592">true</span><br>
<span class="lineno"></span><span class="op" id="5216597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5216600">func</span>&nbsp;<span class="op" id="5216605">(</span><span class="ident" id="5216606">pc</span>&nbsp;<span class="op" id="5216609">*</span><span class="ident" id="5216610">persistConn</span><span class="op" id="5216621">)</span>&nbsp;<span class="builtinfunc" id="5216623">close</span><span class="op" id="5216628">(</span><span class="op" id="5216629">)</span>&nbsp;<span class="op" id="5216631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216634">pc</span><span class="op" id="5216636">.</span><span class="ident" id="5216637">lk</span><span class="op" id="5216639">.</span><span class="ident" id="5216640">Lock</span><span class="op" id="5216644">(</span><span class="op" id="5216645">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216648">defer</span>&nbsp;<span class="ident" id="5216654">pc</span><span class="op" id="5216656">.</span><span class="ident" id="5216657">lk</span><span class="op" id="5216659">.</span><span class="ident" id="5216660">Unlock</span><span class="op" id="5216666">(</span><span class="op" id="5216667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216670">pc</span><span class="op" id="5216672">.</span><span class="ident" id="5216673">closeLocked</span><span class="op" id="5216684">(</span><span class="op" id="5216685">)</span><br>
<span class="lineno"></span><span class="op" id="5216687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5216690">func</span>&nbsp;<span class="op" id="5216695">(</span><span class="ident" id="5216696">pc</span>&nbsp;<span class="op" id="5216699">*</span><span class="ident" id="5216700">persistConn</span><span class="op" id="5216711">)</span>&nbsp;<span class="ident" id="5216713">closeLocked</span><span class="op" id="5216724">(</span><span class="op" id="5216725">)</span>&nbsp;<span class="op" id="5216727">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216730">pc</span><span class="op" id="5216732">.</span><span class="ident" id="5216733">broken</span>&nbsp;<span class="op" id="5216740">=</span>&nbsp;<span class="builtintype" id="5216742">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216748">if</span>&nbsp;<span class="op" id="5216751">!</span><span class="ident" id="5216752">pc</span><span class="op" id="5216754">.</span><span class="ident" id="5216755">closed</span>&nbsp;<span class="op" id="5216762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216766">pc</span><span class="op" id="5216768">.</span><span class="ident" id="5216769">conn</span><span class="op" id="5216773">.</span><span class="ident" id="5216774">Close</span><span class="op" id="5216779">(</span><span class="op" id="5216780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216784">pc</span><span class="op" id="5216786">.</span><span class="ident" id="5216787">closed</span>&nbsp;<span class="op" id="5216794">=</span>&nbsp;<span class="builtintype" id="5216796">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5216803">close</span><span class="op" id="5216808">(</span><span class="ident" id="5216809">pc</span><span class="op" id="5216811">.</span><span class="ident" id="5216812">closech</span><span class="op" id="5216819">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216825">pc</span><span class="op" id="5216827">.</span><span class="ident" id="5216828">mutateHeaderFunc</span>&nbsp;<span class="op" id="5216845">=</span>&nbsp;<span class="ident" id="5216847">nil</span><br>
<span class="lineno"></span><span class="op" id="5216851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5216854">var</span>&nbsp;<span class="ident" id="5216858">portMap</span>&nbsp;<span class="op" id="5216866">=</span>&nbsp;<span class="keyword" id="5216868">map</span><span class="op" id="5216871">[</span><span class="builtintype" id="5216872">string</span><span class="op" id="5216878">]</span><span class="builtintype" id="5216879">string</span><span class="op" id="5216885">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5216888">&#34;http&#34;</span><span class="op" id="5216894">:</span>&nbsp;&nbsp;<span class="string" id="5216897">&#34;80&#34;</span><span class="op" id="5216901">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5216904">&#34;https&#34;</span><span class="op" id="5216911">:</span>&nbsp;<span class="string" id="5216913">&#34;443&#34;</span><span class="op" id="5216918">,</span><br>
<span class="lineno"></span><span class="op" id="5216920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5216923">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="5216990">func</span>&nbsp;<span class="ident" id="5216995">canonicalAddr</span><span class="op" id="5217008">(</span><span class="ident" id="5217009">url</span>&nbsp;<span class="op" id="5217013">*</span><span class="ident" id="5217014">url</span><span class="op" id="5217017">.</span><span class="ident" id="5217018">URL</span><span class="op" id="5217021">)</span>&nbsp;<span class="builtintype" id="5217023">string</span>&nbsp;<span class="op" id="5217030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217033">addr</span>&nbsp;<span class="op" id="5217038">:=</span>&nbsp;<span class="ident" id="5217041">url</span><span class="op" id="5217044">.</span><span class="ident" id="5217045">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217051">if</span>&nbsp;<span class="op" id="5217054">!</span><span class="ident" id="5217055">hasPort</span><span class="op" id="5217062">(</span><span class="ident" id="5217063">addr</span><span class="op" id="5217067">)</span>&nbsp;<span class="op" id="5217069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217073">return</span>&nbsp;<span class="ident" id="5217080">addr</span>&nbsp;<span class="op" id="5217085">+</span>&nbsp;<span class="string" id="5217087">&#34;:&#34;</span>&nbsp;<span class="op" id="5217091">+</span>&nbsp;<span class="ident" id="5217093">portMap</span><span class="op" id="5217100">[</span><span class="ident" id="5217101">url</span><span class="op" id="5217104">.</span><span class="ident" id="5217105">Scheme</span><span class="op" id="5217111">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217114">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217117">return</span>&nbsp;<span class="ident" id="5217124">addr</span><br>
<span class="lineno"></span><span class="op" id="5217129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5217132">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="5217201">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="5217270">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="5217336">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="5217401">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5217449">type</span>&nbsp;<span class="ident" id="5217454">bodyEOFSignal</span>&nbsp;<span class="keyword" id="5217468">struct</span>&nbsp;<span class="op" id="5217475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217478">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5217491">io</span><span class="op" id="5217493">.</span><span class="ident" id="5217494">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217506">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5217519">sync</span><span class="op" id="5217523">.</span><span class="ident" id="5217524">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5217532">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217562">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5217575">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5217588">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217622">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5217635">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5217648">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217670">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5217683">func</span><span class="op" id="5217687">(</span><span class="builtintype" id="5217688">error</span><span class="op" id="5217693">)</span>&nbsp;&nbsp;<span class="comment" id="5217696">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217733">earlyCloseFn</span>&nbsp;<span class="keyword" id="5217746">func</span><span class="op" id="5217750">(</span><span class="op" id="5217751">)</span>&nbsp;<span class="builtintype" id="5217753">error</span>&nbsp;<span class="comment" id="5217759">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="5217810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5217813">func</span>&nbsp;<span class="op" id="5217818">(</span><span class="ident" id="5217819">es</span>&nbsp;<span class="op" id="5217822">*</span><span class="ident" id="5217823">bodyEOFSignal</span><span class="op" id="5217836">)</span>&nbsp;<span class="ident" id="5217838">Read</span><span class="op" id="5217842">(</span><span class="ident" id="5217843">p</span>&nbsp;<span class="op" id="5217845">[</span><span class="op" id="5217846">]</span><span class="builtintype" id="5217847">byte</span><span class="op" id="5217851">)</span>&nbsp;<span class="op" id="5217853">(</span><span class="ident" id="5217854">n</span>&nbsp;<span class="builtintype" id="5217856">int</span><span class="op" id="5217859">,</span>&nbsp;<span class="ident" id="5217861">err</span>&nbsp;<span class="builtintype" id="5217865">error</span><span class="op" id="5217870">)</span>&nbsp;<span class="op" id="5217872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217875">es</span><span class="op" id="5217877">.</span><span class="ident" id="5217878">mu</span><span class="op" id="5217880">.</span><span class="ident" id="5217881">Lock</span><span class="op" id="5217885">(</span><span class="op" id="5217886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217889">closed</span><span class="op" id="5217895">,</span>&nbsp;<span class="ident" id="5217897">rerr</span>&nbsp;<span class="op" id="5217902">:=</span>&nbsp;<span class="ident" id="5217905">es</span><span class="op" id="5217907">.</span><span class="ident" id="5217908">closed</span><span class="op" id="5217914">,</span>&nbsp;<span class="ident" id="5217916">es</span><span class="op" id="5217918">.</span><span class="ident" id="5217919">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217925">es</span><span class="op" id="5217927">.</span><span class="ident" id="5217928">mu</span><span class="op" id="5217930">.</span><span class="ident" id="5217931">Unlock</span><span class="op" id="5217937">(</span><span class="op" id="5217938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217941">if</span>&nbsp;<span class="ident" id="5217944">closed</span>&nbsp;<span class="op" id="5217951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217955">return</span>&nbsp;<span class="num" id="5217962">0</span><span class="op" id="5217963">,</span>&nbsp;<span class="ident" id="5217965">errors</span><span class="op" id="5217971">.</span><span class="ident" id="5217972">New</span><span class="op" id="5217975">(</span><span class="string" id="5217976">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="5218012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218018">if</span>&nbsp;<span class="ident" id="5218021">rerr</span>&nbsp;<span class="op" id="5218026">!=</span>&nbsp;<span class="ident" id="5218029">nil</span>&nbsp;<span class="op" id="5218033">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218037">return</span>&nbsp;<span class="num" id="5218044">0</span><span class="op" id="5218045">,</span>&nbsp;<span class="ident" id="5218047">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218057">n</span><span class="op" id="5218058">,</span>&nbsp;<span class="ident" id="5218060">err</span>&nbsp;<span class="op" id="5218064">=</span>&nbsp;<span class="ident" id="5218066">es</span><span class="op" id="5218068">.</span><span class="ident" id="5218069">body</span><span class="op" id="5218073">.</span><span class="ident" id="5218074">Read</span><span class="op" id="5218078">(</span><span class="ident" id="5218079">p</span><span class="op" id="5218080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218083">if</span>&nbsp;<span class="ident" id="5218086">err</span>&nbsp;<span class="op" id="5218090">!=</span>&nbsp;<span class="ident" id="5218093">nil</span>&nbsp;<span class="op" id="5218097">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218101">es</span><span class="op" id="5218103">.</span><span class="ident" id="5218104">mu</span><span class="op" id="5218106">.</span><span class="ident" id="5218107">Lock</span><span class="op" id="5218111">(</span><span class="op" id="5218112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218116">defer</span>&nbsp;<span class="ident" id="5218122">es</span><span class="op" id="5218124">.</span><span class="ident" id="5218125">mu</span><span class="op" id="5218127">.</span><span class="ident" id="5218128">Unlock</span><span class="op" id="5218134">(</span><span class="op" id="5218135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218139">if</span>&nbsp;<span class="ident" id="5218142">es</span><span class="op" id="5218144">.</span><span class="ident" id="5218145">rerr</span>&nbsp;<span class="op" id="5218150">==</span>&nbsp;<span class="ident" id="5218153">nil</span>&nbsp;<span class="op" id="5218157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218162">es</span><span class="op" id="5218164">.</span><span class="ident" id="5218165">rerr</span>&nbsp;<span class="op" id="5218170">=</span>&nbsp;<span class="ident" id="5218172">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218178">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218182">es</span><span class="op" id="5218184">.</span><span class="ident" id="5218185">condfn</span><span class="op" id="5218191">(</span><span class="ident" id="5218192">err</span><span class="op" id="5218195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218201">return</span><br>
<span class="lineno"></span><span class="op" id="5218208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="5218211">func</span>&nbsp;<span class="op" id="5218216">(</span><span class="ident" id="5218217">es</span>&nbsp;<span class="op" id="5218220">*</span><span class="ident" id="5218221">bodyEOFSignal</span><span class="op" id="5218234">)</span>&nbsp;<span class="ident" id="5218236">Close</span><span class="op" id="5218241">(</span><span class="op" id="5218242">)</span>&nbsp;<span class="builtintype" id="5218244">error</span>&nbsp;<span class="op" id="5218250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218253">es</span><span class="op" id="5218255">.</span><span class="ident" id="5218256">mu</span><span class="op" id="5218258">.</span><span class="ident" id="5218259">Lock</span><span class="op" id="5218263">(</span><span class="op" id="5218264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218267">defer</span>&nbsp;<span class="ident" id="5218273">es</span><span class="op" id="5218275">.</span><span class="ident" id="5218276">mu</span><span class="op" id="5218278">.</span><span class="ident" id="5218279">Unlock</span><span class="op" id="5218285">(</span><span class="op" id="5218286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218289">if</span>&nbsp;<span class="ident" id="5218292">es</span><span class="op" id="5218294">.</span><span class="ident" id="5218295">closed</span>&nbsp;<span class="op" id="5218302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218306">return</span>&nbsp;<span class="ident" id="5218313">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218321">es</span><span class="op" id="5218323">.</span><span class="ident" id="5218324">closed</span>&nbsp;<span class="op" id="5218331">=</span>&nbsp;<span class="builtintype" id="5218333">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218339">if</span>&nbsp;<span class="ident" id="5218342">es</span><span class="op" id="5218344">.</span><span class="ident" id="5218345">earlyCloseFn</span>&nbsp;<span class="op" id="5218358">!=</span>&nbsp;<span class="ident" id="5218361">nil</span>&nbsp;<span class="op" id="5218365">&amp;&amp;</span>&nbsp;<span class="ident" id="5218368">es</span><span class="op" id="5218370">.</span><span class="ident" id="5218371">rerr</span>&nbsp;<span class="op" id="5218376">!=</span>&nbsp;<span class="ident" id="5218379">io</span><span class="op" id="5218381">.</span><span class="ident" id="5218382">EOF</span>&nbsp;<span class="op" id="5218386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218390">return</span>&nbsp;<span class="ident" id="5218397">es</span><span class="op" id="5218399">.</span><span class="ident" id="5218400">earlyCloseFn</span><span class="op" id="5218412">(</span><span class="op" id="5218413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218416">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218419">err</span>&nbsp;<span class="op" id="5218423">:=</span>&nbsp;<span class="ident" id="5218426">es</span><span class="op" id="5218428">.</span><span class="ident" id="5218429">body</span><span class="op" id="5218433">.</span><span class="ident" id="5218434">Close</span><span class="op" id="5218439">(</span><span class="op" id="5218440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218443">es</span><span class="op" id="5218445">.</span><span class="ident" id="5218446">condfn</span><span class="op" id="5218452">(</span><span class="ident" id="5218453">err</span><span class="op" id="5218456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218459">return</span>&nbsp;<span class="ident" id="5218466">err</span><br>
<span class="lineno"></span><span class="op" id="5218470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="5218473">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="5218500">func</span>&nbsp;<span class="op" id="5218505">(</span><span class="ident" id="5218506">es</span>&nbsp;<span class="op" id="5218509">*</span><span class="ident" id="5218510">bodyEOFSignal</span><span class="op" id="5218523">)</span>&nbsp;<span class="ident" id="5218525">condfn</span><span class="op" id="5218531">(</span><span class="ident" id="5218532">err</span>&nbsp;<span class="builtintype" id="5218536">error</span><span class="op" id="5218541">)</span>&nbsp;<span class="op" id="5218543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218546">if</span>&nbsp;<span class="ident" id="5218549">es</span><span class="op" id="5218551">.</span><span class="ident" id="5218552">fn</span>&nbsp;<span class="op" id="5218555">==</span>&nbsp;<span class="ident" id="5218558">nil</span>&nbsp;<span class="op" id="5218562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218566">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218574">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218577">if</span>&nbsp;<span class="ident" id="5218580">err</span>&nbsp;<span class="op" id="5218584">==</span>&nbsp;<span class="ident" id="5218587">io</span><span class="op" id="5218589">.</span><span class="ident" id="5218590">EOF</span>&nbsp;<span class="op" id="5218594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218598">err</span>&nbsp;<span class="op" id="5218602">=</span>&nbsp;<span class="ident" id="5218604">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218612">es</span><span class="op" id="5218614">.</span><span class="ident" id="5218615">fn</span><span class="op" id="5218617">(</span><span class="ident" id="5218618">err</span><span class="op" id="5218621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218624">es</span><span class="op" id="5218626">.</span><span class="ident" id="5218627">fn</span>&nbsp;<span class="op" id="5218630">=</span>&nbsp;<span class="ident" id="5218632">nil</span><br>
<span class="lineno">1230</span><span class="op" id="5218636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5218639">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="5218692">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="5218741">type</span>&nbsp;<span class="ident" id="5218746">gzipReader</span>&nbsp;<span class="keyword" id="5218757">struct</span>&nbsp;<span class="op" id="5218764">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218767">body</span>&nbsp;<span class="ident" id="5218772">io</span><span class="op" id="5218774">.</span><span class="ident" id="5218775">ReadCloser</span>&nbsp;<span class="comment" id="5218786">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218815">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5218820">io</span><span class="op" id="5218822">.</span><span class="ident" id="5218823">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5218834">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="5218868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5218871">func</span>&nbsp;<span class="op" id="5218876">(</span><span class="ident" id="5218877">gz</span>&nbsp;<span class="op" id="5218880">*</span><span class="ident" id="5218881">gzipReader</span><span class="op" id="5218891">)</span>&nbsp;<span class="ident" id="5218893">Read</span><span class="op" id="5218897">(</span><span class="ident" id="5218898">p</span>&nbsp;<span class="op" id="5218900">[</span><span class="op" id="5218901">]</span><span class="builtintype" id="5218902">byte</span><span class="op" id="5218906">)</span>&nbsp;<span class="op" id="5218908">(</span><span class="ident" id="5218909">n</span>&nbsp;<span class="builtintype" id="5218911">int</span><span class="op" id="5218914">,</span>&nbsp;<span class="ident" id="5218916">err</span>&nbsp;<span class="builtintype" id="5218920">error</span><span class="op" id="5218925">)</span>&nbsp;<span class="op" id="5218927">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218930">if</span>&nbsp;<span class="ident" id="5218933">gz</span><span class="op" id="5218935">.</span><span class="ident" id="5218936">zr</span>&nbsp;<span class="op" id="5218939">==</span>&nbsp;<span class="ident" id="5218942">nil</span>&nbsp;<span class="op" id="5218946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218950">gz</span><span class="op" id="5218952">.</span><span class="ident" id="5218953">zr</span><span class="op" id="5218955">,</span>&nbsp;<span class="ident" id="5218957">err</span>&nbsp;<span class="op" id="5218961">=</span>&nbsp;<span class="ident" id="5218963">gzip</span><span class="op" id="5218967">.</span><span class="ident" id="5218968">NewReader</span><span class="op" id="5218977">(</span><span class="ident" id="5218978">gz</span><span class="op" id="5218980">.</span><span class="ident" id="5218981">body</span><span class="op" id="5218985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218989">if</span>&nbsp;<span class="ident" id="5218992">err</span>&nbsp;<span class="op" id="5218996">!=</span>&nbsp;<span class="ident" id="5218999">nil</span>&nbsp;<span class="op" id="5219003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219008">return</span>&nbsp;<span class="num" id="5219015">0</span><span class="op" id="5219016">,</span>&nbsp;<span class="ident" id="5219018">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219024">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219030">return</span>&nbsp;<span class="ident" id="5219037">gz</span><span class="op" id="5219039">.</span><span class="ident" id="5219040">zr</span><span class="op" id="5219042">.</span><span class="ident" id="5219043">Read</span><span class="op" id="5219047">(</span><span class="ident" id="5219048">p</span><span class="op" id="5219049">)</span><br>
<span class="lineno"></span><span class="op" id="5219051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5219054">func</span>&nbsp;<span class="op" id="5219059">(</span><span class="ident" id="5219060">gz</span>&nbsp;<span class="op" id="5219063">*</span><span class="ident" id="5219064">gzipReader</span><span class="op" id="5219074">)</span>&nbsp;<span class="ident" id="5219076">Close</span><span class="op" id="5219081">(</span><span class="op" id="5219082">)</span>&nbsp;<span class="builtintype" id="5219084">error</span>&nbsp;<span class="op" id="5219090">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219093">return</span>&nbsp;<span class="ident" id="5219100">gz</span><span class="op" id="5219102">.</span><span class="ident" id="5219103">body</span><span class="op" id="5219107">.</span><span class="ident" id="5219108">Close</span><span class="op" id="5219113">(</span><span class="op" id="5219114">)</span><br>
<span class="lineno"></span><span class="op" id="5219116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5219119">type</span>&nbsp;<span class="ident" id="5219124">readerAndCloser</span>&nbsp;<span class="keyword" id="5219140">struct</span>&nbsp;<span class="op" id="5219147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219150">io</span><span class="op" id="5219152">.</span><span class="ident" id="5219153">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219161">io</span><span class="op" id="5219163">.</span><span class="ident" id="5219164">Closer</span><br>
<span class="lineno"></span><span class="op" id="5219171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5219174">type</span>&nbsp;<span class="ident" id="5219179">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="5219204">struct</span><span class="op" id="5219210">{</span><span class="op" id="5219211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="5219214">func</span>&nbsp;<span class="op" id="5219219">(</span><span class="ident" id="5219220">tlsHandshakeTimeoutError</span><span class="op" id="5219244">)</span>&nbsp;<span class="ident" id="5219246">Timeout</span><span class="op" id="5219253">(</span><span class="op" id="5219254">)</span>&nbsp;<span class="builtintype" id="5219256">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5219263">{</span>&nbsp;<span class="keyword" id="5219265">return</span>&nbsp;<span class="builtintype" id="5219272">true</span>&nbsp;<span class="op" id="5219277">}</span><br>
<span class="lineno"></span><span class="keyword" id="5219279">func</span>&nbsp;<span class="op" id="5219284">(</span><span class="ident" id="5219285">tlsHandshakeTimeoutError</span><span class="op" id="5219309">)</span>&nbsp;<span class="ident" id="5219311">Temporary</span><span class="op" id="5219320">(</span><span class="op" id="5219321">)</span>&nbsp;<span class="builtintype" id="5219323">bool</span>&nbsp;<span class="op" id="5219328">{</span>&nbsp;<span class="keyword" id="5219330">return</span>&nbsp;<span class="builtintype" id="5219337">true</span>&nbsp;<span class="op" id="5219342">}</span><br>
<span class="lineno"></span><span class="keyword" id="5219344">func</span>&nbsp;<span class="op" id="5219349">(</span><span class="ident" id="5219350">tlsHandshakeTimeoutError</span><span class="op" id="5219374">)</span>&nbsp;<span class="ident" id="5219376">Error</span><span class="op" id="5219381">(</span><span class="op" id="5219382">)</span>&nbsp;<span class="builtintype" id="5219384">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5219393">{</span>&nbsp;<span class="keyword" id="5219395">return</span>&nbsp;<span class="string" id="5219402">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="5219436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5219439">type</span>&nbsp;<span class="ident" id="5219444">noteEOFReader</span>&nbsp;<span class="keyword" id="5219458">struct</span>&nbsp;<span class="op" id="5219465">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219468">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5219475">io</span><span class="op" id="5219477">.</span><span class="ident" id="5219478">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219486">sawEOF</span>&nbsp;<span class="op" id="5219493">*</span><span class="builtintype" id="5219494">bool</span><br>
<span class="lineno"></span><span class="op" id="5219499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5219502">func</span>&nbsp;<span class="op" id="5219507">(</span><span class="ident" id="5219508">nr</span>&nbsp;<span class="ident" id="5219511">noteEOFReader</span><span class="op" id="5219524">)</span>&nbsp;<span class="ident" id="5219526">Read</span><span class="op" id="5219530">(</span><span class="ident" id="5219531">p</span>&nbsp;<span class="op" id="5219533">[</span><span class="op" id="5219534">]</span><span class="builtintype" id="5219535">byte</span><span class="op" id="5219539">)</span>&nbsp;<span class="op" id="5219541">(</span><span class="ident" id="5219542">n</span>&nbsp;<span class="builtintype" id="5219544">int</span><span class="op" id="5219547">,</span>&nbsp;<span class="ident" id="5219549">err</span>&nbsp;<span class="builtintype" id="5219553">error</span><span class="op" id="5219558">)</span>&nbsp;<span class="op" id="5219560">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219563">n</span><span class="op" id="5219564">,</span>&nbsp;<span class="ident" id="5219566">err</span>&nbsp;<span class="op" id="5219570">=</span>&nbsp;<span class="ident" id="5219572">nr</span><span class="op" id="5219574">.</span><span class="ident" id="5219575">r</span><span class="op" id="5219576">.</span><span class="ident" id="5219577">Read</span><span class="op" id="5219581">(</span><span class="ident" id="5219582">p</span><span class="op" id="5219583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219586">if</span>&nbsp;<span class="ident" id="5219589">err</span>&nbsp;<span class="op" id="5219593">==</span>&nbsp;<span class="ident" id="5219596">io</span><span class="op" id="5219598">.</span><span class="ident" id="5219599">EOF</span>&nbsp;<span class="op" id="5219603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219607">*</span><span class="ident" id="5219608">nr</span><span class="op" id="5219610">.</span><span class="ident" id="5219611">sawEOF</span>&nbsp;<span class="op" id="5219618">=</span>&nbsp;<span class="builtintype" id="5219620">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219629">return</span><br>
<span class="lineno">1275</span><span class="op" id="5219636">}</span>
</div>
</body>
</html>
