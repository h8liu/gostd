<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5448351">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5448406">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5448460">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5448511">package</span>&nbsp;<span class="ident" id="5448519">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5448524">import</span>&nbsp;<span class="op" id="5448531">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5448534">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5448543">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5448553">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5448560">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5448565">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5448568">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="5448613">type</span>&nbsp;<span class="ident" id="5448618">writer</span>&nbsp;<span class="keyword" id="5448625">interface</span>&nbsp;<span class="op" id="5448635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448638">io</span><span class="op" id="5448640">.</span><span class="ident" id="5448641">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448653">Flush</span><span class="op" id="5448658">(</span><span class="op" id="5448659">)</span>&nbsp;<span class="builtintype" id="5448661">error</span><br>
<span class="lineno"></span><span class="op" id="5448667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5448670">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5448747">type</span>&nbsp;<span class="ident" id="5448752">errWriteCloser</span>&nbsp;<span class="keyword" id="5448767">struct</span>&nbsp;<span class="op" id="5448774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448777">err</span>&nbsp;<span class="builtintype" id="5448781">error</span><br>
<span class="lineno"></span><span class="op" id="5448787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5448790">func</span>&nbsp;<span class="op" id="5448795">(</span><span class="ident" id="5448796">e</span>&nbsp;<span class="op" id="5448798">*</span><span class="ident" id="5448799">errWriteCloser</span><span class="op" id="5448813">)</span>&nbsp;<span class="ident" id="5448815">Write</span><span class="op" id="5448820">(</span><span class="op" id="5448821">[</span><span class="op" id="5448822">]</span><span class="builtintype" id="5448823">byte</span><span class="op" id="5448827">)</span>&nbsp;<span class="op" id="5448829">(</span><span class="builtintype" id="5448830">int</span><span class="op" id="5448833">,</span>&nbsp;<span class="builtintype" id="5448835">error</span><span class="op" id="5448840">)</span>&nbsp;<span class="op" id="5448842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448845">return</span>&nbsp;<span class="num" id="5448852">0</span><span class="op" id="5448853">,</span>&nbsp;<span class="ident" id="5448855">e</span><span class="op" id="5448856">.</span><span class="ident" id="5448857">err</span><br>
<span class="lineno"></span><span class="op" id="5448861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5448864">func</span>&nbsp;<span class="op" id="5448869">(</span><span class="ident" id="5448870">e</span>&nbsp;<span class="op" id="5448872">*</span><span class="ident" id="5448873">errWriteCloser</span><span class="op" id="5448887">)</span>&nbsp;<span class="ident" id="5448889">Close</span><span class="op" id="5448894">(</span><span class="op" id="5448895">)</span>&nbsp;<span class="builtintype" id="5448897">error</span>&nbsp;<span class="op" id="5448903">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448906">return</span>&nbsp;<span class="ident" id="5448913">e</span><span class="op" id="5448914">.</span><span class="ident" id="5448915">err</span><br>
<span class="lineno"></span><span class="op" id="5448919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5448922">const</span>&nbsp;<span class="op" id="5448928">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5448931">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449003">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449044">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5449056">=</span>&nbsp;<span class="num" id="5449058">1</span><span class="op" id="5449059">&lt;&lt;</span><span class="num" id="5449061">12</span>&nbsp;<span class="op" id="5449064">-</span>&nbsp;<span class="num" id="5449066">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449069">invalidCode</span>&nbsp;<span class="op" id="5449081">=</span>&nbsp;<span class="num" id="5449083">1</span><span class="op" id="5449084">&lt;&lt;</span><span class="num" id="5449086">32</span>&nbsp;<span class="op" id="5449089">-</span>&nbsp;<span class="num" id="5449091">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449094">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449171">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449250">tableSize</span>&nbsp;<span class="op" id="5449260">=</span>&nbsp;<span class="num" id="5449262">4</span>&nbsp;<span class="op" id="5449264">*</span>&nbsp;<span class="num" id="5449266">1</span>&nbsp;<span class="op" id="5449268">&lt;&lt;</span>&nbsp;<span class="num" id="5449271">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449275">tableMask</span>&nbsp;<span class="op" id="5449285">=</span>&nbsp;<span class="ident" id="5449287">tableSize</span>&nbsp;<span class="op" id="5449297">-</span>&nbsp;<span class="num" id="5449299">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449302">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449373">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449436">invalidEntry</span>&nbsp;<span class="op" id="5449449">=</span>&nbsp;<span class="num" id="5449451">0</span><br>
<span class="lineno">45</span><span class="op" id="5449453">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5449456">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="5449486">type</span>&nbsp;<span class="ident" id="5449491">encoder</span>&nbsp;<span class="keyword" id="5449499">struct</span>&nbsp;<span class="op" id="5449506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449509">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449567">w</span>&nbsp;<span class="ident" id="5449569">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449577">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449635">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449684">order</span>&nbsp;<span class="ident" id="5449690">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449697">write</span>&nbsp;<span class="keyword" id="5449703">func</span><span class="op" id="5449707">(</span><span class="op" id="5449708">*</span><span class="ident" id="5449709">encoder</span><span class="op" id="5449716">,</span>&nbsp;<span class="builtintype" id="5449718">uint32</span><span class="op" id="5449724">)</span>&nbsp;<span class="builtintype" id="5449726">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449733">bits</span>&nbsp;&nbsp;<span class="builtintype" id="5449739">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449747">nBits</span>&nbsp;<span class="builtintype" id="5449753">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449759">width</span>&nbsp;<span class="builtintype" id="5449765">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449771">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449823">litWidth</span>&nbsp;<span class="builtintype" id="5449832">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449838">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449892">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449955">hi</span><span class="op" id="5449957">,</span>&nbsp;<span class="ident" id="5449959">overflow</span>&nbsp;<span class="builtintype" id="5449968">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449976">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5450050">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450114">savedCode</span>&nbsp;<span class="builtintype" id="5450124">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5450132">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5450207">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450261">err</span>&nbsp;<span class="builtintype" id="5450265">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5450272">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5450346">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5450419">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5450490">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450524">table</span>&nbsp;<span class="op" id="5450530">[</span><span class="ident" id="5450531">tableSize</span><span class="op" id="5450540">]</span><span class="builtintype" id="5450541">uint32</span><br>
<span class="lineno"></span><span class="op" id="5450548">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="5450551">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5450622">func</span>&nbsp;<span class="op" id="5450627">(</span><span class="ident" id="5450628">e</span>&nbsp;<span class="op" id="5450630">*</span><span class="ident" id="5450631">encoder</span><span class="op" id="5450638">)</span>&nbsp;<span class="ident" id="5450640">writeLSB</span><span class="op" id="5450648">(</span><span class="ident" id="5450649">c</span>&nbsp;<span class="builtintype" id="5450651">uint32</span><span class="op" id="5450657">)</span>&nbsp;<span class="builtintype" id="5450659">error</span>&nbsp;<span class="op" id="5450665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450668">e</span><span class="op" id="5450669">.</span><span class="ident" id="5450670">bits</span>&nbsp;<span class="op" id="5450675">|=</span>&nbsp;<span class="ident" id="5450678">c</span>&nbsp;<span class="op" id="5450680">&lt;&lt;</span>&nbsp;<span class="ident" id="5450683">e</span><span class="op" id="5450684">.</span><span class="ident" id="5450685">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450692">e</span><span class="op" id="5450693">.</span><span class="ident" id="5450694">nBits</span>&nbsp;<span class="op" id="5450700">+=</span>&nbsp;<span class="ident" id="5450703">e</span><span class="op" id="5450704">.</span><span class="ident" id="5450705">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450712">for</span>&nbsp;<span class="ident" id="5450716">e</span><span class="op" id="5450717">.</span><span class="ident" id="5450718">nBits</span>&nbsp;<span class="op" id="5450724">&gt;=</span>&nbsp;<span class="num" id="5450727">8</span>&nbsp;<span class="op" id="5450729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450733">if</span>&nbsp;<span class="ident" id="5450736">err</span>&nbsp;<span class="op" id="5450740">:=</span>&nbsp;<span class="ident" id="5450743">e</span><span class="op" id="5450744">.</span><span class="ident" id="5450745">w</span><span class="op" id="5450746">.</span><span class="ident" id="5450747">WriteByte</span><span class="op" id="5450756">(</span><span class="builtintype" id="5450757">uint8</span><span class="op" id="5450762">(</span><span class="ident" id="5450763">e</span><span class="op" id="5450764">.</span><span class="ident" id="5450765">bits</span><span class="op" id="5450769">)</span><span class="op" id="5450770">)</span><span class="op" id="5450771">;</span>&nbsp;<span class="ident" id="5450773">err</span>&nbsp;<span class="op" id="5450777">!=</span>&nbsp;<span class="ident" id="5450780">nil</span>&nbsp;<span class="op" id="5450784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450789">return</span>&nbsp;<span class="ident" id="5450796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5450802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450806">e</span><span class="op" id="5450807">.</span><span class="ident" id="5450808">bits</span>&nbsp;<span class="op" id="5450813">&gt;&gt;=</span>&nbsp;<span class="num" id="5450817">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450821">e</span><span class="op" id="5450822">.</span><span class="ident" id="5450823">nBits</span>&nbsp;<span class="op" id="5450829">-=</span>&nbsp;<span class="num" id="5450832">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5450835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450838">return</span>&nbsp;<span class="ident" id="5450845">nil</span><br>
<span class="lineno"></span><span class="op" id="5450849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5450852">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5450922">func</span>&nbsp;<span class="op" id="5450927">(</span><span class="ident" id="5450928">e</span>&nbsp;<span class="op" id="5450930">*</span><span class="ident" id="5450931">encoder</span><span class="op" id="5450938">)</span>&nbsp;<span class="ident" id="5450940">writeMSB</span><span class="op" id="5450948">(</span><span class="ident" id="5450949">c</span>&nbsp;<span class="builtintype" id="5450951">uint32</span><span class="op" id="5450957">)</span>&nbsp;<span class="builtintype" id="5450959">error</span>&nbsp;<span class="op" id="5450965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450968">e</span><span class="op" id="5450969">.</span><span class="ident" id="5450970">bits</span>&nbsp;<span class="op" id="5450975">|=</span>&nbsp;<span class="ident" id="5450978">c</span>&nbsp;<span class="op" id="5450980">&lt;&lt;</span>&nbsp;<span class="op" id="5450983">(</span><span class="num" id="5450984">32</span>&nbsp;<span class="op" id="5450987">-</span>&nbsp;<span class="ident" id="5450989">e</span><span class="op" id="5450990">.</span><span class="ident" id="5450991">width</span>&nbsp;<span class="op" id="5450997">-</span>&nbsp;<span class="ident" id="5450999">e</span><span class="op" id="5451000">.</span><span class="ident" id="5451001">nBits</span><span class="op" id="5451006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451009">e</span><span class="op" id="5451010">.</span><span class="ident" id="5451011">nBits</span>&nbsp;<span class="op" id="5451017">+=</span>&nbsp;<span class="ident" id="5451020">e</span><span class="op" id="5451021">.</span><span class="ident" id="5451022">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451029">for</span>&nbsp;<span class="ident" id="5451033">e</span><span class="op" id="5451034">.</span><span class="ident" id="5451035">nBits</span>&nbsp;<span class="op" id="5451041">&gt;=</span>&nbsp;<span class="num" id="5451044">8</span>&nbsp;<span class="op" id="5451046">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451050">if</span>&nbsp;<span class="ident" id="5451053">err</span>&nbsp;<span class="op" id="5451057">:=</span>&nbsp;<span class="ident" id="5451060">e</span><span class="op" id="5451061">.</span><span class="ident" id="5451062">w</span><span class="op" id="5451063">.</span><span class="ident" id="5451064">WriteByte</span><span class="op" id="5451073">(</span><span class="builtintype" id="5451074">uint8</span><span class="op" id="5451079">(</span><span class="ident" id="5451080">e</span><span class="op" id="5451081">.</span><span class="ident" id="5451082">bits</span>&nbsp;<span class="op" id="5451087">&gt;&gt;</span>&nbsp;<span class="num" id="5451090">24</span><span class="op" id="5451092">)</span><span class="op" id="5451093">)</span><span class="op" id="5451094">;</span>&nbsp;<span class="ident" id="5451096">err</span>&nbsp;<span class="op" id="5451100">!=</span>&nbsp;<span class="ident" id="5451103">nil</span>&nbsp;<span class="op" id="5451107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451112">return</span>&nbsp;<span class="ident" id="5451119">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5451125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451129">e</span><span class="op" id="5451130">.</span><span class="ident" id="5451131">bits</span>&nbsp;<span class="op" id="5451136">&lt;&lt;=</span>&nbsp;<span class="num" id="5451140">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451144">e</span><span class="op" id="5451145">.</span><span class="ident" id="5451146">nBits</span>&nbsp;<span class="op" id="5451152">-=</span>&nbsp;<span class="num" id="5451155">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5451158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451161">return</span>&nbsp;<span class="ident" id="5451168">nil</span><br>
<span class="lineno"></span><span class="op" id="5451172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5451175">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="5451253">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="5451312">var</span>&nbsp;<span class="ident" id="5451316">errOutOfCodes</span>&nbsp;<span class="op" id="5451330">=</span>&nbsp;<span class="ident" id="5451332">errors</span><span class="op" id="5451338">.</span><span class="ident" id="5451339">New</span><span class="op" id="5451342">(</span><span class="string" id="5451343">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="5451362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5451365">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5451438">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="5451512">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="5451556">func</span>&nbsp;<span class="op" id="5451561">(</span><span class="ident" id="5451562">e</span>&nbsp;<span class="op" id="5451564">*</span><span class="ident" id="5451565">encoder</span><span class="op" id="5451572">)</span>&nbsp;<span class="ident" id="5451574">incHi</span><span class="op" id="5451579">(</span><span class="op" id="5451580">)</span>&nbsp;<span class="builtintype" id="5451582">error</span>&nbsp;<span class="op" id="5451588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451591">e</span><span class="op" id="5451592">.</span><span class="ident" id="5451593">hi</span><span class="op" id="5451595">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451599">if</span>&nbsp;<span class="ident" id="5451602">e</span><span class="op" id="5451603">.</span><span class="ident" id="5451604">hi</span>&nbsp;<span class="op" id="5451607">==</span>&nbsp;<span class="ident" id="5451610">e</span><span class="op" id="5451611">.</span><span class="ident" id="5451612">overflow</span>&nbsp;<span class="op" id="5451621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451625">e</span><span class="op" id="5451626">.</span><span class="ident" id="5451627">width</span><span class="op" id="5451632">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451637">e</span><span class="op" id="5451638">.</span><span class="ident" id="5451639">overflow</span>&nbsp;<span class="op" id="5451648">&lt;&lt;=</span>&nbsp;<span class="num" id="5451652">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5451655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451658">if</span>&nbsp;<span class="ident" id="5451661">e</span><span class="op" id="5451662">.</span><span class="ident" id="5451663">hi</span>&nbsp;<span class="op" id="5451666">==</span>&nbsp;<span class="ident" id="5451669">maxCode</span>&nbsp;<span class="op" id="5451677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451681">clear</span>&nbsp;<span class="op" id="5451687">:=</span>&nbsp;<span class="builtintype" id="5451690">uint32</span><span class="op" id="5451696">(</span><span class="num" id="5451697">1</span><span class="op" id="5451698">)</span>&nbsp;<span class="op" id="5451700">&lt;&lt;</span>&nbsp;<span class="ident" id="5451703">e</span><span class="op" id="5451704">.</span><span class="ident" id="5451705">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451716">if</span>&nbsp;<span class="ident" id="5451719">err</span>&nbsp;<span class="op" id="5451723">:=</span>&nbsp;<span class="ident" id="5451726">e</span><span class="op" id="5451727">.</span><span class="ident" id="5451728">write</span><span class="op" id="5451733">(</span><span class="ident" id="5451734">e</span><span class="op" id="5451735">,</span>&nbsp;<span class="ident" id="5451737">clear</span><span class="op" id="5451742">)</span><span class="op" id="5451743">;</span>&nbsp;<span class="ident" id="5451745">err</span>&nbsp;<span class="op" id="5451749">!=</span>&nbsp;<span class="ident" id="5451752">nil</span>&nbsp;<span class="op" id="5451756">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451761">return</span>&nbsp;<span class="ident" id="5451768">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5451774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451778">e</span><span class="op" id="5451779">.</span><span class="ident" id="5451780">width</span>&nbsp;<span class="op" id="5451786">=</span>&nbsp;<span class="builtintype" id="5451788">uint</span><span class="op" id="5451792">(</span><span class="ident" id="5451793">e</span><span class="op" id="5451794">.</span><span class="ident" id="5451795">litWidth</span><span class="op" id="5451803">)</span>&nbsp;<span class="op" id="5451805">+</span>&nbsp;<span class="num" id="5451807">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451811">e</span><span class="op" id="5451812">.</span><span class="ident" id="5451813">hi</span>&nbsp;<span class="op" id="5451816">=</span>&nbsp;<span class="ident" id="5451818">clear</span>&nbsp;<span class="op" id="5451824">+</span>&nbsp;<span class="num" id="5451826">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451830">e</span><span class="op" id="5451831">.</span><span class="ident" id="5451832">overflow</span>&nbsp;<span class="op" id="5451841">=</span>&nbsp;<span class="ident" id="5451843">clear</span>&nbsp;<span class="op" id="5451849">&lt;&lt;</span>&nbsp;<span class="num" id="5451852">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451856">for</span>&nbsp;<span class="ident" id="5451860">i</span>&nbsp;<span class="op" id="5451862">:=</span>&nbsp;<span class="keyword" id="5451865">range</span>&nbsp;<span class="ident" id="5451871">e</span><span class="op" id="5451872">.</span><span class="ident" id="5451873">table</span>&nbsp;<span class="op" id="5451879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451884">e</span><span class="op" id="5451885">.</span><span class="ident" id="5451886">table</span><span class="op" id="5451891">[</span><span class="ident" id="5451892">i</span><span class="op" id="5451893">]</span>&nbsp;<span class="op" id="5451895">=</span>&nbsp;<span class="ident" id="5451897">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5451912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451916">return</span>&nbsp;<span class="ident" id="5451923">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5451938">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451941">return</span>&nbsp;<span class="ident" id="5451948">nil</span><br>
<span class="lineno"></span><span class="op" id="5451952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5451955">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5452030">func</span>&nbsp;<span class="op" id="5452035">(</span><span class="ident" id="5452036">e</span>&nbsp;<span class="op" id="5452038">*</span><span class="ident" id="5452039">encoder</span><span class="op" id="5452046">)</span>&nbsp;<span class="ident" id="5452048">Write</span><span class="op" id="5452053">(</span><span class="ident" id="5452054">p</span>&nbsp;<span class="op" id="5452056">[</span><span class="op" id="5452057">]</span><span class="builtintype" id="5452058">byte</span><span class="op" id="5452062">)</span>&nbsp;<span class="op" id="5452064">(</span><span class="ident" id="5452065">n</span>&nbsp;<span class="builtintype" id="5452067">int</span><span class="op" id="5452070">,</span>&nbsp;<span class="ident" id="5452072">err</span>&nbsp;<span class="builtintype" id="5452076">error</span><span class="op" id="5452081">)</span>&nbsp;<span class="op" id="5452083">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452086">if</span>&nbsp;<span class="ident" id="5452089">e</span><span class="op" id="5452090">.</span><span class="ident" id="5452091">err</span>&nbsp;<span class="op" id="5452095">!=</span>&nbsp;<span class="ident" id="5452098">nil</span>&nbsp;<span class="op" id="5452102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452106">return</span>&nbsp;<span class="num" id="5452113">0</span><span class="op" id="5452114">,</span>&nbsp;<span class="ident" id="5452116">e</span><span class="op" id="5452117">.</span><span class="ident" id="5452118">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452126">if</span>&nbsp;<span class="builtinfunc" id="5452129">len</span><span class="op" id="5452132">(</span><span class="ident" id="5452133">p</span><span class="op" id="5452134">)</span>&nbsp;<span class="op" id="5452136">==</span>&nbsp;<span class="num" id="5452139">0</span>&nbsp;<span class="op" id="5452141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452145">return</span>&nbsp;<span class="num" id="5452152">0</span><span class="op" id="5452153">,</span>&nbsp;<span class="ident" id="5452155">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452163">n</span>&nbsp;<span class="op" id="5452165">=</span>&nbsp;<span class="builtinfunc" id="5452167">len</span><span class="op" id="5452170">(</span><span class="ident" id="5452171">p</span><span class="op" id="5452172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452175">litMask</span>&nbsp;<span class="op" id="5452183">:=</span>&nbsp;<span class="builtintype" id="5452186">uint32</span><span class="op" id="5452192">(</span><span class="num" id="5452193">1</span><span class="op" id="5452194">&lt;&lt;</span><span class="ident" id="5452196">e</span><span class="op" id="5452197">.</span><span class="ident" id="5452198">litWidth</span>&nbsp;<span class="op" id="5452207">-</span>&nbsp;<span class="num" id="5452209">1</span><span class="op" id="5452210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452213">code</span>&nbsp;<span class="op" id="5452218">:=</span>&nbsp;<span class="ident" id="5452221">e</span><span class="op" id="5452222">.</span><span class="ident" id="5452223">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452234">if</span>&nbsp;<span class="ident" id="5452237">code</span>&nbsp;<span class="op" id="5452242">==</span>&nbsp;<span class="ident" id="5452245">invalidCode</span>&nbsp;<span class="op" id="5452257">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452261">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452312">code</span><span class="op" id="5452316">,</span>&nbsp;<span class="ident" id="5452318">p</span>&nbsp;<span class="op" id="5452320">=</span>&nbsp;<span class="builtintype" id="5452322">uint32</span><span class="op" id="5452328">(</span><span class="ident" id="5452329">p</span><span class="op" id="5452330">[</span><span class="num" id="5452331">0</span><span class="op" id="5452332">]</span><span class="op" id="5452333">)</span><span class="op" id="5452334">&amp;</span><span class="ident" id="5452335">litMask</span><span class="op" id="5452342">,</span>&nbsp;<span class="ident" id="5452344">p</span><span class="op" id="5452345">[</span><span class="num" id="5452346">1</span><span class="op" id="5452347">:</span><span class="op" id="5452348">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452351">}</span><br>
<span class="lineno"></span><span class="ident" id="5452353">loop</span><span class="op" id="5452357">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452360">for</span>&nbsp;<span class="ident" id="5452364">_</span><span class="op" id="5452365">,</span>&nbsp;<span class="ident" id="5452367">x</span>&nbsp;<span class="op" id="5452369">:=</span>&nbsp;<span class="keyword" id="5452372">range</span>&nbsp;<span class="ident" id="5452378">p</span>&nbsp;<span class="op" id="5452380">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452384">literal</span>&nbsp;<span class="op" id="5452392">:=</span>&nbsp;<span class="builtintype" id="5452395">uint32</span><span class="op" id="5452401">(</span><span class="ident" id="5452402">x</span><span class="op" id="5452403">)</span>&nbsp;<span class="op" id="5452405">&amp;</span>&nbsp;<span class="ident" id="5452407">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452417">key</span>&nbsp;<span class="op" id="5452421">:=</span>&nbsp;<span class="ident" id="5452424">code</span><span class="op" id="5452428">&lt;&lt;</span><span class="num" id="5452430">8</span>&nbsp;<span class="op" id="5452432">|</span>&nbsp;<span class="ident" id="5452434">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452444">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452517">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452550">hash</span>&nbsp;<span class="op" id="5452555">:=</span>&nbsp;<span class="op" id="5452558">(</span><span class="ident" id="5452559">key</span><span class="op" id="5452562">&gt;&gt;</span><span class="num" id="5452564">12</span>&nbsp;<span class="op" id="5452567">^</span>&nbsp;<span class="ident" id="5452569">key</span><span class="op" id="5452572">)</span>&nbsp;<span class="op" id="5452574">&amp;</span>&nbsp;<span class="ident" id="5452576">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452588">for</span>&nbsp;<span class="ident" id="5452592">h</span><span class="op" id="5452593">,</span>&nbsp;<span class="ident" id="5452595">t</span>&nbsp;<span class="op" id="5452597">:=</span>&nbsp;<span class="ident" id="5452600">hash</span><span class="op" id="5452604">,</span>&nbsp;<span class="ident" id="5452606">e</span><span class="op" id="5452607">.</span><span class="ident" id="5452608">table</span><span class="op" id="5452613">[</span><span class="ident" id="5452614">hash</span><span class="op" id="5452618">]</span><span class="op" id="5452619">;</span>&nbsp;<span class="ident" id="5452621">t</span>&nbsp;<span class="op" id="5452623">!=</span>&nbsp;<span class="ident" id="5452626">invalidEntry</span><span class="op" id="5452638">;</span>&nbsp;<span class="op" id="5452640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452645">if</span>&nbsp;<span class="ident" id="5452648">key</span>&nbsp;<span class="op" id="5452652">==</span>&nbsp;<span class="ident" id="5452655">t</span><span class="op" id="5452656">&gt;&gt;</span><span class="num" id="5452658">12</span>&nbsp;<span class="op" id="5452661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452667">code</span>&nbsp;<span class="op" id="5452672">=</span>&nbsp;<span class="ident" id="5452674">t</span>&nbsp;<span class="op" id="5452676">&amp;</span>&nbsp;<span class="ident" id="5452678">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452690">continue</span>&nbsp;<span class="ident" id="5452699">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452707">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452712">h</span>&nbsp;<span class="op" id="5452714">=</span>&nbsp;<span class="op" id="5452716">(</span><span class="ident" id="5452717">h</span>&nbsp;<span class="op" id="5452719">+</span>&nbsp;<span class="num" id="5452721">1</span><span class="op" id="5452722">)</span>&nbsp;<span class="op" id="5452724">&amp;</span>&nbsp;<span class="ident" id="5452726">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452739">t</span>&nbsp;<span class="op" id="5452741">=</span>&nbsp;<span class="ident" id="5452743">e</span><span class="op" id="5452744">.</span><span class="ident" id="5452745">table</span><span class="op" id="5452750">[</span><span class="ident" id="5452751">h</span><span class="op" id="5452752">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452760">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452833">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452861">if</span>&nbsp;<span class="ident" id="5452864">e</span><span class="op" id="5452865">.</span><span class="ident" id="5452866">err</span>&nbsp;<span class="op" id="5452870">=</span>&nbsp;<span class="ident" id="5452872">e</span><span class="op" id="5452873">.</span><span class="ident" id="5452874">write</span><span class="op" id="5452879">(</span><span class="ident" id="5452880">e</span><span class="op" id="5452881">,</span>&nbsp;<span class="ident" id="5452883">code</span><span class="op" id="5452887">)</span><span class="op" id="5452888">;</span>&nbsp;<span class="ident" id="5452890">e</span><span class="op" id="5452891">.</span><span class="ident" id="5452892">err</span>&nbsp;<span class="op" id="5452896">!=</span>&nbsp;<span class="ident" id="5452899">nil</span>&nbsp;<span class="op" id="5452903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452908">return</span>&nbsp;<span class="num" id="5452915">0</span><span class="op" id="5452916">,</span>&nbsp;<span class="ident" id="5452918">e</span><span class="op" id="5452919">.</span><span class="ident" id="5452920">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452930">code</span>&nbsp;<span class="op" id="5452935">=</span>&nbsp;<span class="ident" id="5452937">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452947">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453021">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453094">if</span>&nbsp;<span class="ident" id="5453097">err1</span>&nbsp;<span class="op" id="5453102">:=</span>&nbsp;<span class="ident" id="5453105">e</span><span class="op" id="5453106">.</span><span class="ident" id="5453107">incHi</span><span class="op" id="5453112">(</span><span class="op" id="5453113">)</span><span class="op" id="5453114">;</span>&nbsp;<span class="ident" id="5453116">err1</span>&nbsp;<span class="op" id="5453121">!=</span>&nbsp;<span class="ident" id="5453124">nil</span>&nbsp;<span class="op" id="5453128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453133">if</span>&nbsp;<span class="ident" id="5453136">err1</span>&nbsp;<span class="op" id="5453141">==</span>&nbsp;<span class="ident" id="5453144">errOutOfCodes</span>&nbsp;<span class="op" id="5453158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453164">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453176">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453181">e</span><span class="op" id="5453182">.</span><span class="ident" id="5453183">err</span>&nbsp;<span class="op" id="5453187">=</span>&nbsp;<span class="ident" id="5453189">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453197">return</span>&nbsp;<span class="num" id="5453204">0</span><span class="op" id="5453205">,</span>&nbsp;<span class="ident" id="5453207">e</span><span class="op" id="5453208">.</span><span class="ident" id="5453209">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453219">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453292">for</span>&nbsp;<span class="op" id="5453296">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453301">if</span>&nbsp;<span class="ident" id="5453304">e</span><span class="op" id="5453305">.</span><span class="ident" id="5453306">table</span><span class="op" id="5453311">[</span><span class="ident" id="5453312">hash</span><span class="op" id="5453316">]</span>&nbsp;<span class="op" id="5453318">==</span>&nbsp;<span class="ident" id="5453321">invalidEntry</span>&nbsp;<span class="op" id="5453334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453340">e</span><span class="op" id="5453341">.</span><span class="ident" id="5453342">table</span><span class="op" id="5453347">[</span><span class="ident" id="5453348">hash</span><span class="op" id="5453352">]</span>&nbsp;<span class="op" id="5453354">=</span>&nbsp;<span class="op" id="5453356">(</span><span class="ident" id="5453357">key</span>&nbsp;<span class="op" id="5453361">&lt;&lt;</span>&nbsp;<span class="num" id="5453364">12</span><span class="op" id="5453366">)</span>&nbsp;<span class="op" id="5453368">|</span>&nbsp;<span class="ident" id="5453370">e</span><span class="op" id="5453371">.</span><span class="ident" id="5453372">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453379">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453393">hash</span>&nbsp;<span class="op" id="5453398">=</span>&nbsp;<span class="op" id="5453400">(</span><span class="ident" id="5453401">hash</span>&nbsp;<span class="op" id="5453406">+</span>&nbsp;<span class="num" id="5453408">1</span><span class="op" id="5453409">)</span>&nbsp;<span class="op" id="5453411">&amp;</span>&nbsp;<span class="ident" id="5453413">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453431">e</span><span class="op" id="5453432">.</span><span class="ident" id="5453433">savedCode</span>&nbsp;<span class="op" id="5453443">=</span>&nbsp;<span class="ident" id="5453445">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453451">return</span>&nbsp;<span class="ident" id="5453458">n</span><span class="op" id="5453459">,</span>&nbsp;<span class="ident" id="5453461">nil</span><br>
<span class="lineno"></span><span class="op" id="5453465">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5453468">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5453547">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5453579">func</span>&nbsp;<span class="op" id="5453584">(</span><span class="ident" id="5453585">e</span>&nbsp;<span class="op" id="5453587">*</span><span class="ident" id="5453588">encoder</span><span class="op" id="5453595">)</span>&nbsp;<span class="ident" id="5453597">Close</span><span class="op" id="5453602">(</span><span class="op" id="5453603">)</span>&nbsp;<span class="builtintype" id="5453605">error</span>&nbsp;<span class="op" id="5453611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453614">if</span>&nbsp;<span class="ident" id="5453617">e</span><span class="op" id="5453618">.</span><span class="ident" id="5453619">err</span>&nbsp;<span class="op" id="5453623">!=</span>&nbsp;<span class="ident" id="5453626">nil</span>&nbsp;<span class="op" id="5453630">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453634">if</span>&nbsp;<span class="ident" id="5453637">e</span><span class="op" id="5453638">.</span><span class="ident" id="5453639">err</span>&nbsp;<span class="op" id="5453643">==</span>&nbsp;<span class="ident" id="5453646">errClosed</span>&nbsp;<span class="op" id="5453656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453661">return</span>&nbsp;<span class="ident" id="5453668">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453678">return</span>&nbsp;<span class="ident" id="5453685">e</span><span class="op" id="5453686">.</span><span class="ident" id="5453687">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453692">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453695">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453748">e</span><span class="op" id="5453749">.</span><span class="ident" id="5453750">err</span>&nbsp;<span class="op" id="5453754">=</span>&nbsp;<span class="ident" id="5453756">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453767">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453801">if</span>&nbsp;<span class="ident" id="5453804">e</span><span class="op" id="5453805">.</span><span class="ident" id="5453806">savedCode</span>&nbsp;<span class="op" id="5453816">!=</span>&nbsp;<span class="ident" id="5453819">invalidCode</span>&nbsp;<span class="op" id="5453831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453835">if</span>&nbsp;<span class="ident" id="5453838">err</span>&nbsp;<span class="op" id="5453842">:=</span>&nbsp;<span class="ident" id="5453845">e</span><span class="op" id="5453846">.</span><span class="ident" id="5453847">write</span><span class="op" id="5453852">(</span><span class="ident" id="5453853">e</span><span class="op" id="5453854">,</span>&nbsp;<span class="ident" id="5453856">e</span><span class="op" id="5453857">.</span><span class="ident" id="5453858">savedCode</span><span class="op" id="5453867">)</span><span class="op" id="5453868">;</span>&nbsp;<span class="ident" id="5453870">err</span>&nbsp;<span class="op" id="5453874">!=</span>&nbsp;<span class="ident" id="5453877">nil</span>&nbsp;<span class="op" id="5453881">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453886">return</span>&nbsp;<span class="ident" id="5453893">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453903">if</span>&nbsp;<span class="ident" id="5453906">err</span>&nbsp;<span class="op" id="5453910">:=</span>&nbsp;<span class="ident" id="5453913">e</span><span class="op" id="5453914">.</span><span class="ident" id="5453915">incHi</span><span class="op" id="5453920">(</span><span class="op" id="5453921">)</span><span class="op" id="5453922">;</span>&nbsp;<span class="ident" id="5453924">err</span>&nbsp;<span class="op" id="5453928">!=</span>&nbsp;<span class="ident" id="5453931">nil</span>&nbsp;<span class="op" id="5453935">&amp;&amp;</span>&nbsp;<span class="ident" id="5453938">err</span>&nbsp;<span class="op" id="5453942">!=</span>&nbsp;<span class="ident" id="5453945">errOutOfCodes</span>&nbsp;<span class="op" id="5453959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453964">return</span>&nbsp;<span class="ident" id="5453971">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453977">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453983">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454007">eof</span>&nbsp;<span class="op" id="5454011">:=</span>&nbsp;<span class="builtintype" id="5454014">uint32</span><span class="op" id="5454020">(</span><span class="num" id="5454021">1</span><span class="op" id="5454022">)</span><span class="op" id="5454023">&lt;&lt;</span><span class="ident" id="5454025">e</span><span class="op" id="5454026">.</span><span class="ident" id="5454027">litWidth</span>&nbsp;<span class="op" id="5454036">+</span>&nbsp;<span class="num" id="5454038">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454041">if</span>&nbsp;<span class="ident" id="5454044">err</span>&nbsp;<span class="op" id="5454048">:=</span>&nbsp;<span class="ident" id="5454051">e</span><span class="op" id="5454052">.</span><span class="ident" id="5454053">write</span><span class="op" id="5454058">(</span><span class="ident" id="5454059">e</span><span class="op" id="5454060">,</span>&nbsp;<span class="ident" id="5454062">eof</span><span class="op" id="5454065">)</span><span class="op" id="5454066">;</span>&nbsp;<span class="ident" id="5454068">err</span>&nbsp;<span class="op" id="5454072">!=</span>&nbsp;<span class="ident" id="5454075">nil</span>&nbsp;<span class="op" id="5454079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454083">return</span>&nbsp;<span class="ident" id="5454090">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5454098">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454124">if</span>&nbsp;<span class="ident" id="5454127">e</span><span class="op" id="5454128">.</span><span class="ident" id="5454129">nBits</span>&nbsp;<span class="op" id="5454135">&gt;</span>&nbsp;<span class="num" id="5454137">0</span>&nbsp;<span class="op" id="5454139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454143">if</span>&nbsp;<span class="ident" id="5454146">e</span><span class="op" id="5454147">.</span><span class="ident" id="5454148">order</span>&nbsp;<span class="op" id="5454154">==</span>&nbsp;<span class="ident" id="5454157">MSB</span>&nbsp;<span class="op" id="5454161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454166">e</span><span class="op" id="5454167">.</span><span class="ident" id="5454168">bits</span>&nbsp;<span class="op" id="5454173">&gt;&gt;=</span>&nbsp;<span class="num" id="5454177">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454186">if</span>&nbsp;<span class="ident" id="5454189">err</span>&nbsp;<span class="op" id="5454193">:=</span>&nbsp;<span class="ident" id="5454196">e</span><span class="op" id="5454197">.</span><span class="ident" id="5454198">w</span><span class="op" id="5454199">.</span><span class="ident" id="5454200">WriteByte</span><span class="op" id="5454209">(</span><span class="builtintype" id="5454210">uint8</span><span class="op" id="5454215">(</span><span class="ident" id="5454216">e</span><span class="op" id="5454217">.</span><span class="ident" id="5454218">bits</span><span class="op" id="5454222">)</span><span class="op" id="5454223">)</span><span class="op" id="5454224">;</span>&nbsp;<span class="ident" id="5454226">err</span>&nbsp;<span class="op" id="5454230">!=</span>&nbsp;<span class="ident" id="5454233">nil</span>&nbsp;<span class="op" id="5454237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454242">return</span>&nbsp;<span class="ident" id="5454249">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454258">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454261">return</span>&nbsp;<span class="ident" id="5454268">e</span><span class="op" id="5454269">.</span><span class="ident" id="5454270">w</span><span class="op" id="5454271">.</span><span class="ident" id="5454272">Flush</span><span class="op" id="5454277">(</span><span class="op" id="5454278">)</span><br>
<span class="lineno"></span><span class="op" id="5454280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5454283">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5454326">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="5454400">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5454475">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="5454496">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5454569">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5454604">func</span>&nbsp;<span class="ident" id="5454609">NewWriter</span><span class="op" id="5454618">(</span><span class="ident" id="5454619">w</span>&nbsp;<span class="ident" id="5454621">io</span><span class="op" id="5454623">.</span><span class="ident" id="5454624">Writer</span><span class="op" id="5454630">,</span>&nbsp;<span class="ident" id="5454632">order</span>&nbsp;<span class="ident" id="5454638">Order</span><span class="op" id="5454643">,</span>&nbsp;<span class="ident" id="5454645">litWidth</span>&nbsp;<span class="builtintype" id="5454654">int</span><span class="op" id="5454657">)</span>&nbsp;<span class="ident" id="5454659">io</span><span class="op" id="5454661">.</span><span class="ident" id="5454662">WriteCloser</span>&nbsp;<span class="op" id="5454674">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454677">var</span>&nbsp;<span class="ident" id="5454681">write</span>&nbsp;<span class="keyword" id="5454687">func</span><span class="op" id="5454691">(</span><span class="op" id="5454692">*</span><span class="ident" id="5454693">encoder</span><span class="op" id="5454700">,</span>&nbsp;<span class="builtintype" id="5454702">uint32</span><span class="op" id="5454708">)</span>&nbsp;<span class="builtintype" id="5454710">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454717">switch</span>&nbsp;<span class="ident" id="5454724">order</span>&nbsp;<span class="op" id="5454730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454733">case</span>&nbsp;<span class="ident" id="5454738">LSB</span><span class="op" id="5454741">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454745">write</span>&nbsp;<span class="op" id="5454751">=</span>&nbsp;<span class="op" id="5454753">(</span><span class="op" id="5454754">*</span><span class="ident" id="5454755">encoder</span><span class="op" id="5454762">)</span><span class="op" id="5454763">.</span><span class="ident" id="5454764">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454774">case</span>&nbsp;<span class="ident" id="5454779">MSB</span><span class="op" id="5454782">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454786">write</span>&nbsp;<span class="op" id="5454792">=</span>&nbsp;<span class="op" id="5454794">(</span><span class="op" id="5454795">*</span><span class="ident" id="5454796">encoder</span><span class="op" id="5454803">)</span><span class="op" id="5454804">.</span><span class="ident" id="5454805">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454815">default</span><span class="op" id="5454822">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454826">return</span>&nbsp;<span class="op" id="5454833">&amp;</span><span class="ident" id="5454834">errWriteCloser</span><span class="op" id="5454848">{</span><span class="ident" id="5454849">errors</span><span class="op" id="5454855">.</span><span class="ident" id="5454856">New</span><span class="op" id="5454859">(</span><span class="string" id="5454860">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5454880">)</span><span class="op" id="5454881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454887">if</span>&nbsp;<span class="ident" id="5454890">litWidth</span>&nbsp;<span class="op" id="5454899">&lt;</span>&nbsp;<span class="num" id="5454901">2</span>&nbsp;<span class="op" id="5454903">||</span>&nbsp;<span class="num" id="5454906">8</span>&nbsp;<span class="op" id="5454908">&lt;</span>&nbsp;<span class="ident" id="5454910">litWidth</span>&nbsp;<span class="op" id="5454919">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454923">return</span>&nbsp;<span class="op" id="5454930">&amp;</span><span class="ident" id="5454931">errWriteCloser</span><span class="op" id="5454945">{</span><span class="ident" id="5454946">fmt</span><span class="op" id="5454949">.</span><span class="ident" id="5454950">Errorf</span><span class="op" id="5454956">(</span><span class="string" id="5454957">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5454988">,</span>&nbsp;<span class="ident" id="5454990">litWidth</span><span class="op" id="5454998">)</span><span class="op" id="5454999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455005">bw</span><span class="op" id="5455007">,</span>&nbsp;<span class="ident" id="5455009">ok</span>&nbsp;<span class="op" id="5455012">:=</span>&nbsp;<span class="ident" id="5455015">w</span><span class="op" id="5455016">.</span><span class="op" id="5455017">(</span><span class="ident" id="5455018">writer</span><span class="op" id="5455024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455027">if</span>&nbsp;<span class="op" id="5455030">!</span><span class="ident" id="5455031">ok</span>&nbsp;<span class="op" id="5455034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455038">bw</span>&nbsp;<span class="op" id="5455041">=</span>&nbsp;<span class="ident" id="5455043">bufio</span><span class="op" id="5455048">.</span><span class="ident" id="5455049">NewWriter</span><span class="op" id="5455058">(</span><span class="ident" id="5455059">w</span><span class="op" id="5455060">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455066">lw</span>&nbsp;<span class="op" id="5455069">:=</span>&nbsp;<span class="builtintype" id="5455072">uint</span><span class="op" id="5455076">(</span><span class="ident" id="5455077">litWidth</span><span class="op" id="5455085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455088">return</span>&nbsp;<span class="op" id="5455095">&amp;</span><span class="ident" id="5455096">encoder</span><span class="op" id="5455103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455107">w</span><span class="op" id="5455108">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455118">bw</span><span class="op" id="5455120">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455124">order</span><span class="op" id="5455129">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455135">order</span><span class="op" id="5455140">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455144">write</span><span class="op" id="5455149">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455155">write</span><span class="op" id="5455160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455164">width</span><span class="op" id="5455169">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5455175">1</span>&nbsp;<span class="op" id="5455177">+</span>&nbsp;<span class="ident" id="5455179">lw</span><span class="op" id="5455181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455185">litWidth</span><span class="op" id="5455193">:</span>&nbsp;&nbsp;<span class="ident" id="5455196">lw</span><span class="op" id="5455198">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455202">hi</span><span class="op" id="5455204">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5455213">1</span><span class="op" id="5455214">&lt;&lt;</span><span class="ident" id="5455216">lw</span>&nbsp;<span class="op" id="5455219">+</span>&nbsp;<span class="num" id="5455221">1</span><span class="op" id="5455222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455226">overflow</span><span class="op" id="5455234">:</span>&nbsp;&nbsp;<span class="num" id="5455237">1</span>&nbsp;<span class="op" id="5455239">&lt;&lt;</span>&nbsp;<span class="op" id="5455242">(</span><span class="ident" id="5455243">lw</span>&nbsp;<span class="op" id="5455246">+</span>&nbsp;<span class="num" id="5455248">1</span><span class="op" id="5455249">)</span><span class="op" id="5455250">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455254">savedCode</span><span class="op" id="5455263">:</span>&nbsp;<span class="ident" id="5455265">invalidCode</span><span class="op" id="5455276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455279">}</span><br>
<span class="lineno"></span><span class="op" id="5455281">}</span>
</div>
</body>
</html>
