<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4901145">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4901200">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4901254">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4901305">package</span>&nbsp;<span class="ident" id="4901313">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4901318">import</span>&nbsp;<span class="op" id="4901325">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4901328">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4901337">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4901354">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4901368">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4901377">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4901392">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4901398">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4901408">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4901411">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="4901454">type</span>&nbsp;<span class="ident" id="4901459">Encoder</span>&nbsp;<span class="keyword" id="4901467">struct</span>&nbsp;<span class="op" id="4901474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901477">CompressionLevel</span>&nbsp;<span class="ident" id="4901494">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="4901511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4901514">type</span>&nbsp;<span class="ident" id="4901519">encoder</span>&nbsp;<span class="keyword" id="4901527">struct</span>&nbsp;<span class="op" id="4901534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901537">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4901544">*</span><span class="ident" id="4901545">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901554">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4901561">io</span><span class="op" id="4901563">.</span><span class="ident" id="4901564">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901572">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4901579">image</span><span class="op" id="4901584">.</span><span class="ident" id="4901585">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901592">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4901599">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901604">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4901611">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901618">header</span>&nbsp;<span class="op" id="4901625">[</span><span class="num" id="4901626">8</span><span class="op" id="4901627">]</span><span class="builtintype" id="4901628">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901634">footer</span>&nbsp;<span class="op" id="4901641">[</span><span class="num" id="4901642">4</span><span class="op" id="4901643">]</span><span class="builtintype" id="4901644">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901650">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4901657">[</span><span class="num" id="4901658">4</span>&nbsp;<span class="op" id="4901660">*</span>&nbsp;<span class="num" id="4901662">256</span><span class="op" id="4901665">]</span><span class="builtintype" id="4901666">byte</span><br>
<span class="lineno"></span><span class="op" id="4901671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4901674">type</span>&nbsp;<span class="ident" id="4901679">CompressionLevel</span>&nbsp;<span class="builtintype" id="4901696">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4901701">const</span>&nbsp;<span class="op" id="4901707">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901710">DefaultCompression</span>&nbsp;<span class="ident" id="4901729">CompressionLevel</span>&nbsp;<span class="op" id="4901746">=</span>&nbsp;<span class="num" id="4901748">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901751">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4901770">CompressionLevel</span>&nbsp;<span class="op" id="4901787">=</span>&nbsp;<span class="op" id="4901789">-</span><span class="num" id="4901790">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901793">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4901812">CompressionLevel</span>&nbsp;<span class="op" id="4901829">=</span>&nbsp;<span class="op" id="4901831">-</span><span class="num" id="4901832">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901835">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4901854">CompressionLevel</span>&nbsp;<span class="op" id="4901871">=</span>&nbsp;<span class="op" id="4901873">-</span><span class="num" id="4901874">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4901878">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4901951">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="4902011">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4902014">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="4902029">func</span>&nbsp;<span class="ident" id="4902034">writeUint32</span><span class="op" id="4902045">(</span><span class="ident" id="4902046">b</span>&nbsp;<span class="op" id="4902048">[</span><span class="op" id="4902049">]</span><span class="builtintype" id="4902050">uint8</span><span class="op" id="4902055">,</span>&nbsp;<span class="ident" id="4902057">u</span>&nbsp;<span class="builtintype" id="4902059">uint32</span><span class="op" id="4902065">)</span>&nbsp;<span class="op" id="4902067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902070">b</span><span class="op" id="4902071">[</span><span class="num" id="4902072">0</span><span class="op" id="4902073">]</span>&nbsp;<span class="op" id="4902075">=</span>&nbsp;<span class="builtintype" id="4902077">uint8</span><span class="op" id="4902082">(</span><span class="ident" id="4902083">u</span>&nbsp;<span class="op" id="4902085">&gt;&gt;</span>&nbsp;<span class="num" id="4902088">24</span><span class="op" id="4902090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902093">b</span><span class="op" id="4902094">[</span><span class="num" id="4902095">1</span><span class="op" id="4902096">]</span>&nbsp;<span class="op" id="4902098">=</span>&nbsp;<span class="builtintype" id="4902100">uint8</span><span class="op" id="4902105">(</span><span class="ident" id="4902106">u</span>&nbsp;<span class="op" id="4902108">&gt;&gt;</span>&nbsp;<span class="num" id="4902111">16</span><span class="op" id="4902113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902116">b</span><span class="op" id="4902117">[</span><span class="num" id="4902118">2</span><span class="op" id="4902119">]</span>&nbsp;<span class="op" id="4902121">=</span>&nbsp;<span class="builtintype" id="4902123">uint8</span><span class="op" id="4902128">(</span><span class="ident" id="4902129">u</span>&nbsp;<span class="op" id="4902131">&gt;&gt;</span>&nbsp;<span class="num" id="4902134">8</span><span class="op" id="4902135">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902138">b</span><span class="op" id="4902139">[</span><span class="num" id="4902140">3</span><span class="op" id="4902141">]</span>&nbsp;<span class="op" id="4902143">=</span>&nbsp;<span class="builtintype" id="4902145">uint8</span><span class="op" id="4902150">(</span><span class="ident" id="4902151">u</span>&nbsp;<span class="op" id="4902153">&gt;&gt;</span>&nbsp;<span class="num" id="4902156">0</span><span class="op" id="4902157">)</span><br>
<span class="lineno"></span><span class="op" id="4902159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4902162">type</span>&nbsp;<span class="ident" id="4902167">opaquer</span>&nbsp;<span class="keyword" id="4902175">interface</span>&nbsp;<span class="op" id="4902185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902188">Opaque</span><span class="op" id="4902194">(</span><span class="op" id="4902195">)</span>&nbsp;<span class="builtintype" id="4902197">bool</span><br>
<span class="lineno">55</span><span class="op" id="4902202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4902205">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="4902258">func</span>&nbsp;<span class="ident" id="4902263">opaque</span><span class="op" id="4902269">(</span><span class="ident" id="4902270">m</span>&nbsp;<span class="ident" id="4902272">image</span><span class="op" id="4902277">.</span><span class="ident" id="4902278">Image</span><span class="op" id="4902283">)</span>&nbsp;<span class="builtintype" id="4902285">bool</span>&nbsp;<span class="op" id="4902290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902293">if</span>&nbsp;<span class="ident" id="4902296">o</span><span class="op" id="4902297">,</span>&nbsp;<span class="ident" id="4902299">ok</span>&nbsp;<span class="op" id="4902302">:=</span>&nbsp;<span class="ident" id="4902305">m</span><span class="op" id="4902306">.</span><span class="op" id="4902307">(</span><span class="ident" id="4902308">opaquer</span><span class="op" id="4902315">)</span><span class="op" id="4902316">;</span>&nbsp;<span class="ident" id="4902318">ok</span>&nbsp;<span class="op" id="4902321">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902325">return</span>&nbsp;<span class="ident" id="4902332">o</span><span class="op" id="4902333">.</span><span class="ident" id="4902334">Opaque</span><span class="op" id="4902340">(</span><span class="op" id="4902341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902347">b</span>&nbsp;<span class="op" id="4902349">:=</span>&nbsp;<span class="ident" id="4902352">m</span><span class="op" id="4902353">.</span><span class="ident" id="4902354">Bounds</span><span class="op" id="4902360">(</span><span class="op" id="4902361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902364">for</span>&nbsp;<span class="ident" id="4902368">y</span>&nbsp;<span class="op" id="4902370">:=</span>&nbsp;<span class="ident" id="4902373">b</span><span class="op" id="4902374">.</span><span class="ident" id="4902375">Min</span><span class="op" id="4902378">.</span><span class="ident" id="4902379">Y</span><span class="op" id="4902380">;</span>&nbsp;<span class="ident" id="4902382">y</span>&nbsp;<span class="op" id="4902384">&lt;</span>&nbsp;<span class="ident" id="4902386">b</span><span class="op" id="4902387">.</span><span class="ident" id="4902388">Max</span><span class="op" id="4902391">.</span><span class="ident" id="4902392">Y</span><span class="op" id="4902393">;</span>&nbsp;<span class="ident" id="4902395">y</span><span class="op" id="4902396">++</span>&nbsp;<span class="op" id="4902399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902403">for</span>&nbsp;<span class="ident" id="4902407">x</span>&nbsp;<span class="op" id="4902409">:=</span>&nbsp;<span class="ident" id="4902412">b</span><span class="op" id="4902413">.</span><span class="ident" id="4902414">Min</span><span class="op" id="4902417">.</span><span class="ident" id="4902418">X</span><span class="op" id="4902419">;</span>&nbsp;<span class="ident" id="4902421">x</span>&nbsp;<span class="op" id="4902423">&lt;</span>&nbsp;<span class="ident" id="4902425">b</span><span class="op" id="4902426">.</span><span class="ident" id="4902427">Max</span><span class="op" id="4902430">.</span><span class="ident" id="4902431">X</span><span class="op" id="4902432">;</span>&nbsp;<span class="ident" id="4902434">x</span><span class="op" id="4902435">++</span>&nbsp;<span class="op" id="4902438">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902443">_</span><span class="op" id="4902444">,</span>&nbsp;<span class="ident" id="4902446">_</span><span class="op" id="4902447">,</span>&nbsp;<span class="ident" id="4902449">_</span><span class="op" id="4902450">,</span>&nbsp;<span class="ident" id="4902452">a</span>&nbsp;<span class="op" id="4902454">:=</span>&nbsp;<span class="ident" id="4902457">m</span><span class="op" id="4902458">.</span><span class="ident" id="4902459">At</span><span class="op" id="4902461">(</span><span class="ident" id="4902462">x</span><span class="op" id="4902463">,</span>&nbsp;<span class="ident" id="4902465">y</span><span class="op" id="4902466">)</span><span class="op" id="4902467">.</span><span class="ident" id="4902468">RGBA</span><span class="op" id="4902472">(</span><span class="op" id="4902473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902478">if</span>&nbsp;<span class="ident" id="4902481">a</span>&nbsp;<span class="op" id="4902483">!=</span>&nbsp;<span class="num" id="4902486">0xffff</span>&nbsp;<span class="op" id="4902493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902499">return</span>&nbsp;<span class="builtintype" id="4902506">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902519">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902525">return</span>&nbsp;<span class="builtintype" id="4902532">true</span><br>
<span class="lineno"></span><span class="op" id="4902537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4902540">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="4902602">func</span>&nbsp;<span class="ident" id="4902607">abs8</span><span class="op" id="4902611">(</span><span class="ident" id="4902612">d</span>&nbsp;<span class="builtintype" id="4902614">uint8</span><span class="op" id="4902619">)</span>&nbsp;<span class="builtintype" id="4902621">int</span>&nbsp;<span class="op" id="4902625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902628">if</span>&nbsp;<span class="ident" id="4902631">d</span>&nbsp;<span class="op" id="4902633">&lt;</span>&nbsp;<span class="num" id="4902635">128</span>&nbsp;<span class="op" id="4902639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902643">return</span>&nbsp;<span class="builtintype" id="4902650">int</span><span class="op" id="4902653">(</span><span class="ident" id="4902654">d</span><span class="op" id="4902655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902661">return</span>&nbsp;<span class="num" id="4902668">256</span>&nbsp;<span class="op" id="4902672">-</span>&nbsp;<span class="builtintype" id="4902674">int</span><span class="op" id="4902677">(</span><span class="ident" id="4902678">d</span><span class="op" id="4902679">)</span><br>
<span class="lineno">80</span><span class="op" id="4902681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4902684">func</span>&nbsp;<span class="op" id="4902689">(</span><span class="ident" id="4902690">e</span>&nbsp;<span class="op" id="4902692">*</span><span class="ident" id="4902693">encoder</span><span class="op" id="4902700">)</span>&nbsp;<span class="ident" id="4902702">writeChunk</span><span class="op" id="4902712">(</span><span class="ident" id="4902713">b</span>&nbsp;<span class="op" id="4902715">[</span><span class="op" id="4902716">]</span><span class="builtintype" id="4902717">byte</span><span class="op" id="4902721">,</span>&nbsp;<span class="ident" id="4902723">name</span>&nbsp;<span class="builtintype" id="4902728">string</span><span class="op" id="4902734">)</span>&nbsp;<span class="op" id="4902736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902739">if</span>&nbsp;<span class="ident" id="4902742">e</span><span class="op" id="4902743">.</span><span class="ident" id="4902744">err</span>&nbsp;<span class="op" id="4902748">!=</span>&nbsp;<span class="ident" id="4902751">nil</span>&nbsp;<span class="op" id="4902755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902759">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902770">n</span>&nbsp;<span class="op" id="4902772">:=</span>&nbsp;<span class="builtintype" id="4902775">uint32</span><span class="op" id="4902781">(</span><span class="builtinfunc" id="4902782">len</span><span class="op" id="4902785">(</span><span class="ident" id="4902786">b</span><span class="op" id="4902787">)</span><span class="op" id="4902788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902791">if</span>&nbsp;<span class="builtintype" id="4902794">int</span><span class="op" id="4902797">(</span><span class="ident" id="4902798">n</span><span class="op" id="4902799">)</span>&nbsp;<span class="op" id="4902801">!=</span>&nbsp;<span class="builtinfunc" id="4902804">len</span><span class="op" id="4902807">(</span><span class="ident" id="4902808">b</span><span class="op" id="4902809">)</span>&nbsp;<span class="op" id="4902811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902815">e</span><span class="op" id="4902816">.</span><span class="ident" id="4902817">err</span>&nbsp;<span class="op" id="4902821">=</span>&nbsp;<span class="ident" id="4902823">UnsupportedError</span><span class="op" id="4902839">(</span><span class="ident" id="4902840">name</span>&nbsp;<span class="op" id="4902845">+</span>&nbsp;<span class="string" id="4902847">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="4902871">+</span>&nbsp;<span class="ident" id="4902873">strconv</span><span class="op" id="4902880">.</span><span class="ident" id="4902881">Itoa</span><span class="op" id="4902885">(</span><span class="builtinfunc" id="4902886">len</span><span class="op" id="4902889">(</span><span class="ident" id="4902890">b</span><span class="op" id="4902891">)</span><span class="op" id="4902892">)</span><span class="op" id="4902893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902897">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902908">writeUint32</span><span class="op" id="4902919">(</span><span class="ident" id="4902920">e</span><span class="op" id="4902921">.</span><span class="ident" id="4902922">header</span><span class="op" id="4902928">[</span><span class="op" id="4902929">:</span><span class="num" id="4902930">4</span><span class="op" id="4902931">]</span><span class="op" id="4902932">,</span>&nbsp;<span class="ident" id="4902934">n</span><span class="op" id="4902935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902938">e</span><span class="op" id="4902939">.</span><span class="ident" id="4902940">header</span><span class="op" id="4902946">[</span><span class="num" id="4902947">4</span><span class="op" id="4902948">]</span>&nbsp;<span class="op" id="4902950">=</span>&nbsp;<span class="ident" id="4902952">name</span><span class="op" id="4902956">[</span><span class="num" id="4902957">0</span><span class="op" id="4902958">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902961">e</span><span class="op" id="4902962">.</span><span class="ident" id="4902963">header</span><span class="op" id="4902969">[</span><span class="num" id="4902970">5</span><span class="op" id="4902971">]</span>&nbsp;<span class="op" id="4902973">=</span>&nbsp;<span class="ident" id="4902975">name</span><span class="op" id="4902979">[</span><span class="num" id="4902980">1</span><span class="op" id="4902981">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902984">e</span><span class="op" id="4902985">.</span><span class="ident" id="4902986">header</span><span class="op" id="4902992">[</span><span class="num" id="4902993">6</span><span class="op" id="4902994">]</span>&nbsp;<span class="op" id="4902996">=</span>&nbsp;<span class="ident" id="4902998">name</span><span class="op" id="4903002">[</span><span class="num" id="4903003">2</span><span class="op" id="4903004">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903007">e</span><span class="op" id="4903008">.</span><span class="ident" id="4903009">header</span><span class="op" id="4903015">[</span><span class="num" id="4903016">7</span><span class="op" id="4903017">]</span>&nbsp;<span class="op" id="4903019">=</span>&nbsp;<span class="ident" id="4903021">name</span><span class="op" id="4903025">[</span><span class="num" id="4903026">3</span><span class="op" id="4903027">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903030">crc</span>&nbsp;<span class="op" id="4903034">:=</span>&nbsp;<span class="ident" id="4903037">crc32</span><span class="op" id="4903042">.</span><span class="ident" id="4903043">NewIEEE</span><span class="op" id="4903050">(</span><span class="op" id="4903051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903054">crc</span><span class="op" id="4903057">.</span><span class="ident" id="4903058">Write</span><span class="op" id="4903063">(</span><span class="ident" id="4903064">e</span><span class="op" id="4903065">.</span><span class="ident" id="4903066">header</span><span class="op" id="4903072">[</span><span class="num" id="4903073">4</span><span class="op" id="4903074">:</span><span class="num" id="4903075">8</span><span class="op" id="4903076">]</span><span class="op" id="4903077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903080">crc</span><span class="op" id="4903083">.</span><span class="ident" id="4903084">Write</span><span class="op" id="4903089">(</span><span class="ident" id="4903090">b</span><span class="op" id="4903091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903094">writeUint32</span><span class="op" id="4903105">(</span><span class="ident" id="4903106">e</span><span class="op" id="4903107">.</span><span class="ident" id="4903108">footer</span><span class="op" id="4903114">[</span><span class="op" id="4903115">:</span><span class="num" id="4903116">4</span><span class="op" id="4903117">]</span><span class="op" id="4903118">,</span>&nbsp;<span class="ident" id="4903120">crc</span><span class="op" id="4903123">.</span><span class="ident" id="4903124">Sum32</span><span class="op" id="4903129">(</span><span class="op" id="4903130">)</span><span class="op" id="4903131">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903135">_</span><span class="op" id="4903136">,</span>&nbsp;<span class="ident" id="4903138">e</span><span class="op" id="4903139">.</span><span class="ident" id="4903140">err</span>&nbsp;<span class="op" id="4903144">=</span>&nbsp;<span class="ident" id="4903146">e</span><span class="op" id="4903147">.</span><span class="ident" id="4903148">w</span><span class="op" id="4903149">.</span><span class="ident" id="4903150">Write</span><span class="op" id="4903155">(</span><span class="ident" id="4903156">e</span><span class="op" id="4903157">.</span><span class="ident" id="4903158">header</span><span class="op" id="4903164">[</span><span class="op" id="4903165">:</span><span class="num" id="4903166">8</span><span class="op" id="4903167">]</span><span class="op" id="4903168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903171">if</span>&nbsp;<span class="ident" id="4903174">e</span><span class="op" id="4903175">.</span><span class="ident" id="4903176">err</span>&nbsp;<span class="op" id="4903180">!=</span>&nbsp;<span class="ident" id="4903183">nil</span>&nbsp;<span class="op" id="4903187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903191">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903199">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903202">_</span><span class="op" id="4903203">,</span>&nbsp;<span class="ident" id="4903205">e</span><span class="op" id="4903206">.</span><span class="ident" id="4903207">err</span>&nbsp;<span class="op" id="4903211">=</span>&nbsp;<span class="ident" id="4903213">e</span><span class="op" id="4903214">.</span><span class="ident" id="4903215">w</span><span class="op" id="4903216">.</span><span class="ident" id="4903217">Write</span><span class="op" id="4903222">(</span><span class="ident" id="4903223">b</span><span class="op" id="4903224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903227">if</span>&nbsp;<span class="ident" id="4903230">e</span><span class="op" id="4903231">.</span><span class="ident" id="4903232">err</span>&nbsp;<span class="op" id="4903236">!=</span>&nbsp;<span class="ident" id="4903239">nil</span>&nbsp;<span class="op" id="4903243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903247">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903258">_</span><span class="op" id="4903259">,</span>&nbsp;<span class="ident" id="4903261">e</span><span class="op" id="4903262">.</span><span class="ident" id="4903263">err</span>&nbsp;<span class="op" id="4903267">=</span>&nbsp;<span class="ident" id="4903269">e</span><span class="op" id="4903270">.</span><span class="ident" id="4903271">w</span><span class="op" id="4903272">.</span><span class="ident" id="4903273">Write</span><span class="op" id="4903278">(</span><span class="ident" id="4903279">e</span><span class="op" id="4903280">.</span><span class="ident" id="4903281">footer</span><span class="op" id="4903287">[</span><span class="op" id="4903288">:</span><span class="num" id="4903289">4</span><span class="op" id="4903290">]</span><span class="op" id="4903291">)</span><br>
<span class="lineno">110</span><span class="op" id="4903293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4903296">func</span>&nbsp;<span class="op" id="4903301">(</span><span class="ident" id="4903302">e</span>&nbsp;<span class="op" id="4903304">*</span><span class="ident" id="4903305">encoder</span><span class="op" id="4903312">)</span>&nbsp;<span class="ident" id="4903314">writeIHDR</span><span class="op" id="4903323">(</span><span class="op" id="4903324">)</span>&nbsp;<span class="op" id="4903326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903329">b</span>&nbsp;<span class="op" id="4903331">:=</span>&nbsp;<span class="ident" id="4903334">e</span><span class="op" id="4903335">.</span><span class="ident" id="4903336">m</span><span class="op" id="4903337">.</span><span class="ident" id="4903338">Bounds</span><span class="op" id="4903344">(</span><span class="op" id="4903345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903348">writeUint32</span><span class="op" id="4903359">(</span><span class="ident" id="4903360">e</span><span class="op" id="4903361">.</span><span class="ident" id="4903362">tmp</span><span class="op" id="4903365">[</span><span class="num" id="4903366">0</span><span class="op" id="4903367">:</span><span class="num" id="4903368">4</span><span class="op" id="4903369">]</span><span class="op" id="4903370">,</span>&nbsp;<span class="builtintype" id="4903372">uint32</span><span class="op" id="4903378">(</span><span class="ident" id="4903379">b</span><span class="op" id="4903380">.</span><span class="ident" id="4903381">Dx</span><span class="op" id="4903383">(</span><span class="op" id="4903384">)</span><span class="op" id="4903385">)</span><span class="op" id="4903386">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903389">writeUint32</span><span class="op" id="4903400">(</span><span class="ident" id="4903401">e</span><span class="op" id="4903402">.</span><span class="ident" id="4903403">tmp</span><span class="op" id="4903406">[</span><span class="num" id="4903407">4</span><span class="op" id="4903408">:</span><span class="num" id="4903409">8</span><span class="op" id="4903410">]</span><span class="op" id="4903411">,</span>&nbsp;<span class="builtintype" id="4903413">uint32</span><span class="op" id="4903419">(</span><span class="ident" id="4903420">b</span><span class="op" id="4903421">.</span><span class="ident" id="4903422">Dy</span><span class="op" id="4903424">(</span><span class="op" id="4903425">)</span><span class="op" id="4903426">)</span><span class="op" id="4903427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4903430">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903464">switch</span>&nbsp;<span class="ident" id="4903471">e</span><span class="op" id="4903472">.</span><span class="ident" id="4903473">cb</span>&nbsp;<span class="op" id="4903476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903479">case</span>&nbsp;<span class="ident" id="4903484">cbG8</span><span class="op" id="4903488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903492">e</span><span class="op" id="4903493">.</span><span class="ident" id="4903494">tmp</span><span class="op" id="4903497">[</span><span class="num" id="4903498">8</span><span class="op" id="4903499">]</span>&nbsp;<span class="op" id="4903501">=</span>&nbsp;<span class="num" id="4903503">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903507">e</span><span class="op" id="4903508">.</span><span class="ident" id="4903509">tmp</span><span class="op" id="4903512">[</span><span class="num" id="4903513">9</span><span class="op" id="4903514">]</span>&nbsp;<span class="op" id="4903516">=</span>&nbsp;<span class="ident" id="4903518">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903531">case</span>&nbsp;<span class="ident" id="4903536">cbTC8</span><span class="op" id="4903541">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903545">e</span><span class="op" id="4903546">.</span><span class="ident" id="4903547">tmp</span><span class="op" id="4903550">[</span><span class="num" id="4903551">8</span><span class="op" id="4903552">]</span>&nbsp;<span class="op" id="4903554">=</span>&nbsp;<span class="num" id="4903556">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903560">e</span><span class="op" id="4903561">.</span><span class="ident" id="4903562">tmp</span><span class="op" id="4903565">[</span><span class="num" id="4903566">9</span><span class="op" id="4903567">]</span>&nbsp;<span class="op" id="4903569">=</span>&nbsp;<span class="ident" id="4903571">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903584">case</span>&nbsp;<span class="ident" id="4903589">cbP8</span><span class="op" id="4903593">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903597">e</span><span class="op" id="4903598">.</span><span class="ident" id="4903599">tmp</span><span class="op" id="4903602">[</span><span class="num" id="4903603">8</span><span class="op" id="4903604">]</span>&nbsp;<span class="op" id="4903606">=</span>&nbsp;<span class="num" id="4903608">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903612">e</span><span class="op" id="4903613">.</span><span class="ident" id="4903614">tmp</span><span class="op" id="4903617">[</span><span class="num" id="4903618">9</span><span class="op" id="4903619">]</span>&nbsp;<span class="op" id="4903621">=</span>&nbsp;<span class="ident" id="4903623">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903635">case</span>&nbsp;<span class="ident" id="4903640">cbTCA8</span><span class="op" id="4903646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903650">e</span><span class="op" id="4903651">.</span><span class="ident" id="4903652">tmp</span><span class="op" id="4903655">[</span><span class="num" id="4903656">8</span><span class="op" id="4903657">]</span>&nbsp;<span class="op" id="4903659">=</span>&nbsp;<span class="num" id="4903661">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903665">e</span><span class="op" id="4903666">.</span><span class="ident" id="4903667">tmp</span><span class="op" id="4903670">[</span><span class="num" id="4903671">9</span><span class="op" id="4903672">]</span>&nbsp;<span class="op" id="4903674">=</span>&nbsp;<span class="ident" id="4903676">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903694">case</span>&nbsp;<span class="ident" id="4903699">cbG16</span><span class="op" id="4903704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903708">e</span><span class="op" id="4903709">.</span><span class="ident" id="4903710">tmp</span><span class="op" id="4903713">[</span><span class="num" id="4903714">8</span><span class="op" id="4903715">]</span>&nbsp;<span class="op" id="4903717">=</span>&nbsp;<span class="num" id="4903719">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903724">e</span><span class="op" id="4903725">.</span><span class="ident" id="4903726">tmp</span><span class="op" id="4903729">[</span><span class="num" id="4903730">9</span><span class="op" id="4903731">]</span>&nbsp;<span class="op" id="4903733">=</span>&nbsp;<span class="ident" id="4903735">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903748">case</span>&nbsp;<span class="ident" id="4903753">cbTC16</span><span class="op" id="4903759">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903763">e</span><span class="op" id="4903764">.</span><span class="ident" id="4903765">tmp</span><span class="op" id="4903768">[</span><span class="num" id="4903769">8</span><span class="op" id="4903770">]</span>&nbsp;<span class="op" id="4903772">=</span>&nbsp;<span class="num" id="4903774">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903779">e</span><span class="op" id="4903780">.</span><span class="ident" id="4903781">tmp</span><span class="op" id="4903784">[</span><span class="num" id="4903785">9</span><span class="op" id="4903786">]</span>&nbsp;<span class="op" id="4903788">=</span>&nbsp;<span class="ident" id="4903790">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903803">case</span>&nbsp;<span class="ident" id="4903808">cbTCA16</span><span class="op" id="4903815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903819">e</span><span class="op" id="4903820">.</span><span class="ident" id="4903821">tmp</span><span class="op" id="4903824">[</span><span class="num" id="4903825">8</span><span class="op" id="4903826">]</span>&nbsp;<span class="op" id="4903828">=</span>&nbsp;<span class="num" id="4903830">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903835">e</span><span class="op" id="4903836">.</span><span class="ident" id="4903837">tmp</span><span class="op" id="4903840">[</span><span class="num" id="4903841">9</span><span class="op" id="4903842">]</span>&nbsp;<span class="op" id="4903844">=</span>&nbsp;<span class="ident" id="4903846">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903864">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903867">e</span><span class="op" id="4903868">.</span><span class="ident" id="4903869">tmp</span><span class="op" id="4903872">[</span><span class="num" id="4903873">10</span><span class="op" id="4903875">]</span>&nbsp;<span class="op" id="4903877">=</span>&nbsp;<span class="num" id="4903879">0</span>&nbsp;<span class="comment" id="4903881">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903912">e</span><span class="op" id="4903913">.</span><span class="ident" id="4903914">tmp</span><span class="op" id="4903917">[</span><span class="num" id="4903918">11</span><span class="op" id="4903920">]</span>&nbsp;<span class="op" id="4903922">=</span>&nbsp;<span class="num" id="4903924">0</span>&nbsp;<span class="comment" id="4903926">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903952">e</span><span class="op" id="4903953">.</span><span class="ident" id="4903954">tmp</span><span class="op" id="4903957">[</span><span class="num" id="4903958">12</span><span class="op" id="4903960">]</span>&nbsp;<span class="op" id="4903962">=</span>&nbsp;<span class="num" id="4903964">0</span>&nbsp;<span class="comment" id="4903966">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903985">e</span><span class="op" id="4903986">.</span><span class="ident" id="4903987">writeChunk</span><span class="op" id="4903997">(</span><span class="ident" id="4903998">e</span><span class="op" id="4903999">.</span><span class="ident" id="4904000">tmp</span><span class="op" id="4904003">[</span><span class="op" id="4904004">:</span><span class="num" id="4904005">13</span><span class="op" id="4904007">]</span><span class="op" id="4904008">,</span>&nbsp;<span class="string" id="4904010">&#34;IHDR&#34;</span><span class="op" id="4904016">)</span><br>
<span class="lineno"></span><span class="op" id="4904018">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="4904021">func</span>&nbsp;<span class="op" id="4904026">(</span><span class="ident" id="4904027">e</span>&nbsp;<span class="op" id="4904029">*</span><span class="ident" id="4904030">encoder</span><span class="op" id="4904037">)</span>&nbsp;<span class="ident" id="4904039">writePLTEAndTRNS</span><span class="op" id="4904055">(</span><span class="ident" id="4904056">p</span>&nbsp;<span class="ident" id="4904058">color</span><span class="op" id="4904063">.</span><span class="ident" id="4904064">Palette</span><span class="op" id="4904071">)</span>&nbsp;<span class="op" id="4904073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904076">if</span>&nbsp;<span class="builtinfunc" id="4904079">len</span><span class="op" id="4904082">(</span><span class="ident" id="4904083">p</span><span class="op" id="4904084">)</span>&nbsp;<span class="op" id="4904086">&lt;</span>&nbsp;<span class="num" id="4904088">1</span>&nbsp;<span class="op" id="4904090">||</span>&nbsp;<span class="builtinfunc" id="4904093">len</span><span class="op" id="4904096">(</span><span class="ident" id="4904097">p</span><span class="op" id="4904098">)</span>&nbsp;<span class="op" id="4904100">&gt;</span>&nbsp;<span class="num" id="4904102">256</span>&nbsp;<span class="op" id="4904106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904110">e</span><span class="op" id="4904111">.</span><span class="ident" id="4904112">err</span>&nbsp;<span class="op" id="4904116">=</span>&nbsp;<span class="ident" id="4904118">FormatError</span><span class="op" id="4904129">(</span><span class="string" id="4904130">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="4904153">+</span>&nbsp;<span class="ident" id="4904155">strconv</span><span class="op" id="4904162">.</span><span class="ident" id="4904163">Itoa</span><span class="op" id="4904167">(</span><span class="builtinfunc" id="4904168">len</span><span class="op" id="4904171">(</span><span class="ident" id="4904172">p</span><span class="op" id="4904173">)</span><span class="op" id="4904174">)</span><span class="op" id="4904175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904179">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904190">last</span>&nbsp;<span class="op" id="4904195">:=</span>&nbsp;<span class="op" id="4904198">-</span><span class="num" id="4904199">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904202">for</span>&nbsp;<span class="ident" id="4904206">i</span><span class="op" id="4904207">,</span>&nbsp;<span class="ident" id="4904209">c</span>&nbsp;<span class="op" id="4904211">:=</span>&nbsp;<span class="keyword" id="4904214">range</span>&nbsp;<span class="ident" id="4904220">p</span>&nbsp;<span class="op" id="4904222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904226">c1</span>&nbsp;<span class="op" id="4904229">:=</span>&nbsp;<span class="ident" id="4904232">color</span><span class="op" id="4904237">.</span><span class="ident" id="4904238">NRGBAModel</span><span class="op" id="4904248">.</span><span class="ident" id="4904249">Convert</span><span class="op" id="4904256">(</span><span class="ident" id="4904257">c</span><span class="op" id="4904258">)</span><span class="op" id="4904259">.</span><span class="op" id="4904260">(</span><span class="ident" id="4904261">color</span><span class="op" id="4904266">.</span><span class="ident" id="4904267">NRGBA</span><span class="op" id="4904272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904276">e</span><span class="op" id="4904277">.</span><span class="ident" id="4904278">tmp</span><span class="op" id="4904281">[</span><span class="num" id="4904282">3</span><span class="op" id="4904283">*</span><span class="ident" id="4904284">i</span><span class="op" id="4904285">+</span><span class="num" id="4904286">0</span><span class="op" id="4904287">]</span>&nbsp;<span class="op" id="4904289">=</span>&nbsp;<span class="ident" id="4904291">c1</span><span class="op" id="4904293">.</span><span class="ident" id="4904294">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904298">e</span><span class="op" id="4904299">.</span><span class="ident" id="4904300">tmp</span><span class="op" id="4904303">[</span><span class="num" id="4904304">3</span><span class="op" id="4904305">*</span><span class="ident" id="4904306">i</span><span class="op" id="4904307">+</span><span class="num" id="4904308">1</span><span class="op" id="4904309">]</span>&nbsp;<span class="op" id="4904311">=</span>&nbsp;<span class="ident" id="4904313">c1</span><span class="op" id="4904315">.</span><span class="ident" id="4904316">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904320">e</span><span class="op" id="4904321">.</span><span class="ident" id="4904322">tmp</span><span class="op" id="4904325">[</span><span class="num" id="4904326">3</span><span class="op" id="4904327">*</span><span class="ident" id="4904328">i</span><span class="op" id="4904329">+</span><span class="num" id="4904330">2</span><span class="op" id="4904331">]</span>&nbsp;<span class="op" id="4904333">=</span>&nbsp;<span class="ident" id="4904335">c1</span><span class="op" id="4904337">.</span><span class="ident" id="4904338">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904342">if</span>&nbsp;<span class="ident" id="4904345">c1</span><span class="op" id="4904347">.</span><span class="ident" id="4904348">A</span>&nbsp;<span class="op" id="4904350">!=</span>&nbsp;<span class="num" id="4904353">0xff</span>&nbsp;<span class="op" id="4904358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904363">last</span>&nbsp;<span class="op" id="4904368">=</span>&nbsp;<span class="ident" id="4904370">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904374">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904378">e</span><span class="op" id="4904379">.</span><span class="ident" id="4904380">tmp</span><span class="op" id="4904383">[</span><span class="num" id="4904384">3</span><span class="op" id="4904385">*</span><span class="num" id="4904386">256</span><span class="op" id="4904389">+</span><span class="ident" id="4904390">i</span><span class="op" id="4904391">]</span>&nbsp;<span class="op" id="4904393">=</span>&nbsp;<span class="ident" id="4904395">c1</span><span class="op" id="4904397">.</span><span class="ident" id="4904398">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904404">e</span><span class="op" id="4904405">.</span><span class="ident" id="4904406">writeChunk</span><span class="op" id="4904416">(</span><span class="ident" id="4904417">e</span><span class="op" id="4904418">.</span><span class="ident" id="4904419">tmp</span><span class="op" id="4904422">[</span><span class="op" id="4904423">:</span><span class="num" id="4904424">3</span><span class="op" id="4904425">*</span><span class="builtinfunc" id="4904426">len</span><span class="op" id="4904429">(</span><span class="ident" id="4904430">p</span><span class="op" id="4904431">)</span><span class="op" id="4904432">]</span><span class="op" id="4904433">,</span>&nbsp;<span class="string" id="4904435">&#34;PLTE&#34;</span><span class="op" id="4904441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904444">if</span>&nbsp;<span class="ident" id="4904447">last</span>&nbsp;<span class="op" id="4904452">!=</span>&nbsp;<span class="op" id="4904455">-</span><span class="num" id="4904456">1</span>&nbsp;<span class="op" id="4904458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904462">e</span><span class="op" id="4904463">.</span><span class="ident" id="4904464">writeChunk</span><span class="op" id="4904474">(</span><span class="ident" id="4904475">e</span><span class="op" id="4904476">.</span><span class="ident" id="4904477">tmp</span><span class="op" id="4904480">[</span><span class="num" id="4904481">3</span><span class="op" id="4904482">*</span><span class="num" id="4904483">256</span><span class="op" id="4904486">:</span><span class="num" id="4904487">3</span><span class="op" id="4904488">*</span><span class="num" id="4904489">256</span><span class="op" id="4904492">+</span><span class="num" id="4904493">1</span><span class="op" id="4904494">+</span><span class="ident" id="4904495">last</span><span class="op" id="4904499">]</span><span class="op" id="4904500">,</span>&nbsp;<span class="string" id="4904502">&#34;tRNS&#34;</span><span class="op" id="4904508">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904511">}</span><br>
<span class="lineno"></span><span class="op" id="4904513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4904516">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="4904596">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="4904677">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="4904751">//</span><br>
<span class="lineno"></span><span class="comment" id="4904754">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="4904825">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4904883">func</span>&nbsp;<span class="op" id="4904888">(</span><span class="ident" id="4904889">e</span>&nbsp;<span class="op" id="4904891">*</span><span class="ident" id="4904892">encoder</span><span class="op" id="4904899">)</span>&nbsp;<span class="ident" id="4904901">Write</span><span class="op" id="4904906">(</span><span class="ident" id="4904907">b</span>&nbsp;<span class="op" id="4904909">[</span><span class="op" id="4904910">]</span><span class="builtintype" id="4904911">byte</span><span class="op" id="4904915">)</span>&nbsp;<span class="op" id="4904917">(</span><span class="builtintype" id="4904918">int</span><span class="op" id="4904921">,</span>&nbsp;<span class="builtintype" id="4904923">error</span><span class="op" id="4904928">)</span>&nbsp;<span class="op" id="4904930">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904933">e</span><span class="op" id="4904934">.</span><span class="ident" id="4904935">writeChunk</span><span class="op" id="4904945">(</span><span class="ident" id="4904946">b</span><span class="op" id="4904947">,</span>&nbsp;<span class="string" id="4904949">&#34;IDAT&#34;</span><span class="op" id="4904955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904958">if</span>&nbsp;<span class="ident" id="4904961">e</span><span class="op" id="4904962">.</span><span class="ident" id="4904963">err</span>&nbsp;<span class="op" id="4904967">!=</span>&nbsp;<span class="ident" id="4904970">nil</span>&nbsp;<span class="op" id="4904974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904978">return</span>&nbsp;<span class="num" id="4904985">0</span><span class="op" id="4904986">,</span>&nbsp;<span class="ident" id="4904988">e</span><span class="op" id="4904989">.</span><span class="ident" id="4904990">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904998">return</span>&nbsp;<span class="builtinfunc" id="4905005">len</span><span class="op" id="4905008">(</span><span class="ident" id="4905009">b</span><span class="op" id="4905010">)</span><span class="op" id="4905011">,</span>&nbsp;<span class="ident" id="4905013">nil</span><br>
<span class="lineno">180</span><span class="op" id="4905017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4905020">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="4905095">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="4905193">func</span>&nbsp;<span class="ident" id="4905198">filter</span><span class="op" id="4905204">(</span><span class="ident" id="4905205">cr</span>&nbsp;<span class="op" id="4905208">*</span><span class="op" id="4905209">[</span><span class="ident" id="4905210">nFilter</span><span class="op" id="4905217">]</span><span class="op" id="4905218">[</span><span class="op" id="4905219">]</span><span class="builtintype" id="4905220">byte</span><span class="op" id="4905224">,</span>&nbsp;<span class="ident" id="4905226">pr</span>&nbsp;<span class="op" id="4905229">[</span><span class="op" id="4905230">]</span><span class="builtintype" id="4905231">byte</span><span class="op" id="4905235">,</span>&nbsp;<span class="ident" id="4905237">bpp</span>&nbsp;<span class="builtintype" id="4905241">int</span><span class="op" id="4905244">)</span>&nbsp;<span class="builtintype" id="4905246">int</span>&nbsp;<span class="op" id="4905250">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905253">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905352">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905448">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905543">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905617">cdat0</span>&nbsp;<span class="op" id="4905623">:=</span>&nbsp;<span class="ident" id="4905626">cr</span><span class="op" id="4905628">[</span><span class="num" id="4905629">0</span><span class="op" id="4905630">]</span><span class="op" id="4905631">[</span><span class="num" id="4905632">1</span><span class="op" id="4905633">:</span><span class="op" id="4905634">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905637">cdat1</span>&nbsp;<span class="op" id="4905643">:=</span>&nbsp;<span class="ident" id="4905646">cr</span><span class="op" id="4905648">[</span><span class="num" id="4905649">1</span><span class="op" id="4905650">]</span><span class="op" id="4905651">[</span><span class="num" id="4905652">1</span><span class="op" id="4905653">:</span><span class="op" id="4905654">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905657">cdat2</span>&nbsp;<span class="op" id="4905663">:=</span>&nbsp;<span class="ident" id="4905666">cr</span><span class="op" id="4905668">[</span><span class="num" id="4905669">2</span><span class="op" id="4905670">]</span><span class="op" id="4905671">[</span><span class="num" id="4905672">1</span><span class="op" id="4905673">:</span><span class="op" id="4905674">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905677">cdat3</span>&nbsp;<span class="op" id="4905683">:=</span>&nbsp;<span class="ident" id="4905686">cr</span><span class="op" id="4905688">[</span><span class="num" id="4905689">3</span><span class="op" id="4905690">]</span><span class="op" id="4905691">[</span><span class="num" id="4905692">1</span><span class="op" id="4905693">:</span><span class="op" id="4905694">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905697">cdat4</span>&nbsp;<span class="op" id="4905703">:=</span>&nbsp;<span class="ident" id="4905706">cr</span><span class="op" id="4905708">[</span><span class="num" id="4905709">4</span><span class="op" id="4905710">]</span><span class="op" id="4905711">[</span><span class="num" id="4905712">1</span><span class="op" id="4905713">:</span><span class="op" id="4905714">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905717">pdat</span>&nbsp;<span class="op" id="4905722">:=</span>&nbsp;<span class="ident" id="4905725">pr</span><span class="op" id="4905727">[</span><span class="num" id="4905728">1</span><span class="op" id="4905729">:</span><span class="op" id="4905730">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905733">n</span>&nbsp;<span class="op" id="4905735">:=</span>&nbsp;<span class="builtinfunc" id="4905738">len</span><span class="op" id="4905741">(</span><span class="ident" id="4905742">cdat0</span><span class="op" id="4905747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905751">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905770">sum</span>&nbsp;<span class="op" id="4905774">:=</span>&nbsp;<span class="num" id="4905777">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905780">for</span>&nbsp;<span class="ident" id="4905784">i</span>&nbsp;<span class="op" id="4905786">:=</span>&nbsp;<span class="num" id="4905789">0</span><span class="op" id="4905790">;</span>&nbsp;<span class="ident" id="4905792">i</span>&nbsp;<span class="op" id="4905794">&lt;</span>&nbsp;<span class="ident" id="4905796">n</span><span class="op" id="4905797">;</span>&nbsp;<span class="ident" id="4905799">i</span><span class="op" id="4905800">++</span>&nbsp;<span class="op" id="4905803">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905807">cdat2</span><span class="op" id="4905812">[</span><span class="ident" id="4905813">i</span><span class="op" id="4905814">]</span>&nbsp;<span class="op" id="4905816">=</span>&nbsp;<span class="ident" id="4905818">cdat0</span><span class="op" id="4905823">[</span><span class="ident" id="4905824">i</span><span class="op" id="4905825">]</span>&nbsp;<span class="op" id="4905827">-</span>&nbsp;<span class="ident" id="4905829">pdat</span><span class="op" id="4905833">[</span><span class="ident" id="4905834">i</span><span class="op" id="4905835">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905839">sum</span>&nbsp;<span class="op" id="4905843">+=</span>&nbsp;<span class="ident" id="4905846">abs8</span><span class="op" id="4905850">(</span><span class="ident" id="4905851">cdat2</span><span class="op" id="4905856">[</span><span class="ident" id="4905857">i</span><span class="op" id="4905858">]</span><span class="op" id="4905859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905865">best</span>&nbsp;<span class="op" id="4905870">:=</span>&nbsp;<span class="ident" id="4905873">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905878">filter</span>&nbsp;<span class="op" id="4905885">:=</span>&nbsp;<span class="ident" id="4905888">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905895">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905917">sum</span>&nbsp;<span class="op" id="4905921">=</span>&nbsp;<span class="num" id="4905923">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905926">for</span>&nbsp;<span class="ident" id="4905930">i</span>&nbsp;<span class="op" id="4905932">:=</span>&nbsp;<span class="num" id="4905935">0</span><span class="op" id="4905936">;</span>&nbsp;<span class="ident" id="4905938">i</span>&nbsp;<span class="op" id="4905940">&lt;</span>&nbsp;<span class="ident" id="4905942">bpp</span><span class="op" id="4905945">;</span>&nbsp;<span class="ident" id="4905947">i</span><span class="op" id="4905948">++</span>&nbsp;<span class="op" id="4905951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905955">cdat4</span><span class="op" id="4905960">[</span><span class="ident" id="4905961">i</span><span class="op" id="4905962">]</span>&nbsp;<span class="op" id="4905964">=</span>&nbsp;<span class="ident" id="4905966">cdat0</span><span class="op" id="4905971">[</span><span class="ident" id="4905972">i</span><span class="op" id="4905973">]</span>&nbsp;<span class="op" id="4905975">-</span>&nbsp;<span class="ident" id="4905977">pdat</span><span class="op" id="4905981">[</span><span class="ident" id="4905982">i</span><span class="op" id="4905983">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905987">sum</span>&nbsp;<span class="op" id="4905991">+=</span>&nbsp;<span class="ident" id="4905994">abs8</span><span class="op" id="4905998">(</span><span class="ident" id="4905999">cdat4</span><span class="op" id="4906004">[</span><span class="ident" id="4906005">i</span><span class="op" id="4906006">]</span><span class="op" id="4906007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906013">for</span>&nbsp;<span class="ident" id="4906017">i</span>&nbsp;<span class="op" id="4906019">:=</span>&nbsp;<span class="ident" id="4906022">bpp</span><span class="op" id="4906025">;</span>&nbsp;<span class="ident" id="4906027">i</span>&nbsp;<span class="op" id="4906029">&lt;</span>&nbsp;<span class="ident" id="4906031">n</span><span class="op" id="4906032">;</span>&nbsp;<span class="ident" id="4906034">i</span><span class="op" id="4906035">++</span>&nbsp;<span class="op" id="4906038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906042">cdat4</span><span class="op" id="4906047">[</span><span class="ident" id="4906048">i</span><span class="op" id="4906049">]</span>&nbsp;<span class="op" id="4906051">=</span>&nbsp;<span class="ident" id="4906053">cdat0</span><span class="op" id="4906058">[</span><span class="ident" id="4906059">i</span><span class="op" id="4906060">]</span>&nbsp;<span class="op" id="4906062">-</span>&nbsp;<span class="ident" id="4906064">paeth</span><span class="op" id="4906069">(</span><span class="ident" id="4906070">cdat0</span><span class="op" id="4906075">[</span><span class="ident" id="4906076">i</span><span class="op" id="4906077">-</span><span class="ident" id="4906078">bpp</span><span class="op" id="4906081">]</span><span class="op" id="4906082">,</span>&nbsp;<span class="ident" id="4906084">pdat</span><span class="op" id="4906088">[</span><span class="ident" id="4906089">i</span><span class="op" id="4906090">]</span><span class="op" id="4906091">,</span>&nbsp;<span class="ident" id="4906093">pdat</span><span class="op" id="4906097">[</span><span class="ident" id="4906098">i</span><span class="op" id="4906099">-</span><span class="ident" id="4906100">bpp</span><span class="op" id="4906103">]</span><span class="op" id="4906104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906108">sum</span>&nbsp;<span class="op" id="4906112">+=</span>&nbsp;<span class="ident" id="4906115">abs8</span><span class="op" id="4906119">(</span><span class="ident" id="4906120">cdat4</span><span class="op" id="4906125">[</span><span class="ident" id="4906126">i</span><span class="op" id="4906127">]</span><span class="op" id="4906128">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906132">if</span>&nbsp;<span class="ident" id="4906135">sum</span>&nbsp;<span class="op" id="4906139">&gt;=</span>&nbsp;<span class="ident" id="4906142">best</span>&nbsp;<span class="op" id="4906147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906152">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906166">if</span>&nbsp;<span class="ident" id="4906169">sum</span>&nbsp;<span class="op" id="4906173">&lt;</span>&nbsp;<span class="ident" id="4906175">best</span>&nbsp;<span class="op" id="4906180">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906184">best</span>&nbsp;<span class="op" id="4906189">=</span>&nbsp;<span class="ident" id="4906191">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906197">filter</span>&nbsp;<span class="op" id="4906204">=</span>&nbsp;<span class="ident" id="4906206">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906219">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906240">sum</span>&nbsp;<span class="op" id="4906244">=</span>&nbsp;<span class="num" id="4906246">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906249">for</span>&nbsp;<span class="ident" id="4906253">i</span>&nbsp;<span class="op" id="4906255">:=</span>&nbsp;<span class="num" id="4906258">0</span><span class="op" id="4906259">;</span>&nbsp;<span class="ident" id="4906261">i</span>&nbsp;<span class="op" id="4906263">&lt;</span>&nbsp;<span class="ident" id="4906265">n</span><span class="op" id="4906266">;</span>&nbsp;<span class="ident" id="4906268">i</span><span class="op" id="4906269">++</span>&nbsp;<span class="op" id="4906272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906276">sum</span>&nbsp;<span class="op" id="4906280">+=</span>&nbsp;<span class="ident" id="4906283">abs8</span><span class="op" id="4906287">(</span><span class="ident" id="4906288">cdat0</span><span class="op" id="4906293">[</span><span class="ident" id="4906294">i</span><span class="op" id="4906295">]</span><span class="op" id="4906296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906300">if</span>&nbsp;<span class="ident" id="4906303">sum</span>&nbsp;<span class="op" id="4906307">&gt;=</span>&nbsp;<span class="ident" id="4906310">best</span>&nbsp;<span class="op" id="4906315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906320">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906334">if</span>&nbsp;<span class="ident" id="4906337">sum</span>&nbsp;<span class="op" id="4906341">&lt;</span>&nbsp;<span class="ident" id="4906343">best</span>&nbsp;<span class="op" id="4906348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906352">best</span>&nbsp;<span class="op" id="4906357">=</span>&nbsp;<span class="ident" id="4906359">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906365">filter</span>&nbsp;<span class="op" id="4906372">=</span>&nbsp;<span class="ident" id="4906374">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906386">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906406">sum</span>&nbsp;<span class="op" id="4906410">=</span>&nbsp;<span class="num" id="4906412">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906415">for</span>&nbsp;<span class="ident" id="4906419">i</span>&nbsp;<span class="op" id="4906421">:=</span>&nbsp;<span class="num" id="4906424">0</span><span class="op" id="4906425">;</span>&nbsp;<span class="ident" id="4906427">i</span>&nbsp;<span class="op" id="4906429">&lt;</span>&nbsp;<span class="ident" id="4906431">bpp</span><span class="op" id="4906434">;</span>&nbsp;<span class="ident" id="4906436">i</span><span class="op" id="4906437">++</span>&nbsp;<span class="op" id="4906440">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906444">cdat1</span><span class="op" id="4906449">[</span><span class="ident" id="4906450">i</span><span class="op" id="4906451">]</span>&nbsp;<span class="op" id="4906453">=</span>&nbsp;<span class="ident" id="4906455">cdat0</span><span class="op" id="4906460">[</span><span class="ident" id="4906461">i</span><span class="op" id="4906462">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906466">sum</span>&nbsp;<span class="op" id="4906470">+=</span>&nbsp;<span class="ident" id="4906473">abs8</span><span class="op" id="4906477">(</span><span class="ident" id="4906478">cdat1</span><span class="op" id="4906483">[</span><span class="ident" id="4906484">i</span><span class="op" id="4906485">]</span><span class="op" id="4906486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906492">for</span>&nbsp;<span class="ident" id="4906496">i</span>&nbsp;<span class="op" id="4906498">:=</span>&nbsp;<span class="ident" id="4906501">bpp</span><span class="op" id="4906504">;</span>&nbsp;<span class="ident" id="4906506">i</span>&nbsp;<span class="op" id="4906508">&lt;</span>&nbsp;<span class="ident" id="4906510">n</span><span class="op" id="4906511">;</span>&nbsp;<span class="ident" id="4906513">i</span><span class="op" id="4906514">++</span>&nbsp;<span class="op" id="4906517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906521">cdat1</span><span class="op" id="4906526">[</span><span class="ident" id="4906527">i</span><span class="op" id="4906528">]</span>&nbsp;<span class="op" id="4906530">=</span>&nbsp;<span class="ident" id="4906532">cdat0</span><span class="op" id="4906537">[</span><span class="ident" id="4906538">i</span><span class="op" id="4906539">]</span>&nbsp;<span class="op" id="4906541">-</span>&nbsp;<span class="ident" id="4906543">cdat0</span><span class="op" id="4906548">[</span><span class="ident" id="4906549">i</span><span class="op" id="4906550">-</span><span class="ident" id="4906551">bpp</span><span class="op" id="4906554">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906558">sum</span>&nbsp;<span class="op" id="4906562">+=</span>&nbsp;<span class="ident" id="4906565">abs8</span><span class="op" id="4906569">(</span><span class="ident" id="4906570">cdat1</span><span class="op" id="4906575">[</span><span class="ident" id="4906576">i</span><span class="op" id="4906577">]</span><span class="op" id="4906578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906582">if</span>&nbsp;<span class="ident" id="4906585">sum</span>&nbsp;<span class="op" id="4906589">&gt;=</span>&nbsp;<span class="ident" id="4906592">best</span>&nbsp;<span class="op" id="4906597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906602">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906613">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906616">if</span>&nbsp;<span class="ident" id="4906619">sum</span>&nbsp;<span class="op" id="4906623">&lt;</span>&nbsp;<span class="ident" id="4906625">best</span>&nbsp;<span class="op" id="4906630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906634">best</span>&nbsp;<span class="op" id="4906639">=</span>&nbsp;<span class="ident" id="4906641">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906647">filter</span>&nbsp;<span class="op" id="4906654">=</span>&nbsp;<span class="ident" id="4906656">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906667">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906691">sum</span>&nbsp;<span class="op" id="4906695">=</span>&nbsp;<span class="num" id="4906697">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906700">for</span>&nbsp;<span class="ident" id="4906704">i</span>&nbsp;<span class="op" id="4906706">:=</span>&nbsp;<span class="num" id="4906709">0</span><span class="op" id="4906710">;</span>&nbsp;<span class="ident" id="4906712">i</span>&nbsp;<span class="op" id="4906714">&lt;</span>&nbsp;<span class="ident" id="4906716">bpp</span><span class="op" id="4906719">;</span>&nbsp;<span class="ident" id="4906721">i</span><span class="op" id="4906722">++</span>&nbsp;<span class="op" id="4906725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906729">cdat3</span><span class="op" id="4906734">[</span><span class="ident" id="4906735">i</span><span class="op" id="4906736">]</span>&nbsp;<span class="op" id="4906738">=</span>&nbsp;<span class="ident" id="4906740">cdat0</span><span class="op" id="4906745">[</span><span class="ident" id="4906746">i</span><span class="op" id="4906747">]</span>&nbsp;<span class="op" id="4906749">-</span>&nbsp;<span class="ident" id="4906751">pdat</span><span class="op" id="4906755">[</span><span class="ident" id="4906756">i</span><span class="op" id="4906757">]</span><span class="op" id="4906758">/</span><span class="num" id="4906759">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906763">sum</span>&nbsp;<span class="op" id="4906767">+=</span>&nbsp;<span class="ident" id="4906770">abs8</span><span class="op" id="4906774">(</span><span class="ident" id="4906775">cdat3</span><span class="op" id="4906780">[</span><span class="ident" id="4906781">i</span><span class="op" id="4906782">]</span><span class="op" id="4906783">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906789">for</span>&nbsp;<span class="ident" id="4906793">i</span>&nbsp;<span class="op" id="4906795">:=</span>&nbsp;<span class="ident" id="4906798">bpp</span><span class="op" id="4906801">;</span>&nbsp;<span class="ident" id="4906803">i</span>&nbsp;<span class="op" id="4906805">&lt;</span>&nbsp;<span class="ident" id="4906807">n</span><span class="op" id="4906808">;</span>&nbsp;<span class="ident" id="4906810">i</span><span class="op" id="4906811">++</span>&nbsp;<span class="op" id="4906814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906818">cdat3</span><span class="op" id="4906823">[</span><span class="ident" id="4906824">i</span><span class="op" id="4906825">]</span>&nbsp;<span class="op" id="4906827">=</span>&nbsp;<span class="ident" id="4906829">cdat0</span><span class="op" id="4906834">[</span><span class="ident" id="4906835">i</span><span class="op" id="4906836">]</span>&nbsp;<span class="op" id="4906838">-</span>&nbsp;<span class="builtintype" id="4906840">uint8</span><span class="op" id="4906845">(</span><span class="op" id="4906846">(</span><span class="builtintype" id="4906847">int</span><span class="op" id="4906850">(</span><span class="ident" id="4906851">cdat0</span><span class="op" id="4906856">[</span><span class="ident" id="4906857">i</span><span class="op" id="4906858">-</span><span class="ident" id="4906859">bpp</span><span class="op" id="4906862">]</span><span class="op" id="4906863">)</span><span class="op" id="4906864">+</span><span class="builtintype" id="4906865">int</span><span class="op" id="4906868">(</span><span class="ident" id="4906869">pdat</span><span class="op" id="4906873">[</span><span class="ident" id="4906874">i</span><span class="op" id="4906875">]</span><span class="op" id="4906876">)</span><span class="op" id="4906877">)</span><span class="op" id="4906878">/</span><span class="num" id="4906879">2</span><span class="op" id="4906880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906884">sum</span>&nbsp;<span class="op" id="4906888">+=</span>&nbsp;<span class="ident" id="4906891">abs8</span><span class="op" id="4906895">(</span><span class="ident" id="4906896">cdat3</span><span class="op" id="4906901">[</span><span class="ident" id="4906902">i</span><span class="op" id="4906903">]</span><span class="op" id="4906904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906908">if</span>&nbsp;<span class="ident" id="4906911">sum</span>&nbsp;<span class="op" id="4906915">&gt;=</span>&nbsp;<span class="ident" id="4906918">best</span>&nbsp;<span class="op" id="4906923">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906928">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906942">if</span>&nbsp;<span class="ident" id="4906945">sum</span>&nbsp;<span class="op" id="4906949">&lt;</span>&nbsp;<span class="ident" id="4906951">best</span>&nbsp;<span class="op" id="4906956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906960">best</span>&nbsp;<span class="op" id="4906965">=</span>&nbsp;<span class="ident" id="4906967">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906973">filter</span>&nbsp;<span class="op" id="4906980">=</span>&nbsp;<span class="ident" id="4906982">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906997">return</span>&nbsp;<span class="ident" id="4907004">filter</span><br>
<span class="lineno"></span><span class="op" id="4907011">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="4907014">func</span>&nbsp;<span class="ident" id="4907019">writeImage</span><span class="op" id="4907029">(</span><span class="ident" id="4907030">w</span>&nbsp;<span class="ident" id="4907032">io</span><span class="op" id="4907034">.</span><span class="ident" id="4907035">Writer</span><span class="op" id="4907041">,</span>&nbsp;<span class="ident" id="4907043">m</span>&nbsp;<span class="ident" id="4907045">image</span><span class="op" id="4907050">.</span><span class="ident" id="4907051">Image</span><span class="op" id="4907056">,</span>&nbsp;<span class="ident" id="4907058">cb</span>&nbsp;<span class="builtintype" id="4907061">int</span><span class="op" id="4907064">,</span>&nbsp;<span class="ident" id="4907066">level</span>&nbsp;<span class="builtintype" id="4907072">int</span><span class="op" id="4907075">)</span>&nbsp;<span class="builtintype" id="4907077">error</span>&nbsp;<span class="op" id="4907083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907086">zw</span><span class="op" id="4907088">,</span>&nbsp;<span class="ident" id="4907090">err</span>&nbsp;<span class="op" id="4907094">:=</span>&nbsp;<span class="ident" id="4907097">zlib</span><span class="op" id="4907101">.</span><span class="ident" id="4907102">NewWriterLevel</span><span class="op" id="4907116">(</span><span class="ident" id="4907117">w</span><span class="op" id="4907118">,</span>&nbsp;<span class="ident" id="4907120">level</span><span class="op" id="4907125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907128">if</span>&nbsp;<span class="ident" id="4907131">err</span>&nbsp;<span class="op" id="4907135">!=</span>&nbsp;<span class="ident" id="4907138">nil</span>&nbsp;<span class="op" id="4907142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907146">return</span>&nbsp;<span class="ident" id="4907153">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907161">defer</span>&nbsp;<span class="ident" id="4907167">zw</span><span class="op" id="4907169">.</span><span class="ident" id="4907170">Close</span><span class="op" id="4907175">(</span><span class="op" id="4907176">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907180">bpp</span>&nbsp;<span class="op" id="4907184">:=</span>&nbsp;<span class="num" id="4907187">0</span>&nbsp;<span class="comment" id="4907189">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907211">switch</span>&nbsp;<span class="ident" id="4907218">cb</span>&nbsp;<span class="op" id="4907221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907224">case</span>&nbsp;<span class="ident" id="4907229">cbG8</span><span class="op" id="4907233">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907237">bpp</span>&nbsp;<span class="op" id="4907241">=</span>&nbsp;<span class="num" id="4907243">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907246">case</span>&nbsp;<span class="ident" id="4907251">cbTC8</span><span class="op" id="4907256">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907260">bpp</span>&nbsp;<span class="op" id="4907264">=</span>&nbsp;<span class="num" id="4907266">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907269">case</span>&nbsp;<span class="ident" id="4907274">cbP8</span><span class="op" id="4907278">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907282">bpp</span>&nbsp;<span class="op" id="4907286">=</span>&nbsp;<span class="num" id="4907288">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907291">case</span>&nbsp;<span class="ident" id="4907296">cbTCA8</span><span class="op" id="4907302">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907306">bpp</span>&nbsp;<span class="op" id="4907310">=</span>&nbsp;<span class="num" id="4907312">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907315">case</span>&nbsp;<span class="ident" id="4907320">cbTC16</span><span class="op" id="4907326">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907330">bpp</span>&nbsp;<span class="op" id="4907334">=</span>&nbsp;<span class="num" id="4907336">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907339">case</span>&nbsp;<span class="ident" id="4907344">cbTCA16</span><span class="op" id="4907351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907355">bpp</span>&nbsp;<span class="op" id="4907359">=</span>&nbsp;<span class="num" id="4907361">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907364">case</span>&nbsp;<span class="ident" id="4907369">cbG16</span><span class="op" id="4907374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907378">bpp</span>&nbsp;<span class="op" id="4907382">=</span>&nbsp;<span class="num" id="4907384">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907390">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907455">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907531">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907618">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907705">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907770">b</span>&nbsp;<span class="op" id="4907772">:=</span>&nbsp;<span class="ident" id="4907775">m</span><span class="op" id="4907776">.</span><span class="ident" id="4907777">Bounds</span><span class="op" id="4907783">(</span><span class="op" id="4907784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907787">var</span>&nbsp;<span class="ident" id="4907791">cr</span>&nbsp;<span class="op" id="4907794">[</span><span class="ident" id="4907795">nFilter</span><span class="op" id="4907802">]</span><span class="op" id="4907803">[</span><span class="op" id="4907804">]</span><span class="builtintype" id="4907805">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907812">for</span>&nbsp;<span class="ident" id="4907816">i</span>&nbsp;<span class="op" id="4907818">:=</span>&nbsp;<span class="keyword" id="4907821">range</span>&nbsp;<span class="ident" id="4907827">cr</span>&nbsp;<span class="op" id="4907830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907834">cr</span><span class="op" id="4907836">[</span><span class="ident" id="4907837">i</span><span class="op" id="4907838">]</span>&nbsp;<span class="op" id="4907840">=</span>&nbsp;<span class="builtinfunc" id="4907842">make</span><span class="op" id="4907846">(</span><span class="op" id="4907847">[</span><span class="op" id="4907848">]</span><span class="builtintype" id="4907849">uint8</span><span class="op" id="4907854">,</span>&nbsp;<span class="num" id="4907856">1</span><span class="op" id="4907857">+</span><span class="ident" id="4907858">bpp</span><span class="op" id="4907861">*</span><span class="ident" id="4907862">b</span><span class="op" id="4907863">.</span><span class="ident" id="4907864">Dx</span><span class="op" id="4907866">(</span><span class="op" id="4907867">)</span><span class="op" id="4907868">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907872">cr</span><span class="op" id="4907874">[</span><span class="ident" id="4907875">i</span><span class="op" id="4907876">]</span><span class="op" id="4907877">[</span><span class="num" id="4907878">0</span><span class="op" id="4907879">]</span>&nbsp;<span class="op" id="4907881">=</span>&nbsp;<span class="builtintype" id="4907883">uint8</span><span class="op" id="4907888">(</span><span class="ident" id="4907889">i</span><span class="op" id="4907890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907896">pr</span>&nbsp;<span class="op" id="4907899">:=</span>&nbsp;<span class="builtinfunc" id="4907902">make</span><span class="op" id="4907906">(</span><span class="op" id="4907907">[</span><span class="op" id="4907908">]</span><span class="builtintype" id="4907909">uint8</span><span class="op" id="4907914">,</span>&nbsp;<span class="num" id="4907916">1</span><span class="op" id="4907917">+</span><span class="ident" id="4907918">bpp</span><span class="op" id="4907921">*</span><span class="ident" id="4907922">b</span><span class="op" id="4907923">.</span><span class="ident" id="4907924">Dx</span><span class="op" id="4907926">(</span><span class="op" id="4907927">)</span><span class="op" id="4907928">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907932">gray</span><span class="op" id="4907936">,</span>&nbsp;<span class="ident" id="4907938">_</span>&nbsp;<span class="op" id="4907940">:=</span>&nbsp;<span class="ident" id="4907943">m</span><span class="op" id="4907944">.</span><span class="op" id="4907945">(</span><span class="op" id="4907946">*</span><span class="ident" id="4907947">image</span><span class="op" id="4907952">.</span><span class="ident" id="4907953">Gray</span><span class="op" id="4907957">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907960">rgba</span><span class="op" id="4907964">,</span>&nbsp;<span class="ident" id="4907966">_</span>&nbsp;<span class="op" id="4907968">:=</span>&nbsp;<span class="ident" id="4907971">m</span><span class="op" id="4907972">.</span><span class="op" id="4907973">(</span><span class="op" id="4907974">*</span><span class="ident" id="4907975">image</span><span class="op" id="4907980">.</span><span class="ident" id="4907981">RGBA</span><span class="op" id="4907985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907988">paletted</span><span class="op" id="4907996">,</span>&nbsp;<span class="ident" id="4907998">_</span>&nbsp;<span class="op" id="4908000">:=</span>&nbsp;<span class="ident" id="4908003">m</span><span class="op" id="4908004">.</span><span class="op" id="4908005">(</span><span class="op" id="4908006">*</span><span class="ident" id="4908007">image</span><span class="op" id="4908012">.</span><span class="ident" id="4908013">Paletted</span><span class="op" id="4908021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908024">nrgba</span><span class="op" id="4908029">,</span>&nbsp;<span class="ident" id="4908031">_</span>&nbsp;<span class="op" id="4908033">:=</span>&nbsp;<span class="ident" id="4908036">m</span><span class="op" id="4908037">.</span><span class="op" id="4908038">(</span><span class="op" id="4908039">*</span><span class="ident" id="4908040">image</span><span class="op" id="4908045">.</span><span class="ident" id="4908046">NRGBA</span><span class="op" id="4908051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908055">for</span>&nbsp;<span class="ident" id="4908059">y</span>&nbsp;<span class="op" id="4908061">:=</span>&nbsp;<span class="ident" id="4908064">b</span><span class="op" id="4908065">.</span><span class="ident" id="4908066">Min</span><span class="op" id="4908069">.</span><span class="ident" id="4908070">Y</span><span class="op" id="4908071">;</span>&nbsp;<span class="ident" id="4908073">y</span>&nbsp;<span class="op" id="4908075">&lt;</span>&nbsp;<span class="ident" id="4908077">b</span><span class="op" id="4908078">.</span><span class="ident" id="4908079">Max</span><span class="op" id="4908082">.</span><span class="ident" id="4908083">Y</span><span class="op" id="4908084">;</span>&nbsp;<span class="ident" id="4908086">y</span><span class="op" id="4908087">++</span>&nbsp;<span class="op" id="4908090">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908094">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908129">i</span>&nbsp;<span class="op" id="4908131">:=</span>&nbsp;<span class="num" id="4908134">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908138">switch</span>&nbsp;<span class="ident" id="4908145">cb</span>&nbsp;<span class="op" id="4908148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908152">case</span>&nbsp;<span class="ident" id="4908157">cbG8</span><span class="op" id="4908161">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908166">if</span>&nbsp;<span class="ident" id="4908169">gray</span>&nbsp;<span class="op" id="4908174">!=</span>&nbsp;<span class="ident" id="4908177">nil</span>&nbsp;<span class="op" id="4908181">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908187">offset</span>&nbsp;<span class="op" id="4908194">:=</span>&nbsp;<span class="op" id="4908197">(</span><span class="ident" id="4908198">y</span>&nbsp;<span class="op" id="4908200">-</span>&nbsp;<span class="ident" id="4908202">b</span><span class="op" id="4908203">.</span><span class="ident" id="4908204">Min</span><span class="op" id="4908207">.</span><span class="ident" id="4908208">Y</span><span class="op" id="4908209">)</span>&nbsp;<span class="op" id="4908211">*</span>&nbsp;<span class="ident" id="4908213">gray</span><span class="op" id="4908217">.</span><span class="ident" id="4908218">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4908229">copy</span><span class="op" id="4908233">(</span><span class="ident" id="4908234">cr</span><span class="op" id="4908236">[</span><span class="num" id="4908237">0</span><span class="op" id="4908238">]</span><span class="op" id="4908239">[</span><span class="num" id="4908240">1</span><span class="op" id="4908241">:</span><span class="op" id="4908242">]</span><span class="op" id="4908243">,</span>&nbsp;<span class="ident" id="4908245">gray</span><span class="op" id="4908249">.</span><span class="ident" id="4908250">Pix</span><span class="op" id="4908253">[</span><span class="ident" id="4908254">offset</span><span class="op" id="4908260">:</span><span class="ident" id="4908261">offset</span><span class="op" id="4908267">+</span><span class="ident" id="4908268">b</span><span class="op" id="4908269">.</span><span class="ident" id="4908270">Dx</span><span class="op" id="4908272">(</span><span class="op" id="4908273">)</span><span class="op" id="4908274">]</span><span class="op" id="4908275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908280">}</span>&nbsp;<span class="keyword" id="4908282">else</span>&nbsp;<span class="op" id="4908287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908293">for</span>&nbsp;<span class="ident" id="4908297">x</span>&nbsp;<span class="op" id="4908299">:=</span>&nbsp;<span class="ident" id="4908302">b</span><span class="op" id="4908303">.</span><span class="ident" id="4908304">Min</span><span class="op" id="4908307">.</span><span class="ident" id="4908308">X</span><span class="op" id="4908309">;</span>&nbsp;<span class="ident" id="4908311">x</span>&nbsp;<span class="op" id="4908313">&lt;</span>&nbsp;<span class="ident" id="4908315">b</span><span class="op" id="4908316">.</span><span class="ident" id="4908317">Max</span><span class="op" id="4908320">.</span><span class="ident" id="4908321">X</span><span class="op" id="4908322">;</span>&nbsp;<span class="ident" id="4908324">x</span><span class="op" id="4908325">++</span>&nbsp;<span class="op" id="4908328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908335">c</span>&nbsp;<span class="op" id="4908337">:=</span>&nbsp;<span class="ident" id="4908340">color</span><span class="op" id="4908345">.</span><span class="ident" id="4908346">GrayModel</span><span class="op" id="4908355">.</span><span class="ident" id="4908356">Convert</span><span class="op" id="4908363">(</span><span class="ident" id="4908364">m</span><span class="op" id="4908365">.</span><span class="ident" id="4908366">At</span><span class="op" id="4908368">(</span><span class="ident" id="4908369">x</span><span class="op" id="4908370">,</span>&nbsp;<span class="ident" id="4908372">y</span><span class="op" id="4908373">)</span><span class="op" id="4908374">)</span><span class="op" id="4908375">.</span><span class="op" id="4908376">(</span><span class="ident" id="4908377">color</span><span class="op" id="4908382">.</span><span class="ident" id="4908383">Gray</span><span class="op" id="4908387">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908394">cr</span><span class="op" id="4908396">[</span><span class="num" id="4908397">0</span><span class="op" id="4908398">]</span><span class="op" id="4908399">[</span><span class="ident" id="4908400">i</span><span class="op" id="4908401">]</span>&nbsp;<span class="op" id="4908403">=</span>&nbsp;<span class="ident" id="4908405">c</span><span class="op" id="4908406">.</span><span class="ident" id="4908407">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908414">i</span><span class="op" id="4908415">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908431">case</span>&nbsp;<span class="ident" id="4908436">cbTC8</span><span class="op" id="4908441">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908446">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908518">cr0</span>&nbsp;<span class="op" id="4908522">:=</span>&nbsp;<span class="ident" id="4908525">cr</span><span class="op" id="4908527">[</span><span class="num" id="4908528">0</span><span class="op" id="4908529">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908534">stride</span><span class="op" id="4908540">,</span>&nbsp;<span class="ident" id="4908542">pix</span>&nbsp;<span class="op" id="4908546">:=</span>&nbsp;<span class="num" id="4908549">0</span><span class="op" id="4908550">,</span>&nbsp;<span class="op" id="4908552">[</span><span class="op" id="4908553">]</span><span class="builtintype" id="4908554">byte</span><span class="op" id="4908558">(</span><span class="ident" id="4908559">nil</span><span class="op" id="4908562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908567">if</span>&nbsp;<span class="ident" id="4908570">rgba</span>&nbsp;<span class="op" id="4908575">!=</span>&nbsp;<span class="ident" id="4908578">nil</span>&nbsp;<span class="op" id="4908582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908588">stride</span><span class="op" id="4908594">,</span>&nbsp;<span class="ident" id="4908596">pix</span>&nbsp;<span class="op" id="4908600">=</span>&nbsp;<span class="ident" id="4908602">rgba</span><span class="op" id="4908606">.</span><span class="ident" id="4908607">Stride</span><span class="op" id="4908613">,</span>&nbsp;<span class="ident" id="4908615">rgba</span><span class="op" id="4908619">.</span><span class="ident" id="4908620">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908627">}</span>&nbsp;<span class="keyword" id="4908629">else</span>&nbsp;<span class="keyword" id="4908634">if</span>&nbsp;<span class="ident" id="4908637">nrgba</span>&nbsp;<span class="op" id="4908643">!=</span>&nbsp;<span class="ident" id="4908646">nil</span>&nbsp;<span class="op" id="4908650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908656">stride</span><span class="op" id="4908662">,</span>&nbsp;<span class="ident" id="4908664">pix</span>&nbsp;<span class="op" id="4908668">=</span>&nbsp;<span class="ident" id="4908670">nrgba</span><span class="op" id="4908675">.</span><span class="ident" id="4908676">Stride</span><span class="op" id="4908682">,</span>&nbsp;<span class="ident" id="4908684">nrgba</span><span class="op" id="4908689">.</span><span class="ident" id="4908690">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908702">if</span>&nbsp;<span class="ident" id="4908705">stride</span>&nbsp;<span class="op" id="4908712">!=</span>&nbsp;<span class="num" id="4908715">0</span>&nbsp;<span class="op" id="4908717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908723">j0</span>&nbsp;<span class="op" id="4908726">:=</span>&nbsp;<span class="op" id="4908729">(</span><span class="ident" id="4908730">y</span>&nbsp;<span class="op" id="4908732">-</span>&nbsp;<span class="ident" id="4908734">b</span><span class="op" id="4908735">.</span><span class="ident" id="4908736">Min</span><span class="op" id="4908739">.</span><span class="ident" id="4908740">Y</span><span class="op" id="4908741">)</span>&nbsp;<span class="op" id="4908743">*</span>&nbsp;<span class="ident" id="4908745">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908756">j1</span>&nbsp;<span class="op" id="4908759">:=</span>&nbsp;<span class="ident" id="4908762">j0</span>&nbsp;<span class="op" id="4908765">+</span>&nbsp;<span class="ident" id="4908767">b</span><span class="op" id="4908768">.</span><span class="ident" id="4908769">Dx</span><span class="op" id="4908771">(</span><span class="op" id="4908772">)</span><span class="op" id="4908773">*</span><span class="num" id="4908774">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908780">for</span>&nbsp;<span class="ident" id="4908784">j</span>&nbsp;<span class="op" id="4908786">:=</span>&nbsp;<span class="ident" id="4908789">j0</span><span class="op" id="4908791">;</span>&nbsp;<span class="ident" id="4908793">j</span>&nbsp;<span class="op" id="4908795">&lt;</span>&nbsp;<span class="ident" id="4908797">j1</span><span class="op" id="4908799">;</span>&nbsp;<span class="ident" id="4908801">j</span>&nbsp;<span class="op" id="4908803">+=</span>&nbsp;<span class="num" id="4908806">4</span>&nbsp;<span class="op" id="4908808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908815">cr0</span><span class="op" id="4908818">[</span><span class="ident" id="4908819">i</span><span class="op" id="4908820">+</span><span class="num" id="4908821">0</span><span class="op" id="4908822">]</span>&nbsp;<span class="op" id="4908824">=</span>&nbsp;<span class="ident" id="4908826">pix</span><span class="op" id="4908829">[</span><span class="ident" id="4908830">j</span><span class="op" id="4908831">+</span><span class="num" id="4908832">0</span><span class="op" id="4908833">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908840">cr0</span><span class="op" id="4908843">[</span><span class="ident" id="4908844">i</span><span class="op" id="4908845">+</span><span class="num" id="4908846">1</span><span class="op" id="4908847">]</span>&nbsp;<span class="op" id="4908849">=</span>&nbsp;<span class="ident" id="4908851">pix</span><span class="op" id="4908854">[</span><span class="ident" id="4908855">j</span><span class="op" id="4908856">+</span><span class="num" id="4908857">1</span><span class="op" id="4908858">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908865">cr0</span><span class="op" id="4908868">[</span><span class="ident" id="4908869">i</span><span class="op" id="4908870">+</span><span class="num" id="4908871">2</span><span class="op" id="4908872">]</span>&nbsp;<span class="op" id="4908874">=</span>&nbsp;<span class="ident" id="4908876">pix</span><span class="op" id="4908879">[</span><span class="ident" id="4908880">j</span><span class="op" id="4908881">+</span><span class="num" id="4908882">2</span><span class="op" id="4908883">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908890">i</span>&nbsp;<span class="op" id="4908892">+=</span>&nbsp;<span class="num" id="4908895">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908906">}</span>&nbsp;<span class="keyword" id="4908908">else</span>&nbsp;<span class="op" id="4908913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908919">for</span>&nbsp;<span class="ident" id="4908923">x</span>&nbsp;<span class="op" id="4908925">:=</span>&nbsp;<span class="ident" id="4908928">b</span><span class="op" id="4908929">.</span><span class="ident" id="4908930">Min</span><span class="op" id="4908933">.</span><span class="ident" id="4908934">X</span><span class="op" id="4908935">;</span>&nbsp;<span class="ident" id="4908937">x</span>&nbsp;<span class="op" id="4908939">&lt;</span>&nbsp;<span class="ident" id="4908941">b</span><span class="op" id="4908942">.</span><span class="ident" id="4908943">Max</span><span class="op" id="4908946">.</span><span class="ident" id="4908947">X</span><span class="op" id="4908948">;</span>&nbsp;<span class="ident" id="4908950">x</span><span class="op" id="4908951">++</span>&nbsp;<span class="op" id="4908954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908961">r</span><span class="op" id="4908962">,</span>&nbsp;<span class="ident" id="4908964">g</span><span class="op" id="4908965">,</span>&nbsp;<span class="ident" id="4908967">b</span><span class="op" id="4908968">,</span>&nbsp;<span class="ident" id="4908970">_</span>&nbsp;<span class="op" id="4908972">:=</span>&nbsp;<span class="ident" id="4908975">m</span><span class="op" id="4908976">.</span><span class="ident" id="4908977">At</span><span class="op" id="4908979">(</span><span class="ident" id="4908980">x</span><span class="op" id="4908981">,</span>&nbsp;<span class="ident" id="4908983">y</span><span class="op" id="4908984">)</span><span class="op" id="4908985">.</span><span class="ident" id="4908986">RGBA</span><span class="op" id="4908990">(</span><span class="op" id="4908991">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908998">cr0</span><span class="op" id="4909001">[</span><span class="ident" id="4909002">i</span><span class="op" id="4909003">+</span><span class="num" id="4909004">0</span><span class="op" id="4909005">]</span>&nbsp;<span class="op" id="4909007">=</span>&nbsp;<span class="builtintype" id="4909009">uint8</span><span class="op" id="4909014">(</span><span class="ident" id="4909015">r</span>&nbsp;<span class="op" id="4909017">&gt;&gt;</span>&nbsp;<span class="num" id="4909020">8</span><span class="op" id="4909021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909028">cr0</span><span class="op" id="4909031">[</span><span class="ident" id="4909032">i</span><span class="op" id="4909033">+</span><span class="num" id="4909034">1</span><span class="op" id="4909035">]</span>&nbsp;<span class="op" id="4909037">=</span>&nbsp;<span class="builtintype" id="4909039">uint8</span><span class="op" id="4909044">(</span><span class="ident" id="4909045">g</span>&nbsp;<span class="op" id="4909047">&gt;&gt;</span>&nbsp;<span class="num" id="4909050">8</span><span class="op" id="4909051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909058">cr0</span><span class="op" id="4909061">[</span><span class="ident" id="4909062">i</span><span class="op" id="4909063">+</span><span class="num" id="4909064">2</span><span class="op" id="4909065">]</span>&nbsp;<span class="op" id="4909067">=</span>&nbsp;<span class="builtintype" id="4909069">uint8</span><span class="op" id="4909074">(</span><span class="ident" id="4909075">b</span>&nbsp;<span class="op" id="4909077">&gt;&gt;</span>&nbsp;<span class="num" id="4909080">8</span><span class="op" id="4909081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909088">i</span>&nbsp;<span class="op" id="4909090">+=</span>&nbsp;<span class="num" id="4909093">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909099">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909108">case</span>&nbsp;<span class="ident" id="4909113">cbP8</span><span class="op" id="4909117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909122">if</span>&nbsp;<span class="ident" id="4909125">paletted</span>&nbsp;<span class="op" id="4909134">!=</span>&nbsp;<span class="ident" id="4909137">nil</span>&nbsp;<span class="op" id="4909141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909147">offset</span>&nbsp;<span class="op" id="4909154">:=</span>&nbsp;<span class="op" id="4909157">(</span><span class="ident" id="4909158">y</span>&nbsp;<span class="op" id="4909160">-</span>&nbsp;<span class="ident" id="4909162">b</span><span class="op" id="4909163">.</span><span class="ident" id="4909164">Min</span><span class="op" id="4909167">.</span><span class="ident" id="4909168">Y</span><span class="op" id="4909169">)</span>&nbsp;<span class="op" id="4909171">*</span>&nbsp;<span class="ident" id="4909173">paletted</span><span class="op" id="4909181">.</span><span class="ident" id="4909182">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4909193">copy</span><span class="op" id="4909197">(</span><span class="ident" id="4909198">cr</span><span class="op" id="4909200">[</span><span class="num" id="4909201">0</span><span class="op" id="4909202">]</span><span class="op" id="4909203">[</span><span class="num" id="4909204">1</span><span class="op" id="4909205">:</span><span class="op" id="4909206">]</span><span class="op" id="4909207">,</span>&nbsp;<span class="ident" id="4909209">paletted</span><span class="op" id="4909217">.</span><span class="ident" id="4909218">Pix</span><span class="op" id="4909221">[</span><span class="ident" id="4909222">offset</span><span class="op" id="4909228">:</span><span class="ident" id="4909229">offset</span><span class="op" id="4909235">+</span><span class="ident" id="4909236">b</span><span class="op" id="4909237">.</span><span class="ident" id="4909238">Dx</span><span class="op" id="4909240">(</span><span class="op" id="4909241">)</span><span class="op" id="4909242">]</span><span class="op" id="4909243">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909248">}</span>&nbsp;<span class="keyword" id="4909250">else</span>&nbsp;<span class="op" id="4909255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909261">pi</span>&nbsp;<span class="op" id="4909264">:=</span>&nbsp;<span class="ident" id="4909267">m</span><span class="op" id="4909268">.</span><span class="op" id="4909269">(</span><span class="ident" id="4909270">image</span><span class="op" id="4909275">.</span><span class="ident" id="4909276">PalettedImage</span><span class="op" id="4909289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909295">for</span>&nbsp;<span class="ident" id="4909299">x</span>&nbsp;<span class="op" id="4909301">:=</span>&nbsp;<span class="ident" id="4909304">b</span><span class="op" id="4909305">.</span><span class="ident" id="4909306">Min</span><span class="op" id="4909309">.</span><span class="ident" id="4909310">X</span><span class="op" id="4909311">;</span>&nbsp;<span class="ident" id="4909313">x</span>&nbsp;<span class="op" id="4909315">&lt;</span>&nbsp;<span class="ident" id="4909317">b</span><span class="op" id="4909318">.</span><span class="ident" id="4909319">Max</span><span class="op" id="4909322">.</span><span class="ident" id="4909323">X</span><span class="op" id="4909324">;</span>&nbsp;<span class="ident" id="4909326">x</span><span class="op" id="4909327">++</span>&nbsp;<span class="op" id="4909330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909337">cr</span><span class="op" id="4909339">[</span><span class="num" id="4909340">0</span><span class="op" id="4909341">]</span><span class="op" id="4909342">[</span><span class="ident" id="4909343">i</span><span class="op" id="4909344">]</span>&nbsp;<span class="op" id="4909346">=</span>&nbsp;<span class="ident" id="4909348">pi</span><span class="op" id="4909350">.</span><span class="ident" id="4909351">ColorIndexAt</span><span class="op" id="4909363">(</span><span class="ident" id="4909364">x</span><span class="op" id="4909365">,</span>&nbsp;<span class="ident" id="4909367">y</span><span class="op" id="4909368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909375">i</span>&nbsp;<span class="op" id="4909377">+=</span>&nbsp;<span class="num" id="4909380">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909395">case</span>&nbsp;<span class="ident" id="4909400">cbTCA8</span><span class="op" id="4909406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909411">if</span>&nbsp;<span class="ident" id="4909414">nrgba</span>&nbsp;<span class="op" id="4909420">!=</span>&nbsp;<span class="ident" id="4909423">nil</span>&nbsp;<span class="op" id="4909427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909433">offset</span>&nbsp;<span class="op" id="4909440">:=</span>&nbsp;<span class="op" id="4909443">(</span><span class="ident" id="4909444">y</span>&nbsp;<span class="op" id="4909446">-</span>&nbsp;<span class="ident" id="4909448">b</span><span class="op" id="4909449">.</span><span class="ident" id="4909450">Min</span><span class="op" id="4909453">.</span><span class="ident" id="4909454">Y</span><span class="op" id="4909455">)</span>&nbsp;<span class="op" id="4909457">*</span>&nbsp;<span class="ident" id="4909459">nrgba</span><span class="op" id="4909464">.</span><span class="ident" id="4909465">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4909476">copy</span><span class="op" id="4909480">(</span><span class="ident" id="4909481">cr</span><span class="op" id="4909483">[</span><span class="num" id="4909484">0</span><span class="op" id="4909485">]</span><span class="op" id="4909486">[</span><span class="num" id="4909487">1</span><span class="op" id="4909488">:</span><span class="op" id="4909489">]</span><span class="op" id="4909490">,</span>&nbsp;<span class="ident" id="4909492">nrgba</span><span class="op" id="4909497">.</span><span class="ident" id="4909498">Pix</span><span class="op" id="4909501">[</span><span class="ident" id="4909502">offset</span><span class="op" id="4909508">:</span><span class="ident" id="4909509">offset</span><span class="op" id="4909515">+</span><span class="ident" id="4909516">b</span><span class="op" id="4909517">.</span><span class="ident" id="4909518">Dx</span><span class="op" id="4909520">(</span><span class="op" id="4909521">)</span><span class="op" id="4909522">*</span><span class="num" id="4909523">4</span><span class="op" id="4909524">]</span><span class="op" id="4909525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909530">}</span>&nbsp;<span class="keyword" id="4909532">else</span>&nbsp;<span class="op" id="4909537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4909543">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909640">for</span>&nbsp;<span class="ident" id="4909644">x</span>&nbsp;<span class="op" id="4909646">:=</span>&nbsp;<span class="ident" id="4909649">b</span><span class="op" id="4909650">.</span><span class="ident" id="4909651">Min</span><span class="op" id="4909654">.</span><span class="ident" id="4909655">X</span><span class="op" id="4909656">;</span>&nbsp;<span class="ident" id="4909658">x</span>&nbsp;<span class="op" id="4909660">&lt;</span>&nbsp;<span class="ident" id="4909662">b</span><span class="op" id="4909663">.</span><span class="ident" id="4909664">Max</span><span class="op" id="4909667">.</span><span class="ident" id="4909668">X</span><span class="op" id="4909669">;</span>&nbsp;<span class="ident" id="4909671">x</span><span class="op" id="4909672">++</span>&nbsp;<span class="op" id="4909675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909682">c</span>&nbsp;<span class="op" id="4909684">:=</span>&nbsp;<span class="ident" id="4909687">color</span><span class="op" id="4909692">.</span><span class="ident" id="4909693">NRGBAModel</span><span class="op" id="4909703">.</span><span class="ident" id="4909704">Convert</span><span class="op" id="4909711">(</span><span class="ident" id="4909712">m</span><span class="op" id="4909713">.</span><span class="ident" id="4909714">At</span><span class="op" id="4909716">(</span><span class="ident" id="4909717">x</span><span class="op" id="4909718">,</span>&nbsp;<span class="ident" id="4909720">y</span><span class="op" id="4909721">)</span><span class="op" id="4909722">)</span><span class="op" id="4909723">.</span><span class="op" id="4909724">(</span><span class="ident" id="4909725">color</span><span class="op" id="4909730">.</span><span class="ident" id="4909731">NRGBA</span><span class="op" id="4909736">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909743">cr</span><span class="op" id="4909745">[</span><span class="num" id="4909746">0</span><span class="op" id="4909747">]</span><span class="op" id="4909748">[</span><span class="ident" id="4909749">i</span><span class="op" id="4909750">+</span><span class="num" id="4909751">0</span><span class="op" id="4909752">]</span>&nbsp;<span class="op" id="4909754">=</span>&nbsp;<span class="ident" id="4909756">c</span><span class="op" id="4909757">.</span><span class="ident" id="4909758">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909765">cr</span><span class="op" id="4909767">[</span><span class="num" id="4909768">0</span><span class="op" id="4909769">]</span><span class="op" id="4909770">[</span><span class="ident" id="4909771">i</span><span class="op" id="4909772">+</span><span class="num" id="4909773">1</span><span class="op" id="4909774">]</span>&nbsp;<span class="op" id="4909776">=</span>&nbsp;<span class="ident" id="4909778">c</span><span class="op" id="4909779">.</span><span class="ident" id="4909780">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909787">cr</span><span class="op" id="4909789">[</span><span class="num" id="4909790">0</span><span class="op" id="4909791">]</span><span class="op" id="4909792">[</span><span class="ident" id="4909793">i</span><span class="op" id="4909794">+</span><span class="num" id="4909795">2</span><span class="op" id="4909796">]</span>&nbsp;<span class="op" id="4909798">=</span>&nbsp;<span class="ident" id="4909800">c</span><span class="op" id="4909801">.</span><span class="ident" id="4909802">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909809">cr</span><span class="op" id="4909811">[</span><span class="num" id="4909812">0</span><span class="op" id="4909813">]</span><span class="op" id="4909814">[</span><span class="ident" id="4909815">i</span><span class="op" id="4909816">+</span><span class="num" id="4909817">3</span><span class="op" id="4909818">]</span>&nbsp;<span class="op" id="4909820">=</span>&nbsp;<span class="ident" id="4909822">c</span><span class="op" id="4909823">.</span><span class="ident" id="4909824">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909831">i</span>&nbsp;<span class="op" id="4909833">+=</span>&nbsp;<span class="num" id="4909836">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909851">case</span>&nbsp;<span class="ident" id="4909856">cbG16</span><span class="op" id="4909861">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909866">for</span>&nbsp;<span class="ident" id="4909870">x</span>&nbsp;<span class="op" id="4909872">:=</span>&nbsp;<span class="ident" id="4909875">b</span><span class="op" id="4909876">.</span><span class="ident" id="4909877">Min</span><span class="op" id="4909880">.</span><span class="ident" id="4909881">X</span><span class="op" id="4909882">;</span>&nbsp;<span class="ident" id="4909884">x</span>&nbsp;<span class="op" id="4909886">&lt;</span>&nbsp;<span class="ident" id="4909888">b</span><span class="op" id="4909889">.</span><span class="ident" id="4909890">Max</span><span class="op" id="4909893">.</span><span class="ident" id="4909894">X</span><span class="op" id="4909895">;</span>&nbsp;<span class="ident" id="4909897">x</span><span class="op" id="4909898">++</span>&nbsp;<span class="op" id="4909901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909907">c</span>&nbsp;<span class="op" id="4909909">:=</span>&nbsp;<span class="ident" id="4909912">color</span><span class="op" id="4909917">.</span><span class="ident" id="4909918">Gray16Model</span><span class="op" id="4909929">.</span><span class="ident" id="4909930">Convert</span><span class="op" id="4909937">(</span><span class="ident" id="4909938">m</span><span class="op" id="4909939">.</span><span class="ident" id="4909940">At</span><span class="op" id="4909942">(</span><span class="ident" id="4909943">x</span><span class="op" id="4909944">,</span>&nbsp;<span class="ident" id="4909946">y</span><span class="op" id="4909947">)</span><span class="op" id="4909948">)</span><span class="op" id="4909949">.</span><span class="op" id="4909950">(</span><span class="ident" id="4909951">color</span><span class="op" id="4909956">.</span><span class="ident" id="4909957">Gray16</span><span class="op" id="4909963">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909969">cr</span><span class="op" id="4909971">[</span><span class="num" id="4909972">0</span><span class="op" id="4909973">]</span><span class="op" id="4909974">[</span><span class="ident" id="4909975">i</span><span class="op" id="4909976">+</span><span class="num" id="4909977">0</span><span class="op" id="4909978">]</span>&nbsp;<span class="op" id="4909980">=</span>&nbsp;<span class="builtintype" id="4909982">uint8</span><span class="op" id="4909987">(</span><span class="ident" id="4909988">c</span><span class="op" id="4909989">.</span><span class="ident" id="4909990">Y</span>&nbsp;<span class="op" id="4909992">&gt;&gt;</span>&nbsp;<span class="num" id="4909995">8</span><span class="op" id="4909996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910002">cr</span><span class="op" id="4910004">[</span><span class="num" id="4910005">0</span><span class="op" id="4910006">]</span><span class="op" id="4910007">[</span><span class="ident" id="4910008">i</span><span class="op" id="4910009">+</span><span class="num" id="4910010">1</span><span class="op" id="4910011">]</span>&nbsp;<span class="op" id="4910013">=</span>&nbsp;<span class="builtintype" id="4910015">uint8</span><span class="op" id="4910020">(</span><span class="ident" id="4910021">c</span><span class="op" id="4910022">.</span><span class="ident" id="4910023">Y</span><span class="op" id="4910024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910030">i</span>&nbsp;<span class="op" id="4910032">+=</span>&nbsp;<span class="num" id="4910035">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910044">case</span>&nbsp;<span class="ident" id="4910049">cbTC16</span><span class="op" id="4910055">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910060">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910132">for</span>&nbsp;<span class="ident" id="4910136">x</span>&nbsp;<span class="op" id="4910138">:=</span>&nbsp;<span class="ident" id="4910141">b</span><span class="op" id="4910142">.</span><span class="ident" id="4910143">Min</span><span class="op" id="4910146">.</span><span class="ident" id="4910147">X</span><span class="op" id="4910148">;</span>&nbsp;<span class="ident" id="4910150">x</span>&nbsp;<span class="op" id="4910152">&lt;</span>&nbsp;<span class="ident" id="4910154">b</span><span class="op" id="4910155">.</span><span class="ident" id="4910156">Max</span><span class="op" id="4910159">.</span><span class="ident" id="4910160">X</span><span class="op" id="4910161">;</span>&nbsp;<span class="ident" id="4910163">x</span><span class="op" id="4910164">++</span>&nbsp;<span class="op" id="4910167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910173">r</span><span class="op" id="4910174">,</span>&nbsp;<span class="ident" id="4910176">g</span><span class="op" id="4910177">,</span>&nbsp;<span class="ident" id="4910179">b</span><span class="op" id="4910180">,</span>&nbsp;<span class="ident" id="4910182">_</span>&nbsp;<span class="op" id="4910184">:=</span>&nbsp;<span class="ident" id="4910187">m</span><span class="op" id="4910188">.</span><span class="ident" id="4910189">At</span><span class="op" id="4910191">(</span><span class="ident" id="4910192">x</span><span class="op" id="4910193">,</span>&nbsp;<span class="ident" id="4910195">y</span><span class="op" id="4910196">)</span><span class="op" id="4910197">.</span><span class="ident" id="4910198">RGBA</span><span class="op" id="4910202">(</span><span class="op" id="4910203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910209">cr</span><span class="op" id="4910211">[</span><span class="num" id="4910212">0</span><span class="op" id="4910213">]</span><span class="op" id="4910214">[</span><span class="ident" id="4910215">i</span><span class="op" id="4910216">+</span><span class="num" id="4910217">0</span><span class="op" id="4910218">]</span>&nbsp;<span class="op" id="4910220">=</span>&nbsp;<span class="builtintype" id="4910222">uint8</span><span class="op" id="4910227">(</span><span class="ident" id="4910228">r</span>&nbsp;<span class="op" id="4910230">&gt;&gt;</span>&nbsp;<span class="num" id="4910233">8</span><span class="op" id="4910234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910240">cr</span><span class="op" id="4910242">[</span><span class="num" id="4910243">0</span><span class="op" id="4910244">]</span><span class="op" id="4910245">[</span><span class="ident" id="4910246">i</span><span class="op" id="4910247">+</span><span class="num" id="4910248">1</span><span class="op" id="4910249">]</span>&nbsp;<span class="op" id="4910251">=</span>&nbsp;<span class="builtintype" id="4910253">uint8</span><span class="op" id="4910258">(</span><span class="ident" id="4910259">r</span><span class="op" id="4910260">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910266">cr</span><span class="op" id="4910268">[</span><span class="num" id="4910269">0</span><span class="op" id="4910270">]</span><span class="op" id="4910271">[</span><span class="ident" id="4910272">i</span><span class="op" id="4910273">+</span><span class="num" id="4910274">2</span><span class="op" id="4910275">]</span>&nbsp;<span class="op" id="4910277">=</span>&nbsp;<span class="builtintype" id="4910279">uint8</span><span class="op" id="4910284">(</span><span class="ident" id="4910285">g</span>&nbsp;<span class="op" id="4910287">&gt;&gt;</span>&nbsp;<span class="num" id="4910290">8</span><span class="op" id="4910291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910297">cr</span><span class="op" id="4910299">[</span><span class="num" id="4910300">0</span><span class="op" id="4910301">]</span><span class="op" id="4910302">[</span><span class="ident" id="4910303">i</span><span class="op" id="4910304">+</span><span class="num" id="4910305">3</span><span class="op" id="4910306">]</span>&nbsp;<span class="op" id="4910308">=</span>&nbsp;<span class="builtintype" id="4910310">uint8</span><span class="op" id="4910315">(</span><span class="ident" id="4910316">g</span><span class="op" id="4910317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910323">cr</span><span class="op" id="4910325">[</span><span class="num" id="4910326">0</span><span class="op" id="4910327">]</span><span class="op" id="4910328">[</span><span class="ident" id="4910329">i</span><span class="op" id="4910330">+</span><span class="num" id="4910331">4</span><span class="op" id="4910332">]</span>&nbsp;<span class="op" id="4910334">=</span>&nbsp;<span class="builtintype" id="4910336">uint8</span><span class="op" id="4910341">(</span><span class="ident" id="4910342">b</span>&nbsp;<span class="op" id="4910344">&gt;&gt;</span>&nbsp;<span class="num" id="4910347">8</span><span class="op" id="4910348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910354">cr</span><span class="op" id="4910356">[</span><span class="num" id="4910357">0</span><span class="op" id="4910358">]</span><span class="op" id="4910359">[</span><span class="ident" id="4910360">i</span><span class="op" id="4910361">+</span><span class="num" id="4910362">5</span><span class="op" id="4910363">]</span>&nbsp;<span class="op" id="4910365">=</span>&nbsp;<span class="builtintype" id="4910367">uint8</span><span class="op" id="4910372">(</span><span class="ident" id="4910373">b</span><span class="op" id="4910374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910380">i</span>&nbsp;<span class="op" id="4910382">+=</span>&nbsp;<span class="num" id="4910385">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910394">case</span>&nbsp;<span class="ident" id="4910399">cbTCA16</span><span class="op" id="4910406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910411">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910507">for</span>&nbsp;<span class="ident" id="4910511">x</span>&nbsp;<span class="op" id="4910513">:=</span>&nbsp;<span class="ident" id="4910516">b</span><span class="op" id="4910517">.</span><span class="ident" id="4910518">Min</span><span class="op" id="4910521">.</span><span class="ident" id="4910522">X</span><span class="op" id="4910523">;</span>&nbsp;<span class="ident" id="4910525">x</span>&nbsp;<span class="op" id="4910527">&lt;</span>&nbsp;<span class="ident" id="4910529">b</span><span class="op" id="4910530">.</span><span class="ident" id="4910531">Max</span><span class="op" id="4910534">.</span><span class="ident" id="4910535">X</span><span class="op" id="4910536">;</span>&nbsp;<span class="ident" id="4910538">x</span><span class="op" id="4910539">++</span>&nbsp;<span class="op" id="4910542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910548">c</span>&nbsp;<span class="op" id="4910550">:=</span>&nbsp;<span class="ident" id="4910553">color</span><span class="op" id="4910558">.</span><span class="ident" id="4910559">NRGBA64Model</span><span class="op" id="4910571">.</span><span class="ident" id="4910572">Convert</span><span class="op" id="4910579">(</span><span class="ident" id="4910580">m</span><span class="op" id="4910581">.</span><span class="ident" id="4910582">At</span><span class="op" id="4910584">(</span><span class="ident" id="4910585">x</span><span class="op" id="4910586">,</span>&nbsp;<span class="ident" id="4910588">y</span><span class="op" id="4910589">)</span><span class="op" id="4910590">)</span><span class="op" id="4910591">.</span><span class="op" id="4910592">(</span><span class="ident" id="4910593">color</span><span class="op" id="4910598">.</span><span class="ident" id="4910599">NRGBA64</span><span class="op" id="4910606">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910612">cr</span><span class="op" id="4910614">[</span><span class="num" id="4910615">0</span><span class="op" id="4910616">]</span><span class="op" id="4910617">[</span><span class="ident" id="4910618">i</span><span class="op" id="4910619">+</span><span class="num" id="4910620">0</span><span class="op" id="4910621">]</span>&nbsp;<span class="op" id="4910623">=</span>&nbsp;<span class="builtintype" id="4910625">uint8</span><span class="op" id="4910630">(</span><span class="ident" id="4910631">c</span><span class="op" id="4910632">.</span><span class="ident" id="4910633">R</span>&nbsp;<span class="op" id="4910635">&gt;&gt;</span>&nbsp;<span class="num" id="4910638">8</span><span class="op" id="4910639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910645">cr</span><span class="op" id="4910647">[</span><span class="num" id="4910648">0</span><span class="op" id="4910649">]</span><span class="op" id="4910650">[</span><span class="ident" id="4910651">i</span><span class="op" id="4910652">+</span><span class="num" id="4910653">1</span><span class="op" id="4910654">]</span>&nbsp;<span class="op" id="4910656">=</span>&nbsp;<span class="builtintype" id="4910658">uint8</span><span class="op" id="4910663">(</span><span class="ident" id="4910664">c</span><span class="op" id="4910665">.</span><span class="ident" id="4910666">R</span><span class="op" id="4910667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910673">cr</span><span class="op" id="4910675">[</span><span class="num" id="4910676">0</span><span class="op" id="4910677">]</span><span class="op" id="4910678">[</span><span class="ident" id="4910679">i</span><span class="op" id="4910680">+</span><span class="num" id="4910681">2</span><span class="op" id="4910682">]</span>&nbsp;<span class="op" id="4910684">=</span>&nbsp;<span class="builtintype" id="4910686">uint8</span><span class="op" id="4910691">(</span><span class="ident" id="4910692">c</span><span class="op" id="4910693">.</span><span class="ident" id="4910694">G</span>&nbsp;<span class="op" id="4910696">&gt;&gt;</span>&nbsp;<span class="num" id="4910699">8</span><span class="op" id="4910700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910706">cr</span><span class="op" id="4910708">[</span><span class="num" id="4910709">0</span><span class="op" id="4910710">]</span><span class="op" id="4910711">[</span><span class="ident" id="4910712">i</span><span class="op" id="4910713">+</span><span class="num" id="4910714">3</span><span class="op" id="4910715">]</span>&nbsp;<span class="op" id="4910717">=</span>&nbsp;<span class="builtintype" id="4910719">uint8</span><span class="op" id="4910724">(</span><span class="ident" id="4910725">c</span><span class="op" id="4910726">.</span><span class="ident" id="4910727">G</span><span class="op" id="4910728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910734">cr</span><span class="op" id="4910736">[</span><span class="num" id="4910737">0</span><span class="op" id="4910738">]</span><span class="op" id="4910739">[</span><span class="ident" id="4910740">i</span><span class="op" id="4910741">+</span><span class="num" id="4910742">4</span><span class="op" id="4910743">]</span>&nbsp;<span class="op" id="4910745">=</span>&nbsp;<span class="builtintype" id="4910747">uint8</span><span class="op" id="4910752">(</span><span class="ident" id="4910753">c</span><span class="op" id="4910754">.</span><span class="ident" id="4910755">B</span>&nbsp;<span class="op" id="4910757">&gt;&gt;</span>&nbsp;<span class="num" id="4910760">8</span><span class="op" id="4910761">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910767">cr</span><span class="op" id="4910769">[</span><span class="num" id="4910770">0</span><span class="op" id="4910771">]</span><span class="op" id="4910772">[</span><span class="ident" id="4910773">i</span><span class="op" id="4910774">+</span><span class="num" id="4910775">5</span><span class="op" id="4910776">]</span>&nbsp;<span class="op" id="4910778">=</span>&nbsp;<span class="builtintype" id="4910780">uint8</span><span class="op" id="4910785">(</span><span class="ident" id="4910786">c</span><span class="op" id="4910787">.</span><span class="ident" id="4910788">B</span><span class="op" id="4910789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910795">cr</span><span class="op" id="4910797">[</span><span class="num" id="4910798">0</span><span class="op" id="4910799">]</span><span class="op" id="4910800">[</span><span class="ident" id="4910801">i</span><span class="op" id="4910802">+</span><span class="num" id="4910803">6</span><span class="op" id="4910804">]</span>&nbsp;<span class="op" id="4910806">=</span>&nbsp;<span class="builtintype" id="4910808">uint8</span><span class="op" id="4910813">(</span><span class="ident" id="4910814">c</span><span class="op" id="4910815">.</span><span class="ident" id="4910816">A</span>&nbsp;<span class="op" id="4910818">&gt;&gt;</span>&nbsp;<span class="num" id="4910821">8</span><span class="op" id="4910822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910828">cr</span><span class="op" id="4910830">[</span><span class="num" id="4910831">0</span><span class="op" id="4910832">]</span><span class="op" id="4910833">[</span><span class="ident" id="4910834">i</span><span class="op" id="4910835">+</span><span class="num" id="4910836">7</span><span class="op" id="4910837">]</span>&nbsp;<span class="op" id="4910839">=</span>&nbsp;<span class="builtintype" id="4910841">uint8</span><span class="op" id="4910846">(</span><span class="ident" id="4910847">c</span><span class="op" id="4910848">.</span><span class="ident" id="4910849">A</span><span class="op" id="4910850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910856">i</span>&nbsp;<span class="op" id="4910858">+=</span>&nbsp;<span class="num" id="4910861">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910866">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910875">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910898">f</span>&nbsp;<span class="op" id="4910900">:=</span>&nbsp;<span class="ident" id="4910903">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910912">if</span>&nbsp;<span class="ident" id="4910915">level</span>&nbsp;<span class="op" id="4910921">!=</span>&nbsp;<span class="ident" id="4910924">zlib</span><span class="op" id="4910928">.</span><span class="ident" id="4910929">NoCompression</span>&nbsp;<span class="op" id="4910943">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910948">f</span>&nbsp;<span class="op" id="4910950">=</span>&nbsp;<span class="ident" id="4910952">filter</span><span class="op" id="4910958">(</span><span class="op" id="4910959">&amp;</span><span class="ident" id="4910960">cr</span><span class="op" id="4910962">,</span>&nbsp;<span class="ident" id="4910964">pr</span><span class="op" id="4910966">,</span>&nbsp;<span class="ident" id="4910968">bpp</span><span class="op" id="4910971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910980">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911013">if</span>&nbsp;<span class="ident" id="4911016">_</span><span class="op" id="4911017">,</span>&nbsp;<span class="ident" id="4911019">err</span>&nbsp;<span class="op" id="4911023">:=</span>&nbsp;<span class="ident" id="4911026">zw</span><span class="op" id="4911028">.</span><span class="ident" id="4911029">Write</span><span class="op" id="4911034">(</span><span class="ident" id="4911035">cr</span><span class="op" id="4911037">[</span><span class="ident" id="4911038">f</span><span class="op" id="4911039">]</span><span class="op" id="4911040">)</span><span class="op" id="4911041">;</span>&nbsp;<span class="ident" id="4911043">err</span>&nbsp;<span class="op" id="4911047">!=</span>&nbsp;<span class="ident" id="4911050">nil</span>&nbsp;<span class="op" id="4911054">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911059">return</span>&nbsp;<span class="ident" id="4911066">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911077">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911133">pr</span><span class="op" id="4911135">,</span>&nbsp;<span class="ident" id="4911137">cr</span><span class="op" id="4911139">[</span><span class="num" id="4911140">0</span><span class="op" id="4911141">]</span>&nbsp;<span class="op" id="4911143">=</span>&nbsp;<span class="ident" id="4911145">cr</span><span class="op" id="4911147">[</span><span class="num" id="4911148">0</span><span class="op" id="4911149">]</span><span class="op" id="4911150">,</span>&nbsp;<span class="ident" id="4911152">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911159">return</span>&nbsp;<span class="ident" id="4911166">nil</span><br>
<span class="lineno"></span><span class="op" id="4911170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4911173">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="4911232">func</span>&nbsp;<span class="op" id="4911237">(</span><span class="ident" id="4911238">e</span>&nbsp;<span class="op" id="4911240">*</span><span class="ident" id="4911241">encoder</span><span class="op" id="4911248">)</span>&nbsp;<span class="ident" id="4911250">writeIDATs</span><span class="op" id="4911260">(</span><span class="op" id="4911261">)</span>&nbsp;<span class="op" id="4911263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911266">if</span>&nbsp;<span class="ident" id="4911269">e</span><span class="op" id="4911270">.</span><span class="ident" id="4911271">err</span>&nbsp;<span class="op" id="4911275">!=</span>&nbsp;<span class="ident" id="4911278">nil</span>&nbsp;<span class="op" id="4911282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911286">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911297">var</span>&nbsp;<span class="ident" id="4911301">bw</span>&nbsp;<span class="op" id="4911304">*</span><span class="ident" id="4911305">bufio</span><span class="op" id="4911310">.</span><span class="ident" id="4911311">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911319">bw</span>&nbsp;<span class="op" id="4911322">=</span>&nbsp;<span class="ident" id="4911324">bufio</span><span class="op" id="4911329">.</span><span class="ident" id="4911330">NewWriterSize</span><span class="op" id="4911343">(</span><span class="ident" id="4911344">e</span><span class="op" id="4911345">,</span>&nbsp;<span class="num" id="4911347">1</span><span class="op" id="4911348">&lt;&lt;</span><span class="num" id="4911350">15</span><span class="op" id="4911352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911355">e</span><span class="op" id="4911356">.</span><span class="ident" id="4911357">err</span>&nbsp;<span class="op" id="4911361">=</span>&nbsp;<span class="ident" id="4911363">writeImage</span><span class="op" id="4911373">(</span><span class="ident" id="4911374">bw</span><span class="op" id="4911376">,</span>&nbsp;<span class="ident" id="4911378">e</span><span class="op" id="4911379">.</span><span class="ident" id="4911380">m</span><span class="op" id="4911381">,</span>&nbsp;<span class="ident" id="4911383">e</span><span class="op" id="4911384">.</span><span class="ident" id="4911385">cb</span><span class="op" id="4911387">,</span>&nbsp;<span class="ident" id="4911389">levelToZlib</span><span class="op" id="4911400">(</span><span class="ident" id="4911401">e</span><span class="op" id="4911402">.</span><span class="ident" id="4911403">enc</span><span class="op" id="4911406">.</span><span class="ident" id="4911407">CompressionLevel</span><span class="op" id="4911423">)</span><span class="op" id="4911424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911427">if</span>&nbsp;<span class="ident" id="4911430">e</span><span class="op" id="4911431">.</span><span class="ident" id="4911432">err</span>&nbsp;<span class="op" id="4911436">!=</span>&nbsp;<span class="ident" id="4911439">nil</span>&nbsp;<span class="op" id="4911443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911447">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911455">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911458">e</span><span class="op" id="4911459">.</span><span class="ident" id="4911460">err</span>&nbsp;<span class="op" id="4911464">=</span>&nbsp;<span class="ident" id="4911466">bw</span><span class="op" id="4911468">.</span><span class="ident" id="4911469">Flush</span><span class="op" id="4911474">(</span><span class="op" id="4911475">)</span><br>
<span class="lineno"></span><span class="op" id="4911477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4911480">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4911543">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="4911606">func</span>&nbsp;<span class="ident" id="4911611">levelToZlib</span><span class="op" id="4911622">(</span><span class="ident" id="4911623">l</span>&nbsp;<span class="ident" id="4911625">CompressionLevel</span><span class="op" id="4911641">)</span>&nbsp;<span class="builtintype" id="4911643">int</span>&nbsp;<span class="op" id="4911647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911650">switch</span>&nbsp;<span class="ident" id="4911657">l</span>&nbsp;<span class="op" id="4911659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911662">case</span>&nbsp;<span class="ident" id="4911667">DefaultCompression</span><span class="op" id="4911685">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911689">return</span>&nbsp;<span class="ident" id="4911696">zlib</span><span class="op" id="4911700">.</span><span class="ident" id="4911701">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911721">case</span>&nbsp;<span class="ident" id="4911726">NoCompression</span><span class="op" id="4911739">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911743">return</span>&nbsp;<span class="ident" id="4911750">zlib</span><span class="op" id="4911754">.</span><span class="ident" id="4911755">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911770">case</span>&nbsp;<span class="ident" id="4911775">BestSpeed</span><span class="op" id="4911784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911788">return</span>&nbsp;<span class="ident" id="4911795">zlib</span><span class="op" id="4911799">.</span><span class="ident" id="4911800">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911811">case</span>&nbsp;<span class="ident" id="4911816">BestCompression</span><span class="op" id="4911831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911835">return</span>&nbsp;<span class="ident" id="4911842">zlib</span><span class="op" id="4911846">.</span><span class="ident" id="4911847">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911864">default</span><span class="op" id="4911871">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911875">return</span>&nbsp;<span class="ident" id="4911882">zlib</span><span class="op" id="4911886">.</span><span class="ident" id="4911887">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911907">}</span><br>
<span class="lineno"></span><span class="op" id="4911909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="4911912">func</span>&nbsp;<span class="op" id="4911917">(</span><span class="ident" id="4911918">e</span>&nbsp;<span class="op" id="4911920">*</span><span class="ident" id="4911921">encoder</span><span class="op" id="4911928">)</span>&nbsp;<span class="ident" id="4911930">writeIEND</span><span class="op" id="4911939">(</span><span class="op" id="4911940">)</span>&nbsp;<span class="op" id="4911942">{</span>&nbsp;<span class="ident" id="4911944">e</span><span class="op" id="4911945">.</span><span class="ident" id="4911946">writeChunk</span><span class="op" id="4911956">(</span><span class="ident" id="4911957">nil</span><span class="op" id="4911960">,</span>&nbsp;<span class="string" id="4911962">&#34;IEND&#34;</span><span class="op" id="4911968">)</span>&nbsp;<span class="op" id="4911970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4911973">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4912039">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="4912113">func</span>&nbsp;<span class="ident" id="4912118">Encode</span><span class="op" id="4912124">(</span><span class="ident" id="4912125">w</span>&nbsp;<span class="ident" id="4912127">io</span><span class="op" id="4912129">.</span><span class="ident" id="4912130">Writer</span><span class="op" id="4912136">,</span>&nbsp;<span class="ident" id="4912138">m</span>&nbsp;<span class="ident" id="4912140">image</span><span class="op" id="4912145">.</span><span class="ident" id="4912146">Image</span><span class="op" id="4912151">)</span>&nbsp;<span class="builtintype" id="4912153">error</span>&nbsp;<span class="op" id="4912159">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912162">var</span>&nbsp;<span class="ident" id="4912166">e</span>&nbsp;<span class="ident" id="4912168">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912177">return</span>&nbsp;<span class="ident" id="4912184">e</span><span class="op" id="4912185">.</span><span class="ident" id="4912186">Encode</span><span class="op" id="4912192">(</span><span class="ident" id="4912193">w</span><span class="op" id="4912194">,</span>&nbsp;<span class="ident" id="4912196">m</span><span class="op" id="4912197">)</span><br>
<span class="lineno"></span><span class="op" id="4912199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4912202">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="4912251">func</span>&nbsp;<span class="op" id="4912256">(</span><span class="ident" id="4912257">enc</span>&nbsp;<span class="op" id="4912261">*</span><span class="ident" id="4912262">Encoder</span><span class="op" id="4912269">)</span>&nbsp;<span class="ident" id="4912271">Encode</span><span class="op" id="4912277">(</span><span class="ident" id="4912278">w</span>&nbsp;<span class="ident" id="4912280">io</span><span class="op" id="4912282">.</span><span class="ident" id="4912283">Writer</span><span class="op" id="4912289">,</span>&nbsp;<span class="ident" id="4912291">m</span>&nbsp;<span class="ident" id="4912293">image</span><span class="op" id="4912298">.</span><span class="ident" id="4912299">Image</span><span class="op" id="4912304">)</span>&nbsp;<span class="builtintype" id="4912306">error</span>&nbsp;<span class="op" id="4912312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912315">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912392">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912472">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912491">mw</span><span class="op" id="4912493">,</span>&nbsp;<span class="ident" id="4912495">mh</span>&nbsp;<span class="op" id="4912498">:=</span>&nbsp;<span class="ident" id="4912501">int64</span><span class="op" id="4912506">(</span><span class="ident" id="4912507">m</span><span class="op" id="4912508">.</span><span class="ident" id="4912509">Bounds</span><span class="op" id="4912515">(</span><span class="op" id="4912516">)</span><span class="op" id="4912517">.</span><span class="ident" id="4912518">Dx</span><span class="op" id="4912520">(</span><span class="op" id="4912521">)</span><span class="op" id="4912522">)</span><span class="op" id="4912523">,</span>&nbsp;<span class="ident" id="4912525">int64</span><span class="op" id="4912530">(</span><span class="ident" id="4912531">m</span><span class="op" id="4912532">.</span><span class="ident" id="4912533">Bounds</span><span class="op" id="4912539">(</span><span class="op" id="4912540">)</span><span class="op" id="4912541">.</span><span class="ident" id="4912542">Dy</span><span class="op" id="4912544">(</span><span class="op" id="4912545">)</span><span class="op" id="4912546">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912549">if</span>&nbsp;<span class="ident" id="4912552">mw</span>&nbsp;<span class="op" id="4912555">&lt;=</span>&nbsp;<span class="num" id="4912558">0</span>&nbsp;<span class="op" id="4912560">||</span>&nbsp;<span class="ident" id="4912563">mh</span>&nbsp;<span class="op" id="4912566">&lt;=</span>&nbsp;<span class="num" id="4912569">0</span>&nbsp;<span class="op" id="4912571">||</span>&nbsp;<span class="ident" id="4912574">mw</span>&nbsp;<span class="op" id="4912577">&gt;=</span>&nbsp;<span class="num" id="4912580">1</span><span class="op" id="4912581">&lt;&lt;</span><span class="num" id="4912583">32</span>&nbsp;<span class="op" id="4912586">||</span>&nbsp;<span class="ident" id="4912589">mh</span>&nbsp;<span class="op" id="4912592">&gt;=</span>&nbsp;<span class="num" id="4912595">1</span><span class="op" id="4912596">&lt;&lt;</span><span class="num" id="4912598">32</span>&nbsp;<span class="op" id="4912601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912605">return</span>&nbsp;<span class="ident" id="4912612">FormatError</span><span class="op" id="4912623">(</span><span class="string" id="4912624">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="4912647">+</span>&nbsp;<span class="ident" id="4912649">strconv</span><span class="op" id="4912656">.</span><span class="ident" id="4912657">FormatInt</span><span class="op" id="4912666">(</span><span class="ident" id="4912667">mw</span><span class="op" id="4912669">,</span>&nbsp;<span class="num" id="4912671">10</span><span class="op" id="4912673">)</span>&nbsp;<span class="op" id="4912675">+</span>&nbsp;<span class="string" id="4912677">&#34;x&#34;</span>&nbsp;<span class="op" id="4912681">+</span>&nbsp;<span class="ident" id="4912683">strconv</span><span class="op" id="4912690">.</span><span class="ident" id="4912691">FormatInt</span><span class="op" id="4912700">(</span><span class="ident" id="4912701">mh</span><span class="op" id="4912703">,</span>&nbsp;<span class="num" id="4912705">10</span><span class="op" id="4912707">)</span><span class="op" id="4912708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912715">var</span>&nbsp;<span class="ident" id="4912719">e</span>&nbsp;<span class="ident" id="4912721">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912730">e</span><span class="op" id="4912731">.</span><span class="ident" id="4912732">enc</span>&nbsp;<span class="op" id="4912736">=</span>&nbsp;<span class="ident" id="4912738">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912743">e</span><span class="op" id="4912744">.</span><span class="ident" id="4912745">w</span>&nbsp;<span class="op" id="4912747">=</span>&nbsp;<span class="ident" id="4912749">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912752">e</span><span class="op" id="4912753">.</span><span class="ident" id="4912754">m</span>&nbsp;<span class="op" id="4912756">=</span>&nbsp;<span class="ident" id="4912758">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912762">var</span>&nbsp;<span class="ident" id="4912766">pal</span>&nbsp;<span class="ident" id="4912770">color</span><span class="op" id="4912775">.</span><span class="ident" id="4912776">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912785">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912846">if</span>&nbsp;<span class="ident" id="4912849">_</span><span class="op" id="4912850">,</span>&nbsp;<span class="ident" id="4912852">ok</span>&nbsp;<span class="op" id="4912855">:=</span>&nbsp;<span class="ident" id="4912858">m</span><span class="op" id="4912859">.</span><span class="op" id="4912860">(</span><span class="ident" id="4912861">image</span><span class="op" id="4912866">.</span><span class="ident" id="4912867">PalettedImage</span><span class="op" id="4912880">)</span><span class="op" id="4912881">;</span>&nbsp;<span class="ident" id="4912883">ok</span>&nbsp;<span class="op" id="4912886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912890">pal</span><span class="op" id="4912893">,</span>&nbsp;<span class="ident" id="4912895">_</span>&nbsp;<span class="op" id="4912897">=</span>&nbsp;<span class="ident" id="4912899">m</span><span class="op" id="4912900">.</span><span class="ident" id="4912901">ColorModel</span><span class="op" id="4912911">(</span><span class="op" id="4912912">)</span><span class="op" id="4912913">.</span><span class="op" id="4912914">(</span><span class="ident" id="4912915">color</span><span class="op" id="4912920">.</span><span class="ident" id="4912921">Palette</span><span class="op" id="4912928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912934">if</span>&nbsp;<span class="ident" id="4912937">pal</span>&nbsp;<span class="op" id="4912941">!=</span>&nbsp;<span class="ident" id="4912944">nil</span>&nbsp;<span class="op" id="4912948">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912952">e</span><span class="op" id="4912953">.</span><span class="ident" id="4912954">cb</span>&nbsp;<span class="op" id="4912957">=</span>&nbsp;<span class="ident" id="4912959">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912965">}</span>&nbsp;<span class="keyword" id="4912967">else</span>&nbsp;<span class="op" id="4912972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912976">switch</span>&nbsp;<span class="ident" id="4912983">m</span><span class="op" id="4912984">.</span><span class="ident" id="4912985">ColorModel</span><span class="op" id="4912995">(</span><span class="op" id="4912996">)</span>&nbsp;<span class="op" id="4912998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913002">case</span>&nbsp;<span class="ident" id="4913007">color</span><span class="op" id="4913012">.</span><span class="ident" id="4913013">GrayModel</span><span class="op" id="4913022">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913027">e</span><span class="op" id="4913028">.</span><span class="ident" id="4913029">cb</span>&nbsp;<span class="op" id="4913032">=</span>&nbsp;<span class="ident" id="4913034">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913041">case</span>&nbsp;<span class="ident" id="4913046">color</span><span class="op" id="4913051">.</span><span class="ident" id="4913052">Gray16Model</span><span class="op" id="4913063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913068">e</span><span class="op" id="4913069">.</span><span class="ident" id="4913070">cb</span>&nbsp;<span class="op" id="4913073">=</span>&nbsp;<span class="ident" id="4913075">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913083">case</span>&nbsp;<span class="ident" id="4913088">color</span><span class="op" id="4913093">.</span><span class="ident" id="4913094">RGBAModel</span><span class="op" id="4913103">,</span>&nbsp;<span class="ident" id="4913105">color</span><span class="op" id="4913110">.</span><span class="ident" id="4913111">NRGBAModel</span><span class="op" id="4913121">,</span>&nbsp;<span class="ident" id="4913123">color</span><span class="op" id="4913128">.</span><span class="ident" id="4913129">AlphaModel</span><span class="op" id="4913139">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913144">if</span>&nbsp;<span class="ident" id="4913147">opaque</span><span class="op" id="4913153">(</span><span class="ident" id="4913154">m</span><span class="op" id="4913155">)</span>&nbsp;<span class="op" id="4913157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913163">e</span><span class="op" id="4913164">.</span><span class="ident" id="4913165">cb</span>&nbsp;<span class="op" id="4913168">=</span>&nbsp;<span class="ident" id="4913170">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913179">}</span>&nbsp;<span class="keyword" id="4913181">else</span>&nbsp;<span class="op" id="4913186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913192">e</span><span class="op" id="4913193">.</span><span class="ident" id="4913194">cb</span>&nbsp;<span class="op" id="4913197">=</span>&nbsp;<span class="ident" id="4913199">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913213">default</span><span class="op" id="4913220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913225">if</span>&nbsp;<span class="ident" id="4913228">opaque</span><span class="op" id="4913234">(</span><span class="ident" id="4913235">m</span><span class="op" id="4913236">)</span>&nbsp;<span class="op" id="4913238">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913244">e</span><span class="op" id="4913245">.</span><span class="ident" id="4913246">cb</span>&nbsp;<span class="op" id="4913249">=</span>&nbsp;<span class="ident" id="4913251">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913261">}</span>&nbsp;<span class="keyword" id="4913263">else</span>&nbsp;<span class="op" id="4913268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913274">e</span><span class="op" id="4913275">.</span><span class="ident" id="4913276">cb</span>&nbsp;<span class="op" id="4913279">=</span>&nbsp;<span class="ident" id="4913281">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913296">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913303">_</span><span class="op" id="4913304">,</span>&nbsp;<span class="ident" id="4913306">e</span><span class="op" id="4913307">.</span><span class="ident" id="4913308">err</span>&nbsp;<span class="op" id="4913312">=</span>&nbsp;<span class="ident" id="4913314">io</span><span class="op" id="4913316">.</span><span class="ident" id="4913317">WriteString</span><span class="op" id="4913328">(</span><span class="ident" id="4913329">w</span><span class="op" id="4913330">,</span>&nbsp;<span class="ident" id="4913332">pngHeader</span><span class="op" id="4913341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913344">e</span><span class="op" id="4913345">.</span><span class="ident" id="4913346">writeIHDR</span><span class="op" id="4913355">(</span><span class="op" id="4913356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913359">if</span>&nbsp;<span class="ident" id="4913362">pal</span>&nbsp;<span class="op" id="4913366">!=</span>&nbsp;<span class="ident" id="4913369">nil</span>&nbsp;<span class="op" id="4913373">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913377">e</span><span class="op" id="4913378">.</span><span class="ident" id="4913379">writePLTEAndTRNS</span><span class="op" id="4913395">(</span><span class="ident" id="4913396">pal</span><span class="op" id="4913399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913405">e</span><span class="op" id="4913406">.</span><span class="ident" id="4913407">writeIDATs</span><span class="op" id="4913417">(</span><span class="op" id="4913418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913421">e</span><span class="op" id="4913422">.</span><span class="ident" id="4913423">writeIEND</span><span class="op" id="4913432">(</span><span class="op" id="4913433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913436">return</span>&nbsp;<span class="ident" id="4913443">e</span><span class="op" id="4913444">.</span><span class="ident" id="4913445">err</span><br>
<span class="lineno">530</span><span class="op" id="4913449">}</span>
</div>
</body>
</html>
