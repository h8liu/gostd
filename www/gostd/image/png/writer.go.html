<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6319644">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6319699">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6319753">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6319804">package</span>&nbsp;<span class="ident" id="6319812">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6319817">import</span>&nbsp;<span class="op" id="6319824">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319827">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319836">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319853">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319867">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319876">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319891">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319897">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6319907">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6319910">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="6319953">type</span>&nbsp;<span class="ident" id="6319958">Encoder</span>&nbsp;<span class="keyword" id="6319966">struct</span>&nbsp;<span class="op" id="6319973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319976">CompressionLevel</span>&nbsp;<span class="ident" id="6319993">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="6320010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6320013">type</span>&nbsp;<span class="ident" id="6320018">encoder</span>&nbsp;<span class="keyword" id="6320026">struct</span>&nbsp;<span class="op" id="6320033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320036">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6320043">*</span><span class="ident" id="6320044">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320053">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320060">io</span><span class="op" id="6320062">.</span><span class="ident" id="6320063">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320071">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320078">image</span><span class="op" id="6320083">.</span><span class="ident" id="6320084">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320091">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6320098">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320103">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6320110">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320117">header</span>&nbsp;<span class="op" id="6320124">[</span><span class="num" id="6320125">8</span><span class="op" id="6320126">]</span><span class="builtintype" id="6320127">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320133">footer</span>&nbsp;<span class="op" id="6320140">[</span><span class="num" id="6320141">4</span><span class="op" id="6320142">]</span><span class="builtintype" id="6320143">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320149">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6320156">[</span><span class="num" id="6320157">4</span>&nbsp;<span class="op" id="6320159">*</span>&nbsp;<span class="num" id="6320161">256</span><span class="op" id="6320164">]</span><span class="builtintype" id="6320165">byte</span><br>
<span class="lineno"></span><span class="op" id="6320170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6320173">type</span>&nbsp;<span class="ident" id="6320178">CompressionLevel</span>&nbsp;<span class="builtintype" id="6320195">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="6320200">const</span>&nbsp;<span class="op" id="6320206">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320209">DefaultCompression</span>&nbsp;<span class="ident" id="6320228">CompressionLevel</span>&nbsp;<span class="op" id="6320245">=</span>&nbsp;<span class="num" id="6320247">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320250">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320269">CompressionLevel</span>&nbsp;<span class="op" id="6320286">=</span>&nbsp;<span class="op" id="6320288">-</span><span class="num" id="6320289">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320292">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320311">CompressionLevel</span>&nbsp;<span class="op" id="6320328">=</span>&nbsp;<span class="op" id="6320330">-</span><span class="num" id="6320331">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320334">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320353">CompressionLevel</span>&nbsp;<span class="op" id="6320370">=</span>&nbsp;<span class="op" id="6320372">-</span><span class="num" id="6320373">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6320377">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6320450">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="6320510">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6320513">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6320528">func</span>&nbsp;<span class="ident" id="6320533">writeUint32</span><span class="op" id="6320544">(</span><span class="ident" id="6320545">b</span>&nbsp;<span class="op" id="6320547">[</span><span class="op" id="6320548">]</span><span class="builtintype" id="6320549">uint8</span><span class="op" id="6320554">,</span>&nbsp;<span class="ident" id="6320556">u</span>&nbsp;<span class="builtintype" id="6320558">uint32</span><span class="op" id="6320564">)</span>&nbsp;<span class="op" id="6320566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320569">b</span><span class="op" id="6320570">[</span><span class="num" id="6320571">0</span><span class="op" id="6320572">]</span>&nbsp;<span class="op" id="6320574">=</span>&nbsp;<span class="builtintype" id="6320576">uint8</span><span class="op" id="6320581">(</span><span class="ident" id="6320582">u</span>&nbsp;<span class="op" id="6320584">&gt;&gt;</span>&nbsp;<span class="num" id="6320587">24</span><span class="op" id="6320589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320592">b</span><span class="op" id="6320593">[</span><span class="num" id="6320594">1</span><span class="op" id="6320595">]</span>&nbsp;<span class="op" id="6320597">=</span>&nbsp;<span class="builtintype" id="6320599">uint8</span><span class="op" id="6320604">(</span><span class="ident" id="6320605">u</span>&nbsp;<span class="op" id="6320607">&gt;&gt;</span>&nbsp;<span class="num" id="6320610">16</span><span class="op" id="6320612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320615">b</span><span class="op" id="6320616">[</span><span class="num" id="6320617">2</span><span class="op" id="6320618">]</span>&nbsp;<span class="op" id="6320620">=</span>&nbsp;<span class="builtintype" id="6320622">uint8</span><span class="op" id="6320627">(</span><span class="ident" id="6320628">u</span>&nbsp;<span class="op" id="6320630">&gt;&gt;</span>&nbsp;<span class="num" id="6320633">8</span><span class="op" id="6320634">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320637">b</span><span class="op" id="6320638">[</span><span class="num" id="6320639">3</span><span class="op" id="6320640">]</span>&nbsp;<span class="op" id="6320642">=</span>&nbsp;<span class="builtintype" id="6320644">uint8</span><span class="op" id="6320649">(</span><span class="ident" id="6320650">u</span>&nbsp;<span class="op" id="6320652">&gt;&gt;</span>&nbsp;<span class="num" id="6320655">0</span><span class="op" id="6320656">)</span><br>
<span class="lineno"></span><span class="op" id="6320658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6320661">type</span>&nbsp;<span class="ident" id="6320666">opaquer</span>&nbsp;<span class="keyword" id="6320674">interface</span>&nbsp;<span class="op" id="6320684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320687">Opaque</span><span class="op" id="6320693">(</span><span class="op" id="6320694">)</span>&nbsp;<span class="builtintype" id="6320696">bool</span><br>
<span class="lineno">55</span><span class="op" id="6320701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6320704">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="6320757">func</span>&nbsp;<span class="ident" id="6320762">opaque</span><span class="op" id="6320768">(</span><span class="ident" id="6320769">m</span>&nbsp;<span class="ident" id="6320771">image</span><span class="op" id="6320776">.</span><span class="ident" id="6320777">Image</span><span class="op" id="6320782">)</span>&nbsp;<span class="builtintype" id="6320784">bool</span>&nbsp;<span class="op" id="6320789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320792">if</span>&nbsp;<span class="ident" id="6320795">o</span><span class="op" id="6320796">,</span>&nbsp;<span class="ident" id="6320798">ok</span>&nbsp;<span class="op" id="6320801">:=</span>&nbsp;<span class="ident" id="6320804">m</span><span class="op" id="6320805">.</span><span class="op" id="6320806">(</span><span class="ident" id="6320807">opaquer</span><span class="op" id="6320814">)</span><span class="op" id="6320815">;</span>&nbsp;<span class="ident" id="6320817">ok</span>&nbsp;<span class="op" id="6320820">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320824">return</span>&nbsp;<span class="ident" id="6320831">o</span><span class="op" id="6320832">.</span><span class="ident" id="6320833">Opaque</span><span class="op" id="6320839">(</span><span class="op" id="6320840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6320843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320846">b</span>&nbsp;<span class="op" id="6320848">:=</span>&nbsp;<span class="ident" id="6320851">m</span><span class="op" id="6320852">.</span><span class="ident" id="6320853">Bounds</span><span class="op" id="6320859">(</span><span class="op" id="6320860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320863">for</span>&nbsp;<span class="ident" id="6320867">y</span>&nbsp;<span class="op" id="6320869">:=</span>&nbsp;<span class="ident" id="6320872">b</span><span class="op" id="6320873">.</span><span class="ident" id="6320874">Min</span><span class="op" id="6320877">.</span><span class="ident" id="6320878">Y</span><span class="op" id="6320879">;</span>&nbsp;<span class="ident" id="6320881">y</span>&nbsp;<span class="op" id="6320883">&lt;</span>&nbsp;<span class="ident" id="6320885">b</span><span class="op" id="6320886">.</span><span class="ident" id="6320887">Max</span><span class="op" id="6320890">.</span><span class="ident" id="6320891">Y</span><span class="op" id="6320892">;</span>&nbsp;<span class="ident" id="6320894">y</span><span class="op" id="6320895">++</span>&nbsp;<span class="op" id="6320898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320902">for</span>&nbsp;<span class="ident" id="6320906">x</span>&nbsp;<span class="op" id="6320908">:=</span>&nbsp;<span class="ident" id="6320911">b</span><span class="op" id="6320912">.</span><span class="ident" id="6320913">Min</span><span class="op" id="6320916">.</span><span class="ident" id="6320917">X</span><span class="op" id="6320918">;</span>&nbsp;<span class="ident" id="6320920">x</span>&nbsp;<span class="op" id="6320922">&lt;</span>&nbsp;<span class="ident" id="6320924">b</span><span class="op" id="6320925">.</span><span class="ident" id="6320926">Max</span><span class="op" id="6320929">.</span><span class="ident" id="6320930">X</span><span class="op" id="6320931">;</span>&nbsp;<span class="ident" id="6320933">x</span><span class="op" id="6320934">++</span>&nbsp;<span class="op" id="6320937">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320942">_</span><span class="op" id="6320943">,</span>&nbsp;<span class="ident" id="6320945">_</span><span class="op" id="6320946">,</span>&nbsp;<span class="ident" id="6320948">_</span><span class="op" id="6320949">,</span>&nbsp;<span class="ident" id="6320951">a</span>&nbsp;<span class="op" id="6320953">:=</span>&nbsp;<span class="ident" id="6320956">m</span><span class="op" id="6320957">.</span><span class="ident" id="6320958">At</span><span class="op" id="6320960">(</span><span class="ident" id="6320961">x</span><span class="op" id="6320962">,</span>&nbsp;<span class="ident" id="6320964">y</span><span class="op" id="6320965">)</span><span class="op" id="6320966">.</span><span class="ident" id="6320967">RGBA</span><span class="op" id="6320971">(</span><span class="op" id="6320972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320977">if</span>&nbsp;<span class="ident" id="6320980">a</span>&nbsp;<span class="op" id="6320982">!=</span>&nbsp;<span class="num" id="6320985">0xffff</span>&nbsp;<span class="op" id="6320992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6320998">return</span>&nbsp;<span class="builtintype" id="6321005">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6321014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6321018">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6321021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321024">return</span>&nbsp;<span class="builtintype" id="6321031">true</span><br>
<span class="lineno"></span><span class="op" id="6321036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6321039">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="6321101">func</span>&nbsp;<span class="ident" id="6321106">abs8</span><span class="op" id="6321110">(</span><span class="ident" id="6321111">d</span>&nbsp;<span class="builtintype" id="6321113">uint8</span><span class="op" id="6321118">)</span>&nbsp;<span class="builtintype" id="6321120">int</span>&nbsp;<span class="op" id="6321124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321127">if</span>&nbsp;<span class="ident" id="6321130">d</span>&nbsp;<span class="op" id="6321132">&lt;</span>&nbsp;<span class="num" id="6321134">128</span>&nbsp;<span class="op" id="6321138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321142">return</span>&nbsp;<span class="builtintype" id="6321149">int</span><span class="op" id="6321152">(</span><span class="ident" id="6321153">d</span><span class="op" id="6321154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6321157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321160">return</span>&nbsp;<span class="num" id="6321167">256</span>&nbsp;<span class="op" id="6321171">-</span>&nbsp;<span class="builtintype" id="6321173">int</span><span class="op" id="6321176">(</span><span class="ident" id="6321177">d</span><span class="op" id="6321178">)</span><br>
<span class="lineno">80</span><span class="op" id="6321180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6321183">func</span>&nbsp;<span class="op" id="6321188">(</span><span class="ident" id="6321189">e</span>&nbsp;<span class="op" id="6321191">*</span><span class="ident" id="6321192">encoder</span><span class="op" id="6321199">)</span>&nbsp;<span class="ident" id="6321201">writeChunk</span><span class="op" id="6321211">(</span><span class="ident" id="6321212">b</span>&nbsp;<span class="op" id="6321214">[</span><span class="op" id="6321215">]</span><span class="builtintype" id="6321216">byte</span><span class="op" id="6321220">,</span>&nbsp;<span class="ident" id="6321222">name</span>&nbsp;<span class="builtintype" id="6321227">string</span><span class="op" id="6321233">)</span>&nbsp;<span class="op" id="6321235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321238">if</span>&nbsp;<span class="ident" id="6321241">e</span><span class="op" id="6321242">.</span><span class="ident" id="6321243">err</span>&nbsp;<span class="op" id="6321247">!=</span>&nbsp;<span class="ident" id="6321250">nil</span>&nbsp;<span class="op" id="6321254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321258">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6321266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321269">n</span>&nbsp;<span class="op" id="6321271">:=</span>&nbsp;<span class="builtintype" id="6321274">uint32</span><span class="op" id="6321280">(</span><span class="builtinfunc" id="6321281">len</span><span class="op" id="6321284">(</span><span class="ident" id="6321285">b</span><span class="op" id="6321286">)</span><span class="op" id="6321287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321290">if</span>&nbsp;<span class="builtintype" id="6321293">int</span><span class="op" id="6321296">(</span><span class="ident" id="6321297">n</span><span class="op" id="6321298">)</span>&nbsp;<span class="op" id="6321300">!=</span>&nbsp;<span class="builtinfunc" id="6321303">len</span><span class="op" id="6321306">(</span><span class="ident" id="6321307">b</span><span class="op" id="6321308">)</span>&nbsp;<span class="op" id="6321310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321314">e</span><span class="op" id="6321315">.</span><span class="ident" id="6321316">err</span>&nbsp;<span class="op" id="6321320">=</span>&nbsp;<span class="ident" id="6321322">UnsupportedError</span><span class="op" id="6321338">(</span><span class="ident" id="6321339">name</span>&nbsp;<span class="op" id="6321344">+</span>&nbsp;<span class="string" id="6321346">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="6321370">+</span>&nbsp;<span class="ident" id="6321372">strconv</span><span class="op" id="6321379">.</span><span class="ident" id="6321380">Itoa</span><span class="op" id="6321384">(</span><span class="builtinfunc" id="6321385">len</span><span class="op" id="6321388">(</span><span class="ident" id="6321389">b</span><span class="op" id="6321390">)</span><span class="op" id="6321391">)</span><span class="op" id="6321392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321396">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6321404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321407">writeUint32</span><span class="op" id="6321418">(</span><span class="ident" id="6321419">e</span><span class="op" id="6321420">.</span><span class="ident" id="6321421">header</span><span class="op" id="6321427">[</span><span class="op" id="6321428">:</span><span class="num" id="6321429">4</span><span class="op" id="6321430">]</span><span class="op" id="6321431">,</span>&nbsp;<span class="ident" id="6321433">n</span><span class="op" id="6321434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321437">e</span><span class="op" id="6321438">.</span><span class="ident" id="6321439">header</span><span class="op" id="6321445">[</span><span class="num" id="6321446">4</span><span class="op" id="6321447">]</span>&nbsp;<span class="op" id="6321449">=</span>&nbsp;<span class="ident" id="6321451">name</span><span class="op" id="6321455">[</span><span class="num" id="6321456">0</span><span class="op" id="6321457">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321460">e</span><span class="op" id="6321461">.</span><span class="ident" id="6321462">header</span><span class="op" id="6321468">[</span><span class="num" id="6321469">5</span><span class="op" id="6321470">]</span>&nbsp;<span class="op" id="6321472">=</span>&nbsp;<span class="ident" id="6321474">name</span><span class="op" id="6321478">[</span><span class="num" id="6321479">1</span><span class="op" id="6321480">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321483">e</span><span class="op" id="6321484">.</span><span class="ident" id="6321485">header</span><span class="op" id="6321491">[</span><span class="num" id="6321492">6</span><span class="op" id="6321493">]</span>&nbsp;<span class="op" id="6321495">=</span>&nbsp;<span class="ident" id="6321497">name</span><span class="op" id="6321501">[</span><span class="num" id="6321502">2</span><span class="op" id="6321503">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321506">e</span><span class="op" id="6321507">.</span><span class="ident" id="6321508">header</span><span class="op" id="6321514">[</span><span class="num" id="6321515">7</span><span class="op" id="6321516">]</span>&nbsp;<span class="op" id="6321518">=</span>&nbsp;<span class="ident" id="6321520">name</span><span class="op" id="6321524">[</span><span class="num" id="6321525">3</span><span class="op" id="6321526">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321529">crc</span>&nbsp;<span class="op" id="6321533">:=</span>&nbsp;<span class="ident" id="6321536">crc32</span><span class="op" id="6321541">.</span><span class="ident" id="6321542">NewIEEE</span><span class="op" id="6321549">(</span><span class="op" id="6321550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321553">crc</span><span class="op" id="6321556">.</span><span class="ident" id="6321557">Write</span><span class="op" id="6321562">(</span><span class="ident" id="6321563">e</span><span class="op" id="6321564">.</span><span class="ident" id="6321565">header</span><span class="op" id="6321571">[</span><span class="num" id="6321572">4</span><span class="op" id="6321573">:</span><span class="num" id="6321574">8</span><span class="op" id="6321575">]</span><span class="op" id="6321576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321579">crc</span><span class="op" id="6321582">.</span><span class="ident" id="6321583">Write</span><span class="op" id="6321588">(</span><span class="ident" id="6321589">b</span><span class="op" id="6321590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321593">writeUint32</span><span class="op" id="6321604">(</span><span class="ident" id="6321605">e</span><span class="op" id="6321606">.</span><span class="ident" id="6321607">footer</span><span class="op" id="6321613">[</span><span class="op" id="6321614">:</span><span class="num" id="6321615">4</span><span class="op" id="6321616">]</span><span class="op" id="6321617">,</span>&nbsp;<span class="ident" id="6321619">crc</span><span class="op" id="6321622">.</span><span class="ident" id="6321623">Sum32</span><span class="op" id="6321628">(</span><span class="op" id="6321629">)</span><span class="op" id="6321630">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321634">_</span><span class="op" id="6321635">,</span>&nbsp;<span class="ident" id="6321637">e</span><span class="op" id="6321638">.</span><span class="ident" id="6321639">err</span>&nbsp;<span class="op" id="6321643">=</span>&nbsp;<span class="ident" id="6321645">e</span><span class="op" id="6321646">.</span><span class="ident" id="6321647">w</span><span class="op" id="6321648">.</span><span class="ident" id="6321649">Write</span><span class="op" id="6321654">(</span><span class="ident" id="6321655">e</span><span class="op" id="6321656">.</span><span class="ident" id="6321657">header</span><span class="op" id="6321663">[</span><span class="op" id="6321664">:</span><span class="num" id="6321665">8</span><span class="op" id="6321666">]</span><span class="op" id="6321667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321670">if</span>&nbsp;<span class="ident" id="6321673">e</span><span class="op" id="6321674">.</span><span class="ident" id="6321675">err</span>&nbsp;<span class="op" id="6321679">!=</span>&nbsp;<span class="ident" id="6321682">nil</span>&nbsp;<span class="op" id="6321686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321690">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6321698">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321701">_</span><span class="op" id="6321702">,</span>&nbsp;<span class="ident" id="6321704">e</span><span class="op" id="6321705">.</span><span class="ident" id="6321706">err</span>&nbsp;<span class="op" id="6321710">=</span>&nbsp;<span class="ident" id="6321712">e</span><span class="op" id="6321713">.</span><span class="ident" id="6321714">w</span><span class="op" id="6321715">.</span><span class="ident" id="6321716">Write</span><span class="op" id="6321721">(</span><span class="ident" id="6321722">b</span><span class="op" id="6321723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321726">if</span>&nbsp;<span class="ident" id="6321729">e</span><span class="op" id="6321730">.</span><span class="ident" id="6321731">err</span>&nbsp;<span class="op" id="6321735">!=</span>&nbsp;<span class="ident" id="6321738">nil</span>&nbsp;<span class="op" id="6321742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321746">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6321754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321757">_</span><span class="op" id="6321758">,</span>&nbsp;<span class="ident" id="6321760">e</span><span class="op" id="6321761">.</span><span class="ident" id="6321762">err</span>&nbsp;<span class="op" id="6321766">=</span>&nbsp;<span class="ident" id="6321768">e</span><span class="op" id="6321769">.</span><span class="ident" id="6321770">w</span><span class="op" id="6321771">.</span><span class="ident" id="6321772">Write</span><span class="op" id="6321777">(</span><span class="ident" id="6321778">e</span><span class="op" id="6321779">.</span><span class="ident" id="6321780">footer</span><span class="op" id="6321786">[</span><span class="op" id="6321787">:</span><span class="num" id="6321788">4</span><span class="op" id="6321789">]</span><span class="op" id="6321790">)</span><br>
<span class="lineno">110</span><span class="op" id="6321792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6321795">func</span>&nbsp;<span class="op" id="6321800">(</span><span class="ident" id="6321801">e</span>&nbsp;<span class="op" id="6321803">*</span><span class="ident" id="6321804">encoder</span><span class="op" id="6321811">)</span>&nbsp;<span class="ident" id="6321813">writeIHDR</span><span class="op" id="6321822">(</span><span class="op" id="6321823">)</span>&nbsp;<span class="op" id="6321825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321828">b</span>&nbsp;<span class="op" id="6321830">:=</span>&nbsp;<span class="ident" id="6321833">e</span><span class="op" id="6321834">.</span><span class="ident" id="6321835">m</span><span class="op" id="6321836">.</span><span class="ident" id="6321837">Bounds</span><span class="op" id="6321843">(</span><span class="op" id="6321844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321847">writeUint32</span><span class="op" id="6321858">(</span><span class="ident" id="6321859">e</span><span class="op" id="6321860">.</span><span class="ident" id="6321861">tmp</span><span class="op" id="6321864">[</span><span class="num" id="6321865">0</span><span class="op" id="6321866">:</span><span class="num" id="6321867">4</span><span class="op" id="6321868">]</span><span class="op" id="6321869">,</span>&nbsp;<span class="builtintype" id="6321871">uint32</span><span class="op" id="6321877">(</span><span class="ident" id="6321878">b</span><span class="op" id="6321879">.</span><span class="ident" id="6321880">Dx</span><span class="op" id="6321882">(</span><span class="op" id="6321883">)</span><span class="op" id="6321884">)</span><span class="op" id="6321885">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321888">writeUint32</span><span class="op" id="6321899">(</span><span class="ident" id="6321900">e</span><span class="op" id="6321901">.</span><span class="ident" id="6321902">tmp</span><span class="op" id="6321905">[</span><span class="num" id="6321906">4</span><span class="op" id="6321907">:</span><span class="num" id="6321908">8</span><span class="op" id="6321909">]</span><span class="op" id="6321910">,</span>&nbsp;<span class="builtintype" id="6321912">uint32</span><span class="op" id="6321918">(</span><span class="ident" id="6321919">b</span><span class="op" id="6321920">.</span><span class="ident" id="6321921">Dy</span><span class="op" id="6321923">(</span><span class="op" id="6321924">)</span><span class="op" id="6321925">)</span><span class="op" id="6321926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6321929">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321963">switch</span>&nbsp;<span class="ident" id="6321970">e</span><span class="op" id="6321971">.</span><span class="ident" id="6321972">cb</span>&nbsp;<span class="op" id="6321975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6321978">case</span>&nbsp;<span class="ident" id="6321983">cbG8</span><span class="op" id="6321987">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321991">e</span><span class="op" id="6321992">.</span><span class="ident" id="6321993">tmp</span><span class="op" id="6321996">[</span><span class="num" id="6321997">8</span><span class="op" id="6321998">]</span>&nbsp;<span class="op" id="6322000">=</span>&nbsp;<span class="num" id="6322002">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322006">e</span><span class="op" id="6322007">.</span><span class="ident" id="6322008">tmp</span><span class="op" id="6322011">[</span><span class="num" id="6322012">9</span><span class="op" id="6322013">]</span>&nbsp;<span class="op" id="6322015">=</span>&nbsp;<span class="ident" id="6322017">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322030">case</span>&nbsp;<span class="ident" id="6322035">cbTC8</span><span class="op" id="6322040">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322044">e</span><span class="op" id="6322045">.</span><span class="ident" id="6322046">tmp</span><span class="op" id="6322049">[</span><span class="num" id="6322050">8</span><span class="op" id="6322051">]</span>&nbsp;<span class="op" id="6322053">=</span>&nbsp;<span class="num" id="6322055">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322059">e</span><span class="op" id="6322060">.</span><span class="ident" id="6322061">tmp</span><span class="op" id="6322064">[</span><span class="num" id="6322065">9</span><span class="op" id="6322066">]</span>&nbsp;<span class="op" id="6322068">=</span>&nbsp;<span class="ident" id="6322070">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322083">case</span>&nbsp;<span class="ident" id="6322088">cbP8</span><span class="op" id="6322092">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322096">e</span><span class="op" id="6322097">.</span><span class="ident" id="6322098">tmp</span><span class="op" id="6322101">[</span><span class="num" id="6322102">8</span><span class="op" id="6322103">]</span>&nbsp;<span class="op" id="6322105">=</span>&nbsp;<span class="num" id="6322107">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322111">e</span><span class="op" id="6322112">.</span><span class="ident" id="6322113">tmp</span><span class="op" id="6322116">[</span><span class="num" id="6322117">9</span><span class="op" id="6322118">]</span>&nbsp;<span class="op" id="6322120">=</span>&nbsp;<span class="ident" id="6322122">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322134">case</span>&nbsp;<span class="ident" id="6322139">cbTCA8</span><span class="op" id="6322145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322149">e</span><span class="op" id="6322150">.</span><span class="ident" id="6322151">tmp</span><span class="op" id="6322154">[</span><span class="num" id="6322155">8</span><span class="op" id="6322156">]</span>&nbsp;<span class="op" id="6322158">=</span>&nbsp;<span class="num" id="6322160">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322164">e</span><span class="op" id="6322165">.</span><span class="ident" id="6322166">tmp</span><span class="op" id="6322169">[</span><span class="num" id="6322170">9</span><span class="op" id="6322171">]</span>&nbsp;<span class="op" id="6322173">=</span>&nbsp;<span class="ident" id="6322175">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322193">case</span>&nbsp;<span class="ident" id="6322198">cbG16</span><span class="op" id="6322203">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322207">e</span><span class="op" id="6322208">.</span><span class="ident" id="6322209">tmp</span><span class="op" id="6322212">[</span><span class="num" id="6322213">8</span><span class="op" id="6322214">]</span>&nbsp;<span class="op" id="6322216">=</span>&nbsp;<span class="num" id="6322218">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322223">e</span><span class="op" id="6322224">.</span><span class="ident" id="6322225">tmp</span><span class="op" id="6322228">[</span><span class="num" id="6322229">9</span><span class="op" id="6322230">]</span>&nbsp;<span class="op" id="6322232">=</span>&nbsp;<span class="ident" id="6322234">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322247">case</span>&nbsp;<span class="ident" id="6322252">cbTC16</span><span class="op" id="6322258">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322262">e</span><span class="op" id="6322263">.</span><span class="ident" id="6322264">tmp</span><span class="op" id="6322267">[</span><span class="num" id="6322268">8</span><span class="op" id="6322269">]</span>&nbsp;<span class="op" id="6322271">=</span>&nbsp;<span class="num" id="6322273">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322278">e</span><span class="op" id="6322279">.</span><span class="ident" id="6322280">tmp</span><span class="op" id="6322283">[</span><span class="num" id="6322284">9</span><span class="op" id="6322285">]</span>&nbsp;<span class="op" id="6322287">=</span>&nbsp;<span class="ident" id="6322289">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322302">case</span>&nbsp;<span class="ident" id="6322307">cbTCA16</span><span class="op" id="6322314">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322318">e</span><span class="op" id="6322319">.</span><span class="ident" id="6322320">tmp</span><span class="op" id="6322323">[</span><span class="num" id="6322324">8</span><span class="op" id="6322325">]</span>&nbsp;<span class="op" id="6322327">=</span>&nbsp;<span class="num" id="6322329">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322334">e</span><span class="op" id="6322335">.</span><span class="ident" id="6322336">tmp</span><span class="op" id="6322339">[</span><span class="num" id="6322340">9</span><span class="op" id="6322341">]</span>&nbsp;<span class="op" id="6322343">=</span>&nbsp;<span class="ident" id="6322345">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322363">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322366">e</span><span class="op" id="6322367">.</span><span class="ident" id="6322368">tmp</span><span class="op" id="6322371">[</span><span class="num" id="6322372">10</span><span class="op" id="6322374">]</span>&nbsp;<span class="op" id="6322376">=</span>&nbsp;<span class="num" id="6322378">0</span>&nbsp;<span class="comment" id="6322380">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322411">e</span><span class="op" id="6322412">.</span><span class="ident" id="6322413">tmp</span><span class="op" id="6322416">[</span><span class="num" id="6322417">11</span><span class="op" id="6322419">]</span>&nbsp;<span class="op" id="6322421">=</span>&nbsp;<span class="num" id="6322423">0</span>&nbsp;<span class="comment" id="6322425">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322451">e</span><span class="op" id="6322452">.</span><span class="ident" id="6322453">tmp</span><span class="op" id="6322456">[</span><span class="num" id="6322457">12</span><span class="op" id="6322459">]</span>&nbsp;<span class="op" id="6322461">=</span>&nbsp;<span class="num" id="6322463">0</span>&nbsp;<span class="comment" id="6322465">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322484">e</span><span class="op" id="6322485">.</span><span class="ident" id="6322486">writeChunk</span><span class="op" id="6322496">(</span><span class="ident" id="6322497">e</span><span class="op" id="6322498">.</span><span class="ident" id="6322499">tmp</span><span class="op" id="6322502">[</span><span class="op" id="6322503">:</span><span class="num" id="6322504">13</span><span class="op" id="6322506">]</span><span class="op" id="6322507">,</span>&nbsp;<span class="string" id="6322509">&#34;IHDR&#34;</span><span class="op" id="6322515">)</span><br>
<span class="lineno"></span><span class="op" id="6322517">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="6322520">func</span>&nbsp;<span class="op" id="6322525">(</span><span class="ident" id="6322526">e</span>&nbsp;<span class="op" id="6322528">*</span><span class="ident" id="6322529">encoder</span><span class="op" id="6322536">)</span>&nbsp;<span class="ident" id="6322538">writePLTEAndTRNS</span><span class="op" id="6322554">(</span><span class="ident" id="6322555">p</span>&nbsp;<span class="ident" id="6322557">color</span><span class="op" id="6322562">.</span><span class="ident" id="6322563">Palette</span><span class="op" id="6322570">)</span>&nbsp;<span class="op" id="6322572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322575">if</span>&nbsp;<span class="builtinfunc" id="6322578">len</span><span class="op" id="6322581">(</span><span class="ident" id="6322582">p</span><span class="op" id="6322583">)</span>&nbsp;<span class="op" id="6322585">&lt;</span>&nbsp;<span class="num" id="6322587">1</span>&nbsp;<span class="op" id="6322589">||</span>&nbsp;<span class="builtinfunc" id="6322592">len</span><span class="op" id="6322595">(</span><span class="ident" id="6322596">p</span><span class="op" id="6322597">)</span>&nbsp;<span class="op" id="6322599">&gt;</span>&nbsp;<span class="num" id="6322601">256</span>&nbsp;<span class="op" id="6322605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322609">e</span><span class="op" id="6322610">.</span><span class="ident" id="6322611">err</span>&nbsp;<span class="op" id="6322615">=</span>&nbsp;<span class="ident" id="6322617">FormatError</span><span class="op" id="6322628">(</span><span class="string" id="6322629">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="6322652">+</span>&nbsp;<span class="ident" id="6322654">strconv</span><span class="op" id="6322661">.</span><span class="ident" id="6322662">Itoa</span><span class="op" id="6322666">(</span><span class="builtinfunc" id="6322667">len</span><span class="op" id="6322670">(</span><span class="ident" id="6322671">p</span><span class="op" id="6322672">)</span><span class="op" id="6322673">)</span><span class="op" id="6322674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322678">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322689">last</span>&nbsp;<span class="op" id="6322694">:=</span>&nbsp;<span class="op" id="6322697">-</span><span class="num" id="6322698">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322701">for</span>&nbsp;<span class="ident" id="6322705">i</span><span class="op" id="6322706">,</span>&nbsp;<span class="ident" id="6322708">c</span>&nbsp;<span class="op" id="6322710">:=</span>&nbsp;<span class="keyword" id="6322713">range</span>&nbsp;<span class="ident" id="6322719">p</span>&nbsp;<span class="op" id="6322721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322725">c1</span>&nbsp;<span class="op" id="6322728">:=</span>&nbsp;<span class="ident" id="6322731">color</span><span class="op" id="6322736">.</span><span class="ident" id="6322737">NRGBAModel</span><span class="op" id="6322747">.</span><span class="ident" id="6322748">Convert</span><span class="op" id="6322755">(</span><span class="ident" id="6322756">c</span><span class="op" id="6322757">)</span><span class="op" id="6322758">.</span><span class="op" id="6322759">(</span><span class="ident" id="6322760">color</span><span class="op" id="6322765">.</span><span class="ident" id="6322766">NRGBA</span><span class="op" id="6322771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322775">e</span><span class="op" id="6322776">.</span><span class="ident" id="6322777">tmp</span><span class="op" id="6322780">[</span><span class="num" id="6322781">3</span><span class="op" id="6322782">*</span><span class="ident" id="6322783">i</span><span class="op" id="6322784">+</span><span class="num" id="6322785">0</span><span class="op" id="6322786">]</span>&nbsp;<span class="op" id="6322788">=</span>&nbsp;<span class="ident" id="6322790">c1</span><span class="op" id="6322792">.</span><span class="ident" id="6322793">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322797">e</span><span class="op" id="6322798">.</span><span class="ident" id="6322799">tmp</span><span class="op" id="6322802">[</span><span class="num" id="6322803">3</span><span class="op" id="6322804">*</span><span class="ident" id="6322805">i</span><span class="op" id="6322806">+</span><span class="num" id="6322807">1</span><span class="op" id="6322808">]</span>&nbsp;<span class="op" id="6322810">=</span>&nbsp;<span class="ident" id="6322812">c1</span><span class="op" id="6322814">.</span><span class="ident" id="6322815">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322819">e</span><span class="op" id="6322820">.</span><span class="ident" id="6322821">tmp</span><span class="op" id="6322824">[</span><span class="num" id="6322825">3</span><span class="op" id="6322826">*</span><span class="ident" id="6322827">i</span><span class="op" id="6322828">+</span><span class="num" id="6322829">2</span><span class="op" id="6322830">]</span>&nbsp;<span class="op" id="6322832">=</span>&nbsp;<span class="ident" id="6322834">c1</span><span class="op" id="6322836">.</span><span class="ident" id="6322837">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322841">if</span>&nbsp;<span class="ident" id="6322844">c1</span><span class="op" id="6322846">.</span><span class="ident" id="6322847">A</span>&nbsp;<span class="op" id="6322849">!=</span>&nbsp;<span class="num" id="6322852">0xff</span>&nbsp;<span class="op" id="6322857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322862">last</span>&nbsp;<span class="op" id="6322867">=</span>&nbsp;<span class="ident" id="6322869">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322873">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322877">e</span><span class="op" id="6322878">.</span><span class="ident" id="6322879">tmp</span><span class="op" id="6322882">[</span><span class="num" id="6322883">3</span><span class="op" id="6322884">*</span><span class="num" id="6322885">256</span><span class="op" id="6322888">+</span><span class="ident" id="6322889">i</span><span class="op" id="6322890">]</span>&nbsp;<span class="op" id="6322892">=</span>&nbsp;<span class="ident" id="6322894">c1</span><span class="op" id="6322896">.</span><span class="ident" id="6322897">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322903">e</span><span class="op" id="6322904">.</span><span class="ident" id="6322905">writeChunk</span><span class="op" id="6322915">(</span><span class="ident" id="6322916">e</span><span class="op" id="6322917">.</span><span class="ident" id="6322918">tmp</span><span class="op" id="6322921">[</span><span class="op" id="6322922">:</span><span class="num" id="6322923">3</span><span class="op" id="6322924">*</span><span class="builtinfunc" id="6322925">len</span><span class="op" id="6322928">(</span><span class="ident" id="6322929">p</span><span class="op" id="6322930">)</span><span class="op" id="6322931">]</span><span class="op" id="6322932">,</span>&nbsp;<span class="string" id="6322934">&#34;PLTE&#34;</span><span class="op" id="6322940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6322943">if</span>&nbsp;<span class="ident" id="6322946">last</span>&nbsp;<span class="op" id="6322951">!=</span>&nbsp;<span class="op" id="6322954">-</span><span class="num" id="6322955">1</span>&nbsp;<span class="op" id="6322957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6322961">e</span><span class="op" id="6322962">.</span><span class="ident" id="6322963">writeChunk</span><span class="op" id="6322973">(</span><span class="ident" id="6322974">e</span><span class="op" id="6322975">.</span><span class="ident" id="6322976">tmp</span><span class="op" id="6322979">[</span><span class="num" id="6322980">3</span><span class="op" id="6322981">*</span><span class="num" id="6322982">256</span><span class="op" id="6322985">:</span><span class="num" id="6322986">3</span><span class="op" id="6322987">*</span><span class="num" id="6322988">256</span><span class="op" id="6322991">+</span><span class="num" id="6322992">1</span><span class="op" id="6322993">+</span><span class="ident" id="6322994">last</span><span class="op" id="6322998">]</span><span class="op" id="6322999">,</span>&nbsp;<span class="string" id="6323001">&#34;tRNS&#34;</span><span class="op" id="6323007">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6323010">}</span><br>
<span class="lineno"></span><span class="op" id="6323012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6323015">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="6323095">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="6323176">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="6323250">//</span><br>
<span class="lineno"></span><span class="comment" id="6323253">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="6323324">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6323382">func</span>&nbsp;<span class="op" id="6323387">(</span><span class="ident" id="6323388">e</span>&nbsp;<span class="op" id="6323390">*</span><span class="ident" id="6323391">encoder</span><span class="op" id="6323398">)</span>&nbsp;<span class="ident" id="6323400">Write</span><span class="op" id="6323405">(</span><span class="ident" id="6323406">b</span>&nbsp;<span class="op" id="6323408">[</span><span class="op" id="6323409">]</span><span class="builtintype" id="6323410">byte</span><span class="op" id="6323414">)</span>&nbsp;<span class="op" id="6323416">(</span><span class="builtintype" id="6323417">int</span><span class="op" id="6323420">,</span>&nbsp;<span class="builtintype" id="6323422">error</span><span class="op" id="6323427">)</span>&nbsp;<span class="op" id="6323429">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323432">e</span><span class="op" id="6323433">.</span><span class="ident" id="6323434">writeChunk</span><span class="op" id="6323444">(</span><span class="ident" id="6323445">b</span><span class="op" id="6323446">,</span>&nbsp;<span class="string" id="6323448">&#34;IDAT&#34;</span><span class="op" id="6323454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323457">if</span>&nbsp;<span class="ident" id="6323460">e</span><span class="op" id="6323461">.</span><span class="ident" id="6323462">err</span>&nbsp;<span class="op" id="6323466">!=</span>&nbsp;<span class="ident" id="6323469">nil</span>&nbsp;<span class="op" id="6323473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323477">return</span>&nbsp;<span class="num" id="6323484">0</span><span class="op" id="6323485">,</span>&nbsp;<span class="ident" id="6323487">e</span><span class="op" id="6323488">.</span><span class="ident" id="6323489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6323494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6323497">return</span>&nbsp;<span class="builtinfunc" id="6323504">len</span><span class="op" id="6323507">(</span><span class="ident" id="6323508">b</span><span class="op" id="6323509">)</span><span class="op" id="6323510">,</span>&nbsp;<span class="ident" id="6323512">nil</span><br>
<span class="lineno">180</span><span class="op" id="6323516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6323519">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="6323594">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="6323692">func</span>&nbsp;<span class="ident" id="6323697">filter</span><span class="op" id="6323703">(</span><span class="ident" id="6323704">cr</span>&nbsp;<span class="op" id="6323707">*</span><span class="op" id="6323708">[</span><span class="ident" id="6323709">nFilter</span><span class="op" id="6323716">]</span><span class="op" id="6323717">[</span><span class="op" id="6323718">]</span><span class="builtintype" id="6323719">byte</span><span class="op" id="6323723">,</span>&nbsp;<span class="ident" id="6323725">pr</span>&nbsp;<span class="op" id="6323728">[</span><span class="op" id="6323729">]</span><span class="builtintype" id="6323730">byte</span><span class="op" id="6323734">,</span>&nbsp;<span class="ident" id="6323736">bpp</span>&nbsp;<span class="builtintype" id="6323740">int</span><span class="op" id="6323743">)</span>&nbsp;<span class="builtintype" id="6323745">int</span>&nbsp;<span class="op" id="6323749">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6323752">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6323851">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6323947">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6324042">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324116">cdat0</span>&nbsp;<span class="op" id="6324122">:=</span>&nbsp;<span class="ident" id="6324125">cr</span><span class="op" id="6324127">[</span><span class="num" id="6324128">0</span><span class="op" id="6324129">]</span><span class="op" id="6324130">[</span><span class="num" id="6324131">1</span><span class="op" id="6324132">:</span><span class="op" id="6324133">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324136">cdat1</span>&nbsp;<span class="op" id="6324142">:=</span>&nbsp;<span class="ident" id="6324145">cr</span><span class="op" id="6324147">[</span><span class="num" id="6324148">1</span><span class="op" id="6324149">]</span><span class="op" id="6324150">[</span><span class="num" id="6324151">1</span><span class="op" id="6324152">:</span><span class="op" id="6324153">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324156">cdat2</span>&nbsp;<span class="op" id="6324162">:=</span>&nbsp;<span class="ident" id="6324165">cr</span><span class="op" id="6324167">[</span><span class="num" id="6324168">2</span><span class="op" id="6324169">]</span><span class="op" id="6324170">[</span><span class="num" id="6324171">1</span><span class="op" id="6324172">:</span><span class="op" id="6324173">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324176">cdat3</span>&nbsp;<span class="op" id="6324182">:=</span>&nbsp;<span class="ident" id="6324185">cr</span><span class="op" id="6324187">[</span><span class="num" id="6324188">3</span><span class="op" id="6324189">]</span><span class="op" id="6324190">[</span><span class="num" id="6324191">1</span><span class="op" id="6324192">:</span><span class="op" id="6324193">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324196">cdat4</span>&nbsp;<span class="op" id="6324202">:=</span>&nbsp;<span class="ident" id="6324205">cr</span><span class="op" id="6324207">[</span><span class="num" id="6324208">4</span><span class="op" id="6324209">]</span><span class="op" id="6324210">[</span><span class="num" id="6324211">1</span><span class="op" id="6324212">:</span><span class="op" id="6324213">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324216">pdat</span>&nbsp;<span class="op" id="6324221">:=</span>&nbsp;<span class="ident" id="6324224">pr</span><span class="op" id="6324226">[</span><span class="num" id="6324227">1</span><span class="op" id="6324228">:</span><span class="op" id="6324229">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324232">n</span>&nbsp;<span class="op" id="6324234">:=</span>&nbsp;<span class="builtinfunc" id="6324237">len</span><span class="op" id="6324240">(</span><span class="ident" id="6324241">cdat0</span><span class="op" id="6324246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6324250">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324269">sum</span>&nbsp;<span class="op" id="6324273">:=</span>&nbsp;<span class="num" id="6324276">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324279">for</span>&nbsp;<span class="ident" id="6324283">i</span>&nbsp;<span class="op" id="6324285">:=</span>&nbsp;<span class="num" id="6324288">0</span><span class="op" id="6324289">;</span>&nbsp;<span class="ident" id="6324291">i</span>&nbsp;<span class="op" id="6324293">&lt;</span>&nbsp;<span class="ident" id="6324295">n</span><span class="op" id="6324296">;</span>&nbsp;<span class="ident" id="6324298">i</span><span class="op" id="6324299">++</span>&nbsp;<span class="op" id="6324302">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324306">cdat2</span><span class="op" id="6324311">[</span><span class="ident" id="6324312">i</span><span class="op" id="6324313">]</span>&nbsp;<span class="op" id="6324315">=</span>&nbsp;<span class="ident" id="6324317">cdat0</span><span class="op" id="6324322">[</span><span class="ident" id="6324323">i</span><span class="op" id="6324324">]</span>&nbsp;<span class="op" id="6324326">-</span>&nbsp;<span class="ident" id="6324328">pdat</span><span class="op" id="6324332">[</span><span class="ident" id="6324333">i</span><span class="op" id="6324334">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324338">sum</span>&nbsp;<span class="op" id="6324342">+=</span>&nbsp;<span class="ident" id="6324345">abs8</span><span class="op" id="6324349">(</span><span class="ident" id="6324350">cdat2</span><span class="op" id="6324355">[</span><span class="ident" id="6324356">i</span><span class="op" id="6324357">]</span><span class="op" id="6324358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324364">best</span>&nbsp;<span class="op" id="6324369">:=</span>&nbsp;<span class="ident" id="6324372">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324377">filter</span>&nbsp;<span class="op" id="6324384">:=</span>&nbsp;<span class="ident" id="6324387">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6324394">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324416">sum</span>&nbsp;<span class="op" id="6324420">=</span>&nbsp;<span class="num" id="6324422">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324425">for</span>&nbsp;<span class="ident" id="6324429">i</span>&nbsp;<span class="op" id="6324431">:=</span>&nbsp;<span class="num" id="6324434">0</span><span class="op" id="6324435">;</span>&nbsp;<span class="ident" id="6324437">i</span>&nbsp;<span class="op" id="6324439">&lt;</span>&nbsp;<span class="ident" id="6324441">bpp</span><span class="op" id="6324444">;</span>&nbsp;<span class="ident" id="6324446">i</span><span class="op" id="6324447">++</span>&nbsp;<span class="op" id="6324450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324454">cdat4</span><span class="op" id="6324459">[</span><span class="ident" id="6324460">i</span><span class="op" id="6324461">]</span>&nbsp;<span class="op" id="6324463">=</span>&nbsp;<span class="ident" id="6324465">cdat0</span><span class="op" id="6324470">[</span><span class="ident" id="6324471">i</span><span class="op" id="6324472">]</span>&nbsp;<span class="op" id="6324474">-</span>&nbsp;<span class="ident" id="6324476">pdat</span><span class="op" id="6324480">[</span><span class="ident" id="6324481">i</span><span class="op" id="6324482">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324486">sum</span>&nbsp;<span class="op" id="6324490">+=</span>&nbsp;<span class="ident" id="6324493">abs8</span><span class="op" id="6324497">(</span><span class="ident" id="6324498">cdat4</span><span class="op" id="6324503">[</span><span class="ident" id="6324504">i</span><span class="op" id="6324505">]</span><span class="op" id="6324506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324512">for</span>&nbsp;<span class="ident" id="6324516">i</span>&nbsp;<span class="op" id="6324518">:=</span>&nbsp;<span class="ident" id="6324521">bpp</span><span class="op" id="6324524">;</span>&nbsp;<span class="ident" id="6324526">i</span>&nbsp;<span class="op" id="6324528">&lt;</span>&nbsp;<span class="ident" id="6324530">n</span><span class="op" id="6324531">;</span>&nbsp;<span class="ident" id="6324533">i</span><span class="op" id="6324534">++</span>&nbsp;<span class="op" id="6324537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324541">cdat4</span><span class="op" id="6324546">[</span><span class="ident" id="6324547">i</span><span class="op" id="6324548">]</span>&nbsp;<span class="op" id="6324550">=</span>&nbsp;<span class="ident" id="6324552">cdat0</span><span class="op" id="6324557">[</span><span class="ident" id="6324558">i</span><span class="op" id="6324559">]</span>&nbsp;<span class="op" id="6324561">-</span>&nbsp;<span class="ident" id="6324563">paeth</span><span class="op" id="6324568">(</span><span class="ident" id="6324569">cdat0</span><span class="op" id="6324574">[</span><span class="ident" id="6324575">i</span><span class="op" id="6324576">-</span><span class="ident" id="6324577">bpp</span><span class="op" id="6324580">]</span><span class="op" id="6324581">,</span>&nbsp;<span class="ident" id="6324583">pdat</span><span class="op" id="6324587">[</span><span class="ident" id="6324588">i</span><span class="op" id="6324589">]</span><span class="op" id="6324590">,</span>&nbsp;<span class="ident" id="6324592">pdat</span><span class="op" id="6324596">[</span><span class="ident" id="6324597">i</span><span class="op" id="6324598">-</span><span class="ident" id="6324599">bpp</span><span class="op" id="6324602">]</span><span class="op" id="6324603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324607">sum</span>&nbsp;<span class="op" id="6324611">+=</span>&nbsp;<span class="ident" id="6324614">abs8</span><span class="op" id="6324618">(</span><span class="ident" id="6324619">cdat4</span><span class="op" id="6324624">[</span><span class="ident" id="6324625">i</span><span class="op" id="6324626">]</span><span class="op" id="6324627">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324631">if</span>&nbsp;<span class="ident" id="6324634">sum</span>&nbsp;<span class="op" id="6324638">&gt;=</span>&nbsp;<span class="ident" id="6324641">best</span>&nbsp;<span class="op" id="6324646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324651">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324665">if</span>&nbsp;<span class="ident" id="6324668">sum</span>&nbsp;<span class="op" id="6324672">&lt;</span>&nbsp;<span class="ident" id="6324674">best</span>&nbsp;<span class="op" id="6324679">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324683">best</span>&nbsp;<span class="op" id="6324688">=</span>&nbsp;<span class="ident" id="6324690">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324696">filter</span>&nbsp;<span class="op" id="6324703">=</span>&nbsp;<span class="ident" id="6324705">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6324718">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324739">sum</span>&nbsp;<span class="op" id="6324743">=</span>&nbsp;<span class="num" id="6324745">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324748">for</span>&nbsp;<span class="ident" id="6324752">i</span>&nbsp;<span class="op" id="6324754">:=</span>&nbsp;<span class="num" id="6324757">0</span><span class="op" id="6324758">;</span>&nbsp;<span class="ident" id="6324760">i</span>&nbsp;<span class="op" id="6324762">&lt;</span>&nbsp;<span class="ident" id="6324764">n</span><span class="op" id="6324765">;</span>&nbsp;<span class="ident" id="6324767">i</span><span class="op" id="6324768">++</span>&nbsp;<span class="op" id="6324771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324775">sum</span>&nbsp;<span class="op" id="6324779">+=</span>&nbsp;<span class="ident" id="6324782">abs8</span><span class="op" id="6324786">(</span><span class="ident" id="6324787">cdat0</span><span class="op" id="6324792">[</span><span class="ident" id="6324793">i</span><span class="op" id="6324794">]</span><span class="op" id="6324795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324799">if</span>&nbsp;<span class="ident" id="6324802">sum</span>&nbsp;<span class="op" id="6324806">&gt;=</span>&nbsp;<span class="ident" id="6324809">best</span>&nbsp;<span class="op" id="6324814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324819">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324833">if</span>&nbsp;<span class="ident" id="6324836">sum</span>&nbsp;<span class="op" id="6324840">&lt;</span>&nbsp;<span class="ident" id="6324842">best</span>&nbsp;<span class="op" id="6324847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324851">best</span>&nbsp;<span class="op" id="6324856">=</span>&nbsp;<span class="ident" id="6324858">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324864">filter</span>&nbsp;<span class="op" id="6324871">=</span>&nbsp;<span class="ident" id="6324873">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6324885">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324905">sum</span>&nbsp;<span class="op" id="6324909">=</span>&nbsp;<span class="num" id="6324911">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324914">for</span>&nbsp;<span class="ident" id="6324918">i</span>&nbsp;<span class="op" id="6324920">:=</span>&nbsp;<span class="num" id="6324923">0</span><span class="op" id="6324924">;</span>&nbsp;<span class="ident" id="6324926">i</span>&nbsp;<span class="op" id="6324928">&lt;</span>&nbsp;<span class="ident" id="6324930">bpp</span><span class="op" id="6324933">;</span>&nbsp;<span class="ident" id="6324935">i</span><span class="op" id="6324936">++</span>&nbsp;<span class="op" id="6324939">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324943">cdat1</span><span class="op" id="6324948">[</span><span class="ident" id="6324949">i</span><span class="op" id="6324950">]</span>&nbsp;<span class="op" id="6324952">=</span>&nbsp;<span class="ident" id="6324954">cdat0</span><span class="op" id="6324959">[</span><span class="ident" id="6324960">i</span><span class="op" id="6324961">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324965">sum</span>&nbsp;<span class="op" id="6324969">+=</span>&nbsp;<span class="ident" id="6324972">abs8</span><span class="op" id="6324976">(</span><span class="ident" id="6324977">cdat1</span><span class="op" id="6324982">[</span><span class="ident" id="6324983">i</span><span class="op" id="6324984">]</span><span class="op" id="6324985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324991">for</span>&nbsp;<span class="ident" id="6324995">i</span>&nbsp;<span class="op" id="6324997">:=</span>&nbsp;<span class="ident" id="6325000">bpp</span><span class="op" id="6325003">;</span>&nbsp;<span class="ident" id="6325005">i</span>&nbsp;<span class="op" id="6325007">&lt;</span>&nbsp;<span class="ident" id="6325009">n</span><span class="op" id="6325010">;</span>&nbsp;<span class="ident" id="6325012">i</span><span class="op" id="6325013">++</span>&nbsp;<span class="op" id="6325016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325020">cdat1</span><span class="op" id="6325025">[</span><span class="ident" id="6325026">i</span><span class="op" id="6325027">]</span>&nbsp;<span class="op" id="6325029">=</span>&nbsp;<span class="ident" id="6325031">cdat0</span><span class="op" id="6325036">[</span><span class="ident" id="6325037">i</span><span class="op" id="6325038">]</span>&nbsp;<span class="op" id="6325040">-</span>&nbsp;<span class="ident" id="6325042">cdat0</span><span class="op" id="6325047">[</span><span class="ident" id="6325048">i</span><span class="op" id="6325049">-</span><span class="ident" id="6325050">bpp</span><span class="op" id="6325053">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325057">sum</span>&nbsp;<span class="op" id="6325061">+=</span>&nbsp;<span class="ident" id="6325064">abs8</span><span class="op" id="6325068">(</span><span class="ident" id="6325069">cdat1</span><span class="op" id="6325074">[</span><span class="ident" id="6325075">i</span><span class="op" id="6325076">]</span><span class="op" id="6325077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325081">if</span>&nbsp;<span class="ident" id="6325084">sum</span>&nbsp;<span class="op" id="6325088">&gt;=</span>&nbsp;<span class="ident" id="6325091">best</span>&nbsp;<span class="op" id="6325096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325101">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325112">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325115">if</span>&nbsp;<span class="ident" id="6325118">sum</span>&nbsp;<span class="op" id="6325122">&lt;</span>&nbsp;<span class="ident" id="6325124">best</span>&nbsp;<span class="op" id="6325129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325133">best</span>&nbsp;<span class="op" id="6325138">=</span>&nbsp;<span class="ident" id="6325140">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325146">filter</span>&nbsp;<span class="op" id="6325153">=</span>&nbsp;<span class="ident" id="6325155">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6325166">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325190">sum</span>&nbsp;<span class="op" id="6325194">=</span>&nbsp;<span class="num" id="6325196">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325199">for</span>&nbsp;<span class="ident" id="6325203">i</span>&nbsp;<span class="op" id="6325205">:=</span>&nbsp;<span class="num" id="6325208">0</span><span class="op" id="6325209">;</span>&nbsp;<span class="ident" id="6325211">i</span>&nbsp;<span class="op" id="6325213">&lt;</span>&nbsp;<span class="ident" id="6325215">bpp</span><span class="op" id="6325218">;</span>&nbsp;<span class="ident" id="6325220">i</span><span class="op" id="6325221">++</span>&nbsp;<span class="op" id="6325224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325228">cdat3</span><span class="op" id="6325233">[</span><span class="ident" id="6325234">i</span><span class="op" id="6325235">]</span>&nbsp;<span class="op" id="6325237">=</span>&nbsp;<span class="ident" id="6325239">cdat0</span><span class="op" id="6325244">[</span><span class="ident" id="6325245">i</span><span class="op" id="6325246">]</span>&nbsp;<span class="op" id="6325248">-</span>&nbsp;<span class="ident" id="6325250">pdat</span><span class="op" id="6325254">[</span><span class="ident" id="6325255">i</span><span class="op" id="6325256">]</span><span class="op" id="6325257">/</span><span class="num" id="6325258">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325262">sum</span>&nbsp;<span class="op" id="6325266">+=</span>&nbsp;<span class="ident" id="6325269">abs8</span><span class="op" id="6325273">(</span><span class="ident" id="6325274">cdat3</span><span class="op" id="6325279">[</span><span class="ident" id="6325280">i</span><span class="op" id="6325281">]</span><span class="op" id="6325282">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325288">for</span>&nbsp;<span class="ident" id="6325292">i</span>&nbsp;<span class="op" id="6325294">:=</span>&nbsp;<span class="ident" id="6325297">bpp</span><span class="op" id="6325300">;</span>&nbsp;<span class="ident" id="6325302">i</span>&nbsp;<span class="op" id="6325304">&lt;</span>&nbsp;<span class="ident" id="6325306">n</span><span class="op" id="6325307">;</span>&nbsp;<span class="ident" id="6325309">i</span><span class="op" id="6325310">++</span>&nbsp;<span class="op" id="6325313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325317">cdat3</span><span class="op" id="6325322">[</span><span class="ident" id="6325323">i</span><span class="op" id="6325324">]</span>&nbsp;<span class="op" id="6325326">=</span>&nbsp;<span class="ident" id="6325328">cdat0</span><span class="op" id="6325333">[</span><span class="ident" id="6325334">i</span><span class="op" id="6325335">]</span>&nbsp;<span class="op" id="6325337">-</span>&nbsp;<span class="builtintype" id="6325339">uint8</span><span class="op" id="6325344">(</span><span class="op" id="6325345">(</span><span class="builtintype" id="6325346">int</span><span class="op" id="6325349">(</span><span class="ident" id="6325350">cdat0</span><span class="op" id="6325355">[</span><span class="ident" id="6325356">i</span><span class="op" id="6325357">-</span><span class="ident" id="6325358">bpp</span><span class="op" id="6325361">]</span><span class="op" id="6325362">)</span><span class="op" id="6325363">+</span><span class="builtintype" id="6325364">int</span><span class="op" id="6325367">(</span><span class="ident" id="6325368">pdat</span><span class="op" id="6325372">[</span><span class="ident" id="6325373">i</span><span class="op" id="6325374">]</span><span class="op" id="6325375">)</span><span class="op" id="6325376">)</span><span class="op" id="6325377">/</span><span class="num" id="6325378">2</span><span class="op" id="6325379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325383">sum</span>&nbsp;<span class="op" id="6325387">+=</span>&nbsp;<span class="ident" id="6325390">abs8</span><span class="op" id="6325394">(</span><span class="ident" id="6325395">cdat3</span><span class="op" id="6325400">[</span><span class="ident" id="6325401">i</span><span class="op" id="6325402">]</span><span class="op" id="6325403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325407">if</span>&nbsp;<span class="ident" id="6325410">sum</span>&nbsp;<span class="op" id="6325414">&gt;=</span>&nbsp;<span class="ident" id="6325417">best</span>&nbsp;<span class="op" id="6325422">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325427">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325441">if</span>&nbsp;<span class="ident" id="6325444">sum</span>&nbsp;<span class="op" id="6325448">&lt;</span>&nbsp;<span class="ident" id="6325450">best</span>&nbsp;<span class="op" id="6325455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325459">best</span>&nbsp;<span class="op" id="6325464">=</span>&nbsp;<span class="ident" id="6325466">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325472">filter</span>&nbsp;<span class="op" id="6325479">=</span>&nbsp;<span class="ident" id="6325481">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325496">return</span>&nbsp;<span class="ident" id="6325503">filter</span><br>
<span class="lineno"></span><span class="op" id="6325510">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="6325513">func</span>&nbsp;<span class="ident" id="6325518">writeImage</span><span class="op" id="6325528">(</span><span class="ident" id="6325529">w</span>&nbsp;<span class="ident" id="6325531">io</span><span class="op" id="6325533">.</span><span class="ident" id="6325534">Writer</span><span class="op" id="6325540">,</span>&nbsp;<span class="ident" id="6325542">m</span>&nbsp;<span class="ident" id="6325544">image</span><span class="op" id="6325549">.</span><span class="ident" id="6325550">Image</span><span class="op" id="6325555">,</span>&nbsp;<span class="ident" id="6325557">cb</span>&nbsp;<span class="builtintype" id="6325560">int</span><span class="op" id="6325563">,</span>&nbsp;<span class="ident" id="6325565">level</span>&nbsp;<span class="builtintype" id="6325571">int</span><span class="op" id="6325574">)</span>&nbsp;<span class="builtintype" id="6325576">error</span>&nbsp;<span class="op" id="6325582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325585">zw</span><span class="op" id="6325587">,</span>&nbsp;<span class="ident" id="6325589">err</span>&nbsp;<span class="op" id="6325593">:=</span>&nbsp;<span class="ident" id="6325596">zlib</span><span class="op" id="6325600">.</span><span class="ident" id="6325601">NewWriterLevel</span><span class="op" id="6325615">(</span><span class="ident" id="6325616">w</span><span class="op" id="6325617">,</span>&nbsp;<span class="ident" id="6325619">level</span><span class="op" id="6325624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325627">if</span>&nbsp;<span class="ident" id="6325630">err</span>&nbsp;<span class="op" id="6325634">!=</span>&nbsp;<span class="ident" id="6325637">nil</span>&nbsp;<span class="op" id="6325641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325645">return</span>&nbsp;<span class="ident" id="6325652">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325660">defer</span>&nbsp;<span class="ident" id="6325666">zw</span><span class="op" id="6325668">.</span><span class="ident" id="6325669">Close</span><span class="op" id="6325674">(</span><span class="op" id="6325675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325679">bpp</span>&nbsp;<span class="op" id="6325683">:=</span>&nbsp;<span class="num" id="6325686">0</span>&nbsp;<span class="comment" id="6325688">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325710">switch</span>&nbsp;<span class="ident" id="6325717">cb</span>&nbsp;<span class="op" id="6325720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325723">case</span>&nbsp;<span class="ident" id="6325728">cbG8</span><span class="op" id="6325732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325736">bpp</span>&nbsp;<span class="op" id="6325740">=</span>&nbsp;<span class="num" id="6325742">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325745">case</span>&nbsp;<span class="ident" id="6325750">cbTC8</span><span class="op" id="6325755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325759">bpp</span>&nbsp;<span class="op" id="6325763">=</span>&nbsp;<span class="num" id="6325765">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325768">case</span>&nbsp;<span class="ident" id="6325773">cbP8</span><span class="op" id="6325777">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325781">bpp</span>&nbsp;<span class="op" id="6325785">=</span>&nbsp;<span class="num" id="6325787">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325790">case</span>&nbsp;<span class="ident" id="6325795">cbTCA8</span><span class="op" id="6325801">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325805">bpp</span>&nbsp;<span class="op" id="6325809">=</span>&nbsp;<span class="num" id="6325811">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325814">case</span>&nbsp;<span class="ident" id="6325819">cbTC16</span><span class="op" id="6325825">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325829">bpp</span>&nbsp;<span class="op" id="6325833">=</span>&nbsp;<span class="num" id="6325835">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325838">case</span>&nbsp;<span class="ident" id="6325843">cbTCA16</span><span class="op" id="6325850">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325854">bpp</span>&nbsp;<span class="op" id="6325858">=</span>&nbsp;<span class="num" id="6325860">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325863">case</span>&nbsp;<span class="ident" id="6325868">cbG16</span><span class="op" id="6325873">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325877">bpp</span>&nbsp;<span class="op" id="6325881">=</span>&nbsp;<span class="num" id="6325883">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6325889">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6325954">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6326030">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6326117">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6326204">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326269">b</span>&nbsp;<span class="op" id="6326271">:=</span>&nbsp;<span class="ident" id="6326274">m</span><span class="op" id="6326275">.</span><span class="ident" id="6326276">Bounds</span><span class="op" id="6326282">(</span><span class="op" id="6326283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326286">var</span>&nbsp;<span class="ident" id="6326290">cr</span>&nbsp;<span class="op" id="6326293">[</span><span class="ident" id="6326294">nFilter</span><span class="op" id="6326301">]</span><span class="op" id="6326302">[</span><span class="op" id="6326303">]</span><span class="builtintype" id="6326304">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326311">for</span>&nbsp;<span class="ident" id="6326315">i</span>&nbsp;<span class="op" id="6326317">:=</span>&nbsp;<span class="keyword" id="6326320">range</span>&nbsp;<span class="ident" id="6326326">cr</span>&nbsp;<span class="op" id="6326329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326333">cr</span><span class="op" id="6326335">[</span><span class="ident" id="6326336">i</span><span class="op" id="6326337">]</span>&nbsp;<span class="op" id="6326339">=</span>&nbsp;<span class="builtinfunc" id="6326341">make</span><span class="op" id="6326345">(</span><span class="op" id="6326346">[</span><span class="op" id="6326347">]</span><span class="builtintype" id="6326348">uint8</span><span class="op" id="6326353">,</span>&nbsp;<span class="num" id="6326355">1</span><span class="op" id="6326356">+</span><span class="ident" id="6326357">bpp</span><span class="op" id="6326360">*</span><span class="ident" id="6326361">b</span><span class="op" id="6326362">.</span><span class="ident" id="6326363">Dx</span><span class="op" id="6326365">(</span><span class="op" id="6326366">)</span><span class="op" id="6326367">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326371">cr</span><span class="op" id="6326373">[</span><span class="ident" id="6326374">i</span><span class="op" id="6326375">]</span><span class="op" id="6326376">[</span><span class="num" id="6326377">0</span><span class="op" id="6326378">]</span>&nbsp;<span class="op" id="6326380">=</span>&nbsp;<span class="builtintype" id="6326382">uint8</span><span class="op" id="6326387">(</span><span class="ident" id="6326388">i</span><span class="op" id="6326389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326395">pr</span>&nbsp;<span class="op" id="6326398">:=</span>&nbsp;<span class="builtinfunc" id="6326401">make</span><span class="op" id="6326405">(</span><span class="op" id="6326406">[</span><span class="op" id="6326407">]</span><span class="builtintype" id="6326408">uint8</span><span class="op" id="6326413">,</span>&nbsp;<span class="num" id="6326415">1</span><span class="op" id="6326416">+</span><span class="ident" id="6326417">bpp</span><span class="op" id="6326420">*</span><span class="ident" id="6326421">b</span><span class="op" id="6326422">.</span><span class="ident" id="6326423">Dx</span><span class="op" id="6326425">(</span><span class="op" id="6326426">)</span><span class="op" id="6326427">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326431">gray</span><span class="op" id="6326435">,</span>&nbsp;<span class="ident" id="6326437">_</span>&nbsp;<span class="op" id="6326439">:=</span>&nbsp;<span class="ident" id="6326442">m</span><span class="op" id="6326443">.</span><span class="op" id="6326444">(</span><span class="op" id="6326445">*</span><span class="ident" id="6326446">image</span><span class="op" id="6326451">.</span><span class="ident" id="6326452">Gray</span><span class="op" id="6326456">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326459">rgba</span><span class="op" id="6326463">,</span>&nbsp;<span class="ident" id="6326465">_</span>&nbsp;<span class="op" id="6326467">:=</span>&nbsp;<span class="ident" id="6326470">m</span><span class="op" id="6326471">.</span><span class="op" id="6326472">(</span><span class="op" id="6326473">*</span><span class="ident" id="6326474">image</span><span class="op" id="6326479">.</span><span class="ident" id="6326480">RGBA</span><span class="op" id="6326484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326487">paletted</span><span class="op" id="6326495">,</span>&nbsp;<span class="ident" id="6326497">_</span>&nbsp;<span class="op" id="6326499">:=</span>&nbsp;<span class="ident" id="6326502">m</span><span class="op" id="6326503">.</span><span class="op" id="6326504">(</span><span class="op" id="6326505">*</span><span class="ident" id="6326506">image</span><span class="op" id="6326511">.</span><span class="ident" id="6326512">Paletted</span><span class="op" id="6326520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326523">nrgba</span><span class="op" id="6326528">,</span>&nbsp;<span class="ident" id="6326530">_</span>&nbsp;<span class="op" id="6326532">:=</span>&nbsp;<span class="ident" id="6326535">m</span><span class="op" id="6326536">.</span><span class="op" id="6326537">(</span><span class="op" id="6326538">*</span><span class="ident" id="6326539">image</span><span class="op" id="6326544">.</span><span class="ident" id="6326545">NRGBA</span><span class="op" id="6326550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326554">for</span>&nbsp;<span class="ident" id="6326558">y</span>&nbsp;<span class="op" id="6326560">:=</span>&nbsp;<span class="ident" id="6326563">b</span><span class="op" id="6326564">.</span><span class="ident" id="6326565">Min</span><span class="op" id="6326568">.</span><span class="ident" id="6326569">Y</span><span class="op" id="6326570">;</span>&nbsp;<span class="ident" id="6326572">y</span>&nbsp;<span class="op" id="6326574">&lt;</span>&nbsp;<span class="ident" id="6326576">b</span><span class="op" id="6326577">.</span><span class="ident" id="6326578">Max</span><span class="op" id="6326581">.</span><span class="ident" id="6326582">Y</span><span class="op" id="6326583">;</span>&nbsp;<span class="ident" id="6326585">y</span><span class="op" id="6326586">++</span>&nbsp;<span class="op" id="6326589">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6326593">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326628">i</span>&nbsp;<span class="op" id="6326630">:=</span>&nbsp;<span class="num" id="6326633">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326637">switch</span>&nbsp;<span class="ident" id="6326644">cb</span>&nbsp;<span class="op" id="6326647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326651">case</span>&nbsp;<span class="ident" id="6326656">cbG8</span><span class="op" id="6326660">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326665">if</span>&nbsp;<span class="ident" id="6326668">gray</span>&nbsp;<span class="op" id="6326673">!=</span>&nbsp;<span class="ident" id="6326676">nil</span>&nbsp;<span class="op" id="6326680">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326686">offset</span>&nbsp;<span class="op" id="6326693">:=</span>&nbsp;<span class="op" id="6326696">(</span><span class="ident" id="6326697">y</span>&nbsp;<span class="op" id="6326699">-</span>&nbsp;<span class="ident" id="6326701">b</span><span class="op" id="6326702">.</span><span class="ident" id="6326703">Min</span><span class="op" id="6326706">.</span><span class="ident" id="6326707">Y</span><span class="op" id="6326708">)</span>&nbsp;<span class="op" id="6326710">*</span>&nbsp;<span class="ident" id="6326712">gray</span><span class="op" id="6326716">.</span><span class="ident" id="6326717">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6326728">copy</span><span class="op" id="6326732">(</span><span class="ident" id="6326733">cr</span><span class="op" id="6326735">[</span><span class="num" id="6326736">0</span><span class="op" id="6326737">]</span><span class="op" id="6326738">[</span><span class="num" id="6326739">1</span><span class="op" id="6326740">:</span><span class="op" id="6326741">]</span><span class="op" id="6326742">,</span>&nbsp;<span class="ident" id="6326744">gray</span><span class="op" id="6326748">.</span><span class="ident" id="6326749">Pix</span><span class="op" id="6326752">[</span><span class="ident" id="6326753">offset</span><span class="op" id="6326759">:</span><span class="ident" id="6326760">offset</span><span class="op" id="6326766">+</span><span class="ident" id="6326767">b</span><span class="op" id="6326768">.</span><span class="ident" id="6326769">Dx</span><span class="op" id="6326771">(</span><span class="op" id="6326772">)</span><span class="op" id="6326773">]</span><span class="op" id="6326774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326779">}</span>&nbsp;<span class="keyword" id="6326781">else</span>&nbsp;<span class="op" id="6326786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326792">for</span>&nbsp;<span class="ident" id="6326796">x</span>&nbsp;<span class="op" id="6326798">:=</span>&nbsp;<span class="ident" id="6326801">b</span><span class="op" id="6326802">.</span><span class="ident" id="6326803">Min</span><span class="op" id="6326806">.</span><span class="ident" id="6326807">X</span><span class="op" id="6326808">;</span>&nbsp;<span class="ident" id="6326810">x</span>&nbsp;<span class="op" id="6326812">&lt;</span>&nbsp;<span class="ident" id="6326814">b</span><span class="op" id="6326815">.</span><span class="ident" id="6326816">Max</span><span class="op" id="6326819">.</span><span class="ident" id="6326820">X</span><span class="op" id="6326821">;</span>&nbsp;<span class="ident" id="6326823">x</span><span class="op" id="6326824">++</span>&nbsp;<span class="op" id="6326827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326834">c</span>&nbsp;<span class="op" id="6326836">:=</span>&nbsp;<span class="ident" id="6326839">color</span><span class="op" id="6326844">.</span><span class="ident" id="6326845">GrayModel</span><span class="op" id="6326854">.</span><span class="ident" id="6326855">Convert</span><span class="op" id="6326862">(</span><span class="ident" id="6326863">m</span><span class="op" id="6326864">.</span><span class="ident" id="6326865">At</span><span class="op" id="6326867">(</span><span class="ident" id="6326868">x</span><span class="op" id="6326869">,</span>&nbsp;<span class="ident" id="6326871">y</span><span class="op" id="6326872">)</span><span class="op" id="6326873">)</span><span class="op" id="6326874">.</span><span class="op" id="6326875">(</span><span class="ident" id="6326876">color</span><span class="op" id="6326881">.</span><span class="ident" id="6326882">Gray</span><span class="op" id="6326886">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326893">cr</span><span class="op" id="6326895">[</span><span class="num" id="6326896">0</span><span class="op" id="6326897">]</span><span class="op" id="6326898">[</span><span class="ident" id="6326899">i</span><span class="op" id="6326900">]</span>&nbsp;<span class="op" id="6326902">=</span>&nbsp;<span class="ident" id="6326904">c</span><span class="op" id="6326905">.</span><span class="ident" id="6326906">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326913">i</span><span class="op" id="6326914">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326930">case</span>&nbsp;<span class="ident" id="6326935">cbTC8</span><span class="op" id="6326940">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6326945">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327017">cr0</span>&nbsp;<span class="op" id="6327021">:=</span>&nbsp;<span class="ident" id="6327024">cr</span><span class="op" id="6327026">[</span><span class="num" id="6327027">0</span><span class="op" id="6327028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327033">stride</span><span class="op" id="6327039">,</span>&nbsp;<span class="ident" id="6327041">pix</span>&nbsp;<span class="op" id="6327045">:=</span>&nbsp;<span class="num" id="6327048">0</span><span class="op" id="6327049">,</span>&nbsp;<span class="op" id="6327051">[</span><span class="op" id="6327052">]</span><span class="builtintype" id="6327053">byte</span><span class="op" id="6327057">(</span><span class="ident" id="6327058">nil</span><span class="op" id="6327061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327066">if</span>&nbsp;<span class="ident" id="6327069">rgba</span>&nbsp;<span class="op" id="6327074">!=</span>&nbsp;<span class="ident" id="6327077">nil</span>&nbsp;<span class="op" id="6327081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327087">stride</span><span class="op" id="6327093">,</span>&nbsp;<span class="ident" id="6327095">pix</span>&nbsp;<span class="op" id="6327099">=</span>&nbsp;<span class="ident" id="6327101">rgba</span><span class="op" id="6327105">.</span><span class="ident" id="6327106">Stride</span><span class="op" id="6327112">,</span>&nbsp;<span class="ident" id="6327114">rgba</span><span class="op" id="6327118">.</span><span class="ident" id="6327119">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327126">}</span>&nbsp;<span class="keyword" id="6327128">else</span>&nbsp;<span class="keyword" id="6327133">if</span>&nbsp;<span class="ident" id="6327136">nrgba</span>&nbsp;<span class="op" id="6327142">!=</span>&nbsp;<span class="ident" id="6327145">nil</span>&nbsp;<span class="op" id="6327149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327155">stride</span><span class="op" id="6327161">,</span>&nbsp;<span class="ident" id="6327163">pix</span>&nbsp;<span class="op" id="6327167">=</span>&nbsp;<span class="ident" id="6327169">nrgba</span><span class="op" id="6327174">.</span><span class="ident" id="6327175">Stride</span><span class="op" id="6327181">,</span>&nbsp;<span class="ident" id="6327183">nrgba</span><span class="op" id="6327188">.</span><span class="ident" id="6327189">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327201">if</span>&nbsp;<span class="ident" id="6327204">stride</span>&nbsp;<span class="op" id="6327211">!=</span>&nbsp;<span class="num" id="6327214">0</span>&nbsp;<span class="op" id="6327216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327222">j0</span>&nbsp;<span class="op" id="6327225">:=</span>&nbsp;<span class="op" id="6327228">(</span><span class="ident" id="6327229">y</span>&nbsp;<span class="op" id="6327231">-</span>&nbsp;<span class="ident" id="6327233">b</span><span class="op" id="6327234">.</span><span class="ident" id="6327235">Min</span><span class="op" id="6327238">.</span><span class="ident" id="6327239">Y</span><span class="op" id="6327240">)</span>&nbsp;<span class="op" id="6327242">*</span>&nbsp;<span class="ident" id="6327244">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327255">j1</span>&nbsp;<span class="op" id="6327258">:=</span>&nbsp;<span class="ident" id="6327261">j0</span>&nbsp;<span class="op" id="6327264">+</span>&nbsp;<span class="ident" id="6327266">b</span><span class="op" id="6327267">.</span><span class="ident" id="6327268">Dx</span><span class="op" id="6327270">(</span><span class="op" id="6327271">)</span><span class="op" id="6327272">*</span><span class="num" id="6327273">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327279">for</span>&nbsp;<span class="ident" id="6327283">j</span>&nbsp;<span class="op" id="6327285">:=</span>&nbsp;<span class="ident" id="6327288">j0</span><span class="op" id="6327290">;</span>&nbsp;<span class="ident" id="6327292">j</span>&nbsp;<span class="op" id="6327294">&lt;</span>&nbsp;<span class="ident" id="6327296">j1</span><span class="op" id="6327298">;</span>&nbsp;<span class="ident" id="6327300">j</span>&nbsp;<span class="op" id="6327302">+=</span>&nbsp;<span class="num" id="6327305">4</span>&nbsp;<span class="op" id="6327307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327314">cr0</span><span class="op" id="6327317">[</span><span class="ident" id="6327318">i</span><span class="op" id="6327319">+</span><span class="num" id="6327320">0</span><span class="op" id="6327321">]</span>&nbsp;<span class="op" id="6327323">=</span>&nbsp;<span class="ident" id="6327325">pix</span><span class="op" id="6327328">[</span><span class="ident" id="6327329">j</span><span class="op" id="6327330">+</span><span class="num" id="6327331">0</span><span class="op" id="6327332">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327339">cr0</span><span class="op" id="6327342">[</span><span class="ident" id="6327343">i</span><span class="op" id="6327344">+</span><span class="num" id="6327345">1</span><span class="op" id="6327346">]</span>&nbsp;<span class="op" id="6327348">=</span>&nbsp;<span class="ident" id="6327350">pix</span><span class="op" id="6327353">[</span><span class="ident" id="6327354">j</span><span class="op" id="6327355">+</span><span class="num" id="6327356">1</span><span class="op" id="6327357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327364">cr0</span><span class="op" id="6327367">[</span><span class="ident" id="6327368">i</span><span class="op" id="6327369">+</span><span class="num" id="6327370">2</span><span class="op" id="6327371">]</span>&nbsp;<span class="op" id="6327373">=</span>&nbsp;<span class="ident" id="6327375">pix</span><span class="op" id="6327378">[</span><span class="ident" id="6327379">j</span><span class="op" id="6327380">+</span><span class="num" id="6327381">2</span><span class="op" id="6327382">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327389">i</span>&nbsp;<span class="op" id="6327391">+=</span>&nbsp;<span class="num" id="6327394">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327405">}</span>&nbsp;<span class="keyword" id="6327407">else</span>&nbsp;<span class="op" id="6327412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327418">for</span>&nbsp;<span class="ident" id="6327422">x</span>&nbsp;<span class="op" id="6327424">:=</span>&nbsp;<span class="ident" id="6327427">b</span><span class="op" id="6327428">.</span><span class="ident" id="6327429">Min</span><span class="op" id="6327432">.</span><span class="ident" id="6327433">X</span><span class="op" id="6327434">;</span>&nbsp;<span class="ident" id="6327436">x</span>&nbsp;<span class="op" id="6327438">&lt;</span>&nbsp;<span class="ident" id="6327440">b</span><span class="op" id="6327441">.</span><span class="ident" id="6327442">Max</span><span class="op" id="6327445">.</span><span class="ident" id="6327446">X</span><span class="op" id="6327447">;</span>&nbsp;<span class="ident" id="6327449">x</span><span class="op" id="6327450">++</span>&nbsp;<span class="op" id="6327453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327460">r</span><span class="op" id="6327461">,</span>&nbsp;<span class="ident" id="6327463">g</span><span class="op" id="6327464">,</span>&nbsp;<span class="ident" id="6327466">b</span><span class="op" id="6327467">,</span>&nbsp;<span class="ident" id="6327469">_</span>&nbsp;<span class="op" id="6327471">:=</span>&nbsp;<span class="ident" id="6327474">m</span><span class="op" id="6327475">.</span><span class="ident" id="6327476">At</span><span class="op" id="6327478">(</span><span class="ident" id="6327479">x</span><span class="op" id="6327480">,</span>&nbsp;<span class="ident" id="6327482">y</span><span class="op" id="6327483">)</span><span class="op" id="6327484">.</span><span class="ident" id="6327485">RGBA</span><span class="op" id="6327489">(</span><span class="op" id="6327490">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327497">cr0</span><span class="op" id="6327500">[</span><span class="ident" id="6327501">i</span><span class="op" id="6327502">+</span><span class="num" id="6327503">0</span><span class="op" id="6327504">]</span>&nbsp;<span class="op" id="6327506">=</span>&nbsp;<span class="builtintype" id="6327508">uint8</span><span class="op" id="6327513">(</span><span class="ident" id="6327514">r</span>&nbsp;<span class="op" id="6327516">&gt;&gt;</span>&nbsp;<span class="num" id="6327519">8</span><span class="op" id="6327520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327527">cr0</span><span class="op" id="6327530">[</span><span class="ident" id="6327531">i</span><span class="op" id="6327532">+</span><span class="num" id="6327533">1</span><span class="op" id="6327534">]</span>&nbsp;<span class="op" id="6327536">=</span>&nbsp;<span class="builtintype" id="6327538">uint8</span><span class="op" id="6327543">(</span><span class="ident" id="6327544">g</span>&nbsp;<span class="op" id="6327546">&gt;&gt;</span>&nbsp;<span class="num" id="6327549">8</span><span class="op" id="6327550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327557">cr0</span><span class="op" id="6327560">[</span><span class="ident" id="6327561">i</span><span class="op" id="6327562">+</span><span class="num" id="6327563">2</span><span class="op" id="6327564">]</span>&nbsp;<span class="op" id="6327566">=</span>&nbsp;<span class="builtintype" id="6327568">uint8</span><span class="op" id="6327573">(</span><span class="ident" id="6327574">b</span>&nbsp;<span class="op" id="6327576">&gt;&gt;</span>&nbsp;<span class="num" id="6327579">8</span><span class="op" id="6327580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327587">i</span>&nbsp;<span class="op" id="6327589">+=</span>&nbsp;<span class="num" id="6327592">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327598">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327607">case</span>&nbsp;<span class="ident" id="6327612">cbP8</span><span class="op" id="6327616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327621">if</span>&nbsp;<span class="ident" id="6327624">paletted</span>&nbsp;<span class="op" id="6327633">!=</span>&nbsp;<span class="ident" id="6327636">nil</span>&nbsp;<span class="op" id="6327640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327646">offset</span>&nbsp;<span class="op" id="6327653">:=</span>&nbsp;<span class="op" id="6327656">(</span><span class="ident" id="6327657">y</span>&nbsp;<span class="op" id="6327659">-</span>&nbsp;<span class="ident" id="6327661">b</span><span class="op" id="6327662">.</span><span class="ident" id="6327663">Min</span><span class="op" id="6327666">.</span><span class="ident" id="6327667">Y</span><span class="op" id="6327668">)</span>&nbsp;<span class="op" id="6327670">*</span>&nbsp;<span class="ident" id="6327672">paletted</span><span class="op" id="6327680">.</span><span class="ident" id="6327681">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6327692">copy</span><span class="op" id="6327696">(</span><span class="ident" id="6327697">cr</span><span class="op" id="6327699">[</span><span class="num" id="6327700">0</span><span class="op" id="6327701">]</span><span class="op" id="6327702">[</span><span class="num" id="6327703">1</span><span class="op" id="6327704">:</span><span class="op" id="6327705">]</span><span class="op" id="6327706">,</span>&nbsp;<span class="ident" id="6327708">paletted</span><span class="op" id="6327716">.</span><span class="ident" id="6327717">Pix</span><span class="op" id="6327720">[</span><span class="ident" id="6327721">offset</span><span class="op" id="6327727">:</span><span class="ident" id="6327728">offset</span><span class="op" id="6327734">+</span><span class="ident" id="6327735">b</span><span class="op" id="6327736">.</span><span class="ident" id="6327737">Dx</span><span class="op" id="6327739">(</span><span class="op" id="6327740">)</span><span class="op" id="6327741">]</span><span class="op" id="6327742">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327747">}</span>&nbsp;<span class="keyword" id="6327749">else</span>&nbsp;<span class="op" id="6327754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327760">pi</span>&nbsp;<span class="op" id="6327763">:=</span>&nbsp;<span class="ident" id="6327766">m</span><span class="op" id="6327767">.</span><span class="op" id="6327768">(</span><span class="ident" id="6327769">image</span><span class="op" id="6327774">.</span><span class="ident" id="6327775">PalettedImage</span><span class="op" id="6327788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327794">for</span>&nbsp;<span class="ident" id="6327798">x</span>&nbsp;<span class="op" id="6327800">:=</span>&nbsp;<span class="ident" id="6327803">b</span><span class="op" id="6327804">.</span><span class="ident" id="6327805">Min</span><span class="op" id="6327808">.</span><span class="ident" id="6327809">X</span><span class="op" id="6327810">;</span>&nbsp;<span class="ident" id="6327812">x</span>&nbsp;<span class="op" id="6327814">&lt;</span>&nbsp;<span class="ident" id="6327816">b</span><span class="op" id="6327817">.</span><span class="ident" id="6327818">Max</span><span class="op" id="6327821">.</span><span class="ident" id="6327822">X</span><span class="op" id="6327823">;</span>&nbsp;<span class="ident" id="6327825">x</span><span class="op" id="6327826">++</span>&nbsp;<span class="op" id="6327829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327836">cr</span><span class="op" id="6327838">[</span><span class="num" id="6327839">0</span><span class="op" id="6327840">]</span><span class="op" id="6327841">[</span><span class="ident" id="6327842">i</span><span class="op" id="6327843">]</span>&nbsp;<span class="op" id="6327845">=</span>&nbsp;<span class="ident" id="6327847">pi</span><span class="op" id="6327849">.</span><span class="ident" id="6327850">ColorIndexAt</span><span class="op" id="6327862">(</span><span class="ident" id="6327863">x</span><span class="op" id="6327864">,</span>&nbsp;<span class="ident" id="6327866">y</span><span class="op" id="6327867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327874">i</span>&nbsp;<span class="op" id="6327876">+=</span>&nbsp;<span class="num" id="6327879">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327894">case</span>&nbsp;<span class="ident" id="6327899">cbTCA8</span><span class="op" id="6327905">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327910">if</span>&nbsp;<span class="ident" id="6327913">nrgba</span>&nbsp;<span class="op" id="6327919">!=</span>&nbsp;<span class="ident" id="6327922">nil</span>&nbsp;<span class="op" id="6327926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327932">offset</span>&nbsp;<span class="op" id="6327939">:=</span>&nbsp;<span class="op" id="6327942">(</span><span class="ident" id="6327943">y</span>&nbsp;<span class="op" id="6327945">-</span>&nbsp;<span class="ident" id="6327947">b</span><span class="op" id="6327948">.</span><span class="ident" id="6327949">Min</span><span class="op" id="6327952">.</span><span class="ident" id="6327953">Y</span><span class="op" id="6327954">)</span>&nbsp;<span class="op" id="6327956">*</span>&nbsp;<span class="ident" id="6327958">nrgba</span><span class="op" id="6327963">.</span><span class="ident" id="6327964">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6327975">copy</span><span class="op" id="6327979">(</span><span class="ident" id="6327980">cr</span><span class="op" id="6327982">[</span><span class="num" id="6327983">0</span><span class="op" id="6327984">]</span><span class="op" id="6327985">[</span><span class="num" id="6327986">1</span><span class="op" id="6327987">:</span><span class="op" id="6327988">]</span><span class="op" id="6327989">,</span>&nbsp;<span class="ident" id="6327991">nrgba</span><span class="op" id="6327996">.</span><span class="ident" id="6327997">Pix</span><span class="op" id="6328000">[</span><span class="ident" id="6328001">offset</span><span class="op" id="6328007">:</span><span class="ident" id="6328008">offset</span><span class="op" id="6328014">+</span><span class="ident" id="6328015">b</span><span class="op" id="6328016">.</span><span class="ident" id="6328017">Dx</span><span class="op" id="6328019">(</span><span class="op" id="6328020">)</span><span class="op" id="6328021">*</span><span class="num" id="6328022">4</span><span class="op" id="6328023">]</span><span class="op" id="6328024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328029">}</span>&nbsp;<span class="keyword" id="6328031">else</span>&nbsp;<span class="op" id="6328036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328042">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328139">for</span>&nbsp;<span class="ident" id="6328143">x</span>&nbsp;<span class="op" id="6328145">:=</span>&nbsp;<span class="ident" id="6328148">b</span><span class="op" id="6328149">.</span><span class="ident" id="6328150">Min</span><span class="op" id="6328153">.</span><span class="ident" id="6328154">X</span><span class="op" id="6328155">;</span>&nbsp;<span class="ident" id="6328157">x</span>&nbsp;<span class="op" id="6328159">&lt;</span>&nbsp;<span class="ident" id="6328161">b</span><span class="op" id="6328162">.</span><span class="ident" id="6328163">Max</span><span class="op" id="6328166">.</span><span class="ident" id="6328167">X</span><span class="op" id="6328168">;</span>&nbsp;<span class="ident" id="6328170">x</span><span class="op" id="6328171">++</span>&nbsp;<span class="op" id="6328174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328181">c</span>&nbsp;<span class="op" id="6328183">:=</span>&nbsp;<span class="ident" id="6328186">color</span><span class="op" id="6328191">.</span><span class="ident" id="6328192">NRGBAModel</span><span class="op" id="6328202">.</span><span class="ident" id="6328203">Convert</span><span class="op" id="6328210">(</span><span class="ident" id="6328211">m</span><span class="op" id="6328212">.</span><span class="ident" id="6328213">At</span><span class="op" id="6328215">(</span><span class="ident" id="6328216">x</span><span class="op" id="6328217">,</span>&nbsp;<span class="ident" id="6328219">y</span><span class="op" id="6328220">)</span><span class="op" id="6328221">)</span><span class="op" id="6328222">.</span><span class="op" id="6328223">(</span><span class="ident" id="6328224">color</span><span class="op" id="6328229">.</span><span class="ident" id="6328230">NRGBA</span><span class="op" id="6328235">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328242">cr</span><span class="op" id="6328244">[</span><span class="num" id="6328245">0</span><span class="op" id="6328246">]</span><span class="op" id="6328247">[</span><span class="ident" id="6328248">i</span><span class="op" id="6328249">+</span><span class="num" id="6328250">0</span><span class="op" id="6328251">]</span>&nbsp;<span class="op" id="6328253">=</span>&nbsp;<span class="ident" id="6328255">c</span><span class="op" id="6328256">.</span><span class="ident" id="6328257">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328264">cr</span><span class="op" id="6328266">[</span><span class="num" id="6328267">0</span><span class="op" id="6328268">]</span><span class="op" id="6328269">[</span><span class="ident" id="6328270">i</span><span class="op" id="6328271">+</span><span class="num" id="6328272">1</span><span class="op" id="6328273">]</span>&nbsp;<span class="op" id="6328275">=</span>&nbsp;<span class="ident" id="6328277">c</span><span class="op" id="6328278">.</span><span class="ident" id="6328279">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328286">cr</span><span class="op" id="6328288">[</span><span class="num" id="6328289">0</span><span class="op" id="6328290">]</span><span class="op" id="6328291">[</span><span class="ident" id="6328292">i</span><span class="op" id="6328293">+</span><span class="num" id="6328294">2</span><span class="op" id="6328295">]</span>&nbsp;<span class="op" id="6328297">=</span>&nbsp;<span class="ident" id="6328299">c</span><span class="op" id="6328300">.</span><span class="ident" id="6328301">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328308">cr</span><span class="op" id="6328310">[</span><span class="num" id="6328311">0</span><span class="op" id="6328312">]</span><span class="op" id="6328313">[</span><span class="ident" id="6328314">i</span><span class="op" id="6328315">+</span><span class="num" id="6328316">3</span><span class="op" id="6328317">]</span>&nbsp;<span class="op" id="6328319">=</span>&nbsp;<span class="ident" id="6328321">c</span><span class="op" id="6328322">.</span><span class="ident" id="6328323">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328330">i</span>&nbsp;<span class="op" id="6328332">+=</span>&nbsp;<span class="num" id="6328335">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328350">case</span>&nbsp;<span class="ident" id="6328355">cbG16</span><span class="op" id="6328360">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328365">for</span>&nbsp;<span class="ident" id="6328369">x</span>&nbsp;<span class="op" id="6328371">:=</span>&nbsp;<span class="ident" id="6328374">b</span><span class="op" id="6328375">.</span><span class="ident" id="6328376">Min</span><span class="op" id="6328379">.</span><span class="ident" id="6328380">X</span><span class="op" id="6328381">;</span>&nbsp;<span class="ident" id="6328383">x</span>&nbsp;<span class="op" id="6328385">&lt;</span>&nbsp;<span class="ident" id="6328387">b</span><span class="op" id="6328388">.</span><span class="ident" id="6328389">Max</span><span class="op" id="6328392">.</span><span class="ident" id="6328393">X</span><span class="op" id="6328394">;</span>&nbsp;<span class="ident" id="6328396">x</span><span class="op" id="6328397">++</span>&nbsp;<span class="op" id="6328400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328406">c</span>&nbsp;<span class="op" id="6328408">:=</span>&nbsp;<span class="ident" id="6328411">color</span><span class="op" id="6328416">.</span><span class="ident" id="6328417">Gray16Model</span><span class="op" id="6328428">.</span><span class="ident" id="6328429">Convert</span><span class="op" id="6328436">(</span><span class="ident" id="6328437">m</span><span class="op" id="6328438">.</span><span class="ident" id="6328439">At</span><span class="op" id="6328441">(</span><span class="ident" id="6328442">x</span><span class="op" id="6328443">,</span>&nbsp;<span class="ident" id="6328445">y</span><span class="op" id="6328446">)</span><span class="op" id="6328447">)</span><span class="op" id="6328448">.</span><span class="op" id="6328449">(</span><span class="ident" id="6328450">color</span><span class="op" id="6328455">.</span><span class="ident" id="6328456">Gray16</span><span class="op" id="6328462">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328468">cr</span><span class="op" id="6328470">[</span><span class="num" id="6328471">0</span><span class="op" id="6328472">]</span><span class="op" id="6328473">[</span><span class="ident" id="6328474">i</span><span class="op" id="6328475">+</span><span class="num" id="6328476">0</span><span class="op" id="6328477">]</span>&nbsp;<span class="op" id="6328479">=</span>&nbsp;<span class="builtintype" id="6328481">uint8</span><span class="op" id="6328486">(</span><span class="ident" id="6328487">c</span><span class="op" id="6328488">.</span><span class="ident" id="6328489">Y</span>&nbsp;<span class="op" id="6328491">&gt;&gt;</span>&nbsp;<span class="num" id="6328494">8</span><span class="op" id="6328495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328501">cr</span><span class="op" id="6328503">[</span><span class="num" id="6328504">0</span><span class="op" id="6328505">]</span><span class="op" id="6328506">[</span><span class="ident" id="6328507">i</span><span class="op" id="6328508">+</span><span class="num" id="6328509">1</span><span class="op" id="6328510">]</span>&nbsp;<span class="op" id="6328512">=</span>&nbsp;<span class="builtintype" id="6328514">uint8</span><span class="op" id="6328519">(</span><span class="ident" id="6328520">c</span><span class="op" id="6328521">.</span><span class="ident" id="6328522">Y</span><span class="op" id="6328523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328529">i</span>&nbsp;<span class="op" id="6328531">+=</span>&nbsp;<span class="num" id="6328534">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328543">case</span>&nbsp;<span class="ident" id="6328548">cbTC16</span><span class="op" id="6328554">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328559">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328631">for</span>&nbsp;<span class="ident" id="6328635">x</span>&nbsp;<span class="op" id="6328637">:=</span>&nbsp;<span class="ident" id="6328640">b</span><span class="op" id="6328641">.</span><span class="ident" id="6328642">Min</span><span class="op" id="6328645">.</span><span class="ident" id="6328646">X</span><span class="op" id="6328647">;</span>&nbsp;<span class="ident" id="6328649">x</span>&nbsp;<span class="op" id="6328651">&lt;</span>&nbsp;<span class="ident" id="6328653">b</span><span class="op" id="6328654">.</span><span class="ident" id="6328655">Max</span><span class="op" id="6328658">.</span><span class="ident" id="6328659">X</span><span class="op" id="6328660">;</span>&nbsp;<span class="ident" id="6328662">x</span><span class="op" id="6328663">++</span>&nbsp;<span class="op" id="6328666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328672">r</span><span class="op" id="6328673">,</span>&nbsp;<span class="ident" id="6328675">g</span><span class="op" id="6328676">,</span>&nbsp;<span class="ident" id="6328678">b</span><span class="op" id="6328679">,</span>&nbsp;<span class="ident" id="6328681">_</span>&nbsp;<span class="op" id="6328683">:=</span>&nbsp;<span class="ident" id="6328686">m</span><span class="op" id="6328687">.</span><span class="ident" id="6328688">At</span><span class="op" id="6328690">(</span><span class="ident" id="6328691">x</span><span class="op" id="6328692">,</span>&nbsp;<span class="ident" id="6328694">y</span><span class="op" id="6328695">)</span><span class="op" id="6328696">.</span><span class="ident" id="6328697">RGBA</span><span class="op" id="6328701">(</span><span class="op" id="6328702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328708">cr</span><span class="op" id="6328710">[</span><span class="num" id="6328711">0</span><span class="op" id="6328712">]</span><span class="op" id="6328713">[</span><span class="ident" id="6328714">i</span><span class="op" id="6328715">+</span><span class="num" id="6328716">0</span><span class="op" id="6328717">]</span>&nbsp;<span class="op" id="6328719">=</span>&nbsp;<span class="builtintype" id="6328721">uint8</span><span class="op" id="6328726">(</span><span class="ident" id="6328727">r</span>&nbsp;<span class="op" id="6328729">&gt;&gt;</span>&nbsp;<span class="num" id="6328732">8</span><span class="op" id="6328733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328739">cr</span><span class="op" id="6328741">[</span><span class="num" id="6328742">0</span><span class="op" id="6328743">]</span><span class="op" id="6328744">[</span><span class="ident" id="6328745">i</span><span class="op" id="6328746">+</span><span class="num" id="6328747">1</span><span class="op" id="6328748">]</span>&nbsp;<span class="op" id="6328750">=</span>&nbsp;<span class="builtintype" id="6328752">uint8</span><span class="op" id="6328757">(</span><span class="ident" id="6328758">r</span><span class="op" id="6328759">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328765">cr</span><span class="op" id="6328767">[</span><span class="num" id="6328768">0</span><span class="op" id="6328769">]</span><span class="op" id="6328770">[</span><span class="ident" id="6328771">i</span><span class="op" id="6328772">+</span><span class="num" id="6328773">2</span><span class="op" id="6328774">]</span>&nbsp;<span class="op" id="6328776">=</span>&nbsp;<span class="builtintype" id="6328778">uint8</span><span class="op" id="6328783">(</span><span class="ident" id="6328784">g</span>&nbsp;<span class="op" id="6328786">&gt;&gt;</span>&nbsp;<span class="num" id="6328789">8</span><span class="op" id="6328790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328796">cr</span><span class="op" id="6328798">[</span><span class="num" id="6328799">0</span><span class="op" id="6328800">]</span><span class="op" id="6328801">[</span><span class="ident" id="6328802">i</span><span class="op" id="6328803">+</span><span class="num" id="6328804">3</span><span class="op" id="6328805">]</span>&nbsp;<span class="op" id="6328807">=</span>&nbsp;<span class="builtintype" id="6328809">uint8</span><span class="op" id="6328814">(</span><span class="ident" id="6328815">g</span><span class="op" id="6328816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328822">cr</span><span class="op" id="6328824">[</span><span class="num" id="6328825">0</span><span class="op" id="6328826">]</span><span class="op" id="6328827">[</span><span class="ident" id="6328828">i</span><span class="op" id="6328829">+</span><span class="num" id="6328830">4</span><span class="op" id="6328831">]</span>&nbsp;<span class="op" id="6328833">=</span>&nbsp;<span class="builtintype" id="6328835">uint8</span><span class="op" id="6328840">(</span><span class="ident" id="6328841">b</span>&nbsp;<span class="op" id="6328843">&gt;&gt;</span>&nbsp;<span class="num" id="6328846">8</span><span class="op" id="6328847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328853">cr</span><span class="op" id="6328855">[</span><span class="num" id="6328856">0</span><span class="op" id="6328857">]</span><span class="op" id="6328858">[</span><span class="ident" id="6328859">i</span><span class="op" id="6328860">+</span><span class="num" id="6328861">5</span><span class="op" id="6328862">]</span>&nbsp;<span class="op" id="6328864">=</span>&nbsp;<span class="builtintype" id="6328866">uint8</span><span class="op" id="6328871">(</span><span class="ident" id="6328872">b</span><span class="op" id="6328873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328879">i</span>&nbsp;<span class="op" id="6328881">+=</span>&nbsp;<span class="num" id="6328884">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328893">case</span>&nbsp;<span class="ident" id="6328898">cbTCA16</span><span class="op" id="6328905">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328910">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329006">for</span>&nbsp;<span class="ident" id="6329010">x</span>&nbsp;<span class="op" id="6329012">:=</span>&nbsp;<span class="ident" id="6329015">b</span><span class="op" id="6329016">.</span><span class="ident" id="6329017">Min</span><span class="op" id="6329020">.</span><span class="ident" id="6329021">X</span><span class="op" id="6329022">;</span>&nbsp;<span class="ident" id="6329024">x</span>&nbsp;<span class="op" id="6329026">&lt;</span>&nbsp;<span class="ident" id="6329028">b</span><span class="op" id="6329029">.</span><span class="ident" id="6329030">Max</span><span class="op" id="6329033">.</span><span class="ident" id="6329034">X</span><span class="op" id="6329035">;</span>&nbsp;<span class="ident" id="6329037">x</span><span class="op" id="6329038">++</span>&nbsp;<span class="op" id="6329041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329047">c</span>&nbsp;<span class="op" id="6329049">:=</span>&nbsp;<span class="ident" id="6329052">color</span><span class="op" id="6329057">.</span><span class="ident" id="6329058">NRGBA64Model</span><span class="op" id="6329070">.</span><span class="ident" id="6329071">Convert</span><span class="op" id="6329078">(</span><span class="ident" id="6329079">m</span><span class="op" id="6329080">.</span><span class="ident" id="6329081">At</span><span class="op" id="6329083">(</span><span class="ident" id="6329084">x</span><span class="op" id="6329085">,</span>&nbsp;<span class="ident" id="6329087">y</span><span class="op" id="6329088">)</span><span class="op" id="6329089">)</span><span class="op" id="6329090">.</span><span class="op" id="6329091">(</span><span class="ident" id="6329092">color</span><span class="op" id="6329097">.</span><span class="ident" id="6329098">NRGBA64</span><span class="op" id="6329105">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329111">cr</span><span class="op" id="6329113">[</span><span class="num" id="6329114">0</span><span class="op" id="6329115">]</span><span class="op" id="6329116">[</span><span class="ident" id="6329117">i</span><span class="op" id="6329118">+</span><span class="num" id="6329119">0</span><span class="op" id="6329120">]</span>&nbsp;<span class="op" id="6329122">=</span>&nbsp;<span class="builtintype" id="6329124">uint8</span><span class="op" id="6329129">(</span><span class="ident" id="6329130">c</span><span class="op" id="6329131">.</span><span class="ident" id="6329132">R</span>&nbsp;<span class="op" id="6329134">&gt;&gt;</span>&nbsp;<span class="num" id="6329137">8</span><span class="op" id="6329138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329144">cr</span><span class="op" id="6329146">[</span><span class="num" id="6329147">0</span><span class="op" id="6329148">]</span><span class="op" id="6329149">[</span><span class="ident" id="6329150">i</span><span class="op" id="6329151">+</span><span class="num" id="6329152">1</span><span class="op" id="6329153">]</span>&nbsp;<span class="op" id="6329155">=</span>&nbsp;<span class="builtintype" id="6329157">uint8</span><span class="op" id="6329162">(</span><span class="ident" id="6329163">c</span><span class="op" id="6329164">.</span><span class="ident" id="6329165">R</span><span class="op" id="6329166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329172">cr</span><span class="op" id="6329174">[</span><span class="num" id="6329175">0</span><span class="op" id="6329176">]</span><span class="op" id="6329177">[</span><span class="ident" id="6329178">i</span><span class="op" id="6329179">+</span><span class="num" id="6329180">2</span><span class="op" id="6329181">]</span>&nbsp;<span class="op" id="6329183">=</span>&nbsp;<span class="builtintype" id="6329185">uint8</span><span class="op" id="6329190">(</span><span class="ident" id="6329191">c</span><span class="op" id="6329192">.</span><span class="ident" id="6329193">G</span>&nbsp;<span class="op" id="6329195">&gt;&gt;</span>&nbsp;<span class="num" id="6329198">8</span><span class="op" id="6329199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329205">cr</span><span class="op" id="6329207">[</span><span class="num" id="6329208">0</span><span class="op" id="6329209">]</span><span class="op" id="6329210">[</span><span class="ident" id="6329211">i</span><span class="op" id="6329212">+</span><span class="num" id="6329213">3</span><span class="op" id="6329214">]</span>&nbsp;<span class="op" id="6329216">=</span>&nbsp;<span class="builtintype" id="6329218">uint8</span><span class="op" id="6329223">(</span><span class="ident" id="6329224">c</span><span class="op" id="6329225">.</span><span class="ident" id="6329226">G</span><span class="op" id="6329227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329233">cr</span><span class="op" id="6329235">[</span><span class="num" id="6329236">0</span><span class="op" id="6329237">]</span><span class="op" id="6329238">[</span><span class="ident" id="6329239">i</span><span class="op" id="6329240">+</span><span class="num" id="6329241">4</span><span class="op" id="6329242">]</span>&nbsp;<span class="op" id="6329244">=</span>&nbsp;<span class="builtintype" id="6329246">uint8</span><span class="op" id="6329251">(</span><span class="ident" id="6329252">c</span><span class="op" id="6329253">.</span><span class="ident" id="6329254">B</span>&nbsp;<span class="op" id="6329256">&gt;&gt;</span>&nbsp;<span class="num" id="6329259">8</span><span class="op" id="6329260">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329266">cr</span><span class="op" id="6329268">[</span><span class="num" id="6329269">0</span><span class="op" id="6329270">]</span><span class="op" id="6329271">[</span><span class="ident" id="6329272">i</span><span class="op" id="6329273">+</span><span class="num" id="6329274">5</span><span class="op" id="6329275">]</span>&nbsp;<span class="op" id="6329277">=</span>&nbsp;<span class="builtintype" id="6329279">uint8</span><span class="op" id="6329284">(</span><span class="ident" id="6329285">c</span><span class="op" id="6329286">.</span><span class="ident" id="6329287">B</span><span class="op" id="6329288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329294">cr</span><span class="op" id="6329296">[</span><span class="num" id="6329297">0</span><span class="op" id="6329298">]</span><span class="op" id="6329299">[</span><span class="ident" id="6329300">i</span><span class="op" id="6329301">+</span><span class="num" id="6329302">6</span><span class="op" id="6329303">]</span>&nbsp;<span class="op" id="6329305">=</span>&nbsp;<span class="builtintype" id="6329307">uint8</span><span class="op" id="6329312">(</span><span class="ident" id="6329313">c</span><span class="op" id="6329314">.</span><span class="ident" id="6329315">A</span>&nbsp;<span class="op" id="6329317">&gt;&gt;</span>&nbsp;<span class="num" id="6329320">8</span><span class="op" id="6329321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329327">cr</span><span class="op" id="6329329">[</span><span class="num" id="6329330">0</span><span class="op" id="6329331">]</span><span class="op" id="6329332">[</span><span class="ident" id="6329333">i</span><span class="op" id="6329334">+</span><span class="num" id="6329335">7</span><span class="op" id="6329336">]</span>&nbsp;<span class="op" id="6329338">=</span>&nbsp;<span class="builtintype" id="6329340">uint8</span><span class="op" id="6329345">(</span><span class="ident" id="6329346">c</span><span class="op" id="6329347">.</span><span class="ident" id="6329348">A</span><span class="op" id="6329349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329355">i</span>&nbsp;<span class="op" id="6329357">+=</span>&nbsp;<span class="num" id="6329360">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329365">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6329374">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329397">f</span>&nbsp;<span class="op" id="6329399">:=</span>&nbsp;<span class="ident" id="6329402">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329411">if</span>&nbsp;<span class="ident" id="6329414">level</span>&nbsp;<span class="op" id="6329420">!=</span>&nbsp;<span class="ident" id="6329423">zlib</span><span class="op" id="6329427">.</span><span class="ident" id="6329428">NoCompression</span>&nbsp;<span class="op" id="6329442">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329447">f</span>&nbsp;<span class="op" id="6329449">=</span>&nbsp;<span class="ident" id="6329451">filter</span><span class="op" id="6329457">(</span><span class="op" id="6329458">&amp;</span><span class="ident" id="6329459">cr</span><span class="op" id="6329461">,</span>&nbsp;<span class="ident" id="6329463">pr</span><span class="op" id="6329465">,</span>&nbsp;<span class="ident" id="6329467">bpp</span><span class="op" id="6329470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6329479">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329512">if</span>&nbsp;<span class="ident" id="6329515">_</span><span class="op" id="6329516">,</span>&nbsp;<span class="ident" id="6329518">err</span>&nbsp;<span class="op" id="6329522">:=</span>&nbsp;<span class="ident" id="6329525">zw</span><span class="op" id="6329527">.</span><span class="ident" id="6329528">Write</span><span class="op" id="6329533">(</span><span class="ident" id="6329534">cr</span><span class="op" id="6329536">[</span><span class="ident" id="6329537">f</span><span class="op" id="6329538">]</span><span class="op" id="6329539">)</span><span class="op" id="6329540">;</span>&nbsp;<span class="ident" id="6329542">err</span>&nbsp;<span class="op" id="6329546">!=</span>&nbsp;<span class="ident" id="6329549">nil</span>&nbsp;<span class="op" id="6329553">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329558">return</span>&nbsp;<span class="ident" id="6329565">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6329576">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329632">pr</span><span class="op" id="6329634">,</span>&nbsp;<span class="ident" id="6329636">cr</span><span class="op" id="6329638">[</span><span class="num" id="6329639">0</span><span class="op" id="6329640">]</span>&nbsp;<span class="op" id="6329642">=</span>&nbsp;<span class="ident" id="6329644">cr</span><span class="op" id="6329646">[</span><span class="num" id="6329647">0</span><span class="op" id="6329648">]</span><span class="op" id="6329649">,</span>&nbsp;<span class="ident" id="6329651">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329658">return</span>&nbsp;<span class="ident" id="6329665">nil</span><br>
<span class="lineno"></span><span class="op" id="6329669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6329672">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="6329731">func</span>&nbsp;<span class="op" id="6329736">(</span><span class="ident" id="6329737">e</span>&nbsp;<span class="op" id="6329739">*</span><span class="ident" id="6329740">encoder</span><span class="op" id="6329747">)</span>&nbsp;<span class="ident" id="6329749">writeIDATs</span><span class="op" id="6329759">(</span><span class="op" id="6329760">)</span>&nbsp;<span class="op" id="6329762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329765">if</span>&nbsp;<span class="ident" id="6329768">e</span><span class="op" id="6329769">.</span><span class="ident" id="6329770">err</span>&nbsp;<span class="op" id="6329774">!=</span>&nbsp;<span class="ident" id="6329777">nil</span>&nbsp;<span class="op" id="6329781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329785">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329796">var</span>&nbsp;<span class="ident" id="6329800">bw</span>&nbsp;<span class="op" id="6329803">*</span><span class="ident" id="6329804">bufio</span><span class="op" id="6329809">.</span><span class="ident" id="6329810">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329818">bw</span>&nbsp;<span class="op" id="6329821">=</span>&nbsp;<span class="ident" id="6329823">bufio</span><span class="op" id="6329828">.</span><span class="ident" id="6329829">NewWriterSize</span><span class="op" id="6329842">(</span><span class="ident" id="6329843">e</span><span class="op" id="6329844">,</span>&nbsp;<span class="num" id="6329846">1</span><span class="op" id="6329847">&lt;&lt;</span><span class="num" id="6329849">15</span><span class="op" id="6329851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329854">e</span><span class="op" id="6329855">.</span><span class="ident" id="6329856">err</span>&nbsp;<span class="op" id="6329860">=</span>&nbsp;<span class="ident" id="6329862">writeImage</span><span class="op" id="6329872">(</span><span class="ident" id="6329873">bw</span><span class="op" id="6329875">,</span>&nbsp;<span class="ident" id="6329877">e</span><span class="op" id="6329878">.</span><span class="ident" id="6329879">m</span><span class="op" id="6329880">,</span>&nbsp;<span class="ident" id="6329882">e</span><span class="op" id="6329883">.</span><span class="ident" id="6329884">cb</span><span class="op" id="6329886">,</span>&nbsp;<span class="ident" id="6329888">levelToZlib</span><span class="op" id="6329899">(</span><span class="ident" id="6329900">e</span><span class="op" id="6329901">.</span><span class="ident" id="6329902">enc</span><span class="op" id="6329905">.</span><span class="ident" id="6329906">CompressionLevel</span><span class="op" id="6329922">)</span><span class="op" id="6329923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329926">if</span>&nbsp;<span class="ident" id="6329929">e</span><span class="op" id="6329930">.</span><span class="ident" id="6329931">err</span>&nbsp;<span class="op" id="6329935">!=</span>&nbsp;<span class="ident" id="6329938">nil</span>&nbsp;<span class="op" id="6329942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329946">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329954">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329957">e</span><span class="op" id="6329958">.</span><span class="ident" id="6329959">err</span>&nbsp;<span class="op" id="6329963">=</span>&nbsp;<span class="ident" id="6329965">bw</span><span class="op" id="6329967">.</span><span class="ident" id="6329968">Flush</span><span class="op" id="6329973">(</span><span class="op" id="6329974">)</span><br>
<span class="lineno"></span><span class="op" id="6329976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6329979">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6330042">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="6330105">func</span>&nbsp;<span class="ident" id="6330110">levelToZlib</span><span class="op" id="6330121">(</span><span class="ident" id="6330122">l</span>&nbsp;<span class="ident" id="6330124">CompressionLevel</span><span class="op" id="6330140">)</span>&nbsp;<span class="builtintype" id="6330142">int</span>&nbsp;<span class="op" id="6330146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330149">switch</span>&nbsp;<span class="ident" id="6330156">l</span>&nbsp;<span class="op" id="6330158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330161">case</span>&nbsp;<span class="ident" id="6330166">DefaultCompression</span><span class="op" id="6330184">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330188">return</span>&nbsp;<span class="ident" id="6330195">zlib</span><span class="op" id="6330199">.</span><span class="ident" id="6330200">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330220">case</span>&nbsp;<span class="ident" id="6330225">NoCompression</span><span class="op" id="6330238">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330242">return</span>&nbsp;<span class="ident" id="6330249">zlib</span><span class="op" id="6330253">.</span><span class="ident" id="6330254">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330269">case</span>&nbsp;<span class="ident" id="6330274">BestSpeed</span><span class="op" id="6330283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330287">return</span>&nbsp;<span class="ident" id="6330294">zlib</span><span class="op" id="6330298">.</span><span class="ident" id="6330299">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330310">case</span>&nbsp;<span class="ident" id="6330315">BestCompression</span><span class="op" id="6330330">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330334">return</span>&nbsp;<span class="ident" id="6330341">zlib</span><span class="op" id="6330345">.</span><span class="ident" id="6330346">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330363">default</span><span class="op" id="6330370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330374">return</span>&nbsp;<span class="ident" id="6330381">zlib</span><span class="op" id="6330385">.</span><span class="ident" id="6330386">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330406">}</span><br>
<span class="lineno"></span><span class="op" id="6330408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="6330411">func</span>&nbsp;<span class="op" id="6330416">(</span><span class="ident" id="6330417">e</span>&nbsp;<span class="op" id="6330419">*</span><span class="ident" id="6330420">encoder</span><span class="op" id="6330427">)</span>&nbsp;<span class="ident" id="6330429">writeIEND</span><span class="op" id="6330438">(</span><span class="op" id="6330439">)</span>&nbsp;<span class="op" id="6330441">{</span>&nbsp;<span class="ident" id="6330443">e</span><span class="op" id="6330444">.</span><span class="ident" id="6330445">writeChunk</span><span class="op" id="6330455">(</span><span class="ident" id="6330456">nil</span><span class="op" id="6330459">,</span>&nbsp;<span class="string" id="6330461">&#34;IEND&#34;</span><span class="op" id="6330467">)</span>&nbsp;<span class="op" id="6330469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6330472">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6330538">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="6330612">func</span>&nbsp;<span class="ident" id="6330617">Encode</span><span class="op" id="6330623">(</span><span class="ident" id="6330624">w</span>&nbsp;<span class="ident" id="6330626">io</span><span class="op" id="6330628">.</span><span class="ident" id="6330629">Writer</span><span class="op" id="6330635">,</span>&nbsp;<span class="ident" id="6330637">m</span>&nbsp;<span class="ident" id="6330639">image</span><span class="op" id="6330644">.</span><span class="ident" id="6330645">Image</span><span class="op" id="6330650">)</span>&nbsp;<span class="builtintype" id="6330652">error</span>&nbsp;<span class="op" id="6330658">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330661">var</span>&nbsp;<span class="ident" id="6330665">e</span>&nbsp;<span class="ident" id="6330667">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330676">return</span>&nbsp;<span class="ident" id="6330683">e</span><span class="op" id="6330684">.</span><span class="ident" id="6330685">Encode</span><span class="op" id="6330691">(</span><span class="ident" id="6330692">w</span><span class="op" id="6330693">,</span>&nbsp;<span class="ident" id="6330695">m</span><span class="op" id="6330696">)</span><br>
<span class="lineno"></span><span class="op" id="6330698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6330701">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="6330750">func</span>&nbsp;<span class="op" id="6330755">(</span><span class="ident" id="6330756">enc</span>&nbsp;<span class="op" id="6330760">*</span><span class="ident" id="6330761">Encoder</span><span class="op" id="6330768">)</span>&nbsp;<span class="ident" id="6330770">Encode</span><span class="op" id="6330776">(</span><span class="ident" id="6330777">w</span>&nbsp;<span class="ident" id="6330779">io</span><span class="op" id="6330781">.</span><span class="ident" id="6330782">Writer</span><span class="op" id="6330788">,</span>&nbsp;<span class="ident" id="6330790">m</span>&nbsp;<span class="ident" id="6330792">image</span><span class="op" id="6330797">.</span><span class="ident" id="6330798">Image</span><span class="op" id="6330803">)</span>&nbsp;<span class="builtintype" id="6330805">error</span>&nbsp;<span class="op" id="6330811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330814">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330891">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330971">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330990">mw</span><span class="op" id="6330992">,</span>&nbsp;<span class="ident" id="6330994">mh</span>&nbsp;<span class="op" id="6330997">:=</span>&nbsp;<span class="ident" id="6331000">int64</span><span class="op" id="6331005">(</span><span class="ident" id="6331006">m</span><span class="op" id="6331007">.</span><span class="ident" id="6331008">Bounds</span><span class="op" id="6331014">(</span><span class="op" id="6331015">)</span><span class="op" id="6331016">.</span><span class="ident" id="6331017">Dx</span><span class="op" id="6331019">(</span><span class="op" id="6331020">)</span><span class="op" id="6331021">)</span><span class="op" id="6331022">,</span>&nbsp;<span class="ident" id="6331024">int64</span><span class="op" id="6331029">(</span><span class="ident" id="6331030">m</span><span class="op" id="6331031">.</span><span class="ident" id="6331032">Bounds</span><span class="op" id="6331038">(</span><span class="op" id="6331039">)</span><span class="op" id="6331040">.</span><span class="ident" id="6331041">Dy</span><span class="op" id="6331043">(</span><span class="op" id="6331044">)</span><span class="op" id="6331045">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331048">if</span>&nbsp;<span class="ident" id="6331051">mw</span>&nbsp;<span class="op" id="6331054">&lt;=</span>&nbsp;<span class="num" id="6331057">0</span>&nbsp;<span class="op" id="6331059">||</span>&nbsp;<span class="ident" id="6331062">mh</span>&nbsp;<span class="op" id="6331065">&lt;=</span>&nbsp;<span class="num" id="6331068">0</span>&nbsp;<span class="op" id="6331070">||</span>&nbsp;<span class="ident" id="6331073">mw</span>&nbsp;<span class="op" id="6331076">&gt;=</span>&nbsp;<span class="num" id="6331079">1</span><span class="op" id="6331080">&lt;&lt;</span><span class="num" id="6331082">32</span>&nbsp;<span class="op" id="6331085">||</span>&nbsp;<span class="ident" id="6331088">mh</span>&nbsp;<span class="op" id="6331091">&gt;=</span>&nbsp;<span class="num" id="6331094">1</span><span class="op" id="6331095">&lt;&lt;</span><span class="num" id="6331097">32</span>&nbsp;<span class="op" id="6331100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331104">return</span>&nbsp;<span class="ident" id="6331111">FormatError</span><span class="op" id="6331122">(</span><span class="string" id="6331123">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="6331146">+</span>&nbsp;<span class="ident" id="6331148">strconv</span><span class="op" id="6331155">.</span><span class="ident" id="6331156">FormatInt</span><span class="op" id="6331165">(</span><span class="ident" id="6331166">mw</span><span class="op" id="6331168">,</span>&nbsp;<span class="num" id="6331170">10</span><span class="op" id="6331172">)</span>&nbsp;<span class="op" id="6331174">+</span>&nbsp;<span class="string" id="6331176">&#34;x&#34;</span>&nbsp;<span class="op" id="6331180">+</span>&nbsp;<span class="ident" id="6331182">strconv</span><span class="op" id="6331189">.</span><span class="ident" id="6331190">FormatInt</span><span class="op" id="6331199">(</span><span class="ident" id="6331200">mh</span><span class="op" id="6331202">,</span>&nbsp;<span class="num" id="6331204">10</span><span class="op" id="6331206">)</span><span class="op" id="6331207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331214">var</span>&nbsp;<span class="ident" id="6331218">e</span>&nbsp;<span class="ident" id="6331220">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331229">e</span><span class="op" id="6331230">.</span><span class="ident" id="6331231">enc</span>&nbsp;<span class="op" id="6331235">=</span>&nbsp;<span class="ident" id="6331237">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331242">e</span><span class="op" id="6331243">.</span><span class="ident" id="6331244">w</span>&nbsp;<span class="op" id="6331246">=</span>&nbsp;<span class="ident" id="6331248">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331251">e</span><span class="op" id="6331252">.</span><span class="ident" id="6331253">m</span>&nbsp;<span class="op" id="6331255">=</span>&nbsp;<span class="ident" id="6331257">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331261">var</span>&nbsp;<span class="ident" id="6331265">pal</span>&nbsp;<span class="ident" id="6331269">color</span><span class="op" id="6331274">.</span><span class="ident" id="6331275">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6331284">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331345">if</span>&nbsp;<span class="ident" id="6331348">_</span><span class="op" id="6331349">,</span>&nbsp;<span class="ident" id="6331351">ok</span>&nbsp;<span class="op" id="6331354">:=</span>&nbsp;<span class="ident" id="6331357">m</span><span class="op" id="6331358">.</span><span class="op" id="6331359">(</span><span class="ident" id="6331360">image</span><span class="op" id="6331365">.</span><span class="ident" id="6331366">PalettedImage</span><span class="op" id="6331379">)</span><span class="op" id="6331380">;</span>&nbsp;<span class="ident" id="6331382">ok</span>&nbsp;<span class="op" id="6331385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331389">pal</span><span class="op" id="6331392">,</span>&nbsp;<span class="ident" id="6331394">_</span>&nbsp;<span class="op" id="6331396">=</span>&nbsp;<span class="ident" id="6331398">m</span><span class="op" id="6331399">.</span><span class="ident" id="6331400">ColorModel</span><span class="op" id="6331410">(</span><span class="op" id="6331411">)</span><span class="op" id="6331412">.</span><span class="op" id="6331413">(</span><span class="ident" id="6331414">color</span><span class="op" id="6331419">.</span><span class="ident" id="6331420">Palette</span><span class="op" id="6331427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331433">if</span>&nbsp;<span class="ident" id="6331436">pal</span>&nbsp;<span class="op" id="6331440">!=</span>&nbsp;<span class="ident" id="6331443">nil</span>&nbsp;<span class="op" id="6331447">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331451">e</span><span class="op" id="6331452">.</span><span class="ident" id="6331453">cb</span>&nbsp;<span class="op" id="6331456">=</span>&nbsp;<span class="ident" id="6331458">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331464">}</span>&nbsp;<span class="keyword" id="6331466">else</span>&nbsp;<span class="op" id="6331471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331475">switch</span>&nbsp;<span class="ident" id="6331482">m</span><span class="op" id="6331483">.</span><span class="ident" id="6331484">ColorModel</span><span class="op" id="6331494">(</span><span class="op" id="6331495">)</span>&nbsp;<span class="op" id="6331497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331501">case</span>&nbsp;<span class="ident" id="6331506">color</span><span class="op" id="6331511">.</span><span class="ident" id="6331512">GrayModel</span><span class="op" id="6331521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331526">e</span><span class="op" id="6331527">.</span><span class="ident" id="6331528">cb</span>&nbsp;<span class="op" id="6331531">=</span>&nbsp;<span class="ident" id="6331533">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331540">case</span>&nbsp;<span class="ident" id="6331545">color</span><span class="op" id="6331550">.</span><span class="ident" id="6331551">Gray16Model</span><span class="op" id="6331562">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331567">e</span><span class="op" id="6331568">.</span><span class="ident" id="6331569">cb</span>&nbsp;<span class="op" id="6331572">=</span>&nbsp;<span class="ident" id="6331574">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331582">case</span>&nbsp;<span class="ident" id="6331587">color</span><span class="op" id="6331592">.</span><span class="ident" id="6331593">RGBAModel</span><span class="op" id="6331602">,</span>&nbsp;<span class="ident" id="6331604">color</span><span class="op" id="6331609">.</span><span class="ident" id="6331610">NRGBAModel</span><span class="op" id="6331620">,</span>&nbsp;<span class="ident" id="6331622">color</span><span class="op" id="6331627">.</span><span class="ident" id="6331628">AlphaModel</span><span class="op" id="6331638">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331643">if</span>&nbsp;<span class="ident" id="6331646">opaque</span><span class="op" id="6331652">(</span><span class="ident" id="6331653">m</span><span class="op" id="6331654">)</span>&nbsp;<span class="op" id="6331656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331662">e</span><span class="op" id="6331663">.</span><span class="ident" id="6331664">cb</span>&nbsp;<span class="op" id="6331667">=</span>&nbsp;<span class="ident" id="6331669">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331678">}</span>&nbsp;<span class="keyword" id="6331680">else</span>&nbsp;<span class="op" id="6331685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331691">e</span><span class="op" id="6331692">.</span><span class="ident" id="6331693">cb</span>&nbsp;<span class="op" id="6331696">=</span>&nbsp;<span class="ident" id="6331698">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331712">default</span><span class="op" id="6331719">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331724">if</span>&nbsp;<span class="ident" id="6331727">opaque</span><span class="op" id="6331733">(</span><span class="ident" id="6331734">m</span><span class="op" id="6331735">)</span>&nbsp;<span class="op" id="6331737">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331743">e</span><span class="op" id="6331744">.</span><span class="ident" id="6331745">cb</span>&nbsp;<span class="op" id="6331748">=</span>&nbsp;<span class="ident" id="6331750">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331760">}</span>&nbsp;<span class="keyword" id="6331762">else</span>&nbsp;<span class="op" id="6331767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331773">e</span><span class="op" id="6331774">.</span><span class="ident" id="6331775">cb</span>&nbsp;<span class="op" id="6331778">=</span>&nbsp;<span class="ident" id="6331780">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331795">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331802">_</span><span class="op" id="6331803">,</span>&nbsp;<span class="ident" id="6331805">e</span><span class="op" id="6331806">.</span><span class="ident" id="6331807">err</span>&nbsp;<span class="op" id="6331811">=</span>&nbsp;<span class="ident" id="6331813">io</span><span class="op" id="6331815">.</span><span class="ident" id="6331816">WriteString</span><span class="op" id="6331827">(</span><span class="ident" id="6331828">w</span><span class="op" id="6331829">,</span>&nbsp;<span class="ident" id="6331831">pngHeader</span><span class="op" id="6331840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331843">e</span><span class="op" id="6331844">.</span><span class="ident" id="6331845">writeIHDR</span><span class="op" id="6331854">(</span><span class="op" id="6331855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331858">if</span>&nbsp;<span class="ident" id="6331861">pal</span>&nbsp;<span class="op" id="6331865">!=</span>&nbsp;<span class="ident" id="6331868">nil</span>&nbsp;<span class="op" id="6331872">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331876">e</span><span class="op" id="6331877">.</span><span class="ident" id="6331878">writePLTEAndTRNS</span><span class="op" id="6331894">(</span><span class="ident" id="6331895">pal</span><span class="op" id="6331898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331904">e</span><span class="op" id="6331905">.</span><span class="ident" id="6331906">writeIDATs</span><span class="op" id="6331916">(</span><span class="op" id="6331917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331920">e</span><span class="op" id="6331921">.</span><span class="ident" id="6331922">writeIEND</span><span class="op" id="6331931">(</span><span class="op" id="6331932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331935">return</span>&nbsp;<span class="ident" id="6331942">e</span><span class="op" id="6331943">.</span><span class="ident" id="6331944">err</span><br>
<span class="lineno">530</span><span class="op" id="6331948">}</span>
</div>
</body>
</html>
