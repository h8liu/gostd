<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html" class="current">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1498981">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1499036">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1499090">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1499141">package</span>&nbsp;<span class="ident" id="1499149">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1499158">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1499217">//</span><br>
<span class="lineno"></span><span class="comment" id="1499220">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1499273">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1499330">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1499388">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1499444">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1499503">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1499530">//</span><br>
<span class="lineno"></span><span class="comment" id="1499533">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1499586">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1499604">//</span><br>
<span class="lineno"></span><span class="comment" id="1499607">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1499660">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1499715">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1499776">//</span><br>
<span class="lineno"></span><span class="comment" id="1499779">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1499834">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1499892">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1499951">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1500008">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1500063">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1500124">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1500180">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1500239">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1500261">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1500323">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1500383">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1500444">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1500480">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1500547">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1500614">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1500681">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1500748">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1500815">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1500882">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1500949">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1501016">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1501083">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1501150">//</span><br>
<span class="lineno"></span><span class="comment" id="1501153">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1501222">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1501278">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1501347">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1501416">//</span><br>
<span class="lineno"></span><span class="comment" id="1501419">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1501487">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1501561">import</span>&nbsp;<span class="op" id="1501568">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1501571">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1501580">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1501583">const</span>&nbsp;<span class="op" id="1501589">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501592">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501649">bucketCntBits</span>&nbsp;<span class="op" id="1501663">=</span>&nbsp;<span class="num" id="1501665">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501668">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501682">=</span>&nbsp;<span class="num" id="1501684">1</span>&nbsp;<span class="op" id="1501686">&lt;&lt;</span>&nbsp;<span class="ident" id="1501689">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501705">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501764">loadFactor</span>&nbsp;<span class="op" id="1501775">=</span>&nbsp;<span class="num" id="1501777">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501783">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501864">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501889">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501954">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502023">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1502036">=</span>&nbsp;<span class="num" id="1502038">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502043">maxValueSize</span>&nbsp;<span class="op" id="1502056">=</span>&nbsp;<span class="num" id="1502058">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502064">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502135">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502200">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502237">dataOffset</span>&nbsp;<span class="op" id="1502248">=</span>&nbsp;<span class="ident" id="1502250">unsafe</span><span class="op" id="1502256">.</span><span class="ident" id="1502257">Offsetof</span><span class="op" id="1502265">(</span><span class="keyword" id="1502266">struct</span>&nbsp;<span class="op" id="1502273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502277">b</span>&nbsp;<span class="ident" id="1502279">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502286">v</span>&nbsp;<span class="ident" id="1502288">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502295">}</span><span class="op" id="1502296">{</span><span class="op" id="1502297">}</span><span class="op" id="1502298">.</span><span class="ident" id="1502299">v</span><span class="op" id="1502300">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502304">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502384">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502477">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502571">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502653">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502668">=</span>&nbsp;<span class="num" id="1502670">0</span>&nbsp;<span class="comment" id="1502672">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502690">evacuatedEmpty</span>&nbsp;<span class="op" id="1502705">=</span>&nbsp;<span class="num" id="1502707">1</span>&nbsp;<span class="comment" id="1502709">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502749">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502764">=</span>&nbsp;<span class="num" id="1502766">2</span>&nbsp;<span class="comment" id="1502768">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502849">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502864">=</span>&nbsp;<span class="num" id="1502866">3</span>&nbsp;<span class="comment" id="1502868">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502933">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502948">=</span>&nbsp;<span class="num" id="1502950">4</span>&nbsp;<span class="comment" id="1502952">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502999">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503009">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503021">=</span>&nbsp;<span class="num" id="1503023">1</span>&nbsp;<span class="comment" id="1503025">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503068">oldIterator</span>&nbsp;<span class="op" id="1503080">=</span>&nbsp;<span class="num" id="1503082">2</span>&nbsp;<span class="comment" id="1503084">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503131">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503174">noCheck</span>&nbsp;<span class="op" id="1503182">=</span>&nbsp;<span class="num" id="1503184">1</span><span class="op" id="1503185">&lt;&lt;</span><span class="op" id="1503187">(</span><span class="num" id="1503188">8</span><span class="op" id="1503189">*</span><span class="ident" id="1503190">ptrSize</span><span class="op" id="1503197">)</span>&nbsp;<span class="op" id="1503199">-</span>&nbsp;<span class="num" id="1503201">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503205">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503275">checkgc</span>&nbsp;<span class="op" id="1503283">=</span>&nbsp;<span class="builtintype" id="1503285">false</span><br>
<span class="lineno"></span><span class="op" id="1503291">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1503294">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1503320">type</span>&nbsp;<span class="ident" id="1503325">hmap</span>&nbsp;<span class="keyword" id="1503330">struct</span>&nbsp;<span class="op" id="1503337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503340">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503414">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503500">count</span>&nbsp;<span class="builtintype" id="1503506">int</span>&nbsp;<span class="comment" id="1503510">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503582">flags</span>&nbsp;<span class="builtintype" id="1503588">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503596">hash0</span>&nbsp;<span class="builtintype" id="1503602">uint32</span>&nbsp;<span class="comment" id="1503609">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503623">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1503629">uint8</span>&nbsp;&nbsp;<span class="comment" id="1503636">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503703">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503714">unsafe</span><span class="op" id="1503720">.</span><span class="ident" id="1503721">Pointer</span>&nbsp;<span class="comment" id="1503729">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503779">oldbuckets</span>&nbsp;<span class="ident" id="1503790">unsafe</span><span class="op" id="1503796">.</span><span class="ident" id="1503797">Pointer</span>&nbsp;<span class="comment" id="1503805">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503875">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1503886">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503901">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1503981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1503984">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1504010">type</span>&nbsp;<span class="ident" id="1504015">bmap</span>&nbsp;<span class="keyword" id="1504020">struct</span>&nbsp;<span class="op" id="1504027">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504030">tophash</span>&nbsp;&nbsp;<span class="op" id="1504039">[</span><span class="ident" id="1504040">bucketCnt</span><span class="op" id="1504049">]</span><span class="builtintype" id="1504050">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504057">overflow</span>&nbsp;<span class="op" id="1504066">*</span><span class="ident" id="1504067">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504073">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504131">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504214">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504301">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1504377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1504380">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1504411">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1504476">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1504509">type</span>&nbsp;<span class="ident" id="1504514">hiter</span>&nbsp;<span class="keyword" id="1504520">struct</span>&nbsp;<span class="op" id="1504527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504530">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504542">unsafe</span><span class="op" id="1504548">.</span><span class="ident" id="1504549">Pointer</span>&nbsp;<span class="comment" id="1504557">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504647">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504659">unsafe</span><span class="op" id="1504665">.</span><span class="ident" id="1504666">Pointer</span>&nbsp;<span class="comment" id="1504674">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504727">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504739">*</span><span class="ident" id="1504740">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504749">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504761">*</span><span class="ident" id="1504762">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504768">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504780">unsafe</span><span class="op" id="1504786">.</span><span class="ident" id="1504787">Pointer</span>&nbsp;<span class="comment" id="1504795">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504843">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504855">*</span><span class="ident" id="1504856">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504870">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504889">startBucket</span>&nbsp;<span class="builtintype" id="1504901">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504916">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504948">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1504960">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504975">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505073">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1505085">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505100">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505165">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1505177">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505184">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1505196">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505203">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1505215">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505224">checkBucket</span>&nbsp;<span class="builtintype" id="1505236">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1505244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1505247">func</span>&nbsp;<span class="ident" id="1505252">evacuated</span><span class="op" id="1505261">(</span><span class="ident" id="1505262">b</span>&nbsp;<span class="op" id="1505264">*</span><span class="ident" id="1505265">bmap</span><span class="op" id="1505269">)</span>&nbsp;<span class="builtintype" id="1505271">bool</span>&nbsp;<span class="op" id="1505276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505279">h</span>&nbsp;<span class="op" id="1505281">:=</span>&nbsp;<span class="ident" id="1505284">b</span><span class="op" id="1505285">.</span><span class="ident" id="1505286">tophash</span><span class="op" id="1505293">[</span><span class="num" id="1505294">0</span><span class="op" id="1505295">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505298">return</span>&nbsp;<span class="ident" id="1505305">h</span>&nbsp;<span class="op" id="1505307">&gt;</span>&nbsp;<span class="ident" id="1505309">empty</span>&nbsp;<span class="op" id="1505315">&amp;&amp;</span>&nbsp;<span class="ident" id="1505318">h</span>&nbsp;<span class="op" id="1505320">&lt;</span>&nbsp;<span class="ident" id="1505322">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1505333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1505336">func</span>&nbsp;<span class="ident" id="1505341">makemap</span><span class="op" id="1505348">(</span><span class="ident" id="1505349">t</span>&nbsp;<span class="op" id="1505351">*</span><span class="ident" id="1505352">maptype</span><span class="op" id="1505359">,</span>&nbsp;<span class="ident" id="1505361">hint</span>&nbsp;<span class="ident" id="1505366">int64</span><span class="op" id="1505371">)</span>&nbsp;<span class="op" id="1505373">*</span><span class="ident" id="1505374">hmap</span>&nbsp;<span class="op" id="1505379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505382">if</span>&nbsp;<span class="ident" id="1505385">sz</span>&nbsp;<span class="op" id="1505388">:=</span>&nbsp;<span class="ident" id="1505391">unsafe</span><span class="op" id="1505397">.</span><span class="ident" id="1505398">Sizeof</span><span class="op" id="1505404">(</span><span class="ident" id="1505405">hmap</span><span class="op" id="1505409">{</span><span class="op" id="1505410">}</span><span class="op" id="1505411">)</span><span class="op" id="1505412">;</span>&nbsp;<span class="ident" id="1505414">sz</span>&nbsp;<span class="op" id="1505417">&gt;</span>&nbsp;<span class="num" id="1505419">48</span>&nbsp;<span class="op" id="1505422">||</span>&nbsp;<span class="ident" id="1505425">sz</span>&nbsp;<span class="op" id="1505428">!=</span>&nbsp;<span class="builtintype" id="1505431">uintptr</span><span class="op" id="1505438">(</span><span class="ident" id="1505439">t</span><span class="op" id="1505440">.</span><span class="ident" id="1505441">hmap</span><span class="op" id="1505445">.</span><span class="ident" id="1505446">size</span><span class="op" id="1505450">)</span>&nbsp;<span class="op" id="1505452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505456">gothrow</span><span class="op" id="1505463">(</span><span class="string" id="1505464">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1505479">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505486">if</span>&nbsp;<span class="ident" id="1505489">hint</span>&nbsp;<span class="op" id="1505494">&lt;</span>&nbsp;<span class="num" id="1505496">0</span>&nbsp;<span class="op" id="1505498">||</span>&nbsp;<span class="ident" id="1505501">int64</span><span class="op" id="1505506">(</span><span class="builtintype" id="1505507">int32</span><span class="op" id="1505512">(</span><span class="ident" id="1505513">hint</span><span class="op" id="1505517">)</span><span class="op" id="1505518">)</span>&nbsp;<span class="op" id="1505520">!=</span>&nbsp;<span class="ident" id="1505523">hint</span>&nbsp;<span class="op" id="1505528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1505532">panic</span><span class="op" id="1505537">(</span><span class="string" id="1505538">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1505566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505570">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505629">if</span>&nbsp;<span class="op" id="1505632">!</span><span class="ident" id="1505633">ismapkey</span><span class="op" id="1505641">(</span><span class="ident" id="1505642">t</span><span class="op" id="1505643">.</span><span class="ident" id="1505644">key</span><span class="op" id="1505647">)</span>&nbsp;<span class="op" id="1505649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505653">gothrow</span><span class="op" id="1505660">(</span><span class="string" id="1505661">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1505704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505707">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505711">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505751">if</span>&nbsp;<span class="ident" id="1505754">t</span><span class="op" id="1505755">.</span><span class="ident" id="1505756">key</span><span class="op" id="1505759">.</span><span class="ident" id="1505760">size</span>&nbsp;<span class="op" id="1505765">&gt;</span>&nbsp;<span class="ident" id="1505767">maxKeySize</span>&nbsp;<span class="op" id="1505778">&amp;&amp;</span>&nbsp;<span class="op" id="1505781">(</span><span class="op" id="1505782">!</span><span class="ident" id="1505783">t</span><span class="op" id="1505784">.</span><span class="ident" id="1505785">indirectkey</span>&nbsp;<span class="op" id="1505797">||</span>&nbsp;<span class="ident" id="1505800">t</span><span class="op" id="1505801">.</span><span class="ident" id="1505802">keysize</span>&nbsp;<span class="op" id="1505810">!=</span>&nbsp;<span class="builtintype" id="1505813">uint8</span><span class="op" id="1505818">(</span><span class="ident" id="1505819">ptrSize</span><span class="op" id="1505826">)</span><span class="op" id="1505827">)</span>&nbsp;<span class="op" id="1505829">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505834">t</span><span class="op" id="1505835">.</span><span class="ident" id="1505836">key</span><span class="op" id="1505839">.</span><span class="ident" id="1505840">size</span>&nbsp;<span class="op" id="1505845">&lt;=</span>&nbsp;<span class="ident" id="1505848">maxKeySize</span>&nbsp;<span class="op" id="1505859">&amp;&amp;</span>&nbsp;<span class="op" id="1505862">(</span><span class="ident" id="1505863">t</span><span class="op" id="1505864">.</span><span class="ident" id="1505865">indirectkey</span>&nbsp;<span class="op" id="1505877">||</span>&nbsp;<span class="ident" id="1505880">t</span><span class="op" id="1505881">.</span><span class="ident" id="1505882">keysize</span>&nbsp;<span class="op" id="1505890">!=</span>&nbsp;<span class="builtintype" id="1505893">uint8</span><span class="op" id="1505898">(</span><span class="ident" id="1505899">t</span><span class="op" id="1505900">.</span><span class="ident" id="1505901">key</span><span class="op" id="1505904">.</span><span class="ident" id="1505905">size</span><span class="op" id="1505909">)</span><span class="op" id="1505910">)</span>&nbsp;<span class="op" id="1505912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505916">gothrow</span><span class="op" id="1505923">(</span><span class="string" id="1505924">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1505940">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505946">if</span>&nbsp;<span class="ident" id="1505949">t</span><span class="op" id="1505950">.</span><span class="ident" id="1505951">elem</span><span class="op" id="1505955">.</span><span class="ident" id="1505956">size</span>&nbsp;<span class="op" id="1505961">&gt;</span>&nbsp;<span class="ident" id="1505963">maxValueSize</span>&nbsp;<span class="op" id="1505976">&amp;&amp;</span>&nbsp;<span class="op" id="1505979">(</span><span class="op" id="1505980">!</span><span class="ident" id="1505981">t</span><span class="op" id="1505982">.</span><span class="ident" id="1505983">indirectvalue</span>&nbsp;<span class="op" id="1505997">||</span>&nbsp;<span class="ident" id="1506000">t</span><span class="op" id="1506001">.</span><span class="ident" id="1506002">valuesize</span>&nbsp;<span class="op" id="1506012">!=</span>&nbsp;<span class="builtintype" id="1506015">uint8</span><span class="op" id="1506020">(</span><span class="ident" id="1506021">ptrSize</span><span class="op" id="1506028">)</span><span class="op" id="1506029">)</span>&nbsp;<span class="op" id="1506031">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506036">t</span><span class="op" id="1506037">.</span><span class="ident" id="1506038">elem</span><span class="op" id="1506042">.</span><span class="ident" id="1506043">size</span>&nbsp;<span class="op" id="1506048">&lt;=</span>&nbsp;<span class="ident" id="1506051">maxValueSize</span>&nbsp;<span class="op" id="1506064">&amp;&amp;</span>&nbsp;<span class="op" id="1506067">(</span><span class="ident" id="1506068">t</span><span class="op" id="1506069">.</span><span class="ident" id="1506070">indirectvalue</span>&nbsp;<span class="op" id="1506084">||</span>&nbsp;<span class="ident" id="1506087">t</span><span class="op" id="1506088">.</span><span class="ident" id="1506089">valuesize</span>&nbsp;<span class="op" id="1506099">!=</span>&nbsp;<span class="builtintype" id="1506102">uint8</span><span class="op" id="1506107">(</span><span class="ident" id="1506108">t</span><span class="op" id="1506109">.</span><span class="ident" id="1506110">elem</span><span class="op" id="1506114">.</span><span class="ident" id="1506115">size</span><span class="op" id="1506119">)</span><span class="op" id="1506120">)</span>&nbsp;<span class="op" id="1506122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506126">gothrow</span><span class="op" id="1506133">(</span><span class="string" id="1506134">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1506152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506155">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1506159">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1506236">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506281">if</span>&nbsp;<span class="ident" id="1506284">t</span><span class="op" id="1506285">.</span><span class="ident" id="1506286">key</span><span class="op" id="1506289">.</span><span class="ident" id="1506290">align</span>&nbsp;<span class="op" id="1506296">&gt;</span>&nbsp;<span class="ident" id="1506298">bucketCnt</span>&nbsp;<span class="op" id="1506308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506312">gothrow</span><span class="op" id="1506319">(</span><span class="string" id="1506320">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1506339">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506345">if</span>&nbsp;<span class="ident" id="1506348">t</span><span class="op" id="1506349">.</span><span class="ident" id="1506350">elem</span><span class="op" id="1506354">.</span><span class="ident" id="1506355">align</span>&nbsp;<span class="op" id="1506361">&gt;</span>&nbsp;<span class="ident" id="1506363">bucketCnt</span>&nbsp;<span class="op" id="1506373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506377">gothrow</span><span class="op" id="1506384">(</span><span class="string" id="1506385">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1506406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506412">if</span>&nbsp;<span class="builtintype" id="1506415">uintptr</span><span class="op" id="1506422">(</span><span class="ident" id="1506423">t</span><span class="op" id="1506424">.</span><span class="ident" id="1506425">key</span><span class="op" id="1506428">.</span><span class="ident" id="1506429">size</span><span class="op" id="1506433">)</span><span class="op" id="1506434">%</span><span class="builtintype" id="1506435">uintptr</span><span class="op" id="1506442">(</span><span class="ident" id="1506443">t</span><span class="op" id="1506444">.</span><span class="ident" id="1506445">key</span><span class="op" id="1506448">.</span><span class="ident" id="1506449">align</span><span class="op" id="1506454">)</span>&nbsp;<span class="op" id="1506456">!=</span>&nbsp;<span class="num" id="1506459">0</span>&nbsp;<span class="op" id="1506461">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506465">gothrow</span><span class="op" id="1506472">(</span><span class="string" id="1506473">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1506511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506517">if</span>&nbsp;<span class="builtintype" id="1506520">uintptr</span><span class="op" id="1506527">(</span><span class="ident" id="1506528">t</span><span class="op" id="1506529">.</span><span class="ident" id="1506530">elem</span><span class="op" id="1506534">.</span><span class="ident" id="1506535">size</span><span class="op" id="1506539">)</span><span class="op" id="1506540">%</span><span class="builtintype" id="1506541">uintptr</span><span class="op" id="1506548">(</span><span class="ident" id="1506549">t</span><span class="op" id="1506550">.</span><span class="ident" id="1506551">elem</span><span class="op" id="1506555">.</span><span class="ident" id="1506556">align</span><span class="op" id="1506561">)</span>&nbsp;<span class="op" id="1506563">!=</span>&nbsp;<span class="num" id="1506566">0</span>&nbsp;<span class="op" id="1506568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506572">gothrow</span><span class="op" id="1506579">(</span><span class="string" id="1506580">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1506622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506625">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506628">if</span>&nbsp;<span class="ident" id="1506631">bucketCnt</span>&nbsp;<span class="op" id="1506641">&lt;</span>&nbsp;<span class="num" id="1506643">8</span>&nbsp;<span class="op" id="1506645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506649">gothrow</span><span class="op" id="1506656">(</span><span class="string" id="1506657">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1506700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506706">if</span>&nbsp;<span class="ident" id="1506709">dataOffset</span><span class="op" id="1506719">%</span><span class="builtintype" id="1506720">uintptr</span><span class="op" id="1506727">(</span><span class="ident" id="1506728">t</span><span class="op" id="1506729">.</span><span class="ident" id="1506730">key</span><span class="op" id="1506733">.</span><span class="ident" id="1506734">align</span><span class="op" id="1506739">)</span>&nbsp;<span class="op" id="1506741">!=</span>&nbsp;<span class="num" id="1506744">0</span>&nbsp;<span class="op" id="1506746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506750">gothrow</span><span class="op" id="1506757">(</span><span class="string" id="1506758">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1506788">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506794">if</span>&nbsp;<span class="ident" id="1506797">dataOffset</span><span class="op" id="1506807">%</span><span class="builtintype" id="1506808">uintptr</span><span class="op" id="1506815">(</span><span class="ident" id="1506816">t</span><span class="op" id="1506817">.</span><span class="ident" id="1506818">elem</span><span class="op" id="1506822">.</span><span class="ident" id="1506823">align</span><span class="op" id="1506828">)</span>&nbsp;<span class="op" id="1506830">!=</span>&nbsp;<span class="num" id="1506833">0</span>&nbsp;<span class="op" id="1506835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506839">gothrow</span><span class="op" id="1506846">(</span><span class="string" id="1506847">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1506879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1506886">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506954">B</span>&nbsp;<span class="op" id="1506956">:=</span>&nbsp;<span class="builtintype" id="1506959">uint8</span><span class="op" id="1506964">(</span><span class="num" id="1506965">0</span><span class="op" id="1506966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506969">for</span>&nbsp;<span class="op" id="1506973">;</span>&nbsp;<span class="ident" id="1506975">hint</span>&nbsp;<span class="op" id="1506980">&gt;</span>&nbsp;<span class="ident" id="1506982">bucketCnt</span>&nbsp;<span class="op" id="1506992">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1506995">float32</span><span class="op" id="1507002">(</span><span class="ident" id="1507003">hint</span><span class="op" id="1507007">)</span>&nbsp;<span class="op" id="1507009">&gt;</span>&nbsp;<span class="ident" id="1507011">loadFactor</span><span class="op" id="1507021">*</span><span class="builtintype" id="1507022">float32</span><span class="op" id="1507029">(</span><span class="builtintype" id="1507030">uintptr</span><span class="op" id="1507037">(</span><span class="num" id="1507038">1</span><span class="op" id="1507039">)</span><span class="op" id="1507040">&lt;&lt;</span><span class="ident" id="1507042">B</span><span class="op" id="1507043">)</span><span class="op" id="1507044">;</span>&nbsp;<span class="ident" id="1507046">B</span><span class="op" id="1507047">++</span>&nbsp;<span class="op" id="1507050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507057">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507089">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507163">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507224">var</span>&nbsp;<span class="ident" id="1507228">buckets</span>&nbsp;<span class="ident" id="1507236">unsafe</span><span class="op" id="1507242">.</span><span class="ident" id="1507243">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507252">if</span>&nbsp;<span class="ident" id="1507255">B</span>&nbsp;<span class="op" id="1507257">!=</span>&nbsp;<span class="num" id="1507260">0</span>&nbsp;<span class="op" id="1507262">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507266">if</span>&nbsp;<span class="ident" id="1507269">checkgc</span>&nbsp;<span class="op" id="1507277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507282">memstats</span><span class="op" id="1507290">.</span><span class="ident" id="1507291">next_gc</span>&nbsp;<span class="op" id="1507299">=</span>&nbsp;<span class="ident" id="1507301">memstats</span><span class="op" id="1507309">.</span><span class="ident" id="1507310">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507327">buckets</span>&nbsp;<span class="op" id="1507335">=</span>&nbsp;<span class="ident" id="1507337">newarray</span><span class="op" id="1507345">(</span><span class="ident" id="1507346">t</span><span class="op" id="1507347">.</span><span class="ident" id="1507348">bucket</span><span class="op" id="1507354">,</span>&nbsp;<span class="builtintype" id="1507356">uintptr</span><span class="op" id="1507363">(</span><span class="num" id="1507364">1</span><span class="op" id="1507365">)</span><span class="op" id="1507366">&lt;&lt;</span><span class="ident" id="1507368">B</span><span class="op" id="1507369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507372">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507376">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507396">if</span>&nbsp;<span class="ident" id="1507399">checkgc</span>&nbsp;<span class="op" id="1507407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507411">memstats</span><span class="op" id="1507419">.</span><span class="ident" id="1507420">next_gc</span>&nbsp;<span class="op" id="1507428">=</span>&nbsp;<span class="ident" id="1507430">memstats</span><span class="op" id="1507438">.</span><span class="ident" id="1507439">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507451">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507454">h</span>&nbsp;<span class="op" id="1507456">:=</span>&nbsp;<span class="op" id="1507459">(</span><span class="op" id="1507460">*</span><span class="ident" id="1507461">hmap</span><span class="op" id="1507465">)</span><span class="op" id="1507466">(</span><span class="ident" id="1507467">newobject</span><span class="op" id="1507476">(</span><span class="ident" id="1507477">t</span><span class="op" id="1507478">.</span><span class="ident" id="1507479">hmap</span><span class="op" id="1507483">)</span><span class="op" id="1507484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507487">h</span><span class="op" id="1507488">.</span><span class="ident" id="1507489">count</span>&nbsp;<span class="op" id="1507495">=</span>&nbsp;<span class="num" id="1507497">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507500">h</span><span class="op" id="1507501">.</span><span class="ident" id="1507502">B</span>&nbsp;<span class="op" id="1507504">=</span>&nbsp;<span class="ident" id="1507506">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507509">h</span><span class="op" id="1507510">.</span><span class="ident" id="1507511">flags</span>&nbsp;<span class="op" id="1507517">=</span>&nbsp;<span class="num" id="1507519">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507522">h</span><span class="op" id="1507523">.</span><span class="ident" id="1507524">hash0</span>&nbsp;<span class="op" id="1507530">=</span>&nbsp;<span class="ident" id="1507532">fastrand1</span><span class="op" id="1507541">(</span><span class="op" id="1507542">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507545">h</span><span class="op" id="1507546">.</span><span class="ident" id="1507547">buckets</span>&nbsp;<span class="op" id="1507555">=</span>&nbsp;<span class="ident" id="1507557">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507566">h</span><span class="op" id="1507567">.</span><span class="ident" id="1507568">oldbuckets</span>&nbsp;<span class="op" id="1507579">=</span>&nbsp;<span class="builtintype" id="1507581">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507586">h</span><span class="op" id="1507587">.</span><span class="ident" id="1507588">nevacuate</span>&nbsp;<span class="op" id="1507598">=</span>&nbsp;<span class="num" id="1507600">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507604">return</span>&nbsp;<span class="ident" id="1507611">h</span><br>
<span class="lineno">230</span><span class="op" id="1507613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1507616">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1507687">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1507758">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1507788">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1507856">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1507887">func</span>&nbsp;<span class="ident" id="1507892">mapaccess1</span><span class="op" id="1507902">(</span><span class="ident" id="1507903">t</span>&nbsp;<span class="op" id="1507905">*</span><span class="ident" id="1507906">maptype</span><span class="op" id="1507913">,</span>&nbsp;<span class="ident" id="1507915">h</span>&nbsp;<span class="op" id="1507917">*</span><span class="ident" id="1507918">hmap</span><span class="op" id="1507922">,</span>&nbsp;<span class="ident" id="1507924">key</span>&nbsp;<span class="ident" id="1507928">unsafe</span><span class="op" id="1507934">.</span><span class="ident" id="1507935">Pointer</span><span class="op" id="1507942">)</span>&nbsp;<span class="ident" id="1507944">unsafe</span><span class="op" id="1507950">.</span><span class="ident" id="1507951">Pointer</span>&nbsp;<span class="op" id="1507959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507962">if</span>&nbsp;<span class="ident" id="1507965">raceenabled</span>&nbsp;<span class="op" id="1507977">&amp;&amp;</span>&nbsp;<span class="ident" id="1507980">h</span>&nbsp;<span class="op" id="1507982">!=</span>&nbsp;<span class="builtintype" id="1507985">nil</span>&nbsp;<span class="op" id="1507989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507993">callerpc</span>&nbsp;<span class="op" id="1508002">:=</span>&nbsp;<span class="ident" id="1508005">getcallerpc</span><span class="op" id="1508016">(</span><span class="ident" id="1508017">unsafe</span><span class="op" id="1508023">.</span><span class="ident" id="1508024">Pointer</span><span class="op" id="1508031">(</span><span class="op" id="1508032">&amp;</span><span class="ident" id="1508033">t</span><span class="op" id="1508034">)</span><span class="op" id="1508035">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508039">pc</span>&nbsp;<span class="op" id="1508042">:=</span>&nbsp;<span class="ident" id="1508045">funcPC</span><span class="op" id="1508051">(</span><span class="ident" id="1508052">mapaccess1</span><span class="op" id="1508062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508066">racereadpc</span><span class="op" id="1508076">(</span><span class="ident" id="1508077">unsafe</span><span class="op" id="1508083">.</span><span class="ident" id="1508084">Pointer</span><span class="op" id="1508091">(</span><span class="ident" id="1508092">h</span><span class="op" id="1508093">)</span><span class="op" id="1508094">,</span>&nbsp;<span class="ident" id="1508096">callerpc</span><span class="op" id="1508104">,</span>&nbsp;<span class="ident" id="1508106">pc</span><span class="op" id="1508108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508112">raceReadObjectPC</span><span class="op" id="1508128">(</span><span class="ident" id="1508129">t</span><span class="op" id="1508130">.</span><span class="ident" id="1508131">key</span><span class="op" id="1508134">,</span>&nbsp;<span class="ident" id="1508136">key</span><span class="op" id="1508139">,</span>&nbsp;<span class="ident" id="1508141">callerpc</span><span class="op" id="1508149">,</span>&nbsp;<span class="ident" id="1508151">pc</span><span class="op" id="1508153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508159">if</span>&nbsp;<span class="ident" id="1508162">h</span>&nbsp;<span class="op" id="1508164">==</span>&nbsp;<span class="builtintype" id="1508167">nil</span>&nbsp;<span class="op" id="1508171">||</span>&nbsp;<span class="ident" id="1508174">h</span><span class="op" id="1508175">.</span><span class="ident" id="1508176">count</span>&nbsp;<span class="op" id="1508182">==</span>&nbsp;<span class="num" id="1508185">0</span>&nbsp;<span class="op" id="1508187">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508191">return</span>&nbsp;<span class="ident" id="1508198">unsafe</span><span class="op" id="1508204">.</span><span class="ident" id="1508205">Pointer</span><span class="op" id="1508212">(</span><span class="ident" id="1508213">t</span><span class="op" id="1508214">.</span><span class="ident" id="1508215">elem</span><span class="op" id="1508219">.</span><span class="ident" id="1508220">zero</span><span class="op" id="1508224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508230">alg</span>&nbsp;<span class="op" id="1508234">:=</span>&nbsp;<span class="ident" id="1508237">goalg</span><span class="op" id="1508242">(</span><span class="ident" id="1508243">t</span><span class="op" id="1508244">.</span><span class="ident" id="1508245">key</span><span class="op" id="1508248">.</span><span class="ident" id="1508249">alg</span><span class="op" id="1508252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508255">hash</span>&nbsp;<span class="op" id="1508260">:=</span>&nbsp;<span class="ident" id="1508263">alg</span><span class="op" id="1508266">.</span><span class="ident" id="1508267">hash</span><span class="op" id="1508271">(</span><span class="ident" id="1508272">key</span><span class="op" id="1508275">,</span>&nbsp;<span class="builtintype" id="1508277">uintptr</span><span class="op" id="1508284">(</span><span class="ident" id="1508285">t</span><span class="op" id="1508286">.</span><span class="ident" id="1508287">key</span><span class="op" id="1508290">.</span><span class="ident" id="1508291">size</span><span class="op" id="1508295">)</span><span class="op" id="1508296">,</span>&nbsp;<span class="builtintype" id="1508298">uintptr</span><span class="op" id="1508305">(</span><span class="ident" id="1508306">h</span><span class="op" id="1508307">.</span><span class="ident" id="1508308">hash0</span><span class="op" id="1508313">)</span><span class="op" id="1508314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508317">m</span>&nbsp;<span class="op" id="1508319">:=</span>&nbsp;<span class="builtintype" id="1508322">uintptr</span><span class="op" id="1508329">(</span><span class="num" id="1508330">1</span><span class="op" id="1508331">)</span><span class="op" id="1508332">&lt;&lt;</span><span class="ident" id="1508334">h</span><span class="op" id="1508335">.</span><span class="ident" id="1508336">B</span>&nbsp;<span class="op" id="1508338">-</span>&nbsp;<span class="num" id="1508340">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508343">b</span>&nbsp;<span class="op" id="1508345">:=</span>&nbsp;<span class="op" id="1508348">(</span><span class="op" id="1508349">*</span><span class="ident" id="1508350">bmap</span><span class="op" id="1508354">)</span><span class="op" id="1508355">(</span><span class="ident" id="1508356">add</span><span class="op" id="1508359">(</span><span class="ident" id="1508360">h</span><span class="op" id="1508361">.</span><span class="ident" id="1508362">buckets</span><span class="op" id="1508369">,</span>&nbsp;<span class="op" id="1508371">(</span><span class="ident" id="1508372">hash</span><span class="op" id="1508376">&amp;</span><span class="ident" id="1508377">m</span><span class="op" id="1508378">)</span><span class="op" id="1508379">*</span><span class="builtintype" id="1508380">uintptr</span><span class="op" id="1508387">(</span><span class="ident" id="1508388">t</span><span class="op" id="1508389">.</span><span class="ident" id="1508390">bucketsize</span><span class="op" id="1508400">)</span><span class="op" id="1508401">)</span><span class="op" id="1508402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508405">if</span>&nbsp;<span class="ident" id="1508408">c</span>&nbsp;<span class="op" id="1508410">:=</span>&nbsp;<span class="ident" id="1508413">h</span><span class="op" id="1508414">.</span><span class="ident" id="1508415">oldbuckets</span><span class="op" id="1508425">;</span>&nbsp;<span class="ident" id="1508427">c</span>&nbsp;<span class="op" id="1508429">!=</span>&nbsp;<span class="builtintype" id="1508432">nil</span>&nbsp;<span class="op" id="1508436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508440">oldb</span>&nbsp;<span class="op" id="1508445">:=</span>&nbsp;<span class="op" id="1508448">(</span><span class="op" id="1508449">*</span><span class="ident" id="1508450">bmap</span><span class="op" id="1508454">)</span><span class="op" id="1508455">(</span><span class="ident" id="1508456">add</span><span class="op" id="1508459">(</span><span class="ident" id="1508460">c</span><span class="op" id="1508461">,</span>&nbsp;<span class="op" id="1508463">(</span><span class="ident" id="1508464">hash</span><span class="op" id="1508468">&amp;</span><span class="op" id="1508469">(</span><span class="ident" id="1508470">m</span><span class="op" id="1508471">&gt;&gt;</span><span class="num" id="1508473">1</span><span class="op" id="1508474">)</span><span class="op" id="1508475">)</span><span class="op" id="1508476">*</span><span class="builtintype" id="1508477">uintptr</span><span class="op" id="1508484">(</span><span class="ident" id="1508485">t</span><span class="op" id="1508486">.</span><span class="ident" id="1508487">bucketsize</span><span class="op" id="1508497">)</span><span class="op" id="1508498">)</span><span class="op" id="1508499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508503">if</span>&nbsp;<span class="op" id="1508506">!</span><span class="ident" id="1508507">evacuated</span><span class="op" id="1508516">(</span><span class="ident" id="1508517">oldb</span><span class="op" id="1508521">)</span>&nbsp;<span class="op" id="1508523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508528">b</span>&nbsp;<span class="op" id="1508530">=</span>&nbsp;<span class="ident" id="1508532">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508545">top</span>&nbsp;<span class="op" id="1508549">:=</span>&nbsp;<span class="builtintype" id="1508552">uint8</span><span class="op" id="1508557">(</span><span class="ident" id="1508558">hash</span>&nbsp;<span class="op" id="1508563">&gt;&gt;</span>&nbsp;<span class="op" id="1508566">(</span><span class="ident" id="1508567">ptrSize</span><span class="op" id="1508574">*</span><span class="num" id="1508575">8</span>&nbsp;<span class="op" id="1508577">-</span>&nbsp;<span class="num" id="1508579">8</span><span class="op" id="1508580">)</span><span class="op" id="1508581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508584">if</span>&nbsp;<span class="ident" id="1508587">top</span>&nbsp;<span class="op" id="1508591">&lt;</span>&nbsp;<span class="ident" id="1508593">minTopHash</span>&nbsp;<span class="op" id="1508604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508608">top</span>&nbsp;<span class="op" id="1508612">+=</span>&nbsp;<span class="ident" id="1508615">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508630">for</span>&nbsp;<span class="op" id="1508634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508638">for</span>&nbsp;<span class="ident" id="1508642">i</span>&nbsp;<span class="op" id="1508644">:=</span>&nbsp;<span class="builtintype" id="1508647">uintptr</span><span class="op" id="1508654">(</span><span class="num" id="1508655">0</span><span class="op" id="1508656">)</span><span class="op" id="1508657">;</span>&nbsp;<span class="ident" id="1508659">i</span>&nbsp;<span class="op" id="1508661">&lt;</span>&nbsp;<span class="ident" id="1508663">bucketCnt</span><span class="op" id="1508672">;</span>&nbsp;<span class="ident" id="1508674">i</span><span class="op" id="1508675">++</span>&nbsp;<span class="op" id="1508678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508683">if</span>&nbsp;<span class="ident" id="1508686">b</span><span class="op" id="1508687">.</span><span class="ident" id="1508688">tophash</span><span class="op" id="1508695">[</span><span class="ident" id="1508696">i</span><span class="op" id="1508697">]</span>&nbsp;<span class="op" id="1508699">!=</span>&nbsp;<span class="ident" id="1508702">top</span>&nbsp;<span class="op" id="1508706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508712">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508729">k</span>&nbsp;<span class="op" id="1508731">:=</span>&nbsp;<span class="ident" id="1508734">add</span><span class="op" id="1508737">(</span><span class="ident" id="1508738">unsafe</span><span class="op" id="1508744">.</span><span class="ident" id="1508745">Pointer</span><span class="op" id="1508752">(</span><span class="ident" id="1508753">b</span><span class="op" id="1508754">)</span><span class="op" id="1508755">,</span>&nbsp;<span class="ident" id="1508757">dataOffset</span><span class="op" id="1508767">+</span><span class="ident" id="1508768">i</span><span class="op" id="1508769">*</span><span class="builtintype" id="1508770">uintptr</span><span class="op" id="1508777">(</span><span class="ident" id="1508778">t</span><span class="op" id="1508779">.</span><span class="ident" id="1508780">keysize</span><span class="op" id="1508787">)</span><span class="op" id="1508788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508793">if</span>&nbsp;<span class="ident" id="1508796">t</span><span class="op" id="1508797">.</span><span class="ident" id="1508798">indirectkey</span>&nbsp;<span class="op" id="1508810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508816">k</span>&nbsp;<span class="op" id="1508818">=</span>&nbsp;<span class="op" id="1508820">*</span><span class="op" id="1508821">(</span><span class="op" id="1508822">(</span><span class="op" id="1508823">*</span><span class="ident" id="1508824">unsafe</span><span class="op" id="1508830">.</span><span class="ident" id="1508831">Pointer</span><span class="op" id="1508838">)</span><span class="op" id="1508839">(</span><span class="ident" id="1508840">k</span><span class="op" id="1508841">)</span><span class="op" id="1508842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508847">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508852">if</span>&nbsp;<span class="ident" id="1508855">alg</span><span class="op" id="1508858">.</span><span class="ident" id="1508859">equal</span><span class="op" id="1508864">(</span><span class="ident" id="1508865">key</span><span class="op" id="1508868">,</span>&nbsp;<span class="ident" id="1508870">k</span><span class="op" id="1508871">,</span>&nbsp;<span class="builtintype" id="1508873">uintptr</span><span class="op" id="1508880">(</span><span class="ident" id="1508881">t</span><span class="op" id="1508882">.</span><span class="ident" id="1508883">key</span><span class="op" id="1508886">.</span><span class="ident" id="1508887">size</span><span class="op" id="1508891">)</span><span class="op" id="1508892">)</span>&nbsp;<span class="op" id="1508894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508900">v</span>&nbsp;<span class="op" id="1508902">:=</span>&nbsp;<span class="ident" id="1508905">add</span><span class="op" id="1508908">(</span><span class="ident" id="1508909">unsafe</span><span class="op" id="1508915">.</span><span class="ident" id="1508916">Pointer</span><span class="op" id="1508923">(</span><span class="ident" id="1508924">b</span><span class="op" id="1508925">)</span><span class="op" id="1508926">,</span>&nbsp;<span class="ident" id="1508928">dataOffset</span><span class="op" id="1508938">+</span><span class="ident" id="1508939">bucketCnt</span><span class="op" id="1508948">*</span><span class="builtintype" id="1508949">uintptr</span><span class="op" id="1508956">(</span><span class="ident" id="1508957">t</span><span class="op" id="1508958">.</span><span class="ident" id="1508959">keysize</span><span class="op" id="1508966">)</span><span class="op" id="1508967">+</span><span class="ident" id="1508968">i</span><span class="op" id="1508969">*</span><span class="builtintype" id="1508970">uintptr</span><span class="op" id="1508977">(</span><span class="ident" id="1508978">t</span><span class="op" id="1508979">.</span><span class="ident" id="1508980">valuesize</span><span class="op" id="1508989">)</span><span class="op" id="1508990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508996">if</span>&nbsp;<span class="ident" id="1508999">t</span><span class="op" id="1509000">.</span><span class="ident" id="1509001">indirectvalue</span>&nbsp;<span class="op" id="1509015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509022">v</span>&nbsp;<span class="op" id="1509024">=</span>&nbsp;<span class="op" id="1509026">*</span><span class="op" id="1509027">(</span><span class="op" id="1509028">(</span><span class="op" id="1509029">*</span><span class="ident" id="1509030">unsafe</span><span class="op" id="1509036">.</span><span class="ident" id="1509037">Pointer</span><span class="op" id="1509044">)</span><span class="op" id="1509045">(</span><span class="ident" id="1509046">v</span><span class="op" id="1509047">)</span><span class="op" id="1509048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509054">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509060">return</span>&nbsp;<span class="ident" id="1509067">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509080">b</span>&nbsp;<span class="op" id="1509082">=</span>&nbsp;<span class="ident" id="1509084">b</span><span class="op" id="1509085">.</span><span class="ident" id="1509086">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509097">if</span>&nbsp;<span class="ident" id="1509100">b</span>&nbsp;<span class="op" id="1509102">==</span>&nbsp;<span class="builtintype" id="1509105">nil</span>&nbsp;<span class="op" id="1509109">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509114">return</span>&nbsp;<span class="ident" id="1509121">unsafe</span><span class="op" id="1509127">.</span><span class="ident" id="1509128">Pointer</span><span class="op" id="1509135">(</span><span class="ident" id="1509136">t</span><span class="op" id="1509137">.</span><span class="ident" id="1509138">elem</span><span class="op" id="1509142">.</span><span class="ident" id="1509143">zero</span><span class="op" id="1509147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509154">}</span><br>
<span class="lineno"></span><span class="op" id="1509156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1509159">func</span>&nbsp;<span class="ident" id="1509164">mapaccess2</span><span class="op" id="1509174">(</span><span class="ident" id="1509175">t</span>&nbsp;<span class="op" id="1509177">*</span><span class="ident" id="1509178">maptype</span><span class="op" id="1509185">,</span>&nbsp;<span class="ident" id="1509187">h</span>&nbsp;<span class="op" id="1509189">*</span><span class="ident" id="1509190">hmap</span><span class="op" id="1509194">,</span>&nbsp;<span class="ident" id="1509196">key</span>&nbsp;<span class="ident" id="1509200">unsafe</span><span class="op" id="1509206">.</span><span class="ident" id="1509207">Pointer</span><span class="op" id="1509214">)</span>&nbsp;<span class="op" id="1509216">(</span><span class="ident" id="1509217">unsafe</span><span class="op" id="1509223">.</span><span class="ident" id="1509224">Pointer</span><span class="op" id="1509231">,</span>&nbsp;<span class="builtintype" id="1509233">bool</span><span class="op" id="1509237">)</span>&nbsp;<span class="op" id="1509239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509242">if</span>&nbsp;<span class="ident" id="1509245">raceenabled</span>&nbsp;<span class="op" id="1509257">&amp;&amp;</span>&nbsp;<span class="ident" id="1509260">h</span>&nbsp;<span class="op" id="1509262">!=</span>&nbsp;<span class="builtintype" id="1509265">nil</span>&nbsp;<span class="op" id="1509269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509273">callerpc</span>&nbsp;<span class="op" id="1509282">:=</span>&nbsp;<span class="ident" id="1509285">getcallerpc</span><span class="op" id="1509296">(</span><span class="ident" id="1509297">unsafe</span><span class="op" id="1509303">.</span><span class="ident" id="1509304">Pointer</span><span class="op" id="1509311">(</span><span class="op" id="1509312">&amp;</span><span class="ident" id="1509313">t</span><span class="op" id="1509314">)</span><span class="op" id="1509315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509319">pc</span>&nbsp;<span class="op" id="1509322">:=</span>&nbsp;<span class="ident" id="1509325">funcPC</span><span class="op" id="1509331">(</span><span class="ident" id="1509332">mapaccess2</span><span class="op" id="1509342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509346">racereadpc</span><span class="op" id="1509356">(</span><span class="ident" id="1509357">unsafe</span><span class="op" id="1509363">.</span><span class="ident" id="1509364">Pointer</span><span class="op" id="1509371">(</span><span class="ident" id="1509372">h</span><span class="op" id="1509373">)</span><span class="op" id="1509374">,</span>&nbsp;<span class="ident" id="1509376">callerpc</span><span class="op" id="1509384">,</span>&nbsp;<span class="ident" id="1509386">pc</span><span class="op" id="1509388">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509392">raceReadObjectPC</span><span class="op" id="1509408">(</span><span class="ident" id="1509409">t</span><span class="op" id="1509410">.</span><span class="ident" id="1509411">key</span><span class="op" id="1509414">,</span>&nbsp;<span class="ident" id="1509416">key</span><span class="op" id="1509419">,</span>&nbsp;<span class="ident" id="1509421">callerpc</span><span class="op" id="1509429">,</span>&nbsp;<span class="ident" id="1509431">pc</span><span class="op" id="1509433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509439">if</span>&nbsp;<span class="ident" id="1509442">h</span>&nbsp;<span class="op" id="1509444">==</span>&nbsp;<span class="builtintype" id="1509447">nil</span>&nbsp;<span class="op" id="1509451">||</span>&nbsp;<span class="ident" id="1509454">h</span><span class="op" id="1509455">.</span><span class="ident" id="1509456">count</span>&nbsp;<span class="op" id="1509462">==</span>&nbsp;<span class="num" id="1509465">0</span>&nbsp;<span class="op" id="1509467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509471">return</span>&nbsp;<span class="ident" id="1509478">unsafe</span><span class="op" id="1509484">.</span><span class="ident" id="1509485">Pointer</span><span class="op" id="1509492">(</span><span class="ident" id="1509493">t</span><span class="op" id="1509494">.</span><span class="ident" id="1509495">elem</span><span class="op" id="1509499">.</span><span class="ident" id="1509500">zero</span><span class="op" id="1509504">)</span><span class="op" id="1509505">,</span>&nbsp;<span class="builtintype" id="1509507">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509514">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509517">alg</span>&nbsp;<span class="op" id="1509521">:=</span>&nbsp;<span class="ident" id="1509524">goalg</span><span class="op" id="1509529">(</span><span class="ident" id="1509530">t</span><span class="op" id="1509531">.</span><span class="ident" id="1509532">key</span><span class="op" id="1509535">.</span><span class="ident" id="1509536">alg</span><span class="op" id="1509539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509542">hash</span>&nbsp;<span class="op" id="1509547">:=</span>&nbsp;<span class="ident" id="1509550">alg</span><span class="op" id="1509553">.</span><span class="ident" id="1509554">hash</span><span class="op" id="1509558">(</span><span class="ident" id="1509559">key</span><span class="op" id="1509562">,</span>&nbsp;<span class="builtintype" id="1509564">uintptr</span><span class="op" id="1509571">(</span><span class="ident" id="1509572">t</span><span class="op" id="1509573">.</span><span class="ident" id="1509574">key</span><span class="op" id="1509577">.</span><span class="ident" id="1509578">size</span><span class="op" id="1509582">)</span><span class="op" id="1509583">,</span>&nbsp;<span class="builtintype" id="1509585">uintptr</span><span class="op" id="1509592">(</span><span class="ident" id="1509593">h</span><span class="op" id="1509594">.</span><span class="ident" id="1509595">hash0</span><span class="op" id="1509600">)</span><span class="op" id="1509601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509604">m</span>&nbsp;<span class="op" id="1509606">:=</span>&nbsp;<span class="builtintype" id="1509609">uintptr</span><span class="op" id="1509616">(</span><span class="num" id="1509617">1</span><span class="op" id="1509618">)</span><span class="op" id="1509619">&lt;&lt;</span><span class="ident" id="1509621">h</span><span class="op" id="1509622">.</span><span class="ident" id="1509623">B</span>&nbsp;<span class="op" id="1509625">-</span>&nbsp;<span class="num" id="1509627">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509630">b</span>&nbsp;<span class="op" id="1509632">:=</span>&nbsp;<span class="op" id="1509635">(</span><span class="op" id="1509636">*</span><span class="ident" id="1509637">bmap</span><span class="op" id="1509641">)</span><span class="op" id="1509642">(</span><span class="ident" id="1509643">unsafe</span><span class="op" id="1509649">.</span><span class="ident" id="1509650">Pointer</span><span class="op" id="1509657">(</span><span class="builtintype" id="1509658">uintptr</span><span class="op" id="1509665">(</span><span class="ident" id="1509666">h</span><span class="op" id="1509667">.</span><span class="ident" id="1509668">buckets</span><span class="op" id="1509675">)</span>&nbsp;<span class="op" id="1509677">+</span>&nbsp;<span class="op" id="1509679">(</span><span class="ident" id="1509680">hash</span><span class="op" id="1509684">&amp;</span><span class="ident" id="1509685">m</span><span class="op" id="1509686">)</span><span class="op" id="1509687">*</span><span class="builtintype" id="1509688">uintptr</span><span class="op" id="1509695">(</span><span class="ident" id="1509696">t</span><span class="op" id="1509697">.</span><span class="ident" id="1509698">bucketsize</span><span class="op" id="1509708">)</span><span class="op" id="1509709">)</span><span class="op" id="1509710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509713">if</span>&nbsp;<span class="ident" id="1509716">c</span>&nbsp;<span class="op" id="1509718">:=</span>&nbsp;<span class="ident" id="1509721">h</span><span class="op" id="1509722">.</span><span class="ident" id="1509723">oldbuckets</span><span class="op" id="1509733">;</span>&nbsp;<span class="ident" id="1509735">c</span>&nbsp;<span class="op" id="1509737">!=</span>&nbsp;<span class="builtintype" id="1509740">nil</span>&nbsp;<span class="op" id="1509744">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509748">oldb</span>&nbsp;<span class="op" id="1509753">:=</span>&nbsp;<span class="op" id="1509756">(</span><span class="op" id="1509757">*</span><span class="ident" id="1509758">bmap</span><span class="op" id="1509762">)</span><span class="op" id="1509763">(</span><span class="ident" id="1509764">unsafe</span><span class="op" id="1509770">.</span><span class="ident" id="1509771">Pointer</span><span class="op" id="1509778">(</span><span class="builtintype" id="1509779">uintptr</span><span class="op" id="1509786">(</span><span class="ident" id="1509787">c</span><span class="op" id="1509788">)</span>&nbsp;<span class="op" id="1509790">+</span>&nbsp;<span class="op" id="1509792">(</span><span class="ident" id="1509793">hash</span><span class="op" id="1509797">&amp;</span><span class="op" id="1509798">(</span><span class="ident" id="1509799">m</span><span class="op" id="1509800">&gt;&gt;</span><span class="num" id="1509802">1</span><span class="op" id="1509803">)</span><span class="op" id="1509804">)</span><span class="op" id="1509805">*</span><span class="builtintype" id="1509806">uintptr</span><span class="op" id="1509813">(</span><span class="ident" id="1509814">t</span><span class="op" id="1509815">.</span><span class="ident" id="1509816">bucketsize</span><span class="op" id="1509826">)</span><span class="op" id="1509827">)</span><span class="op" id="1509828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509832">if</span>&nbsp;<span class="op" id="1509835">!</span><span class="ident" id="1509836">evacuated</span><span class="op" id="1509845">(</span><span class="ident" id="1509846">oldb</span><span class="op" id="1509850">)</span>&nbsp;<span class="op" id="1509852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509857">b</span>&nbsp;<span class="op" id="1509859">=</span>&nbsp;<span class="ident" id="1509861">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509871">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509874">top</span>&nbsp;<span class="op" id="1509878">:=</span>&nbsp;<span class="builtintype" id="1509881">uint8</span><span class="op" id="1509886">(</span><span class="ident" id="1509887">hash</span>&nbsp;<span class="op" id="1509892">&gt;&gt;</span>&nbsp;<span class="op" id="1509895">(</span><span class="ident" id="1509896">ptrSize</span><span class="op" id="1509903">*</span><span class="num" id="1509904">8</span>&nbsp;<span class="op" id="1509906">-</span>&nbsp;<span class="num" id="1509908">8</span><span class="op" id="1509909">)</span><span class="op" id="1509910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509913">if</span>&nbsp;<span class="ident" id="1509916">top</span>&nbsp;<span class="op" id="1509920">&lt;</span>&nbsp;<span class="ident" id="1509922">minTopHash</span>&nbsp;<span class="op" id="1509933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509937">top</span>&nbsp;<span class="op" id="1509941">+=</span>&nbsp;<span class="ident" id="1509944">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509959">for</span>&nbsp;<span class="op" id="1509963">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509967">for</span>&nbsp;<span class="ident" id="1509971">i</span>&nbsp;<span class="op" id="1509973">:=</span>&nbsp;<span class="builtintype" id="1509976">uintptr</span><span class="op" id="1509983">(</span><span class="num" id="1509984">0</span><span class="op" id="1509985">)</span><span class="op" id="1509986">;</span>&nbsp;<span class="ident" id="1509988">i</span>&nbsp;<span class="op" id="1509990">&lt;</span>&nbsp;<span class="ident" id="1509992">bucketCnt</span><span class="op" id="1510001">;</span>&nbsp;<span class="ident" id="1510003">i</span><span class="op" id="1510004">++</span>&nbsp;<span class="op" id="1510007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510012">if</span>&nbsp;<span class="ident" id="1510015">b</span><span class="op" id="1510016">.</span><span class="ident" id="1510017">tophash</span><span class="op" id="1510024">[</span><span class="ident" id="1510025">i</span><span class="op" id="1510026">]</span>&nbsp;<span class="op" id="1510028">!=</span>&nbsp;<span class="ident" id="1510031">top</span>&nbsp;<span class="op" id="1510035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510041">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510058">k</span>&nbsp;<span class="op" id="1510060">:=</span>&nbsp;<span class="ident" id="1510063">add</span><span class="op" id="1510066">(</span><span class="ident" id="1510067">unsafe</span><span class="op" id="1510073">.</span><span class="ident" id="1510074">Pointer</span><span class="op" id="1510081">(</span><span class="ident" id="1510082">b</span><span class="op" id="1510083">)</span><span class="op" id="1510084">,</span>&nbsp;<span class="ident" id="1510086">dataOffset</span><span class="op" id="1510096">+</span><span class="ident" id="1510097">i</span><span class="op" id="1510098">*</span><span class="builtintype" id="1510099">uintptr</span><span class="op" id="1510106">(</span><span class="ident" id="1510107">t</span><span class="op" id="1510108">.</span><span class="ident" id="1510109">keysize</span><span class="op" id="1510116">)</span><span class="op" id="1510117">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510122">if</span>&nbsp;<span class="ident" id="1510125">t</span><span class="op" id="1510126">.</span><span class="ident" id="1510127">indirectkey</span>&nbsp;<span class="op" id="1510139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510145">k</span>&nbsp;<span class="op" id="1510147">=</span>&nbsp;<span class="op" id="1510149">*</span><span class="op" id="1510150">(</span><span class="op" id="1510151">(</span><span class="op" id="1510152">*</span><span class="ident" id="1510153">unsafe</span><span class="op" id="1510159">.</span><span class="ident" id="1510160">Pointer</span><span class="op" id="1510167">)</span><span class="op" id="1510168">(</span><span class="ident" id="1510169">k</span><span class="op" id="1510170">)</span><span class="op" id="1510171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510181">if</span>&nbsp;<span class="ident" id="1510184">alg</span><span class="op" id="1510187">.</span><span class="ident" id="1510188">equal</span><span class="op" id="1510193">(</span><span class="ident" id="1510194">key</span><span class="op" id="1510197">,</span>&nbsp;<span class="ident" id="1510199">k</span><span class="op" id="1510200">,</span>&nbsp;<span class="builtintype" id="1510202">uintptr</span><span class="op" id="1510209">(</span><span class="ident" id="1510210">t</span><span class="op" id="1510211">.</span><span class="ident" id="1510212">key</span><span class="op" id="1510215">.</span><span class="ident" id="1510216">size</span><span class="op" id="1510220">)</span><span class="op" id="1510221">)</span>&nbsp;<span class="op" id="1510223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510229">v</span>&nbsp;<span class="op" id="1510231">:=</span>&nbsp;<span class="ident" id="1510234">add</span><span class="op" id="1510237">(</span><span class="ident" id="1510238">unsafe</span><span class="op" id="1510244">.</span><span class="ident" id="1510245">Pointer</span><span class="op" id="1510252">(</span><span class="ident" id="1510253">b</span><span class="op" id="1510254">)</span><span class="op" id="1510255">,</span>&nbsp;<span class="ident" id="1510257">dataOffset</span><span class="op" id="1510267">+</span><span class="ident" id="1510268">bucketCnt</span><span class="op" id="1510277">*</span><span class="builtintype" id="1510278">uintptr</span><span class="op" id="1510285">(</span><span class="ident" id="1510286">t</span><span class="op" id="1510287">.</span><span class="ident" id="1510288">keysize</span><span class="op" id="1510295">)</span><span class="op" id="1510296">+</span><span class="ident" id="1510297">i</span><span class="op" id="1510298">*</span><span class="builtintype" id="1510299">uintptr</span><span class="op" id="1510306">(</span><span class="ident" id="1510307">t</span><span class="op" id="1510308">.</span><span class="ident" id="1510309">valuesize</span><span class="op" id="1510318">)</span><span class="op" id="1510319">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510325">if</span>&nbsp;<span class="ident" id="1510328">t</span><span class="op" id="1510329">.</span><span class="ident" id="1510330">indirectvalue</span>&nbsp;<span class="op" id="1510344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510351">v</span>&nbsp;<span class="op" id="1510353">=</span>&nbsp;<span class="op" id="1510355">*</span><span class="op" id="1510356">(</span><span class="op" id="1510357">(</span><span class="op" id="1510358">*</span><span class="ident" id="1510359">unsafe</span><span class="op" id="1510365">.</span><span class="ident" id="1510366">Pointer</span><span class="op" id="1510373">)</span><span class="op" id="1510374">(</span><span class="ident" id="1510375">v</span><span class="op" id="1510376">)</span><span class="op" id="1510377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510389">return</span>&nbsp;<span class="ident" id="1510396">v</span><span class="op" id="1510397">,</span>&nbsp;<span class="builtintype" id="1510399">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510407">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510415">b</span>&nbsp;<span class="op" id="1510417">=</span>&nbsp;<span class="ident" id="1510419">b</span><span class="op" id="1510420">.</span><span class="ident" id="1510421">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510432">if</span>&nbsp;<span class="ident" id="1510435">b</span>&nbsp;<span class="op" id="1510437">==</span>&nbsp;<span class="builtintype" id="1510440">nil</span>&nbsp;<span class="op" id="1510444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510449">return</span>&nbsp;<span class="ident" id="1510456">unsafe</span><span class="op" id="1510462">.</span><span class="ident" id="1510463">Pointer</span><span class="op" id="1510470">(</span><span class="ident" id="1510471">t</span><span class="op" id="1510472">.</span><span class="ident" id="1510473">elem</span><span class="op" id="1510477">.</span><span class="ident" id="1510478">zero</span><span class="op" id="1510482">)</span><span class="op" id="1510483">,</span>&nbsp;<span class="builtintype" id="1510485">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510493">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510496">}</span><br>
<span class="lineno"></span><span class="op" id="1510498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1510501">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1510554">func</span>&nbsp;<span class="ident" id="1510559">mapaccessK</span><span class="op" id="1510569">(</span><span class="ident" id="1510570">t</span>&nbsp;<span class="op" id="1510572">*</span><span class="ident" id="1510573">maptype</span><span class="op" id="1510580">,</span>&nbsp;<span class="ident" id="1510582">h</span>&nbsp;<span class="op" id="1510584">*</span><span class="ident" id="1510585">hmap</span><span class="op" id="1510589">,</span>&nbsp;<span class="ident" id="1510591">key</span>&nbsp;<span class="ident" id="1510595">unsafe</span><span class="op" id="1510601">.</span><span class="ident" id="1510602">Pointer</span><span class="op" id="1510609">)</span>&nbsp;<span class="op" id="1510611">(</span><span class="ident" id="1510612">unsafe</span><span class="op" id="1510618">.</span><span class="ident" id="1510619">Pointer</span><span class="op" id="1510626">,</span>&nbsp;<span class="ident" id="1510628">unsafe</span><span class="op" id="1510634">.</span><span class="ident" id="1510635">Pointer</span><span class="op" id="1510642">)</span>&nbsp;<span class="op" id="1510644">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510647">if</span>&nbsp;<span class="ident" id="1510650">h</span>&nbsp;<span class="op" id="1510652">==</span>&nbsp;<span class="builtintype" id="1510655">nil</span>&nbsp;<span class="op" id="1510659">||</span>&nbsp;<span class="ident" id="1510662">h</span><span class="op" id="1510663">.</span><span class="ident" id="1510664">count</span>&nbsp;<span class="op" id="1510670">==</span>&nbsp;<span class="num" id="1510673">0</span>&nbsp;<span class="op" id="1510675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510679">return</span>&nbsp;<span class="builtintype" id="1510686">nil</span><span class="op" id="1510689">,</span>&nbsp;<span class="builtintype" id="1510691">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510699">alg</span>&nbsp;<span class="op" id="1510703">:=</span>&nbsp;<span class="ident" id="1510706">goalg</span><span class="op" id="1510711">(</span><span class="ident" id="1510712">t</span><span class="op" id="1510713">.</span><span class="ident" id="1510714">key</span><span class="op" id="1510717">.</span><span class="ident" id="1510718">alg</span><span class="op" id="1510721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510724">hash</span>&nbsp;<span class="op" id="1510729">:=</span>&nbsp;<span class="ident" id="1510732">alg</span><span class="op" id="1510735">.</span><span class="ident" id="1510736">hash</span><span class="op" id="1510740">(</span><span class="ident" id="1510741">key</span><span class="op" id="1510744">,</span>&nbsp;<span class="builtintype" id="1510746">uintptr</span><span class="op" id="1510753">(</span><span class="ident" id="1510754">t</span><span class="op" id="1510755">.</span><span class="ident" id="1510756">key</span><span class="op" id="1510759">.</span><span class="ident" id="1510760">size</span><span class="op" id="1510764">)</span><span class="op" id="1510765">,</span>&nbsp;<span class="builtintype" id="1510767">uintptr</span><span class="op" id="1510774">(</span><span class="ident" id="1510775">h</span><span class="op" id="1510776">.</span><span class="ident" id="1510777">hash0</span><span class="op" id="1510782">)</span><span class="op" id="1510783">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510786">m</span>&nbsp;<span class="op" id="1510788">:=</span>&nbsp;<span class="builtintype" id="1510791">uintptr</span><span class="op" id="1510798">(</span><span class="num" id="1510799">1</span><span class="op" id="1510800">)</span><span class="op" id="1510801">&lt;&lt;</span><span class="ident" id="1510803">h</span><span class="op" id="1510804">.</span><span class="ident" id="1510805">B</span>&nbsp;<span class="op" id="1510807">-</span>&nbsp;<span class="num" id="1510809">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510812">b</span>&nbsp;<span class="op" id="1510814">:=</span>&nbsp;<span class="op" id="1510817">(</span><span class="op" id="1510818">*</span><span class="ident" id="1510819">bmap</span><span class="op" id="1510823">)</span><span class="op" id="1510824">(</span><span class="ident" id="1510825">unsafe</span><span class="op" id="1510831">.</span><span class="ident" id="1510832">Pointer</span><span class="op" id="1510839">(</span><span class="builtintype" id="1510840">uintptr</span><span class="op" id="1510847">(</span><span class="ident" id="1510848">h</span><span class="op" id="1510849">.</span><span class="ident" id="1510850">buckets</span><span class="op" id="1510857">)</span>&nbsp;<span class="op" id="1510859">+</span>&nbsp;<span class="op" id="1510861">(</span><span class="ident" id="1510862">hash</span><span class="op" id="1510866">&amp;</span><span class="ident" id="1510867">m</span><span class="op" id="1510868">)</span><span class="op" id="1510869">*</span><span class="builtintype" id="1510870">uintptr</span><span class="op" id="1510877">(</span><span class="ident" id="1510878">t</span><span class="op" id="1510879">.</span><span class="ident" id="1510880">bucketsize</span><span class="op" id="1510890">)</span><span class="op" id="1510891">)</span><span class="op" id="1510892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510895">if</span>&nbsp;<span class="ident" id="1510898">c</span>&nbsp;<span class="op" id="1510900">:=</span>&nbsp;<span class="ident" id="1510903">h</span><span class="op" id="1510904">.</span><span class="ident" id="1510905">oldbuckets</span><span class="op" id="1510915">;</span>&nbsp;<span class="ident" id="1510917">c</span>&nbsp;<span class="op" id="1510919">!=</span>&nbsp;<span class="builtintype" id="1510922">nil</span>&nbsp;<span class="op" id="1510926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510930">oldb</span>&nbsp;<span class="op" id="1510935">:=</span>&nbsp;<span class="op" id="1510938">(</span><span class="op" id="1510939">*</span><span class="ident" id="1510940">bmap</span><span class="op" id="1510944">)</span><span class="op" id="1510945">(</span><span class="ident" id="1510946">unsafe</span><span class="op" id="1510952">.</span><span class="ident" id="1510953">Pointer</span><span class="op" id="1510960">(</span><span class="builtintype" id="1510961">uintptr</span><span class="op" id="1510968">(</span><span class="ident" id="1510969">c</span><span class="op" id="1510970">)</span>&nbsp;<span class="op" id="1510972">+</span>&nbsp;<span class="op" id="1510974">(</span><span class="ident" id="1510975">hash</span><span class="op" id="1510979">&amp;</span><span class="op" id="1510980">(</span><span class="ident" id="1510981">m</span><span class="op" id="1510982">&gt;&gt;</span><span class="num" id="1510984">1</span><span class="op" id="1510985">)</span><span class="op" id="1510986">)</span><span class="op" id="1510987">*</span><span class="builtintype" id="1510988">uintptr</span><span class="op" id="1510995">(</span><span class="ident" id="1510996">t</span><span class="op" id="1510997">.</span><span class="ident" id="1510998">bucketsize</span><span class="op" id="1511008">)</span><span class="op" id="1511009">)</span><span class="op" id="1511010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511014">if</span>&nbsp;<span class="op" id="1511017">!</span><span class="ident" id="1511018">evacuated</span><span class="op" id="1511027">(</span><span class="ident" id="1511028">oldb</span><span class="op" id="1511032">)</span>&nbsp;<span class="op" id="1511034">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511039">b</span>&nbsp;<span class="op" id="1511041">=</span>&nbsp;<span class="ident" id="1511043">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511056">top</span>&nbsp;<span class="op" id="1511060">:=</span>&nbsp;<span class="builtintype" id="1511063">uint8</span><span class="op" id="1511068">(</span><span class="ident" id="1511069">hash</span>&nbsp;<span class="op" id="1511074">&gt;&gt;</span>&nbsp;<span class="op" id="1511077">(</span><span class="ident" id="1511078">ptrSize</span><span class="op" id="1511085">*</span><span class="num" id="1511086">8</span>&nbsp;<span class="op" id="1511088">-</span>&nbsp;<span class="num" id="1511090">8</span><span class="op" id="1511091">)</span><span class="op" id="1511092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511095">if</span>&nbsp;<span class="ident" id="1511098">top</span>&nbsp;<span class="op" id="1511102">&lt;</span>&nbsp;<span class="ident" id="1511104">minTopHash</span>&nbsp;<span class="op" id="1511115">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511119">top</span>&nbsp;<span class="op" id="1511123">+=</span>&nbsp;<span class="ident" id="1511126">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511141">for</span>&nbsp;<span class="op" id="1511145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511149">for</span>&nbsp;<span class="ident" id="1511153">i</span>&nbsp;<span class="op" id="1511155">:=</span>&nbsp;<span class="builtintype" id="1511158">uintptr</span><span class="op" id="1511165">(</span><span class="num" id="1511166">0</span><span class="op" id="1511167">)</span><span class="op" id="1511168">;</span>&nbsp;<span class="ident" id="1511170">i</span>&nbsp;<span class="op" id="1511172">&lt;</span>&nbsp;<span class="ident" id="1511174">bucketCnt</span><span class="op" id="1511183">;</span>&nbsp;<span class="ident" id="1511185">i</span><span class="op" id="1511186">++</span>&nbsp;<span class="op" id="1511189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511194">if</span>&nbsp;<span class="ident" id="1511197">b</span><span class="op" id="1511198">.</span><span class="ident" id="1511199">tophash</span><span class="op" id="1511206">[</span><span class="ident" id="1511207">i</span><span class="op" id="1511208">]</span>&nbsp;<span class="op" id="1511210">!=</span>&nbsp;<span class="ident" id="1511213">top</span>&nbsp;<span class="op" id="1511217">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511223">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511240">k</span>&nbsp;<span class="op" id="1511242">:=</span>&nbsp;<span class="ident" id="1511245">add</span><span class="op" id="1511248">(</span><span class="ident" id="1511249">unsafe</span><span class="op" id="1511255">.</span><span class="ident" id="1511256">Pointer</span><span class="op" id="1511263">(</span><span class="ident" id="1511264">b</span><span class="op" id="1511265">)</span><span class="op" id="1511266">,</span>&nbsp;<span class="ident" id="1511268">dataOffset</span><span class="op" id="1511278">+</span><span class="ident" id="1511279">i</span><span class="op" id="1511280">*</span><span class="builtintype" id="1511281">uintptr</span><span class="op" id="1511288">(</span><span class="ident" id="1511289">t</span><span class="op" id="1511290">.</span><span class="ident" id="1511291">keysize</span><span class="op" id="1511298">)</span><span class="op" id="1511299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511304">if</span>&nbsp;<span class="ident" id="1511307">t</span><span class="op" id="1511308">.</span><span class="ident" id="1511309">indirectkey</span>&nbsp;<span class="op" id="1511321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511327">k</span>&nbsp;<span class="op" id="1511329">=</span>&nbsp;<span class="op" id="1511331">*</span><span class="op" id="1511332">(</span><span class="op" id="1511333">(</span><span class="op" id="1511334">*</span><span class="ident" id="1511335">unsafe</span><span class="op" id="1511341">.</span><span class="ident" id="1511342">Pointer</span><span class="op" id="1511349">)</span><span class="op" id="1511350">(</span><span class="ident" id="1511351">k</span><span class="op" id="1511352">)</span><span class="op" id="1511353">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511363">if</span>&nbsp;<span class="ident" id="1511366">alg</span><span class="op" id="1511369">.</span><span class="ident" id="1511370">equal</span><span class="op" id="1511375">(</span><span class="ident" id="1511376">key</span><span class="op" id="1511379">,</span>&nbsp;<span class="ident" id="1511381">k</span><span class="op" id="1511382">,</span>&nbsp;<span class="builtintype" id="1511384">uintptr</span><span class="op" id="1511391">(</span><span class="ident" id="1511392">t</span><span class="op" id="1511393">.</span><span class="ident" id="1511394">key</span><span class="op" id="1511397">.</span><span class="ident" id="1511398">size</span><span class="op" id="1511402">)</span><span class="op" id="1511403">)</span>&nbsp;<span class="op" id="1511405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511411">v</span>&nbsp;<span class="op" id="1511413">:=</span>&nbsp;<span class="ident" id="1511416">add</span><span class="op" id="1511419">(</span><span class="ident" id="1511420">unsafe</span><span class="op" id="1511426">.</span><span class="ident" id="1511427">Pointer</span><span class="op" id="1511434">(</span><span class="ident" id="1511435">b</span><span class="op" id="1511436">)</span><span class="op" id="1511437">,</span>&nbsp;<span class="ident" id="1511439">dataOffset</span><span class="op" id="1511449">+</span><span class="ident" id="1511450">bucketCnt</span><span class="op" id="1511459">*</span><span class="builtintype" id="1511460">uintptr</span><span class="op" id="1511467">(</span><span class="ident" id="1511468">t</span><span class="op" id="1511469">.</span><span class="ident" id="1511470">keysize</span><span class="op" id="1511477">)</span><span class="op" id="1511478">+</span><span class="ident" id="1511479">i</span><span class="op" id="1511480">*</span><span class="builtintype" id="1511481">uintptr</span><span class="op" id="1511488">(</span><span class="ident" id="1511489">t</span><span class="op" id="1511490">.</span><span class="ident" id="1511491">valuesize</span><span class="op" id="1511500">)</span><span class="op" id="1511501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511507">if</span>&nbsp;<span class="ident" id="1511510">t</span><span class="op" id="1511511">.</span><span class="ident" id="1511512">indirectvalue</span>&nbsp;<span class="op" id="1511526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511533">v</span>&nbsp;<span class="op" id="1511535">=</span>&nbsp;<span class="op" id="1511537">*</span><span class="op" id="1511538">(</span><span class="op" id="1511539">(</span><span class="op" id="1511540">*</span><span class="ident" id="1511541">unsafe</span><span class="op" id="1511547">.</span><span class="ident" id="1511548">Pointer</span><span class="op" id="1511555">)</span><span class="op" id="1511556">(</span><span class="ident" id="1511557">v</span><span class="op" id="1511558">)</span><span class="op" id="1511559">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511571">return</span>&nbsp;<span class="ident" id="1511578">k</span><span class="op" id="1511579">,</span>&nbsp;<span class="ident" id="1511581">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511594">b</span>&nbsp;<span class="op" id="1511596">=</span>&nbsp;<span class="ident" id="1511598">b</span><span class="op" id="1511599">.</span><span class="ident" id="1511600">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511611">if</span>&nbsp;<span class="ident" id="1511614">b</span>&nbsp;<span class="op" id="1511616">==</span>&nbsp;<span class="builtintype" id="1511619">nil</span>&nbsp;<span class="op" id="1511623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511628">return</span>&nbsp;<span class="builtintype" id="1511635">nil</span><span class="op" id="1511638">,</span>&nbsp;<span class="builtintype" id="1511640">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511649">}</span><br>
<span class="lineno"></span><span class="op" id="1511651">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1511654">func</span>&nbsp;<span class="ident" id="1511659">mapassign1</span><span class="op" id="1511669">(</span><span class="ident" id="1511670">t</span>&nbsp;<span class="op" id="1511672">*</span><span class="ident" id="1511673">maptype</span><span class="op" id="1511680">,</span>&nbsp;<span class="ident" id="1511682">h</span>&nbsp;<span class="op" id="1511684">*</span><span class="ident" id="1511685">hmap</span><span class="op" id="1511689">,</span>&nbsp;<span class="ident" id="1511691">key</span>&nbsp;<span class="ident" id="1511695">unsafe</span><span class="op" id="1511701">.</span><span class="ident" id="1511702">Pointer</span><span class="op" id="1511709">,</span>&nbsp;<span class="ident" id="1511711">val</span>&nbsp;<span class="ident" id="1511715">unsafe</span><span class="op" id="1511721">.</span><span class="ident" id="1511722">Pointer</span><span class="op" id="1511729">)</span>&nbsp;<span class="op" id="1511731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511734">if</span>&nbsp;<span class="ident" id="1511737">h</span>&nbsp;<span class="op" id="1511739">==</span>&nbsp;<span class="builtintype" id="1511742">nil</span>&nbsp;<span class="op" id="1511746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1511750">panic</span><span class="op" id="1511755">(</span><span class="string" id="1511756">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1511788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511791">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511794">if</span>&nbsp;<span class="ident" id="1511797">raceenabled</span>&nbsp;<span class="op" id="1511809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511813">callerpc</span>&nbsp;<span class="op" id="1511822">:=</span>&nbsp;<span class="ident" id="1511825">getcallerpc</span><span class="op" id="1511836">(</span><span class="ident" id="1511837">unsafe</span><span class="op" id="1511843">.</span><span class="ident" id="1511844">Pointer</span><span class="op" id="1511851">(</span><span class="op" id="1511852">&amp;</span><span class="ident" id="1511853">t</span><span class="op" id="1511854">)</span><span class="op" id="1511855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511859">pc</span>&nbsp;<span class="op" id="1511862">:=</span>&nbsp;<span class="ident" id="1511865">funcPC</span><span class="op" id="1511871">(</span><span class="ident" id="1511872">mapassign1</span><span class="op" id="1511882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511886">racewritepc</span><span class="op" id="1511897">(</span><span class="ident" id="1511898">unsafe</span><span class="op" id="1511904">.</span><span class="ident" id="1511905">Pointer</span><span class="op" id="1511912">(</span><span class="ident" id="1511913">h</span><span class="op" id="1511914">)</span><span class="op" id="1511915">,</span>&nbsp;<span class="ident" id="1511917">callerpc</span><span class="op" id="1511925">,</span>&nbsp;<span class="ident" id="1511927">pc</span><span class="op" id="1511929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511933">raceReadObjectPC</span><span class="op" id="1511949">(</span><span class="ident" id="1511950">t</span><span class="op" id="1511951">.</span><span class="ident" id="1511952">key</span><span class="op" id="1511955">,</span>&nbsp;<span class="ident" id="1511957">key</span><span class="op" id="1511960">,</span>&nbsp;<span class="ident" id="1511962">callerpc</span><span class="op" id="1511970">,</span>&nbsp;<span class="ident" id="1511972">pc</span><span class="op" id="1511974">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511978">raceReadObjectPC</span><span class="op" id="1511994">(</span><span class="ident" id="1511995">t</span><span class="op" id="1511996">.</span><span class="ident" id="1511997">elem</span><span class="op" id="1512001">,</span>&nbsp;<span class="ident" id="1512003">val</span><span class="op" id="1512006">,</span>&nbsp;<span class="ident" id="1512008">callerpc</span><span class="op" id="1512016">,</span>&nbsp;<span class="ident" id="1512018">pc</span><span class="op" id="1512020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512027">alg</span>&nbsp;<span class="op" id="1512031">:=</span>&nbsp;<span class="ident" id="1512034">goalg</span><span class="op" id="1512039">(</span><span class="ident" id="1512040">t</span><span class="op" id="1512041">.</span><span class="ident" id="1512042">key</span><span class="op" id="1512045">.</span><span class="ident" id="1512046">alg</span><span class="op" id="1512049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512052">hash</span>&nbsp;<span class="op" id="1512057">:=</span>&nbsp;<span class="ident" id="1512060">alg</span><span class="op" id="1512063">.</span><span class="ident" id="1512064">hash</span><span class="op" id="1512068">(</span><span class="ident" id="1512069">key</span><span class="op" id="1512072">,</span>&nbsp;<span class="builtintype" id="1512074">uintptr</span><span class="op" id="1512081">(</span><span class="ident" id="1512082">t</span><span class="op" id="1512083">.</span><span class="ident" id="1512084">key</span><span class="op" id="1512087">.</span><span class="ident" id="1512088">size</span><span class="op" id="1512092">)</span><span class="op" id="1512093">,</span>&nbsp;<span class="builtintype" id="1512095">uintptr</span><span class="op" id="1512102">(</span><span class="ident" id="1512103">h</span><span class="op" id="1512104">.</span><span class="ident" id="1512105">hash0</span><span class="op" id="1512110">)</span><span class="op" id="1512111">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512115">if</span>&nbsp;<span class="ident" id="1512118">h</span><span class="op" id="1512119">.</span><span class="ident" id="1512120">buckets</span>&nbsp;<span class="op" id="1512128">==</span>&nbsp;<span class="builtintype" id="1512131">nil</span>&nbsp;<span class="op" id="1512135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512139">if</span>&nbsp;<span class="ident" id="1512142">checkgc</span>&nbsp;<span class="op" id="1512150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512155">memstats</span><span class="op" id="1512163">.</span><span class="ident" id="1512164">next_gc</span>&nbsp;<span class="op" id="1512172">=</span>&nbsp;<span class="ident" id="1512174">memstats</span><span class="op" id="1512182">.</span><span class="ident" id="1512183">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512196">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512200">h</span><span class="op" id="1512201">.</span><span class="ident" id="1512202">buckets</span>&nbsp;<span class="op" id="1512210">=</span>&nbsp;<span class="ident" id="1512212">newarray</span><span class="op" id="1512220">(</span><span class="ident" id="1512221">t</span><span class="op" id="1512222">.</span><span class="ident" id="1512223">bucket</span><span class="op" id="1512229">,</span>&nbsp;<span class="num" id="1512231">1</span><span class="op" id="1512232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1512238">again</span><span class="op" id="1512243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512246">bucket</span>&nbsp;<span class="op" id="1512253">:=</span>&nbsp;<span class="ident" id="1512256">hash</span>&nbsp;<span class="op" id="1512261">&amp;</span>&nbsp;<span class="op" id="1512263">(</span><span class="builtintype" id="1512264">uintptr</span><span class="op" id="1512271">(</span><span class="num" id="1512272">1</span><span class="op" id="1512273">)</span><span class="op" id="1512274">&lt;&lt;</span><span class="ident" id="1512276">h</span><span class="op" id="1512277">.</span><span class="ident" id="1512278">B</span>&nbsp;<span class="op" id="1512280">-</span>&nbsp;<span class="num" id="1512282">1</span><span class="op" id="1512283">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512286">if</span>&nbsp;<span class="ident" id="1512289">h</span><span class="op" id="1512290">.</span><span class="ident" id="1512291">oldbuckets</span>&nbsp;<span class="op" id="1512302">!=</span>&nbsp;<span class="builtintype" id="1512305">nil</span>&nbsp;<span class="op" id="1512309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512313">growWork</span><span class="op" id="1512321">(</span><span class="ident" id="1512322">t</span><span class="op" id="1512323">,</span>&nbsp;<span class="ident" id="1512325">h</span><span class="op" id="1512326">,</span>&nbsp;<span class="ident" id="1512328">bucket</span><span class="op" id="1512334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512340">b</span>&nbsp;<span class="op" id="1512342">:=</span>&nbsp;<span class="op" id="1512345">(</span><span class="op" id="1512346">*</span><span class="ident" id="1512347">bmap</span><span class="op" id="1512351">)</span><span class="op" id="1512352">(</span><span class="ident" id="1512353">unsafe</span><span class="op" id="1512359">.</span><span class="ident" id="1512360">Pointer</span><span class="op" id="1512367">(</span><span class="builtintype" id="1512368">uintptr</span><span class="op" id="1512375">(</span><span class="ident" id="1512376">h</span><span class="op" id="1512377">.</span><span class="ident" id="1512378">buckets</span><span class="op" id="1512385">)</span>&nbsp;<span class="op" id="1512387">+</span>&nbsp;<span class="ident" id="1512389">bucket</span><span class="op" id="1512395">*</span><span class="builtintype" id="1512396">uintptr</span><span class="op" id="1512403">(</span><span class="ident" id="1512404">t</span><span class="op" id="1512405">.</span><span class="ident" id="1512406">bucketsize</span><span class="op" id="1512416">)</span><span class="op" id="1512417">)</span><span class="op" id="1512418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512421">top</span>&nbsp;<span class="op" id="1512425">:=</span>&nbsp;<span class="builtintype" id="1512428">uint8</span><span class="op" id="1512433">(</span><span class="ident" id="1512434">hash</span>&nbsp;<span class="op" id="1512439">&gt;&gt;</span>&nbsp;<span class="op" id="1512442">(</span><span class="ident" id="1512443">ptrSize</span><span class="op" id="1512450">*</span><span class="num" id="1512451">8</span>&nbsp;<span class="op" id="1512453">-</span>&nbsp;<span class="num" id="1512455">8</span><span class="op" id="1512456">)</span><span class="op" id="1512457">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512460">if</span>&nbsp;<span class="ident" id="1512463">top</span>&nbsp;<span class="op" id="1512467">&lt;</span>&nbsp;<span class="ident" id="1512469">minTopHash</span>&nbsp;<span class="op" id="1512480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512484">top</span>&nbsp;<span class="op" id="1512488">+=</span>&nbsp;<span class="ident" id="1512491">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512507">var</span>&nbsp;<span class="ident" id="1512511">inserti</span>&nbsp;<span class="op" id="1512519">*</span><span class="builtintype" id="1512520">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512527">var</span>&nbsp;<span class="ident" id="1512531">insertk</span>&nbsp;<span class="ident" id="1512539">unsafe</span><span class="op" id="1512545">.</span><span class="ident" id="1512546">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512555">var</span>&nbsp;<span class="ident" id="1512559">insertv</span>&nbsp;<span class="ident" id="1512567">unsafe</span><span class="op" id="1512573">.</span><span class="ident" id="1512574">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512583">for</span>&nbsp;<span class="op" id="1512587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512591">for</span>&nbsp;<span class="ident" id="1512595">i</span>&nbsp;<span class="op" id="1512597">:=</span>&nbsp;<span class="builtintype" id="1512600">uintptr</span><span class="op" id="1512607">(</span><span class="num" id="1512608">0</span><span class="op" id="1512609">)</span><span class="op" id="1512610">;</span>&nbsp;<span class="ident" id="1512612">i</span>&nbsp;<span class="op" id="1512614">&lt;</span>&nbsp;<span class="ident" id="1512616">bucketCnt</span><span class="op" id="1512625">;</span>&nbsp;<span class="ident" id="1512627">i</span><span class="op" id="1512628">++</span>&nbsp;<span class="op" id="1512631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512636">if</span>&nbsp;<span class="ident" id="1512639">b</span><span class="op" id="1512640">.</span><span class="ident" id="1512641">tophash</span><span class="op" id="1512648">[</span><span class="ident" id="1512649">i</span><span class="op" id="1512650">]</span>&nbsp;<span class="op" id="1512652">!=</span>&nbsp;<span class="ident" id="1512655">top</span>&nbsp;<span class="op" id="1512659">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512665">if</span>&nbsp;<span class="ident" id="1512668">b</span><span class="op" id="1512669">.</span><span class="ident" id="1512670">tophash</span><span class="op" id="1512677">[</span><span class="ident" id="1512678">i</span><span class="op" id="1512679">]</span>&nbsp;<span class="op" id="1512681">==</span>&nbsp;<span class="ident" id="1512684">empty</span>&nbsp;<span class="op" id="1512690">&amp;&amp;</span>&nbsp;<span class="ident" id="1512693">inserti</span>&nbsp;<span class="op" id="1512701">==</span>&nbsp;<span class="builtintype" id="1512704">nil</span>&nbsp;<span class="op" id="1512708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512715">inserti</span>&nbsp;<span class="op" id="1512723">=</span>&nbsp;<span class="op" id="1512725">&amp;</span><span class="ident" id="1512726">b</span><span class="op" id="1512727">.</span><span class="ident" id="1512728">tophash</span><span class="op" id="1512735">[</span><span class="ident" id="1512736">i</span><span class="op" id="1512737">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512744">insertk</span>&nbsp;<span class="op" id="1512752">=</span>&nbsp;<span class="ident" id="1512754">add</span><span class="op" id="1512757">(</span><span class="ident" id="1512758">unsafe</span><span class="op" id="1512764">.</span><span class="ident" id="1512765">Pointer</span><span class="op" id="1512772">(</span><span class="ident" id="1512773">b</span><span class="op" id="1512774">)</span><span class="op" id="1512775">,</span>&nbsp;<span class="ident" id="1512777">dataOffset</span><span class="op" id="1512787">+</span><span class="ident" id="1512788">i</span><span class="op" id="1512789">*</span><span class="builtintype" id="1512790">uintptr</span><span class="op" id="1512797">(</span><span class="ident" id="1512798">t</span><span class="op" id="1512799">.</span><span class="ident" id="1512800">keysize</span><span class="op" id="1512807">)</span><span class="op" id="1512808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512815">insertv</span>&nbsp;<span class="op" id="1512823">=</span>&nbsp;<span class="ident" id="1512825">add</span><span class="op" id="1512828">(</span><span class="ident" id="1512829">unsafe</span><span class="op" id="1512835">.</span><span class="ident" id="1512836">Pointer</span><span class="op" id="1512843">(</span><span class="ident" id="1512844">b</span><span class="op" id="1512845">)</span><span class="op" id="1512846">,</span>&nbsp;<span class="ident" id="1512848">dataOffset</span><span class="op" id="1512858">+</span><span class="ident" id="1512859">bucketCnt</span><span class="op" id="1512868">*</span><span class="builtintype" id="1512869">uintptr</span><span class="op" id="1512876">(</span><span class="ident" id="1512877">t</span><span class="op" id="1512878">.</span><span class="ident" id="1512879">keysize</span><span class="op" id="1512886">)</span><span class="op" id="1512887">+</span><span class="ident" id="1512888">i</span><span class="op" id="1512889">*</span><span class="builtintype" id="1512890">uintptr</span><span class="op" id="1512897">(</span><span class="ident" id="1512898">t</span><span class="op" id="1512899">.</span><span class="ident" id="1512900">valuesize</span><span class="op" id="1512909">)</span><span class="op" id="1512910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512916">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512922">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512939">k</span>&nbsp;<span class="op" id="1512941">:=</span>&nbsp;<span class="ident" id="1512944">add</span><span class="op" id="1512947">(</span><span class="ident" id="1512948">unsafe</span><span class="op" id="1512954">.</span><span class="ident" id="1512955">Pointer</span><span class="op" id="1512962">(</span><span class="ident" id="1512963">b</span><span class="op" id="1512964">)</span><span class="op" id="1512965">,</span>&nbsp;<span class="ident" id="1512967">dataOffset</span><span class="op" id="1512977">+</span><span class="ident" id="1512978">i</span><span class="op" id="1512979">*</span><span class="builtintype" id="1512980">uintptr</span><span class="op" id="1512987">(</span><span class="ident" id="1512988">t</span><span class="op" id="1512989">.</span><span class="ident" id="1512990">keysize</span><span class="op" id="1512997">)</span><span class="op" id="1512998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513003">k2</span>&nbsp;<span class="op" id="1513006">:=</span>&nbsp;<span class="ident" id="1513009">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513014">if</span>&nbsp;<span class="ident" id="1513017">t</span><span class="op" id="1513018">.</span><span class="ident" id="1513019">indirectkey</span>&nbsp;<span class="op" id="1513031">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513037">k2</span>&nbsp;<span class="op" id="1513040">=</span>&nbsp;<span class="op" id="1513042">*</span><span class="op" id="1513043">(</span><span class="op" id="1513044">(</span><span class="op" id="1513045">*</span><span class="ident" id="1513046">unsafe</span><span class="op" id="1513052">.</span><span class="ident" id="1513053">Pointer</span><span class="op" id="1513060">)</span><span class="op" id="1513061">(</span><span class="ident" id="1513062">k2</span><span class="op" id="1513064">)</span><span class="op" id="1513065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513075">if</span>&nbsp;<span class="op" id="1513078">!</span><span class="ident" id="1513079">alg</span><span class="op" id="1513082">.</span><span class="ident" id="1513083">equal</span><span class="op" id="1513088">(</span><span class="ident" id="1513089">key</span><span class="op" id="1513092">,</span>&nbsp;<span class="ident" id="1513094">k2</span><span class="op" id="1513096">,</span>&nbsp;<span class="builtintype" id="1513098">uintptr</span><span class="op" id="1513105">(</span><span class="ident" id="1513106">t</span><span class="op" id="1513107">.</span><span class="ident" id="1513108">key</span><span class="op" id="1513111">.</span><span class="ident" id="1513112">size</span><span class="op" id="1513116">)</span><span class="op" id="1513117">)</span>&nbsp;<span class="op" id="1513119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513125">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513137">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513142">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513192">memmove</span><span class="op" id="1513199">(</span><span class="ident" id="1513200">k2</span><span class="op" id="1513202">,</span>&nbsp;<span class="ident" id="1513204">key</span><span class="op" id="1513207">,</span>&nbsp;<span class="builtintype" id="1513209">uintptr</span><span class="op" id="1513216">(</span><span class="ident" id="1513217">t</span><span class="op" id="1513218">.</span><span class="ident" id="1513219">key</span><span class="op" id="1513222">.</span><span class="ident" id="1513223">size</span><span class="op" id="1513227">)</span><span class="op" id="1513228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513233">v</span>&nbsp;<span class="op" id="1513235">:=</span>&nbsp;<span class="ident" id="1513238">add</span><span class="op" id="1513241">(</span><span class="ident" id="1513242">unsafe</span><span class="op" id="1513248">.</span><span class="ident" id="1513249">Pointer</span><span class="op" id="1513256">(</span><span class="ident" id="1513257">b</span><span class="op" id="1513258">)</span><span class="op" id="1513259">,</span>&nbsp;<span class="ident" id="1513261">dataOffset</span><span class="op" id="1513271">+</span><span class="ident" id="1513272">bucketCnt</span><span class="op" id="1513281">*</span><span class="builtintype" id="1513282">uintptr</span><span class="op" id="1513289">(</span><span class="ident" id="1513290">t</span><span class="op" id="1513291">.</span><span class="ident" id="1513292">keysize</span><span class="op" id="1513299">)</span><span class="op" id="1513300">+</span><span class="ident" id="1513301">i</span><span class="op" id="1513302">*</span><span class="builtintype" id="1513303">uintptr</span><span class="op" id="1513310">(</span><span class="ident" id="1513311">t</span><span class="op" id="1513312">.</span><span class="ident" id="1513313">valuesize</span><span class="op" id="1513322">)</span><span class="op" id="1513323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513328">v2</span>&nbsp;<span class="op" id="1513331">:=</span>&nbsp;<span class="ident" id="1513334">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513339">if</span>&nbsp;<span class="ident" id="1513342">t</span><span class="op" id="1513343">.</span><span class="ident" id="1513344">indirectvalue</span>&nbsp;<span class="op" id="1513358">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513364">v2</span>&nbsp;<span class="op" id="1513367">=</span>&nbsp;<span class="op" id="1513369">*</span><span class="op" id="1513370">(</span><span class="op" id="1513371">(</span><span class="op" id="1513372">*</span><span class="ident" id="1513373">unsafe</span><span class="op" id="1513379">.</span><span class="ident" id="1513380">Pointer</span><span class="op" id="1513387">)</span><span class="op" id="1513388">(</span><span class="ident" id="1513389">v2</span><span class="op" id="1513391">)</span><span class="op" id="1513392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513402">memmove</span><span class="op" id="1513409">(</span><span class="ident" id="1513410">v2</span><span class="op" id="1513412">,</span>&nbsp;<span class="ident" id="1513414">val</span><span class="op" id="1513417">,</span>&nbsp;<span class="builtintype" id="1513419">uintptr</span><span class="op" id="1513426">(</span><span class="ident" id="1513427">t</span><span class="op" id="1513428">.</span><span class="ident" id="1513429">elem</span><span class="op" id="1513433">.</span><span class="ident" id="1513434">size</span><span class="op" id="1513438">)</span><span class="op" id="1513439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513444">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513453">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513457">if</span>&nbsp;<span class="ident" id="1513460">b</span><span class="op" id="1513461">.</span><span class="ident" id="1513462">overflow</span>&nbsp;<span class="op" id="1513471">==</span>&nbsp;<span class="builtintype" id="1513474">nil</span>&nbsp;<span class="op" id="1513478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513483">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513495">b</span>&nbsp;<span class="op" id="1513497">=</span>&nbsp;<span class="ident" id="1513499">b</span><span class="op" id="1513500">.</span><span class="ident" id="1513501">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513511">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513515">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513581">if</span>&nbsp;<span class="builtintype" id="1513584">float32</span><span class="op" id="1513591">(</span><span class="ident" id="1513592">h</span><span class="op" id="1513593">.</span><span class="ident" id="1513594">count</span><span class="op" id="1513599">)</span>&nbsp;<span class="op" id="1513601">&gt;=</span>&nbsp;<span class="ident" id="1513604">loadFactor</span><span class="op" id="1513614">*</span><span class="builtintype" id="1513615">float32</span><span class="op" id="1513622">(</span><span class="op" id="1513623">(</span><span class="builtintype" id="1513624">uintptr</span><span class="op" id="1513631">(</span><span class="num" id="1513632">1</span><span class="op" id="1513633">)</span><span class="op" id="1513634">&lt;&lt;</span><span class="ident" id="1513636">h</span><span class="op" id="1513637">.</span><span class="ident" id="1513638">B</span><span class="op" id="1513639">)</span><span class="op" id="1513640">)</span>&nbsp;<span class="op" id="1513642">&amp;&amp;</span>&nbsp;<span class="ident" id="1513645">h</span><span class="op" id="1513646">.</span><span class="ident" id="1513647">count</span>&nbsp;<span class="op" id="1513653">&gt;=</span>&nbsp;<span class="ident" id="1513656">bucketCnt</span>&nbsp;<span class="op" id="1513666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513670">hashGrow</span><span class="op" id="1513678">(</span><span class="ident" id="1513679">t</span><span class="op" id="1513680">,</span>&nbsp;<span class="ident" id="1513682">h</span><span class="op" id="1513683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513687">goto</span>&nbsp;<span class="ident" id="1513692">again</span>&nbsp;<span class="comment" id="1513698">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513761">if</span>&nbsp;<span class="ident" id="1513764">inserti</span>&nbsp;<span class="op" id="1513772">==</span>&nbsp;<span class="builtintype" id="1513775">nil</span>&nbsp;<span class="op" id="1513779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513783">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513838">if</span>&nbsp;<span class="ident" id="1513841">checkgc</span>&nbsp;<span class="op" id="1513849">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513854">memstats</span><span class="op" id="1513862">.</span><span class="ident" id="1513863">next_gc</span>&nbsp;<span class="op" id="1513871">=</span>&nbsp;<span class="ident" id="1513873">memstats</span><span class="op" id="1513881">.</span><span class="ident" id="1513882">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513899">newb</span>&nbsp;<span class="op" id="1513904">:=</span>&nbsp;<span class="op" id="1513907">(</span><span class="op" id="1513908">*</span><span class="ident" id="1513909">bmap</span><span class="op" id="1513913">)</span><span class="op" id="1513914">(</span><span class="ident" id="1513915">newobject</span><span class="op" id="1513924">(</span><span class="ident" id="1513925">t</span><span class="op" id="1513926">.</span><span class="ident" id="1513927">bucket</span><span class="op" id="1513933">)</span><span class="op" id="1513934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513938">b</span><span class="op" id="1513939">.</span><span class="ident" id="1513940">overflow</span>&nbsp;<span class="op" id="1513949">=</span>&nbsp;<span class="ident" id="1513951">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513958">inserti</span>&nbsp;<span class="op" id="1513966">=</span>&nbsp;<span class="op" id="1513968">&amp;</span><span class="ident" id="1513969">newb</span><span class="op" id="1513973">.</span><span class="ident" id="1513974">tophash</span><span class="op" id="1513981">[</span><span class="num" id="1513982">0</span><span class="op" id="1513983">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513987">insertk</span>&nbsp;<span class="op" id="1513995">=</span>&nbsp;<span class="ident" id="1513997">add</span><span class="op" id="1514000">(</span><span class="ident" id="1514001">unsafe</span><span class="op" id="1514007">.</span><span class="ident" id="1514008">Pointer</span><span class="op" id="1514015">(</span><span class="ident" id="1514016">newb</span><span class="op" id="1514020">)</span><span class="op" id="1514021">,</span>&nbsp;<span class="ident" id="1514023">dataOffset</span><span class="op" id="1514033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514037">insertv</span>&nbsp;<span class="op" id="1514045">=</span>&nbsp;<span class="ident" id="1514047">add</span><span class="op" id="1514050">(</span><span class="ident" id="1514051">insertk</span><span class="op" id="1514058">,</span>&nbsp;<span class="ident" id="1514060">bucketCnt</span><span class="op" id="1514069">*</span><span class="builtintype" id="1514070">uintptr</span><span class="op" id="1514077">(</span><span class="ident" id="1514078">t</span><span class="op" id="1514079">.</span><span class="ident" id="1514080">keysize</span><span class="op" id="1514087">)</span><span class="op" id="1514088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514095">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514138">if</span>&nbsp;<span class="ident" id="1514141">t</span><span class="op" id="1514142">.</span><span class="ident" id="1514143">indirectkey</span>&nbsp;<span class="op" id="1514155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514159">if</span>&nbsp;<span class="ident" id="1514162">checkgc</span>&nbsp;<span class="op" id="1514170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514175">memstats</span><span class="op" id="1514183">.</span><span class="ident" id="1514184">next_gc</span>&nbsp;<span class="op" id="1514192">=</span>&nbsp;<span class="ident" id="1514194">memstats</span><span class="op" id="1514202">.</span><span class="ident" id="1514203">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514220">kmem</span>&nbsp;<span class="op" id="1514225">:=</span>&nbsp;<span class="ident" id="1514228">newobject</span><span class="op" id="1514237">(</span><span class="ident" id="1514238">t</span><span class="op" id="1514239">.</span><span class="ident" id="1514240">key</span><span class="op" id="1514243">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514247">*</span><span class="op" id="1514248">(</span><span class="op" id="1514249">*</span><span class="ident" id="1514250">unsafe</span><span class="op" id="1514256">.</span><span class="ident" id="1514257">Pointer</span><span class="op" id="1514264">)</span><span class="op" id="1514265">(</span><span class="ident" id="1514266">insertk</span><span class="op" id="1514273">)</span>&nbsp;<span class="op" id="1514275">=</span>&nbsp;<span class="ident" id="1514277">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514284">insertk</span>&nbsp;<span class="op" id="1514292">=</span>&nbsp;<span class="ident" id="1514294">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514303">if</span>&nbsp;<span class="ident" id="1514306">t</span><span class="op" id="1514307">.</span><span class="ident" id="1514308">indirectvalue</span>&nbsp;<span class="op" id="1514322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514326">if</span>&nbsp;<span class="ident" id="1514329">checkgc</span>&nbsp;<span class="op" id="1514337">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514342">memstats</span><span class="op" id="1514350">.</span><span class="ident" id="1514351">next_gc</span>&nbsp;<span class="op" id="1514359">=</span>&nbsp;<span class="ident" id="1514361">memstats</span><span class="op" id="1514369">.</span><span class="ident" id="1514370">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514387">vmem</span>&nbsp;<span class="op" id="1514392">:=</span>&nbsp;<span class="ident" id="1514395">newobject</span><span class="op" id="1514404">(</span><span class="ident" id="1514405">t</span><span class="op" id="1514406">.</span><span class="ident" id="1514407">elem</span><span class="op" id="1514411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514415">*</span><span class="op" id="1514416">(</span><span class="op" id="1514417">*</span><span class="ident" id="1514418">unsafe</span><span class="op" id="1514424">.</span><span class="ident" id="1514425">Pointer</span><span class="op" id="1514432">)</span><span class="op" id="1514433">(</span><span class="ident" id="1514434">insertv</span><span class="op" id="1514441">)</span>&nbsp;<span class="op" id="1514443">=</span>&nbsp;<span class="ident" id="1514445">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514452">insertv</span>&nbsp;<span class="op" id="1514460">=</span>&nbsp;<span class="ident" id="1514462">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514471">memmove</span><span class="op" id="1514478">(</span><span class="ident" id="1514479">insertk</span><span class="op" id="1514486">,</span>&nbsp;<span class="ident" id="1514488">key</span><span class="op" id="1514491">,</span>&nbsp;<span class="builtintype" id="1514493">uintptr</span><span class="op" id="1514500">(</span><span class="ident" id="1514501">t</span><span class="op" id="1514502">.</span><span class="ident" id="1514503">key</span><span class="op" id="1514506">.</span><span class="ident" id="1514507">size</span><span class="op" id="1514511">)</span><span class="op" id="1514512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514515">memmove</span><span class="op" id="1514522">(</span><span class="ident" id="1514523">insertv</span><span class="op" id="1514530">,</span>&nbsp;<span class="ident" id="1514532">val</span><span class="op" id="1514535">,</span>&nbsp;<span class="builtintype" id="1514537">uintptr</span><span class="op" id="1514544">(</span><span class="ident" id="1514545">t</span><span class="op" id="1514546">.</span><span class="ident" id="1514547">elem</span><span class="op" id="1514551">.</span><span class="ident" id="1514552">size</span><span class="op" id="1514556">)</span><span class="op" id="1514557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514560">*</span><span class="ident" id="1514561">inserti</span>&nbsp;<span class="op" id="1514569">=</span>&nbsp;<span class="ident" id="1514571">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514576">h</span><span class="op" id="1514577">.</span><span class="ident" id="1514578">count</span><span class="op" id="1514583">++</span><br>
<span class="lineno">485</span><span class="op" id="1514586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1514589">func</span>&nbsp;<span class="ident" id="1514594">mapdelete</span><span class="op" id="1514603">(</span><span class="ident" id="1514604">t</span>&nbsp;<span class="op" id="1514606">*</span><span class="ident" id="1514607">maptype</span><span class="op" id="1514614">,</span>&nbsp;<span class="ident" id="1514616">h</span>&nbsp;<span class="op" id="1514618">*</span><span class="ident" id="1514619">hmap</span><span class="op" id="1514623">,</span>&nbsp;<span class="ident" id="1514625">key</span>&nbsp;<span class="ident" id="1514629">unsafe</span><span class="op" id="1514635">.</span><span class="ident" id="1514636">Pointer</span><span class="op" id="1514643">)</span>&nbsp;<span class="op" id="1514645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514648">if</span>&nbsp;<span class="ident" id="1514651">raceenabled</span>&nbsp;<span class="op" id="1514663">&amp;&amp;</span>&nbsp;<span class="ident" id="1514666">h</span>&nbsp;<span class="op" id="1514668">!=</span>&nbsp;<span class="builtintype" id="1514671">nil</span>&nbsp;<span class="op" id="1514675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514679">callerpc</span>&nbsp;<span class="op" id="1514688">:=</span>&nbsp;<span class="ident" id="1514691">getcallerpc</span><span class="op" id="1514702">(</span><span class="ident" id="1514703">unsafe</span><span class="op" id="1514709">.</span><span class="ident" id="1514710">Pointer</span><span class="op" id="1514717">(</span><span class="op" id="1514718">&amp;</span><span class="ident" id="1514719">t</span><span class="op" id="1514720">)</span><span class="op" id="1514721">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514725">pc</span>&nbsp;<span class="op" id="1514728">:=</span>&nbsp;<span class="ident" id="1514731">funcPC</span><span class="op" id="1514737">(</span><span class="ident" id="1514738">mapdelete</span><span class="op" id="1514747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514751">racewritepc</span><span class="op" id="1514762">(</span><span class="ident" id="1514763">unsafe</span><span class="op" id="1514769">.</span><span class="ident" id="1514770">Pointer</span><span class="op" id="1514777">(</span><span class="ident" id="1514778">h</span><span class="op" id="1514779">)</span><span class="op" id="1514780">,</span>&nbsp;<span class="ident" id="1514782">callerpc</span><span class="op" id="1514790">,</span>&nbsp;<span class="ident" id="1514792">pc</span><span class="op" id="1514794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514798">raceReadObjectPC</span><span class="op" id="1514814">(</span><span class="ident" id="1514815">t</span><span class="op" id="1514816">.</span><span class="ident" id="1514817">key</span><span class="op" id="1514820">,</span>&nbsp;<span class="ident" id="1514822">key</span><span class="op" id="1514825">,</span>&nbsp;<span class="ident" id="1514827">callerpc</span><span class="op" id="1514835">,</span>&nbsp;<span class="ident" id="1514837">pc</span><span class="op" id="1514839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514845">if</span>&nbsp;<span class="ident" id="1514848">h</span>&nbsp;<span class="op" id="1514850">==</span>&nbsp;<span class="builtintype" id="1514853">nil</span>&nbsp;<span class="op" id="1514857">||</span>&nbsp;<span class="ident" id="1514860">h</span><span class="op" id="1514861">.</span><span class="ident" id="1514862">count</span>&nbsp;<span class="op" id="1514868">==</span>&nbsp;<span class="num" id="1514871">0</span>&nbsp;<span class="op" id="1514873">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514877">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514888">alg</span>&nbsp;<span class="op" id="1514892">:=</span>&nbsp;<span class="ident" id="1514895">goalg</span><span class="op" id="1514900">(</span><span class="ident" id="1514901">t</span><span class="op" id="1514902">.</span><span class="ident" id="1514903">key</span><span class="op" id="1514906">.</span><span class="ident" id="1514907">alg</span><span class="op" id="1514910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514913">hash</span>&nbsp;<span class="op" id="1514918">:=</span>&nbsp;<span class="ident" id="1514921">alg</span><span class="op" id="1514924">.</span><span class="ident" id="1514925">hash</span><span class="op" id="1514929">(</span><span class="ident" id="1514930">key</span><span class="op" id="1514933">,</span>&nbsp;<span class="builtintype" id="1514935">uintptr</span><span class="op" id="1514942">(</span><span class="ident" id="1514943">t</span><span class="op" id="1514944">.</span><span class="ident" id="1514945">key</span><span class="op" id="1514948">.</span><span class="ident" id="1514949">size</span><span class="op" id="1514953">)</span><span class="op" id="1514954">,</span>&nbsp;<span class="builtintype" id="1514956">uintptr</span><span class="op" id="1514963">(</span><span class="ident" id="1514964">h</span><span class="op" id="1514965">.</span><span class="ident" id="1514966">hash0</span><span class="op" id="1514971">)</span><span class="op" id="1514972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514975">bucket</span>&nbsp;<span class="op" id="1514982">:=</span>&nbsp;<span class="ident" id="1514985">hash</span>&nbsp;<span class="op" id="1514990">&amp;</span>&nbsp;<span class="op" id="1514992">(</span><span class="builtintype" id="1514993">uintptr</span><span class="op" id="1515000">(</span><span class="num" id="1515001">1</span><span class="op" id="1515002">)</span><span class="op" id="1515003">&lt;&lt;</span><span class="ident" id="1515005">h</span><span class="op" id="1515006">.</span><span class="ident" id="1515007">B</span>&nbsp;<span class="op" id="1515009">-</span>&nbsp;<span class="num" id="1515011">1</span><span class="op" id="1515012">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515015">if</span>&nbsp;<span class="ident" id="1515018">h</span><span class="op" id="1515019">.</span><span class="ident" id="1515020">oldbuckets</span>&nbsp;<span class="op" id="1515031">!=</span>&nbsp;<span class="builtintype" id="1515034">nil</span>&nbsp;<span class="op" id="1515038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515042">growWork</span><span class="op" id="1515050">(</span><span class="ident" id="1515051">t</span><span class="op" id="1515052">,</span>&nbsp;<span class="ident" id="1515054">h</span><span class="op" id="1515055">,</span>&nbsp;<span class="ident" id="1515057">bucket</span><span class="op" id="1515063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515069">b</span>&nbsp;<span class="op" id="1515071">:=</span>&nbsp;<span class="op" id="1515074">(</span><span class="op" id="1515075">*</span><span class="ident" id="1515076">bmap</span><span class="op" id="1515080">)</span><span class="op" id="1515081">(</span><span class="ident" id="1515082">unsafe</span><span class="op" id="1515088">.</span><span class="ident" id="1515089">Pointer</span><span class="op" id="1515096">(</span><span class="builtintype" id="1515097">uintptr</span><span class="op" id="1515104">(</span><span class="ident" id="1515105">h</span><span class="op" id="1515106">.</span><span class="ident" id="1515107">buckets</span><span class="op" id="1515114">)</span>&nbsp;<span class="op" id="1515116">+</span>&nbsp;<span class="ident" id="1515118">bucket</span><span class="op" id="1515124">*</span><span class="builtintype" id="1515125">uintptr</span><span class="op" id="1515132">(</span><span class="ident" id="1515133">t</span><span class="op" id="1515134">.</span><span class="ident" id="1515135">bucketsize</span><span class="op" id="1515145">)</span><span class="op" id="1515146">)</span><span class="op" id="1515147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515150">top</span>&nbsp;<span class="op" id="1515154">:=</span>&nbsp;<span class="builtintype" id="1515157">uint8</span><span class="op" id="1515162">(</span><span class="ident" id="1515163">hash</span>&nbsp;<span class="op" id="1515168">&gt;&gt;</span>&nbsp;<span class="op" id="1515171">(</span><span class="ident" id="1515172">ptrSize</span><span class="op" id="1515179">*</span><span class="num" id="1515180">8</span>&nbsp;<span class="op" id="1515182">-</span>&nbsp;<span class="num" id="1515184">8</span><span class="op" id="1515185">)</span><span class="op" id="1515186">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515189">if</span>&nbsp;<span class="ident" id="1515192">top</span>&nbsp;<span class="op" id="1515196">&lt;</span>&nbsp;<span class="ident" id="1515198">minTopHash</span>&nbsp;<span class="op" id="1515209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515213">top</span>&nbsp;<span class="op" id="1515217">+=</span>&nbsp;<span class="ident" id="1515220">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515235">for</span>&nbsp;<span class="op" id="1515239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515243">for</span>&nbsp;<span class="ident" id="1515247">i</span>&nbsp;<span class="op" id="1515249">:=</span>&nbsp;<span class="builtintype" id="1515252">uintptr</span><span class="op" id="1515259">(</span><span class="num" id="1515260">0</span><span class="op" id="1515261">)</span><span class="op" id="1515262">;</span>&nbsp;<span class="ident" id="1515264">i</span>&nbsp;<span class="op" id="1515266">&lt;</span>&nbsp;<span class="ident" id="1515268">bucketCnt</span><span class="op" id="1515277">;</span>&nbsp;<span class="ident" id="1515279">i</span><span class="op" id="1515280">++</span>&nbsp;<span class="op" id="1515283">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515288">if</span>&nbsp;<span class="ident" id="1515291">b</span><span class="op" id="1515292">.</span><span class="ident" id="1515293">tophash</span><span class="op" id="1515300">[</span><span class="ident" id="1515301">i</span><span class="op" id="1515302">]</span>&nbsp;<span class="op" id="1515304">!=</span>&nbsp;<span class="ident" id="1515307">top</span>&nbsp;<span class="op" id="1515311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515317">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515334">k</span>&nbsp;<span class="op" id="1515336">:=</span>&nbsp;<span class="ident" id="1515339">add</span><span class="op" id="1515342">(</span><span class="ident" id="1515343">unsafe</span><span class="op" id="1515349">.</span><span class="ident" id="1515350">Pointer</span><span class="op" id="1515357">(</span><span class="ident" id="1515358">b</span><span class="op" id="1515359">)</span><span class="op" id="1515360">,</span>&nbsp;<span class="ident" id="1515362">dataOffset</span><span class="op" id="1515372">+</span><span class="ident" id="1515373">i</span><span class="op" id="1515374">*</span><span class="builtintype" id="1515375">uintptr</span><span class="op" id="1515382">(</span><span class="ident" id="1515383">t</span><span class="op" id="1515384">.</span><span class="ident" id="1515385">keysize</span><span class="op" id="1515392">)</span><span class="op" id="1515393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515398">k2</span>&nbsp;<span class="op" id="1515401">:=</span>&nbsp;<span class="ident" id="1515404">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515409">if</span>&nbsp;<span class="ident" id="1515412">t</span><span class="op" id="1515413">.</span><span class="ident" id="1515414">indirectkey</span>&nbsp;<span class="op" id="1515426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515432">k2</span>&nbsp;<span class="op" id="1515435">=</span>&nbsp;<span class="op" id="1515437">*</span><span class="op" id="1515438">(</span><span class="op" id="1515439">(</span><span class="op" id="1515440">*</span><span class="ident" id="1515441">unsafe</span><span class="op" id="1515447">.</span><span class="ident" id="1515448">Pointer</span><span class="op" id="1515455">)</span><span class="op" id="1515456">(</span><span class="ident" id="1515457">k2</span><span class="op" id="1515459">)</span><span class="op" id="1515460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515470">if</span>&nbsp;<span class="op" id="1515473">!</span><span class="ident" id="1515474">alg</span><span class="op" id="1515477">.</span><span class="ident" id="1515478">equal</span><span class="op" id="1515483">(</span><span class="ident" id="1515484">key</span><span class="op" id="1515487">,</span>&nbsp;<span class="ident" id="1515489">k2</span><span class="op" id="1515491">,</span>&nbsp;<span class="builtintype" id="1515493">uintptr</span><span class="op" id="1515500">(</span><span class="ident" id="1515501">t</span><span class="op" id="1515502">.</span><span class="ident" id="1515503">key</span><span class="op" id="1515506">.</span><span class="ident" id="1515507">size</span><span class="op" id="1515511">)</span><span class="op" id="1515512">)</span>&nbsp;<span class="op" id="1515514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515520">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515537">memclr</span><span class="op" id="1515543">(</span><span class="ident" id="1515544">k</span><span class="op" id="1515545">,</span>&nbsp;<span class="builtintype" id="1515547">uintptr</span><span class="op" id="1515554">(</span><span class="ident" id="1515555">t</span><span class="op" id="1515556">.</span><span class="ident" id="1515557">keysize</span><span class="op" id="1515564">)</span><span class="op" id="1515565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515570">v</span>&nbsp;<span class="op" id="1515572">:=</span>&nbsp;<span class="ident" id="1515575">unsafe</span><span class="op" id="1515581">.</span><span class="ident" id="1515582">Pointer</span><span class="op" id="1515589">(</span><span class="builtintype" id="1515590">uintptr</span><span class="op" id="1515597">(</span><span class="ident" id="1515598">unsafe</span><span class="op" id="1515604">.</span><span class="ident" id="1515605">Pointer</span><span class="op" id="1515612">(</span><span class="ident" id="1515613">b</span><span class="op" id="1515614">)</span><span class="op" id="1515615">)</span>&nbsp;<span class="op" id="1515617">+</span>&nbsp;<span class="ident" id="1515619">dataOffset</span>&nbsp;<span class="op" id="1515630">+</span>&nbsp;<span class="ident" id="1515632">bucketCnt</span><span class="op" id="1515641">*</span><span class="builtintype" id="1515642">uintptr</span><span class="op" id="1515649">(</span><span class="ident" id="1515650">t</span><span class="op" id="1515651">.</span><span class="ident" id="1515652">keysize</span><span class="op" id="1515659">)</span>&nbsp;<span class="op" id="1515661">+</span>&nbsp;<span class="ident" id="1515663">i</span><span class="op" id="1515664">*</span><span class="builtintype" id="1515665">uintptr</span><span class="op" id="1515672">(</span><span class="ident" id="1515673">t</span><span class="op" id="1515674">.</span><span class="ident" id="1515675">valuesize</span><span class="op" id="1515684">)</span><span class="op" id="1515685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515690">memclr</span><span class="op" id="1515696">(</span><span class="ident" id="1515697">v</span><span class="op" id="1515698">,</span>&nbsp;<span class="builtintype" id="1515700">uintptr</span><span class="op" id="1515707">(</span><span class="ident" id="1515708">t</span><span class="op" id="1515709">.</span><span class="ident" id="1515710">valuesize</span><span class="op" id="1515719">)</span><span class="op" id="1515720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515725">b</span><span class="op" id="1515726">.</span><span class="ident" id="1515727">tophash</span><span class="op" id="1515734">[</span><span class="ident" id="1515735">i</span><span class="op" id="1515736">]</span>&nbsp;<span class="op" id="1515738">=</span>&nbsp;<span class="ident" id="1515740">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515749">h</span><span class="op" id="1515750">.</span><span class="ident" id="1515751">count</span><span class="op" id="1515756">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515762">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515775">b</span>&nbsp;<span class="op" id="1515777">=</span>&nbsp;<span class="ident" id="1515779">b</span><span class="op" id="1515780">.</span><span class="ident" id="1515781">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515792">if</span>&nbsp;<span class="ident" id="1515795">b</span>&nbsp;<span class="op" id="1515797">==</span>&nbsp;<span class="builtintype" id="1515800">nil</span>&nbsp;<span class="op" id="1515804">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515809">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515821">}</span><br>
<span class="lineno"></span><span class="op" id="1515823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1515826">func</span>&nbsp;<span class="ident" id="1515831">mapiterinit</span><span class="op" id="1515842">(</span><span class="ident" id="1515843">t</span>&nbsp;<span class="op" id="1515845">*</span><span class="ident" id="1515846">maptype</span><span class="op" id="1515853">,</span>&nbsp;<span class="ident" id="1515855">h</span>&nbsp;<span class="op" id="1515857">*</span><span class="ident" id="1515858">hmap</span><span class="op" id="1515862">,</span>&nbsp;<span class="ident" id="1515864">it</span>&nbsp;<span class="op" id="1515867">*</span><span class="ident" id="1515868">hiter</span><span class="op" id="1515873">)</span>&nbsp;<span class="op" id="1515875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1515878">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515943">it</span><span class="op" id="1515945">.</span><span class="ident" id="1515946">key</span>&nbsp;<span class="op" id="1515950">=</span>&nbsp;<span class="builtintype" id="1515952">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515957">it</span><span class="op" id="1515959">.</span><span class="ident" id="1515960">value</span>&nbsp;<span class="op" id="1515966">=</span>&nbsp;<span class="builtintype" id="1515968">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515973">it</span><span class="op" id="1515975">.</span><span class="ident" id="1515976">t</span>&nbsp;<span class="op" id="1515978">=</span>&nbsp;<span class="builtintype" id="1515980">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515985">it</span><span class="op" id="1515987">.</span><span class="ident" id="1515988">h</span>&nbsp;<span class="op" id="1515990">=</span>&nbsp;<span class="builtintype" id="1515992">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515997">it</span><span class="op" id="1515999">.</span><span class="ident" id="1516000">buckets</span>&nbsp;<span class="op" id="1516008">=</span>&nbsp;<span class="builtintype" id="1516010">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516015">it</span><span class="op" id="1516017">.</span><span class="ident" id="1516018">bptr</span>&nbsp;<span class="op" id="1516023">=</span>&nbsp;<span class="builtintype" id="1516025">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516031">if</span>&nbsp;<span class="ident" id="1516034">raceenabled</span>&nbsp;<span class="op" id="1516046">&amp;&amp;</span>&nbsp;<span class="ident" id="1516049">h</span>&nbsp;<span class="op" id="1516051">!=</span>&nbsp;<span class="builtintype" id="1516054">nil</span>&nbsp;<span class="op" id="1516058">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516062">callerpc</span>&nbsp;<span class="op" id="1516071">:=</span>&nbsp;<span class="ident" id="1516074">getcallerpc</span><span class="op" id="1516085">(</span><span class="ident" id="1516086">unsafe</span><span class="op" id="1516092">.</span><span class="ident" id="1516093">Pointer</span><span class="op" id="1516100">(</span><span class="op" id="1516101">&amp;</span><span class="ident" id="1516102">t</span><span class="op" id="1516103">)</span><span class="op" id="1516104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516108">racereadpc</span><span class="op" id="1516118">(</span><span class="ident" id="1516119">unsafe</span><span class="op" id="1516125">.</span><span class="ident" id="1516126">Pointer</span><span class="op" id="1516133">(</span><span class="ident" id="1516134">h</span><span class="op" id="1516135">)</span><span class="op" id="1516136">,</span>&nbsp;<span class="ident" id="1516138">callerpc</span><span class="op" id="1516146">,</span>&nbsp;<span class="ident" id="1516148">funcPC</span><span class="op" id="1516154">(</span><span class="ident" id="1516155">mapiterinit</span><span class="op" id="1516166">)</span><span class="op" id="1516167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1516170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516174">if</span>&nbsp;<span class="ident" id="1516177">h</span>&nbsp;<span class="op" id="1516179">==</span>&nbsp;<span class="builtintype" id="1516182">nil</span>&nbsp;<span class="op" id="1516186">||</span>&nbsp;<span class="ident" id="1516189">h</span><span class="op" id="1516190">.</span><span class="ident" id="1516191">count</span>&nbsp;<span class="op" id="1516197">==</span>&nbsp;<span class="num" id="1516200">0</span>&nbsp;<span class="op" id="1516202">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516206">it</span><span class="op" id="1516208">.</span><span class="ident" id="1516209">key</span>&nbsp;<span class="op" id="1516213">=</span>&nbsp;<span class="builtintype" id="1516215">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516221">it</span><span class="op" id="1516223">.</span><span class="ident" id="1516224">value</span>&nbsp;<span class="op" id="1516230">=</span>&nbsp;<span class="builtintype" id="1516232">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516238">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1516246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516250">if</span>&nbsp;<span class="ident" id="1516253">unsafe</span><span class="op" id="1516259">.</span><span class="ident" id="1516260">Sizeof</span><span class="op" id="1516266">(</span><span class="ident" id="1516267">hiter</span><span class="op" id="1516272">{</span><span class="op" id="1516273">}</span><span class="op" id="1516274">)</span><span class="op" id="1516275">/</span><span class="ident" id="1516276">ptrSize</span>&nbsp;<span class="op" id="1516284">!=</span>&nbsp;<span class="num" id="1516287">10</span>&nbsp;<span class="op" id="1516290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516294">gothrow</span><span class="op" id="1516301">(</span><span class="string" id="1516302">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1516328">)</span>&nbsp;<span class="comment" id="1516330">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1516361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516364">it</span><span class="op" id="1516366">.</span><span class="ident" id="1516367">t</span>&nbsp;<span class="op" id="1516369">=</span>&nbsp;<span class="ident" id="1516371">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516374">it</span><span class="op" id="1516376">.</span><span class="ident" id="1516377">h</span>&nbsp;<span class="op" id="1516379">=</span>&nbsp;<span class="ident" id="1516381">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516385">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516419">it</span><span class="op" id="1516421">.</span><span class="ident" id="1516422">B</span>&nbsp;<span class="op" id="1516424">=</span>&nbsp;<span class="ident" id="1516426">h</span><span class="op" id="1516427">.</span><span class="ident" id="1516428">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516431">it</span><span class="op" id="1516433">.</span><span class="ident" id="1516434">buckets</span>&nbsp;<span class="op" id="1516442">=</span>&nbsp;<span class="ident" id="1516444">h</span><span class="op" id="1516445">.</span><span class="ident" id="1516446">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516456">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516482">r</span>&nbsp;<span class="op" id="1516484">:=</span>&nbsp;<span class="builtintype" id="1516487">uintptr</span><span class="op" id="1516494">(</span><span class="ident" id="1516495">fastrand1</span><span class="op" id="1516504">(</span><span class="op" id="1516505">)</span><span class="op" id="1516506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516509">if</span>&nbsp;<span class="ident" id="1516512">h</span><span class="op" id="1516513">.</span><span class="ident" id="1516514">B</span>&nbsp;<span class="op" id="1516516">&gt;</span>&nbsp;<span class="num" id="1516518">31</span><span class="op" id="1516520">-</span><span class="ident" id="1516521">bucketCntBits</span>&nbsp;<span class="op" id="1516535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516539">r</span>&nbsp;<span class="op" id="1516541">+=</span>&nbsp;<span class="builtintype" id="1516544">uintptr</span><span class="op" id="1516551">(</span><span class="ident" id="1516552">fastrand1</span><span class="op" id="1516561">(</span><span class="op" id="1516562">)</span><span class="op" id="1516563">)</span>&nbsp;<span class="op" id="1516565">&lt;&lt;</span>&nbsp;<span class="num" id="1516568">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1516572">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516575">it</span><span class="op" id="1516577">.</span><span class="ident" id="1516578">startBucket</span>&nbsp;<span class="op" id="1516590">=</span>&nbsp;<span class="ident" id="1516592">r</span>&nbsp;<span class="op" id="1516594">&amp;</span>&nbsp;<span class="op" id="1516596">(</span><span class="builtintype" id="1516597">uintptr</span><span class="op" id="1516604">(</span><span class="num" id="1516605">1</span><span class="op" id="1516606">)</span><span class="op" id="1516607">&lt;&lt;</span><span class="ident" id="1516609">h</span><span class="op" id="1516610">.</span><span class="ident" id="1516611">B</span>&nbsp;<span class="op" id="1516613">-</span>&nbsp;<span class="num" id="1516615">1</span><span class="op" id="1516616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516619">it</span><span class="op" id="1516621">.</span><span class="ident" id="1516622">offset</span>&nbsp;<span class="op" id="1516629">=</span>&nbsp;<span class="builtintype" id="1516631">uint8</span><span class="op" id="1516636">(</span><span class="ident" id="1516637">r</span>&nbsp;<span class="op" id="1516639">&gt;&gt;</span>&nbsp;<span class="ident" id="1516642">h</span><span class="op" id="1516643">.</span><span class="ident" id="1516644">B</span>&nbsp;<span class="op" id="1516646">&amp;</span>&nbsp;<span class="op" id="1516648">(</span><span class="ident" id="1516649">bucketCnt</span>&nbsp;<span class="op" id="1516659">-</span>&nbsp;<span class="num" id="1516661">1</span><span class="op" id="1516662">)</span><span class="op" id="1516663">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516667">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516686">it</span><span class="op" id="1516688">.</span><span class="ident" id="1516689">bucket</span>&nbsp;<span class="op" id="1516696">=</span>&nbsp;<span class="ident" id="1516698">it</span><span class="op" id="1516700">.</span><span class="ident" id="1516701">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516714">it</span><span class="op" id="1516716">.</span><span class="ident" id="1516717">wrapped</span>&nbsp;<span class="op" id="1516725">=</span>&nbsp;<span class="builtintype" id="1516727">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516734">it</span><span class="op" id="1516736">.</span><span class="ident" id="1516737">bptr</span>&nbsp;<span class="op" id="1516742">=</span>&nbsp;<span class="builtintype" id="1516744">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516750">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516784">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516840">for</span>&nbsp;<span class="op" id="1516844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516848">old</span>&nbsp;<span class="op" id="1516852">:=</span>&nbsp;<span class="ident" id="1516855">h</span><span class="op" id="1516856">.</span><span class="ident" id="1516857">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516865">if</span>&nbsp;<span class="ident" id="1516868">old</span>&nbsp;<span class="op" id="1516872">==</span>&nbsp;<span class="ident" id="1516875">old</span><span class="op" id="1516878">|</span><span class="ident" id="1516879">iterator</span><span class="op" id="1516887">|</span><span class="ident" id="1516888">oldIterator</span>&nbsp;<span class="op" id="1516900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516905">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1516913">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516917">if</span>&nbsp;<span class="ident" id="1516920">cas</span><span class="op" id="1516923">(</span><span class="op" id="1516924">&amp;</span><span class="ident" id="1516925">h</span><span class="op" id="1516926">.</span><span class="ident" id="1516927">flags</span><span class="op" id="1516932">,</span>&nbsp;<span class="ident" id="1516934">old</span><span class="op" id="1516937">,</span>&nbsp;<span class="ident" id="1516939">old</span><span class="op" id="1516942">|</span><span class="ident" id="1516943">iterator</span><span class="op" id="1516951">|</span><span class="ident" id="1516952">oldIterator</span><span class="op" id="1516963">)</span>&nbsp;<span class="op" id="1516965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516970">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1516978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1516981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516985">mapiternext</span><span class="op" id="1516996">(</span><span class="ident" id="1516997">it</span><span class="op" id="1516999">)</span><br>
<span class="lineno"></span><span class="op" id="1517001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1517004">func</span>&nbsp;<span class="ident" id="1517009">mapiternext</span><span class="op" id="1517020">(</span><span class="ident" id="1517021">it</span>&nbsp;<span class="op" id="1517024">*</span><span class="ident" id="1517025">hiter</span><span class="op" id="1517030">)</span>&nbsp;<span class="op" id="1517032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517035">h</span>&nbsp;<span class="op" id="1517037">:=</span>&nbsp;<span class="ident" id="1517040">it</span><span class="op" id="1517042">.</span><span class="ident" id="1517043">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517046">if</span>&nbsp;<span class="ident" id="1517049">raceenabled</span>&nbsp;<span class="op" id="1517061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517065">callerpc</span>&nbsp;<span class="op" id="1517074">:=</span>&nbsp;<span class="ident" id="1517077">getcallerpc</span><span class="op" id="1517088">(</span><span class="ident" id="1517089">unsafe</span><span class="op" id="1517095">.</span><span class="ident" id="1517096">Pointer</span><span class="op" id="1517103">(</span><span class="op" id="1517104">&amp;</span><span class="ident" id="1517105">it</span><span class="op" id="1517107">)</span><span class="op" id="1517108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517112">racereadpc</span><span class="op" id="1517122">(</span><span class="ident" id="1517123">unsafe</span><span class="op" id="1517129">.</span><span class="ident" id="1517130">Pointer</span><span class="op" id="1517137">(</span><span class="ident" id="1517138">h</span><span class="op" id="1517139">)</span><span class="op" id="1517140">,</span>&nbsp;<span class="ident" id="1517142">callerpc</span><span class="op" id="1517150">,</span>&nbsp;<span class="ident" id="1517152">funcPC</span><span class="op" id="1517158">(</span><span class="ident" id="1517159">mapiternext</span><span class="op" id="1517170">)</span><span class="op" id="1517171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517177">t</span>&nbsp;<span class="op" id="1517179">:=</span>&nbsp;<span class="ident" id="1517182">it</span><span class="op" id="1517184">.</span><span class="ident" id="1517185">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517188">bucket</span>&nbsp;<span class="op" id="1517195">:=</span>&nbsp;<span class="ident" id="1517198">it</span><span class="op" id="1517200">.</span><span class="ident" id="1517201">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517209">b</span>&nbsp;<span class="op" id="1517211">:=</span>&nbsp;<span class="ident" id="1517214">it</span><span class="op" id="1517216">.</span><span class="ident" id="1517217">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517223">i</span>&nbsp;<span class="op" id="1517225">:=</span>&nbsp;<span class="ident" id="1517228">it</span><span class="op" id="1517230">.</span><span class="ident" id="1517231">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517234">checkBucket</span>&nbsp;<span class="op" id="1517246">:=</span>&nbsp;<span class="ident" id="1517249">it</span><span class="op" id="1517251">.</span><span class="ident" id="1517252">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517265">alg</span>&nbsp;<span class="op" id="1517269">:=</span>&nbsp;<span class="ident" id="1517272">goalg</span><span class="op" id="1517277">(</span><span class="ident" id="1517278">t</span><span class="op" id="1517279">.</span><span class="ident" id="1517280">key</span><span class="op" id="1517283">.</span><span class="ident" id="1517284">alg</span><span class="op" id="1517287">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1517290">next</span><span class="op" id="1517294">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517297">if</span>&nbsp;<span class="ident" id="1517300">b</span>&nbsp;<span class="op" id="1517302">==</span>&nbsp;<span class="builtintype" id="1517305">nil</span>&nbsp;<span class="op" id="1517309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517313">if</span>&nbsp;<span class="ident" id="1517316">bucket</span>&nbsp;<span class="op" id="1517323">==</span>&nbsp;<span class="ident" id="1517326">it</span><span class="op" id="1517328">.</span><span class="ident" id="1517329">startBucket</span>&nbsp;<span class="op" id="1517341">&amp;&amp;</span>&nbsp;<span class="ident" id="1517344">it</span><span class="op" id="1517346">.</span><span class="ident" id="1517347">wrapped</span>&nbsp;<span class="op" id="1517355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517360">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517383">it</span><span class="op" id="1517385">.</span><span class="ident" id="1517386">key</span>&nbsp;<span class="op" id="1517390">=</span>&nbsp;<span class="builtintype" id="1517392">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517399">it</span><span class="op" id="1517401">.</span><span class="ident" id="1517402">value</span>&nbsp;<span class="op" id="1517408">=</span>&nbsp;<span class="builtintype" id="1517410">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517417">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517430">if</span>&nbsp;<span class="ident" id="1517433">h</span><span class="op" id="1517434">.</span><span class="ident" id="1517435">oldbuckets</span>&nbsp;<span class="op" id="1517446">!=</span>&nbsp;<span class="builtintype" id="1517449">nil</span>&nbsp;<span class="op" id="1517453">&amp;&amp;</span>&nbsp;<span class="ident" id="1517456">it</span><span class="op" id="1517458">.</span><span class="ident" id="1517459">B</span>&nbsp;<span class="op" id="1517461">==</span>&nbsp;<span class="ident" id="1517464">h</span><span class="op" id="1517465">.</span><span class="ident" id="1517466">B</span>&nbsp;<span class="op" id="1517468">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517473">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517554">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517631">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517707">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517783">oldbucket</span>&nbsp;<span class="op" id="1517793">:=</span>&nbsp;<span class="ident" id="1517796">bucket</span>&nbsp;<span class="op" id="1517803">&amp;</span>&nbsp;<span class="op" id="1517805">(</span><span class="builtintype" id="1517806">uintptr</span><span class="op" id="1517813">(</span><span class="num" id="1517814">1</span><span class="op" id="1517815">)</span><span class="op" id="1517816">&lt;&lt;</span><span class="op" id="1517818">(</span><span class="ident" id="1517819">it</span><span class="op" id="1517821">.</span><span class="ident" id="1517822">B</span><span class="op" id="1517823">-</span><span class="num" id="1517824">1</span><span class="op" id="1517825">)</span>&nbsp;<span class="op" id="1517827">-</span>&nbsp;<span class="num" id="1517829">1</span><span class="op" id="1517830">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517835">b</span>&nbsp;<span class="op" id="1517837">=</span>&nbsp;<span class="op" id="1517839">(</span><span class="op" id="1517840">*</span><span class="ident" id="1517841">bmap</span><span class="op" id="1517845">)</span><span class="op" id="1517846">(</span><span class="ident" id="1517847">add</span><span class="op" id="1517850">(</span><span class="ident" id="1517851">h</span><span class="op" id="1517852">.</span><span class="ident" id="1517853">oldbuckets</span><span class="op" id="1517863">,</span>&nbsp;<span class="ident" id="1517865">oldbucket</span><span class="op" id="1517874">*</span><span class="builtintype" id="1517875">uintptr</span><span class="op" id="1517882">(</span><span class="ident" id="1517883">t</span><span class="op" id="1517884">.</span><span class="ident" id="1517885">bucketsize</span><span class="op" id="1517895">)</span><span class="op" id="1517896">)</span><span class="op" id="1517897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517902">if</span>&nbsp;<span class="op" id="1517905">!</span><span class="ident" id="1517906">evacuated</span><span class="op" id="1517915">(</span><span class="ident" id="1517916">b</span><span class="op" id="1517917">)</span>&nbsp;<span class="op" id="1517919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517925">checkBucket</span>&nbsp;<span class="op" id="1517937">=</span>&nbsp;<span class="ident" id="1517939">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517949">}</span>&nbsp;<span class="keyword" id="1517951">else</span>&nbsp;<span class="op" id="1517956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517962">b</span>&nbsp;<span class="op" id="1517964">=</span>&nbsp;<span class="op" id="1517966">(</span><span class="op" id="1517967">*</span><span class="ident" id="1517968">bmap</span><span class="op" id="1517972">)</span><span class="op" id="1517973">(</span><span class="ident" id="1517974">add</span><span class="op" id="1517977">(</span><span class="ident" id="1517978">it</span><span class="op" id="1517980">.</span><span class="ident" id="1517981">buckets</span><span class="op" id="1517988">,</span>&nbsp;<span class="ident" id="1517990">bucket</span><span class="op" id="1517996">*</span><span class="builtintype" id="1517997">uintptr</span><span class="op" id="1518004">(</span><span class="ident" id="1518005">t</span><span class="op" id="1518006">.</span><span class="ident" id="1518007">bucketsize</span><span class="op" id="1518017">)</span><span class="op" id="1518018">)</span><span class="op" id="1518019">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518025">checkBucket</span>&nbsp;<span class="op" id="1518037">=</span>&nbsp;<span class="ident" id="1518039">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518054">}</span>&nbsp;<span class="keyword" id="1518056">else</span>&nbsp;<span class="op" id="1518061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518066">b</span>&nbsp;<span class="op" id="1518068">=</span>&nbsp;<span class="op" id="1518070">(</span><span class="op" id="1518071">*</span><span class="ident" id="1518072">bmap</span><span class="op" id="1518076">)</span><span class="op" id="1518077">(</span><span class="ident" id="1518078">add</span><span class="op" id="1518081">(</span><span class="ident" id="1518082">it</span><span class="op" id="1518084">.</span><span class="ident" id="1518085">buckets</span><span class="op" id="1518092">,</span>&nbsp;<span class="ident" id="1518094">bucket</span><span class="op" id="1518100">*</span><span class="builtintype" id="1518101">uintptr</span><span class="op" id="1518108">(</span><span class="ident" id="1518109">t</span><span class="op" id="1518110">.</span><span class="ident" id="1518111">bucketsize</span><span class="op" id="1518121">)</span><span class="op" id="1518122">)</span><span class="op" id="1518123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518128">checkBucket</span>&nbsp;<span class="op" id="1518140">=</span>&nbsp;<span class="ident" id="1518142">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518156">bucket</span><span class="op" id="1518162">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518167">if</span>&nbsp;<span class="ident" id="1518170">bucket</span>&nbsp;<span class="op" id="1518177">==</span>&nbsp;<span class="builtintype" id="1518180">uintptr</span><span class="op" id="1518187">(</span><span class="num" id="1518188">1</span><span class="op" id="1518189">)</span><span class="op" id="1518190">&lt;&lt;</span><span class="ident" id="1518192">it</span><span class="op" id="1518194">.</span><span class="ident" id="1518195">B</span>&nbsp;<span class="op" id="1518197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518202">bucket</span>&nbsp;<span class="op" id="1518209">=</span>&nbsp;<span class="num" id="1518211">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518216">it</span><span class="op" id="1518218">.</span><span class="ident" id="1518219">wrapped</span>&nbsp;<span class="op" id="1518227">=</span>&nbsp;<span class="builtintype" id="1518229">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518240">i</span>&nbsp;<span class="op" id="1518242">=</span>&nbsp;<span class="num" id="1518244">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518250">for</span>&nbsp;<span class="op" id="1518254">;</span>&nbsp;<span class="ident" id="1518256">i</span>&nbsp;<span class="op" id="1518258">&lt;</span>&nbsp;<span class="ident" id="1518260">bucketCnt</span><span class="op" id="1518269">;</span>&nbsp;<span class="ident" id="1518271">i</span><span class="op" id="1518272">++</span>&nbsp;<span class="op" id="1518275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518279">offi</span>&nbsp;<span class="op" id="1518284">:=</span>&nbsp;<span class="op" id="1518287">(</span><span class="ident" id="1518288">i</span>&nbsp;<span class="op" id="1518290">+</span>&nbsp;<span class="ident" id="1518292">it</span><span class="op" id="1518294">.</span><span class="ident" id="1518295">offset</span><span class="op" id="1518301">)</span>&nbsp;<span class="op" id="1518303">&amp;</span>&nbsp;<span class="op" id="1518305">(</span><span class="ident" id="1518306">bucketCnt</span>&nbsp;<span class="op" id="1518316">-</span>&nbsp;<span class="num" id="1518318">1</span><span class="op" id="1518319">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518323">k</span>&nbsp;<span class="op" id="1518325">:=</span>&nbsp;<span class="ident" id="1518328">add</span><span class="op" id="1518331">(</span><span class="ident" id="1518332">unsafe</span><span class="op" id="1518338">.</span><span class="ident" id="1518339">Pointer</span><span class="op" id="1518346">(</span><span class="ident" id="1518347">b</span><span class="op" id="1518348">)</span><span class="op" id="1518349">,</span>&nbsp;<span class="ident" id="1518351">dataOffset</span><span class="op" id="1518361">+</span><span class="builtintype" id="1518362">uintptr</span><span class="op" id="1518369">(</span><span class="ident" id="1518370">offi</span><span class="op" id="1518374">)</span><span class="op" id="1518375">*</span><span class="builtintype" id="1518376">uintptr</span><span class="op" id="1518383">(</span><span class="ident" id="1518384">t</span><span class="op" id="1518385">.</span><span class="ident" id="1518386">keysize</span><span class="op" id="1518393">)</span><span class="op" id="1518394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518398">v</span>&nbsp;<span class="op" id="1518400">:=</span>&nbsp;<span class="ident" id="1518403">add</span><span class="op" id="1518406">(</span><span class="ident" id="1518407">unsafe</span><span class="op" id="1518413">.</span><span class="ident" id="1518414">Pointer</span><span class="op" id="1518421">(</span><span class="ident" id="1518422">b</span><span class="op" id="1518423">)</span><span class="op" id="1518424">,</span>&nbsp;<span class="ident" id="1518426">dataOffset</span><span class="op" id="1518436">+</span><span class="ident" id="1518437">bucketCnt</span><span class="op" id="1518446">*</span><span class="builtintype" id="1518447">uintptr</span><span class="op" id="1518454">(</span><span class="ident" id="1518455">t</span><span class="op" id="1518456">.</span><span class="ident" id="1518457">keysize</span><span class="op" id="1518464">)</span><span class="op" id="1518465">+</span><span class="builtintype" id="1518466">uintptr</span><span class="op" id="1518473">(</span><span class="ident" id="1518474">offi</span><span class="op" id="1518478">)</span><span class="op" id="1518479">*</span><span class="builtintype" id="1518480">uintptr</span><span class="op" id="1518487">(</span><span class="ident" id="1518488">t</span><span class="op" id="1518489">.</span><span class="ident" id="1518490">valuesize</span><span class="op" id="1518499">)</span><span class="op" id="1518500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518504">if</span>&nbsp;<span class="ident" id="1518507">b</span><span class="op" id="1518508">.</span><span class="ident" id="1518509">tophash</span><span class="op" id="1518516">[</span><span class="ident" id="1518517">offi</span><span class="op" id="1518521">]</span>&nbsp;<span class="op" id="1518523">!=</span>&nbsp;<span class="ident" id="1518526">empty</span>&nbsp;<span class="op" id="1518532">&amp;&amp;</span>&nbsp;<span class="ident" id="1518535">b</span><span class="op" id="1518536">.</span><span class="ident" id="1518537">tophash</span><span class="op" id="1518544">[</span><span class="ident" id="1518545">offi</span><span class="op" id="1518549">]</span>&nbsp;<span class="op" id="1518551">!=</span>&nbsp;<span class="ident" id="1518554">evacuatedEmpty</span>&nbsp;<span class="op" id="1518569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518574">if</span>&nbsp;<span class="ident" id="1518577">checkBucket</span>&nbsp;<span class="op" id="1518589">!=</span>&nbsp;<span class="ident" id="1518592">noCheck</span>&nbsp;<span class="op" id="1518600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518606">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518670">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518732">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518801">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518866">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518927">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518989">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519020">k2</span>&nbsp;<span class="op" id="1519023">:=</span>&nbsp;<span class="ident" id="1519026">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519032">if</span>&nbsp;<span class="ident" id="1519035">t</span><span class="op" id="1519036">.</span><span class="ident" id="1519037">indirectkey</span>&nbsp;<span class="op" id="1519049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519056">k2</span>&nbsp;<span class="op" id="1519059">=</span>&nbsp;<span class="op" id="1519061">*</span><span class="op" id="1519062">(</span><span class="op" id="1519063">(</span><span class="op" id="1519064">*</span><span class="ident" id="1519065">unsafe</span><span class="op" id="1519071">.</span><span class="ident" id="1519072">Pointer</span><span class="op" id="1519079">)</span><span class="op" id="1519080">(</span><span class="ident" id="1519081">k2</span><span class="op" id="1519083">)</span><span class="op" id="1519084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519090">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519096">if</span>&nbsp;<span class="ident" id="1519099">alg</span><span class="op" id="1519102">.</span><span class="ident" id="1519103">equal</span><span class="op" id="1519108">(</span><span class="ident" id="1519109">k2</span><span class="op" id="1519111">,</span>&nbsp;<span class="ident" id="1519113">k2</span><span class="op" id="1519115">,</span>&nbsp;<span class="builtintype" id="1519117">uintptr</span><span class="op" id="1519124">(</span><span class="ident" id="1519125">t</span><span class="op" id="1519126">.</span><span class="ident" id="1519127">key</span><span class="op" id="1519130">.</span><span class="ident" id="1519131">size</span><span class="op" id="1519135">)</span><span class="op" id="1519136">)</span>&nbsp;<span class="op" id="1519138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519145">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519202">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519260">hash</span>&nbsp;<span class="op" id="1519265">:=</span>&nbsp;<span class="ident" id="1519268">alg</span><span class="op" id="1519271">.</span><span class="ident" id="1519272">hash</span><span class="op" id="1519276">(</span><span class="ident" id="1519277">k2</span><span class="op" id="1519279">,</span>&nbsp;<span class="builtintype" id="1519281">uintptr</span><span class="op" id="1519288">(</span><span class="ident" id="1519289">t</span><span class="op" id="1519290">.</span><span class="ident" id="1519291">key</span><span class="op" id="1519294">.</span><span class="ident" id="1519295">size</span><span class="op" id="1519299">)</span><span class="op" id="1519300">,</span>&nbsp;<span class="builtintype" id="1519302">uintptr</span><span class="op" id="1519309">(</span><span class="ident" id="1519310">h</span><span class="op" id="1519311">.</span><span class="ident" id="1519312">hash0</span><span class="op" id="1519317">)</span><span class="op" id="1519318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519325">if</span>&nbsp;<span class="ident" id="1519328">hash</span><span class="op" id="1519332">&amp;</span><span class="op" id="1519333">(</span><span class="builtintype" id="1519334">uintptr</span><span class="op" id="1519341">(</span><span class="num" id="1519342">1</span><span class="op" id="1519343">)</span><span class="op" id="1519344">&lt;&lt;</span><span class="ident" id="1519346">it</span><span class="op" id="1519348">.</span><span class="ident" id="1519349">B</span><span class="op" id="1519350">-</span><span class="num" id="1519351">1</span><span class="op" id="1519352">)</span>&nbsp;<span class="op" id="1519354">!=</span>&nbsp;<span class="ident" id="1519357">checkBucket</span>&nbsp;<span class="op" id="1519369">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519377">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519397">}</span>&nbsp;<span class="keyword" id="1519399">else</span>&nbsp;<span class="op" id="1519404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519411">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519470">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519529">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519588">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519640">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519700">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519758">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519781">if</span>&nbsp;<span class="ident" id="1519784">checkBucket</span><span class="op" id="1519795">&gt;&gt;</span><span class="op" id="1519797">(</span><span class="ident" id="1519798">it</span><span class="op" id="1519800">.</span><span class="ident" id="1519801">B</span><span class="op" id="1519802">-</span><span class="num" id="1519803">1</span><span class="op" id="1519804">)</span>&nbsp;<span class="op" id="1519806">!=</span>&nbsp;<span class="builtintype" id="1519809">uintptr</span><span class="op" id="1519816">(</span><span class="ident" id="1519817">b</span><span class="op" id="1519818">.</span><span class="ident" id="1519819">tophash</span><span class="op" id="1519826">[</span><span class="ident" id="1519827">offi</span><span class="op" id="1519831">]</span><span class="op" id="1519832">&amp;</span><span class="num" id="1519833">1</span><span class="op" id="1519834">)</span>&nbsp;<span class="op" id="1519836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519844">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519869">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519874">if</span>&nbsp;<span class="ident" id="1519877">b</span><span class="op" id="1519878">.</span><span class="ident" id="1519879">tophash</span><span class="op" id="1519886">[</span><span class="ident" id="1519887">offi</span><span class="op" id="1519891">]</span>&nbsp;<span class="op" id="1519893">!=</span>&nbsp;<span class="ident" id="1519896">evacuatedX</span>&nbsp;<span class="op" id="1519907">&amp;&amp;</span>&nbsp;<span class="ident" id="1519910">b</span><span class="op" id="1519911">.</span><span class="ident" id="1519912">tophash</span><span class="op" id="1519919">[</span><span class="ident" id="1519920">offi</span><span class="op" id="1519924">]</span>&nbsp;<span class="op" id="1519926">!=</span>&nbsp;<span class="ident" id="1519929">evacuatedY</span>&nbsp;<span class="op" id="1519940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519946">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519996">if</span>&nbsp;<span class="ident" id="1519999">t</span><span class="op" id="1520000">.</span><span class="ident" id="1520001">indirectkey</span>&nbsp;<span class="op" id="1520013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520020">k</span>&nbsp;<span class="op" id="1520022">=</span>&nbsp;<span class="op" id="1520024">*</span><span class="op" id="1520025">(</span><span class="op" id="1520026">(</span><span class="op" id="1520027">*</span><span class="ident" id="1520028">unsafe</span><span class="op" id="1520034">.</span><span class="ident" id="1520035">Pointer</span><span class="op" id="1520042">)</span><span class="op" id="1520043">(</span><span class="ident" id="1520044">k</span><span class="op" id="1520045">)</span><span class="op" id="1520046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520052">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520058">it</span><span class="op" id="1520060">.</span><span class="ident" id="1520061">key</span>&nbsp;<span class="op" id="1520065">=</span>&nbsp;<span class="ident" id="1520067">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520073">if</span>&nbsp;<span class="ident" id="1520076">t</span><span class="op" id="1520077">.</span><span class="ident" id="1520078">indirectvalue</span>&nbsp;<span class="op" id="1520092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520099">v</span>&nbsp;<span class="op" id="1520101">=</span>&nbsp;<span class="op" id="1520103">*</span><span class="op" id="1520104">(</span><span class="op" id="1520105">(</span><span class="op" id="1520106">*</span><span class="ident" id="1520107">unsafe</span><span class="op" id="1520113">.</span><span class="ident" id="1520114">Pointer</span><span class="op" id="1520121">)</span><span class="op" id="1520122">(</span><span class="ident" id="1520123">v</span><span class="op" id="1520124">)</span><span class="op" id="1520125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520137">it</span><span class="op" id="1520139">.</span><span class="ident" id="1520140">value</span>&nbsp;<span class="op" id="1520146">=</span>&nbsp;<span class="ident" id="1520148">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520153">}</span>&nbsp;<span class="keyword" id="1520155">else</span>&nbsp;<span class="op" id="1520160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520166">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520230">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520289">k2</span>&nbsp;<span class="op" id="1520292">:=</span>&nbsp;<span class="ident" id="1520295">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520301">if</span>&nbsp;<span class="ident" id="1520304">t</span><span class="op" id="1520305">.</span><span class="ident" id="1520306">indirectkey</span>&nbsp;<span class="op" id="1520318">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520325">k2</span>&nbsp;<span class="op" id="1520328">=</span>&nbsp;<span class="op" id="1520330">*</span><span class="op" id="1520331">(</span><span class="op" id="1520332">(</span><span class="op" id="1520333">*</span><span class="ident" id="1520334">unsafe</span><span class="op" id="1520340">.</span><span class="ident" id="1520341">Pointer</span><span class="op" id="1520348">)</span><span class="op" id="1520349">(</span><span class="ident" id="1520350">k2</span><span class="op" id="1520352">)</span><span class="op" id="1520353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520365">if</span>&nbsp;<span class="ident" id="1520368">alg</span><span class="op" id="1520371">.</span><span class="ident" id="1520372">equal</span><span class="op" id="1520377">(</span><span class="ident" id="1520378">k2</span><span class="op" id="1520380">,</span>&nbsp;<span class="ident" id="1520382">k2</span><span class="op" id="1520384">,</span>&nbsp;<span class="builtintype" id="1520386">uintptr</span><span class="op" id="1520393">(</span><span class="ident" id="1520394">t</span><span class="op" id="1520395">.</span><span class="ident" id="1520396">key</span><span class="op" id="1520399">.</span><span class="ident" id="1520400">size</span><span class="op" id="1520404">)</span><span class="op" id="1520405">)</span>&nbsp;<span class="op" id="1520407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520414">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520465">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520514">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520576">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520643">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520716">rk</span><span class="op" id="1520718">,</span>&nbsp;<span class="ident" id="1520720">rv</span>&nbsp;<span class="op" id="1520723">:=</span>&nbsp;<span class="ident" id="1520726">mapaccessK</span><span class="op" id="1520736">(</span><span class="ident" id="1520737">t</span><span class="op" id="1520738">,</span>&nbsp;<span class="ident" id="1520740">h</span><span class="op" id="1520741">,</span>&nbsp;<span class="ident" id="1520743">k2</span><span class="op" id="1520745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520752">if</span>&nbsp;<span class="ident" id="1520755">rk</span>&nbsp;<span class="op" id="1520758">==</span>&nbsp;<span class="builtintype" id="1520761">nil</span>&nbsp;<span class="op" id="1520765">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520773">continue</span>&nbsp;<span class="comment" id="1520782">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520818">it</span><span class="op" id="1520820">.</span><span class="ident" id="1520821">key</span>&nbsp;<span class="op" id="1520825">=</span>&nbsp;<span class="ident" id="1520827">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520835">it</span><span class="op" id="1520837">.</span><span class="ident" id="1520838">value</span>&nbsp;<span class="op" id="1520844">=</span>&nbsp;<span class="ident" id="1520846">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520853">}</span>&nbsp;<span class="keyword" id="1520855">else</span>&nbsp;<span class="op" id="1520860">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520867">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520922">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520983">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1521036">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521079">it</span><span class="op" id="1521081">.</span><span class="ident" id="1521082">key</span>&nbsp;<span class="op" id="1521086">=</span>&nbsp;<span class="ident" id="1521088">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521096">if</span>&nbsp;<span class="ident" id="1521099">t</span><span class="op" id="1521100">.</span><span class="ident" id="1521101">indirectvalue</span>&nbsp;<span class="op" id="1521115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521123">v</span>&nbsp;<span class="op" id="1521125">=</span>&nbsp;<span class="op" id="1521127">*</span><span class="op" id="1521128">(</span><span class="op" id="1521129">(</span><span class="op" id="1521130">*</span><span class="ident" id="1521131">unsafe</span><span class="op" id="1521137">.</span><span class="ident" id="1521138">Pointer</span><span class="op" id="1521145">)</span><span class="op" id="1521146">(</span><span class="ident" id="1521147">v</span><span class="op" id="1521148">)</span><span class="op" id="1521149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521163">it</span><span class="op" id="1521165">.</span><span class="ident" id="1521166">value</span>&nbsp;<span class="op" id="1521172">=</span>&nbsp;<span class="ident" id="1521174">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521180">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521190">it</span><span class="op" id="1521192">.</span><span class="ident" id="1521193">bucket</span>&nbsp;<span class="op" id="1521200">=</span>&nbsp;<span class="ident" id="1521202">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521212">it</span><span class="op" id="1521214">.</span><span class="ident" id="1521215">bptr</span>&nbsp;<span class="op" id="1521220">=</span>&nbsp;<span class="ident" id="1521222">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521227">it</span><span class="op" id="1521229">.</span><span class="ident" id="1521230">i</span>&nbsp;<span class="op" id="1521232">=</span>&nbsp;<span class="ident" id="1521234">i</span>&nbsp;<span class="op" id="1521236">+</span>&nbsp;<span class="num" id="1521238">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521243">it</span><span class="op" id="1521245">.</span><span class="ident" id="1521246">checkBucket</span>&nbsp;<span class="op" id="1521258">=</span>&nbsp;<span class="ident" id="1521260">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521275">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521290">b</span>&nbsp;<span class="op" id="1521292">=</span>&nbsp;<span class="ident" id="1521294">b</span><span class="op" id="1521295">.</span><span class="ident" id="1521296">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521306">i</span>&nbsp;<span class="op" id="1521308">=</span>&nbsp;<span class="num" id="1521310">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521313">goto</span>&nbsp;<span class="ident" id="1521318">next</span><br>
<span class="lineno"></span><span class="op" id="1521323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1521326">func</span>&nbsp;<span class="ident" id="1521331">hashGrow</span><span class="op" id="1521339">(</span><span class="ident" id="1521340">t</span>&nbsp;<span class="op" id="1521342">*</span><span class="ident" id="1521343">maptype</span><span class="op" id="1521350">,</span>&nbsp;<span class="ident" id="1521352">h</span>&nbsp;<span class="op" id="1521354">*</span><span class="ident" id="1521355">hmap</span><span class="op" id="1521359">)</span>&nbsp;<span class="op" id="1521361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521364">if</span>&nbsp;<span class="ident" id="1521367">h</span><span class="op" id="1521368">.</span><span class="ident" id="1521369">oldbuckets</span>&nbsp;<span class="op" id="1521380">!=</span>&nbsp;<span class="builtintype" id="1521383">nil</span>&nbsp;<span class="op" id="1521387">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521391">gothrow</span><span class="op" id="1521398">(</span><span class="string" id="1521399">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1521428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521434">oldbuckets</span>&nbsp;<span class="op" id="1521445">:=</span>&nbsp;<span class="ident" id="1521448">h</span><span class="op" id="1521449">.</span><span class="ident" id="1521450">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521459">if</span>&nbsp;<span class="ident" id="1521462">checkgc</span>&nbsp;<span class="op" id="1521470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521474">memstats</span><span class="op" id="1521482">.</span><span class="ident" id="1521483">next_gc</span>&nbsp;<span class="op" id="1521491">=</span>&nbsp;<span class="ident" id="1521493">memstats</span><span class="op" id="1521501">.</span><span class="ident" id="1521502">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521517">newbuckets</span>&nbsp;<span class="op" id="1521528">:=</span>&nbsp;<span class="ident" id="1521531">newarray</span><span class="op" id="1521539">(</span><span class="ident" id="1521540">t</span><span class="op" id="1521541">.</span><span class="ident" id="1521542">bucket</span><span class="op" id="1521548">,</span>&nbsp;<span class="builtintype" id="1521550">uintptr</span><span class="op" id="1521557">(</span><span class="num" id="1521558">1</span><span class="op" id="1521559">)</span><span class="op" id="1521560">&lt;&lt;</span><span class="op" id="1521562">(</span><span class="ident" id="1521563">h</span><span class="op" id="1521564">.</span><span class="ident" id="1521565">B</span><span class="op" id="1521566">+</span><span class="num" id="1521567">1</span><span class="op" id="1521568">)</span><span class="op" id="1521569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521572">flags</span>&nbsp;<span class="op" id="1521578">:=</span>&nbsp;<span class="ident" id="1521581">h</span><span class="op" id="1521582">.</span><span class="ident" id="1521583">flags</span>&nbsp;<span class="op" id="1521589">&amp;^</span>&nbsp;<span class="op" id="1521592">(</span><span class="ident" id="1521593">iterator</span>&nbsp;<span class="op" id="1521602">|</span>&nbsp;<span class="ident" id="1521604">oldIterator</span><span class="op" id="1521615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521618">if</span>&nbsp;<span class="ident" id="1521621">h</span><span class="op" id="1521622">.</span><span class="ident" id="1521623">flags</span><span class="op" id="1521628">&amp;</span><span class="ident" id="1521629">iterator</span>&nbsp;<span class="op" id="1521638">!=</span>&nbsp;<span class="num" id="1521641">0</span>&nbsp;<span class="op" id="1521643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521647">flags</span>&nbsp;<span class="op" id="1521653">|=</span>&nbsp;<span class="ident" id="1521656">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1521672">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521708">h</span><span class="op" id="1521709">.</span><span class="ident" id="1521710">B</span><span class="op" id="1521711">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521715">h</span><span class="op" id="1521716">.</span><span class="ident" id="1521717">flags</span>&nbsp;<span class="op" id="1521723">=</span>&nbsp;<span class="ident" id="1521725">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521732">h</span><span class="op" id="1521733">.</span><span class="ident" id="1521734">oldbuckets</span>&nbsp;<span class="op" id="1521745">=</span>&nbsp;<span class="ident" id="1521747">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521759">h</span><span class="op" id="1521760">.</span><span class="ident" id="1521761">buckets</span>&nbsp;<span class="op" id="1521769">=</span>&nbsp;<span class="ident" id="1521771">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521783">h</span><span class="op" id="1521784">.</span><span class="ident" id="1521785">nevacuate</span>&nbsp;<span class="op" id="1521795">=</span>&nbsp;<span class="num" id="1521797">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1521801">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1521869">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1521902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1521905">func</span>&nbsp;<span class="ident" id="1521910">growWork</span><span class="op" id="1521918">(</span><span class="ident" id="1521919">t</span>&nbsp;<span class="op" id="1521921">*</span><span class="ident" id="1521922">maptype</span><span class="op" id="1521929">,</span>&nbsp;<span class="ident" id="1521931">h</span>&nbsp;<span class="op" id="1521933">*</span><span class="ident" id="1521934">hmap</span><span class="op" id="1521938">,</span>&nbsp;<span class="ident" id="1521940">bucket</span>&nbsp;<span class="builtintype" id="1521947">uintptr</span><span class="op" id="1521954">)</span>&nbsp;<span class="op" id="1521956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521959">noldbuckets</span>&nbsp;<span class="op" id="1521971">:=</span>&nbsp;<span class="builtintype" id="1521974">uintptr</span><span class="op" id="1521981">(</span><span class="num" id="1521982">1</span><span class="op" id="1521983">)</span>&nbsp;<span class="op" id="1521985">&lt;&lt;</span>&nbsp;<span class="op" id="1521988">(</span><span class="ident" id="1521989">h</span><span class="op" id="1521990">.</span><span class="ident" id="1521991">B</span>&nbsp;<span class="op" id="1521993">-</span>&nbsp;<span class="num" id="1521995">1</span><span class="op" id="1521996">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1522000">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1522054">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522091">evacuate</span><span class="op" id="1522099">(</span><span class="ident" id="1522100">t</span><span class="op" id="1522101">,</span>&nbsp;<span class="ident" id="1522103">h</span><span class="op" id="1522104">,</span>&nbsp;<span class="ident" id="1522106">bucket</span><span class="op" id="1522112">&amp;</span><span class="op" id="1522113">(</span><span class="ident" id="1522114">noldbuckets</span><span class="op" id="1522125">-</span><span class="num" id="1522126">1</span><span class="op" id="1522127">)</span><span class="op" id="1522128">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1522132">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522192">if</span>&nbsp;<span class="ident" id="1522195">h</span><span class="op" id="1522196">.</span><span class="ident" id="1522197">oldbuckets</span>&nbsp;<span class="op" id="1522208">!=</span>&nbsp;<span class="builtintype" id="1522211">nil</span>&nbsp;<span class="op" id="1522215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522219">evacuate</span><span class="op" id="1522227">(</span><span class="ident" id="1522228">t</span><span class="op" id="1522229">,</span>&nbsp;<span class="ident" id="1522231">h</span><span class="op" id="1522232">,</span>&nbsp;<span class="ident" id="1522234">h</span><span class="op" id="1522235">.</span><span class="ident" id="1522236">nevacuate</span><span class="op" id="1522245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1522248">}</span><br>
<span class="lineno"></span><span class="op" id="1522250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1522253">func</span>&nbsp;<span class="ident" id="1522258">evacuate</span><span class="op" id="1522266">(</span><span class="ident" id="1522267">t</span>&nbsp;<span class="op" id="1522269">*</span><span class="ident" id="1522270">maptype</span><span class="op" id="1522277">,</span>&nbsp;<span class="ident" id="1522279">h</span>&nbsp;<span class="op" id="1522281">*</span><span class="ident" id="1522282">hmap</span><span class="op" id="1522286">,</span>&nbsp;<span class="ident" id="1522288">oldbucket</span>&nbsp;<span class="builtintype" id="1522298">uintptr</span><span class="op" id="1522305">)</span>&nbsp;<span class="op" id="1522307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522310">b</span>&nbsp;<span class="op" id="1522312">:=</span>&nbsp;<span class="op" id="1522315">(</span><span class="op" id="1522316">*</span><span class="ident" id="1522317">bmap</span><span class="op" id="1522321">)</span><span class="op" id="1522322">(</span><span class="ident" id="1522323">add</span><span class="op" id="1522326">(</span><span class="ident" id="1522327">h</span><span class="op" id="1522328">.</span><span class="ident" id="1522329">oldbuckets</span><span class="op" id="1522339">,</span>&nbsp;<span class="ident" id="1522341">oldbucket</span><span class="op" id="1522350">*</span><span class="builtintype" id="1522351">uintptr</span><span class="op" id="1522358">(</span><span class="ident" id="1522359">t</span><span class="op" id="1522360">.</span><span class="ident" id="1522361">bucketsize</span><span class="op" id="1522371">)</span><span class="op" id="1522372">)</span><span class="op" id="1522373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522376">newbit</span>&nbsp;<span class="op" id="1522383">:=</span>&nbsp;<span class="builtintype" id="1522386">uintptr</span><span class="op" id="1522393">(</span><span class="num" id="1522394">1</span><span class="op" id="1522395">)</span>&nbsp;<span class="op" id="1522397">&lt;&lt;</span>&nbsp;<span class="op" id="1522400">(</span><span class="ident" id="1522401">h</span><span class="op" id="1522402">.</span><span class="ident" id="1522403">B</span>&nbsp;<span class="op" id="1522405">-</span>&nbsp;<span class="num" id="1522407">1</span><span class="op" id="1522408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522411">alg</span>&nbsp;<span class="op" id="1522415">:=</span>&nbsp;<span class="ident" id="1522418">goalg</span><span class="op" id="1522423">(</span><span class="ident" id="1522424">t</span><span class="op" id="1522425">.</span><span class="ident" id="1522426">key</span><span class="op" id="1522429">.</span><span class="ident" id="1522430">alg</span><span class="op" id="1522433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522436">if</span>&nbsp;<span class="op" id="1522439">!</span><span class="ident" id="1522440">evacuated</span><span class="op" id="1522449">(</span><span class="ident" id="1522450">b</span><span class="op" id="1522451">)</span>&nbsp;<span class="op" id="1522453">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1522457">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1522527">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522591">x</span>&nbsp;<span class="op" id="1522593">:=</span>&nbsp;<span class="op" id="1522596">(</span><span class="op" id="1522597">*</span><span class="ident" id="1522598">bmap</span><span class="op" id="1522602">)</span><span class="op" id="1522603">(</span><span class="ident" id="1522604">add</span><span class="op" id="1522607">(</span><span class="ident" id="1522608">h</span><span class="op" id="1522609">.</span><span class="ident" id="1522610">buckets</span><span class="op" id="1522617">,</span>&nbsp;<span class="ident" id="1522619">oldbucket</span><span class="op" id="1522628">*</span><span class="builtintype" id="1522629">uintptr</span><span class="op" id="1522636">(</span><span class="ident" id="1522637">t</span><span class="op" id="1522638">.</span><span class="ident" id="1522639">bucketsize</span><span class="op" id="1522649">)</span><span class="op" id="1522650">)</span><span class="op" id="1522651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522655">y</span>&nbsp;<span class="op" id="1522657">:=</span>&nbsp;<span class="op" id="1522660">(</span><span class="op" id="1522661">*</span><span class="ident" id="1522662">bmap</span><span class="op" id="1522666">)</span><span class="op" id="1522667">(</span><span class="ident" id="1522668">add</span><span class="op" id="1522671">(</span><span class="ident" id="1522672">h</span><span class="op" id="1522673">.</span><span class="ident" id="1522674">buckets</span><span class="op" id="1522681">,</span>&nbsp;<span class="op" id="1522683">(</span><span class="ident" id="1522684">oldbucket</span><span class="op" id="1522693">+</span><span class="ident" id="1522694">newbit</span><span class="op" id="1522700">)</span><span class="op" id="1522701">*</span><span class="builtintype" id="1522702">uintptr</span><span class="op" id="1522709">(</span><span class="ident" id="1522710">t</span><span class="op" id="1522711">.</span><span class="ident" id="1522712">bucketsize</span><span class="op" id="1522722">)</span><span class="op" id="1522723">)</span><span class="op" id="1522724">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522728">xi</span>&nbsp;<span class="op" id="1522731">:=</span>&nbsp;<span class="num" id="1522734">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522738">yi</span>&nbsp;<span class="op" id="1522741">:=</span>&nbsp;<span class="num" id="1522744">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522748">xk</span>&nbsp;<span class="op" id="1522751">:=</span>&nbsp;<span class="ident" id="1522754">add</span><span class="op" id="1522757">(</span><span class="ident" id="1522758">unsafe</span><span class="op" id="1522764">.</span><span class="ident" id="1522765">Pointer</span><span class="op" id="1522772">(</span><span class="ident" id="1522773">x</span><span class="op" id="1522774">)</span><span class="op" id="1522775">,</span>&nbsp;<span class="ident" id="1522777">dataOffset</span><span class="op" id="1522787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522791">yk</span>&nbsp;<span class="op" id="1522794">:=</span>&nbsp;<span class="ident" id="1522797">add</span><span class="op" id="1522800">(</span><span class="ident" id="1522801">unsafe</span><span class="op" id="1522807">.</span><span class="ident" id="1522808">Pointer</span><span class="op" id="1522815">(</span><span class="ident" id="1522816">y</span><span class="op" id="1522817">)</span><span class="op" id="1522818">,</span>&nbsp;<span class="ident" id="1522820">dataOffset</span><span class="op" id="1522830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522834">xv</span>&nbsp;<span class="op" id="1522837">:=</span>&nbsp;<span class="ident" id="1522840">add</span><span class="op" id="1522843">(</span><span class="ident" id="1522844">xk</span><span class="op" id="1522846">,</span>&nbsp;<span class="ident" id="1522848">bucketCnt</span><span class="op" id="1522857">*</span><span class="builtintype" id="1522858">uintptr</span><span class="op" id="1522865">(</span><span class="ident" id="1522866">t</span><span class="op" id="1522867">.</span><span class="ident" id="1522868">keysize</span><span class="op" id="1522875">)</span><span class="op" id="1522876">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522880">yv</span>&nbsp;<span class="op" id="1522883">:=</span>&nbsp;<span class="ident" id="1522886">add</span><span class="op" id="1522889">(</span><span class="ident" id="1522890">yk</span><span class="op" id="1522892">,</span>&nbsp;<span class="ident" id="1522894">bucketCnt</span><span class="op" id="1522903">*</span><span class="builtintype" id="1522904">uintptr</span><span class="op" id="1522911">(</span><span class="ident" id="1522912">t</span><span class="op" id="1522913">.</span><span class="ident" id="1522914">keysize</span><span class="op" id="1522921">)</span><span class="op" id="1522922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522926">for</span>&nbsp;<span class="op" id="1522930">;</span>&nbsp;<span class="ident" id="1522932">b</span>&nbsp;<span class="op" id="1522934">!=</span>&nbsp;<span class="builtintype" id="1522937">nil</span><span class="op" id="1522940">;</span>&nbsp;<span class="ident" id="1522942">b</span>&nbsp;<span class="op" id="1522944">=</span>&nbsp;<span class="ident" id="1522946">b</span><span class="op" id="1522947">.</span><span class="ident" id="1522948">overflow</span>&nbsp;<span class="op" id="1522957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522962">k</span>&nbsp;<span class="op" id="1522964">:=</span>&nbsp;<span class="ident" id="1522967">add</span><span class="op" id="1522970">(</span><span class="ident" id="1522971">unsafe</span><span class="op" id="1522977">.</span><span class="ident" id="1522978">Pointer</span><span class="op" id="1522985">(</span><span class="ident" id="1522986">b</span><span class="op" id="1522987">)</span><span class="op" id="1522988">,</span>&nbsp;<span class="ident" id="1522990">dataOffset</span><span class="op" id="1523000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523005">v</span>&nbsp;<span class="op" id="1523007">:=</span>&nbsp;<span class="ident" id="1523010">add</span><span class="op" id="1523013">(</span><span class="ident" id="1523014">k</span><span class="op" id="1523015">,</span>&nbsp;<span class="ident" id="1523017">bucketCnt</span><span class="op" id="1523026">*</span><span class="builtintype" id="1523027">uintptr</span><span class="op" id="1523034">(</span><span class="ident" id="1523035">t</span><span class="op" id="1523036">.</span><span class="ident" id="1523037">keysize</span><span class="op" id="1523044">)</span><span class="op" id="1523045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523050">for</span>&nbsp;<span class="ident" id="1523054">i</span>&nbsp;<span class="op" id="1523056">:=</span>&nbsp;<span class="num" id="1523059">0</span><span class="op" id="1523060">;</span>&nbsp;<span class="ident" id="1523062">i</span>&nbsp;<span class="op" id="1523064">&lt;</span>&nbsp;<span class="ident" id="1523066">bucketCnt</span><span class="op" id="1523075">;</span>&nbsp;<span class="ident" id="1523077">i</span><span class="op" id="1523078">,</span>&nbsp;<span class="ident" id="1523080">k</span><span class="op" id="1523081">,</span>&nbsp;<span class="ident" id="1523083">v</span>&nbsp;<span class="op" id="1523085">=</span>&nbsp;<span class="ident" id="1523087">i</span><span class="op" id="1523088">+</span><span class="num" id="1523089">1</span><span class="op" id="1523090">,</span>&nbsp;<span class="ident" id="1523092">add</span><span class="op" id="1523095">(</span><span class="ident" id="1523096">k</span><span class="op" id="1523097">,</span>&nbsp;<span class="builtintype" id="1523099">uintptr</span><span class="op" id="1523106">(</span><span class="ident" id="1523107">t</span><span class="op" id="1523108">.</span><span class="ident" id="1523109">keysize</span><span class="op" id="1523116">)</span><span class="op" id="1523117">)</span><span class="op" id="1523118">,</span>&nbsp;<span class="ident" id="1523120">add</span><span class="op" id="1523123">(</span><span class="ident" id="1523124">v</span><span class="op" id="1523125">,</span>&nbsp;<span class="builtintype" id="1523127">uintptr</span><span class="op" id="1523134">(</span><span class="ident" id="1523135">t</span><span class="op" id="1523136">.</span><span class="ident" id="1523137">valuesize</span><span class="op" id="1523146">)</span><span class="op" id="1523147">)</span>&nbsp;<span class="op" id="1523149">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523155">top</span>&nbsp;<span class="op" id="1523159">:=</span>&nbsp;<span class="ident" id="1523162">b</span><span class="op" id="1523163">.</span><span class="ident" id="1523164">tophash</span><span class="op" id="1523171">[</span><span class="ident" id="1523172">i</span><span class="op" id="1523173">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523179">if</span>&nbsp;<span class="ident" id="1523182">top</span>&nbsp;<span class="op" id="1523186">==</span>&nbsp;<span class="ident" id="1523189">empty</span>&nbsp;<span class="op" id="1523195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523202">b</span><span class="op" id="1523203">.</span><span class="ident" id="1523204">tophash</span><span class="op" id="1523211">[</span><span class="ident" id="1523212">i</span><span class="op" id="1523213">]</span>&nbsp;<span class="op" id="1523215">=</span>&nbsp;<span class="ident" id="1523217">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523237">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523250">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523256">if</span>&nbsp;<span class="ident" id="1523259">top</span>&nbsp;<span class="op" id="1523263">&lt;</span>&nbsp;<span class="ident" id="1523265">minTopHash</span>&nbsp;<span class="op" id="1523276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523283">gothrow</span><span class="op" id="1523290">(</span><span class="string" id="1523291">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1523306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523318">k2</span>&nbsp;<span class="op" id="1523321">:=</span>&nbsp;<span class="ident" id="1523324">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523330">if</span>&nbsp;<span class="ident" id="1523333">t</span><span class="op" id="1523334">.</span><span class="ident" id="1523335">indirectkey</span>&nbsp;<span class="op" id="1523347">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523354">k2</span>&nbsp;<span class="op" id="1523357">=</span>&nbsp;<span class="op" id="1523359">*</span><span class="op" id="1523360">(</span><span class="op" id="1523361">(</span><span class="op" id="1523362">*</span><span class="ident" id="1523363">unsafe</span><span class="op" id="1523369">.</span><span class="ident" id="1523370">Pointer</span><span class="op" id="1523377">)</span><span class="op" id="1523378">(</span><span class="ident" id="1523379">k2</span><span class="op" id="1523381">)</span><span class="op" id="1523382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523394">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523463">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523519">hash</span>&nbsp;<span class="op" id="1523524">:=</span>&nbsp;<span class="ident" id="1523527">alg</span><span class="op" id="1523530">.</span><span class="ident" id="1523531">hash</span><span class="op" id="1523535">(</span><span class="ident" id="1523536">k2</span><span class="op" id="1523538">,</span>&nbsp;<span class="builtintype" id="1523540">uintptr</span><span class="op" id="1523547">(</span><span class="ident" id="1523548">t</span><span class="op" id="1523549">.</span><span class="ident" id="1523550">key</span><span class="op" id="1523553">.</span><span class="ident" id="1523554">size</span><span class="op" id="1523558">)</span><span class="op" id="1523559">,</span>&nbsp;<span class="builtintype" id="1523561">uintptr</span><span class="op" id="1523568">(</span><span class="ident" id="1523569">h</span><span class="op" id="1523570">.</span><span class="ident" id="1523571">hash0</span><span class="op" id="1523576">)</span><span class="op" id="1523577">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523583">if</span>&nbsp;<span class="ident" id="1523586">h</span><span class="op" id="1523587">.</span><span class="ident" id="1523588">flags</span><span class="op" id="1523593">&amp;</span><span class="ident" id="1523594">iterator</span>&nbsp;<span class="op" id="1523603">!=</span>&nbsp;<span class="num" id="1523606">0</span>&nbsp;<span class="op" id="1523608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523615">if</span>&nbsp;<span class="op" id="1523618">!</span><span class="ident" id="1523619">alg</span><span class="op" id="1523622">.</span><span class="ident" id="1523623">equal</span><span class="op" id="1523628">(</span><span class="ident" id="1523629">k2</span><span class="op" id="1523631">,</span>&nbsp;<span class="ident" id="1523633">k2</span><span class="op" id="1523635">,</span>&nbsp;<span class="builtintype" id="1523637">uintptr</span><span class="op" id="1523644">(</span><span class="ident" id="1523645">t</span><span class="op" id="1523646">.</span><span class="ident" id="1523647">key</span><span class="op" id="1523650">.</span><span class="ident" id="1523651">size</span><span class="op" id="1523655">)</span><span class="op" id="1523656">)</span>&nbsp;<span class="op" id="1523658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523666">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523734">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523801">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523869">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523933">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523985">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1524053">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1524122">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1524192">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1524257">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1524324">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524355">if</span>&nbsp;<span class="op" id="1524358">(</span><span class="ident" id="1524359">top</span>&nbsp;<span class="op" id="1524363">&amp;</span>&nbsp;<span class="num" id="1524365">1</span><span class="op" id="1524366">)</span>&nbsp;<span class="op" id="1524368">!=</span>&nbsp;<span class="num" id="1524371">0</span>&nbsp;<span class="op" id="1524373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524382">hash</span>&nbsp;<span class="op" id="1524387">|=</span>&nbsp;<span class="ident" id="1524390">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524403">}</span>&nbsp;<span class="keyword" id="1524405">else</span>&nbsp;<span class="op" id="1524410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524419">hash</span>&nbsp;<span class="op" id="1524424">&amp;^=</span>&nbsp;<span class="ident" id="1524428">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524449">top</span>&nbsp;<span class="op" id="1524453">=</span>&nbsp;<span class="builtintype" id="1524455">uint8</span><span class="op" id="1524460">(</span><span class="ident" id="1524461">hash</span>&nbsp;<span class="op" id="1524466">&gt;&gt;</span>&nbsp;<span class="op" id="1524469">(</span><span class="ident" id="1524470">ptrSize</span><span class="op" id="1524477">*</span><span class="num" id="1524478">8</span>&nbsp;<span class="op" id="1524480">-</span>&nbsp;<span class="num" id="1524482">8</span><span class="op" id="1524483">)</span><span class="op" id="1524484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524492">if</span>&nbsp;<span class="ident" id="1524495">top</span>&nbsp;<span class="op" id="1524499">&lt;</span>&nbsp;<span class="ident" id="1524501">minTopHash</span>&nbsp;<span class="op" id="1524512">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524521">top</span>&nbsp;<span class="op" id="1524525">+=</span>&nbsp;<span class="ident" id="1524528">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524564">if</span>&nbsp;<span class="op" id="1524567">(</span><span class="ident" id="1524568">hash</span>&nbsp;<span class="op" id="1524573">&amp;</span>&nbsp;<span class="ident" id="1524575">newbit</span><span class="op" id="1524581">)</span>&nbsp;<span class="op" id="1524583">==</span>&nbsp;<span class="num" id="1524586">0</span>&nbsp;<span class="op" id="1524588">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524595">b</span><span class="op" id="1524596">.</span><span class="ident" id="1524597">tophash</span><span class="op" id="1524604">[</span><span class="ident" id="1524605">i</span><span class="op" id="1524606">]</span>&nbsp;<span class="op" id="1524608">=</span>&nbsp;<span class="ident" id="1524610">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524626">if</span>&nbsp;<span class="ident" id="1524629">xi</span>&nbsp;<span class="op" id="1524632">==</span>&nbsp;<span class="ident" id="1524635">bucketCnt</span>&nbsp;<span class="op" id="1524645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524653">if</span>&nbsp;<span class="ident" id="1524656">checkgc</span>&nbsp;<span class="op" id="1524664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524673">memstats</span><span class="op" id="1524681">.</span><span class="ident" id="1524682">next_gc</span>&nbsp;<span class="op" id="1524690">=</span>&nbsp;<span class="ident" id="1524692">memstats</span><span class="op" id="1524700">.</span><span class="ident" id="1524701">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524718">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524726">newx</span>&nbsp;<span class="op" id="1524731">:=</span>&nbsp;<span class="op" id="1524734">(</span><span class="op" id="1524735">*</span><span class="ident" id="1524736">bmap</span><span class="op" id="1524740">)</span><span class="op" id="1524741">(</span><span class="ident" id="1524742">newobject</span><span class="op" id="1524751">(</span><span class="ident" id="1524752">t</span><span class="op" id="1524753">.</span><span class="ident" id="1524754">bucket</span><span class="op" id="1524760">)</span><span class="op" id="1524761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524769">x</span><span class="op" id="1524770">.</span><span class="ident" id="1524771">overflow</span>&nbsp;<span class="op" id="1524780">=</span>&nbsp;<span class="ident" id="1524782">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524793">x</span>&nbsp;<span class="op" id="1524795">=</span>&nbsp;<span class="ident" id="1524797">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524808">xi</span>&nbsp;<span class="op" id="1524811">=</span>&nbsp;<span class="num" id="1524813">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524821">xk</span>&nbsp;<span class="op" id="1524824">=</span>&nbsp;<span class="ident" id="1524826">add</span><span class="op" id="1524829">(</span><span class="ident" id="1524830">unsafe</span><span class="op" id="1524836">.</span><span class="ident" id="1524837">Pointer</span><span class="op" id="1524844">(</span><span class="ident" id="1524845">x</span><span class="op" id="1524846">)</span><span class="op" id="1524847">,</span>&nbsp;<span class="ident" id="1524849">dataOffset</span><span class="op" id="1524859">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524867">xv</span>&nbsp;<span class="op" id="1524870">=</span>&nbsp;<span class="ident" id="1524872">add</span><span class="op" id="1524875">(</span><span class="ident" id="1524876">xk</span><span class="op" id="1524878">,</span>&nbsp;<span class="ident" id="1524880">bucketCnt</span><span class="op" id="1524889">*</span><span class="builtintype" id="1524890">uintptr</span><span class="op" id="1524897">(</span><span class="ident" id="1524898">t</span><span class="op" id="1524899">.</span><span class="ident" id="1524900">keysize</span><span class="op" id="1524907">)</span><span class="op" id="1524908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524922">x</span><span class="op" id="1524923">.</span><span class="ident" id="1524924">tophash</span><span class="op" id="1524931">[</span><span class="ident" id="1524932">xi</span><span class="op" id="1524934">]</span>&nbsp;<span class="op" id="1524936">=</span>&nbsp;<span class="ident" id="1524938">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524947">if</span>&nbsp;<span class="ident" id="1524950">t</span><span class="op" id="1524951">.</span><span class="ident" id="1524952">indirectkey</span>&nbsp;<span class="op" id="1524964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524972">*</span><span class="op" id="1524973">(</span><span class="op" id="1524974">*</span><span class="ident" id="1524975">unsafe</span><span class="op" id="1524981">.</span><span class="ident" id="1524982">Pointer</span><span class="op" id="1524989">)</span><span class="op" id="1524990">(</span><span class="ident" id="1524991">xk</span><span class="op" id="1524993">)</span>&nbsp;<span class="op" id="1524995">=</span>&nbsp;<span class="ident" id="1524997">k2</span>&nbsp;<span class="comment" id="1525000">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525021">}</span>&nbsp;<span class="keyword" id="1525023">else</span>&nbsp;<span class="op" id="1525028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525036">memmove</span><span class="op" id="1525043">(</span><span class="ident" id="1525044">xk</span><span class="op" id="1525046">,</span>&nbsp;<span class="ident" id="1525048">k</span><span class="op" id="1525049">,</span>&nbsp;<span class="builtintype" id="1525051">uintptr</span><span class="op" id="1525058">(</span><span class="ident" id="1525059">t</span><span class="op" id="1525060">.</span><span class="ident" id="1525061">key</span><span class="op" id="1525064">.</span><span class="ident" id="1525065">size</span><span class="op" id="1525069">)</span><span class="op" id="1525070">)</span>&nbsp;<span class="comment" id="1525072">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525098">if</span>&nbsp;<span class="ident" id="1525101">t</span><span class="op" id="1525102">.</span><span class="ident" id="1525103">indirectvalue</span>&nbsp;<span class="op" id="1525117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525125">*</span><span class="op" id="1525126">(</span><span class="op" id="1525127">*</span><span class="ident" id="1525128">unsafe</span><span class="op" id="1525134">.</span><span class="ident" id="1525135">Pointer</span><span class="op" id="1525142">)</span><span class="op" id="1525143">(</span><span class="ident" id="1525144">xv</span><span class="op" id="1525146">)</span>&nbsp;<span class="op" id="1525148">=</span>&nbsp;<span class="op" id="1525150">*</span><span class="op" id="1525151">(</span><span class="op" id="1525152">*</span><span class="ident" id="1525153">unsafe</span><span class="op" id="1525159">.</span><span class="ident" id="1525160">Pointer</span><span class="op" id="1525167">)</span><span class="op" id="1525168">(</span><span class="ident" id="1525169">v</span><span class="op" id="1525170">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525177">}</span>&nbsp;<span class="keyword" id="1525179">else</span>&nbsp;<span class="op" id="1525184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525192">memmove</span><span class="op" id="1525199">(</span><span class="ident" id="1525200">xv</span><span class="op" id="1525202">,</span>&nbsp;<span class="ident" id="1525204">v</span><span class="op" id="1525205">,</span>&nbsp;<span class="builtintype" id="1525207">uintptr</span><span class="op" id="1525214">(</span><span class="ident" id="1525215">t</span><span class="op" id="1525216">.</span><span class="ident" id="1525217">elem</span><span class="op" id="1525221">.</span><span class="ident" id="1525222">size</span><span class="op" id="1525226">)</span><span class="op" id="1525227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525241">xi</span><span class="op" id="1525243">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525251">xk</span>&nbsp;<span class="op" id="1525254">=</span>&nbsp;<span class="ident" id="1525256">add</span><span class="op" id="1525259">(</span><span class="ident" id="1525260">xk</span><span class="op" id="1525262">,</span>&nbsp;<span class="builtintype" id="1525264">uintptr</span><span class="op" id="1525271">(</span><span class="ident" id="1525272">t</span><span class="op" id="1525273">.</span><span class="ident" id="1525274">keysize</span><span class="op" id="1525281">)</span><span class="op" id="1525282">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525289">xv</span>&nbsp;<span class="op" id="1525292">=</span>&nbsp;<span class="ident" id="1525294">add</span><span class="op" id="1525297">(</span><span class="ident" id="1525298">xv</span><span class="op" id="1525300">,</span>&nbsp;<span class="builtintype" id="1525302">uintptr</span><span class="op" id="1525309">(</span><span class="ident" id="1525310">t</span><span class="op" id="1525311">.</span><span class="ident" id="1525312">valuesize</span><span class="op" id="1525321">)</span><span class="op" id="1525322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525328">}</span>&nbsp;<span class="keyword" id="1525330">else</span>&nbsp;<span class="op" id="1525335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525342">b</span><span class="op" id="1525343">.</span><span class="ident" id="1525344">tophash</span><span class="op" id="1525351">[</span><span class="ident" id="1525352">i</span><span class="op" id="1525353">]</span>&nbsp;<span class="op" id="1525355">=</span>&nbsp;<span class="ident" id="1525357">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525373">if</span>&nbsp;<span class="ident" id="1525376">yi</span>&nbsp;<span class="op" id="1525379">==</span>&nbsp;<span class="ident" id="1525382">bucketCnt</span>&nbsp;<span class="op" id="1525392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525400">if</span>&nbsp;<span class="ident" id="1525403">checkgc</span>&nbsp;<span class="op" id="1525411">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525420">memstats</span><span class="op" id="1525428">.</span><span class="ident" id="1525429">next_gc</span>&nbsp;<span class="op" id="1525437">=</span>&nbsp;<span class="ident" id="1525439">memstats</span><span class="op" id="1525447">.</span><span class="ident" id="1525448">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525473">newy</span>&nbsp;<span class="op" id="1525478">:=</span>&nbsp;<span class="op" id="1525481">(</span><span class="op" id="1525482">*</span><span class="ident" id="1525483">bmap</span><span class="op" id="1525487">)</span><span class="op" id="1525488">(</span><span class="ident" id="1525489">newobject</span><span class="op" id="1525498">(</span><span class="ident" id="1525499">t</span><span class="op" id="1525500">.</span><span class="ident" id="1525501">bucket</span><span class="op" id="1525507">)</span><span class="op" id="1525508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525516">y</span><span class="op" id="1525517">.</span><span class="ident" id="1525518">overflow</span>&nbsp;<span class="op" id="1525527">=</span>&nbsp;<span class="ident" id="1525529">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525540">y</span>&nbsp;<span class="op" id="1525542">=</span>&nbsp;<span class="ident" id="1525544">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525555">yi</span>&nbsp;<span class="op" id="1525558">=</span>&nbsp;<span class="num" id="1525560">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525568">yk</span>&nbsp;<span class="op" id="1525571">=</span>&nbsp;<span class="ident" id="1525573">add</span><span class="op" id="1525576">(</span><span class="ident" id="1525577">unsafe</span><span class="op" id="1525583">.</span><span class="ident" id="1525584">Pointer</span><span class="op" id="1525591">(</span><span class="ident" id="1525592">y</span><span class="op" id="1525593">)</span><span class="op" id="1525594">,</span>&nbsp;<span class="ident" id="1525596">dataOffset</span><span class="op" id="1525606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525614">yv</span>&nbsp;<span class="op" id="1525617">=</span>&nbsp;<span class="ident" id="1525619">add</span><span class="op" id="1525622">(</span><span class="ident" id="1525623">yk</span><span class="op" id="1525625">,</span>&nbsp;<span class="ident" id="1525627">bucketCnt</span><span class="op" id="1525636">*</span><span class="builtintype" id="1525637">uintptr</span><span class="op" id="1525644">(</span><span class="ident" id="1525645">t</span><span class="op" id="1525646">.</span><span class="ident" id="1525647">keysize</span><span class="op" id="1525654">)</span><span class="op" id="1525655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525669">y</span><span class="op" id="1525670">.</span><span class="ident" id="1525671">tophash</span><span class="op" id="1525678">[</span><span class="ident" id="1525679">yi</span><span class="op" id="1525681">]</span>&nbsp;<span class="op" id="1525683">=</span>&nbsp;<span class="ident" id="1525685">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525694">if</span>&nbsp;<span class="ident" id="1525697">t</span><span class="op" id="1525698">.</span><span class="ident" id="1525699">indirectkey</span>&nbsp;<span class="op" id="1525711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525719">*</span><span class="op" id="1525720">(</span><span class="op" id="1525721">*</span><span class="ident" id="1525722">unsafe</span><span class="op" id="1525728">.</span><span class="ident" id="1525729">Pointer</span><span class="op" id="1525736">)</span><span class="op" id="1525737">(</span><span class="ident" id="1525738">yk</span><span class="op" id="1525740">)</span>&nbsp;<span class="op" id="1525742">=</span>&nbsp;<span class="ident" id="1525744">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525752">}</span>&nbsp;<span class="keyword" id="1525754">else</span>&nbsp;<span class="op" id="1525759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525767">memmove</span><span class="op" id="1525774">(</span><span class="ident" id="1525775">yk</span><span class="op" id="1525777">,</span>&nbsp;<span class="ident" id="1525779">k</span><span class="op" id="1525780">,</span>&nbsp;<span class="builtintype" id="1525782">uintptr</span><span class="op" id="1525789">(</span><span class="ident" id="1525790">t</span><span class="op" id="1525791">.</span><span class="ident" id="1525792">key</span><span class="op" id="1525795">.</span><span class="ident" id="1525796">size</span><span class="op" id="1525800">)</span><span class="op" id="1525801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525808">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525815">if</span>&nbsp;<span class="ident" id="1525818">t</span><span class="op" id="1525819">.</span><span class="ident" id="1525820">indirectvalue</span>&nbsp;<span class="op" id="1525834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525842">*</span><span class="op" id="1525843">(</span><span class="op" id="1525844">*</span><span class="ident" id="1525845">unsafe</span><span class="op" id="1525851">.</span><span class="ident" id="1525852">Pointer</span><span class="op" id="1525859">)</span><span class="op" id="1525860">(</span><span class="ident" id="1525861">yv</span><span class="op" id="1525863">)</span>&nbsp;<span class="op" id="1525865">=</span>&nbsp;<span class="op" id="1525867">*</span><span class="op" id="1525868">(</span><span class="op" id="1525869">*</span><span class="ident" id="1525870">unsafe</span><span class="op" id="1525876">.</span><span class="ident" id="1525877">Pointer</span><span class="op" id="1525884">)</span><span class="op" id="1525885">(</span><span class="ident" id="1525886">v</span><span class="op" id="1525887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525894">}</span>&nbsp;<span class="keyword" id="1525896">else</span>&nbsp;<span class="op" id="1525901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525909">memmove</span><span class="op" id="1525916">(</span><span class="ident" id="1525917">yv</span><span class="op" id="1525919">,</span>&nbsp;<span class="ident" id="1525921">v</span><span class="op" id="1525922">,</span>&nbsp;<span class="builtintype" id="1525924">uintptr</span><span class="op" id="1525931">(</span><span class="ident" id="1525932">t</span><span class="op" id="1525933">.</span><span class="ident" id="1525934">elem</span><span class="op" id="1525938">.</span><span class="ident" id="1525939">size</span><span class="op" id="1525943">)</span><span class="op" id="1525944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525951">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525958">yi</span><span class="op" id="1525960">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525968">yk</span>&nbsp;<span class="op" id="1525971">=</span>&nbsp;<span class="ident" id="1525973">add</span><span class="op" id="1525976">(</span><span class="ident" id="1525977">yk</span><span class="op" id="1525979">,</span>&nbsp;<span class="builtintype" id="1525981">uintptr</span><span class="op" id="1525988">(</span><span class="ident" id="1525989">t</span><span class="op" id="1525990">.</span><span class="ident" id="1525991">keysize</span><span class="op" id="1525998">)</span><span class="op" id="1525999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526006">yv</span>&nbsp;<span class="op" id="1526009">=</span>&nbsp;<span class="ident" id="1526011">add</span><span class="op" id="1526014">(</span><span class="ident" id="1526015">yv</span><span class="op" id="1526017">,</span>&nbsp;<span class="builtintype" id="1526019">uintptr</span><span class="op" id="1526026">(</span><span class="ident" id="1526027">t</span><span class="op" id="1526028">.</span><span class="ident" id="1526029">valuesize</span><span class="op" id="1526038">)</span><span class="op" id="1526039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526050">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1526058">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1526121">if</span>&nbsp;<span class="ident" id="1526124">h</span><span class="op" id="1526125">.</span><span class="ident" id="1526126">flags</span><span class="op" id="1526131">&amp;</span><span class="ident" id="1526132">oldIterator</span>&nbsp;<span class="op" id="1526144">==</span>&nbsp;<span class="num" id="1526147">0</span>&nbsp;<span class="op" id="1526149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526154">b</span>&nbsp;<span class="op" id="1526156">=</span>&nbsp;<span class="op" id="1526158">(</span><span class="op" id="1526159">*</span><span class="ident" id="1526160">bmap</span><span class="op" id="1526164">)</span><span class="op" id="1526165">(</span><span class="ident" id="1526166">add</span><span class="op" id="1526169">(</span><span class="ident" id="1526170">h</span><span class="op" id="1526171">.</span><span class="ident" id="1526172">oldbuckets</span><span class="op" id="1526182">,</span>&nbsp;<span class="ident" id="1526184">oldbucket</span><span class="op" id="1526193">*</span><span class="builtintype" id="1526194">uintptr</span><span class="op" id="1526201">(</span><span class="ident" id="1526202">t</span><span class="op" id="1526203">.</span><span class="ident" id="1526204">bucketsize</span><span class="op" id="1526214">)</span><span class="op" id="1526215">)</span><span class="op" id="1526216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526221">b</span><span class="op" id="1526222">.</span><span class="ident" id="1526223">overflow</span>&nbsp;<span class="op" id="1526232">=</span>&nbsp;<span class="builtintype" id="1526234">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526241">memclr</span><span class="op" id="1526247">(</span><span class="ident" id="1526248">add</span><span class="op" id="1526251">(</span><span class="ident" id="1526252">unsafe</span><span class="op" id="1526258">.</span><span class="ident" id="1526259">Pointer</span><span class="op" id="1526266">(</span><span class="ident" id="1526267">b</span><span class="op" id="1526268">)</span><span class="op" id="1526269">,</span>&nbsp;<span class="ident" id="1526271">dataOffset</span><span class="op" id="1526281">)</span><span class="op" id="1526282">,</span>&nbsp;<span class="builtintype" id="1526284">uintptr</span><span class="op" id="1526291">(</span><span class="ident" id="1526292">t</span><span class="op" id="1526293">.</span><span class="ident" id="1526294">bucketsize</span><span class="op" id="1526304">)</span><span class="op" id="1526305">-</span><span class="ident" id="1526306">dataOffset</span><span class="op" id="1526316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1526327">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1526355">if</span>&nbsp;<span class="ident" id="1526358">oldbucket</span>&nbsp;<span class="op" id="1526368">==</span>&nbsp;<span class="ident" id="1526371">h</span><span class="op" id="1526372">.</span><span class="ident" id="1526373">nevacuate</span>&nbsp;<span class="op" id="1526383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526387">h</span><span class="op" id="1526388">.</span><span class="ident" id="1526389">nevacuate</span>&nbsp;<span class="op" id="1526399">=</span>&nbsp;<span class="ident" id="1526401">oldbucket</span>&nbsp;<span class="op" id="1526411">+</span>&nbsp;<span class="num" id="1526413">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1526417">if</span>&nbsp;<span class="ident" id="1526420">oldbucket</span><span class="op" id="1526429">+</span><span class="num" id="1526430">1</span>&nbsp;<span class="op" id="1526432">==</span>&nbsp;<span class="ident" id="1526435">newbit</span>&nbsp;<span class="op" id="1526442">{</span>&nbsp;<span class="comment" id="1526444">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1526476">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526532">h</span><span class="op" id="1526533">.</span><span class="ident" id="1526534">oldbuckets</span>&nbsp;<span class="op" id="1526545">=</span>&nbsp;<span class="builtintype" id="1526547">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526556">}</span><br>
<span class="lineno"></span><span class="op" id="1526558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1526561">func</span>&nbsp;<span class="ident" id="1526566">ismapkey</span><span class="op" id="1526574">(</span><span class="ident" id="1526575">t</span>&nbsp;<span class="op" id="1526577">*</span><span class="ident" id="1526578">_type</span><span class="op" id="1526583">)</span>&nbsp;<span class="builtintype" id="1526585">bool</span>&nbsp;<span class="op" id="1526590">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1526593">return</span>&nbsp;<span class="ident" id="1526600">goalg</span><span class="op" id="1526605">(</span><span class="ident" id="1526606">t</span><span class="op" id="1526607">.</span><span class="ident" id="1526608">alg</span><span class="op" id="1526611">)</span><span class="op" id="1526612">.</span><span class="ident" id="1526613">hash</span>&nbsp;<span class="op" id="1526618">!=</span>&nbsp;<span class="builtintype" id="1526621">nil</span><br>
<span class="lineno"></span><span class="op" id="1526625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1526628">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1526679">func</span>&nbsp;<span class="ident" id="1526684">reflect_makemap</span><span class="op" id="1526699">(</span><span class="ident" id="1526700">t</span>&nbsp;<span class="op" id="1526702">*</span><span class="ident" id="1526703">maptype</span><span class="op" id="1526710">)</span>&nbsp;<span class="op" id="1526712">*</span><span class="ident" id="1526713">hmap</span>&nbsp;<span class="op" id="1526718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1526721">return</span>&nbsp;<span class="ident" id="1526728">makemap</span><span class="op" id="1526735">(</span><span class="ident" id="1526736">t</span><span class="op" id="1526737">,</span>&nbsp;<span class="num" id="1526739">0</span><span class="op" id="1526740">)</span><br>
<span class="lineno"></span><span class="op" id="1526742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1526745">func</span>&nbsp;<span class="ident" id="1526750">reflect_mapaccess</span><span class="op" id="1526767">(</span><span class="ident" id="1526768">t</span>&nbsp;<span class="op" id="1526770">*</span><span class="ident" id="1526771">maptype</span><span class="op" id="1526778">,</span>&nbsp;<span class="ident" id="1526780">h</span>&nbsp;<span class="op" id="1526782">*</span><span class="ident" id="1526783">hmap</span><span class="op" id="1526787">,</span>&nbsp;<span class="ident" id="1526789">key</span>&nbsp;<span class="ident" id="1526793">unsafe</span><span class="op" id="1526799">.</span><span class="ident" id="1526800">Pointer</span><span class="op" id="1526807">)</span>&nbsp;<span class="ident" id="1526809">unsafe</span><span class="op" id="1526815">.</span><span class="ident" id="1526816">Pointer</span>&nbsp;<span class="op" id="1526824">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526827">val</span><span class="op" id="1526830">,</span>&nbsp;<span class="ident" id="1526832">ok</span>&nbsp;<span class="op" id="1526835">:=</span>&nbsp;<span class="ident" id="1526838">mapaccess2</span><span class="op" id="1526848">(</span><span class="ident" id="1526849">t</span><span class="op" id="1526850">,</span>&nbsp;<span class="ident" id="1526852">h</span><span class="op" id="1526853">,</span>&nbsp;<span class="ident" id="1526855">key</span><span class="op" id="1526858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1526861">if</span>&nbsp;<span class="op" id="1526864">!</span><span class="ident" id="1526865">ok</span>&nbsp;<span class="op" id="1526868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1526872">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1526917">val</span>&nbsp;<span class="op" id="1526921">=</span>&nbsp;<span class="builtintype" id="1526923">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526928">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1526931">return</span>&nbsp;<span class="ident" id="1526938">val</span><br>
<span class="lineno"></span><span class="op" id="1526942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1526945">func</span>&nbsp;<span class="ident" id="1526950">reflect_mapassign</span><span class="op" id="1526967">(</span><span class="ident" id="1526968">t</span>&nbsp;<span class="op" id="1526970">*</span><span class="ident" id="1526971">maptype</span><span class="op" id="1526978">,</span>&nbsp;<span class="ident" id="1526980">h</span>&nbsp;<span class="op" id="1526982">*</span><span class="ident" id="1526983">hmap</span><span class="op" id="1526987">,</span>&nbsp;<span class="ident" id="1526989">key</span>&nbsp;<span class="ident" id="1526993">unsafe</span><span class="op" id="1526999">.</span><span class="ident" id="1527000">Pointer</span><span class="op" id="1527007">,</span>&nbsp;<span class="ident" id="1527009">val</span>&nbsp;<span class="ident" id="1527013">unsafe</span><span class="op" id="1527019">.</span><span class="ident" id="1527020">Pointer</span><span class="op" id="1527027">)</span>&nbsp;<span class="op" id="1527029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1527032">mapassign1</span><span class="op" id="1527042">(</span><span class="ident" id="1527043">t</span><span class="op" id="1527044">,</span>&nbsp;<span class="ident" id="1527046">h</span><span class="op" id="1527047">,</span>&nbsp;<span class="ident" id="1527049">key</span><span class="op" id="1527052">,</span>&nbsp;<span class="ident" id="1527054">val</span><span class="op" id="1527057">)</span><br>
<span class="lineno">920</span><span class="op" id="1527059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1527062">func</span>&nbsp;<span class="ident" id="1527067">reflect_mapdelete</span><span class="op" id="1527084">(</span><span class="ident" id="1527085">t</span>&nbsp;<span class="op" id="1527087">*</span><span class="ident" id="1527088">maptype</span><span class="op" id="1527095">,</span>&nbsp;<span class="ident" id="1527097">h</span>&nbsp;<span class="op" id="1527099">*</span><span class="ident" id="1527100">hmap</span><span class="op" id="1527104">,</span>&nbsp;<span class="ident" id="1527106">key</span>&nbsp;<span class="ident" id="1527110">unsafe</span><span class="op" id="1527116">.</span><span class="ident" id="1527117">Pointer</span><span class="op" id="1527124">)</span>&nbsp;<span class="op" id="1527126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1527129">mapdelete</span><span class="op" id="1527138">(</span><span class="ident" id="1527139">t</span><span class="op" id="1527140">,</span>&nbsp;<span class="ident" id="1527142">h</span><span class="op" id="1527143">,</span>&nbsp;<span class="ident" id="1527145">key</span><span class="op" id="1527148">)</span><br>
<span class="lineno"></span><span class="op" id="1527150">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1527153">func</span>&nbsp;<span class="ident" id="1527158">reflect_mapiterinit</span><span class="op" id="1527177">(</span><span class="ident" id="1527178">t</span>&nbsp;<span class="op" id="1527180">*</span><span class="ident" id="1527181">maptype</span><span class="op" id="1527188">,</span>&nbsp;<span class="ident" id="1527190">h</span>&nbsp;<span class="op" id="1527192">*</span><span class="ident" id="1527193">hmap</span><span class="op" id="1527197">)</span>&nbsp;<span class="op" id="1527199">*</span><span class="ident" id="1527200">hiter</span>&nbsp;<span class="op" id="1527206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1527209">it</span>&nbsp;<span class="op" id="1527212">:=</span>&nbsp;<span class="builtinfunc" id="1527215">new</span><span class="op" id="1527218">(</span><span class="ident" id="1527219">hiter</span><span class="op" id="1527224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1527227">mapiterinit</span><span class="op" id="1527238">(</span><span class="ident" id="1527239">t</span><span class="op" id="1527240">,</span>&nbsp;<span class="ident" id="1527242">h</span><span class="op" id="1527243">,</span>&nbsp;<span class="ident" id="1527245">it</span><span class="op" id="1527247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1527250">return</span>&nbsp;<span class="ident" id="1527257">it</span><br>
<span class="lineno">930</span><span class="op" id="1527260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1527263">func</span>&nbsp;<span class="ident" id="1527268">reflect_mapiternext</span><span class="op" id="1527287">(</span><span class="ident" id="1527288">it</span>&nbsp;<span class="op" id="1527291">*</span><span class="ident" id="1527292">hiter</span><span class="op" id="1527297">)</span>&nbsp;<span class="op" id="1527299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1527302">mapiternext</span><span class="op" id="1527313">(</span><span class="ident" id="1527314">it</span><span class="op" id="1527316">)</span><br>
<span class="lineno"></span><span class="op" id="1527318">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1527321">func</span>&nbsp;<span class="ident" id="1527326">reflect_mapiterkey</span><span class="op" id="1527344">(</span><span class="ident" id="1527345">it</span>&nbsp;<span class="op" id="1527348">*</span><span class="ident" id="1527349">hiter</span><span class="op" id="1527354">)</span>&nbsp;<span class="ident" id="1527356">unsafe</span><span class="op" id="1527362">.</span><span class="ident" id="1527363">Pointer</span>&nbsp;<span class="op" id="1527371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1527374">return</span>&nbsp;<span class="ident" id="1527381">it</span><span class="op" id="1527383">.</span><span class="ident" id="1527384">key</span><br>
<span class="lineno"></span><span class="op" id="1527388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1527391">func</span>&nbsp;<span class="ident" id="1527396">reflect_maplen</span><span class="op" id="1527410">(</span><span class="ident" id="1527411">h</span>&nbsp;<span class="op" id="1527413">*</span><span class="ident" id="1527414">hmap</span><span class="op" id="1527418">)</span>&nbsp;<span class="builtintype" id="1527420">int</span>&nbsp;<span class="op" id="1527424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1527427">if</span>&nbsp;<span class="ident" id="1527430">h</span>&nbsp;<span class="op" id="1527432">==</span>&nbsp;<span class="builtintype" id="1527435">nil</span>&nbsp;<span class="op" id="1527439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1527443">return</span>&nbsp;<span class="num" id="1527450">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1527453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1527456">if</span>&nbsp;<span class="ident" id="1527459">raceenabled</span>&nbsp;<span class="op" id="1527471">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1527475">callerpc</span>&nbsp;<span class="op" id="1527484">:=</span>&nbsp;<span class="ident" id="1527487">getcallerpc</span><span class="op" id="1527498">(</span><span class="ident" id="1527499">unsafe</span><span class="op" id="1527505">.</span><span class="ident" id="1527506">Pointer</span><span class="op" id="1527513">(</span><span class="op" id="1527514">&amp;</span><span class="ident" id="1527515">h</span><span class="op" id="1527516">)</span><span class="op" id="1527517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1527521">racereadpc</span><span class="op" id="1527531">(</span><span class="ident" id="1527532">unsafe</span><span class="op" id="1527538">.</span><span class="ident" id="1527539">Pointer</span><span class="op" id="1527546">(</span><span class="ident" id="1527547">h</span><span class="op" id="1527548">)</span><span class="op" id="1527549">,</span>&nbsp;<span class="ident" id="1527551">callerpc</span><span class="op" id="1527559">,</span>&nbsp;<span class="ident" id="1527561">funcPC</span><span class="op" id="1527567">(</span><span class="ident" id="1527568">reflect_maplen</span><span class="op" id="1527582">)</span><span class="op" id="1527583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1527586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1527589">return</span>&nbsp;<span class="ident" id="1527596">h</span><span class="op" id="1527597">.</span><span class="ident" id="1527598">count</span><br>
<span class="lineno"></span><span class="op" id="1527604">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1527607">func</span>&nbsp;<span class="ident" id="1527612">reflect_ismapkey</span><span class="op" id="1527628">(</span><span class="ident" id="1527629">t</span>&nbsp;<span class="op" id="1527631">*</span><span class="ident" id="1527632">_type</span><span class="op" id="1527637">)</span>&nbsp;<span class="builtintype" id="1527639">bool</span>&nbsp;<span class="op" id="1527644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1527647">return</span>&nbsp;<span class="ident" id="1527654">ismapkey</span><span class="op" id="1527662">(</span><span class="ident" id="1527663">t</span><span class="op" id="1527664">)</span><br>
<span class="lineno"></span><span class="op" id="1527666">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
