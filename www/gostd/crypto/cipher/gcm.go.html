<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html" class="current">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4371338">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4371393">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4371447">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4371498">package</span>&nbsp;<span class="ident" id="4371506">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4371514">import</span>&nbsp;<span class="op" id="4371521">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4371524">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4371541">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op" id="4371550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4371553">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="4371629">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4371638">type</span>&nbsp;<span class="ident" id="4371643">AEAD</span>&nbsp;<span class="keyword" id="4371648">interface</span>&nbsp;<span class="op" id="4371658">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4371661">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4371733">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4371747">NonceSize</span><span class="op" id="4371756">(</span><span class="op" id="4371757">)</span>&nbsp;<span class="builtintype" id="4371759">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4371765">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4371834">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4371864">Overhead</span><span class="op" id="4371872">(</span><span class="op" id="4371873">)</span>&nbsp;<span class="builtintype" id="4371875">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4371881">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4371946">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372019">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372090">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372117">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372121">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4372180">Seal</span><span class="op" id="4372184">(</span><span class="ident" id="4372185">dst</span><span class="op" id="4372188">,</span>&nbsp;<span class="ident" id="4372190">nonce</span><span class="op" id="4372195">,</span>&nbsp;<span class="ident" id="4372197">plaintext</span><span class="op" id="4372206">,</span>&nbsp;<span class="ident" id="4372208">data</span>&nbsp;<span class="op" id="4372213">[</span><span class="op" id="4372214">]</span><span class="builtintype" id="4372215">byte</span><span class="op" id="4372219">)</span>&nbsp;<span class="op" id="4372221">[</span><span class="op" id="4372222">]</span><span class="builtintype" id="4372223">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372230">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372296">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372368">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372439">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372505">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372531">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4372535">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4372595">Open</span><span class="op" id="4372599">(</span><span class="ident" id="4372600">dst</span><span class="op" id="4372603">,</span>&nbsp;<span class="ident" id="4372605">nonce</span><span class="op" id="4372610">,</span>&nbsp;<span class="ident" id="4372612">ciphertext</span><span class="op" id="4372622">,</span>&nbsp;<span class="ident" id="4372624">data</span>&nbsp;<span class="op" id="4372629">[</span><span class="op" id="4372630">]</span><span class="builtintype" id="4372631">byte</span><span class="op" id="4372635">)</span>&nbsp;<span class="op" id="4372637">(</span><span class="op" id="4372638">[</span><span class="op" id="4372639">]</span><span class="builtintype" id="4372640">byte</span><span class="op" id="4372644">,</span>&nbsp;<span class="builtintype" id="4372646">error</span><span class="op" id="4372651">)</span><br>
<span class="lineno"></span><span class="op" id="4372653">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="4372656">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment" id="4372739">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="4372817">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment" id="4372855">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment" id="4372916">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="4372977">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="4373042">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="4373106">type</span>&nbsp;<span class="ident" id="4373111">gcmFieldElement</span>&nbsp;<span class="keyword" id="4373127">struct</span>&nbsp;<span class="op" id="4373134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4373137">low</span><span class="op" id="4373140">,</span>&nbsp;<span class="ident" id="4373142">high</span>&nbsp;<span class="ident" id="4373147">uint64</span><br>
<span class="lineno">50</span><span class="op" id="4373154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4373157">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment" id="4373222">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword" id="4373317">type</span>&nbsp;<span class="ident" id="4373322">gcm</span>&nbsp;<span class="keyword" id="4373326">struct</span>&nbsp;<span class="op" id="4373333">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4373336">cipher</span>&nbsp;<span class="ident" id="4373343">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4373350">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4373416">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4373473">productTable</span>&nbsp;<span class="op" id="4373486">[</span><span class="num" id="4373487">16</span><span class="op" id="4373489">]</span><span class="ident" id="4373490">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op" id="4373506">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4373509">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword" id="4373591">func</span>&nbsp;<span class="ident" id="4373596">NewGCM</span><span class="op" id="4373602">(</span><span class="ident" id="4373603">cipher</span>&nbsp;<span class="ident" id="4373610">Block</span><span class="op" id="4373615">)</span>&nbsp;<span class="op" id="4373617">(</span><span class="ident" id="4373618">AEAD</span><span class="op" id="4373622">,</span>&nbsp;<span class="builtintype" id="4373624">error</span><span class="op" id="4373629">)</span>&nbsp;<span class="op" id="4373631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4373634">if</span>&nbsp;<span class="ident" id="4373637">cipher</span><span class="op" id="4373643">.</span><span class="ident" id="4373644">BlockSize</span><span class="op" id="4373653">(</span><span class="op" id="4373654">)</span>&nbsp;<span class="op" id="4373656">!=</span>&nbsp;<span class="ident" id="4373659">gcmBlockSize</span>&nbsp;<span class="op" id="4373672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4373676">return</span>&nbsp;<span class="ident" id="4373683">nil</span><span class="op" id="4373686">,</span>&nbsp;<span class="ident" id="4373688">errors</span><span class="op" id="4373694">.</span><span class="ident" id="4373695">New</span><span class="op" id="4373698">(</span><span class="string" id="4373699">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op" id="4373745">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4373748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4373752">var</span>&nbsp;<span class="ident" id="4373756">key</span>&nbsp;<span class="op" id="4373760">[</span><span class="ident" id="4373761">gcmBlockSize</span><span class="op" id="4373773">]</span><span class="builtintype" id="4373774">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4373780">cipher</span><span class="op" id="4373786">.</span><span class="ident" id="4373787">Encrypt</span><span class="op" id="4373794">(</span><span class="ident" id="4373795">key</span><span class="op" id="4373798">[</span><span class="op" id="4373799">:</span><span class="op" id="4373800">]</span><span class="op" id="4373801">,</span>&nbsp;<span class="ident" id="4373803">key</span><span class="op" id="4373806">[</span><span class="op" id="4373807">:</span><span class="op" id="4373808">]</span><span class="op" id="4373809">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4373813">g</span>&nbsp;<span class="op" id="4373815">:=</span>&nbsp;<span class="op" id="4373818">&amp;</span><span class="ident" id="4373819">gcm</span><span class="op" id="4373822">{</span><span class="ident" id="4373823">cipher</span><span class="op" id="4373829">:</span>&nbsp;<span class="ident" id="4373831">cipher</span><span class="op" id="4373837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4373841">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4373910">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4373975">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4374044">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4374114">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374184">x</span>&nbsp;<span class="op" id="4374186">:=</span>&nbsp;<span class="ident" id="4374189">gcmFieldElement</span><span class="op" id="4374204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374208">getUint64</span><span class="op" id="4374217">(</span><span class="ident" id="4374218">key</span><span class="op" id="4374221">[</span><span class="op" id="4374222">:</span><span class="num" id="4374223">8</span><span class="op" id="4374224">]</span><span class="op" id="4374225">)</span><span class="op" id="4374226">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374230">getUint64</span><span class="op" id="4374239">(</span><span class="ident" id="4374240">key</span><span class="op" id="4374243">[</span><span class="num" id="4374244">8</span><span class="op" id="4374245">:</span><span class="op" id="4374246">]</span><span class="op" id="4374247">)</span><span class="op" id="4374248">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4374251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374254">g</span><span class="op" id="4374255">.</span><span class="ident" id="4374256">productTable</span><span class="op" id="4374268">[</span><span class="ident" id="4374269">reverseBits</span><span class="op" id="4374280">(</span><span class="num" id="4374281">1</span><span class="op" id="4374282">)</span><span class="op" id="4374283">]</span>&nbsp;<span class="op" id="4374285">=</span>&nbsp;<span class="ident" id="4374287">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4374291">for</span>&nbsp;<span class="ident" id="4374295">i</span>&nbsp;<span class="op" id="4374297">:=</span>&nbsp;<span class="num" id="4374300">2</span><span class="op" id="4374301">;</span>&nbsp;<span class="ident" id="4374303">i</span>&nbsp;<span class="op" id="4374305">&lt;</span>&nbsp;<span class="num" id="4374307">16</span><span class="op" id="4374309">;</span>&nbsp;<span class="ident" id="4374311">i</span>&nbsp;<span class="op" id="4374313">+=</span>&nbsp;<span class="num" id="4374316">2</span>&nbsp;<span class="op" id="4374318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374322">g</span><span class="op" id="4374323">.</span><span class="ident" id="4374324">productTable</span><span class="op" id="4374336">[</span><span class="ident" id="4374337">reverseBits</span><span class="op" id="4374348">(</span><span class="ident" id="4374349">i</span><span class="op" id="4374350">)</span><span class="op" id="4374351">]</span>&nbsp;<span class="op" id="4374353">=</span>&nbsp;<span class="ident" id="4374355">gcmDouble</span><span class="op" id="4374364">(</span><span class="op" id="4374365">&amp;</span><span class="ident" id="4374366">g</span><span class="op" id="4374367">.</span><span class="ident" id="4374368">productTable</span><span class="op" id="4374380">[</span><span class="ident" id="4374381">reverseBits</span><span class="op" id="4374392">(</span><span class="ident" id="4374393">i</span><span class="op" id="4374394">/</span><span class="num" id="4374395">2</span><span class="op" id="4374396">)</span><span class="op" id="4374397">]</span><span class="op" id="4374398">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374402">g</span><span class="op" id="4374403">.</span><span class="ident" id="4374404">productTable</span><span class="op" id="4374416">[</span><span class="ident" id="4374417">reverseBits</span><span class="op" id="4374428">(</span><span class="ident" id="4374429">i</span><span class="op" id="4374430">+</span><span class="num" id="4374431">1</span><span class="op" id="4374432">)</span><span class="op" id="4374433">]</span>&nbsp;<span class="op" id="4374435">=</span>&nbsp;<span class="ident" id="4374437">gcmAdd</span><span class="op" id="4374443">(</span><span class="op" id="4374444">&amp;</span><span class="ident" id="4374445">g</span><span class="op" id="4374446">.</span><span class="ident" id="4374447">productTable</span><span class="op" id="4374459">[</span><span class="ident" id="4374460">reverseBits</span><span class="op" id="4374471">(</span><span class="ident" id="4374472">i</span><span class="op" id="4374473">)</span><span class="op" id="4374474">]</span><span class="op" id="4374475">,</span>&nbsp;<span class="op" id="4374477">&amp;</span><span class="ident" id="4374478">x</span><span class="op" id="4374479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4374482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4374486">return</span>&nbsp;<span class="ident" id="4374493">g</span><span class="op" id="4374494">,</span>&nbsp;<span class="ident" id="4374496">nil</span><br>
<span class="lineno"></span><span class="op" id="4374500">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="4374503">const</span>&nbsp;<span class="op" id="4374509">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374512">gcmBlockSize</span>&nbsp;<span class="op" id="4374525">=</span>&nbsp;<span class="num" id="4374527">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374531">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4374544">=</span>&nbsp;<span class="num" id="4374546">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374550">gcmNonceSize</span>&nbsp;<span class="op" id="4374563">=</span>&nbsp;<span class="num" id="4374565">12</span><br>
<span class="lineno">95</span><span class="op" id="4374568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4374571">func</span>&nbsp;<span class="op" id="4374576">(</span><span class="op" id="4374577">*</span><span class="ident" id="4374578">gcm</span><span class="op" id="4374581">)</span>&nbsp;<span class="ident" id="4374583">NonceSize</span><span class="op" id="4374592">(</span><span class="op" id="4374593">)</span>&nbsp;<span class="builtintype" id="4374595">int</span>&nbsp;<span class="op" id="4374599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4374602">return</span>&nbsp;<span class="ident" id="4374609">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op" id="4374622">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="4374625">func</span>&nbsp;<span class="op" id="4374630">(</span><span class="op" id="4374631">*</span><span class="ident" id="4374632">gcm</span><span class="op" id="4374635">)</span>&nbsp;<span class="ident" id="4374637">Overhead</span><span class="op" id="4374645">(</span><span class="op" id="4374646">)</span>&nbsp;<span class="builtintype" id="4374648">int</span>&nbsp;<span class="op" id="4374652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4374655">return</span>&nbsp;<span class="ident" id="4374662">gcmTagSize</span><br>
<span class="lineno"></span><span class="op" id="4374673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="4374676">func</span>&nbsp;<span class="op" id="4374681">(</span><span class="ident" id="4374682">g</span>&nbsp;<span class="op" id="4374684">*</span><span class="ident" id="4374685">gcm</span><span class="op" id="4374688">)</span>&nbsp;<span class="ident" id="4374690">Seal</span><span class="op" id="4374694">(</span><span class="ident" id="4374695">dst</span><span class="op" id="4374698">,</span>&nbsp;<span class="ident" id="4374700">nonce</span><span class="op" id="4374705">,</span>&nbsp;<span class="ident" id="4374707">plaintext</span><span class="op" id="4374716">,</span>&nbsp;<span class="ident" id="4374718">data</span>&nbsp;<span class="op" id="4374723">[</span><span class="op" id="4374724">]</span><span class="builtintype" id="4374725">byte</span><span class="op" id="4374729">)</span>&nbsp;<span class="op" id="4374731">[</span><span class="op" id="4374732">]</span><span class="builtintype" id="4374733">byte</span>&nbsp;<span class="op" id="4374738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4374741">if</span>&nbsp;<span class="builtinfunc" id="4374744">len</span><span class="op" id="4374747">(</span><span class="ident" id="4374748">nonce</span><span class="op" id="4374753">)</span>&nbsp;<span class="op" id="4374755">!=</span>&nbsp;<span class="ident" id="4374758">gcmNonceSize</span>&nbsp;<span class="op" id="4374771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4374775">panic</span><span class="op" id="4374780">(</span><span class="string" id="4374781">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="4374826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4374829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374833">ret</span><span class="op" id="4374836">,</span>&nbsp;<span class="ident" id="4374838">out</span>&nbsp;<span class="op" id="4374842">:=</span>&nbsp;<span class="ident" id="4374845">sliceForAppend</span><span class="op" id="4374859">(</span><span class="ident" id="4374860">dst</span><span class="op" id="4374863">,</span>&nbsp;<span class="builtinfunc" id="4374865">len</span><span class="op" id="4374868">(</span><span class="ident" id="4374869">plaintext</span><span class="op" id="4374878">)</span><span class="op" id="4374879">+</span><span class="ident" id="4374880">gcmTagSize</span><span class="op" id="4374890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4374894">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4374925">var</span>&nbsp;<span class="ident" id="4374929">counter</span><span class="op" id="4374936">,</span>&nbsp;<span class="ident" id="4374938">tagMask</span>&nbsp;<span class="op" id="4374946">[</span><span class="ident" id="4374947">gcmBlockSize</span><span class="op" id="4374959">]</span><span class="builtintype" id="4374960">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4374966">copy</span><span class="op" id="4374970">(</span><span class="ident" id="4374971">counter</span><span class="op" id="4374978">[</span><span class="op" id="4374979">:</span><span class="op" id="4374980">]</span><span class="op" id="4374981">,</span>&nbsp;<span class="ident" id="4374983">nonce</span><span class="op" id="4374988">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4374991">counter</span><span class="op" id="4374998">[</span><span class="ident" id="4374999">gcmBlockSize</span><span class="op" id="4375011">-</span><span class="num" id="4375012">1</span><span class="op" id="4375013">]</span>&nbsp;<span class="op" id="4375015">=</span>&nbsp;<span class="num" id="4375017">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375021">g</span><span class="op" id="4375022">.</span><span class="ident" id="4375023">cipher</span><span class="op" id="4375029">.</span><span class="ident" id="4375030">Encrypt</span><span class="op" id="4375037">(</span><span class="ident" id="4375038">tagMask</span><span class="op" id="4375045">[</span><span class="op" id="4375046">:</span><span class="op" id="4375047">]</span><span class="op" id="4375048">,</span>&nbsp;<span class="ident" id="4375050">counter</span><span class="op" id="4375057">[</span><span class="op" id="4375058">:</span><span class="op" id="4375059">]</span><span class="op" id="4375060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375063">gcmInc32</span><span class="op" id="4375071">(</span><span class="op" id="4375072">&amp;</span><span class="ident" id="4375073">counter</span><span class="op" id="4375080">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375084">g</span><span class="op" id="4375085">.</span><span class="ident" id="4375086">counterCrypt</span><span class="op" id="4375098">(</span><span class="ident" id="4375099">out</span><span class="op" id="4375102">,</span>&nbsp;<span class="ident" id="4375104">plaintext</span><span class="op" id="4375113">,</span>&nbsp;<span class="op" id="4375115">&amp;</span><span class="ident" id="4375116">counter</span><span class="op" id="4375123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375126">g</span><span class="op" id="4375127">.</span><span class="ident" id="4375128">auth</span><span class="op" id="4375132">(</span><span class="ident" id="4375133">out</span><span class="op" id="4375136">[</span><span class="builtinfunc" id="4375137">len</span><span class="op" id="4375140">(</span><span class="ident" id="4375141">plaintext</span><span class="op" id="4375150">)</span><span class="op" id="4375151">:</span><span class="op" id="4375152">]</span><span class="op" id="4375153">,</span>&nbsp;<span class="ident" id="4375155">out</span><span class="op" id="4375158">[</span><span class="op" id="4375159">:</span><span class="builtinfunc" id="4375160">len</span><span class="op" id="4375163">(</span><span class="ident" id="4375164">plaintext</span><span class="op" id="4375173">)</span><span class="op" id="4375174">]</span><span class="op" id="4375175">,</span>&nbsp;<span class="ident" id="4375177">data</span><span class="op" id="4375181">,</span>&nbsp;<span class="op" id="4375183">&amp;</span><span class="ident" id="4375184">tagMask</span><span class="op" id="4375191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4375195">return</span>&nbsp;<span class="ident" id="4375202">ret</span><br>
<span class="lineno"></span><span class="op" id="4375206">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4375209">var</span>&nbsp;<span class="ident" id="4375213">errOpen</span>&nbsp;<span class="op" id="4375221">=</span>&nbsp;<span class="ident" id="4375223">errors</span><span class="op" id="4375229">.</span><span class="ident" id="4375230">New</span><span class="op" id="4375233">(</span><span class="string" id="4375234">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op" id="4375273">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4375276">func</span>&nbsp;<span class="op" id="4375281">(</span><span class="ident" id="4375282">g</span>&nbsp;<span class="op" id="4375284">*</span><span class="ident" id="4375285">gcm</span><span class="op" id="4375288">)</span>&nbsp;<span class="ident" id="4375290">Open</span><span class="op" id="4375294">(</span><span class="ident" id="4375295">dst</span><span class="op" id="4375298">,</span>&nbsp;<span class="ident" id="4375300">nonce</span><span class="op" id="4375305">,</span>&nbsp;<span class="ident" id="4375307">ciphertext</span><span class="op" id="4375317">,</span>&nbsp;<span class="ident" id="4375319">data</span>&nbsp;<span class="op" id="4375324">[</span><span class="op" id="4375325">]</span><span class="builtintype" id="4375326">byte</span><span class="op" id="4375330">)</span>&nbsp;<span class="op" id="4375332">(</span><span class="op" id="4375333">[</span><span class="op" id="4375334">]</span><span class="builtintype" id="4375335">byte</span><span class="op" id="4375339">,</span>&nbsp;<span class="builtintype" id="4375341">error</span><span class="op" id="4375346">)</span>&nbsp;<span class="op" id="4375348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4375351">if</span>&nbsp;<span class="builtinfunc" id="4375354">len</span><span class="op" id="4375357">(</span><span class="ident" id="4375358">nonce</span><span class="op" id="4375363">)</span>&nbsp;<span class="op" id="4375365">!=</span>&nbsp;<span class="ident" id="4375368">gcmNonceSize</span>&nbsp;<span class="op" id="4375381">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4375385">panic</span><span class="op" id="4375390">(</span><span class="string" id="4375391">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="4375436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4375439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4375443">if</span>&nbsp;<span class="builtinfunc" id="4375446">len</span><span class="op" id="4375449">(</span><span class="ident" id="4375450">ciphertext</span><span class="op" id="4375460">)</span>&nbsp;<span class="op" id="4375462">&lt;</span>&nbsp;<span class="ident" id="4375464">gcmTagSize</span>&nbsp;<span class="op" id="4375475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4375479">return</span>&nbsp;<span class="ident" id="4375486">nil</span><span class="op" id="4375489">,</span>&nbsp;<span class="ident" id="4375491">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4375500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375503">tag</span>&nbsp;<span class="op" id="4375507">:=</span>&nbsp;<span class="ident" id="4375510">ciphertext</span><span class="op" id="4375520">[</span><span class="builtinfunc" id="4375521">len</span><span class="op" id="4375524">(</span><span class="ident" id="4375525">ciphertext</span><span class="op" id="4375535">)</span><span class="op" id="4375536">-</span><span class="ident" id="4375537">gcmTagSize</span><span class="op" id="4375547">:</span><span class="op" id="4375548">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375551">ciphertext</span>&nbsp;<span class="op" id="4375562">=</span>&nbsp;<span class="ident" id="4375564">ciphertext</span><span class="op" id="4375574">[</span><span class="op" id="4375575">:</span><span class="builtinfunc" id="4375576">len</span><span class="op" id="4375579">(</span><span class="ident" id="4375580">ciphertext</span><span class="op" id="4375590">)</span><span class="op" id="4375591">-</span><span class="ident" id="4375592">gcmTagSize</span><span class="op" id="4375602">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4375606">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4375637">var</span>&nbsp;<span class="ident" id="4375641">counter</span><span class="op" id="4375648">,</span>&nbsp;<span class="ident" id="4375650">tagMask</span>&nbsp;<span class="op" id="4375658">[</span><span class="ident" id="4375659">gcmBlockSize</span><span class="op" id="4375671">]</span><span class="builtintype" id="4375672">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4375678">copy</span><span class="op" id="4375682">(</span><span class="ident" id="4375683">counter</span><span class="op" id="4375690">[</span><span class="op" id="4375691">:</span><span class="op" id="4375692">]</span><span class="op" id="4375693">,</span>&nbsp;<span class="ident" id="4375695">nonce</span><span class="op" id="4375700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375703">counter</span><span class="op" id="4375710">[</span><span class="ident" id="4375711">gcmBlockSize</span><span class="op" id="4375723">-</span><span class="num" id="4375724">1</span><span class="op" id="4375725">]</span>&nbsp;<span class="op" id="4375727">=</span>&nbsp;<span class="num" id="4375729">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375733">g</span><span class="op" id="4375734">.</span><span class="ident" id="4375735">cipher</span><span class="op" id="4375741">.</span><span class="ident" id="4375742">Encrypt</span><span class="op" id="4375749">(</span><span class="ident" id="4375750">tagMask</span><span class="op" id="4375757">[</span><span class="op" id="4375758">:</span><span class="op" id="4375759">]</span><span class="op" id="4375760">,</span>&nbsp;<span class="ident" id="4375762">counter</span><span class="op" id="4375769">[</span><span class="op" id="4375770">:</span><span class="op" id="4375771">]</span><span class="op" id="4375772">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375775">gcmInc32</span><span class="op" id="4375783">(</span><span class="op" id="4375784">&amp;</span><span class="ident" id="4375785">counter</span><span class="op" id="4375792">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4375796">var</span>&nbsp;<span class="ident" id="4375800">expectedTag</span>&nbsp;<span class="op" id="4375812">[</span><span class="ident" id="4375813">gcmTagSize</span><span class="op" id="4375823">]</span><span class="builtintype" id="4375824">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375830">g</span><span class="op" id="4375831">.</span><span class="ident" id="4375832">auth</span><span class="op" id="4375836">(</span><span class="ident" id="4375837">expectedTag</span><span class="op" id="4375848">[</span><span class="op" id="4375849">:</span><span class="op" id="4375850">]</span><span class="op" id="4375851">,</span>&nbsp;<span class="ident" id="4375853">ciphertext</span><span class="op" id="4375863">,</span>&nbsp;<span class="ident" id="4375865">data</span><span class="op" id="4375869">,</span>&nbsp;<span class="op" id="4375871">&amp;</span><span class="ident" id="4375872">tagMask</span><span class="op" id="4375879">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4375883">if</span>&nbsp;<span class="ident" id="4375886">subtle</span><span class="op" id="4375892">.</span><span class="ident" id="4375893">ConstantTimeCompare</span><span class="op" id="4375912">(</span><span class="ident" id="4375913">expectedTag</span><span class="op" id="4375924">[</span><span class="op" id="4375925">:</span><span class="op" id="4375926">]</span><span class="op" id="4375927">,</span>&nbsp;<span class="ident" id="4375929">tag</span><span class="op" id="4375932">)</span>&nbsp;<span class="op" id="4375934">!=</span>&nbsp;<span class="num" id="4375937">1</span>&nbsp;<span class="op" id="4375939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4375943">return</span>&nbsp;<span class="ident" id="4375950">nil</span><span class="op" id="4375953">,</span>&nbsp;<span class="ident" id="4375955">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4375964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4375968">ret</span><span class="op" id="4375971">,</span>&nbsp;<span class="ident" id="4375973">out</span>&nbsp;<span class="op" id="4375977">:=</span>&nbsp;<span class="ident" id="4375980">sliceForAppend</span><span class="op" id="4375994">(</span><span class="ident" id="4375995">dst</span><span class="op" id="4375998">,</span>&nbsp;<span class="builtinfunc" id="4376000">len</span><span class="op" id="4376003">(</span><span class="ident" id="4376004">ciphertext</span><span class="op" id="4376014">)</span><span class="op" id="4376015">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4376018">g</span><span class="op" id="4376019">.</span><span class="ident" id="4376020">counterCrypt</span><span class="op" id="4376032">(</span><span class="ident" id="4376033">out</span><span class="op" id="4376036">,</span>&nbsp;<span class="ident" id="4376038">ciphertext</span><span class="op" id="4376048">,</span>&nbsp;<span class="op" id="4376050">&amp;</span><span class="ident" id="4376051">counter</span><span class="op" id="4376058">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4376062">return</span>&nbsp;<span class="ident" id="4376069">ret</span><span class="op" id="4376072">,</span>&nbsp;<span class="ident" id="4376074">nil</span><br>
<span class="lineno"></span><span class="op" id="4376078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="4376081">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword" id="4376149">func</span>&nbsp;<span class="ident" id="4376154">reverseBits</span><span class="op" id="4376165">(</span><span class="ident" id="4376166">i</span>&nbsp;<span class="builtintype" id="4376168">int</span><span class="op" id="4376171">)</span>&nbsp;<span class="builtintype" id="4376173">int</span>&nbsp;<span class="op" id="4376177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4376180">i</span>&nbsp;<span class="op" id="4376182">=</span>&nbsp;<span class="op" id="4376184">(</span><span class="op" id="4376185">(</span><span class="ident" id="4376186">i</span>&nbsp;<span class="op" id="4376188">&lt;&lt;</span>&nbsp;<span class="num" id="4376191">2</span><span class="op" id="4376192">)</span>&nbsp;<span class="op" id="4376194">&amp;</span>&nbsp;<span class="num" id="4376196">0xc</span><span class="op" id="4376199">)</span>&nbsp;<span class="op" id="4376201">|</span>&nbsp;<span class="op" id="4376203">(</span><span class="op" id="4376204">(</span><span class="ident" id="4376205">i</span>&nbsp;<span class="op" id="4376207">&gt;&gt;</span>&nbsp;<span class="num" id="4376210">2</span><span class="op" id="4376211">)</span>&nbsp;<span class="op" id="4376213">&amp;</span>&nbsp;<span class="num" id="4376215">0x3</span><span class="op" id="4376218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4376221">i</span>&nbsp;<span class="op" id="4376223">=</span>&nbsp;<span class="op" id="4376225">(</span><span class="op" id="4376226">(</span><span class="ident" id="4376227">i</span>&nbsp;<span class="op" id="4376229">&lt;&lt;</span>&nbsp;<span class="num" id="4376232">1</span><span class="op" id="4376233">)</span>&nbsp;<span class="op" id="4376235">&amp;</span>&nbsp;<span class="num" id="4376237">0xa</span><span class="op" id="4376240">)</span>&nbsp;<span class="op" id="4376242">|</span>&nbsp;<span class="op" id="4376244">(</span><span class="op" id="4376245">(</span><span class="ident" id="4376246">i</span>&nbsp;<span class="op" id="4376248">&gt;&gt;</span>&nbsp;<span class="num" id="4376251">1</span><span class="op" id="4376252">)</span>&nbsp;<span class="op" id="4376254">&amp;</span>&nbsp;<span class="num" id="4376256">0x5</span><span class="op" id="4376259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4376262">return</span>&nbsp;<span class="ident" id="4376269">i</span><br>
<span class="lineno">165</span><span class="op" id="4376271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4376274">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword" id="4376339">func</span>&nbsp;<span class="ident" id="4376344">gcmAdd</span><span class="op" id="4376350">(</span><span class="ident" id="4376351">x</span><span class="op" id="4376352">,</span>&nbsp;<span class="ident" id="4376354">y</span>&nbsp;<span class="op" id="4376356">*</span><span class="ident" id="4376357">gcmFieldElement</span><span class="op" id="4376372">)</span>&nbsp;<span class="ident" id="4376374">gcmFieldElement</span>&nbsp;<span class="op" id="4376390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4376393">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4376447">return</span>&nbsp;<span class="ident" id="4376454">gcmFieldElement</span><span class="op" id="4376469">{</span><span class="ident" id="4376470">x</span><span class="op" id="4376471">.</span><span class="ident" id="4376472">low</span>&nbsp;<span class="op" id="4376476">^</span>&nbsp;<span class="ident" id="4376478">y</span><span class="op" id="4376479">.</span><span class="ident" id="4376480">low</span><span class="op" id="4376483">,</span>&nbsp;<span class="ident" id="4376485">x</span><span class="op" id="4376486">.</span><span class="ident" id="4376487">high</span>&nbsp;<span class="op" id="4376492">^</span>&nbsp;<span class="ident" id="4376494">y</span><span class="op" id="4376495">.</span><span class="ident" id="4376496">high</span><span class="op" id="4376500">}</span><br>
<span class="lineno"></span><span class="op" id="4376502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4376505">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword" id="4376577">func</span>&nbsp;<span class="ident" id="4376582">gcmDouble</span><span class="op" id="4376591">(</span><span class="ident" id="4376592">x</span>&nbsp;<span class="op" id="4376594">*</span><span class="ident" id="4376595">gcmFieldElement</span><span class="op" id="4376610">)</span>&nbsp;<span class="op" id="4376612">(</span><span class="ident" id="4376613">double</span>&nbsp;<span class="ident" id="4376620">gcmFieldElement</span><span class="op" id="4376635">)</span>&nbsp;<span class="op" id="4376637">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4376640">msbSet</span>&nbsp;<span class="op" id="4376647">:=</span>&nbsp;<span class="ident" id="4376650">x</span><span class="op" id="4376651">.</span><span class="ident" id="4376652">high</span><span class="op" id="4376656">&amp;</span><span class="num" id="4376657">1</span>&nbsp;<span class="op" id="4376659">==</span>&nbsp;<span class="num" id="4376662">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4376666">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4376735">double</span><span class="op" id="4376741">.</span><span class="ident" id="4376742">high</span>&nbsp;<span class="op" id="4376747">=</span>&nbsp;<span class="ident" id="4376749">x</span><span class="op" id="4376750">.</span><span class="ident" id="4376751">high</span>&nbsp;<span class="op" id="4376756">&gt;&gt;</span>&nbsp;<span class="num" id="4376759">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4376762">double</span><span class="op" id="4376768">.</span><span class="ident" id="4376769">high</span>&nbsp;<span class="op" id="4376774">|=</span>&nbsp;<span class="ident" id="4376777">x</span><span class="op" id="4376778">.</span><span class="ident" id="4376779">low</span>&nbsp;<span class="op" id="4376783">&lt;&lt;</span>&nbsp;<span class="num" id="4376786">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4376790">double</span><span class="op" id="4376796">.</span><span class="ident" id="4376797">low</span>&nbsp;<span class="op" id="4376801">=</span>&nbsp;<span class="ident" id="4376803">x</span><span class="op" id="4376804">.</span><span class="ident" id="4376805">low</span>&nbsp;<span class="op" id="4376809">&gt;&gt;</span>&nbsp;<span class="num" id="4376812">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4376816">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4376881">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4376949">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4377013">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4377086">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4377157">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4377228">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4377237">if</span>&nbsp;<span class="ident" id="4377240">msbSet</span>&nbsp;<span class="op" id="4377247">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4377251">double</span><span class="op" id="4377257">.</span><span class="ident" id="4377258">low</span>&nbsp;<span class="op" id="4377262">^=</span>&nbsp;<span class="num" id="4377265">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4377285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4377289">return</span><br>
<span class="lineno"></span><span class="op" id="4377296">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="4377299">var</span>&nbsp;<span class="ident" id="4377303">gcmReductionTable</span>&nbsp;<span class="op" id="4377321">=</span>&nbsp;<span class="op" id="4377323">[</span><span class="op" id="4377324">]</span><span class="builtintype" id="4377325">uint16</span><span class="op" id="4377331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4377334">0x0000</span><span class="op" id="4377340">,</span>&nbsp;<span class="num" id="4377342">0x1c20</span><span class="op" id="4377348">,</span>&nbsp;<span class="num" id="4377350">0x3840</span><span class="op" id="4377356">,</span>&nbsp;<span class="num" id="4377358">0x2460</span><span class="op" id="4377364">,</span>&nbsp;<span class="num" id="4377366">0x7080</span><span class="op" id="4377372">,</span>&nbsp;<span class="num" id="4377374">0x6ca0</span><span class="op" id="4377380">,</span>&nbsp;<span class="num" id="4377382">0x48c0</span><span class="op" id="4377388">,</span>&nbsp;<span class="num" id="4377390">0x54e0</span><span class="op" id="4377396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4377399">0xe100</span><span class="op" id="4377405">,</span>&nbsp;<span class="num" id="4377407">0xfd20</span><span class="op" id="4377413">,</span>&nbsp;<span class="num" id="4377415">0xd940</span><span class="op" id="4377421">,</span>&nbsp;<span class="num" id="4377423">0xc560</span><span class="op" id="4377429">,</span>&nbsp;<span class="num" id="4377431">0x9180</span><span class="op" id="4377437">,</span>&nbsp;<span class="num" id="4377439">0x8da0</span><span class="op" id="4377445">,</span>&nbsp;<span class="num" id="4377447">0xa9c0</span><span class="op" id="4377453">,</span>&nbsp;<span class="num" id="4377455">0xb5e0</span><span class="op" id="4377461">,</span><br>
<span class="lineno"></span><span class="op" id="4377463">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4377466">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword" id="4377533">func</span>&nbsp;<span class="op" id="4377538">(</span><span class="ident" id="4377539">g</span>&nbsp;<span class="op" id="4377541">*</span><span class="ident" id="4377542">gcm</span><span class="op" id="4377545">)</span>&nbsp;<span class="ident" id="4377547">mul</span><span class="op" id="4377550">(</span><span class="ident" id="4377551">y</span>&nbsp;<span class="op" id="4377553">*</span><span class="ident" id="4377554">gcmFieldElement</span><span class="op" id="4377569">)</span>&nbsp;<span class="op" id="4377571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4377574">var</span>&nbsp;<span class="ident" id="4377578">z</span>&nbsp;<span class="ident" id="4377580">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4377598">for</span>&nbsp;<span class="ident" id="4377602">i</span>&nbsp;<span class="op" id="4377604">:=</span>&nbsp;<span class="num" id="4377607">0</span><span class="op" id="4377608">;</span>&nbsp;<span class="ident" id="4377610">i</span>&nbsp;<span class="op" id="4377612">&lt;</span>&nbsp;<span class="num" id="4377614">2</span><span class="op" id="4377615">;</span>&nbsp;<span class="ident" id="4377617">i</span><span class="op" id="4377618">++</span>&nbsp;<span class="op" id="4377621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4377625">word</span>&nbsp;<span class="op" id="4377630">:=</span>&nbsp;<span class="ident" id="4377633">y</span><span class="op" id="4377634">.</span><span class="ident" id="4377635">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4377642">if</span>&nbsp;<span class="ident" id="4377645">i</span>&nbsp;<span class="op" id="4377647">==</span>&nbsp;<span class="num" id="4377650">1</span>&nbsp;<span class="op" id="4377652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4377657">word</span>&nbsp;<span class="op" id="4377662">=</span>&nbsp;<span class="ident" id="4377664">y</span><span class="op" id="4377665">.</span><span class="ident" id="4377666">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4377672">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4377677">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4377740">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4377784">for</span>&nbsp;<span class="ident" id="4377788">j</span>&nbsp;<span class="op" id="4377790">:=</span>&nbsp;<span class="num" id="4377793">0</span><span class="op" id="4377794">;</span>&nbsp;<span class="ident" id="4377796">j</span>&nbsp;<span class="op" id="4377798">&lt;</span>&nbsp;<span class="num" id="4377800">64</span><span class="op" id="4377802">;</span>&nbsp;<span class="ident" id="4377804">j</span>&nbsp;<span class="op" id="4377806">+=</span>&nbsp;<span class="num" id="4377809">4</span>&nbsp;<span class="op" id="4377811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4377816">msw</span>&nbsp;<span class="op" id="4377820">:=</span>&nbsp;<span class="ident" id="4377823">z</span><span class="op" id="4377824">.</span><span class="ident" id="4377825">high</span>&nbsp;<span class="op" id="4377830">&amp;</span>&nbsp;<span class="num" id="4377832">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4377839">z</span><span class="op" id="4377840">.</span><span class="ident" id="4377841">high</span>&nbsp;<span class="op" id="4377846">&gt;&gt;=</span>&nbsp;<span class="num" id="4377850">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4377855">z</span><span class="op" id="4377856">.</span><span class="ident" id="4377857">high</span>&nbsp;<span class="op" id="4377862">|=</span>&nbsp;<span class="ident" id="4377865">z</span><span class="op" id="4377866">.</span><span class="ident" id="4377867">low</span>&nbsp;<span class="op" id="4377871">&lt;&lt;</span>&nbsp;<span class="num" id="4377874">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4377880">z</span><span class="op" id="4377881">.</span><span class="ident" id="4377882">low</span>&nbsp;<span class="op" id="4377886">&gt;&gt;=</span>&nbsp;<span class="num" id="4377890">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4377895">z</span><span class="op" id="4377896">.</span><span class="ident" id="4377897">low</span>&nbsp;<span class="op" id="4377901">^=</span>&nbsp;<span class="ident" id="4377904">uint64</span><span class="op" id="4377910">(</span><span class="ident" id="4377911">gcmReductionTable</span><span class="op" id="4377928">[</span><span class="ident" id="4377929">msw</span><span class="op" id="4377932">]</span><span class="op" id="4377933">)</span>&nbsp;<span class="op" id="4377935">&lt;&lt;</span>&nbsp;<span class="num" id="4377938">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4377945">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4377989">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4378040">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378057">t</span>&nbsp;<span class="op" id="4378059">:=</span>&nbsp;<span class="op" id="4378062">&amp;</span><span class="ident" id="4378063">g</span><span class="op" id="4378064">.</span><span class="ident" id="4378065">productTable</span><span class="op" id="4378077">[</span><span class="ident" id="4378078">word</span><span class="op" id="4378082">&amp;</span><span class="num" id="4378083">0xf</span><span class="op" id="4378086">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378092">z</span><span class="op" id="4378093">.</span><span class="ident" id="4378094">low</span>&nbsp;<span class="op" id="4378098">^=</span>&nbsp;<span class="ident" id="4378101">t</span><span class="op" id="4378102">.</span><span class="ident" id="4378103">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378110">z</span><span class="op" id="4378111">.</span><span class="ident" id="4378112">high</span>&nbsp;<span class="op" id="4378117">^=</span>&nbsp;<span class="ident" id="4378120">t</span><span class="op" id="4378121">.</span><span class="ident" id="4378122">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378130">word</span>&nbsp;<span class="op" id="4378135">&gt;&gt;=</span>&nbsp;<span class="num" id="4378139">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4378143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4378146">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4378150">*</span><span class="ident" id="4378151">y</span>&nbsp;<span class="op" id="4378153">=</span>&nbsp;<span class="ident" id="4378155">z</span><br>
<span class="lineno"></span><span class="op" id="4378157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4378160">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment" id="4378235">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword" id="4378311">func</span>&nbsp;<span class="op" id="4378316">(</span><span class="ident" id="4378317">g</span>&nbsp;<span class="op" id="4378319">*</span><span class="ident" id="4378320">gcm</span><span class="op" id="4378323">)</span>&nbsp;<span class="ident" id="4378325">updateBlocks</span><span class="op" id="4378337">(</span><span class="ident" id="4378338">y</span>&nbsp;<span class="op" id="4378340">*</span><span class="ident" id="4378341">gcmFieldElement</span><span class="op" id="4378356">,</span>&nbsp;<span class="ident" id="4378358">blocks</span>&nbsp;<span class="op" id="4378365">[</span><span class="op" id="4378366">]</span><span class="builtintype" id="4378367">byte</span><span class="op" id="4378371">)</span>&nbsp;<span class="op" id="4378373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4378376">for</span>&nbsp;<span class="builtinfunc" id="4378380">len</span><span class="op" id="4378383">(</span><span class="ident" id="4378384">blocks</span><span class="op" id="4378390">)</span>&nbsp;<span class="op" id="4378392">&gt;</span>&nbsp;<span class="num" id="4378394">0</span>&nbsp;<span class="op" id="4378396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378400">y</span><span class="op" id="4378401">.</span><span class="ident" id="4378402">low</span>&nbsp;<span class="op" id="4378406">^=</span>&nbsp;<span class="ident" id="4378409">getUint64</span><span class="op" id="4378418">(</span><span class="ident" id="4378419">blocks</span><span class="op" id="4378425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378429">y</span><span class="op" id="4378430">.</span><span class="ident" id="4378431">high</span>&nbsp;<span class="op" id="4378436">^=</span>&nbsp;<span class="ident" id="4378439">getUint64</span><span class="op" id="4378448">(</span><span class="ident" id="4378449">blocks</span><span class="op" id="4378455">[</span><span class="num" id="4378456">8</span><span class="op" id="4378457">:</span><span class="op" id="4378458">]</span><span class="op" id="4378459">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378463">g</span><span class="op" id="4378464">.</span><span class="ident" id="4378465">mul</span><span class="op" id="4378468">(</span><span class="ident" id="4378469">y</span><span class="op" id="4378470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378474">blocks</span>&nbsp;<span class="op" id="4378481">=</span>&nbsp;<span class="ident" id="4378483">blocks</span><span class="op" id="4378489">[</span><span class="ident" id="4378490">gcmBlockSize</span><span class="op" id="4378502">:</span><span class="op" id="4378503">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4378506">}</span><br>
<span class="lineno"></span><span class="op" id="4378508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment" id="4378511">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4378586">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword" id="4378660">func</span>&nbsp;<span class="op" id="4378665">(</span><span class="ident" id="4378666">g</span>&nbsp;<span class="op" id="4378668">*</span><span class="ident" id="4378669">gcm</span><span class="op" id="4378672">)</span>&nbsp;<span class="ident" id="4378674">update</span><span class="op" id="4378680">(</span><span class="ident" id="4378681">y</span>&nbsp;<span class="op" id="4378683">*</span><span class="ident" id="4378684">gcmFieldElement</span><span class="op" id="4378699">,</span>&nbsp;<span class="ident" id="4378701">data</span>&nbsp;<span class="op" id="4378706">[</span><span class="op" id="4378707">]</span><span class="builtintype" id="4378708">byte</span><span class="op" id="4378712">)</span>&nbsp;<span class="op" id="4378714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378717">fullBlocks</span>&nbsp;<span class="op" id="4378728">:=</span>&nbsp;<span class="op" id="4378731">(</span><span class="builtinfunc" id="4378732">len</span><span class="op" id="4378735">(</span><span class="ident" id="4378736">data</span><span class="op" id="4378740">)</span>&nbsp;<span class="op" id="4378742">&gt;&gt;</span>&nbsp;<span class="num" id="4378745">4</span><span class="op" id="4378746">)</span>&nbsp;<span class="op" id="4378748">&lt;&lt;</span>&nbsp;<span class="num" id="4378751">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378754">g</span><span class="op" id="4378755">.</span><span class="ident" id="4378756">updateBlocks</span><span class="op" id="4378768">(</span><span class="ident" id="4378769">y</span><span class="op" id="4378770">,</span>&nbsp;<span class="ident" id="4378772">data</span><span class="op" id="4378776">[</span><span class="op" id="4378777">:</span><span class="ident" id="4378778">fullBlocks</span><span class="op" id="4378788">]</span><span class="op" id="4378789">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4378793">if</span>&nbsp;<span class="builtinfunc" id="4378796">len</span><span class="op" id="4378799">(</span><span class="ident" id="4378800">data</span><span class="op" id="4378804">)</span>&nbsp;<span class="op" id="4378806">!=</span>&nbsp;<span class="ident" id="4378809">fullBlocks</span>&nbsp;<span class="op" id="4378820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4378824">var</span>&nbsp;<span class="ident" id="4378828">partialBlock</span>&nbsp;<span class="op" id="4378841">[</span><span class="ident" id="4378842">gcmBlockSize</span><span class="op" id="4378854">]</span><span class="builtintype" id="4378855">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4378862">copy</span><span class="op" id="4378866">(</span><span class="ident" id="4378867">partialBlock</span><span class="op" id="4378879">[</span><span class="op" id="4378880">:</span><span class="op" id="4378881">]</span><span class="op" id="4378882">,</span>&nbsp;<span class="ident" id="4378884">data</span><span class="op" id="4378888">[</span><span class="ident" id="4378889">fullBlocks</span><span class="op" id="4378899">:</span><span class="op" id="4378900">]</span><span class="op" id="4378901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4378905">g</span><span class="op" id="4378906">.</span><span class="ident" id="4378907">updateBlocks</span><span class="op" id="4378919">(</span><span class="ident" id="4378920">y</span><span class="op" id="4378921">,</span>&nbsp;<span class="ident" id="4378923">partialBlock</span><span class="op" id="4378935">[</span><span class="op" id="4378936">:</span><span class="op" id="4378937">]</span><span class="op" id="4378938">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4378941">}</span><br>
<span class="lineno"></span><span class="op" id="4378943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4378946">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="4379024">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword" id="4379046">func</span>&nbsp;<span class="ident" id="4379051">gcmInc32</span><span class="op" id="4379059">(</span><span class="ident" id="4379060">counterBlock</span>&nbsp;<span class="op" id="4379073">*</span><span class="op" id="4379074">[</span><span class="num" id="4379075">16</span><span class="op" id="4379077">]</span><span class="builtintype" id="4379078">byte</span><span class="op" id="4379082">)</span>&nbsp;<span class="op" id="4379084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4379087">for</span>&nbsp;<span class="ident" id="4379091">i</span>&nbsp;<span class="op" id="4379093">:=</span>&nbsp;<span class="ident" id="4379096">gcmBlockSize</span>&nbsp;<span class="op" id="4379109">-</span>&nbsp;<span class="num" id="4379111">1</span><span class="op" id="4379112">;</span>&nbsp;<span class="ident" id="4379114">i</span>&nbsp;<span class="op" id="4379116">&gt;=</span>&nbsp;<span class="ident" id="4379119">gcmBlockSize</span><span class="op" id="4379131">-</span><span class="num" id="4379132">4</span><span class="op" id="4379133">;</span>&nbsp;<span class="ident" id="4379135">i</span><span class="op" id="4379136">--</span>&nbsp;<span class="op" id="4379139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4379143">counterBlock</span><span class="op" id="4379155">[</span><span class="ident" id="4379156">i</span><span class="op" id="4379157">]</span><span class="op" id="4379158">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4379163">if</span>&nbsp;<span class="ident" id="4379166">counterBlock</span><span class="op" id="4379178">[</span><span class="ident" id="4379179">i</span><span class="op" id="4379180">]</span>&nbsp;<span class="op" id="4379182">!=</span>&nbsp;<span class="num" id="4379185">0</span>&nbsp;<span class="op" id="4379187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4379192">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4379200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4379203">}</span><br>
<span class="lineno"></span><span class="op" id="4379205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4379208">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment" id="4379286">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4379366">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4379445">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="4379520">func</span>&nbsp;<span class="ident" id="4379525">sliceForAppend</span><span class="op" id="4379539">(</span><span class="ident" id="4379540">in</span>&nbsp;<span class="op" id="4379543">[</span><span class="op" id="4379544">]</span><span class="builtintype" id="4379545">byte</span><span class="op" id="4379549">,</span>&nbsp;<span class="ident" id="4379551">n</span>&nbsp;<span class="builtintype" id="4379553">int</span><span class="op" id="4379556">)</span>&nbsp;<span class="op" id="4379558">(</span><span class="ident" id="4379559">head</span><span class="op" id="4379563">,</span>&nbsp;<span class="ident" id="4379565">tail</span>&nbsp;<span class="op" id="4379570">[</span><span class="op" id="4379571">]</span><span class="builtintype" id="4379572">byte</span><span class="op" id="4379576">)</span>&nbsp;<span class="op" id="4379578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4379581">if</span>&nbsp;<span class="ident" id="4379584">total</span>&nbsp;<span class="op" id="4379590">:=</span>&nbsp;<span class="builtinfunc" id="4379593">len</span><span class="op" id="4379596">(</span><span class="ident" id="4379597">in</span><span class="op" id="4379599">)</span>&nbsp;<span class="op" id="4379601">+</span>&nbsp;<span class="ident" id="4379603">n</span><span class="op" id="4379604">;</span>&nbsp;<span class="builtinfunc" id="4379606">cap</span><span class="op" id="4379609">(</span><span class="ident" id="4379610">in</span><span class="op" id="4379612">)</span>&nbsp;<span class="op" id="4379614">&gt;=</span>&nbsp;<span class="ident" id="4379617">total</span>&nbsp;<span class="op" id="4379623">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4379627">head</span>&nbsp;<span class="op" id="4379632">=</span>&nbsp;<span class="ident" id="4379634">in</span><span class="op" id="4379636">[</span><span class="op" id="4379637">:</span><span class="ident" id="4379638">total</span><span class="op" id="4379643">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4379646">}</span>&nbsp;<span class="keyword" id="4379648">else</span>&nbsp;<span class="op" id="4379653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4379657">head</span>&nbsp;<span class="op" id="4379662">=</span>&nbsp;<span class="builtinfunc" id="4379664">make</span><span class="op" id="4379668">(</span><span class="op" id="4379669">[</span><span class="op" id="4379670">]</span><span class="builtintype" id="4379671">byte</span><span class="op" id="4379675">,</span>&nbsp;<span class="ident" id="4379677">total</span><span class="op" id="4379682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4379686">copy</span><span class="op" id="4379690">(</span><span class="ident" id="4379691">head</span><span class="op" id="4379695">,</span>&nbsp;<span class="ident" id="4379697">in</span><span class="op" id="4379699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4379702">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4379705">tail</span>&nbsp;<span class="op" id="4379710">=</span>&nbsp;<span class="ident" id="4379712">head</span><span class="op" id="4379716">[</span><span class="builtinfunc" id="4379717">len</span><span class="op" id="4379720">(</span><span class="ident" id="4379721">in</span><span class="op" id="4379723">)</span><span class="op" id="4379724">:</span><span class="op" id="4379725">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4379728">return</span><br>
<span class="lineno"></span><span class="op" id="4379735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4379738">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword" id="4379803">func</span>&nbsp;<span class="op" id="4379808">(</span><span class="ident" id="4379809">g</span>&nbsp;<span class="op" id="4379811">*</span><span class="ident" id="4379812">gcm</span><span class="op" id="4379815">)</span>&nbsp;<span class="ident" id="4379817">counterCrypt</span><span class="op" id="4379829">(</span><span class="ident" id="4379830">out</span><span class="op" id="4379833">,</span>&nbsp;<span class="ident" id="4379835">in</span>&nbsp;<span class="op" id="4379838">[</span><span class="op" id="4379839">]</span><span class="builtintype" id="4379840">byte</span><span class="op" id="4379844">,</span>&nbsp;<span class="ident" id="4379846">counter</span>&nbsp;<span class="op" id="4379854">*</span><span class="op" id="4379855">[</span><span class="ident" id="4379856">gcmBlockSize</span><span class="op" id="4379868">]</span><span class="builtintype" id="4379869">byte</span><span class="op" id="4379873">)</span>&nbsp;<span class="op" id="4379875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4379878">var</span>&nbsp;<span class="ident" id="4379882">mask</span>&nbsp;<span class="op" id="4379887">[</span><span class="ident" id="4379888">gcmBlockSize</span><span class="op" id="4379900">]</span><span class="builtintype" id="4379901">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4379908">for</span>&nbsp;<span class="builtinfunc" id="4379912">len</span><span class="op" id="4379915">(</span><span class="ident" id="4379916">in</span><span class="op" id="4379918">)</span>&nbsp;<span class="op" id="4379920">&gt;=</span>&nbsp;<span class="ident" id="4379923">gcmBlockSize</span>&nbsp;<span class="op" id="4379936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4379940">g</span><span class="op" id="4379941">.</span><span class="ident" id="4379942">cipher</span><span class="op" id="4379948">.</span><span class="ident" id="4379949">Encrypt</span><span class="op" id="4379956">(</span><span class="ident" id="4379957">mask</span><span class="op" id="4379961">[</span><span class="op" id="4379962">:</span><span class="op" id="4379963">]</span><span class="op" id="4379964">,</span>&nbsp;<span class="ident" id="4379966">counter</span><span class="op" id="4379973">[</span><span class="op" id="4379974">:</span><span class="op" id="4379975">]</span><span class="op" id="4379976">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4379980">gcmInc32</span><span class="op" id="4379988">(</span><span class="ident" id="4379989">counter</span><span class="op" id="4379996">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380001">xorWords</span><span class="op" id="4380009">(</span><span class="ident" id="4380010">out</span><span class="op" id="4380013">,</span>&nbsp;<span class="ident" id="4380015">in</span><span class="op" id="4380017">,</span>&nbsp;<span class="ident" id="4380019">mask</span><span class="op" id="4380023">[</span><span class="op" id="4380024">:</span><span class="op" id="4380025">]</span><span class="op" id="4380026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380030">out</span>&nbsp;<span class="op" id="4380034">=</span>&nbsp;<span class="ident" id="4380036">out</span><span class="op" id="4380039">[</span><span class="ident" id="4380040">gcmBlockSize</span><span class="op" id="4380052">:</span><span class="op" id="4380053">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380057">in</span>&nbsp;<span class="op" id="4380060">=</span>&nbsp;<span class="ident" id="4380062">in</span><span class="op" id="4380064">[</span><span class="ident" id="4380065">gcmBlockSize</span><span class="op" id="4380077">:</span><span class="op" id="4380078">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4380081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4380085">if</span>&nbsp;<span class="builtinfunc" id="4380088">len</span><span class="op" id="4380091">(</span><span class="ident" id="4380092">in</span><span class="op" id="4380094">)</span>&nbsp;<span class="op" id="4380096">&gt;</span>&nbsp;<span class="num" id="4380098">0</span>&nbsp;<span class="op" id="4380100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380104">g</span><span class="op" id="4380105">.</span><span class="ident" id="4380106">cipher</span><span class="op" id="4380112">.</span><span class="ident" id="4380113">Encrypt</span><span class="op" id="4380120">(</span><span class="ident" id="4380121">mask</span><span class="op" id="4380125">[</span><span class="op" id="4380126">:</span><span class="op" id="4380127">]</span><span class="op" id="4380128">,</span>&nbsp;<span class="ident" id="4380130">counter</span><span class="op" id="4380137">[</span><span class="op" id="4380138">:</span><span class="op" id="4380139">]</span><span class="op" id="4380140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380144">gcmInc32</span><span class="op" id="4380152">(</span><span class="ident" id="4380153">counter</span><span class="op" id="4380160">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380164">xorBytes</span><span class="op" id="4380172">(</span><span class="ident" id="4380173">out</span><span class="op" id="4380176">,</span>&nbsp;<span class="ident" id="4380178">in</span><span class="op" id="4380180">,</span>&nbsp;<span class="ident" id="4380182">mask</span><span class="op" id="4380186">[</span><span class="op" id="4380187">:</span><span class="op" id="4380188">]</span><span class="op" id="4380189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4380192">}</span><br>
<span class="lineno"></span><span class="op" id="4380194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4380197">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment" id="4380273">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4380314">func</span>&nbsp;<span class="op" id="4380319">(</span><span class="ident" id="4380320">g</span>&nbsp;<span class="op" id="4380322">*</span><span class="ident" id="4380323">gcm</span><span class="op" id="4380326">)</span>&nbsp;<span class="ident" id="4380328">auth</span><span class="op" id="4380332">(</span><span class="ident" id="4380333">out</span><span class="op" id="4380336">,</span>&nbsp;<span class="ident" id="4380338">ciphertext</span><span class="op" id="4380348">,</span>&nbsp;<span class="ident" id="4380350">additionalData</span>&nbsp;<span class="op" id="4380365">[</span><span class="op" id="4380366">]</span><span class="builtintype" id="4380367">byte</span><span class="op" id="4380371">,</span>&nbsp;<span class="ident" id="4380373">tagMask</span>&nbsp;<span class="op" id="4380381">*</span><span class="op" id="4380382">[</span><span class="ident" id="4380383">gcmTagSize</span><span class="op" id="4380393">]</span><span class="builtintype" id="4380394">byte</span><span class="op" id="4380398">)</span>&nbsp;<span class="op" id="4380400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4380403">var</span>&nbsp;<span class="ident" id="4380407">y</span>&nbsp;<span class="ident" id="4380409">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380426">g</span><span class="op" id="4380427">.</span><span class="ident" id="4380428">update</span><span class="op" id="4380434">(</span><span class="op" id="4380435">&amp;</span><span class="ident" id="4380436">y</span><span class="op" id="4380437">,</span>&nbsp;<span class="ident" id="4380439">additionalData</span><span class="op" id="4380453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380456">g</span><span class="op" id="4380457">.</span><span class="ident" id="4380458">update</span><span class="op" id="4380464">(</span><span class="op" id="4380465">&amp;</span><span class="ident" id="4380466">y</span><span class="op" id="4380467">,</span>&nbsp;<span class="ident" id="4380469">ciphertext</span><span class="op" id="4380479">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380483">y</span><span class="op" id="4380484">.</span><span class="ident" id="4380485">low</span>&nbsp;<span class="op" id="4380489">^=</span>&nbsp;<span class="ident" id="4380492">uint64</span><span class="op" id="4380498">(</span><span class="builtinfunc" id="4380499">len</span><span class="op" id="4380502">(</span><span class="ident" id="4380503">additionalData</span><span class="op" id="4380517">)</span><span class="op" id="4380518">)</span>&nbsp;<span class="op" id="4380520">*</span>&nbsp;<span class="num" id="4380522">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380525">y</span><span class="op" id="4380526">.</span><span class="ident" id="4380527">high</span>&nbsp;<span class="op" id="4380532">^=</span>&nbsp;<span class="ident" id="4380535">uint64</span><span class="op" id="4380541">(</span><span class="builtinfunc" id="4380542">len</span><span class="op" id="4380545">(</span><span class="ident" id="4380546">ciphertext</span><span class="op" id="4380556">)</span><span class="op" id="4380557">)</span>&nbsp;<span class="op" id="4380559">*</span>&nbsp;<span class="num" id="4380561">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380565">g</span><span class="op" id="4380566">.</span><span class="ident" id="4380567">mul</span><span class="op" id="4380570">(</span><span class="op" id="4380571">&amp;</span><span class="ident" id="4380572">y</span><span class="op" id="4380573">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380577">putUint64</span><span class="op" id="4380586">(</span><span class="ident" id="4380587">out</span><span class="op" id="4380590">,</span>&nbsp;<span class="ident" id="4380592">y</span><span class="op" id="4380593">.</span><span class="ident" id="4380594">low</span><span class="op" id="4380597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380600">putUint64</span><span class="op" id="4380609">(</span><span class="ident" id="4380610">out</span><span class="op" id="4380613">[</span><span class="num" id="4380614">8</span><span class="op" id="4380615">:</span><span class="op" id="4380616">]</span><span class="op" id="4380617">,</span>&nbsp;<span class="ident" id="4380619">y</span><span class="op" id="4380620">.</span><span class="ident" id="4380621">high</span><span class="op" id="4380625">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380629">xorWords</span><span class="op" id="4380637">(</span><span class="ident" id="4380638">out</span><span class="op" id="4380641">,</span>&nbsp;<span class="ident" id="4380643">out</span><span class="op" id="4380646">,</span>&nbsp;<span class="ident" id="4380648">tagMask</span><span class="op" id="4380655">[</span><span class="op" id="4380656">:</span><span class="op" id="4380657">]</span><span class="op" id="4380658">)</span><br>
<span class="lineno">320</span><span class="op" id="4380660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4380663">func</span>&nbsp;<span class="ident" id="4380668">getUint64</span><span class="op" id="4380677">(</span><span class="ident" id="4380678">data</span>&nbsp;<span class="op" id="4380683">[</span><span class="op" id="4380684">]</span><span class="builtintype" id="4380685">byte</span><span class="op" id="4380689">)</span>&nbsp;<span class="ident" id="4380691">uint64</span>&nbsp;<span class="op" id="4380698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380701">r</span>&nbsp;<span class="op" id="4380703">:=</span>&nbsp;<span class="ident" id="4380706">uint64</span><span class="op" id="4380712">(</span><span class="ident" id="4380713">data</span><span class="op" id="4380717">[</span><span class="num" id="4380718">0</span><span class="op" id="4380719">]</span><span class="op" id="4380720">)</span><span class="op" id="4380721">&lt;&lt;</span><span class="num" id="4380723">56</span>&nbsp;<span class="op" id="4380726">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380730">uint64</span><span class="op" id="4380736">(</span><span class="ident" id="4380737">data</span><span class="op" id="4380741">[</span><span class="num" id="4380742">1</span><span class="op" id="4380743">]</span><span class="op" id="4380744">)</span><span class="op" id="4380745">&lt;&lt;</span><span class="num" id="4380747">48</span>&nbsp;<span class="op" id="4380750">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380754">uint64</span><span class="op" id="4380760">(</span><span class="ident" id="4380761">data</span><span class="op" id="4380765">[</span><span class="num" id="4380766">2</span><span class="op" id="4380767">]</span><span class="op" id="4380768">)</span><span class="op" id="4380769">&lt;&lt;</span><span class="num" id="4380771">40</span>&nbsp;<span class="op" id="4380774">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380778">uint64</span><span class="op" id="4380784">(</span><span class="ident" id="4380785">data</span><span class="op" id="4380789">[</span><span class="num" id="4380790">3</span><span class="op" id="4380791">]</span><span class="op" id="4380792">)</span><span class="op" id="4380793">&lt;&lt;</span><span class="num" id="4380795">32</span>&nbsp;<span class="op" id="4380798">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380802">uint64</span><span class="op" id="4380808">(</span><span class="ident" id="4380809">data</span><span class="op" id="4380813">[</span><span class="num" id="4380814">4</span><span class="op" id="4380815">]</span><span class="op" id="4380816">)</span><span class="op" id="4380817">&lt;&lt;</span><span class="num" id="4380819">24</span>&nbsp;<span class="op" id="4380822">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380826">uint64</span><span class="op" id="4380832">(</span><span class="ident" id="4380833">data</span><span class="op" id="4380837">[</span><span class="num" id="4380838">5</span><span class="op" id="4380839">]</span><span class="op" id="4380840">)</span><span class="op" id="4380841">&lt;&lt;</span><span class="num" id="4380843">16</span>&nbsp;<span class="op" id="4380846">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380850">uint64</span><span class="op" id="4380856">(</span><span class="ident" id="4380857">data</span><span class="op" id="4380861">[</span><span class="num" id="4380862">6</span><span class="op" id="4380863">]</span><span class="op" id="4380864">)</span><span class="op" id="4380865">&lt;&lt;</span><span class="num" id="4380867">8</span>&nbsp;<span class="op" id="4380869">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380873">uint64</span><span class="op" id="4380879">(</span><span class="ident" id="4380880">data</span><span class="op" id="4380884">[</span><span class="num" id="4380885">7</span><span class="op" id="4380886">]</span><span class="op" id="4380887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4380890">return</span>&nbsp;<span class="ident" id="4380897">r</span><br>
<span class="lineno"></span><span class="op" id="4380899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4380902">func</span>&nbsp;<span class="ident" id="4380907">putUint64</span><span class="op" id="4380916">(</span><span class="ident" id="4380917">out</span>&nbsp;<span class="op" id="4380921">[</span><span class="op" id="4380922">]</span><span class="builtintype" id="4380923">byte</span><span class="op" id="4380927">,</span>&nbsp;<span class="ident" id="4380929">v</span>&nbsp;<span class="ident" id="4380931">uint64</span><span class="op" id="4380937">)</span>&nbsp;<span class="op" id="4380939">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380942">out</span><span class="op" id="4380945">[</span><span class="num" id="4380946">0</span><span class="op" id="4380947">]</span>&nbsp;<span class="op" id="4380949">=</span>&nbsp;<span class="builtintype" id="4380951">byte</span><span class="op" id="4380955">(</span><span class="ident" id="4380956">v</span>&nbsp;<span class="op" id="4380958">&gt;&gt;</span>&nbsp;<span class="num" id="4380961">56</span><span class="op" id="4380963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380966">out</span><span class="op" id="4380969">[</span><span class="num" id="4380970">1</span><span class="op" id="4380971">]</span>&nbsp;<span class="op" id="4380973">=</span>&nbsp;<span class="builtintype" id="4380975">byte</span><span class="op" id="4380979">(</span><span class="ident" id="4380980">v</span>&nbsp;<span class="op" id="4380982">&gt;&gt;</span>&nbsp;<span class="num" id="4380985">48</span><span class="op" id="4380987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4380990">out</span><span class="op" id="4380993">[</span><span class="num" id="4380994">2</span><span class="op" id="4380995">]</span>&nbsp;<span class="op" id="4380997">=</span>&nbsp;<span class="builtintype" id="4380999">byte</span><span class="op" id="4381003">(</span><span class="ident" id="4381004">v</span>&nbsp;<span class="op" id="4381006">&gt;&gt;</span>&nbsp;<span class="num" id="4381009">40</span><span class="op" id="4381011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4381014">out</span><span class="op" id="4381017">[</span><span class="num" id="4381018">3</span><span class="op" id="4381019">]</span>&nbsp;<span class="op" id="4381021">=</span>&nbsp;<span class="builtintype" id="4381023">byte</span><span class="op" id="4381027">(</span><span class="ident" id="4381028">v</span>&nbsp;<span class="op" id="4381030">&gt;&gt;</span>&nbsp;<span class="num" id="4381033">32</span><span class="op" id="4381035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4381038">out</span><span class="op" id="4381041">[</span><span class="num" id="4381042">4</span><span class="op" id="4381043">]</span>&nbsp;<span class="op" id="4381045">=</span>&nbsp;<span class="builtintype" id="4381047">byte</span><span class="op" id="4381051">(</span><span class="ident" id="4381052">v</span>&nbsp;<span class="op" id="4381054">&gt;&gt;</span>&nbsp;<span class="num" id="4381057">24</span><span class="op" id="4381059">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4381062">out</span><span class="op" id="4381065">[</span><span class="num" id="4381066">5</span><span class="op" id="4381067">]</span>&nbsp;<span class="op" id="4381069">=</span>&nbsp;<span class="builtintype" id="4381071">byte</span><span class="op" id="4381075">(</span><span class="ident" id="4381076">v</span>&nbsp;<span class="op" id="4381078">&gt;&gt;</span>&nbsp;<span class="num" id="4381081">16</span><span class="op" id="4381083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4381086">out</span><span class="op" id="4381089">[</span><span class="num" id="4381090">6</span><span class="op" id="4381091">]</span>&nbsp;<span class="op" id="4381093">=</span>&nbsp;<span class="builtintype" id="4381095">byte</span><span class="op" id="4381099">(</span><span class="ident" id="4381100">v</span>&nbsp;<span class="op" id="4381102">&gt;&gt;</span>&nbsp;<span class="num" id="4381105">8</span><span class="op" id="4381106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4381109">out</span><span class="op" id="4381112">[</span><span class="num" id="4381113">7</span><span class="op" id="4381114">]</span>&nbsp;<span class="op" id="4381116">=</span>&nbsp;<span class="builtintype" id="4381118">byte</span><span class="op" id="4381122">(</span><span class="ident" id="4381123">v</span><span class="op" id="4381124">)</span><br>
<span class="lineno"></span><span class="op" id="4381126">}</span>
</div>
</body>
</html>
