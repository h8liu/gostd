<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html" class="current">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4325704">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4325759">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4325813">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4325864">package</span>&nbsp;<span class="ident" id="4325872">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4325882">import</span>&nbsp;<span class="op" id="4325889">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4325892">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4325901">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4325908">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4325916">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4325922">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4325939">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="4325961">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4325964">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4326025">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="4326096">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4326186">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="4326254">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="4326267">func</span>&nbsp;<span class="ident" id="4326272">escapeTemplate</span><span class="op" id="4326286">(</span><span class="ident" id="4326287">tmpl</span>&nbsp;<span class="op" id="4326292">*</span><span class="ident" id="4326293">Template</span><span class="op" id="4326301">,</span>&nbsp;<span class="ident" id="4326303">node</span>&nbsp;<span class="ident" id="4326308">parse</span><span class="op" id="4326313">.</span><span class="ident" id="4326314">Node</span><span class="op" id="4326318">,</span>&nbsp;<span class="ident" id="4326320">name</span>&nbsp;<span class="builtintype" id="4326325">string</span><span class="op" id="4326331">)</span>&nbsp;<span class="builtintype" id="4326333">error</span>&nbsp;<span class="op" id="4326339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326342">e</span>&nbsp;<span class="op" id="4326344">:=</span>&nbsp;<span class="ident" id="4326347">newEscaper</span><span class="op" id="4326357">(</span><span class="ident" id="4326358">tmpl</span><span class="op" id="4326362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326365">c</span><span class="op" id="4326366">,</span>&nbsp;<span class="ident" id="4326368">_</span>&nbsp;<span class="op" id="4326370">:=</span>&nbsp;<span class="ident" id="4326373">e</span><span class="op" id="4326374">.</span><span class="ident" id="4326375">escapeTree</span><span class="op" id="4326385">(</span><span class="ident" id="4326386">context</span><span class="op" id="4326393">{</span><span class="op" id="4326394">}</span><span class="op" id="4326395">,</span>&nbsp;<span class="ident" id="4326397">node</span><span class="op" id="4326401">,</span>&nbsp;<span class="ident" id="4326403">name</span><span class="op" id="4326407">,</span>&nbsp;<span class="num" id="4326409">0</span><span class="op" id="4326410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4326413">var</span>&nbsp;<span class="ident" id="4326417">err</span>&nbsp;<span class="builtintype" id="4326421">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4326428">if</span>&nbsp;<span class="ident" id="4326431">c</span><span class="op" id="4326432">.</span><span class="ident" id="4326433">err</span>&nbsp;<span class="op" id="4326437">!=</span>&nbsp;<span class="builtintype" id="4326440">nil</span>&nbsp;<span class="op" id="4326444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326448">err</span><span class="op" id="4326451">,</span>&nbsp;<span class="ident" id="4326453">c</span><span class="op" id="4326454">.</span><span class="ident" id="4326455">err</span><span class="op" id="4326458">.</span><span class="ident" id="4326459">Name</span>&nbsp;<span class="op" id="4326464">=</span>&nbsp;<span class="ident" id="4326466">c</span><span class="op" id="4326467">.</span><span class="ident" id="4326468">err</span><span class="op" id="4326471">,</span>&nbsp;<span class="ident" id="4326473">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4326479">}</span>&nbsp;<span class="keyword" id="4326481">else</span>&nbsp;<span class="keyword" id="4326486">if</span>&nbsp;<span class="ident" id="4326489">c</span><span class="op" id="4326490">.</span><span class="ident" id="4326491">state</span>&nbsp;<span class="op" id="4326497">!=</span>&nbsp;<span class="ident" id="4326500">stateText</span>&nbsp;<span class="op" id="4326510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326514">err</span>&nbsp;<span class="op" id="4326518">=</span>&nbsp;<span class="op" id="4326520">&amp;</span><span class="ident" id="4326521">Error</span><span class="op" id="4326526">{</span><span class="ident" id="4326527">ErrEndContext</span><span class="op" id="4326540">,</span>&nbsp;<span class="builtintype" id="4326542">nil</span><span class="op" id="4326545">,</span>&nbsp;<span class="ident" id="4326547">name</span><span class="op" id="4326551">,</span>&nbsp;<span class="num" id="4326553">0</span><span class="op" id="4326554">,</span>&nbsp;<span class="ident" id="4326556">fmt</span><span class="op" id="4326559">.</span><span class="ident" id="4326560">Sprintf</span><span class="op" id="4326567">(</span><span class="string" id="4326568">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="4326600">,</span>&nbsp;<span class="ident" id="4326602">c</span><span class="op" id="4326603">)</span><span class="op" id="4326604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4326607">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4326610">if</span>&nbsp;<span class="ident" id="4326613">err</span>&nbsp;<span class="op" id="4326617">!=</span>&nbsp;<span class="builtintype" id="4326620">nil</span>&nbsp;<span class="op" id="4326624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4326628">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4326672">if</span>&nbsp;<span class="ident" id="4326675">t</span>&nbsp;<span class="op" id="4326677">:=</span>&nbsp;<span class="ident" id="4326680">tmpl</span><span class="op" id="4326684">.</span><span class="ident" id="4326685">set</span><span class="op" id="4326688">[</span><span class="ident" id="4326689">name</span><span class="op" id="4326693">]</span><span class="op" id="4326694">;</span>&nbsp;<span class="ident" id="4326696">t</span>&nbsp;<span class="op" id="4326698">!=</span>&nbsp;<span class="builtintype" id="4326701">nil</span>&nbsp;<span class="op" id="4326705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326710">t</span><span class="op" id="4326711">.</span><span class="ident" id="4326712">escapeErr</span>&nbsp;<span class="op" id="4326722">=</span>&nbsp;<span class="ident" id="4326724">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326731">t</span><span class="op" id="4326732">.</span><span class="ident" id="4326733">text</span><span class="op" id="4326737">.</span><span class="ident" id="4326738">Tree</span>&nbsp;<span class="op" id="4326743">=</span>&nbsp;<span class="builtintype" id="4326745">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326752">t</span><span class="op" id="4326753">.</span><span class="ident" id="4326754">Tree</span>&nbsp;<span class="op" id="4326759">=</span>&nbsp;<span class="builtintype" id="4326761">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4326767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4326771">return</span>&nbsp;<span class="ident" id="4326778">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4326783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326786">e</span><span class="op" id="4326787">.</span><span class="ident" id="4326788">commit</span><span class="op" id="4326794">(</span><span class="op" id="4326795">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4326798">if</span>&nbsp;<span class="ident" id="4326801">t</span>&nbsp;<span class="op" id="4326803">:=</span>&nbsp;<span class="ident" id="4326806">tmpl</span><span class="op" id="4326810">.</span><span class="ident" id="4326811">set</span><span class="op" id="4326814">[</span><span class="ident" id="4326815">name</span><span class="op" id="4326819">]</span><span class="op" id="4326820">;</span>&nbsp;<span class="ident" id="4326822">t</span>&nbsp;<span class="op" id="4326824">!=</span>&nbsp;<span class="builtintype" id="4326827">nil</span>&nbsp;<span class="op" id="4326831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326835">t</span><span class="op" id="4326836">.</span><span class="ident" id="4326837">escapeErr</span>&nbsp;<span class="op" id="4326847">=</span>&nbsp;<span class="ident" id="4326849">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4326860">t</span><span class="op" id="4326861">.</span><span class="ident" id="4326862">Tree</span>&nbsp;<span class="op" id="4326867">=</span>&nbsp;<span class="ident" id="4326869">t</span><span class="op" id="4326870">.</span><span class="ident" id="4326871">text</span><span class="op" id="4326875">.</span><span class="ident" id="4326876">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4326882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4326885">return</span>&nbsp;<span class="builtintype" id="4326892">nil</span><br>
<span class="lineno">45</span><span class="op" id="4326896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4326899">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="4326973">var</span>&nbsp;<span class="ident" id="4326977">funcMap</span>&nbsp;<span class="op" id="4326985">=</span>&nbsp;<span class="ident" id="4326987">template</span><span class="op" id="4326995">.</span><span class="ident" id="4326996">FuncMap</span><span class="op" id="4327003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327006">&#34;html_template_attrescaper&#34;</span><span class="op" id="4327033">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4327039">attrEscaper</span><span class="op" id="4327050">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327053">&#34;html_template_commentescaper&#34;</span><span class="op" id="4327083">:</span>&nbsp;&nbsp;<span class="ident" id="4327086">commentEscaper</span><span class="op" id="4327100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327103">&#34;html_template_cssescaper&#34;</span><span class="op" id="4327129">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4327136">cssEscaper</span><span class="op" id="4327146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327149">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="4327179">:</span>&nbsp;&nbsp;<span class="ident" id="4327182">cssValueFilter</span><span class="op" id="4327196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327199">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="4327229">:</span>&nbsp;&nbsp;<span class="ident" id="4327232">htmlNameFilter</span><span class="op" id="4327246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327249">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4327276">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4327282">htmlEscaper</span><span class="op" id="4327293">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327296">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4327327">:</span>&nbsp;<span class="ident" id="4327329">jsRegexpEscaper</span><span class="op" id="4327344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327347">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4327375">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4327380">jsStrEscaper</span><span class="op" id="4327392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327395">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="4327423">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4327428">jsValEscaper</span><span class="op" id="4327440">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327443">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4327473">:</span>&nbsp;&nbsp;<span class="ident" id="4327476">htmlNospaceEscaper</span><span class="op" id="4327494">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327497">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4327526">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4327530">rcdataEscaper</span><span class="op" id="4327543">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327546">&#34;html_template_urlescaper&#34;</span><span class="op" id="4327572">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4327579">urlEscaper</span><span class="op" id="4327589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327592">&#34;html_template_urlfilter&#34;</span><span class="op" id="4327617">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4327625">urlFilter</span><span class="op" id="4327634">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327637">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4327666">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4327670">urlNormalizer</span><span class="op" id="4327683">,</span><br>
<span class="lineno"></span><span class="op" id="4327685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4327688">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="4327766">var</span>&nbsp;<span class="ident" id="4327770">equivEscapers</span>&nbsp;<span class="op" id="4327784">=</span>&nbsp;<span class="keyword" id="4327786">map</span><span class="op" id="4327789">[</span><span class="builtintype" id="4327790">string</span><span class="op" id="4327796">]</span><span class="builtintype" id="4327797">string</span><span class="op" id="4327803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327806">&#34;html_template_attrescaper&#34;</span><span class="op" id="4327833">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327838">&#34;html&#34;</span><span class="op" id="4327844">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327847">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4327874">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327879">&#34;html&#34;</span><span class="op" id="4327885">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327888">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4327918">:</span>&nbsp;<span class="string" id="4327920">&#34;html&#34;</span><span class="op" id="4327926">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327929">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4327958">:</span>&nbsp;&nbsp;<span class="string" id="4327961">&#34;html&#34;</span><span class="op" id="4327967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4327970">&#34;html_template_urlescaper&#34;</span><span class="op" id="4327996">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4328002">&#34;urlquery&#34;</span><span class="op" id="4328012">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4328015">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4328044">:</span>&nbsp;&nbsp;<span class="string" id="4328047">&#34;urlquery&#34;</span><span class="op" id="4328057">,</span><br>
<span class="lineno"></span><span class="op" id="4328059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4328062">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="4328141">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="4328170">type</span>&nbsp;<span class="ident" id="4328175">escaper</span>&nbsp;<span class="keyword" id="4328183">struct</span>&nbsp;<span class="op" id="4328190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4328193">tmpl</span>&nbsp;<span class="op" id="4328198">*</span><span class="ident" id="4328199">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4328209">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4328280">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4328331">output</span>&nbsp;<span class="keyword" id="4328338">map</span><span class="op" id="4328341">[</span><span class="builtintype" id="4328342">string</span><span class="op" id="4328348">]</span><span class="ident" id="4328349">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4328358">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4328431">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4328484">derived</span>&nbsp;<span class="keyword" id="4328492">map</span><span class="op" id="4328495">[</span><span class="builtintype" id="4328496">string</span><span class="op" id="4328502">]</span><span class="op" id="4328503">*</span><span class="ident" id="4328504">template</span><span class="op" id="4328512">.</span><span class="ident" id="4328513">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4328523">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4328591">called</span>&nbsp;<span class="keyword" id="4328598">map</span><span class="op" id="4328601">[</span><span class="builtintype" id="4328602">string</span><span class="op" id="4328608">]</span><span class="builtintype" id="4328609">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4328615">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4328682">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4328748">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4328810">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="4328828">map</span><span class="op" id="4328831">[</span><span class="op" id="4328832">*</span><span class="ident" id="4328833">parse</span><span class="op" id="4328838">.</span><span class="ident" id="4328839">ActionNode</span><span class="op" id="4328849">]</span><span class="op" id="4328850">[</span><span class="op" id="4328851">]</span><span class="builtintype" id="4328852">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4328860">templateNodeEdits</span>&nbsp;<span class="keyword" id="4328878">map</span><span class="op" id="4328881">[</span><span class="op" id="4328882">*</span><span class="ident" id="4328883">parse</span><span class="op" id="4328888">.</span><span class="ident" id="4328889">TemplateNode</span><span class="op" id="4328901">]</span><span class="builtintype" id="4328902">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4328910">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4328928">map</span><span class="op" id="4328931">[</span><span class="op" id="4328932">*</span><span class="ident" id="4328933">parse</span><span class="op" id="4328938">.</span><span class="ident" id="4328939">TextNode</span><span class="op" id="4328947">]</span><span class="op" id="4328948">[</span><span class="op" id="4328949">]</span><span class="builtintype" id="4328950">byte</span><br>
<span class="lineno"></span><span class="op" id="4328955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4328958">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="4329015">func</span>&nbsp;<span class="ident" id="4329020">newEscaper</span><span class="op" id="4329030">(</span><span class="ident" id="4329031">t</span>&nbsp;<span class="op" id="4329033">*</span><span class="ident" id="4329034">Template</span><span class="op" id="4329042">)</span>&nbsp;<span class="op" id="4329044">*</span><span class="ident" id="4329045">escaper</span>&nbsp;<span class="op" id="4329053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329056">return</span>&nbsp;<span class="op" id="4329063">&amp;</span><span class="ident" id="4329064">escaper</span><span class="op" id="4329071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4329075">t</span><span class="op" id="4329076">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329080">map</span><span class="op" id="4329083">[</span><span class="builtintype" id="4329084">string</span><span class="op" id="4329090">]</span><span class="ident" id="4329091">context</span><span class="op" id="4329098">{</span><span class="op" id="4329099">}</span><span class="op" id="4329100">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329104">map</span><span class="op" id="4329107">[</span><span class="builtintype" id="4329108">string</span><span class="op" id="4329114">]</span><span class="op" id="4329115">*</span><span class="ident" id="4329116">template</span><span class="op" id="4329124">.</span><span class="ident" id="4329125">Template</span><span class="op" id="4329133">{</span><span class="op" id="4329134">}</span><span class="op" id="4329135">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329139">map</span><span class="op" id="4329142">[</span><span class="builtintype" id="4329143">string</span><span class="op" id="4329149">]</span><span class="builtintype" id="4329150">bool</span><span class="op" id="4329154">{</span><span class="op" id="4329155">}</span><span class="op" id="4329156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329160">map</span><span class="op" id="4329163">[</span><span class="op" id="4329164">*</span><span class="ident" id="4329165">parse</span><span class="op" id="4329170">.</span><span class="ident" id="4329171">ActionNode</span><span class="op" id="4329181">]</span><span class="op" id="4329182">[</span><span class="op" id="4329183">]</span><span class="builtintype" id="4329184">string</span><span class="op" id="4329190">{</span><span class="op" id="4329191">}</span><span class="op" id="4329192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329196">map</span><span class="op" id="4329199">[</span><span class="op" id="4329200">*</span><span class="ident" id="4329201">parse</span><span class="op" id="4329206">.</span><span class="ident" id="4329207">TemplateNode</span><span class="op" id="4329219">]</span><span class="builtintype" id="4329220">string</span><span class="op" id="4329226">{</span><span class="op" id="4329227">}</span><span class="op" id="4329228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329232">map</span><span class="op" id="4329235">[</span><span class="op" id="4329236">*</span><span class="ident" id="4329237">parse</span><span class="op" id="4329242">.</span><span class="ident" id="4329243">TextNode</span><span class="op" id="4329251">]</span><span class="op" id="4329252">[</span><span class="op" id="4329253">]</span><span class="builtintype" id="4329254">byte</span><span class="op" id="4329258">{</span><span class="op" id="4329259">}</span><span class="op" id="4329260">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4329263">}</span><br>
<span class="lineno"></span><span class="op" id="4329265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4329268">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="4329349">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="4329425">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4329504">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="4329581">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="4329605">const</span>&nbsp;<span class="ident" id="4329611">filterFailsafe</span>&nbsp;<span class="op" id="4329626">=</span>&nbsp;<span class="string" id="4329628">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="4329640">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4329675">func</span>&nbsp;<span class="op" id="4329680">(</span><span class="ident" id="4329681">e</span>&nbsp;<span class="op" id="4329683">*</span><span class="ident" id="4329684">escaper</span><span class="op" id="4329691">)</span>&nbsp;<span class="ident" id="4329693">escape</span><span class="op" id="4329699">(</span><span class="ident" id="4329700">c</span>&nbsp;<span class="ident" id="4329702">context</span><span class="op" id="4329709">,</span>&nbsp;<span class="ident" id="4329711">n</span>&nbsp;<span class="ident" id="4329713">parse</span><span class="op" id="4329718">.</span><span class="ident" id="4329719">Node</span><span class="op" id="4329723">)</span>&nbsp;<span class="ident" id="4329725">context</span>&nbsp;<span class="op" id="4329733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329736">switch</span>&nbsp;<span class="ident" id="4329743">n</span>&nbsp;<span class="op" id="4329745">:=</span>&nbsp;<span class="ident" id="4329748">n</span><span class="op" id="4329749">.</span><span class="op" id="4329750">(</span><span class="keyword" id="4329751">type</span><span class="op" id="4329755">)</span>&nbsp;<span class="op" id="4329757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329760">case</span>&nbsp;<span class="op" id="4329765">*</span><span class="ident" id="4329766">parse</span><span class="op" id="4329771">.</span><span class="ident" id="4329772">ActionNode</span><span class="op" id="4329782">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329786">return</span>&nbsp;<span class="ident" id="4329793">e</span><span class="op" id="4329794">.</span><span class="ident" id="4329795">escapeAction</span><span class="op" id="4329807">(</span><span class="ident" id="4329808">c</span><span class="op" id="4329809">,</span>&nbsp;<span class="ident" id="4329811">n</span><span class="op" id="4329812">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329815">case</span>&nbsp;<span class="op" id="4329820">*</span><span class="ident" id="4329821">parse</span><span class="op" id="4329826">.</span><span class="ident" id="4329827">IfNode</span><span class="op" id="4329833">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329837">return</span>&nbsp;<span class="ident" id="4329844">e</span><span class="op" id="4329845">.</span><span class="ident" id="4329846">escapeBranch</span><span class="op" id="4329858">(</span><span class="ident" id="4329859">c</span><span class="op" id="4329860">,</span>&nbsp;<span class="op" id="4329862">&amp;</span><span class="ident" id="4329863">n</span><span class="op" id="4329864">.</span><span class="ident" id="4329865">BranchNode</span><span class="op" id="4329875">,</span>&nbsp;<span class="string" id="4329877">&#34;if&#34;</span><span class="op" id="4329881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329884">case</span>&nbsp;<span class="op" id="4329889">*</span><span class="ident" id="4329890">parse</span><span class="op" id="4329895">.</span><span class="ident" id="4329896">ListNode</span><span class="op" id="4329904">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329908">return</span>&nbsp;<span class="ident" id="4329915">e</span><span class="op" id="4329916">.</span><span class="ident" id="4329917">escapeList</span><span class="op" id="4329927">(</span><span class="ident" id="4329928">c</span><span class="op" id="4329929">,</span>&nbsp;<span class="ident" id="4329931">n</span><span class="op" id="4329932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329935">case</span>&nbsp;<span class="op" id="4329940">*</span><span class="ident" id="4329941">parse</span><span class="op" id="4329946">.</span><span class="ident" id="4329947">RangeNode</span><span class="op" id="4329956">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4329960">return</span>&nbsp;<span class="ident" id="4329967">e</span><span class="op" id="4329968">.</span><span class="ident" id="4329969">escapeBranch</span><span class="op" id="4329981">(</span><span class="ident" id="4329982">c</span><span class="op" id="4329983">,</span>&nbsp;<span class="op" id="4329985">&amp;</span><span class="ident" id="4329986">n</span><span class="op" id="4329987">.</span><span class="ident" id="4329988">BranchNode</span><span class="op" id="4329998">,</span>&nbsp;<span class="string" id="4330000">&#34;range&#34;</span><span class="op" id="4330007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330010">case</span>&nbsp;<span class="op" id="4330015">*</span><span class="ident" id="4330016">parse</span><span class="op" id="4330021">.</span><span class="ident" id="4330022">TemplateNode</span><span class="op" id="4330034">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330038">return</span>&nbsp;<span class="ident" id="4330045">e</span><span class="op" id="4330046">.</span><span class="ident" id="4330047">escapeTemplate</span><span class="op" id="4330061">(</span><span class="ident" id="4330062">c</span><span class="op" id="4330063">,</span>&nbsp;<span class="ident" id="4330065">n</span><span class="op" id="4330066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330069">case</span>&nbsp;<span class="op" id="4330074">*</span><span class="ident" id="4330075">parse</span><span class="op" id="4330080">.</span><span class="ident" id="4330081">TextNode</span><span class="op" id="4330089">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330093">return</span>&nbsp;<span class="ident" id="4330100">e</span><span class="op" id="4330101">.</span><span class="ident" id="4330102">escapeText</span><span class="op" id="4330112">(</span><span class="ident" id="4330113">c</span><span class="op" id="4330114">,</span>&nbsp;<span class="ident" id="4330116">n</span><span class="op" id="4330117">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330120">case</span>&nbsp;<span class="op" id="4330125">*</span><span class="ident" id="4330126">parse</span><span class="op" id="4330131">.</span><span class="ident" id="4330132">WithNode</span><span class="op" id="4330140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330144">return</span>&nbsp;<span class="ident" id="4330151">e</span><span class="op" id="4330152">.</span><span class="ident" id="4330153">escapeBranch</span><span class="op" id="4330165">(</span><span class="ident" id="4330166">c</span><span class="op" id="4330167">,</span>&nbsp;<span class="op" id="4330169">&amp;</span><span class="ident" id="4330170">n</span><span class="op" id="4330171">.</span><span class="ident" id="4330172">BranchNode</span><span class="op" id="4330182">,</span>&nbsp;<span class="string" id="4330184">&#34;with&#34;</span><span class="op" id="4330190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4330193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4330196">panic</span><span class="op" id="4330201">(</span><span class="string" id="4330202">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="4330214">+</span>&nbsp;<span class="ident" id="4330216">n</span><span class="op" id="4330217">.</span><span class="ident" id="4330218">String</span><span class="op" id="4330224">(</span><span class="op" id="4330225">)</span>&nbsp;<span class="op" id="4330227">+</span>&nbsp;<span class="string" id="4330229">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="4330248">)</span><br>
<span class="lineno"></span><span class="op" id="4330250">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="4330253">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4330302">func</span>&nbsp;<span class="op" id="4330307">(</span><span class="ident" id="4330308">e</span>&nbsp;<span class="op" id="4330310">*</span><span class="ident" id="4330311">escaper</span><span class="op" id="4330318">)</span>&nbsp;<span class="ident" id="4330320">escapeAction</span><span class="op" id="4330332">(</span><span class="ident" id="4330333">c</span>&nbsp;<span class="ident" id="4330335">context</span><span class="op" id="4330342">,</span>&nbsp;<span class="ident" id="4330344">n</span>&nbsp;<span class="op" id="4330346">*</span><span class="ident" id="4330347">parse</span><span class="op" id="4330352">.</span><span class="ident" id="4330353">ActionNode</span><span class="op" id="4330363">)</span>&nbsp;<span class="ident" id="4330365">context</span>&nbsp;<span class="op" id="4330373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330376">if</span>&nbsp;<span class="builtinfunc" id="4330379">len</span><span class="op" id="4330382">(</span><span class="ident" id="4330383">n</span><span class="op" id="4330384">.</span><span class="ident" id="4330385">Pipe</span><span class="op" id="4330389">.</span><span class="ident" id="4330390">Decl</span><span class="op" id="4330394">)</span>&nbsp;<span class="op" id="4330396">!=</span>&nbsp;<span class="num" id="4330399">0</span>&nbsp;<span class="op" id="4330401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4330405">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330461">return</span>&nbsp;<span class="ident" id="4330468">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4330471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4330474">c</span>&nbsp;<span class="op" id="4330476">=</span>&nbsp;<span class="ident" id="4330478">nudge</span><span class="op" id="4330483">(</span><span class="ident" id="4330484">c</span><span class="op" id="4330485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4330488">s</span>&nbsp;<span class="op" id="4330490">:=</span>&nbsp;<span class="builtinfunc" id="4330493">make</span><span class="op" id="4330497">(</span><span class="op" id="4330498">[</span><span class="op" id="4330499">]</span><span class="builtintype" id="4330500">string</span><span class="op" id="4330506">,</span>&nbsp;<span class="num" id="4330508">0</span><span class="op" id="4330509">,</span>&nbsp;<span class="num" id="4330511">3</span><span class="op" id="4330512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330515">switch</span>&nbsp;<span class="ident" id="4330522">c</span><span class="op" id="4330523">.</span><span class="ident" id="4330524">state</span>&nbsp;<span class="op" id="4330530">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330533">case</span>&nbsp;<span class="ident" id="4330538">stateError</span><span class="op" id="4330548">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330552">return</span>&nbsp;<span class="ident" id="4330559">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330562">case</span>&nbsp;<span class="ident" id="4330567">stateURL</span><span class="op" id="4330575">,</span>&nbsp;<span class="ident" id="4330577">stateCSSDqStr</span><span class="op" id="4330590">,</span>&nbsp;<span class="ident" id="4330592">stateCSSSqStr</span><span class="op" id="4330605">,</span>&nbsp;<span class="ident" id="4330607">stateCSSDqURL</span><span class="op" id="4330620">,</span>&nbsp;<span class="ident" id="4330622">stateCSSSqURL</span><span class="op" id="4330635">,</span>&nbsp;<span class="ident" id="4330637">stateCSSURL</span><span class="op" id="4330648">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330652">switch</span>&nbsp;<span class="ident" id="4330659">c</span><span class="op" id="4330660">.</span><span class="ident" id="4330661">urlPart</span>&nbsp;<span class="op" id="4330669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330673">case</span>&nbsp;<span class="ident" id="4330678">urlPartNone</span><span class="op" id="4330689">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4330694">s</span>&nbsp;<span class="op" id="4330696">=</span>&nbsp;<span class="builtinfunc" id="4330698">append</span><span class="op" id="4330704">(</span><span class="ident" id="4330705">s</span><span class="op" id="4330706">,</span>&nbsp;<span class="string" id="4330708">&#34;html_template_urlfilter&#34;</span><span class="op" id="4330733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330738">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330752">case</span>&nbsp;<span class="ident" id="4330757">urlPartPreQuery</span><span class="op" id="4330772">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330777">switch</span>&nbsp;<span class="ident" id="4330784">c</span><span class="op" id="4330785">.</span><span class="ident" id="4330786">state</span>&nbsp;<span class="op" id="4330792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330797">case</span>&nbsp;<span class="ident" id="4330802">stateCSSDqStr</span><span class="op" id="4330815">,</span>&nbsp;<span class="ident" id="4330817">stateCSSSqStr</span><span class="op" id="4330830">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4330836">s</span>&nbsp;<span class="op" id="4330838">=</span>&nbsp;<span class="builtinfunc" id="4330840">append</span><span class="op" id="4330846">(</span><span class="ident" id="4330847">s</span><span class="op" id="4330848">,</span>&nbsp;<span class="string" id="4330850">&#34;html_template_cssescaper&#34;</span><span class="op" id="4330876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330881">default</span><span class="op" id="4330888">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4330894">s</span>&nbsp;<span class="op" id="4330896">=</span>&nbsp;<span class="builtinfunc" id="4330898">append</span><span class="op" id="4330904">(</span><span class="ident" id="4330905">s</span><span class="op" id="4330906">,</span>&nbsp;<span class="string" id="4330908">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4330937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4330942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4330946">case</span>&nbsp;<span class="ident" id="4330951">urlPartQueryOrFrag</span><span class="op" id="4330969">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4330974">s</span>&nbsp;<span class="op" id="4330976">=</span>&nbsp;<span class="builtinfunc" id="4330978">append</span><span class="op" id="4330984">(</span><span class="ident" id="4330985">s</span><span class="op" id="4330986">,</span>&nbsp;<span class="string" id="4330988">&#34;html_template_urlescaper&#34;</span><span class="op" id="4331014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331018">case</span>&nbsp;<span class="ident" id="4331023">urlPartUnknown</span><span class="op" id="4331037">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331042">return</span>&nbsp;<span class="ident" id="4331049">context</span><span class="op" id="4331056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331062">state</span><span class="op" id="4331067">:</span>&nbsp;<span class="ident" id="4331069">stateError</span><span class="op" id="4331079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331085">err</span><span class="op" id="4331088">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4331092">errorf</span><span class="op" id="4331098">(</span><span class="ident" id="4331099">ErrAmbigContext</span><span class="op" id="4331114">,</span>&nbsp;<span class="ident" id="4331116">n</span><span class="op" id="4331117">,</span>&nbsp;<span class="ident" id="4331119">n</span><span class="op" id="4331120">.</span><span class="ident" id="4331121">Line</span><span class="op" id="4331125">,</span>&nbsp;<span class="string" id="4331127">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="4331167">,</span>&nbsp;<span class="ident" id="4331169">n</span><span class="op" id="4331170">)</span><span class="op" id="4331171">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4331176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331180">default</span><span class="op" id="4331187">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4331192">panic</span><span class="op" id="4331197">(</span><span class="ident" id="4331198">c</span><span class="op" id="4331199">.</span><span class="ident" id="4331200">urlPart</span><span class="op" id="4331207">.</span><span class="ident" id="4331208">String</span><span class="op" id="4331214">(</span><span class="op" id="4331215">)</span><span class="op" id="4331216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4331220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331223">case</span>&nbsp;<span class="ident" id="4331228">stateJS</span><span class="op" id="4331235">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331239">s</span>&nbsp;<span class="op" id="4331241">=</span>&nbsp;<span class="builtinfunc" id="4331243">append</span><span class="op" id="4331249">(</span><span class="ident" id="4331250">s</span><span class="op" id="4331251">,</span>&nbsp;<span class="string" id="4331253">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="4331281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4331285">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331335">c</span><span class="op" id="4331336">.</span><span class="ident" id="4331337">jsCtx</span>&nbsp;<span class="op" id="4331343">=</span>&nbsp;<span class="ident" id="4331345">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331357">case</span>&nbsp;<span class="ident" id="4331362">stateJSDqStr</span><span class="op" id="4331374">,</span>&nbsp;<span class="ident" id="4331376">stateJSSqStr</span><span class="op" id="4331388">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331392">s</span>&nbsp;<span class="op" id="4331394">=</span>&nbsp;<span class="builtinfunc" id="4331396">append</span><span class="op" id="4331402">(</span><span class="ident" id="4331403">s</span><span class="op" id="4331404">,</span>&nbsp;<span class="string" id="4331406">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4331434">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331437">case</span>&nbsp;<span class="ident" id="4331442">stateJSRegexp</span><span class="op" id="4331455">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331459">s</span>&nbsp;<span class="op" id="4331461">=</span>&nbsp;<span class="builtinfunc" id="4331463">append</span><span class="op" id="4331469">(</span><span class="ident" id="4331470">s</span><span class="op" id="4331471">,</span>&nbsp;<span class="string" id="4331473">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4331504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331507">case</span>&nbsp;<span class="ident" id="4331512">stateCSS</span><span class="op" id="4331520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331524">s</span>&nbsp;<span class="op" id="4331526">=</span>&nbsp;<span class="builtinfunc" id="4331528">append</span><span class="op" id="4331534">(</span><span class="ident" id="4331535">s</span><span class="op" id="4331536">,</span>&nbsp;<span class="string" id="4331538">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="4331568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331571">case</span>&nbsp;<span class="ident" id="4331576">stateText</span><span class="op" id="4331585">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331589">s</span>&nbsp;<span class="op" id="4331591">=</span>&nbsp;<span class="builtinfunc" id="4331593">append</span><span class="op" id="4331599">(</span><span class="ident" id="4331600">s</span><span class="op" id="4331601">,</span>&nbsp;<span class="string" id="4331603">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4331630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331633">case</span>&nbsp;<span class="ident" id="4331638">stateRCDATA</span><span class="op" id="4331649">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331653">s</span>&nbsp;<span class="op" id="4331655">=</span>&nbsp;<span class="builtinfunc" id="4331657">append</span><span class="op" id="4331663">(</span><span class="ident" id="4331664">s</span><span class="op" id="4331665">,</span>&nbsp;<span class="string" id="4331667">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4331696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331699">case</span>&nbsp;<span class="ident" id="4331704">stateAttr</span><span class="op" id="4331713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4331717">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331751">case</span>&nbsp;<span class="ident" id="4331756">stateAttrName</span><span class="op" id="4331769">,</span>&nbsp;<span class="ident" id="4331771">stateTag</span><span class="op" id="4331779">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331783">c</span><span class="op" id="4331784">.</span><span class="ident" id="4331785">state</span>&nbsp;<span class="op" id="4331791">=</span>&nbsp;<span class="ident" id="4331793">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331809">s</span>&nbsp;<span class="op" id="4331811">=</span>&nbsp;<span class="builtinfunc" id="4331813">append</span><span class="op" id="4331819">(</span><span class="ident" id="4331820">s</span><span class="op" id="4331821">,</span>&nbsp;<span class="string" id="4331823">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="4331853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331856">default</span><span class="op" id="4331863">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4331867">if</span>&nbsp;<span class="ident" id="4331870">isComment</span><span class="op" id="4331879">(</span><span class="ident" id="4331880">c</span><span class="op" id="4331881">.</span><span class="ident" id="4331882">state</span><span class="op" id="4331887">)</span>&nbsp;<span class="op" id="4331889">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4331894">s</span>&nbsp;<span class="op" id="4331896">=</span>&nbsp;<span class="builtinfunc" id="4331898">append</span><span class="op" id="4331904">(</span><span class="ident" id="4331905">s</span><span class="op" id="4331906">,</span>&nbsp;<span class="string" id="4331908">&#34;html_template_commentescaper&#34;</span><span class="op" id="4331938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4331942">}</span>&nbsp;<span class="keyword" id="4331944">else</span>&nbsp;<span class="op" id="4331949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4331954">panic</span><span class="op" id="4331959">(</span><span class="string" id="4331960">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="4331980">+</span>&nbsp;<span class="ident" id="4331982">c</span><span class="op" id="4331983">.</span><span class="ident" id="4331984">state</span><span class="op" id="4331989">.</span><span class="ident" id="4331990">String</span><span class="op" id="4331996">(</span><span class="op" id="4331997">)</span><span class="op" id="4331998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332005">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332008">switch</span>&nbsp;<span class="ident" id="4332015">c</span><span class="op" id="4332016">.</span><span class="ident" id="4332017">delim</span>&nbsp;<span class="op" id="4332023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332026">case</span>&nbsp;<span class="ident" id="4332031">delimNone</span><span class="op" id="4332040">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4332044">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332095">case</span>&nbsp;<span class="ident" id="4332100">delimSpaceOrTagEnd</span><span class="op" id="4332118">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332122">s</span>&nbsp;<span class="op" id="4332124">=</span>&nbsp;<span class="builtinfunc" id="4332126">append</span><span class="op" id="4332132">(</span><span class="ident" id="4332133">s</span><span class="op" id="4332134">,</span>&nbsp;<span class="string" id="4332136">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4332166">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332169">default</span><span class="op" id="4332176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332180">s</span>&nbsp;<span class="op" id="4332182">=</span>&nbsp;<span class="builtinfunc" id="4332184">append</span><span class="op" id="4332190">(</span><span class="ident" id="4332191">s</span><span class="op" id="4332192">,</span>&nbsp;<span class="string" id="4332194">&#34;html_template_attrescaper&#34;</span><span class="op" id="4332221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332227">e</span><span class="op" id="4332228">.</span><span class="ident" id="4332229">editActionNode</span><span class="op" id="4332243">(</span><span class="ident" id="4332244">n</span><span class="op" id="4332245">,</span>&nbsp;<span class="ident" id="4332247">s</span><span class="op" id="4332248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332251">return</span>&nbsp;<span class="ident" id="4332258">c</span><br>
<span class="lineno">205</span><span class="op" id="4332260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4332263">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="4332348">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="4332411">func</span>&nbsp;<span class="ident" id="4332416">allIdents</span><span class="op" id="4332425">(</span><span class="ident" id="4332426">node</span>&nbsp;<span class="ident" id="4332431">parse</span><span class="op" id="4332436">.</span><span class="ident" id="4332437">Node</span><span class="op" id="4332441">)</span>&nbsp;<span class="op" id="4332443">[</span><span class="op" id="4332444">]</span><span class="builtintype" id="4332445">string</span>&nbsp;<span class="op" id="4332452">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332455">switch</span>&nbsp;<span class="ident" id="4332462">node</span>&nbsp;<span class="op" id="4332467">:=</span>&nbsp;<span class="ident" id="4332470">node</span><span class="op" id="4332474">.</span><span class="op" id="4332475">(</span><span class="keyword" id="4332476">type</span><span class="op" id="4332480">)</span>&nbsp;<span class="op" id="4332482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332485">case</span>&nbsp;<span class="op" id="4332490">*</span><span class="ident" id="4332491">parse</span><span class="op" id="4332496">.</span><span class="ident" id="4332497">IdentifierNode</span><span class="op" id="4332511">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332515">return</span>&nbsp;<span class="op" id="4332522">[</span><span class="op" id="4332523">]</span><span class="builtintype" id="4332524">string</span><span class="op" id="4332530">{</span><span class="ident" id="4332531">node</span><span class="op" id="4332535">.</span><span class="ident" id="4332536">Ident</span><span class="op" id="4332541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332544">case</span>&nbsp;<span class="op" id="4332549">*</span><span class="ident" id="4332550">parse</span><span class="op" id="4332555">.</span><span class="ident" id="4332556">FieldNode</span><span class="op" id="4332565">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332569">return</span>&nbsp;<span class="ident" id="4332576">node</span><span class="op" id="4332580">.</span><span class="ident" id="4332581">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4332591">panic</span><span class="op" id="4332596">(</span><span class="string" id="4332597">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="4332634">)</span><br>
<span class="lineno"></span><span class="op" id="4332636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4332639">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="4332709">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="4332743">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="4332816">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4332893">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="4332967">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="4332997">func</span>&nbsp;<span class="ident" id="4333002">ensurePipelineContains</span><span class="op" id="4333024">(</span><span class="ident" id="4333025">p</span>&nbsp;<span class="op" id="4333027">*</span><span class="ident" id="4333028">parse</span><span class="op" id="4333033">.</span><span class="ident" id="4333034">PipeNode</span><span class="op" id="4333042">,</span>&nbsp;<span class="ident" id="4333044">s</span>&nbsp;<span class="op" id="4333046">[</span><span class="op" id="4333047">]</span><span class="builtintype" id="4333048">string</span><span class="op" id="4333054">)</span>&nbsp;<span class="op" id="4333056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333059">if</span>&nbsp;<span class="builtinfunc" id="4333062">len</span><span class="op" id="4333065">(</span><span class="ident" id="4333066">s</span><span class="op" id="4333067">)</span>&nbsp;<span class="op" id="4333069">==</span>&nbsp;<span class="num" id="4333072">0</span>&nbsp;<span class="op" id="4333074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333078">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333089">n</span>&nbsp;<span class="op" id="4333091">:=</span>&nbsp;<span class="builtinfunc" id="4333094">len</span><span class="op" id="4333097">(</span><span class="ident" id="4333098">p</span><span class="op" id="4333099">.</span><span class="ident" id="4333100">Cmds</span><span class="op" id="4333104">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4333107">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333165">idents</span>&nbsp;<span class="op" id="4333172">:=</span>&nbsp;<span class="ident" id="4333175">p</span><span class="op" id="4333176">.</span><span class="ident" id="4333177">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333183">for</span>&nbsp;<span class="ident" id="4333187">i</span>&nbsp;<span class="op" id="4333189">:=</span>&nbsp;<span class="ident" id="4333192">n</span>&nbsp;<span class="op" id="4333194">-</span>&nbsp;<span class="num" id="4333196">1</span><span class="op" id="4333197">;</span>&nbsp;<span class="ident" id="4333199">i</span>&nbsp;<span class="op" id="4333201">&gt;=</span>&nbsp;<span class="num" id="4333204">0</span><span class="op" id="4333205">;</span>&nbsp;<span class="ident" id="4333207">i</span><span class="op" id="4333208">--</span>&nbsp;<span class="op" id="4333211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333215">if</span>&nbsp;<span class="ident" id="4333218">cmd</span>&nbsp;<span class="op" id="4333222">:=</span>&nbsp;<span class="ident" id="4333225">p</span><span class="op" id="4333226">.</span><span class="ident" id="4333227">Cmds</span><span class="op" id="4333231">[</span><span class="ident" id="4333232">i</span><span class="op" id="4333233">]</span><span class="op" id="4333234">;</span>&nbsp;<span class="builtinfunc" id="4333236">len</span><span class="op" id="4333239">(</span><span class="ident" id="4333240">cmd</span><span class="op" id="4333243">.</span><span class="ident" id="4333244">Args</span><span class="op" id="4333248">)</span>&nbsp;<span class="op" id="4333250">!=</span>&nbsp;<span class="num" id="4333253">0</span>&nbsp;<span class="op" id="4333255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333260">if</span>&nbsp;<span class="ident" id="4333263">_</span><span class="op" id="4333264">,</span>&nbsp;<span class="ident" id="4333266">ok</span>&nbsp;<span class="op" id="4333269">:=</span>&nbsp;<span class="ident" id="4333272">cmd</span><span class="op" id="4333275">.</span><span class="ident" id="4333276">Args</span><span class="op" id="4333280">[</span><span class="num" id="4333281">0</span><span class="op" id="4333282">]</span><span class="op" id="4333283">.</span><span class="op" id="4333284">(</span><span class="op" id="4333285">*</span><span class="ident" id="4333286">parse</span><span class="op" id="4333291">.</span><span class="ident" id="4333292">IdentifierNode</span><span class="op" id="4333306">)</span><span class="op" id="4333307">;</span>&nbsp;<span class="ident" id="4333309">ok</span>&nbsp;<span class="op" id="4333312">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333318">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333338">idents</span>&nbsp;<span class="op" id="4333345">=</span>&nbsp;<span class="ident" id="4333347">p</span><span class="op" id="4333348">.</span><span class="ident" id="4333349">Cmds</span><span class="op" id="4333353">[</span><span class="ident" id="4333354">i</span><span class="op" id="4333355">+</span><span class="num" id="4333356">1</span><span class="op" id="4333357">:</span><span class="op" id="4333358">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333361">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333364">dups</span>&nbsp;<span class="op" id="4333369">:=</span>&nbsp;<span class="num" id="4333372">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333375">for</span>&nbsp;<span class="ident" id="4333379">_</span><span class="op" id="4333380">,</span>&nbsp;<span class="ident" id="4333382">idNode</span>&nbsp;<span class="op" id="4333389">:=</span>&nbsp;<span class="keyword" id="4333392">range</span>&nbsp;<span class="ident" id="4333398">idents</span>&nbsp;<span class="op" id="4333405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333409">for</span>&nbsp;<span class="ident" id="4333413">_</span><span class="op" id="4333414">,</span>&nbsp;<span class="ident" id="4333416">ident</span>&nbsp;<span class="op" id="4333422">:=</span>&nbsp;<span class="keyword" id="4333425">range</span>&nbsp;<span class="ident" id="4333431">allIdents</span><span class="op" id="4333440">(</span><span class="ident" id="4333441">idNode</span><span class="op" id="4333447">.</span><span class="ident" id="4333448">Args</span><span class="op" id="4333452">[</span><span class="num" id="4333453">0</span><span class="op" id="4333454">]</span><span class="op" id="4333455">)</span>&nbsp;<span class="op" id="4333457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333462">if</span>&nbsp;<span class="ident" id="4333465">escFnsEq</span><span class="op" id="4333473">(</span><span class="ident" id="4333474">s</span><span class="op" id="4333475">[</span><span class="ident" id="4333476">dups</span><span class="op" id="4333480">]</span><span class="op" id="4333481">,</span>&nbsp;<span class="ident" id="4333483">ident</span><span class="op" id="4333488">)</span>&nbsp;<span class="op" id="4333490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333496">dups</span><span class="op" id="4333500">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333507">if</span>&nbsp;<span class="ident" id="4333510">dups</span>&nbsp;<span class="op" id="4333515">==</span>&nbsp;<span class="builtinfunc" id="4333518">len</span><span class="op" id="4333521">(</span><span class="ident" id="4333522">s</span><span class="op" id="4333523">)</span>&nbsp;<span class="op" id="4333525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333532">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333552">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333558">newCmds</span>&nbsp;<span class="op" id="4333566">:=</span>&nbsp;<span class="builtinfunc" id="4333569">make</span><span class="op" id="4333573">(</span><span class="op" id="4333574">[</span><span class="op" id="4333575">]</span><span class="op" id="4333576">*</span><span class="ident" id="4333577">parse</span><span class="op" id="4333582">.</span><span class="ident" id="4333583">CommandNode</span><span class="op" id="4333594">,</span>&nbsp;<span class="ident" id="4333596">n</span><span class="op" id="4333597">-</span><span class="builtinfunc" id="4333598">len</span><span class="op" id="4333601">(</span><span class="ident" id="4333602">idents</span><span class="op" id="4333608">)</span><span class="op" id="4333609">,</span>&nbsp;<span class="ident" id="4333611">n</span><span class="op" id="4333612">+</span><span class="builtinfunc" id="4333613">len</span><span class="op" id="4333616">(</span><span class="ident" id="4333617">s</span><span class="op" id="4333618">)</span><span class="op" id="4333619">-</span><span class="ident" id="4333620">dups</span><span class="op" id="4333624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4333627">copy</span><span class="op" id="4333631">(</span><span class="ident" id="4333632">newCmds</span><span class="op" id="4333639">,</span>&nbsp;<span class="ident" id="4333641">p</span><span class="op" id="4333642">.</span><span class="ident" id="4333643">Cmds</span><span class="op" id="4333647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4333650">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333717">for</span>&nbsp;<span class="ident" id="4333721">_</span><span class="op" id="4333722">,</span>&nbsp;<span class="ident" id="4333724">idNode</span>&nbsp;<span class="op" id="4333731">:=</span>&nbsp;<span class="keyword" id="4333734">range</span>&nbsp;<span class="ident" id="4333740">idents</span>&nbsp;<span class="op" id="4333747">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333751">pos</span>&nbsp;<span class="op" id="4333755">:=</span>&nbsp;<span class="ident" id="4333758">idNode</span><span class="op" id="4333764">.</span><span class="ident" id="4333765">Args</span><span class="op" id="4333769">[</span><span class="num" id="4333770">0</span><span class="op" id="4333771">]</span><span class="op" id="4333772">.</span><span class="ident" id="4333773">Position</span><span class="op" id="4333781">(</span><span class="op" id="4333782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333786">for</span>&nbsp;<span class="ident" id="4333790">_</span><span class="op" id="4333791">,</span>&nbsp;<span class="ident" id="4333793">ident</span>&nbsp;<span class="op" id="4333799">:=</span>&nbsp;<span class="keyword" id="4333802">range</span>&nbsp;<span class="ident" id="4333808">allIdents</span><span class="op" id="4333817">(</span><span class="ident" id="4333818">idNode</span><span class="op" id="4333824">.</span><span class="ident" id="4333825">Args</span><span class="op" id="4333829">[</span><span class="num" id="4333830">0</span><span class="op" id="4333831">]</span><span class="op" id="4333832">)</span>&nbsp;<span class="op" id="4333834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333839">i</span>&nbsp;<span class="op" id="4333841">:=</span>&nbsp;<span class="ident" id="4333844">indexOfStr</span><span class="op" id="4333854">(</span><span class="ident" id="4333855">ident</span><span class="op" id="4333860">,</span>&nbsp;<span class="ident" id="4333862">s</span><span class="op" id="4333863">,</span>&nbsp;<span class="ident" id="4333865">escFnsEq</span><span class="op" id="4333873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333878">if</span>&nbsp;<span class="ident" id="4333881">i</span>&nbsp;<span class="op" id="4333883">!=</span>&nbsp;<span class="op" id="4333886">-</span><span class="num" id="4333887">1</span>&nbsp;<span class="op" id="4333889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333895">for</span>&nbsp;<span class="ident" id="4333899">_</span><span class="op" id="4333900">,</span>&nbsp;<span class="ident" id="4333902">name</span>&nbsp;<span class="op" id="4333907">:=</span>&nbsp;<span class="keyword" id="4333910">range</span>&nbsp;<span class="ident" id="4333916">s</span><span class="op" id="4333917">[</span><span class="op" id="4333918">:</span><span class="ident" id="4333919">i</span><span class="op" id="4333920">]</span>&nbsp;<span class="op" id="4333922">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333929">newCmds</span>&nbsp;<span class="op" id="4333937">=</span>&nbsp;<span class="ident" id="4333939">appendCmd</span><span class="op" id="4333948">(</span><span class="ident" id="4333949">newCmds</span><span class="op" id="4333956">,</span>&nbsp;<span class="ident" id="4333958">newIdentCmd</span><span class="op" id="4333969">(</span><span class="ident" id="4333970">name</span><span class="op" id="4333974">,</span>&nbsp;<span class="ident" id="4333976">pos</span><span class="op" id="4333979">)</span><span class="op" id="4333980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333992">s</span>&nbsp;<span class="op" id="4333994">=</span>&nbsp;<span class="ident" id="4333996">s</span><span class="op" id="4333997">[</span><span class="ident" id="4333998">i</span><span class="op" id="4333999">+</span><span class="num" id="4334000">1</span><span class="op" id="4334001">:</span><span class="op" id="4334002">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334011">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4334015">newCmds</span>&nbsp;<span class="op" id="4334023">=</span>&nbsp;<span class="ident" id="4334025">appendCmd</span><span class="op" id="4334034">(</span><span class="ident" id="4334035">newCmds</span><span class="op" id="4334042">,</span>&nbsp;<span class="ident" id="4334044">idNode</span><span class="op" id="4334050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4334056">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334093">for</span>&nbsp;<span class="ident" id="4334097">_</span><span class="op" id="4334098">,</span>&nbsp;<span class="ident" id="4334100">name</span>&nbsp;<span class="op" id="4334105">:=</span>&nbsp;<span class="keyword" id="4334108">range</span>&nbsp;<span class="ident" id="4334114">s</span>&nbsp;<span class="op" id="4334116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4334120">newCmds</span>&nbsp;<span class="op" id="4334128">=</span>&nbsp;<span class="ident" id="4334130">appendCmd</span><span class="op" id="4334139">(</span><span class="ident" id="4334140">newCmds</span><span class="op" id="4334147">,</span>&nbsp;<span class="ident" id="4334149">newIdentCmd</span><span class="op" id="4334160">(</span><span class="ident" id="4334161">name</span><span class="op" id="4334165">,</span>&nbsp;<span class="ident" id="4334167">p</span><span class="op" id="4334168">.</span><span class="ident" id="4334169">Position</span><span class="op" id="4334177">(</span><span class="op" id="4334178">)</span><span class="op" id="4334179">)</span><span class="op" id="4334180">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4334186">p</span><span class="op" id="4334187">.</span><span class="ident" id="4334188">Cmds</span>&nbsp;<span class="op" id="4334193">=</span>&nbsp;<span class="ident" id="4334195">newCmds</span><br>
<span class="lineno"></span><span class="op" id="4334203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4334206">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="4334286">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="4334300">var</span>&nbsp;<span class="ident" id="4334304">redundantFuncs</span>&nbsp;<span class="op" id="4334319">=</span>&nbsp;<span class="keyword" id="4334321">map</span><span class="op" id="4334324">[</span><span class="builtintype" id="4334325">string</span><span class="op" id="4334331">]</span><span class="keyword" id="4334332">map</span><span class="op" id="4334335">[</span><span class="builtintype" id="4334336">string</span><span class="op" id="4334342">]</span><span class="builtintype" id="4334343">bool</span><span class="op" id="4334347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334350">&#34;html_template_commentescaper&#34;</span><span class="op" id="4334380">:</span>&nbsp;<span class="op" id="4334382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334386">&#34;html_template_attrescaper&#34;</span><span class="op" id="4334413">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4334418">true</span><span class="op" id="4334422">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334426">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4334456">:</span>&nbsp;<span class="builtintype" id="4334458">true</span><span class="op" id="4334462">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334466">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4334493">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4334498">true</span><span class="op" id="4334502">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334505">}</span><span class="op" id="4334506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334509">&#34;html_template_cssescaper&#34;</span><span class="op" id="4334535">:</span>&nbsp;<span class="op" id="4334537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334541">&#34;html_template_attrescaper&#34;</span><span class="op" id="4334568">:</span>&nbsp;<span class="builtintype" id="4334570">true</span><span class="op" id="4334574">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334577">}</span><span class="op" id="4334578">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334581">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4334612">:</span>&nbsp;<span class="op" id="4334614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334618">&#34;html_template_attrescaper&#34;</span><span class="op" id="4334645">:</span>&nbsp;<span class="builtintype" id="4334647">true</span><span class="op" id="4334651">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334654">}</span><span class="op" id="4334655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334658">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4334686">:</span>&nbsp;<span class="op" id="4334688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334692">&#34;html_template_attrescaper&#34;</span><span class="op" id="4334719">:</span>&nbsp;<span class="builtintype" id="4334721">true</span><span class="op" id="4334725">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334728">}</span><span class="op" id="4334729">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334732">&#34;html_template_urlescaper&#34;</span><span class="op" id="4334758">:</span>&nbsp;<span class="op" id="4334760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4334764">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4334793">:</span>&nbsp;<span class="builtintype" id="4334795">true</span><span class="op" id="4334799">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334802">}</span><span class="op" id="4334803">,</span><br>
<span class="lineno"></span><span class="op" id="4334805">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="4334808">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="4334882">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="4334931">func</span>&nbsp;<span class="ident" id="4334936">appendCmd</span><span class="op" id="4334945">(</span><span class="ident" id="4334946">cmds</span>&nbsp;<span class="op" id="4334951">[</span><span class="op" id="4334952">]</span><span class="op" id="4334953">*</span><span class="ident" id="4334954">parse</span><span class="op" id="4334959">.</span><span class="ident" id="4334960">CommandNode</span><span class="op" id="4334971">,</span>&nbsp;<span class="ident" id="4334973">cmd</span>&nbsp;<span class="op" id="4334977">*</span><span class="ident" id="4334978">parse</span><span class="op" id="4334983">.</span><span class="ident" id="4334984">CommandNode</span><span class="op" id="4334995">)</span>&nbsp;<span class="op" id="4334997">[</span><span class="op" id="4334998">]</span><span class="op" id="4334999">*</span><span class="ident" id="4335000">parse</span><span class="op" id="4335005">.</span><span class="ident" id="4335006">CommandNode</span>&nbsp;<span class="op" id="4335018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335021">if</span>&nbsp;<span class="ident" id="4335024">n</span>&nbsp;<span class="op" id="4335026">:=</span>&nbsp;<span class="builtinfunc" id="4335029">len</span><span class="op" id="4335032">(</span><span class="ident" id="4335033">cmds</span><span class="op" id="4335037">)</span><span class="op" id="4335038">;</span>&nbsp;<span class="ident" id="4335040">n</span>&nbsp;<span class="op" id="4335042">!=</span>&nbsp;<span class="num" id="4335045">0</span>&nbsp;<span class="op" id="4335047">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335051">last</span><span class="op" id="4335055">,</span>&nbsp;<span class="ident" id="4335057">ok</span>&nbsp;<span class="op" id="4335060">:=</span>&nbsp;<span class="ident" id="4335063">cmds</span><span class="op" id="4335067">[</span><span class="ident" id="4335068">n</span><span class="op" id="4335069">-</span><span class="num" id="4335070">1</span><span class="op" id="4335071">]</span><span class="op" id="4335072">.</span><span class="ident" id="4335073">Args</span><span class="op" id="4335077">[</span><span class="num" id="4335078">0</span><span class="op" id="4335079">]</span><span class="op" id="4335080">.</span><span class="op" id="4335081">(</span><span class="op" id="4335082">*</span><span class="ident" id="4335083">parse</span><span class="op" id="4335088">.</span><span class="ident" id="4335089">IdentifierNode</span><span class="op" id="4335103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335107">next</span><span class="op" id="4335111">,</span>&nbsp;<span class="ident" id="4335113">_</span>&nbsp;<span class="op" id="4335115">:=</span>&nbsp;<span class="ident" id="4335118">cmd</span><span class="op" id="4335121">.</span><span class="ident" id="4335122">Args</span><span class="op" id="4335126">[</span><span class="num" id="4335127">0</span><span class="op" id="4335128">]</span><span class="op" id="4335129">.</span><span class="op" id="4335130">(</span><span class="op" id="4335131">*</span><span class="ident" id="4335132">parse</span><span class="op" id="4335137">.</span><span class="ident" id="4335138">IdentifierNode</span><span class="op" id="4335152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335156">if</span>&nbsp;<span class="ident" id="4335159">ok</span>&nbsp;<span class="op" id="4335162">&amp;&amp;</span>&nbsp;<span class="ident" id="4335165">redundantFuncs</span><span class="op" id="4335179">[</span><span class="ident" id="4335180">last</span><span class="op" id="4335184">.</span><span class="ident" id="4335185">Ident</span><span class="op" id="4335190">]</span><span class="op" id="4335191">[</span><span class="ident" id="4335192">next</span><span class="op" id="4335196">.</span><span class="ident" id="4335197">Ident</span><span class="op" id="4335202">]</span>&nbsp;<span class="op" id="4335204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335209">return</span>&nbsp;<span class="ident" id="4335216">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335223">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335229">return</span>&nbsp;<span class="builtinfunc" id="4335236">append</span><span class="op" id="4335242">(</span><span class="ident" id="4335243">cmds</span><span class="op" id="4335247">,</span>&nbsp;<span class="ident" id="4335249">cmd</span><span class="op" id="4335252">)</span><br>
<span class="lineno"></span><span class="op" id="4335254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4335257">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="4335337">func</span>&nbsp;<span class="ident" id="4335342">indexOfStr</span><span class="op" id="4335352">(</span><span class="ident" id="4335353">s</span>&nbsp;<span class="builtintype" id="4335355">string</span><span class="op" id="4335361">,</span>&nbsp;<span class="ident" id="4335363">strs</span>&nbsp;<span class="op" id="4335368">[</span><span class="op" id="4335369">]</span><span class="builtintype" id="4335370">string</span><span class="op" id="4335376">,</span>&nbsp;<span class="ident" id="4335378">eq</span>&nbsp;<span class="keyword" id="4335381">func</span><span class="op" id="4335385">(</span><span class="ident" id="4335386">a</span><span class="op" id="4335387">,</span>&nbsp;<span class="ident" id="4335389">b</span>&nbsp;<span class="builtintype" id="4335391">string</span><span class="op" id="4335397">)</span>&nbsp;<span class="builtintype" id="4335399">bool</span><span class="op" id="4335403">)</span>&nbsp;<span class="builtintype" id="4335405">int</span>&nbsp;<span class="op" id="4335409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335412">for</span>&nbsp;<span class="ident" id="4335416">i</span><span class="op" id="4335417">,</span>&nbsp;<span class="ident" id="4335419">t</span>&nbsp;<span class="op" id="4335421">:=</span>&nbsp;<span class="keyword" id="4335424">range</span>&nbsp;<span class="ident" id="4335430">strs</span>&nbsp;<span class="op" id="4335435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335439">if</span>&nbsp;<span class="ident" id="4335442">eq</span><span class="op" id="4335444">(</span><span class="ident" id="4335445">s</span><span class="op" id="4335446">,</span>&nbsp;<span class="ident" id="4335448">t</span><span class="op" id="4335449">)</span>&nbsp;<span class="op" id="4335451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335456">return</span>&nbsp;<span class="ident" id="4335463">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335467">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335473">return</span>&nbsp;<span class="op" id="4335480">-</span><span class="num" id="4335481">1</span><br>
<span class="lineno"></span><span class="op" id="4335483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4335486">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="4335557">func</span>&nbsp;<span class="ident" id="4335562">escFnsEq</span><span class="op" id="4335570">(</span><span class="ident" id="4335571">a</span><span class="op" id="4335572">,</span>&nbsp;<span class="ident" id="4335574">b</span>&nbsp;<span class="builtintype" id="4335576">string</span><span class="op" id="4335582">)</span>&nbsp;<span class="builtintype" id="4335584">bool</span>&nbsp;<span class="op" id="4335589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335592">if</span>&nbsp;<span class="ident" id="4335595">e</span>&nbsp;<span class="op" id="4335597">:=</span>&nbsp;<span class="ident" id="4335600">equivEscapers</span><span class="op" id="4335613">[</span><span class="ident" id="4335614">a</span><span class="op" id="4335615">]</span><span class="op" id="4335616">;</span>&nbsp;<span class="ident" id="4335618">e</span>&nbsp;<span class="op" id="4335620">!=</span>&nbsp;<span class="string" id="4335623">&#34;&#34;</span>&nbsp;<span class="op" id="4335626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335630">a</span>&nbsp;<span class="op" id="4335632">=</span>&nbsp;<span class="ident" id="4335634">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335640">if</span>&nbsp;<span class="ident" id="4335643">e</span>&nbsp;<span class="op" id="4335645">:=</span>&nbsp;<span class="ident" id="4335648">equivEscapers</span><span class="op" id="4335661">[</span><span class="ident" id="4335662">b</span><span class="op" id="4335663">]</span><span class="op" id="4335664">;</span>&nbsp;<span class="ident" id="4335666">e</span>&nbsp;<span class="op" id="4335668">!=</span>&nbsp;<span class="string" id="4335671">&#34;&#34;</span>&nbsp;<span class="op" id="4335674">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335678">b</span>&nbsp;<span class="op" id="4335680">=</span>&nbsp;<span class="ident" id="4335682">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335688">return</span>&nbsp;<span class="ident" id="4335695">a</span>&nbsp;<span class="op" id="4335697">==</span>&nbsp;<span class="ident" id="4335700">b</span><br>
<span class="lineno"></span><span class="op" id="4335702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="4335705">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4335776">func</span>&nbsp;<span class="ident" id="4335781">newIdentCmd</span><span class="op" id="4335792">(</span><span class="ident" id="4335793">identifier</span>&nbsp;<span class="builtintype" id="4335804">string</span><span class="op" id="4335810">,</span>&nbsp;<span class="ident" id="4335812">pos</span>&nbsp;<span class="ident" id="4335816">parse</span><span class="op" id="4335821">.</span><span class="ident" id="4335822">Pos</span><span class="op" id="4335825">)</span>&nbsp;<span class="op" id="4335827">*</span><span class="ident" id="4335828">parse</span><span class="op" id="4335833">.</span><span class="ident" id="4335834">CommandNode</span>&nbsp;<span class="op" id="4335846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335849">return</span>&nbsp;<span class="op" id="4335856">&amp;</span><span class="ident" id="4335857">parse</span><span class="op" id="4335862">.</span><span class="ident" id="4335863">CommandNode</span><span class="op" id="4335874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335878">NodeType</span><span class="op" id="4335886">:</span>&nbsp;<span class="ident" id="4335888">parse</span><span class="op" id="4335893">.</span><span class="ident" id="4335894">NodeCommand</span><span class="op" id="4335905">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335909">Args</span><span class="op" id="4335913">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335919">[</span><span class="op" id="4335920">]</span><span class="ident" id="4335921">parse</span><span class="op" id="4335926">.</span><span class="ident" id="4335927">Node</span><span class="op" id="4335931">{</span><span class="ident" id="4335932">parse</span><span class="op" id="4335937">.</span><span class="ident" id="4335938">NewIdentifier</span><span class="op" id="4335951">(</span><span class="ident" id="4335952">identifier</span><span class="op" id="4335962">)</span><span class="op" id="4335963">.</span><span class="ident" id="4335964">SetTree</span><span class="op" id="4335971">(</span><span class="builtintype" id="4335972">nil</span><span class="op" id="4335975">)</span><span class="op" id="4335976">.</span><span class="ident" id="4335977">SetPos</span><span class="op" id="4335983">(</span><span class="ident" id="4335984">pos</span><span class="op" id="4335987">)</span><span class="op" id="4335988">}</span><span class="op" id="4335989">,</span>&nbsp;<span class="comment" id="4335991">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4336010">}</span><br>
<span class="lineno"></span><span class="op" id="4336012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4336015">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4336090">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="4336129">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="4336154">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="4336172">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="4336251">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="4336270">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="4336329">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="4336392">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="4336470">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4336502">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4336568">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="4336633">func</span>&nbsp;<span class="ident" id="4336638">nudge</span><span class="op" id="4336643">(</span><span class="ident" id="4336644">c</span>&nbsp;<span class="ident" id="4336646">context</span><span class="op" id="4336653">)</span>&nbsp;<span class="ident" id="4336655">context</span>&nbsp;<span class="op" id="4336663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336666">switch</span>&nbsp;<span class="ident" id="4336673">c</span><span class="op" id="4336674">.</span><span class="ident" id="4336675">state</span>&nbsp;<span class="op" id="4336681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336684">case</span>&nbsp;<span class="ident" id="4336689">stateTag</span><span class="op" id="4336697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4336701">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4336760">c</span><span class="op" id="4336761">.</span><span class="ident" id="4336762">state</span>&nbsp;<span class="op" id="4336768">=</span>&nbsp;<span class="ident" id="4336770">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336785">case</span>&nbsp;<span class="ident" id="4336790">stateBeforeValue</span><span class="op" id="4336806">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4336810">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4336872">c</span><span class="op" id="4336873">.</span><span class="ident" id="4336874">state</span><span class="op" id="4336879">,</span>&nbsp;<span class="ident" id="4336881">c</span><span class="op" id="4336882">.</span><span class="ident" id="4336883">delim</span><span class="op" id="4336888">,</span>&nbsp;<span class="ident" id="4336890">c</span><span class="op" id="4336891">.</span><span class="ident" id="4336892">attr</span>&nbsp;<span class="op" id="4336897">=</span>&nbsp;<span class="ident" id="4336899">attrStartStates</span><span class="op" id="4336914">[</span><span class="ident" id="4336915">c</span><span class="op" id="4336916">.</span><span class="ident" id="4336917">attr</span><span class="op" id="4336921">]</span><span class="op" id="4336922">,</span>&nbsp;<span class="ident" id="4336924">delimSpaceOrTagEnd</span><span class="op" id="4336942">,</span>&nbsp;<span class="ident" id="4336944">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336954">case</span>&nbsp;<span class="ident" id="4336959">stateAfterName</span><span class="op" id="4336973">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4336977">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4337036">c</span><span class="op" id="4337037">.</span><span class="ident" id="4337038">state</span><span class="op" id="4337043">,</span>&nbsp;<span class="ident" id="4337045">c</span><span class="op" id="4337046">.</span><span class="ident" id="4337047">attr</span>&nbsp;<span class="op" id="4337052">=</span>&nbsp;<span class="ident" id="4337054">stateAttrName</span><span class="op" id="4337067">,</span>&nbsp;<span class="ident" id="4337069">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4337079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337082">return</span>&nbsp;<span class="ident" id="4337089">c</span><br>
<span class="lineno"></span><span class="op" id="4337091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="4337094">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4337169">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4337248">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="4337278">func</span>&nbsp;<span class="ident" id="4337283">join</span><span class="op" id="4337287">(</span><span class="ident" id="4337288">a</span><span class="op" id="4337289">,</span>&nbsp;<span class="ident" id="4337291">b</span>&nbsp;<span class="ident" id="4337293">context</span><span class="op" id="4337300">,</span>&nbsp;<span class="ident" id="4337302">node</span>&nbsp;<span class="ident" id="4337307">parse</span><span class="op" id="4337312">.</span><span class="ident" id="4337313">Node</span><span class="op" id="4337317">,</span>&nbsp;<span class="ident" id="4337319">nodeName</span>&nbsp;<span class="builtintype" id="4337328">string</span><span class="op" id="4337334">)</span>&nbsp;<span class="ident" id="4337336">context</span>&nbsp;<span class="op" id="4337344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337347">if</span>&nbsp;<span class="ident" id="4337350">a</span><span class="op" id="4337351">.</span><span class="ident" id="4337352">state</span>&nbsp;<span class="op" id="4337358">==</span>&nbsp;<span class="ident" id="4337361">stateError</span>&nbsp;<span class="op" id="4337372">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337376">return</span>&nbsp;<span class="ident" id="4337383">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4337386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337389">if</span>&nbsp;<span class="ident" id="4337392">b</span><span class="op" id="4337393">.</span><span class="ident" id="4337394">state</span>&nbsp;<span class="op" id="4337400">==</span>&nbsp;<span class="ident" id="4337403">stateError</span>&nbsp;<span class="op" id="4337414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337418">return</span>&nbsp;<span class="ident" id="4337425">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4337428">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337431">if</span>&nbsp;<span class="ident" id="4337434">a</span><span class="op" id="4337435">.</span><span class="ident" id="4337436">eq</span><span class="op" id="4337438">(</span><span class="ident" id="4337439">b</span><span class="op" id="4337440">)</span>&nbsp;<span class="op" id="4337442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337446">return</span>&nbsp;<span class="ident" id="4337453">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4337456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4337460">c</span>&nbsp;<span class="op" id="4337462">:=</span>&nbsp;<span class="ident" id="4337465">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4337468">c</span><span class="op" id="4337469">.</span><span class="ident" id="4337470">urlPart</span>&nbsp;<span class="op" id="4337478">=</span>&nbsp;<span class="ident" id="4337480">b</span><span class="op" id="4337481">.</span><span class="ident" id="4337482">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337491">if</span>&nbsp;<span class="ident" id="4337494">c</span><span class="op" id="4337495">.</span><span class="ident" id="4337496">eq</span><span class="op" id="4337498">(</span><span class="ident" id="4337499">b</span><span class="op" id="4337500">)</span>&nbsp;<span class="op" id="4337502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4337506">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4337548">c</span><span class="op" id="4337549">.</span><span class="ident" id="4337550">urlPart</span>&nbsp;<span class="op" id="4337558">=</span>&nbsp;<span class="ident" id="4337560">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337577">return</span>&nbsp;<span class="ident" id="4337584">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4337587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4337591">c</span>&nbsp;<span class="op" id="4337593">=</span>&nbsp;<span class="ident" id="4337595">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4337598">c</span><span class="op" id="4337599">.</span><span class="ident" id="4337600">jsCtx</span>&nbsp;<span class="op" id="4337606">=</span>&nbsp;<span class="ident" id="4337608">b</span><span class="op" id="4337609">.</span><span class="ident" id="4337610">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337617">if</span>&nbsp;<span class="ident" id="4337620">c</span><span class="op" id="4337621">.</span><span class="ident" id="4337622">eq</span><span class="op" id="4337624">(</span><span class="ident" id="4337625">b</span><span class="op" id="4337626">)</span>&nbsp;<span class="op" id="4337628">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4337632">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4337672">c</span><span class="op" id="4337673">.</span><span class="ident" id="4337674">jsCtx</span>&nbsp;<span class="op" id="4337680">=</span>&nbsp;<span class="ident" id="4337682">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337697">return</span>&nbsp;<span class="ident" id="4337704">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4337707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4337711">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4337768">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4337788">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4337825">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4337889">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337919">if</span>&nbsp;<span class="ident" id="4337922">c</span><span class="op" id="4337923">,</span>&nbsp;<span class="ident" id="4337925">d</span>&nbsp;<span class="op" id="4337927">:=</span>&nbsp;<span class="ident" id="4337930">nudge</span><span class="op" id="4337935">(</span><span class="ident" id="4337936">a</span><span class="op" id="4337937">)</span><span class="op" id="4337938">,</span>&nbsp;<span class="ident" id="4337940">nudge</span><span class="op" id="4337945">(</span><span class="ident" id="4337946">b</span><span class="op" id="4337947">)</span><span class="op" id="4337948">;</span>&nbsp;<span class="op" id="4337950">!</span><span class="op" id="4337951">(</span><span class="ident" id="4337952">c</span><span class="op" id="4337953">.</span><span class="ident" id="4337954">eq</span><span class="op" id="4337956">(</span><span class="ident" id="4337957">a</span><span class="op" id="4337958">)</span>&nbsp;<span class="op" id="4337960">&amp;&amp;</span>&nbsp;<span class="ident" id="4337963">d</span><span class="op" id="4337964">.</span><span class="ident" id="4337965">eq</span><span class="op" id="4337967">(</span><span class="ident" id="4337968">b</span><span class="op" id="4337969">)</span><span class="op" id="4337970">)</span>&nbsp;<span class="op" id="4337972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4337976">if</span>&nbsp;<span class="ident" id="4337979">e</span>&nbsp;<span class="op" id="4337981">:=</span>&nbsp;<span class="ident" id="4337984">join</span><span class="op" id="4337988">(</span><span class="ident" id="4337989">c</span><span class="op" id="4337990">,</span>&nbsp;<span class="ident" id="4337992">d</span><span class="op" id="4337993">,</span>&nbsp;<span class="ident" id="4337995">node</span><span class="op" id="4337999">,</span>&nbsp;<span class="ident" id="4338001">nodeName</span><span class="op" id="4338009">)</span><span class="op" id="4338010">;</span>&nbsp;<span class="ident" id="4338012">e</span><span class="op" id="4338013">.</span><span class="ident" id="4338014">state</span>&nbsp;<span class="op" id="4338020">!=</span>&nbsp;<span class="ident" id="4338023">stateError</span>&nbsp;<span class="op" id="4338034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4338039">return</span>&nbsp;<span class="ident" id="4338046">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4338050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4338053">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4338057">return</span>&nbsp;<span class="ident" id="4338064">context</span><span class="op" id="4338071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4338075">state</span><span class="op" id="4338080">:</span>&nbsp;<span class="ident" id="4338082">stateError</span><span class="op" id="4338092">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4338096">err</span><span class="op" id="4338099">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4338103">errorf</span><span class="op" id="4338109">(</span><span class="ident" id="4338110">ErrBranchEnd</span><span class="op" id="4338122">,</span>&nbsp;<span class="ident" id="4338124">node</span><span class="op" id="4338128">,</span>&nbsp;<span class="num" id="4338130">0</span><span class="op" id="4338131">,</span>&nbsp;<span class="string" id="4338133">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="4338184">,</span>&nbsp;<span class="ident" id="4338186">nodeName</span><span class="op" id="4338194">,</span>&nbsp;<span class="ident" id="4338196">a</span><span class="op" id="4338197">,</span>&nbsp;<span class="ident" id="4338199">b</span><span class="op" id="4338200">)</span><span class="op" id="4338201">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4338204">}</span><br>
<span class="lineno">410</span><span class="op" id="4338206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4338209">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4338283">func</span>&nbsp;<span class="op" id="4338288">(</span><span class="ident" id="4338289">e</span>&nbsp;<span class="op" id="4338291">*</span><span class="ident" id="4338292">escaper</span><span class="op" id="4338299">)</span>&nbsp;<span class="ident" id="4338301">escapeBranch</span><span class="op" id="4338313">(</span><span class="ident" id="4338314">c</span>&nbsp;<span class="ident" id="4338316">context</span><span class="op" id="4338323">,</span>&nbsp;<span class="ident" id="4338325">n</span>&nbsp;<span class="op" id="4338327">*</span><span class="ident" id="4338328">parse</span><span class="op" id="4338333">.</span><span class="ident" id="4338334">BranchNode</span><span class="op" id="4338344">,</span>&nbsp;<span class="ident" id="4338346">nodeName</span>&nbsp;<span class="builtintype" id="4338355">string</span><span class="op" id="4338361">)</span>&nbsp;<span class="ident" id="4338363">context</span>&nbsp;<span class="op" id="4338371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4338374">c0</span>&nbsp;<span class="op" id="4338377">:=</span>&nbsp;<span class="ident" id="4338380">e</span><span class="op" id="4338381">.</span><span class="ident" id="4338382">escapeList</span><span class="op" id="4338392">(</span><span class="ident" id="4338393">c</span><span class="op" id="4338394">,</span>&nbsp;<span class="ident" id="4338396">n</span><span class="op" id="4338397">.</span><span class="ident" id="4338398">List</span><span class="op" id="4338402">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4338405">if</span>&nbsp;<span class="ident" id="4338408">nodeName</span>&nbsp;<span class="op" id="4338417">==</span>&nbsp;<span class="string" id="4338420">&#34;range&#34;</span>&nbsp;<span class="op" id="4338428">&amp;&amp;</span>&nbsp;<span class="ident" id="4338431">c0</span><span class="op" id="4338433">.</span><span class="ident" id="4338434">state</span>&nbsp;<span class="op" id="4338440">!=</span>&nbsp;<span class="ident" id="4338443">stateError</span>&nbsp;<span class="op" id="4338454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4338458">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4338527">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4338596">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4338628">c1</span><span class="op" id="4338630">,</span>&nbsp;<span class="ident" id="4338632">_</span>&nbsp;<span class="op" id="4338634">:=</span>&nbsp;<span class="ident" id="4338637">e</span><span class="op" id="4338638">.</span><span class="ident" id="4338639">escapeListConditionally</span><span class="op" id="4338662">(</span><span class="ident" id="4338663">c0</span><span class="op" id="4338665">,</span>&nbsp;<span class="ident" id="4338667">n</span><span class="op" id="4338668">.</span><span class="ident" id="4338669">List</span><span class="op" id="4338673">,</span>&nbsp;<span class="builtintype" id="4338675">nil</span><span class="op" id="4338678">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4338682">c0</span>&nbsp;<span class="op" id="4338685">=</span>&nbsp;<span class="ident" id="4338687">join</span><span class="op" id="4338691">(</span><span class="ident" id="4338692">c0</span><span class="op" id="4338694">,</span>&nbsp;<span class="ident" id="4338696">c1</span><span class="op" id="4338698">,</span>&nbsp;<span class="ident" id="4338700">n</span><span class="op" id="4338701">,</span>&nbsp;<span class="ident" id="4338703">nodeName</span><span class="op" id="4338711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4338715">if</span>&nbsp;<span class="ident" id="4338718">c0</span><span class="op" id="4338720">.</span><span class="ident" id="4338721">state</span>&nbsp;<span class="op" id="4338727">==</span>&nbsp;<span class="ident" id="4338730">stateError</span>&nbsp;<span class="op" id="4338741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4338746">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4338803">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4338860">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4338887">c0</span><span class="op" id="4338889">.</span><span class="ident" id="4338890">err</span><span class="op" id="4338893">.</span><span class="ident" id="4338894">Line</span>&nbsp;<span class="op" id="4338899">=</span>&nbsp;<span class="ident" id="4338901">n</span><span class="op" id="4338902">.</span><span class="ident" id="4338903">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4338911">c0</span><span class="op" id="4338913">.</span><span class="ident" id="4338914">err</span><span class="op" id="4338917">.</span><span class="ident" id="4338918">Description</span>&nbsp;<span class="op" id="4338930">=</span>&nbsp;<span class="string" id="4338932">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="4338959">+</span>&nbsp;<span class="ident" id="4338961">c0</span><span class="op" id="4338963">.</span><span class="ident" id="4338964">err</span><span class="op" id="4338967">.</span><span class="ident" id="4338968">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4338983">return</span>&nbsp;<span class="ident" id="4338990">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4338995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4338998">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4339001">c1</span>&nbsp;<span class="op" id="4339004">:=</span>&nbsp;<span class="ident" id="4339007">e</span><span class="op" id="4339008">.</span><span class="ident" id="4339009">escapeList</span><span class="op" id="4339019">(</span><span class="ident" id="4339020">c</span><span class="op" id="4339021">,</span>&nbsp;<span class="ident" id="4339023">n</span><span class="op" id="4339024">.</span><span class="ident" id="4339025">ElseList</span><span class="op" id="4339033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339036">return</span>&nbsp;<span class="ident" id="4339043">join</span><span class="op" id="4339047">(</span><span class="ident" id="4339048">c0</span><span class="op" id="4339050">,</span>&nbsp;<span class="ident" id="4339052">c1</span><span class="op" id="4339054">,</span>&nbsp;<span class="ident" id="4339056">n</span><span class="op" id="4339057">,</span>&nbsp;<span class="ident" id="4339059">nodeName</span><span class="op" id="4339067">)</span><br>
<span class="lineno"></span><span class="op" id="4339069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4339072">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="4339116">func</span>&nbsp;<span class="op" id="4339121">(</span><span class="ident" id="4339122">e</span>&nbsp;<span class="op" id="4339124">*</span><span class="ident" id="4339125">escaper</span><span class="op" id="4339132">)</span>&nbsp;<span class="ident" id="4339134">escapeList</span><span class="op" id="4339144">(</span><span class="ident" id="4339145">c</span>&nbsp;<span class="ident" id="4339147">context</span><span class="op" id="4339154">,</span>&nbsp;<span class="ident" id="4339156">n</span>&nbsp;<span class="op" id="4339158">*</span><span class="ident" id="4339159">parse</span><span class="op" id="4339164">.</span><span class="ident" id="4339165">ListNode</span><span class="op" id="4339173">)</span>&nbsp;<span class="ident" id="4339175">context</span>&nbsp;<span class="op" id="4339183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339186">if</span>&nbsp;<span class="ident" id="4339189">n</span>&nbsp;<span class="op" id="4339191">==</span>&nbsp;<span class="builtintype" id="4339194">nil</span>&nbsp;<span class="op" id="4339198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339202">return</span>&nbsp;<span class="ident" id="4339209">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4339212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339215">for</span>&nbsp;<span class="ident" id="4339219">_</span><span class="op" id="4339220">,</span>&nbsp;<span class="ident" id="4339222">m</span>&nbsp;<span class="op" id="4339224">:=</span>&nbsp;<span class="keyword" id="4339227">range</span>&nbsp;<span class="ident" id="4339233">n</span><span class="op" id="4339234">.</span><span class="ident" id="4339235">Nodes</span>&nbsp;<span class="op" id="4339241">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4339245">c</span>&nbsp;<span class="op" id="4339247">=</span>&nbsp;<span class="ident" id="4339249">e</span><span class="op" id="4339250">.</span><span class="ident" id="4339251">escape</span><span class="op" id="4339257">(</span><span class="ident" id="4339258">c</span><span class="op" id="4339259">,</span>&nbsp;<span class="ident" id="4339261">m</span><span class="op" id="4339262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4339265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339268">return</span>&nbsp;<span class="ident" id="4339275">c</span><br>
<span class="lineno"></span><span class="op" id="4339277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="4339280">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4339356">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="4339428">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="4339508">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="4339555">func</span>&nbsp;<span class="op" id="4339560">(</span><span class="ident" id="4339561">e</span>&nbsp;<span class="op" id="4339563">*</span><span class="ident" id="4339564">escaper</span><span class="op" id="4339571">)</span>&nbsp;<span class="ident" id="4339573">escapeListConditionally</span><span class="op" id="4339596">(</span><span class="ident" id="4339597">c</span>&nbsp;<span class="ident" id="4339599">context</span><span class="op" id="4339606">,</span>&nbsp;<span class="ident" id="4339608">n</span>&nbsp;<span class="op" id="4339610">*</span><span class="ident" id="4339611">parse</span><span class="op" id="4339616">.</span><span class="ident" id="4339617">ListNode</span><span class="op" id="4339625">,</span>&nbsp;<span class="ident" id="4339627">filter</span>&nbsp;<span class="keyword" id="4339634">func</span><span class="op" id="4339638">(</span><span class="op" id="4339639">*</span><span class="ident" id="4339640">escaper</span><span class="op" id="4339647">,</span>&nbsp;<span class="ident" id="4339649">context</span><span class="op" id="4339656">)</span>&nbsp;<span class="builtintype" id="4339658">bool</span><span class="op" id="4339662">)</span>&nbsp;<span class="op" id="4339664">(</span><span class="ident" id="4339665">context</span><span class="op" id="4339672">,</span>&nbsp;<span class="builtintype" id="4339674">bool</span><span class="op" id="4339678">)</span>&nbsp;<span class="op" id="4339680">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4339683">e1</span>&nbsp;<span class="op" id="4339686">:=</span>&nbsp;<span class="ident" id="4339689">newEscaper</span><span class="op" id="4339699">(</span><span class="ident" id="4339700">e</span><span class="op" id="4339701">.</span><span class="ident" id="4339702">tmpl</span><span class="op" id="4339706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4339709">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339750">for</span>&nbsp;<span class="ident" id="4339754">k</span><span class="op" id="4339755">,</span>&nbsp;<span class="ident" id="4339757">v</span>&nbsp;<span class="op" id="4339759">:=</span>&nbsp;<span class="keyword" id="4339762">range</span>&nbsp;<span class="ident" id="4339768">e</span><span class="op" id="4339769">.</span><span class="ident" id="4339770">output</span>&nbsp;<span class="op" id="4339777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4339781">e1</span><span class="op" id="4339783">.</span><span class="ident" id="4339784">output</span><span class="op" id="4339790">[</span><span class="ident" id="4339791">k</span><span class="op" id="4339792">]</span>&nbsp;<span class="op" id="4339794">=</span>&nbsp;<span class="ident" id="4339796">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4339799">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4339802">c</span>&nbsp;<span class="op" id="4339804">=</span>&nbsp;<span class="ident" id="4339806">e1</span><span class="op" id="4339808">.</span><span class="ident" id="4339809">escapeList</span><span class="op" id="4339819">(</span><span class="ident" id="4339820">c</span><span class="op" id="4339821">,</span>&nbsp;<span class="ident" id="4339823">n</span><span class="op" id="4339824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4339827">ok</span>&nbsp;<span class="op" id="4339830">:=</span>&nbsp;<span class="ident" id="4339833">filter</span>&nbsp;<span class="op" id="4339840">!=</span>&nbsp;<span class="builtintype" id="4339843">nil</span>&nbsp;<span class="op" id="4339847">&amp;&amp;</span>&nbsp;<span class="ident" id="4339850">filter</span><span class="op" id="4339856">(</span><span class="ident" id="4339857">e1</span><span class="op" id="4339859">,</span>&nbsp;<span class="ident" id="4339861">c</span><span class="op" id="4339862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339865">if</span>&nbsp;<span class="ident" id="4339868">ok</span>&nbsp;<span class="op" id="4339871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4339875">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339927">for</span>&nbsp;<span class="ident" id="4339931">k</span><span class="op" id="4339932">,</span>&nbsp;<span class="ident" id="4339934">v</span>&nbsp;<span class="op" id="4339936">:=</span>&nbsp;<span class="keyword" id="4339939">range</span>&nbsp;<span class="ident" id="4339945">e1</span><span class="op" id="4339947">.</span><span class="ident" id="4339948">output</span>&nbsp;<span class="op" id="4339955">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4339960">e</span><span class="op" id="4339961">.</span><span class="ident" id="4339962">output</span><span class="op" id="4339968">[</span><span class="ident" id="4339969">k</span><span class="op" id="4339970">]</span>&nbsp;<span class="op" id="4339972">=</span>&nbsp;<span class="ident" id="4339974">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4339978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4339982">for</span>&nbsp;<span class="ident" id="4339986">k</span><span class="op" id="4339987">,</span>&nbsp;<span class="ident" id="4339989">v</span>&nbsp;<span class="op" id="4339991">:=</span>&nbsp;<span class="keyword" id="4339994">range</span>&nbsp;<span class="ident" id="4340000">e1</span><span class="op" id="4340002">.</span><span class="ident" id="4340003">derived</span>&nbsp;<span class="op" id="4340011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340016">e</span><span class="op" id="4340017">.</span><span class="ident" id="4340018">derived</span><span class="op" id="4340025">[</span><span class="ident" id="4340026">k</span><span class="op" id="4340027">]</span>&nbsp;<span class="op" id="4340029">=</span>&nbsp;<span class="ident" id="4340031">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4340035">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340039">for</span>&nbsp;<span class="ident" id="4340043">k</span><span class="op" id="4340044">,</span>&nbsp;<span class="ident" id="4340046">v</span>&nbsp;<span class="op" id="4340048">:=</span>&nbsp;<span class="keyword" id="4340051">range</span>&nbsp;<span class="ident" id="4340057">e1</span><span class="op" id="4340059">.</span><span class="ident" id="4340060">called</span>&nbsp;<span class="op" id="4340067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340072">e</span><span class="op" id="4340073">.</span><span class="ident" id="4340074">called</span><span class="op" id="4340080">[</span><span class="ident" id="4340081">k</span><span class="op" id="4340082">]</span>&nbsp;<span class="op" id="4340084">=</span>&nbsp;<span class="ident" id="4340086">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4340090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340094">for</span>&nbsp;<span class="ident" id="4340098">k</span><span class="op" id="4340099">,</span>&nbsp;<span class="ident" id="4340101">v</span>&nbsp;<span class="op" id="4340103">:=</span>&nbsp;<span class="keyword" id="4340106">range</span>&nbsp;<span class="ident" id="4340112">e1</span><span class="op" id="4340114">.</span><span class="ident" id="4340115">actionNodeEdits</span>&nbsp;<span class="op" id="4340131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340136">e</span><span class="op" id="4340137">.</span><span class="ident" id="4340138">editActionNode</span><span class="op" id="4340152">(</span><span class="ident" id="4340153">k</span><span class="op" id="4340154">,</span>&nbsp;<span class="ident" id="4340156">v</span><span class="op" id="4340157">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4340161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340165">for</span>&nbsp;<span class="ident" id="4340169">k</span><span class="op" id="4340170">,</span>&nbsp;<span class="ident" id="4340172">v</span>&nbsp;<span class="op" id="4340174">:=</span>&nbsp;<span class="keyword" id="4340177">range</span>&nbsp;<span class="ident" id="4340183">e1</span><span class="op" id="4340185">.</span><span class="ident" id="4340186">templateNodeEdits</span>&nbsp;<span class="op" id="4340204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340209">e</span><span class="op" id="4340210">.</span><span class="ident" id="4340211">editTemplateNode</span><span class="op" id="4340227">(</span><span class="ident" id="4340228">k</span><span class="op" id="4340229">,</span>&nbsp;<span class="ident" id="4340231">v</span><span class="op" id="4340232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4340236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340240">for</span>&nbsp;<span class="ident" id="4340244">k</span><span class="op" id="4340245">,</span>&nbsp;<span class="ident" id="4340247">v</span>&nbsp;<span class="op" id="4340249">:=</span>&nbsp;<span class="keyword" id="4340252">range</span>&nbsp;<span class="ident" id="4340258">e1</span><span class="op" id="4340260">.</span><span class="ident" id="4340261">textNodeEdits</span>&nbsp;<span class="op" id="4340275">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340280">e</span><span class="op" id="4340281">.</span><span class="ident" id="4340282">editTextNode</span><span class="op" id="4340294">(</span><span class="ident" id="4340295">k</span><span class="op" id="4340296">,</span>&nbsp;<span class="ident" id="4340298">v</span><span class="op" id="4340299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4340303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4340306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340309">return</span>&nbsp;<span class="ident" id="4340316">c</span><span class="op" id="4340317">,</span>&nbsp;<span class="ident" id="4340319">ok</span><br>
<span class="lineno"></span><span class="op" id="4340322">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4340325">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4340377">func</span>&nbsp;<span class="op" id="4340382">(</span><span class="ident" id="4340383">e</span>&nbsp;<span class="op" id="4340385">*</span><span class="ident" id="4340386">escaper</span><span class="op" id="4340393">)</span>&nbsp;<span class="ident" id="4340395">escapeTemplate</span><span class="op" id="4340409">(</span><span class="ident" id="4340410">c</span>&nbsp;<span class="ident" id="4340412">context</span><span class="op" id="4340419">,</span>&nbsp;<span class="ident" id="4340421">n</span>&nbsp;<span class="op" id="4340423">*</span><span class="ident" id="4340424">parse</span><span class="op" id="4340429">.</span><span class="ident" id="4340430">TemplateNode</span><span class="op" id="4340442">)</span>&nbsp;<span class="ident" id="4340444">context</span>&nbsp;<span class="op" id="4340452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340455">c</span><span class="op" id="4340456">,</span>&nbsp;<span class="ident" id="4340458">name</span>&nbsp;<span class="op" id="4340463">:=</span>&nbsp;<span class="ident" id="4340466">e</span><span class="op" id="4340467">.</span><span class="ident" id="4340468">escapeTree</span><span class="op" id="4340478">(</span><span class="ident" id="4340479">c</span><span class="op" id="4340480">,</span>&nbsp;<span class="ident" id="4340482">n</span><span class="op" id="4340483">,</span>&nbsp;<span class="ident" id="4340485">n</span><span class="op" id="4340486">.</span><span class="ident" id="4340487">Name</span><span class="op" id="4340491">,</span>&nbsp;<span class="ident" id="4340493">n</span><span class="op" id="4340494">.</span><span class="ident" id="4340495">Line</span><span class="op" id="4340499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340502">if</span>&nbsp;<span class="ident" id="4340505">name</span>&nbsp;<span class="op" id="4340510">!=</span>&nbsp;<span class="ident" id="4340513">n</span><span class="op" id="4340514">.</span><span class="ident" id="4340515">Name</span>&nbsp;<span class="op" id="4340520">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340524">e</span><span class="op" id="4340525">.</span><span class="ident" id="4340526">editTemplateNode</span><span class="op" id="4340542">(</span><span class="ident" id="4340543">n</span><span class="op" id="4340544">,</span>&nbsp;<span class="ident" id="4340546">name</span><span class="op" id="4340550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4340553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340556">return</span>&nbsp;<span class="ident" id="4340563">c</span><br>
<span class="lineno"></span><span class="op" id="4340565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="4340568">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4340642">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="4340687">func</span>&nbsp;<span class="op" id="4340692">(</span><span class="ident" id="4340693">e</span>&nbsp;<span class="op" id="4340695">*</span><span class="ident" id="4340696">escaper</span><span class="op" id="4340703">)</span>&nbsp;<span class="ident" id="4340705">escapeTree</span><span class="op" id="4340715">(</span><span class="ident" id="4340716">c</span>&nbsp;<span class="ident" id="4340718">context</span><span class="op" id="4340725">,</span>&nbsp;<span class="ident" id="4340727">node</span>&nbsp;<span class="ident" id="4340732">parse</span><span class="op" id="4340737">.</span><span class="ident" id="4340738">Node</span><span class="op" id="4340742">,</span>&nbsp;<span class="ident" id="4340744">name</span>&nbsp;<span class="builtintype" id="4340749">string</span><span class="op" id="4340755">,</span>&nbsp;<span class="ident" id="4340757">line</span>&nbsp;<span class="builtintype" id="4340762">int</span><span class="op" id="4340765">)</span>&nbsp;<span class="op" id="4340767">(</span><span class="ident" id="4340768">context</span><span class="op" id="4340775">,</span>&nbsp;<span class="builtintype" id="4340777">string</span><span class="op" id="4340783">)</span>&nbsp;<span class="op" id="4340785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4340788">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4340862">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340878">dname</span>&nbsp;<span class="op" id="4340884">:=</span>&nbsp;<span class="ident" id="4340887">c</span><span class="op" id="4340888">.</span><span class="ident" id="4340889">mangle</span><span class="op" id="4340895">(</span><span class="ident" id="4340896">name</span><span class="op" id="4340900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4340903">e</span><span class="op" id="4340904">.</span><span class="ident" id="4340905">called</span><span class="op" id="4340911">[</span><span class="ident" id="4340912">dname</span><span class="op" id="4340917">]</span>&nbsp;<span class="op" id="4340919">=</span>&nbsp;<span class="builtintype" id="4340921">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340927">if</span>&nbsp;<span class="ident" id="4340930">out</span><span class="op" id="4340933">,</span>&nbsp;<span class="ident" id="4340935">ok</span>&nbsp;<span class="op" id="4340938">:=</span>&nbsp;<span class="ident" id="4340941">e</span><span class="op" id="4340942">.</span><span class="ident" id="4340943">output</span><span class="op" id="4340949">[</span><span class="ident" id="4340950">dname</span><span class="op" id="4340955">]</span><span class="op" id="4340956">;</span>&nbsp;<span class="ident" id="4340958">ok</span>&nbsp;<span class="op" id="4340961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4340965">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4340987">return</span>&nbsp;<span class="ident" id="4340994">out</span><span class="op" id="4340997">,</span>&nbsp;<span class="ident" id="4340999">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4341006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341009">t</span>&nbsp;<span class="op" id="4341011">:=</span>&nbsp;<span class="ident" id="4341014">e</span><span class="op" id="4341015">.</span><span class="ident" id="4341016">template</span><span class="op" id="4341024">(</span><span class="ident" id="4341025">name</span><span class="op" id="4341029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4341032">if</span>&nbsp;<span class="ident" id="4341035">t</span>&nbsp;<span class="op" id="4341037">==</span>&nbsp;<span class="builtintype" id="4341040">nil</span>&nbsp;<span class="op" id="4341044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4341048">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4341129">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4341184">if</span>&nbsp;<span class="ident" id="4341187">e</span><span class="op" id="4341188">.</span><span class="ident" id="4341189">tmpl</span><span class="op" id="4341193">.</span><span class="ident" id="4341194">set</span><span class="op" id="4341197">[</span><span class="ident" id="4341198">name</span><span class="op" id="4341202">]</span>&nbsp;<span class="op" id="4341204">!=</span>&nbsp;<span class="builtintype" id="4341207">nil</span>&nbsp;<span class="op" id="4341211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4341216">return</span>&nbsp;<span class="ident" id="4341223">context</span><span class="op" id="4341230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341236">state</span><span class="op" id="4341241">:</span>&nbsp;<span class="ident" id="4341243">stateError</span><span class="op" id="4341253">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341259">err</span><span class="op" id="4341262">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4341266">errorf</span><span class="op" id="4341272">(</span><span class="ident" id="4341273">ErrNoSuchTemplate</span><span class="op" id="4341290">,</span>&nbsp;<span class="ident" id="4341292">node</span><span class="op" id="4341296">,</span>&nbsp;<span class="ident" id="4341298">line</span><span class="op" id="4341302">,</span>&nbsp;<span class="string" id="4341304">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="4341343">,</span>&nbsp;<span class="ident" id="4341345">name</span><span class="op" id="4341349">)</span><span class="op" id="4341350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4341355">}</span><span class="op" id="4341356">,</span>&nbsp;<span class="ident" id="4341358">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4341366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4341370">return</span>&nbsp;<span class="ident" id="4341377">context</span><span class="op" id="4341384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341389">state</span><span class="op" id="4341394">:</span>&nbsp;<span class="ident" id="4341396">stateError</span><span class="op" id="4341406">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341411">err</span><span class="op" id="4341414">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4341418">errorf</span><span class="op" id="4341424">(</span><span class="ident" id="4341425">ErrNoSuchTemplate</span><span class="op" id="4341442">,</span>&nbsp;<span class="ident" id="4341444">node</span><span class="op" id="4341448">,</span>&nbsp;<span class="ident" id="4341450">line</span><span class="op" id="4341454">,</span>&nbsp;<span class="string" id="4341456">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="4341477">,</span>&nbsp;<span class="ident" id="4341479">name</span><span class="op" id="4341483">)</span><span class="op" id="4341484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4341488">}</span><span class="op" id="4341489">,</span>&nbsp;<span class="ident" id="4341491">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4341498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4341501">if</span>&nbsp;<span class="ident" id="4341504">dname</span>&nbsp;<span class="op" id="4341510">!=</span>&nbsp;<span class="ident" id="4341513">name</span>&nbsp;<span class="op" id="4341518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4341522">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4341593">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341657">dt</span>&nbsp;<span class="op" id="4341660">:=</span>&nbsp;<span class="ident" id="4341663">e</span><span class="op" id="4341664">.</span><span class="ident" id="4341665">template</span><span class="op" id="4341673">(</span><span class="ident" id="4341674">dname</span><span class="op" id="4341679">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4341683">if</span>&nbsp;<span class="ident" id="4341686">dt</span>&nbsp;<span class="op" id="4341689">==</span>&nbsp;<span class="builtintype" id="4341692">nil</span>&nbsp;<span class="op" id="4341696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341701">dt</span>&nbsp;<span class="op" id="4341704">=</span>&nbsp;<span class="ident" id="4341706">template</span><span class="op" id="4341714">.</span><span class="ident" id="4341715">New</span><span class="op" id="4341718">(</span><span class="ident" id="4341719">dname</span><span class="op" id="4341724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341729">dt</span><span class="op" id="4341731">.</span><span class="ident" id="4341732">Tree</span>&nbsp;<span class="op" id="4341737">=</span>&nbsp;<span class="op" id="4341739">&amp;</span><span class="ident" id="4341740">parse</span><span class="op" id="4341745">.</span><span class="ident" id="4341746">Tree</span><span class="op" id="4341750">{</span><span class="ident" id="4341751">Name</span><span class="op" id="4341755">:</span>&nbsp;<span class="ident" id="4341757">dname</span><span class="op" id="4341762">,</span>&nbsp;<span class="ident" id="4341764">Root</span><span class="op" id="4341768">:</span>&nbsp;<span class="ident" id="4341770">t</span><span class="op" id="4341771">.</span><span class="ident" id="4341772">Root</span><span class="op" id="4341776">.</span><span class="ident" id="4341777">CopyList</span><span class="op" id="4341785">(</span><span class="op" id="4341786">)</span><span class="op" id="4341787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341792">e</span><span class="op" id="4341793">.</span><span class="ident" id="4341794">derived</span><span class="op" id="4341801">[</span><span class="ident" id="4341802">dname</span><span class="op" id="4341807">]</span>&nbsp;<span class="op" id="4341809">=</span>&nbsp;<span class="ident" id="4341811">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4341816">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4341820">t</span>&nbsp;<span class="op" id="4341822">=</span>&nbsp;<span class="ident" id="4341824">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4341828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4341831">return</span>&nbsp;<span class="ident" id="4341838">e</span><span class="op" id="4341839">.</span><span class="ident" id="4341840">computeOutCtx</span><span class="op" id="4341853">(</span><span class="ident" id="4341854">c</span><span class="op" id="4341855">,</span>&nbsp;<span class="ident" id="4341857">t</span><span class="op" id="4341858">)</span><span class="op" id="4341859">,</span>&nbsp;<span class="ident" id="4341861">dname</span><br>
<span class="lineno"></span><span class="op" id="4341867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="4341870">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4341950">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="4341996">func</span>&nbsp;<span class="op" id="4342001">(</span><span class="ident" id="4342002">e</span>&nbsp;<span class="op" id="4342004">*</span><span class="ident" id="4342005">escaper</span><span class="op" id="4342012">)</span>&nbsp;<span class="ident" id="4342014">computeOutCtx</span><span class="op" id="4342027">(</span><span class="ident" id="4342028">c</span>&nbsp;<span class="ident" id="4342030">context</span><span class="op" id="4342037">,</span>&nbsp;<span class="ident" id="4342039">t</span>&nbsp;<span class="op" id="4342041">*</span><span class="ident" id="4342042">template</span><span class="op" id="4342050">.</span><span class="ident" id="4342051">Template</span><span class="op" id="4342059">)</span>&nbsp;<span class="ident" id="4342061">context</span>&nbsp;<span class="op" id="4342069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4342072">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4342109">c1</span><span class="op" id="4342111">,</span>&nbsp;<span class="ident" id="4342113">ok</span>&nbsp;<span class="op" id="4342116">:=</span>&nbsp;<span class="ident" id="4342119">e</span><span class="op" id="4342120">.</span><span class="ident" id="4342121">escapeTemplateBody</span><span class="op" id="4342139">(</span><span class="ident" id="4342140">c</span><span class="op" id="4342141">,</span>&nbsp;<span class="ident" id="4342143">t</span><span class="op" id="4342144">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4342147">if</span>&nbsp;<span class="op" id="4342150">!</span><span class="ident" id="4342151">ok</span>&nbsp;<span class="op" id="4342154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4342158">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4342224">if</span>&nbsp;<span class="ident" id="4342227">c2</span><span class="op" id="4342229">,</span>&nbsp;<span class="ident" id="4342231">ok2</span>&nbsp;<span class="op" id="4342235">:=</span>&nbsp;<span class="ident" id="4342238">e</span><span class="op" id="4342239">.</span><span class="ident" id="4342240">escapeTemplateBody</span><span class="op" id="4342258">(</span><span class="ident" id="4342259">c1</span><span class="op" id="4342261">,</span>&nbsp;<span class="ident" id="4342263">t</span><span class="op" id="4342264">)</span><span class="op" id="4342265">;</span>&nbsp;<span class="ident" id="4342267">ok2</span>&nbsp;<span class="op" id="4342271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4342276">c1</span><span class="op" id="4342278">,</span>&nbsp;<span class="ident" id="4342280">ok</span>&nbsp;<span class="op" id="4342283">=</span>&nbsp;<span class="ident" id="4342285">c2</span><span class="op" id="4342287">,</span>&nbsp;<span class="builtintype" id="4342289">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4342296">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4342300">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4342362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4342365">if</span>&nbsp;<span class="op" id="4342368">!</span><span class="ident" id="4342369">ok</span>&nbsp;<span class="op" id="4342372">&amp;&amp;</span>&nbsp;<span class="ident" id="4342375">c1</span><span class="op" id="4342377">.</span><span class="ident" id="4342378">state</span>&nbsp;<span class="op" id="4342384">!=</span>&nbsp;<span class="ident" id="4342387">stateError</span>&nbsp;<span class="op" id="4342398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4342402">return</span>&nbsp;<span class="ident" id="4342409">context</span><span class="op" id="4342416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4342421">state</span><span class="op" id="4342426">:</span>&nbsp;<span class="ident" id="4342428">stateError</span><span class="op" id="4342438">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4342443">err</span><span class="op" id="4342446">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4342450">errorf</span><span class="op" id="4342456">(</span><span class="ident" id="4342457">ErrOutputContext</span><span class="op" id="4342473">,</span>&nbsp;<span class="ident" id="4342475">t</span><span class="op" id="4342476">.</span><span class="ident" id="4342477">Tree</span><span class="op" id="4342481">.</span><span class="ident" id="4342482">Root</span><span class="op" id="4342486">,</span>&nbsp;<span class="num" id="4342488">0</span><span class="op" id="4342489">,</span>&nbsp;<span class="string" id="4342491">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="4342538">,</span>&nbsp;<span class="ident" id="4342540">t</span><span class="op" id="4342541">.</span><span class="ident" id="4342542">Name</span><span class="op" id="4342546">(</span><span class="op" id="4342547">)</span><span class="op" id="4342548">)</span><span class="op" id="4342549">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4342553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4342556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4342559">return</span>&nbsp;<span class="ident" id="4342566">c1</span><br>
<span class="lineno"></span><span class="op" id="4342569">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="4342572">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4342647">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4342724">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="4342751">func</span>&nbsp;<span class="op" id="4342756">(</span><span class="ident" id="4342757">e</span>&nbsp;<span class="op" id="4342759">*</span><span class="ident" id="4342760">escaper</span><span class="op" id="4342767">)</span>&nbsp;<span class="ident" id="4342769">escapeTemplateBody</span><span class="op" id="4342787">(</span><span class="ident" id="4342788">c</span>&nbsp;<span class="ident" id="4342790">context</span><span class="op" id="4342797">,</span>&nbsp;<span class="ident" id="4342799">t</span>&nbsp;<span class="op" id="4342801">*</span><span class="ident" id="4342802">template</span><span class="op" id="4342810">.</span><span class="ident" id="4342811">Template</span><span class="op" id="4342819">)</span>&nbsp;<span class="op" id="4342821">(</span><span class="ident" id="4342822">context</span><span class="op" id="4342829">,</span>&nbsp;<span class="builtintype" id="4342831">bool</span><span class="op" id="4342835">)</span>&nbsp;<span class="op" id="4342837">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4342840">filter</span>&nbsp;<span class="op" id="4342847">:=</span>&nbsp;<span class="keyword" id="4342850">func</span><span class="op" id="4342854">(</span><span class="ident" id="4342855">e1</span>&nbsp;<span class="op" id="4342858">*</span><span class="ident" id="4342859">escaper</span><span class="op" id="4342866">,</span>&nbsp;<span class="ident" id="4342868">c1</span>&nbsp;<span class="ident" id="4342871">context</span><span class="op" id="4342878">)</span>&nbsp;<span class="builtintype" id="4342880">bool</span>&nbsp;<span class="op" id="4342885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4342889">if</span>&nbsp;<span class="ident" id="4342892">c1</span><span class="op" id="4342894">.</span><span class="ident" id="4342895">state</span>&nbsp;<span class="op" id="4342901">==</span>&nbsp;<span class="ident" id="4342904">stateError</span>&nbsp;<span class="op" id="4342915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4342920">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4342962">return</span>&nbsp;<span class="builtintype" id="4342969">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4342977">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4342981">if</span>&nbsp;<span class="op" id="4342984">!</span><span class="ident" id="4342985">e1</span><span class="op" id="4342987">.</span><span class="ident" id="4342988">called</span><span class="op" id="4342994">[</span><span class="ident" id="4342995">t</span><span class="op" id="4342996">.</span><span class="ident" id="4342997">Name</span><span class="op" id="4343001">(</span><span class="op" id="4343002">)</span><span class="op" id="4343003">]</span>&nbsp;<span class="op" id="4343005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343010">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343062">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4343093">return</span>&nbsp;<span class="builtintype" id="4343100">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4343107">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343111">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4343173">return</span>&nbsp;<span class="ident" id="4343180">c</span><span class="op" id="4343181">.</span><span class="ident" id="4343182">eq</span><span class="op" id="4343184">(</span><span class="ident" id="4343185">c1</span><span class="op" id="4343187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4343190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343193">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343266">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343340">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343410">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4343438">e</span><span class="op" id="4343439">.</span><span class="ident" id="4343440">output</span><span class="op" id="4343446">[</span><span class="ident" id="4343447">t</span><span class="op" id="4343448">.</span><span class="ident" id="4343449">Name</span><span class="op" id="4343453">(</span><span class="op" id="4343454">)</span><span class="op" id="4343455">]</span>&nbsp;<span class="op" id="4343457">=</span>&nbsp;<span class="ident" id="4343459">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4343462">return</span>&nbsp;<span class="ident" id="4343469">e</span><span class="op" id="4343470">.</span><span class="ident" id="4343471">escapeListConditionally</span><span class="op" id="4343494">(</span><span class="ident" id="4343495">c</span><span class="op" id="4343496">,</span>&nbsp;<span class="ident" id="4343498">t</span><span class="op" id="4343499">.</span><span class="ident" id="4343500">Tree</span><span class="op" id="4343504">.</span><span class="ident" id="4343505">Root</span><span class="op" id="4343509">,</span>&nbsp;<span class="ident" id="4343511">filter</span><span class="op" id="4343517">)</span><br>
<span class="lineno"></span><span class="op" id="4343519">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="4343522">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4343596">var</span>&nbsp;<span class="ident" id="4343600">delimEnds</span>&nbsp;<span class="op" id="4343610">=</span>&nbsp;<span class="op" id="4343612">[</span><span class="op" id="4343613">...</span><span class="op" id="4343616">]</span><span class="builtintype" id="4343617">string</span><span class="op" id="4343623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4343626">delimDoubleQuote</span><span class="op" id="4343642">:</span>&nbsp;<span class="string" id="4343644">`&#34;`</span><span class="op" id="4343647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4343650">delimSingleQuote</span><span class="op" id="4343666">:</span>&nbsp;<span class="string" id="4343668">&#34;&#39;&#34;</span><span class="op" id="4343671">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343674">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343743">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343788">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343828">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343902">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4343974">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4344024">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344030">delimSpaceOrTagEnd</span><span class="op" id="4344048">:</span>&nbsp;<span class="string" id="4344050">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="4344062">,</span><br>
<span class="lineno"></span><span class="op" id="4344064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="4344067">var</span>&nbsp;<span class="ident" id="4344071">doctypeBytes</span>&nbsp;<span class="op" id="4344084">=</span>&nbsp;<span class="op" id="4344086">[</span><span class="op" id="4344087">]</span><span class="builtintype" id="4344088">byte</span><span class="op" id="4344092">(</span><span class="string" id="4344093">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="4344104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4344107">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4344151">func</span>&nbsp;<span class="op" id="4344156">(</span><span class="ident" id="4344157">e</span>&nbsp;<span class="op" id="4344159">*</span><span class="ident" id="4344160">escaper</span><span class="op" id="4344167">)</span>&nbsp;<span class="ident" id="4344169">escapeText</span><span class="op" id="4344179">(</span><span class="ident" id="4344180">c</span>&nbsp;<span class="ident" id="4344182">context</span><span class="op" id="4344189">,</span>&nbsp;<span class="ident" id="4344191">n</span>&nbsp;<span class="op" id="4344193">*</span><span class="ident" id="4344194">parse</span><span class="op" id="4344199">.</span><span class="ident" id="4344200">TextNode</span><span class="op" id="4344208">)</span>&nbsp;<span class="ident" id="4344210">context</span>&nbsp;<span class="op" id="4344218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344221">s</span><span class="op" id="4344222">,</span>&nbsp;<span class="ident" id="4344224">written</span><span class="op" id="4344231">,</span>&nbsp;<span class="ident" id="4344233">i</span><span class="op" id="4344234">,</span>&nbsp;<span class="ident" id="4344236">b</span>&nbsp;<span class="op" id="4344238">:=</span>&nbsp;<span class="ident" id="4344241">n</span><span class="op" id="4344242">.</span><span class="ident" id="4344243">Text</span><span class="op" id="4344247">,</span>&nbsp;<span class="num" id="4344249">0</span><span class="op" id="4344250">,</span>&nbsp;<span class="num" id="4344252">0</span><span class="op" id="4344253">,</span>&nbsp;<span class="builtinfunc" id="4344255">new</span><span class="op" id="4344258">(</span><span class="ident" id="4344259">bytes</span><span class="op" id="4344264">.</span><span class="ident" id="4344265">Buffer</span><span class="op" id="4344271">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344274">for</span>&nbsp;<span class="ident" id="4344278">i</span>&nbsp;<span class="op" id="4344280">!=</span>&nbsp;<span class="builtinfunc" id="4344283">len</span><span class="op" id="4344286">(</span><span class="ident" id="4344287">s</span><span class="op" id="4344288">)</span>&nbsp;<span class="op" id="4344290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344294">c1</span><span class="op" id="4344296">,</span>&nbsp;<span class="ident" id="4344298">nread</span>&nbsp;<span class="op" id="4344304">:=</span>&nbsp;<span class="ident" id="4344307">contextAfterText</span><span class="op" id="4344323">(</span><span class="ident" id="4344324">c</span><span class="op" id="4344325">,</span>&nbsp;<span class="ident" id="4344327">s</span><span class="op" id="4344328">[</span><span class="ident" id="4344329">i</span><span class="op" id="4344330">:</span><span class="op" id="4344331">]</span><span class="op" id="4344332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344336">i1</span>&nbsp;<span class="op" id="4344339">:=</span>&nbsp;<span class="ident" id="4344342">i</span>&nbsp;<span class="op" id="4344344">+</span>&nbsp;<span class="ident" id="4344346">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344354">if</span>&nbsp;<span class="ident" id="4344357">c</span><span class="op" id="4344358">.</span><span class="ident" id="4344359">state</span>&nbsp;<span class="op" id="4344365">==</span>&nbsp;<span class="ident" id="4344368">stateText</span>&nbsp;<span class="op" id="4344378">||</span>&nbsp;<span class="ident" id="4344381">c</span><span class="op" id="4344382">.</span><span class="ident" id="4344383">state</span>&nbsp;<span class="op" id="4344389">==</span>&nbsp;<span class="ident" id="4344392">stateRCDATA</span>&nbsp;<span class="op" id="4344404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344409">end</span>&nbsp;<span class="op" id="4344413">:=</span>&nbsp;<span class="ident" id="4344416">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344422">if</span>&nbsp;<span class="ident" id="4344425">c1</span><span class="op" id="4344427">.</span><span class="ident" id="4344428">state</span>&nbsp;<span class="op" id="4344434">!=</span>&nbsp;<span class="ident" id="4344437">c</span><span class="op" id="4344438">.</span><span class="ident" id="4344439">state</span>&nbsp;<span class="op" id="4344445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344451">for</span>&nbsp;<span class="ident" id="4344455">j</span>&nbsp;<span class="op" id="4344457">:=</span>&nbsp;<span class="ident" id="4344460">end</span>&nbsp;<span class="op" id="4344464">-</span>&nbsp;<span class="num" id="4344466">1</span><span class="op" id="4344467">;</span>&nbsp;<span class="ident" id="4344469">j</span>&nbsp;<span class="op" id="4344471">&gt;=</span>&nbsp;<span class="ident" id="4344474">i</span><span class="op" id="4344475">;</span>&nbsp;<span class="ident" id="4344477">j</span><span class="op" id="4344478">--</span>&nbsp;<span class="op" id="4344481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344488">if</span>&nbsp;<span class="ident" id="4344491">s</span><span class="op" id="4344492">[</span><span class="ident" id="4344493">j</span><span class="op" id="4344494">]</span>&nbsp;<span class="op" id="4344496">==</span>&nbsp;<span class="string" id="4344499">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4344503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344511">end</span>&nbsp;<span class="op" id="4344515">=</span>&nbsp;<span class="ident" id="4344517">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344525">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4344536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4344542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4344547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344552">for</span>&nbsp;<span class="ident" id="4344556">j</span>&nbsp;<span class="op" id="4344558">:=</span>&nbsp;<span class="ident" id="4344561">i</span><span class="op" id="4344562">;</span>&nbsp;<span class="ident" id="4344564">j</span>&nbsp;<span class="op" id="4344566">&lt;</span>&nbsp;<span class="ident" id="4344568">end</span><span class="op" id="4344571">;</span>&nbsp;<span class="ident" id="4344573">j</span><span class="op" id="4344574">++</span>&nbsp;<span class="op" id="4344577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344583">if</span>&nbsp;<span class="ident" id="4344586">s</span><span class="op" id="4344587">[</span><span class="ident" id="4344588">j</span><span class="op" id="4344589">]</span>&nbsp;<span class="op" id="4344591">==</span>&nbsp;<span class="string" id="4344594">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4344598">&amp;&amp;</span>&nbsp;<span class="op" id="4344601">!</span><span class="ident" id="4344602">bytes</span><span class="op" id="4344607">.</span><span class="ident" id="4344608">HasPrefix</span><span class="op" id="4344617">(</span><span class="ident" id="4344618">bytes</span><span class="op" id="4344623">.</span><span class="ident" id="4344624">ToUpper</span><span class="op" id="4344631">(</span><span class="ident" id="4344632">s</span><span class="op" id="4344633">[</span><span class="ident" id="4344634">j</span><span class="op" id="4344635">:</span><span class="op" id="4344636">]</span><span class="op" id="4344637">)</span><span class="op" id="4344638">,</span>&nbsp;<span class="ident" id="4344640">doctypeBytes</span><span class="op" id="4344652">)</span>&nbsp;<span class="op" id="4344654">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344661">b</span><span class="op" id="4344662">.</span><span class="ident" id="4344663">Write</span><span class="op" id="4344668">(</span><span class="ident" id="4344669">s</span><span class="op" id="4344670">[</span><span class="ident" id="4344671">written</span><span class="op" id="4344678">:</span><span class="ident" id="4344679">j</span><span class="op" id="4344680">]</span><span class="op" id="4344681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344688">b</span><span class="op" id="4344689">.</span><span class="ident" id="4344690">WriteString</span><span class="op" id="4344701">(</span><span class="string" id="4344702">&#34;&amp;lt;&#34;</span><span class="op" id="4344708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4344715">written</span>&nbsp;<span class="op" id="4344723">=</span>&nbsp;<span class="ident" id="4344725">j</span>&nbsp;<span class="op" id="4344727">+</span>&nbsp;<span class="num" id="4344729">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4344735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4344740">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4344744">}</span>&nbsp;<span class="keyword" id="4344746">else</span>&nbsp;<span class="keyword" id="4344751">if</span>&nbsp;<span class="ident" id="4344754">isComment</span><span class="op" id="4344763">(</span><span class="ident" id="4344764">c</span><span class="op" id="4344765">.</span><span class="ident" id="4344766">state</span><span class="op" id="4344771">)</span>&nbsp;<span class="op" id="4344773">&amp;&amp;</span>&nbsp;<span class="ident" id="4344776">c</span><span class="op" id="4344777">.</span><span class="ident" id="4344778">delim</span>&nbsp;<span class="op" id="4344784">==</span>&nbsp;<span class="ident" id="4344787">delimNone</span>&nbsp;<span class="op" id="4344797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344802">switch</span>&nbsp;<span class="ident" id="4344809">c</span><span class="op" id="4344810">.</span><span class="ident" id="4344811">state</span>&nbsp;<span class="op" id="4344817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4344822">case</span>&nbsp;<span class="ident" id="4344827">stateJSBlockCmt</span><span class="op" id="4344842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4344848">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4344884">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4344933">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4344985">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345035">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345083">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345132">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4345163">if</span>&nbsp;<span class="ident" id="4345166">bytes</span><span class="op" id="4345171">.</span><span class="ident" id="4345172">IndexAny</span><span class="op" id="4345180">(</span><span class="ident" id="4345181">s</span><span class="op" id="4345182">[</span><span class="ident" id="4345183">written</span><span class="op" id="4345190">:</span><span class="ident" id="4345191">i1</span><span class="op" id="4345193">]</span><span class="op" id="4345194">,</span>&nbsp;<span class="string" id="4345196">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="4345214">)</span>&nbsp;<span class="op" id="4345216">!=</span>&nbsp;<span class="op" id="4345219">-</span><span class="num" id="4345220">1</span>&nbsp;<span class="op" id="4345222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345229">b</span><span class="op" id="4345230">.</span><span class="ident" id="4345231">WriteByte</span><span class="op" id="4345240">(</span><span class="string" id="4345241">&#39;\n&#39;</span><span class="op" id="4345245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345251">}</span>&nbsp;<span class="keyword" id="4345253">else</span>&nbsp;<span class="op" id="4345258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345265">b</span><span class="op" id="4345266">.</span><span class="ident" id="4345267">WriteByte</span><span class="op" id="4345276">(</span><span class="string" id="4345277">&#39;&nbsp;&#39;</span><span class="op" id="4345280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345286">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4345291">case</span>&nbsp;<span class="ident" id="4345296">stateCSSBlockCmt</span><span class="op" id="4345312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345318">b</span><span class="op" id="4345319">.</span><span class="ident" id="4345320">WriteByte</span><span class="op" id="4345329">(</span><span class="string" id="4345330">&#39;&nbsp;&#39;</span><span class="op" id="4345333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345343">written</span>&nbsp;<span class="op" id="4345351">=</span>&nbsp;<span class="ident" id="4345353">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345358">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4345362">if</span>&nbsp;<span class="ident" id="4345365">c</span><span class="op" id="4345366">.</span><span class="ident" id="4345367">state</span>&nbsp;<span class="op" id="4345373">!=</span>&nbsp;<span class="ident" id="4345376">c1</span><span class="op" id="4345378">.</span><span class="ident" id="4345379">state</span>&nbsp;<span class="op" id="4345385">&amp;&amp;</span>&nbsp;<span class="ident" id="4345388">isComment</span><span class="op" id="4345397">(</span><span class="ident" id="4345398">c1</span><span class="op" id="4345400">.</span><span class="ident" id="4345401">state</span><span class="op" id="4345406">)</span>&nbsp;<span class="op" id="4345408">&amp;&amp;</span>&nbsp;<span class="ident" id="4345411">c1</span><span class="op" id="4345413">.</span><span class="ident" id="4345414">delim</span>&nbsp;<span class="op" id="4345420">==</span>&nbsp;<span class="ident" id="4345423">delimNone</span>&nbsp;<span class="op" id="4345433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345438">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345504">cs</span>&nbsp;<span class="op" id="4345507">:=</span>&nbsp;<span class="ident" id="4345510">i1</span>&nbsp;<span class="op" id="4345513">-</span>&nbsp;<span class="num" id="4345515">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4345520">if</span>&nbsp;<span class="ident" id="4345523">c1</span><span class="op" id="4345525">.</span><span class="ident" id="4345526">state</span>&nbsp;<span class="op" id="4345532">==</span>&nbsp;<span class="ident" id="4345535">stateHTMLCmt</span>&nbsp;<span class="op" id="4345548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4345554">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345592">cs</span>&nbsp;<span class="op" id="4345595">-=</span>&nbsp;<span class="num" id="4345598">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345608">b</span><span class="op" id="4345609">.</span><span class="ident" id="4345610">Write</span><span class="op" id="4345615">(</span><span class="ident" id="4345616">s</span><span class="op" id="4345617">[</span><span class="ident" id="4345618">written</span><span class="op" id="4345625">:</span><span class="ident" id="4345626">cs</span><span class="op" id="4345628">]</span><span class="op" id="4345629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345634">written</span>&nbsp;<span class="op" id="4345642">=</span>&nbsp;<span class="ident" id="4345644">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345649">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4345653">if</span>&nbsp;<span class="ident" id="4345656">i</span>&nbsp;<span class="op" id="4345658">==</span>&nbsp;<span class="ident" id="4345661">i1</span>&nbsp;<span class="op" id="4345664">&amp;&amp;</span>&nbsp;<span class="ident" id="4345667">c</span><span class="op" id="4345668">.</span><span class="ident" id="4345669">state</span>&nbsp;<span class="op" id="4345675">==</span>&nbsp;<span class="ident" id="4345678">c1</span><span class="op" id="4345680">.</span><span class="ident" id="4345681">state</span>&nbsp;<span class="op" id="4345687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4345692">panic</span><span class="op" id="4345697">(</span><span class="ident" id="4345698">fmt</span><span class="op" id="4345701">.</span><span class="ident" id="4345702">Sprintf</span><span class="op" id="4345709">(</span><span class="string" id="4345710">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="4345749">,</span>&nbsp;<span class="ident" id="4345751">c</span><span class="op" id="4345752">,</span>&nbsp;<span class="ident" id="4345754">c1</span><span class="op" id="4345756">,</span>&nbsp;<span class="ident" id="4345758">s</span><span class="op" id="4345759">[</span><span class="op" id="4345760">:</span><span class="ident" id="4345761">i</span><span class="op" id="4345762">]</span><span class="op" id="4345763">,</span>&nbsp;<span class="ident" id="4345765">s</span><span class="op" id="4345766">[</span><span class="ident" id="4345767">i</span><span class="op" id="4345768">:</span><span class="op" id="4345769">]</span><span class="op" id="4345770">)</span><span class="op" id="4345771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345779">c</span><span class="op" id="4345780">,</span>&nbsp;<span class="ident" id="4345782">i</span>&nbsp;<span class="op" id="4345784">=</span>&nbsp;<span class="ident" id="4345786">c1</span><span class="op" id="4345788">,</span>&nbsp;<span class="ident" id="4345790">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345794">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4345798">if</span>&nbsp;<span class="ident" id="4345801">written</span>&nbsp;<span class="op" id="4345809">!=</span>&nbsp;<span class="num" id="4345812">0</span>&nbsp;<span class="op" id="4345814">&amp;&amp;</span>&nbsp;<span class="ident" id="4345817">c</span><span class="op" id="4345818">.</span><span class="ident" id="4345819">state</span>&nbsp;<span class="op" id="4345825">!=</span>&nbsp;<span class="ident" id="4345828">stateError</span>&nbsp;<span class="op" id="4345839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4345843">if</span>&nbsp;<span class="op" id="4345846">!</span><span class="ident" id="4345847">isComment</span><span class="op" id="4345856">(</span><span class="ident" id="4345857">c</span><span class="op" id="4345858">.</span><span class="ident" id="4345859">state</span><span class="op" id="4345864">)</span>&nbsp;<span class="op" id="4345866">||</span>&nbsp;<span class="ident" id="4345869">c</span><span class="op" id="4345870">.</span><span class="ident" id="4345871">delim</span>&nbsp;<span class="op" id="4345877">!=</span>&nbsp;<span class="ident" id="4345880">delimNone</span>&nbsp;<span class="op" id="4345890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345895">b</span><span class="op" id="4345896">.</span><span class="ident" id="4345897">Write</span><span class="op" id="4345902">(</span><span class="ident" id="4345903">n</span><span class="op" id="4345904">.</span><span class="ident" id="4345905">Text</span><span class="op" id="4345909">[</span><span class="ident" id="4345910">written</span><span class="op" id="4345917">:</span><span class="op" id="4345918">]</span><span class="op" id="4345919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345923">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4345927">e</span><span class="op" id="4345928">.</span><span class="ident" id="4345929">editTextNode</span><span class="op" id="4345941">(</span><span class="ident" id="4345942">n</span><span class="op" id="4345943">,</span>&nbsp;<span class="ident" id="4345945">b</span><span class="op" id="4345946">.</span><span class="ident" id="4345947">Bytes</span><span class="op" id="4345952">(</span><span class="op" id="4345953">)</span><span class="op" id="4345954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4345957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4345960">return</span>&nbsp;<span class="ident" id="4345967">c</span><br>
<span class="lineno"></span><span class="op" id="4345969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="4345972">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4346052">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="4346130">func</span>&nbsp;<span class="ident" id="4346135">contextAfterText</span><span class="op" id="4346151">(</span><span class="ident" id="4346152">c</span>&nbsp;<span class="ident" id="4346154">context</span><span class="op" id="4346161">,</span>&nbsp;<span class="ident" id="4346163">s</span>&nbsp;<span class="op" id="4346165">[</span><span class="op" id="4346166">]</span><span class="builtintype" id="4346167">byte</span><span class="op" id="4346171">)</span>&nbsp;<span class="op" id="4346173">(</span><span class="ident" id="4346174">context</span><span class="op" id="4346181">,</span>&nbsp;<span class="builtintype" id="4346183">int</span><span class="op" id="4346186">)</span>&nbsp;<span class="op" id="4346188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346191">if</span>&nbsp;<span class="ident" id="4346194">c</span><span class="op" id="4346195">.</span><span class="ident" id="4346196">delim</span>&nbsp;<span class="op" id="4346202">==</span>&nbsp;<span class="ident" id="4346205">delimNone</span>&nbsp;<span class="op" id="4346215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4346219">c1</span><span class="op" id="4346221">,</span>&nbsp;<span class="ident" id="4346223">i</span>&nbsp;<span class="op" id="4346225">:=</span>&nbsp;<span class="ident" id="4346228">tSpecialTagEnd</span><span class="op" id="4346242">(</span><span class="ident" id="4346243">c</span><span class="op" id="4346244">,</span>&nbsp;<span class="ident" id="4346246">s</span><span class="op" id="4346247">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346251">if</span>&nbsp;<span class="ident" id="4346254">i</span>&nbsp;<span class="op" id="4346256">==</span>&nbsp;<span class="num" id="4346259">0</span>&nbsp;<span class="op" id="4346261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346266">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346322">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346372">return</span>&nbsp;<span class="ident" id="4346379">c1</span><span class="op" id="4346381">,</span>&nbsp;<span class="num" id="4346383">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4346387">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346391">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346436">return</span>&nbsp;<span class="ident" id="4346443">transitionFunc</span><span class="op" id="4346457">[</span><span class="ident" id="4346458">c</span><span class="op" id="4346459">.</span><span class="ident" id="4346460">state</span><span class="op" id="4346465">]</span><span class="op" id="4346466">(</span><span class="ident" id="4346467">c</span><span class="op" id="4346468">,</span>&nbsp;<span class="ident" id="4346470">s</span><span class="op" id="4346471">[</span><span class="op" id="4346472">:</span><span class="ident" id="4346473">i</span><span class="op" id="4346474">]</span><span class="op" id="4346475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4346478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4346482">i</span>&nbsp;<span class="op" id="4346484">:=</span>&nbsp;<span class="ident" id="4346487">bytes</span><span class="op" id="4346492">.</span><span class="ident" id="4346493">IndexAny</span><span class="op" id="4346501">(</span><span class="ident" id="4346502">s</span><span class="op" id="4346503">,</span>&nbsp;<span class="ident" id="4346505">delimEnds</span><span class="op" id="4346514">[</span><span class="ident" id="4346515">c</span><span class="op" id="4346516">.</span><span class="ident" id="4346517">delim</span><span class="op" id="4346522">]</span><span class="op" id="4346523">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346526">if</span>&nbsp;<span class="ident" id="4346529">i</span>&nbsp;<span class="op" id="4346531">==</span>&nbsp;<span class="op" id="4346534">-</span><span class="num" id="4346535">1</span>&nbsp;<span class="op" id="4346537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4346541">i</span>&nbsp;<span class="op" id="4346543">=</span>&nbsp;<span class="builtinfunc" id="4346545">len</span><span class="op" id="4346548">(</span><span class="ident" id="4346549">s</span><span class="op" id="4346550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4346553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346556">if</span>&nbsp;<span class="ident" id="4346559">c</span><span class="op" id="4346560">.</span><span class="ident" id="4346561">delim</span>&nbsp;<span class="op" id="4346567">==</span>&nbsp;<span class="ident" id="4346570">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="4346589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346593">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346670">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346718">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346776">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346842">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346892">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4346945">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4346990">if</span>&nbsp;<span class="ident" id="4346993">j</span>&nbsp;<span class="op" id="4346995">:=</span>&nbsp;<span class="ident" id="4346998">bytes</span><span class="op" id="4347003">.</span><span class="ident" id="4347004">IndexAny</span><span class="op" id="4347012">(</span><span class="ident" id="4347013">s</span><span class="op" id="4347014">[</span><span class="op" id="4347015">:</span><span class="ident" id="4347016">i</span><span class="op" id="4347017">]</span><span class="op" id="4347018">,</span>&nbsp;<span class="string" id="4347020">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="4347028">)</span><span class="op" id="4347029">;</span>&nbsp;<span class="ident" id="4347031">j</span>&nbsp;<span class="op" id="4347033">&gt;=</span>&nbsp;<span class="num" id="4347036">0</span>&nbsp;<span class="op" id="4347038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347043">return</span>&nbsp;<span class="ident" id="4347050">context</span><span class="op" id="4347057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347063">state</span><span class="op" id="4347068">:</span>&nbsp;<span class="ident" id="4347070">stateError</span><span class="op" id="4347080">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347086">err</span><span class="op" id="4347089">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4347093">errorf</span><span class="op" id="4347099">(</span><span class="ident" id="4347100">ErrBadHTML</span><span class="op" id="4347110">,</span>&nbsp;<span class="builtintype" id="4347112">nil</span><span class="op" id="4347115">,</span>&nbsp;<span class="num" id="4347117">0</span><span class="op" id="4347118">,</span>&nbsp;<span class="string" id="4347120">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="4347145">,</span>&nbsp;<span class="ident" id="4347147">s</span><span class="op" id="4347148">[</span><span class="ident" id="4347149">j</span><span class="op" id="4347150">:</span><span class="ident" id="4347151">j</span><span class="op" id="4347152">+</span><span class="num" id="4347153">1</span><span class="op" id="4347154">]</span><span class="op" id="4347155">,</span>&nbsp;<span class="ident" id="4347157">s</span><span class="op" id="4347158">[</span><span class="op" id="4347159">:</span><span class="ident" id="4347160">i</span><span class="op" id="4347161">]</span><span class="op" id="4347162">)</span><span class="op" id="4347163">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4347168">}</span><span class="op" id="4347169">,</span>&nbsp;<span class="builtinfunc" id="4347171">len</span><span class="op" id="4347174">(</span><span class="ident" id="4347175">s</span><span class="op" id="4347176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4347180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4347183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347186">if</span>&nbsp;<span class="ident" id="4347189">i</span>&nbsp;<span class="op" id="4347191">==</span>&nbsp;<span class="builtinfunc" id="4347194">len</span><span class="op" id="4347197">(</span><span class="ident" id="4347198">s</span><span class="op" id="4347199">)</span>&nbsp;<span class="op" id="4347201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347205">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347239">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347297">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347348">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347403">for</span>&nbsp;<span class="ident" id="4347407">u</span>&nbsp;<span class="op" id="4347409">:=</span>&nbsp;<span class="op" id="4347412">[</span><span class="op" id="4347413">]</span><span class="builtintype" id="4347414">byte</span><span class="op" id="4347418">(</span><span class="ident" id="4347419">html</span><span class="op" id="4347423">.</span><span class="ident" id="4347424">UnescapeString</span><span class="op" id="4347438">(</span><span class="builtintype" id="4347439">string</span><span class="op" id="4347445">(</span><span class="ident" id="4347446">s</span><span class="op" id="4347447">)</span><span class="op" id="4347448">)</span><span class="op" id="4347449">)</span><span class="op" id="4347450">;</span>&nbsp;<span class="builtinfunc" id="4347452">len</span><span class="op" id="4347455">(</span><span class="ident" id="4347456">u</span><span class="op" id="4347457">)</span>&nbsp;<span class="op" id="4347459">!=</span>&nbsp;<span class="num" id="4347462">0</span><span class="op" id="4347463">;</span>&nbsp;<span class="op" id="4347465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347470">c1</span><span class="op" id="4347472">,</span>&nbsp;<span class="ident" id="4347474">i1</span>&nbsp;<span class="op" id="4347477">:=</span>&nbsp;<span class="ident" id="4347480">transitionFunc</span><span class="op" id="4347494">[</span><span class="ident" id="4347495">c</span><span class="op" id="4347496">.</span><span class="ident" id="4347497">state</span><span class="op" id="4347502">]</span><span class="op" id="4347503">(</span><span class="ident" id="4347504">c</span><span class="op" id="4347505">,</span>&nbsp;<span class="ident" id="4347507">u</span><span class="op" id="4347508">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347513">c</span><span class="op" id="4347514">,</span>&nbsp;<span class="ident" id="4347516">u</span>&nbsp;<span class="op" id="4347518">=</span>&nbsp;<span class="ident" id="4347520">c1</span><span class="op" id="4347522">,</span>&nbsp;<span class="ident" id="4347524">u</span><span class="op" id="4347525">[</span><span class="ident" id="4347526">i1</span><span class="op" id="4347528">:</span><span class="op" id="4347529">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4347533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347537">return</span>&nbsp;<span class="ident" id="4347544">c</span><span class="op" id="4347545">,</span>&nbsp;<span class="builtinfunc" id="4347547">len</span><span class="op" id="4347550">(</span><span class="ident" id="4347551">s</span><span class="op" id="4347552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4347555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347558">if</span>&nbsp;<span class="ident" id="4347561">c</span><span class="op" id="4347562">.</span><span class="ident" id="4347563">delim</span>&nbsp;<span class="op" id="4347569">!=</span>&nbsp;<span class="ident" id="4347572">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="4347591">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347595">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4347619">i</span><span class="op" id="4347620">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4347624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347627">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4347689">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347723">return</span>&nbsp;<span class="ident" id="4347730">context</span><span class="op" id="4347737">{</span><span class="ident" id="4347738">state</span><span class="op" id="4347743">:</span>&nbsp;<span class="ident" id="4347745">stateTag</span><span class="op" id="4347753">,</span>&nbsp;<span class="ident" id="4347755">element</span><span class="op" id="4347762">:</span>&nbsp;<span class="ident" id="4347764">c</span><span class="op" id="4347765">.</span><span class="ident" id="4347766">element</span><span class="op" id="4347773">}</span><span class="op" id="4347774">,</span>&nbsp;<span class="ident" id="4347776">i</span><br>
<span class="lineno"></span><span class="op" id="4347778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4347781">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="4347856">func</span>&nbsp;<span class="op" id="4347861">(</span><span class="ident" id="4347862">e</span>&nbsp;<span class="op" id="4347864">*</span><span class="ident" id="4347865">escaper</span><span class="op" id="4347872">)</span>&nbsp;<span class="ident" id="4347874">editActionNode</span><span class="op" id="4347888">(</span><span class="ident" id="4347889">n</span>&nbsp;<span class="op" id="4347891">*</span><span class="ident" id="4347892">parse</span><span class="op" id="4347897">.</span><span class="ident" id="4347898">ActionNode</span><span class="op" id="4347908">,</span>&nbsp;<span class="ident" id="4347910">cmds</span>&nbsp;<span class="op" id="4347915">[</span><span class="op" id="4347916">]</span><span class="builtintype" id="4347917">string</span><span class="op" id="4347923">)</span>&nbsp;<span class="op" id="4347925">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4347928">if</span>&nbsp;<span class="ident" id="4347931">_</span><span class="op" id="4347932">,</span>&nbsp;<span class="ident" id="4347934">ok</span>&nbsp;<span class="op" id="4347937">:=</span>&nbsp;<span class="ident" id="4347940">e</span><span class="op" id="4347941">.</span><span class="ident" id="4347942">actionNodeEdits</span><span class="op" id="4347957">[</span><span class="ident" id="4347958">n</span><span class="op" id="4347959">]</span><span class="op" id="4347960">;</span>&nbsp;<span class="ident" id="4347962">ok</span>&nbsp;<span class="op" id="4347965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4347969">panic</span><span class="op" id="4347974">(</span><span class="ident" id="4347975">fmt</span><span class="op" id="4347978">.</span><span class="ident" id="4347979">Sprintf</span><span class="op" id="4347986">(</span><span class="string" id="4347987">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4348021">,</span>&nbsp;<span class="ident" id="4348023">n</span><span class="op" id="4348024">)</span><span class="op" id="4348025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4348028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348031">e</span><span class="op" id="4348032">.</span><span class="ident" id="4348033">actionNodeEdits</span><span class="op" id="4348048">[</span><span class="ident" id="4348049">n</span><span class="op" id="4348050">]</span>&nbsp;<span class="op" id="4348052">=</span>&nbsp;<span class="ident" id="4348054">cmds</span><br>
<span class="lineno"></span><span class="op" id="4348059">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="4348062">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="4348142">func</span>&nbsp;<span class="op" id="4348147">(</span><span class="ident" id="4348148">e</span>&nbsp;<span class="op" id="4348150">*</span><span class="ident" id="4348151">escaper</span><span class="op" id="4348158">)</span>&nbsp;<span class="ident" id="4348160">editTemplateNode</span><span class="op" id="4348176">(</span><span class="ident" id="4348177">n</span>&nbsp;<span class="op" id="4348179">*</span><span class="ident" id="4348180">parse</span><span class="op" id="4348185">.</span><span class="ident" id="4348186">TemplateNode</span><span class="op" id="4348198">,</span>&nbsp;<span class="ident" id="4348200">callee</span>&nbsp;<span class="builtintype" id="4348207">string</span><span class="op" id="4348213">)</span>&nbsp;<span class="op" id="4348215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348218">if</span>&nbsp;<span class="ident" id="4348221">_</span><span class="op" id="4348222">,</span>&nbsp;<span class="ident" id="4348224">ok</span>&nbsp;<span class="op" id="4348227">:=</span>&nbsp;<span class="ident" id="4348230">e</span><span class="op" id="4348231">.</span><span class="ident" id="4348232">templateNodeEdits</span><span class="op" id="4348249">[</span><span class="ident" id="4348250">n</span><span class="op" id="4348251">]</span><span class="op" id="4348252">;</span>&nbsp;<span class="ident" id="4348254">ok</span>&nbsp;<span class="op" id="4348257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4348261">panic</span><span class="op" id="4348266">(</span><span class="ident" id="4348267">fmt</span><span class="op" id="4348270">.</span><span class="ident" id="4348271">Sprintf</span><span class="op" id="4348278">(</span><span class="string" id="4348279">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4348313">,</span>&nbsp;<span class="ident" id="4348315">n</span><span class="op" id="4348316">)</span><span class="op" id="4348317">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4348320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348323">e</span><span class="op" id="4348324">.</span><span class="ident" id="4348325">templateNodeEdits</span><span class="op" id="4348342">[</span><span class="ident" id="4348343">n</span><span class="op" id="4348344">]</span>&nbsp;<span class="op" id="4348346">=</span>&nbsp;<span class="ident" id="4348348">callee</span><br>
<span class="lineno"></span><span class="op" id="4348355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4348358">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="4348424">func</span>&nbsp;<span class="op" id="4348429">(</span><span class="ident" id="4348430">e</span>&nbsp;<span class="op" id="4348432">*</span><span class="ident" id="4348433">escaper</span><span class="op" id="4348440">)</span>&nbsp;<span class="ident" id="4348442">editTextNode</span><span class="op" id="4348454">(</span><span class="ident" id="4348455">n</span>&nbsp;<span class="op" id="4348457">*</span><span class="ident" id="4348458">parse</span><span class="op" id="4348463">.</span><span class="ident" id="4348464">TextNode</span><span class="op" id="4348472">,</span>&nbsp;<span class="ident" id="4348474">text</span>&nbsp;<span class="op" id="4348479">[</span><span class="op" id="4348480">]</span><span class="builtintype" id="4348481">byte</span><span class="op" id="4348485">)</span>&nbsp;<span class="op" id="4348487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348490">if</span>&nbsp;<span class="ident" id="4348493">_</span><span class="op" id="4348494">,</span>&nbsp;<span class="ident" id="4348496">ok</span>&nbsp;<span class="op" id="4348499">:=</span>&nbsp;<span class="ident" id="4348502">e</span><span class="op" id="4348503">.</span><span class="ident" id="4348504">textNodeEdits</span><span class="op" id="4348517">[</span><span class="ident" id="4348518">n</span><span class="op" id="4348519">]</span><span class="op" id="4348520">;</span>&nbsp;<span class="ident" id="4348522">ok</span>&nbsp;<span class="op" id="4348525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4348529">panic</span><span class="op" id="4348534">(</span><span class="ident" id="4348535">fmt</span><span class="op" id="4348538">.</span><span class="ident" id="4348539">Sprintf</span><span class="op" id="4348546">(</span><span class="string" id="4348547">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4348581">,</span>&nbsp;<span class="ident" id="4348583">n</span><span class="op" id="4348584">)</span><span class="op" id="4348585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4348588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348591">e</span><span class="op" id="4348592">.</span><span class="ident" id="4348593">textNodeEdits</span><span class="op" id="4348606">[</span><span class="ident" id="4348607">n</span><span class="op" id="4348608">]</span>&nbsp;<span class="op" id="4348610">=</span>&nbsp;<span class="ident" id="4348612">text</span><br>
<span class="lineno">735</span><span class="op" id="4348617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4348620">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="4348699">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="4348764">func</span>&nbsp;<span class="op" id="4348769">(</span><span class="ident" id="4348770">e</span>&nbsp;<span class="op" id="4348772">*</span><span class="ident" id="4348773">escaper</span><span class="op" id="4348780">)</span>&nbsp;<span class="ident" id="4348782">commit</span><span class="op" id="4348788">(</span><span class="op" id="4348789">)</span>&nbsp;<span class="op" id="4348791">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348794">for</span>&nbsp;<span class="ident" id="4348798">name</span>&nbsp;<span class="op" id="4348803">:=</span>&nbsp;<span class="keyword" id="4348806">range</span>&nbsp;<span class="ident" id="4348812">e</span><span class="op" id="4348813">.</span><span class="ident" id="4348814">output</span>&nbsp;<span class="op" id="4348821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4348825">e</span><span class="op" id="4348826">.</span><span class="ident" id="4348827">template</span><span class="op" id="4348835">(</span><span class="ident" id="4348836">name</span><span class="op" id="4348840">)</span><span class="op" id="4348841">.</span><span class="ident" id="4348842">Funcs</span><span class="op" id="4348847">(</span><span class="ident" id="4348848">funcMap</span><span class="op" id="4348855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4348858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348861">for</span>&nbsp;<span class="ident" id="4348865">_</span><span class="op" id="4348866">,</span>&nbsp;<span class="ident" id="4348868">t</span>&nbsp;<span class="op" id="4348870">:=</span>&nbsp;<span class="keyword" id="4348873">range</span>&nbsp;<span class="ident" id="4348879">e</span><span class="op" id="4348880">.</span><span class="ident" id="4348881">derived</span>&nbsp;<span class="op" id="4348889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4348893">if</span>&nbsp;<span class="ident" id="4348896">_</span><span class="op" id="4348897">,</span>&nbsp;<span class="ident" id="4348899">err</span>&nbsp;<span class="op" id="4348903">:=</span>&nbsp;<span class="ident" id="4348906">e</span><span class="op" id="4348907">.</span><span class="ident" id="4348908">tmpl</span><span class="op" id="4348912">.</span><span class="ident" id="4348913">text</span><span class="op" id="4348917">.</span><span class="ident" id="4348918">AddParseTree</span><span class="op" id="4348930">(</span><span class="ident" id="4348931">t</span><span class="op" id="4348932">.</span><span class="ident" id="4348933">Name</span><span class="op" id="4348937">(</span><span class="op" id="4348938">)</span><span class="op" id="4348939">,</span>&nbsp;<span class="ident" id="4348941">t</span><span class="op" id="4348942">.</span><span class="ident" id="4348943">Tree</span><span class="op" id="4348947">)</span><span class="op" id="4348948">;</span>&nbsp;<span class="ident" id="4348950">err</span>&nbsp;<span class="op" id="4348954">!=</span>&nbsp;<span class="builtintype" id="4348957">nil</span>&nbsp;<span class="op" id="4348961">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4348966">panic</span><span class="op" id="4348971">(</span><span class="string" id="4348972">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="4349003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349013">for</span>&nbsp;<span class="ident" id="4349017">n</span><span class="op" id="4349018">,</span>&nbsp;<span class="ident" id="4349020">s</span>&nbsp;<span class="op" id="4349022">:=</span>&nbsp;<span class="keyword" id="4349025">range</span>&nbsp;<span class="ident" id="4349031">e</span><span class="op" id="4349032">.</span><span class="ident" id="4349033">actionNodeEdits</span>&nbsp;<span class="op" id="4349049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349053">ensurePipelineContains</span><span class="op" id="4349075">(</span><span class="ident" id="4349076">n</span><span class="op" id="4349077">.</span><span class="ident" id="4349078">Pipe</span><span class="op" id="4349082">,</span>&nbsp;<span class="ident" id="4349084">s</span><span class="op" id="4349085">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349091">for</span>&nbsp;<span class="ident" id="4349095">n</span><span class="op" id="4349096">,</span>&nbsp;<span class="ident" id="4349098">name</span>&nbsp;<span class="op" id="4349103">:=</span>&nbsp;<span class="keyword" id="4349106">range</span>&nbsp;<span class="ident" id="4349112">e</span><span class="op" id="4349113">.</span><span class="ident" id="4349114">templateNodeEdits</span>&nbsp;<span class="op" id="4349132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349136">n</span><span class="op" id="4349137">.</span><span class="ident" id="4349138">Name</span>&nbsp;<span class="op" id="4349143">=</span>&nbsp;<span class="ident" id="4349145">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349154">for</span>&nbsp;<span class="ident" id="4349158">n</span><span class="op" id="4349159">,</span>&nbsp;<span class="ident" id="4349161">s</span>&nbsp;<span class="op" id="4349163">:=</span>&nbsp;<span class="keyword" id="4349166">range</span>&nbsp;<span class="ident" id="4349172">e</span><span class="op" id="4349173">.</span><span class="ident" id="4349174">textNodeEdits</span>&nbsp;<span class="op" id="4349188">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349192">n</span><span class="op" id="4349193">.</span><span class="ident" id="4349194">Text</span>&nbsp;<span class="op" id="4349199">=</span>&nbsp;<span class="ident" id="4349201">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349204">}</span><br>
<span class="lineno"></span><span class="op" id="4349206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4349209">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="4349279">func</span>&nbsp;<span class="op" id="4349284">(</span><span class="ident" id="4349285">e</span>&nbsp;<span class="op" id="4349287">*</span><span class="ident" id="4349288">escaper</span><span class="op" id="4349295">)</span>&nbsp;<span class="ident" id="4349297">template</span><span class="op" id="4349305">(</span><span class="ident" id="4349306">name</span>&nbsp;<span class="builtintype" id="4349311">string</span><span class="op" id="4349317">)</span>&nbsp;<span class="op" id="4349319">*</span><span class="ident" id="4349320">template</span><span class="op" id="4349328">.</span><span class="ident" id="4349329">Template</span>&nbsp;<span class="op" id="4349338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349341">t</span>&nbsp;<span class="op" id="4349343">:=</span>&nbsp;<span class="ident" id="4349346">e</span><span class="op" id="4349347">.</span><span class="ident" id="4349348">tmpl</span><span class="op" id="4349352">.</span><span class="ident" id="4349353">text</span><span class="op" id="4349357">.</span><span class="ident" id="4349358">Lookup</span><span class="op" id="4349364">(</span><span class="ident" id="4349365">name</span><span class="op" id="4349369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349372">if</span>&nbsp;<span class="ident" id="4349375">t</span>&nbsp;<span class="op" id="4349377">==</span>&nbsp;<span class="builtintype" id="4349380">nil</span>&nbsp;<span class="op" id="4349384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349388">t</span>&nbsp;<span class="op" id="4349390">=</span>&nbsp;<span class="ident" id="4349392">e</span><span class="op" id="4349393">.</span><span class="ident" id="4349394">derived</span><span class="op" id="4349401">[</span><span class="ident" id="4349402">name</span><span class="op" id="4349406">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349409">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349412">return</span>&nbsp;<span class="ident" id="4349419">t</span><br>
<span class="lineno"></span><span class="op" id="4349421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4349424">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4349494">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4349556">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="4349636">func</span>&nbsp;<span class="ident" id="4349641">HTMLEscape</span><span class="op" id="4349651">(</span><span class="ident" id="4349652">w</span>&nbsp;<span class="ident" id="4349654">io</span><span class="op" id="4349656">.</span><span class="ident" id="4349657">Writer</span><span class="op" id="4349663">,</span>&nbsp;<span class="ident" id="4349665">b</span>&nbsp;<span class="op" id="4349667">[</span><span class="op" id="4349668">]</span><span class="builtintype" id="4349669">byte</span><span class="op" id="4349673">)</span>&nbsp;<span class="op" id="4349675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4349678">template</span><span class="op" id="4349686">.</span><span class="ident" id="4349687">HTMLEscape</span><span class="op" id="4349697">(</span><span class="ident" id="4349698">w</span><span class="op" id="4349699">,</span>&nbsp;<span class="ident" id="4349701">b</span><span class="op" id="4349702">)</span><br>
<span class="lineno"></span><span class="op" id="4349704">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="4349707">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="4349789">func</span>&nbsp;<span class="ident" id="4349794">HTMLEscapeString</span><span class="op" id="4349810">(</span><span class="ident" id="4349811">s</span>&nbsp;<span class="builtintype" id="4349813">string</span><span class="op" id="4349819">)</span>&nbsp;<span class="builtintype" id="4349821">string</span>&nbsp;<span class="op" id="4349828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4349831">return</span>&nbsp;<span class="ident" id="4349838">template</span><span class="op" id="4349846">.</span><span class="ident" id="4349847">HTMLEscapeString</span><span class="op" id="4349863">(</span><span class="ident" id="4349864">s</span><span class="op" id="4349865">)</span><br>
<span class="lineno"></span><span class="op" id="4349867">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="4349870">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="4349936">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="4349972">func</span>&nbsp;<span class="ident" id="4349977">HTMLEscaper</span><span class="op" id="4349988">(</span><span class="ident" id="4349989">args</span>&nbsp;<span class="op" id="4349994">...</span><span class="keyword" id="4349997">interface</span><span class="op" id="4350006">{</span><span class="op" id="4350007">}</span><span class="op" id="4350008">)</span>&nbsp;<span class="builtintype" id="4350010">string</span>&nbsp;<span class="op" id="4350017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350020">return</span>&nbsp;<span class="ident" id="4350027">template</span><span class="op" id="4350035">.</span><span class="ident" id="4350036">HTMLEscaper</span><span class="op" id="4350047">(</span><span class="ident" id="4350048">args</span><span class="op" id="4350052">...</span><span class="op" id="4350055">)</span><br>
<span class="lineno">785</span><span class="op" id="4350057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4350060">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="4350144">func</span>&nbsp;<span class="ident" id="4350149">JSEscape</span><span class="op" id="4350157">(</span><span class="ident" id="4350158">w</span>&nbsp;<span class="ident" id="4350160">io</span><span class="op" id="4350162">.</span><span class="ident" id="4350163">Writer</span><span class="op" id="4350169">,</span>&nbsp;<span class="ident" id="4350171">b</span>&nbsp;<span class="op" id="4350173">[</span><span class="op" id="4350174">]</span><span class="builtintype" id="4350175">byte</span><span class="op" id="4350179">)</span>&nbsp;<span class="op" id="4350181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4350184">template</span><span class="op" id="4350192">.</span><span class="ident" id="4350193">JSEscape</span><span class="op" id="4350201">(</span><span class="ident" id="4350202">w</span><span class="op" id="4350203">,</span>&nbsp;<span class="ident" id="4350205">b</span><span class="op" id="4350206">)</span><br>
<span class="lineno">790</span><span class="op" id="4350208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4350211">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="4350297">func</span>&nbsp;<span class="ident" id="4350302">JSEscapeString</span><span class="op" id="4350316">(</span><span class="ident" id="4350317">s</span>&nbsp;<span class="builtintype" id="4350319">string</span><span class="op" id="4350325">)</span>&nbsp;<span class="builtintype" id="4350327">string</span>&nbsp;<span class="op" id="4350334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350337">return</span>&nbsp;<span class="ident" id="4350344">template</span><span class="op" id="4350352">.</span><span class="ident" id="4350353">JSEscapeString</span><span class="op" id="4350367">(</span><span class="ident" id="4350368">s</span><span class="op" id="4350369">)</span><br>
<span class="lineno">795</span><span class="op" id="4350371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4350374">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="4350444">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="4350480">func</span>&nbsp;<span class="ident" id="4350485">JSEscaper</span><span class="op" id="4350494">(</span><span class="ident" id="4350495">args</span>&nbsp;<span class="op" id="4350500">...</span><span class="keyword" id="4350503">interface</span><span class="op" id="4350512">{</span><span class="op" id="4350513">}</span><span class="op" id="4350514">)</span>&nbsp;<span class="builtintype" id="4350516">string</span>&nbsp;<span class="op" id="4350523">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350526">return</span>&nbsp;<span class="ident" id="4350533">template</span><span class="op" id="4350541">.</span><span class="ident" id="4350542">JSEscaper</span><span class="op" id="4350551">(</span><span class="ident" id="4350552">args</span><span class="op" id="4350556">...</span><span class="op" id="4350559">)</span><br>
<span class="lineno"></span><span class="op" id="4350561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4350564">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4350642">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="4350708">func</span>&nbsp;<span class="ident" id="4350713">URLQueryEscaper</span><span class="op" id="4350728">(</span><span class="ident" id="4350729">args</span>&nbsp;<span class="op" id="4350734">...</span><span class="keyword" id="4350737">interface</span><span class="op" id="4350746">{</span><span class="op" id="4350747">}</span><span class="op" id="4350748">)</span>&nbsp;<span class="builtintype" id="4350750">string</span>&nbsp;<span class="op" id="4350757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4350760">return</span>&nbsp;<span class="ident" id="4350767">template</span><span class="op" id="4350775">.</span><span class="ident" id="4350776">URLQueryEscaper</span><span class="op" id="4350791">(</span><span class="ident" id="4350792">args</span><span class="op" id="4350796">...</span><span class="op" id="4350799">)</span><br>
<span class="lineno"></span><span class="op" id="4350801">}</span>
</div>
</body>
</html>
