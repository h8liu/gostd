<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html" class="current">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2536730">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2536785">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2536839">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2536890">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2536907">package</span>&nbsp;<span class="ident" id="2536915">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2536924">import</span>&nbsp;<span class="op" id="2536931">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2536934">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2536943">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2536946">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2537036">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2537063">type</span>&nbsp;<span class="ident" id="2537068">SysProcIDMap</span>&nbsp;<span class="keyword" id="2537081">struct</span>&nbsp;<span class="op" id="2537088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537091">ContainerID</span>&nbsp;<span class="builtintype" id="2537103">int</span>&nbsp;<span class="comment" id="2537107">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537125">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537137">int</span>&nbsp;<span class="comment" id="2537141">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537154">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537166">int</span>&nbsp;<span class="comment" id="2537170">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2537179">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2537182">type</span>&nbsp;<span class="ident" id="2537187">SysProcAttr</span>&nbsp;<span class="keyword" id="2537199">struct</span>&nbsp;<span class="op" id="2537206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537209">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537221">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537236">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537248">Credential</span>&nbsp;&nbsp;<span class="op" id="2537260">*</span><span class="ident" id="2537261">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537275">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537291">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537303">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537318">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537338">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537350">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537365">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537385">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537397">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537412">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537463">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537475">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537490">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537565">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537577">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537592">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537634">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2537646">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537661">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537697">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2537709">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537724">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537795">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2537807">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2537822">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537861">UidMappings</span>&nbsp;<span class="op" id="2537873">[</span><span class="op" id="2537874">]</span><span class="ident" id="2537875">SysProcIDMap</span>&nbsp;<span class="comment" id="2537888">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2537930">GidMappings</span>&nbsp;<span class="op" id="2537942">[</span><span class="op" id="2537943">]</span><span class="ident" id="2537944">SysProcIDMap</span>&nbsp;<span class="comment" id="2537957">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2537999">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2538002">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2538037">func</span>&nbsp;<span class="ident" id="2538042">runtime_BeforeFork</span><span class="op" id="2538060">(</span><span class="op" id="2538061">)</span><br>
<span class="lineno"></span><span class="keyword" id="2538063">func</span>&nbsp;<span class="ident" id="2538068">runtime_AfterFork</span><span class="op" id="2538085">(</span><span class="op" id="2538086">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2538089">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2538161">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2538219">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2538286">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2538353">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2538421">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2538485">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2538546">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2538608">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2538649">func</span>&nbsp;<span class="ident" id="2538654">forkAndExecInChild</span><span class="op" id="2538672">(</span><span class="ident" id="2538673">argv0</span>&nbsp;<span class="op" id="2538679">*</span><span class="builtintype" id="2538680">byte</span><span class="op" id="2538684">,</span>&nbsp;<span class="ident" id="2538686">argv</span><span class="op" id="2538690">,</span>&nbsp;<span class="ident" id="2538692">envv</span>&nbsp;<span class="op" id="2538697">[</span><span class="op" id="2538698">]</span><span class="op" id="2538699">*</span><span class="builtintype" id="2538700">byte</span><span class="op" id="2538704">,</span>&nbsp;<span class="ident" id="2538706">chroot</span><span class="op" id="2538712">,</span>&nbsp;<span class="ident" id="2538714">dir</span>&nbsp;<span class="op" id="2538718">*</span><span class="builtintype" id="2538719">byte</span><span class="op" id="2538723">,</span>&nbsp;<span class="ident" id="2538725">attr</span>&nbsp;<span class="op" id="2538730">*</span><span class="ident" id="2538731">ProcAttr</span><span class="op" id="2538739">,</span>&nbsp;<span class="ident" id="2538741">sys</span>&nbsp;<span class="op" id="2538745">*</span><span class="ident" id="2538746">SysProcAttr</span><span class="op" id="2538757">,</span>&nbsp;<span class="ident" id="2538759">pipe</span>&nbsp;<span class="builtintype" id="2538764">int</span><span class="op" id="2538767">)</span>&nbsp;<span class="op" id="2538769">(</span><span class="ident" id="2538770">pid</span>&nbsp;<span class="builtintype" id="2538774">int</span><span class="op" id="2538777">,</span>&nbsp;<span class="ident" id="2538779">err</span>&nbsp;<span class="ident" id="2538783">Errno</span><span class="op" id="2538788">)</span>&nbsp;<span class="op" id="2538790">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2538793">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2538838">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2538893">var</span>&nbsp;<span class="op" id="2538897">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2538901">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2538908">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2538918">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2538925">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2538933">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2538940">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2538948">nextfd</span>&nbsp;<span class="builtintype" id="2538955">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2538961">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2538968">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2538974">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2538981">[</span><span class="num" id="2538982">2</span><span class="op" id="2538983">]</span><span class="builtintype" id="2538984">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2538989">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2538993">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2539048">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2539112">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539171">fd</span>&nbsp;<span class="op" id="2539174">:=</span>&nbsp;<span class="builtinfunc" id="2539177">make</span><span class="op" id="2539181">(</span><span class="op" id="2539182">[</span><span class="op" id="2539183">]</span><span class="builtintype" id="2539184">int</span><span class="op" id="2539187">,</span>&nbsp;<span class="builtinfunc" id="2539189">len</span><span class="op" id="2539192">(</span><span class="ident" id="2539193">attr</span><span class="op" id="2539197">.</span><span class="ident" id="2539198">Files</span><span class="op" id="2539203">)</span><span class="op" id="2539204">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539207">nextfd</span>&nbsp;<span class="op" id="2539214">=</span>&nbsp;<span class="builtinfunc" id="2539216">len</span><span class="op" id="2539219">(</span><span class="ident" id="2539220">attr</span><span class="op" id="2539224">.</span><span class="ident" id="2539225">Files</span><span class="op" id="2539230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539233">for</span>&nbsp;<span class="ident" id="2539237">i</span><span class="op" id="2539238">,</span>&nbsp;<span class="ident" id="2539240">ufd</span>&nbsp;<span class="op" id="2539244">:=</span>&nbsp;<span class="keyword" id="2539247">range</span>&nbsp;<span class="ident" id="2539253">attr</span><span class="op" id="2539257">.</span><span class="ident" id="2539258">Files</span>&nbsp;<span class="op" id="2539264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539268">if</span>&nbsp;<span class="ident" id="2539271">nextfd</span>&nbsp;<span class="op" id="2539278">&lt;</span>&nbsp;<span class="builtintype" id="2539280">int</span><span class="op" id="2539283">(</span><span class="ident" id="2539284">ufd</span><span class="op" id="2539287">)</span>&nbsp;<span class="op" id="2539289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539294">nextfd</span>&nbsp;<span class="op" id="2539301">=</span>&nbsp;<span class="builtintype" id="2539303">int</span><span class="op" id="2539306">(</span><span class="ident" id="2539307">ufd</span><span class="op" id="2539310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2539314">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539318">fd</span><span class="op" id="2539320">[</span><span class="ident" id="2539321">i</span><span class="op" id="2539322">]</span>&nbsp;<span class="op" id="2539324">=</span>&nbsp;<span class="builtintype" id="2539326">int</span><span class="op" id="2539329">(</span><span class="ident" id="2539330">ufd</span><span class="op" id="2539333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2539336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539339">nextfd</span><span class="op" id="2539345">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2539350">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2539414">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539470">if</span>&nbsp;<span class="ident" id="2539473">sys</span><span class="op" id="2539476">.</span><span class="ident" id="2539477">UidMappings</span>&nbsp;<span class="op" id="2539489">!=</span>&nbsp;<span class="ident" id="2539492">nil</span>&nbsp;<span class="op" id="2539496">||</span>&nbsp;<span class="ident" id="2539499">sys</span><span class="op" id="2539502">.</span><span class="ident" id="2539503">GidMappings</span>&nbsp;<span class="op" id="2539515">!=</span>&nbsp;<span class="ident" id="2539518">nil</span>&nbsp;<span class="op" id="2539522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539526">if</span>&nbsp;<span class="ident" id="2539529">err</span>&nbsp;<span class="op" id="2539533">:=</span>&nbsp;<span class="ident" id="2539536">forkExecPipe</span><span class="op" id="2539548">(</span><span class="ident" id="2539549">p</span><span class="op" id="2539550">[</span><span class="op" id="2539551">:</span><span class="op" id="2539552">]</span><span class="op" id="2539553">)</span><span class="op" id="2539554">;</span>&nbsp;<span class="ident" id="2539556">err</span>&nbsp;<span class="op" id="2539560">!=</span>&nbsp;<span class="ident" id="2539563">nil</span>&nbsp;<span class="op" id="2539567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539572">return</span>&nbsp;<span class="num" id="2539579">0</span><span class="op" id="2539580">,</span>&nbsp;<span class="ident" id="2539582">err</span><span class="op" id="2539585">.</span><span class="op" id="2539586">(</span><span class="ident" id="2539587">Errno</span><span class="op" id="2539592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2539596">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2539599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2539603">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2539627">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539686">runtime_BeforeFork</span><span class="op" id="2539704">(</span><span class="op" id="2539705">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539708">r1</span><span class="op" id="2539710">,</span>&nbsp;<span class="ident" id="2539712">_</span><span class="op" id="2539713">,</span>&nbsp;<span class="ident" id="2539715">err1</span>&nbsp;<span class="op" id="2539720">=</span>&nbsp;<span class="ident" id="2539722">RawSyscall6</span><span class="op" id="2539733">(</span><span class="ident" id="2539734">SYS_CLONE</span><span class="op" id="2539743">,</span>&nbsp;<span class="builtintype" id="2539745">uintptr</span><span class="op" id="2539752">(</span><span class="ident" id="2539753">SIGCHLD</span><span class="op" id="2539760">)</span><span class="op" id="2539761">|</span><span class="ident" id="2539762">sys</span><span class="op" id="2539765">.</span><span class="ident" id="2539766">Cloneflags</span><span class="op" id="2539776">,</span>&nbsp;<span class="num" id="2539778">0</span><span class="op" id="2539779">,</span>&nbsp;<span class="num" id="2539781">0</span><span class="op" id="2539782">,</span>&nbsp;<span class="num" id="2539784">0</span><span class="op" id="2539785">,</span>&nbsp;<span class="num" id="2539787">0</span><span class="op" id="2539788">,</span>&nbsp;<span class="num" id="2539790">0</span><span class="op" id="2539791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539794">if</span>&nbsp;<span class="ident" id="2539797">err1</span>&nbsp;<span class="op" id="2539802">!=</span>&nbsp;<span class="num" id="2539805">0</span>&nbsp;<span class="op" id="2539807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539811">runtime_AfterFork</span><span class="op" id="2539828">(</span><span class="op" id="2539829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539833">return</span>&nbsp;<span class="num" id="2539840">0</span><span class="op" id="2539841">,</span>&nbsp;<span class="ident" id="2539843">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2539849">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539853">if</span>&nbsp;<span class="ident" id="2539856">r1</span>&nbsp;<span class="op" id="2539859">!=</span>&nbsp;<span class="num" id="2539862">0</span>&nbsp;<span class="op" id="2539864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2539868">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539892">runtime_AfterFork</span><span class="op" id="2539909">(</span><span class="op" id="2539910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539914">pid</span>&nbsp;<span class="op" id="2539918">=</span>&nbsp;<span class="builtintype" id="2539920">int</span><span class="op" id="2539923">(</span><span class="ident" id="2539924">r1</span><span class="op" id="2539926">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2539931">if</span>&nbsp;<span class="ident" id="2539934">sys</span><span class="op" id="2539937">.</span><span class="ident" id="2539938">UidMappings</span>&nbsp;<span class="op" id="2539950">!=</span>&nbsp;<span class="ident" id="2539953">nil</span>&nbsp;<span class="op" id="2539957">||</span>&nbsp;<span class="ident" id="2539960">sys</span><span class="op" id="2539963">.</span><span class="ident" id="2539964">GidMappings</span>&nbsp;<span class="op" id="2539976">!=</span>&nbsp;<span class="ident" id="2539979">nil</span>&nbsp;<span class="op" id="2539983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2539988">Close</span><span class="op" id="2539993">(</span><span class="ident" id="2539994">p</span><span class="op" id="2539995">[</span><span class="num" id="2539996">0</span><span class="op" id="2539997">]</span><span class="op" id="2539998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2540003">err</span>&nbsp;<span class="op" id="2540007">:=</span>&nbsp;<span class="ident" id="2540010">writeUidGidMappings</span><span class="op" id="2540029">(</span><span class="ident" id="2540030">pid</span><span class="op" id="2540033">,</span>&nbsp;<span class="ident" id="2540035">sys</span><span class="op" id="2540038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540043">if</span>&nbsp;<span class="ident" id="2540046">err</span>&nbsp;<span class="op" id="2540050">!=</span>&nbsp;<span class="ident" id="2540053">nil</span>&nbsp;<span class="op" id="2540057">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2540063">err2</span>&nbsp;<span class="op" id="2540068">=</span>&nbsp;<span class="ident" id="2540070">err</span><span class="op" id="2540073">.</span><span class="op" id="2540074">(</span><span class="ident" id="2540075">Errno</span><span class="op" id="2540080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2540090">RawSyscall</span><span class="op" id="2540100">(</span><span class="ident" id="2540101">SYS_WRITE</span><span class="op" id="2540110">,</span>&nbsp;<span class="builtintype" id="2540112">uintptr</span><span class="op" id="2540119">(</span><span class="ident" id="2540120">p</span><span class="op" id="2540121">[</span><span class="num" id="2540122">1</span><span class="op" id="2540123">]</span><span class="op" id="2540124">)</span><span class="op" id="2540125">,</span>&nbsp;<span class="builtintype" id="2540127">uintptr</span><span class="op" id="2540134">(</span><span class="ident" id="2540135">unsafe</span><span class="op" id="2540141">.</span><span class="ident" id="2540142">Pointer</span><span class="op" id="2540149">(</span><span class="op" id="2540150">&amp;</span><span class="ident" id="2540151">err2</span><span class="op" id="2540155">)</span><span class="op" id="2540156">)</span><span class="op" id="2540157">,</span>&nbsp;<span class="ident" id="2540159">unsafe</span><span class="op" id="2540165">.</span><span class="ident" id="2540166">Sizeof</span><span class="op" id="2540172">(</span><span class="ident" id="2540173">err2</span><span class="op" id="2540177">)</span><span class="op" id="2540178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2540183">Close</span><span class="op" id="2540188">(</span><span class="ident" id="2540189">p</span><span class="op" id="2540190">[</span><span class="num" id="2540191">1</span><span class="op" id="2540192">]</span><span class="op" id="2540193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540197">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540202">return</span>&nbsp;<span class="ident" id="2540209">pid</span><span class="op" id="2540212">,</span>&nbsp;<span class="num" id="2540214">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2540221">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2540256">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540310">if</span>&nbsp;<span class="ident" id="2540313">sys</span><span class="op" id="2540316">.</span><span class="ident" id="2540317">UidMappings</span>&nbsp;<span class="op" id="2540329">!=</span>&nbsp;<span class="ident" id="2540332">nil</span>&nbsp;<span class="op" id="2540336">||</span>&nbsp;<span class="ident" id="2540339">sys</span><span class="op" id="2540342">.</span><span class="ident" id="2540343">GidMappings</span>&nbsp;<span class="op" id="2540355">!=</span>&nbsp;<span class="ident" id="2540358">nil</span>&nbsp;<span class="op" id="2540362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540366">if</span>&nbsp;<span class="ident" id="2540369">_</span><span class="op" id="2540370">,</span>&nbsp;<span class="ident" id="2540372">_</span><span class="op" id="2540373">,</span>&nbsp;<span class="ident" id="2540375">err1</span>&nbsp;<span class="op" id="2540380">=</span>&nbsp;<span class="ident" id="2540382">RawSyscall</span><span class="op" id="2540392">(</span><span class="ident" id="2540393">SYS_CLOSE</span><span class="op" id="2540402">,</span>&nbsp;<span class="builtintype" id="2540404">uintptr</span><span class="op" id="2540411">(</span><span class="ident" id="2540412">p</span><span class="op" id="2540413">[</span><span class="num" id="2540414">1</span><span class="op" id="2540415">]</span><span class="op" id="2540416">)</span><span class="op" id="2540417">,</span>&nbsp;<span class="num" id="2540419">0</span><span class="op" id="2540420">,</span>&nbsp;<span class="num" id="2540422">0</span><span class="op" id="2540423">)</span><span class="op" id="2540424">;</span>&nbsp;<span class="ident" id="2540426">err1</span>&nbsp;<span class="op" id="2540431">!=</span>&nbsp;<span class="num" id="2540434">0</span>&nbsp;<span class="op" id="2540436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540441">goto</span>&nbsp;<span class="ident" id="2540446">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2540463">r1</span><span class="op" id="2540465">,</span>&nbsp;<span class="ident" id="2540467">_</span><span class="op" id="2540468">,</span>&nbsp;<span class="ident" id="2540470">err1</span>&nbsp;<span class="op" id="2540475">=</span>&nbsp;<span class="ident" id="2540477">RawSyscall</span><span class="op" id="2540487">(</span><span class="ident" id="2540488">SYS_READ</span><span class="op" id="2540496">,</span>&nbsp;<span class="builtintype" id="2540498">uintptr</span><span class="op" id="2540505">(</span><span class="ident" id="2540506">p</span><span class="op" id="2540507">[</span><span class="num" id="2540508">0</span><span class="op" id="2540509">]</span><span class="op" id="2540510">)</span><span class="op" id="2540511">,</span>&nbsp;<span class="builtintype" id="2540513">uintptr</span><span class="op" id="2540520">(</span><span class="ident" id="2540521">unsafe</span><span class="op" id="2540527">.</span><span class="ident" id="2540528">Pointer</span><span class="op" id="2540535">(</span><span class="op" id="2540536">&amp;</span><span class="ident" id="2540537">err2</span><span class="op" id="2540541">)</span><span class="op" id="2540542">)</span><span class="op" id="2540543">,</span>&nbsp;<span class="ident" id="2540545">unsafe</span><span class="op" id="2540551">.</span><span class="ident" id="2540552">Sizeof</span><span class="op" id="2540558">(</span><span class="ident" id="2540559">err2</span><span class="op" id="2540563">)</span><span class="op" id="2540564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540568">if</span>&nbsp;<span class="ident" id="2540571">err1</span>&nbsp;<span class="op" id="2540576">!=</span>&nbsp;<span class="num" id="2540579">0</span>&nbsp;<span class="op" id="2540581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540586">goto</span>&nbsp;<span class="ident" id="2540591">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540604">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540608">if</span>&nbsp;<span class="ident" id="2540611">r1</span>&nbsp;<span class="op" id="2540614">!=</span>&nbsp;<span class="ident" id="2540617">unsafe</span><span class="op" id="2540623">.</span><span class="ident" id="2540624">Sizeof</span><span class="op" id="2540630">(</span><span class="ident" id="2540631">err2</span><span class="op" id="2540635">)</span>&nbsp;<span class="op" id="2540637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2540642">err1</span>&nbsp;<span class="op" id="2540647">=</span>&nbsp;<span class="ident" id="2540649">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540659">goto</span>&nbsp;<span class="ident" id="2540664">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540681">if</span>&nbsp;<span class="ident" id="2540684">err2</span>&nbsp;<span class="op" id="2540689">!=</span>&nbsp;<span class="num" id="2540692">0</span>&nbsp;<span class="op" id="2540694">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2540699">err1</span>&nbsp;<span class="op" id="2540704">=</span>&nbsp;<span class="ident" id="2540706">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540714">goto</span>&nbsp;<span class="ident" id="2540719">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2540739">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540763">if</span>&nbsp;<span class="ident" id="2540766">sys</span><span class="op" id="2540769">.</span><span class="ident" id="2540770">Pdeathsig</span>&nbsp;<span class="op" id="2540780">!=</span>&nbsp;<span class="num" id="2540783">0</span>&nbsp;<span class="op" id="2540785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2540789">_</span><span class="op" id="2540790">,</span>&nbsp;<span class="ident" id="2540792">_</span><span class="op" id="2540793">,</span>&nbsp;<span class="ident" id="2540795">err1</span>&nbsp;<span class="op" id="2540800">=</span>&nbsp;<span class="ident" id="2540802">RawSyscall6</span><span class="op" id="2540813">(</span><span class="ident" id="2540814">SYS_PRCTL</span><span class="op" id="2540823">,</span>&nbsp;<span class="ident" id="2540825">PR_SET_PDEATHSIG</span><span class="op" id="2540841">,</span>&nbsp;<span class="builtintype" id="2540843">uintptr</span><span class="op" id="2540850">(</span><span class="ident" id="2540851">sys</span><span class="op" id="2540854">.</span><span class="ident" id="2540855">Pdeathsig</span><span class="op" id="2540864">)</span><span class="op" id="2540865">,</span>&nbsp;<span class="num" id="2540867">0</span><span class="op" id="2540868">,</span>&nbsp;<span class="num" id="2540870">0</span><span class="op" id="2540871">,</span>&nbsp;<span class="num" id="2540873">0</span><span class="op" id="2540874">,</span>&nbsp;<span class="num" id="2540876">0</span><span class="op" id="2540877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540881">if</span>&nbsp;<span class="ident" id="2540884">err1</span>&nbsp;<span class="op" id="2540889">!=</span>&nbsp;<span class="num" id="2540892">0</span>&nbsp;<span class="op" id="2540894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2540899">goto</span>&nbsp;<span class="ident" id="2540904">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2540917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2540922">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2540985">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2541047">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2541067">r1</span><span class="op" id="2541069">,</span>&nbsp;<span class="ident" id="2541071">_</span><span class="op" id="2541072">,</span>&nbsp;<span class="ident" id="2541074">_</span>&nbsp;<span class="op" id="2541076">=</span>&nbsp;<span class="ident" id="2541078">RawSyscall</span><span class="op" id="2541088">(</span><span class="ident" id="2541089">SYS_GETPPID</span><span class="op" id="2541100">,</span>&nbsp;<span class="num" id="2541102">0</span><span class="op" id="2541103">,</span>&nbsp;<span class="num" id="2541105">0</span><span class="op" id="2541106">,</span>&nbsp;<span class="num" id="2541108">0</span><span class="op" id="2541109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541113">if</span>&nbsp;<span class="ident" id="2541116">r1</span>&nbsp;<span class="op" id="2541119">==</span>&nbsp;<span class="num" id="2541122">1</span>&nbsp;<span class="op" id="2541124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2541129">pid</span><span class="op" id="2541132">,</span>&nbsp;<span class="ident" id="2541134">_</span><span class="op" id="2541135">,</span>&nbsp;<span class="ident" id="2541137">_</span>&nbsp;<span class="op" id="2541139">:=</span>&nbsp;<span class="ident" id="2541142">RawSyscall</span><span class="op" id="2541152">(</span><span class="ident" id="2541153">SYS_GETPID</span><span class="op" id="2541163">,</span>&nbsp;<span class="num" id="2541165">0</span><span class="op" id="2541166">,</span>&nbsp;<span class="num" id="2541168">0</span><span class="op" id="2541169">,</span>&nbsp;<span class="num" id="2541171">0</span><span class="op" id="2541172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2541177">_</span><span class="op" id="2541178">,</span>&nbsp;<span class="ident" id="2541180">_</span><span class="op" id="2541181">,</span>&nbsp;<span class="ident" id="2541183">err1</span>&nbsp;<span class="op" id="2541188">:=</span>&nbsp;<span class="ident" id="2541191">RawSyscall</span><span class="op" id="2541201">(</span><span class="ident" id="2541202">SYS_KILL</span><span class="op" id="2541210">,</span>&nbsp;<span class="ident" id="2541212">pid</span><span class="op" id="2541215">,</span>&nbsp;<span class="builtintype" id="2541217">uintptr</span><span class="op" id="2541224">(</span><span class="ident" id="2541225">sys</span><span class="op" id="2541228">.</span><span class="ident" id="2541229">Pdeathsig</span><span class="op" id="2541238">)</span><span class="op" id="2541239">,</span>&nbsp;<span class="num" id="2541241">0</span><span class="op" id="2541242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541247">if</span>&nbsp;<span class="ident" id="2541250">err1</span>&nbsp;<span class="op" id="2541255">!=</span>&nbsp;<span class="num" id="2541258">0</span>&nbsp;<span class="op" id="2541260">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541266">goto</span>&nbsp;<span class="ident" id="2541271">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2541296">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541329">if</span>&nbsp;<span class="ident" id="2541332">sys</span><span class="op" id="2541335">.</span><span class="ident" id="2541336">Ptrace</span>&nbsp;<span class="op" id="2541343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2541347">_</span><span class="op" id="2541348">,</span>&nbsp;<span class="ident" id="2541350">_</span><span class="op" id="2541351">,</span>&nbsp;<span class="ident" id="2541353">err1</span>&nbsp;<span class="op" id="2541358">=</span>&nbsp;<span class="ident" id="2541360">RawSyscall</span><span class="op" id="2541370">(</span><span class="ident" id="2541371">SYS_PTRACE</span><span class="op" id="2541381">,</span>&nbsp;<span class="builtintype" id="2541383">uintptr</span><span class="op" id="2541390">(</span><span class="ident" id="2541391">PTRACE_TRACEME</span><span class="op" id="2541405">)</span><span class="op" id="2541406">,</span>&nbsp;<span class="num" id="2541408">0</span><span class="op" id="2541409">,</span>&nbsp;<span class="num" id="2541411">0</span><span class="op" id="2541412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541416">if</span>&nbsp;<span class="ident" id="2541419">err1</span>&nbsp;<span class="op" id="2541424">!=</span>&nbsp;<span class="num" id="2541427">0</span>&nbsp;<span class="op" id="2541429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541434">goto</span>&nbsp;<span class="ident" id="2541439">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2541459">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541474">if</span>&nbsp;<span class="ident" id="2541477">sys</span><span class="op" id="2541480">.</span><span class="ident" id="2541481">Setsid</span>&nbsp;<span class="op" id="2541488">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2541492">_</span><span class="op" id="2541493">,</span>&nbsp;<span class="ident" id="2541495">_</span><span class="op" id="2541496">,</span>&nbsp;<span class="ident" id="2541498">err1</span>&nbsp;<span class="op" id="2541503">=</span>&nbsp;<span class="ident" id="2541505">RawSyscall</span><span class="op" id="2541515">(</span><span class="ident" id="2541516">SYS_SETSID</span><span class="op" id="2541526">,</span>&nbsp;<span class="num" id="2541528">0</span><span class="op" id="2541529">,</span>&nbsp;<span class="num" id="2541531">0</span><span class="op" id="2541532">,</span>&nbsp;<span class="num" id="2541534">0</span><span class="op" id="2541535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541539">if</span>&nbsp;<span class="ident" id="2541542">err1</span>&nbsp;<span class="op" id="2541547">!=</span>&nbsp;<span class="num" id="2541550">0</span>&nbsp;<span class="op" id="2541552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541557">goto</span>&nbsp;<span class="ident" id="2541562">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541578">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2541582">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541604">if</span>&nbsp;<span class="ident" id="2541607">sys</span><span class="op" id="2541610">.</span><span class="ident" id="2541611">Setpgid</span>&nbsp;<span class="op" id="2541619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2541623">_</span><span class="op" id="2541624">,</span>&nbsp;<span class="ident" id="2541626">_</span><span class="op" id="2541627">,</span>&nbsp;<span class="ident" id="2541629">err1</span>&nbsp;<span class="op" id="2541634">=</span>&nbsp;<span class="ident" id="2541636">RawSyscall</span><span class="op" id="2541646">(</span><span class="ident" id="2541647">SYS_SETPGID</span><span class="op" id="2541658">,</span>&nbsp;<span class="num" id="2541660">0</span><span class="op" id="2541661">,</span>&nbsp;<span class="num" id="2541663">0</span><span class="op" id="2541664">,</span>&nbsp;<span class="num" id="2541666">0</span><span class="op" id="2541667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541671">if</span>&nbsp;<span class="ident" id="2541674">err1</span>&nbsp;<span class="op" id="2541679">!=</span>&nbsp;<span class="num" id="2541682">0</span>&nbsp;<span class="op" id="2541684">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541689">goto</span>&nbsp;<span class="ident" id="2541694">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2541714">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541725">if</span>&nbsp;<span class="ident" id="2541728">chroot</span>&nbsp;<span class="op" id="2541735">!=</span>&nbsp;<span class="ident" id="2541738">nil</span>&nbsp;<span class="op" id="2541742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2541746">_</span><span class="op" id="2541747">,</span>&nbsp;<span class="ident" id="2541749">_</span><span class="op" id="2541750">,</span>&nbsp;<span class="ident" id="2541752">err1</span>&nbsp;<span class="op" id="2541757">=</span>&nbsp;<span class="ident" id="2541759">RawSyscall</span><span class="op" id="2541769">(</span><span class="ident" id="2541770">SYS_CHROOT</span><span class="op" id="2541780">,</span>&nbsp;<span class="builtintype" id="2541782">uintptr</span><span class="op" id="2541789">(</span><span class="ident" id="2541790">unsafe</span><span class="op" id="2541796">.</span><span class="ident" id="2541797">Pointer</span><span class="op" id="2541804">(</span><span class="ident" id="2541805">chroot</span><span class="op" id="2541811">)</span><span class="op" id="2541812">)</span><span class="op" id="2541813">,</span>&nbsp;<span class="num" id="2541815">0</span><span class="op" id="2541816">,</span>&nbsp;<span class="num" id="2541818">0</span><span class="op" id="2541819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541823">if</span>&nbsp;<span class="ident" id="2541826">err1</span>&nbsp;<span class="op" id="2541831">!=</span>&nbsp;<span class="num" id="2541834">0</span>&nbsp;<span class="op" id="2541836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541841">goto</span>&nbsp;<span class="ident" id="2541846">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541859">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2541862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2541866">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541886">if</span>&nbsp;<span class="ident" id="2541889">cred</span>&nbsp;<span class="op" id="2541894">:=</span>&nbsp;<span class="ident" id="2541897">sys</span><span class="op" id="2541900">.</span><span class="ident" id="2541901">Credential</span><span class="op" id="2541911">;</span>&nbsp;<span class="ident" id="2541913">cred</span>&nbsp;<span class="op" id="2541918">!=</span>&nbsp;<span class="ident" id="2541921">nil</span>&nbsp;<span class="op" id="2541925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2541929">ngroups</span>&nbsp;<span class="op" id="2541937">:=</span>&nbsp;<span class="builtintype" id="2541940">uintptr</span><span class="op" id="2541947">(</span><span class="builtinfunc" id="2541948">len</span><span class="op" id="2541951">(</span><span class="ident" id="2541952">cred</span><span class="op" id="2541956">.</span><span class="ident" id="2541957">Groups</span><span class="op" id="2541963">)</span><span class="op" id="2541964">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541968">var</span>&nbsp;<span class="ident" id="2541972">groups</span>&nbsp;<span class="ident" id="2541979">unsafe</span><span class="op" id="2541985">.</span><span class="ident" id="2541986">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2541996">if</span>&nbsp;<span class="ident" id="2541999">ngroups</span>&nbsp;<span class="op" id="2542007">&gt;</span>&nbsp;<span class="num" id="2542009">0</span>&nbsp;<span class="op" id="2542011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542016">groups</span>&nbsp;<span class="op" id="2542023">=</span>&nbsp;<span class="ident" id="2542025">unsafe</span><span class="op" id="2542031">.</span><span class="ident" id="2542032">Pointer</span><span class="op" id="2542039">(</span><span class="op" id="2542040">&amp;</span><span class="ident" id="2542041">cred</span><span class="op" id="2542045">.</span><span class="ident" id="2542046">Groups</span><span class="op" id="2542052">[</span><span class="num" id="2542053">0</span><span class="op" id="2542054">]</span><span class="op" id="2542055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542063">_</span><span class="op" id="2542064">,</span>&nbsp;<span class="ident" id="2542066">_</span><span class="op" id="2542067">,</span>&nbsp;<span class="ident" id="2542069">err1</span>&nbsp;<span class="op" id="2542074">=</span>&nbsp;<span class="ident" id="2542076">RawSyscall</span><span class="op" id="2542086">(</span><span class="ident" id="2542087">SYS_SETGROUPS</span><span class="op" id="2542100">,</span>&nbsp;<span class="ident" id="2542102">ngroups</span><span class="op" id="2542109">,</span>&nbsp;<span class="builtintype" id="2542111">uintptr</span><span class="op" id="2542118">(</span><span class="ident" id="2542119">groups</span><span class="op" id="2542125">)</span><span class="op" id="2542126">,</span>&nbsp;<span class="num" id="2542128">0</span><span class="op" id="2542129">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542133">if</span>&nbsp;<span class="ident" id="2542136">err1</span>&nbsp;<span class="op" id="2542141">!=</span>&nbsp;<span class="num" id="2542144">0</span>&nbsp;<span class="op" id="2542146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542151">goto</span>&nbsp;<span class="ident" id="2542156">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542173">_</span><span class="op" id="2542174">,</span>&nbsp;<span class="ident" id="2542176">_</span><span class="op" id="2542177">,</span>&nbsp;<span class="ident" id="2542179">err1</span>&nbsp;<span class="op" id="2542184">=</span>&nbsp;<span class="ident" id="2542186">RawSyscall</span><span class="op" id="2542196">(</span><span class="ident" id="2542197">SYS_SETGID</span><span class="op" id="2542207">,</span>&nbsp;<span class="builtintype" id="2542209">uintptr</span><span class="op" id="2542216">(</span><span class="ident" id="2542217">cred</span><span class="op" id="2542221">.</span><span class="ident" id="2542222">Gid</span><span class="op" id="2542225">)</span><span class="op" id="2542226">,</span>&nbsp;<span class="num" id="2542228">0</span><span class="op" id="2542229">,</span>&nbsp;<span class="num" id="2542231">0</span><span class="op" id="2542232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542236">if</span>&nbsp;<span class="ident" id="2542239">err1</span>&nbsp;<span class="op" id="2542244">!=</span>&nbsp;<span class="num" id="2542247">0</span>&nbsp;<span class="op" id="2542249">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542254">goto</span>&nbsp;<span class="ident" id="2542259">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542276">_</span><span class="op" id="2542277">,</span>&nbsp;<span class="ident" id="2542279">_</span><span class="op" id="2542280">,</span>&nbsp;<span class="ident" id="2542282">err1</span>&nbsp;<span class="op" id="2542287">=</span>&nbsp;<span class="ident" id="2542289">RawSyscall</span><span class="op" id="2542299">(</span><span class="ident" id="2542300">SYS_SETUID</span><span class="op" id="2542310">,</span>&nbsp;<span class="builtintype" id="2542312">uintptr</span><span class="op" id="2542319">(</span><span class="ident" id="2542320">cred</span><span class="op" id="2542324">.</span><span class="ident" id="2542325">Uid</span><span class="op" id="2542328">)</span><span class="op" id="2542329">,</span>&nbsp;<span class="num" id="2542331">0</span><span class="op" id="2542332">,</span>&nbsp;<span class="num" id="2542334">0</span><span class="op" id="2542335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542339">if</span>&nbsp;<span class="ident" id="2542342">err1</span>&nbsp;<span class="op" id="2542347">!=</span>&nbsp;<span class="num" id="2542350">0</span>&nbsp;<span class="op" id="2542352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542357">goto</span>&nbsp;<span class="ident" id="2542362">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2542382">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542392">if</span>&nbsp;<span class="ident" id="2542395">dir</span>&nbsp;<span class="op" id="2542399">!=</span>&nbsp;<span class="ident" id="2542402">nil</span>&nbsp;<span class="op" id="2542406">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542410">_</span><span class="op" id="2542411">,</span>&nbsp;<span class="ident" id="2542413">_</span><span class="op" id="2542414">,</span>&nbsp;<span class="ident" id="2542416">err1</span>&nbsp;<span class="op" id="2542421">=</span>&nbsp;<span class="ident" id="2542423">RawSyscall</span><span class="op" id="2542433">(</span><span class="ident" id="2542434">SYS_CHDIR</span><span class="op" id="2542443">,</span>&nbsp;<span class="builtintype" id="2542445">uintptr</span><span class="op" id="2542452">(</span><span class="ident" id="2542453">unsafe</span><span class="op" id="2542459">.</span><span class="ident" id="2542460">Pointer</span><span class="op" id="2542467">(</span><span class="ident" id="2542468">dir</span><span class="op" id="2542471">)</span><span class="op" id="2542472">)</span><span class="op" id="2542473">,</span>&nbsp;<span class="num" id="2542475">0</span><span class="op" id="2542476">,</span>&nbsp;<span class="num" id="2542478">0</span><span class="op" id="2542479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542483">if</span>&nbsp;<span class="ident" id="2542486">err1</span>&nbsp;<span class="op" id="2542491">!=</span>&nbsp;<span class="num" id="2542494">0</span>&nbsp;<span class="op" id="2542496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542501">goto</span>&nbsp;<span class="ident" id="2542506">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542522">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2542526">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2542589">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542645">if</span>&nbsp;<span class="ident" id="2542648">pipe</span>&nbsp;<span class="op" id="2542653">&lt;</span>&nbsp;<span class="ident" id="2542655">nextfd</span>&nbsp;<span class="op" id="2542662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542666">_</span><span class="op" id="2542667">,</span>&nbsp;<span class="ident" id="2542669">_</span><span class="op" id="2542670">,</span>&nbsp;<span class="ident" id="2542672">err1</span>&nbsp;<span class="op" id="2542677">=</span>&nbsp;<span class="ident" id="2542679">RawSyscall</span><span class="op" id="2542689">(</span><span class="ident" id="2542690">SYS_DUP2</span><span class="op" id="2542698">,</span>&nbsp;<span class="builtintype" id="2542700">uintptr</span><span class="op" id="2542707">(</span><span class="ident" id="2542708">pipe</span><span class="op" id="2542712">)</span><span class="op" id="2542713">,</span>&nbsp;<span class="builtintype" id="2542715">uintptr</span><span class="op" id="2542722">(</span><span class="ident" id="2542723">nextfd</span><span class="op" id="2542729">)</span><span class="op" id="2542730">,</span>&nbsp;<span class="num" id="2542732">0</span><span class="op" id="2542733">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542737">if</span>&nbsp;<span class="ident" id="2542740">err1</span>&nbsp;<span class="op" id="2542745">!=</span>&nbsp;<span class="num" id="2542748">0</span>&nbsp;<span class="op" id="2542750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542755">goto</span>&nbsp;<span class="ident" id="2542760">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542777">RawSyscall</span><span class="op" id="2542787">(</span><span class="ident" id="2542788">SYS_FCNTL</span><span class="op" id="2542797">,</span>&nbsp;<span class="builtintype" id="2542799">uintptr</span><span class="op" id="2542806">(</span><span class="ident" id="2542807">nextfd</span><span class="op" id="2542813">)</span><span class="op" id="2542814">,</span>&nbsp;<span class="ident" id="2542816">F_SETFD</span><span class="op" id="2542823">,</span>&nbsp;<span class="ident" id="2542825">FD_CLOEXEC</span><span class="op" id="2542835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542839">pipe</span>&nbsp;<span class="op" id="2542844">=</span>&nbsp;<span class="ident" id="2542846">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542855">nextfd</span><span class="op" id="2542861">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2542865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542868">for</span>&nbsp;<span class="ident" id="2542872">i</span>&nbsp;<span class="op" id="2542874">=</span>&nbsp;<span class="num" id="2542876">0</span><span class="op" id="2542877">;</span>&nbsp;<span class="ident" id="2542879">i</span>&nbsp;<span class="op" id="2542881">&lt;</span>&nbsp;<span class="builtinfunc" id="2542883">len</span><span class="op" id="2542886">(</span><span class="ident" id="2542887">fd</span><span class="op" id="2542889">)</span><span class="op" id="2542890">;</span>&nbsp;<span class="ident" id="2542892">i</span><span class="op" id="2542893">++</span>&nbsp;<span class="op" id="2542896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2542900">if</span>&nbsp;<span class="ident" id="2542903">fd</span><span class="op" id="2542905">[</span><span class="ident" id="2542906">i</span><span class="op" id="2542907">]</span>&nbsp;<span class="op" id="2542909">&gt;=</span>&nbsp;<span class="num" id="2542912">0</span>&nbsp;<span class="op" id="2542914">&amp;&amp;</span>&nbsp;<span class="ident" id="2542917">fd</span><span class="op" id="2542919">[</span><span class="ident" id="2542920">i</span><span class="op" id="2542921">]</span>&nbsp;<span class="op" id="2542923">&lt;</span>&nbsp;<span class="builtintype" id="2542925">int</span><span class="op" id="2542928">(</span><span class="ident" id="2542929">i</span><span class="op" id="2542930">)</span>&nbsp;<span class="op" id="2542932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2542937">_</span><span class="op" id="2542938">,</span>&nbsp;<span class="ident" id="2542940">_</span><span class="op" id="2542941">,</span>&nbsp;<span class="ident" id="2542943">err1</span>&nbsp;<span class="op" id="2542948">=</span>&nbsp;<span class="ident" id="2542950">RawSyscall</span><span class="op" id="2542960">(</span><span class="ident" id="2542961">SYS_DUP2</span><span class="op" id="2542969">,</span>&nbsp;<span class="builtintype" id="2542971">uintptr</span><span class="op" id="2542978">(</span><span class="ident" id="2542979">fd</span><span class="op" id="2542981">[</span><span class="ident" id="2542982">i</span><span class="op" id="2542983">]</span><span class="op" id="2542984">)</span><span class="op" id="2542985">,</span>&nbsp;<span class="builtintype" id="2542987">uintptr</span><span class="op" id="2542994">(</span><span class="ident" id="2542995">nextfd</span><span class="op" id="2543001">)</span><span class="op" id="2543002">,</span>&nbsp;<span class="num" id="2543004">0</span><span class="op" id="2543005">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543010">if</span>&nbsp;<span class="ident" id="2543013">err1</span>&nbsp;<span class="op" id="2543018">!=</span>&nbsp;<span class="num" id="2543021">0</span>&nbsp;<span class="op" id="2543023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543029">goto</span>&nbsp;<span class="ident" id="2543034">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2543053">RawSyscall</span><span class="op" id="2543063">(</span><span class="ident" id="2543064">SYS_FCNTL</span><span class="op" id="2543073">,</span>&nbsp;<span class="builtintype" id="2543075">uintptr</span><span class="op" id="2543082">(</span><span class="ident" id="2543083">nextfd</span><span class="op" id="2543089">)</span><span class="op" id="2543090">,</span>&nbsp;<span class="ident" id="2543092">F_SETFD</span><span class="op" id="2543099">,</span>&nbsp;<span class="ident" id="2543101">FD_CLOEXEC</span><span class="op" id="2543111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2543116">fd</span><span class="op" id="2543118">[</span><span class="ident" id="2543119">i</span><span class="op" id="2543120">]</span>&nbsp;<span class="op" id="2543122">=</span>&nbsp;<span class="ident" id="2543124">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2543134">nextfd</span><span class="op" id="2543140">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543146">if</span>&nbsp;<span class="ident" id="2543149">nextfd</span>&nbsp;<span class="op" id="2543156">==</span>&nbsp;<span class="ident" id="2543159">pipe</span>&nbsp;<span class="op" id="2543164">{</span>&nbsp;<span class="comment" id="2543166">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2543193">nextfd</span><span class="op" id="2543199">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543209">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543216">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543251">for</span>&nbsp;<span class="ident" id="2543255">i</span>&nbsp;<span class="op" id="2543257">=</span>&nbsp;<span class="num" id="2543259">0</span><span class="op" id="2543260">;</span>&nbsp;<span class="ident" id="2543262">i</span>&nbsp;<span class="op" id="2543264">&lt;</span>&nbsp;<span class="builtinfunc" id="2543266">len</span><span class="op" id="2543269">(</span><span class="ident" id="2543270">fd</span><span class="op" id="2543272">)</span><span class="op" id="2543273">;</span>&nbsp;<span class="ident" id="2543275">i</span><span class="op" id="2543276">++</span>&nbsp;<span class="op" id="2543279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543283">if</span>&nbsp;<span class="ident" id="2543286">fd</span><span class="op" id="2543288">[</span><span class="ident" id="2543289">i</span><span class="op" id="2543290">]</span>&nbsp;<span class="op" id="2543292">==</span>&nbsp;<span class="op" id="2543295">-</span><span class="num" id="2543296">1</span>&nbsp;<span class="op" id="2543298">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2543303">RawSyscall</span><span class="op" id="2543313">(</span><span class="ident" id="2543314">SYS_CLOSE</span><span class="op" id="2543323">,</span>&nbsp;<span class="builtintype" id="2543325">uintptr</span><span class="op" id="2543332">(</span><span class="ident" id="2543333">i</span><span class="op" id="2543334">)</span><span class="op" id="2543335">,</span>&nbsp;<span class="num" id="2543337">0</span><span class="op" id="2543338">,</span>&nbsp;<span class="num" id="2543340">0</span><span class="op" id="2543341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543346">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543361">if</span>&nbsp;<span class="ident" id="2543364">fd</span><span class="op" id="2543366">[</span><span class="ident" id="2543367">i</span><span class="op" id="2543368">]</span>&nbsp;<span class="op" id="2543370">==</span>&nbsp;<span class="builtintype" id="2543373">int</span><span class="op" id="2543376">(</span><span class="ident" id="2543377">i</span><span class="op" id="2543378">)</span>&nbsp;<span class="op" id="2543380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543385">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543443">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2543480">_</span><span class="op" id="2543481">,</span>&nbsp;<span class="ident" id="2543483">_</span><span class="op" id="2543484">,</span>&nbsp;<span class="ident" id="2543486">err1</span>&nbsp;<span class="op" id="2543491">=</span>&nbsp;<span class="ident" id="2543493">RawSyscall</span><span class="op" id="2543503">(</span><span class="ident" id="2543504">SYS_FCNTL</span><span class="op" id="2543513">,</span>&nbsp;<span class="builtintype" id="2543515">uintptr</span><span class="op" id="2543522">(</span><span class="ident" id="2543523">fd</span><span class="op" id="2543525">[</span><span class="ident" id="2543526">i</span><span class="op" id="2543527">]</span><span class="op" id="2543528">)</span><span class="op" id="2543529">,</span>&nbsp;<span class="ident" id="2543531">F_SETFD</span><span class="op" id="2543538">,</span>&nbsp;<span class="num" id="2543540">0</span><span class="op" id="2543541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543546">if</span>&nbsp;<span class="ident" id="2543549">err1</span>&nbsp;<span class="op" id="2543554">!=</span>&nbsp;<span class="num" id="2543557">0</span>&nbsp;<span class="op" id="2543559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543565">goto</span>&nbsp;<span class="ident" id="2543570">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543584">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543589">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543604">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543650">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2543686">_</span><span class="op" id="2543687">,</span>&nbsp;<span class="ident" id="2543689">_</span><span class="op" id="2543690">,</span>&nbsp;<span class="ident" id="2543692">err1</span>&nbsp;<span class="op" id="2543697">=</span>&nbsp;<span class="ident" id="2543699">RawSyscall</span><span class="op" id="2543709">(</span><span class="ident" id="2543710">SYS_DUP2</span><span class="op" id="2543718">,</span>&nbsp;<span class="builtintype" id="2543720">uintptr</span><span class="op" id="2543727">(</span><span class="ident" id="2543728">fd</span><span class="op" id="2543730">[</span><span class="ident" id="2543731">i</span><span class="op" id="2543732">]</span><span class="op" id="2543733">)</span><span class="op" id="2543734">,</span>&nbsp;<span class="builtintype" id="2543736">uintptr</span><span class="op" id="2543743">(</span><span class="ident" id="2543744">i</span><span class="op" id="2543745">)</span><span class="op" id="2543746">,</span>&nbsp;<span class="num" id="2543748">0</span><span class="op" id="2543749">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543753">if</span>&nbsp;<span class="ident" id="2543756">err1</span>&nbsp;<span class="op" id="2543761">!=</span>&nbsp;<span class="num" id="2543764">0</span>&nbsp;<span class="op" id="2543766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2543771">goto</span>&nbsp;<span class="ident" id="2543776">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2543792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543796">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543853">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543915">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2543970">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2544001">for</span>&nbsp;<span class="ident" id="2544005">i</span>&nbsp;<span class="op" id="2544007">=</span>&nbsp;<span class="builtinfunc" id="2544009">len</span><span class="op" id="2544012">(</span><span class="ident" id="2544013">fd</span><span class="op" id="2544015">)</span><span class="op" id="2544016">;</span>&nbsp;<span class="ident" id="2544018">i</span>&nbsp;<span class="op" id="2544020">&lt;</span>&nbsp;<span class="num" id="2544022">3</span><span class="op" id="2544023">;</span>&nbsp;<span class="ident" id="2544025">i</span><span class="op" id="2544026">++</span>&nbsp;<span class="op" id="2544029">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2544033">RawSyscall</span><span class="op" id="2544043">(</span><span class="ident" id="2544044">SYS_CLOSE</span><span class="op" id="2544053">,</span>&nbsp;<span class="builtintype" id="2544055">uintptr</span><span class="op" id="2544062">(</span><span class="ident" id="2544063">i</span><span class="op" id="2544064">)</span><span class="op" id="2544065">,</span>&nbsp;<span class="num" id="2544067">0</span><span class="op" id="2544068">,</span>&nbsp;<span class="num" id="2544070">0</span><span class="op" id="2544071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2544074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2544078">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2544103">if</span>&nbsp;<span class="ident" id="2544106">sys</span><span class="op" id="2544109">.</span><span class="ident" id="2544110">Noctty</span>&nbsp;<span class="op" id="2544117">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2544121">_</span><span class="op" id="2544122">,</span>&nbsp;<span class="ident" id="2544124">_</span><span class="op" id="2544125">,</span>&nbsp;<span class="ident" id="2544127">err1</span>&nbsp;<span class="op" id="2544132">=</span>&nbsp;<span class="ident" id="2544134">RawSyscall</span><span class="op" id="2544144">(</span><span class="ident" id="2544145">SYS_IOCTL</span><span class="op" id="2544154">,</span>&nbsp;<span class="num" id="2544156">0</span><span class="op" id="2544157">,</span>&nbsp;<span class="builtintype" id="2544159">uintptr</span><span class="op" id="2544166">(</span><span class="ident" id="2544167">TIOCNOTTY</span><span class="op" id="2544176">)</span><span class="op" id="2544177">,</span>&nbsp;<span class="num" id="2544179">0</span><span class="op" id="2544180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2544184">if</span>&nbsp;<span class="ident" id="2544187">err1</span>&nbsp;<span class="op" id="2544192">!=</span>&nbsp;<span class="num" id="2544195">0</span>&nbsp;<span class="op" id="2544197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2544202">goto</span>&nbsp;<span class="ident" id="2544207">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2544220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2544223">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2544227">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2544263">if</span>&nbsp;<span class="ident" id="2544266">sys</span><span class="op" id="2544269">.</span><span class="ident" id="2544270">Setctty</span>&nbsp;<span class="op" id="2544278">&amp;&amp;</span>&nbsp;<span class="ident" id="2544281">sys</span><span class="op" id="2544284">.</span><span class="ident" id="2544285">Ctty</span>&nbsp;<span class="op" id="2544290">&gt;=</span>&nbsp;<span class="num" id="2544293">0</span>&nbsp;<span class="op" id="2544295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2544299">_</span><span class="op" id="2544300">,</span>&nbsp;<span class="ident" id="2544302">_</span><span class="op" id="2544303">,</span>&nbsp;<span class="ident" id="2544305">err1</span>&nbsp;<span class="op" id="2544310">=</span>&nbsp;<span class="ident" id="2544312">RawSyscall</span><span class="op" id="2544322">(</span><span class="ident" id="2544323">SYS_IOCTL</span><span class="op" id="2544332">,</span>&nbsp;<span class="builtintype" id="2544334">uintptr</span><span class="op" id="2544341">(</span><span class="ident" id="2544342">sys</span><span class="op" id="2544345">.</span><span class="ident" id="2544346">Ctty</span><span class="op" id="2544350">)</span><span class="op" id="2544351">,</span>&nbsp;<span class="builtintype" id="2544353">uintptr</span><span class="op" id="2544360">(</span><span class="ident" id="2544361">TIOCSCTTY</span><span class="op" id="2544370">)</span><span class="op" id="2544371">,</span>&nbsp;<span class="num" id="2544373">0</span><span class="op" id="2544374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2544378">if</span>&nbsp;<span class="ident" id="2544381">err1</span>&nbsp;<span class="op" id="2544386">!=</span>&nbsp;<span class="num" id="2544389">0</span>&nbsp;<span class="op" id="2544391">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2544396">goto</span>&nbsp;<span class="ident" id="2544401">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2544414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2544417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2544421">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2544439">_</span><span class="op" id="2544440">,</span>&nbsp;<span class="ident" id="2544442">_</span><span class="op" id="2544443">,</span>&nbsp;<span class="ident" id="2544445">err1</span>&nbsp;<span class="op" id="2544450">=</span>&nbsp;<span class="ident" id="2544452">RawSyscall</span><span class="op" id="2544462">(</span><span class="ident" id="2544463">SYS_EXECVE</span><span class="op" id="2544473">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2544477">uintptr</span><span class="op" id="2544484">(</span><span class="ident" id="2544485">unsafe</span><span class="op" id="2544491">.</span><span class="ident" id="2544492">Pointer</span><span class="op" id="2544499">(</span><span class="ident" id="2544500">argv0</span><span class="op" id="2544505">)</span><span class="op" id="2544506">)</span><span class="op" id="2544507">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2544511">uintptr</span><span class="op" id="2544518">(</span><span class="ident" id="2544519">unsafe</span><span class="op" id="2544525">.</span><span class="ident" id="2544526">Pointer</span><span class="op" id="2544533">(</span><span class="op" id="2544534">&amp;</span><span class="ident" id="2544535">argv</span><span class="op" id="2544539">[</span><span class="num" id="2544540">0</span><span class="op" id="2544541">]</span><span class="op" id="2544542">)</span><span class="op" id="2544543">)</span><span class="op" id="2544544">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2544548">uintptr</span><span class="op" id="2544555">(</span><span class="ident" id="2544556">unsafe</span><span class="op" id="2544562">.</span><span class="ident" id="2544563">Pointer</span><span class="op" id="2544570">(</span><span class="op" id="2544571">&amp;</span><span class="ident" id="2544572">envv</span><span class="op" id="2544576">[</span><span class="num" id="2544577">0</span><span class="op" id="2544578">]</span><span class="op" id="2544579">)</span><span class="op" id="2544580">)</span><span class="op" id="2544581">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2544584">childerror</span><span class="op" id="2544594">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2544597">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2544625">RawSyscall</span><span class="op" id="2544635">(</span><span class="ident" id="2544636">SYS_WRITE</span><span class="op" id="2544645">,</span>&nbsp;<span class="builtintype" id="2544647">uintptr</span><span class="op" id="2544654">(</span><span class="ident" id="2544655">pipe</span><span class="op" id="2544659">)</span><span class="op" id="2544660">,</span>&nbsp;<span class="builtintype" id="2544662">uintptr</span><span class="op" id="2544669">(</span><span class="ident" id="2544670">unsafe</span><span class="op" id="2544676">.</span><span class="ident" id="2544677">Pointer</span><span class="op" id="2544684">(</span><span class="op" id="2544685">&amp;</span><span class="ident" id="2544686">err1</span><span class="op" id="2544690">)</span><span class="op" id="2544691">)</span><span class="op" id="2544692">,</span>&nbsp;<span class="ident" id="2544694">unsafe</span><span class="op" id="2544700">.</span><span class="ident" id="2544701">Sizeof</span><span class="op" id="2544707">(</span><span class="ident" id="2544708">err1</span><span class="op" id="2544712">)</span><span class="op" id="2544713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2544716">for</span>&nbsp;<span class="op" id="2544720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2544724">RawSyscall</span><span class="op" id="2544734">(</span><span class="ident" id="2544735">SYS_EXIT</span><span class="op" id="2544743">,</span>&nbsp;<span class="num" id="2544745">253</span><span class="op" id="2544748">,</span>&nbsp;<span class="num" id="2544750">0</span><span class="op" id="2544751">,</span>&nbsp;<span class="num" id="2544753">0</span><span class="op" id="2544754">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2544757">}</span><br>
<span class="lineno"></span><span class="op" id="2544759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2544762">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2544829">func</span>&nbsp;<span class="ident" id="2544834">forkExecPipe</span><span class="op" id="2544846">(</span><span class="ident" id="2544847">p</span>&nbsp;<span class="op" id="2544849">[</span><span class="op" id="2544850">]</span><span class="builtintype" id="2544851">int</span><span class="op" id="2544854">)</span>&nbsp;<span class="op" id="2544856">(</span><span class="ident" id="2544857">err</span>&nbsp;<span class="builtintype" id="2544861">error</span><span class="op" id="2544866">)</span>&nbsp;<span class="op" id="2544868">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2544871">err</span>&nbsp;<span class="op" id="2544875">=</span>&nbsp;<span class="ident" id="2544877">Pipe2</span><span class="op" id="2544882">(</span><span class="ident" id="2544883">p</span><span class="op" id="2544884">,</span>&nbsp;<span class="ident" id="2544886">O_CLOEXEC</span><span class="op" id="2544895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2544898">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2544973">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545003">if</span>&nbsp;<span class="ident" id="2545006">err</span>&nbsp;<span class="op" id="2545010">==</span>&nbsp;<span class="ident" id="2545013">ENOSYS</span>&nbsp;<span class="op" id="2545020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545024">if</span>&nbsp;<span class="ident" id="2545027">err</span>&nbsp;<span class="op" id="2545031">=</span>&nbsp;<span class="ident" id="2545033">Pipe</span><span class="op" id="2545037">(</span><span class="ident" id="2545038">p</span><span class="op" id="2545039">)</span><span class="op" id="2545040">;</span>&nbsp;<span class="ident" id="2545042">err</span>&nbsp;<span class="op" id="2545046">!=</span>&nbsp;<span class="ident" id="2545049">nil</span>&nbsp;<span class="op" id="2545053">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545058">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2545067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545071">if</span>&nbsp;<span class="ident" id="2545074">_</span><span class="op" id="2545075">,</span>&nbsp;<span class="ident" id="2545077">err</span>&nbsp;<span class="op" id="2545081">=</span>&nbsp;<span class="ident" id="2545083">fcntl</span><span class="op" id="2545088">(</span><span class="ident" id="2545089">p</span><span class="op" id="2545090">[</span><span class="num" id="2545091">0</span><span class="op" id="2545092">]</span><span class="op" id="2545093">,</span>&nbsp;<span class="ident" id="2545095">F_SETFD</span><span class="op" id="2545102">,</span>&nbsp;<span class="ident" id="2545104">FD_CLOEXEC</span><span class="op" id="2545114">)</span><span class="op" id="2545115">;</span>&nbsp;<span class="ident" id="2545117">err</span>&nbsp;<span class="op" id="2545121">!=</span>&nbsp;<span class="ident" id="2545124">nil</span>&nbsp;<span class="op" id="2545128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545133">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2545142">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2545146">_</span><span class="op" id="2545147">,</span>&nbsp;<span class="ident" id="2545149">err</span>&nbsp;<span class="op" id="2545153">=</span>&nbsp;<span class="ident" id="2545155">fcntl</span><span class="op" id="2545160">(</span><span class="ident" id="2545161">p</span><span class="op" id="2545162">[</span><span class="num" id="2545163">1</span><span class="op" id="2545164">]</span><span class="op" id="2545165">,</span>&nbsp;<span class="ident" id="2545167">F_SETFD</span><span class="op" id="2545174">,</span>&nbsp;<span class="ident" id="2545176">FD_CLOEXEC</span><span class="op" id="2545186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2545189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545192">return</span><br>
<span class="lineno"></span><span class="op" id="2545199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2545202">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2545299">func</span>&nbsp;<span class="ident" id="2545304">writeIDMappings</span><span class="op" id="2545319">(</span><span class="ident" id="2545320">path</span>&nbsp;<span class="builtintype" id="2545325">string</span><span class="op" id="2545331">,</span>&nbsp;<span class="ident" id="2545333">idMap</span>&nbsp;<span class="op" id="2545339">[</span><span class="op" id="2545340">]</span><span class="ident" id="2545341">SysProcIDMap</span><span class="op" id="2545353">)</span>&nbsp;<span class="builtintype" id="2545355">error</span>&nbsp;<span class="op" id="2545361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2545364">fd</span><span class="op" id="2545366">,</span>&nbsp;<span class="ident" id="2545368">err</span>&nbsp;<span class="op" id="2545372">:=</span>&nbsp;<span class="ident" id="2545375">Open</span><span class="op" id="2545379">(</span><span class="ident" id="2545380">path</span><span class="op" id="2545384">,</span>&nbsp;<span class="ident" id="2545386">O_RDWR</span><span class="op" id="2545392">,</span>&nbsp;<span class="num" id="2545394">0</span><span class="op" id="2545395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545398">if</span>&nbsp;<span class="ident" id="2545401">err</span>&nbsp;<span class="op" id="2545405">!=</span>&nbsp;<span class="ident" id="2545408">nil</span>&nbsp;<span class="op" id="2545412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545416">return</span>&nbsp;<span class="ident" id="2545423">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2545428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2545432">data</span>&nbsp;<span class="op" id="2545437">:=</span>&nbsp;<span class="string" id="2545440">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545444">for</span>&nbsp;<span class="ident" id="2545448">_</span><span class="op" id="2545449">,</span>&nbsp;<span class="ident" id="2545451">im</span>&nbsp;<span class="op" id="2545454">:=</span>&nbsp;<span class="keyword" id="2545457">range</span>&nbsp;<span class="ident" id="2545463">idMap</span>&nbsp;<span class="op" id="2545469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2545473">data</span>&nbsp;<span class="op" id="2545478">=</span>&nbsp;<span class="ident" id="2545480">data</span>&nbsp;<span class="op" id="2545485">+</span>&nbsp;<span class="ident" id="2545487">itoa</span><span class="op" id="2545491">(</span><span class="ident" id="2545492">im</span><span class="op" id="2545494">.</span><span class="ident" id="2545495">ContainerID</span><span class="op" id="2545506">)</span>&nbsp;<span class="op" id="2545508">+</span>&nbsp;<span class="string" id="2545510">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2545514">+</span>&nbsp;<span class="ident" id="2545516">itoa</span><span class="op" id="2545520">(</span><span class="ident" id="2545521">im</span><span class="op" id="2545523">.</span><span class="ident" id="2545524">HostID</span><span class="op" id="2545530">)</span>&nbsp;<span class="op" id="2545532">+</span>&nbsp;<span class="string" id="2545534">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2545538">+</span>&nbsp;<span class="ident" id="2545540">itoa</span><span class="op" id="2545544">(</span><span class="ident" id="2545545">im</span><span class="op" id="2545547">.</span><span class="ident" id="2545548">Size</span><span class="op" id="2545552">)</span>&nbsp;<span class="op" id="2545554">+</span>&nbsp;<span class="string" id="2545556">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2545562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2545566">bytes</span><span class="op" id="2545571">,</span>&nbsp;<span class="ident" id="2545573">err</span>&nbsp;<span class="op" id="2545577">:=</span>&nbsp;<span class="ident" id="2545580">ByteSliceFromString</span><span class="op" id="2545599">(</span><span class="ident" id="2545600">data</span><span class="op" id="2545604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545607">if</span>&nbsp;<span class="ident" id="2545610">err</span>&nbsp;<span class="op" id="2545614">!=</span>&nbsp;<span class="ident" id="2545617">nil</span>&nbsp;<span class="op" id="2545621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2545625">Close</span><span class="op" id="2545630">(</span><span class="ident" id="2545631">fd</span><span class="op" id="2545633">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545637">return</span>&nbsp;<span class="ident" id="2545644">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2545649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545653">if</span>&nbsp;<span class="ident" id="2545656">_</span><span class="op" id="2545657">,</span>&nbsp;<span class="ident" id="2545659">err</span>&nbsp;<span class="op" id="2545663">:=</span>&nbsp;<span class="ident" id="2545666">Write</span><span class="op" id="2545671">(</span><span class="ident" id="2545672">fd</span><span class="op" id="2545674">,</span>&nbsp;<span class="ident" id="2545676">bytes</span><span class="op" id="2545681">)</span><span class="op" id="2545682">;</span>&nbsp;<span class="ident" id="2545684">err</span>&nbsp;<span class="op" id="2545688">!=</span>&nbsp;<span class="ident" id="2545691">nil</span>&nbsp;<span class="op" id="2545695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2545699">Close</span><span class="op" id="2545704">(</span><span class="ident" id="2545705">fd</span><span class="op" id="2545707">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545711">return</span>&nbsp;<span class="ident" id="2545718">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2545723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545727">if</span>&nbsp;<span class="ident" id="2545730">err</span>&nbsp;<span class="op" id="2545734">:=</span>&nbsp;<span class="ident" id="2545737">Close</span><span class="op" id="2545742">(</span><span class="ident" id="2545743">fd</span><span class="op" id="2545745">)</span><span class="op" id="2545746">;</span>&nbsp;<span class="ident" id="2545748">err</span>&nbsp;<span class="op" id="2545752">!=</span>&nbsp;<span class="ident" id="2545755">nil</span>&nbsp;<span class="op" id="2545759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545763">return</span>&nbsp;<span class="ident" id="2545770">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2545775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545779">return</span>&nbsp;<span class="ident" id="2545786">nil</span><br>
<span class="lineno"></span><span class="op" id="2545790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2545793">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2545873">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2545932">func</span>&nbsp;<span class="ident" id="2545937">writeUidGidMappings</span><span class="op" id="2545956">(</span><span class="ident" id="2545957">pid</span>&nbsp;<span class="builtintype" id="2545961">int</span><span class="op" id="2545964">,</span>&nbsp;<span class="ident" id="2545966">sys</span>&nbsp;<span class="op" id="2545970">*</span><span class="ident" id="2545971">SysProcAttr</span><span class="op" id="2545982">)</span>&nbsp;<span class="builtintype" id="2545984">error</span>&nbsp;<span class="op" id="2545990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2545993">if</span>&nbsp;<span class="ident" id="2545996">sys</span><span class="op" id="2545999">.</span><span class="ident" id="2546000">UidMappings</span>&nbsp;<span class="op" id="2546012">!=</span>&nbsp;<span class="ident" id="2546015">nil</span>&nbsp;<span class="op" id="2546019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2546023">uidf</span>&nbsp;<span class="op" id="2546028">:=</span>&nbsp;<span class="string" id="2546031">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2546040">+</span>&nbsp;<span class="ident" id="2546042">itoa</span><span class="op" id="2546046">(</span><span class="ident" id="2546047">pid</span><span class="op" id="2546050">)</span>&nbsp;<span class="op" id="2546052">+</span>&nbsp;<span class="string" id="2546054">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2546067">if</span>&nbsp;<span class="ident" id="2546070">err</span>&nbsp;<span class="op" id="2546074">:=</span>&nbsp;<span class="ident" id="2546077">writeIDMappings</span><span class="op" id="2546092">(</span><span class="ident" id="2546093">uidf</span><span class="op" id="2546097">,</span>&nbsp;<span class="ident" id="2546099">sys</span><span class="op" id="2546102">.</span><span class="ident" id="2546103">UidMappings</span><span class="op" id="2546114">)</span><span class="op" id="2546115">;</span>&nbsp;<span class="ident" id="2546117">err</span>&nbsp;<span class="op" id="2546121">!=</span>&nbsp;<span class="ident" id="2546124">nil</span>&nbsp;<span class="op" id="2546128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2546133">return</span>&nbsp;<span class="ident" id="2546140">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2546146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2546149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2546153">if</span>&nbsp;<span class="ident" id="2546156">sys</span><span class="op" id="2546159">.</span><span class="ident" id="2546160">GidMappings</span>&nbsp;<span class="op" id="2546172">!=</span>&nbsp;<span class="ident" id="2546175">nil</span>&nbsp;<span class="op" id="2546179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2546183">gidf</span>&nbsp;<span class="op" id="2546188">:=</span>&nbsp;<span class="string" id="2546191">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2546200">+</span>&nbsp;<span class="ident" id="2546202">itoa</span><span class="op" id="2546206">(</span><span class="ident" id="2546207">pid</span><span class="op" id="2546210">)</span>&nbsp;<span class="op" id="2546212">+</span>&nbsp;<span class="string" id="2546214">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2546227">if</span>&nbsp;<span class="ident" id="2546230">err</span>&nbsp;<span class="op" id="2546234">:=</span>&nbsp;<span class="ident" id="2546237">writeIDMappings</span><span class="op" id="2546252">(</span><span class="ident" id="2546253">gidf</span><span class="op" id="2546257">,</span>&nbsp;<span class="ident" id="2546259">sys</span><span class="op" id="2546262">.</span><span class="ident" id="2546263">GidMappings</span><span class="op" id="2546274">)</span><span class="op" id="2546275">;</span>&nbsp;<span class="ident" id="2546277">err</span>&nbsp;<span class="op" id="2546281">!=</span>&nbsp;<span class="ident" id="2546284">nil</span>&nbsp;<span class="op" id="2546288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2546293">return</span>&nbsp;<span class="ident" id="2546300">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2546306">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2546309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2546313">return</span>&nbsp;<span class="ident" id="2546320">nil</span><br>
<span class="lineno"></span><span class="op" id="2546324">}</span>
</div>
</body>
</html>
