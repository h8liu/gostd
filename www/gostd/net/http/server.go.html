<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3054577">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3054632">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3054686">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3054737">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3054769">package</span>&nbsp;<span class="ident" id="3054777">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3054783">import</span>&nbsp;<span class="op" id="3054790">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054793">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054802">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054816">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054826">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054833">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054839">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054852">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054859">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054866">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054877">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054883">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054891">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054902">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054913">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054924">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054932">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3054947">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3054954">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3054957">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3054998">var</span>&nbsp;<span class="op" id="3055002">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055005">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3055024">=</span>&nbsp;<span class="ident" id="3055026">errors</span><span class="op" id="3055032">.</span><span class="ident" id="3055033">New</span><span class="op" id="3055036">(</span><span class="string" id="3055037">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3055068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055071">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3055090">=</span>&nbsp;<span class="ident" id="3055092">errors</span><span class="op" id="3055098">.</span><span class="ident" id="3055099">New</span><span class="op" id="3055102">(</span><span class="string" id="3055103">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3055169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055172">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3055191">=</span>&nbsp;<span class="ident" id="3055193">errors</span><span class="op" id="3055199">.</span><span class="ident" id="3055200">New</span><span class="op" id="3055203">(</span><span class="string" id="3055204">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3055228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055231">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3055250">=</span>&nbsp;<span class="ident" id="3055252">errors</span><span class="op" id="3055258">.</span><span class="ident" id="3055259">New</span><span class="op" id="3055262">(</span><span class="string" id="3055263">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3055319">)</span><br>
<span class="lineno">35</span><span class="op" id="3055321">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055324">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3055377">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3055429">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3055452">//</span><br>
<span class="lineno"></span><span class="comment" id="3055455">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3055526">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3055594">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3055657">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3055676">//</span><br>
<span class="lineno"></span><span class="comment" id="3055679">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3055748">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3055816">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3055886">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3055918">//</span><br>
<span class="lineno"></span><span class="keyword" id="3055921">type</span>&nbsp;<span class="ident" id="3055926">Handler</span>&nbsp;<span class="keyword" id="3055934">interface</span>&nbsp;<span class="op" id="3055944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055947">ServeHTTP</span><span class="op" id="3055956">(</span><span class="ident" id="3055957">ResponseWriter</span><span class="op" id="3055971">,</span>&nbsp;<span class="op" id="3055973">*</span><span class="ident" id="3055974">Request</span><span class="op" id="3055981">)</span><br>
<span class="lineno"></span><span class="op" id="3055983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3055986">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3056046">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3056077">type</span>&nbsp;<span class="ident" id="3056082">ResponseWriter</span>&nbsp;<span class="keyword" id="3056097">interface</span>&nbsp;<span class="op" id="3056107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056110">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056178">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056245">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056260">Header</span><span class="op" id="3056266">(</span><span class="op" id="3056267">)</span>&nbsp;<span class="ident" id="3056269">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056278">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056348">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056431">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056494">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056572">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056636">Write</span><span class="op" id="3056641">(</span><span class="op" id="3056642">[</span><span class="op" id="3056643">]</span><span class="builtintype" id="3056644">byte</span><span class="op" id="3056648">)</span>&nbsp;<span class="op" id="3056650">(</span><span class="builtintype" id="3056651">int</span><span class="op" id="3056654">,</span>&nbsp;<span class="builtintype" id="3056656">error</span><span class="op" id="3056661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056665">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056729">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056798">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056855">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3056913">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056935">WriteHeader</span><span class="op" id="3056946">(</span><span class="builtintype" id="3056947">int</span><span class="op" id="3056950">)</span><br>
<span class="lineno"></span><span class="op" id="3056952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3056955">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3057025">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3057082">//</span><br>
<span class="lineno"></span><span class="comment" id="3057085">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3057143">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3057196">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3057261">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3057275">type</span>&nbsp;<span class="ident" id="3057280">Flusher</span>&nbsp;<span class="keyword" id="3057288">interface</span>&nbsp;<span class="op" id="3057298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3057301">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3057350">Flush</span><span class="op" id="3057355">(</span><span class="op" id="3057356">)</span><br>
<span class="lineno"></span><span class="op" id="3057358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3057361">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3057432">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3057480">type</span>&nbsp;<span class="ident" id="3057485">Hijacker</span>&nbsp;<span class="keyword" id="3057494">interface</span>&nbsp;<span class="op" id="3057504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3057507">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3057560">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3057614">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3057665">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3057718">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3057748">Hijack</span><span class="op" id="3057754">(</span><span class="op" id="3057755">)</span>&nbsp;<span class="op" id="3057757">(</span><span class="ident" id="3057758">net</span><span class="op" id="3057761">.</span><span class="ident" id="3057762">Conn</span><span class="op" id="3057766">,</span>&nbsp;<span class="op" id="3057768">*</span><span class="ident" id="3057769">bufio</span><span class="op" id="3057774">.</span><span class="ident" id="3057775">ReadWriter</span><span class="op" id="3057785">,</span>&nbsp;<span class="builtintype" id="3057787">error</span><span class="op" id="3057792">)</span><br>
<span class="lineno"></span><span class="op" id="3057794">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3057797">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3057868">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3057933">//</span><br>
<span class="lineno"></span><span class="comment" id="3057936">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3058006">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3058070">type</span>&nbsp;<span class="ident" id="3058075">CloseNotifier</span>&nbsp;<span class="keyword" id="3058089">interface</span>&nbsp;<span class="op" id="3058099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3058102">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3058165">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058211">CloseNotify</span><span class="op" id="3058222">(</span><span class="op" id="3058223">)</span>&nbsp;<span class="op" id="3058225">&lt;-</span><span class="keyword" id="3058227">chan</span>&nbsp;<span class="builtintype" id="3058232">bool</span><br>
<span class="lineno">110</span><span class="op" id="3058237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3058240">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3058300">type</span>&nbsp;<span class="ident" id="3058305">conn</span>&nbsp;<span class="keyword" id="3058310">struct</span>&nbsp;<span class="op" id="3058317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058320">remoteAddr</span>&nbsp;<span class="builtintype" id="3058331">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058352">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058387">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058398">*</span><span class="ident" id="3058399">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058419">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058466">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058477">net</span><span class="op" id="3058480">.</span><span class="ident" id="3058481">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058498">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058517">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058528">io</span><span class="op" id="3058530">.</span><span class="ident" id="3058531">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058549">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058610">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3058621">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058642">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058670">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058681">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058702">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058756">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058767">*</span><span class="ident" id="3058768">io</span><span class="op" id="3058770">.</span><span class="ident" id="3058771">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058788">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058811">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058822">*</span><span class="ident" id="3058823">bufio</span><span class="op" id="3058828">.</span><span class="ident" id="3058829">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058843">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058906">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3058917">*</span><span class="ident" id="3058918">tls</span><span class="op" id="3058921">.</span><span class="ident" id="3058922">ConnectionState</span>&nbsp;<span class="comment" id="3058938">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3058969">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058982">sync</span><span class="op" id="3058986">.</span><span class="ident" id="3058987">Mutex</span>&nbsp;<span class="comment" id="3058993">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059018">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3059031">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3059042">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059085">closeNotifyc</span>&nbsp;<span class="keyword" id="3059098">chan</span>&nbsp;<span class="builtintype" id="3059103">bool</span>&nbsp;&nbsp;<span class="comment" id="3059109">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059125">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3059138">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3059149">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3059192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3059195">func</span>&nbsp;<span class="op" id="3059200">(</span><span class="ident" id="3059201">c</span>&nbsp;<span class="op" id="3059203">*</span><span class="ident" id="3059204">conn</span><span class="op" id="3059208">)</span>&nbsp;<span class="ident" id="3059210">hijacked</span><span class="op" id="3059218">(</span><span class="op" id="3059219">)</span>&nbsp;<span class="builtintype" id="3059221">bool</span>&nbsp;<span class="op" id="3059226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059229">c</span><span class="op" id="3059230">.</span><span class="ident" id="3059231">mu</span><span class="op" id="3059233">.</span><span class="ident" id="3059234">Lock</span><span class="op" id="3059238">(</span><span class="op" id="3059239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059242">defer</span>&nbsp;<span class="ident" id="3059248">c</span><span class="op" id="3059249">.</span><span class="ident" id="3059250">mu</span><span class="op" id="3059252">.</span><span class="ident" id="3059253">Unlock</span><span class="op" id="3059259">(</span><span class="op" id="3059260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059263">return</span>&nbsp;<span class="ident" id="3059270">c</span><span class="op" id="3059271">.</span><span class="ident" id="3059272">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3059282">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3059285">func</span>&nbsp;<span class="op" id="3059290">(</span><span class="ident" id="3059291">c</span>&nbsp;<span class="op" id="3059293">*</span><span class="ident" id="3059294">conn</span><span class="op" id="3059298">)</span>&nbsp;<span class="ident" id="3059300">hijack</span><span class="op" id="3059306">(</span><span class="op" id="3059307">)</span>&nbsp;<span class="op" id="3059309">(</span><span class="ident" id="3059310">rwc</span>&nbsp;<span class="ident" id="3059314">net</span><span class="op" id="3059317">.</span><span class="ident" id="3059318">Conn</span><span class="op" id="3059322">,</span>&nbsp;<span class="ident" id="3059324">buf</span>&nbsp;<span class="op" id="3059328">*</span><span class="ident" id="3059329">bufio</span><span class="op" id="3059334">.</span><span class="ident" id="3059335">ReadWriter</span><span class="op" id="3059345">,</span>&nbsp;<span class="ident" id="3059347">err</span>&nbsp;<span class="builtintype" id="3059351">error</span><span class="op" id="3059356">)</span>&nbsp;<span class="op" id="3059358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059361">c</span><span class="op" id="3059362">.</span><span class="ident" id="3059363">mu</span><span class="op" id="3059365">.</span><span class="ident" id="3059366">Lock</span><span class="op" id="3059370">(</span><span class="op" id="3059371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059374">defer</span>&nbsp;<span class="ident" id="3059380">c</span><span class="op" id="3059381">.</span><span class="ident" id="3059382">mu</span><span class="op" id="3059384">.</span><span class="ident" id="3059385">Unlock</span><span class="op" id="3059391">(</span><span class="op" id="3059392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059395">if</span>&nbsp;<span class="ident" id="3059398">c</span><span class="op" id="3059399">.</span><span class="ident" id="3059400">hijackedv</span>&nbsp;<span class="op" id="3059410">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059414">return</span>&nbsp;<span class="ident" id="3059421">nil</span><span class="op" id="3059424">,</span>&nbsp;<span class="ident" id="3059426">nil</span><span class="op" id="3059429">,</span>&nbsp;<span class="ident" id="3059431">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3059444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059447">if</span>&nbsp;<span class="ident" id="3059450">c</span><span class="op" id="3059451">.</span><span class="ident" id="3059452">closeNotifyc</span>&nbsp;<span class="op" id="3059465">!=</span>&nbsp;<span class="ident" id="3059468">nil</span>&nbsp;<span class="op" id="3059472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059476">return</span>&nbsp;<span class="ident" id="3059483">nil</span><span class="op" id="3059486">,</span>&nbsp;<span class="ident" id="3059488">nil</span><span class="op" id="3059491">,</span>&nbsp;<span class="ident" id="3059493">errors</span><span class="op" id="3059499">.</span><span class="ident" id="3059500">New</span><span class="op" id="3059503">(</span><span class="string" id="3059504">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3059560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3059563">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059566">c</span><span class="op" id="3059567">.</span><span class="ident" id="3059568">hijackedv</span>&nbsp;<span class="op" id="3059578">=</span>&nbsp;<span class="builtintype" id="3059580">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059586">rwc</span>&nbsp;<span class="op" id="3059590">=</span>&nbsp;<span class="ident" id="3059592">c</span><span class="op" id="3059593">.</span><span class="ident" id="3059594">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059599">buf</span>&nbsp;<span class="op" id="3059603">=</span>&nbsp;<span class="ident" id="3059605">c</span><span class="op" id="3059606">.</span><span class="ident" id="3059607">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059612">c</span><span class="op" id="3059613">.</span><span class="ident" id="3059614">rwc</span>&nbsp;<span class="op" id="3059618">=</span>&nbsp;<span class="ident" id="3059620">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059625">c</span><span class="op" id="3059626">.</span><span class="ident" id="3059627">buf</span>&nbsp;<span class="op" id="3059631">=</span>&nbsp;<span class="ident" id="3059633">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059638">c</span><span class="op" id="3059639">.</span><span class="ident" id="3059640">setState</span><span class="op" id="3059648">(</span><span class="ident" id="3059649">rwc</span><span class="op" id="3059652">,</span>&nbsp;<span class="ident" id="3059654">StateHijacked</span><span class="op" id="3059667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059670">return</span><br>
<span class="lineno"></span><span class="op" id="3059677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3059680">func</span>&nbsp;<span class="op" id="3059685">(</span><span class="ident" id="3059686">c</span>&nbsp;<span class="op" id="3059688">*</span><span class="ident" id="3059689">conn</span><span class="op" id="3059693">)</span>&nbsp;<span class="ident" id="3059695">closeNotify</span><span class="op" id="3059706">(</span><span class="op" id="3059707">)</span>&nbsp;<span class="op" id="3059709">&lt;-</span><span class="keyword" id="3059711">chan</span>&nbsp;<span class="builtintype" id="3059716">bool</span>&nbsp;<span class="op" id="3059721">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059724">c</span><span class="op" id="3059725">.</span><span class="ident" id="3059726">mu</span><span class="op" id="3059728">.</span><span class="ident" id="3059729">Lock</span><span class="op" id="3059733">(</span><span class="op" id="3059734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059737">defer</span>&nbsp;<span class="ident" id="3059743">c</span><span class="op" id="3059744">.</span><span class="ident" id="3059745">mu</span><span class="op" id="3059747">.</span><span class="ident" id="3059748">Unlock</span><span class="op" id="3059754">(</span><span class="op" id="3059755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059758">if</span>&nbsp;<span class="ident" id="3059761">c</span><span class="op" id="3059762">.</span><span class="ident" id="3059763">closeNotifyc</span>&nbsp;<span class="op" id="3059776">==</span>&nbsp;<span class="ident" id="3059779">nil</span>&nbsp;<span class="op" id="3059783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059787">c</span><span class="op" id="3059788">.</span><span class="ident" id="3059789">closeNotifyc</span>&nbsp;<span class="op" id="3059802">=</span>&nbsp;<span class="builtinfunc" id="3059804">make</span><span class="op" id="3059808">(</span><span class="keyword" id="3059809">chan</span>&nbsp;<span class="builtintype" id="3059814">bool</span><span class="op" id="3059818">,</span>&nbsp;<span class="num" id="3059820">1</span><span class="op" id="3059821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059825">if</span>&nbsp;<span class="ident" id="3059828">c</span><span class="op" id="3059829">.</span><span class="ident" id="3059830">hijackedv</span>&nbsp;<span class="op" id="3059840">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3059845">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3059895">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3059930">return</span>&nbsp;<span class="ident" id="3059937">c</span><span class="op" id="3059938">.</span><span class="ident" id="3059939">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3059954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059958">pr</span><span class="op" id="3059960">,</span>&nbsp;<span class="ident" id="3059962">pw</span>&nbsp;<span class="op" id="3059965">:=</span>&nbsp;<span class="ident" id="3059968">io</span><span class="op" id="3059970">.</span><span class="ident" id="3059971">Pipe</span><span class="op" id="3059975">(</span><span class="op" id="3059976">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3059981">readSource</span>&nbsp;<span class="op" id="3059992">:=</span>&nbsp;<span class="ident" id="3059995">c</span><span class="op" id="3059996">.</span><span class="ident" id="3059997">sr</span><span class="op" id="3059999">.</span><span class="ident" id="3060000">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060004">c</span><span class="op" id="3060005">.</span><span class="ident" id="3060006">sr</span><span class="op" id="3060008">.</span><span class="ident" id="3060009">Lock</span><span class="op" id="3060013">(</span><span class="op" id="3060014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060018">c</span><span class="op" id="3060019">.</span><span class="ident" id="3060020">sr</span><span class="op" id="3060022">.</span><span class="ident" id="3060023">r</span>&nbsp;<span class="op" id="3060025">=</span>&nbsp;<span class="ident" id="3060027">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060032">c</span><span class="op" id="3060033">.</span><span class="ident" id="3060034">sr</span><span class="op" id="3060036">.</span><span class="ident" id="3060037">Unlock</span><span class="op" id="3060043">(</span><span class="op" id="3060044">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3060048">go</span>&nbsp;<span class="keyword" id="3060051">func</span><span class="op" id="3060055">(</span><span class="op" id="3060056">)</span>&nbsp;<span class="op" id="3060058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060063">_</span><span class="op" id="3060064">,</span>&nbsp;<span class="ident" id="3060066">err</span>&nbsp;<span class="op" id="3060070">:=</span>&nbsp;<span class="ident" id="3060073">io</span><span class="op" id="3060075">.</span><span class="ident" id="3060076">Copy</span><span class="op" id="3060080">(</span><span class="ident" id="3060081">pw</span><span class="op" id="3060083">,</span>&nbsp;<span class="ident" id="3060085">readSource</span><span class="op" id="3060095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3060100">if</span>&nbsp;<span class="ident" id="3060103">err</span>&nbsp;<span class="op" id="3060107">==</span>&nbsp;<span class="ident" id="3060110">nil</span>&nbsp;<span class="op" id="3060114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060120">err</span>&nbsp;<span class="op" id="3060124">=</span>&nbsp;<span class="ident" id="3060126">io</span><span class="op" id="3060128">.</span><span class="ident" id="3060129">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3060136">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060141">pw</span><span class="op" id="3060143">.</span><span class="ident" id="3060144">CloseWithError</span><span class="op" id="3060158">(</span><span class="ident" id="3060159">err</span><span class="op" id="3060162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060167">c</span><span class="op" id="3060168">.</span><span class="ident" id="3060169">noteClientGone</span><span class="op" id="3060183">(</span><span class="op" id="3060184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3060188">}</span><span class="op" id="3060189">(</span><span class="op" id="3060190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3060193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3060196">return</span>&nbsp;<span class="ident" id="3060203">c</span><span class="op" id="3060204">.</span><span class="ident" id="3060205">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3060218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3060221">func</span>&nbsp;<span class="op" id="3060226">(</span><span class="ident" id="3060227">c</span>&nbsp;<span class="op" id="3060229">*</span><span class="ident" id="3060230">conn</span><span class="op" id="3060234">)</span>&nbsp;<span class="ident" id="3060236">noteClientGone</span><span class="op" id="3060250">(</span><span class="op" id="3060251">)</span>&nbsp;<span class="op" id="3060253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060256">c</span><span class="op" id="3060257">.</span><span class="ident" id="3060258">mu</span><span class="op" id="3060260">.</span><span class="ident" id="3060261">Lock</span><span class="op" id="3060265">(</span><span class="op" id="3060266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3060269">defer</span>&nbsp;<span class="ident" id="3060275">c</span><span class="op" id="3060276">.</span><span class="ident" id="3060277">mu</span><span class="op" id="3060279">.</span><span class="ident" id="3060280">Unlock</span><span class="op" id="3060286">(</span><span class="op" id="3060287">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3060290">if</span>&nbsp;<span class="ident" id="3060293">c</span><span class="op" id="3060294">.</span><span class="ident" id="3060295">closeNotifyc</span>&nbsp;<span class="op" id="3060308">!=</span>&nbsp;<span class="ident" id="3060311">nil</span>&nbsp;<span class="op" id="3060315">&amp;&amp;</span>&nbsp;<span class="op" id="3060318">!</span><span class="ident" id="3060319">c</span><span class="op" id="3060320">.</span><span class="ident" id="3060321">clientGone</span>&nbsp;<span class="op" id="3060332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060336">c</span><span class="op" id="3060337">.</span><span class="ident" id="3060338">closeNotifyc</span>&nbsp;<span class="op" id="3060351">&lt;-</span>&nbsp;<span class="builtintype" id="3060354">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3060360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060363">c</span><span class="op" id="3060364">.</span><span class="ident" id="3060365">clientGone</span>&nbsp;<span class="op" id="3060376">=</span>&nbsp;<span class="builtintype" id="3060378">true</span><br>
<span class="lineno"></span><span class="op" id="3060383">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3060386">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3060444">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3060496">type</span>&nbsp;<span class="ident" id="3060501">switchReader</span>&nbsp;<span class="keyword" id="3060514">struct</span>&nbsp;<span class="op" id="3060521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060524">io</span><span class="op" id="3060526">.</span><span class="ident" id="3060527">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3060534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3060537">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3060595">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3060648">type</span>&nbsp;<span class="ident" id="3060653">switchWriter</span>&nbsp;<span class="keyword" id="3060666">struct</span>&nbsp;<span class="op" id="3060673">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060676">io</span><span class="op" id="3060678">.</span><span class="ident" id="3060679">Writer</span><br>
<span class="lineno"></span><span class="op" id="3060686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3060689">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3060756">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3060801">type</span>&nbsp;<span class="ident" id="3060806">liveSwitchReader</span>&nbsp;<span class="keyword" id="3060823">struct</span>&nbsp;<span class="op" id="3060830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060833">sync</span><span class="op" id="3060837">.</span><span class="ident" id="3060838">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060845">r</span>&nbsp;<span class="ident" id="3060847">io</span><span class="op" id="3060849">.</span><span class="ident" id="3060850">Reader</span><br>
<span class="lineno"></span><span class="op" id="3060857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3060860">func</span>&nbsp;<span class="op" id="3060865">(</span><span class="ident" id="3060866">sr</span>&nbsp;<span class="op" id="3060869">*</span><span class="ident" id="3060870">liveSwitchReader</span><span class="op" id="3060886">)</span>&nbsp;<span class="ident" id="3060888">Read</span><span class="op" id="3060892">(</span><span class="ident" id="3060893">p</span>&nbsp;<span class="op" id="3060895">[</span><span class="op" id="3060896">]</span><span class="builtintype" id="3060897">byte</span><span class="op" id="3060901">)</span>&nbsp;<span class="op" id="3060903">(</span><span class="ident" id="3060904">n</span>&nbsp;<span class="builtintype" id="3060906">int</span><span class="op" id="3060909">,</span>&nbsp;<span class="ident" id="3060911">err</span>&nbsp;<span class="builtintype" id="3060915">error</span><span class="op" id="3060920">)</span>&nbsp;<span class="op" id="3060922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060925">sr</span><span class="op" id="3060927">.</span><span class="ident" id="3060928">Lock</span><span class="op" id="3060932">(</span><span class="op" id="3060933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060936">r</span>&nbsp;<span class="op" id="3060938">:=</span>&nbsp;<span class="ident" id="3060941">sr</span><span class="op" id="3060943">.</span><span class="ident" id="3060944">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3060947">sr</span><span class="op" id="3060949">.</span><span class="ident" id="3060950">Unlock</span><span class="op" id="3060956">(</span><span class="op" id="3060957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3060960">return</span>&nbsp;<span class="ident" id="3060967">r</span><span class="op" id="3060968">.</span><span class="ident" id="3060969">Read</span><span class="op" id="3060973">(</span><span class="ident" id="3060974">p</span><span class="op" id="3060975">)</span><br>
<span class="lineno">215</span><span class="op" id="3060977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3060980">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3061034">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3061076">const</span>&nbsp;<span class="ident" id="3061082">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3061107">=</span>&nbsp;<span class="num" id="3061109">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3061115">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3061184">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3061233">//</span><br>
<span class="lineno"></span><span class="comment" id="3061236">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3061308">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3061379">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3061451">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3061525">//</span><br>
<span class="lineno"></span><span class="comment" id="3061528">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3061598">type</span>&nbsp;<span class="ident" id="3061603">chunkWriter</span>&nbsp;<span class="keyword" id="3061615">struct</span>&nbsp;<span class="op" id="3061622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3061625">res</span>&nbsp;<span class="op" id="3061629">*</span><span class="ident" id="3061630">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3061641">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3061703">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3061761">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3061819">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3061859">header</span>&nbsp;<span class="ident" id="3061866">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3061875">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3061939">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3061989">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3062050">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062073">wroteHeader</span>&nbsp;<span class="builtintype" id="3062085">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3062092">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062127">chunking</span>&nbsp;<span class="builtintype" id="3062136">bool</span>&nbsp;<span class="comment" id="3062141">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3062191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3062194">var</span>&nbsp;<span class="op" id="3062198">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062201">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3062212">=</span>&nbsp;<span class="op" id="3062214">[</span><span class="op" id="3062215">]</span><span class="builtintype" id="3062216">byte</span><span class="op" id="3062220">(</span><span class="string" id="3062221">&#34;\r\n&#34;</span><span class="op" id="3062227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062230">colonSpace</span>&nbsp;<span class="op" id="3062241">=</span>&nbsp;<span class="op" id="3062243">[</span><span class="op" id="3062244">]</span><span class="builtintype" id="3062245">byte</span><span class="op" id="3062249">(</span><span class="string" id="3062250">&#34;:&nbsp;&#34;</span><span class="op" id="3062254">)</span><br>
<span class="lineno"></span><span class="op" id="3062256">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3062259">func</span>&nbsp;<span class="op" id="3062264">(</span><span class="ident" id="3062265">cw</span>&nbsp;<span class="op" id="3062268">*</span><span class="ident" id="3062269">chunkWriter</span><span class="op" id="3062280">)</span>&nbsp;<span class="ident" id="3062282">Write</span><span class="op" id="3062287">(</span><span class="ident" id="3062288">p</span>&nbsp;<span class="op" id="3062290">[</span><span class="op" id="3062291">]</span><span class="builtintype" id="3062292">byte</span><span class="op" id="3062296">)</span>&nbsp;<span class="op" id="3062298">(</span><span class="ident" id="3062299">n</span>&nbsp;<span class="builtintype" id="3062301">int</span><span class="op" id="3062304">,</span>&nbsp;<span class="ident" id="3062306">err</span>&nbsp;<span class="builtintype" id="3062310">error</span><span class="op" id="3062315">)</span>&nbsp;<span class="op" id="3062317">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062320">if</span>&nbsp;<span class="op" id="3062323">!</span><span class="ident" id="3062324">cw</span><span class="op" id="3062326">.</span><span class="ident" id="3062327">wroteHeader</span>&nbsp;<span class="op" id="3062339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062343">cw</span><span class="op" id="3062345">.</span><span class="ident" id="3062346">writeHeader</span><span class="op" id="3062357">(</span><span class="ident" id="3062358">p</span><span class="op" id="3062359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062365">if</span>&nbsp;<span class="ident" id="3062368">cw</span><span class="op" id="3062370">.</span><span class="ident" id="3062371">res</span><span class="op" id="3062374">.</span><span class="ident" id="3062375">req</span><span class="op" id="3062378">.</span><span class="ident" id="3062379">Method</span>&nbsp;<span class="op" id="3062386">==</span>&nbsp;<span class="string" id="3062389">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3062396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3062400">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062417">return</span>&nbsp;<span class="builtinfunc" id="3062424">len</span><span class="op" id="3062427">(</span><span class="ident" id="3062428">p</span><span class="op" id="3062429">)</span><span class="op" id="3062430">,</span>&nbsp;<span class="ident" id="3062432">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062440">if</span>&nbsp;<span class="ident" id="3062443">cw</span><span class="op" id="3062445">.</span><span class="ident" id="3062446">chunking</span>&nbsp;<span class="op" id="3062455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062459">_</span><span class="op" id="3062460">,</span>&nbsp;<span class="ident" id="3062462">err</span>&nbsp;<span class="op" id="3062466">=</span>&nbsp;<span class="ident" id="3062468">fmt</span><span class="op" id="3062471">.</span><span class="ident" id="3062472">Fprintf</span><span class="op" id="3062479">(</span><span class="ident" id="3062480">cw</span><span class="op" id="3062482">.</span><span class="ident" id="3062483">res</span><span class="op" id="3062486">.</span><span class="ident" id="3062487">conn</span><span class="op" id="3062491">.</span><span class="ident" id="3062492">buf</span><span class="op" id="3062495">,</span>&nbsp;<span class="string" id="3062497">&#34;%x\r\n&#34;</span><span class="op" id="3062505">,</span>&nbsp;<span class="builtinfunc" id="3062507">len</span><span class="op" id="3062510">(</span><span class="ident" id="3062511">p</span><span class="op" id="3062512">)</span><span class="op" id="3062513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062517">if</span>&nbsp;<span class="ident" id="3062520">err</span>&nbsp;<span class="op" id="3062524">!=</span>&nbsp;<span class="ident" id="3062527">nil</span>&nbsp;<span class="op" id="3062531">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062536">cw</span><span class="op" id="3062538">.</span><span class="ident" id="3062539">res</span><span class="op" id="3062542">.</span><span class="ident" id="3062543">conn</span><span class="op" id="3062547">.</span><span class="ident" id="3062548">rwc</span><span class="op" id="3062551">.</span><span class="ident" id="3062552">Close</span><span class="op" id="3062557">(</span><span class="op" id="3062558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062563">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062578">n</span><span class="op" id="3062579">,</span>&nbsp;<span class="ident" id="3062581">err</span>&nbsp;<span class="op" id="3062585">=</span>&nbsp;<span class="ident" id="3062587">cw</span><span class="op" id="3062589">.</span><span class="ident" id="3062590">res</span><span class="op" id="3062593">.</span><span class="ident" id="3062594">conn</span><span class="op" id="3062598">.</span><span class="ident" id="3062599">buf</span><span class="op" id="3062602">.</span><span class="ident" id="3062603">Write</span><span class="op" id="3062608">(</span><span class="ident" id="3062609">p</span><span class="op" id="3062610">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062613">if</span>&nbsp;<span class="ident" id="3062616">cw</span><span class="op" id="3062618">.</span><span class="ident" id="3062619">chunking</span>&nbsp;<span class="op" id="3062628">&amp;&amp;</span>&nbsp;<span class="ident" id="3062631">err</span>&nbsp;<span class="op" id="3062635">==</span>&nbsp;<span class="ident" id="3062638">nil</span>&nbsp;<span class="op" id="3062642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062646">_</span><span class="op" id="3062647">,</span>&nbsp;<span class="ident" id="3062649">err</span>&nbsp;<span class="op" id="3062653">=</span>&nbsp;<span class="ident" id="3062655">cw</span><span class="op" id="3062657">.</span><span class="ident" id="3062658">res</span><span class="op" id="3062661">.</span><span class="ident" id="3062662">conn</span><span class="op" id="3062666">.</span><span class="ident" id="3062667">buf</span><span class="op" id="3062670">.</span><span class="ident" id="3062671">Write</span><span class="op" id="3062676">(</span><span class="ident" id="3062677">crlf</span><span class="op" id="3062681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062687">if</span>&nbsp;<span class="ident" id="3062690">err</span>&nbsp;<span class="op" id="3062694">!=</span>&nbsp;<span class="ident" id="3062697">nil</span>&nbsp;<span class="op" id="3062701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062705">cw</span><span class="op" id="3062707">.</span><span class="ident" id="3062708">res</span><span class="op" id="3062711">.</span><span class="ident" id="3062712">conn</span><span class="op" id="3062716">.</span><span class="ident" id="3062717">rwc</span><span class="op" id="3062720">.</span><span class="ident" id="3062721">Close</span><span class="op" id="3062726">(</span><span class="op" id="3062727">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062733">return</span><br>
<span class="lineno"></span><span class="op" id="3062740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3062743">func</span>&nbsp;<span class="op" id="3062748">(</span><span class="ident" id="3062749">cw</span>&nbsp;<span class="op" id="3062752">*</span><span class="ident" id="3062753">chunkWriter</span><span class="op" id="3062764">)</span>&nbsp;<span class="ident" id="3062766">flush</span><span class="op" id="3062771">(</span><span class="op" id="3062772">)</span>&nbsp;<span class="op" id="3062774">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062777">if</span>&nbsp;<span class="op" id="3062780">!</span><span class="ident" id="3062781">cw</span><span class="op" id="3062783">.</span><span class="ident" id="3062784">wroteHeader</span>&nbsp;<span class="op" id="3062796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062800">cw</span><span class="op" id="3062802">.</span><span class="ident" id="3062803">writeHeader</span><span class="op" id="3062814">(</span><span class="ident" id="3062815">nil</span><span class="op" id="3062818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062824">cw</span><span class="op" id="3062826">.</span><span class="ident" id="3062827">res</span><span class="op" id="3062830">.</span><span class="ident" id="3062831">conn</span><span class="op" id="3062835">.</span><span class="ident" id="3062836">buf</span><span class="op" id="3062839">.</span><span class="ident" id="3062840">Flush</span><span class="op" id="3062845">(</span><span class="op" id="3062846">)</span><br>
<span class="lineno"></span><span class="op" id="3062848">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3062851">func</span>&nbsp;<span class="op" id="3062856">(</span><span class="ident" id="3062857">cw</span>&nbsp;<span class="op" id="3062860">*</span><span class="ident" id="3062861">chunkWriter</span><span class="op" id="3062872">)</span>&nbsp;<span class="builtinfunc" id="3062874">close</span><span class="op" id="3062879">(</span><span class="op" id="3062880">)</span>&nbsp;<span class="op" id="3062882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062885">if</span>&nbsp;<span class="op" id="3062888">!</span><span class="ident" id="3062889">cw</span><span class="op" id="3062891">.</span><span class="ident" id="3062892">wroteHeader</span>&nbsp;<span class="op" id="3062904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062908">cw</span><span class="op" id="3062910">.</span><span class="ident" id="3062911">writeHeader</span><span class="op" id="3062922">(</span><span class="ident" id="3062923">nil</span><span class="op" id="3062926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062929">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062932">if</span>&nbsp;<span class="ident" id="3062935">cw</span><span class="op" id="3062937">.</span><span class="ident" id="3062938">chunking</span>&nbsp;<span class="op" id="3062947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3062951">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3063007">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3063061">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063072">cw</span><span class="op" id="3063074">.</span><span class="ident" id="3063075">res</span><span class="op" id="3063078">.</span><span class="ident" id="3063079">conn</span><span class="op" id="3063083">.</span><span class="ident" id="3063084">buf</span><span class="op" id="3063087">.</span><span class="ident" id="3063088">WriteString</span><span class="op" id="3063099">(</span><span class="string" id="3063100">&#34;0\r\n\r\n&#34;</span><span class="op" id="3063111">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063114">}</span><br>
<span class="lineno"></span><span class="op" id="3063116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3063119">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3063181">type</span>&nbsp;<span class="ident" id="3063186">response</span>&nbsp;<span class="keyword" id="3063195">struct</span>&nbsp;<span class="op" id="3063202">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063205">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3063219">*</span><span class="ident" id="3063220">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063226">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3063240">*</span><span class="ident" id="3063241">Request</span>&nbsp;<span class="comment" id="3063249">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063279">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3063293">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063302">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063348">wroteContinue</span>&nbsp;<span class="builtintype" id="3063362">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063371">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063410">w</span>&nbsp;&nbsp;<span class="op" id="3063413">*</span><span class="ident" id="3063414">bufio</span><span class="op" id="3063419">.</span><span class="ident" id="3063420">Writer</span>&nbsp;<span class="comment" id="3063427">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063471">cw</span>&nbsp;<span class="ident" id="3063474">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063487">sw</span>&nbsp;<span class="op" id="3063490">*</span><span class="ident" id="3063491">switchWriter</span>&nbsp;<span class="comment" id="3063504">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3063559">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3063620">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3063682">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3063740">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063784">handlerHeader</span>&nbsp;<span class="ident" id="3063798">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063806">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3063820">bool</span>&nbsp;<span class="comment" id="3063825">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063872">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063886">int64</span>&nbsp;<span class="comment" id="3063892">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063928">contentLength</span>&nbsp;<span class="ident" id="3063942">int64</span>&nbsp;<span class="comment" id="3063948">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063994">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3064008">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3064014">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064053">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064112">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064165">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064216">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064236">closeAfterReply</span>&nbsp;<span class="builtintype" id="3064252">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064259">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064314">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064369">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064420">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064482">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064538">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064598">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064617">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3064637">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064644">handlerDone</span>&nbsp;<span class="builtintype" id="3064656">bool</span>&nbsp;<span class="comment" id="3064661">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3064698">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064738">dateBuf</span>&nbsp;<span class="op" id="3064746">[</span><span class="builtinfunc" id="3064747">len</span><span class="op" id="3064750">(</span><span class="ident" id="3064751">TimeFormat</span><span class="op" id="3064761">)</span><span class="op" id="3064762">]</span><span class="builtintype" id="3064763">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064769">clenBuf</span>&nbsp;<span class="op" id="3064777">[</span><span class="num" id="3064778">10</span><span class="op" id="3064780">]</span><span class="builtintype" id="3064781">byte</span><br>
<span class="lineno">340</span><span class="op" id="3064786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3064789">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3064860">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3064890">func</span>&nbsp;<span class="op" id="3064895">(</span><span class="ident" id="3064896">w</span>&nbsp;<span class="op" id="3064898">*</span><span class="ident" id="3064899">response</span><span class="op" id="3064907">)</span>&nbsp;<span class="ident" id="3064909">requestTooLarge</span><span class="op" id="3064924">(</span><span class="op" id="3064925">)</span>&nbsp;<span class="op" id="3064927">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064930">w</span><span class="op" id="3064931">.</span><span class="ident" id="3064932">closeAfterReply</span>&nbsp;<span class="op" id="3064948">=</span>&nbsp;<span class="builtintype" id="3064950">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064956">w</span><span class="op" id="3064957">.</span><span class="ident" id="3064958">requestBodyLimitHit</span>&nbsp;<span class="op" id="3064978">=</span>&nbsp;<span class="builtintype" id="3064980">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3064986">if</span>&nbsp;<span class="op" id="3064989">!</span><span class="ident" id="3064990">w</span><span class="op" id="3064991">.</span><span class="ident" id="3064992">wroteHeader</span>&nbsp;<span class="op" id="3065004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065008">w</span><span class="op" id="3065009">.</span><span class="ident" id="3065010">Header</span><span class="op" id="3065016">(</span><span class="op" id="3065017">)</span><span class="op" id="3065018">.</span><span class="ident" id="3065019">Set</span><span class="op" id="3065022">(</span><span class="string" id="3065023">&#34;Connection&#34;</span><span class="op" id="3065035">,</span>&nbsp;<span class="string" id="3065037">&#34;close&#34;</span><span class="op" id="3065044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065047">}</span><br>
<span class="lineno">350</span><span class="op" id="3065049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3065052">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3065124">func</span>&nbsp;<span class="op" id="3065129">(</span><span class="ident" id="3065130">w</span>&nbsp;<span class="op" id="3065132">*</span><span class="ident" id="3065133">response</span><span class="op" id="3065141">)</span>&nbsp;<span class="ident" id="3065143">needsSniff</span><span class="op" id="3065153">(</span><span class="op" id="3065154">)</span>&nbsp;<span class="builtintype" id="3065156">bool</span>&nbsp;<span class="op" id="3065161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065164">_</span><span class="op" id="3065165">,</span>&nbsp;<span class="ident" id="3065167">haveType</span>&nbsp;<span class="op" id="3065176">:=</span>&nbsp;<span class="ident" id="3065179">w</span><span class="op" id="3065180">.</span><span class="ident" id="3065181">handlerHeader</span><span class="op" id="3065194">[</span><span class="string" id="3065195">&#34;Content-Type&#34;</span><span class="op" id="3065209">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065212">return</span>&nbsp;<span class="op" id="3065219">!</span><span class="ident" id="3065220">w</span><span class="op" id="3065221">.</span><span class="ident" id="3065222">cw</span><span class="op" id="3065224">.</span><span class="ident" id="3065225">wroteHeader</span>&nbsp;<span class="op" id="3065237">&amp;&amp;</span>&nbsp;<span class="op" id="3065240">!</span><span class="ident" id="3065241">haveType</span>&nbsp;<span class="op" id="3065250">&amp;&amp;</span>&nbsp;<span class="ident" id="3065253">w</span><span class="op" id="3065254">.</span><span class="ident" id="3065255">written</span>&nbsp;<span class="op" id="3065263">&lt;</span>&nbsp;<span class="ident" id="3065265">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="3065274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3065277">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3065343">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3065360">type</span>&nbsp;<span class="ident" id="3065365">writerOnly</span>&nbsp;<span class="keyword" id="3065376">struct</span>&nbsp;<span class="op" id="3065383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065386">io</span><span class="op" id="3065388">.</span><span class="ident" id="3065389">Writer</span><br>
<span class="lineno"></span><span class="op" id="3065396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3065399">func</span>&nbsp;<span class="ident" id="3065404">srcIsRegularFile</span><span class="op" id="3065420">(</span><span class="ident" id="3065421">src</span>&nbsp;<span class="ident" id="3065425">io</span><span class="op" id="3065427">.</span><span class="ident" id="3065428">Reader</span><span class="op" id="3065434">)</span>&nbsp;<span class="op" id="3065436">(</span><span class="ident" id="3065437">isRegular</span>&nbsp;<span class="builtintype" id="3065447">bool</span><span class="op" id="3065451">,</span>&nbsp;<span class="ident" id="3065453">err</span>&nbsp;<span class="builtintype" id="3065457">error</span><span class="op" id="3065462">)</span>&nbsp;<span class="op" id="3065464">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065467">switch</span>&nbsp;<span class="ident" id="3065474">v</span>&nbsp;<span class="op" id="3065476">:=</span>&nbsp;<span class="ident" id="3065479">src</span><span class="op" id="3065482">.</span><span class="op" id="3065483">(</span><span class="keyword" id="3065484">type</span><span class="op" id="3065488">)</span>&nbsp;<span class="op" id="3065490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065493">case</span>&nbsp;<span class="op" id="3065498">*</span><span class="ident" id="3065499">os</span><span class="op" id="3065501">.</span><span class="ident" id="3065502">File</span><span class="op" id="3065506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065510">fi</span><span class="op" id="3065512">,</span>&nbsp;<span class="ident" id="3065514">err</span>&nbsp;<span class="op" id="3065518">:=</span>&nbsp;<span class="ident" id="3065521">v</span><span class="op" id="3065522">.</span><span class="ident" id="3065523">Stat</span><span class="op" id="3065527">(</span><span class="op" id="3065528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065532">if</span>&nbsp;<span class="ident" id="3065535">err</span>&nbsp;<span class="op" id="3065539">!=</span>&nbsp;<span class="ident" id="3065542">nil</span>&nbsp;<span class="op" id="3065546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065551">return</span>&nbsp;<span class="builtintype" id="3065558">false</span><span class="op" id="3065563">,</span>&nbsp;<span class="ident" id="3065565">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065575">return</span>&nbsp;<span class="ident" id="3065582">fi</span><span class="op" id="3065584">.</span><span class="ident" id="3065585">Mode</span><span class="op" id="3065589">(</span><span class="op" id="3065590">)</span><span class="op" id="3065591">.</span><span class="ident" id="3065592">IsRegular</span><span class="op" id="3065601">(</span><span class="op" id="3065602">)</span><span class="op" id="3065603">,</span>&nbsp;<span class="ident" id="3065605">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065610">case</span>&nbsp;<span class="op" id="3065615">*</span><span class="ident" id="3065616">io</span><span class="op" id="3065618">.</span><span class="ident" id="3065619">LimitedReader</span><span class="op" id="3065632">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065636">return</span>&nbsp;<span class="ident" id="3065643">srcIsRegularFile</span><span class="op" id="3065659">(</span><span class="ident" id="3065660">v</span><span class="op" id="3065661">.</span><span class="ident" id="3065662">R</span><span class="op" id="3065663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065666">default</span><span class="op" id="3065673">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065677">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065685">}</span><br>
<span class="lineno"></span><span class="op" id="3065687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3065690">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3065760">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3065796">func</span>&nbsp;<span class="op" id="3065801">(</span><span class="ident" id="3065802">w</span>&nbsp;<span class="op" id="3065804">*</span><span class="ident" id="3065805">response</span><span class="op" id="3065813">)</span>&nbsp;<span class="ident" id="3065815">ReadFrom</span><span class="op" id="3065823">(</span><span class="ident" id="3065824">src</span>&nbsp;<span class="ident" id="3065828">io</span><span class="op" id="3065830">.</span><span class="ident" id="3065831">Reader</span><span class="op" id="3065837">)</span>&nbsp;<span class="op" id="3065839">(</span><span class="ident" id="3065840">n</span>&nbsp;<span class="ident" id="3065842">int64</span><span class="op" id="3065847">,</span>&nbsp;<span class="ident" id="3065849">err</span>&nbsp;<span class="builtintype" id="3065853">error</span><span class="op" id="3065858">)</span>&nbsp;<span class="op" id="3065860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3065863">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3065925">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3065989">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066041">rf</span><span class="op" id="3066043">,</span>&nbsp;<span class="ident" id="3066045">ok</span>&nbsp;<span class="op" id="3066048">:=</span>&nbsp;<span class="ident" id="3066051">w</span><span class="op" id="3066052">.</span><span class="ident" id="3066053">conn</span><span class="op" id="3066057">.</span><span class="ident" id="3066058">rwc</span><span class="op" id="3066061">.</span><span class="op" id="3066062">(</span><span class="ident" id="3066063">io</span><span class="op" id="3066065">.</span><span class="ident" id="3066066">ReaderFrom</span><span class="op" id="3066076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066079">regFile</span><span class="op" id="3066086">,</span>&nbsp;<span class="ident" id="3066088">err</span>&nbsp;<span class="op" id="3066092">:=</span>&nbsp;<span class="ident" id="3066095">srcIsRegularFile</span><span class="op" id="3066111">(</span><span class="ident" id="3066112">src</span><span class="op" id="3066115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066118">if</span>&nbsp;<span class="ident" id="3066121">err</span>&nbsp;<span class="op" id="3066125">!=</span>&nbsp;<span class="ident" id="3066128">nil</span>&nbsp;<span class="op" id="3066132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066136">return</span>&nbsp;<span class="num" id="3066143">0</span><span class="op" id="3066144">,</span>&nbsp;<span class="ident" id="3066146">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066151">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066154">if</span>&nbsp;<span class="op" id="3066157">!</span><span class="ident" id="3066158">ok</span>&nbsp;<span class="op" id="3066161">||</span>&nbsp;<span class="op" id="3066164">!</span><span class="ident" id="3066165">regFile</span>&nbsp;<span class="op" id="3066173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066177">return</span>&nbsp;<span class="ident" id="3066184">io</span><span class="op" id="3066186">.</span><span class="ident" id="3066187">Copy</span><span class="op" id="3066191">(</span><span class="ident" id="3066192">writerOnly</span><span class="op" id="3066202">{</span><span class="ident" id="3066203">w</span><span class="op" id="3066204">}</span><span class="op" id="3066205">,</span>&nbsp;<span class="ident" id="3066207">src</span><span class="op" id="3066210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3066217">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066237">if</span>&nbsp;<span class="op" id="3066240">!</span><span class="ident" id="3066241">w</span><span class="op" id="3066242">.</span><span class="ident" id="3066243">wroteHeader</span>&nbsp;<span class="op" id="3066255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066259">w</span><span class="op" id="3066260">.</span><span class="ident" id="3066261">WriteHeader</span><span class="op" id="3066272">(</span><span class="ident" id="3066273">StatusOK</span><span class="op" id="3066281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066288">if</span>&nbsp;<span class="ident" id="3066291">w</span><span class="op" id="3066292">.</span><span class="ident" id="3066293">needsSniff</span><span class="op" id="3066303">(</span><span class="op" id="3066304">)</span>&nbsp;<span class="op" id="3066306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066310">n0</span><span class="op" id="3066312">,</span>&nbsp;<span class="ident" id="3066314">err</span>&nbsp;<span class="op" id="3066318">:=</span>&nbsp;<span class="ident" id="3066321">io</span><span class="op" id="3066323">.</span><span class="ident" id="3066324">Copy</span><span class="op" id="3066328">(</span><span class="ident" id="3066329">writerOnly</span><span class="op" id="3066339">{</span><span class="ident" id="3066340">w</span><span class="op" id="3066341">}</span><span class="op" id="3066342">,</span>&nbsp;<span class="ident" id="3066344">io</span><span class="op" id="3066346">.</span><span class="ident" id="3066347">LimitReader</span><span class="op" id="3066358">(</span><span class="ident" id="3066359">src</span><span class="op" id="3066362">,</span>&nbsp;<span class="ident" id="3066364">sniffLen</span><span class="op" id="3066372">)</span><span class="op" id="3066373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066377">n</span>&nbsp;<span class="op" id="3066379">+=</span>&nbsp;<span class="ident" id="3066382">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066387">if</span>&nbsp;<span class="ident" id="3066390">err</span>&nbsp;<span class="op" id="3066394">!=</span>&nbsp;<span class="ident" id="3066397">nil</span>&nbsp;<span class="op" id="3066401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066406">return</span>&nbsp;<span class="ident" id="3066413">n</span><span class="op" id="3066414">,</span>&nbsp;<span class="ident" id="3066416">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066429">w</span><span class="op" id="3066430">.</span><span class="ident" id="3066431">w</span><span class="op" id="3066432">.</span><span class="ident" id="3066433">Flush</span><span class="op" id="3066438">(</span><span class="op" id="3066439">)</span>&nbsp;&nbsp;<span class="comment" id="3066442">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066477">w</span><span class="op" id="3066478">.</span><span class="ident" id="3066479">cw</span><span class="op" id="3066481">.</span><span class="ident" id="3066482">flush</span><span class="op" id="3066487">(</span><span class="op" id="3066488">)</span>&nbsp;<span class="comment" id="3066490">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3066542">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066622">if</span>&nbsp;<span class="op" id="3066625">!</span><span class="ident" id="3066626">w</span><span class="op" id="3066627">.</span><span class="ident" id="3066628">cw</span><span class="op" id="3066630">.</span><span class="ident" id="3066631">chunking</span>&nbsp;<span class="op" id="3066640">&amp;&amp;</span>&nbsp;<span class="ident" id="3066643">w</span><span class="op" id="3066644">.</span><span class="ident" id="3066645">bodyAllowed</span><span class="op" id="3066656">(</span><span class="op" id="3066657">)</span>&nbsp;<span class="op" id="3066659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066663">n0</span><span class="op" id="3066665">,</span>&nbsp;<span class="ident" id="3066667">err</span>&nbsp;<span class="op" id="3066671">:=</span>&nbsp;<span class="ident" id="3066674">rf</span><span class="op" id="3066676">.</span><span class="ident" id="3066677">ReadFrom</span><span class="op" id="3066685">(</span><span class="ident" id="3066686">src</span><span class="op" id="3066689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066693">n</span>&nbsp;<span class="op" id="3066695">+=</span>&nbsp;<span class="ident" id="3066698">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066703">w</span><span class="op" id="3066704">.</span><span class="ident" id="3066705">written</span>&nbsp;<span class="op" id="3066713">+=</span>&nbsp;<span class="ident" id="3066716">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066721">return</span>&nbsp;<span class="ident" id="3066728">n</span><span class="op" id="3066729">,</span>&nbsp;<span class="ident" id="3066731">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066740">n0</span><span class="op" id="3066742">,</span>&nbsp;<span class="ident" id="3066744">err</span>&nbsp;<span class="op" id="3066748">:=</span>&nbsp;<span class="ident" id="3066751">io</span><span class="op" id="3066753">.</span><span class="ident" id="3066754">Copy</span><span class="op" id="3066758">(</span><span class="ident" id="3066759">writerOnly</span><span class="op" id="3066769">{</span><span class="ident" id="3066770">w</span><span class="op" id="3066771">}</span><span class="op" id="3066772">,</span>&nbsp;<span class="ident" id="3066774">src</span><span class="op" id="3066777">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066780">n</span>&nbsp;<span class="op" id="3066782">+=</span>&nbsp;<span class="ident" id="3066785">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066789">return</span>&nbsp;<span class="ident" id="3066796">n</span><span class="op" id="3066797">,</span>&nbsp;<span class="ident" id="3066799">err</span><br>
<span class="lineno"></span><span class="op" id="3066803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3066806">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3066875">const</span>&nbsp;<span class="ident" id="3066881">noLimit</span>&nbsp;<span class="ident" id="3066889">int64</span>&nbsp;<span class="op" id="3066895">=</span>&nbsp;<span class="op" id="3066897">(</span><span class="num" id="3066898">1</span>&nbsp;<span class="op" id="3066900">&lt;&lt;</span>&nbsp;<span class="num" id="3066903">63</span><span class="op" id="3066905">)</span>&nbsp;<span class="op" id="3066907">-</span>&nbsp;<span class="num" id="3066909">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3066912">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3066990">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3067025">const</span>&nbsp;<span class="ident" id="3067031">debugServerConnections</span>&nbsp;<span class="op" id="3067054">=</span>&nbsp;<span class="builtintype" id="3067056">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3067063">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3067098">func</span>&nbsp;<span class="op" id="3067103">(</span><span class="ident" id="3067104">srv</span>&nbsp;<span class="op" id="3067108">*</span><span class="ident" id="3067109">Server</span><span class="op" id="3067115">)</span>&nbsp;<span class="ident" id="3067117">newConn</span><span class="op" id="3067124">(</span><span class="ident" id="3067125">rwc</span>&nbsp;<span class="ident" id="3067129">net</span><span class="op" id="3067132">.</span><span class="ident" id="3067133">Conn</span><span class="op" id="3067137">)</span>&nbsp;<span class="op" id="3067139">(</span><span class="ident" id="3067140">c</span>&nbsp;<span class="op" id="3067142">*</span><span class="ident" id="3067143">conn</span><span class="op" id="3067147">,</span>&nbsp;<span class="ident" id="3067149">err</span>&nbsp;<span class="builtintype" id="3067153">error</span><span class="op" id="3067158">)</span>&nbsp;<span class="op" id="3067160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067163">c</span>&nbsp;<span class="op" id="3067165">=</span>&nbsp;<span class="builtinfunc" id="3067167">new</span><span class="op" id="3067170">(</span><span class="ident" id="3067171">conn</span><span class="op" id="3067175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067178">c</span><span class="op" id="3067179">.</span><span class="ident" id="3067180">remoteAddr</span>&nbsp;<span class="op" id="3067191">=</span>&nbsp;<span class="ident" id="3067193">rwc</span><span class="op" id="3067196">.</span><span class="ident" id="3067197">RemoteAddr</span><span class="op" id="3067207">(</span><span class="op" id="3067208">)</span><span class="op" id="3067209">.</span><span class="ident" id="3067210">String</span><span class="op" id="3067216">(</span><span class="op" id="3067217">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067220">c</span><span class="op" id="3067221">.</span><span class="ident" id="3067222">server</span>&nbsp;<span class="op" id="3067229">=</span>&nbsp;<span class="ident" id="3067231">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067236">c</span><span class="op" id="3067237">.</span><span class="ident" id="3067238">rwc</span>&nbsp;<span class="op" id="3067242">=</span>&nbsp;<span class="ident" id="3067244">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067249">c</span><span class="op" id="3067250">.</span><span class="ident" id="3067251">w</span>&nbsp;<span class="op" id="3067253">=</span>&nbsp;<span class="ident" id="3067255">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067260">if</span>&nbsp;<span class="ident" id="3067263">debugServerConnections</span>&nbsp;<span class="op" id="3067286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067290">c</span><span class="op" id="3067291">.</span><span class="ident" id="3067292">rwc</span>&nbsp;<span class="op" id="3067296">=</span>&nbsp;<span class="ident" id="3067298">newLoggingConn</span><span class="op" id="3067312">(</span><span class="string" id="3067313">&#34;server&#34;</span><span class="op" id="3067321">,</span>&nbsp;<span class="ident" id="3067323">c</span><span class="op" id="3067324">.</span><span class="ident" id="3067325">rwc</span><span class="op" id="3067328">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067334">c</span><span class="op" id="3067335">.</span><span class="ident" id="3067336">sr</span>&nbsp;<span class="op" id="3067339">=</span>&nbsp;<span class="ident" id="3067341">liveSwitchReader</span><span class="op" id="3067357">{</span><span class="ident" id="3067358">r</span><span class="op" id="3067359">:</span>&nbsp;<span class="ident" id="3067361">c</span><span class="op" id="3067362">.</span><span class="ident" id="3067363">rwc</span><span class="op" id="3067366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067369">c</span><span class="op" id="3067370">.</span><span class="ident" id="3067371">lr</span>&nbsp;<span class="op" id="3067374">=</span>&nbsp;<span class="ident" id="3067376">io</span><span class="op" id="3067378">.</span><span class="ident" id="3067379">LimitReader</span><span class="op" id="3067390">(</span><span class="op" id="3067391">&amp;</span><span class="ident" id="3067392">c</span><span class="op" id="3067393">.</span><span class="ident" id="3067394">sr</span><span class="op" id="3067396">,</span>&nbsp;<span class="ident" id="3067398">noLimit</span><span class="op" id="3067405">)</span><span class="op" id="3067406">.</span><span class="op" id="3067407">(</span><span class="op" id="3067408">*</span><span class="ident" id="3067409">io</span><span class="op" id="3067411">.</span><span class="ident" id="3067412">LimitedReader</span><span class="op" id="3067425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067428">br</span>&nbsp;<span class="op" id="3067431">:=</span>&nbsp;<span class="ident" id="3067434">newBufioReader</span><span class="op" id="3067448">(</span><span class="ident" id="3067449">c</span><span class="op" id="3067450">.</span><span class="ident" id="3067451">lr</span><span class="op" id="3067453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067456">bw</span>&nbsp;<span class="op" id="3067459">:=</span>&nbsp;<span class="ident" id="3067462">newBufioWriterSize</span><span class="op" id="3067480">(</span><span class="ident" id="3067481">checkConnErrorWriter</span><span class="op" id="3067501">{</span><span class="ident" id="3067502">c</span><span class="op" id="3067503">}</span><span class="op" id="3067504">,</span>&nbsp;<span class="num" id="3067506">4</span><span class="op" id="3067507">&lt;&lt;</span><span class="num" id="3067509">10</span><span class="op" id="3067511">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067514">c</span><span class="op" id="3067515">.</span><span class="ident" id="3067516">buf</span>&nbsp;<span class="op" id="3067520">=</span>&nbsp;<span class="ident" id="3067522">bufio</span><span class="op" id="3067527">.</span><span class="ident" id="3067528">NewReadWriter</span><span class="op" id="3067541">(</span><span class="ident" id="3067542">br</span><span class="op" id="3067544">,</span>&nbsp;<span class="ident" id="3067546">bw</span><span class="op" id="3067548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067551">return</span>&nbsp;<span class="ident" id="3067558">c</span><span class="op" id="3067559">,</span>&nbsp;<span class="ident" id="3067561">nil</span><br>
<span class="lineno"></span><span class="op" id="3067565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3067568">var</span>&nbsp;<span class="op" id="3067572">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067575">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3067593">sync</span><span class="op" id="3067597">.</span><span class="ident" id="3067598">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067604">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3067622">sync</span><span class="op" id="3067626">.</span><span class="ident" id="3067627">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067633">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3067651">sync</span><span class="op" id="3067655">.</span><span class="ident" id="3067656">Pool</span><br>
<span class="lineno"></span><span class="op" id="3067661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3067664">func</span>&nbsp;<span class="ident" id="3067669">bufioWriterPool</span><span class="op" id="3067684">(</span><span class="ident" id="3067685">size</span>&nbsp;<span class="builtintype" id="3067690">int</span><span class="op" id="3067693">)</span>&nbsp;<span class="op" id="3067695">*</span><span class="ident" id="3067696">sync</span><span class="op" id="3067700">.</span><span class="ident" id="3067701">Pool</span>&nbsp;<span class="op" id="3067706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067709">switch</span>&nbsp;<span class="ident" id="3067716">size</span>&nbsp;<span class="op" id="3067721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067724">case</span>&nbsp;<span class="num" id="3067729">2</span>&nbsp;<span class="op" id="3067731">&lt;&lt;</span>&nbsp;<span class="num" id="3067734">10</span><span class="op" id="3067736">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067740">return</span>&nbsp;<span class="op" id="3067747">&amp;</span><span class="ident" id="3067748">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067767">case</span>&nbsp;<span class="num" id="3067772">4</span>&nbsp;<span class="op" id="3067774">&lt;&lt;</span>&nbsp;<span class="num" id="3067777">10</span><span class="op" id="3067779">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067783">return</span>&nbsp;<span class="op" id="3067790">&amp;</span><span class="ident" id="3067791">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067813">return</span>&nbsp;<span class="ident" id="3067820">nil</span><br>
<span class="lineno"></span><span class="op" id="3067824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3067827">func</span>&nbsp;<span class="ident" id="3067832">newBufioReader</span><span class="op" id="3067846">(</span><span class="ident" id="3067847">r</span>&nbsp;<span class="ident" id="3067849">io</span><span class="op" id="3067851">.</span><span class="ident" id="3067852">Reader</span><span class="op" id="3067858">)</span>&nbsp;<span class="op" id="3067860">*</span><span class="ident" id="3067861">bufio</span><span class="op" id="3067866">.</span><span class="ident" id="3067867">Reader</span>&nbsp;<span class="op" id="3067874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067877">if</span>&nbsp;<span class="ident" id="3067880">v</span>&nbsp;<span class="op" id="3067882">:=</span>&nbsp;<span class="ident" id="3067885">bufioReaderPool</span><span class="op" id="3067900">.</span><span class="ident" id="3067901">Get</span><span class="op" id="3067904">(</span><span class="op" id="3067905">)</span><span class="op" id="3067906">;</span>&nbsp;<span class="ident" id="3067908">v</span>&nbsp;<span class="op" id="3067910">!=</span>&nbsp;<span class="ident" id="3067913">nil</span>&nbsp;<span class="op" id="3067917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067921">br</span>&nbsp;<span class="op" id="3067924">:=</span>&nbsp;<span class="ident" id="3067927">v</span><span class="op" id="3067928">.</span><span class="op" id="3067929">(</span><span class="op" id="3067930">*</span><span class="ident" id="3067931">bufio</span><span class="op" id="3067936">.</span><span class="ident" id="3067937">Reader</span><span class="op" id="3067943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067947">br</span><span class="op" id="3067949">.</span><span class="ident" id="3067950">Reset</span><span class="op" id="3067955">(</span><span class="ident" id="3067956">r</span><span class="op" id="3067957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067961">return</span>&nbsp;<span class="ident" id="3067968">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067975">return</span>&nbsp;<span class="ident" id="3067982">bufio</span><span class="op" id="3067987">.</span><span class="ident" id="3067988">NewReader</span><span class="op" id="3067997">(</span><span class="ident" id="3067998">r</span><span class="op" id="3067999">)</span><br>
<span class="lineno"></span><span class="op" id="3068001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3068004">func</span>&nbsp;<span class="ident" id="3068009">putBufioReader</span><span class="op" id="3068023">(</span><span class="ident" id="3068024">br</span>&nbsp;<span class="op" id="3068027">*</span><span class="ident" id="3068028">bufio</span><span class="op" id="3068033">.</span><span class="ident" id="3068034">Reader</span><span class="op" id="3068040">)</span>&nbsp;<span class="op" id="3068042">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068045">br</span><span class="op" id="3068047">.</span><span class="ident" id="3068048">Reset</span><span class="op" id="3068053">(</span><span class="ident" id="3068054">nil</span><span class="op" id="3068057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068060">bufioReaderPool</span><span class="op" id="3068075">.</span><span class="ident" id="3068076">Put</span><span class="op" id="3068079">(</span><span class="ident" id="3068080">br</span><span class="op" id="3068082">)</span><br>
<span class="lineno"></span><span class="op" id="3068084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3068087">func</span>&nbsp;<span class="ident" id="3068092">newBufioWriterSize</span><span class="op" id="3068110">(</span><span class="ident" id="3068111">w</span>&nbsp;<span class="ident" id="3068113">io</span><span class="op" id="3068115">.</span><span class="ident" id="3068116">Writer</span><span class="op" id="3068122">,</span>&nbsp;<span class="ident" id="3068124">size</span>&nbsp;<span class="builtintype" id="3068129">int</span><span class="op" id="3068132">)</span>&nbsp;<span class="op" id="3068134">*</span><span class="ident" id="3068135">bufio</span><span class="op" id="3068140">.</span><span class="ident" id="3068141">Writer</span>&nbsp;<span class="op" id="3068148">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068151">pool</span>&nbsp;<span class="op" id="3068156">:=</span>&nbsp;<span class="ident" id="3068159">bufioWriterPool</span><span class="op" id="3068174">(</span><span class="ident" id="3068175">size</span><span class="op" id="3068179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068182">if</span>&nbsp;<span class="ident" id="3068185">pool</span>&nbsp;<span class="op" id="3068190">!=</span>&nbsp;<span class="ident" id="3068193">nil</span>&nbsp;<span class="op" id="3068197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068201">if</span>&nbsp;<span class="ident" id="3068204">v</span>&nbsp;<span class="op" id="3068206">:=</span>&nbsp;<span class="ident" id="3068209">pool</span><span class="op" id="3068213">.</span><span class="ident" id="3068214">Get</span><span class="op" id="3068217">(</span><span class="op" id="3068218">)</span><span class="op" id="3068219">;</span>&nbsp;<span class="ident" id="3068221">v</span>&nbsp;<span class="op" id="3068223">!=</span>&nbsp;<span class="ident" id="3068226">nil</span>&nbsp;<span class="op" id="3068230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068235">bw</span>&nbsp;<span class="op" id="3068238">:=</span>&nbsp;<span class="ident" id="3068241">v</span><span class="op" id="3068242">.</span><span class="op" id="3068243">(</span><span class="op" id="3068244">*</span><span class="ident" id="3068245">bufio</span><span class="op" id="3068250">.</span><span class="ident" id="3068251">Writer</span><span class="op" id="3068257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068262">bw</span><span class="op" id="3068264">.</span><span class="ident" id="3068265">Reset</span><span class="op" id="3068270">(</span><span class="ident" id="3068271">w</span><span class="op" id="3068272">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068277">return</span>&nbsp;<span class="ident" id="3068284">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068295">return</span>&nbsp;<span class="ident" id="3068302">bufio</span><span class="op" id="3068307">.</span><span class="ident" id="3068308">NewWriterSize</span><span class="op" id="3068321">(</span><span class="ident" id="3068322">w</span><span class="op" id="3068323">,</span>&nbsp;<span class="ident" id="3068325">size</span><span class="op" id="3068329">)</span><br>
<span class="lineno"></span><span class="op" id="3068331">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3068334">func</span>&nbsp;<span class="ident" id="3068339">putBufioWriter</span><span class="op" id="3068353">(</span><span class="ident" id="3068354">bw</span>&nbsp;<span class="op" id="3068357">*</span><span class="ident" id="3068358">bufio</span><span class="op" id="3068363">.</span><span class="ident" id="3068364">Writer</span><span class="op" id="3068370">)</span>&nbsp;<span class="op" id="3068372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068375">bw</span><span class="op" id="3068377">.</span><span class="ident" id="3068378">Reset</span><span class="op" id="3068383">(</span><span class="ident" id="3068384">nil</span><span class="op" id="3068387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068390">if</span>&nbsp;<span class="ident" id="3068393">pool</span>&nbsp;<span class="op" id="3068398">:=</span>&nbsp;<span class="ident" id="3068401">bufioWriterPool</span><span class="op" id="3068416">(</span><span class="ident" id="3068417">bw</span><span class="op" id="3068419">.</span><span class="ident" id="3068420">Available</span><span class="op" id="3068429">(</span><span class="op" id="3068430">)</span><span class="op" id="3068431">)</span><span class="op" id="3068432">;</span>&nbsp;<span class="ident" id="3068434">pool</span>&nbsp;<span class="op" id="3068439">!=</span>&nbsp;<span class="ident" id="3068442">nil</span>&nbsp;<span class="op" id="3068446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068450">pool</span><span class="op" id="3068454">.</span><span class="ident" id="3068455">Put</span><span class="op" id="3068458">(</span><span class="ident" id="3068459">bw</span><span class="op" id="3068461">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068464">}</span><br>
<span class="lineno"></span><span class="op" id="3068466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3068469">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3068539">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3068562">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3068622">const</span>&nbsp;<span class="ident" id="3068628">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3068650">=</span>&nbsp;<span class="num" id="3068652">1</span>&nbsp;<span class="op" id="3068654">&lt;&lt;</span>&nbsp;<span class="num" id="3068657">20</span>&nbsp;<span class="comment" id="3068660">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3068669">func</span>&nbsp;<span class="op" id="3068674">(</span><span class="ident" id="3068675">srv</span>&nbsp;<span class="op" id="3068679">*</span><span class="ident" id="3068680">Server</span><span class="op" id="3068686">)</span>&nbsp;<span class="ident" id="3068688">maxHeaderBytes</span><span class="op" id="3068702">(</span><span class="op" id="3068703">)</span>&nbsp;<span class="builtintype" id="3068705">int</span>&nbsp;<span class="op" id="3068709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068712">if</span>&nbsp;<span class="ident" id="3068715">srv</span><span class="op" id="3068718">.</span><span class="ident" id="3068719">MaxHeaderBytes</span>&nbsp;<span class="op" id="3068734">&gt;</span>&nbsp;<span class="num" id="3068736">0</span>&nbsp;<span class="op" id="3068738">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068742">return</span>&nbsp;<span class="ident" id="3068749">srv</span><span class="op" id="3068752">.</span><span class="ident" id="3068753">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068772">return</span>&nbsp;<span class="ident" id="3068779">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="3068801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3068804">func</span>&nbsp;<span class="op" id="3068809">(</span><span class="ident" id="3068810">srv</span>&nbsp;<span class="op" id="3068814">*</span><span class="ident" id="3068815">Server</span><span class="op" id="3068821">)</span>&nbsp;<span class="ident" id="3068823">initialLimitedReaderSize</span><span class="op" id="3068847">(</span><span class="op" id="3068848">)</span>&nbsp;<span class="ident" id="3068850">int64</span>&nbsp;<span class="op" id="3068856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068859">return</span>&nbsp;<span class="ident" id="3068866">int64</span><span class="op" id="3068871">(</span><span class="ident" id="3068872">srv</span><span class="op" id="3068875">.</span><span class="ident" id="3068876">maxHeaderBytes</span><span class="op" id="3068890">(</span><span class="op" id="3068891">)</span><span class="op" id="3068892">)</span>&nbsp;<span class="op" id="3068894">+</span>&nbsp;<span class="num" id="3068896">4096</span>&nbsp;<span class="comment" id="3068901">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3068915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3068918">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3068982">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3069014">type</span>&nbsp;<span class="ident" id="3069019">expectContinueReader</span>&nbsp;<span class="keyword" id="3069040">struct</span>&nbsp;<span class="op" id="3069047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069050">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069061">*</span><span class="ident" id="3069062">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069072">readCloser</span>&nbsp;<span class="ident" id="3069083">io</span><span class="op" id="3069085">.</span><span class="ident" id="3069086">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069098">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3069109">bool</span><br>
<span class="lineno">520</span><span class="op" id="3069114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3069117">func</span>&nbsp;<span class="op" id="3069122">(</span><span class="ident" id="3069123">ecr</span>&nbsp;<span class="op" id="3069127">*</span><span class="ident" id="3069128">expectContinueReader</span><span class="op" id="3069148">)</span>&nbsp;<span class="ident" id="3069150">Read</span><span class="op" id="3069154">(</span><span class="ident" id="3069155">p</span>&nbsp;<span class="op" id="3069157">[</span><span class="op" id="3069158">]</span><span class="builtintype" id="3069159">byte</span><span class="op" id="3069163">)</span>&nbsp;<span class="op" id="3069165">(</span><span class="ident" id="3069166">n</span>&nbsp;<span class="builtintype" id="3069168">int</span><span class="op" id="3069171">,</span>&nbsp;<span class="ident" id="3069173">err</span>&nbsp;<span class="builtintype" id="3069177">error</span><span class="op" id="3069182">)</span>&nbsp;<span class="op" id="3069184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069187">if</span>&nbsp;<span class="ident" id="3069190">ecr</span><span class="op" id="3069193">.</span><span class="ident" id="3069194">closed</span>&nbsp;<span class="op" id="3069201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069205">return</span>&nbsp;<span class="num" id="3069212">0</span><span class="op" id="3069213">,</span>&nbsp;<span class="ident" id="3069215">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3069238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069241">if</span>&nbsp;<span class="op" id="3069244">!</span><span class="ident" id="3069245">ecr</span><span class="op" id="3069248">.</span><span class="ident" id="3069249">resp</span><span class="op" id="3069253">.</span><span class="ident" id="3069254">wroteContinue</span>&nbsp;<span class="op" id="3069268">&amp;&amp;</span>&nbsp;<span class="op" id="3069271">!</span><span class="ident" id="3069272">ecr</span><span class="op" id="3069275">.</span><span class="ident" id="3069276">resp</span><span class="op" id="3069280">.</span><span class="ident" id="3069281">conn</span><span class="op" id="3069285">.</span><span class="ident" id="3069286">hijacked</span><span class="op" id="3069294">(</span><span class="op" id="3069295">)</span>&nbsp;<span class="op" id="3069297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069301">ecr</span><span class="op" id="3069304">.</span><span class="ident" id="3069305">resp</span><span class="op" id="3069309">.</span><span class="ident" id="3069310">wroteContinue</span>&nbsp;<span class="op" id="3069324">=</span>&nbsp;<span class="builtintype" id="3069326">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069333">ecr</span><span class="op" id="3069336">.</span><span class="ident" id="3069337">resp</span><span class="op" id="3069341">.</span><span class="ident" id="3069342">conn</span><span class="op" id="3069346">.</span><span class="ident" id="3069347">buf</span><span class="op" id="3069350">.</span><span class="ident" id="3069351">WriteString</span><span class="op" id="3069362">(</span><span class="string" id="3069363">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3069394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069398">ecr</span><span class="op" id="3069401">.</span><span class="ident" id="3069402">resp</span><span class="op" id="3069406">.</span><span class="ident" id="3069407">conn</span><span class="op" id="3069411">.</span><span class="ident" id="3069412">buf</span><span class="op" id="3069415">.</span><span class="ident" id="3069416">Flush</span><span class="op" id="3069421">(</span><span class="op" id="3069422">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3069425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069428">return</span>&nbsp;<span class="ident" id="3069435">ecr</span><span class="op" id="3069438">.</span><span class="ident" id="3069439">readCloser</span><span class="op" id="3069449">.</span><span class="ident" id="3069450">Read</span><span class="op" id="3069454">(</span><span class="ident" id="3069455">p</span><span class="op" id="3069456">)</span><br>
<span class="lineno"></span><span class="op" id="3069458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3069461">func</span>&nbsp;<span class="op" id="3069466">(</span><span class="ident" id="3069467">ecr</span>&nbsp;<span class="op" id="3069471">*</span><span class="ident" id="3069472">expectContinueReader</span><span class="op" id="3069492">)</span>&nbsp;<span class="ident" id="3069494">Close</span><span class="op" id="3069499">(</span><span class="op" id="3069500">)</span>&nbsp;<span class="builtintype" id="3069502">error</span>&nbsp;<span class="op" id="3069508">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069511">ecr</span><span class="op" id="3069514">.</span><span class="ident" id="3069515">closed</span>&nbsp;<span class="op" id="3069522">=</span>&nbsp;<span class="builtintype" id="3069524">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069530">return</span>&nbsp;<span class="ident" id="3069537">ecr</span><span class="op" id="3069540">.</span><span class="ident" id="3069541">readCloser</span><span class="op" id="3069551">.</span><span class="ident" id="3069552">Close</span><span class="op" id="3069557">(</span><span class="op" id="3069558">)</span><br>
<span class="lineno"></span><span class="op" id="3069560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3069563">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3069608">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3069656">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3069696">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3069760">const</span>&nbsp;<span class="ident" id="3069766">TimeFormat</span>&nbsp;<span class="op" id="3069777">=</span>&nbsp;<span class="string" id="3069779">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3069812">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3069892">func</span>&nbsp;<span class="ident" id="3069897">appendTime</span><span class="op" id="3069907">(</span><span class="ident" id="3069908">b</span>&nbsp;<span class="op" id="3069910">[</span><span class="op" id="3069911">]</span><span class="builtintype" id="3069912">byte</span><span class="op" id="3069916">,</span>&nbsp;<span class="ident" id="3069918">t</span>&nbsp;<span class="ident" id="3069920">time</span><span class="op" id="3069924">.</span><span class="ident" id="3069925">Time</span><span class="op" id="3069929">)</span>&nbsp;<span class="op" id="3069931">[</span><span class="op" id="3069932">]</span><span class="builtintype" id="3069933">byte</span>&nbsp;<span class="op" id="3069938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069941">const</span>&nbsp;<span class="ident" id="3069947">days</span>&nbsp;<span class="op" id="3069952">=</span>&nbsp;<span class="string" id="3069954">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069979">const</span>&nbsp;<span class="ident" id="3069985">months</span>&nbsp;<span class="op" id="3069992">=</span>&nbsp;<span class="string" id="3069994">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070035">t</span>&nbsp;<span class="op" id="3070037">=</span>&nbsp;<span class="ident" id="3070039">t</span><span class="op" id="3070040">.</span><span class="ident" id="3070041">UTC</span><span class="op" id="3070044">(</span><span class="op" id="3070045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070048">yy</span><span class="op" id="3070050">,</span>&nbsp;<span class="ident" id="3070052">mm</span><span class="op" id="3070054">,</span>&nbsp;<span class="ident" id="3070056">dd</span>&nbsp;<span class="op" id="3070059">:=</span>&nbsp;<span class="ident" id="3070062">t</span><span class="op" id="3070063">.</span><span class="ident" id="3070064">Date</span><span class="op" id="3070068">(</span><span class="op" id="3070069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070072">hh</span><span class="op" id="3070074">,</span>&nbsp;<span class="ident" id="3070076">mn</span><span class="op" id="3070078">,</span>&nbsp;<span class="ident" id="3070080">ss</span>&nbsp;<span class="op" id="3070083">:=</span>&nbsp;<span class="ident" id="3070086">t</span><span class="op" id="3070087">.</span><span class="ident" id="3070088">Clock</span><span class="op" id="3070093">(</span><span class="op" id="3070094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070097">day</span>&nbsp;<span class="op" id="3070101">:=</span>&nbsp;<span class="ident" id="3070104">days</span><span class="op" id="3070108">[</span><span class="num" id="3070109">3</span><span class="op" id="3070110">*</span><span class="ident" id="3070111">t</span><span class="op" id="3070112">.</span><span class="ident" id="3070113">Weekday</span><span class="op" id="3070120">(</span><span class="op" id="3070121">)</span><span class="op" id="3070122">:</span><span class="op" id="3070123">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070126">mon</span>&nbsp;<span class="op" id="3070130">:=</span>&nbsp;<span class="ident" id="3070133">months</span><span class="op" id="3070139">[</span><span class="num" id="3070140">3</span><span class="op" id="3070141">*</span><span class="op" id="3070142">(</span><span class="ident" id="3070143">mm</span><span class="op" id="3070145">-</span><span class="num" id="3070146">1</span><span class="op" id="3070147">)</span><span class="op" id="3070148">:</span><span class="op" id="3070149">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070153">return</span>&nbsp;<span class="builtinfunc" id="3070160">append</span><span class="op" id="3070166">(</span><span class="ident" id="3070167">b</span><span class="op" id="3070168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070172">day</span><span class="op" id="3070175">[</span><span class="num" id="3070176">0</span><span class="op" id="3070177">]</span><span class="op" id="3070178">,</span>&nbsp;<span class="ident" id="3070180">day</span><span class="op" id="3070183">[</span><span class="num" id="3070184">1</span><span class="op" id="3070185">]</span><span class="op" id="3070186">,</span>&nbsp;<span class="ident" id="3070188">day</span><span class="op" id="3070191">[</span><span class="num" id="3070192">2</span><span class="op" id="3070193">]</span><span class="op" id="3070194">,</span>&nbsp;<span class="string" id="3070196">&#39;,&#39;</span><span class="op" id="3070199">,</span>&nbsp;<span class="string" id="3070201">&#39;&nbsp;&#39;</span><span class="op" id="3070204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3070208">byte</span><span class="op" id="3070212">(</span><span class="string" id="3070213">&#39;0&#39;</span><span class="op" id="3070216">+</span><span class="ident" id="3070217">dd</span><span class="op" id="3070219">/</span><span class="num" id="3070220">10</span><span class="op" id="3070222">)</span><span class="op" id="3070223">,</span>&nbsp;<span class="builtintype" id="3070225">byte</span><span class="op" id="3070229">(</span><span class="string" id="3070230">&#39;0&#39;</span><span class="op" id="3070233">+</span><span class="ident" id="3070234">dd</span><span class="op" id="3070236">%</span><span class="num" id="3070237">10</span><span class="op" id="3070239">)</span><span class="op" id="3070240">,</span>&nbsp;<span class="string" id="3070242">&#39;&nbsp;&#39;</span><span class="op" id="3070245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070249">mon</span><span class="op" id="3070252">[</span><span class="num" id="3070253">0</span><span class="op" id="3070254">]</span><span class="op" id="3070255">,</span>&nbsp;<span class="ident" id="3070257">mon</span><span class="op" id="3070260">[</span><span class="num" id="3070261">1</span><span class="op" id="3070262">]</span><span class="op" id="3070263">,</span>&nbsp;<span class="ident" id="3070265">mon</span><span class="op" id="3070268">[</span><span class="num" id="3070269">2</span><span class="op" id="3070270">]</span><span class="op" id="3070271">,</span>&nbsp;<span class="string" id="3070273">&#39;&nbsp;&#39;</span><span class="op" id="3070276">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3070280">byte</span><span class="op" id="3070284">(</span><span class="string" id="3070285">&#39;0&#39;</span><span class="op" id="3070288">+</span><span class="ident" id="3070289">yy</span><span class="op" id="3070291">/</span><span class="num" id="3070292">1000</span><span class="op" id="3070296">)</span><span class="op" id="3070297">,</span>&nbsp;<span class="builtintype" id="3070299">byte</span><span class="op" id="3070303">(</span><span class="string" id="3070304">&#39;0&#39;</span><span class="op" id="3070307">+</span><span class="op" id="3070308">(</span><span class="ident" id="3070309">yy</span><span class="op" id="3070311">/</span><span class="num" id="3070312">100</span><span class="op" id="3070315">)</span><span class="op" id="3070316">%</span><span class="num" id="3070317">10</span><span class="op" id="3070319">)</span><span class="op" id="3070320">,</span>&nbsp;<span class="builtintype" id="3070322">byte</span><span class="op" id="3070326">(</span><span class="string" id="3070327">&#39;0&#39;</span><span class="op" id="3070330">+</span><span class="op" id="3070331">(</span><span class="ident" id="3070332">yy</span><span class="op" id="3070334">/</span><span class="num" id="3070335">10</span><span class="op" id="3070337">)</span><span class="op" id="3070338">%</span><span class="num" id="3070339">10</span><span class="op" id="3070341">)</span><span class="op" id="3070342">,</span>&nbsp;<span class="builtintype" id="3070344">byte</span><span class="op" id="3070348">(</span><span class="string" id="3070349">&#39;0&#39;</span><span class="op" id="3070352">+</span><span class="ident" id="3070353">yy</span><span class="op" id="3070355">%</span><span class="num" id="3070356">10</span><span class="op" id="3070358">)</span><span class="op" id="3070359">,</span>&nbsp;<span class="string" id="3070361">&#39;&nbsp;&#39;</span><span class="op" id="3070364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3070368">byte</span><span class="op" id="3070372">(</span><span class="string" id="3070373">&#39;0&#39;</span><span class="op" id="3070376">+</span><span class="ident" id="3070377">hh</span><span class="op" id="3070379">/</span><span class="num" id="3070380">10</span><span class="op" id="3070382">)</span><span class="op" id="3070383">,</span>&nbsp;<span class="builtintype" id="3070385">byte</span><span class="op" id="3070389">(</span><span class="string" id="3070390">&#39;0&#39;</span><span class="op" id="3070393">+</span><span class="ident" id="3070394">hh</span><span class="op" id="3070396">%</span><span class="num" id="3070397">10</span><span class="op" id="3070399">)</span><span class="op" id="3070400">,</span>&nbsp;<span class="string" id="3070402">&#39;:&#39;</span><span class="op" id="3070405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3070409">byte</span><span class="op" id="3070413">(</span><span class="string" id="3070414">&#39;0&#39;</span><span class="op" id="3070417">+</span><span class="ident" id="3070418">mn</span><span class="op" id="3070420">/</span><span class="num" id="3070421">10</span><span class="op" id="3070423">)</span><span class="op" id="3070424">,</span>&nbsp;<span class="builtintype" id="3070426">byte</span><span class="op" id="3070430">(</span><span class="string" id="3070431">&#39;0&#39;</span><span class="op" id="3070434">+</span><span class="ident" id="3070435">mn</span><span class="op" id="3070437">%</span><span class="num" id="3070438">10</span><span class="op" id="3070440">)</span><span class="op" id="3070441">,</span>&nbsp;<span class="string" id="3070443">&#39;:&#39;</span><span class="op" id="3070446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3070450">byte</span><span class="op" id="3070454">(</span><span class="string" id="3070455">&#39;0&#39;</span><span class="op" id="3070458">+</span><span class="ident" id="3070459">ss</span><span class="op" id="3070461">/</span><span class="num" id="3070462">10</span><span class="op" id="3070464">)</span><span class="op" id="3070465">,</span>&nbsp;<span class="builtintype" id="3070467">byte</span><span class="op" id="3070471">(</span><span class="string" id="3070472">&#39;0&#39;</span><span class="op" id="3070475">+</span><span class="ident" id="3070476">ss</span><span class="op" id="3070478">%</span><span class="num" id="3070479">10</span><span class="op" id="3070481">)</span><span class="op" id="3070482">,</span>&nbsp;<span class="string" id="3070484">&#39;&nbsp;&#39;</span><span class="op" id="3070487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3070491">&#39;G&#39;</span><span class="op" id="3070494">,</span>&nbsp;<span class="string" id="3070496">&#39;M&#39;</span><span class="op" id="3070499">,</span>&nbsp;<span class="string" id="3070501">&#39;T&#39;</span><span class="op" id="3070504">)</span><br>
<span class="lineno">565</span><span class="op" id="3070506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3070509">var</span>&nbsp;<span class="ident" id="3070513">errTooLarge</span>&nbsp;<span class="op" id="3070525">=</span>&nbsp;<span class="ident" id="3070527">errors</span><span class="op" id="3070533">.</span><span class="ident" id="3070534">New</span><span class="op" id="3070537">(</span><span class="string" id="3070538">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3070563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3070566">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3070604">func</span>&nbsp;<span class="op" id="3070609">(</span><span class="ident" id="3070610">c</span>&nbsp;<span class="op" id="3070612">*</span><span class="ident" id="3070613">conn</span><span class="op" id="3070617">)</span>&nbsp;<span class="ident" id="3070619">readRequest</span><span class="op" id="3070630">(</span><span class="op" id="3070631">)</span>&nbsp;<span class="op" id="3070633">(</span><span class="ident" id="3070634">w</span>&nbsp;<span class="op" id="3070636">*</span><span class="ident" id="3070637">response</span><span class="op" id="3070645">,</span>&nbsp;<span class="ident" id="3070647">err</span>&nbsp;<span class="builtintype" id="3070651">error</span><span class="op" id="3070656">)</span>&nbsp;<span class="op" id="3070658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070661">if</span>&nbsp;<span class="ident" id="3070664">c</span><span class="op" id="3070665">.</span><span class="ident" id="3070666">hijacked</span><span class="op" id="3070674">(</span><span class="op" id="3070675">)</span>&nbsp;<span class="op" id="3070677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070681">return</span>&nbsp;<span class="ident" id="3070688">nil</span><span class="op" id="3070691">,</span>&nbsp;<span class="ident" id="3070693">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3070706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070710">if</span>&nbsp;<span class="ident" id="3070713">d</span>&nbsp;<span class="op" id="3070715">:=</span>&nbsp;<span class="ident" id="3070718">c</span><span class="op" id="3070719">.</span><span class="ident" id="3070720">server</span><span class="op" id="3070726">.</span><span class="ident" id="3070727">ReadTimeout</span><span class="op" id="3070738">;</span>&nbsp;<span class="ident" id="3070740">d</span>&nbsp;<span class="op" id="3070742">!=</span>&nbsp;<span class="num" id="3070745">0</span>&nbsp;<span class="op" id="3070747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070751">c</span><span class="op" id="3070752">.</span><span class="ident" id="3070753">rwc</span><span class="op" id="3070756">.</span><span class="ident" id="3070757">SetReadDeadline</span><span class="op" id="3070772">(</span><span class="ident" id="3070773">time</span><span class="op" id="3070777">.</span><span class="ident" id="3070778">Now</span><span class="op" id="3070781">(</span><span class="op" id="3070782">)</span><span class="op" id="3070783">.</span><span class="ident" id="3070784">Add</span><span class="op" id="3070787">(</span><span class="ident" id="3070788">d</span><span class="op" id="3070789">)</span><span class="op" id="3070790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3070793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070796">if</span>&nbsp;<span class="ident" id="3070799">d</span>&nbsp;<span class="op" id="3070801">:=</span>&nbsp;<span class="ident" id="3070804">c</span><span class="op" id="3070805">.</span><span class="ident" id="3070806">server</span><span class="op" id="3070812">.</span><span class="ident" id="3070813">WriteTimeout</span><span class="op" id="3070825">;</span>&nbsp;<span class="ident" id="3070827">d</span>&nbsp;<span class="op" id="3070829">!=</span>&nbsp;<span class="num" id="3070832">0</span>&nbsp;<span class="op" id="3070834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070838">defer</span>&nbsp;<span class="keyword" id="3070844">func</span><span class="op" id="3070848">(</span><span class="op" id="3070849">)</span>&nbsp;<span class="op" id="3070851">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070856">c</span><span class="op" id="3070857">.</span><span class="ident" id="3070858">rwc</span><span class="op" id="3070861">.</span><span class="ident" id="3070862">SetWriteDeadline</span><span class="op" id="3070878">(</span><span class="ident" id="3070879">time</span><span class="op" id="3070883">.</span><span class="ident" id="3070884">Now</span><span class="op" id="3070887">(</span><span class="op" id="3070888">)</span><span class="op" id="3070889">.</span><span class="ident" id="3070890">Add</span><span class="op" id="3070893">(</span><span class="ident" id="3070894">d</span><span class="op" id="3070895">)</span><span class="op" id="3070896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3070900">}</span><span class="op" id="3070901">(</span><span class="op" id="3070902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3070905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070909">c</span><span class="op" id="3070910">.</span><span class="ident" id="3070911">lr</span><span class="op" id="3070913">.</span><span class="ident" id="3070914">N</span>&nbsp;<span class="op" id="3070916">=</span>&nbsp;<span class="ident" id="3070918">c</span><span class="op" id="3070919">.</span><span class="ident" id="3070920">server</span><span class="op" id="3070926">.</span><span class="ident" id="3070927">initialLimitedReaderSize</span><span class="op" id="3070951">(</span><span class="op" id="3070952">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070955">var</span>&nbsp;<span class="ident" id="3070959">req</span>&nbsp;<span class="op" id="3070963">*</span><span class="ident" id="3070964">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070973">if</span>&nbsp;<span class="ident" id="3070976">req</span><span class="op" id="3070979">,</span>&nbsp;<span class="ident" id="3070981">err</span>&nbsp;<span class="op" id="3070985">=</span>&nbsp;<span class="ident" id="3070987">ReadRequest</span><span class="op" id="3070998">(</span><span class="ident" id="3070999">c</span><span class="op" id="3071000">.</span><span class="ident" id="3071001">buf</span><span class="op" id="3071004">.</span><span class="ident" id="3071005">Reader</span><span class="op" id="3071011">)</span><span class="op" id="3071012">;</span>&nbsp;<span class="ident" id="3071014">err</span>&nbsp;<span class="op" id="3071018">!=</span>&nbsp;<span class="ident" id="3071021">nil</span>&nbsp;<span class="op" id="3071025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071029">if</span>&nbsp;<span class="ident" id="3071032">c</span><span class="op" id="3071033">.</span><span class="ident" id="3071034">lr</span><span class="op" id="3071036">.</span><span class="ident" id="3071037">N</span>&nbsp;<span class="op" id="3071039">==</span>&nbsp;<span class="num" id="3071042">0</span>&nbsp;<span class="op" id="3071044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071049">return</span>&nbsp;<span class="ident" id="3071056">nil</span><span class="op" id="3071059">,</span>&nbsp;<span class="ident" id="3071061">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071075">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071079">return</span>&nbsp;<span class="ident" id="3071086">nil</span><span class="op" id="3071089">,</span>&nbsp;<span class="ident" id="3071091">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071099">c</span><span class="op" id="3071100">.</span><span class="ident" id="3071101">lr</span><span class="op" id="3071103">.</span><span class="ident" id="3071104">N</span>&nbsp;<span class="op" id="3071106">=</span>&nbsp;<span class="ident" id="3071108">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071118">req</span><span class="op" id="3071121">.</span><span class="ident" id="3071122">RemoteAddr</span>&nbsp;<span class="op" id="3071133">=</span>&nbsp;<span class="ident" id="3071135">c</span><span class="op" id="3071136">.</span><span class="ident" id="3071137">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071149">req</span><span class="op" id="3071152">.</span><span class="ident" id="3071153">TLS</span>&nbsp;<span class="op" id="3071157">=</span>&nbsp;<span class="ident" id="3071159">c</span><span class="op" id="3071160">.</span><span class="ident" id="3071161">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071172">w</span>&nbsp;<span class="op" id="3071174">=</span>&nbsp;<span class="op" id="3071176">&amp;</span><span class="ident" id="3071177">response</span><span class="op" id="3071185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071189">conn</span><span class="op" id="3071193">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071204">c</span><span class="op" id="3071205">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071209">req</span><span class="op" id="3071212">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071224">req</span><span class="op" id="3071227">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071231">handlerHeader</span><span class="op" id="3071244">:</span>&nbsp;<span class="builtinfunc" id="3071246">make</span><span class="op" id="3071250">(</span><span class="ident" id="3071251">Header</span><span class="op" id="3071257">)</span><span class="op" id="3071258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071262">contentLength</span><span class="op" id="3071275">:</span>&nbsp;<span class="op" id="3071277">-</span><span class="num" id="3071278">1</span><span class="op" id="3071279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071285">w</span><span class="op" id="3071286">.</span><span class="ident" id="3071287">cw</span><span class="op" id="3071289">.</span><span class="ident" id="3071290">res</span>&nbsp;<span class="op" id="3071294">=</span>&nbsp;<span class="ident" id="3071296">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071299">w</span><span class="op" id="3071300">.</span><span class="ident" id="3071301">w</span>&nbsp;<span class="op" id="3071303">=</span>&nbsp;<span class="ident" id="3071305">newBufioWriterSize</span><span class="op" id="3071323">(</span><span class="op" id="3071324">&amp;</span><span class="ident" id="3071325">w</span><span class="op" id="3071326">.</span><span class="ident" id="3071327">cw</span><span class="op" id="3071329">,</span>&nbsp;<span class="ident" id="3071331">bufferBeforeChunkingSize</span><span class="op" id="3071355">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071358">return</span>&nbsp;<span class="ident" id="3071365">w</span><span class="op" id="3071366">,</span>&nbsp;<span class="ident" id="3071368">nil</span><br>
<span class="lineno"></span><span class="op" id="3071372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3071375">func</span>&nbsp;<span class="op" id="3071380">(</span><span class="ident" id="3071381">w</span>&nbsp;<span class="op" id="3071383">*</span><span class="ident" id="3071384">response</span><span class="op" id="3071392">)</span>&nbsp;<span class="ident" id="3071394">Header</span><span class="op" id="3071400">(</span><span class="op" id="3071401">)</span>&nbsp;<span class="ident" id="3071403">Header</span>&nbsp;<span class="op" id="3071410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071413">if</span>&nbsp;<span class="ident" id="3071416">w</span><span class="op" id="3071417">.</span><span class="ident" id="3071418">cw</span><span class="op" id="3071420">.</span><span class="ident" id="3071421">header</span>&nbsp;<span class="op" id="3071428">==</span>&nbsp;<span class="ident" id="3071431">nil</span>&nbsp;<span class="op" id="3071435">&amp;&amp;</span>&nbsp;<span class="ident" id="3071438">w</span><span class="op" id="3071439">.</span><span class="ident" id="3071440">wroteHeader</span>&nbsp;<span class="op" id="3071452">&amp;&amp;</span>&nbsp;<span class="op" id="3071455">!</span><span class="ident" id="3071456">w</span><span class="op" id="3071457">.</span><span class="ident" id="3071458">cw</span><span class="op" id="3071460">.</span><span class="ident" id="3071461">wroteHeader</span>&nbsp;<span class="op" id="3071473">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071477">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071532">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071589">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071643">w</span><span class="op" id="3071644">.</span><span class="ident" id="3071645">cw</span><span class="op" id="3071647">.</span><span class="ident" id="3071648">header</span>&nbsp;<span class="op" id="3071655">=</span>&nbsp;<span class="ident" id="3071657">w</span><span class="op" id="3071658">.</span><span class="ident" id="3071659">handlerHeader</span><span class="op" id="3071672">.</span><span class="ident" id="3071673">clone</span><span class="op" id="3071678">(</span><span class="op" id="3071679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071682">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071685">w</span><span class="op" id="3071686">.</span><span class="ident" id="3071687">calledHeader</span>&nbsp;<span class="op" id="3071700">=</span>&nbsp;<span class="builtintype" id="3071702">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071708">return</span>&nbsp;<span class="ident" id="3071715">w</span><span class="op" id="3071716">.</span><span class="ident" id="3071717">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3071731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3071734">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3071805">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3071872">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3071942">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3072010">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3072030">//</span><br>
<span class="lineno">625</span><span class="comment" id="3072033">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3072101">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3072171">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3072190">const</span>&nbsp;<span class="ident" id="3072196">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3072220">=</span>&nbsp;<span class="num" id="3072222">256</span>&nbsp;<span class="op" id="3072226">&lt;&lt;</span>&nbsp;<span class="num" id="3072229">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3072233">func</span>&nbsp;<span class="op" id="3072238">(</span><span class="ident" id="3072239">w</span>&nbsp;<span class="op" id="3072241">*</span><span class="ident" id="3072242">response</span><span class="op" id="3072250">)</span>&nbsp;<span class="ident" id="3072252">WriteHeader</span><span class="op" id="3072263">(</span><span class="ident" id="3072264">code</span>&nbsp;<span class="builtintype" id="3072269">int</span><span class="op" id="3072272">)</span>&nbsp;<span class="op" id="3072274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072277">if</span>&nbsp;<span class="ident" id="3072280">w</span><span class="op" id="3072281">.</span><span class="ident" id="3072282">conn</span><span class="op" id="3072286">.</span><span class="ident" id="3072287">hijacked</span><span class="op" id="3072295">(</span><span class="op" id="3072296">)</span>&nbsp;<span class="op" id="3072298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072302">w</span><span class="op" id="3072303">.</span><span class="ident" id="3072304">conn</span><span class="op" id="3072308">.</span><span class="ident" id="3072309">server</span><span class="op" id="3072315">.</span><span class="ident" id="3072316">logf</span><span class="op" id="3072320">(</span><span class="string" id="3072321">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3072372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072376">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3072384">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072387">if</span>&nbsp;<span class="ident" id="3072390">w</span><span class="op" id="3072391">.</span><span class="ident" id="3072392">wroteHeader</span>&nbsp;<span class="op" id="3072404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072408">w</span><span class="op" id="3072409">.</span><span class="ident" id="3072410">conn</span><span class="op" id="3072414">.</span><span class="ident" id="3072415">server</span><span class="op" id="3072421">.</span><span class="ident" id="3072422">logf</span><span class="op" id="3072426">(</span><span class="string" id="3072427">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3072470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072474">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3072482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072485">w</span><span class="op" id="3072486">.</span><span class="ident" id="3072487">wroteHeader</span>&nbsp;<span class="op" id="3072499">=</span>&nbsp;<span class="builtintype" id="3072501">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072507">w</span><span class="op" id="3072508">.</span><span class="ident" id="3072509">status</span>&nbsp;<span class="op" id="3072516">=</span>&nbsp;<span class="ident" id="3072518">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072525">if</span>&nbsp;<span class="ident" id="3072528">w</span><span class="op" id="3072529">.</span><span class="ident" id="3072530">calledHeader</span>&nbsp;<span class="op" id="3072543">&amp;&amp;</span>&nbsp;<span class="ident" id="3072546">w</span><span class="op" id="3072547">.</span><span class="ident" id="3072548">cw</span><span class="op" id="3072550">.</span><span class="ident" id="3072551">header</span>&nbsp;<span class="op" id="3072558">==</span>&nbsp;<span class="ident" id="3072561">nil</span>&nbsp;<span class="op" id="3072565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072569">w</span><span class="op" id="3072570">.</span><span class="ident" id="3072571">cw</span><span class="op" id="3072573">.</span><span class="ident" id="3072574">header</span>&nbsp;<span class="op" id="3072581">=</span>&nbsp;<span class="ident" id="3072583">w</span><span class="op" id="3072584">.</span><span class="ident" id="3072585">handlerHeader</span><span class="op" id="3072598">.</span><span class="ident" id="3072599">clone</span><span class="op" id="3072604">(</span><span class="op" id="3072605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3072608">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072612">if</span>&nbsp;<span class="ident" id="3072615">cl</span>&nbsp;<span class="op" id="3072618">:=</span>&nbsp;<span class="ident" id="3072621">w</span><span class="op" id="3072622">.</span><span class="ident" id="3072623">handlerHeader</span><span class="op" id="3072636">.</span><span class="ident" id="3072637">get</span><span class="op" id="3072640">(</span><span class="string" id="3072641">&#34;Content-Length&#34;</span><span class="op" id="3072657">)</span><span class="op" id="3072658">;</span>&nbsp;<span class="ident" id="3072660">cl</span>&nbsp;<span class="op" id="3072663">!=</span>&nbsp;<span class="string" id="3072666">&#34;&#34;</span>&nbsp;<span class="op" id="3072669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072673">v</span><span class="op" id="3072674">,</span>&nbsp;<span class="ident" id="3072676">err</span>&nbsp;<span class="op" id="3072680">:=</span>&nbsp;<span class="ident" id="3072683">strconv</span><span class="op" id="3072690">.</span><span class="ident" id="3072691">ParseInt</span><span class="op" id="3072699">(</span><span class="ident" id="3072700">cl</span><span class="op" id="3072702">,</span>&nbsp;<span class="num" id="3072704">10</span><span class="op" id="3072706">,</span>&nbsp;<span class="num" id="3072708">64</span><span class="op" id="3072710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072714">if</span>&nbsp;<span class="ident" id="3072717">err</span>&nbsp;<span class="op" id="3072721">==</span>&nbsp;<span class="ident" id="3072724">nil</span>&nbsp;<span class="op" id="3072728">&amp;&amp;</span>&nbsp;<span class="ident" id="3072731">v</span>&nbsp;<span class="op" id="3072733">&gt;=</span>&nbsp;<span class="num" id="3072736">0</span>&nbsp;<span class="op" id="3072738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072743">w</span><span class="op" id="3072744">.</span><span class="ident" id="3072745">contentLength</span>&nbsp;<span class="op" id="3072759">=</span>&nbsp;<span class="ident" id="3072761">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3072765">}</span>&nbsp;<span class="keyword" id="3072767">else</span>&nbsp;<span class="op" id="3072772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072777">w</span><span class="op" id="3072778">.</span><span class="ident" id="3072779">conn</span><span class="op" id="3072783">.</span><span class="ident" id="3072784">server</span><span class="op" id="3072790">.</span><span class="ident" id="3072791">logf</span><span class="op" id="3072795">(</span><span class="string" id="3072796">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3072832">,</span>&nbsp;<span class="ident" id="3072834">cl</span><span class="op" id="3072836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072841">w</span><span class="op" id="3072842">.</span><span class="ident" id="3072843">handlerHeader</span><span class="op" id="3072856">.</span><span class="ident" id="3072857">Del</span><span class="op" id="3072860">(</span><span class="string" id="3072861">&#34;Content-Length&#34;</span><span class="op" id="3072877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3072881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3072884">}</span><br>
<span class="lineno">655</span><span class="op" id="3072886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3072889">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3072970">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3073049">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3073106">type</span>&nbsp;<span class="ident" id="3073111">extraHeader</span>&nbsp;<span class="keyword" id="3073123">struct</span>&nbsp;<span class="op" id="3073130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073133">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3073150">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073158">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3073175">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073183">transferEncoding</span>&nbsp;<span class="builtintype" id="3073200">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073208">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073225">[</span><span class="op" id="3073226">]</span><span class="builtintype" id="3073227">byte</span>&nbsp;<span class="comment" id="3073232">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073255">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073272">[</span><span class="op" id="3073273">]</span><span class="builtintype" id="3073274">byte</span>&nbsp;<span class="comment" id="3073279">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3073301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3073304">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3073352">var</span>&nbsp;<span class="ident" id="3073356">extraHeaderKeys</span>&nbsp;<span class="op" id="3073372">=</span>&nbsp;<span class="op" id="3073374">[</span><span class="op" id="3073375">]</span><span class="op" id="3073376">[</span><span class="op" id="3073377">]</span><span class="builtintype" id="3073378">byte</span><span class="op" id="3073382">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073385">[</span><span class="op" id="3073386">]</span><span class="builtintype" id="3073387">byte</span><span class="op" id="3073391">(</span><span class="string" id="3073392">&#34;Content-Type&#34;</span><span class="op" id="3073406">)</span><span class="op" id="3073407">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073410">[</span><span class="op" id="3073411">]</span><span class="builtintype" id="3073412">byte</span><span class="op" id="3073416">(</span><span class="string" id="3073417">&#34;Connection&#34;</span><span class="op" id="3073429">)</span><span class="op" id="3073430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073433">[</span><span class="op" id="3073434">]</span><span class="builtintype" id="3073435">byte</span><span class="op" id="3073439">(</span><span class="string" id="3073440">&#34;Transfer-Encoding&#34;</span><span class="op" id="3073459">)</span><span class="op" id="3073460">,</span><br>
<span class="lineno"></span><span class="op" id="3073462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3073465">var</span>&nbsp;<span class="op" id="3073469">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073472">headerContentLength</span>&nbsp;<span class="op" id="3073492">=</span>&nbsp;<span class="op" id="3073494">[</span><span class="op" id="3073495">]</span><span class="builtintype" id="3073496">byte</span><span class="op" id="3073500">(</span><span class="string" id="3073501">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3073519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073522">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073542">=</span>&nbsp;<span class="op" id="3073544">[</span><span class="op" id="3073545">]</span><span class="builtintype" id="3073546">byte</span><span class="op" id="3073550">(</span><span class="string" id="3073551">&#34;Date:&nbsp;&#34;</span><span class="op" id="3073559">)</span><br>
<span class="lineno"></span><span class="op" id="3073561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3073564">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3073613">//</span><br>
<span class="lineno"></span><span class="comment" id="3073616">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3073685">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3073755">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3073814">func</span>&nbsp;<span class="op" id="3073819">(</span><span class="ident" id="3073820">h</span>&nbsp;<span class="ident" id="3073822">extraHeader</span><span class="op" id="3073833">)</span>&nbsp;<span class="ident" id="3073835">Write</span><span class="op" id="3073840">(</span><span class="ident" id="3073841">w</span>&nbsp;<span class="op" id="3073843">*</span><span class="ident" id="3073844">bufio</span><span class="op" id="3073849">.</span><span class="ident" id="3073850">Writer</span><span class="op" id="3073856">)</span>&nbsp;<span class="op" id="3073858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073861">if</span>&nbsp;<span class="ident" id="3073864">h</span><span class="op" id="3073865">.</span><span class="ident" id="3073866">date</span>&nbsp;<span class="op" id="3073871">!=</span>&nbsp;<span class="ident" id="3073874">nil</span>&nbsp;<span class="op" id="3073878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073882">w</span><span class="op" id="3073883">.</span><span class="ident" id="3073884">Write</span><span class="op" id="3073889">(</span><span class="ident" id="3073890">headerDate</span><span class="op" id="3073900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073904">w</span><span class="op" id="3073905">.</span><span class="ident" id="3073906">Write</span><span class="op" id="3073911">(</span><span class="ident" id="3073912">h</span><span class="op" id="3073913">.</span><span class="ident" id="3073914">date</span><span class="op" id="3073918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073922">w</span><span class="op" id="3073923">.</span><span class="ident" id="3073924">Write</span><span class="op" id="3073929">(</span><span class="ident" id="3073930">crlf</span><span class="op" id="3073934">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073940">if</span>&nbsp;<span class="ident" id="3073943">h</span><span class="op" id="3073944">.</span><span class="ident" id="3073945">contentLength</span>&nbsp;<span class="op" id="3073959">!=</span>&nbsp;<span class="ident" id="3073962">nil</span>&nbsp;<span class="op" id="3073966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073970">w</span><span class="op" id="3073971">.</span><span class="ident" id="3073972">Write</span><span class="op" id="3073977">(</span><span class="ident" id="3073978">headerContentLength</span><span class="op" id="3073997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074001">w</span><span class="op" id="3074002">.</span><span class="ident" id="3074003">Write</span><span class="op" id="3074008">(</span><span class="ident" id="3074009">h</span><span class="op" id="3074010">.</span><span class="ident" id="3074011">contentLength</span><span class="op" id="3074024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074028">w</span><span class="op" id="3074029">.</span><span class="ident" id="3074030">Write</span><span class="op" id="3074035">(</span><span class="ident" id="3074036">crlf</span><span class="op" id="3074040">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074046">for</span>&nbsp;<span class="ident" id="3074050">i</span><span class="op" id="3074051">,</span>&nbsp;<span class="ident" id="3074053">v</span>&nbsp;<span class="op" id="3074055">:=</span>&nbsp;<span class="keyword" id="3074058">range</span>&nbsp;<span class="op" id="3074064">[</span><span class="op" id="3074065">]</span><span class="builtintype" id="3074066">string</span><span class="op" id="3074072">{</span><span class="ident" id="3074073">h</span><span class="op" id="3074074">.</span><span class="ident" id="3074075">contentType</span><span class="op" id="3074086">,</span>&nbsp;<span class="ident" id="3074088">h</span><span class="op" id="3074089">.</span><span class="ident" id="3074090">connection</span><span class="op" id="3074100">,</span>&nbsp;<span class="ident" id="3074102">h</span><span class="op" id="3074103">.</span><span class="ident" id="3074104">transferEncoding</span><span class="op" id="3074120">}</span>&nbsp;<span class="op" id="3074122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074126">if</span>&nbsp;<span class="ident" id="3074129">v</span>&nbsp;<span class="op" id="3074131">!=</span>&nbsp;<span class="string" id="3074134">&#34;&#34;</span>&nbsp;<span class="op" id="3074137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074142">w</span><span class="op" id="3074143">.</span><span class="ident" id="3074144">Write</span><span class="op" id="3074149">(</span><span class="ident" id="3074150">extraHeaderKeys</span><span class="op" id="3074165">[</span><span class="ident" id="3074166">i</span><span class="op" id="3074167">]</span><span class="op" id="3074168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074173">w</span><span class="op" id="3074174">.</span><span class="ident" id="3074175">Write</span><span class="op" id="3074180">(</span><span class="ident" id="3074181">colonSpace</span><span class="op" id="3074191">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074196">w</span><span class="op" id="3074197">.</span><span class="ident" id="3074198">WriteString</span><span class="op" id="3074209">(</span><span class="ident" id="3074210">v</span><span class="op" id="3074211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074216">w</span><span class="op" id="3074217">.</span><span class="ident" id="3074218">Write</span><span class="op" id="3074223">(</span><span class="ident" id="3074224">crlf</span><span class="op" id="3074228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074235">}</span><br>
<span class="lineno"></span><span class="op" id="3074237">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3074240">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3074309">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3074332">//</span><br>
<span class="lineno"></span><span class="comment" id="3074335">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3074406">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3074476">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3074545">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3074611">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3074623">func</span>&nbsp;<span class="op" id="3074628">(</span><span class="ident" id="3074629">cw</span>&nbsp;<span class="op" id="3074632">*</span><span class="ident" id="3074633">chunkWriter</span><span class="op" id="3074644">)</span>&nbsp;<span class="ident" id="3074646">writeHeader</span><span class="op" id="3074657">(</span><span class="ident" id="3074658">p</span>&nbsp;<span class="op" id="3074660">[</span><span class="op" id="3074661">]</span><span class="builtintype" id="3074662">byte</span><span class="op" id="3074666">)</span>&nbsp;<span class="op" id="3074668">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074671">if</span>&nbsp;<span class="ident" id="3074674">cw</span><span class="op" id="3074676">.</span><span class="ident" id="3074677">wroteHeader</span>&nbsp;<span class="op" id="3074689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074693">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074704">cw</span><span class="op" id="3074706">.</span><span class="ident" id="3074707">wroteHeader</span>&nbsp;<span class="op" id="3074719">=</span>&nbsp;<span class="builtintype" id="3074721">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074728">w</span>&nbsp;<span class="op" id="3074730">:=</span>&nbsp;<span class="ident" id="3074733">cw</span><span class="op" id="3074735">.</span><span class="ident" id="3074736">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074741">keepAlivesEnabled</span>&nbsp;<span class="op" id="3074759">:=</span>&nbsp;<span class="ident" id="3074762">w</span><span class="op" id="3074763">.</span><span class="ident" id="3074764">conn</span><span class="op" id="3074768">.</span><span class="ident" id="3074769">server</span><span class="op" id="3074775">.</span><span class="ident" id="3074776">doKeepAlives</span><span class="op" id="3074788">(</span><span class="op" id="3074789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074792">isHEAD</span>&nbsp;<span class="op" id="3074799">:=</span>&nbsp;<span class="ident" id="3074802">w</span><span class="op" id="3074803">.</span><span class="ident" id="3074804">req</span><span class="op" id="3074807">.</span><span class="ident" id="3074808">Method</span>&nbsp;<span class="op" id="3074815">==</span>&nbsp;<span class="string" id="3074818">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3074827">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3074891">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3074953">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075009">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075071">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075099">header</span>&nbsp;<span class="op" id="3075106">:=</span>&nbsp;<span class="ident" id="3075109">cw</span><span class="op" id="3075111">.</span><span class="ident" id="3075112">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075120">owned</span>&nbsp;<span class="op" id="3075126">:=</span>&nbsp;<span class="ident" id="3075129">header</span>&nbsp;<span class="op" id="3075136">!=</span>&nbsp;<span class="ident" id="3075139">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075144">if</span>&nbsp;<span class="op" id="3075147">!</span><span class="ident" id="3075148">owned</span>&nbsp;<span class="op" id="3075154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075158">header</span>&nbsp;<span class="op" id="3075165">=</span>&nbsp;<span class="ident" id="3075167">w</span><span class="op" id="3075168">.</span><span class="ident" id="3075169">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075187">var</span>&nbsp;<span class="ident" id="3075191">excludeHeader</span>&nbsp;<span class="keyword" id="3075205">map</span><span class="op" id="3075208">[</span><span class="builtintype" id="3075209">string</span><span class="op" id="3075215">]</span><span class="builtintype" id="3075216">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075222">delHeader</span>&nbsp;<span class="op" id="3075232">:=</span>&nbsp;<span class="keyword" id="3075235">func</span><span class="op" id="3075239">(</span><span class="ident" id="3075240">key</span>&nbsp;<span class="builtintype" id="3075244">string</span><span class="op" id="3075250">)</span>&nbsp;<span class="op" id="3075252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075256">if</span>&nbsp;<span class="ident" id="3075259">owned</span>&nbsp;<span class="op" id="3075265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075270">header</span><span class="op" id="3075276">.</span><span class="ident" id="3075277">Del</span><span class="op" id="3075280">(</span><span class="ident" id="3075281">key</span><span class="op" id="3075284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075289">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075298">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075302">if</span>&nbsp;<span class="ident" id="3075305">_</span><span class="op" id="3075306">,</span>&nbsp;<span class="ident" id="3075308">ok</span>&nbsp;<span class="op" id="3075311">:=</span>&nbsp;<span class="ident" id="3075314">header</span><span class="op" id="3075320">[</span><span class="ident" id="3075321">key</span><span class="op" id="3075324">]</span><span class="op" id="3075325">;</span>&nbsp;<span class="op" id="3075327">!</span><span class="ident" id="3075328">ok</span>&nbsp;<span class="op" id="3075331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075336">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075349">if</span>&nbsp;<span class="ident" id="3075352">excludeHeader</span>&nbsp;<span class="op" id="3075366">==</span>&nbsp;<span class="ident" id="3075369">nil</span>&nbsp;<span class="op" id="3075373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075378">excludeHeader</span>&nbsp;<span class="op" id="3075392">=</span>&nbsp;<span class="builtinfunc" id="3075394">make</span><span class="op" id="3075398">(</span><span class="keyword" id="3075399">map</span><span class="op" id="3075402">[</span><span class="builtintype" id="3075403">string</span><span class="op" id="3075409">]</span><span class="builtintype" id="3075410">bool</span><span class="op" id="3075414">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075422">excludeHeader</span><span class="op" id="3075435">[</span><span class="ident" id="3075436">key</span><span class="op" id="3075439">]</span>&nbsp;<span class="op" id="3075441">=</span>&nbsp;<span class="builtintype" id="3075443">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075452">var</span>&nbsp;<span class="ident" id="3075456">setHeader</span>&nbsp;<span class="ident" id="3075466">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075480">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075539">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075603">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075664">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075700">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075771">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075835">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075897">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075961">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3076025">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3076085">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3076147">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076181">if</span>&nbsp;<span class="ident" id="3076184">w</span><span class="op" id="3076185">.</span><span class="ident" id="3076186">handlerDone</span>&nbsp;<span class="op" id="3076198">&amp;&amp;</span>&nbsp;<span class="ident" id="3076201">bodyAllowedForStatus</span><span class="op" id="3076221">(</span><span class="ident" id="3076222">w</span><span class="op" id="3076223">.</span><span class="ident" id="3076224">status</span><span class="op" id="3076230">)</span>&nbsp;<span class="op" id="3076232">&amp;&amp;</span>&nbsp;<span class="ident" id="3076235">header</span><span class="op" id="3076241">.</span><span class="ident" id="3076242">get</span><span class="op" id="3076245">(</span><span class="string" id="3076246">&#34;Content-Length&#34;</span><span class="op" id="3076262">)</span>&nbsp;<span class="op" id="3076264">==</span>&nbsp;<span class="string" id="3076267">&#34;&#34;</span>&nbsp;<span class="op" id="3076270">&amp;&amp;</span>&nbsp;<span class="op" id="3076273">(</span><span class="op" id="3076274">!</span><span class="ident" id="3076275">isHEAD</span>&nbsp;<span class="op" id="3076282">||</span>&nbsp;<span class="builtinfunc" id="3076285">len</span><span class="op" id="3076288">(</span><span class="ident" id="3076289">p</span><span class="op" id="3076290">)</span>&nbsp;<span class="op" id="3076292">&gt;</span>&nbsp;<span class="num" id="3076294">0</span><span class="op" id="3076295">)</span>&nbsp;<span class="op" id="3076297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076301">w</span><span class="op" id="3076302">.</span><span class="ident" id="3076303">contentLength</span>&nbsp;<span class="op" id="3076317">=</span>&nbsp;<span class="ident" id="3076319">int64</span><span class="op" id="3076324">(</span><span class="builtinfunc" id="3076325">len</span><span class="op" id="3076328">(</span><span class="ident" id="3076329">p</span><span class="op" id="3076330">)</span><span class="op" id="3076331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076335">setHeader</span><span class="op" id="3076344">.</span><span class="ident" id="3076345">contentLength</span>&nbsp;<span class="op" id="3076359">=</span>&nbsp;<span class="ident" id="3076361">strconv</span><span class="op" id="3076368">.</span><span class="ident" id="3076369">AppendInt</span><span class="op" id="3076378">(</span><span class="ident" id="3076379">cw</span><span class="op" id="3076381">.</span><span class="ident" id="3076382">res</span><span class="op" id="3076385">.</span><span class="ident" id="3076386">clenBuf</span><span class="op" id="3076393">[</span><span class="op" id="3076394">:</span><span class="num" id="3076395">0</span><span class="op" id="3076396">]</span><span class="op" id="3076397">,</span>&nbsp;<span class="ident" id="3076399">int64</span><span class="op" id="3076404">(</span><span class="builtinfunc" id="3076405">len</span><span class="op" id="3076408">(</span><span class="ident" id="3076409">p</span><span class="op" id="3076410">)</span><span class="op" id="3076411">)</span><span class="op" id="3076412">,</span>&nbsp;<span class="num" id="3076414">10</span><span class="op" id="3076416">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3076423">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3076489">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076557">if</span>&nbsp;<span class="ident" id="3076560">w</span><span class="op" id="3076561">.</span><span class="ident" id="3076562">req</span><span class="op" id="3076565">.</span><span class="ident" id="3076566">wantsHttp10KeepAlive</span><span class="op" id="3076586">(</span><span class="op" id="3076587">)</span>&nbsp;<span class="op" id="3076589">&amp;&amp;</span>&nbsp;<span class="ident" id="3076592">keepAlivesEnabled</span>&nbsp;<span class="op" id="3076610">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076614">sentLength</span>&nbsp;<span class="op" id="3076625">:=</span>&nbsp;<span class="ident" id="3076628">header</span><span class="op" id="3076634">.</span><span class="ident" id="3076635">get</span><span class="op" id="3076638">(</span><span class="string" id="3076639">&#34;Content-Length&#34;</span><span class="op" id="3076655">)</span>&nbsp;<span class="op" id="3076657">!=</span>&nbsp;<span class="string" id="3076660">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076665">if</span>&nbsp;<span class="ident" id="3076668">sentLength</span>&nbsp;<span class="op" id="3076679">&amp;&amp;</span>&nbsp;<span class="ident" id="3076682">header</span><span class="op" id="3076688">.</span><span class="ident" id="3076689">get</span><span class="op" id="3076692">(</span><span class="string" id="3076693">&#34;Connection&#34;</span><span class="op" id="3076705">)</span>&nbsp;<span class="op" id="3076707">==</span>&nbsp;<span class="string" id="3076710">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3076723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076728">w</span><span class="op" id="3076729">.</span><span class="ident" id="3076730">closeAfterReply</span>&nbsp;<span class="op" id="3076746">=</span>&nbsp;<span class="builtintype" id="3076748">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076759">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3076763">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076823">hasCL</span>&nbsp;<span class="op" id="3076829">:=</span>&nbsp;<span class="ident" id="3076832">w</span><span class="op" id="3076833">.</span><span class="ident" id="3076834">contentLength</span>&nbsp;<span class="op" id="3076848">!=</span>&nbsp;<span class="op" id="3076851">-</span><span class="num" id="3076852">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076856">if</span>&nbsp;<span class="ident" id="3076859">w</span><span class="op" id="3076860">.</span><span class="ident" id="3076861">req</span><span class="op" id="3076864">.</span><span class="ident" id="3076865">wantsHttp10KeepAlive</span><span class="op" id="3076885">(</span><span class="op" id="3076886">)</span>&nbsp;<span class="op" id="3076888">&amp;&amp;</span>&nbsp;<span class="op" id="3076891">(</span><span class="ident" id="3076892">isHEAD</span>&nbsp;<span class="op" id="3076899">||</span>&nbsp;<span class="ident" id="3076902">hasCL</span><span class="op" id="3076907">)</span>&nbsp;<span class="op" id="3076909">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076913">_</span><span class="op" id="3076914">,</span>&nbsp;<span class="ident" id="3076916">connectionHeaderSet</span>&nbsp;<span class="op" id="3076936">:=</span>&nbsp;<span class="ident" id="3076939">header</span><span class="op" id="3076945">[</span><span class="string" id="3076946">&#34;Connection&#34;</span><span class="op" id="3076958">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076962">if</span>&nbsp;<span class="op" id="3076965">!</span><span class="ident" id="3076966">connectionHeaderSet</span>&nbsp;<span class="op" id="3076986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076991">setHeader</span><span class="op" id="3077000">.</span><span class="ident" id="3077001">connection</span>&nbsp;<span class="op" id="3077012">=</span>&nbsp;<span class="string" id="3077014">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077032">}</span>&nbsp;<span class="keyword" id="3077034">else</span>&nbsp;<span class="keyword" id="3077039">if</span>&nbsp;<span class="op" id="3077042">!</span><span class="ident" id="3077043">w</span><span class="op" id="3077044">.</span><span class="ident" id="3077045">req</span><span class="op" id="3077048">.</span><span class="ident" id="3077049">ProtoAtLeast</span><span class="op" id="3077061">(</span><span class="num" id="3077062">1</span><span class="op" id="3077063">,</span>&nbsp;<span class="num" id="3077065">1</span><span class="op" id="3077066">)</span>&nbsp;<span class="op" id="3077068">||</span>&nbsp;<span class="ident" id="3077071">w</span><span class="op" id="3077072">.</span><span class="ident" id="3077073">req</span><span class="op" id="3077076">.</span><span class="ident" id="3077077">wantsClose</span><span class="op" id="3077087">(</span><span class="op" id="3077088">)</span>&nbsp;<span class="op" id="3077090">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077094">w</span><span class="op" id="3077095">.</span><span class="ident" id="3077096">closeAfterReply</span>&nbsp;<span class="op" id="3077112">=</span>&nbsp;<span class="builtintype" id="3077114">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077124">if</span>&nbsp;<span class="ident" id="3077127">header</span><span class="op" id="3077133">.</span><span class="ident" id="3077134">get</span><span class="op" id="3077137">(</span><span class="string" id="3077138">&#34;Connection&#34;</span><span class="op" id="3077150">)</span>&nbsp;<span class="op" id="3077152">==</span>&nbsp;<span class="string" id="3077155">&#34;close&#34;</span>&nbsp;<span class="op" id="3077163">||</span>&nbsp;<span class="op" id="3077166">!</span><span class="ident" id="3077167">keepAlivesEnabled</span>&nbsp;<span class="op" id="3077185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077189">w</span><span class="op" id="3077190">.</span><span class="ident" id="3077191">closeAfterReply</span>&nbsp;<span class="op" id="3077207">=</span>&nbsp;<span class="builtintype" id="3077209">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3077219">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3077279">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3077340">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3077401">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077452">if</span>&nbsp;<span class="ident" id="3077455">w</span><span class="op" id="3077456">.</span><span class="ident" id="3077457">req</span><span class="op" id="3077460">.</span><span class="ident" id="3077461">ContentLength</span>&nbsp;<span class="op" id="3077475">!=</span>&nbsp;<span class="num" id="3077478">0</span>&nbsp;<span class="op" id="3077480">&amp;&amp;</span>&nbsp;<span class="op" id="3077483">!</span><span class="ident" id="3077484">w</span><span class="op" id="3077485">.</span><span class="ident" id="3077486">closeAfterReply</span>&nbsp;<span class="op" id="3077502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077506">ecr</span><span class="op" id="3077509">,</span>&nbsp;<span class="ident" id="3077511">isExpecter</span>&nbsp;<span class="op" id="3077522">:=</span>&nbsp;<span class="ident" id="3077525">w</span><span class="op" id="3077526">.</span><span class="ident" id="3077527">req</span><span class="op" id="3077530">.</span><span class="ident" id="3077531">Body</span><span class="op" id="3077535">.</span><span class="op" id="3077536">(</span><span class="op" id="3077537">*</span><span class="ident" id="3077538">expectContinueReader</span><span class="op" id="3077558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077562">if</span>&nbsp;<span class="op" id="3077565">!</span><span class="ident" id="3077566">isExpecter</span>&nbsp;<span class="op" id="3077577">||</span>&nbsp;<span class="ident" id="3077580">ecr</span><span class="op" id="3077583">.</span><span class="ident" id="3077584">resp</span><span class="op" id="3077588">.</span><span class="ident" id="3077589">wroteContinue</span>&nbsp;<span class="op" id="3077603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077608">n</span><span class="op" id="3077609">,</span>&nbsp;<span class="ident" id="3077611">_</span>&nbsp;<span class="op" id="3077613">:=</span>&nbsp;<span class="ident" id="3077616">io</span><span class="op" id="3077618">.</span><span class="ident" id="3077619">CopyN</span><span class="op" id="3077624">(</span><span class="ident" id="3077625">ioutil</span><span class="op" id="3077631">.</span><span class="ident" id="3077632">Discard</span><span class="op" id="3077639">,</span>&nbsp;<span class="ident" id="3077641">w</span><span class="op" id="3077642">.</span><span class="ident" id="3077643">req</span><span class="op" id="3077646">.</span><span class="ident" id="3077647">Body</span><span class="op" id="3077651">,</span>&nbsp;<span class="ident" id="3077653">maxPostHandlerReadBytes</span><span class="op" id="3077676">+</span><span class="num" id="3077677">1</span><span class="op" id="3077678">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077683">if</span>&nbsp;<span class="ident" id="3077686">n</span>&nbsp;<span class="op" id="3077688">&gt;=</span>&nbsp;<span class="ident" id="3077691">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3077715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077721">w</span><span class="op" id="3077722">.</span><span class="ident" id="3077723">requestTooLarge</span><span class="op" id="3077738">(</span><span class="op" id="3077739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077745">delHeader</span><span class="op" id="3077754">(</span><span class="string" id="3077755">&#34;Connection&#34;</span><span class="op" id="3077767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077773">setHeader</span><span class="op" id="3077782">.</span><span class="ident" id="3077783">connection</span>&nbsp;<span class="op" id="3077794">=</span>&nbsp;<span class="string" id="3077796">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077807">}</span>&nbsp;<span class="keyword" id="3077809">else</span>&nbsp;<span class="op" id="3077814">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077820">w</span><span class="op" id="3077821">.</span><span class="ident" id="3077822">req</span><span class="op" id="3077825">.</span><span class="ident" id="3077826">Body</span><span class="op" id="3077830">.</span><span class="ident" id="3077831">Close</span><span class="op" id="3077836">(</span><span class="op" id="3077837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077853">code</span>&nbsp;<span class="op" id="3077858">:=</span>&nbsp;<span class="ident" id="3077861">w</span><span class="op" id="3077862">.</span><span class="ident" id="3077863">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077871">if</span>&nbsp;<span class="ident" id="3077874">bodyAllowedForStatus</span><span class="op" id="3077894">(</span><span class="ident" id="3077895">code</span><span class="op" id="3077899">)</span>&nbsp;<span class="op" id="3077901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3077905">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077964">_</span><span class="op" id="3077965">,</span>&nbsp;<span class="ident" id="3077967">haveType</span>&nbsp;<span class="op" id="3077976">:=</span>&nbsp;<span class="ident" id="3077979">header</span><span class="op" id="3077985">[</span><span class="string" id="3077986">&#34;Content-Type&#34;</span><span class="op" id="3078000">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078004">if</span>&nbsp;<span class="op" id="3078007">!</span><span class="ident" id="3078008">haveType</span>&nbsp;<span class="op" id="3078017">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078022">setHeader</span><span class="op" id="3078031">.</span><span class="ident" id="3078032">contentType</span>&nbsp;<span class="op" id="3078044">=</span>&nbsp;<span class="ident" id="3078046">DetectContentType</span><span class="op" id="3078063">(</span><span class="ident" id="3078064">p</span><span class="op" id="3078065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078072">}</span>&nbsp;<span class="keyword" id="3078074">else</span>&nbsp;<span class="op" id="3078079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078083">for</span>&nbsp;<span class="ident" id="3078087">_</span><span class="op" id="3078088">,</span>&nbsp;<span class="ident" id="3078090">k</span>&nbsp;<span class="op" id="3078092">:=</span>&nbsp;<span class="keyword" id="3078095">range</span>&nbsp;<span class="ident" id="3078101">suppressedHeaders</span><span class="op" id="3078118">(</span><span class="ident" id="3078119">code</span><span class="op" id="3078123">)</span>&nbsp;<span class="op" id="3078125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078130">delHeader</span><span class="op" id="3078139">(</span><span class="ident" id="3078140">k</span><span class="op" id="3078141">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078152">if</span>&nbsp;<span class="ident" id="3078155">_</span><span class="op" id="3078156">,</span>&nbsp;<span class="ident" id="3078158">ok</span>&nbsp;<span class="op" id="3078161">:=</span>&nbsp;<span class="ident" id="3078164">header</span><span class="op" id="3078170">[</span><span class="string" id="3078171">&#34;Date&#34;</span><span class="op" id="3078177">]</span><span class="op" id="3078178">;</span>&nbsp;<span class="op" id="3078180">!</span><span class="ident" id="3078181">ok</span>&nbsp;<span class="op" id="3078184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078188">setHeader</span><span class="op" id="3078197">.</span><span class="ident" id="3078198">date</span>&nbsp;<span class="op" id="3078203">=</span>&nbsp;<span class="ident" id="3078205">appendTime</span><span class="op" id="3078215">(</span><span class="ident" id="3078216">cw</span><span class="op" id="3078218">.</span><span class="ident" id="3078219">res</span><span class="op" id="3078222">.</span><span class="ident" id="3078223">dateBuf</span><span class="op" id="3078230">[</span><span class="op" id="3078231">:</span><span class="num" id="3078232">0</span><span class="op" id="3078233">]</span><span class="op" id="3078234">,</span>&nbsp;<span class="ident" id="3078236">time</span><span class="op" id="3078240">.</span><span class="ident" id="3078241">Now</span><span class="op" id="3078244">(</span><span class="op" id="3078245">)</span><span class="op" id="3078246">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078253">te</span>&nbsp;<span class="op" id="3078256">:=</span>&nbsp;<span class="ident" id="3078259">header</span><span class="op" id="3078265">.</span><span class="ident" id="3078266">get</span><span class="op" id="3078269">(</span><span class="string" id="3078270">&#34;Transfer-Encoding&#34;</span><span class="op" id="3078289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078292">hasTE</span>&nbsp;<span class="op" id="3078298">:=</span>&nbsp;<span class="ident" id="3078301">te</span>&nbsp;<span class="op" id="3078304">!=</span>&nbsp;<span class="string" id="3078307">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078311">if</span>&nbsp;<span class="ident" id="3078314">hasCL</span>&nbsp;<span class="op" id="3078320">&amp;&amp;</span>&nbsp;<span class="ident" id="3078323">hasTE</span>&nbsp;<span class="op" id="3078329">&amp;&amp;</span>&nbsp;<span class="ident" id="3078332">te</span>&nbsp;<span class="op" id="3078335">!=</span>&nbsp;<span class="string" id="3078338">&#34;identity&#34;</span>&nbsp;<span class="op" id="3078349">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3078353">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3078419">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078464">w</span><span class="op" id="3078465">.</span><span class="ident" id="3078466">conn</span><span class="op" id="3078470">.</span><span class="ident" id="3078471">server</span><span class="op" id="3078477">.</span><span class="ident" id="3078478">logf</span><span class="op" id="3078482">(</span><span class="string" id="3078483">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3078570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078575">te</span><span class="op" id="3078577">,</span>&nbsp;<span class="ident" id="3078579">w</span><span class="op" id="3078580">.</span><span class="ident" id="3078581">contentLength</span><span class="op" id="3078594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078598">delHeader</span><span class="op" id="3078607">(</span><span class="string" id="3078608">&#34;Content-Length&#34;</span><span class="op" id="3078624">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078628">hasCL</span>&nbsp;<span class="op" id="3078634">=</span>&nbsp;<span class="builtintype" id="3078636">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078647">if</span>&nbsp;<span class="ident" id="3078650">w</span><span class="op" id="3078651">.</span><span class="ident" id="3078652">req</span><span class="op" id="3078655">.</span><span class="ident" id="3078656">Method</span>&nbsp;<span class="op" id="3078663">==</span>&nbsp;<span class="string" id="3078666">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3078673">||</span>&nbsp;<span class="op" id="3078676">!</span><span class="ident" id="3078677">bodyAllowedForStatus</span><span class="op" id="3078697">(</span><span class="ident" id="3078698">code</span><span class="op" id="3078702">)</span>&nbsp;<span class="op" id="3078704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3078708">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078723">}</span>&nbsp;<span class="keyword" id="3078725">else</span>&nbsp;<span class="keyword" id="3078730">if</span>&nbsp;<span class="ident" id="3078733">code</span>&nbsp;<span class="op" id="3078738">==</span>&nbsp;<span class="ident" id="3078741">StatusNoContent</span>&nbsp;<span class="op" id="3078757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078761">delHeader</span><span class="op" id="3078770">(</span><span class="string" id="3078771">&#34;Transfer-Encoding&#34;</span><span class="op" id="3078790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078793">}</span>&nbsp;<span class="keyword" id="3078795">else</span>&nbsp;<span class="keyword" id="3078800">if</span>&nbsp;<span class="ident" id="3078803">hasCL</span>&nbsp;<span class="op" id="3078809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078813">delHeader</span><span class="op" id="3078822">(</span><span class="string" id="3078823">&#34;Transfer-Encoding&#34;</span><span class="op" id="3078842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078845">}</span>&nbsp;<span class="keyword" id="3078847">else</span>&nbsp;<span class="keyword" id="3078852">if</span>&nbsp;<span class="ident" id="3078855">w</span><span class="op" id="3078856">.</span><span class="ident" id="3078857">req</span><span class="op" id="3078860">.</span><span class="ident" id="3078861">ProtoAtLeast</span><span class="op" id="3078873">(</span><span class="num" id="3078874">1</span><span class="op" id="3078875">,</span>&nbsp;<span class="num" id="3078877">1</span><span class="op" id="3078878">)</span>&nbsp;<span class="op" id="3078880">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3078884">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3078962">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079041">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079113">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079185">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079201">if</span>&nbsp;<span class="ident" id="3079204">hasTE</span>&nbsp;<span class="op" id="3079210">&amp;&amp;</span>&nbsp;<span class="ident" id="3079213">te</span>&nbsp;<span class="op" id="3079216">==</span>&nbsp;<span class="string" id="3079219">&#34;identity&#34;</span>&nbsp;<span class="op" id="3079230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079235">cw</span><span class="op" id="3079237">.</span><span class="ident" id="3079238">chunking</span>&nbsp;<span class="op" id="3079247">=</span>&nbsp;<span class="builtintype" id="3079249">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079258">w</span><span class="op" id="3079259">.</span><span class="ident" id="3079260">closeAfterReply</span>&nbsp;<span class="op" id="3079276">=</span>&nbsp;<span class="builtintype" id="3079278">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079285">}</span>&nbsp;<span class="keyword" id="3079287">else</span>&nbsp;<span class="op" id="3079292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079297">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079354">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079400">cw</span><span class="op" id="3079402">.</span><span class="ident" id="3079403">chunking</span>&nbsp;<span class="op" id="3079412">=</span>&nbsp;<span class="builtintype" id="3079414">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079422">setHeader</span><span class="op" id="3079431">.</span><span class="ident" id="3079432">transferEncoding</span>&nbsp;<span class="op" id="3079449">=</span>&nbsp;<span class="string" id="3079451">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079466">}</span>&nbsp;<span class="keyword" id="3079468">else</span>&nbsp;<span class="op" id="3079473">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079477">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079529">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079583">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079622">w</span><span class="op" id="3079623">.</span><span class="ident" id="3079624">closeAfterReply</span>&nbsp;<span class="op" id="3079640">=</span>&nbsp;<span class="builtintype" id="3079642">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079649">delHeader</span><span class="op" id="3079658">(</span><span class="string" id="3079659">&#34;Transfer-Encoding&#34;</span><span class="op" id="3079678">)</span>&nbsp;<span class="comment" id="3079680">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079708">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079775">if</span>&nbsp;<span class="ident" id="3079778">cw</span><span class="op" id="3079780">.</span><span class="ident" id="3079781">chunking</span>&nbsp;<span class="op" id="3079790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079794">delHeader</span><span class="op" id="3079803">(</span><span class="string" id="3079804">&#34;Content-Length&#34;</span><span class="op" id="3079820">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079826">if</span>&nbsp;<span class="op" id="3079829">!</span><span class="ident" id="3079830">w</span><span class="op" id="3079831">.</span><span class="ident" id="3079832">req</span><span class="op" id="3079835">.</span><span class="ident" id="3079836">ProtoAtLeast</span><span class="op" id="3079848">(</span><span class="num" id="3079849">1</span><span class="op" id="3079850">,</span>&nbsp;<span class="num" id="3079852">0</span><span class="op" id="3079853">)</span>&nbsp;<span class="op" id="3079855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079859">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079871">if</span>&nbsp;<span class="ident" id="3079874">w</span><span class="op" id="3079875">.</span><span class="ident" id="3079876">closeAfterReply</span>&nbsp;<span class="op" id="3079892">&amp;&amp;</span>&nbsp;<span class="op" id="3079895">(</span><span class="op" id="3079896">!</span><span class="ident" id="3079897">keepAlivesEnabled</span>&nbsp;<span class="op" id="3079915">||</span>&nbsp;<span class="op" id="3079918">!</span><span class="ident" id="3079919">hasToken</span><span class="op" id="3079927">(</span><span class="ident" id="3079928">cw</span><span class="op" id="3079930">.</span><span class="ident" id="3079931">header</span><span class="op" id="3079937">.</span><span class="ident" id="3079938">get</span><span class="op" id="3079941">(</span><span class="string" id="3079942">&#34;Connection&#34;</span><span class="op" id="3079954">)</span><span class="op" id="3079955">,</span>&nbsp;<span class="string" id="3079957">&#34;close&#34;</span><span class="op" id="3079964">)</span><span class="op" id="3079965">)</span>&nbsp;<span class="op" id="3079967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079971">delHeader</span><span class="op" id="3079980">(</span><span class="string" id="3079981">&#34;Connection&#34;</span><span class="op" id="3079993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079997">if</span>&nbsp;<span class="ident" id="3080000">w</span><span class="op" id="3080001">.</span><span class="ident" id="3080002">req</span><span class="op" id="3080005">.</span><span class="ident" id="3080006">ProtoAtLeast</span><span class="op" id="3080018">(</span><span class="num" id="3080019">1</span><span class="op" id="3080020">,</span>&nbsp;<span class="num" id="3080022">1</span><span class="op" id="3080023">)</span>&nbsp;<span class="op" id="3080025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080030">setHeader</span><span class="op" id="3080039">.</span><span class="ident" id="3080040">connection</span>&nbsp;<span class="op" id="3080051">=</span>&nbsp;<span class="string" id="3080053">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080063">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080070">w</span><span class="op" id="3080071">.</span><span class="ident" id="3080072">conn</span><span class="op" id="3080076">.</span><span class="ident" id="3080077">buf</span><span class="op" id="3080080">.</span><span class="ident" id="3080081">WriteString</span><span class="op" id="3080092">(</span><span class="ident" id="3080093">statusLine</span><span class="op" id="3080103">(</span><span class="ident" id="3080104">w</span><span class="op" id="3080105">.</span><span class="ident" id="3080106">req</span><span class="op" id="3080109">,</span>&nbsp;<span class="ident" id="3080111">code</span><span class="op" id="3080115">)</span><span class="op" id="3080116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080119">cw</span><span class="op" id="3080121">.</span><span class="ident" id="3080122">header</span><span class="op" id="3080128">.</span><span class="ident" id="3080129">WriteSubset</span><span class="op" id="3080140">(</span><span class="ident" id="3080141">w</span><span class="op" id="3080142">.</span><span class="ident" id="3080143">conn</span><span class="op" id="3080147">.</span><span class="ident" id="3080148">buf</span><span class="op" id="3080151">,</span>&nbsp;<span class="ident" id="3080153">excludeHeader</span><span class="op" id="3080166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080169">setHeader</span><span class="op" id="3080178">.</span><span class="ident" id="3080179">Write</span><span class="op" id="3080184">(</span><span class="ident" id="3080185">w</span><span class="op" id="3080186">.</span><span class="ident" id="3080187">conn</span><span class="op" id="3080191">.</span><span class="ident" id="3080192">buf</span><span class="op" id="3080195">.</span><span class="ident" id="3080196">Writer</span><span class="op" id="3080202">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080205">w</span><span class="op" id="3080206">.</span><span class="ident" id="3080207">conn</span><span class="op" id="3080211">.</span><span class="ident" id="3080212">buf</span><span class="op" id="3080215">.</span><span class="ident" id="3080216">Write</span><span class="op" id="3080221">(</span><span class="ident" id="3080222">crlf</span><span class="op" id="3080226">)</span><br>
<span class="lineno"></span><span class="op" id="3080228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3080231">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3080300">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3080368">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3080437">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3080505">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3080543">var</span>&nbsp;<span class="op" id="3080547">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080550">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3080562">sync</span><span class="op" id="3080566">.</span><span class="ident" id="3080567">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080576">statusLines</span>&nbsp;<span class="op" id="3080588">=</span>&nbsp;<span class="builtinfunc" id="3080590">make</span><span class="op" id="3080594">(</span><span class="keyword" id="3080595">map</span><span class="op" id="3080598">[</span><span class="builtintype" id="3080599">int</span><span class="op" id="3080602">]</span><span class="builtintype" id="3080603">string</span><span class="op" id="3080609">)</span><br>
<span class="lineno"></span><span class="op" id="3080611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3080614">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3080682">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3080733">func</span>&nbsp;<span class="ident" id="3080738">statusLine</span><span class="op" id="3080748">(</span><span class="ident" id="3080749">req</span>&nbsp;<span class="op" id="3080753">*</span><span class="ident" id="3080754">Request</span><span class="op" id="3080761">,</span>&nbsp;<span class="ident" id="3080763">code</span>&nbsp;<span class="builtintype" id="3080768">int</span><span class="op" id="3080771">)</span>&nbsp;<span class="builtintype" id="3080773">string</span>&nbsp;<span class="op" id="3080780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3080783">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080798">key</span>&nbsp;<span class="op" id="3080802">:=</span>&nbsp;<span class="ident" id="3080805">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080811">proto11</span>&nbsp;<span class="op" id="3080819">:=</span>&nbsp;<span class="ident" id="3080822">req</span><span class="op" id="3080825">.</span><span class="ident" id="3080826">ProtoAtLeast</span><span class="op" id="3080838">(</span><span class="num" id="3080839">1</span><span class="op" id="3080840">,</span>&nbsp;<span class="num" id="3080842">1</span><span class="op" id="3080843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080846">if</span>&nbsp;<span class="op" id="3080849">!</span><span class="ident" id="3080850">proto11</span>&nbsp;<span class="op" id="3080858">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080862">key</span>&nbsp;<span class="op" id="3080866">=</span>&nbsp;<span class="op" id="3080868">-</span><span class="ident" id="3080869">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080877">statusMu</span><span class="op" id="3080885">.</span><span class="ident" id="3080886">RLock</span><span class="op" id="3080891">(</span><span class="op" id="3080892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080895">line</span><span class="op" id="3080899">,</span>&nbsp;<span class="ident" id="3080901">ok</span>&nbsp;<span class="op" id="3080904">:=</span>&nbsp;<span class="ident" id="3080907">statusLines</span><span class="op" id="3080918">[</span><span class="ident" id="3080919">key</span><span class="op" id="3080922">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080925">statusMu</span><span class="op" id="3080933">.</span><span class="ident" id="3080934">RUnlock</span><span class="op" id="3080941">(</span><span class="op" id="3080942">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080945">if</span>&nbsp;<span class="ident" id="3080948">ok</span>&nbsp;<span class="op" id="3080951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080955">return</span>&nbsp;<span class="ident" id="3080962">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3080972">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080987">proto</span>&nbsp;<span class="op" id="3080993">:=</span>&nbsp;<span class="string" id="3080996">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081008">if</span>&nbsp;<span class="ident" id="3081011">proto11</span>&nbsp;<span class="op" id="3081019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081023">proto</span>&nbsp;<span class="op" id="3081029">=</span>&nbsp;<span class="string" id="3081031">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081046">codestring</span>&nbsp;<span class="op" id="3081057">:=</span>&nbsp;<span class="ident" id="3081060">strconv</span><span class="op" id="3081067">.</span><span class="ident" id="3081068">Itoa</span><span class="op" id="3081072">(</span><span class="ident" id="3081073">code</span><span class="op" id="3081077">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081080">text</span><span class="op" id="3081084">,</span>&nbsp;<span class="ident" id="3081086">ok</span>&nbsp;<span class="op" id="3081089">:=</span>&nbsp;<span class="ident" id="3081092">statusText</span><span class="op" id="3081102">[</span><span class="ident" id="3081103">code</span><span class="op" id="3081107">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081110">if</span>&nbsp;<span class="op" id="3081113">!</span><span class="ident" id="3081114">ok</span>&nbsp;<span class="op" id="3081117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081121">text</span>&nbsp;<span class="op" id="3081126">=</span>&nbsp;<span class="string" id="3081128">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3081143">+</span>&nbsp;<span class="ident" id="3081145">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081160">line</span>&nbsp;<span class="op" id="3081165">=</span>&nbsp;<span class="ident" id="3081167">proto</span>&nbsp;<span class="op" id="3081173">+</span>&nbsp;<span class="string" id="3081175">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3081179">+</span>&nbsp;<span class="ident" id="3081181">codestring</span>&nbsp;<span class="op" id="3081192">+</span>&nbsp;<span class="string" id="3081194">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3081198">+</span>&nbsp;<span class="ident" id="3081200">text</span>&nbsp;<span class="op" id="3081205">+</span>&nbsp;<span class="string" id="3081207">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081215">if</span>&nbsp;<span class="ident" id="3081218">ok</span>&nbsp;<span class="op" id="3081221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081225">statusMu</span><span class="op" id="3081233">.</span><span class="ident" id="3081234">Lock</span><span class="op" id="3081238">(</span><span class="op" id="3081239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081243">defer</span>&nbsp;<span class="ident" id="3081249">statusMu</span><span class="op" id="3081257">.</span><span class="ident" id="3081258">Unlock</span><span class="op" id="3081264">(</span><span class="op" id="3081265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3081269">statusLines</span><span class="op" id="3081280">[</span><span class="ident" id="3081281">key</span><span class="op" id="3081284">]</span>&nbsp;<span class="op" id="3081286">=</span>&nbsp;<span class="ident" id="3081288">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081294">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081297">return</span>&nbsp;<span class="ident" id="3081304">line</span><br>
<span class="lineno"></span><span class="op" id="3081309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3081312">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3081386">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3081451">func</span>&nbsp;<span class="op" id="3081456">(</span><span class="ident" id="3081457">w</span>&nbsp;<span class="op" id="3081459">*</span><span class="ident" id="3081460">response</span><span class="op" id="3081468">)</span>&nbsp;<span class="ident" id="3081470">bodyAllowed</span><span class="op" id="3081481">(</span><span class="op" id="3081482">)</span>&nbsp;<span class="builtintype" id="3081484">bool</span>&nbsp;<span class="op" id="3081489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081492">if</span>&nbsp;<span class="op" id="3081495">!</span><span class="ident" id="3081496">w</span><span class="op" id="3081497">.</span><span class="ident" id="3081498">wroteHeader</span>&nbsp;<span class="op" id="3081510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3081514">panic</span><span class="op" id="3081519">(</span><span class="string" id="3081520">&#34;&#34;</span><span class="op" id="3081522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3081525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3081528">return</span>&nbsp;<span class="ident" id="3081535">bodyAllowedForStatus</span><span class="op" id="3081555">(</span><span class="ident" id="3081556">w</span><span class="op" id="3081557">.</span><span class="ident" id="3081558">status</span><span class="op" id="3081564">)</span><br>
<span class="lineno">940</span><span class="op" id="3081566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3081569">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3081606">//</span><br>
<span class="lineno"></span><span class="comment" id="3081609">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3081676">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3081751">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3081795">//</span><br>
<span class="lineno"></span><span class="comment" id="3081798">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3081868">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3081936">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3082007">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3082033">//</span><br>
<span class="lineno"></span><span class="comment" id="3082036">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3082105">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3082142">//</span><br>
<span class="lineno"></span><span class="comment" id="3082145">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3082185">//</span><br>
<span class="lineno"></span><span class="comment" id="3082188">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3082228">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3082299">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3082374">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3082427">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3082496">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3082566">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3082633">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3082662">//</span><br>
<span class="lineno"></span><span class="comment" id="3082665">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3082729">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3082796">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3082864">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3082929">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3082999">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3083068">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3083139">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3083210">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3083232">func</span>&nbsp;<span class="op" id="3083237">(</span><span class="ident" id="3083238">w</span>&nbsp;<span class="op" id="3083240">*</span><span class="ident" id="3083241">response</span><span class="op" id="3083249">)</span>&nbsp;<span class="ident" id="3083251">Write</span><span class="op" id="3083256">(</span><span class="ident" id="3083257">data</span>&nbsp;<span class="op" id="3083262">[</span><span class="op" id="3083263">]</span><span class="builtintype" id="3083264">byte</span><span class="op" id="3083268">)</span>&nbsp;<span class="op" id="3083270">(</span><span class="ident" id="3083271">n</span>&nbsp;<span class="builtintype" id="3083273">int</span><span class="op" id="3083276">,</span>&nbsp;<span class="ident" id="3083278">err</span>&nbsp;<span class="builtintype" id="3083282">error</span><span class="op" id="3083287">)</span>&nbsp;<span class="op" id="3083289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083292">return</span>&nbsp;<span class="ident" id="3083299">w</span><span class="op" id="3083300">.</span><span class="ident" id="3083301">write</span><span class="op" id="3083306">(</span><span class="builtinfunc" id="3083307">len</span><span class="op" id="3083310">(</span><span class="ident" id="3083311">data</span><span class="op" id="3083315">)</span><span class="op" id="3083316">,</span>&nbsp;<span class="ident" id="3083318">data</span><span class="op" id="3083322">,</span>&nbsp;<span class="string" id="3083324">&#34;&#34;</span><span class="op" id="3083326">)</span><br>
<span class="lineno"></span><span class="op" id="3083328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3083331">func</span>&nbsp;<span class="op" id="3083336">(</span><span class="ident" id="3083337">w</span>&nbsp;<span class="op" id="3083339">*</span><span class="ident" id="3083340">response</span><span class="op" id="3083348">)</span>&nbsp;<span class="ident" id="3083350">WriteString</span><span class="op" id="3083361">(</span><span class="ident" id="3083362">data</span>&nbsp;<span class="builtintype" id="3083367">string</span><span class="op" id="3083373">)</span>&nbsp;<span class="op" id="3083375">(</span><span class="ident" id="3083376">n</span>&nbsp;<span class="builtintype" id="3083378">int</span><span class="op" id="3083381">,</span>&nbsp;<span class="ident" id="3083383">err</span>&nbsp;<span class="builtintype" id="3083387">error</span><span class="op" id="3083392">)</span>&nbsp;<span class="op" id="3083394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083397">return</span>&nbsp;<span class="ident" id="3083404">w</span><span class="op" id="3083405">.</span><span class="ident" id="3083406">write</span><span class="op" id="3083411">(</span><span class="builtinfunc" id="3083412">len</span><span class="op" id="3083415">(</span><span class="ident" id="3083416">data</span><span class="op" id="3083420">)</span><span class="op" id="3083421">,</span>&nbsp;<span class="ident" id="3083423">nil</span><span class="op" id="3083426">,</span>&nbsp;<span class="ident" id="3083428">data</span><span class="op" id="3083432">)</span><br>
<span class="lineno"></span><span class="op" id="3083434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3083437">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3083475">func</span>&nbsp;<span class="op" id="3083480">(</span><span class="ident" id="3083481">w</span>&nbsp;<span class="op" id="3083483">*</span><span class="ident" id="3083484">response</span><span class="op" id="3083492">)</span>&nbsp;<span class="ident" id="3083494">write</span><span class="op" id="3083499">(</span><span class="ident" id="3083500">lenData</span>&nbsp;<span class="builtintype" id="3083508">int</span><span class="op" id="3083511">,</span>&nbsp;<span class="ident" id="3083513">dataB</span>&nbsp;<span class="op" id="3083519">[</span><span class="op" id="3083520">]</span><span class="builtintype" id="3083521">byte</span><span class="op" id="3083525">,</span>&nbsp;<span class="ident" id="3083527">dataS</span>&nbsp;<span class="builtintype" id="3083533">string</span><span class="op" id="3083539">)</span>&nbsp;<span class="op" id="3083541">(</span><span class="ident" id="3083542">n</span>&nbsp;<span class="builtintype" id="3083544">int</span><span class="op" id="3083547">,</span>&nbsp;<span class="ident" id="3083549">err</span>&nbsp;<span class="builtintype" id="3083553">error</span><span class="op" id="3083558">)</span>&nbsp;<span class="op" id="3083560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083563">if</span>&nbsp;<span class="ident" id="3083566">w</span><span class="op" id="3083567">.</span><span class="ident" id="3083568">conn</span><span class="op" id="3083572">.</span><span class="ident" id="3083573">hijacked</span><span class="op" id="3083581">(</span><span class="op" id="3083582">)</span>&nbsp;<span class="op" id="3083584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083588">w</span><span class="op" id="3083589">.</span><span class="ident" id="3083590">conn</span><span class="op" id="3083594">.</span><span class="ident" id="3083595">server</span><span class="op" id="3083601">.</span><span class="ident" id="3083602">logf</span><span class="op" id="3083606">(</span><span class="string" id="3083607">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3083652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083656">return</span>&nbsp;<span class="num" id="3083663">0</span><span class="op" id="3083664">,</span>&nbsp;<span class="ident" id="3083666">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083679">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083682">if</span>&nbsp;<span class="op" id="3083685">!</span><span class="ident" id="3083686">w</span><span class="op" id="3083687">.</span><span class="ident" id="3083688">wroteHeader</span>&nbsp;<span class="op" id="3083700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083704">w</span><span class="op" id="3083705">.</span><span class="ident" id="3083706">WriteHeader</span><span class="op" id="3083717">(</span><span class="ident" id="3083718">StatusOK</span><span class="op" id="3083726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083732">if</span>&nbsp;<span class="ident" id="3083735">lenData</span>&nbsp;<span class="op" id="3083743">==</span>&nbsp;<span class="num" id="3083746">0</span>&nbsp;<span class="op" id="3083748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083752">return</span>&nbsp;<span class="num" id="3083759">0</span><span class="op" id="3083760">,</span>&nbsp;<span class="ident" id="3083762">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083770">if</span>&nbsp;<span class="op" id="3083773">!</span><span class="ident" id="3083774">w</span><span class="op" id="3083775">.</span><span class="ident" id="3083776">bodyAllowed</span><span class="op" id="3083787">(</span><span class="op" id="3083788">)</span>&nbsp;<span class="op" id="3083790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083794">return</span>&nbsp;<span class="num" id="3083801">0</span><span class="op" id="3083802">,</span>&nbsp;<span class="ident" id="3083804">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3083827">w</span><span class="op" id="3083828">.</span><span class="ident" id="3083829">written</span>&nbsp;<span class="op" id="3083837">+=</span>&nbsp;<span class="ident" id="3083840">int64</span><span class="op" id="3083845">(</span><span class="ident" id="3083846">lenData</span><span class="op" id="3083853">)</span>&nbsp;<span class="comment" id="3083855">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083892">if</span>&nbsp;<span class="ident" id="3083895">w</span><span class="op" id="3083896">.</span><span class="ident" id="3083897">contentLength</span>&nbsp;<span class="op" id="3083911">!=</span>&nbsp;<span class="op" id="3083914">-</span><span class="num" id="3083915">1</span>&nbsp;<span class="op" id="3083917">&amp;&amp;</span>&nbsp;<span class="ident" id="3083920">w</span><span class="op" id="3083921">.</span><span class="ident" id="3083922">written</span>&nbsp;<span class="op" id="3083930">&gt;</span>&nbsp;<span class="ident" id="3083932">w</span><span class="op" id="3083933">.</span><span class="ident" id="3083934">contentLength</span>&nbsp;<span class="op" id="3083948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083952">return</span>&nbsp;<span class="num" id="3083959">0</span><span class="op" id="3083960">,</span>&nbsp;<span class="ident" id="3083962">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3083980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3083983">if</span>&nbsp;<span class="ident" id="3083986">dataB</span>&nbsp;<span class="op" id="3083992">!=</span>&nbsp;<span class="ident" id="3083995">nil</span>&nbsp;<span class="op" id="3083999">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084003">return</span>&nbsp;<span class="ident" id="3084010">w</span><span class="op" id="3084011">.</span><span class="ident" id="3084012">w</span><span class="op" id="3084013">.</span><span class="ident" id="3084014">Write</span><span class="op" id="3084019">(</span><span class="ident" id="3084020">dataB</span><span class="op" id="3084025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084028">}</span>&nbsp;<span class="keyword" id="3084030">else</span>&nbsp;<span class="op" id="3084035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084039">return</span>&nbsp;<span class="ident" id="3084046">w</span><span class="op" id="3084047">.</span><span class="ident" id="3084048">w</span><span class="op" id="3084049">.</span><span class="ident" id="3084050">WriteString</span><span class="op" id="3084061">(</span><span class="ident" id="3084062">dataS</span><span class="op" id="3084067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084070">}</span><br>
<span class="lineno"></span><span class="op" id="3084072">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3084075">func</span>&nbsp;<span class="op" id="3084080">(</span><span class="ident" id="3084081">w</span>&nbsp;<span class="op" id="3084083">*</span><span class="ident" id="3084084">response</span><span class="op" id="3084092">)</span>&nbsp;<span class="ident" id="3084094">finishRequest</span><span class="op" id="3084107">(</span><span class="op" id="3084108">)</span>&nbsp;<span class="op" id="3084110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084113">w</span><span class="op" id="3084114">.</span><span class="ident" id="3084115">handlerDone</span>&nbsp;<span class="op" id="3084127">=</span>&nbsp;<span class="builtintype" id="3084129">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084136">if</span>&nbsp;<span class="op" id="3084139">!</span><span class="ident" id="3084140">w</span><span class="op" id="3084141">.</span><span class="ident" id="3084142">wroteHeader</span>&nbsp;<span class="op" id="3084154">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084158">w</span><span class="op" id="3084159">.</span><span class="ident" id="3084160">WriteHeader</span><span class="op" id="3084171">(</span><span class="ident" id="3084172">StatusOK</span><span class="op" id="3084180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084187">w</span><span class="op" id="3084188">.</span><span class="ident" id="3084189">w</span><span class="op" id="3084190">.</span><span class="ident" id="3084191">Flush</span><span class="op" id="3084196">(</span><span class="op" id="3084197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084200">putBufioWriter</span><span class="op" id="3084214">(</span><span class="ident" id="3084215">w</span><span class="op" id="3084216">.</span><span class="ident" id="3084217">w</span><span class="op" id="3084218">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084221">w</span><span class="op" id="3084222">.</span><span class="ident" id="3084223">cw</span><span class="op" id="3084225">.</span><span class="builtinfunc" id="3084226">close</span><span class="op" id="3084231">(</span><span class="op" id="3084232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084235">w</span><span class="op" id="3084236">.</span><span class="ident" id="3084237">conn</span><span class="op" id="3084241">.</span><span class="ident" id="3084242">buf</span><span class="op" id="3084245">.</span><span class="ident" id="3084246">Flush</span><span class="op" id="3084251">(</span><span class="op" id="3084252">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084256">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084319">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084361">w</span><span class="op" id="3084362">.</span><span class="ident" id="3084363">req</span><span class="op" id="3084366">.</span><span class="ident" id="3084367">Body</span><span class="op" id="3084371">.</span><span class="ident" id="3084372">Close</span><span class="op" id="3084377">(</span><span class="op" id="3084378">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084382">if</span>&nbsp;<span class="ident" id="3084385">w</span><span class="op" id="3084386">.</span><span class="ident" id="3084387">req</span><span class="op" id="3084390">.</span><span class="ident" id="3084391">MultipartForm</span>&nbsp;<span class="op" id="3084405">!=</span>&nbsp;<span class="ident" id="3084408">nil</span>&nbsp;<span class="op" id="3084412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084416">w</span><span class="op" id="3084417">.</span><span class="ident" id="3084418">req</span><span class="op" id="3084421">.</span><span class="ident" id="3084422">MultipartForm</span><span class="op" id="3084435">.</span><span class="ident" id="3084436">RemoveAll</span><span class="op" id="3084445">(</span><span class="op" id="3084446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084449">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084453">if</span>&nbsp;<span class="ident" id="3084456">w</span><span class="op" id="3084457">.</span><span class="ident" id="3084458">req</span><span class="op" id="3084461">.</span><span class="ident" id="3084462">Method</span>&nbsp;<span class="op" id="3084469">!=</span>&nbsp;<span class="string" id="3084472">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3084479">&amp;&amp;</span>&nbsp;<span class="ident" id="3084482">w</span><span class="op" id="3084483">.</span><span class="ident" id="3084484">contentLength</span>&nbsp;<span class="op" id="3084498">!=</span>&nbsp;<span class="op" id="3084501">-</span><span class="num" id="3084502">1</span>&nbsp;<span class="op" id="3084504">&amp;&amp;</span>&nbsp;<span class="ident" id="3084507">w</span><span class="op" id="3084508">.</span><span class="ident" id="3084509">bodyAllowed</span><span class="op" id="3084520">(</span><span class="op" id="3084521">)</span>&nbsp;<span class="op" id="3084523">&amp;&amp;</span>&nbsp;<span class="ident" id="3084526">w</span><span class="op" id="3084527">.</span><span class="ident" id="3084528">contentLength</span>&nbsp;<span class="op" id="3084542">!=</span>&nbsp;<span class="ident" id="3084545">w</span><span class="op" id="3084546">.</span><span class="ident" id="3084547">written</span>&nbsp;<span class="op" id="3084555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084559">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084613">w</span><span class="op" id="3084614">.</span><span class="ident" id="3084615">closeAfterReply</span>&nbsp;<span class="op" id="3084631">=</span>&nbsp;<span class="builtintype" id="3084633">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084639">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084643">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084705">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084756">if</span>&nbsp;<span class="ident" id="3084759">w</span><span class="op" id="3084760">.</span><span class="ident" id="3084761">conn</span><span class="op" id="3084765">.</span><span class="ident" id="3084766">werr</span>&nbsp;<span class="op" id="3084771">!=</span>&nbsp;<span class="ident" id="3084774">nil</span>&nbsp;<span class="op" id="3084778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084782">w</span><span class="op" id="3084783">.</span><span class="ident" id="3084784">closeAfterReply</span>&nbsp;<span class="op" id="3084800">=</span>&nbsp;<span class="builtintype" id="3084802">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084808">}</span><br>
<span class="lineno"></span><span class="op" id="3084810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3084813">func</span>&nbsp;<span class="op" id="3084818">(</span><span class="ident" id="3084819">w</span>&nbsp;<span class="op" id="3084821">*</span><span class="ident" id="3084822">response</span><span class="op" id="3084830">)</span>&nbsp;<span class="ident" id="3084832">Flush</span><span class="op" id="3084837">(</span><span class="op" id="3084838">)</span>&nbsp;<span class="op" id="3084840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084843">if</span>&nbsp;<span class="op" id="3084846">!</span><span class="ident" id="3084847">w</span><span class="op" id="3084848">.</span><span class="ident" id="3084849">wroteHeader</span>&nbsp;<span class="op" id="3084861">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084865">w</span><span class="op" id="3084866">.</span><span class="ident" id="3084867">WriteHeader</span><span class="op" id="3084878">(</span><span class="ident" id="3084879">StatusOK</span><span class="op" id="3084887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3084890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084893">w</span><span class="op" id="3084894">.</span><span class="ident" id="3084895">w</span><span class="op" id="3084896">.</span><span class="ident" id="3084897">Flush</span><span class="op" id="3084902">(</span><span class="op" id="3084903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084906">w</span><span class="op" id="3084907">.</span><span class="ident" id="3084908">cw</span><span class="op" id="3084910">.</span><span class="ident" id="3084911">flush</span><span class="op" id="3084916">(</span><span class="op" id="3084917">)</span><br>
<span class="lineno"></span><span class="op" id="3084919">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3084922">func</span>&nbsp;<span class="op" id="3084927">(</span><span class="ident" id="3084928">c</span>&nbsp;<span class="op" id="3084930">*</span><span class="ident" id="3084931">conn</span><span class="op" id="3084935">)</span>&nbsp;<span class="ident" id="3084937">finalFlush</span><span class="op" id="3084947">(</span><span class="op" id="3084948">)</span>&nbsp;<span class="op" id="3084950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3084953">if</span>&nbsp;<span class="ident" id="3084956">c</span><span class="op" id="3084957">.</span><span class="ident" id="3084958">buf</span>&nbsp;<span class="op" id="3084962">!=</span>&nbsp;<span class="ident" id="3084965">nil</span>&nbsp;<span class="op" id="3084969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3084973">c</span><span class="op" id="3084974">.</span><span class="ident" id="3084975">buf</span><span class="op" id="3084978">.</span><span class="ident" id="3084979">Flush</span><span class="op" id="3084984">(</span><span class="op" id="3084985">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3084990">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3085060">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085097">putBufioReader</span><span class="op" id="3085111">(</span><span class="ident" id="3085112">c</span><span class="op" id="3085113">.</span><span class="ident" id="3085114">buf</span><span class="op" id="3085117">.</span><span class="ident" id="3085118">Reader</span><span class="op" id="3085124">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3085129">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3085199">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085236">putBufioWriter</span><span class="op" id="3085250">(</span><span class="ident" id="3085251">c</span><span class="op" id="3085252">.</span><span class="ident" id="3085253">buf</span><span class="op" id="3085256">.</span><span class="ident" id="3085257">Writer</span><span class="op" id="3085263">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085268">c</span><span class="op" id="3085269">.</span><span class="ident" id="3085270">buf</span>&nbsp;<span class="op" id="3085274">=</span>&nbsp;<span class="ident" id="3085276">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085281">}</span><br>
<span class="lineno">1065</span><span class="op" id="3085283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3085286">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3085311">func</span>&nbsp;<span class="op" id="3085316">(</span><span class="ident" id="3085317">c</span>&nbsp;<span class="op" id="3085319">*</span><span class="ident" id="3085320">conn</span><span class="op" id="3085324">)</span>&nbsp;<span class="builtinfunc" id="3085326">close</span><span class="op" id="3085331">(</span><span class="op" id="3085332">)</span>&nbsp;<span class="op" id="3085334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085337">c</span><span class="op" id="3085338">.</span><span class="ident" id="3085339">finalFlush</span><span class="op" id="3085349">(</span><span class="op" id="3085350">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3085353">if</span>&nbsp;<span class="ident" id="3085356">c</span><span class="op" id="3085357">.</span><span class="ident" id="3085358">rwc</span>&nbsp;<span class="op" id="3085362">!=</span>&nbsp;<span class="ident" id="3085365">nil</span>&nbsp;<span class="op" id="3085369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085373">c</span><span class="op" id="3085374">.</span><span class="ident" id="3085375">rwc</span><span class="op" id="3085378">.</span><span class="ident" id="3085379">Close</span><span class="op" id="3085384">(</span><span class="op" id="3085385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085389">c</span><span class="op" id="3085390">.</span><span class="ident" id="3085391">rwc</span>&nbsp;<span class="op" id="3085395">=</span>&nbsp;<span class="ident" id="3085397">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3085402">}</span><br>
<span class="lineno"></span><span class="op" id="3085404">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3085407">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3085477">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3085545">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3085614">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3085685">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3085738">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3085803">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3085871">const</span>&nbsp;<span class="ident" id="3085877">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3085895">=</span>&nbsp;<span class="num" id="3085897">500</span>&nbsp;<span class="op" id="3085901">*</span>&nbsp;<span class="ident" id="3085903">time</span><span class="op" id="3085907">.</span><span class="ident" id="3085908">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3085921">type</span>&nbsp;<span class="ident" id="3085926">closeWriter</span>&nbsp;<span class="keyword" id="3085938">interface</span>&nbsp;<span class="op" id="3085948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3085951">CloseWrite</span><span class="op" id="3085961">(</span><span class="op" id="3085962">)</span>&nbsp;<span class="builtintype" id="3085964">error</span><br>
<span class="lineno"></span><span class="op" id="3085970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3085973">var</span>&nbsp;<span class="ident" id="3085977">_</span>&nbsp;<span class="ident" id="3085979">closeWriter</span>&nbsp;<span class="op" id="3085991">=</span>&nbsp;<span class="op" id="3085993">(</span><span class="op" id="3085994">*</span><span class="ident" id="3085995">net</span><span class="op" id="3085998">.</span><span class="ident" id="3085999">TCPConn</span><span class="op" id="3086006">)</span><span class="op" id="3086007">(</span><span class="ident" id="3086008">nil</span><span class="op" id="3086011">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3086014">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3086084">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3086154">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3086216">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3086235">//</span><br>
<span class="lineno"></span><span class="comment" id="3086238">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3086274">func</span>&nbsp;<span class="op" id="3086279">(</span><span class="ident" id="3086280">c</span>&nbsp;<span class="op" id="3086282">*</span><span class="ident" id="3086283">conn</span><span class="op" id="3086287">)</span>&nbsp;<span class="ident" id="3086289">closeWriteAndWait</span><span class="op" id="3086306">(</span><span class="op" id="3086307">)</span>&nbsp;<span class="op" id="3086309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086312">c</span><span class="op" id="3086313">.</span><span class="ident" id="3086314">finalFlush</span><span class="op" id="3086324">(</span><span class="op" id="3086325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086328">if</span>&nbsp;<span class="ident" id="3086331">tcp</span><span class="op" id="3086334">,</span>&nbsp;<span class="ident" id="3086336">ok</span>&nbsp;<span class="op" id="3086339">:=</span>&nbsp;<span class="ident" id="3086342">c</span><span class="op" id="3086343">.</span><span class="ident" id="3086344">rwc</span><span class="op" id="3086347">.</span><span class="op" id="3086348">(</span><span class="ident" id="3086349">closeWriter</span><span class="op" id="3086360">)</span><span class="op" id="3086361">;</span>&nbsp;<span class="ident" id="3086363">ok</span>&nbsp;<span class="op" id="3086366">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086370">tcp</span><span class="op" id="3086373">.</span><span class="ident" id="3086374">CloseWrite</span><span class="op" id="3086384">(</span><span class="op" id="3086385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086391">time</span><span class="op" id="3086395">.</span><span class="ident" id="3086396">Sleep</span><span class="op" id="3086401">(</span><span class="ident" id="3086402">rstAvoidanceDelay</span><span class="op" id="3086419">)</span><br>
<span class="lineno"></span><span class="op" id="3086421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3086424">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3086488">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3086557">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3086615">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3086635">func</span>&nbsp;<span class="ident" id="3086640">validNPN</span><span class="op" id="3086648">(</span><span class="ident" id="3086649">proto</span>&nbsp;<span class="builtintype" id="3086655">string</span><span class="op" id="3086661">)</span>&nbsp;<span class="builtintype" id="3086663">bool</span>&nbsp;<span class="op" id="3086668">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086671">switch</span>&nbsp;<span class="ident" id="3086678">proto</span>&nbsp;<span class="op" id="3086684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086687">case</span>&nbsp;<span class="string" id="3086692">&#34;&#34;</span><span class="op" id="3086694">,</span>&nbsp;<span class="string" id="3086696">&#34;http/1.1&#34;</span><span class="op" id="3086706">,</span>&nbsp;<span class="string" id="3086708">&#34;http/1.0&#34;</span><span class="op" id="3086718">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086722">return</span>&nbsp;<span class="builtintype" id="3086729">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086739">return</span>&nbsp;<span class="builtintype" id="3086746">true</span><br>
<span class="lineno">1115</span><span class="op" id="3086751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3086754">func</span>&nbsp;<span class="op" id="3086759">(</span><span class="ident" id="3086760">c</span>&nbsp;<span class="op" id="3086762">*</span><span class="ident" id="3086763">conn</span><span class="op" id="3086767">)</span>&nbsp;<span class="ident" id="3086769">setState</span><span class="op" id="3086777">(</span><span class="ident" id="3086778">nc</span>&nbsp;<span class="ident" id="3086781">net</span><span class="op" id="3086784">.</span><span class="ident" id="3086785">Conn</span><span class="op" id="3086789">,</span>&nbsp;<span class="ident" id="3086791">state</span>&nbsp;<span class="ident" id="3086797">ConnState</span><span class="op" id="3086806">)</span>&nbsp;<span class="op" id="3086808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3086811">if</span>&nbsp;<span class="ident" id="3086814">hook</span>&nbsp;<span class="op" id="3086819">:=</span>&nbsp;<span class="ident" id="3086822">c</span><span class="op" id="3086823">.</span><span class="ident" id="3086824">server</span><span class="op" id="3086830">.</span><span class="ident" id="3086831">ConnState</span><span class="op" id="3086840">;</span>&nbsp;<span class="ident" id="3086842">hook</span>&nbsp;<span class="op" id="3086847">!=</span>&nbsp;<span class="ident" id="3086850">nil</span>&nbsp;<span class="op" id="3086854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086858">hook</span><span class="op" id="3086862">(</span><span class="ident" id="3086863">nc</span><span class="op" id="3086865">,</span>&nbsp;<span class="ident" id="3086867">state</span><span class="op" id="3086872">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3086875">}</span><br>
<span class="lineno"></span><span class="op" id="3086877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3086880">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3086907">func</span>&nbsp;<span class="op" id="3086912">(</span><span class="ident" id="3086913">c</span>&nbsp;<span class="op" id="3086915">*</span><span class="ident" id="3086916">conn</span><span class="op" id="3086920">)</span>&nbsp;<span class="ident" id="3086922">serve</span><span class="op" id="3086927">(</span><span class="op" id="3086928">)</span>&nbsp;<span class="op" id="3086930">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3086933">origConn</span>&nbsp;<span class="op" id="3086942">:=</span>&nbsp;<span class="ident" id="3086945">c</span><span class="op" id="3086946">.</span><span class="ident" id="3086947">rwc</span>&nbsp;<span class="comment" id="3086951">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087002">defer</span>&nbsp;<span class="keyword" id="3087008">func</span><span class="op" id="3087012">(</span><span class="op" id="3087013">)</span>&nbsp;<span class="op" id="3087015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087019">if</span>&nbsp;<span class="ident" id="3087022">err</span>&nbsp;<span class="op" id="3087026">:=</span>&nbsp;<span class="builtinfunc" id="3087029">recover</span><span class="op" id="3087036">(</span><span class="op" id="3087037">)</span><span class="op" id="3087038">;</span>&nbsp;<span class="ident" id="3087040">err</span>&nbsp;<span class="op" id="3087044">!=</span>&nbsp;<span class="ident" id="3087047">nil</span>&nbsp;<span class="op" id="3087051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087056">const</span>&nbsp;<span class="ident" id="3087062">size</span>&nbsp;<span class="op" id="3087067">=</span>&nbsp;<span class="num" id="3087069">64</span>&nbsp;<span class="op" id="3087072">&lt;&lt;</span>&nbsp;<span class="num" id="3087075">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087081">buf</span>&nbsp;<span class="op" id="3087085">:=</span>&nbsp;<span class="builtinfunc" id="3087088">make</span><span class="op" id="3087092">(</span><span class="op" id="3087093">[</span><span class="op" id="3087094">]</span><span class="builtintype" id="3087095">byte</span><span class="op" id="3087099">,</span>&nbsp;<span class="ident" id="3087101">size</span><span class="op" id="3087105">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087110">buf</span>&nbsp;<span class="op" id="3087114">=</span>&nbsp;<span class="ident" id="3087116">buf</span><span class="op" id="3087119">[</span><span class="op" id="3087120">:</span><span class="ident" id="3087121">runtime</span><span class="op" id="3087128">.</span><span class="ident" id="3087129">Stack</span><span class="op" id="3087134">(</span><span class="ident" id="3087135">buf</span><span class="op" id="3087138">,</span>&nbsp;<span class="builtintype" id="3087140">false</span><span class="op" id="3087145">)</span><span class="op" id="3087146">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087151">c</span><span class="op" id="3087152">.</span><span class="ident" id="3087153">server</span><span class="op" id="3087159">.</span><span class="ident" id="3087160">logf</span><span class="op" id="3087164">(</span><span class="string" id="3087165">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3087197">,</span>&nbsp;<span class="ident" id="3087199">c</span><span class="op" id="3087200">.</span><span class="ident" id="3087201">remoteAddr</span><span class="op" id="3087211">,</span>&nbsp;<span class="ident" id="3087213">err</span><span class="op" id="3087216">,</span>&nbsp;<span class="ident" id="3087218">buf</span><span class="op" id="3087221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087229">if</span>&nbsp;<span class="op" id="3087232">!</span><span class="ident" id="3087233">c</span><span class="op" id="3087234">.</span><span class="ident" id="3087235">hijacked</span><span class="op" id="3087243">(</span><span class="op" id="3087244">)</span>&nbsp;<span class="op" id="3087246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087251">c</span><span class="op" id="3087252">.</span><span class="builtinfunc" id="3087253">close</span><span class="op" id="3087258">(</span><span class="op" id="3087259">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087264">c</span><span class="op" id="3087265">.</span><span class="ident" id="3087266">setState</span><span class="op" id="3087274">(</span><span class="ident" id="3087275">origConn</span><span class="op" id="3087283">,</span>&nbsp;<span class="ident" id="3087285">StateClosed</span><span class="op" id="3087296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087303">}</span><span class="op" id="3087304">(</span><span class="op" id="3087305">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087309">if</span>&nbsp;<span class="ident" id="3087312">tlsConn</span><span class="op" id="3087319">,</span>&nbsp;<span class="ident" id="3087321">ok</span>&nbsp;<span class="op" id="3087324">:=</span>&nbsp;<span class="ident" id="3087327">c</span><span class="op" id="3087328">.</span><span class="ident" id="3087329">rwc</span><span class="op" id="3087332">.</span><span class="op" id="3087333">(</span><span class="op" id="3087334">*</span><span class="ident" id="3087335">tls</span><span class="op" id="3087338">.</span><span class="ident" id="3087339">Conn</span><span class="op" id="3087343">)</span><span class="op" id="3087344">;</span>&nbsp;<span class="ident" id="3087346">ok</span>&nbsp;<span class="op" id="3087349">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087353">if</span>&nbsp;<span class="ident" id="3087356">d</span>&nbsp;<span class="op" id="3087358">:=</span>&nbsp;<span class="ident" id="3087361">c</span><span class="op" id="3087362">.</span><span class="ident" id="3087363">server</span><span class="op" id="3087369">.</span><span class="ident" id="3087370">ReadTimeout</span><span class="op" id="3087381">;</span>&nbsp;<span class="ident" id="3087383">d</span>&nbsp;<span class="op" id="3087385">!=</span>&nbsp;<span class="num" id="3087388">0</span>&nbsp;<span class="op" id="3087390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087395">c</span><span class="op" id="3087396">.</span><span class="ident" id="3087397">rwc</span><span class="op" id="3087400">.</span><span class="ident" id="3087401">SetReadDeadline</span><span class="op" id="3087416">(</span><span class="ident" id="3087417">time</span><span class="op" id="3087421">.</span><span class="ident" id="3087422">Now</span><span class="op" id="3087425">(</span><span class="op" id="3087426">)</span><span class="op" id="3087427">.</span><span class="ident" id="3087428">Add</span><span class="op" id="3087431">(</span><span class="ident" id="3087432">d</span><span class="op" id="3087433">)</span><span class="op" id="3087434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087442">if</span>&nbsp;<span class="ident" id="3087445">d</span>&nbsp;<span class="op" id="3087447">:=</span>&nbsp;<span class="ident" id="3087450">c</span><span class="op" id="3087451">.</span><span class="ident" id="3087452">server</span><span class="op" id="3087458">.</span><span class="ident" id="3087459">WriteTimeout</span><span class="op" id="3087471">;</span>&nbsp;<span class="ident" id="3087473">d</span>&nbsp;<span class="op" id="3087475">!=</span>&nbsp;<span class="num" id="3087478">0</span>&nbsp;<span class="op" id="3087480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087485">c</span><span class="op" id="3087486">.</span><span class="ident" id="3087487">rwc</span><span class="op" id="3087490">.</span><span class="ident" id="3087491">SetWriteDeadline</span><span class="op" id="3087507">(</span><span class="ident" id="3087508">time</span><span class="op" id="3087512">.</span><span class="ident" id="3087513">Now</span><span class="op" id="3087516">(</span><span class="op" id="3087517">)</span><span class="op" id="3087518">.</span><span class="ident" id="3087519">Add</span><span class="op" id="3087522">(</span><span class="ident" id="3087523">d</span><span class="op" id="3087524">)</span><span class="op" id="3087525">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087533">if</span>&nbsp;<span class="ident" id="3087536">err</span>&nbsp;<span class="op" id="3087540">:=</span>&nbsp;<span class="ident" id="3087543">tlsConn</span><span class="op" id="3087550">.</span><span class="ident" id="3087551">Handshake</span><span class="op" id="3087560">(</span><span class="op" id="3087561">)</span><span class="op" id="3087562">;</span>&nbsp;<span class="ident" id="3087564">err</span>&nbsp;<span class="op" id="3087568">!=</span>&nbsp;<span class="ident" id="3087571">nil</span>&nbsp;<span class="op" id="3087575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087580">c</span><span class="op" id="3087581">.</span><span class="ident" id="3087582">server</span><span class="op" id="3087588">.</span><span class="ident" id="3087589">logf</span><span class="op" id="3087593">(</span><span class="string" id="3087594">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3087633">,</span>&nbsp;<span class="ident" id="3087635">c</span><span class="op" id="3087636">.</span><span class="ident" id="3087637">rwc</span><span class="op" id="3087640">.</span><span class="ident" id="3087641">RemoteAddr</span><span class="op" id="3087651">(</span><span class="op" id="3087652">)</span><span class="op" id="3087653">,</span>&nbsp;<span class="ident" id="3087655">err</span><span class="op" id="3087658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087663">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087672">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087676">c</span><span class="op" id="3087677">.</span><span class="ident" id="3087678">tlsState</span>&nbsp;<span class="op" id="3087687">=</span>&nbsp;<span class="builtinfunc" id="3087689">new</span><span class="op" id="3087692">(</span><span class="ident" id="3087693">tls</span><span class="op" id="3087696">.</span><span class="ident" id="3087697">ConnectionState</span><span class="op" id="3087712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087716">*</span><span class="ident" id="3087717">c</span><span class="op" id="3087718">.</span><span class="ident" id="3087719">tlsState</span>&nbsp;<span class="op" id="3087728">=</span>&nbsp;<span class="ident" id="3087730">tlsConn</span><span class="op" id="3087737">.</span><span class="ident" id="3087738">ConnectionState</span><span class="op" id="3087753">(</span><span class="op" id="3087754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087758">if</span>&nbsp;<span class="ident" id="3087761">proto</span>&nbsp;<span class="op" id="3087767">:=</span>&nbsp;<span class="ident" id="3087770">c</span><span class="op" id="3087771">.</span><span class="ident" id="3087772">tlsState</span><span class="op" id="3087780">.</span><span class="ident" id="3087781">NegotiatedProtocol</span><span class="op" id="3087799">;</span>&nbsp;<span class="ident" id="3087801">validNPN</span><span class="op" id="3087809">(</span><span class="ident" id="3087810">proto</span><span class="op" id="3087815">)</span>&nbsp;<span class="op" id="3087817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087822">if</span>&nbsp;<span class="ident" id="3087825">fn</span>&nbsp;<span class="op" id="3087828">:=</span>&nbsp;<span class="ident" id="3087831">c</span><span class="op" id="3087832">.</span><span class="ident" id="3087833">server</span><span class="op" id="3087839">.</span><span class="ident" id="3087840">TLSNextProto</span><span class="op" id="3087852">[</span><span class="ident" id="3087853">proto</span><span class="op" id="3087858">]</span><span class="op" id="3087859">;</span>&nbsp;<span class="ident" id="3087861">fn</span>&nbsp;<span class="op" id="3087864">!=</span>&nbsp;<span class="ident" id="3087867">nil</span>&nbsp;<span class="op" id="3087871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087877">h</span>&nbsp;<span class="op" id="3087879">:=</span>&nbsp;<span class="ident" id="3087882">initNPNRequest</span><span class="op" id="3087896">{</span><span class="ident" id="3087897">tlsConn</span><span class="op" id="3087904">,</span>&nbsp;<span class="ident" id="3087906">serverHandler</span><span class="op" id="3087919">{</span><span class="ident" id="3087920">c</span><span class="op" id="3087921">.</span><span class="ident" id="3087922">server</span><span class="op" id="3087928">}</span><span class="op" id="3087929">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087935">fn</span><span class="op" id="3087937">(</span><span class="ident" id="3087938">c</span><span class="op" id="3087939">.</span><span class="ident" id="3087940">server</span><span class="op" id="3087946">,</span>&nbsp;<span class="ident" id="3087948">tlsConn</span><span class="op" id="3087955">,</span>&nbsp;<span class="ident" id="3087957">h</span><span class="op" id="3087958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087968">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3087980">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3087984">for</span>&nbsp;<span class="op" id="3087988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3087992">w</span><span class="op" id="3087993">,</span>&nbsp;<span class="ident" id="3087995">err</span>&nbsp;<span class="op" id="3087999">:=</span>&nbsp;<span class="ident" id="3088002">c</span><span class="op" id="3088003">.</span><span class="ident" id="3088004">readRequest</span><span class="op" id="3088015">(</span><span class="op" id="3088016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088020">if</span>&nbsp;<span class="ident" id="3088023">c</span><span class="op" id="3088024">.</span><span class="ident" id="3088025">lr</span><span class="op" id="3088027">.</span><span class="ident" id="3088028">N</span>&nbsp;<span class="op" id="3088030">!=</span>&nbsp;<span class="ident" id="3088033">c</span><span class="op" id="3088034">.</span><span class="ident" id="3088035">server</span><span class="op" id="3088041">.</span><span class="ident" id="3088042">initialLimitedReaderSize</span><span class="op" id="3088066">(</span><span class="op" id="3088067">)</span>&nbsp;<span class="op" id="3088069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088074">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088129">c</span><span class="op" id="3088130">.</span><span class="ident" id="3088131">setState</span><span class="op" id="3088139">(</span><span class="ident" id="3088140">c</span><span class="op" id="3088141">.</span><span class="ident" id="3088142">rwc</span><span class="op" id="3088145">,</span>&nbsp;<span class="ident" id="3088147">StateActive</span><span class="op" id="3088158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088166">if</span>&nbsp;<span class="ident" id="3088169">err</span>&nbsp;<span class="op" id="3088173">!=</span>&nbsp;<span class="ident" id="3088176">nil</span>&nbsp;<span class="op" id="3088180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088185">if</span>&nbsp;<span class="ident" id="3088188">err</span>&nbsp;<span class="op" id="3088192">==</span>&nbsp;<span class="ident" id="3088195">errTooLarge</span>&nbsp;<span class="op" id="3088207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088213">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088256">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088290">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088331">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088372">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088409">io</span><span class="op" id="3088411">.</span><span class="ident" id="3088412">WriteString</span><span class="op" id="3088423">(</span><span class="ident" id="3088424">c</span><span class="op" id="3088425">.</span><span class="ident" id="3088426">rwc</span><span class="op" id="3088429">,</span>&nbsp;<span class="string" id="3088431">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3088478">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088484">c</span><span class="op" id="3088485">.</span><span class="ident" id="3088486">closeWriteAndWait</span><span class="op" id="3088503">(</span><span class="op" id="3088504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088510">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088519">}</span>&nbsp;<span class="keyword" id="3088521">else</span>&nbsp;<span class="keyword" id="3088526">if</span>&nbsp;<span class="ident" id="3088529">err</span>&nbsp;<span class="op" id="3088533">==</span>&nbsp;<span class="ident" id="3088536">io</span><span class="op" id="3088538">.</span><span class="ident" id="3088539">EOF</span>&nbsp;<span class="op" id="3088543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088549">break</span>&nbsp;<span class="comment" id="3088555">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088573">}</span>&nbsp;<span class="keyword" id="3088575">else</span>&nbsp;<span class="keyword" id="3088580">if</span>&nbsp;<span class="ident" id="3088583">neterr</span><span class="op" id="3088589">,</span>&nbsp;<span class="ident" id="3088591">ok</span>&nbsp;<span class="op" id="3088594">:=</span>&nbsp;<span class="ident" id="3088597">err</span><span class="op" id="3088600">.</span><span class="op" id="3088601">(</span><span class="ident" id="3088602">net</span><span class="op" id="3088605">.</span><span class="ident" id="3088606">Error</span><span class="op" id="3088611">)</span><span class="op" id="3088612">;</span>&nbsp;<span class="ident" id="3088614">ok</span>&nbsp;<span class="op" id="3088617">&amp;&amp;</span>&nbsp;<span class="ident" id="3088620">neterr</span><span class="op" id="3088626">.</span><span class="ident" id="3088627">Timeout</span><span class="op" id="3088634">(</span><span class="op" id="3088635">)</span>&nbsp;<span class="op" id="3088637">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088643">break</span>&nbsp;<span class="comment" id="3088649">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088672">io</span><span class="op" id="3088674">.</span><span class="ident" id="3088675">WriteString</span><span class="op" id="3088686">(</span><span class="ident" id="3088687">c</span><span class="op" id="3088688">.</span><span class="ident" id="3088689">rwc</span><span class="op" id="3088692">,</span>&nbsp;<span class="string" id="3088694">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3088728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088733">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3088741">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088746">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088779">req</span>&nbsp;<span class="op" id="3088783">:=</span>&nbsp;<span class="ident" id="3088786">w</span><span class="op" id="3088787">.</span><span class="ident" id="3088788">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088794">if</span>&nbsp;<span class="ident" id="3088797">req</span><span class="op" id="3088800">.</span><span class="ident" id="3088801">expectsContinue</span><span class="op" id="3088816">(</span><span class="op" id="3088817">)</span>&nbsp;<span class="op" id="3088819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3088824">if</span>&nbsp;<span class="ident" id="3088827">req</span><span class="op" id="3088830">.</span><span class="ident" id="3088831">ProtoAtLeast</span><span class="op" id="3088843">(</span><span class="num" id="3088844">1</span><span class="op" id="3088845">,</span>&nbsp;<span class="num" id="3088847">1</span><span class="op" id="3088848">)</span>&nbsp;<span class="op" id="3088850">&amp;&amp;</span>&nbsp;<span class="ident" id="3088853">req</span><span class="op" id="3088856">.</span><span class="ident" id="3088857">ContentLength</span>&nbsp;<span class="op" id="3088871">!=</span>&nbsp;<span class="num" id="3088874">0</span>&nbsp;<span class="op" id="3088876">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3088882">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3088950">req</span><span class="op" id="3088953">.</span><span class="ident" id="3088954">Body</span>&nbsp;<span class="op" id="3088959">=</span>&nbsp;<span class="op" id="3088961">&amp;</span><span class="ident" id="3088962">expectContinueReader</span><span class="op" id="3088982">{</span><span class="ident" id="3088983">readCloser</span><span class="op" id="3088993">:</span>&nbsp;<span class="ident" id="3088995">req</span><span class="op" id="3088998">.</span><span class="ident" id="3088999">Body</span><span class="op" id="3089003">,</span>&nbsp;<span class="ident" id="3089005">resp</span><span class="op" id="3089009">:</span>&nbsp;<span class="ident" id="3089011">w</span><span class="op" id="3089012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089022">req</span><span class="op" id="3089025">.</span><span class="ident" id="3089026">Header</span><span class="op" id="3089032">.</span><span class="ident" id="3089033">Del</span><span class="op" id="3089036">(</span><span class="string" id="3089037">&#34;Expect&#34;</span><span class="op" id="3089045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089049">}</span>&nbsp;<span class="keyword" id="3089051">else</span>&nbsp;<span class="keyword" id="3089056">if</span>&nbsp;<span class="ident" id="3089059">req</span><span class="op" id="3089062">.</span><span class="ident" id="3089063">Header</span><span class="op" id="3089069">.</span><span class="ident" id="3089070">get</span><span class="op" id="3089073">(</span><span class="string" id="3089074">&#34;Expect&#34;</span><span class="op" id="3089082">)</span>&nbsp;<span class="op" id="3089084">!=</span>&nbsp;<span class="string" id="3089087">&#34;&#34;</span>&nbsp;<span class="op" id="3089090">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089095">w</span><span class="op" id="3089096">.</span><span class="ident" id="3089097">sendExpectationFailed</span><span class="op" id="3089118">(</span><span class="op" id="3089119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089124">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089137">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089201">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089271">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089331">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089407">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089471">serverHandler</span><span class="op" id="3089484">{</span><span class="ident" id="3089485">c</span><span class="op" id="3089486">.</span><span class="ident" id="3089487">server</span><span class="op" id="3089493">}</span><span class="op" id="3089494">.</span><span class="ident" id="3089495">ServeHTTP</span><span class="op" id="3089504">(</span><span class="ident" id="3089505">w</span><span class="op" id="3089506">,</span>&nbsp;<span class="ident" id="3089508">w</span><span class="op" id="3089509">.</span><span class="ident" id="3089510">req</span><span class="op" id="3089513">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089517">if</span>&nbsp;<span class="ident" id="3089520">c</span><span class="op" id="3089521">.</span><span class="ident" id="3089522">hijacked</span><span class="op" id="3089530">(</span><span class="op" id="3089531">)</span>&nbsp;<span class="op" id="3089533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089538">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089551">w</span><span class="op" id="3089552">.</span><span class="ident" id="3089553">finishRequest</span><span class="op" id="3089566">(</span><span class="op" id="3089567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089571">if</span>&nbsp;<span class="ident" id="3089574">w</span><span class="op" id="3089575">.</span><span class="ident" id="3089576">closeAfterReply</span>&nbsp;<span class="op" id="3089592">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089597">if</span>&nbsp;<span class="ident" id="3089600">w</span><span class="op" id="3089601">.</span><span class="ident" id="3089602">requestBodyLimitHit</span>&nbsp;<span class="op" id="3089622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089628">c</span><span class="op" id="3089629">.</span><span class="ident" id="3089630">closeWriteAndWait</span><span class="op" id="3089647">(</span><span class="op" id="3089648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3089658">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089666">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3089670">c</span><span class="op" id="3089671">.</span><span class="ident" id="3089672">setState</span><span class="op" id="3089680">(</span><span class="ident" id="3089681">c</span><span class="op" id="3089682">.</span><span class="ident" id="3089683">rwc</span><span class="op" id="3089686">,</span>&nbsp;<span class="ident" id="3089688">StateIdle</span><span class="op" id="3089697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3089700">}</span><br>
<span class="lineno"></span><span class="op" id="3089702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3089705">func</span>&nbsp;<span class="op" id="3089710">(</span><span class="ident" id="3089711">w</span>&nbsp;<span class="op" id="3089713">*</span><span class="ident" id="3089714">response</span><span class="op" id="3089722">)</span>&nbsp;<span class="ident" id="3089724">sendExpectationFailed</span><span class="op" id="3089745">(</span><span class="op" id="3089746">)</span>&nbsp;<span class="op" id="3089748">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089751">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089801">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089854">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089904">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089954">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3089994">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090038">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090042">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090096">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090146">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090193">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090241">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090294">w</span><span class="op" id="3090295">.</span><span class="ident" id="3090296">Header</span><span class="op" id="3090302">(</span><span class="op" id="3090303">)</span><span class="op" id="3090304">.</span><span class="ident" id="3090305">Set</span><span class="op" id="3090308">(</span><span class="string" id="3090309">&#34;Connection&#34;</span><span class="op" id="3090321">,</span>&nbsp;<span class="string" id="3090323">&#34;close&#34;</span><span class="op" id="3090330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090333">w</span><span class="op" id="3090334">.</span><span class="ident" id="3090335">WriteHeader</span><span class="op" id="3090346">(</span><span class="ident" id="3090347">StatusExpectationFailed</span><span class="op" id="3090370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090373">w</span><span class="op" id="3090374">.</span><span class="ident" id="3090375">finishRequest</span><span class="op" id="3090388">(</span><span class="op" id="3090389">)</span><br>
<span class="lineno">1235</span><span class="op" id="3090391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3090394">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3090481">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3090500">func</span>&nbsp;<span class="op" id="3090505">(</span><span class="ident" id="3090506">w</span>&nbsp;<span class="op" id="3090508">*</span><span class="ident" id="3090509">response</span><span class="op" id="3090517">)</span>&nbsp;<span class="ident" id="3090519">Hijack</span><span class="op" id="3090525">(</span><span class="op" id="3090526">)</span>&nbsp;<span class="op" id="3090528">(</span><span class="ident" id="3090529">rwc</span>&nbsp;<span class="ident" id="3090533">net</span><span class="op" id="3090536">.</span><span class="ident" id="3090537">Conn</span><span class="op" id="3090541">,</span>&nbsp;<span class="ident" id="3090543">buf</span>&nbsp;<span class="op" id="3090547">*</span><span class="ident" id="3090548">bufio</span><span class="op" id="3090553">.</span><span class="ident" id="3090554">ReadWriter</span><span class="op" id="3090564">,</span>&nbsp;<span class="ident" id="3090566">err</span>&nbsp;<span class="builtintype" id="3090570">error</span><span class="op" id="3090575">)</span>&nbsp;<span class="op" id="3090577">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090580">if</span>&nbsp;<span class="ident" id="3090583">w</span><span class="op" id="3090584">.</span><span class="ident" id="3090585">wroteHeader</span>&nbsp;<span class="op" id="3090597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090601">w</span><span class="op" id="3090602">.</span><span class="ident" id="3090603">cw</span><span class="op" id="3090605">.</span><span class="ident" id="3090606">flush</span><span class="op" id="3090611">(</span><span class="op" id="3090612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3090615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090618">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3090689">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090736">rwc</span><span class="op" id="3090739">,</span>&nbsp;<span class="ident" id="3090741">buf</span><span class="op" id="3090744">,</span>&nbsp;<span class="ident" id="3090746">err</span>&nbsp;<span class="op" id="3090750">=</span>&nbsp;<span class="ident" id="3090752">w</span><span class="op" id="3090753">.</span><span class="ident" id="3090754">conn</span><span class="op" id="3090758">.</span><span class="ident" id="3090759">hijack</span><span class="op" id="3090765">(</span><span class="op" id="3090766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090769">if</span>&nbsp;<span class="ident" id="3090772">err</span>&nbsp;<span class="op" id="3090776">==</span>&nbsp;<span class="ident" id="3090779">nil</span>&nbsp;<span class="op" id="3090783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090787">putBufioWriter</span><span class="op" id="3090801">(</span><span class="ident" id="3090802">w</span><span class="op" id="3090803">.</span><span class="ident" id="3090804">w</span><span class="op" id="3090805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3090809">w</span><span class="op" id="3090810">.</span><span class="ident" id="3090811">w</span>&nbsp;<span class="op" id="3090813">=</span>&nbsp;<span class="ident" id="3090815">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3090820">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090823">return</span>&nbsp;<span class="ident" id="3090830">rwc</span><span class="op" id="3090833">,</span>&nbsp;<span class="ident" id="3090835">buf</span><span class="op" id="3090838">,</span>&nbsp;<span class="ident" id="3090840">err</span><br>
<span class="lineno"></span><span class="op" id="3090844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3090847">func</span>&nbsp;<span class="op" id="3090852">(</span><span class="ident" id="3090853">w</span>&nbsp;<span class="op" id="3090855">*</span><span class="ident" id="3090856">response</span><span class="op" id="3090864">)</span>&nbsp;<span class="ident" id="3090866">CloseNotify</span><span class="op" id="3090877">(</span><span class="op" id="3090878">)</span>&nbsp;<span class="op" id="3090880">&lt;-</span><span class="keyword" id="3090882">chan</span>&nbsp;<span class="builtintype" id="3090887">bool</span>&nbsp;<span class="op" id="3090892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3090895">return</span>&nbsp;<span class="ident" id="3090902">w</span><span class="op" id="3090903">.</span><span class="ident" id="3090904">conn</span><span class="op" id="3090908">.</span><span class="ident" id="3090909">closeNotify</span><span class="op" id="3090920">(</span><span class="op" id="3090921">)</span><br>
<span class="lineno">1255</span><span class="op" id="3090923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3090926">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3090984">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3091044">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3091099">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3091131">type</span>&nbsp;<span class="ident" id="3091136">HandlerFunc</span>&nbsp;<span class="keyword" id="3091148">func</span><span class="op" id="3091152">(</span><span class="ident" id="3091153">ResponseWriter</span><span class="op" id="3091167">,</span>&nbsp;<span class="op" id="3091169">*</span><span class="ident" id="3091170">Request</span><span class="op" id="3091177">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3091180">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3091208">func</span>&nbsp;<span class="op" id="3091213">(</span><span class="ident" id="3091214">f</span>&nbsp;<span class="ident" id="3091216">HandlerFunc</span><span class="op" id="3091227">)</span>&nbsp;<span class="ident" id="3091229">ServeHTTP</span><span class="op" id="3091238">(</span><span class="ident" id="3091239">w</span>&nbsp;<span class="ident" id="3091241">ResponseWriter</span><span class="op" id="3091255">,</span>&nbsp;<span class="ident" id="3091257">r</span>&nbsp;<span class="op" id="3091259">*</span><span class="ident" id="3091260">Request</span><span class="op" id="3091267">)</span>&nbsp;<span class="op" id="3091269">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091272">f</span><span class="op" id="3091273">(</span><span class="ident" id="3091274">w</span><span class="op" id="3091275">,</span>&nbsp;<span class="ident" id="3091277">r</span><span class="op" id="3091278">)</span><br>
<span class="lineno"></span><span class="op" id="3091280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3091283">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3091303">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3091383">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3091426">func</span>&nbsp;<span class="ident" id="3091431">Error</span><span class="op" id="3091436">(</span><span class="ident" id="3091437">w</span>&nbsp;<span class="ident" id="3091439">ResponseWriter</span><span class="op" id="3091453">,</span>&nbsp;<span class="builtintype" id="3091455">error</span>&nbsp;<span class="builtintype" id="3091461">string</span><span class="op" id="3091467">,</span>&nbsp;<span class="ident" id="3091469">code</span>&nbsp;<span class="builtintype" id="3091474">int</span><span class="op" id="3091477">)</span>&nbsp;<span class="op" id="3091479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091482">w</span><span class="op" id="3091483">.</span><span class="ident" id="3091484">Header</span><span class="op" id="3091490">(</span><span class="op" id="3091491">)</span><span class="op" id="3091492">.</span><span class="ident" id="3091493">Set</span><span class="op" id="3091496">(</span><span class="string" id="3091497">&#34;Content-Type&#34;</span><span class="op" id="3091511">,</span>&nbsp;<span class="string" id="3091513">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3091540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091543">w</span><span class="op" id="3091544">.</span><span class="ident" id="3091545">WriteHeader</span><span class="op" id="3091556">(</span><span class="ident" id="3091557">code</span><span class="op" id="3091561">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3091564">fmt</span><span class="op" id="3091567">.</span><span class="ident" id="3091568">Fprintln</span><span class="op" id="3091576">(</span><span class="ident" id="3091577">w</span><span class="op" id="3091578">,</span>&nbsp;<span class="builtintype" id="3091580">error</span><span class="op" id="3091585">)</span><br>
<span class="lineno"></span><span class="op" id="3091587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3091590">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3091659">func</span>&nbsp;<span class="ident" id="3091664">NotFound</span><span class="op" id="3091672">(</span><span class="ident" id="3091673">w</span>&nbsp;<span class="ident" id="3091675">ResponseWriter</span><span class="op" id="3091689">,</span>&nbsp;<span class="ident" id="3091691">r</span>&nbsp;<span class="op" id="3091693">*</span><span class="ident" id="3091694">Request</span><span class="op" id="3091701">)</span>&nbsp;<span class="op" id="3091703">{</span>&nbsp;<span class="ident" id="3091705">Error</span><span class="op" id="3091710">(</span><span class="ident" id="3091711">w</span><span class="op" id="3091712">,</span>&nbsp;<span class="string" id="3091714">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3091734">,</span>&nbsp;<span class="ident" id="3091736">StatusNotFound</span><span class="op" id="3091750">)</span>&nbsp;<span class="op" id="3091752">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3091755">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3091807">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3091876">func</span>&nbsp;<span class="ident" id="3091881">NotFoundHandler</span><span class="op" id="3091896">(</span><span class="op" id="3091897">)</span>&nbsp;<span class="ident" id="3091899">Handler</span>&nbsp;<span class="op" id="3091907">{</span>&nbsp;<span class="keyword" id="3091909">return</span>&nbsp;<span class="ident" id="3091916">HandlerFunc</span><span class="op" id="3091927">(</span><span class="ident" id="3091928">NotFound</span><span class="op" id="3091936">)</span>&nbsp;<span class="op" id="3091938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3091941">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3092000">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3092060">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3092113">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3092169">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3092215">func</span>&nbsp;<span class="ident" id="3092220">StripPrefix</span><span class="op" id="3092231">(</span><span class="ident" id="3092232">prefix</span>&nbsp;<span class="builtintype" id="3092239">string</span><span class="op" id="3092245">,</span>&nbsp;<span class="ident" id="3092247">h</span>&nbsp;<span class="ident" id="3092249">Handler</span><span class="op" id="3092256">)</span>&nbsp;<span class="ident" id="3092258">Handler</span>&nbsp;<span class="op" id="3092266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092269">if</span>&nbsp;<span class="ident" id="3092272">prefix</span>&nbsp;<span class="op" id="3092279">==</span>&nbsp;<span class="string" id="3092282">&#34;&#34;</span>&nbsp;<span class="op" id="3092285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092289">return</span>&nbsp;<span class="ident" id="3092296">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092302">return</span>&nbsp;<span class="ident" id="3092309">HandlerFunc</span><span class="op" id="3092320">(</span><span class="keyword" id="3092321">func</span><span class="op" id="3092325">(</span><span class="ident" id="3092326">w</span>&nbsp;<span class="ident" id="3092328">ResponseWriter</span><span class="op" id="3092342">,</span>&nbsp;<span class="ident" id="3092344">r</span>&nbsp;<span class="op" id="3092346">*</span><span class="ident" id="3092347">Request</span><span class="op" id="3092354">)</span>&nbsp;<span class="op" id="3092356">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092360">if</span>&nbsp;<span class="ident" id="3092363">p</span>&nbsp;<span class="op" id="3092365">:=</span>&nbsp;<span class="ident" id="3092368">strings</span><span class="op" id="3092375">.</span><span class="ident" id="3092376">TrimPrefix</span><span class="op" id="3092386">(</span><span class="ident" id="3092387">r</span><span class="op" id="3092388">.</span><span class="ident" id="3092389">URL</span><span class="op" id="3092392">.</span><span class="ident" id="3092393">Path</span><span class="op" id="3092397">,</span>&nbsp;<span class="ident" id="3092399">prefix</span><span class="op" id="3092405">)</span><span class="op" id="3092406">;</span>&nbsp;<span class="builtinfunc" id="3092408">len</span><span class="op" id="3092411">(</span><span class="ident" id="3092412">p</span><span class="op" id="3092413">)</span>&nbsp;<span class="op" id="3092415">&lt;</span>&nbsp;<span class="builtinfunc" id="3092417">len</span><span class="op" id="3092420">(</span><span class="ident" id="3092421">r</span><span class="op" id="3092422">.</span><span class="ident" id="3092423">URL</span><span class="op" id="3092426">.</span><span class="ident" id="3092427">Path</span><span class="op" id="3092431">)</span>&nbsp;<span class="op" id="3092433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092438">r</span><span class="op" id="3092439">.</span><span class="ident" id="3092440">URL</span><span class="op" id="3092443">.</span><span class="ident" id="3092444">Path</span>&nbsp;<span class="op" id="3092449">=</span>&nbsp;<span class="ident" id="3092451">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092456">h</span><span class="op" id="3092457">.</span><span class="ident" id="3092458">ServeHTTP</span><span class="op" id="3092467">(</span><span class="ident" id="3092468">w</span><span class="op" id="3092469">,</span>&nbsp;<span class="ident" id="3092471">r</span><span class="op" id="3092472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092476">}</span>&nbsp;<span class="keyword" id="3092478">else</span>&nbsp;<span class="op" id="3092483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3092488">NotFound</span><span class="op" id="3092496">(</span><span class="ident" id="3092497">w</span><span class="op" id="3092498">,</span>&nbsp;<span class="ident" id="3092500">r</span><span class="op" id="3092501">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3092508">}</span><span class="op" id="3092509">)</span><br>
<span class="lineno"></span><span class="op" id="3092511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3092514">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3092573">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3092626">func</span>&nbsp;<span class="ident" id="3092631">Redirect</span><span class="op" id="3092639">(</span><span class="ident" id="3092640">w</span>&nbsp;<span class="ident" id="3092642">ResponseWriter</span><span class="op" id="3092656">,</span>&nbsp;<span class="ident" id="3092658">r</span>&nbsp;<span class="op" id="3092660">*</span><span class="ident" id="3092661">Request</span><span class="op" id="3092668">,</span>&nbsp;<span class="ident" id="3092670">urlStr</span>&nbsp;<span class="builtintype" id="3092677">string</span><span class="op" id="3092683">,</span>&nbsp;<span class="ident" id="3092685">code</span>&nbsp;<span class="builtintype" id="3092690">int</span><span class="op" id="3092693">)</span>&nbsp;<span class="op" id="3092695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3092698">if</span>&nbsp;<span class="ident" id="3092701">u</span><span class="op" id="3092702">,</span>&nbsp;<span class="ident" id="3092704">err</span>&nbsp;<span class="op" id="3092708">:=</span>&nbsp;<span class="ident" id="3092711">url</span><span class="op" id="3092714">.</span><span class="ident" id="3092715">Parse</span><span class="op" id="3092720">(</span><span class="ident" id="3092721">urlStr</span><span class="op" id="3092727">)</span><span class="op" id="3092728">;</span>&nbsp;<span class="ident" id="3092730">err</span>&nbsp;<span class="op" id="3092734">==</span>&nbsp;<span class="ident" id="3092737">nil</span>&nbsp;<span class="op" id="3092741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3092745">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3092788">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3092822">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3092870">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3092917">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3092965">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093005">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093045">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093080">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093122">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093167">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093215">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093262">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093314">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093367">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093382">oldpath</span>&nbsp;<span class="op" id="3093390">:=</span>&nbsp;<span class="ident" id="3093393">r</span><span class="op" id="3093394">.</span><span class="ident" id="3093395">URL</span><span class="op" id="3093398">.</span><span class="ident" id="3093399">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093406">if</span>&nbsp;<span class="ident" id="3093409">oldpath</span>&nbsp;<span class="op" id="3093417">==</span>&nbsp;<span class="string" id="3093420">&#34;&#34;</span>&nbsp;<span class="op" id="3093423">{</span>&nbsp;<span class="comment" id="3093425">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093479">oldpath</span>&nbsp;<span class="op" id="3093487">=</span>&nbsp;<span class="string" id="3093489">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093499">if</span>&nbsp;<span class="ident" id="3093502">u</span><span class="op" id="3093503">.</span><span class="ident" id="3093504">Scheme</span>&nbsp;<span class="op" id="3093511">==</span>&nbsp;<span class="string" id="3093514">&#34;&#34;</span>&nbsp;<span class="op" id="3093517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093522">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093553">if</span>&nbsp;<span class="ident" id="3093556">urlStr</span>&nbsp;<span class="op" id="3093563">==</span>&nbsp;<span class="string" id="3093566">&#34;&#34;</span>&nbsp;<span class="op" id="3093569">||</span>&nbsp;<span class="ident" id="3093572">urlStr</span><span class="op" id="3093578">[</span><span class="num" id="3093579">0</span><span class="op" id="3093580">]</span>&nbsp;<span class="op" id="3093582">!=</span>&nbsp;<span class="string" id="3093585">&#39;/&#39;</span>&nbsp;<span class="op" id="3093589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093595">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093630">olddir</span><span class="op" id="3093636">,</span>&nbsp;<span class="ident" id="3093638">_</span>&nbsp;<span class="op" id="3093640">:=</span>&nbsp;<span class="ident" id="3093643">path</span><span class="op" id="3093647">.</span><span class="ident" id="3093648">Split</span><span class="op" id="3093653">(</span><span class="ident" id="3093654">oldpath</span><span class="op" id="3093661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093667">urlStr</span>&nbsp;<span class="op" id="3093674">=</span>&nbsp;<span class="ident" id="3093676">olddir</span>&nbsp;<span class="op" id="3093683">+</span>&nbsp;<span class="ident" id="3093685">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093695">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093701">var</span>&nbsp;<span class="ident" id="3093705">query</span>&nbsp;<span class="builtintype" id="3093711">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093721">if</span>&nbsp;<span class="ident" id="3093724">i</span>&nbsp;<span class="op" id="3093726">:=</span>&nbsp;<span class="ident" id="3093729">strings</span><span class="op" id="3093736">.</span><span class="ident" id="3093737">Index</span><span class="op" id="3093742">(</span><span class="ident" id="3093743">urlStr</span><span class="op" id="3093749">,</span>&nbsp;<span class="string" id="3093751">&#34;?&#34;</span><span class="op" id="3093754">)</span><span class="op" id="3093755">;</span>&nbsp;<span class="ident" id="3093757">i</span>&nbsp;<span class="op" id="3093759">!=</span>&nbsp;<span class="op" id="3093762">-</span><span class="num" id="3093763">1</span>&nbsp;<span class="op" id="3093765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093771">urlStr</span><span class="op" id="3093777">,</span>&nbsp;<span class="ident" id="3093779">query</span>&nbsp;<span class="op" id="3093785">=</span>&nbsp;<span class="ident" id="3093787">urlStr</span><span class="op" id="3093793">[</span><span class="op" id="3093794">:</span><span class="ident" id="3093795">i</span><span class="op" id="3093796">]</span><span class="op" id="3093797">,</span>&nbsp;<span class="ident" id="3093799">urlStr</span><span class="op" id="3093805">[</span><span class="ident" id="3093806">i</span><span class="op" id="3093807">:</span><span class="op" id="3093808">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3093813">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3093819">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093862">trailing</span>&nbsp;<span class="op" id="3093871">:=</span>&nbsp;<span class="ident" id="3093874">strings</span><span class="op" id="3093881">.</span><span class="ident" id="3093882">HasSuffix</span><span class="op" id="3093891">(</span><span class="ident" id="3093892">urlStr</span><span class="op" id="3093898">,</span>&nbsp;<span class="string" id="3093900">&#34;/&#34;</span><span class="op" id="3093903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093908">urlStr</span>&nbsp;<span class="op" id="3093915">=</span>&nbsp;<span class="ident" id="3093917">path</span><span class="op" id="3093921">.</span><span class="ident" id="3093922">Clean</span><span class="op" id="3093927">(</span><span class="ident" id="3093928">urlStr</span><span class="op" id="3093934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3093939">if</span>&nbsp;<span class="ident" id="3093942">trailing</span>&nbsp;<span class="op" id="3093951">&amp;&amp;</span>&nbsp;<span class="op" id="3093954">!</span><span class="ident" id="3093955">strings</span><span class="op" id="3093962">.</span><span class="ident" id="3093963">HasSuffix</span><span class="op" id="3093972">(</span><span class="ident" id="3093973">urlStr</span><span class="op" id="3093979">,</span>&nbsp;<span class="string" id="3093981">&#34;/&#34;</span><span class="op" id="3093984">)</span>&nbsp;<span class="op" id="3093986">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3093992">urlStr</span>&nbsp;<span class="op" id="3093999">+=</span>&nbsp;<span class="string" id="3094002">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094014">urlStr</span>&nbsp;<span class="op" id="3094021">+=</span>&nbsp;<span class="ident" id="3094024">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094035">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094039">w</span><span class="op" id="3094040">.</span><span class="ident" id="3094041">Header</span><span class="op" id="3094047">(</span><span class="op" id="3094048">)</span><span class="op" id="3094049">.</span><span class="ident" id="3094050">Set</span><span class="op" id="3094053">(</span><span class="string" id="3094054">&#34;Location&#34;</span><span class="op" id="3094064">,</span>&nbsp;<span class="ident" id="3094066">urlStr</span><span class="op" id="3094072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094075">w</span><span class="op" id="3094076">.</span><span class="ident" id="3094077">WriteHeader</span><span class="op" id="3094088">(</span><span class="ident" id="3094089">code</span><span class="op" id="3094093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3094097">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3094166">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3094233">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094300">if</span>&nbsp;<span class="ident" id="3094303">r</span><span class="op" id="3094304">.</span><span class="ident" id="3094305">Method</span>&nbsp;<span class="op" id="3094312">==</span>&nbsp;<span class="string" id="3094315">&#34;GET&#34;</span>&nbsp;<span class="op" id="3094321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094325">note</span>&nbsp;<span class="op" id="3094330">:=</span>&nbsp;<span class="string" id="3094333">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3094346">+</span>&nbsp;<span class="ident" id="3094348">htmlEscape</span><span class="op" id="3094358">(</span><span class="ident" id="3094359">urlStr</span><span class="op" id="3094365">)</span>&nbsp;<span class="op" id="3094367">+</span>&nbsp;<span class="string" id="3094369">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3094375">+</span>&nbsp;<span class="ident" id="3094377">statusText</span><span class="op" id="3094387">[</span><span class="ident" id="3094388">code</span><span class="op" id="3094392">]</span>&nbsp;<span class="op" id="3094394">+</span>&nbsp;<span class="string" id="3094396">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094408">fmt</span><span class="op" id="3094411">.</span><span class="ident" id="3094412">Fprintln</span><span class="op" id="3094420">(</span><span class="ident" id="3094421">w</span><span class="op" id="3094422">,</span>&nbsp;<span class="ident" id="3094424">note</span><span class="op" id="3094428">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3094431">}</span><br>
<span class="lineno"></span><span class="op" id="3094433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3094436">var</span>&nbsp;<span class="ident" id="3094440">htmlReplacer</span>&nbsp;<span class="op" id="3094453">=</span>&nbsp;<span class="ident" id="3094455">strings</span><span class="op" id="3094462">.</span><span class="ident" id="3094463">NewReplacer</span><span class="op" id="3094474">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3094477">&#34;&amp;&#34;</span><span class="op" id="3094480">,</span>&nbsp;<span class="string" id="3094482">&#34;&amp;amp;&#34;</span><span class="op" id="3094489">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3094492">&#34;&lt;&#34;</span><span class="op" id="3094495">,</span>&nbsp;<span class="string" id="3094497">&#34;&amp;lt;&#34;</span><span class="op" id="3094503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3094506">&#34;&gt;&#34;</span><span class="op" id="3094509">,</span>&nbsp;<span class="string" id="3094511">&#34;&amp;gt;&#34;</span><span class="op" id="3094517">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3094520">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3094558">`&#34;`</span><span class="op" id="3094561">,</span>&nbsp;<span class="string" id="3094563">&#34;&amp;#34;&#34;</span><span class="op" id="3094570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3094573">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3094648">&#34;&#39;&#34;</span><span class="op" id="3094651">,</span>&nbsp;<span class="string" id="3094653">&#34;&amp;#39;&#34;</span><span class="op" id="3094660">,</span><br>
<span class="lineno"></span><span class="op" id="3094662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3094665">func</span>&nbsp;<span class="ident" id="3094670">htmlEscape</span><span class="op" id="3094680">(</span><span class="ident" id="3094681">s</span>&nbsp;<span class="builtintype" id="3094683">string</span><span class="op" id="3094689">)</span>&nbsp;<span class="builtintype" id="3094691">string</span>&nbsp;<span class="op" id="3094698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3094701">return</span>&nbsp;<span class="ident" id="3094708">htmlReplacer</span><span class="op" id="3094720">.</span><span class="ident" id="3094721">Replace</span><span class="op" id="3094728">(</span><span class="ident" id="3094729">s</span><span class="op" id="3094730">)</span><br>
<span class="lineno">1375</span><span class="op" id="3094732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3094735">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3094762">type</span>&nbsp;<span class="ident" id="3094767">redirectHandler</span>&nbsp;<span class="keyword" id="3094783">struct</span>&nbsp;<span class="op" id="3094790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094793">url</span>&nbsp;&nbsp;<span class="builtintype" id="3094798">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094806">code</span>&nbsp;<span class="builtintype" id="3094811">int</span><br>
<span class="lineno"></span><span class="op" id="3094815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3094818">func</span>&nbsp;<span class="op" id="3094823">(</span><span class="ident" id="3094824">rh</span>&nbsp;<span class="op" id="3094827">*</span><span class="ident" id="3094828">redirectHandler</span><span class="op" id="3094843">)</span>&nbsp;<span class="ident" id="3094845">ServeHTTP</span><span class="op" id="3094854">(</span><span class="ident" id="3094855">w</span>&nbsp;<span class="ident" id="3094857">ResponseWriter</span><span class="op" id="3094871">,</span>&nbsp;<span class="ident" id="3094873">r</span>&nbsp;<span class="op" id="3094875">*</span><span class="ident" id="3094876">Request</span><span class="op" id="3094883">)</span>&nbsp;<span class="op" id="3094885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3094888">Redirect</span><span class="op" id="3094896">(</span><span class="ident" id="3094897">w</span><span class="op" id="3094898">,</span>&nbsp;<span class="ident" id="3094900">r</span><span class="op" id="3094901">,</span>&nbsp;<span class="ident" id="3094903">rh</span><span class="op" id="3094905">.</span><span class="ident" id="3094906">url</span><span class="op" id="3094909">,</span>&nbsp;<span class="ident" id="3094911">rh</span><span class="op" id="3094913">.</span><span class="ident" id="3094914">code</span><span class="op" id="3094918">)</span><br>
<span class="lineno">1385</span><span class="op" id="3094920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3094923">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3094983">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3095044">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3095060">func</span>&nbsp;<span class="ident" id="3095065">RedirectHandler</span><span class="op" id="3095080">(</span><span class="ident" id="3095081">url</span>&nbsp;<span class="builtintype" id="3095085">string</span><span class="op" id="3095091">,</span>&nbsp;<span class="ident" id="3095093">code</span>&nbsp;<span class="builtintype" id="3095098">int</span><span class="op" id="3095101">)</span>&nbsp;<span class="ident" id="3095103">Handler</span>&nbsp;<span class="op" id="3095111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3095114">return</span>&nbsp;<span class="op" id="3095121">&amp;</span><span class="ident" id="3095122">redirectHandler</span><span class="op" id="3095137">{</span><span class="ident" id="3095138">url</span><span class="op" id="3095141">,</span>&nbsp;<span class="ident" id="3095143">code</span><span class="op" id="3095147">}</span><br>
<span class="lineno"></span><span class="op" id="3095149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3095152">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3095196">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3095272">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3095327">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3095360">//</span><br>
<span class="lineno"></span><span class="comment" id="3095363">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3095422">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3095488">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3095550">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3095606">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3095663">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3095723">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3095782">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3095805">//</span><br>
<span class="lineno"></span><span class="comment" id="3095808">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3095879">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3095948">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3095996">//</span><br>
<span class="lineno"></span><span class="comment" id="3095999">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3096073">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3096145">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3096220">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3096291">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3096333">//</span><br>
<span class="lineno"></span><span class="comment" id="3096336">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3096400">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3096461">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3096495">type</span>&nbsp;<span class="ident" id="3096500">ServeMux</span>&nbsp;<span class="keyword" id="3096509">struct</span>&nbsp;<span class="op" id="3096516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3096519">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3096525">sync</span><span class="op" id="3096529">.</span><span class="ident" id="3096530">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3096539">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096545">map</span><span class="op" id="3096548">[</span><span class="builtintype" id="3096549">string</span><span class="op" id="3096555">]</span><span class="ident" id="3096556">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3096566">hosts</span>&nbsp;<span class="builtintype" id="3096572">bool</span>&nbsp;<span class="comment" id="3096577">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3096619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3096622">type</span>&nbsp;<span class="ident" id="3096627">muxEntry</span>&nbsp;<span class="keyword" id="3096636">struct</span>&nbsp;<span class="op" id="3096643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3096646">explicit</span>&nbsp;<span class="builtintype" id="3096655">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3096661">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3096670">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3096679">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3096688">string</span><br>
<span class="lineno"></span><span class="op" id="3096695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3096698">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3096751">func</span>&nbsp;<span class="ident" id="3096756">NewServeMux</span><span class="op" id="3096767">(</span><span class="op" id="3096768">)</span>&nbsp;<span class="op" id="3096770">*</span><span class="ident" id="3096771">ServeMux</span>&nbsp;<span class="op" id="3096780">{</span>&nbsp;<span class="keyword" id="3096782">return</span>&nbsp;<span class="op" id="3096789">&amp;</span><span class="ident" id="3096790">ServeMux</span><span class="op" id="3096798">{</span><span class="ident" id="3096799">m</span><span class="op" id="3096800">:</span>&nbsp;<span class="builtinfunc" id="3096802">make</span><span class="op" id="3096806">(</span><span class="keyword" id="3096807">map</span><span class="op" id="3096810">[</span><span class="builtintype" id="3096811">string</span><span class="op" id="3096817">]</span><span class="ident" id="3096818">muxEntry</span><span class="op" id="3096826">)</span><span class="op" id="3096827">}</span>&nbsp;<span class="op" id="3096829">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3096832">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3096890">var</span>&nbsp;<span class="ident" id="3096894">DefaultServeMux</span>&nbsp;<span class="op" id="3096910">=</span>&nbsp;<span class="ident" id="3096912">NewServeMux</span><span class="op" id="3096923">(</span><span class="op" id="3096924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3096927">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3096955">func</span>&nbsp;<span class="ident" id="3096960">pathMatch</span><span class="op" id="3096969">(</span><span class="ident" id="3096970">pattern</span><span class="op" id="3096977">,</span>&nbsp;<span class="ident" id="3096979">path</span>&nbsp;<span class="builtintype" id="3096984">string</span><span class="op" id="3096990">)</span>&nbsp;<span class="builtintype" id="3096992">bool</span>&nbsp;<span class="op" id="3096997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097000">if</span>&nbsp;<span class="builtinfunc" id="3097003">len</span><span class="op" id="3097006">(</span><span class="ident" id="3097007">pattern</span><span class="op" id="3097014">)</span>&nbsp;<span class="op" id="3097016">==</span>&nbsp;<span class="num" id="3097019">0</span>&nbsp;<span class="op" id="3097021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3097025">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097048">return</span>&nbsp;<span class="builtintype" id="3097055">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3097062">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3097065">n</span>&nbsp;<span class="op" id="3097067">:=</span>&nbsp;<span class="builtinfunc" id="3097070">len</span><span class="op" id="3097073">(</span><span class="ident" id="3097074">pattern</span><span class="op" id="3097081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097084">if</span>&nbsp;<span class="ident" id="3097087">pattern</span><span class="op" id="3097094">[</span><span class="ident" id="3097095">n</span><span class="op" id="3097096">-</span><span class="num" id="3097097">1</span><span class="op" id="3097098">]</span>&nbsp;<span class="op" id="3097100">!=</span>&nbsp;<span class="string" id="3097103">&#39;/&#39;</span>&nbsp;<span class="op" id="3097107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097111">return</span>&nbsp;<span class="ident" id="3097118">pattern</span>&nbsp;<span class="op" id="3097126">==</span>&nbsp;<span class="ident" id="3097129">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3097135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097138">return</span>&nbsp;<span class="builtinfunc" id="3097145">len</span><span class="op" id="3097148">(</span><span class="ident" id="3097149">path</span><span class="op" id="3097153">)</span>&nbsp;<span class="op" id="3097155">&gt;=</span>&nbsp;<span class="ident" id="3097158">n</span>&nbsp;<span class="op" id="3097160">&amp;&amp;</span>&nbsp;<span class="ident" id="3097163">path</span><span class="op" id="3097167">[</span><span class="num" id="3097168">0</span><span class="op" id="3097169">:</span><span class="ident" id="3097170">n</span><span class="op" id="3097171">]</span>&nbsp;<span class="op" id="3097173">==</span>&nbsp;<span class="ident" id="3097176">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="3097184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3097187">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3097254">func</span>&nbsp;<span class="ident" id="3097259">cleanPath</span><span class="op" id="3097268">(</span><span class="ident" id="3097269">p</span>&nbsp;<span class="builtintype" id="3097271">string</span><span class="op" id="3097277">)</span>&nbsp;<span class="builtintype" id="3097279">string</span>&nbsp;<span class="op" id="3097286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097289">if</span>&nbsp;<span class="ident" id="3097292">p</span>&nbsp;<span class="op" id="3097294">==</span>&nbsp;<span class="string" id="3097297">&#34;&#34;</span>&nbsp;<span class="op" id="3097300">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097304">return</span>&nbsp;<span class="string" id="3097311">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3097316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097319">if</span>&nbsp;<span class="ident" id="3097322">p</span><span class="op" id="3097323">[</span><span class="num" id="3097324">0</span><span class="op" id="3097325">]</span>&nbsp;<span class="op" id="3097327">!=</span>&nbsp;<span class="string" id="3097330">&#39;/&#39;</span>&nbsp;<span class="op" id="3097334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3097338">p</span>&nbsp;<span class="op" id="3097340">=</span>&nbsp;<span class="string" id="3097342">&#34;/&#34;</span>&nbsp;<span class="op" id="3097346">+</span>&nbsp;<span class="ident" id="3097348">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3097351">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3097354">np</span>&nbsp;<span class="op" id="3097357">:=</span>&nbsp;<span class="ident" id="3097360">path</span><span class="op" id="3097364">.</span><span class="ident" id="3097365">Clean</span><span class="op" id="3097370">(</span><span class="ident" id="3097371">p</span><span class="op" id="3097372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3097375">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3097430">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097476">if</span>&nbsp;<span class="ident" id="3097479">p</span><span class="op" id="3097480">[</span><span class="builtinfunc" id="3097481">len</span><span class="op" id="3097484">(</span><span class="ident" id="3097485">p</span><span class="op" id="3097486">)</span><span class="op" id="3097487">-</span><span class="num" id="3097488">1</span><span class="op" id="3097489">]</span>&nbsp;<span class="op" id="3097491">==</span>&nbsp;<span class="string" id="3097494">&#39;/&#39;</span>&nbsp;<span class="op" id="3097498">&amp;&amp;</span>&nbsp;<span class="ident" id="3097501">np</span>&nbsp;<span class="op" id="3097504">!=</span>&nbsp;<span class="string" id="3097507">&#34;/&#34;</span>&nbsp;<span class="op" id="3097511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3097515">np</span>&nbsp;<span class="op" id="3097518">+=</span>&nbsp;<span class="string" id="3097521">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3097526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097529">return</span>&nbsp;<span class="ident" id="3097536">np</span><br>
<span class="lineno"></span><span class="op" id="3097539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3097542">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3097597">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3097637">func</span>&nbsp;<span class="op" id="3097642">(</span><span class="ident" id="3097643">mux</span>&nbsp;<span class="op" id="3097647">*</span><span class="ident" id="3097648">ServeMux</span><span class="op" id="3097656">)</span>&nbsp;<span class="ident" id="3097658">match</span><span class="op" id="3097663">(</span><span class="ident" id="3097664">path</span>&nbsp;<span class="builtintype" id="3097669">string</span><span class="op" id="3097675">)</span>&nbsp;<span class="op" id="3097677">(</span><span class="ident" id="3097678">h</span>&nbsp;<span class="ident" id="3097680">Handler</span><span class="op" id="3097687">,</span>&nbsp;<span class="ident" id="3097689">pattern</span>&nbsp;<span class="builtintype" id="3097697">string</span><span class="op" id="3097703">)</span>&nbsp;<span class="op" id="3097705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097708">var</span>&nbsp;<span class="ident" id="3097712">n</span>&nbsp;<span class="op" id="3097714">=</span>&nbsp;<span class="num" id="3097716">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097719">for</span>&nbsp;<span class="ident" id="3097723">k</span><span class="op" id="3097724">,</span>&nbsp;<span class="ident" id="3097726">v</span>&nbsp;<span class="op" id="3097728">:=</span>&nbsp;<span class="keyword" id="3097731">range</span>&nbsp;<span class="ident" id="3097737">mux</span><span class="op" id="3097740">.</span><span class="ident" id="3097741">m</span>&nbsp;<span class="op" id="3097743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097747">if</span>&nbsp;<span class="op" id="3097750">!</span><span class="ident" id="3097751">pathMatch</span><span class="op" id="3097760">(</span><span class="ident" id="3097761">k</span><span class="op" id="3097762">,</span>&nbsp;<span class="ident" id="3097764">path</span><span class="op" id="3097768">)</span>&nbsp;<span class="op" id="3097770">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097775">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3097786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097790">if</span>&nbsp;<span class="ident" id="3097793">h</span>&nbsp;<span class="op" id="3097795">==</span>&nbsp;<span class="ident" id="3097798">nil</span>&nbsp;<span class="op" id="3097802">||</span>&nbsp;<span class="builtinfunc" id="3097805">len</span><span class="op" id="3097808">(</span><span class="ident" id="3097809">k</span><span class="op" id="3097810">)</span>&nbsp;<span class="op" id="3097812">&gt;</span>&nbsp;<span class="ident" id="3097814">n</span>&nbsp;<span class="op" id="3097816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3097821">n</span>&nbsp;<span class="op" id="3097823">=</span>&nbsp;<span class="builtinfunc" id="3097825">len</span><span class="op" id="3097828">(</span><span class="ident" id="3097829">k</span><span class="op" id="3097830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3097835">h</span>&nbsp;<span class="op" id="3097837">=</span>&nbsp;<span class="ident" id="3097839">v</span><span class="op" id="3097840">.</span><span class="ident" id="3097841">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3097846">pattern</span>&nbsp;<span class="op" id="3097854">=</span>&nbsp;<span class="ident" id="3097856">v</span><span class="op" id="3097857">.</span><span class="ident" id="3097858">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3097868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3097871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3097874">return</span><br>
<span class="lineno"></span><span class="op" id="3097881">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3097884">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3097945">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3098011">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3098079">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3098145">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3098171">//</span><br>
<span class="lineno"></span><span class="comment" id="3098174">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3098238">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3098300">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3098361">//</span><br>
<span class="lineno"></span><span class="comment" id="3098364">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3098430">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3098500">func</span>&nbsp;<span class="op" id="3098505">(</span><span class="ident" id="3098506">mux</span>&nbsp;<span class="op" id="3098510">*</span><span class="ident" id="3098511">ServeMux</span><span class="op" id="3098519">)</span>&nbsp;<span class="ident" id="3098521">Handler</span><span class="op" id="3098528">(</span><span class="ident" id="3098529">r</span>&nbsp;<span class="op" id="3098531">*</span><span class="ident" id="3098532">Request</span><span class="op" id="3098539">)</span>&nbsp;<span class="op" id="3098541">(</span><span class="ident" id="3098542">h</span>&nbsp;<span class="ident" id="3098544">Handler</span><span class="op" id="3098551">,</span>&nbsp;<span class="ident" id="3098553">pattern</span>&nbsp;<span class="builtintype" id="3098561">string</span><span class="op" id="3098567">)</span>&nbsp;<span class="op" id="3098569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3098572">if</span>&nbsp;<span class="ident" id="3098575">r</span><span class="op" id="3098576">.</span><span class="ident" id="3098577">Method</span>&nbsp;<span class="op" id="3098584">!=</span>&nbsp;<span class="string" id="3098587">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3098597">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3098601">if</span>&nbsp;<span class="ident" id="3098604">p</span>&nbsp;<span class="op" id="3098606">:=</span>&nbsp;<span class="ident" id="3098609">cleanPath</span><span class="op" id="3098618">(</span><span class="ident" id="3098619">r</span><span class="op" id="3098620">.</span><span class="ident" id="3098621">URL</span><span class="op" id="3098624">.</span><span class="ident" id="3098625">Path</span><span class="op" id="3098629">)</span><span class="op" id="3098630">;</span>&nbsp;<span class="ident" id="3098632">p</span>&nbsp;<span class="op" id="3098634">!=</span>&nbsp;<span class="ident" id="3098637">r</span><span class="op" id="3098638">.</span><span class="ident" id="3098639">URL</span><span class="op" id="3098642">.</span><span class="ident" id="3098643">Path</span>&nbsp;<span class="op" id="3098648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098653">_</span><span class="op" id="3098654">,</span>&nbsp;<span class="ident" id="3098656">pattern</span>&nbsp;<span class="op" id="3098664">=</span>&nbsp;<span class="ident" id="3098666">mux</span><span class="op" id="3098669">.</span><span class="ident" id="3098670">handler</span><span class="op" id="3098677">(</span><span class="ident" id="3098678">r</span><span class="op" id="3098679">.</span><span class="ident" id="3098680">Host</span><span class="op" id="3098684">,</span>&nbsp;<span class="ident" id="3098686">p</span><span class="op" id="3098687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098692">url</span>&nbsp;<span class="op" id="3098696">:=</span>&nbsp;<span class="op" id="3098699">*</span><span class="ident" id="3098700">r</span><span class="op" id="3098701">.</span><span class="ident" id="3098702">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098709">url</span><span class="op" id="3098712">.</span><span class="ident" id="3098713">Path</span>&nbsp;<span class="op" id="3098718">=</span>&nbsp;<span class="ident" id="3098720">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3098725">return</span>&nbsp;<span class="ident" id="3098732">RedirectHandler</span><span class="op" id="3098747">(</span><span class="ident" id="3098748">url</span><span class="op" id="3098751">.</span><span class="ident" id="3098752">String</span><span class="op" id="3098758">(</span><span class="op" id="3098759">)</span><span class="op" id="3098760">,</span>&nbsp;<span class="ident" id="3098762">StatusMovedPermanently</span><span class="op" id="3098784">)</span><span class="op" id="3098785">,</span>&nbsp;<span class="ident" id="3098787">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3098797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3098800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3098804">return</span>&nbsp;<span class="ident" id="3098811">mux</span><span class="op" id="3098814">.</span><span class="ident" id="3098815">handler</span><span class="op" id="3098822">(</span><span class="ident" id="3098823">r</span><span class="op" id="3098824">.</span><span class="ident" id="3098825">Host</span><span class="op" id="3098829">,</span>&nbsp;<span class="ident" id="3098831">r</span><span class="op" id="3098832">.</span><span class="ident" id="3098833">URL</span><span class="op" id="3098836">.</span><span class="ident" id="3098837">Path</span><span class="op" id="3098841">)</span><br>
<span class="lineno"></span><span class="op" id="3098843">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3098846">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3098896">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3098970">func</span>&nbsp;<span class="op" id="3098975">(</span><span class="ident" id="3098976">mux</span>&nbsp;<span class="op" id="3098980">*</span><span class="ident" id="3098981">ServeMux</span><span class="op" id="3098989">)</span>&nbsp;<span class="ident" id="3098991">handler</span><span class="op" id="3098998">(</span><span class="ident" id="3098999">host</span><span class="op" id="3099003">,</span>&nbsp;<span class="ident" id="3099005">path</span>&nbsp;<span class="builtintype" id="3099010">string</span><span class="op" id="3099016">)</span>&nbsp;<span class="op" id="3099018">(</span><span class="ident" id="3099019">h</span>&nbsp;<span class="ident" id="3099021">Handler</span><span class="op" id="3099028">,</span>&nbsp;<span class="ident" id="3099030">pattern</span>&nbsp;<span class="builtintype" id="3099038">string</span><span class="op" id="3099044">)</span>&nbsp;<span class="op" id="3099046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099049">mux</span><span class="op" id="3099052">.</span><span class="ident" id="3099053">mu</span><span class="op" id="3099055">.</span><span class="ident" id="3099056">RLock</span><span class="op" id="3099061">(</span><span class="op" id="3099062">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099065">defer</span>&nbsp;<span class="ident" id="3099071">mux</span><span class="op" id="3099074">.</span><span class="ident" id="3099075">mu</span><span class="op" id="3099077">.</span><span class="ident" id="3099078">RUnlock</span><span class="op" id="3099085">(</span><span class="op" id="3099086">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3099090">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099151">if</span>&nbsp;<span class="ident" id="3099154">mux</span><span class="op" id="3099157">.</span><span class="ident" id="3099158">hosts</span>&nbsp;<span class="op" id="3099164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099168">h</span><span class="op" id="3099169">,</span>&nbsp;<span class="ident" id="3099171">pattern</span>&nbsp;<span class="op" id="3099179">=</span>&nbsp;<span class="ident" id="3099181">mux</span><span class="op" id="3099184">.</span><span class="ident" id="3099185">match</span><span class="op" id="3099190">(</span><span class="ident" id="3099191">host</span>&nbsp;<span class="op" id="3099196">+</span>&nbsp;<span class="ident" id="3099198">path</span><span class="op" id="3099202">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099208">if</span>&nbsp;<span class="ident" id="3099211">h</span>&nbsp;<span class="op" id="3099213">==</span>&nbsp;<span class="ident" id="3099216">nil</span>&nbsp;<span class="op" id="3099220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099224">h</span><span class="op" id="3099225">,</span>&nbsp;<span class="ident" id="3099227">pattern</span>&nbsp;<span class="op" id="3099235">=</span>&nbsp;<span class="ident" id="3099237">mux</span><span class="op" id="3099240">.</span><span class="ident" id="3099241">match</span><span class="op" id="3099246">(</span><span class="ident" id="3099247">path</span><span class="op" id="3099251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099257">if</span>&nbsp;<span class="ident" id="3099260">h</span>&nbsp;<span class="op" id="3099262">==</span>&nbsp;<span class="ident" id="3099265">nil</span>&nbsp;<span class="op" id="3099269">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099273">h</span><span class="op" id="3099274">,</span>&nbsp;<span class="ident" id="3099276">pattern</span>&nbsp;<span class="op" id="3099284">=</span>&nbsp;<span class="ident" id="3099286">NotFoundHandler</span><span class="op" id="3099301">(</span><span class="op" id="3099302">)</span><span class="op" id="3099303">,</span>&nbsp;<span class="string" id="3099305">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099312">return</span><br>
<span class="lineno"></span><span class="op" id="3099319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3099322">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3099379">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3099428">func</span>&nbsp;<span class="op" id="3099433">(</span><span class="ident" id="3099434">mux</span>&nbsp;<span class="op" id="3099438">*</span><span class="ident" id="3099439">ServeMux</span><span class="op" id="3099447">)</span>&nbsp;<span class="ident" id="3099449">ServeHTTP</span><span class="op" id="3099458">(</span><span class="ident" id="3099459">w</span>&nbsp;<span class="ident" id="3099461">ResponseWriter</span><span class="op" id="3099475">,</span>&nbsp;<span class="ident" id="3099477">r</span>&nbsp;<span class="op" id="3099479">*</span><span class="ident" id="3099480">Request</span><span class="op" id="3099487">)</span>&nbsp;<span class="op" id="3099489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099492">if</span>&nbsp;<span class="ident" id="3099495">r</span><span class="op" id="3099496">.</span><span class="ident" id="3099497">RequestURI</span>&nbsp;<span class="op" id="3099508">==</span>&nbsp;<span class="string" id="3099511">&#34;*&#34;</span>&nbsp;<span class="op" id="3099515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099519">if</span>&nbsp;<span class="ident" id="3099522">r</span><span class="op" id="3099523">.</span><span class="ident" id="3099524">ProtoAtLeast</span><span class="op" id="3099536">(</span><span class="num" id="3099537">1</span><span class="op" id="3099538">,</span>&nbsp;<span class="num" id="3099540">1</span><span class="op" id="3099541">)</span>&nbsp;<span class="op" id="3099543">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099548">w</span><span class="op" id="3099549">.</span><span class="ident" id="3099550">Header</span><span class="op" id="3099556">(</span><span class="op" id="3099557">)</span><span class="op" id="3099558">.</span><span class="ident" id="3099559">Set</span><span class="op" id="3099562">(</span><span class="string" id="3099563">&#34;Connection&#34;</span><span class="op" id="3099575">,</span>&nbsp;<span class="string" id="3099577">&#34;close&#34;</span><span class="op" id="3099584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099592">w</span><span class="op" id="3099593">.</span><span class="ident" id="3099594">WriteHeader</span><span class="op" id="3099605">(</span><span class="ident" id="3099606">StatusBadRequest</span><span class="op" id="3099622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099626">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099634">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099637">h</span><span class="op" id="3099638">,</span>&nbsp;<span class="ident" id="3099640">_</span>&nbsp;<span class="op" id="3099642">:=</span>&nbsp;<span class="ident" id="3099645">mux</span><span class="op" id="3099648">.</span><span class="ident" id="3099649">Handler</span><span class="op" id="3099656">(</span><span class="ident" id="3099657">r</span><span class="op" id="3099658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099661">h</span><span class="op" id="3099662">.</span><span class="ident" id="3099663">ServeHTTP</span><span class="op" id="3099672">(</span><span class="ident" id="3099673">w</span><span class="op" id="3099674">,</span>&nbsp;<span class="ident" id="3099676">r</span><span class="op" id="3099677">)</span><br>
<span class="lineno"></span><span class="op" id="3099679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3099682">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3099737">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3099796">func</span>&nbsp;<span class="op" id="3099801">(</span><span class="ident" id="3099802">mux</span>&nbsp;<span class="op" id="3099806">*</span><span class="ident" id="3099807">ServeMux</span><span class="op" id="3099815">)</span>&nbsp;<span class="ident" id="3099817">Handle</span><span class="op" id="3099823">(</span><span class="ident" id="3099824">pattern</span>&nbsp;<span class="builtintype" id="3099832">string</span><span class="op" id="3099838">,</span>&nbsp;<span class="ident" id="3099840">handler</span>&nbsp;<span class="ident" id="3099848">Handler</span><span class="op" id="3099855">)</span>&nbsp;<span class="op" id="3099857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099860">mux</span><span class="op" id="3099863">.</span><span class="ident" id="3099864">mu</span><span class="op" id="3099866">.</span><span class="ident" id="3099867">Lock</span><span class="op" id="3099871">(</span><span class="op" id="3099872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099875">defer</span>&nbsp;<span class="ident" id="3099881">mux</span><span class="op" id="3099884">.</span><span class="ident" id="3099885">mu</span><span class="op" id="3099887">.</span><span class="ident" id="3099888">Unlock</span><span class="op" id="3099894">(</span><span class="op" id="3099895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099899">if</span>&nbsp;<span class="ident" id="3099902">pattern</span>&nbsp;<span class="op" id="3099910">==</span>&nbsp;<span class="string" id="3099913">&#34;&#34;</span>&nbsp;<span class="op" id="3099916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3099920">panic</span><span class="op" id="3099925">(</span><span class="string" id="3099926">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3099951">+</span>&nbsp;<span class="ident" id="3099953">pattern</span><span class="op" id="3099960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099966">if</span>&nbsp;<span class="ident" id="3099969">handler</span>&nbsp;<span class="op" id="3099977">==</span>&nbsp;<span class="ident" id="3099980">nil</span>&nbsp;<span class="op" id="3099984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3099988">panic</span><span class="op" id="3099993">(</span><span class="string" id="3099994">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3100013">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100019">if</span>&nbsp;<span class="ident" id="3100022">mux</span><span class="op" id="3100025">.</span><span class="ident" id="3100026">m</span><span class="op" id="3100027">[</span><span class="ident" id="3100028">pattern</span><span class="op" id="3100035">]</span><span class="op" id="3100036">.</span><span class="ident" id="3100037">explicit</span>&nbsp;<span class="op" id="3100046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3100050">panic</span><span class="op" id="3100055">(</span><span class="string" id="3100056">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3100092">+</span>&nbsp;<span class="ident" id="3100094">pattern</span><span class="op" id="3100101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100108">mux</span><span class="op" id="3100111">.</span><span class="ident" id="3100112">m</span><span class="op" id="3100113">[</span><span class="ident" id="3100114">pattern</span><span class="op" id="3100121">]</span>&nbsp;<span class="op" id="3100123">=</span>&nbsp;<span class="ident" id="3100125">muxEntry</span><span class="op" id="3100133">{</span><span class="ident" id="3100134">explicit</span><span class="op" id="3100142">:</span>&nbsp;<span class="builtintype" id="3100144">true</span><span class="op" id="3100148">,</span>&nbsp;<span class="ident" id="3100150">h</span><span class="op" id="3100151">:</span>&nbsp;<span class="ident" id="3100153">handler</span><span class="op" id="3100160">,</span>&nbsp;<span class="ident" id="3100162">pattern</span><span class="op" id="3100169">:</span>&nbsp;<span class="ident" id="3100171">pattern</span><span class="op" id="3100178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100182">if</span>&nbsp;<span class="ident" id="3100185">pattern</span><span class="op" id="3100192">[</span><span class="num" id="3100193">0</span><span class="op" id="3100194">]</span>&nbsp;<span class="op" id="3100196">!=</span>&nbsp;<span class="string" id="3100199">&#39;/&#39;</span>&nbsp;<span class="op" id="3100203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100207">mux</span><span class="op" id="3100210">.</span><span class="ident" id="3100211">hosts</span>&nbsp;<span class="op" id="3100217">=</span>&nbsp;<span class="builtintype" id="3100219">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100225">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100229">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100251">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100326">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100380">n</span>&nbsp;<span class="op" id="3100382">:=</span>&nbsp;<span class="builtinfunc" id="3100385">len</span><span class="op" id="3100388">(</span><span class="ident" id="3100389">pattern</span><span class="op" id="3100396">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100399">if</span>&nbsp;<span class="ident" id="3100402">n</span>&nbsp;<span class="op" id="3100404">&gt;</span>&nbsp;<span class="num" id="3100406">0</span>&nbsp;<span class="op" id="3100408">&amp;&amp;</span>&nbsp;<span class="ident" id="3100411">pattern</span><span class="op" id="3100418">[</span><span class="ident" id="3100419">n</span><span class="op" id="3100420">-</span><span class="num" id="3100421">1</span><span class="op" id="3100422">]</span>&nbsp;<span class="op" id="3100424">==</span>&nbsp;<span class="string" id="3100427">&#39;/&#39;</span>&nbsp;<span class="op" id="3100431">&amp;&amp;</span>&nbsp;<span class="op" id="3100434">!</span><span class="ident" id="3100435">mux</span><span class="op" id="3100438">.</span><span class="ident" id="3100439">m</span><span class="op" id="3100440">[</span><span class="ident" id="3100441">pattern</span><span class="op" id="3100448">[</span><span class="num" id="3100449">0</span><span class="op" id="3100450">:</span><span class="ident" id="3100451">n</span><span class="op" id="3100452">-</span><span class="num" id="3100453">1</span><span class="op" id="3100454">]</span><span class="op" id="3100455">]</span><span class="op" id="3100456">.</span><span class="ident" id="3100457">explicit</span>&nbsp;<span class="op" id="3100466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100470">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100535">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100559">path</span>&nbsp;<span class="op" id="3100564">:=</span>&nbsp;<span class="ident" id="3100567">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100577">if</span>&nbsp;<span class="ident" id="3100580">pattern</span><span class="op" id="3100587">[</span><span class="num" id="3100588">0</span><span class="op" id="3100589">]</span>&nbsp;<span class="op" id="3100591">!=</span>&nbsp;<span class="string" id="3100594">&#39;/&#39;</span>&nbsp;<span class="op" id="3100598">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100603">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100662">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100695">path</span>&nbsp;<span class="op" id="3100700">=</span>&nbsp;<span class="ident" id="3100702">pattern</span><span class="op" id="3100709">[</span><span class="ident" id="3100710">strings</span><span class="op" id="3100717">.</span><span class="ident" id="3100718">Index</span><span class="op" id="3100723">(</span><span class="ident" id="3100724">pattern</span><span class="op" id="3100731">,</span>&nbsp;<span class="string" id="3100733">&#34;/&#34;</span><span class="op" id="3100736">)</span><span class="op" id="3100737">:</span><span class="op" id="3100738">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100746">mux</span><span class="op" id="3100749">.</span><span class="ident" id="3100750">m</span><span class="op" id="3100751">[</span><span class="ident" id="3100752">pattern</span><span class="op" id="3100759">[</span><span class="num" id="3100760">0</span><span class="op" id="3100761">:</span><span class="ident" id="3100762">n</span><span class="op" id="3100763">-</span><span class="num" id="3100764">1</span><span class="op" id="3100765">]</span><span class="op" id="3100766">]</span>&nbsp;<span class="op" id="3100768">=</span>&nbsp;<span class="ident" id="3100770">muxEntry</span><span class="op" id="3100778">{</span><span class="ident" id="3100779">h</span><span class="op" id="3100780">:</span>&nbsp;<span class="ident" id="3100782">RedirectHandler</span><span class="op" id="3100797">(</span><span class="ident" id="3100798">path</span><span class="op" id="3100802">,</span>&nbsp;<span class="ident" id="3100804">StatusMovedPermanently</span><span class="op" id="3100826">)</span><span class="op" id="3100827">,</span>&nbsp;<span class="ident" id="3100829">pattern</span><span class="op" id="3100836">:</span>&nbsp;<span class="ident" id="3100838">pattern</span><span class="op" id="3100845">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100848">}</span><br>
<span class="lineno"></span><span class="op" id="3100850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3100853">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3100921">func</span>&nbsp;<span class="op" id="3100926">(</span><span class="ident" id="3100927">mux</span>&nbsp;<span class="op" id="3100931">*</span><span class="ident" id="3100932">ServeMux</span><span class="op" id="3100940">)</span>&nbsp;<span class="ident" id="3100942">HandleFunc</span><span class="op" id="3100952">(</span><span class="ident" id="3100953">pattern</span>&nbsp;<span class="builtintype" id="3100961">string</span><span class="op" id="3100967">,</span>&nbsp;<span class="ident" id="3100969">handler</span>&nbsp;<span class="keyword" id="3100977">func</span><span class="op" id="3100981">(</span><span class="ident" id="3100982">ResponseWriter</span><span class="op" id="3100996">,</span>&nbsp;<span class="op" id="3100998">*</span><span class="ident" id="3100999">Request</span><span class="op" id="3101006">)</span><span class="op" id="3101007">)</span>&nbsp;<span class="op" id="3101009">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101012">mux</span><span class="op" id="3101015">.</span><span class="ident" id="3101016">Handle</span><span class="op" id="3101022">(</span><span class="ident" id="3101023">pattern</span><span class="op" id="3101030">,</span>&nbsp;<span class="ident" id="3101032">HandlerFunc</span><span class="op" id="3101043">(</span><span class="ident" id="3101044">handler</span><span class="op" id="3101051">)</span><span class="op" id="3101052">)</span><br>
<span class="lineno"></span><span class="op" id="3101054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3101057">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3101111">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3101138">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3101207">func</span>&nbsp;<span class="ident" id="3101212">Handle</span><span class="op" id="3101218">(</span><span class="ident" id="3101219">pattern</span>&nbsp;<span class="builtintype" id="3101227">string</span><span class="op" id="3101233">,</span>&nbsp;<span class="ident" id="3101235">handler</span>&nbsp;<span class="ident" id="3101243">Handler</span><span class="op" id="3101250">)</span>&nbsp;<span class="op" id="3101252">{</span>&nbsp;<span class="ident" id="3101254">DefaultServeMux</span><span class="op" id="3101269">.</span><span class="ident" id="3101270">Handle</span><span class="op" id="3101276">(</span><span class="ident" id="3101277">pattern</span><span class="op" id="3101284">,</span>&nbsp;<span class="ident" id="3101286">handler</span><span class="op" id="3101293">)</span>&nbsp;<span class="op" id="3101295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3101298">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3101365">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3101392">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3101461">func</span>&nbsp;<span class="ident" id="3101466">HandleFunc</span><span class="op" id="3101476">(</span><span class="ident" id="3101477">pattern</span>&nbsp;<span class="builtintype" id="3101485">string</span><span class="op" id="3101491">,</span>&nbsp;<span class="ident" id="3101493">handler</span>&nbsp;<span class="keyword" id="3101501">func</span><span class="op" id="3101505">(</span><span class="ident" id="3101506">ResponseWriter</span><span class="op" id="3101520">,</span>&nbsp;<span class="op" id="3101522">*</span><span class="ident" id="3101523">Request</span><span class="op" id="3101530">)</span><span class="op" id="3101531">)</span>&nbsp;<span class="op" id="3101533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101536">DefaultServeMux</span><span class="op" id="3101551">.</span><span class="ident" id="3101552">HandleFunc</span><span class="op" id="3101562">(</span><span class="ident" id="3101563">pattern</span><span class="op" id="3101570">,</span>&nbsp;<span class="ident" id="3101572">handler</span><span class="op" id="3101579">)</span><br>
<span class="lineno"></span><span class="op" id="3101581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3101584">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3101646">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3101716">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3101773">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3101845">func</span>&nbsp;<span class="ident" id="3101850">Serve</span><span class="op" id="3101855">(</span><span class="ident" id="3101856">l</span>&nbsp;<span class="ident" id="3101858">net</span><span class="op" id="3101861">.</span><span class="ident" id="3101862">Listener</span><span class="op" id="3101870">,</span>&nbsp;<span class="ident" id="3101872">handler</span>&nbsp;<span class="ident" id="3101880">Handler</span><span class="op" id="3101887">)</span>&nbsp;<span class="builtintype" id="3101889">error</span>&nbsp;<span class="op" id="3101895">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101898">srv</span>&nbsp;<span class="op" id="3101902">:=</span>&nbsp;<span class="op" id="3101905">&amp;</span><span class="ident" id="3101906">Server</span><span class="op" id="3101912">{</span><span class="ident" id="3101913">Handler</span><span class="op" id="3101920">:</span>&nbsp;<span class="ident" id="3101922">handler</span><span class="op" id="3101929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101932">return</span>&nbsp;<span class="ident" id="3101939">srv</span><span class="op" id="3101942">.</span><span class="ident" id="3101943">Serve</span><span class="op" id="3101948">(</span><span class="ident" id="3101949">l</span><span class="op" id="3101950">)</span><br>
<span class="lineno"></span><span class="op" id="3101952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3101955">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3102014">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3102069">type</span>&nbsp;<span class="ident" id="3102074">Server</span>&nbsp;<span class="keyword" id="3102081">struct</span>&nbsp;<span class="op" id="3102088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102091">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3102106">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3102120">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102167">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102182">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3102196">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102247">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102262">time</span><span class="op" id="3102266">.</span><span class="ident" id="3102267">Duration</span>&nbsp;<span class="comment" id="3102276">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102335">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3102350">time</span><span class="op" id="3102354">.</span><span class="ident" id="3102355">Duration</span>&nbsp;<span class="comment" id="3102364">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102425">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3102440">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3102454">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102518">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102533">*</span><span class="ident" id="3102534">tls</span><span class="op" id="3102537">.</span><span class="ident" id="3102538">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3102547">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3102599">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3102661">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3102718">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3102782">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3102842">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3102905">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3102963">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103015">TLSNextProto</span>&nbsp;<span class="keyword" id="3103028">map</span><span class="op" id="3103031">[</span><span class="builtintype" id="3103032">string</span><span class="op" id="3103038">]</span><span class="keyword" id="3103039">func</span><span class="op" id="3103043">(</span><span class="op" id="3103044">*</span><span class="ident" id="3103045">Server</span><span class="op" id="3103051">,</span>&nbsp;<span class="op" id="3103053">*</span><span class="ident" id="3103054">tls</span><span class="op" id="3103057">.</span><span class="ident" id="3103058">Conn</span><span class="op" id="3103062">,</span>&nbsp;<span class="ident" id="3103064">Handler</span><span class="op" id="3103071">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103075">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103137">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103196">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103253">ConnState</span>&nbsp;<span class="keyword" id="3103263">func</span><span class="op" id="3103267">(</span><span class="ident" id="3103268">net</span><span class="op" id="3103271">.</span><span class="ident" id="3103272">Conn</span><span class="op" id="3103276">,</span>&nbsp;<span class="ident" id="3103278">ConnState</span><span class="op" id="3103287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103291">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103354">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103409">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103469">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103490">ErrorLog</span>&nbsp;<span class="op" id="3103499">*</span><span class="ident" id="3103500">log</span><span class="op" id="3103503">.</span><span class="ident" id="3103504">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103513">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3103531">int32</span>&nbsp;<span class="comment" id="3103537">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3103561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3103564">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3103636">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3103688">type</span>&nbsp;<span class="ident" id="3103693">ConnState</span>&nbsp;<span class="builtintype" id="3103703">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3103708">const</span>&nbsp;<span class="op" id="3103714">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103717">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103778">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103836">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103891">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103908">StateNew</span>&nbsp;<span class="ident" id="3103917">ConnState</span>&nbsp;<span class="op" id="3103927">=</span>&nbsp;<span class="ident" id="3103929">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103936">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104000">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104054">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104117">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104171">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104224">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104285">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104299">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104355">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104418">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104479">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104521">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104533">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104585">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104654">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104670">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104718">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104776">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104807">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3104819">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3104822">var</span>&nbsp;<span class="ident" id="3104826">stateName</span>&nbsp;<span class="op" id="3104836">=</span>&nbsp;<span class="keyword" id="3104838">map</span><span class="op" id="3104841">[</span><span class="ident" id="3104842">ConnState</span><span class="op" id="3104851">]</span><span class="builtintype" id="3104852">string</span><span class="op" id="3104858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104861">StateNew</span><span class="op" id="3104869">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3104876">&#34;new&#34;</span><span class="op" id="3104881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104884">StateActive</span><span class="op" id="3104895">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3104899">&#34;active&#34;</span><span class="op" id="3104907">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104910">StateIdle</span><span class="op" id="3104919">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3104925">&#34;idle&#34;</span><span class="op" id="3104931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104934">StateHijacked</span><span class="op" id="3104947">:</span>&nbsp;<span class="string" id="3104949">&#34;hijacked&#34;</span><span class="op" id="3104959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104962">StateClosed</span><span class="op" id="3104973">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3104977">&#34;closed&#34;</span><span class="op" id="3104985">,</span><br>
<span class="lineno"></span><span class="op" id="3104987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3104990">func</span>&nbsp;<span class="op" id="3104995">(</span><span class="ident" id="3104996">c</span>&nbsp;<span class="ident" id="3104998">ConnState</span><span class="op" id="3105007">)</span>&nbsp;<span class="ident" id="3105009">String</span><span class="op" id="3105015">(</span><span class="op" id="3105016">)</span>&nbsp;<span class="builtintype" id="3105018">string</span>&nbsp;<span class="op" id="3105025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105028">return</span>&nbsp;<span class="ident" id="3105035">stateName</span><span class="op" id="3105044">[</span><span class="ident" id="3105045">c</span><span class="op" id="3105046">]</span><br>
<span class="lineno"></span><span class="op" id="3105048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3105051">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3105112">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3105170">type</span>&nbsp;<span class="ident" id="3105175">serverHandler</span>&nbsp;<span class="keyword" id="3105189">struct</span>&nbsp;<span class="op" id="3105196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105199">srv</span>&nbsp;<span class="op" id="3105203">*</span><span class="ident" id="3105204">Server</span><br>
<span class="lineno"></span><span class="op" id="3105211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3105214">func</span>&nbsp;<span class="op" id="3105219">(</span><span class="ident" id="3105220">sh</span>&nbsp;<span class="ident" id="3105223">serverHandler</span><span class="op" id="3105236">)</span>&nbsp;<span class="ident" id="3105238">ServeHTTP</span><span class="op" id="3105247">(</span><span class="ident" id="3105248">rw</span>&nbsp;<span class="ident" id="3105251">ResponseWriter</span><span class="op" id="3105265">,</span>&nbsp;<span class="ident" id="3105267">req</span>&nbsp;<span class="op" id="3105271">*</span><span class="ident" id="3105272">Request</span><span class="op" id="3105279">)</span>&nbsp;<span class="op" id="3105281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105284">handler</span>&nbsp;<span class="op" id="3105292">:=</span>&nbsp;<span class="ident" id="3105295">sh</span><span class="op" id="3105297">.</span><span class="ident" id="3105298">srv</span><span class="op" id="3105301">.</span><span class="ident" id="3105302">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105311">if</span>&nbsp;<span class="ident" id="3105314">handler</span>&nbsp;<span class="op" id="3105322">==</span>&nbsp;<span class="ident" id="3105325">nil</span>&nbsp;<span class="op" id="3105329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105333">handler</span>&nbsp;<span class="op" id="3105341">=</span>&nbsp;<span class="ident" id="3105343">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105360">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105363">if</span>&nbsp;<span class="ident" id="3105366">req</span><span class="op" id="3105369">.</span><span class="ident" id="3105370">RequestURI</span>&nbsp;<span class="op" id="3105381">==</span>&nbsp;<span class="string" id="3105384">&#34;*&#34;</span>&nbsp;<span class="op" id="3105388">&amp;&amp;</span>&nbsp;<span class="ident" id="3105391">req</span><span class="op" id="3105394">.</span><span class="ident" id="3105395">Method</span>&nbsp;<span class="op" id="3105402">==</span>&nbsp;<span class="string" id="3105405">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3105415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105419">handler</span>&nbsp;<span class="op" id="3105427">=</span>&nbsp;<span class="ident" id="3105429">globalOptionsHandler</span><span class="op" id="3105449">{</span><span class="op" id="3105450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105456">handler</span><span class="op" id="3105463">.</span><span class="ident" id="3105464">ServeHTTP</span><span class="op" id="3105473">(</span><span class="ident" id="3105474">rw</span><span class="op" id="3105476">,</span>&nbsp;<span class="ident" id="3105478">req</span><span class="op" id="3105481">)</span><br>
<span class="lineno"></span><span class="op" id="3105483">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3105486">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3105557">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3105620">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3105659">func</span>&nbsp;<span class="op" id="3105664">(</span><span class="ident" id="3105665">srv</span>&nbsp;<span class="op" id="3105669">*</span><span class="ident" id="3105670">Server</span><span class="op" id="3105676">)</span>&nbsp;<span class="ident" id="3105678">ListenAndServe</span><span class="op" id="3105692">(</span><span class="op" id="3105693">)</span>&nbsp;<span class="builtintype" id="3105695">error</span>&nbsp;<span class="op" id="3105701">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105704">addr</span>&nbsp;<span class="op" id="3105709">:=</span>&nbsp;<span class="ident" id="3105712">srv</span><span class="op" id="3105715">.</span><span class="ident" id="3105716">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105722">if</span>&nbsp;<span class="ident" id="3105725">addr</span>&nbsp;<span class="op" id="3105730">==</span>&nbsp;<span class="string" id="3105733">&#34;&#34;</span>&nbsp;<span class="op" id="3105736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105740">addr</span>&nbsp;<span class="op" id="3105745">=</span>&nbsp;<span class="string" id="3105747">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105759">ln</span><span class="op" id="3105761">,</span>&nbsp;<span class="ident" id="3105763">err</span>&nbsp;<span class="op" id="3105767">:=</span>&nbsp;<span class="ident" id="3105770">net</span><span class="op" id="3105773">.</span><span class="ident" id="3105774">Listen</span><span class="op" id="3105780">(</span><span class="string" id="3105781">&#34;tcp&#34;</span><span class="op" id="3105786">,</span>&nbsp;<span class="ident" id="3105788">addr</span><span class="op" id="3105792">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105795">if</span>&nbsp;<span class="ident" id="3105798">err</span>&nbsp;<span class="op" id="3105802">!=</span>&nbsp;<span class="ident" id="3105805">nil</span>&nbsp;<span class="op" id="3105809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105813">return</span>&nbsp;<span class="ident" id="3105820">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105828">return</span>&nbsp;<span class="ident" id="3105835">srv</span><span class="op" id="3105838">.</span><span class="ident" id="3105839">Serve</span><span class="op" id="3105844">(</span><span class="ident" id="3105845">tcpKeepAliveListener</span><span class="op" id="3105865">{</span><span class="ident" id="3105866">ln</span><span class="op" id="3105868">.</span><span class="op" id="3105869">(</span><span class="op" id="3105870">*</span><span class="ident" id="3105871">net</span><span class="op" id="3105874">.</span><span class="ident" id="3105875">TCPListener</span><span class="op" id="3105886">)</span><span class="op" id="3105887">}</span><span class="op" id="3105888">)</span><br>
<span class="lineno"></span><span class="op" id="3105890">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3105893">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3105961">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3106038">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3106081">func</span>&nbsp;<span class="op" id="3106086">(</span><span class="ident" id="3106087">srv</span>&nbsp;<span class="op" id="3106091">*</span><span class="ident" id="3106092">Server</span><span class="op" id="3106098">)</span>&nbsp;<span class="ident" id="3106100">Serve</span><span class="op" id="3106105">(</span><span class="ident" id="3106106">l</span>&nbsp;<span class="ident" id="3106108">net</span><span class="op" id="3106111">.</span><span class="ident" id="3106112">Listener</span><span class="op" id="3106120">)</span>&nbsp;<span class="builtintype" id="3106122">error</span>&nbsp;<span class="op" id="3106128">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106131">defer</span>&nbsp;<span class="ident" id="3106137">l</span><span class="op" id="3106138">.</span><span class="ident" id="3106139">Close</span><span class="op" id="3106144">(</span><span class="op" id="3106145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106148">var</span>&nbsp;<span class="ident" id="3106152">tempDelay</span>&nbsp;<span class="ident" id="3106162">time</span><span class="op" id="3106166">.</span><span class="ident" id="3106167">Duration</span>&nbsp;<span class="comment" id="3106176">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106216">for</span>&nbsp;<span class="op" id="3106220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106224">rw</span><span class="op" id="3106226">,</span>&nbsp;<span class="ident" id="3106228">e</span>&nbsp;<span class="op" id="3106230">:=</span>&nbsp;<span class="ident" id="3106233">l</span><span class="op" id="3106234">.</span><span class="ident" id="3106235">Accept</span><span class="op" id="3106241">(</span><span class="op" id="3106242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106246">if</span>&nbsp;<span class="ident" id="3106249">e</span>&nbsp;<span class="op" id="3106251">!=</span>&nbsp;<span class="ident" id="3106254">nil</span>&nbsp;<span class="op" id="3106258">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106263">if</span>&nbsp;<span class="ident" id="3106266">ne</span><span class="op" id="3106268">,</span>&nbsp;<span class="ident" id="3106270">ok</span>&nbsp;<span class="op" id="3106273">:=</span>&nbsp;<span class="ident" id="3106276">e</span><span class="op" id="3106277">.</span><span class="op" id="3106278">(</span><span class="ident" id="3106279">net</span><span class="op" id="3106282">.</span><span class="ident" id="3106283">Error</span><span class="op" id="3106288">)</span><span class="op" id="3106289">;</span>&nbsp;<span class="ident" id="3106291">ok</span>&nbsp;<span class="op" id="3106294">&amp;&amp;</span>&nbsp;<span class="ident" id="3106297">ne</span><span class="op" id="3106299">.</span><span class="ident" id="3106300">Temporary</span><span class="op" id="3106309">(</span><span class="op" id="3106310">)</span>&nbsp;<span class="op" id="3106312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106318">if</span>&nbsp;<span class="ident" id="3106321">tempDelay</span>&nbsp;<span class="op" id="3106331">==</span>&nbsp;<span class="num" id="3106334">0</span>&nbsp;<span class="op" id="3106336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106343">tempDelay</span>&nbsp;<span class="op" id="3106353">=</span>&nbsp;<span class="num" id="3106355">5</span>&nbsp;<span class="op" id="3106357">*</span>&nbsp;<span class="ident" id="3106359">time</span><span class="op" id="3106363">.</span><span class="ident" id="3106364">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106380">}</span>&nbsp;<span class="keyword" id="3106382">else</span>&nbsp;<span class="op" id="3106387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106394">tempDelay</span>&nbsp;<span class="op" id="3106404">*=</span>&nbsp;<span class="num" id="3106407">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106419">if</span>&nbsp;<span class="ident" id="3106422">max</span>&nbsp;<span class="op" id="3106426">:=</span>&nbsp;<span class="num" id="3106429">1</span>&nbsp;<span class="op" id="3106431">*</span>&nbsp;<span class="ident" id="3106433">time</span><span class="op" id="3106437">.</span><span class="ident" id="3106438">Second</span><span class="op" id="3106444">;</span>&nbsp;<span class="ident" id="3106446">tempDelay</span>&nbsp;<span class="op" id="3106456">&gt;</span>&nbsp;<span class="ident" id="3106458">max</span>&nbsp;<span class="op" id="3106462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106469">tempDelay</span>&nbsp;<span class="op" id="3106479">=</span>&nbsp;<span class="ident" id="3106481">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106495">srv</span><span class="op" id="3106498">.</span><span class="ident" id="3106499">logf</span><span class="op" id="3106503">(</span><span class="string" id="3106504">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3106544">,</span>&nbsp;<span class="ident" id="3106546">e</span><span class="op" id="3106547">,</span>&nbsp;<span class="ident" id="3106549">tempDelay</span><span class="op" id="3106558">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106564">time</span><span class="op" id="3106568">.</span><span class="ident" id="3106569">Sleep</span><span class="op" id="3106574">(</span><span class="ident" id="3106575">tempDelay</span><span class="op" id="3106584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106590">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106607">return</span>&nbsp;<span class="ident" id="3106614">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106618">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106622">tempDelay</span>&nbsp;<span class="op" id="3106632">=</span>&nbsp;<span class="num" id="3106634">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106638">c</span><span class="op" id="3106639">,</span>&nbsp;<span class="ident" id="3106641">err</span>&nbsp;<span class="op" id="3106645">:=</span>&nbsp;<span class="ident" id="3106648">srv</span><span class="op" id="3106651">.</span><span class="ident" id="3106652">newConn</span><span class="op" id="3106659">(</span><span class="ident" id="3106660">rw</span><span class="op" id="3106662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106666">if</span>&nbsp;<span class="ident" id="3106669">err</span>&nbsp;<span class="op" id="3106673">!=</span>&nbsp;<span class="ident" id="3106676">nil</span>&nbsp;<span class="op" id="3106680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106685">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106696">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106700">c</span><span class="op" id="3106701">.</span><span class="ident" id="3106702">setState</span><span class="op" id="3106710">(</span><span class="ident" id="3106711">c</span><span class="op" id="3106712">.</span><span class="ident" id="3106713">rwc</span><span class="op" id="3106716">,</span>&nbsp;<span class="ident" id="3106718">StateNew</span><span class="op" id="3106726">)</span>&nbsp;<span class="comment" id="3106728">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106757">go</span>&nbsp;<span class="ident" id="3106760">c</span><span class="op" id="3106761">.</span><span class="ident" id="3106762">serve</span><span class="op" id="3106767">(</span><span class="op" id="3106768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106771">}</span><br>
<span class="lineno"></span><span class="op" id="3106773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3106776">func</span>&nbsp;<span class="op" id="3106781">(</span><span class="ident" id="3106782">s</span>&nbsp;<span class="op" id="3106784">*</span><span class="ident" id="3106785">Server</span><span class="op" id="3106791">)</span>&nbsp;<span class="ident" id="3106793">doKeepAlives</span><span class="op" id="3106805">(</span><span class="op" id="3106806">)</span>&nbsp;<span class="builtintype" id="3106808">bool</span>&nbsp;<span class="op" id="3106813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106816">return</span>&nbsp;<span class="ident" id="3106823">atomic</span><span class="op" id="3106829">.</span><span class="ident" id="3106830">LoadInt32</span><span class="op" id="3106839">(</span><span class="op" id="3106840">&amp;</span><span class="ident" id="3106841">s</span><span class="op" id="3106842">.</span><span class="ident" id="3106843">disableKeepAlives</span><span class="op" id="3106860">)</span>&nbsp;<span class="op" id="3106862">==</span>&nbsp;<span class="num" id="3106865">0</span><br>
<span class="lineno"></span><span class="op" id="3106867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3106870">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3106941">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3106998">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3107064">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3107102">func</span>&nbsp;<span class="op" id="3107107">(</span><span class="ident" id="3107108">s</span>&nbsp;<span class="op" id="3107110">*</span><span class="ident" id="3107111">Server</span><span class="op" id="3107117">)</span>&nbsp;<span class="ident" id="3107119">SetKeepAlivesEnabled</span><span class="op" id="3107139">(</span><span class="ident" id="3107140">v</span>&nbsp;<span class="builtintype" id="3107142">bool</span><span class="op" id="3107146">)</span>&nbsp;<span class="op" id="3107148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107151">if</span>&nbsp;<span class="ident" id="3107154">v</span>&nbsp;<span class="op" id="3107156">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107160">atomic</span><span class="op" id="3107166">.</span><span class="ident" id="3107167">StoreInt32</span><span class="op" id="3107177">(</span><span class="op" id="3107178">&amp;</span><span class="ident" id="3107179">s</span><span class="op" id="3107180">.</span><span class="ident" id="3107181">disableKeepAlives</span><span class="op" id="3107198">,</span>&nbsp;<span class="num" id="3107200">0</span><span class="op" id="3107201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107204">}</span>&nbsp;<span class="keyword" id="3107206">else</span>&nbsp;<span class="op" id="3107211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107215">atomic</span><span class="op" id="3107221">.</span><span class="ident" id="3107222">StoreInt32</span><span class="op" id="3107232">(</span><span class="op" id="3107233">&amp;</span><span class="ident" id="3107234">s</span><span class="op" id="3107235">.</span><span class="ident" id="3107236">disableKeepAlives</span><span class="op" id="3107253">,</span>&nbsp;<span class="num" id="3107255">1</span><span class="op" id="3107256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107259">}</span><br>
<span class="lineno"></span><span class="op" id="3107261">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3107264">func</span>&nbsp;<span class="op" id="3107269">(</span><span class="ident" id="3107270">s</span>&nbsp;<span class="op" id="3107272">*</span><span class="ident" id="3107273">Server</span><span class="op" id="3107279">)</span>&nbsp;<span class="ident" id="3107281">logf</span><span class="op" id="3107285">(</span><span class="ident" id="3107286">format</span>&nbsp;<span class="builtintype" id="3107293">string</span><span class="op" id="3107299">,</span>&nbsp;<span class="ident" id="3107301">args</span>&nbsp;<span class="op" id="3107306">...</span><span class="keyword" id="3107309">interface</span><span class="op" id="3107318">{</span><span class="op" id="3107319">}</span><span class="op" id="3107320">)</span>&nbsp;<span class="op" id="3107322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107325">if</span>&nbsp;<span class="ident" id="3107328">s</span><span class="op" id="3107329">.</span><span class="ident" id="3107330">ErrorLog</span>&nbsp;<span class="op" id="3107339">!=</span>&nbsp;<span class="ident" id="3107342">nil</span>&nbsp;<span class="op" id="3107346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107350">s</span><span class="op" id="3107351">.</span><span class="ident" id="3107352">ErrorLog</span><span class="op" id="3107360">.</span><span class="ident" id="3107361">Printf</span><span class="op" id="3107367">(</span><span class="ident" id="3107368">format</span><span class="op" id="3107374">,</span>&nbsp;<span class="ident" id="3107376">args</span><span class="op" id="3107380">...</span><span class="op" id="3107383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107386">}</span>&nbsp;<span class="keyword" id="3107388">else</span>&nbsp;<span class="op" id="3107393">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107397">log</span><span class="op" id="3107400">.</span><span class="ident" id="3107401">Printf</span><span class="op" id="3107407">(</span><span class="ident" id="3107408">format</span><span class="op" id="3107414">,</span>&nbsp;<span class="ident" id="3107416">args</span><span class="op" id="3107420">...</span><span class="op" id="3107423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107426">}</span><br>
<span class="lineno"></span><span class="op" id="3107428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3107431">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3107489">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3107545">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3107600">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3107646">//</span><br>
<span class="lineno"></span><span class="comment" id="3107649">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3107681">//</span><br>
<span class="lineno"></span><span class="comment" id="3107684">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3107700">//</span><br>
<span class="lineno"></span><span class="comment" id="3107703">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3107715">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3107724">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3107739">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3107749">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3107754">//</span><br>
<span class="lineno"></span><span class="comment" id="3107757">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3107791">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3107855">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3107896">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3107901">//</span><br>
<span class="lineno"></span><span class="comment" id="3107904">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3107921">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3107964">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3108010">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3108030">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3108070">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="3108076">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="3108081">func</span>&nbsp;<span class="ident" id="3108086">ListenAndServe</span><span class="op" id="3108100">(</span><span class="ident" id="3108101">addr</span>&nbsp;<span class="builtintype" id="3108106">string</span><span class="op" id="3108112">,</span>&nbsp;<span class="ident" id="3108114">handler</span>&nbsp;<span class="ident" id="3108122">Handler</span><span class="op" id="3108129">)</span>&nbsp;<span class="builtintype" id="3108131">error</span>&nbsp;<span class="op" id="3108137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3108140">server</span>&nbsp;<span class="op" id="3108147">:=</span>&nbsp;<span class="op" id="3108150">&amp;</span><span class="ident" id="3108151">Server</span><span class="op" id="3108157">{</span><span class="ident" id="3108158">Addr</span><span class="op" id="3108162">:</span>&nbsp;<span class="ident" id="3108164">addr</span><span class="op" id="3108168">,</span>&nbsp;<span class="ident" id="3108170">Handler</span><span class="op" id="3108177">:</span>&nbsp;<span class="ident" id="3108179">handler</span><span class="op" id="3108186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3108189">return</span>&nbsp;<span class="ident" id="3108196">server</span><span class="op" id="3108202">.</span><span class="ident" id="3108203">ListenAndServe</span><span class="op" id="3108217">(</span><span class="op" id="3108218">)</span><br>
<span class="lineno"></span><span class="op" id="3108220">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3108223">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3108295">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3108374">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3108450">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3108532">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3108597">//</span><br>
<span class="lineno"></span><span class="comment" id="3108600">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3108632">//</span><br>
<span class="lineno"></span><span class="comment" id="3108635">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3108647">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3108657">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3108672">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3108677">//</span><br>
<span class="lineno"></span><span class="comment" id="3108680">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3108740">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3108789">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3108841">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3108846">//</span><br>
<span class="lineno"></span><span class="comment" id="3108849">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3108866">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3108900">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3108975">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3109047">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3109067">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3109087">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3109093">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3109098">//</span><br>
<span class="lineno"></span><span class="comment" id="3109101">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3109181">func</span>&nbsp;<span class="ident" id="3109186">ListenAndServeTLS</span><span class="op" id="3109203">(</span><span class="ident" id="3109204">addr</span>&nbsp;<span class="builtintype" id="3109209">string</span><span class="op" id="3109215">,</span>&nbsp;<span class="ident" id="3109217">certFile</span>&nbsp;<span class="builtintype" id="3109226">string</span><span class="op" id="3109232">,</span>&nbsp;<span class="ident" id="3109234">keyFile</span>&nbsp;<span class="builtintype" id="3109242">string</span><span class="op" id="3109248">,</span>&nbsp;<span class="ident" id="3109250">handler</span>&nbsp;<span class="ident" id="3109258">Handler</span><span class="op" id="3109265">)</span>&nbsp;<span class="builtintype" id="3109267">error</span>&nbsp;<span class="op" id="3109273">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3109276">server</span>&nbsp;<span class="op" id="3109283">:=</span>&nbsp;<span class="op" id="3109286">&amp;</span><span class="ident" id="3109287">Server</span><span class="op" id="3109293">{</span><span class="ident" id="3109294">Addr</span><span class="op" id="3109298">:</span>&nbsp;<span class="ident" id="3109300">addr</span><span class="op" id="3109304">,</span>&nbsp;<span class="ident" id="3109306">Handler</span><span class="op" id="3109313">:</span>&nbsp;<span class="ident" id="3109315">handler</span><span class="op" id="3109322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3109325">return</span>&nbsp;<span class="ident" id="3109332">server</span><span class="op" id="3109338">.</span><span class="ident" id="3109339">ListenAndServeTLS</span><span class="op" id="3109356">(</span><span class="ident" id="3109357">certFile</span><span class="op" id="3109365">,</span>&nbsp;<span class="ident" id="3109367">keyFile</span><span class="op" id="3109374">)</span><br>
<span class="lineno"></span><span class="op" id="3109376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3109379">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3109448">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3109516">//</span><br>
<span class="lineno"></span><span class="comment" id="3109519">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3109586">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3109652">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3109719">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3109784">//</span><br>
<span class="lineno"></span><span class="comment" id="3109787">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3109830">func</span>&nbsp;<span class="op" id="3109835">(</span><span class="ident" id="3109836">srv</span>&nbsp;<span class="op" id="3109840">*</span><span class="ident" id="3109841">Server</span><span class="op" id="3109847">)</span>&nbsp;<span class="ident" id="3109849">ListenAndServeTLS</span><span class="op" id="3109866">(</span><span class="ident" id="3109867">certFile</span><span class="op" id="3109875">,</span>&nbsp;<span class="ident" id="3109877">keyFile</span>&nbsp;<span class="builtintype" id="3109885">string</span><span class="op" id="3109891">)</span>&nbsp;<span class="builtintype" id="3109893">error</span>&nbsp;<span class="op" id="3109899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3109902">addr</span>&nbsp;<span class="op" id="3109907">:=</span>&nbsp;<span class="ident" id="3109910">srv</span><span class="op" id="3109913">.</span><span class="ident" id="3109914">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3109920">if</span>&nbsp;<span class="ident" id="3109923">addr</span>&nbsp;<span class="op" id="3109928">==</span>&nbsp;<span class="string" id="3109931">&#34;&#34;</span>&nbsp;<span class="op" id="3109934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3109938">addr</span>&nbsp;<span class="op" id="3109943">=</span>&nbsp;<span class="string" id="3109945">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3109955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3109958">config</span>&nbsp;<span class="op" id="3109965">:=</span>&nbsp;<span class="op" id="3109968">&amp;</span><span class="ident" id="3109969">tls</span><span class="op" id="3109972">.</span><span class="ident" id="3109973">Config</span><span class="op" id="3109979">{</span><span class="op" id="3109980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3109983">if</span>&nbsp;<span class="ident" id="3109986">srv</span><span class="op" id="3109989">.</span><span class="ident" id="3109990">TLSConfig</span>&nbsp;<span class="op" id="3110000">!=</span>&nbsp;<span class="ident" id="3110003">nil</span>&nbsp;<span class="op" id="3110007">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3110011">*</span><span class="ident" id="3110012">config</span>&nbsp;<span class="op" id="3110019">=</span>&nbsp;<span class="op" id="3110021">*</span><span class="ident" id="3110022">srv</span><span class="op" id="3110025">.</span><span class="ident" id="3110026">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3110037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3110040">if</span>&nbsp;<span class="ident" id="3110043">config</span><span class="op" id="3110049">.</span><span class="ident" id="3110050">NextProtos</span>&nbsp;<span class="op" id="3110061">==</span>&nbsp;<span class="ident" id="3110064">nil</span>&nbsp;<span class="op" id="3110068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3110072">config</span><span class="op" id="3110078">.</span><span class="ident" id="3110079">NextProtos</span>&nbsp;<span class="op" id="3110090">=</span>&nbsp;<span class="op" id="3110092">[</span><span class="op" id="3110093">]</span><span class="builtintype" id="3110094">string</span><span class="op" id="3110100">{</span><span class="string" id="3110101">&#34;http/1.1&#34;</span><span class="op" id="3110111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3110114">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3110118">var</span>&nbsp;<span class="ident" id="3110122">err</span>&nbsp;<span class="builtintype" id="3110126">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3110133">config</span><span class="op" id="3110139">.</span><span class="ident" id="3110140">Certificates</span>&nbsp;<span class="op" id="3110153">=</span>&nbsp;<span class="builtinfunc" id="3110155">make</span><span class="op" id="3110159">(</span><span class="op" id="3110160">[</span><span class="op" id="3110161">]</span><span class="ident" id="3110162">tls</span><span class="op" id="3110165">.</span><span class="ident" id="3110166">Certificate</span><span class="op" id="3110177">,</span>&nbsp;<span class="num" id="3110179">1</span><span class="op" id="3110180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3110183">config</span><span class="op" id="3110189">.</span><span class="ident" id="3110190">Certificates</span><span class="op" id="3110202">[</span><span class="num" id="3110203">0</span><span class="op" id="3110204">]</span><span class="op" id="3110205">,</span>&nbsp;<span class="ident" id="3110207">err</span>&nbsp;<span class="op" id="3110211">=</span>&nbsp;<span class="ident" id="3110213">tls</span><span class="op" id="3110216">.</span><span class="ident" id="3110217">LoadX509KeyPair</span><span class="op" id="3110232">(</span><span class="ident" id="3110233">certFile</span><span class="op" id="3110241">,</span>&nbsp;<span class="ident" id="3110243">keyFile</span><span class="op" id="3110250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3110253">if</span>&nbsp;<span class="ident" id="3110256">err</span>&nbsp;<span class="op" id="3110260">!=</span>&nbsp;<span class="ident" id="3110263">nil</span>&nbsp;<span class="op" id="3110267">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3110271">return</span>&nbsp;<span class="ident" id="3110278">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3110283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3110287">ln</span><span class="op" id="3110289">,</span>&nbsp;<span class="ident" id="3110291">err</span>&nbsp;<span class="op" id="3110295">:=</span>&nbsp;<span class="ident" id="3110298">net</span><span class="op" id="3110301">.</span><span class="ident" id="3110302">Listen</span><span class="op" id="3110308">(</span><span class="string" id="3110309">&#34;tcp&#34;</span><span class="op" id="3110314">,</span>&nbsp;<span class="ident" id="3110316">addr</span><span class="op" id="3110320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3110323">if</span>&nbsp;<span class="ident" id="3110326">err</span>&nbsp;<span class="op" id="3110330">!=</span>&nbsp;<span class="ident" id="3110333">nil</span>&nbsp;<span class="op" id="3110337">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3110341">return</span>&nbsp;<span class="ident" id="3110348">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3110353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3110357">tlsListener</span>&nbsp;<span class="op" id="3110369">:=</span>&nbsp;<span class="ident" id="3110372">tls</span><span class="op" id="3110375">.</span><span class="ident" id="3110376">NewListener</span><span class="op" id="3110387">(</span><span class="ident" id="3110388">tcpKeepAliveListener</span><span class="op" id="3110408">{</span><span class="ident" id="3110409">ln</span><span class="op" id="3110411">.</span><span class="op" id="3110412">(</span><span class="op" id="3110413">*</span><span class="ident" id="3110414">net</span><span class="op" id="3110417">.</span><span class="ident" id="3110418">TCPListener</span><span class="op" id="3110429">)</span><span class="op" id="3110430">}</span><span class="op" id="3110431">,</span>&nbsp;<span class="ident" id="3110433">config</span><span class="op" id="3110439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3110442">return</span>&nbsp;<span class="ident" id="3110449">srv</span><span class="op" id="3110452">.</span><span class="ident" id="3110453">Serve</span><span class="op" id="3110458">(</span><span class="ident" id="3110459">tlsListener</span><span class="op" id="3110470">)</span><br>
<span class="lineno">1880</span><span class="op" id="3110472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3110475">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3110550">//</span><br>
<span class="lineno"></span><span class="comment" id="3110553">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3110623">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3110694">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3110764">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3110827">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3110898">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3110920">func</span>&nbsp;<span class="ident" id="3110925">TimeoutHandler</span><span class="op" id="3110939">(</span><span class="ident" id="3110940">h</span>&nbsp;<span class="ident" id="3110942">Handler</span><span class="op" id="3110949">,</span>&nbsp;<span class="ident" id="3110951">dt</span>&nbsp;<span class="ident" id="3110954">time</span><span class="op" id="3110958">.</span><span class="ident" id="3110959">Duration</span><span class="op" id="3110967">,</span>&nbsp;<span class="ident" id="3110969">msg</span>&nbsp;<span class="builtintype" id="3110973">string</span><span class="op" id="3110979">)</span>&nbsp;<span class="ident" id="3110981">Handler</span>&nbsp;<span class="op" id="3110989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3110992">f</span>&nbsp;<span class="op" id="3110994">:=</span>&nbsp;<span class="keyword" id="3110997">func</span><span class="op" id="3111001">(</span><span class="op" id="3111002">)</span>&nbsp;<span class="op" id="3111004">&lt;-</span><span class="keyword" id="3111006">chan</span>&nbsp;<span class="ident" id="3111011">time</span><span class="op" id="3111015">.</span><span class="ident" id="3111016">Time</span>&nbsp;<span class="op" id="3111021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111025">return</span>&nbsp;<span class="ident" id="3111032">time</span><span class="op" id="3111036">.</span><span class="ident" id="3111037">After</span><span class="op" id="3111042">(</span><span class="ident" id="3111043">dt</span><span class="op" id="3111045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3111048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111051">return</span>&nbsp;<span class="op" id="3111058">&amp;</span><span class="ident" id="3111059">timeoutHandler</span><span class="op" id="3111073">{</span><span class="ident" id="3111074">h</span><span class="op" id="3111075">,</span>&nbsp;<span class="ident" id="3111077">f</span><span class="op" id="3111078">,</span>&nbsp;<span class="ident" id="3111080">msg</span><span class="op" id="3111083">}</span><br>
<span class="lineno">1895</span><span class="op" id="3111085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3111088">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3111151">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3111188">var</span>&nbsp;<span class="ident" id="3111192">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3111210">=</span>&nbsp;<span class="ident" id="3111212">errors</span><span class="op" id="3111218">.</span><span class="ident" id="3111219">New</span><span class="op" id="3111222">(</span><span class="string" id="3111223">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3111246">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3111249">type</span>&nbsp;<span class="ident" id="3111254">timeoutHandler</span>&nbsp;<span class="keyword" id="3111269">struct</span>&nbsp;<span class="op" id="3111276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111279">handler</span>&nbsp;<span class="ident" id="3111287">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111296">timeout</span>&nbsp;<span class="keyword" id="3111304">func</span><span class="op" id="3111308">(</span><span class="op" id="3111309">)</span>&nbsp;<span class="op" id="3111311">&lt;-</span><span class="keyword" id="3111313">chan</span>&nbsp;<span class="ident" id="3111318">time</span><span class="op" id="3111322">.</span><span class="ident" id="3111323">Time</span>&nbsp;<span class="comment" id="3111328">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111368">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3111376">string</span><br>
<span class="lineno">1905</span><span class="op" id="3111383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3111386">func</span>&nbsp;<span class="op" id="3111391">(</span><span class="ident" id="3111392">h</span>&nbsp;<span class="op" id="3111394">*</span><span class="ident" id="3111395">timeoutHandler</span><span class="op" id="3111409">)</span>&nbsp;<span class="ident" id="3111411">errorBody</span><span class="op" id="3111420">(</span><span class="op" id="3111421">)</span>&nbsp;<span class="builtintype" id="3111423">string</span>&nbsp;<span class="op" id="3111430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111433">if</span>&nbsp;<span class="ident" id="3111436">h</span><span class="op" id="3111437">.</span><span class="ident" id="3111438">body</span>&nbsp;<span class="op" id="3111443">!=</span>&nbsp;<span class="string" id="3111446">&#34;&#34;</span>&nbsp;<span class="op" id="3111449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111453">return</span>&nbsp;<span class="ident" id="3111460">h</span><span class="op" id="3111461">.</span><span class="ident" id="3111462">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3111468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111471">return</span>&nbsp;<span class="string" id="3111478">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3111558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3111561">func</span>&nbsp;<span class="op" id="3111566">(</span><span class="ident" id="3111567">h</span>&nbsp;<span class="op" id="3111569">*</span><span class="ident" id="3111570">timeoutHandler</span><span class="op" id="3111584">)</span>&nbsp;<span class="ident" id="3111586">ServeHTTP</span><span class="op" id="3111595">(</span><span class="ident" id="3111596">w</span>&nbsp;<span class="ident" id="3111598">ResponseWriter</span><span class="op" id="3111612">,</span>&nbsp;<span class="ident" id="3111614">r</span>&nbsp;<span class="op" id="3111616">*</span><span class="ident" id="3111617">Request</span><span class="op" id="3111624">)</span>&nbsp;<span class="op" id="3111626">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111629">done</span>&nbsp;<span class="op" id="3111634">:=</span>&nbsp;<span class="builtinfunc" id="3111637">make</span><span class="op" id="3111641">(</span><span class="keyword" id="3111642">chan</span>&nbsp;<span class="builtintype" id="3111647">bool</span><span class="op" id="3111651">,</span>&nbsp;<span class="num" id="3111653">1</span><span class="op" id="3111654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111657">tw</span>&nbsp;<span class="op" id="3111660">:=</span>&nbsp;<span class="op" id="3111663">&amp;</span><span class="ident" id="3111664">timeoutWriter</span><span class="op" id="3111677">{</span><span class="ident" id="3111678">w</span><span class="op" id="3111679">:</span>&nbsp;<span class="ident" id="3111681">w</span><span class="op" id="3111682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111685">go</span>&nbsp;<span class="keyword" id="3111688">func</span><span class="op" id="3111692">(</span><span class="op" id="3111693">)</span>&nbsp;<span class="op" id="3111695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111699">h</span><span class="op" id="3111700">.</span><span class="ident" id="3111701">handler</span><span class="op" id="3111708">.</span><span class="ident" id="3111709">ServeHTTP</span><span class="op" id="3111718">(</span><span class="ident" id="3111719">tw</span><span class="op" id="3111721">,</span>&nbsp;<span class="ident" id="3111723">r</span><span class="op" id="3111724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111728">done</span>&nbsp;<span class="op" id="3111733">&lt;-</span>&nbsp;<span class="builtintype" id="3111736">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3111742">}</span><span class="op" id="3111743">(</span><span class="op" id="3111744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111747">select</span>&nbsp;<span class="op" id="3111754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111757">case</span>&nbsp;<span class="op" id="3111762">&lt;-</span><span class="ident" id="3111764">done</span><span class="op" id="3111768">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111772">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111780">case</span>&nbsp;<span class="op" id="3111785">&lt;-</span><span class="ident" id="3111787">h</span><span class="op" id="3111788">.</span><span class="ident" id="3111789">timeout</span><span class="op" id="3111796">(</span><span class="op" id="3111797">)</span><span class="op" id="3111798">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111802">tw</span><span class="op" id="3111804">.</span><span class="ident" id="3111805">mu</span><span class="op" id="3111807">.</span><span class="ident" id="3111808">Lock</span><span class="op" id="3111812">(</span><span class="op" id="3111813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111817">defer</span>&nbsp;<span class="ident" id="3111823">tw</span><span class="op" id="3111825">.</span><span class="ident" id="3111826">mu</span><span class="op" id="3111828">.</span><span class="ident" id="3111829">Unlock</span><span class="op" id="3111835">(</span><span class="op" id="3111836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3111840">if</span>&nbsp;<span class="op" id="3111843">!</span><span class="ident" id="3111844">tw</span><span class="op" id="3111846">.</span><span class="ident" id="3111847">wroteHeader</span>&nbsp;<span class="op" id="3111859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111864">tw</span><span class="op" id="3111866">.</span><span class="ident" id="3111867">w</span><span class="op" id="3111868">.</span><span class="ident" id="3111869">WriteHeader</span><span class="op" id="3111880">(</span><span class="ident" id="3111881">StatusServiceUnavailable</span><span class="op" id="3111905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111910">tw</span><span class="op" id="3111912">.</span><span class="ident" id="3111913">w</span><span class="op" id="3111914">.</span><span class="ident" id="3111915">Write</span><span class="op" id="3111920">(</span><span class="op" id="3111921">[</span><span class="op" id="3111922">]</span><span class="builtintype" id="3111923">byte</span><span class="op" id="3111927">(</span><span class="ident" id="3111928">h</span><span class="op" id="3111929">.</span><span class="ident" id="3111930">errorBody</span><span class="op" id="3111939">(</span><span class="op" id="3111940">)</span><span class="op" id="3111941">)</span><span class="op" id="3111942">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3111946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3111950">tw</span><span class="op" id="3111952">.</span><span class="ident" id="3111953">timedOut</span>&nbsp;<span class="op" id="3111962">=</span>&nbsp;<span class="builtintype" id="3111964">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3111970">}</span><br>
<span class="lineno"></span><span class="op" id="3111972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3111975">type</span>&nbsp;<span class="ident" id="3111980">timeoutWriter</span>&nbsp;<span class="keyword" id="3111994">struct</span>&nbsp;<span class="op" id="3112001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112004">w</span>&nbsp;<span class="ident" id="3112006">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112023">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112035">sync</span><span class="op" id="3112039">.</span><span class="ident" id="3112040">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112047">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3112059">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112065">wroteHeader</span>&nbsp;<span class="builtintype" id="3112077">bool</span><br>
<span class="lineno"></span><span class="op" id="3112082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3112085">func</span>&nbsp;<span class="op" id="3112090">(</span><span class="ident" id="3112091">tw</span>&nbsp;<span class="op" id="3112094">*</span><span class="ident" id="3112095">timeoutWriter</span><span class="op" id="3112108">)</span>&nbsp;<span class="ident" id="3112110">Header</span><span class="op" id="3112116">(</span><span class="op" id="3112117">)</span>&nbsp;<span class="ident" id="3112119">Header</span>&nbsp;<span class="op" id="3112126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112129">return</span>&nbsp;<span class="ident" id="3112136">tw</span><span class="op" id="3112138">.</span><span class="ident" id="3112139">w</span><span class="op" id="3112140">.</span><span class="ident" id="3112141">Header</span><span class="op" id="3112147">(</span><span class="op" id="3112148">)</span><br>
<span class="lineno">1945</span><span class="op" id="3112150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3112153">func</span>&nbsp;<span class="op" id="3112158">(</span><span class="ident" id="3112159">tw</span>&nbsp;<span class="op" id="3112162">*</span><span class="ident" id="3112163">timeoutWriter</span><span class="op" id="3112176">)</span>&nbsp;<span class="ident" id="3112178">Write</span><span class="op" id="3112183">(</span><span class="ident" id="3112184">p</span>&nbsp;<span class="op" id="3112186">[</span><span class="op" id="3112187">]</span><span class="builtintype" id="3112188">byte</span><span class="op" id="3112192">)</span>&nbsp;<span class="op" id="3112194">(</span><span class="builtintype" id="3112195">int</span><span class="op" id="3112198">,</span>&nbsp;<span class="builtintype" id="3112200">error</span><span class="op" id="3112205">)</span>&nbsp;<span class="op" id="3112207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112210">tw</span><span class="op" id="3112212">.</span><span class="ident" id="3112213">mu</span><span class="op" id="3112215">.</span><span class="ident" id="3112216">Lock</span><span class="op" id="3112220">(</span><span class="op" id="3112221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112224">defer</span>&nbsp;<span class="ident" id="3112230">tw</span><span class="op" id="3112232">.</span><span class="ident" id="3112233">mu</span><span class="op" id="3112235">.</span><span class="ident" id="3112236">Unlock</span><span class="op" id="3112242">(</span><span class="op" id="3112243">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112246">tw</span><span class="op" id="3112248">.</span><span class="ident" id="3112249">wroteHeader</span>&nbsp;<span class="op" id="3112261">=</span>&nbsp;<span class="builtintype" id="3112263">true</span>&nbsp;<span class="comment" id="3112268">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112292">if</span>&nbsp;<span class="ident" id="3112295">tw</span><span class="op" id="3112297">.</span><span class="ident" id="3112298">timedOut</span>&nbsp;<span class="op" id="3112307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112311">return</span>&nbsp;<span class="num" id="3112318">0</span><span class="op" id="3112319">,</span>&nbsp;<span class="ident" id="3112321">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3112340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112343">return</span>&nbsp;<span class="ident" id="3112350">tw</span><span class="op" id="3112352">.</span><span class="ident" id="3112353">w</span><span class="op" id="3112354">.</span><span class="ident" id="3112355">Write</span><span class="op" id="3112360">(</span><span class="ident" id="3112361">p</span><span class="op" id="3112362">)</span><br>
<span class="lineno">1955</span><span class="op" id="3112364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3112367">func</span>&nbsp;<span class="op" id="3112372">(</span><span class="ident" id="3112373">tw</span>&nbsp;<span class="op" id="3112376">*</span><span class="ident" id="3112377">timeoutWriter</span><span class="op" id="3112390">)</span>&nbsp;<span class="ident" id="3112392">WriteHeader</span><span class="op" id="3112403">(</span><span class="ident" id="3112404">code</span>&nbsp;<span class="builtintype" id="3112409">int</span><span class="op" id="3112412">)</span>&nbsp;<span class="op" id="3112414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112417">tw</span><span class="op" id="3112419">.</span><span class="ident" id="3112420">mu</span><span class="op" id="3112422">.</span><span class="ident" id="3112423">Lock</span><span class="op" id="3112427">(</span><span class="op" id="3112428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112431">defer</span>&nbsp;<span class="ident" id="3112437">tw</span><span class="op" id="3112439">.</span><span class="ident" id="3112440">mu</span><span class="op" id="3112442">.</span><span class="ident" id="3112443">Unlock</span><span class="op" id="3112449">(</span><span class="op" id="3112450">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112453">if</span>&nbsp;<span class="ident" id="3112456">tw</span><span class="op" id="3112458">.</span><span class="ident" id="3112459">timedOut</span>&nbsp;<span class="op" id="3112468">||</span>&nbsp;<span class="ident" id="3112471">tw</span><span class="op" id="3112473">.</span><span class="ident" id="3112474">wroteHeader</span>&nbsp;<span class="op" id="3112486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112490">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3112498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112501">tw</span><span class="op" id="3112503">.</span><span class="ident" id="3112504">wroteHeader</span>&nbsp;<span class="op" id="3112516">=</span>&nbsp;<span class="builtintype" id="3112518">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112524">tw</span><span class="op" id="3112526">.</span><span class="ident" id="3112527">w</span><span class="op" id="3112528">.</span><span class="ident" id="3112529">WriteHeader</span><span class="op" id="3112540">(</span><span class="ident" id="3112541">code</span><span class="op" id="3112545">)</span><br>
<span class="lineno">1965</span><span class="op" id="3112547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3112550">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3112615">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3112684">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3112754">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3112766">type</span>&nbsp;<span class="ident" id="3112771">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3112792">struct</span>&nbsp;<span class="op" id="3112799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3112802">*</span><span class="ident" id="3112803">net</span><span class="op" id="3112806">.</span><span class="ident" id="3112807">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3112819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3112822">func</span>&nbsp;<span class="op" id="3112827">(</span><span class="ident" id="3112828">ln</span>&nbsp;<span class="ident" id="3112831">tcpKeepAliveListener</span><span class="op" id="3112851">)</span>&nbsp;<span class="ident" id="3112853">Accept</span><span class="op" id="3112859">(</span><span class="op" id="3112860">)</span>&nbsp;<span class="op" id="3112862">(</span><span class="ident" id="3112863">c</span>&nbsp;<span class="ident" id="3112865">net</span><span class="op" id="3112868">.</span><span class="ident" id="3112869">Conn</span><span class="op" id="3112873">,</span>&nbsp;<span class="ident" id="3112875">err</span>&nbsp;<span class="builtintype" id="3112879">error</span><span class="op" id="3112884">)</span>&nbsp;<span class="op" id="3112886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112889">tc</span><span class="op" id="3112891">,</span>&nbsp;<span class="ident" id="3112893">err</span>&nbsp;<span class="op" id="3112897">:=</span>&nbsp;<span class="ident" id="3112900">ln</span><span class="op" id="3112902">.</span><span class="ident" id="3112903">AcceptTCP</span><span class="op" id="3112912">(</span><span class="op" id="3112913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112916">if</span>&nbsp;<span class="ident" id="3112919">err</span>&nbsp;<span class="op" id="3112923">!=</span>&nbsp;<span class="ident" id="3112926">nil</span>&nbsp;<span class="op" id="3112930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3112934">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3112942">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112945">tc</span><span class="op" id="3112947">.</span><span class="ident" id="3112948">SetKeepAlive</span><span class="op" id="3112960">(</span><span class="builtintype" id="3112961">true</span><span class="op" id="3112965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3112968">tc</span><span class="op" id="3112970">.</span><span class="ident" id="3112971">SetKeepAlivePeriod</span><span class="op" id="3112989">(</span><span class="num" id="3112990">3</span>&nbsp;<span class="op" id="3112992">*</span>&nbsp;<span class="ident" id="3112994">time</span><span class="op" id="3112998">.</span><span class="ident" id="3112999">Minute</span><span class="op" id="3113005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3113008">return</span>&nbsp;<span class="ident" id="3113015">tc</span><span class="op" id="3113017">,</span>&nbsp;<span class="ident" id="3113019">nil</span><br>
<span class="lineno"></span><span class="op" id="3113023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3113026">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3113084">type</span>&nbsp;<span class="ident" id="3113089">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3113110">struct</span><span class="op" id="3113116">{</span><span class="op" id="3113117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3113120">func</span>&nbsp;<span class="op" id="3113125">(</span><span class="ident" id="3113126">globalOptionsHandler</span><span class="op" id="3113146">)</span>&nbsp;<span class="ident" id="3113148">ServeHTTP</span><span class="op" id="3113157">(</span><span class="ident" id="3113158">w</span>&nbsp;<span class="ident" id="3113160">ResponseWriter</span><span class="op" id="3113174">,</span>&nbsp;<span class="ident" id="3113176">r</span>&nbsp;<span class="op" id="3113178">*</span><span class="ident" id="3113179">Request</span><span class="op" id="3113186">)</span>&nbsp;<span class="op" id="3113188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3113191">w</span><span class="op" id="3113192">.</span><span class="ident" id="3113193">Header</span><span class="op" id="3113199">(</span><span class="op" id="3113200">)</span><span class="op" id="3113201">.</span><span class="ident" id="3113202">Set</span><span class="op" id="3113205">(</span><span class="string" id="3113206">&#34;Content-Length&#34;</span><span class="op" id="3113222">,</span>&nbsp;<span class="string" id="3113224">&#34;0&#34;</span><span class="op" id="3113227">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3113230">if</span>&nbsp;<span class="ident" id="3113233">r</span><span class="op" id="3113234">.</span><span class="ident" id="3113235">ContentLength</span>&nbsp;<span class="op" id="3113249">!=</span>&nbsp;<span class="num" id="3113252">0</span>&nbsp;<span class="op" id="3113254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3113258">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3113315">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3113373">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3113430">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3113489">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3113537">mb</span>&nbsp;<span class="op" id="3113540">:=</span>&nbsp;<span class="ident" id="3113543">MaxBytesReader</span><span class="op" id="3113557">(</span><span class="ident" id="3113558">w</span><span class="op" id="3113559">,</span>&nbsp;<span class="ident" id="3113561">r</span><span class="op" id="3113562">.</span><span class="ident" id="3113563">Body</span><span class="op" id="3113567">,</span>&nbsp;<span class="num" id="3113569">4</span><span class="op" id="3113570">&lt;&lt;</span><span class="num" id="3113572">10</span><span class="op" id="3113574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3113578">io</span><span class="op" id="3113580">.</span><span class="ident" id="3113581">Copy</span><span class="op" id="3113585">(</span><span class="ident" id="3113586">ioutil</span><span class="op" id="3113592">.</span><span class="ident" id="3113593">Discard</span><span class="op" id="3113600">,</span>&nbsp;<span class="ident" id="3113602">mb</span><span class="op" id="3113604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3113607">}</span><br>
<span class="lineno"></span><span class="op" id="3113609">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3113612">type</span>&nbsp;<span class="ident" id="3113617">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3113638">struct</span><span class="op" id="3113644">{</span><span class="op" id="3113645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3113648">func</span>&nbsp;<span class="op" id="3113653">(</span><span class="ident" id="3113654">eofReaderWithWriteTo</span><span class="op" id="3113674">)</span>&nbsp;<span class="ident" id="3113676">WriteTo</span><span class="op" id="3113683">(</span><span class="ident" id="3113684">io</span><span class="op" id="3113686">.</span><span class="ident" id="3113687">Writer</span><span class="op" id="3113693">)</span>&nbsp;<span class="op" id="3113695">(</span><span class="ident" id="3113696">int64</span><span class="op" id="3113701">,</span>&nbsp;<span class="builtintype" id="3113703">error</span><span class="op" id="3113708">)</span>&nbsp;<span class="op" id="3113710">{</span>&nbsp;<span class="keyword" id="3113712">return</span>&nbsp;<span class="num" id="3113719">0</span><span class="op" id="3113720">,</span>&nbsp;<span class="ident" id="3113722">nil</span>&nbsp;<span class="op" id="3113726">}</span><br>
<span class="lineno"></span><span class="keyword" id="3113728">func</span>&nbsp;<span class="op" id="3113733">(</span><span class="ident" id="3113734">eofReaderWithWriteTo</span><span class="op" id="3113754">)</span>&nbsp;<span class="ident" id="3113756">Read</span><span class="op" id="3113760">(</span><span class="op" id="3113761">[</span><span class="op" id="3113762">]</span><span class="builtintype" id="3113763">byte</span><span class="op" id="3113767">)</span>&nbsp;<span class="op" id="3113769">(</span><span class="builtintype" id="3113770">int</span><span class="op" id="3113773">,</span>&nbsp;<span class="builtintype" id="3113775">error</span><span class="op" id="3113780">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113790">{</span>&nbsp;<span class="keyword" id="3113792">return</span>&nbsp;<span class="num" id="3113799">0</span><span class="op" id="3113800">,</span>&nbsp;<span class="ident" id="3113802">io</span><span class="op" id="3113804">.</span><span class="ident" id="3113805">EOF</span>&nbsp;<span class="op" id="3113809">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3113812">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3113877">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3113936">var</span>&nbsp;<span class="ident" id="3113940">eofReader</span>&nbsp;<span class="op" id="3113950">=</span>&nbsp;<span class="op" id="3113952">&amp;</span><span class="keyword" id="3113953">struct</span>&nbsp;<span class="op" id="3113960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3113963">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3113985">io</span><span class="op" id="3113987">.</span><span class="ident" id="3113988">Closer</span><br>
<span class="lineno"></span><span class="op" id="3113995">}</span><span class="op" id="3113996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3113999">eofReaderWithWriteTo</span><span class="op" id="3114019">{</span><span class="op" id="3114020">}</span><span class="op" id="3114021">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114024">ioutil</span><span class="op" id="3114030">.</span><span class="ident" id="3114031">NopCloser</span><span class="op" id="3114040">(</span><span class="ident" id="3114041">nil</span><span class="op" id="3114044">)</span><span class="op" id="3114045">,</span><br>
<span class="lineno"></span><span class="op" id="3114047">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3114050">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3114118">var</span>&nbsp;<span class="ident" id="3114122">_</span>&nbsp;<span class="ident" id="3114124">io</span><span class="op" id="3114126">.</span><span class="ident" id="3114127">WriterTo</span>&nbsp;<span class="op" id="3114136">=</span>&nbsp;<span class="ident" id="3114138">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3114149">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3114211">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3114279">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3114324">type</span>&nbsp;<span class="ident" id="3114329">initNPNRequest</span>&nbsp;<span class="keyword" id="3114344">struct</span>&nbsp;<span class="op" id="3114351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114354">c</span>&nbsp;<span class="op" id="3114356">*</span><span class="ident" id="3114357">tls</span><span class="op" id="3114360">.</span><span class="ident" id="3114361">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114367">h</span>&nbsp;<span class="ident" id="3114369">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="3114383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3114386">func</span>&nbsp;<span class="op" id="3114391">(</span><span class="ident" id="3114392">h</span>&nbsp;<span class="ident" id="3114394">initNPNRequest</span><span class="op" id="3114408">)</span>&nbsp;<span class="ident" id="3114410">ServeHTTP</span><span class="op" id="3114419">(</span><span class="ident" id="3114420">rw</span>&nbsp;<span class="ident" id="3114423">ResponseWriter</span><span class="op" id="3114437">,</span>&nbsp;<span class="ident" id="3114439">req</span>&nbsp;<span class="op" id="3114443">*</span><span class="ident" id="3114444">Request</span><span class="op" id="3114451">)</span>&nbsp;<span class="op" id="3114453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3114456">if</span>&nbsp;<span class="ident" id="3114459">req</span><span class="op" id="3114462">.</span><span class="ident" id="3114463">TLS</span>&nbsp;<span class="op" id="3114467">==</span>&nbsp;<span class="ident" id="3114470">nil</span>&nbsp;<span class="op" id="3114474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114478">req</span><span class="op" id="3114481">.</span><span class="ident" id="3114482">TLS</span>&nbsp;<span class="op" id="3114486">=</span>&nbsp;<span class="op" id="3114488">&amp;</span><span class="ident" id="3114489">tls</span><span class="op" id="3114492">.</span><span class="ident" id="3114493">ConnectionState</span><span class="op" id="3114508">{</span><span class="op" id="3114509">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3114513">*</span><span class="ident" id="3114514">req</span><span class="op" id="3114517">.</span><span class="ident" id="3114518">TLS</span>&nbsp;<span class="op" id="3114522">=</span>&nbsp;<span class="ident" id="3114524">h</span><span class="op" id="3114525">.</span><span class="ident" id="3114526">c</span><span class="op" id="3114527">.</span><span class="ident" id="3114528">ConnectionState</span><span class="op" id="3114543">(</span><span class="op" id="3114544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3114547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3114550">if</span>&nbsp;<span class="ident" id="3114553">req</span><span class="op" id="3114556">.</span><span class="ident" id="3114557">Body</span>&nbsp;<span class="op" id="3114562">==</span>&nbsp;<span class="ident" id="3114565">nil</span>&nbsp;<span class="op" id="3114569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114573">req</span><span class="op" id="3114576">.</span><span class="ident" id="3114577">Body</span>&nbsp;<span class="op" id="3114582">=</span>&nbsp;<span class="ident" id="3114584">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3114595">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3114598">if</span>&nbsp;<span class="ident" id="3114601">req</span><span class="op" id="3114604">.</span><span class="ident" id="3114605">RemoteAddr</span>&nbsp;<span class="op" id="3114616">==</span>&nbsp;<span class="string" id="3114619">&#34;&#34;</span>&nbsp;<span class="op" id="3114622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114626">req</span><span class="op" id="3114629">.</span><span class="ident" id="3114630">RemoteAddr</span>&nbsp;<span class="op" id="3114641">=</span>&nbsp;<span class="ident" id="3114643">h</span><span class="op" id="3114644">.</span><span class="ident" id="3114645">c</span><span class="op" id="3114646">.</span><span class="ident" id="3114647">RemoteAddr</span><span class="op" id="3114657">(</span><span class="op" id="3114658">)</span><span class="op" id="3114659">.</span><span class="ident" id="3114660">String</span><span class="op" id="3114666">(</span><span class="op" id="3114667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3114670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114673">h</span><span class="op" id="3114674">.</span><span class="ident" id="3114675">h</span><span class="op" id="3114676">.</span><span class="ident" id="3114677">ServeHTTP</span><span class="op" id="3114686">(</span><span class="ident" id="3114687">rw</span><span class="op" id="3114689">,</span>&nbsp;<span class="ident" id="3114691">req</span><span class="op" id="3114694">)</span><br>
<span class="lineno"></span><span class="op" id="3114696">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3114699">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3114737">type</span>&nbsp;<span class="ident" id="3114742">loggingConn</span>&nbsp;<span class="keyword" id="3114754">struct</span>&nbsp;<span class="op" id="3114761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114764">name</span>&nbsp;<span class="builtintype" id="3114769">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114777">net</span><span class="op" id="3114780">.</span><span class="ident" id="3114781">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3114786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3114789">var</span>&nbsp;<span class="op" id="3114793">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114796">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3114809">sync</span><span class="op" id="3114813">.</span><span class="ident" id="3114814">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114821">uniqNameNext</span>&nbsp;<span class="op" id="3114834">=</span>&nbsp;<span class="builtinfunc" id="3114836">make</span><span class="op" id="3114840">(</span><span class="keyword" id="3114841">map</span><span class="op" id="3114844">[</span><span class="builtintype" id="3114845">string</span><span class="op" id="3114851">]</span><span class="builtintype" id="3114852">int</span><span class="op" id="3114855">)</span><br>
<span class="lineno">2050</span><span class="op" id="3114857">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3114860">func</span>&nbsp;<span class="ident" id="3114865">newLoggingConn</span><span class="op" id="3114879">(</span><span class="ident" id="3114880">baseName</span>&nbsp;<span class="builtintype" id="3114889">string</span><span class="op" id="3114895">,</span>&nbsp;<span class="ident" id="3114897">c</span>&nbsp;<span class="ident" id="3114899">net</span><span class="op" id="3114902">.</span><span class="ident" id="3114903">Conn</span><span class="op" id="3114907">)</span>&nbsp;<span class="ident" id="3114909">net</span><span class="op" id="3114912">.</span><span class="ident" id="3114913">Conn</span>&nbsp;<span class="op" id="3114918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114921">uniqNameMu</span><span class="op" id="3114931">.</span><span class="ident" id="3114932">Lock</span><span class="op" id="3114936">(</span><span class="op" id="3114937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3114940">defer</span>&nbsp;<span class="ident" id="3114946">uniqNameMu</span><span class="op" id="3114956">.</span><span class="ident" id="3114957">Unlock</span><span class="op" id="3114963">(</span><span class="op" id="3114964">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3114967">uniqNameNext</span><span class="op" id="3114979">[</span><span class="ident" id="3114980">baseName</span><span class="op" id="3114988">]</span><span class="op" id="3114989">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3114993">return</span>&nbsp;<span class="op" id="3115000">&amp;</span><span class="ident" id="3115001">loggingConn</span><span class="op" id="3115012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115016">name</span><span class="op" id="3115020">:</span>&nbsp;<span class="ident" id="3115022">fmt</span><span class="op" id="3115025">.</span><span class="ident" id="3115026">Sprintf</span><span class="op" id="3115033">(</span><span class="string" id="3115034">&#34;%s-%d&#34;</span><span class="op" id="3115041">,</span>&nbsp;<span class="ident" id="3115043">baseName</span><span class="op" id="3115051">,</span>&nbsp;<span class="ident" id="3115053">uniqNameNext</span><span class="op" id="3115065">[</span><span class="ident" id="3115066">baseName</span><span class="op" id="3115074">]</span><span class="op" id="3115075">)</span><span class="op" id="3115076">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115080">Conn</span><span class="op" id="3115084">:</span>&nbsp;<span class="ident" id="3115086">c</span><span class="op" id="3115087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3115090">}</span><br>
<span class="lineno">2060</span><span class="op" id="3115092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3115095">func</span>&nbsp;<span class="op" id="3115100">(</span><span class="ident" id="3115101">c</span>&nbsp;<span class="op" id="3115103">*</span><span class="ident" id="3115104">loggingConn</span><span class="op" id="3115115">)</span>&nbsp;<span class="ident" id="3115117">Write</span><span class="op" id="3115122">(</span><span class="ident" id="3115123">p</span>&nbsp;<span class="op" id="3115125">[</span><span class="op" id="3115126">]</span><span class="builtintype" id="3115127">byte</span><span class="op" id="3115131">)</span>&nbsp;<span class="op" id="3115133">(</span><span class="ident" id="3115134">n</span>&nbsp;<span class="builtintype" id="3115136">int</span><span class="op" id="3115139">,</span>&nbsp;<span class="ident" id="3115141">err</span>&nbsp;<span class="builtintype" id="3115145">error</span><span class="op" id="3115150">)</span>&nbsp;<span class="op" id="3115152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115155">log</span><span class="op" id="3115158">.</span><span class="ident" id="3115159">Printf</span><span class="op" id="3115165">(</span><span class="string" id="3115166">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3115187">,</span>&nbsp;<span class="ident" id="3115189">c</span><span class="op" id="3115190">.</span><span class="ident" id="3115191">name</span><span class="op" id="3115195">,</span>&nbsp;<span class="builtinfunc" id="3115197">len</span><span class="op" id="3115200">(</span><span class="ident" id="3115201">p</span><span class="op" id="3115202">)</span><span class="op" id="3115203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115206">n</span><span class="op" id="3115207">,</span>&nbsp;<span class="ident" id="3115209">err</span>&nbsp;<span class="op" id="3115213">=</span>&nbsp;<span class="ident" id="3115215">c</span><span class="op" id="3115216">.</span><span class="ident" id="3115217">Conn</span><span class="op" id="3115221">.</span><span class="ident" id="3115222">Write</span><span class="op" id="3115227">(</span><span class="ident" id="3115228">p</span><span class="op" id="3115229">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115232">log</span><span class="op" id="3115235">.</span><span class="ident" id="3115236">Printf</span><span class="op" id="3115242">(</span><span class="string" id="3115243">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3115266">,</span>&nbsp;<span class="ident" id="3115268">c</span><span class="op" id="3115269">.</span><span class="ident" id="3115270">name</span><span class="op" id="3115274">,</span>&nbsp;<span class="builtinfunc" id="3115276">len</span><span class="op" id="3115279">(</span><span class="ident" id="3115280">p</span><span class="op" id="3115281">)</span><span class="op" id="3115282">,</span>&nbsp;<span class="ident" id="3115284">n</span><span class="op" id="3115285">,</span>&nbsp;<span class="ident" id="3115287">err</span><span class="op" id="3115290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3115293">return</span><br>
<span class="lineno"></span><span class="op" id="3115300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3115303">func</span>&nbsp;<span class="op" id="3115308">(</span><span class="ident" id="3115309">c</span>&nbsp;<span class="op" id="3115311">*</span><span class="ident" id="3115312">loggingConn</span><span class="op" id="3115323">)</span>&nbsp;<span class="ident" id="3115325">Read</span><span class="op" id="3115329">(</span><span class="ident" id="3115330">p</span>&nbsp;<span class="op" id="3115332">[</span><span class="op" id="3115333">]</span><span class="builtintype" id="3115334">byte</span><span class="op" id="3115338">)</span>&nbsp;<span class="op" id="3115340">(</span><span class="ident" id="3115341">n</span>&nbsp;<span class="builtintype" id="3115343">int</span><span class="op" id="3115346">,</span>&nbsp;<span class="ident" id="3115348">err</span>&nbsp;<span class="builtintype" id="3115352">error</span><span class="op" id="3115357">)</span>&nbsp;<span class="op" id="3115359">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115362">log</span><span class="op" id="3115365">.</span><span class="ident" id="3115366">Printf</span><span class="op" id="3115372">(</span><span class="string" id="3115373">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3115393">,</span>&nbsp;<span class="ident" id="3115395">c</span><span class="op" id="3115396">.</span><span class="ident" id="3115397">name</span><span class="op" id="3115401">,</span>&nbsp;<span class="builtinfunc" id="3115403">len</span><span class="op" id="3115406">(</span><span class="ident" id="3115407">p</span><span class="op" id="3115408">)</span><span class="op" id="3115409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115412">n</span><span class="op" id="3115413">,</span>&nbsp;<span class="ident" id="3115415">err</span>&nbsp;<span class="op" id="3115419">=</span>&nbsp;<span class="ident" id="3115421">c</span><span class="op" id="3115422">.</span><span class="ident" id="3115423">Conn</span><span class="op" id="3115427">.</span><span class="ident" id="3115428">Read</span><span class="op" id="3115432">(</span><span class="ident" id="3115433">p</span><span class="op" id="3115434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115437">log</span><span class="op" id="3115440">.</span><span class="ident" id="3115441">Printf</span><span class="op" id="3115447">(</span><span class="string" id="3115448">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3115470">,</span>&nbsp;<span class="ident" id="3115472">c</span><span class="op" id="3115473">.</span><span class="ident" id="3115474">name</span><span class="op" id="3115478">,</span>&nbsp;<span class="builtinfunc" id="3115480">len</span><span class="op" id="3115483">(</span><span class="ident" id="3115484">p</span><span class="op" id="3115485">)</span><span class="op" id="3115486">,</span>&nbsp;<span class="ident" id="3115488">n</span><span class="op" id="3115489">,</span>&nbsp;<span class="ident" id="3115491">err</span><span class="op" id="3115494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3115497">return</span><br>
<span class="lineno"></span><span class="op" id="3115504">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3115507">func</span>&nbsp;<span class="op" id="3115512">(</span><span class="ident" id="3115513">c</span>&nbsp;<span class="op" id="3115515">*</span><span class="ident" id="3115516">loggingConn</span><span class="op" id="3115527">)</span>&nbsp;<span class="ident" id="3115529">Close</span><span class="op" id="3115534">(</span><span class="op" id="3115535">)</span>&nbsp;<span class="op" id="3115537">(</span><span class="ident" id="3115538">err</span>&nbsp;<span class="builtintype" id="3115542">error</span><span class="op" id="3115547">)</span>&nbsp;<span class="op" id="3115549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115552">log</span><span class="op" id="3115555">.</span><span class="ident" id="3115556">Printf</span><span class="op" id="3115562">(</span><span class="string" id="3115563">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3115581">,</span>&nbsp;<span class="ident" id="3115583">c</span><span class="op" id="3115584">.</span><span class="ident" id="3115585">name</span><span class="op" id="3115589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115592">err</span>&nbsp;<span class="op" id="3115596">=</span>&nbsp;<span class="ident" id="3115598">c</span><span class="op" id="3115599">.</span><span class="ident" id="3115600">Conn</span><span class="op" id="3115604">.</span><span class="ident" id="3115605">Close</span><span class="op" id="3115610">(</span><span class="op" id="3115611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115614">log</span><span class="op" id="3115617">.</span><span class="ident" id="3115618">Printf</span><span class="op" id="3115624">(</span><span class="string" id="3115625">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3115642">,</span>&nbsp;<span class="ident" id="3115644">c</span><span class="op" id="3115645">.</span><span class="ident" id="3115646">name</span><span class="op" id="3115650">,</span>&nbsp;<span class="ident" id="3115652">err</span><span class="op" id="3115655">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3115658">return</span><br>
<span class="lineno"></span><span class="op" id="3115665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3115668">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3115748">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3115815">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3115874">type</span>&nbsp;<span class="ident" id="3115879">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3115900">struct</span>&nbsp;<span class="op" id="3115907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115910">c</span>&nbsp;<span class="op" id="3115912">*</span><span class="ident" id="3115913">conn</span><br>
<span class="lineno"></span><span class="op" id="3115918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3115921">func</span>&nbsp;<span class="op" id="3115926">(</span><span class="ident" id="3115927">w</span>&nbsp;<span class="ident" id="3115929">checkConnErrorWriter</span><span class="op" id="3115949">)</span>&nbsp;<span class="ident" id="3115951">Write</span><span class="op" id="3115956">(</span><span class="ident" id="3115957">p</span>&nbsp;<span class="op" id="3115959">[</span><span class="op" id="3115960">]</span><span class="builtintype" id="3115961">byte</span><span class="op" id="3115965">)</span>&nbsp;<span class="op" id="3115967">(</span><span class="ident" id="3115968">n</span>&nbsp;<span class="builtintype" id="3115970">int</span><span class="op" id="3115973">,</span>&nbsp;<span class="ident" id="3115975">err</span>&nbsp;<span class="builtintype" id="3115979">error</span><span class="op" id="3115984">)</span>&nbsp;<span class="op" id="3115986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3115989">n</span><span class="op" id="3115990">,</span>&nbsp;<span class="ident" id="3115992">err</span>&nbsp;<span class="op" id="3115996">=</span>&nbsp;<span class="ident" id="3115998">w</span><span class="op" id="3115999">.</span><span class="ident" id="3116000">c</span><span class="op" id="3116001">.</span><span class="ident" id="3116002">w</span><span class="op" id="3116003">.</span><span class="ident" id="3116004">Write</span><span class="op" id="3116009">(</span><span class="ident" id="3116010">p</span><span class="op" id="3116011">)</span>&nbsp;<span class="comment" id="3116013">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3116071">if</span>&nbsp;<span class="ident" id="3116074">err</span>&nbsp;<span class="op" id="3116078">!=</span>&nbsp;<span class="ident" id="3116081">nil</span>&nbsp;<span class="op" id="3116085">&amp;&amp;</span>&nbsp;<span class="ident" id="3116088">w</span><span class="op" id="3116089">.</span><span class="ident" id="3116090">c</span><span class="op" id="3116091">.</span><span class="ident" id="3116092">werr</span>&nbsp;<span class="op" id="3116097">==</span>&nbsp;<span class="ident" id="3116100">nil</span>&nbsp;<span class="op" id="3116104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3116108">w</span><span class="op" id="3116109">.</span><span class="ident" id="3116110">c</span><span class="op" id="3116111">.</span><span class="ident" id="3116112">werr</span>&nbsp;<span class="op" id="3116117">=</span>&nbsp;<span class="ident" id="3116119">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3116124">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3116127">return</span><br>
<span class="lineno"></span><span class="op" id="3116134">}</span>
</div>
</body>
</html>
