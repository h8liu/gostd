<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3126097">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3126152">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3126206">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3126257">package</span>&nbsp;<span class="ident" id="3126265">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126271">import</span>&nbsp;<span class="op" id="3126278">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126281">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126290">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126299">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126309">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126316">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126322">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126335">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126356">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126373">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126381">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126392">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3126403">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3126410">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3126413">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="3126483">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3126519">var</span>&nbsp;<span class="ident" id="3126523">ErrLineTooLong</span>&nbsp;<span class="op" id="3126538">=</span>&nbsp;<span class="ident" id="3126540">internal</span><span class="op" id="3126548">.</span><span class="ident" id="3126549">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3126565">type</span>&nbsp;<span class="ident" id="3126570">errorReader</span>&nbsp;<span class="keyword" id="3126582">struct</span>&nbsp;<span class="op" id="3126589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126592">err</span>&nbsp;<span class="builtintype" id="3126596">error</span><br>
<span class="lineno"></span><span class="op" id="3126602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3126605">func</span>&nbsp;<span class="op" id="3126610">(</span><span class="ident" id="3126611">r</span>&nbsp;<span class="op" id="3126613">*</span><span class="ident" id="3126614">errorReader</span><span class="op" id="3126625">)</span>&nbsp;<span class="ident" id="3126627">Read</span><span class="op" id="3126631">(</span><span class="ident" id="3126632">p</span>&nbsp;<span class="op" id="3126634">[</span><span class="op" id="3126635">]</span><span class="builtintype" id="3126636">byte</span><span class="op" id="3126640">)</span>&nbsp;<span class="op" id="3126642">(</span><span class="ident" id="3126643">n</span>&nbsp;<span class="builtintype" id="3126645">int</span><span class="op" id="3126648">,</span>&nbsp;<span class="ident" id="3126650">err</span>&nbsp;<span class="builtintype" id="3126654">error</span><span class="op" id="3126659">)</span>&nbsp;<span class="op" id="3126661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126664">return</span>&nbsp;<span class="num" id="3126671">0</span><span class="op" id="3126672">,</span>&nbsp;<span class="ident" id="3126674">r</span><span class="op" id="3126675">.</span><span class="ident" id="3126676">err</span><br>
<span class="lineno"></span><span class="op" id="3126680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3126683">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="3126761">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3126837">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3126904">type</span>&nbsp;<span class="ident" id="3126909">transferWriter</span>&nbsp;<span class="keyword" id="3126924">struct</span>&nbsp;<span class="op" id="3126931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126934">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3126951">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126959">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126976">io</span><span class="op" id="3126978">.</span><span class="ident" id="3126979">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126987">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127004">io</span><span class="op" id="3127006">.</span><span class="ident" id="3127007">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127015">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3127032">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127038">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127055">int64</span>&nbsp;<span class="comment" id="3127061">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127104">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3127121">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127127">TransferEncoding</span>&nbsp;<span class="op" id="3127144">[</span><span class="op" id="3127145">]</span><span class="builtintype" id="3127146">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127154">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127171">Header</span><br>
<span class="lineno"></span><span class="op" id="3127178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3127181">func</span>&nbsp;<span class="ident" id="3127186">newTransferWriter</span><span class="op" id="3127203">(</span><span class="ident" id="3127204">r</span>&nbsp;<span class="keyword" id="3127206">interface</span><span class="op" id="3127215">{</span><span class="op" id="3127216">}</span><span class="op" id="3127217">)</span>&nbsp;<span class="op" id="3127219">(</span><span class="ident" id="3127220">t</span>&nbsp;<span class="op" id="3127222">*</span><span class="ident" id="3127223">transferWriter</span><span class="op" id="3127237">,</span>&nbsp;<span class="ident" id="3127239">err</span>&nbsp;<span class="builtintype" id="3127243">error</span><span class="op" id="3127248">)</span>&nbsp;<span class="op" id="3127250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127253">t</span>&nbsp;<span class="op" id="3127255">=</span>&nbsp;<span class="op" id="3127257">&amp;</span><span class="ident" id="3127258">transferWriter</span><span class="op" id="3127272">{</span><span class="op" id="3127273">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3127277">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127305">atLeastHTTP11</span>&nbsp;<span class="op" id="3127319">:=</span>&nbsp;<span class="builtintype" id="3127322">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127329">switch</span>&nbsp;<span class="ident" id="3127336">rr</span>&nbsp;<span class="op" id="3127339">:=</span>&nbsp;<span class="ident" id="3127342">r</span><span class="op" id="3127343">.</span><span class="op" id="3127344">(</span><span class="keyword" id="3127345">type</span><span class="op" id="3127349">)</span>&nbsp;<span class="op" id="3127351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127354">case</span>&nbsp;<span class="op" id="3127359">*</span><span class="ident" id="3127360">Request</span><span class="op" id="3127367">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127371">if</span>&nbsp;<span class="ident" id="3127374">rr</span><span class="op" id="3127376">.</span><span class="ident" id="3127377">ContentLength</span>&nbsp;<span class="op" id="3127391">!=</span>&nbsp;<span class="num" id="3127394">0</span>&nbsp;<span class="op" id="3127396">&amp;&amp;</span>&nbsp;<span class="ident" id="3127399">rr</span><span class="op" id="3127401">.</span><span class="ident" id="3127402">Body</span>&nbsp;<span class="op" id="3127407">==</span>&nbsp;<span class="ident" id="3127410">nil</span>&nbsp;<span class="op" id="3127414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127419">return</span>&nbsp;<span class="ident" id="3127426">nil</span><span class="op" id="3127429">,</span>&nbsp;<span class="ident" id="3127431">fmt</span><span class="op" id="3127434">.</span><span class="ident" id="3127435">Errorf</span><span class="op" id="3127441">(</span><span class="string" id="3127442">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="3127488">,</span>&nbsp;<span class="ident" id="3127490">rr</span><span class="op" id="3127492">.</span><span class="ident" id="3127493">ContentLength</span><span class="op" id="3127506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3127510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127514">t</span><span class="op" id="3127515">.</span><span class="ident" id="3127516">Method</span>&nbsp;<span class="op" id="3127523">=</span>&nbsp;<span class="ident" id="3127525">rr</span><span class="op" id="3127527">.</span><span class="ident" id="3127528">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127537">t</span><span class="op" id="3127538">.</span><span class="ident" id="3127539">Body</span>&nbsp;<span class="op" id="3127544">=</span>&nbsp;<span class="ident" id="3127546">rr</span><span class="op" id="3127548">.</span><span class="ident" id="3127549">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127556">t</span><span class="op" id="3127557">.</span><span class="ident" id="3127558">BodyCloser</span>&nbsp;<span class="op" id="3127569">=</span>&nbsp;<span class="ident" id="3127571">rr</span><span class="op" id="3127573">.</span><span class="ident" id="3127574">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127581">t</span><span class="op" id="3127582">.</span><span class="ident" id="3127583">ContentLength</span>&nbsp;<span class="op" id="3127597">=</span>&nbsp;<span class="ident" id="3127599">rr</span><span class="op" id="3127601">.</span><span class="ident" id="3127602">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127618">t</span><span class="op" id="3127619">.</span><span class="ident" id="3127620">Close</span>&nbsp;<span class="op" id="3127626">=</span>&nbsp;<span class="ident" id="3127628">rr</span><span class="op" id="3127630">.</span><span class="ident" id="3127631">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127639">t</span><span class="op" id="3127640">.</span><span class="ident" id="3127641">TransferEncoding</span>&nbsp;<span class="op" id="3127658">=</span>&nbsp;<span class="ident" id="3127660">rr</span><span class="op" id="3127662">.</span><span class="ident" id="3127663">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127682">t</span><span class="op" id="3127683">.</span><span class="ident" id="3127684">Trailer</span>&nbsp;<span class="op" id="3127692">=</span>&nbsp;<span class="ident" id="3127694">rr</span><span class="op" id="3127696">.</span><span class="ident" id="3127697">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127707">atLeastHTTP11</span>&nbsp;<span class="op" id="3127721">=</span>&nbsp;<span class="ident" id="3127723">rr</span><span class="op" id="3127725">.</span><span class="ident" id="3127726">ProtoAtLeast</span><span class="op" id="3127738">(</span><span class="num" id="3127739">1</span><span class="op" id="3127740">,</span>&nbsp;<span class="num" id="3127742">1</span><span class="op" id="3127743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127747">if</span>&nbsp;<span class="ident" id="3127750">t</span><span class="op" id="3127751">.</span><span class="ident" id="3127752">Body</span>&nbsp;<span class="op" id="3127757">!=</span>&nbsp;<span class="ident" id="3127760">nil</span>&nbsp;<span class="op" id="3127764">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3127767">len</span><span class="op" id="3127770">(</span><span class="ident" id="3127771">t</span><span class="op" id="3127772">.</span><span class="ident" id="3127773">TransferEncoding</span><span class="op" id="3127789">)</span>&nbsp;<span class="op" id="3127791">==</span>&nbsp;<span class="num" id="3127794">0</span>&nbsp;<span class="op" id="3127796">&amp;&amp;</span>&nbsp;<span class="ident" id="3127799">atLeastHTTP11</span>&nbsp;<span class="op" id="3127813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127818">if</span>&nbsp;<span class="ident" id="3127821">t</span><span class="op" id="3127822">.</span><span class="ident" id="3127823">ContentLength</span>&nbsp;<span class="op" id="3127837">==</span>&nbsp;<span class="num" id="3127840">0</span>&nbsp;<span class="op" id="3127842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3127848">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127904">var</span>&nbsp;<span class="ident" id="3127908">buf</span>&nbsp;<span class="op" id="3127912">[</span><span class="num" id="3127913">1</span><span class="op" id="3127914">]</span><span class="builtintype" id="3127915">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127924">n</span><span class="op" id="3127925">,</span>&nbsp;<span class="ident" id="3127927">rerr</span>&nbsp;<span class="op" id="3127932">:=</span>&nbsp;<span class="ident" id="3127935">io</span><span class="op" id="3127937">.</span><span class="ident" id="3127938">ReadFull</span><span class="op" id="3127946">(</span><span class="ident" id="3127947">t</span><span class="op" id="3127948">.</span><span class="ident" id="3127949">Body</span><span class="op" id="3127953">,</span>&nbsp;<span class="ident" id="3127955">buf</span><span class="op" id="3127958">[</span><span class="op" id="3127959">:</span><span class="op" id="3127960">]</span><span class="op" id="3127961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127967">if</span>&nbsp;<span class="ident" id="3127970">rerr</span>&nbsp;<span class="op" id="3127975">!=</span>&nbsp;<span class="ident" id="3127978">nil</span>&nbsp;<span class="op" id="3127982">&amp;&amp;</span>&nbsp;<span class="ident" id="3127985">rerr</span>&nbsp;<span class="op" id="3127990">!=</span>&nbsp;<span class="ident" id="3127993">io</span><span class="op" id="3127995">.</span><span class="ident" id="3127996">EOF</span>&nbsp;<span class="op" id="3128000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128007">t</span><span class="op" id="3128008">.</span><span class="ident" id="3128009">ContentLength</span>&nbsp;<span class="op" id="3128023">=</span>&nbsp;<span class="op" id="3128025">-</span><span class="num" id="3128026">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128033">t</span><span class="op" id="3128034">.</span><span class="ident" id="3128035">Body</span>&nbsp;<span class="op" id="3128040">=</span>&nbsp;<span class="op" id="3128042">&amp;</span><span class="ident" id="3128043">errorReader</span><span class="op" id="3128054">{</span><span class="ident" id="3128055">rerr</span><span class="op" id="3128059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128065">}</span>&nbsp;<span class="keyword" id="3128067">else</span>&nbsp;<span class="keyword" id="3128072">if</span>&nbsp;<span class="ident" id="3128075">n</span>&nbsp;<span class="op" id="3128077">==</span>&nbsp;<span class="num" id="3128080">1</span>&nbsp;<span class="op" id="3128082">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3128089">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3128152">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3128201">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3128262">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128285">t</span><span class="op" id="3128286">.</span><span class="ident" id="3128287">ContentLength</span>&nbsp;<span class="op" id="3128301">=</span>&nbsp;<span class="op" id="3128303">-</span><span class="num" id="3128304">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128311">t</span><span class="op" id="3128312">.</span><span class="ident" id="3128313">Body</span>&nbsp;<span class="op" id="3128318">=</span>&nbsp;<span class="ident" id="3128320">io</span><span class="op" id="3128322">.</span><span class="ident" id="3128323">MultiReader</span><span class="op" id="3128334">(</span><span class="ident" id="3128335">bytes</span><span class="op" id="3128340">.</span><span class="ident" id="3128341">NewReader</span><span class="op" id="3128350">(</span><span class="ident" id="3128351">buf</span><span class="op" id="3128354">[</span><span class="op" id="3128355">:</span><span class="op" id="3128356">]</span><span class="op" id="3128357">)</span><span class="op" id="3128358">,</span>&nbsp;<span class="ident" id="3128360">t</span><span class="op" id="3128361">.</span><span class="ident" id="3128362">Body</span><span class="op" id="3128366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128372">}</span>&nbsp;<span class="keyword" id="3128374">else</span>&nbsp;<span class="op" id="3128379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3128386">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128418">t</span><span class="op" id="3128419">.</span><span class="ident" id="3128420">Body</span>&nbsp;<span class="op" id="3128425">=</span>&nbsp;<span class="ident" id="3128427">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128436">t</span><span class="op" id="3128437">.</span><span class="ident" id="3128438">BodyCloser</span>&nbsp;<span class="op" id="3128449">=</span>&nbsp;<span class="ident" id="3128451">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128469">if</span>&nbsp;<span class="ident" id="3128472">t</span><span class="op" id="3128473">.</span><span class="ident" id="3128474">ContentLength</span>&nbsp;<span class="op" id="3128488">&lt;</span>&nbsp;<span class="num" id="3128490">0</span>&nbsp;<span class="op" id="3128492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128498">t</span><span class="op" id="3128499">.</span><span class="ident" id="3128500">TransferEncoding</span>&nbsp;<span class="op" id="3128517">=</span>&nbsp;<span class="op" id="3128519">[</span><span class="op" id="3128520">]</span><span class="builtintype" id="3128521">string</span><span class="op" id="3128527">{</span><span class="string" id="3128528">&#34;chunked&#34;</span><span class="op" id="3128537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128542">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128549">case</span>&nbsp;<span class="op" id="3128554">*</span><span class="ident" id="3128555">Response</span><span class="op" id="3128563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128567">if</span>&nbsp;<span class="ident" id="3128570">rr</span><span class="op" id="3128572">.</span><span class="ident" id="3128573">Request</span>&nbsp;<span class="op" id="3128581">!=</span>&nbsp;<span class="ident" id="3128584">nil</span>&nbsp;<span class="op" id="3128588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128593">t</span><span class="op" id="3128594">.</span><span class="ident" id="3128595">Method</span>&nbsp;<span class="op" id="3128602">=</span>&nbsp;<span class="ident" id="3128604">rr</span><span class="op" id="3128606">.</span><span class="ident" id="3128607">Request</span><span class="op" id="3128614">.</span><span class="ident" id="3128615">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128624">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128628">t</span><span class="op" id="3128629">.</span><span class="ident" id="3128630">Body</span>&nbsp;<span class="op" id="3128635">=</span>&nbsp;<span class="ident" id="3128637">rr</span><span class="op" id="3128639">.</span><span class="ident" id="3128640">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128647">t</span><span class="op" id="3128648">.</span><span class="ident" id="3128649">BodyCloser</span>&nbsp;<span class="op" id="3128660">=</span>&nbsp;<span class="ident" id="3128662">rr</span><span class="op" id="3128664">.</span><span class="ident" id="3128665">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128672">t</span><span class="op" id="3128673">.</span><span class="ident" id="3128674">ContentLength</span>&nbsp;<span class="op" id="3128688">=</span>&nbsp;<span class="ident" id="3128690">rr</span><span class="op" id="3128692">.</span><span class="ident" id="3128693">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128709">t</span><span class="op" id="3128710">.</span><span class="ident" id="3128711">Close</span>&nbsp;<span class="op" id="3128717">=</span>&nbsp;<span class="ident" id="3128719">rr</span><span class="op" id="3128721">.</span><span class="ident" id="3128722">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128730">t</span><span class="op" id="3128731">.</span><span class="ident" id="3128732">TransferEncoding</span>&nbsp;<span class="op" id="3128749">=</span>&nbsp;<span class="ident" id="3128751">rr</span><span class="op" id="3128753">.</span><span class="ident" id="3128754">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128773">t</span><span class="op" id="3128774">.</span><span class="ident" id="3128775">Trailer</span>&nbsp;<span class="op" id="3128783">=</span>&nbsp;<span class="ident" id="3128785">rr</span><span class="op" id="3128787">.</span><span class="ident" id="3128788">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128798">atLeastHTTP11</span>&nbsp;<span class="op" id="3128812">=</span>&nbsp;<span class="ident" id="3128814">rr</span><span class="op" id="3128816">.</span><span class="ident" id="3128817">ProtoAtLeast</span><span class="op" id="3128829">(</span><span class="num" id="3128830">1</span><span class="op" id="3128831">,</span>&nbsp;<span class="num" id="3128833">1</span><span class="op" id="3128834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128838">t</span><span class="op" id="3128839">.</span><span class="ident" id="3128840">ResponseToHEAD</span>&nbsp;<span class="op" id="3128855">=</span>&nbsp;<span class="ident" id="3128857">noBodyExpected</span><span class="op" id="3128871">(</span><span class="ident" id="3128872">t</span><span class="op" id="3128873">.</span><span class="ident" id="3128874">Method</span><span class="op" id="3128880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3128887">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128936">if</span>&nbsp;<span class="ident" id="3128939">t</span><span class="op" id="3128940">.</span><span class="ident" id="3128941">ResponseToHEAD</span>&nbsp;<span class="op" id="3128956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128960">t</span><span class="op" id="3128961">.</span><span class="ident" id="3128962">Body</span>&nbsp;<span class="op" id="3128967">=</span>&nbsp;<span class="ident" id="3128969">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128975">if</span>&nbsp;<span class="ident" id="3128978">chunked</span><span class="op" id="3128985">(</span><span class="ident" id="3128986">t</span><span class="op" id="3128987">.</span><span class="ident" id="3128988">TransferEncoding</span><span class="op" id="3129004">)</span>&nbsp;<span class="op" id="3129006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129011">t</span><span class="op" id="3129012">.</span><span class="ident" id="3129013">ContentLength</span>&nbsp;<span class="op" id="3129027">=</span>&nbsp;<span class="op" id="3129029">-</span><span class="num" id="3129030">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129037">}</span>&nbsp;<span class="keyword" id="3129039">else</span>&nbsp;<span class="op" id="3129044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129048">if</span>&nbsp;<span class="op" id="3129051">!</span><span class="ident" id="3129052">atLeastHTTP11</span>&nbsp;<span class="op" id="3129066">||</span>&nbsp;<span class="ident" id="3129069">t</span><span class="op" id="3129070">.</span><span class="ident" id="3129071">Body</span>&nbsp;<span class="op" id="3129076">==</span>&nbsp;<span class="ident" id="3129079">nil</span>&nbsp;<span class="op" id="3129083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129088">t</span><span class="op" id="3129089">.</span><span class="ident" id="3129090">TransferEncoding</span>&nbsp;<span class="op" id="3129107">=</span>&nbsp;<span class="ident" id="3129109">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129115">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129119">if</span>&nbsp;<span class="ident" id="3129122">chunked</span><span class="op" id="3129129">(</span><span class="ident" id="3129130">t</span><span class="op" id="3129131">.</span><span class="ident" id="3129132">TransferEncoding</span><span class="op" id="3129148">)</span>&nbsp;<span class="op" id="3129150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129155">t</span><span class="op" id="3129156">.</span><span class="ident" id="3129157">ContentLength</span>&nbsp;<span class="op" id="3129171">=</span>&nbsp;<span class="op" id="3129173">-</span><span class="num" id="3129174">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129178">}</span>&nbsp;<span class="keyword" id="3129180">else</span>&nbsp;<span class="keyword" id="3129185">if</span>&nbsp;<span class="ident" id="3129188">t</span><span class="op" id="3129189">.</span><span class="ident" id="3129190">Body</span>&nbsp;<span class="op" id="3129195">==</span>&nbsp;<span class="ident" id="3129198">nil</span>&nbsp;<span class="op" id="3129202">{</span>&nbsp;<span class="comment" id="3129204">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129231">t</span><span class="op" id="3129232">.</span><span class="ident" id="3129233">ContentLength</span>&nbsp;<span class="op" id="3129247">=</span>&nbsp;<span class="num" id="3129249">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129253">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3129260">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129281">if</span>&nbsp;<span class="op" id="3129284">!</span><span class="ident" id="3129285">chunked</span><span class="op" id="3129292">(</span><span class="ident" id="3129293">t</span><span class="op" id="3129294">.</span><span class="ident" id="3129295">TransferEncoding</span><span class="op" id="3129311">)</span>&nbsp;<span class="op" id="3129313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129317">t</span><span class="op" id="3129318">.</span><span class="ident" id="3129319">Trailer</span>&nbsp;<span class="op" id="3129327">=</span>&nbsp;<span class="ident" id="3129329">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129338">return</span>&nbsp;<span class="ident" id="3129345">t</span><span class="op" id="3129346">,</span>&nbsp;<span class="ident" id="3129348">nil</span><br>
<span class="lineno"></span><span class="op" id="3129352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3129355">func</span>&nbsp;<span class="ident" id="3129360">noBodyExpected</span><span class="op" id="3129374">(</span><span class="ident" id="3129375">requestMethod</span>&nbsp;<span class="builtintype" id="3129389">string</span><span class="op" id="3129395">)</span>&nbsp;<span class="builtintype" id="3129397">bool</span>&nbsp;<span class="op" id="3129402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129405">return</span>&nbsp;<span class="ident" id="3129412">requestMethod</span>&nbsp;<span class="op" id="3129426">==</span>&nbsp;<span class="string" id="3129429">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="3129436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3129439">func</span>&nbsp;<span class="op" id="3129444">(</span><span class="ident" id="3129445">t</span>&nbsp;<span class="op" id="3129447">*</span><span class="ident" id="3129448">transferWriter</span><span class="op" id="3129462">)</span>&nbsp;<span class="ident" id="3129464">shouldSendContentLength</span><span class="op" id="3129487">(</span><span class="op" id="3129488">)</span>&nbsp;<span class="builtintype" id="3129490">bool</span>&nbsp;<span class="op" id="3129495">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129498">if</span>&nbsp;<span class="ident" id="3129501">chunked</span><span class="op" id="3129508">(</span><span class="ident" id="3129509">t</span><span class="op" id="3129510">.</span><span class="ident" id="3129511">TransferEncoding</span><span class="op" id="3129527">)</span>&nbsp;<span class="op" id="3129529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129533">return</span>&nbsp;<span class="builtintype" id="3129540">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129550">if</span>&nbsp;<span class="ident" id="3129553">t</span><span class="op" id="3129554">.</span><span class="ident" id="3129555">ContentLength</span>&nbsp;<span class="op" id="3129569">&gt;</span>&nbsp;<span class="num" id="3129571">0</span>&nbsp;<span class="op" id="3129573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129577">return</span>&nbsp;<span class="builtintype" id="3129584">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3129593">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129652">if</span>&nbsp;<span class="ident" id="3129655">t</span><span class="op" id="3129656">.</span><span class="ident" id="3129657">Method</span>&nbsp;<span class="op" id="3129664">==</span>&nbsp;<span class="string" id="3129667">&#34;POST&#34;</span>&nbsp;<span class="op" id="3129674">||</span>&nbsp;<span class="ident" id="3129677">t</span><span class="op" id="3129678">.</span><span class="ident" id="3129679">Method</span>&nbsp;<span class="op" id="3129686">==</span>&nbsp;<span class="string" id="3129689">&#34;PUT&#34;</span>&nbsp;<span class="op" id="3129695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129699">return</span>&nbsp;<span class="builtintype" id="3129706">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129712">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129715">if</span>&nbsp;<span class="ident" id="3129718">t</span><span class="op" id="3129719">.</span><span class="ident" id="3129720">ContentLength</span>&nbsp;<span class="op" id="3129734">==</span>&nbsp;<span class="num" id="3129737">0</span>&nbsp;<span class="op" id="3129739">&amp;&amp;</span>&nbsp;<span class="ident" id="3129742">isIdentity</span><span class="op" id="3129752">(</span><span class="ident" id="3129753">t</span><span class="op" id="3129754">.</span><span class="ident" id="3129755">TransferEncoding</span><span class="op" id="3129771">)</span>&nbsp;<span class="op" id="3129773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129777">return</span>&nbsp;<span class="builtintype" id="3129784">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129794">return</span>&nbsp;<span class="builtintype" id="3129801">false</span><br>
<span class="lineno">150</span><span class="op" id="3129807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3129810">func</span>&nbsp;<span class="op" id="3129815">(</span><span class="ident" id="3129816">t</span>&nbsp;<span class="op" id="3129818">*</span><span class="ident" id="3129819">transferWriter</span><span class="op" id="3129833">)</span>&nbsp;<span class="ident" id="3129835">WriteHeader</span><span class="op" id="3129846">(</span><span class="ident" id="3129847">w</span>&nbsp;<span class="ident" id="3129849">io</span><span class="op" id="3129851">.</span><span class="ident" id="3129852">Writer</span><span class="op" id="3129858">)</span>&nbsp;<span class="builtintype" id="3129860">error</span>&nbsp;<span class="op" id="3129866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129869">if</span>&nbsp;<span class="ident" id="3129872">t</span><span class="op" id="3129873">.</span><span class="ident" id="3129874">Close</span>&nbsp;<span class="op" id="3129880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129884">if</span>&nbsp;<span class="ident" id="3129887">_</span><span class="op" id="3129888">,</span>&nbsp;<span class="ident" id="3129890">err</span>&nbsp;<span class="op" id="3129894">:=</span>&nbsp;<span class="ident" id="3129897">io</span><span class="op" id="3129899">.</span><span class="ident" id="3129900">WriteString</span><span class="op" id="3129911">(</span><span class="ident" id="3129912">w</span><span class="op" id="3129913">,</span>&nbsp;<span class="string" id="3129915">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3129938">)</span><span class="op" id="3129939">;</span>&nbsp;<span class="ident" id="3129941">err</span>&nbsp;<span class="op" id="3129945">!=</span>&nbsp;<span class="ident" id="3129948">nil</span>&nbsp;<span class="op" id="3129952">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129957">return</span>&nbsp;<span class="ident" id="3129964">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3129977">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3130046">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3130111">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130133">if</span>&nbsp;<span class="ident" id="3130136">t</span><span class="op" id="3130137">.</span><span class="ident" id="3130138">shouldSendContentLength</span><span class="op" id="3130161">(</span><span class="op" id="3130162">)</span>&nbsp;<span class="op" id="3130164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130168">if</span>&nbsp;<span class="ident" id="3130171">_</span><span class="op" id="3130172">,</span>&nbsp;<span class="ident" id="3130174">err</span>&nbsp;<span class="op" id="3130178">:=</span>&nbsp;<span class="ident" id="3130181">io</span><span class="op" id="3130183">.</span><span class="ident" id="3130184">WriteString</span><span class="op" id="3130195">(</span><span class="ident" id="3130196">w</span><span class="op" id="3130197">,</span>&nbsp;<span class="string" id="3130199">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3130217">)</span><span class="op" id="3130218">;</span>&nbsp;<span class="ident" id="3130220">err</span>&nbsp;<span class="op" id="3130224">!=</span>&nbsp;<span class="ident" id="3130227">nil</span>&nbsp;<span class="op" id="3130231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130236">return</span>&nbsp;<span class="ident" id="3130243">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130253">if</span>&nbsp;<span class="ident" id="3130256">_</span><span class="op" id="3130257">,</span>&nbsp;<span class="ident" id="3130259">err</span>&nbsp;<span class="op" id="3130263">:=</span>&nbsp;<span class="ident" id="3130266">io</span><span class="op" id="3130268">.</span><span class="ident" id="3130269">WriteString</span><span class="op" id="3130280">(</span><span class="ident" id="3130281">w</span><span class="op" id="3130282">,</span>&nbsp;<span class="ident" id="3130284">strconv</span><span class="op" id="3130291">.</span><span class="ident" id="3130292">FormatInt</span><span class="op" id="3130301">(</span><span class="ident" id="3130302">t</span><span class="op" id="3130303">.</span><span class="ident" id="3130304">ContentLength</span><span class="op" id="3130317">,</span>&nbsp;<span class="num" id="3130319">10</span><span class="op" id="3130321">)</span><span class="op" id="3130322">+</span><span class="string" id="3130323">&#34;\r\n&#34;</span><span class="op" id="3130329">)</span><span class="op" id="3130330">;</span>&nbsp;<span class="ident" id="3130332">err</span>&nbsp;<span class="op" id="3130336">!=</span>&nbsp;<span class="ident" id="3130339">nil</span>&nbsp;<span class="op" id="3130343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130348">return</span>&nbsp;<span class="ident" id="3130355">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130364">}</span>&nbsp;<span class="keyword" id="3130366">else</span>&nbsp;<span class="keyword" id="3130371">if</span>&nbsp;<span class="ident" id="3130374">chunked</span><span class="op" id="3130381">(</span><span class="ident" id="3130382">t</span><span class="op" id="3130383">.</span><span class="ident" id="3130384">TransferEncoding</span><span class="op" id="3130400">)</span>&nbsp;<span class="op" id="3130402">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130406">if</span>&nbsp;<span class="ident" id="3130409">_</span><span class="op" id="3130410">,</span>&nbsp;<span class="ident" id="3130412">err</span>&nbsp;<span class="op" id="3130416">:=</span>&nbsp;<span class="ident" id="3130419">io</span><span class="op" id="3130421">.</span><span class="ident" id="3130422">WriteString</span><span class="op" id="3130433">(</span><span class="ident" id="3130434">w</span><span class="op" id="3130435">,</span>&nbsp;<span class="string" id="3130437">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="3130469">)</span><span class="op" id="3130470">;</span>&nbsp;<span class="ident" id="3130472">err</span>&nbsp;<span class="op" id="3130476">!=</span>&nbsp;<span class="ident" id="3130479">nil</span>&nbsp;<span class="op" id="3130483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130488">return</span>&nbsp;<span class="ident" id="3130495">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3130508">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130533">if</span>&nbsp;<span class="ident" id="3130536">t</span><span class="op" id="3130537">.</span><span class="ident" id="3130538">Trailer</span>&nbsp;<span class="op" id="3130546">!=</span>&nbsp;<span class="ident" id="3130549">nil</span>&nbsp;<span class="op" id="3130553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130557">keys</span>&nbsp;<span class="op" id="3130562">:=</span>&nbsp;<span class="builtinfunc" id="3130565">make</span><span class="op" id="3130569">(</span><span class="op" id="3130570">[</span><span class="op" id="3130571">]</span><span class="builtintype" id="3130572">string</span><span class="op" id="3130578">,</span>&nbsp;<span class="num" id="3130580">0</span><span class="op" id="3130581">,</span>&nbsp;<span class="builtinfunc" id="3130583">len</span><span class="op" id="3130586">(</span><span class="ident" id="3130587">t</span><span class="op" id="3130588">.</span><span class="ident" id="3130589">Trailer</span><span class="op" id="3130596">)</span><span class="op" id="3130597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130601">for</span>&nbsp;<span class="ident" id="3130605">k</span>&nbsp;<span class="op" id="3130607">:=</span>&nbsp;<span class="keyword" id="3130610">range</span>&nbsp;<span class="ident" id="3130616">t</span><span class="op" id="3130617">.</span><span class="ident" id="3130618">Trailer</span>&nbsp;<span class="op" id="3130626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130631">k</span>&nbsp;<span class="op" id="3130633">=</span>&nbsp;<span class="ident" id="3130635">CanonicalHeaderKey</span><span class="op" id="3130653">(</span><span class="ident" id="3130654">k</span><span class="op" id="3130655">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130660">switch</span>&nbsp;<span class="ident" id="3130667">k</span>&nbsp;<span class="op" id="3130669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130674">case</span>&nbsp;<span class="string" id="3130679">&#34;Transfer-Encoding&#34;</span><span class="op" id="3130698">,</span>&nbsp;<span class="string" id="3130700">&#34;Trailer&#34;</span><span class="op" id="3130709">,</span>&nbsp;<span class="string" id="3130711">&#34;Content-Length&#34;</span><span class="op" id="3130727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130733">return</span>&nbsp;<span class="op" id="3130740">&amp;</span><span class="ident" id="3130741">badStringError</span><span class="op" id="3130755">{</span><span class="string" id="3130756">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="3130777">,</span>&nbsp;<span class="ident" id="3130779">k</span><span class="op" id="3130780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130790">keys</span>&nbsp;<span class="op" id="3130795">=</span>&nbsp;<span class="builtinfunc" id="3130797">append</span><span class="op" id="3130803">(</span><span class="ident" id="3130804">keys</span><span class="op" id="3130808">,</span>&nbsp;<span class="ident" id="3130810">k</span><span class="op" id="3130811">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130819">if</span>&nbsp;<span class="builtinfunc" id="3130822">len</span><span class="op" id="3130825">(</span><span class="ident" id="3130826">keys</span><span class="op" id="3130830">)</span>&nbsp;<span class="op" id="3130832">&gt;</span>&nbsp;<span class="num" id="3130834">0</span>&nbsp;<span class="op" id="3130836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130841">sort</span><span class="op" id="3130845">.</span><span class="ident" id="3130846">Strings</span><span class="op" id="3130853">(</span><span class="ident" id="3130854">keys</span><span class="op" id="3130858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3130863">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3130936">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130965">if</span>&nbsp;<span class="ident" id="3130968">_</span><span class="op" id="3130969">,</span>&nbsp;<span class="ident" id="3130971">err</span>&nbsp;<span class="op" id="3130975">:=</span>&nbsp;<span class="ident" id="3130978">io</span><span class="op" id="3130980">.</span><span class="ident" id="3130981">WriteString</span><span class="op" id="3130992">(</span><span class="ident" id="3130993">w</span><span class="op" id="3130994">,</span>&nbsp;<span class="string" id="3130996">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="3131007">+</span><span class="ident" id="3131008">strings</span><span class="op" id="3131015">.</span><span class="ident" id="3131016">Join</span><span class="op" id="3131020">(</span><span class="ident" id="3131021">keys</span><span class="op" id="3131025">,</span>&nbsp;<span class="string" id="3131027">&#34;,&#34;</span><span class="op" id="3131030">)</span><span class="op" id="3131031">+</span><span class="string" id="3131032">&#34;\r\n&#34;</span><span class="op" id="3131038">)</span><span class="op" id="3131039">;</span>&nbsp;<span class="ident" id="3131041">err</span>&nbsp;<span class="op" id="3131045">!=</span>&nbsp;<span class="ident" id="3131048">nil</span>&nbsp;<span class="op" id="3131052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131058">return</span>&nbsp;<span class="ident" id="3131065">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131079">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131083">return</span>&nbsp;<span class="ident" id="3131090">nil</span><br>
<span class="lineno"></span><span class="op" id="3131094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3131097">func</span>&nbsp;<span class="op" id="3131102">(</span><span class="ident" id="3131103">t</span>&nbsp;<span class="op" id="3131105">*</span><span class="ident" id="3131106">transferWriter</span><span class="op" id="3131120">)</span>&nbsp;<span class="ident" id="3131122">WriteBody</span><span class="op" id="3131131">(</span><span class="ident" id="3131132">w</span>&nbsp;<span class="ident" id="3131134">io</span><span class="op" id="3131136">.</span><span class="ident" id="3131137">Writer</span><span class="op" id="3131143">)</span>&nbsp;<span class="builtintype" id="3131145">error</span>&nbsp;<span class="op" id="3131151">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131154">var</span>&nbsp;<span class="ident" id="3131158">err</span>&nbsp;<span class="builtintype" id="3131162">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131169">var</span>&nbsp;<span class="ident" id="3131173">ncopy</span>&nbsp;<span class="ident" id="3131179">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3131187">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131202">if</span>&nbsp;<span class="ident" id="3131205">t</span><span class="op" id="3131206">.</span><span class="ident" id="3131207">Body</span>&nbsp;<span class="op" id="3131212">!=</span>&nbsp;<span class="ident" id="3131215">nil</span>&nbsp;<span class="op" id="3131219">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131223">if</span>&nbsp;<span class="ident" id="3131226">chunked</span><span class="op" id="3131233">(</span><span class="ident" id="3131234">t</span><span class="op" id="3131235">.</span><span class="ident" id="3131236">TransferEncoding</span><span class="op" id="3131252">)</span>&nbsp;<span class="op" id="3131254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131259">cw</span>&nbsp;<span class="op" id="3131262">:=</span>&nbsp;<span class="ident" id="3131265">internal</span><span class="op" id="3131273">.</span><span class="ident" id="3131274">NewChunkedWriter</span><span class="op" id="3131290">(</span><span class="ident" id="3131291">w</span><span class="op" id="3131292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131297">_</span><span class="op" id="3131298">,</span>&nbsp;<span class="ident" id="3131300">err</span>&nbsp;<span class="op" id="3131304">=</span>&nbsp;<span class="ident" id="3131306">io</span><span class="op" id="3131308">.</span><span class="ident" id="3131309">Copy</span><span class="op" id="3131313">(</span><span class="ident" id="3131314">cw</span><span class="op" id="3131316">,</span>&nbsp;<span class="ident" id="3131318">t</span><span class="op" id="3131319">.</span><span class="ident" id="3131320">Body</span><span class="op" id="3131324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131329">if</span>&nbsp;<span class="ident" id="3131332">err</span>&nbsp;<span class="op" id="3131336">==</span>&nbsp;<span class="ident" id="3131339">nil</span>&nbsp;<span class="op" id="3131343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131349">err</span>&nbsp;<span class="op" id="3131353">=</span>&nbsp;<span class="ident" id="3131355">cw</span><span class="op" id="3131357">.</span><span class="ident" id="3131358">Close</span><span class="op" id="3131363">(</span><span class="op" id="3131364">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131373">}</span>&nbsp;<span class="keyword" id="3131375">else</span>&nbsp;<span class="keyword" id="3131380">if</span>&nbsp;<span class="ident" id="3131383">t</span><span class="op" id="3131384">.</span><span class="ident" id="3131385">ContentLength</span>&nbsp;<span class="op" id="3131399">==</span>&nbsp;<span class="op" id="3131402">-</span><span class="num" id="3131403">1</span>&nbsp;<span class="op" id="3131405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131410">ncopy</span><span class="op" id="3131415">,</span>&nbsp;<span class="ident" id="3131417">err</span>&nbsp;<span class="op" id="3131421">=</span>&nbsp;<span class="ident" id="3131423">io</span><span class="op" id="3131425">.</span><span class="ident" id="3131426">Copy</span><span class="op" id="3131430">(</span><span class="ident" id="3131431">w</span><span class="op" id="3131432">,</span>&nbsp;<span class="ident" id="3131434">t</span><span class="op" id="3131435">.</span><span class="ident" id="3131436">Body</span><span class="op" id="3131440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131444">}</span>&nbsp;<span class="keyword" id="3131446">else</span>&nbsp;<span class="op" id="3131451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131456">ncopy</span><span class="op" id="3131461">,</span>&nbsp;<span class="ident" id="3131463">err</span>&nbsp;<span class="op" id="3131467">=</span>&nbsp;<span class="ident" id="3131469">io</span><span class="op" id="3131471">.</span><span class="ident" id="3131472">Copy</span><span class="op" id="3131476">(</span><span class="ident" id="3131477">w</span><span class="op" id="3131478">,</span>&nbsp;<span class="ident" id="3131480">io</span><span class="op" id="3131482">.</span><span class="ident" id="3131483">LimitReader</span><span class="op" id="3131494">(</span><span class="ident" id="3131495">t</span><span class="op" id="3131496">.</span><span class="ident" id="3131497">Body</span><span class="op" id="3131501">,</span>&nbsp;<span class="ident" id="3131503">t</span><span class="op" id="3131504">.</span><span class="ident" id="3131505">ContentLength</span><span class="op" id="3131518">)</span><span class="op" id="3131519">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131524">if</span>&nbsp;<span class="ident" id="3131527">err</span>&nbsp;<span class="op" id="3131531">!=</span>&nbsp;<span class="ident" id="3131534">nil</span>&nbsp;<span class="op" id="3131538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131544">return</span>&nbsp;<span class="ident" id="3131551">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131563">var</span>&nbsp;<span class="ident" id="3131567">nextra</span>&nbsp;<span class="ident" id="3131574">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131583">nextra</span><span class="op" id="3131589">,</span>&nbsp;<span class="ident" id="3131591">err</span>&nbsp;<span class="op" id="3131595">=</span>&nbsp;<span class="ident" id="3131597">io</span><span class="op" id="3131599">.</span><span class="ident" id="3131600">Copy</span><span class="op" id="3131604">(</span><span class="ident" id="3131605">ioutil</span><span class="op" id="3131611">.</span><span class="ident" id="3131612">Discard</span><span class="op" id="3131619">,</span>&nbsp;<span class="ident" id="3131621">t</span><span class="op" id="3131622">.</span><span class="ident" id="3131623">Body</span><span class="op" id="3131627">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131632">ncopy</span>&nbsp;<span class="op" id="3131638">+=</span>&nbsp;<span class="ident" id="3131641">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131654">if</span>&nbsp;<span class="ident" id="3131657">err</span>&nbsp;<span class="op" id="3131661">!=</span>&nbsp;<span class="ident" id="3131664">nil</span>&nbsp;<span class="op" id="3131668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131673">return</span>&nbsp;<span class="ident" id="3131680">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131686">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131690">if</span>&nbsp;<span class="ident" id="3131693">err</span>&nbsp;<span class="op" id="3131697">=</span>&nbsp;<span class="ident" id="3131699">t</span><span class="op" id="3131700">.</span><span class="ident" id="3131701">BodyCloser</span><span class="op" id="3131711">.</span><span class="ident" id="3131712">Close</span><span class="op" id="3131717">(</span><span class="op" id="3131718">)</span><span class="op" id="3131719">;</span>&nbsp;<span class="ident" id="3131721">err</span>&nbsp;<span class="op" id="3131725">!=</span>&nbsp;<span class="ident" id="3131728">nil</span>&nbsp;<span class="op" id="3131732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131737">return</span>&nbsp;<span class="ident" id="3131744">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131757">if</span>&nbsp;<span class="op" id="3131760">!</span><span class="ident" id="3131761">t</span><span class="op" id="3131762">.</span><span class="ident" id="3131763">ResponseToHEAD</span>&nbsp;<span class="op" id="3131778">&amp;&amp;</span>&nbsp;<span class="ident" id="3131781">t</span><span class="op" id="3131782">.</span><span class="ident" id="3131783">ContentLength</span>&nbsp;<span class="op" id="3131797">!=</span>&nbsp;<span class="op" id="3131800">-</span><span class="num" id="3131801">1</span>&nbsp;<span class="op" id="3131803">&amp;&amp;</span>&nbsp;<span class="ident" id="3131806">t</span><span class="op" id="3131807">.</span><span class="ident" id="3131808">ContentLength</span>&nbsp;<span class="op" id="3131822">!=</span>&nbsp;<span class="ident" id="3131825">ncopy</span>&nbsp;<span class="op" id="3131831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131835">return</span>&nbsp;<span class="ident" id="3131842">fmt</span><span class="op" id="3131845">.</span><span class="ident" id="3131846">Errorf</span><span class="op" id="3131852">(</span><span class="string" id="3131853">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3131897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131902">t</span><span class="op" id="3131903">.</span><span class="ident" id="3131904">ContentLength</span><span class="op" id="3131917">,</span>&nbsp;<span class="ident" id="3131919">ncopy</span><span class="op" id="3131924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3131931">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131980">if</span>&nbsp;<span class="ident" id="3131983">chunked</span><span class="op" id="3131990">(</span><span class="ident" id="3131991">t</span><span class="op" id="3131992">.</span><span class="ident" id="3131993">TransferEncoding</span><span class="op" id="3132009">)</span>&nbsp;<span class="op" id="3132011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3132015">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132041">if</span>&nbsp;<span class="ident" id="3132044">t</span><span class="op" id="3132045">.</span><span class="ident" id="3132046">Trailer</span>&nbsp;<span class="op" id="3132054">!=</span>&nbsp;<span class="ident" id="3132057">nil</span>&nbsp;<span class="op" id="3132061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132066">if</span>&nbsp;<span class="ident" id="3132069">err</span>&nbsp;<span class="op" id="3132073">:=</span>&nbsp;<span class="ident" id="3132076">t</span><span class="op" id="3132077">.</span><span class="ident" id="3132078">Trailer</span><span class="op" id="3132085">.</span><span class="ident" id="3132086">Write</span><span class="op" id="3132091">(</span><span class="ident" id="3132092">w</span><span class="op" id="3132093">)</span><span class="op" id="3132094">;</span>&nbsp;<span class="ident" id="3132096">err</span>&nbsp;<span class="op" id="3132100">!=</span>&nbsp;<span class="ident" id="3132103">nil</span>&nbsp;<span class="op" id="3132107">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132113">return</span>&nbsp;<span class="ident" id="3132120">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3132135">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132166">_</span><span class="op" id="3132167">,</span>&nbsp;<span class="ident" id="3132169">err</span>&nbsp;<span class="op" id="3132173">=</span>&nbsp;<span class="ident" id="3132175">io</span><span class="op" id="3132177">.</span><span class="ident" id="3132178">WriteString</span><span class="op" id="3132189">(</span><span class="ident" id="3132190">w</span><span class="op" id="3132191">,</span>&nbsp;<span class="string" id="3132193">&#34;\r\n&#34;</span><span class="op" id="3132199">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132205">return</span>&nbsp;<span class="ident" id="3132212">err</span><br>
<span class="lineno"></span><span class="op" id="3132216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3132219">type</span>&nbsp;<span class="ident" id="3132224">transferReader</span>&nbsp;<span class="keyword" id="3132239">struct</span>&nbsp;<span class="op" id="3132246">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3132249">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132259">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132273">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132281">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3132295">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132300">RequestMethod</span>&nbsp;<span class="builtintype" id="3132314">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132322">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3132336">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132341">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3132355">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3132360">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132371">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132388">io</span><span class="op" id="3132390">.</span><span class="ident" id="3132391">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132403">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132420">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132427">TransferEncoding</span>&nbsp;<span class="op" id="3132444">[</span><span class="op" id="3132445">]</span><span class="builtintype" id="3132446">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132454">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3132471">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132477">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132494">Header</span><br>
<span class="lineno"></span><span class="op" id="3132501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3132504">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="3132573">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="3132619">func</span>&nbsp;<span class="ident" id="3132624">bodyAllowedForStatus</span><span class="op" id="3132644">(</span><span class="ident" id="3132645">status</span>&nbsp;<span class="builtintype" id="3132652">int</span><span class="op" id="3132655">)</span>&nbsp;<span class="builtintype" id="3132657">bool</span>&nbsp;<span class="op" id="3132662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132665">switch</span>&nbsp;<span class="op" id="3132672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132675">case</span>&nbsp;<span class="ident" id="3132680">status</span>&nbsp;<span class="op" id="3132687">&gt;=</span>&nbsp;<span class="num" id="3132690">100</span>&nbsp;<span class="op" id="3132694">&amp;&amp;</span>&nbsp;<span class="ident" id="3132697">status</span>&nbsp;<span class="op" id="3132704">&lt;=</span>&nbsp;<span class="num" id="3132707">199</span><span class="op" id="3132710">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132714">return</span>&nbsp;<span class="builtintype" id="3132721">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132728">case</span>&nbsp;<span class="ident" id="3132733">status</span>&nbsp;<span class="op" id="3132740">==</span>&nbsp;<span class="num" id="3132743">204</span><span class="op" id="3132746">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132750">return</span>&nbsp;<span class="builtintype" id="3132757">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132764">case</span>&nbsp;<span class="ident" id="3132769">status</span>&nbsp;<span class="op" id="3132776">==</span>&nbsp;<span class="num" id="3132779">304</span><span class="op" id="3132782">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132786">return</span>&nbsp;<span class="builtintype" id="3132793">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132800">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132803">return</span>&nbsp;<span class="builtintype" id="3132810">true</span><br>
<span class="lineno"></span><span class="op" id="3132815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3132818">var</span>&nbsp;<span class="op" id="3132822">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132825">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3132849">=</span>&nbsp;<span class="op" id="3132851">[</span><span class="op" id="3132852">]</span><span class="builtintype" id="3132853">string</span><span class="op" id="3132859">{</span><span class="string" id="3132860">&#34;Content-Type&#34;</span><span class="op" id="3132874">,</span>&nbsp;<span class="string" id="3132876">&#34;Content-Length&#34;</span><span class="op" id="3132892">,</span>&nbsp;<span class="string" id="3132894">&#34;Transfer-Encoding&#34;</span><span class="op" id="3132913">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132916">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="3132940">=</span>&nbsp;<span class="op" id="3132942">[</span><span class="op" id="3132943">]</span><span class="builtintype" id="3132944">string</span><span class="op" id="3132950">{</span><span class="string" id="3132951">&#34;Content-Length&#34;</span><span class="op" id="3132967">,</span>&nbsp;<span class="string" id="3132969">&#34;Transfer-Encoding&#34;</span><span class="op" id="3132988">}</span><br>
<span class="lineno"></span><span class="op" id="3132990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3132993">func</span>&nbsp;<span class="ident" id="3132998">suppressedHeaders</span><span class="op" id="3133015">(</span><span class="ident" id="3133016">status</span>&nbsp;<span class="builtintype" id="3133023">int</span><span class="op" id="3133026">)</span>&nbsp;<span class="op" id="3133028">[</span><span class="op" id="3133029">]</span><span class="builtintype" id="3133030">string</span>&nbsp;<span class="op" id="3133037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133040">switch</span>&nbsp;<span class="op" id="3133047">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133050">case</span>&nbsp;<span class="ident" id="3133055">status</span>&nbsp;<span class="op" id="3133062">==</span>&nbsp;<span class="num" id="3133065">304</span><span class="op" id="3133068">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133072">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133155">return</span>&nbsp;<span class="ident" id="3133162">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133184">case</span>&nbsp;<span class="op" id="3133189">!</span><span class="ident" id="3133190">bodyAllowedForStatus</span><span class="op" id="3133210">(</span><span class="ident" id="3133211">status</span><span class="op" id="3133217">)</span><span class="op" id="3133218">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133222">return</span>&nbsp;<span class="ident" id="3133229">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133257">return</span>&nbsp;<span class="ident" id="3133264">nil</span><br>
<span class="lineno"></span><span class="op" id="3133268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3133271">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="3133304">func</span>&nbsp;<span class="ident" id="3133309">readTransfer</span><span class="op" id="3133321">(</span><span class="ident" id="3133322">msg</span>&nbsp;<span class="keyword" id="3133326">interface</span><span class="op" id="3133335">{</span><span class="op" id="3133336">}</span><span class="op" id="3133337">,</span>&nbsp;<span class="ident" id="3133339">r</span>&nbsp;<span class="op" id="3133341">*</span><span class="ident" id="3133342">bufio</span><span class="op" id="3133347">.</span><span class="ident" id="3133348">Reader</span><span class="op" id="3133354">)</span>&nbsp;<span class="op" id="3133356">(</span><span class="ident" id="3133357">err</span>&nbsp;<span class="builtintype" id="3133361">error</span><span class="op" id="3133366">)</span>&nbsp;<span class="op" id="3133368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133371">t</span>&nbsp;<span class="op" id="3133373">:=</span>&nbsp;<span class="op" id="3133376">&amp;</span><span class="ident" id="3133377">transferReader</span><span class="op" id="3133391">{</span><span class="ident" id="3133392">RequestMethod</span><span class="op" id="3133405">:</span>&nbsp;<span class="string" id="3133407">&#34;GET&#34;</span><span class="op" id="3133412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133416">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133432">isResponse</span>&nbsp;<span class="op" id="3133443">:=</span>&nbsp;<span class="builtintype" id="3133446">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133453">switch</span>&nbsp;<span class="ident" id="3133460">rr</span>&nbsp;<span class="op" id="3133463">:=</span>&nbsp;<span class="ident" id="3133466">msg</span><span class="op" id="3133469">.</span><span class="op" id="3133470">(</span><span class="keyword" id="3133471">type</span><span class="op" id="3133475">)</span>&nbsp;<span class="op" id="3133477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133480">case</span>&nbsp;<span class="op" id="3133485">*</span><span class="ident" id="3133486">Response</span><span class="op" id="3133494">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133498">t</span><span class="op" id="3133499">.</span><span class="ident" id="3133500">Header</span>&nbsp;<span class="op" id="3133507">=</span>&nbsp;<span class="ident" id="3133509">rr</span><span class="op" id="3133511">.</span><span class="ident" id="3133512">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133521">t</span><span class="op" id="3133522">.</span><span class="ident" id="3133523">StatusCode</span>&nbsp;<span class="op" id="3133534">=</span>&nbsp;<span class="ident" id="3133536">rr</span><span class="op" id="3133538">.</span><span class="ident" id="3133539">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133552">t</span><span class="op" id="3133553">.</span><span class="ident" id="3133554">ProtoMajor</span>&nbsp;<span class="op" id="3133565">=</span>&nbsp;<span class="ident" id="3133567">rr</span><span class="op" id="3133569">.</span><span class="ident" id="3133570">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133583">t</span><span class="op" id="3133584">.</span><span class="ident" id="3133585">ProtoMinor</span>&nbsp;<span class="op" id="3133596">=</span>&nbsp;<span class="ident" id="3133598">rr</span><span class="op" id="3133600">.</span><span class="ident" id="3133601">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133614">t</span><span class="op" id="3133615">.</span><span class="ident" id="3133616">Close</span>&nbsp;<span class="op" id="3133622">=</span>&nbsp;<span class="ident" id="3133624">shouldClose</span><span class="op" id="3133635">(</span><span class="ident" id="3133636">t</span><span class="op" id="3133637">.</span><span class="ident" id="3133638">ProtoMajor</span><span class="op" id="3133648">,</span>&nbsp;<span class="ident" id="3133650">t</span><span class="op" id="3133651">.</span><span class="ident" id="3133652">ProtoMinor</span><span class="op" id="3133662">,</span>&nbsp;<span class="ident" id="3133664">t</span><span class="op" id="3133665">.</span><span class="ident" id="3133666">Header</span><span class="op" id="3133672">,</span>&nbsp;<span class="builtintype" id="3133674">true</span><span class="op" id="3133678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133682">isResponse</span>&nbsp;<span class="op" id="3133693">=</span>&nbsp;<span class="builtintype" id="3133695">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133702">if</span>&nbsp;<span class="ident" id="3133705">rr</span><span class="op" id="3133707">.</span><span class="ident" id="3133708">Request</span>&nbsp;<span class="op" id="3133716">!=</span>&nbsp;<span class="ident" id="3133719">nil</span>&nbsp;<span class="op" id="3133723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133728">t</span><span class="op" id="3133729">.</span><span class="ident" id="3133730">RequestMethod</span>&nbsp;<span class="op" id="3133744">=</span>&nbsp;<span class="ident" id="3133746">rr</span><span class="op" id="3133748">.</span><span class="ident" id="3133749">Request</span><span class="op" id="3133756">.</span><span class="ident" id="3133757">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133769">case</span>&nbsp;<span class="op" id="3133774">*</span><span class="ident" id="3133775">Request</span><span class="op" id="3133782">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133786">t</span><span class="op" id="3133787">.</span><span class="ident" id="3133788">Header</span>&nbsp;<span class="op" id="3133795">=</span>&nbsp;<span class="ident" id="3133797">rr</span><span class="op" id="3133799">.</span><span class="ident" id="3133800">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133809">t</span><span class="op" id="3133810">.</span><span class="ident" id="3133811">ProtoMajor</span>&nbsp;<span class="op" id="3133822">=</span>&nbsp;<span class="ident" id="3133824">rr</span><span class="op" id="3133826">.</span><span class="ident" id="3133827">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133840">t</span><span class="op" id="3133841">.</span><span class="ident" id="3133842">ProtoMinor</span>&nbsp;<span class="op" id="3133853">=</span>&nbsp;<span class="ident" id="3133855">rr</span><span class="op" id="3133857">.</span><span class="ident" id="3133858">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133871">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133935">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133999">t</span><span class="op" id="3134000">.</span><span class="ident" id="3134001">StatusCode</span>&nbsp;<span class="op" id="3134012">=</span>&nbsp;<span class="num" id="3134014">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134019">default</span><span class="op" id="3134026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3134030">panic</span><span class="op" id="3134035">(</span><span class="string" id="3134036">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="3134053">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134060">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134084">if</span>&nbsp;<span class="ident" id="3134087">t</span><span class="op" id="3134088">.</span><span class="ident" id="3134089">ProtoMajor</span>&nbsp;<span class="op" id="3134100">==</span>&nbsp;<span class="num" id="3134103">0</span>&nbsp;<span class="op" id="3134105">&amp;&amp;</span>&nbsp;<span class="ident" id="3134108">t</span><span class="op" id="3134109">.</span><span class="ident" id="3134110">ProtoMinor</span>&nbsp;<span class="op" id="3134121">==</span>&nbsp;<span class="num" id="3134124">0</span>&nbsp;<span class="op" id="3134126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134130">t</span><span class="op" id="3134131">.</span><span class="ident" id="3134132">ProtoMajor</span><span class="op" id="3134142">,</span>&nbsp;<span class="ident" id="3134144">t</span><span class="op" id="3134145">.</span><span class="ident" id="3134146">ProtoMinor</span>&nbsp;<span class="op" id="3134157">=</span>&nbsp;<span class="num" id="3134159">1</span><span class="op" id="3134160">,</span>&nbsp;<span class="num" id="3134162">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134169">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134207">t</span><span class="op" id="3134208">.</span><span class="ident" id="3134209">TransferEncoding</span><span class="op" id="3134225">,</span>&nbsp;<span class="ident" id="3134227">err</span>&nbsp;<span class="op" id="3134231">=</span>&nbsp;<span class="ident" id="3134233">fixTransferEncoding</span><span class="op" id="3134252">(</span><span class="ident" id="3134253">t</span><span class="op" id="3134254">.</span><span class="ident" id="3134255">RequestMethod</span><span class="op" id="3134268">,</span>&nbsp;<span class="ident" id="3134270">t</span><span class="op" id="3134271">.</span><span class="ident" id="3134272">Header</span><span class="op" id="3134278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134281">if</span>&nbsp;<span class="ident" id="3134284">err</span>&nbsp;<span class="op" id="3134288">!=</span>&nbsp;<span class="ident" id="3134291">nil</span>&nbsp;<span class="op" id="3134295">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134299">return</span>&nbsp;<span class="ident" id="3134306">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134315">realLength</span><span class="op" id="3134325">,</span>&nbsp;<span class="ident" id="3134327">err</span>&nbsp;<span class="op" id="3134331">:=</span>&nbsp;<span class="ident" id="3134334">fixLength</span><span class="op" id="3134343">(</span><span class="ident" id="3134344">isResponse</span><span class="op" id="3134354">,</span>&nbsp;<span class="ident" id="3134356">t</span><span class="op" id="3134357">.</span><span class="ident" id="3134358">StatusCode</span><span class="op" id="3134368">,</span>&nbsp;<span class="ident" id="3134370">t</span><span class="op" id="3134371">.</span><span class="ident" id="3134372">RequestMethod</span><span class="op" id="3134385">,</span>&nbsp;<span class="ident" id="3134387">t</span><span class="op" id="3134388">.</span><span class="ident" id="3134389">Header</span><span class="op" id="3134395">,</span>&nbsp;<span class="ident" id="3134397">t</span><span class="op" id="3134398">.</span><span class="ident" id="3134399">TransferEncoding</span><span class="op" id="3134415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134418">if</span>&nbsp;<span class="ident" id="3134421">err</span>&nbsp;<span class="op" id="3134425">!=</span>&nbsp;<span class="ident" id="3134428">nil</span>&nbsp;<span class="op" id="3134432">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134436">return</span>&nbsp;<span class="ident" id="3134443">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134451">if</span>&nbsp;<span class="ident" id="3134454">isResponse</span>&nbsp;<span class="op" id="3134465">&amp;&amp;</span>&nbsp;<span class="ident" id="3134468">t</span><span class="op" id="3134469">.</span><span class="ident" id="3134470">RequestMethod</span>&nbsp;<span class="op" id="3134484">==</span>&nbsp;<span class="string" id="3134487">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3134494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134498">if</span>&nbsp;<span class="ident" id="3134501">n</span><span class="op" id="3134502">,</span>&nbsp;<span class="ident" id="3134504">err</span>&nbsp;<span class="op" id="3134508">:=</span>&nbsp;<span class="ident" id="3134511">parseContentLength</span><span class="op" id="3134529">(</span><span class="ident" id="3134530">t</span><span class="op" id="3134531">.</span><span class="ident" id="3134532">Header</span><span class="op" id="3134538">.</span><span class="ident" id="3134539">get</span><span class="op" id="3134542">(</span><span class="string" id="3134543">&#34;Content-Length&#34;</span><span class="op" id="3134559">)</span><span class="op" id="3134560">)</span><span class="op" id="3134561">;</span>&nbsp;<span class="ident" id="3134563">err</span>&nbsp;<span class="op" id="3134567">!=</span>&nbsp;<span class="ident" id="3134570">nil</span>&nbsp;<span class="op" id="3134574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134579">return</span>&nbsp;<span class="ident" id="3134586">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134592">}</span>&nbsp;<span class="keyword" id="3134594">else</span>&nbsp;<span class="op" id="3134599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134604">t</span><span class="op" id="3134605">.</span><span class="ident" id="3134606">ContentLength</span>&nbsp;<span class="op" id="3134620">=</span>&nbsp;<span class="ident" id="3134622">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134629">}</span>&nbsp;<span class="keyword" id="3134631">else</span>&nbsp;<span class="op" id="3134636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134640">t</span><span class="op" id="3134641">.</span><span class="ident" id="3134642">ContentLength</span>&nbsp;<span class="op" id="3134656">=</span>&nbsp;<span class="ident" id="3134658">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134674">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134686">t</span><span class="op" id="3134687">.</span><span class="ident" id="3134688">Trailer</span><span class="op" id="3134695">,</span>&nbsp;<span class="ident" id="3134697">err</span>&nbsp;<span class="op" id="3134701">=</span>&nbsp;<span class="ident" id="3134703">fixTrailer</span><span class="op" id="3134713">(</span><span class="ident" id="3134714">t</span><span class="op" id="3134715">.</span><span class="ident" id="3134716">Header</span><span class="op" id="3134722">,</span>&nbsp;<span class="ident" id="3134724">t</span><span class="op" id="3134725">.</span><span class="ident" id="3134726">TransferEncoding</span><span class="op" id="3134742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134745">if</span>&nbsp;<span class="ident" id="3134748">err</span>&nbsp;<span class="op" id="3134752">!=</span>&nbsp;<span class="ident" id="3134755">nil</span>&nbsp;<span class="op" id="3134759">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134763">return</span>&nbsp;<span class="ident" id="3134770">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134779">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134857">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134928">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134958">switch</span>&nbsp;<span class="ident" id="3134965">msg</span><span class="op" id="3134968">.</span><span class="op" id="3134969">(</span><span class="keyword" id="3134970">type</span><span class="op" id="3134974">)</span>&nbsp;<span class="op" id="3134976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134979">case</span>&nbsp;<span class="op" id="3134984">*</span><span class="ident" id="3134985">Response</span><span class="op" id="3134993">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134997">if</span>&nbsp;<span class="ident" id="3135000">realLength</span>&nbsp;<span class="op" id="3135011">==</span>&nbsp;<span class="op" id="3135014">-</span><span class="num" id="3135015">1</span>&nbsp;<span class="op" id="3135017">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135023">!</span><span class="ident" id="3135024">chunked</span><span class="op" id="3135031">(</span><span class="ident" id="3135032">t</span><span class="op" id="3135033">.</span><span class="ident" id="3135034">TransferEncoding</span><span class="op" id="3135050">)</span>&nbsp;<span class="op" id="3135052">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135058">bodyAllowedForStatus</span><span class="op" id="3135078">(</span><span class="ident" id="3135079">t</span><span class="op" id="3135080">.</span><span class="ident" id="3135081">StatusCode</span><span class="op" id="3135091">)</span>&nbsp;<span class="op" id="3135093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135098">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135120">t</span><span class="op" id="3135121">.</span><span class="ident" id="3135122">Close</span>&nbsp;<span class="op" id="3135128">=</span>&nbsp;<span class="builtintype" id="3135130">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135140">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135144">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135211">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135287">switch</span>&nbsp;<span class="op" id="3135294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135297">case</span>&nbsp;<span class="ident" id="3135302">chunked</span><span class="op" id="3135309">(</span><span class="ident" id="3135310">t</span><span class="op" id="3135311">.</span><span class="ident" id="3135312">TransferEncoding</span><span class="op" id="3135328">)</span><span class="op" id="3135329">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135333">if</span>&nbsp;<span class="ident" id="3135336">noBodyExpected</span><span class="op" id="3135350">(</span><span class="ident" id="3135351">t</span><span class="op" id="3135352">.</span><span class="ident" id="3135353">RequestMethod</span><span class="op" id="3135366">)</span>&nbsp;<span class="op" id="3135368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135373">t</span><span class="op" id="3135374">.</span><span class="ident" id="3135375">Body</span>&nbsp;<span class="op" id="3135380">=</span>&nbsp;<span class="ident" id="3135382">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135394">}</span>&nbsp;<span class="keyword" id="3135396">else</span>&nbsp;<span class="op" id="3135401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135406">t</span><span class="op" id="3135407">.</span><span class="ident" id="3135408">Body</span>&nbsp;<span class="op" id="3135413">=</span>&nbsp;<span class="op" id="3135415">&amp;</span><span class="ident" id="3135416">body</span><span class="op" id="3135420">{</span><span class="ident" id="3135421">src</span><span class="op" id="3135424">:</span>&nbsp;<span class="ident" id="3135426">internal</span><span class="op" id="3135434">.</span><span class="ident" id="3135435">NewChunkedReader</span><span class="op" id="3135451">(</span><span class="ident" id="3135452">r</span><span class="op" id="3135453">)</span><span class="op" id="3135454">,</span>&nbsp;<span class="ident" id="3135456">hdr</span><span class="op" id="3135459">:</span>&nbsp;<span class="ident" id="3135461">msg</span><span class="op" id="3135464">,</span>&nbsp;<span class="ident" id="3135466">r</span><span class="op" id="3135467">:</span>&nbsp;<span class="ident" id="3135469">r</span><span class="op" id="3135470">,</span>&nbsp;<span class="ident" id="3135472">closing</span><span class="op" id="3135479">:</span>&nbsp;<span class="ident" id="3135481">t</span><span class="op" id="3135482">.</span><span class="ident" id="3135483">Close</span><span class="op" id="3135488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135492">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135495">case</span>&nbsp;<span class="ident" id="3135500">realLength</span>&nbsp;<span class="op" id="3135511">==</span>&nbsp;<span class="num" id="3135514">0</span><span class="op" id="3135515">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135519">t</span><span class="op" id="3135520">.</span><span class="ident" id="3135521">Body</span>&nbsp;<span class="op" id="3135526">=</span>&nbsp;<span class="ident" id="3135528">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135539">case</span>&nbsp;<span class="ident" id="3135544">realLength</span>&nbsp;<span class="op" id="3135555">&gt;</span>&nbsp;<span class="num" id="3135557">0</span><span class="op" id="3135558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135562">t</span><span class="op" id="3135563">.</span><span class="ident" id="3135564">Body</span>&nbsp;<span class="op" id="3135569">=</span>&nbsp;<span class="op" id="3135571">&amp;</span><span class="ident" id="3135572">body</span><span class="op" id="3135576">{</span><span class="ident" id="3135577">src</span><span class="op" id="3135580">:</span>&nbsp;<span class="ident" id="3135582">io</span><span class="op" id="3135584">.</span><span class="ident" id="3135585">LimitReader</span><span class="op" id="3135596">(</span><span class="ident" id="3135597">r</span><span class="op" id="3135598">,</span>&nbsp;<span class="ident" id="3135600">realLength</span><span class="op" id="3135610">)</span><span class="op" id="3135611">,</span>&nbsp;<span class="ident" id="3135613">closing</span><span class="op" id="3135620">:</span>&nbsp;<span class="ident" id="3135622">t</span><span class="op" id="3135623">.</span><span class="ident" id="3135624">Close</span><span class="op" id="3135629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135632">default</span><span class="op" id="3135639">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135643">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135710">if</span>&nbsp;<span class="ident" id="3135713">t</span><span class="op" id="3135714">.</span><span class="ident" id="3135715">Close</span>&nbsp;<span class="op" id="3135721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135726">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135764">t</span><span class="op" id="3135765">.</span><span class="ident" id="3135766">Body</span>&nbsp;<span class="op" id="3135771">=</span>&nbsp;<span class="op" id="3135773">&amp;</span><span class="ident" id="3135774">body</span><span class="op" id="3135778">{</span><span class="ident" id="3135779">src</span><span class="op" id="3135782">:</span>&nbsp;<span class="ident" id="3135784">r</span><span class="op" id="3135785">,</span>&nbsp;<span class="ident" id="3135787">closing</span><span class="op" id="3135794">:</span>&nbsp;<span class="ident" id="3135796">t</span><span class="op" id="3135797">.</span><span class="ident" id="3135798">Close</span><span class="op" id="3135803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135807">}</span>&nbsp;<span class="keyword" id="3135809">else</span>&nbsp;<span class="op" id="3135814">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135819">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135863">t</span><span class="op" id="3135864">.</span><span class="ident" id="3135865">Body</span>&nbsp;<span class="op" id="3135870">=</span>&nbsp;<span class="ident" id="3135872">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135891">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135908">switch</span>&nbsp;<span class="ident" id="3135915">rr</span>&nbsp;<span class="op" id="3135918">:=</span>&nbsp;<span class="ident" id="3135921">msg</span><span class="op" id="3135924">.</span><span class="op" id="3135925">(</span><span class="keyword" id="3135926">type</span><span class="op" id="3135930">)</span>&nbsp;<span class="op" id="3135932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135935">case</span>&nbsp;<span class="op" id="3135940">*</span><span class="ident" id="3135941">Request</span><span class="op" id="3135948">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135952">rr</span><span class="op" id="3135954">.</span><span class="ident" id="3135955">Body</span>&nbsp;<span class="op" id="3135960">=</span>&nbsp;<span class="ident" id="3135962">t</span><span class="op" id="3135963">.</span><span class="ident" id="3135964">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135971">rr</span><span class="op" id="3135973">.</span><span class="ident" id="3135974">ContentLength</span>&nbsp;<span class="op" id="3135988">=</span>&nbsp;<span class="ident" id="3135990">t</span><span class="op" id="3135991">.</span><span class="ident" id="3135992">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136008">rr</span><span class="op" id="3136010">.</span><span class="ident" id="3136011">TransferEncoding</span>&nbsp;<span class="op" id="3136028">=</span>&nbsp;<span class="ident" id="3136030">t</span><span class="op" id="3136031">.</span><span class="ident" id="3136032">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136051">rr</span><span class="op" id="3136053">.</span><span class="ident" id="3136054">Close</span>&nbsp;<span class="op" id="3136060">=</span>&nbsp;<span class="ident" id="3136062">t</span><span class="op" id="3136063">.</span><span class="ident" id="3136064">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136072">rr</span><span class="op" id="3136074">.</span><span class="ident" id="3136075">Trailer</span>&nbsp;<span class="op" id="3136083">=</span>&nbsp;<span class="ident" id="3136085">t</span><span class="op" id="3136086">.</span><span class="ident" id="3136087">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136096">case</span>&nbsp;<span class="op" id="3136101">*</span><span class="ident" id="3136102">Response</span><span class="op" id="3136110">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136114">rr</span><span class="op" id="3136116">.</span><span class="ident" id="3136117">Body</span>&nbsp;<span class="op" id="3136122">=</span>&nbsp;<span class="ident" id="3136124">t</span><span class="op" id="3136125">.</span><span class="ident" id="3136126">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136133">rr</span><span class="op" id="3136135">.</span><span class="ident" id="3136136">ContentLength</span>&nbsp;<span class="op" id="3136150">=</span>&nbsp;<span class="ident" id="3136152">t</span><span class="op" id="3136153">.</span><span class="ident" id="3136154">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136170">rr</span><span class="op" id="3136172">.</span><span class="ident" id="3136173">TransferEncoding</span>&nbsp;<span class="op" id="3136190">=</span>&nbsp;<span class="ident" id="3136192">t</span><span class="op" id="3136193">.</span><span class="ident" id="3136194">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136213">rr</span><span class="op" id="3136215">.</span><span class="ident" id="3136216">Close</span>&nbsp;<span class="op" id="3136222">=</span>&nbsp;<span class="ident" id="3136224">t</span><span class="op" id="3136225">.</span><span class="ident" id="3136226">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136234">rr</span><span class="op" id="3136236">.</span><span class="ident" id="3136237">Trailer</span>&nbsp;<span class="op" id="3136245">=</span>&nbsp;<span class="ident" id="3136247">t</span><span class="op" id="3136248">.</span><span class="ident" id="3136249">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136258">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136262">return</span>&nbsp;<span class="ident" id="3136269">nil</span><br>
<span class="lineno"></span><span class="op" id="3136273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3136276">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="3136333">func</span>&nbsp;<span class="ident" id="3136338">chunked</span><span class="op" id="3136345">(</span><span class="ident" id="3136346">te</span>&nbsp;<span class="op" id="3136349">[</span><span class="op" id="3136350">]</span><span class="builtintype" id="3136351">string</span><span class="op" id="3136357">)</span>&nbsp;<span class="builtintype" id="3136359">bool</span>&nbsp;<span class="op" id="3136364">{</span>&nbsp;<span class="keyword" id="3136366">return</span>&nbsp;<span class="builtinfunc" id="3136373">len</span><span class="op" id="3136376">(</span><span class="ident" id="3136377">te</span><span class="op" id="3136379">)</span>&nbsp;<span class="op" id="3136381">&gt;</span>&nbsp;<span class="num" id="3136383">0</span>&nbsp;<span class="op" id="3136385">&amp;&amp;</span>&nbsp;<span class="ident" id="3136388">te</span><span class="op" id="3136390">[</span><span class="num" id="3136391">0</span><span class="op" id="3136392">]</span>&nbsp;<span class="op" id="3136394">==</span>&nbsp;<span class="string" id="3136397">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3136407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3136410">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3136467">func</span>&nbsp;<span class="ident" id="3136472">isIdentity</span><span class="op" id="3136482">(</span><span class="ident" id="3136483">te</span>&nbsp;<span class="op" id="3136486">[</span><span class="op" id="3136487">]</span><span class="builtintype" id="3136488">string</span><span class="op" id="3136494">)</span>&nbsp;<span class="builtintype" id="3136496">bool</span>&nbsp;<span class="op" id="3136501">{</span>&nbsp;<span class="keyword" id="3136503">return</span>&nbsp;<span class="builtinfunc" id="3136510">len</span><span class="op" id="3136513">(</span><span class="ident" id="3136514">te</span><span class="op" id="3136516">)</span>&nbsp;<span class="op" id="3136518">==</span>&nbsp;<span class="num" id="3136521">1</span>&nbsp;<span class="op" id="3136523">&amp;&amp;</span>&nbsp;<span class="ident" id="3136526">te</span><span class="op" id="3136528">[</span><span class="num" id="3136529">0</span><span class="op" id="3136530">]</span>&nbsp;<span class="op" id="3136532">==</span>&nbsp;<span class="string" id="3136535">&#34;identity&#34;</span>&nbsp;<span class="op" id="3136546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3136549">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="3136579">func</span>&nbsp;<span class="ident" id="3136584">fixTransferEncoding</span><span class="op" id="3136603">(</span><span class="ident" id="3136604">requestMethod</span>&nbsp;<span class="builtintype" id="3136618">string</span><span class="op" id="3136624">,</span>&nbsp;<span class="ident" id="3136626">header</span>&nbsp;<span class="ident" id="3136633">Header</span><span class="op" id="3136639">)</span>&nbsp;<span class="op" id="3136641">(</span><span class="op" id="3136642">[</span><span class="op" id="3136643">]</span><span class="builtintype" id="3136644">string</span><span class="op" id="3136650">,</span>&nbsp;<span class="builtintype" id="3136652">error</span><span class="op" id="3136657">)</span>&nbsp;<span class="op" id="3136659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136662">raw</span><span class="op" id="3136665">,</span>&nbsp;<span class="ident" id="3136667">present</span>&nbsp;<span class="op" id="3136675">:=</span>&nbsp;<span class="ident" id="3136678">header</span><span class="op" id="3136684">[</span><span class="string" id="3136685">&#34;Transfer-Encoding&#34;</span><span class="op" id="3136704">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136707">if</span>&nbsp;<span class="op" id="3136710">!</span><span class="ident" id="3136711">present</span>&nbsp;<span class="op" id="3136719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136723">return</span>&nbsp;<span class="ident" id="3136730">nil</span><span class="op" id="3136733">,</span>&nbsp;<span class="ident" id="3136735">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3136744">delete</span><span class="op" id="3136750">(</span><span class="ident" id="3136751">header</span><span class="op" id="3136757">,</span>&nbsp;<span class="string" id="3136759">&#34;Transfer-Encoding&#34;</span><span class="op" id="3136778">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136782">encodings</span>&nbsp;<span class="op" id="3136792">:=</span>&nbsp;<span class="ident" id="3136795">strings</span><span class="op" id="3136802">.</span><span class="ident" id="3136803">Split</span><span class="op" id="3136808">(</span><span class="ident" id="3136809">raw</span><span class="op" id="3136812">[</span><span class="num" id="3136813">0</span><span class="op" id="3136814">]</span><span class="op" id="3136815">,</span>&nbsp;<span class="string" id="3136817">&#34;,&#34;</span><span class="op" id="3136820">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136823">te</span>&nbsp;<span class="op" id="3136826">:=</span>&nbsp;<span class="builtinfunc" id="3136829">make</span><span class="op" id="3136833">(</span><span class="op" id="3136834">[</span><span class="op" id="3136835">]</span><span class="builtintype" id="3136836">string</span><span class="op" id="3136842">,</span>&nbsp;<span class="num" id="3136844">0</span><span class="op" id="3136845">,</span>&nbsp;<span class="builtinfunc" id="3136847">len</span><span class="op" id="3136850">(</span><span class="ident" id="3136851">encodings</span><span class="op" id="3136860">)</span><span class="op" id="3136861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136864">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136927">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136989">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3137048">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137093">for</span>&nbsp;<span class="ident" id="3137097">_</span><span class="op" id="3137098">,</span>&nbsp;<span class="ident" id="3137100">encoding</span>&nbsp;<span class="op" id="3137109">:=</span>&nbsp;<span class="keyword" id="3137112">range</span>&nbsp;<span class="ident" id="3137118">encodings</span>&nbsp;<span class="op" id="3137128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137132">encoding</span>&nbsp;<span class="op" id="3137141">=</span>&nbsp;<span class="ident" id="3137143">strings</span><span class="op" id="3137150">.</span><span class="ident" id="3137151">ToLower</span><span class="op" id="3137158">(</span><span class="ident" id="3137159">strings</span><span class="op" id="3137166">.</span><span class="ident" id="3137167">TrimSpace</span><span class="op" id="3137176">(</span><span class="ident" id="3137177">encoding</span><span class="op" id="3137185">)</span><span class="op" id="3137186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3137190">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137231">if</span>&nbsp;<span class="ident" id="3137234">encoding</span>&nbsp;<span class="op" id="3137243">==</span>&nbsp;<span class="string" id="3137246">&#34;identity&#34;</span>&nbsp;<span class="op" id="3137257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137262">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137274">if</span>&nbsp;<span class="ident" id="3137277">encoding</span>&nbsp;<span class="op" id="3137286">!=</span>&nbsp;<span class="string" id="3137289">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3137299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137304">return</span>&nbsp;<span class="ident" id="3137311">nil</span><span class="op" id="3137314">,</span>&nbsp;<span class="op" id="3137316">&amp;</span><span class="ident" id="3137317">badStringError</span><span class="op" id="3137331">{</span><span class="string" id="3137332">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="3137363">,</span>&nbsp;<span class="ident" id="3137365">encoding</span><span class="op" id="3137373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137381">te</span>&nbsp;<span class="op" id="3137384">=</span>&nbsp;<span class="ident" id="3137386">te</span><span class="op" id="3137388">[</span><span class="num" id="3137389">0</span>&nbsp;<span class="op" id="3137391">:</span>&nbsp;<span class="builtinfunc" id="3137393">len</span><span class="op" id="3137396">(</span><span class="ident" id="3137397">te</span><span class="op" id="3137399">)</span><span class="op" id="3137400">+</span><span class="num" id="3137401">1</span><span class="op" id="3137402">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137406">te</span><span class="op" id="3137408">[</span><span class="builtinfunc" id="3137409">len</span><span class="op" id="3137412">(</span><span class="ident" id="3137413">te</span><span class="op" id="3137415">)</span><span class="op" id="3137416">-</span><span class="num" id="3137417">1</span><span class="op" id="3137418">]</span>&nbsp;<span class="op" id="3137420">=</span>&nbsp;<span class="ident" id="3137422">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137435">if</span>&nbsp;<span class="builtinfunc" id="3137438">len</span><span class="op" id="3137441">(</span><span class="ident" id="3137442">te</span><span class="op" id="3137444">)</span>&nbsp;<span class="op" id="3137446">&gt;</span>&nbsp;<span class="num" id="3137448">1</span>&nbsp;<span class="op" id="3137450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137454">return</span>&nbsp;<span class="ident" id="3137461">nil</span><span class="op" id="3137464">,</span>&nbsp;<span class="op" id="3137466">&amp;</span><span class="ident" id="3137467">badStringError</span><span class="op" id="3137481">{</span><span class="string" id="3137482">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="3137511">,</span>&nbsp;<span class="ident" id="3137513">strings</span><span class="op" id="3137520">.</span><span class="ident" id="3137521">Join</span><span class="op" id="3137525">(</span><span class="ident" id="3137526">te</span><span class="op" id="3137528">,</span>&nbsp;<span class="string" id="3137530">&#34;,&#34;</span><span class="op" id="3137533">)</span><span class="op" id="3137534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137537">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137540">if</span>&nbsp;<span class="builtinfunc" id="3137543">len</span><span class="op" id="3137546">(</span><span class="ident" id="3137547">te</span><span class="op" id="3137549">)</span>&nbsp;<span class="op" id="3137551">&gt;</span>&nbsp;<span class="num" id="3137553">0</span>&nbsp;<span class="op" id="3137555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3137559">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3137617">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3137673">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3137688">delete</span><span class="op" id="3137694">(</span><span class="ident" id="3137695">header</span><span class="op" id="3137701">,</span>&nbsp;<span class="string" id="3137703">&#34;Content-Length&#34;</span><span class="op" id="3137719">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137723">return</span>&nbsp;<span class="ident" id="3137730">te</span><span class="op" id="3137732">,</span>&nbsp;<span class="ident" id="3137734">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137743">return</span>&nbsp;<span class="ident" id="3137750">nil</span><span class="op" id="3137753">,</span>&nbsp;<span class="ident" id="3137755">nil</span><br>
<span class="lineno"></span><span class="op" id="3137759">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3137762">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="3137834">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3137905">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="3137938">func</span>&nbsp;<span class="ident" id="3137943">fixLength</span><span class="op" id="3137952">(</span><span class="ident" id="3137953">isResponse</span>&nbsp;<span class="builtintype" id="3137964">bool</span><span class="op" id="3137968">,</span>&nbsp;<span class="ident" id="3137970">status</span>&nbsp;<span class="builtintype" id="3137977">int</span><span class="op" id="3137980">,</span>&nbsp;<span class="ident" id="3137982">requestMethod</span>&nbsp;<span class="builtintype" id="3137996">string</span><span class="op" id="3138002">,</span>&nbsp;<span class="ident" id="3138004">header</span>&nbsp;<span class="ident" id="3138011">Header</span><span class="op" id="3138017">,</span>&nbsp;<span class="ident" id="3138019">te</span>&nbsp;<span class="op" id="3138022">[</span><span class="op" id="3138023">]</span><span class="builtintype" id="3138024">string</span><span class="op" id="3138030">)</span>&nbsp;<span class="op" id="3138032">(</span><span class="ident" id="3138033">int64</span><span class="op" id="3138038">,</span>&nbsp;<span class="builtintype" id="3138040">error</span><span class="op" id="3138045">)</span>&nbsp;<span class="op" id="3138047">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138051">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138094">if</span>&nbsp;<span class="ident" id="3138097">noBodyExpected</span><span class="op" id="3138111">(</span><span class="ident" id="3138112">requestMethod</span><span class="op" id="3138125">)</span>&nbsp;<span class="op" id="3138127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138131">return</span>&nbsp;<span class="num" id="3138138">0</span><span class="op" id="3138139">,</span>&nbsp;<span class="ident" id="3138141">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138146">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138149">if</span>&nbsp;<span class="ident" id="3138152">status</span><span class="op" id="3138158">/</span><span class="num" id="3138159">100</span>&nbsp;<span class="op" id="3138163">==</span>&nbsp;<span class="num" id="3138166">1</span>&nbsp;<span class="op" id="3138168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138172">return</span>&nbsp;<span class="num" id="3138179">0</span><span class="op" id="3138180">,</span>&nbsp;<span class="ident" id="3138182">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138190">switch</span>&nbsp;<span class="ident" id="3138197">status</span>&nbsp;<span class="op" id="3138204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138207">case</span>&nbsp;<span class="num" id="3138212">204</span><span class="op" id="3138215">,</span>&nbsp;<span class="num" id="3138217">304</span><span class="op" id="3138220">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138224">return</span>&nbsp;<span class="num" id="3138231">0</span><span class="op" id="3138232">,</span>&nbsp;<span class="ident" id="3138234">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138243">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138280">if</span>&nbsp;<span class="ident" id="3138283">chunked</span><span class="op" id="3138290">(</span><span class="ident" id="3138291">te</span><span class="op" id="3138293">)</span>&nbsp;<span class="op" id="3138295">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138299">return</span>&nbsp;<span class="op" id="3138306">-</span><span class="num" id="3138307">1</span><span class="op" id="3138308">,</span>&nbsp;<span class="ident" id="3138310">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138319">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138353">cl</span>&nbsp;<span class="op" id="3138356">:=</span>&nbsp;<span class="ident" id="3138359">strings</span><span class="op" id="3138366">.</span><span class="ident" id="3138367">TrimSpace</span><span class="op" id="3138376">(</span><span class="ident" id="3138377">header</span><span class="op" id="3138383">.</span><span class="ident" id="3138384">get</span><span class="op" id="3138387">(</span><span class="string" id="3138388">&#34;Content-Length&#34;</span><span class="op" id="3138404">)</span><span class="op" id="3138405">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138408">if</span>&nbsp;<span class="ident" id="3138411">cl</span>&nbsp;<span class="op" id="3138414">!=</span>&nbsp;<span class="string" id="3138417">&#34;&#34;</span>&nbsp;<span class="op" id="3138420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138424">n</span><span class="op" id="3138425">,</span>&nbsp;<span class="ident" id="3138427">err</span>&nbsp;<span class="op" id="3138431">:=</span>&nbsp;<span class="ident" id="3138434">parseContentLength</span><span class="op" id="3138452">(</span><span class="ident" id="3138453">cl</span><span class="op" id="3138455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138459">if</span>&nbsp;<span class="ident" id="3138462">err</span>&nbsp;<span class="op" id="3138466">!=</span>&nbsp;<span class="ident" id="3138469">nil</span>&nbsp;<span class="op" id="3138473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138478">return</span>&nbsp;<span class="op" id="3138485">-</span><span class="num" id="3138486">1</span><span class="op" id="3138487">,</span>&nbsp;<span class="ident" id="3138489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138495">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138499">return</span>&nbsp;<span class="ident" id="3138506">n</span><span class="op" id="3138507">,</span>&nbsp;<span class="ident" id="3138509">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138514">}</span>&nbsp;<span class="keyword" id="3138516">else</span>&nbsp;<span class="op" id="3138521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138525">header</span><span class="op" id="3138531">.</span><span class="ident" id="3138532">Del</span><span class="op" id="3138535">(</span><span class="string" id="3138536">&#34;Content-Length&#34;</span><span class="op" id="3138552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138559">if</span>&nbsp;<span class="op" id="3138562">!</span><span class="ident" id="3138563">isResponse</span>&nbsp;<span class="op" id="3138574">&amp;&amp;</span>&nbsp;<span class="ident" id="3138577">requestMethod</span>&nbsp;<span class="op" id="3138591">==</span>&nbsp;<span class="string" id="3138594">&#34;GET&#34;</span>&nbsp;<span class="op" id="3138600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138604">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138658">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138712">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138767">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138805">return</span>&nbsp;<span class="num" id="3138812">0</span><span class="op" id="3138813">,</span>&nbsp;<span class="ident" id="3138815">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138824">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138900">return</span>&nbsp;<span class="op" id="3138907">-</span><span class="num" id="3138908">1</span><span class="op" id="3138909">,</span>&nbsp;<span class="ident" id="3138911">nil</span><br>
<span class="lineno">500</span><span class="op" id="3138915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3138918">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3138987">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="3139020">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="3139055">func</span>&nbsp;<span class="ident" id="3139060">shouldClose</span><span class="op" id="3139071">(</span><span class="ident" id="3139072">major</span><span class="op" id="3139077">,</span>&nbsp;<span class="ident" id="3139079">minor</span>&nbsp;<span class="builtintype" id="3139085">int</span><span class="op" id="3139088">,</span>&nbsp;<span class="ident" id="3139090">header</span>&nbsp;<span class="ident" id="3139097">Header</span><span class="op" id="3139103">,</span>&nbsp;<span class="ident" id="3139105">removeCloseHeader</span>&nbsp;<span class="builtintype" id="3139123">bool</span><span class="op" id="3139127">)</span>&nbsp;<span class="builtintype" id="3139129">bool</span>&nbsp;<span class="op" id="3139134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139137">if</span>&nbsp;<span class="ident" id="3139140">major</span>&nbsp;<span class="op" id="3139146">&lt;</span>&nbsp;<span class="num" id="3139148">1</span>&nbsp;<span class="op" id="3139150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139154">return</span>&nbsp;<span class="builtintype" id="3139161">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139167">}</span>&nbsp;<span class="keyword" id="3139169">else</span>&nbsp;<span class="keyword" id="3139174">if</span>&nbsp;<span class="ident" id="3139177">major</span>&nbsp;<span class="op" id="3139183">==</span>&nbsp;<span class="num" id="3139186">1</span>&nbsp;<span class="op" id="3139188">&amp;&amp;</span>&nbsp;<span class="ident" id="3139191">minor</span>&nbsp;<span class="op" id="3139197">==</span>&nbsp;<span class="num" id="3139200">0</span>&nbsp;<span class="op" id="3139202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139206">if</span>&nbsp;<span class="op" id="3139209">!</span><span class="ident" id="3139210">strings</span><span class="op" id="3139217">.</span><span class="ident" id="3139218">Contains</span><span class="op" id="3139226">(</span><span class="ident" id="3139227">strings</span><span class="op" id="3139234">.</span><span class="ident" id="3139235">ToLower</span><span class="op" id="3139242">(</span><span class="ident" id="3139243">header</span><span class="op" id="3139249">.</span><span class="ident" id="3139250">get</span><span class="op" id="3139253">(</span><span class="string" id="3139254">&#34;Connection&#34;</span><span class="op" id="3139266">)</span><span class="op" id="3139267">)</span><span class="op" id="3139268">,</span>&nbsp;<span class="string" id="3139270">&#34;keep-alive&#34;</span><span class="op" id="3139282">)</span>&nbsp;<span class="op" id="3139284">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139289">return</span>&nbsp;<span class="builtintype" id="3139296">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139307">return</span>&nbsp;<span class="builtintype" id="3139314">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139321">}</span>&nbsp;<span class="keyword" id="3139323">else</span>&nbsp;<span class="op" id="3139328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139332">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139397">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139424">if</span>&nbsp;<span class="ident" id="3139427">strings</span><span class="op" id="3139434">.</span><span class="ident" id="3139435">ToLower</span><span class="op" id="3139442">(</span><span class="ident" id="3139443">header</span><span class="op" id="3139449">.</span><span class="ident" id="3139450">get</span><span class="op" id="3139453">(</span><span class="string" id="3139454">&#34;Connection&#34;</span><span class="op" id="3139466">)</span><span class="op" id="3139467">)</span>&nbsp;<span class="op" id="3139469">==</span>&nbsp;<span class="string" id="3139472">&#34;close&#34;</span>&nbsp;<span class="op" id="3139480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139485">if</span>&nbsp;<span class="ident" id="3139488">removeCloseHeader</span>&nbsp;<span class="op" id="3139506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139512">header</span><span class="op" id="3139518">.</span><span class="ident" id="3139519">Del</span><span class="op" id="3139522">(</span><span class="string" id="3139523">&#34;Connection&#34;</span><span class="op" id="3139535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139540">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139545">return</span>&nbsp;<span class="builtintype" id="3139552">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139565">return</span>&nbsp;<span class="builtintype" id="3139572">false</span><br>
<span class="lineno"></span><span class="op" id="3139578">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="3139581">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3139609">func</span>&nbsp;<span class="ident" id="3139614">fixTrailer</span><span class="op" id="3139624">(</span><span class="ident" id="3139625">header</span>&nbsp;<span class="ident" id="3139632">Header</span><span class="op" id="3139638">,</span>&nbsp;<span class="ident" id="3139640">te</span>&nbsp;<span class="op" id="3139643">[</span><span class="op" id="3139644">]</span><span class="builtintype" id="3139645">string</span><span class="op" id="3139651">)</span>&nbsp;<span class="op" id="3139653">(</span><span class="ident" id="3139654">Header</span><span class="op" id="3139660">,</span>&nbsp;<span class="builtintype" id="3139662">error</span><span class="op" id="3139667">)</span>&nbsp;<span class="op" id="3139669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139672">raw</span>&nbsp;<span class="op" id="3139676">:=</span>&nbsp;<span class="ident" id="3139679">header</span><span class="op" id="3139685">.</span><span class="ident" id="3139686">get</span><span class="op" id="3139689">(</span><span class="string" id="3139690">&#34;Trailer&#34;</span><span class="op" id="3139699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139702">if</span>&nbsp;<span class="ident" id="3139705">raw</span>&nbsp;<span class="op" id="3139709">==</span>&nbsp;<span class="string" id="3139712">&#34;&#34;</span>&nbsp;<span class="op" id="3139715">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139719">return</span>&nbsp;<span class="ident" id="3139726">nil</span><span class="op" id="3139729">,</span>&nbsp;<span class="ident" id="3139731">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139740">header</span><span class="op" id="3139746">.</span><span class="ident" id="3139747">Del</span><span class="op" id="3139750">(</span><span class="string" id="3139751">&#34;Trailer&#34;</span><span class="op" id="3139760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139763">trailer</span>&nbsp;<span class="op" id="3139771">:=</span>&nbsp;<span class="builtinfunc" id="3139774">make</span><span class="op" id="3139778">(</span><span class="ident" id="3139779">Header</span><span class="op" id="3139785">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139788">keys</span>&nbsp;<span class="op" id="3139793">:=</span>&nbsp;<span class="ident" id="3139796">strings</span><span class="op" id="3139803">.</span><span class="ident" id="3139804">Split</span><span class="op" id="3139809">(</span><span class="ident" id="3139810">raw</span><span class="op" id="3139813">,</span>&nbsp;<span class="string" id="3139815">&#34;,&#34;</span><span class="op" id="3139818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139821">for</span>&nbsp;<span class="ident" id="3139825">_</span><span class="op" id="3139826">,</span>&nbsp;<span class="ident" id="3139828">key</span>&nbsp;<span class="op" id="3139832">:=</span>&nbsp;<span class="keyword" id="3139835">range</span>&nbsp;<span class="ident" id="3139841">keys</span>&nbsp;<span class="op" id="3139846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139850">key</span>&nbsp;<span class="op" id="3139854">=</span>&nbsp;<span class="ident" id="3139856">CanonicalHeaderKey</span><span class="op" id="3139874">(</span><span class="ident" id="3139875">strings</span><span class="op" id="3139882">.</span><span class="ident" id="3139883">TrimSpace</span><span class="op" id="3139892">(</span><span class="ident" id="3139893">key</span><span class="op" id="3139896">)</span><span class="op" id="3139897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139901">switch</span>&nbsp;<span class="ident" id="3139908">key</span>&nbsp;<span class="op" id="3139912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139916">case</span>&nbsp;<span class="string" id="3139921">&#34;Transfer-Encoding&#34;</span><span class="op" id="3139940">,</span>&nbsp;<span class="string" id="3139942">&#34;Trailer&#34;</span><span class="op" id="3139951">,</span>&nbsp;<span class="string" id="3139953">&#34;Content-Length&#34;</span><span class="op" id="3139969">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139974">return</span>&nbsp;<span class="ident" id="3139981">nil</span><span class="op" id="3139984">,</span>&nbsp;<span class="op" id="3139986">&amp;</span><span class="ident" id="3139987">badStringError</span><span class="op" id="3140001">{</span><span class="string" id="3140002">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="3140019">,</span>&nbsp;<span class="ident" id="3140021">key</span><span class="op" id="3140024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140032">trailer</span><span class="op" id="3140039">[</span><span class="ident" id="3140040">key</span><span class="op" id="3140043">]</span>&nbsp;<span class="op" id="3140045">=</span>&nbsp;<span class="ident" id="3140047">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140055">if</span>&nbsp;<span class="builtinfunc" id="3140058">len</span><span class="op" id="3140061">(</span><span class="ident" id="3140062">trailer</span><span class="op" id="3140069">)</span>&nbsp;<span class="op" id="3140071">==</span>&nbsp;<span class="num" id="3140074">0</span>&nbsp;<span class="op" id="3140076">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140080">return</span>&nbsp;<span class="ident" id="3140087">nil</span><span class="op" id="3140090">,</span>&nbsp;<span class="ident" id="3140092">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140100">if</span>&nbsp;<span class="op" id="3140103">!</span><span class="ident" id="3140104">chunked</span><span class="op" id="3140111">(</span><span class="ident" id="3140112">te</span><span class="op" id="3140114">)</span>&nbsp;<span class="op" id="3140116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3140120">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140149">return</span>&nbsp;<span class="ident" id="3140156">nil</span><span class="op" id="3140159">,</span>&nbsp;<span class="ident" id="3140161">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140186">return</span>&nbsp;<span class="ident" id="3140193">trailer</span><span class="op" id="3140200">,</span>&nbsp;<span class="ident" id="3140202">nil</span><br>
<span class="lineno"></span><span class="op" id="3140206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3140209">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="3140251">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3140302">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3140346">type</span>&nbsp;<span class="ident" id="3140351">body</span>&nbsp;<span class="keyword" id="3140356">struct</span>&nbsp;<span class="op" id="3140363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140366">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3140374">io</span><span class="op" id="3140376">.</span><span class="ident" id="3140377">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140385">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3140393">interface</span><span class="op" id="3140402">{</span><span class="op" id="3140403">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3140407">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140466">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3140474">*</span><span class="ident" id="3140475">bufio</span><span class="op" id="3140480">.</span><span class="ident" id="3140481">Reader</span>&nbsp;<span class="comment" id="3140488">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140538">closing</span>&nbsp;<span class="builtintype" id="3140546">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3140560">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140616">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3140623">sync</span><span class="op" id="3140627">.</span><span class="ident" id="3140628">Mutex</span>&nbsp;<span class="comment" id="3140634">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140681">closed</span>&nbsp;<span class="builtintype" id="3140688">bool</span><br>
<span class="lineno">565</span><span class="op" id="3140693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3140696">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3140768">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3140848">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="3140912">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="3140931">var</span>&nbsp;<span class="ident" id="3140935">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="3140957">=</span>&nbsp;<span class="ident" id="3140959">errors</span><span class="op" id="3140965">.</span><span class="ident" id="3140966">New</span><span class="op" id="3140969">(</span><span class="string" id="3140970">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="3141005">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3141008">func</span>&nbsp;<span class="op" id="3141013">(</span><span class="ident" id="3141014">b</span>&nbsp;<span class="op" id="3141016">*</span><span class="ident" id="3141017">body</span><span class="op" id="3141021">)</span>&nbsp;<span class="ident" id="3141023">Read</span><span class="op" id="3141027">(</span><span class="ident" id="3141028">p</span>&nbsp;<span class="op" id="3141030">[</span><span class="op" id="3141031">]</span><span class="builtintype" id="3141032">byte</span><span class="op" id="3141036">)</span>&nbsp;<span class="op" id="3141038">(</span><span class="ident" id="3141039">n</span>&nbsp;<span class="builtintype" id="3141041">int</span><span class="op" id="3141044">,</span>&nbsp;<span class="ident" id="3141046">err</span>&nbsp;<span class="builtintype" id="3141050">error</span><span class="op" id="3141055">)</span>&nbsp;<span class="op" id="3141057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141060">b</span><span class="op" id="3141061">.</span><span class="ident" id="3141062">mu</span><span class="op" id="3141064">.</span><span class="ident" id="3141065">Lock</span><span class="op" id="3141069">(</span><span class="op" id="3141070">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141073">defer</span>&nbsp;<span class="ident" id="3141079">b</span><span class="op" id="3141080">.</span><span class="ident" id="3141081">mu</span><span class="op" id="3141083">.</span><span class="ident" id="3141084">Unlock</span><span class="op" id="3141090">(</span><span class="op" id="3141091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141094">if</span>&nbsp;<span class="ident" id="3141097">b</span><span class="op" id="3141098">.</span><span class="ident" id="3141099">closed</span>&nbsp;<span class="op" id="3141106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141110">return</span>&nbsp;<span class="num" id="3141117">0</span><span class="op" id="3141118">,</span>&nbsp;<span class="ident" id="3141120">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141146">return</span>&nbsp;<span class="ident" id="3141153">b</span><span class="op" id="3141154">.</span><span class="ident" id="3141155">readLocked</span><span class="op" id="3141165">(</span><span class="ident" id="3141166">p</span><span class="op" id="3141167">)</span><br>
<span class="lineno">580</span><span class="op" id="3141169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3141172">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3141191">func</span>&nbsp;<span class="op" id="3141196">(</span><span class="ident" id="3141197">b</span>&nbsp;<span class="op" id="3141199">*</span><span class="ident" id="3141200">body</span><span class="op" id="3141204">)</span>&nbsp;<span class="ident" id="3141206">readLocked</span><span class="op" id="3141216">(</span><span class="ident" id="3141217">p</span>&nbsp;<span class="op" id="3141219">[</span><span class="op" id="3141220">]</span><span class="builtintype" id="3141221">byte</span><span class="op" id="3141225">)</span>&nbsp;<span class="op" id="3141227">(</span><span class="ident" id="3141228">n</span>&nbsp;<span class="builtintype" id="3141230">int</span><span class="op" id="3141233">,</span>&nbsp;<span class="ident" id="3141235">err</span>&nbsp;<span class="builtintype" id="3141239">error</span><span class="op" id="3141244">)</span>&nbsp;<span class="op" id="3141246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141249">n</span><span class="op" id="3141250">,</span>&nbsp;<span class="ident" id="3141252">err</span>&nbsp;<span class="op" id="3141256">=</span>&nbsp;<span class="ident" id="3141258">b</span><span class="op" id="3141259">.</span><span class="ident" id="3141260">src</span><span class="op" id="3141263">.</span><span class="ident" id="3141264">Read</span><span class="op" id="3141268">(</span><span class="ident" id="3141269">p</span><span class="op" id="3141270">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141274">if</span>&nbsp;<span class="ident" id="3141277">err</span>&nbsp;<span class="op" id="3141281">==</span>&nbsp;<span class="ident" id="3141284">io</span><span class="op" id="3141286">.</span><span class="ident" id="3141287">EOF</span>&nbsp;<span class="op" id="3141291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141295">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141332">if</span>&nbsp;<span class="ident" id="3141335">b</span><span class="op" id="3141336">.</span><span class="ident" id="3141337">hdr</span>&nbsp;<span class="op" id="3141341">!=</span>&nbsp;<span class="ident" id="3141344">nil</span>&nbsp;<span class="op" id="3141348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141353">if</span>&nbsp;<span class="ident" id="3141356">e</span>&nbsp;<span class="op" id="3141358">:=</span>&nbsp;<span class="ident" id="3141361">b</span><span class="op" id="3141362">.</span><span class="ident" id="3141363">readTrailer</span><span class="op" id="3141374">(</span><span class="op" id="3141375">)</span><span class="op" id="3141376">;</span>&nbsp;<span class="ident" id="3141378">e</span>&nbsp;<span class="op" id="3141380">!=</span>&nbsp;<span class="ident" id="3141383">nil</span>&nbsp;<span class="op" id="3141387">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141393">err</span>&nbsp;<span class="op" id="3141397">=</span>&nbsp;<span class="ident" id="3141399">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141409">b</span><span class="op" id="3141410">.</span><span class="ident" id="3141411">hdr</span>&nbsp;<span class="op" id="3141415">=</span>&nbsp;<span class="ident" id="3141417">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141423">}</span>&nbsp;<span class="keyword" id="3141425">else</span>&nbsp;<span class="op" id="3141430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141435">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141512">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141571">if</span>&nbsp;<span class="ident" id="3141574">lr</span><span class="op" id="3141576">,</span>&nbsp;<span class="ident" id="3141578">ok</span>&nbsp;<span class="op" id="3141581">:=</span>&nbsp;<span class="ident" id="3141584">b</span><span class="op" id="3141585">.</span><span class="ident" id="3141586">src</span><span class="op" id="3141589">.</span><span class="op" id="3141590">(</span><span class="op" id="3141591">*</span><span class="ident" id="3141592">io</span><span class="op" id="3141594">.</span><span class="ident" id="3141595">LimitedReader</span><span class="op" id="3141608">)</span><span class="op" id="3141609">;</span>&nbsp;<span class="ident" id="3141611">ok</span>&nbsp;<span class="op" id="3141614">&amp;&amp;</span>&nbsp;<span class="ident" id="3141617">lr</span><span class="op" id="3141619">.</span><span class="ident" id="3141620">N</span>&nbsp;<span class="op" id="3141622">&gt;</span>&nbsp;<span class="num" id="3141624">0</span>&nbsp;<span class="op" id="3141626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141632">err</span>&nbsp;<span class="op" id="3141636">=</span>&nbsp;<span class="ident" id="3141638">io</span><span class="op" id="3141640">.</span><span class="ident" id="3141641">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141665">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141672">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141734">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141797">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141857">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141918">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141963">if</span>&nbsp;<span class="ident" id="3141966">err</span>&nbsp;<span class="op" id="3141970">==</span>&nbsp;<span class="ident" id="3141973">nil</span>&nbsp;<span class="op" id="3141977">&amp;&amp;</span>&nbsp;<span class="ident" id="3141980">n</span>&nbsp;<span class="op" id="3141982">&gt;</span>&nbsp;<span class="num" id="3141984">0</span>&nbsp;<span class="op" id="3141986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141990">if</span>&nbsp;<span class="ident" id="3141993">lr</span><span class="op" id="3141995">,</span>&nbsp;<span class="ident" id="3141997">ok</span>&nbsp;<span class="op" id="3142000">:=</span>&nbsp;<span class="ident" id="3142003">b</span><span class="op" id="3142004">.</span><span class="ident" id="3142005">src</span><span class="op" id="3142008">.</span><span class="op" id="3142009">(</span><span class="op" id="3142010">*</span><span class="ident" id="3142011">io</span><span class="op" id="3142013">.</span><span class="ident" id="3142014">LimitedReader</span><span class="op" id="3142027">)</span><span class="op" id="3142028">;</span>&nbsp;<span class="ident" id="3142030">ok</span>&nbsp;<span class="op" id="3142033">&amp;&amp;</span>&nbsp;<span class="ident" id="3142036">lr</span><span class="op" id="3142038">.</span><span class="ident" id="3142039">N</span>&nbsp;<span class="op" id="3142041">==</span>&nbsp;<span class="num" id="3142044">0</span>&nbsp;<span class="op" id="3142046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142051">err</span>&nbsp;<span class="op" id="3142055">=</span>&nbsp;<span class="ident" id="3142057">io</span><span class="op" id="3142059">.</span><span class="ident" id="3142060">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142073">return</span>&nbsp;<span class="ident" id="3142080">n</span><span class="op" id="3142081">,</span>&nbsp;<span class="ident" id="3142083">err</span><br>
<span class="lineno"></span><span class="op" id="3142087">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="3142090">var</span>&nbsp;<span class="op" id="3142094">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142097">singleCRLF</span>&nbsp;<span class="op" id="3142108">=</span>&nbsp;<span class="op" id="3142110">[</span><span class="op" id="3142111">]</span><span class="builtintype" id="3142112">byte</span><span class="op" id="3142116">(</span><span class="string" id="3142117">&#34;\r\n&#34;</span><span class="op" id="3142123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142126">doubleCRLF</span>&nbsp;<span class="op" id="3142137">=</span>&nbsp;<span class="op" id="3142139">[</span><span class="op" id="3142140">]</span><span class="builtintype" id="3142141">byte</span><span class="op" id="3142145">(</span><span class="string" id="3142146">&#34;\r\n\r\n&#34;</span><span class="op" id="3142156">)</span><br>
<span class="lineno"></span><span class="op" id="3142158">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="3142161">func</span>&nbsp;<span class="ident" id="3142166">seeUpcomingDoubleCRLF</span><span class="op" id="3142187">(</span><span class="ident" id="3142188">r</span>&nbsp;<span class="op" id="3142190">*</span><span class="ident" id="3142191">bufio</span><span class="op" id="3142196">.</span><span class="ident" id="3142197">Reader</span><span class="op" id="3142203">)</span>&nbsp;<span class="builtintype" id="3142205">bool</span>&nbsp;<span class="op" id="3142210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142213">for</span>&nbsp;<span class="ident" id="3142217">peekSize</span>&nbsp;<span class="op" id="3142226">:=</span>&nbsp;<span class="num" id="3142229">4</span><span class="op" id="3142230">;</span>&nbsp;<span class="op" id="3142232">;</span>&nbsp;<span class="ident" id="3142234">peekSize</span><span class="op" id="3142242">++</span>&nbsp;<span class="op" id="3142245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142249">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142298">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142350">buf</span><span class="op" id="3142353">,</span>&nbsp;<span class="ident" id="3142355">err</span>&nbsp;<span class="op" id="3142359">:=</span>&nbsp;<span class="ident" id="3142362">r</span><span class="op" id="3142363">.</span><span class="ident" id="3142364">Peek</span><span class="op" id="3142368">(</span><span class="ident" id="3142369">peekSize</span><span class="op" id="3142377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142381">if</span>&nbsp;<span class="ident" id="3142384">bytes</span><span class="op" id="3142389">.</span><span class="ident" id="3142390">HasSuffix</span><span class="op" id="3142399">(</span><span class="ident" id="3142400">buf</span><span class="op" id="3142403">,</span>&nbsp;<span class="ident" id="3142405">doubleCRLF</span><span class="op" id="3142415">)</span>&nbsp;<span class="op" id="3142417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142422">return</span>&nbsp;<span class="builtintype" id="3142429">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142440">if</span>&nbsp;<span class="ident" id="3142443">err</span>&nbsp;<span class="op" id="3142447">!=</span>&nbsp;<span class="ident" id="3142450">nil</span>&nbsp;<span class="op" id="3142454">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142459">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142473">return</span>&nbsp;<span class="builtintype" id="3142480">false</span><br>
<span class="lineno"></span><span class="op" id="3142486">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="3142489">var</span>&nbsp;<span class="ident" id="3142493">errTrailerEOF</span>&nbsp;<span class="op" id="3142507">=</span>&nbsp;<span class="ident" id="3142509">errors</span><span class="op" id="3142515">.</span><span class="ident" id="3142516">New</span><span class="op" id="3142519">(</span><span class="string" id="3142520">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="3142558">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3142561">func</span>&nbsp;<span class="op" id="3142566">(</span><span class="ident" id="3142567">b</span>&nbsp;<span class="op" id="3142569">*</span><span class="ident" id="3142570">body</span><span class="op" id="3142574">)</span>&nbsp;<span class="ident" id="3142576">readTrailer</span><span class="op" id="3142587">(</span><span class="op" id="3142588">)</span>&nbsp;<span class="builtintype" id="3142590">error</span>&nbsp;<span class="op" id="3142596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142599">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142648">buf</span><span class="op" id="3142651">,</span>&nbsp;<span class="ident" id="3142653">err</span>&nbsp;<span class="op" id="3142657">:=</span>&nbsp;<span class="ident" id="3142660">b</span><span class="op" id="3142661">.</span><span class="ident" id="3142662">r</span><span class="op" id="3142663">.</span><span class="ident" id="3142664">Peek</span><span class="op" id="3142668">(</span><span class="num" id="3142669">2</span><span class="op" id="3142670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142673">if</span>&nbsp;<span class="ident" id="3142676">bytes</span><span class="op" id="3142681">.</span><span class="ident" id="3142682">Equal</span><span class="op" id="3142687">(</span><span class="ident" id="3142688">buf</span><span class="op" id="3142691">,</span>&nbsp;<span class="ident" id="3142693">singleCRLF</span><span class="op" id="3142703">)</span>&nbsp;<span class="op" id="3142705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142709">b</span><span class="op" id="3142710">.</span><span class="ident" id="3142711">r</span><span class="op" id="3142712">.</span><span class="ident" id="3142713">ReadByte</span><span class="op" id="3142721">(</span><span class="op" id="3142722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142726">b</span><span class="op" id="3142727">.</span><span class="ident" id="3142728">r</span><span class="op" id="3142729">.</span><span class="ident" id="3142730">ReadByte</span><span class="op" id="3142738">(</span><span class="op" id="3142739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142743">return</span>&nbsp;<span class="ident" id="3142750">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142758">if</span>&nbsp;<span class="builtinfunc" id="3142761">len</span><span class="op" id="3142764">(</span><span class="ident" id="3142765">buf</span><span class="op" id="3142768">)</span>&nbsp;<span class="op" id="3142770">&lt;</span>&nbsp;<span class="num" id="3142772">2</span>&nbsp;<span class="op" id="3142774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142778">return</span>&nbsp;<span class="ident" id="3142785">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142803">if</span>&nbsp;<span class="ident" id="3142806">err</span>&nbsp;<span class="op" id="3142810">!=</span>&nbsp;<span class="ident" id="3142813">nil</span>&nbsp;<span class="op" id="3142817">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142821">return</span>&nbsp;<span class="ident" id="3142828">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142837">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142901">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142961">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3143025">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3143087">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3143151">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3143215">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3143278">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143352">if</span>&nbsp;<span class="op" id="3143355">!</span><span class="ident" id="3143356">seeUpcomingDoubleCRLF</span><span class="op" id="3143377">(</span><span class="ident" id="3143378">b</span><span class="op" id="3143379">.</span><span class="ident" id="3143380">r</span><span class="op" id="3143381">)</span>&nbsp;<span class="op" id="3143383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143387">return</span>&nbsp;<span class="ident" id="3143394">errors</span><span class="op" id="3143400">.</span><span class="ident" id="3143401">New</span><span class="op" id="3143404">(</span><span class="string" id="3143405">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="3143457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143464">hdr</span><span class="op" id="3143467">,</span>&nbsp;<span class="ident" id="3143469">err</span>&nbsp;<span class="op" id="3143473">:=</span>&nbsp;<span class="ident" id="3143476">textproto</span><span class="op" id="3143485">.</span><span class="ident" id="3143486">NewReader</span><span class="op" id="3143495">(</span><span class="ident" id="3143496">b</span><span class="op" id="3143497">.</span><span class="ident" id="3143498">r</span><span class="op" id="3143499">)</span><span class="op" id="3143500">.</span><span class="ident" id="3143501">ReadMIMEHeader</span><span class="op" id="3143515">(</span><span class="op" id="3143516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143519">if</span>&nbsp;<span class="ident" id="3143522">err</span>&nbsp;<span class="op" id="3143526">!=</span>&nbsp;<span class="ident" id="3143529">nil</span>&nbsp;<span class="op" id="3143533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143537">if</span>&nbsp;<span class="ident" id="3143540">err</span>&nbsp;<span class="op" id="3143544">==</span>&nbsp;<span class="ident" id="3143547">io</span><span class="op" id="3143549">.</span><span class="ident" id="3143550">EOF</span>&nbsp;<span class="op" id="3143554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143559">return</span>&nbsp;<span class="ident" id="3143566">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143582">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143586">return</span>&nbsp;<span class="ident" id="3143593">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143601">switch</span>&nbsp;<span class="ident" id="3143608">rr</span>&nbsp;<span class="op" id="3143611">:=</span>&nbsp;<span class="ident" id="3143614">b</span><span class="op" id="3143615">.</span><span class="ident" id="3143616">hdr</span><span class="op" id="3143619">.</span><span class="op" id="3143620">(</span><span class="keyword" id="3143621">type</span><span class="op" id="3143625">)</span>&nbsp;<span class="op" id="3143627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143630">case</span>&nbsp;<span class="op" id="3143635">*</span><span class="ident" id="3143636">Request</span><span class="op" id="3143643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143647">mergeSetHeader</span><span class="op" id="3143661">(</span><span class="op" id="3143662">&amp;</span><span class="ident" id="3143663">rr</span><span class="op" id="3143665">.</span><span class="ident" id="3143666">Trailer</span><span class="op" id="3143673">,</span>&nbsp;<span class="ident" id="3143675">Header</span><span class="op" id="3143681">(</span><span class="ident" id="3143682">hdr</span><span class="op" id="3143685">)</span><span class="op" id="3143686">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143689">case</span>&nbsp;<span class="op" id="3143694">*</span><span class="ident" id="3143695">Response</span><span class="op" id="3143703">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143707">mergeSetHeader</span><span class="op" id="3143721">(</span><span class="op" id="3143722">&amp;</span><span class="ident" id="3143723">rr</span><span class="op" id="3143725">.</span><span class="ident" id="3143726">Trailer</span><span class="op" id="3143733">,</span>&nbsp;<span class="ident" id="3143735">Header</span><span class="op" id="3143741">(</span><span class="ident" id="3143742">hdr</span><span class="op" id="3143745">)</span><span class="op" id="3143746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143752">return</span>&nbsp;<span class="ident" id="3143759">nil</span><br>
<span class="lineno"></span><span class="op" id="3143763">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3143766">func</span>&nbsp;<span class="ident" id="3143771">mergeSetHeader</span><span class="op" id="3143785">(</span><span class="ident" id="3143786">dst</span>&nbsp;<span class="op" id="3143790">*</span><span class="ident" id="3143791">Header</span><span class="op" id="3143797">,</span>&nbsp;<span class="ident" id="3143799">src</span>&nbsp;<span class="ident" id="3143803">Header</span><span class="op" id="3143809">)</span>&nbsp;<span class="op" id="3143811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143814">if</span>&nbsp;<span class="op" id="3143817">*</span><span class="ident" id="3143818">dst</span>&nbsp;<span class="op" id="3143822">==</span>&nbsp;<span class="ident" id="3143825">nil</span>&nbsp;<span class="op" id="3143829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143833">*</span><span class="ident" id="3143834">dst</span>&nbsp;<span class="op" id="3143838">=</span>&nbsp;<span class="ident" id="3143840">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143846">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143857">for</span>&nbsp;<span class="ident" id="3143861">k</span><span class="op" id="3143862">,</span>&nbsp;<span class="ident" id="3143864">vv</span>&nbsp;<span class="op" id="3143867">:=</span>&nbsp;<span class="keyword" id="3143870">range</span>&nbsp;<span class="ident" id="3143876">src</span>&nbsp;<span class="op" id="3143880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143884">(</span><span class="op" id="3143885">*</span><span class="ident" id="3143886">dst</span><span class="op" id="3143889">)</span><span class="op" id="3143890">[</span><span class="ident" id="3143891">k</span><span class="op" id="3143892">]</span>&nbsp;<span class="op" id="3143894">=</span>&nbsp;<span class="ident" id="3143896">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143900">}</span><br>
<span class="lineno"></span><span class="op" id="3143902">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="3143905">func</span>&nbsp;<span class="op" id="3143910">(</span><span class="ident" id="3143911">b</span>&nbsp;<span class="op" id="3143913">*</span><span class="ident" id="3143914">body</span><span class="op" id="3143918">)</span>&nbsp;<span class="ident" id="3143920">Close</span><span class="op" id="3143925">(</span><span class="op" id="3143926">)</span>&nbsp;<span class="builtintype" id="3143928">error</span>&nbsp;<span class="op" id="3143934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143937">b</span><span class="op" id="3143938">.</span><span class="ident" id="3143939">mu</span><span class="op" id="3143941">.</span><span class="ident" id="3143942">Lock</span><span class="op" id="3143946">(</span><span class="op" id="3143947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143950">defer</span>&nbsp;<span class="ident" id="3143956">b</span><span class="op" id="3143957">.</span><span class="ident" id="3143958">mu</span><span class="op" id="3143960">.</span><span class="ident" id="3143961">Unlock</span><span class="op" id="3143967">(</span><span class="op" id="3143968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143971">if</span>&nbsp;<span class="ident" id="3143974">b</span><span class="op" id="3143975">.</span><span class="ident" id="3143976">closed</span>&nbsp;<span class="op" id="3143983">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143987">return</span>&nbsp;<span class="ident" id="3143994">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144002">var</span>&nbsp;<span class="ident" id="3144006">err</span>&nbsp;<span class="builtintype" id="3144010">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144017">switch</span>&nbsp;<span class="op" id="3144024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144027">case</span>&nbsp;<span class="ident" id="3144032">b</span><span class="op" id="3144033">.</span><span class="ident" id="3144034">hdr</span>&nbsp;<span class="op" id="3144038">==</span>&nbsp;<span class="ident" id="3144041">nil</span>&nbsp;<span class="op" id="3144045">&amp;&amp;</span>&nbsp;<span class="ident" id="3144048">b</span><span class="op" id="3144049">.</span><span class="ident" id="3144050">closing</span><span class="op" id="3144057">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3144061">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3144110">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144142">default</span><span class="op" id="3144149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3144153">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3144217">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144270">_</span><span class="op" id="3144271">,</span>&nbsp;<span class="ident" id="3144273">err</span>&nbsp;<span class="op" id="3144277">=</span>&nbsp;<span class="ident" id="3144279">io</span><span class="op" id="3144281">.</span><span class="ident" id="3144282">Copy</span><span class="op" id="3144286">(</span><span class="ident" id="3144287">ioutil</span><span class="op" id="3144293">.</span><span class="ident" id="3144294">Discard</span><span class="op" id="3144301">,</span>&nbsp;<span class="ident" id="3144303">bodyLocked</span><span class="op" id="3144313">{</span><span class="ident" id="3144314">b</span><span class="op" id="3144315">}</span><span class="op" id="3144316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144322">b</span><span class="op" id="3144323">.</span><span class="ident" id="3144324">closed</span>&nbsp;<span class="op" id="3144331">=</span>&nbsp;<span class="builtintype" id="3144333">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144339">return</span>&nbsp;<span class="ident" id="3144346">err</span><br>
<span class="lineno"></span><span class="op" id="3144350">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="3144353">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3144421">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3144438">type</span>&nbsp;<span class="ident" id="3144443">bodyLocked</span>&nbsp;<span class="keyword" id="3144454">struct</span>&nbsp;<span class="op" id="3144461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144464">b</span>&nbsp;<span class="op" id="3144466">*</span><span class="ident" id="3144467">body</span><br>
<span class="lineno">715</span><span class="op" id="3144472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3144475">func</span>&nbsp;<span class="op" id="3144480">(</span><span class="ident" id="3144481">bl</span>&nbsp;<span class="ident" id="3144484">bodyLocked</span><span class="op" id="3144494">)</span>&nbsp;<span class="ident" id="3144496">Read</span><span class="op" id="3144500">(</span><span class="ident" id="3144501">p</span>&nbsp;<span class="op" id="3144503">[</span><span class="op" id="3144504">]</span><span class="builtintype" id="3144505">byte</span><span class="op" id="3144509">)</span>&nbsp;<span class="op" id="3144511">(</span><span class="ident" id="3144512">n</span>&nbsp;<span class="builtintype" id="3144514">int</span><span class="op" id="3144517">,</span>&nbsp;<span class="ident" id="3144519">err</span>&nbsp;<span class="builtintype" id="3144523">error</span><span class="op" id="3144528">)</span>&nbsp;<span class="op" id="3144530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144533">if</span>&nbsp;<span class="ident" id="3144536">bl</span><span class="op" id="3144538">.</span><span class="ident" id="3144539">b</span><span class="op" id="3144540">.</span><span class="ident" id="3144541">closed</span>&nbsp;<span class="op" id="3144548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144552">return</span>&nbsp;<span class="num" id="3144559">0</span><span class="op" id="3144560">,</span>&nbsp;<span class="ident" id="3144562">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144588">return</span>&nbsp;<span class="ident" id="3144595">bl</span><span class="op" id="3144597">.</span><span class="ident" id="3144598">b</span><span class="op" id="3144599">.</span><span class="ident" id="3144600">readLocked</span><span class="op" id="3144610">(</span><span class="ident" id="3144611">p</span><span class="op" id="3144612">)</span><br>
<span class="lineno"></span><span class="op" id="3144614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3144617">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="3144690">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3144728">func</span>&nbsp;<span class="ident" id="3144733">parseContentLength</span><span class="op" id="3144751">(</span><span class="ident" id="3144752">cl</span>&nbsp;<span class="builtintype" id="3144755">string</span><span class="op" id="3144761">)</span>&nbsp;<span class="op" id="3144763">(</span><span class="ident" id="3144764">int64</span><span class="op" id="3144769">,</span>&nbsp;<span class="builtintype" id="3144771">error</span><span class="op" id="3144776">)</span>&nbsp;<span class="op" id="3144778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144781">cl</span>&nbsp;<span class="op" id="3144784">=</span>&nbsp;<span class="ident" id="3144786">strings</span><span class="op" id="3144793">.</span><span class="ident" id="3144794">TrimSpace</span><span class="op" id="3144803">(</span><span class="ident" id="3144804">cl</span><span class="op" id="3144806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144809">if</span>&nbsp;<span class="ident" id="3144812">cl</span>&nbsp;<span class="op" id="3144815">==</span>&nbsp;<span class="string" id="3144818">&#34;&#34;</span>&nbsp;<span class="op" id="3144821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144825">return</span>&nbsp;<span class="op" id="3144832">-</span><span class="num" id="3144833">1</span><span class="op" id="3144834">,</span>&nbsp;<span class="ident" id="3144836">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144844">n</span><span class="op" id="3144845">,</span>&nbsp;<span class="ident" id="3144847">err</span>&nbsp;<span class="op" id="3144851">:=</span>&nbsp;<span class="ident" id="3144854">strconv</span><span class="op" id="3144861">.</span><span class="ident" id="3144862">ParseInt</span><span class="op" id="3144870">(</span><span class="ident" id="3144871">cl</span><span class="op" id="3144873">,</span>&nbsp;<span class="num" id="3144875">10</span><span class="op" id="3144877">,</span>&nbsp;<span class="num" id="3144879">64</span><span class="op" id="3144881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144884">if</span>&nbsp;<span class="ident" id="3144887">err</span>&nbsp;<span class="op" id="3144891">!=</span>&nbsp;<span class="ident" id="3144894">nil</span>&nbsp;<span class="op" id="3144898">||</span>&nbsp;<span class="ident" id="3144901">n</span>&nbsp;<span class="op" id="3144903">&lt;</span>&nbsp;<span class="num" id="3144905">0</span>&nbsp;<span class="op" id="3144907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144911">return</span>&nbsp;<span class="num" id="3144918">0</span><span class="op" id="3144919">,</span>&nbsp;<span class="op" id="3144921">&amp;</span><span class="ident" id="3144922">badStringError</span><span class="op" id="3144936">{</span><span class="string" id="3144937">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="3144957">,</span>&nbsp;<span class="ident" id="3144959">cl</span><span class="op" id="3144961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144964">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144967">return</span>&nbsp;<span class="ident" id="3144974">n</span><span class="op" id="3144975">,</span>&nbsp;<span class="ident" id="3144977">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3144982">}</span>
</div>
</body>
</html>
