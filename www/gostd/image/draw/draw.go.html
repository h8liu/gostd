<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6045293">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6045349">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6045403">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6045454">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="6045508">//</span><br>
<span class="lineno"></span><span class="comment" id="6045511">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="6045583">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="6045633">package</span>&nbsp;<span class="ident" id="6045641">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="6045647">import</span>&nbsp;<span class="op" id="6045654">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6045657">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6045666">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="6045680">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6045683">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="6045745">const</span>&nbsp;<span class="ident" id="6045751">m</span>&nbsp;<span class="op" id="6045753">=</span>&nbsp;<span class="num" id="6045755">1</span><span class="op" id="6045756">&lt;&lt;</span><span class="num" id="6045758">16</span>&nbsp;<span class="op" id="6045761">-</span>&nbsp;<span class="num" id="6045763">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6045766">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="6045837">type</span>&nbsp;<span class="ident" id="6045842">Image</span>&nbsp;<span class="keyword" id="6045848">interface</span>&nbsp;<span class="op" id="6045858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045861">image</span><span class="op" id="6045866">.</span><span class="ident" id="6045867">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045874">Set</span><span class="op" id="6045877">(</span><span class="ident" id="6045878">x</span><span class="op" id="6045879">,</span>&nbsp;<span class="ident" id="6045881">y</span>&nbsp;<span class="builtintype" id="6045883">int</span><span class="op" id="6045886">,</span>&nbsp;<span class="ident" id="6045888">c</span>&nbsp;<span class="ident" id="6045890">color</span><span class="op" id="6045895">.</span><span class="ident" id="6045896">Color</span><span class="op" id="6045901">)</span><br>
<span class="lineno"></span><span class="op" id="6045903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="6045906">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6045952">type</span>&nbsp;<span class="ident" id="6045957">Quantizer</span>&nbsp;<span class="keyword" id="6045967">interface</span>&nbsp;<span class="op" id="6045977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6045980">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6046051">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046118">Quantize</span><span class="op" id="6046126">(</span><span class="ident" id="6046127">p</span>&nbsp;<span class="ident" id="6046129">color</span><span class="op" id="6046134">.</span><span class="ident" id="6046135">Palette</span><span class="op" id="6046142">,</span>&nbsp;<span class="ident" id="6046144">m</span>&nbsp;<span class="ident" id="6046146">image</span><span class="op" id="6046151">.</span><span class="ident" id="6046152">Image</span><span class="op" id="6046157">)</span>&nbsp;<span class="ident" id="6046159">color</span><span class="op" id="6046164">.</span><span class="ident" id="6046165">Palette</span><br>
<span class="lineno">30</span><span class="op" id="6046173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6046176">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="6046221">type</span>&nbsp;<span class="ident" id="6046226">Op</span>&nbsp;<span class="builtintype" id="6046229">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="6046234">const</span>&nbsp;<span class="op" id="6046240">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6046243">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046290">Over</span>&nbsp;<span class="ident" id="6046295">Op</span>&nbsp;<span class="op" id="6046298">=</span>&nbsp;<span class="ident" id="6046300">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6046306">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046341">Src</span><br>
<span class="lineno">40</span><span class="op" id="6046345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6046348">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="6046427">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="6046434">func</span>&nbsp;<span class="op" id="6046439">(</span><span class="ident" id="6046440">op</span>&nbsp;<span class="ident" id="6046443">Op</span><span class="op" id="6046445">)</span>&nbsp;<span class="ident" id="6046447">Draw</span><span class="op" id="6046451">(</span><span class="ident" id="6046452">dst</span>&nbsp;<span class="ident" id="6046456">Image</span><span class="op" id="6046461">,</span>&nbsp;<span class="ident" id="6046463">r</span>&nbsp;<span class="ident" id="6046465">image</span><span class="op" id="6046470">.</span><span class="ident" id="6046471">Rectangle</span><span class="op" id="6046480">,</span>&nbsp;<span class="ident" id="6046482">src</span>&nbsp;<span class="ident" id="6046486">image</span><span class="op" id="6046491">.</span><span class="ident" id="6046492">Image</span><span class="op" id="6046497">,</span>&nbsp;<span class="ident" id="6046499">sp</span>&nbsp;<span class="ident" id="6046502">image</span><span class="op" id="6046507">.</span><span class="ident" id="6046508">Point</span><span class="op" id="6046513">)</span>&nbsp;<span class="op" id="6046515">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046518">DrawMask</span><span class="op" id="6046526">(</span><span class="ident" id="6046527">dst</span><span class="op" id="6046530">,</span>&nbsp;<span class="ident" id="6046532">r</span><span class="op" id="6046533">,</span>&nbsp;<span class="ident" id="6046535">src</span><span class="op" id="6046538">,</span>&nbsp;<span class="ident" id="6046540">sp</span><span class="op" id="6046542">,</span>&nbsp;<span class="ident" id="6046544">nil</span><span class="op" id="6046547">,</span>&nbsp;<span class="ident" id="6046549">image</span><span class="op" id="6046554">.</span><span class="ident" id="6046555">Point</span><span class="op" id="6046560">{</span><span class="op" id="6046561">}</span><span class="op" id="6046562">,</span>&nbsp;<span class="ident" id="6046564">op</span><span class="op" id="6046566">)</span><br>
<span class="lineno"></span><span class="op" id="6046568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6046571">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="6046607">type</span>&nbsp;<span class="ident" id="6046612">Drawer</span>&nbsp;<span class="keyword" id="6046619">interface</span>&nbsp;<span class="op" id="6046629">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6046632">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6046698">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046760">Draw</span><span class="op" id="6046764">(</span><span class="ident" id="6046765">dst</span>&nbsp;<span class="ident" id="6046769">Image</span><span class="op" id="6046774">,</span>&nbsp;<span class="ident" id="6046776">r</span>&nbsp;<span class="ident" id="6046778">image</span><span class="op" id="6046783">.</span><span class="ident" id="6046784">Rectangle</span><span class="op" id="6046793">,</span>&nbsp;<span class="ident" id="6046795">src</span>&nbsp;<span class="ident" id="6046799">image</span><span class="op" id="6046804">.</span><span class="ident" id="6046805">Image</span><span class="op" id="6046810">,</span>&nbsp;<span class="ident" id="6046812">sp</span>&nbsp;<span class="ident" id="6046815">image</span><span class="op" id="6046820">.</span><span class="ident" id="6046821">Point</span><span class="op" id="6046826">)</span><br>
<span class="lineno"></span><span class="op" id="6046828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="6046831">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="6046907">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="6046921">var</span>&nbsp;<span class="ident" id="6046925">FloydSteinberg</span>&nbsp;<span class="ident" id="6046940">Drawer</span>&nbsp;<span class="op" id="6046947">=</span>&nbsp;<span class="ident" id="6046949">floydSteinberg</span><span class="op" id="6046963">{</span><span class="op" id="6046964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6046967">type</span>&nbsp;<span class="ident" id="6046972">floydSteinberg</span>&nbsp;<span class="keyword" id="6046987">struct</span><span class="op" id="6046993">{</span><span class="op" id="6046994">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6046997">func</span>&nbsp;<span class="op" id="6047002">(</span><span class="ident" id="6047003">floydSteinberg</span><span class="op" id="6047017">)</span>&nbsp;<span class="ident" id="6047019">Draw</span><span class="op" id="6047023">(</span><span class="ident" id="6047024">dst</span>&nbsp;<span class="ident" id="6047028">Image</span><span class="op" id="6047033">,</span>&nbsp;<span class="ident" id="6047035">r</span>&nbsp;<span class="ident" id="6047037">image</span><span class="op" id="6047042">.</span><span class="ident" id="6047043">Rectangle</span><span class="op" id="6047052">,</span>&nbsp;<span class="ident" id="6047054">src</span>&nbsp;<span class="ident" id="6047058">image</span><span class="op" id="6047063">.</span><span class="ident" id="6047064">Image</span><span class="op" id="6047069">,</span>&nbsp;<span class="ident" id="6047071">sp</span>&nbsp;<span class="ident" id="6047074">image</span><span class="op" id="6047079">.</span><span class="ident" id="6047080">Point</span><span class="op" id="6047085">)</span>&nbsp;<span class="op" id="6047087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047090">clip</span><span class="op" id="6047094">(</span><span class="ident" id="6047095">dst</span><span class="op" id="6047098">,</span>&nbsp;<span class="op" id="6047100">&amp;</span><span class="ident" id="6047101">r</span><span class="op" id="6047102">,</span>&nbsp;<span class="ident" id="6047104">src</span><span class="op" id="6047107">,</span>&nbsp;<span class="op" id="6047109">&amp;</span><span class="ident" id="6047110">sp</span><span class="op" id="6047112">,</span>&nbsp;<span class="ident" id="6047114">nil</span><span class="op" id="6047117">,</span>&nbsp;<span class="ident" id="6047119">nil</span><span class="op" id="6047122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047125">if</span>&nbsp;<span class="ident" id="6047128">r</span><span class="op" id="6047129">.</span><span class="ident" id="6047130">Empty</span><span class="op" id="6047135">(</span><span class="op" id="6047136">)</span>&nbsp;<span class="op" id="6047138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047142">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047153">drawPaletted</span><span class="op" id="6047165">(</span><span class="ident" id="6047166">dst</span><span class="op" id="6047169">,</span>&nbsp;<span class="ident" id="6047171">r</span><span class="op" id="6047172">,</span>&nbsp;<span class="ident" id="6047174">src</span><span class="op" id="6047177">,</span>&nbsp;<span class="ident" id="6047179">sp</span><span class="op" id="6047181">,</span>&nbsp;<span class="builtintype" id="6047183">true</span><span class="op" id="6047187">)</span><br>
<span class="lineno"></span><span class="op" id="6047189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6047192">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="6047264">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6047341">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="6047384">func</span>&nbsp;<span class="ident" id="6047389">clip</span><span class="op" id="6047393">(</span><span class="ident" id="6047394">dst</span>&nbsp;<span class="ident" id="6047398">Image</span><span class="op" id="6047403">,</span>&nbsp;<span class="ident" id="6047405">r</span>&nbsp;<span class="op" id="6047407">*</span><span class="ident" id="6047408">image</span><span class="op" id="6047413">.</span><span class="ident" id="6047414">Rectangle</span><span class="op" id="6047423">,</span>&nbsp;<span class="ident" id="6047425">src</span>&nbsp;<span class="ident" id="6047429">image</span><span class="op" id="6047434">.</span><span class="ident" id="6047435">Image</span><span class="op" id="6047440">,</span>&nbsp;<span class="ident" id="6047442">sp</span>&nbsp;<span class="op" id="6047445">*</span><span class="ident" id="6047446">image</span><span class="op" id="6047451">.</span><span class="ident" id="6047452">Point</span><span class="op" id="6047457">,</span>&nbsp;<span class="ident" id="6047459">mask</span>&nbsp;<span class="ident" id="6047464">image</span><span class="op" id="6047469">.</span><span class="ident" id="6047470">Image</span><span class="op" id="6047475">,</span>&nbsp;<span class="ident" id="6047477">mp</span>&nbsp;<span class="op" id="6047480">*</span><span class="ident" id="6047481">image</span><span class="op" id="6047486">.</span><span class="ident" id="6047487">Point</span><span class="op" id="6047492">)</span>&nbsp;<span class="op" id="6047494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047497">orig</span>&nbsp;<span class="op" id="6047502">:=</span>&nbsp;<span class="ident" id="6047505">r</span><span class="op" id="6047506">.</span><span class="ident" id="6047507">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047512">*</span><span class="ident" id="6047513">r</span>&nbsp;<span class="op" id="6047515">=</span>&nbsp;<span class="ident" id="6047517">r</span><span class="op" id="6047518">.</span><span class="ident" id="6047519">Intersect</span><span class="op" id="6047528">(</span><span class="ident" id="6047529">dst</span><span class="op" id="6047532">.</span><span class="ident" id="6047533">Bounds</span><span class="op" id="6047539">(</span><span class="op" id="6047540">)</span><span class="op" id="6047541">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047544">*</span><span class="ident" id="6047545">r</span>&nbsp;<span class="op" id="6047547">=</span>&nbsp;<span class="ident" id="6047549">r</span><span class="op" id="6047550">.</span><span class="ident" id="6047551">Intersect</span><span class="op" id="6047560">(</span><span class="ident" id="6047561">src</span><span class="op" id="6047564">.</span><span class="ident" id="6047565">Bounds</span><span class="op" id="6047571">(</span><span class="op" id="6047572">)</span><span class="op" id="6047573">.</span><span class="ident" id="6047574">Add</span><span class="op" id="6047577">(</span><span class="ident" id="6047578">orig</span><span class="op" id="6047582">.</span><span class="ident" id="6047583">Sub</span><span class="op" id="6047586">(</span><span class="op" id="6047587">*</span><span class="ident" id="6047588">sp</span><span class="op" id="6047590">)</span><span class="op" id="6047591">)</span><span class="op" id="6047592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047595">if</span>&nbsp;<span class="ident" id="6047598">mask</span>&nbsp;<span class="op" id="6047603">!=</span>&nbsp;<span class="ident" id="6047606">nil</span>&nbsp;<span class="op" id="6047610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047614">*</span><span class="ident" id="6047615">r</span>&nbsp;<span class="op" id="6047617">=</span>&nbsp;<span class="ident" id="6047619">r</span><span class="op" id="6047620">.</span><span class="ident" id="6047621">Intersect</span><span class="op" id="6047630">(</span><span class="ident" id="6047631">mask</span><span class="op" id="6047635">.</span><span class="ident" id="6047636">Bounds</span><span class="op" id="6047642">(</span><span class="op" id="6047643">)</span><span class="op" id="6047644">.</span><span class="ident" id="6047645">Add</span><span class="op" id="6047648">(</span><span class="ident" id="6047649">orig</span><span class="op" id="6047653">.</span><span class="ident" id="6047654">Sub</span><span class="op" id="6047657">(</span><span class="op" id="6047658">*</span><span class="ident" id="6047659">mp</span><span class="op" id="6047661">)</span><span class="op" id="6047662">)</span><span class="op" id="6047663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047669">dx</span>&nbsp;<span class="op" id="6047672">:=</span>&nbsp;<span class="ident" id="6047675">r</span><span class="op" id="6047676">.</span><span class="ident" id="6047677">Min</span><span class="op" id="6047680">.</span><span class="ident" id="6047681">X</span>&nbsp;<span class="op" id="6047683">-</span>&nbsp;<span class="ident" id="6047685">orig</span><span class="op" id="6047689">.</span><span class="ident" id="6047690">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047693">dy</span>&nbsp;<span class="op" id="6047696">:=</span>&nbsp;<span class="ident" id="6047699">r</span><span class="op" id="6047700">.</span><span class="ident" id="6047701">Min</span><span class="op" id="6047704">.</span><span class="ident" id="6047705">Y</span>&nbsp;<span class="op" id="6047707">-</span>&nbsp;<span class="ident" id="6047709">orig</span><span class="op" id="6047713">.</span><span class="ident" id="6047714">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047717">if</span>&nbsp;<span class="ident" id="6047720">dx</span>&nbsp;<span class="op" id="6047723">==</span>&nbsp;<span class="num" id="6047726">0</span>&nbsp;<span class="op" id="6047728">&amp;&amp;</span>&nbsp;<span class="ident" id="6047731">dy</span>&nbsp;<span class="op" id="6047734">==</span>&nbsp;<span class="num" id="6047737">0</span>&nbsp;<span class="op" id="6047739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047743">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047754">(</span><span class="op" id="6047755">*</span><span class="ident" id="6047756">sp</span><span class="op" id="6047758">)</span><span class="op" id="6047759">.</span><span class="ident" id="6047760">X</span>&nbsp;<span class="op" id="6047762">+=</span>&nbsp;<span class="ident" id="6047765">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047769">(</span><span class="op" id="6047770">*</span><span class="ident" id="6047771">sp</span><span class="op" id="6047773">)</span><span class="op" id="6047774">.</span><span class="ident" id="6047775">Y</span>&nbsp;<span class="op" id="6047777">+=</span>&nbsp;<span class="ident" id="6047780">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047784">(</span><span class="op" id="6047785">*</span><span class="ident" id="6047786">mp</span><span class="op" id="6047788">)</span><span class="op" id="6047789">.</span><span class="ident" id="6047790">X</span>&nbsp;<span class="op" id="6047792">+=</span>&nbsp;<span class="ident" id="6047795">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047799">(</span><span class="op" id="6047800">*</span><span class="ident" id="6047801">mp</span><span class="op" id="6047803">)</span><span class="op" id="6047804">.</span><span class="ident" id="6047805">Y</span>&nbsp;<span class="op" id="6047807">+=</span>&nbsp;<span class="ident" id="6047810">dy</span><br>
<span class="lineno"></span><span class="op" id="6047813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="6047816">func</span>&nbsp;<span class="ident" id="6047821">processBackward</span><span class="op" id="6047836">(</span><span class="ident" id="6047837">dst</span>&nbsp;<span class="ident" id="6047841">Image</span><span class="op" id="6047846">,</span>&nbsp;<span class="ident" id="6047848">r</span>&nbsp;<span class="ident" id="6047850">image</span><span class="op" id="6047855">.</span><span class="ident" id="6047856">Rectangle</span><span class="op" id="6047865">,</span>&nbsp;<span class="ident" id="6047867">src</span>&nbsp;<span class="ident" id="6047871">image</span><span class="op" id="6047876">.</span><span class="ident" id="6047877">Image</span><span class="op" id="6047882">,</span>&nbsp;<span class="ident" id="6047884">sp</span>&nbsp;<span class="ident" id="6047887">image</span><span class="op" id="6047892">.</span><span class="ident" id="6047893">Point</span><span class="op" id="6047898">)</span>&nbsp;<span class="builtintype" id="6047900">bool</span>&nbsp;<span class="op" id="6047905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047908">return</span>&nbsp;<span class="ident" id="6047915">image</span><span class="op" id="6047920">.</span><span class="ident" id="6047921">Image</span><span class="op" id="6047926">(</span><span class="ident" id="6047927">dst</span><span class="op" id="6047930">)</span>&nbsp;<span class="op" id="6047932">==</span>&nbsp;<span class="ident" id="6047935">src</span>&nbsp;<span class="op" id="6047939">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047944">r</span><span class="op" id="6047945">.</span><span class="ident" id="6047946">Overlaps</span><span class="op" id="6047954">(</span><span class="ident" id="6047955">r</span><span class="op" id="6047956">.</span><span class="ident" id="6047957">Add</span><span class="op" id="6047960">(</span><span class="ident" id="6047961">sp</span><span class="op" id="6047963">.</span><span class="ident" id="6047964">Sub</span><span class="op" id="6047967">(</span><span class="ident" id="6047968">r</span><span class="op" id="6047969">.</span><span class="ident" id="6047970">Min</span><span class="op" id="6047973">)</span><span class="op" id="6047974">)</span><span class="op" id="6047975">)</span>&nbsp;<span class="op" id="6047977">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047982">(</span><span class="ident" id="6047983">sp</span><span class="op" id="6047985">.</span><span class="ident" id="6047986">Y</span>&nbsp;<span class="op" id="6047988">&lt;</span>&nbsp;<span class="ident" id="6047990">r</span><span class="op" id="6047991">.</span><span class="ident" id="6047992">Min</span><span class="op" id="6047995">.</span><span class="ident" id="6047996">Y</span>&nbsp;<span class="op" id="6047998">||</span>&nbsp;<span class="op" id="6048001">(</span><span class="ident" id="6048002">sp</span><span class="op" id="6048004">.</span><span class="ident" id="6048005">Y</span>&nbsp;<span class="op" id="6048007">==</span>&nbsp;<span class="ident" id="6048010">r</span><span class="op" id="6048011">.</span><span class="ident" id="6048012">Min</span><span class="op" id="6048015">.</span><span class="ident" id="6048016">Y</span>&nbsp;<span class="op" id="6048018">&amp;&amp;</span>&nbsp;<span class="ident" id="6048021">sp</span><span class="op" id="6048023">.</span><span class="ident" id="6048024">X</span>&nbsp;<span class="op" id="6048026">&lt;</span>&nbsp;<span class="ident" id="6048028">r</span><span class="op" id="6048029">.</span><span class="ident" id="6048030">Min</span><span class="op" id="6048033">.</span><span class="ident" id="6048034">X</span><span class="op" id="6048035">)</span><span class="op" id="6048036">)</span><br>
<span class="lineno"></span><span class="op" id="6048038">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="6048041">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="6048081">func</span>&nbsp;<span class="ident" id="6048086">Draw</span><span class="op" id="6048090">(</span><span class="ident" id="6048091">dst</span>&nbsp;<span class="ident" id="6048095">Image</span><span class="op" id="6048100">,</span>&nbsp;<span class="ident" id="6048102">r</span>&nbsp;<span class="ident" id="6048104">image</span><span class="op" id="6048109">.</span><span class="ident" id="6048110">Rectangle</span><span class="op" id="6048119">,</span>&nbsp;<span class="ident" id="6048121">src</span>&nbsp;<span class="ident" id="6048125">image</span><span class="op" id="6048130">.</span><span class="ident" id="6048131">Image</span><span class="op" id="6048136">,</span>&nbsp;<span class="ident" id="6048138">sp</span>&nbsp;<span class="ident" id="6048141">image</span><span class="op" id="6048146">.</span><span class="ident" id="6048147">Point</span><span class="op" id="6048152">,</span>&nbsp;<span class="ident" id="6048154">op</span>&nbsp;<span class="ident" id="6048157">Op</span><span class="op" id="6048159">)</span>&nbsp;<span class="op" id="6048161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048164">DrawMask</span><span class="op" id="6048172">(</span><span class="ident" id="6048173">dst</span><span class="op" id="6048176">,</span>&nbsp;<span class="ident" id="6048178">r</span><span class="op" id="6048179">,</span>&nbsp;<span class="ident" id="6048181">src</span><span class="op" id="6048184">,</span>&nbsp;<span class="ident" id="6048186">sp</span><span class="op" id="6048188">,</span>&nbsp;<span class="ident" id="6048190">nil</span><span class="op" id="6048193">,</span>&nbsp;<span class="ident" id="6048195">image</span><span class="op" id="6048200">.</span><span class="ident" id="6048201">Point</span><span class="op" id="6048206">{</span><span class="op" id="6048207">}</span><span class="op" id="6048208">,</span>&nbsp;<span class="ident" id="6048210">op</span><span class="op" id="6048212">)</span><br>
<span class="lineno"></span><span class="op" id="6048214">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="6048217">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="6048313">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="6048402">func</span>&nbsp;<span class="ident" id="6048407">DrawMask</span><span class="op" id="6048415">(</span><span class="ident" id="6048416">dst</span>&nbsp;<span class="ident" id="6048420">Image</span><span class="op" id="6048425">,</span>&nbsp;<span class="ident" id="6048427">r</span>&nbsp;<span class="ident" id="6048429">image</span><span class="op" id="6048434">.</span><span class="ident" id="6048435">Rectangle</span><span class="op" id="6048444">,</span>&nbsp;<span class="ident" id="6048446">src</span>&nbsp;<span class="ident" id="6048450">image</span><span class="op" id="6048455">.</span><span class="ident" id="6048456">Image</span><span class="op" id="6048461">,</span>&nbsp;<span class="ident" id="6048463">sp</span>&nbsp;<span class="ident" id="6048466">image</span><span class="op" id="6048471">.</span><span class="ident" id="6048472">Point</span><span class="op" id="6048477">,</span>&nbsp;<span class="ident" id="6048479">mask</span>&nbsp;<span class="ident" id="6048484">image</span><span class="op" id="6048489">.</span><span class="ident" id="6048490">Image</span><span class="op" id="6048495">,</span>&nbsp;<span class="ident" id="6048497">mp</span>&nbsp;<span class="ident" id="6048500">image</span><span class="op" id="6048505">.</span><span class="ident" id="6048506">Point</span><span class="op" id="6048511">,</span>&nbsp;<span class="ident" id="6048513">op</span>&nbsp;<span class="ident" id="6048516">Op</span><span class="op" id="6048518">)</span>&nbsp;<span class="op" id="6048520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048523">clip</span><span class="op" id="6048527">(</span><span class="ident" id="6048528">dst</span><span class="op" id="6048531">,</span>&nbsp;<span class="op" id="6048533">&amp;</span><span class="ident" id="6048534">r</span><span class="op" id="6048535">,</span>&nbsp;<span class="ident" id="6048537">src</span><span class="op" id="6048540">,</span>&nbsp;<span class="op" id="6048542">&amp;</span><span class="ident" id="6048543">sp</span><span class="op" id="6048545">,</span>&nbsp;<span class="ident" id="6048547">mask</span><span class="op" id="6048551">,</span>&nbsp;<span class="op" id="6048553">&amp;</span><span class="ident" id="6048554">mp</span><span class="op" id="6048556">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048559">if</span>&nbsp;<span class="ident" id="6048562">r</span><span class="op" id="6048563">.</span><span class="ident" id="6048564">Empty</span><span class="op" id="6048569">(</span><span class="op" id="6048570">)</span>&nbsp;<span class="op" id="6048572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048576">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048588">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048701">switch</span>&nbsp;<span class="ident" id="6048708">dst0</span>&nbsp;<span class="op" id="6048713">:=</span>&nbsp;<span class="ident" id="6048716">dst</span><span class="op" id="6048719">.</span><span class="op" id="6048720">(</span><span class="keyword" id="6048721">type</span><span class="op" id="6048725">)</span>&nbsp;<span class="op" id="6048727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048730">case</span>&nbsp;<span class="op" id="6048735">*</span><span class="ident" id="6048736">image</span><span class="op" id="6048741">.</span><span class="ident" id="6048742">RGBA</span><span class="op" id="6048746">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048750">if</span>&nbsp;<span class="ident" id="6048753">op</span>&nbsp;<span class="op" id="6048756">==</span>&nbsp;<span class="ident" id="6048759">Over</span>&nbsp;<span class="op" id="6048764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048769">if</span>&nbsp;<span class="ident" id="6048772">mask</span>&nbsp;<span class="op" id="6048777">==</span>&nbsp;<span class="ident" id="6048780">nil</span>&nbsp;<span class="op" id="6048784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048790">switch</span>&nbsp;<span class="ident" id="6048797">src0</span>&nbsp;<span class="op" id="6048802">:=</span>&nbsp;<span class="ident" id="6048805">src</span><span class="op" id="6048808">.</span><span class="op" id="6048809">(</span><span class="keyword" id="6048810">type</span><span class="op" id="6048814">)</span>&nbsp;<span class="op" id="6048816">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048822">case</span>&nbsp;<span class="op" id="6048827">*</span><span class="ident" id="6048828">image</span><span class="op" id="6048833">.</span><span class="ident" id="6048834">Uniform</span><span class="op" id="6048841">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048848">drawFillOver</span><span class="op" id="6048860">(</span><span class="ident" id="6048861">dst0</span><span class="op" id="6048865">,</span>&nbsp;<span class="ident" id="6048867">r</span><span class="op" id="6048868">,</span>&nbsp;<span class="ident" id="6048870">src0</span><span class="op" id="6048874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048881">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048892">case</span>&nbsp;<span class="op" id="6048897">*</span><span class="ident" id="6048898">image</span><span class="op" id="6048903">.</span><span class="ident" id="6048904">RGBA</span><span class="op" id="6048908">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048915">drawCopyOver</span><span class="op" id="6048927">(</span><span class="ident" id="6048928">dst0</span><span class="op" id="6048932">,</span>&nbsp;<span class="ident" id="6048934">r</span><span class="op" id="6048935">,</span>&nbsp;<span class="ident" id="6048937">src0</span><span class="op" id="6048941">,</span>&nbsp;<span class="ident" id="6048943">sp</span><span class="op" id="6048945">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048952">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048963">case</span>&nbsp;<span class="op" id="6048968">*</span><span class="ident" id="6048969">image</span><span class="op" id="6048974">.</span><span class="ident" id="6048975">NRGBA</span><span class="op" id="6048980">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048987">drawNRGBAOver</span><span class="op" id="6049000">(</span><span class="ident" id="6049001">dst0</span><span class="op" id="6049005">,</span>&nbsp;<span class="ident" id="6049007">r</span><span class="op" id="6049008">,</span>&nbsp;<span class="ident" id="6049010">src0</span><span class="op" id="6049014">,</span>&nbsp;<span class="ident" id="6049016">sp</span><span class="op" id="6049018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049025">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049036">case</span>&nbsp;<span class="op" id="6049041">*</span><span class="ident" id="6049042">image</span><span class="op" id="6049047">.</span><span class="ident" id="6049048">YCbCr</span><span class="op" id="6049053">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049060">if</span>&nbsp;<span class="ident" id="6049063">drawYCbCr</span><span class="op" id="6049072">(</span><span class="ident" id="6049073">dst0</span><span class="op" id="6049077">,</span>&nbsp;<span class="ident" id="6049079">r</span><span class="op" id="6049080">,</span>&nbsp;<span class="ident" id="6049082">src0</span><span class="op" id="6049086">,</span>&nbsp;<span class="ident" id="6049088">sp</span><span class="op" id="6049090">)</span>&nbsp;<span class="op" id="6049092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049100">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049123">}</span>&nbsp;<span class="keyword" id="6049125">else</span>&nbsp;<span class="keyword" id="6049130">if</span>&nbsp;<span class="ident" id="6049133">mask0</span><span class="op" id="6049138">,</span>&nbsp;<span class="ident" id="6049140">ok</span>&nbsp;<span class="op" id="6049143">:=</span>&nbsp;<span class="ident" id="6049146">mask</span><span class="op" id="6049150">.</span><span class="op" id="6049151">(</span><span class="op" id="6049152">*</span><span class="ident" id="6049153">image</span><span class="op" id="6049158">.</span><span class="ident" id="6049159">Alpha</span><span class="op" id="6049164">)</span><span class="op" id="6049165">;</span>&nbsp;<span class="ident" id="6049167">ok</span>&nbsp;<span class="op" id="6049170">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049176">switch</span>&nbsp;<span class="ident" id="6049183">src0</span>&nbsp;<span class="op" id="6049188">:=</span>&nbsp;<span class="ident" id="6049191">src</span><span class="op" id="6049194">.</span><span class="op" id="6049195">(</span><span class="keyword" id="6049196">type</span><span class="op" id="6049200">)</span>&nbsp;<span class="op" id="6049202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049208">case</span>&nbsp;<span class="op" id="6049213">*</span><span class="ident" id="6049214">image</span><span class="op" id="6049219">.</span><span class="ident" id="6049220">Uniform</span><span class="op" id="6049227">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049234">drawGlyphOver</span><span class="op" id="6049247">(</span><span class="ident" id="6049248">dst0</span><span class="op" id="6049252">,</span>&nbsp;<span class="ident" id="6049254">r</span><span class="op" id="6049255">,</span>&nbsp;<span class="ident" id="6049257">src0</span><span class="op" id="6049261">,</span>&nbsp;<span class="ident" id="6049263">mask0</span><span class="op" id="6049268">,</span>&nbsp;<span class="ident" id="6049270">mp</span><span class="op" id="6049272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049279">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049290">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049299">}</span>&nbsp;<span class="keyword" id="6049301">else</span>&nbsp;<span class="op" id="6049306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049311">if</span>&nbsp;<span class="ident" id="6049314">mask</span>&nbsp;<span class="op" id="6049319">==</span>&nbsp;<span class="ident" id="6049322">nil</span>&nbsp;<span class="op" id="6049326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049332">switch</span>&nbsp;<span class="ident" id="6049339">src0</span>&nbsp;<span class="op" id="6049344">:=</span>&nbsp;<span class="ident" id="6049347">src</span><span class="op" id="6049350">.</span><span class="op" id="6049351">(</span><span class="keyword" id="6049352">type</span><span class="op" id="6049356">)</span>&nbsp;<span class="op" id="6049358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049364">case</span>&nbsp;<span class="op" id="6049369">*</span><span class="ident" id="6049370">image</span><span class="op" id="6049375">.</span><span class="ident" id="6049376">Uniform</span><span class="op" id="6049383">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049390">drawFillSrc</span><span class="op" id="6049401">(</span><span class="ident" id="6049402">dst0</span><span class="op" id="6049406">,</span>&nbsp;<span class="ident" id="6049408">r</span><span class="op" id="6049409">,</span>&nbsp;<span class="ident" id="6049411">src0</span><span class="op" id="6049415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049422">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049433">case</span>&nbsp;<span class="op" id="6049438">*</span><span class="ident" id="6049439">image</span><span class="op" id="6049444">.</span><span class="ident" id="6049445">RGBA</span><span class="op" id="6049449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049456">drawCopySrc</span><span class="op" id="6049467">(</span><span class="ident" id="6049468">dst0</span><span class="op" id="6049472">,</span>&nbsp;<span class="ident" id="6049474">r</span><span class="op" id="6049475">,</span>&nbsp;<span class="ident" id="6049477">src0</span><span class="op" id="6049481">,</span>&nbsp;<span class="ident" id="6049483">sp</span><span class="op" id="6049485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049492">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049503">case</span>&nbsp;<span class="op" id="6049508">*</span><span class="ident" id="6049509">image</span><span class="op" id="6049514">.</span><span class="ident" id="6049515">NRGBA</span><span class="op" id="6049520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049527">drawNRGBASrc</span><span class="op" id="6049539">(</span><span class="ident" id="6049540">dst0</span><span class="op" id="6049544">,</span>&nbsp;<span class="ident" id="6049546">r</span><span class="op" id="6049547">,</span>&nbsp;<span class="ident" id="6049549">src0</span><span class="op" id="6049553">,</span>&nbsp;<span class="ident" id="6049555">sp</span><span class="op" id="6049557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049564">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049575">case</span>&nbsp;<span class="op" id="6049580">*</span><span class="ident" id="6049581">image</span><span class="op" id="6049586">.</span><span class="ident" id="6049587">YCbCr</span><span class="op" id="6049592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049599">if</span>&nbsp;<span class="ident" id="6049602">drawYCbCr</span><span class="op" id="6049611">(</span><span class="ident" id="6049612">dst0</span><span class="op" id="6049616">,</span>&nbsp;<span class="ident" id="6049618">r</span><span class="op" id="6049619">,</span>&nbsp;<span class="ident" id="6049621">src0</span><span class="op" id="6049625">,</span>&nbsp;<span class="ident" id="6049627">sp</span><span class="op" id="6049629">)</span>&nbsp;<span class="op" id="6049631">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049639">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049666">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049670">drawRGBA</span><span class="op" id="6049678">(</span><span class="ident" id="6049679">dst0</span><span class="op" id="6049683">,</span>&nbsp;<span class="ident" id="6049685">r</span><span class="op" id="6049686">,</span>&nbsp;<span class="ident" id="6049688">src</span><span class="op" id="6049691">,</span>&nbsp;<span class="ident" id="6049693">sp</span><span class="op" id="6049695">,</span>&nbsp;<span class="ident" id="6049697">mask</span><span class="op" id="6049701">,</span>&nbsp;<span class="ident" id="6049703">mp</span><span class="op" id="6049705">,</span>&nbsp;<span class="ident" id="6049707">op</span><span class="op" id="6049709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049713">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049721">case</span>&nbsp;<span class="op" id="6049726">*</span><span class="ident" id="6049727">image</span><span class="op" id="6049732">.</span><span class="ident" id="6049733">Paletted</span><span class="op" id="6049741">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049745">if</span>&nbsp;<span class="ident" id="6049748">op</span>&nbsp;<span class="op" id="6049751">==</span>&nbsp;<span class="ident" id="6049754">Src</span>&nbsp;<span class="op" id="6049758">&amp;&amp;</span>&nbsp;<span class="ident" id="6049761">mask</span>&nbsp;<span class="op" id="6049766">==</span>&nbsp;<span class="ident" id="6049769">nil</span>&nbsp;<span class="op" id="6049773">&amp;&amp;</span>&nbsp;<span class="op" id="6049776">!</span><span class="ident" id="6049777">processBackward</span><span class="op" id="6049792">(</span><span class="ident" id="6049793">dst</span><span class="op" id="6049796">,</span>&nbsp;<span class="ident" id="6049798">r</span><span class="op" id="6049799">,</span>&nbsp;<span class="ident" id="6049801">src</span><span class="op" id="6049804">,</span>&nbsp;<span class="ident" id="6049806">sp</span><span class="op" id="6049808">)</span>&nbsp;<span class="op" id="6049810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049815">drawPaletted</span><span class="op" id="6049827">(</span><span class="ident" id="6049828">dst0</span><span class="op" id="6049832">,</span>&nbsp;<span class="ident" id="6049834">r</span><span class="op" id="6049835">,</span>&nbsp;<span class="ident" id="6049837">src</span><span class="op" id="6049840">,</span>&nbsp;<span class="ident" id="6049842">sp</span><span class="op" id="6049844">,</span>&nbsp;<span class="builtintype" id="6049846">false</span><span class="op" id="6049851">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049862">x0</span><span class="op" id="6049864">,</span>&nbsp;<span class="ident" id="6049866">x1</span><span class="op" id="6049868">,</span>&nbsp;<span class="ident" id="6049870">dx</span>&nbsp;<span class="op" id="6049873">:=</span>&nbsp;<span class="ident" id="6049876">r</span><span class="op" id="6049877">.</span><span class="ident" id="6049878">Min</span><span class="op" id="6049881">.</span><span class="ident" id="6049882">X</span><span class="op" id="6049883">,</span>&nbsp;<span class="ident" id="6049885">r</span><span class="op" id="6049886">.</span><span class="ident" id="6049887">Max</span><span class="op" id="6049890">.</span><span class="ident" id="6049891">X</span><span class="op" id="6049892">,</span>&nbsp;<span class="num" id="6049894">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049897">y0</span><span class="op" id="6049899">,</span>&nbsp;<span class="ident" id="6049901">y1</span><span class="op" id="6049903">,</span>&nbsp;<span class="ident" id="6049905">dy</span>&nbsp;<span class="op" id="6049908">:=</span>&nbsp;<span class="ident" id="6049911">r</span><span class="op" id="6049912">.</span><span class="ident" id="6049913">Min</span><span class="op" id="6049916">.</span><span class="ident" id="6049917">Y</span><span class="op" id="6049918">,</span>&nbsp;<span class="ident" id="6049920">r</span><span class="op" id="6049921">.</span><span class="ident" id="6049922">Max</span><span class="op" id="6049925">.</span><span class="ident" id="6049926">Y</span><span class="op" id="6049927">,</span>&nbsp;<span class="num" id="6049929">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049932">if</span>&nbsp;<span class="ident" id="6049935">processBackward</span><span class="op" id="6049950">(</span><span class="ident" id="6049951">dst</span><span class="op" id="6049954">,</span>&nbsp;<span class="ident" id="6049956">r</span><span class="op" id="6049957">,</span>&nbsp;<span class="ident" id="6049959">src</span><span class="op" id="6049962">,</span>&nbsp;<span class="ident" id="6049964">sp</span><span class="op" id="6049966">)</span>&nbsp;<span class="op" id="6049968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049972">x0</span><span class="op" id="6049974">,</span>&nbsp;<span class="ident" id="6049976">x1</span><span class="op" id="6049978">,</span>&nbsp;<span class="ident" id="6049980">dx</span>&nbsp;<span class="op" id="6049983">=</span>&nbsp;<span class="ident" id="6049985">x1</span><span class="op" id="6049987">-</span><span class="num" id="6049988">1</span><span class="op" id="6049989">,</span>&nbsp;<span class="ident" id="6049991">x0</span><span class="op" id="6049993">-</span><span class="num" id="6049994">1</span><span class="op" id="6049995">,</span>&nbsp;<span class="op" id="6049997">-</span><span class="num" id="6049998">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050002">y0</span><span class="op" id="6050004">,</span>&nbsp;<span class="ident" id="6050006">y1</span><span class="op" id="6050008">,</span>&nbsp;<span class="ident" id="6050010">dy</span>&nbsp;<span class="op" id="6050013">=</span>&nbsp;<span class="ident" id="6050015">y1</span><span class="op" id="6050017">-</span><span class="num" id="6050018">1</span><span class="op" id="6050019">,</span>&nbsp;<span class="ident" id="6050021">y0</span><span class="op" id="6050023">-</span><span class="num" id="6050024">1</span><span class="op" id="6050025">,</span>&nbsp;<span class="op" id="6050027">-</span><span class="num" id="6050028">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050035">var</span>&nbsp;<span class="ident" id="6050039">out</span>&nbsp;<span class="ident" id="6050043">color</span><span class="op" id="6050048">.</span><span class="ident" id="6050049">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050057">sy</span>&nbsp;<span class="op" id="6050060">:=</span>&nbsp;<span class="ident" id="6050063">sp</span><span class="op" id="6050065">.</span><span class="ident" id="6050066">Y</span>&nbsp;<span class="op" id="6050068">+</span>&nbsp;<span class="ident" id="6050070">y0</span>&nbsp;<span class="op" id="6050073">-</span>&nbsp;<span class="ident" id="6050075">r</span><span class="op" id="6050076">.</span><span class="ident" id="6050077">Min</span><span class="op" id="6050080">.</span><span class="ident" id="6050081">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050084">my</span>&nbsp;<span class="op" id="6050087">:=</span>&nbsp;<span class="ident" id="6050090">mp</span><span class="op" id="6050092">.</span><span class="ident" id="6050093">Y</span>&nbsp;<span class="op" id="6050095">+</span>&nbsp;<span class="ident" id="6050097">y0</span>&nbsp;<span class="op" id="6050100">-</span>&nbsp;<span class="ident" id="6050102">r</span><span class="op" id="6050103">.</span><span class="ident" id="6050104">Min</span><span class="op" id="6050107">.</span><span class="ident" id="6050108">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050111">for</span>&nbsp;<span class="ident" id="6050115">y</span>&nbsp;<span class="op" id="6050117">:=</span>&nbsp;<span class="ident" id="6050120">y0</span><span class="op" id="6050122">;</span>&nbsp;<span class="ident" id="6050124">y</span>&nbsp;<span class="op" id="6050126">!=</span>&nbsp;<span class="ident" id="6050129">y1</span><span class="op" id="6050131">;</span>&nbsp;<span class="ident" id="6050133">y</span><span class="op" id="6050134">,</span>&nbsp;<span class="ident" id="6050136">sy</span><span class="op" id="6050138">,</span>&nbsp;<span class="ident" id="6050140">my</span>&nbsp;<span class="op" id="6050143">=</span>&nbsp;<span class="ident" id="6050145">y</span><span class="op" id="6050146">+</span><span class="ident" id="6050147">dy</span><span class="op" id="6050149">,</span>&nbsp;<span class="ident" id="6050151">sy</span><span class="op" id="6050153">+</span><span class="ident" id="6050154">dy</span><span class="op" id="6050156">,</span>&nbsp;<span class="ident" id="6050158">my</span><span class="op" id="6050160">+</span><span class="ident" id="6050161">dy</span>&nbsp;<span class="op" id="6050164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050168">sx</span>&nbsp;<span class="op" id="6050171">:=</span>&nbsp;<span class="ident" id="6050174">sp</span><span class="op" id="6050176">.</span><span class="ident" id="6050177">X</span>&nbsp;<span class="op" id="6050179">+</span>&nbsp;<span class="ident" id="6050181">x0</span>&nbsp;<span class="op" id="6050184">-</span>&nbsp;<span class="ident" id="6050186">r</span><span class="op" id="6050187">.</span><span class="ident" id="6050188">Min</span><span class="op" id="6050191">.</span><span class="ident" id="6050192">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050196">mx</span>&nbsp;<span class="op" id="6050199">:=</span>&nbsp;<span class="ident" id="6050202">mp</span><span class="op" id="6050204">.</span><span class="ident" id="6050205">X</span>&nbsp;<span class="op" id="6050207">+</span>&nbsp;<span class="ident" id="6050209">x0</span>&nbsp;<span class="op" id="6050212">-</span>&nbsp;<span class="ident" id="6050214">r</span><span class="op" id="6050215">.</span><span class="ident" id="6050216">Min</span><span class="op" id="6050219">.</span><span class="ident" id="6050220">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050224">for</span>&nbsp;<span class="ident" id="6050228">x</span>&nbsp;<span class="op" id="6050230">:=</span>&nbsp;<span class="ident" id="6050233">x0</span><span class="op" id="6050235">;</span>&nbsp;<span class="ident" id="6050237">x</span>&nbsp;<span class="op" id="6050239">!=</span>&nbsp;<span class="ident" id="6050242">x1</span><span class="op" id="6050244">;</span>&nbsp;<span class="ident" id="6050246">x</span><span class="op" id="6050247">,</span>&nbsp;<span class="ident" id="6050249">sx</span><span class="op" id="6050251">,</span>&nbsp;<span class="ident" id="6050253">mx</span>&nbsp;<span class="op" id="6050256">=</span>&nbsp;<span class="ident" id="6050258">x</span><span class="op" id="6050259">+</span><span class="ident" id="6050260">dx</span><span class="op" id="6050262">,</span>&nbsp;<span class="ident" id="6050264">sx</span><span class="op" id="6050266">+</span><span class="ident" id="6050267">dx</span><span class="op" id="6050269">,</span>&nbsp;<span class="ident" id="6050271">mx</span><span class="op" id="6050273">+</span><span class="ident" id="6050274">dx</span>&nbsp;<span class="op" id="6050277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050282">ma</span>&nbsp;<span class="op" id="6050285">:=</span>&nbsp;<span class="builtintype" id="6050288">uint32</span><span class="op" id="6050294">(</span><span class="ident" id="6050295">m</span><span class="op" id="6050296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050301">if</span>&nbsp;<span class="ident" id="6050304">mask</span>&nbsp;<span class="op" id="6050309">!=</span>&nbsp;<span class="ident" id="6050312">nil</span>&nbsp;<span class="op" id="6050316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050322">_</span><span class="op" id="6050323">,</span>&nbsp;<span class="ident" id="6050325">_</span><span class="op" id="6050326">,</span>&nbsp;<span class="ident" id="6050328">_</span><span class="op" id="6050329">,</span>&nbsp;<span class="ident" id="6050331">ma</span>&nbsp;<span class="op" id="6050334">=</span>&nbsp;<span class="ident" id="6050336">mask</span><span class="op" id="6050340">.</span><span class="ident" id="6050341">At</span><span class="op" id="6050343">(</span><span class="ident" id="6050344">mx</span><span class="op" id="6050346">,</span>&nbsp;<span class="ident" id="6050348">my</span><span class="op" id="6050350">)</span><span class="op" id="6050351">.</span><span class="ident" id="6050352">RGBA</span><span class="op" id="6050356">(</span><span class="op" id="6050357">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050367">switch</span>&nbsp;<span class="op" id="6050374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050379">case</span>&nbsp;<span class="ident" id="6050384">ma</span>&nbsp;<span class="op" id="6050387">==</span>&nbsp;<span class="num" id="6050390">0</span><span class="op" id="6050391">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050397">if</span>&nbsp;<span class="ident" id="6050400">op</span>&nbsp;<span class="op" id="6050403">==</span>&nbsp;<span class="ident" id="6050406">Over</span>&nbsp;<span class="op" id="6050411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050418">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050432">}</span>&nbsp;<span class="keyword" id="6050434">else</span>&nbsp;<span class="op" id="6050439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050446">dst</span><span class="op" id="6050449">.</span><span class="ident" id="6050450">Set</span><span class="op" id="6050453">(</span><span class="ident" id="6050454">x</span><span class="op" id="6050455">,</span>&nbsp;<span class="ident" id="6050457">y</span><span class="op" id="6050458">,</span>&nbsp;<span class="ident" id="6050460">color</span><span class="op" id="6050465">.</span><span class="ident" id="6050466">Transparent</span><span class="op" id="6050477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050488">case</span>&nbsp;<span class="ident" id="6050493">ma</span>&nbsp;<span class="op" id="6050496">==</span>&nbsp;<span class="ident" id="6050499">m</span>&nbsp;<span class="op" id="6050501">&amp;&amp;</span>&nbsp;<span class="ident" id="6050504">op</span>&nbsp;<span class="op" id="6050507">==</span>&nbsp;<span class="ident" id="6050510">Src</span><span class="op" id="6050513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050519">dst</span><span class="op" id="6050522">.</span><span class="ident" id="6050523">Set</span><span class="op" id="6050526">(</span><span class="ident" id="6050527">x</span><span class="op" id="6050528">,</span>&nbsp;<span class="ident" id="6050530">y</span><span class="op" id="6050531">,</span>&nbsp;<span class="ident" id="6050533">src</span><span class="op" id="6050536">.</span><span class="ident" id="6050537">At</span><span class="op" id="6050539">(</span><span class="ident" id="6050540">sx</span><span class="op" id="6050542">,</span>&nbsp;<span class="ident" id="6050544">sy</span><span class="op" id="6050546">)</span><span class="op" id="6050547">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050552">default</span><span class="op" id="6050559">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050565">sr</span><span class="op" id="6050567">,</span>&nbsp;<span class="ident" id="6050569">sg</span><span class="op" id="6050571">,</span>&nbsp;<span class="ident" id="6050573">sb</span><span class="op" id="6050575">,</span>&nbsp;<span class="ident" id="6050577">sa</span>&nbsp;<span class="op" id="6050580">:=</span>&nbsp;<span class="ident" id="6050583">src</span><span class="op" id="6050586">.</span><span class="ident" id="6050587">At</span><span class="op" id="6050589">(</span><span class="ident" id="6050590">sx</span><span class="op" id="6050592">,</span>&nbsp;<span class="ident" id="6050594">sy</span><span class="op" id="6050596">)</span><span class="op" id="6050597">.</span><span class="ident" id="6050598">RGBA</span><span class="op" id="6050602">(</span><span class="op" id="6050603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050609">if</span>&nbsp;<span class="ident" id="6050612">op</span>&nbsp;<span class="op" id="6050615">==</span>&nbsp;<span class="ident" id="6050618">Over</span>&nbsp;<span class="op" id="6050623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050630">dr</span><span class="op" id="6050632">,</span>&nbsp;<span class="ident" id="6050634">dg</span><span class="op" id="6050636">,</span>&nbsp;<span class="ident" id="6050638">db</span><span class="op" id="6050640">,</span>&nbsp;<span class="ident" id="6050642">da</span>&nbsp;<span class="op" id="6050645">:=</span>&nbsp;<span class="ident" id="6050648">dst</span><span class="op" id="6050651">.</span><span class="ident" id="6050652">At</span><span class="op" id="6050654">(</span><span class="ident" id="6050655">x</span><span class="op" id="6050656">,</span>&nbsp;<span class="ident" id="6050658">y</span><span class="op" id="6050659">)</span><span class="op" id="6050660">.</span><span class="ident" id="6050661">RGBA</span><span class="op" id="6050665">(</span><span class="op" id="6050666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050673">a</span>&nbsp;<span class="op" id="6050675">:=</span>&nbsp;<span class="ident" id="6050678">m</span>&nbsp;<span class="op" id="6050680">-</span>&nbsp;<span class="op" id="6050682">(</span><span class="ident" id="6050683">sa</span>&nbsp;<span class="op" id="6050686">*</span>&nbsp;<span class="ident" id="6050688">ma</span>&nbsp;<span class="op" id="6050691">/</span>&nbsp;<span class="ident" id="6050693">m</span><span class="op" id="6050694">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050701">out</span><span class="op" id="6050704">.</span><span class="ident" id="6050705">R</span>&nbsp;<span class="op" id="6050707">=</span>&nbsp;<span class="builtintype" id="6050709">uint16</span><span class="op" id="6050715">(</span><span class="op" id="6050716">(</span><span class="ident" id="6050717">dr</span><span class="op" id="6050719">*</span><span class="ident" id="6050720">a</span>&nbsp;<span class="op" id="6050722">+</span>&nbsp;<span class="ident" id="6050724">sr</span><span class="op" id="6050726">*</span><span class="ident" id="6050727">ma</span><span class="op" id="6050729">)</span>&nbsp;<span class="op" id="6050731">/</span>&nbsp;<span class="ident" id="6050733">m</span><span class="op" id="6050734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050741">out</span><span class="op" id="6050744">.</span><span class="ident" id="6050745">G</span>&nbsp;<span class="op" id="6050747">=</span>&nbsp;<span class="builtintype" id="6050749">uint16</span><span class="op" id="6050755">(</span><span class="op" id="6050756">(</span><span class="ident" id="6050757">dg</span><span class="op" id="6050759">*</span><span class="ident" id="6050760">a</span>&nbsp;<span class="op" id="6050762">+</span>&nbsp;<span class="ident" id="6050764">sg</span><span class="op" id="6050766">*</span><span class="ident" id="6050767">ma</span><span class="op" id="6050769">)</span>&nbsp;<span class="op" id="6050771">/</span>&nbsp;<span class="ident" id="6050773">m</span><span class="op" id="6050774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050781">out</span><span class="op" id="6050784">.</span><span class="ident" id="6050785">B</span>&nbsp;<span class="op" id="6050787">=</span>&nbsp;<span class="builtintype" id="6050789">uint16</span><span class="op" id="6050795">(</span><span class="op" id="6050796">(</span><span class="ident" id="6050797">db</span><span class="op" id="6050799">*</span><span class="ident" id="6050800">a</span>&nbsp;<span class="op" id="6050802">+</span>&nbsp;<span class="ident" id="6050804">sb</span><span class="op" id="6050806">*</span><span class="ident" id="6050807">ma</span><span class="op" id="6050809">)</span>&nbsp;<span class="op" id="6050811">/</span>&nbsp;<span class="ident" id="6050813">m</span><span class="op" id="6050814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050821">out</span><span class="op" id="6050824">.</span><span class="ident" id="6050825">A</span>&nbsp;<span class="op" id="6050827">=</span>&nbsp;<span class="builtintype" id="6050829">uint16</span><span class="op" id="6050835">(</span><span class="op" id="6050836">(</span><span class="ident" id="6050837">da</span><span class="op" id="6050839">*</span><span class="ident" id="6050840">a</span>&nbsp;<span class="op" id="6050842">+</span>&nbsp;<span class="ident" id="6050844">sa</span><span class="op" id="6050846">*</span><span class="ident" id="6050847">ma</span><span class="op" id="6050849">)</span>&nbsp;<span class="op" id="6050851">/</span>&nbsp;<span class="ident" id="6050853">m</span><span class="op" id="6050854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050860">}</span>&nbsp;<span class="keyword" id="6050862">else</span>&nbsp;<span class="op" id="6050867">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050874">out</span><span class="op" id="6050877">.</span><span class="ident" id="6050878">R</span>&nbsp;<span class="op" id="6050880">=</span>&nbsp;<span class="builtintype" id="6050882">uint16</span><span class="op" id="6050888">(</span><span class="ident" id="6050889">sr</span>&nbsp;<span class="op" id="6050892">*</span>&nbsp;<span class="ident" id="6050894">ma</span>&nbsp;<span class="op" id="6050897">/</span>&nbsp;<span class="ident" id="6050899">m</span><span class="op" id="6050900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050907">out</span><span class="op" id="6050910">.</span><span class="ident" id="6050911">G</span>&nbsp;<span class="op" id="6050913">=</span>&nbsp;<span class="builtintype" id="6050915">uint16</span><span class="op" id="6050921">(</span><span class="ident" id="6050922">sg</span>&nbsp;<span class="op" id="6050925">*</span>&nbsp;<span class="ident" id="6050927">ma</span>&nbsp;<span class="op" id="6050930">/</span>&nbsp;<span class="ident" id="6050932">m</span><span class="op" id="6050933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050940">out</span><span class="op" id="6050943">.</span><span class="ident" id="6050944">B</span>&nbsp;<span class="op" id="6050946">=</span>&nbsp;<span class="builtintype" id="6050948">uint16</span><span class="op" id="6050954">(</span><span class="ident" id="6050955">sb</span>&nbsp;<span class="op" id="6050958">*</span>&nbsp;<span class="ident" id="6050960">ma</span>&nbsp;<span class="op" id="6050963">/</span>&nbsp;<span class="ident" id="6050965">m</span><span class="op" id="6050966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050973">out</span><span class="op" id="6050976">.</span><span class="ident" id="6050977">A</span>&nbsp;<span class="op" id="6050979">=</span>&nbsp;<span class="builtintype" id="6050981">uint16</span><span class="op" id="6050987">(</span><span class="ident" id="6050988">sa</span>&nbsp;<span class="op" id="6050991">*</span>&nbsp;<span class="ident" id="6050993">ma</span>&nbsp;<span class="op" id="6050996">/</span>&nbsp;<span class="ident" id="6050998">m</span><span class="op" id="6050999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051005">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051011">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051072">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051137">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051200">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051261">dst</span><span class="op" id="6051264">.</span><span class="ident" id="6051265">Set</span><span class="op" id="6051268">(</span><span class="ident" id="6051269">x</span><span class="op" id="6051270">,</span>&nbsp;<span class="ident" id="6051272">y</span><span class="op" id="6051273">,</span>&nbsp;<span class="op" id="6051275">&amp;</span><span class="ident" id="6051276">out</span><span class="op" id="6051279">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051291">}</span><br>
<span class="lineno"></span><span class="op" id="6051293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="6051296">func</span>&nbsp;<span class="ident" id="6051301">drawFillOver</span><span class="op" id="6051313">(</span><span class="ident" id="6051314">dst</span>&nbsp;<span class="op" id="6051318">*</span><span class="ident" id="6051319">image</span><span class="op" id="6051324">.</span><span class="ident" id="6051325">RGBA</span><span class="op" id="6051329">,</span>&nbsp;<span class="ident" id="6051331">r</span>&nbsp;<span class="ident" id="6051333">image</span><span class="op" id="6051338">.</span><span class="ident" id="6051339">Rectangle</span><span class="op" id="6051348">,</span>&nbsp;<span class="ident" id="6051350">src</span>&nbsp;<span class="op" id="6051354">*</span><span class="ident" id="6051355">image</span><span class="op" id="6051360">.</span><span class="ident" id="6051361">Uniform</span><span class="op" id="6051368">)</span>&nbsp;<span class="op" id="6051370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051373">sr</span><span class="op" id="6051375">,</span>&nbsp;<span class="ident" id="6051377">sg</span><span class="op" id="6051379">,</span>&nbsp;<span class="ident" id="6051381">sb</span><span class="op" id="6051383">,</span>&nbsp;<span class="ident" id="6051385">sa</span>&nbsp;<span class="op" id="6051388">:=</span>&nbsp;<span class="ident" id="6051391">src</span><span class="op" id="6051394">.</span><span class="ident" id="6051395">RGBA</span><span class="op" id="6051399">(</span><span class="op" id="6051400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051403">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051461">a</span>&nbsp;<span class="op" id="6051463">:=</span>&nbsp;<span class="op" id="6051466">(</span><span class="ident" id="6051467">m</span>&nbsp;<span class="op" id="6051469">-</span>&nbsp;<span class="ident" id="6051471">sa</span><span class="op" id="6051473">)</span>&nbsp;<span class="op" id="6051475">*</span>&nbsp;<span class="num" id="6051477">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051484">i0</span>&nbsp;<span class="op" id="6051487">:=</span>&nbsp;<span class="ident" id="6051490">dst</span><span class="op" id="6051493">.</span><span class="ident" id="6051494">PixOffset</span><span class="op" id="6051503">(</span><span class="ident" id="6051504">r</span><span class="op" id="6051505">.</span><span class="ident" id="6051506">Min</span><span class="op" id="6051509">.</span><span class="ident" id="6051510">X</span><span class="op" id="6051511">,</span>&nbsp;<span class="ident" id="6051513">r</span><span class="op" id="6051514">.</span><span class="ident" id="6051515">Min</span><span class="op" id="6051518">.</span><span class="ident" id="6051519">Y</span><span class="op" id="6051520">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051523">i1</span>&nbsp;<span class="op" id="6051526">:=</span>&nbsp;<span class="ident" id="6051529">i0</span>&nbsp;<span class="op" id="6051532">+</span>&nbsp;<span class="ident" id="6051534">r</span><span class="op" id="6051535">.</span><span class="ident" id="6051536">Dx</span><span class="op" id="6051538">(</span><span class="op" id="6051539">)</span><span class="op" id="6051540">*</span><span class="num" id="6051541">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051544">for</span>&nbsp;<span class="ident" id="6051548">y</span>&nbsp;<span class="op" id="6051550">:=</span>&nbsp;<span class="ident" id="6051553">r</span><span class="op" id="6051554">.</span><span class="ident" id="6051555">Min</span><span class="op" id="6051558">.</span><span class="ident" id="6051559">Y</span><span class="op" id="6051560">;</span>&nbsp;<span class="ident" id="6051562">y</span>&nbsp;<span class="op" id="6051564">!=</span>&nbsp;<span class="ident" id="6051567">r</span><span class="op" id="6051568">.</span><span class="ident" id="6051569">Max</span><span class="op" id="6051572">.</span><span class="ident" id="6051573">Y</span><span class="op" id="6051574">;</span>&nbsp;<span class="ident" id="6051576">y</span><span class="op" id="6051577">++</span>&nbsp;<span class="op" id="6051580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051584">for</span>&nbsp;<span class="ident" id="6051588">i</span>&nbsp;<span class="op" id="6051590">:=</span>&nbsp;<span class="ident" id="6051593">i0</span><span class="op" id="6051595">;</span>&nbsp;<span class="ident" id="6051597">i</span>&nbsp;<span class="op" id="6051599">&lt;</span>&nbsp;<span class="ident" id="6051601">i1</span><span class="op" id="6051603">;</span>&nbsp;<span class="ident" id="6051605">i</span>&nbsp;<span class="op" id="6051607">+=</span>&nbsp;<span class="num" id="6051610">4</span>&nbsp;<span class="op" id="6051612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051617">dr</span>&nbsp;<span class="op" id="6051620">:=</span>&nbsp;<span class="builtintype" id="6051623">uint32</span><span class="op" id="6051629">(</span><span class="ident" id="6051630">dst</span><span class="op" id="6051633">.</span><span class="ident" id="6051634">Pix</span><span class="op" id="6051637">[</span><span class="ident" id="6051638">i</span><span class="op" id="6051639">+</span><span class="num" id="6051640">0</span><span class="op" id="6051641">]</span><span class="op" id="6051642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051647">dg</span>&nbsp;<span class="op" id="6051650">:=</span>&nbsp;<span class="builtintype" id="6051653">uint32</span><span class="op" id="6051659">(</span><span class="ident" id="6051660">dst</span><span class="op" id="6051663">.</span><span class="ident" id="6051664">Pix</span><span class="op" id="6051667">[</span><span class="ident" id="6051668">i</span><span class="op" id="6051669">+</span><span class="num" id="6051670">1</span><span class="op" id="6051671">]</span><span class="op" id="6051672">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051677">db</span>&nbsp;<span class="op" id="6051680">:=</span>&nbsp;<span class="builtintype" id="6051683">uint32</span><span class="op" id="6051689">(</span><span class="ident" id="6051690">dst</span><span class="op" id="6051693">.</span><span class="ident" id="6051694">Pix</span><span class="op" id="6051697">[</span><span class="ident" id="6051698">i</span><span class="op" id="6051699">+</span><span class="num" id="6051700">2</span><span class="op" id="6051701">]</span><span class="op" id="6051702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051707">da</span>&nbsp;<span class="op" id="6051710">:=</span>&nbsp;<span class="builtintype" id="6051713">uint32</span><span class="op" id="6051719">(</span><span class="ident" id="6051720">dst</span><span class="op" id="6051723">.</span><span class="ident" id="6051724">Pix</span><span class="op" id="6051727">[</span><span class="ident" id="6051728">i</span><span class="op" id="6051729">+</span><span class="num" id="6051730">3</span><span class="op" id="6051731">]</span><span class="op" id="6051732">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051738">dst</span><span class="op" id="6051741">.</span><span class="ident" id="6051742">Pix</span><span class="op" id="6051745">[</span><span class="ident" id="6051746">i</span><span class="op" id="6051747">+</span><span class="num" id="6051748">0</span><span class="op" id="6051749">]</span>&nbsp;<span class="op" id="6051751">=</span>&nbsp;<span class="builtintype" id="6051753">uint8</span><span class="op" id="6051758">(</span><span class="op" id="6051759">(</span><span class="ident" id="6051760">dr</span><span class="op" id="6051762">*</span><span class="ident" id="6051763">a</span><span class="op" id="6051764">/</span><span class="ident" id="6051765">m</span>&nbsp;<span class="op" id="6051767">+</span>&nbsp;<span class="ident" id="6051769">sr</span><span class="op" id="6051771">)</span>&nbsp;<span class="op" id="6051773">&gt;&gt;</span>&nbsp;<span class="num" id="6051776">8</span><span class="op" id="6051777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051782">dst</span><span class="op" id="6051785">.</span><span class="ident" id="6051786">Pix</span><span class="op" id="6051789">[</span><span class="ident" id="6051790">i</span><span class="op" id="6051791">+</span><span class="num" id="6051792">1</span><span class="op" id="6051793">]</span>&nbsp;<span class="op" id="6051795">=</span>&nbsp;<span class="builtintype" id="6051797">uint8</span><span class="op" id="6051802">(</span><span class="op" id="6051803">(</span><span class="ident" id="6051804">dg</span><span class="op" id="6051806">*</span><span class="ident" id="6051807">a</span><span class="op" id="6051808">/</span><span class="ident" id="6051809">m</span>&nbsp;<span class="op" id="6051811">+</span>&nbsp;<span class="ident" id="6051813">sg</span><span class="op" id="6051815">)</span>&nbsp;<span class="op" id="6051817">&gt;&gt;</span>&nbsp;<span class="num" id="6051820">8</span><span class="op" id="6051821">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051826">dst</span><span class="op" id="6051829">.</span><span class="ident" id="6051830">Pix</span><span class="op" id="6051833">[</span><span class="ident" id="6051834">i</span><span class="op" id="6051835">+</span><span class="num" id="6051836">2</span><span class="op" id="6051837">]</span>&nbsp;<span class="op" id="6051839">=</span>&nbsp;<span class="builtintype" id="6051841">uint8</span><span class="op" id="6051846">(</span><span class="op" id="6051847">(</span><span class="ident" id="6051848">db</span><span class="op" id="6051850">*</span><span class="ident" id="6051851">a</span><span class="op" id="6051852">/</span><span class="ident" id="6051853">m</span>&nbsp;<span class="op" id="6051855">+</span>&nbsp;<span class="ident" id="6051857">sb</span><span class="op" id="6051859">)</span>&nbsp;<span class="op" id="6051861">&gt;&gt;</span>&nbsp;<span class="num" id="6051864">8</span><span class="op" id="6051865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051870">dst</span><span class="op" id="6051873">.</span><span class="ident" id="6051874">Pix</span><span class="op" id="6051877">[</span><span class="ident" id="6051878">i</span><span class="op" id="6051879">+</span><span class="num" id="6051880">3</span><span class="op" id="6051881">]</span>&nbsp;<span class="op" id="6051883">=</span>&nbsp;<span class="builtintype" id="6051885">uint8</span><span class="op" id="6051890">(</span><span class="op" id="6051891">(</span><span class="ident" id="6051892">da</span><span class="op" id="6051894">*</span><span class="ident" id="6051895">a</span><span class="op" id="6051896">/</span><span class="ident" id="6051897">m</span>&nbsp;<span class="op" id="6051899">+</span>&nbsp;<span class="ident" id="6051901">sa</span><span class="op" id="6051903">)</span>&nbsp;<span class="op" id="6051905">&gt;&gt;</span>&nbsp;<span class="num" id="6051908">8</span><span class="op" id="6051909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051917">i0</span>&nbsp;<span class="op" id="6051920">+=</span>&nbsp;<span class="ident" id="6051923">dst</span><span class="op" id="6051926">.</span><span class="ident" id="6051927">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051936">i1</span>&nbsp;<span class="op" id="6051939">+=</span>&nbsp;<span class="ident" id="6051942">dst</span><span class="op" id="6051945">.</span><span class="ident" id="6051946">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051954">}</span><br>
<span class="lineno"></span><span class="op" id="6051956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6051959">func</span>&nbsp;<span class="ident" id="6051964">drawFillSrc</span><span class="op" id="6051975">(</span><span class="ident" id="6051976">dst</span>&nbsp;<span class="op" id="6051980">*</span><span class="ident" id="6051981">image</span><span class="op" id="6051986">.</span><span class="ident" id="6051987">RGBA</span><span class="op" id="6051991">,</span>&nbsp;<span class="ident" id="6051993">r</span>&nbsp;<span class="ident" id="6051995">image</span><span class="op" id="6052000">.</span><span class="ident" id="6052001">Rectangle</span><span class="op" id="6052010">,</span>&nbsp;<span class="ident" id="6052012">src</span>&nbsp;<span class="op" id="6052016">*</span><span class="ident" id="6052017">image</span><span class="op" id="6052022">.</span><span class="ident" id="6052023">Uniform</span><span class="op" id="6052030">)</span>&nbsp;<span class="op" id="6052032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052035">sr</span><span class="op" id="6052037">,</span>&nbsp;<span class="ident" id="6052039">sg</span><span class="op" id="6052041">,</span>&nbsp;<span class="ident" id="6052043">sb</span><span class="op" id="6052045">,</span>&nbsp;<span class="ident" id="6052047">sa</span>&nbsp;<span class="op" id="6052050">:=</span>&nbsp;<span class="ident" id="6052053">src</span><span class="op" id="6052056">.</span><span class="ident" id="6052057">RGBA</span><span class="op" id="6052061">(</span><span class="op" id="6052062">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052065">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052167">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052271">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052342">i0</span>&nbsp;<span class="op" id="6052345">:=</span>&nbsp;<span class="ident" id="6052348">dst</span><span class="op" id="6052351">.</span><span class="ident" id="6052352">PixOffset</span><span class="op" id="6052361">(</span><span class="ident" id="6052362">r</span><span class="op" id="6052363">.</span><span class="ident" id="6052364">Min</span><span class="op" id="6052367">.</span><span class="ident" id="6052368">X</span><span class="op" id="6052369">,</span>&nbsp;<span class="ident" id="6052371">r</span><span class="op" id="6052372">.</span><span class="ident" id="6052373">Min</span><span class="op" id="6052376">.</span><span class="ident" id="6052377">Y</span><span class="op" id="6052378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052381">i1</span>&nbsp;<span class="op" id="6052384">:=</span>&nbsp;<span class="ident" id="6052387">i0</span>&nbsp;<span class="op" id="6052390">+</span>&nbsp;<span class="ident" id="6052392">r</span><span class="op" id="6052393">.</span><span class="ident" id="6052394">Dx</span><span class="op" id="6052396">(</span><span class="op" id="6052397">)</span><span class="op" id="6052398">*</span><span class="num" id="6052399">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052402">for</span>&nbsp;<span class="ident" id="6052406">i</span>&nbsp;<span class="op" id="6052408">:=</span>&nbsp;<span class="ident" id="6052411">i0</span><span class="op" id="6052413">;</span>&nbsp;<span class="ident" id="6052415">i</span>&nbsp;<span class="op" id="6052417">&lt;</span>&nbsp;<span class="ident" id="6052419">i1</span><span class="op" id="6052421">;</span>&nbsp;<span class="ident" id="6052423">i</span>&nbsp;<span class="op" id="6052425">+=</span>&nbsp;<span class="num" id="6052428">4</span>&nbsp;<span class="op" id="6052430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052434">dst</span><span class="op" id="6052437">.</span><span class="ident" id="6052438">Pix</span><span class="op" id="6052441">[</span><span class="ident" id="6052442">i</span><span class="op" id="6052443">+</span><span class="num" id="6052444">0</span><span class="op" id="6052445">]</span>&nbsp;<span class="op" id="6052447">=</span>&nbsp;<span class="builtintype" id="6052449">uint8</span><span class="op" id="6052454">(</span><span class="ident" id="6052455">sr</span>&nbsp;<span class="op" id="6052458">&gt;&gt;</span>&nbsp;<span class="num" id="6052461">8</span><span class="op" id="6052462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052466">dst</span><span class="op" id="6052469">.</span><span class="ident" id="6052470">Pix</span><span class="op" id="6052473">[</span><span class="ident" id="6052474">i</span><span class="op" id="6052475">+</span><span class="num" id="6052476">1</span><span class="op" id="6052477">]</span>&nbsp;<span class="op" id="6052479">=</span>&nbsp;<span class="builtintype" id="6052481">uint8</span><span class="op" id="6052486">(</span><span class="ident" id="6052487">sg</span>&nbsp;<span class="op" id="6052490">&gt;&gt;</span>&nbsp;<span class="num" id="6052493">8</span><span class="op" id="6052494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052498">dst</span><span class="op" id="6052501">.</span><span class="ident" id="6052502">Pix</span><span class="op" id="6052505">[</span><span class="ident" id="6052506">i</span><span class="op" id="6052507">+</span><span class="num" id="6052508">2</span><span class="op" id="6052509">]</span>&nbsp;<span class="op" id="6052511">=</span>&nbsp;<span class="builtintype" id="6052513">uint8</span><span class="op" id="6052518">(</span><span class="ident" id="6052519">sb</span>&nbsp;<span class="op" id="6052522">&gt;&gt;</span>&nbsp;<span class="num" id="6052525">8</span><span class="op" id="6052526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052530">dst</span><span class="op" id="6052533">.</span><span class="ident" id="6052534">Pix</span><span class="op" id="6052537">[</span><span class="ident" id="6052538">i</span><span class="op" id="6052539">+</span><span class="num" id="6052540">3</span><span class="op" id="6052541">]</span>&nbsp;<span class="op" id="6052543">=</span>&nbsp;<span class="builtintype" id="6052545">uint8</span><span class="op" id="6052550">(</span><span class="ident" id="6052551">sa</span>&nbsp;<span class="op" id="6052554">&gt;&gt;</span>&nbsp;<span class="num" id="6052557">8</span><span class="op" id="6052558">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052564">firstRow</span>&nbsp;<span class="op" id="6052573">:=</span>&nbsp;<span class="ident" id="6052576">dst</span><span class="op" id="6052579">.</span><span class="ident" id="6052580">Pix</span><span class="op" id="6052583">[</span><span class="ident" id="6052584">i0</span><span class="op" id="6052586">:</span><span class="ident" id="6052587">i1</span><span class="op" id="6052589">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052592">for</span>&nbsp;<span class="ident" id="6052596">y</span>&nbsp;<span class="op" id="6052598">:=</span>&nbsp;<span class="ident" id="6052601">r</span><span class="op" id="6052602">.</span><span class="ident" id="6052603">Min</span><span class="op" id="6052606">.</span><span class="ident" id="6052607">Y</span>&nbsp;<span class="op" id="6052609">+</span>&nbsp;<span class="num" id="6052611">1</span><span class="op" id="6052612">;</span>&nbsp;<span class="ident" id="6052614">y</span>&nbsp;<span class="op" id="6052616">&lt;</span>&nbsp;<span class="ident" id="6052618">r</span><span class="op" id="6052619">.</span><span class="ident" id="6052620">Max</span><span class="op" id="6052623">.</span><span class="ident" id="6052624">Y</span><span class="op" id="6052625">;</span>&nbsp;<span class="ident" id="6052627">y</span><span class="op" id="6052628">++</span>&nbsp;<span class="op" id="6052631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052635">i0</span>&nbsp;<span class="op" id="6052638">+=</span>&nbsp;<span class="ident" id="6052641">dst</span><span class="op" id="6052644">.</span><span class="ident" id="6052645">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052654">i1</span>&nbsp;<span class="op" id="6052657">+=</span>&nbsp;<span class="ident" id="6052660">dst</span><span class="op" id="6052663">.</span><span class="ident" id="6052664">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6052673">copy</span><span class="op" id="6052677">(</span><span class="ident" id="6052678">dst</span><span class="op" id="6052681">.</span><span class="ident" id="6052682">Pix</span><span class="op" id="6052685">[</span><span class="ident" id="6052686">i0</span><span class="op" id="6052688">:</span><span class="ident" id="6052689">i1</span><span class="op" id="6052691">]</span><span class="op" id="6052692">,</span>&nbsp;<span class="ident" id="6052694">firstRow</span><span class="op" id="6052702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052705">}</span><br>
<span class="lineno"></span><span class="op" id="6052707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6052710">func</span>&nbsp;<span class="ident" id="6052715">drawCopyOver</span><span class="op" id="6052727">(</span><span class="ident" id="6052728">dst</span>&nbsp;<span class="op" id="6052732">*</span><span class="ident" id="6052733">image</span><span class="op" id="6052738">.</span><span class="ident" id="6052739">RGBA</span><span class="op" id="6052743">,</span>&nbsp;<span class="ident" id="6052745">r</span>&nbsp;<span class="ident" id="6052747">image</span><span class="op" id="6052752">.</span><span class="ident" id="6052753">Rectangle</span><span class="op" id="6052762">,</span>&nbsp;<span class="ident" id="6052764">src</span>&nbsp;<span class="op" id="6052768">*</span><span class="ident" id="6052769">image</span><span class="op" id="6052774">.</span><span class="ident" id="6052775">RGBA</span><span class="op" id="6052779">,</span>&nbsp;<span class="ident" id="6052781">sp</span>&nbsp;<span class="ident" id="6052784">image</span><span class="op" id="6052789">.</span><span class="ident" id="6052790">Point</span><span class="op" id="6052795">)</span>&nbsp;<span class="op" id="6052797">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052800">dx</span><span class="op" id="6052802">,</span>&nbsp;<span class="ident" id="6052804">dy</span>&nbsp;<span class="op" id="6052807">:=</span>&nbsp;<span class="ident" id="6052810">r</span><span class="op" id="6052811">.</span><span class="ident" id="6052812">Dx</span><span class="op" id="6052814">(</span><span class="op" id="6052815">)</span><span class="op" id="6052816">,</span>&nbsp;<span class="ident" id="6052818">r</span><span class="op" id="6052819">.</span><span class="ident" id="6052820">Dy</span><span class="op" id="6052822">(</span><span class="op" id="6052823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052826">d0</span>&nbsp;<span class="op" id="6052829">:=</span>&nbsp;<span class="ident" id="6052832">dst</span><span class="op" id="6052835">.</span><span class="ident" id="6052836">PixOffset</span><span class="op" id="6052845">(</span><span class="ident" id="6052846">r</span><span class="op" id="6052847">.</span><span class="ident" id="6052848">Min</span><span class="op" id="6052851">.</span><span class="ident" id="6052852">X</span><span class="op" id="6052853">,</span>&nbsp;<span class="ident" id="6052855">r</span><span class="op" id="6052856">.</span><span class="ident" id="6052857">Min</span><span class="op" id="6052860">.</span><span class="ident" id="6052861">Y</span><span class="op" id="6052862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052865">s0</span>&nbsp;<span class="op" id="6052868">:=</span>&nbsp;<span class="ident" id="6052871">src</span><span class="op" id="6052874">.</span><span class="ident" id="6052875">PixOffset</span><span class="op" id="6052884">(</span><span class="ident" id="6052885">sp</span><span class="op" id="6052887">.</span><span class="ident" id="6052888">X</span><span class="op" id="6052889">,</span>&nbsp;<span class="ident" id="6052891">sp</span><span class="op" id="6052893">.</span><span class="ident" id="6052894">Y</span><span class="op" id="6052895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052898">var</span>&nbsp;<span class="op" id="6052902">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052906">ddelta</span><span class="op" id="6052912">,</span>&nbsp;<span class="ident" id="6052914">sdelta</span>&nbsp;<span class="builtintype" id="6052921">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052927">i0</span><span class="op" id="6052929">,</span>&nbsp;<span class="ident" id="6052931">i1</span><span class="op" id="6052933">,</span>&nbsp;<span class="ident" id="6052935">idelta</span>&nbsp;<span class="builtintype" id="6052942">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052950">if</span>&nbsp;<span class="ident" id="6052953">r</span><span class="op" id="6052954">.</span><span class="ident" id="6052955">Min</span><span class="op" id="6052958">.</span><span class="ident" id="6052959">Y</span>&nbsp;<span class="op" id="6052961">&lt;</span>&nbsp;<span class="ident" id="6052963">sp</span><span class="op" id="6052965">.</span><span class="ident" id="6052966">Y</span>&nbsp;<span class="op" id="6052968">||</span>&nbsp;<span class="ident" id="6052971">r</span><span class="op" id="6052972">.</span><span class="ident" id="6052973">Min</span><span class="op" id="6052976">.</span><span class="ident" id="6052977">Y</span>&nbsp;<span class="op" id="6052979">==</span>&nbsp;<span class="ident" id="6052982">sp</span><span class="op" id="6052984">.</span><span class="ident" id="6052985">Y</span>&nbsp;<span class="op" id="6052987">&amp;&amp;</span>&nbsp;<span class="ident" id="6052990">r</span><span class="op" id="6052991">.</span><span class="ident" id="6052992">Min</span><span class="op" id="6052995">.</span><span class="ident" id="6052996">X</span>&nbsp;<span class="op" id="6052998">&lt;=</span>&nbsp;<span class="ident" id="6053001">sp</span><span class="op" id="6053003">.</span><span class="ident" id="6053004">X</span>&nbsp;<span class="op" id="6053006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053010">ddelta</span>&nbsp;<span class="op" id="6053017">=</span>&nbsp;<span class="ident" id="6053019">dst</span><span class="op" id="6053022">.</span><span class="ident" id="6053023">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053032">sdelta</span>&nbsp;<span class="op" id="6053039">=</span>&nbsp;<span class="ident" id="6053041">src</span><span class="op" id="6053044">.</span><span class="ident" id="6053045">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053054">i0</span><span class="op" id="6053056">,</span>&nbsp;<span class="ident" id="6053058">i1</span><span class="op" id="6053060">,</span>&nbsp;<span class="ident" id="6053062">idelta</span>&nbsp;<span class="op" id="6053069">=</span>&nbsp;<span class="num" id="6053071">0</span><span class="op" id="6053072">,</span>&nbsp;<span class="ident" id="6053074">dx</span><span class="op" id="6053076">*</span><span class="num" id="6053077">4</span><span class="op" id="6053078">,</span>&nbsp;<span class="op" id="6053080">+</span><span class="num" id="6053081">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053084">}</span>&nbsp;<span class="keyword" id="6053086">else</span>&nbsp;<span class="op" id="6053091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053095">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053203">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053303">d0</span>&nbsp;<span class="op" id="6053306">+=</span>&nbsp;<span class="op" id="6053309">(</span><span class="ident" id="6053310">dy</span>&nbsp;<span class="op" id="6053313">-</span>&nbsp;<span class="num" id="6053315">1</span><span class="op" id="6053316">)</span>&nbsp;<span class="op" id="6053318">*</span>&nbsp;<span class="ident" id="6053320">dst</span><span class="op" id="6053323">.</span><span class="ident" id="6053324">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053333">s0</span>&nbsp;<span class="op" id="6053336">+=</span>&nbsp;<span class="op" id="6053339">(</span><span class="ident" id="6053340">dy</span>&nbsp;<span class="op" id="6053343">-</span>&nbsp;<span class="num" id="6053345">1</span><span class="op" id="6053346">)</span>&nbsp;<span class="op" id="6053348">*</span>&nbsp;<span class="ident" id="6053350">src</span><span class="op" id="6053353">.</span><span class="ident" id="6053354">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053363">ddelta</span>&nbsp;<span class="op" id="6053370">=</span>&nbsp;<span class="op" id="6053372">-</span><span class="ident" id="6053373">dst</span><span class="op" id="6053376">.</span><span class="ident" id="6053377">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053386">sdelta</span>&nbsp;<span class="op" id="6053393">=</span>&nbsp;<span class="op" id="6053395">-</span><span class="ident" id="6053396">src</span><span class="op" id="6053399">.</span><span class="ident" id="6053400">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053409">i0</span><span class="op" id="6053411">,</span>&nbsp;<span class="ident" id="6053413">i1</span><span class="op" id="6053415">,</span>&nbsp;<span class="ident" id="6053417">idelta</span>&nbsp;<span class="op" id="6053424">=</span>&nbsp;<span class="op" id="6053426">(</span><span class="ident" id="6053427">dx</span><span class="op" id="6053429">-</span><span class="num" id="6053430">1</span><span class="op" id="6053431">)</span><span class="op" id="6053432">*</span><span class="num" id="6053433">4</span><span class="op" id="6053434">,</span>&nbsp;<span class="op" id="6053436">-</span><span class="num" id="6053437">4</span><span class="op" id="6053438">,</span>&nbsp;<span class="op" id="6053440">-</span><span class="num" id="6053441">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053444">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053447">for</span>&nbsp;<span class="op" id="6053451">;</span>&nbsp;<span class="ident" id="6053453">dy</span>&nbsp;<span class="op" id="6053456">&gt;</span>&nbsp;<span class="num" id="6053458">0</span><span class="op" id="6053459">;</span>&nbsp;<span class="ident" id="6053461">dy</span><span class="op" id="6053463">--</span>&nbsp;<span class="op" id="6053466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053470">dpix</span>&nbsp;<span class="op" id="6053475">:=</span>&nbsp;<span class="ident" id="6053478">dst</span><span class="op" id="6053481">.</span><span class="ident" id="6053482">Pix</span><span class="op" id="6053485">[</span><span class="ident" id="6053486">d0</span><span class="op" id="6053488">:</span><span class="op" id="6053489">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053493">spix</span>&nbsp;<span class="op" id="6053498">:=</span>&nbsp;<span class="ident" id="6053501">src</span><span class="op" id="6053504">.</span><span class="ident" id="6053505">Pix</span><span class="op" id="6053508">[</span><span class="ident" id="6053509">s0</span><span class="op" id="6053511">:</span><span class="op" id="6053512">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053516">for</span>&nbsp;<span class="ident" id="6053520">i</span>&nbsp;<span class="op" id="6053522">:=</span>&nbsp;<span class="ident" id="6053525">i0</span><span class="op" id="6053527">;</span>&nbsp;<span class="ident" id="6053529">i</span>&nbsp;<span class="op" id="6053531">!=</span>&nbsp;<span class="ident" id="6053534">i1</span><span class="op" id="6053536">;</span>&nbsp;<span class="ident" id="6053538">i</span>&nbsp;<span class="op" id="6053540">+=</span>&nbsp;<span class="ident" id="6053543">idelta</span>&nbsp;<span class="op" id="6053550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053555">sr</span>&nbsp;<span class="op" id="6053558">:=</span>&nbsp;<span class="builtintype" id="6053561">uint32</span><span class="op" id="6053567">(</span><span class="ident" id="6053568">spix</span><span class="op" id="6053572">[</span><span class="ident" id="6053573">i</span><span class="op" id="6053574">+</span><span class="num" id="6053575">0</span><span class="op" id="6053576">]</span><span class="op" id="6053577">)</span>&nbsp;<span class="op" id="6053579">*</span>&nbsp;<span class="num" id="6053581">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053590">sg</span>&nbsp;<span class="op" id="6053593">:=</span>&nbsp;<span class="builtintype" id="6053596">uint32</span><span class="op" id="6053602">(</span><span class="ident" id="6053603">spix</span><span class="op" id="6053607">[</span><span class="ident" id="6053608">i</span><span class="op" id="6053609">+</span><span class="num" id="6053610">1</span><span class="op" id="6053611">]</span><span class="op" id="6053612">)</span>&nbsp;<span class="op" id="6053614">*</span>&nbsp;<span class="num" id="6053616">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053625">sb</span>&nbsp;<span class="op" id="6053628">:=</span>&nbsp;<span class="builtintype" id="6053631">uint32</span><span class="op" id="6053637">(</span><span class="ident" id="6053638">spix</span><span class="op" id="6053642">[</span><span class="ident" id="6053643">i</span><span class="op" id="6053644">+</span><span class="num" id="6053645">2</span><span class="op" id="6053646">]</span><span class="op" id="6053647">)</span>&nbsp;<span class="op" id="6053649">*</span>&nbsp;<span class="num" id="6053651">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053660">sa</span>&nbsp;<span class="op" id="6053663">:=</span>&nbsp;<span class="builtintype" id="6053666">uint32</span><span class="op" id="6053672">(</span><span class="ident" id="6053673">spix</span><span class="op" id="6053677">[</span><span class="ident" id="6053678">i</span><span class="op" id="6053679">+</span><span class="num" id="6053680">3</span><span class="op" id="6053681">]</span><span class="op" id="6053682">)</span>&nbsp;<span class="op" id="6053684">*</span>&nbsp;<span class="num" id="6053686">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053696">dr</span>&nbsp;<span class="op" id="6053699">:=</span>&nbsp;<span class="builtintype" id="6053702">uint32</span><span class="op" id="6053708">(</span><span class="ident" id="6053709">dpix</span><span class="op" id="6053713">[</span><span class="ident" id="6053714">i</span><span class="op" id="6053715">+</span><span class="num" id="6053716">0</span><span class="op" id="6053717">]</span><span class="op" id="6053718">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053723">dg</span>&nbsp;<span class="op" id="6053726">:=</span>&nbsp;<span class="builtintype" id="6053729">uint32</span><span class="op" id="6053735">(</span><span class="ident" id="6053736">dpix</span><span class="op" id="6053740">[</span><span class="ident" id="6053741">i</span><span class="op" id="6053742">+</span><span class="num" id="6053743">1</span><span class="op" id="6053744">]</span><span class="op" id="6053745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053750">db</span>&nbsp;<span class="op" id="6053753">:=</span>&nbsp;<span class="builtintype" id="6053756">uint32</span><span class="op" id="6053762">(</span><span class="ident" id="6053763">dpix</span><span class="op" id="6053767">[</span><span class="ident" id="6053768">i</span><span class="op" id="6053769">+</span><span class="num" id="6053770">2</span><span class="op" id="6053771">]</span><span class="op" id="6053772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053777">da</span>&nbsp;<span class="op" id="6053780">:=</span>&nbsp;<span class="builtintype" id="6053783">uint32</span><span class="op" id="6053789">(</span><span class="ident" id="6053790">dpix</span><span class="op" id="6053794">[</span><span class="ident" id="6053795">i</span><span class="op" id="6053796">+</span><span class="num" id="6053797">3</span><span class="op" id="6053798">]</span><span class="op" id="6053799">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053805">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053865">a</span>&nbsp;<span class="op" id="6053867">:=</span>&nbsp;<span class="op" id="6053870">(</span><span class="ident" id="6053871">m</span>&nbsp;<span class="op" id="6053873">-</span>&nbsp;<span class="ident" id="6053875">sa</span><span class="op" id="6053877">)</span>&nbsp;<span class="op" id="6053879">*</span>&nbsp;<span class="num" id="6053881">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053891">dpix</span><span class="op" id="6053895">[</span><span class="ident" id="6053896">i</span><span class="op" id="6053897">+</span><span class="num" id="6053898">0</span><span class="op" id="6053899">]</span>&nbsp;<span class="op" id="6053901">=</span>&nbsp;<span class="builtintype" id="6053903">uint8</span><span class="op" id="6053908">(</span><span class="op" id="6053909">(</span><span class="ident" id="6053910">dr</span><span class="op" id="6053912">*</span><span class="ident" id="6053913">a</span><span class="op" id="6053914">/</span><span class="ident" id="6053915">m</span>&nbsp;<span class="op" id="6053917">+</span>&nbsp;<span class="ident" id="6053919">sr</span><span class="op" id="6053921">)</span>&nbsp;<span class="op" id="6053923">&gt;&gt;</span>&nbsp;<span class="num" id="6053926">8</span><span class="op" id="6053927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053932">dpix</span><span class="op" id="6053936">[</span><span class="ident" id="6053937">i</span><span class="op" id="6053938">+</span><span class="num" id="6053939">1</span><span class="op" id="6053940">]</span>&nbsp;<span class="op" id="6053942">=</span>&nbsp;<span class="builtintype" id="6053944">uint8</span><span class="op" id="6053949">(</span><span class="op" id="6053950">(</span><span class="ident" id="6053951">dg</span><span class="op" id="6053953">*</span><span class="ident" id="6053954">a</span><span class="op" id="6053955">/</span><span class="ident" id="6053956">m</span>&nbsp;<span class="op" id="6053958">+</span>&nbsp;<span class="ident" id="6053960">sg</span><span class="op" id="6053962">)</span>&nbsp;<span class="op" id="6053964">&gt;&gt;</span>&nbsp;<span class="num" id="6053967">8</span><span class="op" id="6053968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053973">dpix</span><span class="op" id="6053977">[</span><span class="ident" id="6053978">i</span><span class="op" id="6053979">+</span><span class="num" id="6053980">2</span><span class="op" id="6053981">]</span>&nbsp;<span class="op" id="6053983">=</span>&nbsp;<span class="builtintype" id="6053985">uint8</span><span class="op" id="6053990">(</span><span class="op" id="6053991">(</span><span class="ident" id="6053992">db</span><span class="op" id="6053994">*</span><span class="ident" id="6053995">a</span><span class="op" id="6053996">/</span><span class="ident" id="6053997">m</span>&nbsp;<span class="op" id="6053999">+</span>&nbsp;<span class="ident" id="6054001">sb</span><span class="op" id="6054003">)</span>&nbsp;<span class="op" id="6054005">&gt;&gt;</span>&nbsp;<span class="num" id="6054008">8</span><span class="op" id="6054009">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054014">dpix</span><span class="op" id="6054018">[</span><span class="ident" id="6054019">i</span><span class="op" id="6054020">+</span><span class="num" id="6054021">3</span><span class="op" id="6054022">]</span>&nbsp;<span class="op" id="6054024">=</span>&nbsp;<span class="builtintype" id="6054026">uint8</span><span class="op" id="6054031">(</span><span class="op" id="6054032">(</span><span class="ident" id="6054033">da</span><span class="op" id="6054035">*</span><span class="ident" id="6054036">a</span><span class="op" id="6054037">/</span><span class="ident" id="6054038">m</span>&nbsp;<span class="op" id="6054040">+</span>&nbsp;<span class="ident" id="6054042">sa</span><span class="op" id="6054044">)</span>&nbsp;<span class="op" id="6054046">&gt;&gt;</span>&nbsp;<span class="num" id="6054049">8</span><span class="op" id="6054050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054058">d0</span>&nbsp;<span class="op" id="6054061">+=</span>&nbsp;<span class="ident" id="6054064">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054073">s0</span>&nbsp;<span class="op" id="6054076">+=</span>&nbsp;<span class="ident" id="6054079">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054087">}</span><br>
<span class="lineno">305</span><span class="op" id="6054089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6054092">func</span>&nbsp;<span class="ident" id="6054097">drawCopySrc</span><span class="op" id="6054108">(</span><span class="ident" id="6054109">dst</span>&nbsp;<span class="op" id="6054113">*</span><span class="ident" id="6054114">image</span><span class="op" id="6054119">.</span><span class="ident" id="6054120">RGBA</span><span class="op" id="6054124">,</span>&nbsp;<span class="ident" id="6054126">r</span>&nbsp;<span class="ident" id="6054128">image</span><span class="op" id="6054133">.</span><span class="ident" id="6054134">Rectangle</span><span class="op" id="6054143">,</span>&nbsp;<span class="ident" id="6054145">src</span>&nbsp;<span class="op" id="6054149">*</span><span class="ident" id="6054150">image</span><span class="op" id="6054155">.</span><span class="ident" id="6054156">RGBA</span><span class="op" id="6054160">,</span>&nbsp;<span class="ident" id="6054162">sp</span>&nbsp;<span class="ident" id="6054165">image</span><span class="op" id="6054170">.</span><span class="ident" id="6054171">Point</span><span class="op" id="6054176">)</span>&nbsp;<span class="op" id="6054178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054181">n</span><span class="op" id="6054182">,</span>&nbsp;<span class="ident" id="6054184">dy</span>&nbsp;<span class="op" id="6054187">:=</span>&nbsp;<span class="num" id="6054190">4</span><span class="op" id="6054191">*</span><span class="ident" id="6054192">r</span><span class="op" id="6054193">.</span><span class="ident" id="6054194">Dx</span><span class="op" id="6054196">(</span><span class="op" id="6054197">)</span><span class="op" id="6054198">,</span>&nbsp;<span class="ident" id="6054200">r</span><span class="op" id="6054201">.</span><span class="ident" id="6054202">Dy</span><span class="op" id="6054204">(</span><span class="op" id="6054205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054208">d0</span>&nbsp;<span class="op" id="6054211">:=</span>&nbsp;<span class="ident" id="6054214">dst</span><span class="op" id="6054217">.</span><span class="ident" id="6054218">PixOffset</span><span class="op" id="6054227">(</span><span class="ident" id="6054228">r</span><span class="op" id="6054229">.</span><span class="ident" id="6054230">Min</span><span class="op" id="6054233">.</span><span class="ident" id="6054234">X</span><span class="op" id="6054235">,</span>&nbsp;<span class="ident" id="6054237">r</span><span class="op" id="6054238">.</span><span class="ident" id="6054239">Min</span><span class="op" id="6054242">.</span><span class="ident" id="6054243">Y</span><span class="op" id="6054244">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054247">s0</span>&nbsp;<span class="op" id="6054250">:=</span>&nbsp;<span class="ident" id="6054253">src</span><span class="op" id="6054256">.</span><span class="ident" id="6054257">PixOffset</span><span class="op" id="6054266">(</span><span class="ident" id="6054267">sp</span><span class="op" id="6054269">.</span><span class="ident" id="6054270">X</span><span class="op" id="6054271">,</span>&nbsp;<span class="ident" id="6054273">sp</span><span class="op" id="6054275">.</span><span class="ident" id="6054276">Y</span><span class="op" id="6054277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054280">var</span>&nbsp;<span class="ident" id="6054284">ddelta</span><span class="op" id="6054290">,</span>&nbsp;<span class="ident" id="6054292">sdelta</span>&nbsp;<span class="builtintype" id="6054299">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054304">if</span>&nbsp;<span class="ident" id="6054307">r</span><span class="op" id="6054308">.</span><span class="ident" id="6054309">Min</span><span class="op" id="6054312">.</span><span class="ident" id="6054313">Y</span>&nbsp;<span class="op" id="6054315">&lt;=</span>&nbsp;<span class="ident" id="6054318">sp</span><span class="op" id="6054320">.</span><span class="ident" id="6054321">Y</span>&nbsp;<span class="op" id="6054323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054327">ddelta</span>&nbsp;<span class="op" id="6054334">=</span>&nbsp;<span class="ident" id="6054336">dst</span><span class="op" id="6054339">.</span><span class="ident" id="6054340">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054349">sdelta</span>&nbsp;<span class="op" id="6054356">=</span>&nbsp;<span class="ident" id="6054358">src</span><span class="op" id="6054361">.</span><span class="ident" id="6054362">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054370">}</span>&nbsp;<span class="keyword" id="6054372">else</span>&nbsp;<span class="op" id="6054377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054381">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054481">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054577">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054673">d0</span>&nbsp;<span class="op" id="6054676">+=</span>&nbsp;<span class="op" id="6054679">(</span><span class="ident" id="6054680">dy</span>&nbsp;<span class="op" id="6054683">-</span>&nbsp;<span class="num" id="6054685">1</span><span class="op" id="6054686">)</span>&nbsp;<span class="op" id="6054688">*</span>&nbsp;<span class="ident" id="6054690">dst</span><span class="op" id="6054693">.</span><span class="ident" id="6054694">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054703">s0</span>&nbsp;<span class="op" id="6054706">+=</span>&nbsp;<span class="op" id="6054709">(</span><span class="ident" id="6054710">dy</span>&nbsp;<span class="op" id="6054713">-</span>&nbsp;<span class="num" id="6054715">1</span><span class="op" id="6054716">)</span>&nbsp;<span class="op" id="6054718">*</span>&nbsp;<span class="ident" id="6054720">src</span><span class="op" id="6054723">.</span><span class="ident" id="6054724">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054733">ddelta</span>&nbsp;<span class="op" id="6054740">=</span>&nbsp;<span class="op" id="6054742">-</span><span class="ident" id="6054743">dst</span><span class="op" id="6054746">.</span><span class="ident" id="6054747">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054756">sdelta</span>&nbsp;<span class="op" id="6054763">=</span>&nbsp;<span class="op" id="6054765">-</span><span class="ident" id="6054766">src</span><span class="op" id="6054769">.</span><span class="ident" id="6054770">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054781">for</span>&nbsp;<span class="op" id="6054785">;</span>&nbsp;<span class="ident" id="6054787">dy</span>&nbsp;<span class="op" id="6054790">&gt;</span>&nbsp;<span class="num" id="6054792">0</span><span class="op" id="6054793">;</span>&nbsp;<span class="ident" id="6054795">dy</span><span class="op" id="6054797">--</span>&nbsp;<span class="op" id="6054800">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6054804">copy</span><span class="op" id="6054808">(</span><span class="ident" id="6054809">dst</span><span class="op" id="6054812">.</span><span class="ident" id="6054813">Pix</span><span class="op" id="6054816">[</span><span class="ident" id="6054817">d0</span><span class="op" id="6054819">:</span><span class="ident" id="6054820">d0</span><span class="op" id="6054822">+</span><span class="ident" id="6054823">n</span><span class="op" id="6054824">]</span><span class="op" id="6054825">,</span>&nbsp;<span class="ident" id="6054827">src</span><span class="op" id="6054830">.</span><span class="ident" id="6054831">Pix</span><span class="op" id="6054834">[</span><span class="ident" id="6054835">s0</span><span class="op" id="6054837">:</span><span class="ident" id="6054838">s0</span><span class="op" id="6054840">+</span><span class="ident" id="6054841">n</span><span class="op" id="6054842">]</span><span class="op" id="6054843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054847">d0</span>&nbsp;<span class="op" id="6054850">+=</span>&nbsp;<span class="ident" id="6054853">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054862">s0</span>&nbsp;<span class="op" id="6054865">+=</span>&nbsp;<span class="ident" id="6054868">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054876">}</span><br>
<span class="lineno"></span><span class="op" id="6054878">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="6054881">func</span>&nbsp;<span class="ident" id="6054886">drawNRGBAOver</span><span class="op" id="6054899">(</span><span class="ident" id="6054900">dst</span>&nbsp;<span class="op" id="6054904">*</span><span class="ident" id="6054905">image</span><span class="op" id="6054910">.</span><span class="ident" id="6054911">RGBA</span><span class="op" id="6054915">,</span>&nbsp;<span class="ident" id="6054917">r</span>&nbsp;<span class="ident" id="6054919">image</span><span class="op" id="6054924">.</span><span class="ident" id="6054925">Rectangle</span><span class="op" id="6054934">,</span>&nbsp;<span class="ident" id="6054936">src</span>&nbsp;<span class="op" id="6054940">*</span><span class="ident" id="6054941">image</span><span class="op" id="6054946">.</span><span class="ident" id="6054947">NRGBA</span><span class="op" id="6054952">,</span>&nbsp;<span class="ident" id="6054954">sp</span>&nbsp;<span class="ident" id="6054957">image</span><span class="op" id="6054962">.</span><span class="ident" id="6054963">Point</span><span class="op" id="6054968">)</span>&nbsp;<span class="op" id="6054970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054973">i0</span>&nbsp;<span class="op" id="6054976">:=</span>&nbsp;<span class="op" id="6054979">(</span><span class="ident" id="6054980">r</span><span class="op" id="6054981">.</span><span class="ident" id="6054982">Min</span><span class="op" id="6054985">.</span><span class="ident" id="6054986">X</span>&nbsp;<span class="op" id="6054988">-</span>&nbsp;<span class="ident" id="6054990">dst</span><span class="op" id="6054993">.</span><span class="ident" id="6054994">Rect</span><span class="op" id="6054998">.</span><span class="ident" id="6054999">Min</span><span class="op" id="6055002">.</span><span class="ident" id="6055003">X</span><span class="op" id="6055004">)</span>&nbsp;<span class="op" id="6055006">*</span>&nbsp;<span class="num" id="6055008">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055011">i1</span>&nbsp;<span class="op" id="6055014">:=</span>&nbsp;<span class="op" id="6055017">(</span><span class="ident" id="6055018">r</span><span class="op" id="6055019">.</span><span class="ident" id="6055020">Max</span><span class="op" id="6055023">.</span><span class="ident" id="6055024">X</span>&nbsp;<span class="op" id="6055026">-</span>&nbsp;<span class="ident" id="6055028">dst</span><span class="op" id="6055031">.</span><span class="ident" id="6055032">Rect</span><span class="op" id="6055036">.</span><span class="ident" id="6055037">Min</span><span class="op" id="6055040">.</span><span class="ident" id="6055041">X</span><span class="op" id="6055042">)</span>&nbsp;<span class="op" id="6055044">*</span>&nbsp;<span class="num" id="6055046">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055049">si0</span>&nbsp;<span class="op" id="6055053">:=</span>&nbsp;<span class="op" id="6055056">(</span><span class="ident" id="6055057">sp</span><span class="op" id="6055059">.</span><span class="ident" id="6055060">X</span>&nbsp;<span class="op" id="6055062">-</span>&nbsp;<span class="ident" id="6055064">src</span><span class="op" id="6055067">.</span><span class="ident" id="6055068">Rect</span><span class="op" id="6055072">.</span><span class="ident" id="6055073">Min</span><span class="op" id="6055076">.</span><span class="ident" id="6055077">X</span><span class="op" id="6055078">)</span>&nbsp;<span class="op" id="6055080">*</span>&nbsp;<span class="num" id="6055082">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055085">yMax</span>&nbsp;<span class="op" id="6055090">:=</span>&nbsp;<span class="ident" id="6055093">r</span><span class="op" id="6055094">.</span><span class="ident" id="6055095">Max</span><span class="op" id="6055098">.</span><span class="ident" id="6055099">Y</span>&nbsp;<span class="op" id="6055101">-</span>&nbsp;<span class="ident" id="6055103">dst</span><span class="op" id="6055106">.</span><span class="ident" id="6055107">Rect</span><span class="op" id="6055111">.</span><span class="ident" id="6055112">Min</span><span class="op" id="6055115">.</span><span class="ident" id="6055116">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055120">y</span>&nbsp;<span class="op" id="6055122">:=</span>&nbsp;<span class="ident" id="6055125">r</span><span class="op" id="6055126">.</span><span class="ident" id="6055127">Min</span><span class="op" id="6055130">.</span><span class="ident" id="6055131">Y</span>&nbsp;<span class="op" id="6055133">-</span>&nbsp;<span class="ident" id="6055135">dst</span><span class="op" id="6055138">.</span><span class="ident" id="6055139">Rect</span><span class="op" id="6055143">.</span><span class="ident" id="6055144">Min</span><span class="op" id="6055147">.</span><span class="ident" id="6055148">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055151">sy</span>&nbsp;<span class="op" id="6055154">:=</span>&nbsp;<span class="ident" id="6055157">sp</span><span class="op" id="6055159">.</span><span class="ident" id="6055160">Y</span>&nbsp;<span class="op" id="6055162">-</span>&nbsp;<span class="ident" id="6055164">src</span><span class="op" id="6055167">.</span><span class="ident" id="6055168">Rect</span><span class="op" id="6055172">.</span><span class="ident" id="6055173">Min</span><span class="op" id="6055176">.</span><span class="ident" id="6055177">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055180">for</span>&nbsp;<span class="op" id="6055184">;</span>&nbsp;<span class="ident" id="6055186">y</span>&nbsp;<span class="op" id="6055188">!=</span>&nbsp;<span class="ident" id="6055191">yMax</span><span class="op" id="6055195">;</span>&nbsp;<span class="ident" id="6055197">y</span><span class="op" id="6055198">,</span>&nbsp;<span class="ident" id="6055200">sy</span>&nbsp;<span class="op" id="6055203">=</span>&nbsp;<span class="ident" id="6055205">y</span><span class="op" id="6055206">+</span><span class="num" id="6055207">1</span><span class="op" id="6055208">,</span>&nbsp;<span class="ident" id="6055210">sy</span><span class="op" id="6055212">+</span><span class="num" id="6055213">1</span>&nbsp;<span class="op" id="6055215">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055219">dpix</span>&nbsp;<span class="op" id="6055224">:=</span>&nbsp;<span class="ident" id="6055227">dst</span><span class="op" id="6055230">.</span><span class="ident" id="6055231">Pix</span><span class="op" id="6055234">[</span><span class="ident" id="6055235">y</span><span class="op" id="6055236">*</span><span class="ident" id="6055237">dst</span><span class="op" id="6055240">.</span><span class="ident" id="6055241">Stride</span><span class="op" id="6055247">:</span><span class="op" id="6055248">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055252">spix</span>&nbsp;<span class="op" id="6055257">:=</span>&nbsp;<span class="ident" id="6055260">src</span><span class="op" id="6055263">.</span><span class="ident" id="6055264">Pix</span><span class="op" id="6055267">[</span><span class="ident" id="6055268">sy</span><span class="op" id="6055270">*</span><span class="ident" id="6055271">src</span><span class="op" id="6055274">.</span><span class="ident" id="6055275">Stride</span><span class="op" id="6055281">:</span><span class="op" id="6055282">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055287">for</span>&nbsp;<span class="ident" id="6055291">i</span><span class="op" id="6055292">,</span>&nbsp;<span class="ident" id="6055294">si</span>&nbsp;<span class="op" id="6055297">:=</span>&nbsp;<span class="ident" id="6055300">i0</span><span class="op" id="6055302">,</span>&nbsp;<span class="ident" id="6055304">si0</span><span class="op" id="6055307">;</span>&nbsp;<span class="ident" id="6055309">i</span>&nbsp;<span class="op" id="6055311">&lt;</span>&nbsp;<span class="ident" id="6055313">i1</span><span class="op" id="6055315">;</span>&nbsp;<span class="ident" id="6055317">i</span><span class="op" id="6055318">,</span>&nbsp;<span class="ident" id="6055320">si</span>&nbsp;<span class="op" id="6055323">=</span>&nbsp;<span class="ident" id="6055325">i</span><span class="op" id="6055326">+</span><span class="num" id="6055327">4</span><span class="op" id="6055328">,</span>&nbsp;<span class="ident" id="6055330">si</span><span class="op" id="6055332">+</span><span class="num" id="6055333">4</span>&nbsp;<span class="op" id="6055335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055340">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055408">sa</span>&nbsp;<span class="op" id="6055411">:=</span>&nbsp;<span class="builtintype" id="6055414">uint32</span><span class="op" id="6055420">(</span><span class="ident" id="6055421">spix</span><span class="op" id="6055425">[</span><span class="ident" id="6055426">si</span><span class="op" id="6055428">+</span><span class="num" id="6055429">3</span><span class="op" id="6055430">]</span><span class="op" id="6055431">)</span>&nbsp;<span class="op" id="6055433">*</span>&nbsp;<span class="num" id="6055435">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055444">sr</span>&nbsp;<span class="op" id="6055447">:=</span>&nbsp;<span class="builtintype" id="6055450">uint32</span><span class="op" id="6055456">(</span><span class="ident" id="6055457">spix</span><span class="op" id="6055461">[</span><span class="ident" id="6055462">si</span><span class="op" id="6055464">+</span><span class="num" id="6055465">0</span><span class="op" id="6055466">]</span><span class="op" id="6055467">)</span>&nbsp;<span class="op" id="6055469">*</span>&nbsp;<span class="ident" id="6055471">sa</span>&nbsp;<span class="op" id="6055474">/</span>&nbsp;<span class="num" id="6055476">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055484">sg</span>&nbsp;<span class="op" id="6055487">:=</span>&nbsp;<span class="builtintype" id="6055490">uint32</span><span class="op" id="6055496">(</span><span class="ident" id="6055497">spix</span><span class="op" id="6055501">[</span><span class="ident" id="6055502">si</span><span class="op" id="6055504">+</span><span class="num" id="6055505">1</span><span class="op" id="6055506">]</span><span class="op" id="6055507">)</span>&nbsp;<span class="op" id="6055509">*</span>&nbsp;<span class="ident" id="6055511">sa</span>&nbsp;<span class="op" id="6055514">/</span>&nbsp;<span class="num" id="6055516">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055524">sb</span>&nbsp;<span class="op" id="6055527">:=</span>&nbsp;<span class="builtintype" id="6055530">uint32</span><span class="op" id="6055536">(</span><span class="ident" id="6055537">spix</span><span class="op" id="6055541">[</span><span class="ident" id="6055542">si</span><span class="op" id="6055544">+</span><span class="num" id="6055545">2</span><span class="op" id="6055546">]</span><span class="op" id="6055547">)</span>&nbsp;<span class="op" id="6055549">*</span>&nbsp;<span class="ident" id="6055551">sa</span>&nbsp;<span class="op" id="6055554">/</span>&nbsp;<span class="num" id="6055556">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055565">dr</span>&nbsp;<span class="op" id="6055568">:=</span>&nbsp;<span class="builtintype" id="6055571">uint32</span><span class="op" id="6055577">(</span><span class="ident" id="6055578">dpix</span><span class="op" id="6055582">[</span><span class="ident" id="6055583">i</span><span class="op" id="6055584">+</span><span class="num" id="6055585">0</span><span class="op" id="6055586">]</span><span class="op" id="6055587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055592">dg</span>&nbsp;<span class="op" id="6055595">:=</span>&nbsp;<span class="builtintype" id="6055598">uint32</span><span class="op" id="6055604">(</span><span class="ident" id="6055605">dpix</span><span class="op" id="6055609">[</span><span class="ident" id="6055610">i</span><span class="op" id="6055611">+</span><span class="num" id="6055612">1</span><span class="op" id="6055613">]</span><span class="op" id="6055614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055619">db</span>&nbsp;<span class="op" id="6055622">:=</span>&nbsp;<span class="builtintype" id="6055625">uint32</span><span class="op" id="6055631">(</span><span class="ident" id="6055632">dpix</span><span class="op" id="6055636">[</span><span class="ident" id="6055637">i</span><span class="op" id="6055638">+</span><span class="num" id="6055639">2</span><span class="op" id="6055640">]</span><span class="op" id="6055641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055646">da</span>&nbsp;<span class="op" id="6055649">:=</span>&nbsp;<span class="builtintype" id="6055652">uint32</span><span class="op" id="6055658">(</span><span class="ident" id="6055659">dpix</span><span class="op" id="6055663">[</span><span class="ident" id="6055664">i</span><span class="op" id="6055665">+</span><span class="num" id="6055666">3</span><span class="op" id="6055667">]</span><span class="op" id="6055668">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055674">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055734">a</span>&nbsp;<span class="op" id="6055736">:=</span>&nbsp;<span class="op" id="6055739">(</span><span class="ident" id="6055740">m</span>&nbsp;<span class="op" id="6055742">-</span>&nbsp;<span class="ident" id="6055744">sa</span><span class="op" id="6055746">)</span>&nbsp;<span class="op" id="6055748">*</span>&nbsp;<span class="num" id="6055750">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055760">dpix</span><span class="op" id="6055764">[</span><span class="ident" id="6055765">i</span><span class="op" id="6055766">+</span><span class="num" id="6055767">0</span><span class="op" id="6055768">]</span>&nbsp;<span class="op" id="6055770">=</span>&nbsp;<span class="builtintype" id="6055772">uint8</span><span class="op" id="6055777">(</span><span class="op" id="6055778">(</span><span class="ident" id="6055779">dr</span><span class="op" id="6055781">*</span><span class="ident" id="6055782">a</span><span class="op" id="6055783">/</span><span class="ident" id="6055784">m</span>&nbsp;<span class="op" id="6055786">+</span>&nbsp;<span class="ident" id="6055788">sr</span><span class="op" id="6055790">)</span>&nbsp;<span class="op" id="6055792">&gt;&gt;</span>&nbsp;<span class="num" id="6055795">8</span><span class="op" id="6055796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055801">dpix</span><span class="op" id="6055805">[</span><span class="ident" id="6055806">i</span><span class="op" id="6055807">+</span><span class="num" id="6055808">1</span><span class="op" id="6055809">]</span>&nbsp;<span class="op" id="6055811">=</span>&nbsp;<span class="builtintype" id="6055813">uint8</span><span class="op" id="6055818">(</span><span class="op" id="6055819">(</span><span class="ident" id="6055820">dg</span><span class="op" id="6055822">*</span><span class="ident" id="6055823">a</span><span class="op" id="6055824">/</span><span class="ident" id="6055825">m</span>&nbsp;<span class="op" id="6055827">+</span>&nbsp;<span class="ident" id="6055829">sg</span><span class="op" id="6055831">)</span>&nbsp;<span class="op" id="6055833">&gt;&gt;</span>&nbsp;<span class="num" id="6055836">8</span><span class="op" id="6055837">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055842">dpix</span><span class="op" id="6055846">[</span><span class="ident" id="6055847">i</span><span class="op" id="6055848">+</span><span class="num" id="6055849">2</span><span class="op" id="6055850">]</span>&nbsp;<span class="op" id="6055852">=</span>&nbsp;<span class="builtintype" id="6055854">uint8</span><span class="op" id="6055859">(</span><span class="op" id="6055860">(</span><span class="ident" id="6055861">db</span><span class="op" id="6055863">*</span><span class="ident" id="6055864">a</span><span class="op" id="6055865">/</span><span class="ident" id="6055866">m</span>&nbsp;<span class="op" id="6055868">+</span>&nbsp;<span class="ident" id="6055870">sb</span><span class="op" id="6055872">)</span>&nbsp;<span class="op" id="6055874">&gt;&gt;</span>&nbsp;<span class="num" id="6055877">8</span><span class="op" id="6055878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055883">dpix</span><span class="op" id="6055887">[</span><span class="ident" id="6055888">i</span><span class="op" id="6055889">+</span><span class="num" id="6055890">3</span><span class="op" id="6055891">]</span>&nbsp;<span class="op" id="6055893">=</span>&nbsp;<span class="builtintype" id="6055895">uint8</span><span class="op" id="6055900">(</span><span class="op" id="6055901">(</span><span class="ident" id="6055902">da</span><span class="op" id="6055904">*</span><span class="ident" id="6055905">a</span><span class="op" id="6055906">/</span><span class="ident" id="6055907">m</span>&nbsp;<span class="op" id="6055909">+</span>&nbsp;<span class="ident" id="6055911">sa</span><span class="op" id="6055913">)</span>&nbsp;<span class="op" id="6055915">&gt;&gt;</span>&nbsp;<span class="num" id="6055918">8</span><span class="op" id="6055919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055926">}</span><br>
<span class="lineno"></span><span class="op" id="6055928">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="6055931">func</span>&nbsp;<span class="ident" id="6055936">drawNRGBASrc</span><span class="op" id="6055948">(</span><span class="ident" id="6055949">dst</span>&nbsp;<span class="op" id="6055953">*</span><span class="ident" id="6055954">image</span><span class="op" id="6055959">.</span><span class="ident" id="6055960">RGBA</span><span class="op" id="6055964">,</span>&nbsp;<span class="ident" id="6055966">r</span>&nbsp;<span class="ident" id="6055968">image</span><span class="op" id="6055973">.</span><span class="ident" id="6055974">Rectangle</span><span class="op" id="6055983">,</span>&nbsp;<span class="ident" id="6055985">src</span>&nbsp;<span class="op" id="6055989">*</span><span class="ident" id="6055990">image</span><span class="op" id="6055995">.</span><span class="ident" id="6055996">NRGBA</span><span class="op" id="6056001">,</span>&nbsp;<span class="ident" id="6056003">sp</span>&nbsp;<span class="ident" id="6056006">image</span><span class="op" id="6056011">.</span><span class="ident" id="6056012">Point</span><span class="op" id="6056017">)</span>&nbsp;<span class="op" id="6056019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056022">i0</span>&nbsp;<span class="op" id="6056025">:=</span>&nbsp;<span class="op" id="6056028">(</span><span class="ident" id="6056029">r</span><span class="op" id="6056030">.</span><span class="ident" id="6056031">Min</span><span class="op" id="6056034">.</span><span class="ident" id="6056035">X</span>&nbsp;<span class="op" id="6056037">-</span>&nbsp;<span class="ident" id="6056039">dst</span><span class="op" id="6056042">.</span><span class="ident" id="6056043">Rect</span><span class="op" id="6056047">.</span><span class="ident" id="6056048">Min</span><span class="op" id="6056051">.</span><span class="ident" id="6056052">X</span><span class="op" id="6056053">)</span>&nbsp;<span class="op" id="6056055">*</span>&nbsp;<span class="num" id="6056057">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056060">i1</span>&nbsp;<span class="op" id="6056063">:=</span>&nbsp;<span class="op" id="6056066">(</span><span class="ident" id="6056067">r</span><span class="op" id="6056068">.</span><span class="ident" id="6056069">Max</span><span class="op" id="6056072">.</span><span class="ident" id="6056073">X</span>&nbsp;<span class="op" id="6056075">-</span>&nbsp;<span class="ident" id="6056077">dst</span><span class="op" id="6056080">.</span><span class="ident" id="6056081">Rect</span><span class="op" id="6056085">.</span><span class="ident" id="6056086">Min</span><span class="op" id="6056089">.</span><span class="ident" id="6056090">X</span><span class="op" id="6056091">)</span>&nbsp;<span class="op" id="6056093">*</span>&nbsp;<span class="num" id="6056095">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056098">si0</span>&nbsp;<span class="op" id="6056102">:=</span>&nbsp;<span class="op" id="6056105">(</span><span class="ident" id="6056106">sp</span><span class="op" id="6056108">.</span><span class="ident" id="6056109">X</span>&nbsp;<span class="op" id="6056111">-</span>&nbsp;<span class="ident" id="6056113">src</span><span class="op" id="6056116">.</span><span class="ident" id="6056117">Rect</span><span class="op" id="6056121">.</span><span class="ident" id="6056122">Min</span><span class="op" id="6056125">.</span><span class="ident" id="6056126">X</span><span class="op" id="6056127">)</span>&nbsp;<span class="op" id="6056129">*</span>&nbsp;<span class="num" id="6056131">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056134">yMax</span>&nbsp;<span class="op" id="6056139">:=</span>&nbsp;<span class="ident" id="6056142">r</span><span class="op" id="6056143">.</span><span class="ident" id="6056144">Max</span><span class="op" id="6056147">.</span><span class="ident" id="6056148">Y</span>&nbsp;<span class="op" id="6056150">-</span>&nbsp;<span class="ident" id="6056152">dst</span><span class="op" id="6056155">.</span><span class="ident" id="6056156">Rect</span><span class="op" id="6056160">.</span><span class="ident" id="6056161">Min</span><span class="op" id="6056164">.</span><span class="ident" id="6056165">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056169">y</span>&nbsp;<span class="op" id="6056171">:=</span>&nbsp;<span class="ident" id="6056174">r</span><span class="op" id="6056175">.</span><span class="ident" id="6056176">Min</span><span class="op" id="6056179">.</span><span class="ident" id="6056180">Y</span>&nbsp;<span class="op" id="6056182">-</span>&nbsp;<span class="ident" id="6056184">dst</span><span class="op" id="6056187">.</span><span class="ident" id="6056188">Rect</span><span class="op" id="6056192">.</span><span class="ident" id="6056193">Min</span><span class="op" id="6056196">.</span><span class="ident" id="6056197">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056200">sy</span>&nbsp;<span class="op" id="6056203">:=</span>&nbsp;<span class="ident" id="6056206">sp</span><span class="op" id="6056208">.</span><span class="ident" id="6056209">Y</span>&nbsp;<span class="op" id="6056211">-</span>&nbsp;<span class="ident" id="6056213">src</span><span class="op" id="6056216">.</span><span class="ident" id="6056217">Rect</span><span class="op" id="6056221">.</span><span class="ident" id="6056222">Min</span><span class="op" id="6056225">.</span><span class="ident" id="6056226">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056229">for</span>&nbsp;<span class="op" id="6056233">;</span>&nbsp;<span class="ident" id="6056235">y</span>&nbsp;<span class="op" id="6056237">!=</span>&nbsp;<span class="ident" id="6056240">yMax</span><span class="op" id="6056244">;</span>&nbsp;<span class="ident" id="6056246">y</span><span class="op" id="6056247">,</span>&nbsp;<span class="ident" id="6056249">sy</span>&nbsp;<span class="op" id="6056252">=</span>&nbsp;<span class="ident" id="6056254">y</span><span class="op" id="6056255">+</span><span class="num" id="6056256">1</span><span class="op" id="6056257">,</span>&nbsp;<span class="ident" id="6056259">sy</span><span class="op" id="6056261">+</span><span class="num" id="6056262">1</span>&nbsp;<span class="op" id="6056264">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056268">dpix</span>&nbsp;<span class="op" id="6056273">:=</span>&nbsp;<span class="ident" id="6056276">dst</span><span class="op" id="6056279">.</span><span class="ident" id="6056280">Pix</span><span class="op" id="6056283">[</span><span class="ident" id="6056284">y</span><span class="op" id="6056285">*</span><span class="ident" id="6056286">dst</span><span class="op" id="6056289">.</span><span class="ident" id="6056290">Stride</span><span class="op" id="6056296">:</span><span class="op" id="6056297">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056301">spix</span>&nbsp;<span class="op" id="6056306">:=</span>&nbsp;<span class="ident" id="6056309">src</span><span class="op" id="6056312">.</span><span class="ident" id="6056313">Pix</span><span class="op" id="6056316">[</span><span class="ident" id="6056317">sy</span><span class="op" id="6056319">*</span><span class="ident" id="6056320">src</span><span class="op" id="6056323">.</span><span class="ident" id="6056324">Stride</span><span class="op" id="6056330">:</span><span class="op" id="6056331">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056336">for</span>&nbsp;<span class="ident" id="6056340">i</span><span class="op" id="6056341">,</span>&nbsp;<span class="ident" id="6056343">si</span>&nbsp;<span class="op" id="6056346">:=</span>&nbsp;<span class="ident" id="6056349">i0</span><span class="op" id="6056351">,</span>&nbsp;<span class="ident" id="6056353">si0</span><span class="op" id="6056356">;</span>&nbsp;<span class="ident" id="6056358">i</span>&nbsp;<span class="op" id="6056360">&lt;</span>&nbsp;<span class="ident" id="6056362">i1</span><span class="op" id="6056364">;</span>&nbsp;<span class="ident" id="6056366">i</span><span class="op" id="6056367">,</span>&nbsp;<span class="ident" id="6056369">si</span>&nbsp;<span class="op" id="6056372">=</span>&nbsp;<span class="ident" id="6056374">i</span><span class="op" id="6056375">+</span><span class="num" id="6056376">4</span><span class="op" id="6056377">,</span>&nbsp;<span class="ident" id="6056379">si</span><span class="op" id="6056381">+</span><span class="num" id="6056382">4</span>&nbsp;<span class="op" id="6056384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056389">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056457">sa</span>&nbsp;<span class="op" id="6056460">:=</span>&nbsp;<span class="builtintype" id="6056463">uint32</span><span class="op" id="6056469">(</span><span class="ident" id="6056470">spix</span><span class="op" id="6056474">[</span><span class="ident" id="6056475">si</span><span class="op" id="6056477">+</span><span class="num" id="6056478">3</span><span class="op" id="6056479">]</span><span class="op" id="6056480">)</span>&nbsp;<span class="op" id="6056482">*</span>&nbsp;<span class="num" id="6056484">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056493">sr</span>&nbsp;<span class="op" id="6056496">:=</span>&nbsp;<span class="builtintype" id="6056499">uint32</span><span class="op" id="6056505">(</span><span class="ident" id="6056506">spix</span><span class="op" id="6056510">[</span><span class="ident" id="6056511">si</span><span class="op" id="6056513">+</span><span class="num" id="6056514">0</span><span class="op" id="6056515">]</span><span class="op" id="6056516">)</span>&nbsp;<span class="op" id="6056518">*</span>&nbsp;<span class="ident" id="6056520">sa</span>&nbsp;<span class="op" id="6056523">/</span>&nbsp;<span class="num" id="6056525">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056533">sg</span>&nbsp;<span class="op" id="6056536">:=</span>&nbsp;<span class="builtintype" id="6056539">uint32</span><span class="op" id="6056545">(</span><span class="ident" id="6056546">spix</span><span class="op" id="6056550">[</span><span class="ident" id="6056551">si</span><span class="op" id="6056553">+</span><span class="num" id="6056554">1</span><span class="op" id="6056555">]</span><span class="op" id="6056556">)</span>&nbsp;<span class="op" id="6056558">*</span>&nbsp;<span class="ident" id="6056560">sa</span>&nbsp;<span class="op" id="6056563">/</span>&nbsp;<span class="num" id="6056565">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056573">sb</span>&nbsp;<span class="op" id="6056576">:=</span>&nbsp;<span class="builtintype" id="6056579">uint32</span><span class="op" id="6056585">(</span><span class="ident" id="6056586">spix</span><span class="op" id="6056590">[</span><span class="ident" id="6056591">si</span><span class="op" id="6056593">+</span><span class="num" id="6056594">2</span><span class="op" id="6056595">]</span><span class="op" id="6056596">)</span>&nbsp;<span class="op" id="6056598">*</span>&nbsp;<span class="ident" id="6056600">sa</span>&nbsp;<span class="op" id="6056603">/</span>&nbsp;<span class="num" id="6056605">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056614">dpix</span><span class="op" id="6056618">[</span><span class="ident" id="6056619">i</span><span class="op" id="6056620">+</span><span class="num" id="6056621">0</span><span class="op" id="6056622">]</span>&nbsp;<span class="op" id="6056624">=</span>&nbsp;<span class="builtintype" id="6056626">uint8</span><span class="op" id="6056631">(</span><span class="ident" id="6056632">sr</span>&nbsp;<span class="op" id="6056635">&gt;&gt;</span>&nbsp;<span class="num" id="6056638">8</span><span class="op" id="6056639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056644">dpix</span><span class="op" id="6056648">[</span><span class="ident" id="6056649">i</span><span class="op" id="6056650">+</span><span class="num" id="6056651">1</span><span class="op" id="6056652">]</span>&nbsp;<span class="op" id="6056654">=</span>&nbsp;<span class="builtintype" id="6056656">uint8</span><span class="op" id="6056661">(</span><span class="ident" id="6056662">sg</span>&nbsp;<span class="op" id="6056665">&gt;&gt;</span>&nbsp;<span class="num" id="6056668">8</span><span class="op" id="6056669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056674">dpix</span><span class="op" id="6056678">[</span><span class="ident" id="6056679">i</span><span class="op" id="6056680">+</span><span class="num" id="6056681">2</span><span class="op" id="6056682">]</span>&nbsp;<span class="op" id="6056684">=</span>&nbsp;<span class="builtintype" id="6056686">uint8</span><span class="op" id="6056691">(</span><span class="ident" id="6056692">sb</span>&nbsp;<span class="op" id="6056695">&gt;&gt;</span>&nbsp;<span class="num" id="6056698">8</span><span class="op" id="6056699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056704">dpix</span><span class="op" id="6056708">[</span><span class="ident" id="6056709">i</span><span class="op" id="6056710">+</span><span class="num" id="6056711">3</span><span class="op" id="6056712">]</span>&nbsp;<span class="op" id="6056714">=</span>&nbsp;<span class="builtintype" id="6056716">uint8</span><span class="op" id="6056721">(</span><span class="ident" id="6056722">sa</span>&nbsp;<span class="op" id="6056725">&gt;&gt;</span>&nbsp;<span class="num" id="6056728">8</span><span class="op" id="6056729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056733">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056736">}</span><br>
<span class="lineno"></span><span class="op" id="6056738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6056741">func</span>&nbsp;<span class="ident" id="6056746">drawYCbCr</span><span class="op" id="6056755">(</span><span class="ident" id="6056756">dst</span>&nbsp;<span class="op" id="6056760">*</span><span class="ident" id="6056761">image</span><span class="op" id="6056766">.</span><span class="ident" id="6056767">RGBA</span><span class="op" id="6056771">,</span>&nbsp;<span class="ident" id="6056773">r</span>&nbsp;<span class="ident" id="6056775">image</span><span class="op" id="6056780">.</span><span class="ident" id="6056781">Rectangle</span><span class="op" id="6056790">,</span>&nbsp;<span class="ident" id="6056792">src</span>&nbsp;<span class="op" id="6056796">*</span><span class="ident" id="6056797">image</span><span class="op" id="6056802">.</span><span class="ident" id="6056803">YCbCr</span><span class="op" id="6056808">,</span>&nbsp;<span class="ident" id="6056810">sp</span>&nbsp;<span class="ident" id="6056813">image</span><span class="op" id="6056818">.</span><span class="ident" id="6056819">Point</span><span class="op" id="6056824">)</span>&nbsp;<span class="op" id="6056826">(</span><span class="ident" id="6056827">ok</span>&nbsp;<span class="builtintype" id="6056830">bool</span><span class="op" id="6056834">)</span>&nbsp;<span class="op" id="6056836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056839">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056919">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056982">x0</span>&nbsp;<span class="op" id="6056985">:=</span>&nbsp;<span class="op" id="6056988">(</span><span class="ident" id="6056989">r</span><span class="op" id="6056990">.</span><span class="ident" id="6056991">Min</span><span class="op" id="6056994">.</span><span class="ident" id="6056995">X</span>&nbsp;<span class="op" id="6056997">-</span>&nbsp;<span class="ident" id="6056999">dst</span><span class="op" id="6057002">.</span><span class="ident" id="6057003">Rect</span><span class="op" id="6057007">.</span><span class="ident" id="6057008">Min</span><span class="op" id="6057011">.</span><span class="ident" id="6057012">X</span><span class="op" id="6057013">)</span>&nbsp;<span class="op" id="6057015">*</span>&nbsp;<span class="num" id="6057017">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057020">x1</span>&nbsp;<span class="op" id="6057023">:=</span>&nbsp;<span class="op" id="6057026">(</span><span class="ident" id="6057027">r</span><span class="op" id="6057028">.</span><span class="ident" id="6057029">Max</span><span class="op" id="6057032">.</span><span class="ident" id="6057033">X</span>&nbsp;<span class="op" id="6057035">-</span>&nbsp;<span class="ident" id="6057037">dst</span><span class="op" id="6057040">.</span><span class="ident" id="6057041">Rect</span><span class="op" id="6057045">.</span><span class="ident" id="6057046">Min</span><span class="op" id="6057049">.</span><span class="ident" id="6057050">X</span><span class="op" id="6057051">)</span>&nbsp;<span class="op" id="6057053">*</span>&nbsp;<span class="num" id="6057055">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057058">y0</span>&nbsp;<span class="op" id="6057061">:=</span>&nbsp;<span class="ident" id="6057064">r</span><span class="op" id="6057065">.</span><span class="ident" id="6057066">Min</span><span class="op" id="6057069">.</span><span class="ident" id="6057070">Y</span>&nbsp;<span class="op" id="6057072">-</span>&nbsp;<span class="ident" id="6057074">dst</span><span class="op" id="6057077">.</span><span class="ident" id="6057078">Rect</span><span class="op" id="6057082">.</span><span class="ident" id="6057083">Min</span><span class="op" id="6057086">.</span><span class="ident" id="6057087">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057090">y1</span>&nbsp;<span class="op" id="6057093">:=</span>&nbsp;<span class="ident" id="6057096">r</span><span class="op" id="6057097">.</span><span class="ident" id="6057098">Max</span><span class="op" id="6057101">.</span><span class="ident" id="6057102">Y</span>&nbsp;<span class="op" id="6057104">-</span>&nbsp;<span class="ident" id="6057106">dst</span><span class="op" id="6057109">.</span><span class="ident" id="6057110">Rect</span><span class="op" id="6057114">.</span><span class="ident" id="6057115">Min</span><span class="op" id="6057118">.</span><span class="ident" id="6057119">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057122">switch</span>&nbsp;<span class="ident" id="6057129">src</span><span class="op" id="6057132">.</span><span class="ident" id="6057133">SubsampleRatio</span>&nbsp;<span class="op" id="6057148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057151">case</span>&nbsp;<span class="ident" id="6057156">image</span><span class="op" id="6057161">.</span><span class="ident" id="6057162">YCbCrSubsampleRatio444</span><span class="op" id="6057184">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057188">for</span>&nbsp;<span class="ident" id="6057192">y</span><span class="op" id="6057193">,</span>&nbsp;<span class="ident" id="6057195">sy</span>&nbsp;<span class="op" id="6057198">:=</span>&nbsp;<span class="ident" id="6057201">y0</span><span class="op" id="6057203">,</span>&nbsp;<span class="ident" id="6057205">sp</span><span class="op" id="6057207">.</span><span class="ident" id="6057208">Y</span><span class="op" id="6057209">;</span>&nbsp;<span class="ident" id="6057211">y</span>&nbsp;<span class="op" id="6057213">!=</span>&nbsp;<span class="ident" id="6057216">y1</span><span class="op" id="6057218">;</span>&nbsp;<span class="ident" id="6057220">y</span><span class="op" id="6057221">,</span>&nbsp;<span class="ident" id="6057223">sy</span>&nbsp;<span class="op" id="6057226">=</span>&nbsp;<span class="ident" id="6057228">y</span><span class="op" id="6057229">+</span><span class="num" id="6057230">1</span><span class="op" id="6057231">,</span>&nbsp;<span class="ident" id="6057233">sy</span><span class="op" id="6057235">+</span><span class="num" id="6057236">1</span>&nbsp;<span class="op" id="6057238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057243">dpix</span>&nbsp;<span class="op" id="6057248">:=</span>&nbsp;<span class="ident" id="6057251">dst</span><span class="op" id="6057254">.</span><span class="ident" id="6057255">Pix</span><span class="op" id="6057258">[</span><span class="ident" id="6057259">y</span><span class="op" id="6057260">*</span><span class="ident" id="6057261">dst</span><span class="op" id="6057264">.</span><span class="ident" id="6057265">Stride</span><span class="op" id="6057271">:</span><span class="op" id="6057272">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057277">yi</span>&nbsp;<span class="op" id="6057280">:=</span>&nbsp;<span class="op" id="6057283">(</span><span class="ident" id="6057284">sy</span><span class="op" id="6057286">-</span><span class="ident" id="6057287">src</span><span class="op" id="6057290">.</span><span class="ident" id="6057291">Rect</span><span class="op" id="6057295">.</span><span class="ident" id="6057296">Min</span><span class="op" id="6057299">.</span><span class="ident" id="6057300">Y</span><span class="op" id="6057301">)</span><span class="op" id="6057302">*</span><span class="ident" id="6057303">src</span><span class="op" id="6057306">.</span><span class="ident" id="6057307">YStride</span>&nbsp;<span class="op" id="6057315">+</span>&nbsp;<span class="op" id="6057317">(</span><span class="ident" id="6057318">sp</span><span class="op" id="6057320">.</span><span class="ident" id="6057321">X</span>&nbsp;<span class="op" id="6057323">-</span>&nbsp;<span class="ident" id="6057325">src</span><span class="op" id="6057328">.</span><span class="ident" id="6057329">Rect</span><span class="op" id="6057333">.</span><span class="ident" id="6057334">Min</span><span class="op" id="6057337">.</span><span class="ident" id="6057338">X</span><span class="op" id="6057339">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057344">ci</span>&nbsp;<span class="op" id="6057347">:=</span>&nbsp;<span class="op" id="6057350">(</span><span class="ident" id="6057351">sy</span><span class="op" id="6057353">-</span><span class="ident" id="6057354">src</span><span class="op" id="6057357">.</span><span class="ident" id="6057358">Rect</span><span class="op" id="6057362">.</span><span class="ident" id="6057363">Min</span><span class="op" id="6057366">.</span><span class="ident" id="6057367">Y</span><span class="op" id="6057368">)</span><span class="op" id="6057369">*</span><span class="ident" id="6057370">src</span><span class="op" id="6057373">.</span><span class="ident" id="6057374">CStride</span>&nbsp;<span class="op" id="6057382">+</span>&nbsp;<span class="op" id="6057384">(</span><span class="ident" id="6057385">sp</span><span class="op" id="6057387">.</span><span class="ident" id="6057388">X</span>&nbsp;<span class="op" id="6057390">-</span>&nbsp;<span class="ident" id="6057392">src</span><span class="op" id="6057395">.</span><span class="ident" id="6057396">Rect</span><span class="op" id="6057400">.</span><span class="ident" id="6057401">Min</span><span class="op" id="6057404">.</span><span class="ident" id="6057405">X</span><span class="op" id="6057406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057411">for</span>&nbsp;<span class="ident" id="6057415">x</span>&nbsp;<span class="op" id="6057417">:=</span>&nbsp;<span class="ident" id="6057420">x0</span><span class="op" id="6057422">;</span>&nbsp;<span class="ident" id="6057424">x</span>&nbsp;<span class="op" id="6057426">!=</span>&nbsp;<span class="ident" id="6057429">x1</span><span class="op" id="6057431">;</span>&nbsp;<span class="ident" id="6057433">x</span><span class="op" id="6057434">,</span>&nbsp;<span class="ident" id="6057436">yi</span><span class="op" id="6057438">,</span>&nbsp;<span class="ident" id="6057440">ci</span>&nbsp;<span class="op" id="6057443">=</span>&nbsp;<span class="ident" id="6057445">x</span><span class="op" id="6057446">+</span><span class="num" id="6057447">4</span><span class="op" id="6057448">,</span>&nbsp;<span class="ident" id="6057450">yi</span><span class="op" id="6057452">+</span><span class="num" id="6057453">1</span><span class="op" id="6057454">,</span>&nbsp;<span class="ident" id="6057456">ci</span><span class="op" id="6057458">+</span><span class="num" id="6057459">1</span>&nbsp;<span class="op" id="6057461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057467">rr</span><span class="op" id="6057469">,</span>&nbsp;<span class="ident" id="6057471">gg</span><span class="op" id="6057473">,</span>&nbsp;<span class="ident" id="6057475">bb</span>&nbsp;<span class="op" id="6057478">:=</span>&nbsp;<span class="ident" id="6057481">color</span><span class="op" id="6057486">.</span><span class="ident" id="6057487">YCbCrToRGB</span><span class="op" id="6057497">(</span><span class="ident" id="6057498">src</span><span class="op" id="6057501">.</span><span class="ident" id="6057502">Y</span><span class="op" id="6057503">[</span><span class="ident" id="6057504">yi</span><span class="op" id="6057506">]</span><span class="op" id="6057507">,</span>&nbsp;<span class="ident" id="6057509">src</span><span class="op" id="6057512">.</span><span class="ident" id="6057513">Cb</span><span class="op" id="6057515">[</span><span class="ident" id="6057516">ci</span><span class="op" id="6057518">]</span><span class="op" id="6057519">,</span>&nbsp;<span class="ident" id="6057521">src</span><span class="op" id="6057524">.</span><span class="ident" id="6057525">Cr</span><span class="op" id="6057527">[</span><span class="ident" id="6057528">ci</span><span class="op" id="6057530">]</span><span class="op" id="6057531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057537">dpix</span><span class="op" id="6057541">[</span><span class="ident" id="6057542">x</span><span class="op" id="6057543">+</span><span class="num" id="6057544">0</span><span class="op" id="6057545">]</span>&nbsp;<span class="op" id="6057547">=</span>&nbsp;<span class="ident" id="6057549">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057556">dpix</span><span class="op" id="6057560">[</span><span class="ident" id="6057561">x</span><span class="op" id="6057562">+</span><span class="num" id="6057563">1</span><span class="op" id="6057564">]</span>&nbsp;<span class="op" id="6057566">=</span>&nbsp;<span class="ident" id="6057568">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057575">dpix</span><span class="op" id="6057579">[</span><span class="ident" id="6057580">x</span><span class="op" id="6057581">+</span><span class="num" id="6057582">2</span><span class="op" id="6057583">]</span>&nbsp;<span class="op" id="6057585">=</span>&nbsp;<span class="ident" id="6057587">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057594">dpix</span><span class="op" id="6057598">[</span><span class="ident" id="6057599">x</span><span class="op" id="6057600">+</span><span class="num" id="6057601">3</span><span class="op" id="6057602">]</span>&nbsp;<span class="op" id="6057604">=</span>&nbsp;<span class="num" id="6057606">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057620">case</span>&nbsp;<span class="ident" id="6057625">image</span><span class="op" id="6057630">.</span><span class="ident" id="6057631">YCbCrSubsampleRatio422</span><span class="op" id="6057653">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057657">for</span>&nbsp;<span class="ident" id="6057661">y</span><span class="op" id="6057662">,</span>&nbsp;<span class="ident" id="6057664">sy</span>&nbsp;<span class="op" id="6057667">:=</span>&nbsp;<span class="ident" id="6057670">y0</span><span class="op" id="6057672">,</span>&nbsp;<span class="ident" id="6057674">sp</span><span class="op" id="6057676">.</span><span class="ident" id="6057677">Y</span><span class="op" id="6057678">;</span>&nbsp;<span class="ident" id="6057680">y</span>&nbsp;<span class="op" id="6057682">!=</span>&nbsp;<span class="ident" id="6057685">y1</span><span class="op" id="6057687">;</span>&nbsp;<span class="ident" id="6057689">y</span><span class="op" id="6057690">,</span>&nbsp;<span class="ident" id="6057692">sy</span>&nbsp;<span class="op" id="6057695">=</span>&nbsp;<span class="ident" id="6057697">y</span><span class="op" id="6057698">+</span><span class="num" id="6057699">1</span><span class="op" id="6057700">,</span>&nbsp;<span class="ident" id="6057702">sy</span><span class="op" id="6057704">+</span><span class="num" id="6057705">1</span>&nbsp;<span class="op" id="6057707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057712">dpix</span>&nbsp;<span class="op" id="6057717">:=</span>&nbsp;<span class="ident" id="6057720">dst</span><span class="op" id="6057723">.</span><span class="ident" id="6057724">Pix</span><span class="op" id="6057727">[</span><span class="ident" id="6057728">y</span><span class="op" id="6057729">*</span><span class="ident" id="6057730">dst</span><span class="op" id="6057733">.</span><span class="ident" id="6057734">Stride</span><span class="op" id="6057740">:</span><span class="op" id="6057741">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057746">yi</span>&nbsp;<span class="op" id="6057749">:=</span>&nbsp;<span class="op" id="6057752">(</span><span class="ident" id="6057753">sy</span><span class="op" id="6057755">-</span><span class="ident" id="6057756">src</span><span class="op" id="6057759">.</span><span class="ident" id="6057760">Rect</span><span class="op" id="6057764">.</span><span class="ident" id="6057765">Min</span><span class="op" id="6057768">.</span><span class="ident" id="6057769">Y</span><span class="op" id="6057770">)</span><span class="op" id="6057771">*</span><span class="ident" id="6057772">src</span><span class="op" id="6057775">.</span><span class="ident" id="6057776">YStride</span>&nbsp;<span class="op" id="6057784">+</span>&nbsp;<span class="op" id="6057786">(</span><span class="ident" id="6057787">sp</span><span class="op" id="6057789">.</span><span class="ident" id="6057790">X</span>&nbsp;<span class="op" id="6057792">-</span>&nbsp;<span class="ident" id="6057794">src</span><span class="op" id="6057797">.</span><span class="ident" id="6057798">Rect</span><span class="op" id="6057802">.</span><span class="ident" id="6057803">Min</span><span class="op" id="6057806">.</span><span class="ident" id="6057807">X</span><span class="op" id="6057808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057813">ciBase</span>&nbsp;<span class="op" id="6057820">:=</span>&nbsp;<span class="op" id="6057823">(</span><span class="ident" id="6057824">sy</span><span class="op" id="6057826">-</span><span class="ident" id="6057827">src</span><span class="op" id="6057830">.</span><span class="ident" id="6057831">Rect</span><span class="op" id="6057835">.</span><span class="ident" id="6057836">Min</span><span class="op" id="6057839">.</span><span class="ident" id="6057840">Y</span><span class="op" id="6057841">)</span><span class="op" id="6057842">*</span><span class="ident" id="6057843">src</span><span class="op" id="6057846">.</span><span class="ident" id="6057847">CStride</span>&nbsp;<span class="op" id="6057855">-</span>&nbsp;<span class="ident" id="6057857">src</span><span class="op" id="6057860">.</span><span class="ident" id="6057861">Rect</span><span class="op" id="6057865">.</span><span class="ident" id="6057866">Min</span><span class="op" id="6057869">.</span><span class="ident" id="6057870">X</span><span class="op" id="6057871">/</span><span class="num" id="6057872">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057877">for</span>&nbsp;<span class="ident" id="6057881">x</span><span class="op" id="6057882">,</span>&nbsp;<span class="ident" id="6057884">sx</span>&nbsp;<span class="op" id="6057887">:=</span>&nbsp;<span class="ident" id="6057890">x0</span><span class="op" id="6057892">,</span>&nbsp;<span class="ident" id="6057894">sp</span><span class="op" id="6057896">.</span><span class="ident" id="6057897">X</span><span class="op" id="6057898">;</span>&nbsp;<span class="ident" id="6057900">x</span>&nbsp;<span class="op" id="6057902">!=</span>&nbsp;<span class="ident" id="6057905">x1</span><span class="op" id="6057907">;</span>&nbsp;<span class="ident" id="6057909">x</span><span class="op" id="6057910">,</span>&nbsp;<span class="ident" id="6057912">sx</span><span class="op" id="6057914">,</span>&nbsp;<span class="ident" id="6057916">yi</span>&nbsp;<span class="op" id="6057919">=</span>&nbsp;<span class="ident" id="6057921">x</span><span class="op" id="6057922">+</span><span class="num" id="6057923">4</span><span class="op" id="6057924">,</span>&nbsp;<span class="ident" id="6057926">sx</span><span class="op" id="6057928">+</span><span class="num" id="6057929">1</span><span class="op" id="6057930">,</span>&nbsp;<span class="ident" id="6057932">yi</span><span class="op" id="6057934">+</span><span class="num" id="6057935">1</span>&nbsp;<span class="op" id="6057937">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057943">ci</span>&nbsp;<span class="op" id="6057946">:=</span>&nbsp;<span class="ident" id="6057949">ciBase</span>&nbsp;<span class="op" id="6057956">+</span>&nbsp;<span class="ident" id="6057958">sx</span><span class="op" id="6057960">/</span><span class="num" id="6057961">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057967">rr</span><span class="op" id="6057969">,</span>&nbsp;<span class="ident" id="6057971">gg</span><span class="op" id="6057973">,</span>&nbsp;<span class="ident" id="6057975">bb</span>&nbsp;<span class="op" id="6057978">:=</span>&nbsp;<span class="ident" id="6057981">color</span><span class="op" id="6057986">.</span><span class="ident" id="6057987">YCbCrToRGB</span><span class="op" id="6057997">(</span><span class="ident" id="6057998">src</span><span class="op" id="6058001">.</span><span class="ident" id="6058002">Y</span><span class="op" id="6058003">[</span><span class="ident" id="6058004">yi</span><span class="op" id="6058006">]</span><span class="op" id="6058007">,</span>&nbsp;<span class="ident" id="6058009">src</span><span class="op" id="6058012">.</span><span class="ident" id="6058013">Cb</span><span class="op" id="6058015">[</span><span class="ident" id="6058016">ci</span><span class="op" id="6058018">]</span><span class="op" id="6058019">,</span>&nbsp;<span class="ident" id="6058021">src</span><span class="op" id="6058024">.</span><span class="ident" id="6058025">Cr</span><span class="op" id="6058027">[</span><span class="ident" id="6058028">ci</span><span class="op" id="6058030">]</span><span class="op" id="6058031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058037">dpix</span><span class="op" id="6058041">[</span><span class="ident" id="6058042">x</span><span class="op" id="6058043">+</span><span class="num" id="6058044">0</span><span class="op" id="6058045">]</span>&nbsp;<span class="op" id="6058047">=</span>&nbsp;<span class="ident" id="6058049">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058056">dpix</span><span class="op" id="6058060">[</span><span class="ident" id="6058061">x</span><span class="op" id="6058062">+</span><span class="num" id="6058063">1</span><span class="op" id="6058064">]</span>&nbsp;<span class="op" id="6058066">=</span>&nbsp;<span class="ident" id="6058068">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058075">dpix</span><span class="op" id="6058079">[</span><span class="ident" id="6058080">x</span><span class="op" id="6058081">+</span><span class="num" id="6058082">2</span><span class="op" id="6058083">]</span>&nbsp;<span class="op" id="6058085">=</span>&nbsp;<span class="ident" id="6058087">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058094">dpix</span><span class="op" id="6058098">[</span><span class="ident" id="6058099">x</span><span class="op" id="6058100">+</span><span class="num" id="6058101">3</span><span class="op" id="6058102">]</span>&nbsp;<span class="op" id="6058104">=</span>&nbsp;<span class="num" id="6058106">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058120">case</span>&nbsp;<span class="ident" id="6058125">image</span><span class="op" id="6058130">.</span><span class="ident" id="6058131">YCbCrSubsampleRatio420</span><span class="op" id="6058153">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058157">for</span>&nbsp;<span class="ident" id="6058161">y</span><span class="op" id="6058162">,</span>&nbsp;<span class="ident" id="6058164">sy</span>&nbsp;<span class="op" id="6058167">:=</span>&nbsp;<span class="ident" id="6058170">y0</span><span class="op" id="6058172">,</span>&nbsp;<span class="ident" id="6058174">sp</span><span class="op" id="6058176">.</span><span class="ident" id="6058177">Y</span><span class="op" id="6058178">;</span>&nbsp;<span class="ident" id="6058180">y</span>&nbsp;<span class="op" id="6058182">!=</span>&nbsp;<span class="ident" id="6058185">y1</span><span class="op" id="6058187">;</span>&nbsp;<span class="ident" id="6058189">y</span><span class="op" id="6058190">,</span>&nbsp;<span class="ident" id="6058192">sy</span>&nbsp;<span class="op" id="6058195">=</span>&nbsp;<span class="ident" id="6058197">y</span><span class="op" id="6058198">+</span><span class="num" id="6058199">1</span><span class="op" id="6058200">,</span>&nbsp;<span class="ident" id="6058202">sy</span><span class="op" id="6058204">+</span><span class="num" id="6058205">1</span>&nbsp;<span class="op" id="6058207">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058212">dpix</span>&nbsp;<span class="op" id="6058217">:=</span>&nbsp;<span class="ident" id="6058220">dst</span><span class="op" id="6058223">.</span><span class="ident" id="6058224">Pix</span><span class="op" id="6058227">[</span><span class="ident" id="6058228">y</span><span class="op" id="6058229">*</span><span class="ident" id="6058230">dst</span><span class="op" id="6058233">.</span><span class="ident" id="6058234">Stride</span><span class="op" id="6058240">:</span><span class="op" id="6058241">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058246">yi</span>&nbsp;<span class="op" id="6058249">:=</span>&nbsp;<span class="op" id="6058252">(</span><span class="ident" id="6058253">sy</span><span class="op" id="6058255">-</span><span class="ident" id="6058256">src</span><span class="op" id="6058259">.</span><span class="ident" id="6058260">Rect</span><span class="op" id="6058264">.</span><span class="ident" id="6058265">Min</span><span class="op" id="6058268">.</span><span class="ident" id="6058269">Y</span><span class="op" id="6058270">)</span><span class="op" id="6058271">*</span><span class="ident" id="6058272">src</span><span class="op" id="6058275">.</span><span class="ident" id="6058276">YStride</span>&nbsp;<span class="op" id="6058284">+</span>&nbsp;<span class="op" id="6058286">(</span><span class="ident" id="6058287">sp</span><span class="op" id="6058289">.</span><span class="ident" id="6058290">X</span>&nbsp;<span class="op" id="6058292">-</span>&nbsp;<span class="ident" id="6058294">src</span><span class="op" id="6058297">.</span><span class="ident" id="6058298">Rect</span><span class="op" id="6058302">.</span><span class="ident" id="6058303">Min</span><span class="op" id="6058306">.</span><span class="ident" id="6058307">X</span><span class="op" id="6058308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058313">ciBase</span>&nbsp;<span class="op" id="6058320">:=</span>&nbsp;<span class="op" id="6058323">(</span><span class="ident" id="6058324">sy</span><span class="op" id="6058326">/</span><span class="num" id="6058327">2</span><span class="op" id="6058328">-</span><span class="ident" id="6058329">src</span><span class="op" id="6058332">.</span><span class="ident" id="6058333">Rect</span><span class="op" id="6058337">.</span><span class="ident" id="6058338">Min</span><span class="op" id="6058341">.</span><span class="ident" id="6058342">Y</span><span class="op" id="6058343">/</span><span class="num" id="6058344">2</span><span class="op" id="6058345">)</span><span class="op" id="6058346">*</span><span class="ident" id="6058347">src</span><span class="op" id="6058350">.</span><span class="ident" id="6058351">CStride</span>&nbsp;<span class="op" id="6058359">-</span>&nbsp;<span class="ident" id="6058361">src</span><span class="op" id="6058364">.</span><span class="ident" id="6058365">Rect</span><span class="op" id="6058369">.</span><span class="ident" id="6058370">Min</span><span class="op" id="6058373">.</span><span class="ident" id="6058374">X</span><span class="op" id="6058375">/</span><span class="num" id="6058376">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058381">for</span>&nbsp;<span class="ident" id="6058385">x</span><span class="op" id="6058386">,</span>&nbsp;<span class="ident" id="6058388">sx</span>&nbsp;<span class="op" id="6058391">:=</span>&nbsp;<span class="ident" id="6058394">x0</span><span class="op" id="6058396">,</span>&nbsp;<span class="ident" id="6058398">sp</span><span class="op" id="6058400">.</span><span class="ident" id="6058401">X</span><span class="op" id="6058402">;</span>&nbsp;<span class="ident" id="6058404">x</span>&nbsp;<span class="op" id="6058406">!=</span>&nbsp;<span class="ident" id="6058409">x1</span><span class="op" id="6058411">;</span>&nbsp;<span class="ident" id="6058413">x</span><span class="op" id="6058414">,</span>&nbsp;<span class="ident" id="6058416">sx</span><span class="op" id="6058418">,</span>&nbsp;<span class="ident" id="6058420">yi</span>&nbsp;<span class="op" id="6058423">=</span>&nbsp;<span class="ident" id="6058425">x</span><span class="op" id="6058426">+</span><span class="num" id="6058427">4</span><span class="op" id="6058428">,</span>&nbsp;<span class="ident" id="6058430">sx</span><span class="op" id="6058432">+</span><span class="num" id="6058433">1</span><span class="op" id="6058434">,</span>&nbsp;<span class="ident" id="6058436">yi</span><span class="op" id="6058438">+</span><span class="num" id="6058439">1</span>&nbsp;<span class="op" id="6058441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058447">ci</span>&nbsp;<span class="op" id="6058450">:=</span>&nbsp;<span class="ident" id="6058453">ciBase</span>&nbsp;<span class="op" id="6058460">+</span>&nbsp;<span class="ident" id="6058462">sx</span><span class="op" id="6058464">/</span><span class="num" id="6058465">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058471">rr</span><span class="op" id="6058473">,</span>&nbsp;<span class="ident" id="6058475">gg</span><span class="op" id="6058477">,</span>&nbsp;<span class="ident" id="6058479">bb</span>&nbsp;<span class="op" id="6058482">:=</span>&nbsp;<span class="ident" id="6058485">color</span><span class="op" id="6058490">.</span><span class="ident" id="6058491">YCbCrToRGB</span><span class="op" id="6058501">(</span><span class="ident" id="6058502">src</span><span class="op" id="6058505">.</span><span class="ident" id="6058506">Y</span><span class="op" id="6058507">[</span><span class="ident" id="6058508">yi</span><span class="op" id="6058510">]</span><span class="op" id="6058511">,</span>&nbsp;<span class="ident" id="6058513">src</span><span class="op" id="6058516">.</span><span class="ident" id="6058517">Cb</span><span class="op" id="6058519">[</span><span class="ident" id="6058520">ci</span><span class="op" id="6058522">]</span><span class="op" id="6058523">,</span>&nbsp;<span class="ident" id="6058525">src</span><span class="op" id="6058528">.</span><span class="ident" id="6058529">Cr</span><span class="op" id="6058531">[</span><span class="ident" id="6058532">ci</span><span class="op" id="6058534">]</span><span class="op" id="6058535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058541">dpix</span><span class="op" id="6058545">[</span><span class="ident" id="6058546">x</span><span class="op" id="6058547">+</span><span class="num" id="6058548">0</span><span class="op" id="6058549">]</span>&nbsp;<span class="op" id="6058551">=</span>&nbsp;<span class="ident" id="6058553">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058560">dpix</span><span class="op" id="6058564">[</span><span class="ident" id="6058565">x</span><span class="op" id="6058566">+</span><span class="num" id="6058567">1</span><span class="op" id="6058568">]</span>&nbsp;<span class="op" id="6058570">=</span>&nbsp;<span class="ident" id="6058572">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058579">dpix</span><span class="op" id="6058583">[</span><span class="ident" id="6058584">x</span><span class="op" id="6058585">+</span><span class="num" id="6058586">2</span><span class="op" id="6058587">]</span>&nbsp;<span class="op" id="6058589">=</span>&nbsp;<span class="ident" id="6058591">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058598">dpix</span><span class="op" id="6058602">[</span><span class="ident" id="6058603">x</span><span class="op" id="6058604">+</span><span class="num" id="6058605">3</span><span class="op" id="6058606">]</span>&nbsp;<span class="op" id="6058608">=</span>&nbsp;<span class="num" id="6058610">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058624">case</span>&nbsp;<span class="ident" id="6058629">image</span><span class="op" id="6058634">.</span><span class="ident" id="6058635">YCbCrSubsampleRatio440</span><span class="op" id="6058657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058661">for</span>&nbsp;<span class="ident" id="6058665">y</span><span class="op" id="6058666">,</span>&nbsp;<span class="ident" id="6058668">sy</span>&nbsp;<span class="op" id="6058671">:=</span>&nbsp;<span class="ident" id="6058674">y0</span><span class="op" id="6058676">,</span>&nbsp;<span class="ident" id="6058678">sp</span><span class="op" id="6058680">.</span><span class="ident" id="6058681">Y</span><span class="op" id="6058682">;</span>&nbsp;<span class="ident" id="6058684">y</span>&nbsp;<span class="op" id="6058686">!=</span>&nbsp;<span class="ident" id="6058689">y1</span><span class="op" id="6058691">;</span>&nbsp;<span class="ident" id="6058693">y</span><span class="op" id="6058694">,</span>&nbsp;<span class="ident" id="6058696">sy</span>&nbsp;<span class="op" id="6058699">=</span>&nbsp;<span class="ident" id="6058701">y</span><span class="op" id="6058702">+</span><span class="num" id="6058703">1</span><span class="op" id="6058704">,</span>&nbsp;<span class="ident" id="6058706">sy</span><span class="op" id="6058708">+</span><span class="num" id="6058709">1</span>&nbsp;<span class="op" id="6058711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058716">dpix</span>&nbsp;<span class="op" id="6058721">:=</span>&nbsp;<span class="ident" id="6058724">dst</span><span class="op" id="6058727">.</span><span class="ident" id="6058728">Pix</span><span class="op" id="6058731">[</span><span class="ident" id="6058732">y</span><span class="op" id="6058733">*</span><span class="ident" id="6058734">dst</span><span class="op" id="6058737">.</span><span class="ident" id="6058738">Stride</span><span class="op" id="6058744">:</span><span class="op" id="6058745">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058750">yi</span>&nbsp;<span class="op" id="6058753">:=</span>&nbsp;<span class="op" id="6058756">(</span><span class="ident" id="6058757">sy</span><span class="op" id="6058759">-</span><span class="ident" id="6058760">src</span><span class="op" id="6058763">.</span><span class="ident" id="6058764">Rect</span><span class="op" id="6058768">.</span><span class="ident" id="6058769">Min</span><span class="op" id="6058772">.</span><span class="ident" id="6058773">Y</span><span class="op" id="6058774">)</span><span class="op" id="6058775">*</span><span class="ident" id="6058776">src</span><span class="op" id="6058779">.</span><span class="ident" id="6058780">YStride</span>&nbsp;<span class="op" id="6058788">+</span>&nbsp;<span class="op" id="6058790">(</span><span class="ident" id="6058791">sp</span><span class="op" id="6058793">.</span><span class="ident" id="6058794">X</span>&nbsp;<span class="op" id="6058796">-</span>&nbsp;<span class="ident" id="6058798">src</span><span class="op" id="6058801">.</span><span class="ident" id="6058802">Rect</span><span class="op" id="6058806">.</span><span class="ident" id="6058807">Min</span><span class="op" id="6058810">.</span><span class="ident" id="6058811">X</span><span class="op" id="6058812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058817">ci</span>&nbsp;<span class="op" id="6058820">:=</span>&nbsp;<span class="op" id="6058823">(</span><span class="ident" id="6058824">sy</span><span class="op" id="6058826">/</span><span class="num" id="6058827">2</span><span class="op" id="6058828">-</span><span class="ident" id="6058829">src</span><span class="op" id="6058832">.</span><span class="ident" id="6058833">Rect</span><span class="op" id="6058837">.</span><span class="ident" id="6058838">Min</span><span class="op" id="6058841">.</span><span class="ident" id="6058842">Y</span><span class="op" id="6058843">/</span><span class="num" id="6058844">2</span><span class="op" id="6058845">)</span><span class="op" id="6058846">*</span><span class="ident" id="6058847">src</span><span class="op" id="6058850">.</span><span class="ident" id="6058851">CStride</span>&nbsp;<span class="op" id="6058859">+</span>&nbsp;<span class="op" id="6058861">(</span><span class="ident" id="6058862">sp</span><span class="op" id="6058864">.</span><span class="ident" id="6058865">X</span>&nbsp;<span class="op" id="6058867">-</span>&nbsp;<span class="ident" id="6058869">src</span><span class="op" id="6058872">.</span><span class="ident" id="6058873">Rect</span><span class="op" id="6058877">.</span><span class="ident" id="6058878">Min</span><span class="op" id="6058881">.</span><span class="ident" id="6058882">X</span><span class="op" id="6058883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058888">for</span>&nbsp;<span class="ident" id="6058892">x</span>&nbsp;<span class="op" id="6058894">:=</span>&nbsp;<span class="ident" id="6058897">x0</span><span class="op" id="6058899">;</span>&nbsp;<span class="ident" id="6058901">x</span>&nbsp;<span class="op" id="6058903">!=</span>&nbsp;<span class="ident" id="6058906">x1</span><span class="op" id="6058908">;</span>&nbsp;<span class="ident" id="6058910">x</span><span class="op" id="6058911">,</span>&nbsp;<span class="ident" id="6058913">yi</span><span class="op" id="6058915">,</span>&nbsp;<span class="ident" id="6058917">ci</span>&nbsp;<span class="op" id="6058920">=</span>&nbsp;<span class="ident" id="6058922">x</span><span class="op" id="6058923">+</span><span class="num" id="6058924">4</span><span class="op" id="6058925">,</span>&nbsp;<span class="ident" id="6058927">yi</span><span class="op" id="6058929">+</span><span class="num" id="6058930">1</span><span class="op" id="6058931">,</span>&nbsp;<span class="ident" id="6058933">ci</span><span class="op" id="6058935">+</span><span class="num" id="6058936">1</span>&nbsp;<span class="op" id="6058938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058944">rr</span><span class="op" id="6058946">,</span>&nbsp;<span class="ident" id="6058948">gg</span><span class="op" id="6058950">,</span>&nbsp;<span class="ident" id="6058952">bb</span>&nbsp;<span class="op" id="6058955">:=</span>&nbsp;<span class="ident" id="6058958">color</span><span class="op" id="6058963">.</span><span class="ident" id="6058964">YCbCrToRGB</span><span class="op" id="6058974">(</span><span class="ident" id="6058975">src</span><span class="op" id="6058978">.</span><span class="ident" id="6058979">Y</span><span class="op" id="6058980">[</span><span class="ident" id="6058981">yi</span><span class="op" id="6058983">]</span><span class="op" id="6058984">,</span>&nbsp;<span class="ident" id="6058986">src</span><span class="op" id="6058989">.</span><span class="ident" id="6058990">Cb</span><span class="op" id="6058992">[</span><span class="ident" id="6058993">ci</span><span class="op" id="6058995">]</span><span class="op" id="6058996">,</span>&nbsp;<span class="ident" id="6058998">src</span><span class="op" id="6059001">.</span><span class="ident" id="6059002">Cr</span><span class="op" id="6059004">[</span><span class="ident" id="6059005">ci</span><span class="op" id="6059007">]</span><span class="op" id="6059008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059014">dpix</span><span class="op" id="6059018">[</span><span class="ident" id="6059019">x</span><span class="op" id="6059020">+</span><span class="num" id="6059021">0</span><span class="op" id="6059022">]</span>&nbsp;<span class="op" id="6059024">=</span>&nbsp;<span class="ident" id="6059026">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059033">dpix</span><span class="op" id="6059037">[</span><span class="ident" id="6059038">x</span><span class="op" id="6059039">+</span><span class="num" id="6059040">1</span><span class="op" id="6059041">]</span>&nbsp;<span class="op" id="6059043">=</span>&nbsp;<span class="ident" id="6059045">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059052">dpix</span><span class="op" id="6059056">[</span><span class="ident" id="6059057">x</span><span class="op" id="6059058">+</span><span class="num" id="6059059">2</span><span class="op" id="6059060">]</span>&nbsp;<span class="op" id="6059062">=</span>&nbsp;<span class="ident" id="6059064">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059071">dpix</span><span class="op" id="6059075">[</span><span class="ident" id="6059076">x</span><span class="op" id="6059077">+</span><span class="num" id="6059078">3</span><span class="op" id="6059079">]</span>&nbsp;<span class="op" id="6059081">=</span>&nbsp;<span class="num" id="6059083">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059094">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059097">default</span><span class="op" id="6059104">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059108">return</span>&nbsp;<span class="builtintype" id="6059115">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059125">return</span>&nbsp;<span class="builtintype" id="6059132">true</span><br>
<span class="lineno"></span><span class="op" id="6059137">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="6059140">func</span>&nbsp;<span class="ident" id="6059145">drawGlyphOver</span><span class="op" id="6059158">(</span><span class="ident" id="6059159">dst</span>&nbsp;<span class="op" id="6059163">*</span><span class="ident" id="6059164">image</span><span class="op" id="6059169">.</span><span class="ident" id="6059170">RGBA</span><span class="op" id="6059174">,</span>&nbsp;<span class="ident" id="6059176">r</span>&nbsp;<span class="ident" id="6059178">image</span><span class="op" id="6059183">.</span><span class="ident" id="6059184">Rectangle</span><span class="op" id="6059193">,</span>&nbsp;<span class="ident" id="6059195">src</span>&nbsp;<span class="op" id="6059199">*</span><span class="ident" id="6059200">image</span><span class="op" id="6059205">.</span><span class="ident" id="6059206">Uniform</span><span class="op" id="6059213">,</span>&nbsp;<span class="ident" id="6059215">mask</span>&nbsp;<span class="op" id="6059220">*</span><span class="ident" id="6059221">image</span><span class="op" id="6059226">.</span><span class="ident" id="6059227">Alpha</span><span class="op" id="6059232">,</span>&nbsp;<span class="ident" id="6059234">mp</span>&nbsp;<span class="ident" id="6059237">image</span><span class="op" id="6059242">.</span><span class="ident" id="6059243">Point</span><span class="op" id="6059248">)</span>&nbsp;<span class="op" id="6059250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059253">i0</span>&nbsp;<span class="op" id="6059256">:=</span>&nbsp;<span class="ident" id="6059259">dst</span><span class="op" id="6059262">.</span><span class="ident" id="6059263">PixOffset</span><span class="op" id="6059272">(</span><span class="ident" id="6059273">r</span><span class="op" id="6059274">.</span><span class="ident" id="6059275">Min</span><span class="op" id="6059278">.</span><span class="ident" id="6059279">X</span><span class="op" id="6059280">,</span>&nbsp;<span class="ident" id="6059282">r</span><span class="op" id="6059283">.</span><span class="ident" id="6059284">Min</span><span class="op" id="6059287">.</span><span class="ident" id="6059288">Y</span><span class="op" id="6059289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059292">i1</span>&nbsp;<span class="op" id="6059295">:=</span>&nbsp;<span class="ident" id="6059298">i0</span>&nbsp;<span class="op" id="6059301">+</span>&nbsp;<span class="ident" id="6059303">r</span><span class="op" id="6059304">.</span><span class="ident" id="6059305">Dx</span><span class="op" id="6059307">(</span><span class="op" id="6059308">)</span><span class="op" id="6059309">*</span><span class="num" id="6059310">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059313">mi0</span>&nbsp;<span class="op" id="6059317">:=</span>&nbsp;<span class="ident" id="6059320">mask</span><span class="op" id="6059324">.</span><span class="ident" id="6059325">PixOffset</span><span class="op" id="6059334">(</span><span class="ident" id="6059335">mp</span><span class="op" id="6059337">.</span><span class="ident" id="6059338">X</span><span class="op" id="6059339">,</span>&nbsp;<span class="ident" id="6059341">mp</span><span class="op" id="6059343">.</span><span class="ident" id="6059344">Y</span><span class="op" id="6059345">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059348">sr</span><span class="op" id="6059350">,</span>&nbsp;<span class="ident" id="6059352">sg</span><span class="op" id="6059354">,</span>&nbsp;<span class="ident" id="6059356">sb</span><span class="op" id="6059358">,</span>&nbsp;<span class="ident" id="6059360">sa</span>&nbsp;<span class="op" id="6059363">:=</span>&nbsp;<span class="ident" id="6059366">src</span><span class="op" id="6059369">.</span><span class="ident" id="6059370">RGBA</span><span class="op" id="6059374">(</span><span class="op" id="6059375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059378">for</span>&nbsp;<span class="ident" id="6059382">y</span><span class="op" id="6059383">,</span>&nbsp;<span class="ident" id="6059385">my</span>&nbsp;<span class="op" id="6059388">:=</span>&nbsp;<span class="ident" id="6059391">r</span><span class="op" id="6059392">.</span><span class="ident" id="6059393">Min</span><span class="op" id="6059396">.</span><span class="ident" id="6059397">Y</span><span class="op" id="6059398">,</span>&nbsp;<span class="ident" id="6059400">mp</span><span class="op" id="6059402">.</span><span class="ident" id="6059403">Y</span><span class="op" id="6059404">;</span>&nbsp;<span class="ident" id="6059406">y</span>&nbsp;<span class="op" id="6059408">!=</span>&nbsp;<span class="ident" id="6059411">r</span><span class="op" id="6059412">.</span><span class="ident" id="6059413">Max</span><span class="op" id="6059416">.</span><span class="ident" id="6059417">Y</span><span class="op" id="6059418">;</span>&nbsp;<span class="ident" id="6059420">y</span><span class="op" id="6059421">,</span>&nbsp;<span class="ident" id="6059423">my</span>&nbsp;<span class="op" id="6059426">=</span>&nbsp;<span class="ident" id="6059428">y</span><span class="op" id="6059429">+</span><span class="num" id="6059430">1</span><span class="op" id="6059431">,</span>&nbsp;<span class="ident" id="6059433">my</span><span class="op" id="6059435">+</span><span class="num" id="6059436">1</span>&nbsp;<span class="op" id="6059438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059442">for</span>&nbsp;<span class="ident" id="6059446">i</span><span class="op" id="6059447">,</span>&nbsp;<span class="ident" id="6059449">mi</span>&nbsp;<span class="op" id="6059452">:=</span>&nbsp;<span class="ident" id="6059455">i0</span><span class="op" id="6059457">,</span>&nbsp;<span class="ident" id="6059459">mi0</span><span class="op" id="6059462">;</span>&nbsp;<span class="ident" id="6059464">i</span>&nbsp;<span class="op" id="6059466">&lt;</span>&nbsp;<span class="ident" id="6059468">i1</span><span class="op" id="6059470">;</span>&nbsp;<span class="ident" id="6059472">i</span><span class="op" id="6059473">,</span>&nbsp;<span class="ident" id="6059475">mi</span>&nbsp;<span class="op" id="6059478">=</span>&nbsp;<span class="ident" id="6059480">i</span><span class="op" id="6059481">+</span><span class="num" id="6059482">4</span><span class="op" id="6059483">,</span>&nbsp;<span class="ident" id="6059485">mi</span><span class="op" id="6059487">+</span><span class="num" id="6059488">1</span>&nbsp;<span class="op" id="6059490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059495">ma</span>&nbsp;<span class="op" id="6059498">:=</span>&nbsp;<span class="builtintype" id="6059501">uint32</span><span class="op" id="6059507">(</span><span class="ident" id="6059508">mask</span><span class="op" id="6059512">.</span><span class="ident" id="6059513">Pix</span><span class="op" id="6059516">[</span><span class="ident" id="6059517">mi</span><span class="op" id="6059519">]</span><span class="op" id="6059520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059525">if</span>&nbsp;<span class="ident" id="6059528">ma</span>&nbsp;<span class="op" id="6059531">==</span>&nbsp;<span class="num" id="6059534">0</span>&nbsp;<span class="op" id="6059536">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059542">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059559">ma</span>&nbsp;<span class="op" id="6059562">|=</span>&nbsp;<span class="ident" id="6059565">ma</span>&nbsp;<span class="op" id="6059568">&lt;&lt;</span>&nbsp;<span class="num" id="6059571">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059577">dr</span>&nbsp;<span class="op" id="6059580">:=</span>&nbsp;<span class="builtintype" id="6059583">uint32</span><span class="op" id="6059589">(</span><span class="ident" id="6059590">dst</span><span class="op" id="6059593">.</span><span class="ident" id="6059594">Pix</span><span class="op" id="6059597">[</span><span class="ident" id="6059598">i</span><span class="op" id="6059599">+</span><span class="num" id="6059600">0</span><span class="op" id="6059601">]</span><span class="op" id="6059602">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059607">dg</span>&nbsp;<span class="op" id="6059610">:=</span>&nbsp;<span class="builtintype" id="6059613">uint32</span><span class="op" id="6059619">(</span><span class="ident" id="6059620">dst</span><span class="op" id="6059623">.</span><span class="ident" id="6059624">Pix</span><span class="op" id="6059627">[</span><span class="ident" id="6059628">i</span><span class="op" id="6059629">+</span><span class="num" id="6059630">1</span><span class="op" id="6059631">]</span><span class="op" id="6059632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059637">db</span>&nbsp;<span class="op" id="6059640">:=</span>&nbsp;<span class="builtintype" id="6059643">uint32</span><span class="op" id="6059649">(</span><span class="ident" id="6059650">dst</span><span class="op" id="6059653">.</span><span class="ident" id="6059654">Pix</span><span class="op" id="6059657">[</span><span class="ident" id="6059658">i</span><span class="op" id="6059659">+</span><span class="num" id="6059660">2</span><span class="op" id="6059661">]</span><span class="op" id="6059662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059667">da</span>&nbsp;<span class="op" id="6059670">:=</span>&nbsp;<span class="builtintype" id="6059673">uint32</span><span class="op" id="6059679">(</span><span class="ident" id="6059680">dst</span><span class="op" id="6059683">.</span><span class="ident" id="6059684">Pix</span><span class="op" id="6059687">[</span><span class="ident" id="6059688">i</span><span class="op" id="6059689">+</span><span class="num" id="6059690">3</span><span class="op" id="6059691">]</span><span class="op" id="6059692">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059698">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059758">a</span>&nbsp;<span class="op" id="6059760">:=</span>&nbsp;<span class="op" id="6059763">(</span><span class="ident" id="6059764">m</span>&nbsp;<span class="op" id="6059766">-</span>&nbsp;<span class="op" id="6059768">(</span><span class="ident" id="6059769">sa</span>&nbsp;<span class="op" id="6059772">*</span>&nbsp;<span class="ident" id="6059774">ma</span>&nbsp;<span class="op" id="6059777">/</span>&nbsp;<span class="ident" id="6059779">m</span><span class="op" id="6059780">)</span><span class="op" id="6059781">)</span>&nbsp;<span class="op" id="6059783">*</span>&nbsp;<span class="num" id="6059785">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059795">dst</span><span class="op" id="6059798">.</span><span class="ident" id="6059799">Pix</span><span class="op" id="6059802">[</span><span class="ident" id="6059803">i</span><span class="op" id="6059804">+</span><span class="num" id="6059805">0</span><span class="op" id="6059806">]</span>&nbsp;<span class="op" id="6059808">=</span>&nbsp;<span class="builtintype" id="6059810">uint8</span><span class="op" id="6059815">(</span><span class="op" id="6059816">(</span><span class="ident" id="6059817">dr</span><span class="op" id="6059819">*</span><span class="ident" id="6059820">a</span>&nbsp;<span class="op" id="6059822">+</span>&nbsp;<span class="ident" id="6059824">sr</span><span class="op" id="6059826">*</span><span class="ident" id="6059827">ma</span><span class="op" id="6059829">)</span>&nbsp;<span class="op" id="6059831">/</span>&nbsp;<span class="ident" id="6059833">m</span>&nbsp;<span class="op" id="6059835">&gt;&gt;</span>&nbsp;<span class="num" id="6059838">8</span><span class="op" id="6059839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059844">dst</span><span class="op" id="6059847">.</span><span class="ident" id="6059848">Pix</span><span class="op" id="6059851">[</span><span class="ident" id="6059852">i</span><span class="op" id="6059853">+</span><span class="num" id="6059854">1</span><span class="op" id="6059855">]</span>&nbsp;<span class="op" id="6059857">=</span>&nbsp;<span class="builtintype" id="6059859">uint8</span><span class="op" id="6059864">(</span><span class="op" id="6059865">(</span><span class="ident" id="6059866">dg</span><span class="op" id="6059868">*</span><span class="ident" id="6059869">a</span>&nbsp;<span class="op" id="6059871">+</span>&nbsp;<span class="ident" id="6059873">sg</span><span class="op" id="6059875">*</span><span class="ident" id="6059876">ma</span><span class="op" id="6059878">)</span>&nbsp;<span class="op" id="6059880">/</span>&nbsp;<span class="ident" id="6059882">m</span>&nbsp;<span class="op" id="6059884">&gt;&gt;</span>&nbsp;<span class="num" id="6059887">8</span><span class="op" id="6059888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059893">dst</span><span class="op" id="6059896">.</span><span class="ident" id="6059897">Pix</span><span class="op" id="6059900">[</span><span class="ident" id="6059901">i</span><span class="op" id="6059902">+</span><span class="num" id="6059903">2</span><span class="op" id="6059904">]</span>&nbsp;<span class="op" id="6059906">=</span>&nbsp;<span class="builtintype" id="6059908">uint8</span><span class="op" id="6059913">(</span><span class="op" id="6059914">(</span><span class="ident" id="6059915">db</span><span class="op" id="6059917">*</span><span class="ident" id="6059918">a</span>&nbsp;<span class="op" id="6059920">+</span>&nbsp;<span class="ident" id="6059922">sb</span><span class="op" id="6059924">*</span><span class="ident" id="6059925">ma</span><span class="op" id="6059927">)</span>&nbsp;<span class="op" id="6059929">/</span>&nbsp;<span class="ident" id="6059931">m</span>&nbsp;<span class="op" id="6059933">&gt;&gt;</span>&nbsp;<span class="num" id="6059936">8</span><span class="op" id="6059937">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059942">dst</span><span class="op" id="6059945">.</span><span class="ident" id="6059946">Pix</span><span class="op" id="6059949">[</span><span class="ident" id="6059950">i</span><span class="op" id="6059951">+</span><span class="num" id="6059952">3</span><span class="op" id="6059953">]</span>&nbsp;<span class="op" id="6059955">=</span>&nbsp;<span class="builtintype" id="6059957">uint8</span><span class="op" id="6059962">(</span><span class="op" id="6059963">(</span><span class="ident" id="6059964">da</span><span class="op" id="6059966">*</span><span class="ident" id="6059967">a</span>&nbsp;<span class="op" id="6059969">+</span>&nbsp;<span class="ident" id="6059971">sa</span><span class="op" id="6059973">*</span><span class="ident" id="6059974">ma</span><span class="op" id="6059976">)</span>&nbsp;<span class="op" id="6059978">/</span>&nbsp;<span class="ident" id="6059980">m</span>&nbsp;<span class="op" id="6059982">&gt;&gt;</span>&nbsp;<span class="num" id="6059985">8</span><span class="op" id="6059986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059994">i0</span>&nbsp;<span class="op" id="6059997">+=</span>&nbsp;<span class="ident" id="6060000">dst</span><span class="op" id="6060003">.</span><span class="ident" id="6060004">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060013">i1</span>&nbsp;<span class="op" id="6060016">+=</span>&nbsp;<span class="ident" id="6060019">dst</span><span class="op" id="6060022">.</span><span class="ident" id="6060023">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060032">mi0</span>&nbsp;<span class="op" id="6060036">+=</span>&nbsp;<span class="ident" id="6060039">mask</span><span class="op" id="6060043">.</span><span class="ident" id="6060044">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6060052">}</span><br>
<span class="lineno"></span><span class="op" id="6060054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6060057">func</span>&nbsp;<span class="ident" id="6060062">drawRGBA</span><span class="op" id="6060070">(</span><span class="ident" id="6060071">dst</span>&nbsp;<span class="op" id="6060075">*</span><span class="ident" id="6060076">image</span><span class="op" id="6060081">.</span><span class="ident" id="6060082">RGBA</span><span class="op" id="6060086">,</span>&nbsp;<span class="ident" id="6060088">r</span>&nbsp;<span class="ident" id="6060090">image</span><span class="op" id="6060095">.</span><span class="ident" id="6060096">Rectangle</span><span class="op" id="6060105">,</span>&nbsp;<span class="ident" id="6060107">src</span>&nbsp;<span class="ident" id="6060111">image</span><span class="op" id="6060116">.</span><span class="ident" id="6060117">Image</span><span class="op" id="6060122">,</span>&nbsp;<span class="ident" id="6060124">sp</span>&nbsp;<span class="ident" id="6060127">image</span><span class="op" id="6060132">.</span><span class="ident" id="6060133">Point</span><span class="op" id="6060138">,</span>&nbsp;<span class="ident" id="6060140">mask</span>&nbsp;<span class="ident" id="6060145">image</span><span class="op" id="6060150">.</span><span class="ident" id="6060151">Image</span><span class="op" id="6060156">,</span>&nbsp;<span class="ident" id="6060158">mp</span>&nbsp;<span class="ident" id="6060161">image</span><span class="op" id="6060166">.</span><span class="ident" id="6060167">Point</span><span class="op" id="6060172">,</span>&nbsp;<span class="ident" id="6060174">op</span>&nbsp;<span class="ident" id="6060177">Op</span><span class="op" id="6060179">)</span>&nbsp;<span class="op" id="6060181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060184">x0</span><span class="op" id="6060186">,</span>&nbsp;<span class="ident" id="6060188">x1</span><span class="op" id="6060190">,</span>&nbsp;<span class="ident" id="6060192">dx</span>&nbsp;<span class="op" id="6060195">:=</span>&nbsp;<span class="ident" id="6060198">r</span><span class="op" id="6060199">.</span><span class="ident" id="6060200">Min</span><span class="op" id="6060203">.</span><span class="ident" id="6060204">X</span><span class="op" id="6060205">,</span>&nbsp;<span class="ident" id="6060207">r</span><span class="op" id="6060208">.</span><span class="ident" id="6060209">Max</span><span class="op" id="6060212">.</span><span class="ident" id="6060213">X</span><span class="op" id="6060214">,</span>&nbsp;<span class="num" id="6060216">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060219">y0</span><span class="op" id="6060221">,</span>&nbsp;<span class="ident" id="6060223">y1</span><span class="op" id="6060225">,</span>&nbsp;<span class="ident" id="6060227">dy</span>&nbsp;<span class="op" id="6060230">:=</span>&nbsp;<span class="ident" id="6060233">r</span><span class="op" id="6060234">.</span><span class="ident" id="6060235">Min</span><span class="op" id="6060238">.</span><span class="ident" id="6060239">Y</span><span class="op" id="6060240">,</span>&nbsp;<span class="ident" id="6060242">r</span><span class="op" id="6060243">.</span><span class="ident" id="6060244">Max</span><span class="op" id="6060247">.</span><span class="ident" id="6060248">Y</span><span class="op" id="6060249">,</span>&nbsp;<span class="num" id="6060251">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060254">if</span>&nbsp;<span class="ident" id="6060257">image</span><span class="op" id="6060262">.</span><span class="ident" id="6060263">Image</span><span class="op" id="6060268">(</span><span class="ident" id="6060269">dst</span><span class="op" id="6060272">)</span>&nbsp;<span class="op" id="6060274">==</span>&nbsp;<span class="ident" id="6060277">src</span>&nbsp;<span class="op" id="6060281">&amp;&amp;</span>&nbsp;<span class="ident" id="6060284">r</span><span class="op" id="6060285">.</span><span class="ident" id="6060286">Overlaps</span><span class="op" id="6060294">(</span><span class="ident" id="6060295">r</span><span class="op" id="6060296">.</span><span class="ident" id="6060297">Add</span><span class="op" id="6060300">(</span><span class="ident" id="6060301">sp</span><span class="op" id="6060303">.</span><span class="ident" id="6060304">Sub</span><span class="op" id="6060307">(</span><span class="ident" id="6060308">r</span><span class="op" id="6060309">.</span><span class="ident" id="6060310">Min</span><span class="op" id="6060313">)</span><span class="op" id="6060314">)</span><span class="op" id="6060315">)</span>&nbsp;<span class="op" id="6060317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060321">if</span>&nbsp;<span class="ident" id="6060324">sp</span><span class="op" id="6060326">.</span><span class="ident" id="6060327">Y</span>&nbsp;<span class="op" id="6060329">&lt;</span>&nbsp;<span class="ident" id="6060331">r</span><span class="op" id="6060332">.</span><span class="ident" id="6060333">Min</span><span class="op" id="6060336">.</span><span class="ident" id="6060337">Y</span>&nbsp;<span class="op" id="6060339">||</span>&nbsp;<span class="ident" id="6060342">sp</span><span class="op" id="6060344">.</span><span class="ident" id="6060345">Y</span>&nbsp;<span class="op" id="6060347">==</span>&nbsp;<span class="ident" id="6060350">r</span><span class="op" id="6060351">.</span><span class="ident" id="6060352">Min</span><span class="op" id="6060355">.</span><span class="ident" id="6060356">Y</span>&nbsp;<span class="op" id="6060358">&amp;&amp;</span>&nbsp;<span class="ident" id="6060361">sp</span><span class="op" id="6060363">.</span><span class="ident" id="6060364">X</span>&nbsp;<span class="op" id="6060366">&lt;</span>&nbsp;<span class="ident" id="6060368">r</span><span class="op" id="6060369">.</span><span class="ident" id="6060370">Min</span><span class="op" id="6060373">.</span><span class="ident" id="6060374">X</span>&nbsp;<span class="op" id="6060376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060381">x0</span><span class="op" id="6060383">,</span>&nbsp;<span class="ident" id="6060385">x1</span><span class="op" id="6060387">,</span>&nbsp;<span class="ident" id="6060389">dx</span>&nbsp;<span class="op" id="6060392">=</span>&nbsp;<span class="ident" id="6060394">x1</span><span class="op" id="6060396">-</span><span class="num" id="6060397">1</span><span class="op" id="6060398">,</span>&nbsp;<span class="ident" id="6060400">x0</span><span class="op" id="6060402">-</span><span class="num" id="6060403">1</span><span class="op" id="6060404">,</span>&nbsp;<span class="op" id="6060406">-</span><span class="num" id="6060407">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060412">y0</span><span class="op" id="6060414">,</span>&nbsp;<span class="ident" id="6060416">y1</span><span class="op" id="6060418">,</span>&nbsp;<span class="ident" id="6060420">dy</span>&nbsp;<span class="op" id="6060423">=</span>&nbsp;<span class="ident" id="6060425">y1</span><span class="op" id="6060427">-</span><span class="num" id="6060428">1</span><span class="op" id="6060429">,</span>&nbsp;<span class="ident" id="6060431">y0</span><span class="op" id="6060433">-</span><span class="num" id="6060434">1</span><span class="op" id="6060435">,</span>&nbsp;<span class="op" id="6060437">-</span><span class="num" id="6060438">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6060442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6060445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060449">sy</span>&nbsp;<span class="op" id="6060452">:=</span>&nbsp;<span class="ident" id="6060455">sp</span><span class="op" id="6060457">.</span><span class="ident" id="6060458">Y</span>&nbsp;<span class="op" id="6060460">+</span>&nbsp;<span class="ident" id="6060462">y0</span>&nbsp;<span class="op" id="6060465">-</span>&nbsp;<span class="ident" id="6060467">r</span><span class="op" id="6060468">.</span><span class="ident" id="6060469">Min</span><span class="op" id="6060472">.</span><span class="ident" id="6060473">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060476">my</span>&nbsp;<span class="op" id="6060479">:=</span>&nbsp;<span class="ident" id="6060482">mp</span><span class="op" id="6060484">.</span><span class="ident" id="6060485">Y</span>&nbsp;<span class="op" id="6060487">+</span>&nbsp;<span class="ident" id="6060489">y0</span>&nbsp;<span class="op" id="6060492">-</span>&nbsp;<span class="ident" id="6060494">r</span><span class="op" id="6060495">.</span><span class="ident" id="6060496">Min</span><span class="op" id="6060499">.</span><span class="ident" id="6060500">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060503">sx0</span>&nbsp;<span class="op" id="6060507">:=</span>&nbsp;<span class="ident" id="6060510">sp</span><span class="op" id="6060512">.</span><span class="ident" id="6060513">X</span>&nbsp;<span class="op" id="6060515">+</span>&nbsp;<span class="ident" id="6060517">x0</span>&nbsp;<span class="op" id="6060520">-</span>&nbsp;<span class="ident" id="6060522">r</span><span class="op" id="6060523">.</span><span class="ident" id="6060524">Min</span><span class="op" id="6060527">.</span><span class="ident" id="6060528">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060531">mx0</span>&nbsp;<span class="op" id="6060535">:=</span>&nbsp;<span class="ident" id="6060538">mp</span><span class="op" id="6060540">.</span><span class="ident" id="6060541">X</span>&nbsp;<span class="op" id="6060543">+</span>&nbsp;<span class="ident" id="6060545">x0</span>&nbsp;<span class="op" id="6060548">-</span>&nbsp;<span class="ident" id="6060550">r</span><span class="op" id="6060551">.</span><span class="ident" id="6060552">Min</span><span class="op" id="6060555">.</span><span class="ident" id="6060556">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060559">sx1</span>&nbsp;<span class="op" id="6060563">:=</span>&nbsp;<span class="ident" id="6060566">sx0</span>&nbsp;<span class="op" id="6060570">+</span>&nbsp;<span class="op" id="6060572">(</span><span class="ident" id="6060573">x1</span>&nbsp;<span class="op" id="6060576">-</span>&nbsp;<span class="ident" id="6060578">x0</span><span class="op" id="6060580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060583">i0</span>&nbsp;<span class="op" id="6060586">:=</span>&nbsp;<span class="ident" id="6060589">dst</span><span class="op" id="6060592">.</span><span class="ident" id="6060593">PixOffset</span><span class="op" id="6060602">(</span><span class="ident" id="6060603">x0</span><span class="op" id="6060605">,</span>&nbsp;<span class="ident" id="6060607">y0</span><span class="op" id="6060609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060612">di</span>&nbsp;<span class="op" id="6060615">:=</span>&nbsp;<span class="ident" id="6060618">dx</span>&nbsp;<span class="op" id="6060621">*</span>&nbsp;<span class="num" id="6060623">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060626">for</span>&nbsp;<span class="ident" id="6060630">y</span>&nbsp;<span class="op" id="6060632">:=</span>&nbsp;<span class="ident" id="6060635">y0</span><span class="op" id="6060637">;</span>&nbsp;<span class="ident" id="6060639">y</span>&nbsp;<span class="op" id="6060641">!=</span>&nbsp;<span class="ident" id="6060644">y1</span><span class="op" id="6060646">;</span>&nbsp;<span class="ident" id="6060648">y</span><span class="op" id="6060649">,</span>&nbsp;<span class="ident" id="6060651">sy</span><span class="op" id="6060653">,</span>&nbsp;<span class="ident" id="6060655">my</span>&nbsp;<span class="op" id="6060658">=</span>&nbsp;<span class="ident" id="6060660">y</span><span class="op" id="6060661">+</span><span class="ident" id="6060662">dy</span><span class="op" id="6060664">,</span>&nbsp;<span class="ident" id="6060666">sy</span><span class="op" id="6060668">+</span><span class="ident" id="6060669">dy</span><span class="op" id="6060671">,</span>&nbsp;<span class="ident" id="6060673">my</span><span class="op" id="6060675">+</span><span class="ident" id="6060676">dy</span>&nbsp;<span class="op" id="6060679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060683">for</span>&nbsp;<span class="ident" id="6060687">i</span><span class="op" id="6060688">,</span>&nbsp;<span class="ident" id="6060690">sx</span><span class="op" id="6060692">,</span>&nbsp;<span class="ident" id="6060694">mx</span>&nbsp;<span class="op" id="6060697">:=</span>&nbsp;<span class="ident" id="6060700">i0</span><span class="op" id="6060702">,</span>&nbsp;<span class="ident" id="6060704">sx0</span><span class="op" id="6060707">,</span>&nbsp;<span class="ident" id="6060709">mx0</span><span class="op" id="6060712">;</span>&nbsp;<span class="ident" id="6060714">sx</span>&nbsp;<span class="op" id="6060717">!=</span>&nbsp;<span class="ident" id="6060720">sx1</span><span class="op" id="6060723">;</span>&nbsp;<span class="ident" id="6060725">i</span><span class="op" id="6060726">,</span>&nbsp;<span class="ident" id="6060728">sx</span><span class="op" id="6060730">,</span>&nbsp;<span class="ident" id="6060732">mx</span>&nbsp;<span class="op" id="6060735">=</span>&nbsp;<span class="ident" id="6060737">i</span><span class="op" id="6060738">+</span><span class="ident" id="6060739">di</span><span class="op" id="6060741">,</span>&nbsp;<span class="ident" id="6060743">sx</span><span class="op" id="6060745">+</span><span class="ident" id="6060746">dx</span><span class="op" id="6060748">,</span>&nbsp;<span class="ident" id="6060750">mx</span><span class="op" id="6060752">+</span><span class="ident" id="6060753">dx</span>&nbsp;<span class="op" id="6060756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060761">ma</span>&nbsp;<span class="op" id="6060764">:=</span>&nbsp;<span class="builtintype" id="6060767">uint32</span><span class="op" id="6060773">(</span><span class="ident" id="6060774">m</span><span class="op" id="6060775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060780">if</span>&nbsp;<span class="ident" id="6060783">mask</span>&nbsp;<span class="op" id="6060788">!=</span>&nbsp;<span class="ident" id="6060791">nil</span>&nbsp;<span class="op" id="6060795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060801">_</span><span class="op" id="6060802">,</span>&nbsp;<span class="ident" id="6060804">_</span><span class="op" id="6060805">,</span>&nbsp;<span class="ident" id="6060807">_</span><span class="op" id="6060808">,</span>&nbsp;<span class="ident" id="6060810">ma</span>&nbsp;<span class="op" id="6060813">=</span>&nbsp;<span class="ident" id="6060815">mask</span><span class="op" id="6060819">.</span><span class="ident" id="6060820">At</span><span class="op" id="6060822">(</span><span class="ident" id="6060823">mx</span><span class="op" id="6060825">,</span>&nbsp;<span class="ident" id="6060827">my</span><span class="op" id="6060829">)</span><span class="op" id="6060830">.</span><span class="ident" id="6060831">RGBA</span><span class="op" id="6060835">(</span><span class="op" id="6060836">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6060841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060846">sr</span><span class="op" id="6060848">,</span>&nbsp;<span class="ident" id="6060850">sg</span><span class="op" id="6060852">,</span>&nbsp;<span class="ident" id="6060854">sb</span><span class="op" id="6060856">,</span>&nbsp;<span class="ident" id="6060858">sa</span>&nbsp;<span class="op" id="6060861">:=</span>&nbsp;<span class="ident" id="6060864">src</span><span class="op" id="6060867">.</span><span class="ident" id="6060868">At</span><span class="op" id="6060870">(</span><span class="ident" id="6060871">sx</span><span class="op" id="6060873">,</span>&nbsp;<span class="ident" id="6060875">sy</span><span class="op" id="6060877">)</span><span class="op" id="6060878">.</span><span class="ident" id="6060879">RGBA</span><span class="op" id="6060883">(</span><span class="op" id="6060884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6060889">if</span>&nbsp;<span class="ident" id="6060892">op</span>&nbsp;<span class="op" id="6060895">==</span>&nbsp;<span class="ident" id="6060898">Over</span>&nbsp;<span class="op" id="6060903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060909">dr</span>&nbsp;<span class="op" id="6060912">:=</span>&nbsp;<span class="builtintype" id="6060915">uint32</span><span class="op" id="6060921">(</span><span class="ident" id="6060922">dst</span><span class="op" id="6060925">.</span><span class="ident" id="6060926">Pix</span><span class="op" id="6060929">[</span><span class="ident" id="6060930">i</span><span class="op" id="6060931">+</span><span class="num" id="6060932">0</span><span class="op" id="6060933">]</span><span class="op" id="6060934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060940">dg</span>&nbsp;<span class="op" id="6060943">:=</span>&nbsp;<span class="builtintype" id="6060946">uint32</span><span class="op" id="6060952">(</span><span class="ident" id="6060953">dst</span><span class="op" id="6060956">.</span><span class="ident" id="6060957">Pix</span><span class="op" id="6060960">[</span><span class="ident" id="6060961">i</span><span class="op" id="6060962">+</span><span class="num" id="6060963">1</span><span class="op" id="6060964">]</span><span class="op" id="6060965">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6060971">db</span>&nbsp;<span class="op" id="6060974">:=</span>&nbsp;<span class="builtintype" id="6060977">uint32</span><span class="op" id="6060983">(</span><span class="ident" id="6060984">dst</span><span class="op" id="6060987">.</span><span class="ident" id="6060988">Pix</span><span class="op" id="6060991">[</span><span class="ident" id="6060992">i</span><span class="op" id="6060993">+</span><span class="num" id="6060994">2</span><span class="op" id="6060995">]</span><span class="op" id="6060996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061002">da</span>&nbsp;<span class="op" id="6061005">:=</span>&nbsp;<span class="builtintype" id="6061008">uint32</span><span class="op" id="6061014">(</span><span class="ident" id="6061015">dst</span><span class="op" id="6061018">.</span><span class="ident" id="6061019">Pix</span><span class="op" id="6061022">[</span><span class="ident" id="6061023">i</span><span class="op" id="6061024">+</span><span class="num" id="6061025">3</span><span class="op" id="6061026">]</span><span class="op" id="6061027">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6061034">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6061114">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6061172">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6061193">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6061259">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6061324">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061396">a</span>&nbsp;<span class="op" id="6061398">:=</span>&nbsp;<span class="op" id="6061401">(</span><span class="ident" id="6061402">m</span>&nbsp;<span class="op" id="6061404">-</span>&nbsp;<span class="op" id="6061406">(</span><span class="ident" id="6061407">sa</span>&nbsp;<span class="op" id="6061410">*</span>&nbsp;<span class="ident" id="6061412">ma</span>&nbsp;<span class="op" id="6061415">/</span>&nbsp;<span class="ident" id="6061417">m</span><span class="op" id="6061418">)</span><span class="op" id="6061419">)</span>&nbsp;<span class="op" id="6061421">*</span>&nbsp;<span class="num" id="6061423">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061434">dst</span><span class="op" id="6061437">.</span><span class="ident" id="6061438">Pix</span><span class="op" id="6061441">[</span><span class="ident" id="6061442">i</span><span class="op" id="6061443">+</span><span class="num" id="6061444">0</span><span class="op" id="6061445">]</span>&nbsp;<span class="op" id="6061447">=</span>&nbsp;<span class="builtintype" id="6061449">uint8</span><span class="op" id="6061454">(</span><span class="op" id="6061455">(</span><span class="ident" id="6061456">dr</span><span class="op" id="6061458">*</span><span class="ident" id="6061459">a</span>&nbsp;<span class="op" id="6061461">+</span>&nbsp;<span class="ident" id="6061463">sr</span><span class="op" id="6061465">*</span><span class="ident" id="6061466">ma</span><span class="op" id="6061468">)</span>&nbsp;<span class="op" id="6061470">/</span>&nbsp;<span class="ident" id="6061472">m</span>&nbsp;<span class="op" id="6061474">&gt;&gt;</span>&nbsp;<span class="num" id="6061477">8</span><span class="op" id="6061478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061484">dst</span><span class="op" id="6061487">.</span><span class="ident" id="6061488">Pix</span><span class="op" id="6061491">[</span><span class="ident" id="6061492">i</span><span class="op" id="6061493">+</span><span class="num" id="6061494">1</span><span class="op" id="6061495">]</span>&nbsp;<span class="op" id="6061497">=</span>&nbsp;<span class="builtintype" id="6061499">uint8</span><span class="op" id="6061504">(</span><span class="op" id="6061505">(</span><span class="ident" id="6061506">dg</span><span class="op" id="6061508">*</span><span class="ident" id="6061509">a</span>&nbsp;<span class="op" id="6061511">+</span>&nbsp;<span class="ident" id="6061513">sg</span><span class="op" id="6061515">*</span><span class="ident" id="6061516">ma</span><span class="op" id="6061518">)</span>&nbsp;<span class="op" id="6061520">/</span>&nbsp;<span class="ident" id="6061522">m</span>&nbsp;<span class="op" id="6061524">&gt;&gt;</span>&nbsp;<span class="num" id="6061527">8</span><span class="op" id="6061528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061534">dst</span><span class="op" id="6061537">.</span><span class="ident" id="6061538">Pix</span><span class="op" id="6061541">[</span><span class="ident" id="6061542">i</span><span class="op" id="6061543">+</span><span class="num" id="6061544">2</span><span class="op" id="6061545">]</span>&nbsp;<span class="op" id="6061547">=</span>&nbsp;<span class="builtintype" id="6061549">uint8</span><span class="op" id="6061554">(</span><span class="op" id="6061555">(</span><span class="ident" id="6061556">db</span><span class="op" id="6061558">*</span><span class="ident" id="6061559">a</span>&nbsp;<span class="op" id="6061561">+</span>&nbsp;<span class="ident" id="6061563">sb</span><span class="op" id="6061565">*</span><span class="ident" id="6061566">ma</span><span class="op" id="6061568">)</span>&nbsp;<span class="op" id="6061570">/</span>&nbsp;<span class="ident" id="6061572">m</span>&nbsp;<span class="op" id="6061574">&gt;&gt;</span>&nbsp;<span class="num" id="6061577">8</span><span class="op" id="6061578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061584">dst</span><span class="op" id="6061587">.</span><span class="ident" id="6061588">Pix</span><span class="op" id="6061591">[</span><span class="ident" id="6061592">i</span><span class="op" id="6061593">+</span><span class="num" id="6061594">3</span><span class="op" id="6061595">]</span>&nbsp;<span class="op" id="6061597">=</span>&nbsp;<span class="builtintype" id="6061599">uint8</span><span class="op" id="6061604">(</span><span class="op" id="6061605">(</span><span class="ident" id="6061606">da</span><span class="op" id="6061608">*</span><span class="ident" id="6061609">a</span>&nbsp;<span class="op" id="6061611">+</span>&nbsp;<span class="ident" id="6061613">sa</span><span class="op" id="6061615">*</span><span class="ident" id="6061616">ma</span><span class="op" id="6061618">)</span>&nbsp;<span class="op" id="6061620">/</span>&nbsp;<span class="ident" id="6061622">m</span>&nbsp;<span class="op" id="6061624">&gt;&gt;</span>&nbsp;<span class="num" id="6061627">8</span><span class="op" id="6061628">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061634">}</span>&nbsp;<span class="keyword" id="6061636">else</span>&nbsp;<span class="op" id="6061641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061647">dst</span><span class="op" id="6061650">.</span><span class="ident" id="6061651">Pix</span><span class="op" id="6061654">[</span><span class="ident" id="6061655">i</span><span class="op" id="6061656">+</span><span class="num" id="6061657">0</span><span class="op" id="6061658">]</span>&nbsp;<span class="op" id="6061660">=</span>&nbsp;<span class="builtintype" id="6061662">uint8</span><span class="op" id="6061667">(</span><span class="ident" id="6061668">sr</span>&nbsp;<span class="op" id="6061671">*</span>&nbsp;<span class="ident" id="6061673">ma</span>&nbsp;<span class="op" id="6061676">/</span>&nbsp;<span class="ident" id="6061678">m</span>&nbsp;<span class="op" id="6061680">&gt;&gt;</span>&nbsp;<span class="num" id="6061683">8</span><span class="op" id="6061684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061690">dst</span><span class="op" id="6061693">.</span><span class="ident" id="6061694">Pix</span><span class="op" id="6061697">[</span><span class="ident" id="6061698">i</span><span class="op" id="6061699">+</span><span class="num" id="6061700">1</span><span class="op" id="6061701">]</span>&nbsp;<span class="op" id="6061703">=</span>&nbsp;<span class="builtintype" id="6061705">uint8</span><span class="op" id="6061710">(</span><span class="ident" id="6061711">sg</span>&nbsp;<span class="op" id="6061714">*</span>&nbsp;<span class="ident" id="6061716">ma</span>&nbsp;<span class="op" id="6061719">/</span>&nbsp;<span class="ident" id="6061721">m</span>&nbsp;<span class="op" id="6061723">&gt;&gt;</span>&nbsp;<span class="num" id="6061726">8</span><span class="op" id="6061727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061733">dst</span><span class="op" id="6061736">.</span><span class="ident" id="6061737">Pix</span><span class="op" id="6061740">[</span><span class="ident" id="6061741">i</span><span class="op" id="6061742">+</span><span class="num" id="6061743">2</span><span class="op" id="6061744">]</span>&nbsp;<span class="op" id="6061746">=</span>&nbsp;<span class="builtintype" id="6061748">uint8</span><span class="op" id="6061753">(</span><span class="ident" id="6061754">sb</span>&nbsp;<span class="op" id="6061757">*</span>&nbsp;<span class="ident" id="6061759">ma</span>&nbsp;<span class="op" id="6061762">/</span>&nbsp;<span class="ident" id="6061764">m</span>&nbsp;<span class="op" id="6061766">&gt;&gt;</span>&nbsp;<span class="num" id="6061769">8</span><span class="op" id="6061770">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061776">dst</span><span class="op" id="6061779">.</span><span class="ident" id="6061780">Pix</span><span class="op" id="6061783">[</span><span class="ident" id="6061784">i</span><span class="op" id="6061785">+</span><span class="num" id="6061786">3</span><span class="op" id="6061787">]</span>&nbsp;<span class="op" id="6061789">=</span>&nbsp;<span class="builtintype" id="6061791">uint8</span><span class="op" id="6061796">(</span><span class="ident" id="6061797">sa</span>&nbsp;<span class="op" id="6061800">*</span>&nbsp;<span class="ident" id="6061802">ma</span>&nbsp;<span class="op" id="6061805">/</span>&nbsp;<span class="ident" id="6061807">m</span>&nbsp;<span class="op" id="6061809">&gt;&gt;</span>&nbsp;<span class="num" id="6061812">8</span><span class="op" id="6061813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6061826">i0</span>&nbsp;<span class="op" id="6061829">+=</span>&nbsp;<span class="ident" id="6061832">dy</span>&nbsp;<span class="op" id="6061835">*</span>&nbsp;<span class="ident" id="6061837">dst</span><span class="op" id="6061840">.</span><span class="ident" id="6061841">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061849">}</span><br>
<span class="lineno">545</span><span class="op" id="6061851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6061854">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="6061901">func</span>&nbsp;<span class="ident" id="6061906">clamp</span><span class="op" id="6061911">(</span><span class="ident" id="6061912">i</span>&nbsp;<span class="builtintype" id="6061914">int32</span><span class="op" id="6061919">)</span>&nbsp;<span class="builtintype" id="6061921">int32</span>&nbsp;<span class="op" id="6061927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061930">if</span>&nbsp;<span class="ident" id="6061933">i</span>&nbsp;<span class="op" id="6061935">&lt;</span>&nbsp;<span class="num" id="6061937">0</span>&nbsp;<span class="op" id="6061939">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061943">return</span>&nbsp;<span class="num" id="6061950">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061956">if</span>&nbsp;<span class="ident" id="6061959">i</span>&nbsp;<span class="op" id="6061961">&gt;</span>&nbsp;<span class="num" id="6061963">0xffff</span>&nbsp;<span class="op" id="6061970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061974">return</span>&nbsp;<span class="num" id="6061981">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6061989">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6061992">return</span>&nbsp;<span class="ident" id="6061999">i</span><br>
<span class="lineno"></span><span class="op" id="6062001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6062004">func</span>&nbsp;<span class="ident" id="6062009">drawPaletted</span><span class="op" id="6062021">(</span><span class="ident" id="6062022">dst</span>&nbsp;<span class="ident" id="6062026">Image</span><span class="op" id="6062031">,</span>&nbsp;<span class="ident" id="6062033">r</span>&nbsp;<span class="ident" id="6062035">image</span><span class="op" id="6062040">.</span><span class="ident" id="6062041">Rectangle</span><span class="op" id="6062050">,</span>&nbsp;<span class="ident" id="6062052">src</span>&nbsp;<span class="ident" id="6062056">image</span><span class="op" id="6062061">.</span><span class="ident" id="6062062">Image</span><span class="op" id="6062067">,</span>&nbsp;<span class="ident" id="6062069">sp</span>&nbsp;<span class="ident" id="6062072">image</span><span class="op" id="6062077">.</span><span class="ident" id="6062078">Point</span><span class="op" id="6062083">,</span>&nbsp;<span class="ident" id="6062085">floydSteinberg</span>&nbsp;<span class="builtintype" id="6062100">bool</span><span class="op" id="6062104">)</span>&nbsp;<span class="op" id="6062106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062109">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062176">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062241">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062304">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062374">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062445">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062516">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062562">palette</span><span class="op" id="6062569">,</span>&nbsp;<span class="ident" id="6062571">pix</span><span class="op" id="6062574">,</span>&nbsp;<span class="ident" id="6062576">stride</span>&nbsp;<span class="op" id="6062583">:=</span>&nbsp;<span class="op" id="6062586">[</span><span class="op" id="6062587">]</span><span class="op" id="6062588">[</span><span class="num" id="6062589">3</span><span class="op" id="6062590">]</span><span class="builtintype" id="6062591">int32</span><span class="op" id="6062596">(</span><span class="ident" id="6062597">nil</span><span class="op" id="6062600">)</span><span class="op" id="6062601">,</span>&nbsp;<span class="op" id="6062603">[</span><span class="op" id="6062604">]</span><span class="builtintype" id="6062605">byte</span><span class="op" id="6062609">(</span><span class="ident" id="6062610">nil</span><span class="op" id="6062613">)</span><span class="op" id="6062614">,</span>&nbsp;<span class="num" id="6062616">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062619">if</span>&nbsp;<span class="ident" id="6062622">p</span><span class="op" id="6062623">,</span>&nbsp;<span class="ident" id="6062625">ok</span>&nbsp;<span class="op" id="6062628">:=</span>&nbsp;<span class="ident" id="6062631">dst</span><span class="op" id="6062634">.</span><span class="op" id="6062635">(</span><span class="op" id="6062636">*</span><span class="ident" id="6062637">image</span><span class="op" id="6062642">.</span><span class="ident" id="6062643">Paletted</span><span class="op" id="6062651">)</span><span class="op" id="6062652">;</span>&nbsp;<span class="ident" id="6062654">ok</span>&nbsp;<span class="op" id="6062657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062661">palette</span>&nbsp;<span class="op" id="6062669">=</span>&nbsp;<span class="builtinfunc" id="6062671">make</span><span class="op" id="6062675">(</span><span class="op" id="6062676">[</span><span class="op" id="6062677">]</span><span class="op" id="6062678">[</span><span class="num" id="6062679">3</span><span class="op" id="6062680">]</span><span class="builtintype" id="6062681">int32</span><span class="op" id="6062686">,</span>&nbsp;<span class="builtinfunc" id="6062688">len</span><span class="op" id="6062691">(</span><span class="ident" id="6062692">p</span><span class="op" id="6062693">.</span><span class="ident" id="6062694">Palette</span><span class="op" id="6062701">)</span><span class="op" id="6062702">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6062706">for</span>&nbsp;<span class="ident" id="6062710">i</span><span class="op" id="6062711">,</span>&nbsp;<span class="ident" id="6062713">col</span>&nbsp;<span class="op" id="6062717">:=</span>&nbsp;<span class="keyword" id="6062720">range</span>&nbsp;<span class="ident" id="6062726">p</span><span class="op" id="6062727">.</span><span class="ident" id="6062728">Palette</span>&nbsp;<span class="op" id="6062736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062741">r</span><span class="op" id="6062742">,</span>&nbsp;<span class="ident" id="6062744">g</span><span class="op" id="6062745">,</span>&nbsp;<span class="ident" id="6062747">b</span><span class="op" id="6062748">,</span>&nbsp;<span class="ident" id="6062750">_</span>&nbsp;<span class="op" id="6062752">:=</span>&nbsp;<span class="ident" id="6062755">col</span><span class="op" id="6062758">.</span><span class="ident" id="6062759">RGBA</span><span class="op" id="6062763">(</span><span class="op" id="6062764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062769">palette</span><span class="op" id="6062776">[</span><span class="ident" id="6062777">i</span><span class="op" id="6062778">]</span><span class="op" id="6062779">[</span><span class="num" id="6062780">0</span><span class="op" id="6062781">]</span>&nbsp;<span class="op" id="6062783">=</span>&nbsp;<span class="builtintype" id="6062785">int32</span><span class="op" id="6062790">(</span><span class="ident" id="6062791">r</span><span class="op" id="6062792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062797">palette</span><span class="op" id="6062804">[</span><span class="ident" id="6062805">i</span><span class="op" id="6062806">]</span><span class="op" id="6062807">[</span><span class="num" id="6062808">1</span><span class="op" id="6062809">]</span>&nbsp;<span class="op" id="6062811">=</span>&nbsp;<span class="builtintype" id="6062813">int32</span><span class="op" id="6062818">(</span><span class="ident" id="6062819">g</span><span class="op" id="6062820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062825">palette</span><span class="op" id="6062832">[</span><span class="ident" id="6062833">i</span><span class="op" id="6062834">]</span><span class="op" id="6062835">[</span><span class="num" id="6062836">2</span><span class="op" id="6062837">]</span>&nbsp;<span class="op" id="6062839">=</span>&nbsp;<span class="builtintype" id="6062841">int32</span><span class="op" id="6062846">(</span><span class="ident" id="6062847">b</span><span class="op" id="6062848">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6062852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6062856">pix</span><span class="op" id="6062859">,</span>&nbsp;<span class="ident" id="6062861">stride</span>&nbsp;<span class="op" id="6062868">=</span>&nbsp;<span class="ident" id="6062870">p</span><span class="op" id="6062871">.</span><span class="ident" id="6062872">Pix</span><span class="op" id="6062875">[</span><span class="ident" id="6062876">p</span><span class="op" id="6062877">.</span><span class="ident" id="6062878">PixOffset</span><span class="op" id="6062887">(</span><span class="ident" id="6062888">r</span><span class="op" id="6062889">.</span><span class="ident" id="6062890">Min</span><span class="op" id="6062893">.</span><span class="ident" id="6062894">X</span><span class="op" id="6062895">,</span>&nbsp;<span class="ident" id="6062897">r</span><span class="op" id="6062898">.</span><span class="ident" id="6062899">Min</span><span class="op" id="6062902">.</span><span class="ident" id="6062903">Y</span><span class="op" id="6062904">)</span><span class="op" id="6062905">:</span><span class="op" id="6062906">]</span><span class="op" id="6062907">,</span>&nbsp;<span class="ident" id="6062909">p</span><span class="op" id="6062910">.</span><span class="ident" id="6062911">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6062919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062923">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6062998">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6063073">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6063129">var</span>&nbsp;<span class="ident" id="6063133">quantErrorCurr</span><span class="op" id="6063147">,</span>&nbsp;<span class="ident" id="6063149">quantErrorNext</span>&nbsp;<span class="op" id="6063164">[</span><span class="op" id="6063165">]</span><span class="op" id="6063166">[</span><span class="num" id="6063167">3</span><span class="op" id="6063168">]</span><span class="builtintype" id="6063169">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6063176">if</span>&nbsp;<span class="ident" id="6063179">floydSteinberg</span>&nbsp;<span class="op" id="6063194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6063198">quantErrorCurr</span>&nbsp;<span class="op" id="6063213">=</span>&nbsp;<span class="builtinfunc" id="6063215">make</span><span class="op" id="6063219">(</span><span class="op" id="6063220">[</span><span class="op" id="6063221">]</span><span class="op" id="6063222">[</span><span class="num" id="6063223">3</span><span class="op" id="6063224">]</span><span class="builtintype" id="6063225">int32</span><span class="op" id="6063230">,</span>&nbsp;<span class="ident" id="6063232">r</span><span class="op" id="6063233">.</span><span class="ident" id="6063234">Dx</span><span class="op" id="6063236">(</span><span class="op" id="6063237">)</span><span class="op" id="6063238">+</span><span class="num" id="6063239">2</span><span class="op" id="6063240">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6063244">quantErrorNext</span>&nbsp;<span class="op" id="6063259">=</span>&nbsp;<span class="builtinfunc" id="6063261">make</span><span class="op" id="6063265">(</span><span class="op" id="6063266">[</span><span class="op" id="6063267">]</span><span class="op" id="6063268">[</span><span class="num" id="6063269">3</span><span class="op" id="6063270">]</span><span class="builtintype" id="6063271">int32</span><span class="op" id="6063276">,</span>&nbsp;<span class="ident" id="6063278">r</span><span class="op" id="6063279">.</span><span class="ident" id="6063280">Dx</span><span class="op" id="6063282">(</span><span class="op" id="6063283">)</span><span class="op" id="6063284">+</span><span class="num" id="6063285">2</span><span class="op" id="6063286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6063289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6063293">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6063326">out</span>&nbsp;<span class="op" id="6063330">:=</span>&nbsp;<span class="ident" id="6063333">color</span><span class="op" id="6063338">.</span><span class="ident" id="6063339">RGBA64</span><span class="op" id="6063345">{</span><span class="ident" id="6063346">A</span><span class="op" id="6063347">:</span>&nbsp;<span class="num" id="6063349">0xffff</span><span class="op" id="6063355">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6063358">for</span>&nbsp;<span class="ident" id="6063362">y</span>&nbsp;<span class="op" id="6063364">:=</span>&nbsp;<span class="num" id="6063367">0</span><span class="op" id="6063368">;</span>&nbsp;<span class="ident" id="6063370">y</span>&nbsp;<span class="op" id="6063372">!=</span>&nbsp;<span class="ident" id="6063375">r</span><span class="op" id="6063376">.</span><span class="ident" id="6063377">Dy</span><span class="op" id="6063379">(</span><span class="op" id="6063380">)</span><span class="op" id="6063381">;</span>&nbsp;<span class="ident" id="6063383">y</span><span class="op" id="6063384">++</span>&nbsp;<span class="op" id="6063387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6063391">for</span>&nbsp;<span class="ident" id="6063395">x</span>&nbsp;<span class="op" id="6063397">:=</span>&nbsp;<span class="num" id="6063400">0</span><span class="op" id="6063401">;</span>&nbsp;<span class="ident" id="6063403">x</span>&nbsp;<span class="op" id="6063405">!=</span>&nbsp;<span class="ident" id="6063408">r</span><span class="op" id="6063409">.</span><span class="ident" id="6063410">Dx</span><span class="op" id="6063412">(</span><span class="op" id="6063413">)</span><span class="op" id="6063414">;</span>&nbsp;<span class="ident" id="6063416">x</span><span class="op" id="6063417">++</span>&nbsp;<span class="op" id="6063420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6063425">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6063483">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6063521">sr</span><span class="op" id="6063523">,</span>&nbsp;<span class="ident" id="6063525">sg</span><span class="op" id="6063527">,</span>&nbsp;<span class="ident" id="6063529">sb</span><span class="op" id="6063531">,</span>&nbsp;<span class="ident" id="6063533">_</span>&nbsp;<span class="op" id="6063535">:=</span>&nbsp;<span class="ident" id="6063538">src</span><span class="op" id="6063541">.</span><span class="ident" id="6063542">At</span><span class="op" id="6063544">(</span><span class="ident" id="6063545">sp</span><span class="op" id="6063547">.</span><span class="ident" id="6063548">X</span><span class="op" id="6063549">+</span><span class="ident" id="6063550">x</span><span class="op" id="6063551">,</span>&nbsp;<span class="ident" id="6063553">sp</span><span class="op" id="6063555">.</span><span class="ident" id="6063556">Y</span><span class="op" id="6063557">+</span><span class="ident" id="6063558">y</span><span class="op" id="6063559">)</span><span class="op" id="6063560">.</span><span class="ident" id="6063561">RGBA</span><span class="op" id="6063565">(</span><span class="op" id="6063566">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6063571">er</span><span class="op" id="6063573">,</span>&nbsp;<span class="ident" id="6063575">eg</span><span class="op" id="6063577">,</span>&nbsp;<span class="ident" id="6063579">eb</span>&nbsp;<span class="op" id="6063582">:=</span>&nbsp;<span class="builtintype" id="6063585">int32</span><span class="op" id="6063590">(</span><span class="ident" id="6063591">sr</span><span class="op" id="6063593">)</span><span class="op" id="6063594">,</span>&nbsp;<span class="builtintype" id="6063596">int32</span><span class="op" id="6063601">(</span><span class="ident" id="6063602">sg</span><span class="op" id="6063604">)</span><span class="op" id="6063605">,</span>&nbsp;<span class="builtintype" id="6063607">int32</span><span class="op" id="6063612">(</span><span class="ident" id="6063613">sb</span><span class="op" id="6063615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6063620">if</span>&nbsp;<span class="ident" id="6063623">floydSteinberg</span>&nbsp;<span class="op" id="6063638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6063644">er</span>&nbsp;<span class="op" id="6063647">=</span>&nbsp;<span class="ident" id="6063649">clamp</span><span class="op" id="6063654">(</span><span class="ident" id="6063655">er</span>&nbsp;<span class="op" id="6063658">+</span>&nbsp;<span class="ident" id="6063660">quantErrorCurr</span><span class="op" id="6063674">[</span><span class="ident" id="6063675">x</span><span class="op" id="6063676">+</span><span class="num" id="6063677">1</span><span class="op" id="6063678">]</span><span class="op" id="6063679">[</span><span class="num" id="6063680">0</span><span class="op" id="6063681">]</span><span class="op" id="6063682">/</span><span class="num" id="6063683">16</span><span class="op" id="6063685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6063691">eg</span>&nbsp;<span class="op" id="6063694">=</span>&nbsp;<span class="ident" id="6063696">clamp</span><span class="op" id="6063701">(</span><span class="ident" id="6063702">eg</span>&nbsp;<span class="op" id="6063705">+</span>&nbsp;<span class="ident" id="6063707">quantErrorCurr</span><span class="op" id="6063721">[</span><span class="ident" id="6063722">x</span><span class="op" id="6063723">+</span><span class="num" id="6063724">1</span><span class="op" id="6063725">]</span><span class="op" id="6063726">[</span><span class="num" id="6063727">1</span><span class="op" id="6063728">]</span><span class="op" id="6063729">/</span><span class="num" id="6063730">16</span><span class="op" id="6063732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6063738">eb</span>&nbsp;<span class="op" id="6063741">=</span>&nbsp;<span class="ident" id="6063743">clamp</span><span class="op" id="6063748">(</span><span class="ident" id="6063749">eb</span>&nbsp;<span class="op" id="6063752">+</span>&nbsp;<span class="ident" id="6063754">quantErrorCurr</span><span class="op" id="6063768">[</span><span class="ident" id="6063769">x</span><span class="op" id="6063770">+</span><span class="num" id="6063771">1</span><span class="op" id="6063772">]</span><span class="op" id="6063773">[</span><span class="num" id="6063774">2</span><span class="op" id="6063775">]</span><span class="op" id="6063776">/</span><span class="num" id="6063777">16</span><span class="op" id="6063779">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6063784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6063790">if</span>&nbsp;<span class="ident" id="6063793">palette</span>&nbsp;<span class="op" id="6063801">!=</span>&nbsp;<span class="ident" id="6063804">nil</span>&nbsp;<span class="op" id="6063808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6063814">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6063882">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6063950">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6064019">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064071">bestIndex</span><span class="op" id="6064080">,</span>&nbsp;<span class="ident" id="6064082">bestSSD</span>&nbsp;<span class="op" id="6064090">:=</span>&nbsp;<span class="num" id="6064093">0</span><span class="op" id="6064094">,</span>&nbsp;<span class="builtintype" id="6064096">uint32</span><span class="op" id="6064102">(</span><span class="num" id="6064103">1</span><span class="op" id="6064104">&lt;&lt;</span><span class="num" id="6064106">32</span><span class="op" id="6064108">-</span><span class="num" id="6064109">1</span><span class="op" id="6064110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6064116">for</span>&nbsp;<span class="ident" id="6064120">index</span><span class="op" id="6064125">,</span>&nbsp;<span class="ident" id="6064127">p</span>&nbsp;<span class="op" id="6064129">:=</span>&nbsp;<span class="keyword" id="6064132">range</span>&nbsp;<span class="ident" id="6064138">palette</span>&nbsp;<span class="op" id="6064146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064153">delta</span>&nbsp;<span class="op" id="6064159">:=</span>&nbsp;<span class="op" id="6064162">(</span><span class="ident" id="6064163">er</span>&nbsp;<span class="op" id="6064166">-</span>&nbsp;<span class="ident" id="6064168">p</span><span class="op" id="6064169">[</span><span class="num" id="6064170">0</span><span class="op" id="6064171">]</span><span class="op" id="6064172">)</span>&nbsp;<span class="op" id="6064174">&gt;&gt;</span>&nbsp;<span class="num" id="6064177">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064184">ssd</span>&nbsp;<span class="op" id="6064188">:=</span>&nbsp;<span class="builtintype" id="6064191">uint32</span><span class="op" id="6064197">(</span><span class="ident" id="6064198">delta</span>&nbsp;<span class="op" id="6064204">*</span>&nbsp;<span class="ident" id="6064206">delta</span><span class="op" id="6064211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064218">delta</span>&nbsp;<span class="op" id="6064224">=</span>&nbsp;<span class="op" id="6064226">(</span><span class="ident" id="6064227">eg</span>&nbsp;<span class="op" id="6064230">-</span>&nbsp;<span class="ident" id="6064232">p</span><span class="op" id="6064233">[</span><span class="num" id="6064234">1</span><span class="op" id="6064235">]</span><span class="op" id="6064236">)</span>&nbsp;<span class="op" id="6064238">&gt;&gt;</span>&nbsp;<span class="num" id="6064241">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064248">ssd</span>&nbsp;<span class="op" id="6064252">+=</span>&nbsp;<span class="builtintype" id="6064255">uint32</span><span class="op" id="6064261">(</span><span class="ident" id="6064262">delta</span>&nbsp;<span class="op" id="6064268">*</span>&nbsp;<span class="ident" id="6064270">delta</span><span class="op" id="6064275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064282">delta</span>&nbsp;<span class="op" id="6064288">=</span>&nbsp;<span class="op" id="6064290">(</span><span class="ident" id="6064291">eb</span>&nbsp;<span class="op" id="6064294">-</span>&nbsp;<span class="ident" id="6064296">p</span><span class="op" id="6064297">[</span><span class="num" id="6064298">2</span><span class="op" id="6064299">]</span><span class="op" id="6064300">)</span>&nbsp;<span class="op" id="6064302">&gt;&gt;</span>&nbsp;<span class="num" id="6064305">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064312">ssd</span>&nbsp;<span class="op" id="6064316">+=</span>&nbsp;<span class="builtintype" id="6064319">uint32</span><span class="op" id="6064325">(</span><span class="ident" id="6064326">delta</span>&nbsp;<span class="op" id="6064332">*</span>&nbsp;<span class="ident" id="6064334">delta</span><span class="op" id="6064339">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6064346">if</span>&nbsp;<span class="ident" id="6064349">ssd</span>&nbsp;<span class="op" id="6064353">&lt;</span>&nbsp;<span class="ident" id="6064355">bestSSD</span>&nbsp;<span class="op" id="6064363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064371">bestIndex</span><span class="op" id="6064380">,</span>&nbsp;<span class="ident" id="6064382">bestSSD</span>&nbsp;<span class="op" id="6064390">=</span>&nbsp;<span class="ident" id="6064392">index</span><span class="op" id="6064397">,</span>&nbsp;<span class="ident" id="6064399">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6064409">if</span>&nbsp;<span class="ident" id="6064412">ssd</span>&nbsp;<span class="op" id="6064416">==</span>&nbsp;<span class="num" id="6064419">0</span>&nbsp;<span class="op" id="6064421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6064430">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6064442">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6064449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6064455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064461">pix</span><span class="op" id="6064464">[</span><span class="ident" id="6064465">y</span><span class="op" id="6064466">*</span><span class="ident" id="6064467">stride</span><span class="op" id="6064473">+</span><span class="ident" id="6064474">x</span><span class="op" id="6064475">]</span>&nbsp;<span class="op" id="6064477">=</span>&nbsp;<span class="builtintype" id="6064479">byte</span><span class="op" id="6064483">(</span><span class="ident" id="6064484">bestIndex</span><span class="op" id="6064493">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6064500">if</span>&nbsp;<span class="op" id="6064503">!</span><span class="ident" id="6064504">floydSteinberg</span>&nbsp;<span class="op" id="6064519">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6064526">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6064539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064545">er</span>&nbsp;<span class="op" id="6064548">-=</span>&nbsp;<span class="builtintype" id="6064551">int32</span><span class="op" id="6064556">(</span><span class="ident" id="6064557">palette</span><span class="op" id="6064564">[</span><span class="ident" id="6064565">bestIndex</span><span class="op" id="6064574">]</span><span class="op" id="6064575">[</span><span class="num" id="6064576">0</span><span class="op" id="6064577">]</span><span class="op" id="6064578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064584">eg</span>&nbsp;<span class="op" id="6064587">-=</span>&nbsp;<span class="builtintype" id="6064590">int32</span><span class="op" id="6064595">(</span><span class="ident" id="6064596">palette</span><span class="op" id="6064603">[</span><span class="ident" id="6064604">bestIndex</span><span class="op" id="6064613">]</span><span class="op" id="6064614">[</span><span class="num" id="6064615">1</span><span class="op" id="6064616">]</span><span class="op" id="6064617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064623">eb</span>&nbsp;<span class="op" id="6064626">-=</span>&nbsp;<span class="builtintype" id="6064629">int32</span><span class="op" id="6064634">(</span><span class="ident" id="6064635">palette</span><span class="op" id="6064642">[</span><span class="ident" id="6064643">bestIndex</span><span class="op" id="6064652">]</span><span class="op" id="6064653">[</span><span class="num" id="6064654">2</span><span class="op" id="6064655">]</span><span class="op" id="6064656">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6064662">}</span>&nbsp;<span class="keyword" id="6064664">else</span>&nbsp;<span class="op" id="6064669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064675">out</span><span class="op" id="6064678">.</span><span class="ident" id="6064679">R</span>&nbsp;<span class="op" id="6064681">=</span>&nbsp;<span class="builtintype" id="6064683">uint16</span><span class="op" id="6064689">(</span><span class="ident" id="6064690">er</span><span class="op" id="6064692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064698">out</span><span class="op" id="6064701">.</span><span class="ident" id="6064702">G</span>&nbsp;<span class="op" id="6064704">=</span>&nbsp;<span class="builtintype" id="6064706">uint16</span><span class="op" id="6064712">(</span><span class="ident" id="6064713">eg</span><span class="op" id="6064715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064721">out</span><span class="op" id="6064724">.</span><span class="ident" id="6064725">B</span>&nbsp;<span class="op" id="6064727">=</span>&nbsp;<span class="builtintype" id="6064729">uint16</span><span class="op" id="6064735">(</span><span class="ident" id="6064736">eb</span><span class="op" id="6064738">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6064744">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6064805">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6064870">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6064933">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6064994">dst</span><span class="op" id="6064997">.</span><span class="ident" id="6064998">Set</span><span class="op" id="6065001">(</span><span class="ident" id="6065002">r</span><span class="op" id="6065003">.</span><span class="ident" id="6065004">Min</span><span class="op" id="6065007">.</span><span class="ident" id="6065008">X</span><span class="op" id="6065009">+</span><span class="ident" id="6065010">x</span><span class="op" id="6065011">,</span>&nbsp;<span class="ident" id="6065013">r</span><span class="op" id="6065014">.</span><span class="ident" id="6065015">Min</span><span class="op" id="6065018">.</span><span class="ident" id="6065019">Y</span><span class="op" id="6065020">+</span><span class="ident" id="6065021">y</span><span class="op" id="6065022">,</span>&nbsp;<span class="op" id="6065024">&amp;</span><span class="ident" id="6065025">out</span><span class="op" id="6065028">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6065035">if</span>&nbsp;<span class="op" id="6065038">!</span><span class="ident" id="6065039">floydSteinberg</span>&nbsp;<span class="op" id="6065054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6065061">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6065074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065080">sr</span><span class="op" id="6065082">,</span>&nbsp;<span class="ident" id="6065084">sg</span><span class="op" id="6065086">,</span>&nbsp;<span class="ident" id="6065088">sb</span><span class="op" id="6065090">,</span>&nbsp;<span class="ident" id="6065092">_</span>&nbsp;<span class="op" id="6065094">=</span>&nbsp;<span class="ident" id="6065096">dst</span><span class="op" id="6065099">.</span><span class="ident" id="6065100">At</span><span class="op" id="6065102">(</span><span class="ident" id="6065103">r</span><span class="op" id="6065104">.</span><span class="ident" id="6065105">Min</span><span class="op" id="6065108">.</span><span class="ident" id="6065109">X</span><span class="op" id="6065110">+</span><span class="ident" id="6065111">x</span><span class="op" id="6065112">,</span>&nbsp;<span class="ident" id="6065114">r</span><span class="op" id="6065115">.</span><span class="ident" id="6065116">Min</span><span class="op" id="6065119">.</span><span class="ident" id="6065120">Y</span><span class="op" id="6065121">+</span><span class="ident" id="6065122">y</span><span class="op" id="6065123">)</span><span class="op" id="6065124">.</span><span class="ident" id="6065125">RGBA</span><span class="op" id="6065129">(</span><span class="op" id="6065130">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065136">er</span>&nbsp;<span class="op" id="6065139">-=</span>&nbsp;<span class="builtintype" id="6065142">int32</span><span class="op" id="6065147">(</span><span class="ident" id="6065148">sr</span><span class="op" id="6065150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065156">eg</span>&nbsp;<span class="op" id="6065159">-=</span>&nbsp;<span class="builtintype" id="6065162">int32</span><span class="op" id="6065167">(</span><span class="ident" id="6065168">sg</span><span class="op" id="6065170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065176">eb</span>&nbsp;<span class="op" id="6065179">-=</span>&nbsp;<span class="builtintype" id="6065182">int32</span><span class="op" id="6065187">(</span><span class="ident" id="6065188">sb</span><span class="op" id="6065190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6065195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6065201">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065257">quantErrorNext</span><span class="op" id="6065271">[</span><span class="ident" id="6065272">x</span><span class="op" id="6065273">+</span><span class="num" id="6065274">0</span><span class="op" id="6065275">]</span><span class="op" id="6065276">[</span><span class="num" id="6065277">0</span><span class="op" id="6065278">]</span>&nbsp;<span class="op" id="6065280">+=</span>&nbsp;<span class="ident" id="6065283">er</span>&nbsp;<span class="op" id="6065286">*</span>&nbsp;<span class="num" id="6065288">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065293">quantErrorNext</span><span class="op" id="6065307">[</span><span class="ident" id="6065308">x</span><span class="op" id="6065309">+</span><span class="num" id="6065310">0</span><span class="op" id="6065311">]</span><span class="op" id="6065312">[</span><span class="num" id="6065313">1</span><span class="op" id="6065314">]</span>&nbsp;<span class="op" id="6065316">+=</span>&nbsp;<span class="ident" id="6065319">eg</span>&nbsp;<span class="op" id="6065322">*</span>&nbsp;<span class="num" id="6065324">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065329">quantErrorNext</span><span class="op" id="6065343">[</span><span class="ident" id="6065344">x</span><span class="op" id="6065345">+</span><span class="num" id="6065346">0</span><span class="op" id="6065347">]</span><span class="op" id="6065348">[</span><span class="num" id="6065349">2</span><span class="op" id="6065350">]</span>&nbsp;<span class="op" id="6065352">+=</span>&nbsp;<span class="ident" id="6065355">eb</span>&nbsp;<span class="op" id="6065358">*</span>&nbsp;<span class="num" id="6065360">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065365">quantErrorNext</span><span class="op" id="6065379">[</span><span class="ident" id="6065380">x</span><span class="op" id="6065381">+</span><span class="num" id="6065382">1</span><span class="op" id="6065383">]</span><span class="op" id="6065384">[</span><span class="num" id="6065385">0</span><span class="op" id="6065386">]</span>&nbsp;<span class="op" id="6065388">+=</span>&nbsp;<span class="ident" id="6065391">er</span>&nbsp;<span class="op" id="6065394">*</span>&nbsp;<span class="num" id="6065396">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065401">quantErrorNext</span><span class="op" id="6065415">[</span><span class="ident" id="6065416">x</span><span class="op" id="6065417">+</span><span class="num" id="6065418">1</span><span class="op" id="6065419">]</span><span class="op" id="6065420">[</span><span class="num" id="6065421">1</span><span class="op" id="6065422">]</span>&nbsp;<span class="op" id="6065424">+=</span>&nbsp;<span class="ident" id="6065427">eg</span>&nbsp;<span class="op" id="6065430">*</span>&nbsp;<span class="num" id="6065432">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065437">quantErrorNext</span><span class="op" id="6065451">[</span><span class="ident" id="6065452">x</span><span class="op" id="6065453">+</span><span class="num" id="6065454">1</span><span class="op" id="6065455">]</span><span class="op" id="6065456">[</span><span class="num" id="6065457">2</span><span class="op" id="6065458">]</span>&nbsp;<span class="op" id="6065460">+=</span>&nbsp;<span class="ident" id="6065463">eb</span>&nbsp;<span class="op" id="6065466">*</span>&nbsp;<span class="num" id="6065468">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065473">quantErrorNext</span><span class="op" id="6065487">[</span><span class="ident" id="6065488">x</span><span class="op" id="6065489">+</span><span class="num" id="6065490">2</span><span class="op" id="6065491">]</span><span class="op" id="6065492">[</span><span class="num" id="6065493">0</span><span class="op" id="6065494">]</span>&nbsp;<span class="op" id="6065496">+=</span>&nbsp;<span class="ident" id="6065499">er</span>&nbsp;<span class="op" id="6065502">*</span>&nbsp;<span class="num" id="6065504">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065509">quantErrorNext</span><span class="op" id="6065523">[</span><span class="ident" id="6065524">x</span><span class="op" id="6065525">+</span><span class="num" id="6065526">2</span><span class="op" id="6065527">]</span><span class="op" id="6065528">[</span><span class="num" id="6065529">1</span><span class="op" id="6065530">]</span>&nbsp;<span class="op" id="6065532">+=</span>&nbsp;<span class="ident" id="6065535">eg</span>&nbsp;<span class="op" id="6065538">*</span>&nbsp;<span class="num" id="6065540">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065545">quantErrorNext</span><span class="op" id="6065559">[</span><span class="ident" id="6065560">x</span><span class="op" id="6065561">+</span><span class="num" id="6065562">2</span><span class="op" id="6065563">]</span><span class="op" id="6065564">[</span><span class="num" id="6065565">2</span><span class="op" id="6065566">]</span>&nbsp;<span class="op" id="6065568">+=</span>&nbsp;<span class="ident" id="6065571">eb</span>&nbsp;<span class="op" id="6065574">*</span>&nbsp;<span class="num" id="6065576">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065581">quantErrorCurr</span><span class="op" id="6065595">[</span><span class="ident" id="6065596">x</span><span class="op" id="6065597">+</span><span class="num" id="6065598">2</span><span class="op" id="6065599">]</span><span class="op" id="6065600">[</span><span class="num" id="6065601">0</span><span class="op" id="6065602">]</span>&nbsp;<span class="op" id="6065604">+=</span>&nbsp;<span class="ident" id="6065607">er</span>&nbsp;<span class="op" id="6065610">*</span>&nbsp;<span class="num" id="6065612">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065617">quantErrorCurr</span><span class="op" id="6065631">[</span><span class="ident" id="6065632">x</span><span class="op" id="6065633">+</span><span class="num" id="6065634">2</span><span class="op" id="6065635">]</span><span class="op" id="6065636">[</span><span class="num" id="6065637">1</span><span class="op" id="6065638">]</span>&nbsp;<span class="op" id="6065640">+=</span>&nbsp;<span class="ident" id="6065643">eg</span>&nbsp;<span class="op" id="6065646">*</span>&nbsp;<span class="num" id="6065648">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065653">quantErrorCurr</span><span class="op" id="6065667">[</span><span class="ident" id="6065668">x</span><span class="op" id="6065669">+</span><span class="num" id="6065670">2</span><span class="op" id="6065671">]</span><span class="op" id="6065672">[</span><span class="num" id="6065673">2</span><span class="op" id="6065674">]</span>&nbsp;<span class="op" id="6065676">+=</span>&nbsp;<span class="ident" id="6065679">eb</span>&nbsp;<span class="op" id="6065682">*</span>&nbsp;<span class="num" id="6065684">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6065688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6065693">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6065738">if</span>&nbsp;<span class="ident" id="6065741">floydSteinberg</span>&nbsp;<span class="op" id="6065756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065761">quantErrorCurr</span><span class="op" id="6065775">,</span>&nbsp;<span class="ident" id="6065777">quantErrorNext</span>&nbsp;<span class="op" id="6065792">=</span>&nbsp;<span class="ident" id="6065794">quantErrorNext</span><span class="op" id="6065808">,</span>&nbsp;<span class="ident" id="6065810">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6065828">for</span>&nbsp;<span class="ident" id="6065832">i</span>&nbsp;<span class="op" id="6065834">:=</span>&nbsp;<span class="keyword" id="6065837">range</span>&nbsp;<span class="ident" id="6065843">quantErrorNext</span>&nbsp;<span class="op" id="6065858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6065864">quantErrorNext</span><span class="op" id="6065878">[</span><span class="ident" id="6065879">i</span><span class="op" id="6065880">]</span>&nbsp;<span class="op" id="6065882">=</span>&nbsp;<span class="op" id="6065884">[</span><span class="num" id="6065885">3</span><span class="op" id="6065886">]</span><span class="builtintype" id="6065887">int32</span><span class="op" id="6065892">{</span><span class="op" id="6065893">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6065898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6065902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6065905">}</span><br>
<span class="lineno"></span><span class="op" id="6065907">}</span>
</div>
</body>
</html>
