<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html" class="current">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3341957">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3342013">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3342067">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3342118">package</span>&nbsp;<span class="ident" id="3342126">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3342131">import</span>&nbsp;<span class="string" id="3342138">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3342146">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3342204">type</span>&nbsp;<span class="ident" id="3342209">call</span>&nbsp;<span class="keyword" id="3342214">struct</span>&nbsp;<span class="op" id="3342221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342224">wg</span>&nbsp;<span class="ident" id="3342227">sync</span><span class="op" id="3342231">.</span><span class="ident" id="3342232">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3342244">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3342307">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342358">val</span>&nbsp;<span class="keyword" id="3342362">interface</span><span class="op" id="3342371">{</span><span class="op" id="3342372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342375">err</span>&nbsp;<span class="builtintype" id="3342379">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3342387">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3342447">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3342509">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342554">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3342560">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342565">chans</span>&nbsp;<span class="op" id="3342571">[</span><span class="op" id="3342572">]</span><span class="keyword" id="3342573">chan</span><span class="op" id="3342577">&lt;-</span>&nbsp;<span class="ident" id="3342580">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3342599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3342602">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3342670">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3342737">type</span>&nbsp;<span class="ident" id="3342742">singleflight</span>&nbsp;<span class="keyword" id="3342755">struct</span>&nbsp;<span class="op" id="3342762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342765">mu</span>&nbsp;<span class="ident" id="3342768">sync</span><span class="op" id="3342772">.</span><span class="ident" id="3342773">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3342785">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342800">m</span>&nbsp;&nbsp;<span class="keyword" id="3342803">map</span><span class="op" id="3342806">[</span><span class="builtintype" id="3342807">string</span><span class="op" id="3342813">]</span><span class="op" id="3342814">*</span><span class="ident" id="3342815">call</span>&nbsp;<span class="comment" id="3342820">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3342842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3342845">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3342914">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3342931">type</span>&nbsp;<span class="ident" id="3342936">singleflightResult</span>&nbsp;<span class="keyword" id="3342955">struct</span>&nbsp;<span class="op" id="3342962">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342965">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3342972">interface</span><span class="op" id="3342981">{</span><span class="op" id="3342982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342985">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3342992">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3342999">shared</span>&nbsp;<span class="builtintype" id="3343006">bool</span><br>
<span class="lineno"></span><span class="op" id="3343011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3343014">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3343083">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3343149">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3343218">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3343273">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3343351">func</span>&nbsp;<span class="op" id="3343356">(</span><span class="ident" id="3343357">g</span>&nbsp;<span class="op" id="3343359">*</span><span class="ident" id="3343360">singleflight</span><span class="op" id="3343372">)</span>&nbsp;<span class="ident" id="3343374">Do</span><span class="op" id="3343376">(</span><span class="ident" id="3343377">key</span>&nbsp;<span class="builtintype" id="3343381">string</span><span class="op" id="3343387">,</span>&nbsp;<span class="ident" id="3343389">fn</span>&nbsp;<span class="keyword" id="3343392">func</span><span class="op" id="3343396">(</span><span class="op" id="3343397">)</span>&nbsp;<span class="op" id="3343399">(</span><span class="keyword" id="3343400">interface</span><span class="op" id="3343409">{</span><span class="op" id="3343410">}</span><span class="op" id="3343411">,</span>&nbsp;<span class="builtintype" id="3343413">error</span><span class="op" id="3343418">)</span><span class="op" id="3343419">)</span>&nbsp;<span class="op" id="3343421">(</span><span class="ident" id="3343422">v</span>&nbsp;<span class="keyword" id="3343424">interface</span><span class="op" id="3343433">{</span><span class="op" id="3343434">}</span><span class="op" id="3343435">,</span>&nbsp;<span class="ident" id="3343437">err</span>&nbsp;<span class="builtintype" id="3343441">error</span><span class="op" id="3343446">,</span>&nbsp;<span class="ident" id="3343448">shared</span>&nbsp;<span class="builtintype" id="3343455">bool</span><span class="op" id="3343459">)</span>&nbsp;<span class="op" id="3343461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343464">g</span><span class="op" id="3343465">.</span><span class="ident" id="3343466">mu</span><span class="op" id="3343468">.</span><span class="ident" id="3343469">Lock</span><span class="op" id="3343473">(</span><span class="op" id="3343474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3343477">if</span>&nbsp;<span class="ident" id="3343480">g</span><span class="op" id="3343481">.</span><span class="ident" id="3343482">m</span>&nbsp;<span class="op" id="3343484">==</span>&nbsp;<span class="builtintype" id="3343487">nil</span>&nbsp;<span class="op" id="3343491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343495">g</span><span class="op" id="3343496">.</span><span class="ident" id="3343497">m</span>&nbsp;<span class="op" id="3343499">=</span>&nbsp;<span class="builtinfunc" id="3343501">make</span><span class="op" id="3343505">(</span><span class="keyword" id="3343506">map</span><span class="op" id="3343509">[</span><span class="builtintype" id="3343510">string</span><span class="op" id="3343516">]</span><span class="op" id="3343517">*</span><span class="ident" id="3343518">call</span><span class="op" id="3343522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3343525">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3343528">if</span>&nbsp;<span class="ident" id="3343531">c</span><span class="op" id="3343532">,</span>&nbsp;<span class="ident" id="3343534">ok</span>&nbsp;<span class="op" id="3343537">:=</span>&nbsp;<span class="ident" id="3343540">g</span><span class="op" id="3343541">.</span><span class="ident" id="3343542">m</span><span class="op" id="3343543">[</span><span class="ident" id="3343544">key</span><span class="op" id="3343547">]</span><span class="op" id="3343548">;</span>&nbsp;<span class="ident" id="3343550">ok</span>&nbsp;<span class="op" id="3343553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343557">c</span><span class="op" id="3343558">.</span><span class="ident" id="3343559">dups</span><span class="op" id="3343563">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343568">g</span><span class="op" id="3343569">.</span><span class="ident" id="3343570">mu</span><span class="op" id="3343572">.</span><span class="ident" id="3343573">Unlock</span><span class="op" id="3343579">(</span><span class="op" id="3343580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343584">c</span><span class="op" id="3343585">.</span><span class="ident" id="3343586">wg</span><span class="op" id="3343588">.</span><span class="ident" id="3343589">Wait</span><span class="op" id="3343593">(</span><span class="op" id="3343594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3343598">return</span>&nbsp;<span class="ident" id="3343605">c</span><span class="op" id="3343606">.</span><span class="ident" id="3343607">val</span><span class="op" id="3343610">,</span>&nbsp;<span class="ident" id="3343612">c</span><span class="op" id="3343613">.</span><span class="ident" id="3343614">err</span><span class="op" id="3343617">,</span>&nbsp;<span class="builtintype" id="3343619">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3343625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343628">c</span>&nbsp;<span class="op" id="3343630">:=</span>&nbsp;<span class="builtinfunc" id="3343633">new</span><span class="op" id="3343636">(</span><span class="ident" id="3343637">call</span><span class="op" id="3343641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343644">c</span><span class="op" id="3343645">.</span><span class="ident" id="3343646">wg</span><span class="op" id="3343648">.</span><span class="ident" id="3343649">Add</span><span class="op" id="3343652">(</span><span class="num" id="3343653">1</span><span class="op" id="3343654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343657">g</span><span class="op" id="3343658">.</span><span class="ident" id="3343659">m</span><span class="op" id="3343660">[</span><span class="ident" id="3343661">key</span><span class="op" id="3343664">]</span>&nbsp;<span class="op" id="3343666">=</span>&nbsp;<span class="ident" id="3343668">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343671">g</span><span class="op" id="3343672">.</span><span class="ident" id="3343673">mu</span><span class="op" id="3343675">.</span><span class="ident" id="3343676">Unlock</span><span class="op" id="3343682">(</span><span class="op" id="3343683">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343687">g</span><span class="op" id="3343688">.</span><span class="ident" id="3343689">doCall</span><span class="op" id="3343695">(</span><span class="ident" id="3343696">c</span><span class="op" id="3343697">,</span>&nbsp;<span class="ident" id="3343699">key</span><span class="op" id="3343702">,</span>&nbsp;<span class="ident" id="3343704">fn</span><span class="op" id="3343706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3343709">return</span>&nbsp;<span class="ident" id="3343716">c</span><span class="op" id="3343717">.</span><span class="ident" id="3343718">val</span><span class="op" id="3343721">,</span>&nbsp;<span class="ident" id="3343723">c</span><span class="op" id="3343724">.</span><span class="ident" id="3343725">err</span><span class="op" id="3343728">,</span>&nbsp;<span class="ident" id="3343730">c</span><span class="op" id="3343731">.</span><span class="ident" id="3343732">dups</span>&nbsp;<span class="op" id="3343737">&gt;</span>&nbsp;<span class="num" id="3343739">0</span><br>
<span class="lineno"></span><span class="op" id="3343741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3343744">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3343809">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3343841">func</span>&nbsp;<span class="op" id="3343846">(</span><span class="ident" id="3343847">g</span>&nbsp;<span class="op" id="3343849">*</span><span class="ident" id="3343850">singleflight</span><span class="op" id="3343862">)</span>&nbsp;<span class="ident" id="3343864">DoChan</span><span class="op" id="3343870">(</span><span class="ident" id="3343871">key</span>&nbsp;<span class="builtintype" id="3343875">string</span><span class="op" id="3343881">,</span>&nbsp;<span class="ident" id="3343883">fn</span>&nbsp;<span class="keyword" id="3343886">func</span><span class="op" id="3343890">(</span><span class="op" id="3343891">)</span>&nbsp;<span class="op" id="3343893">(</span><span class="keyword" id="3343894">interface</span><span class="op" id="3343903">{</span><span class="op" id="3343904">}</span><span class="op" id="3343905">,</span>&nbsp;<span class="builtintype" id="3343907">error</span><span class="op" id="3343912">)</span><span class="op" id="3343913">)</span>&nbsp;<span class="op" id="3343915">&lt;-</span><span class="keyword" id="3343917">chan</span>&nbsp;<span class="ident" id="3343922">singleflightResult</span>&nbsp;<span class="op" id="3343941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343944">ch</span>&nbsp;<span class="op" id="3343947">:=</span>&nbsp;<span class="builtinfunc" id="3343950">make</span><span class="op" id="3343954">(</span><span class="keyword" id="3343955">chan</span>&nbsp;<span class="ident" id="3343960">singleflightResult</span><span class="op" id="3343978">,</span>&nbsp;<span class="num" id="3343980">1</span><span class="op" id="3343981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3343984">g</span><span class="op" id="3343985">.</span><span class="ident" id="3343986">mu</span><span class="op" id="3343988">.</span><span class="ident" id="3343989">Lock</span><span class="op" id="3343993">(</span><span class="op" id="3343994">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3343997">if</span>&nbsp;<span class="ident" id="3344000">g</span><span class="op" id="3344001">.</span><span class="ident" id="3344002">m</span>&nbsp;<span class="op" id="3344004">==</span>&nbsp;<span class="builtintype" id="3344007">nil</span>&nbsp;<span class="op" id="3344011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344015">g</span><span class="op" id="3344016">.</span><span class="ident" id="3344017">m</span>&nbsp;<span class="op" id="3344019">=</span>&nbsp;<span class="builtinfunc" id="3344021">make</span><span class="op" id="3344025">(</span><span class="keyword" id="3344026">map</span><span class="op" id="3344029">[</span><span class="builtintype" id="3344030">string</span><span class="op" id="3344036">]</span><span class="op" id="3344037">*</span><span class="ident" id="3344038">call</span><span class="op" id="3344042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3344045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3344048">if</span>&nbsp;<span class="ident" id="3344051">c</span><span class="op" id="3344052">,</span>&nbsp;<span class="ident" id="3344054">ok</span>&nbsp;<span class="op" id="3344057">:=</span>&nbsp;<span class="ident" id="3344060">g</span><span class="op" id="3344061">.</span><span class="ident" id="3344062">m</span><span class="op" id="3344063">[</span><span class="ident" id="3344064">key</span><span class="op" id="3344067">]</span><span class="op" id="3344068">;</span>&nbsp;<span class="ident" id="3344070">ok</span>&nbsp;<span class="op" id="3344073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344077">c</span><span class="op" id="3344078">.</span><span class="ident" id="3344079">dups</span><span class="op" id="3344083">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344088">c</span><span class="op" id="3344089">.</span><span class="ident" id="3344090">chans</span>&nbsp;<span class="op" id="3344096">=</span>&nbsp;<span class="builtinfunc" id="3344098">append</span><span class="op" id="3344104">(</span><span class="ident" id="3344105">c</span><span class="op" id="3344106">.</span><span class="ident" id="3344107">chans</span><span class="op" id="3344112">,</span>&nbsp;<span class="ident" id="3344114">ch</span><span class="op" id="3344116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344120">g</span><span class="op" id="3344121">.</span><span class="ident" id="3344122">mu</span><span class="op" id="3344124">.</span><span class="ident" id="3344125">Unlock</span><span class="op" id="3344131">(</span><span class="op" id="3344132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3344136">return</span>&nbsp;<span class="ident" id="3344143">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3344147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344150">c</span>&nbsp;<span class="op" id="3344152">:=</span>&nbsp;<span class="op" id="3344155">&amp;</span><span class="ident" id="3344156">call</span><span class="op" id="3344160">{</span><span class="ident" id="3344161">chans</span><span class="op" id="3344166">:</span>&nbsp;<span class="op" id="3344168">[</span><span class="op" id="3344169">]</span><span class="keyword" id="3344170">chan</span><span class="op" id="3344174">&lt;-</span>&nbsp;<span class="ident" id="3344177">singleflightResult</span><span class="op" id="3344195">{</span><span class="ident" id="3344196">ch</span><span class="op" id="3344198">}</span><span class="op" id="3344199">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344202">c</span><span class="op" id="3344203">.</span><span class="ident" id="3344204">wg</span><span class="op" id="3344206">.</span><span class="ident" id="3344207">Add</span><span class="op" id="3344210">(</span><span class="num" id="3344211">1</span><span class="op" id="3344212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344215">g</span><span class="op" id="3344216">.</span><span class="ident" id="3344217">m</span><span class="op" id="3344218">[</span><span class="ident" id="3344219">key</span><span class="op" id="3344222">]</span>&nbsp;<span class="op" id="3344224">=</span>&nbsp;<span class="ident" id="3344226">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344229">g</span><span class="op" id="3344230">.</span><span class="ident" id="3344231">mu</span><span class="op" id="3344233">.</span><span class="ident" id="3344234">Unlock</span><span class="op" id="3344240">(</span><span class="op" id="3344241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3344245">go</span>&nbsp;<span class="ident" id="3344248">g</span><span class="op" id="3344249">.</span><span class="ident" id="3344250">doCall</span><span class="op" id="3344256">(</span><span class="ident" id="3344257">c</span><span class="op" id="3344258">,</span>&nbsp;<span class="ident" id="3344260">key</span><span class="op" id="3344263">,</span>&nbsp;<span class="ident" id="3344265">fn</span><span class="op" id="3344267">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3344271">return</span>&nbsp;<span class="ident" id="3344278">ch</span><br>
<span class="lineno"></span><span class="op" id="3344281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3344284">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3344329">func</span>&nbsp;<span class="op" id="3344334">(</span><span class="ident" id="3344335">g</span>&nbsp;<span class="op" id="3344337">*</span><span class="ident" id="3344338">singleflight</span><span class="op" id="3344350">)</span>&nbsp;<span class="ident" id="3344352">doCall</span><span class="op" id="3344358">(</span><span class="ident" id="3344359">c</span>&nbsp;<span class="op" id="3344361">*</span><span class="ident" id="3344362">call</span><span class="op" id="3344366">,</span>&nbsp;<span class="ident" id="3344368">key</span>&nbsp;<span class="builtintype" id="3344372">string</span><span class="op" id="3344378">,</span>&nbsp;<span class="ident" id="3344380">fn</span>&nbsp;<span class="keyword" id="3344383">func</span><span class="op" id="3344387">(</span><span class="op" id="3344388">)</span>&nbsp;<span class="op" id="3344390">(</span><span class="keyword" id="3344391">interface</span><span class="op" id="3344400">{</span><span class="op" id="3344401">}</span><span class="op" id="3344402">,</span>&nbsp;<span class="builtintype" id="3344404">error</span><span class="op" id="3344409">)</span><span class="op" id="3344410">)</span>&nbsp;<span class="op" id="3344412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344415">c</span><span class="op" id="3344416">.</span><span class="ident" id="3344417">val</span><span class="op" id="3344420">,</span>&nbsp;<span class="ident" id="3344422">c</span><span class="op" id="3344423">.</span><span class="ident" id="3344424">err</span>&nbsp;<span class="op" id="3344428">=</span>&nbsp;<span class="ident" id="3344430">fn</span><span class="op" id="3344432">(</span><span class="op" id="3344433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344436">c</span><span class="op" id="3344437">.</span><span class="ident" id="3344438">wg</span><span class="op" id="3344440">.</span><span class="ident" id="3344441">Done</span><span class="op" id="3344445">(</span><span class="op" id="3344446">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344450">g</span><span class="op" id="3344451">.</span><span class="ident" id="3344452">mu</span><span class="op" id="3344454">.</span><span class="ident" id="3344455">Lock</span><span class="op" id="3344459">(</span><span class="op" id="3344460">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3344463">delete</span><span class="op" id="3344469">(</span><span class="ident" id="3344470">g</span><span class="op" id="3344471">.</span><span class="ident" id="3344472">m</span><span class="op" id="3344473">,</span>&nbsp;<span class="ident" id="3344475">key</span><span class="op" id="3344478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3344481">for</span>&nbsp;<span class="ident" id="3344485">_</span><span class="op" id="3344486">,</span>&nbsp;<span class="ident" id="3344488">ch</span>&nbsp;<span class="op" id="3344491">:=</span>&nbsp;<span class="keyword" id="3344494">range</span>&nbsp;<span class="ident" id="3344500">c</span><span class="op" id="3344501">.</span><span class="ident" id="3344502">chans</span>&nbsp;<span class="op" id="3344508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344512">ch</span>&nbsp;<span class="op" id="3344515">&lt;-</span>&nbsp;<span class="ident" id="3344518">singleflightResult</span><span class="op" id="3344536">{</span><span class="ident" id="3344537">c</span><span class="op" id="3344538">.</span><span class="ident" id="3344539">val</span><span class="op" id="3344542">,</span>&nbsp;<span class="ident" id="3344544">c</span><span class="op" id="3344545">.</span><span class="ident" id="3344546">err</span><span class="op" id="3344549">,</span>&nbsp;<span class="ident" id="3344551">c</span><span class="op" id="3344552">.</span><span class="ident" id="3344553">dups</span>&nbsp;<span class="op" id="3344558">&gt;</span>&nbsp;<span class="num" id="3344560">0</span><span class="op" id="3344561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3344564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344567">g</span><span class="op" id="3344568">.</span><span class="ident" id="3344569">mu</span><span class="op" id="3344571">.</span><span class="ident" id="3344572">Unlock</span><span class="op" id="3344578">(</span><span class="op" id="3344579">)</span><br>
<span class="lineno">100</span><span class="op" id="3344581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3344584">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3344654">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3344723">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3344755">func</span>&nbsp;<span class="op" id="3344760">(</span><span class="ident" id="3344761">g</span>&nbsp;<span class="op" id="3344763">*</span><span class="ident" id="3344764">singleflight</span><span class="op" id="3344776">)</span>&nbsp;<span class="ident" id="3344778">Forget</span><span class="op" id="3344784">(</span><span class="ident" id="3344785">key</span>&nbsp;<span class="builtintype" id="3344789">string</span><span class="op" id="3344795">)</span>&nbsp;<span class="op" id="3344797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344800">g</span><span class="op" id="3344801">.</span><span class="ident" id="3344802">mu</span><span class="op" id="3344804">.</span><span class="ident" id="3344805">Lock</span><span class="op" id="3344809">(</span><span class="op" id="3344810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3344813">delete</span><span class="op" id="3344819">(</span><span class="ident" id="3344820">g</span><span class="op" id="3344821">.</span><span class="ident" id="3344822">m</span><span class="op" id="3344823">,</span>&nbsp;<span class="ident" id="3344825">key</span><span class="op" id="3344828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3344831">g</span><span class="op" id="3344832">.</span><span class="ident" id="3344833">mu</span><span class="op" id="3344835">.</span><span class="ident" id="3344836">Unlock</span><span class="op" id="3344842">(</span><span class="op" id="3344843">)</span><br>
<span class="lineno"></span><span class="op" id="3344845">}</span>
</div>
</body>
</html>
