<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4812703">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4812758">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4812812">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4812863">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4812918">package</span>&nbsp;<span class="ident" id="4812926">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4812931">import</span>&nbsp;<span class="op" id="4812938">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4812941">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4812953">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4812961">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="4812971">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4812974">const</span>&nbsp;<span class="ident" id="4812980">uint64Size</span>&nbsp;<span class="op" id="4812991">=</span>&nbsp;<span class="num" id="4812993">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4812996">type</span>&nbsp;<span class="ident" id="4813001">encHelper</span>&nbsp;<span class="keyword" id="4813011">func</span><span class="op" id="4813015">(</span><span class="ident" id="4813016">state</span>&nbsp;<span class="op" id="4813022">*</span><span class="ident" id="4813023">encoderState</span><span class="op" id="4813035">,</span>&nbsp;<span class="ident" id="4813037">v</span>&nbsp;<span class="ident" id="4813039">reflect</span><span class="op" id="4813046">.</span><span class="ident" id="4813047">Value</span><span class="op" id="4813052">)</span>&nbsp;<span class="builtintype" id="4813054">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4813060">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="4813137">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="4813203">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4813273">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="4813304">type</span>&nbsp;<span class="ident" id="4813309">encoderState</span>&nbsp;<span class="keyword" id="4813322">struct</span>&nbsp;<span class="op" id="4813329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813332">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4813341">*</span><span class="ident" id="4813342">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813351">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4813360">*</span><span class="ident" id="4813361">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813372">sendZero</span>&nbsp;<span class="builtintype" id="4813381">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4813402">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813472">fieldnum</span>&nbsp;<span class="builtintype" id="4813481">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4813502">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813537">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4813546">[</span><span class="num" id="4813547">1</span>&nbsp;<span class="op" id="4813549">+</span>&nbsp;<span class="ident" id="4813551">uint64Size</span><span class="op" id="4813561">]</span><span class="builtintype" id="4813562">byte</span>&nbsp;<span class="comment" id="4813567">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813625">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4813634">*</span><span class="ident" id="4813635">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4813655">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="4813672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4813675">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="4813761">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4813856">type</span>&nbsp;<span class="ident" id="4813861">encBuffer</span>&nbsp;<span class="keyword" id="4813871">struct</span>&nbsp;<span class="op" id="4813878">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813881">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4813889">[</span><span class="op" id="4813890">]</span><span class="builtintype" id="4813891">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813897">scratch</span>&nbsp;<span class="op" id="4813905">[</span><span class="num" id="4813906">64</span><span class="op" id="4813908">]</span><span class="builtintype" id="4813909">byte</span><br>
<span class="lineno"></span><span class="op" id="4813914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4813917">func</span>&nbsp;<span class="op" id="4813922">(</span><span class="ident" id="4813923">e</span>&nbsp;<span class="op" id="4813925">*</span><span class="ident" id="4813926">encBuffer</span><span class="op" id="4813935">)</span>&nbsp;<span class="ident" id="4813937">WriteByte</span><span class="op" id="4813946">(</span><span class="ident" id="4813947">c</span>&nbsp;<span class="builtintype" id="4813949">byte</span><span class="op" id="4813953">)</span>&nbsp;<span class="op" id="4813955">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813958">e</span><span class="op" id="4813959">.</span><span class="ident" id="4813960">data</span>&nbsp;<span class="op" id="4813965">=</span>&nbsp;<span class="builtinfunc" id="4813967">append</span><span class="op" id="4813973">(</span><span class="ident" id="4813974">e</span><span class="op" id="4813975">.</span><span class="ident" id="4813976">data</span><span class="op" id="4813980">,</span>&nbsp;<span class="ident" id="4813982">c</span><span class="op" id="4813983">)</span><br>
<span class="lineno"></span><span class="op" id="4813985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4813988">func</span>&nbsp;<span class="op" id="4813993">(</span><span class="ident" id="4813994">e</span>&nbsp;<span class="op" id="4813996">*</span><span class="ident" id="4813997">encBuffer</span><span class="op" id="4814006">)</span>&nbsp;<span class="ident" id="4814008">Write</span><span class="op" id="4814013">(</span><span class="ident" id="4814014">p</span>&nbsp;<span class="op" id="4814016">[</span><span class="op" id="4814017">]</span><span class="builtintype" id="4814018">byte</span><span class="op" id="4814022">)</span>&nbsp;<span class="op" id="4814024">(</span><span class="builtintype" id="4814025">int</span><span class="op" id="4814028">,</span>&nbsp;<span class="builtintype" id="4814030">error</span><span class="op" id="4814035">)</span>&nbsp;<span class="op" id="4814037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814040">e</span><span class="op" id="4814041">.</span><span class="ident" id="4814042">data</span>&nbsp;<span class="op" id="4814047">=</span>&nbsp;<span class="builtinfunc" id="4814049">append</span><span class="op" id="4814055">(</span><span class="ident" id="4814056">e</span><span class="op" id="4814057">.</span><span class="ident" id="4814058">data</span><span class="op" id="4814062">,</span>&nbsp;<span class="ident" id="4814064">p</span><span class="op" id="4814065">...</span><span class="op" id="4814068">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814071">return</span>&nbsp;<span class="builtinfunc" id="4814078">len</span><span class="op" id="4814081">(</span><span class="ident" id="4814082">p</span><span class="op" id="4814083">)</span><span class="op" id="4814084">,</span>&nbsp;<span class="ident" id="4814086">nil</span><br>
<span class="lineno"></span><span class="op" id="4814090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4814093">func</span>&nbsp;<span class="op" id="4814098">(</span><span class="ident" id="4814099">e</span>&nbsp;<span class="op" id="4814101">*</span><span class="ident" id="4814102">encBuffer</span><span class="op" id="4814111">)</span>&nbsp;<span class="ident" id="4814113">WriteString</span><span class="op" id="4814124">(</span><span class="ident" id="4814125">s</span>&nbsp;<span class="builtintype" id="4814127">string</span><span class="op" id="4814133">)</span>&nbsp;<span class="op" id="4814135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814138">e</span><span class="op" id="4814139">.</span><span class="ident" id="4814140">data</span>&nbsp;<span class="op" id="4814145">=</span>&nbsp;<span class="builtinfunc" id="4814147">append</span><span class="op" id="4814153">(</span><span class="ident" id="4814154">e</span><span class="op" id="4814155">.</span><span class="ident" id="4814156">data</span><span class="op" id="4814160">,</span>&nbsp;<span class="ident" id="4814162">s</span><span class="op" id="4814163">...</span><span class="op" id="4814166">)</span><br>
<span class="lineno">50</span><span class="op" id="4814168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4814171">func</span>&nbsp;<span class="op" id="4814176">(</span><span class="ident" id="4814177">e</span>&nbsp;<span class="op" id="4814179">*</span><span class="ident" id="4814180">encBuffer</span><span class="op" id="4814189">)</span>&nbsp;<span class="ident" id="4814191">Len</span><span class="op" id="4814194">(</span><span class="op" id="4814195">)</span>&nbsp;<span class="builtintype" id="4814197">int</span>&nbsp;<span class="op" id="4814201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814204">return</span>&nbsp;<span class="builtinfunc" id="4814211">len</span><span class="op" id="4814214">(</span><span class="ident" id="4814215">e</span><span class="op" id="4814216">.</span><span class="ident" id="4814217">data</span><span class="op" id="4814221">)</span><br>
<span class="lineno"></span><span class="op" id="4814223">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="4814226">func</span>&nbsp;<span class="op" id="4814231">(</span><span class="ident" id="4814232">e</span>&nbsp;<span class="op" id="4814234">*</span><span class="ident" id="4814235">encBuffer</span><span class="op" id="4814244">)</span>&nbsp;<span class="ident" id="4814246">Bytes</span><span class="op" id="4814251">(</span><span class="op" id="4814252">)</span>&nbsp;<span class="op" id="4814254">[</span><span class="op" id="4814255">]</span><span class="builtintype" id="4814256">byte</span>&nbsp;<span class="op" id="4814261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814264">return</span>&nbsp;<span class="ident" id="4814271">e</span><span class="op" id="4814272">.</span><span class="ident" id="4814273">data</span><br>
<span class="lineno"></span><span class="op" id="4814278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4814281">func</span>&nbsp;<span class="op" id="4814286">(</span><span class="ident" id="4814287">e</span>&nbsp;<span class="op" id="4814289">*</span><span class="ident" id="4814290">encBuffer</span><span class="op" id="4814299">)</span>&nbsp;<span class="ident" id="4814301">Reset</span><span class="op" id="4814306">(</span><span class="op" id="4814307">)</span>&nbsp;<span class="op" id="4814309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814312">e</span><span class="op" id="4814313">.</span><span class="ident" id="4814314">data</span>&nbsp;<span class="op" id="4814319">=</span>&nbsp;<span class="ident" id="4814321">e</span><span class="op" id="4814322">.</span><span class="ident" id="4814323">data</span><span class="op" id="4814327">[</span><span class="num" id="4814328">0</span><span class="op" id="4814329">:</span><span class="num" id="4814330">0</span><span class="op" id="4814331">]</span><br>
<span class="lineno"></span><span class="op" id="4814333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4814336">func</span>&nbsp;<span class="op" id="4814341">(</span><span class="ident" id="4814342">enc</span>&nbsp;<span class="op" id="4814346">*</span><span class="ident" id="4814347">Encoder</span><span class="op" id="4814354">)</span>&nbsp;<span class="ident" id="4814356">newEncoderState</span><span class="op" id="4814371">(</span><span class="ident" id="4814372">b</span>&nbsp;<span class="op" id="4814374">*</span><span class="ident" id="4814375">encBuffer</span><span class="op" id="4814384">)</span>&nbsp;<span class="op" id="4814386">*</span><span class="ident" id="4814387">encoderState</span>&nbsp;<span class="op" id="4814400">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814403">e</span>&nbsp;<span class="op" id="4814405">:=</span>&nbsp;<span class="ident" id="4814408">enc</span><span class="op" id="4814411">.</span><span class="ident" id="4814412">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814422">if</span>&nbsp;<span class="ident" id="4814425">e</span>&nbsp;<span class="op" id="4814427">==</span>&nbsp;<span class="ident" id="4814430">nil</span>&nbsp;<span class="op" id="4814434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814438">e</span>&nbsp;<span class="op" id="4814440">=</span>&nbsp;<span class="builtinfunc" id="4814442">new</span><span class="op" id="4814445">(</span><span class="ident" id="4814446">encoderState</span><span class="op" id="4814458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814462">e</span><span class="op" id="4814463">.</span><span class="ident" id="4814464">enc</span>&nbsp;<span class="op" id="4814468">=</span>&nbsp;<span class="ident" id="4814470">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814475">}</span>&nbsp;<span class="keyword" id="4814477">else</span>&nbsp;<span class="op" id="4814482">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814486">enc</span><span class="op" id="4814489">.</span><span class="ident" id="4814490">freeList</span>&nbsp;<span class="op" id="4814499">=</span>&nbsp;<span class="ident" id="4814501">e</span><span class="op" id="4814502">.</span><span class="ident" id="4814503">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814512">e</span><span class="op" id="4814513">.</span><span class="ident" id="4814514">sendZero</span>&nbsp;<span class="op" id="4814523">=</span>&nbsp;<span class="builtintype" id="4814525">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814532">e</span><span class="op" id="4814533">.</span><span class="ident" id="4814534">fieldnum</span>&nbsp;<span class="op" id="4814543">=</span>&nbsp;<span class="num" id="4814545">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814548">e</span><span class="op" id="4814549">.</span><span class="ident" id="4814550">b</span>&nbsp;<span class="op" id="4814552">=</span>&nbsp;<span class="ident" id="4814554">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814557">if</span>&nbsp;<span class="builtinfunc" id="4814560">len</span><span class="op" id="4814563">(</span><span class="ident" id="4814564">b</span><span class="op" id="4814565">.</span><span class="ident" id="4814566">data</span><span class="op" id="4814570">)</span>&nbsp;<span class="op" id="4814572">==</span>&nbsp;<span class="num" id="4814575">0</span>&nbsp;<span class="op" id="4814577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814581">b</span><span class="op" id="4814582">.</span><span class="ident" id="4814583">data</span>&nbsp;<span class="op" id="4814588">=</span>&nbsp;<span class="ident" id="4814590">b</span><span class="op" id="4814591">.</span><span class="ident" id="4814592">scratch</span><span class="op" id="4814599">[</span><span class="num" id="4814600">0</span><span class="op" id="4814601">:</span><span class="num" id="4814602">0</span><span class="op" id="4814603">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814609">return</span>&nbsp;<span class="ident" id="4814616">e</span><br>
<span class="lineno"></span><span class="op" id="4814618">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="4814621">func</span>&nbsp;<span class="op" id="4814626">(</span><span class="ident" id="4814627">enc</span>&nbsp;<span class="op" id="4814631">*</span><span class="ident" id="4814632">Encoder</span><span class="op" id="4814639">)</span>&nbsp;<span class="ident" id="4814641">freeEncoderState</span><span class="op" id="4814657">(</span><span class="ident" id="4814658">e</span>&nbsp;<span class="op" id="4814660">*</span><span class="ident" id="4814661">encoderState</span><span class="op" id="4814673">)</span>&nbsp;<span class="op" id="4814675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814678">e</span><span class="op" id="4814679">.</span><span class="ident" id="4814680">next</span>&nbsp;<span class="op" id="4814685">=</span>&nbsp;<span class="ident" id="4814687">enc</span><span class="op" id="4814690">.</span><span class="ident" id="4814691">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814701">enc</span><span class="op" id="4814704">.</span><span class="ident" id="4814705">freeList</span>&nbsp;<span class="op" id="4814714">=</span>&nbsp;<span class="ident" id="4814716">e</span><br>
<span class="lineno"></span><span class="op" id="4814718">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4814721">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="4814792">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="4814853">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="4814921">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4814954">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="4815015">func</span>&nbsp;<span class="op" id="4815020">(</span><span class="ident" id="4815021">state</span>&nbsp;<span class="op" id="4815027">*</span><span class="ident" id="4815028">encoderState</span><span class="op" id="4815040">)</span>&nbsp;<span class="ident" id="4815042">encodeUint</span><span class="op" id="4815052">(</span><span class="ident" id="4815053">x</span>&nbsp;<span class="ident" id="4815055">uint64</span><span class="op" id="4815061">)</span>&nbsp;<span class="op" id="4815063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815066">if</span>&nbsp;<span class="ident" id="4815069">x</span>&nbsp;<span class="op" id="4815071">&lt;=</span>&nbsp;<span class="num" id="4815074">0x7F</span>&nbsp;<span class="op" id="4815079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815083">state</span><span class="op" id="4815088">.</span><span class="ident" id="4815089">b</span><span class="op" id="4815090">.</span><span class="ident" id="4815091">WriteByte</span><span class="op" id="4815100">(</span><span class="builtintype" id="4815101">uint8</span><span class="op" id="4815106">(</span><span class="ident" id="4815107">x</span><span class="op" id="4815108">)</span><span class="op" id="4815109">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815113">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815124">i</span>&nbsp;<span class="op" id="4815126">:=</span>&nbsp;<span class="ident" id="4815129">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815141">for</span>&nbsp;<span class="ident" id="4815145">x</span>&nbsp;<span class="op" id="4815147">&gt;</span>&nbsp;<span class="num" id="4815149">0</span>&nbsp;<span class="op" id="4815151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815155">state</span><span class="op" id="4815160">.</span><span class="ident" id="4815161">buf</span><span class="op" id="4815164">[</span><span class="ident" id="4815165">i</span><span class="op" id="4815166">]</span>&nbsp;<span class="op" id="4815168">=</span>&nbsp;<span class="builtintype" id="4815170">uint8</span><span class="op" id="4815175">(</span><span class="ident" id="4815176">x</span><span class="op" id="4815177">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815181">x</span>&nbsp;<span class="op" id="4815183">&gt;&gt;=</span>&nbsp;<span class="num" id="4815187">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815191">i</span><span class="op" id="4815192">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815199">state</span><span class="op" id="4815204">.</span><span class="ident" id="4815205">buf</span><span class="op" id="4815208">[</span><span class="ident" id="4815209">i</span><span class="op" id="4815210">]</span>&nbsp;<span class="op" id="4815212">=</span>&nbsp;<span class="builtintype" id="4815214">uint8</span><span class="op" id="4815219">(</span><span class="ident" id="4815220">i</span>&nbsp;<span class="op" id="4815222">-</span>&nbsp;<span class="ident" id="4815224">uint64Size</span><span class="op" id="4815234">)</span>&nbsp;<span class="comment" id="4815236">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815262">state</span><span class="op" id="4815267">.</span><span class="ident" id="4815268">b</span><span class="op" id="4815269">.</span><span class="ident" id="4815270">Write</span><span class="op" id="4815275">(</span><span class="ident" id="4815276">state</span><span class="op" id="4815281">.</span><span class="ident" id="4815282">buf</span><span class="op" id="4815285">[</span><span class="ident" id="4815286">i</span>&nbsp;<span class="op" id="4815288">:</span>&nbsp;<span class="ident" id="4815290">uint64Size</span><span class="op" id="4815300">+</span><span class="num" id="4815301">1</span><span class="op" id="4815302">]</span><span class="op" id="4815303">)</span><br>
<span class="lineno">105</span><span class="op" id="4815305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4815308">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="4815366">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="4815452">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="4815480">func</span>&nbsp;<span class="op" id="4815485">(</span><span class="ident" id="4815486">state</span>&nbsp;<span class="op" id="4815492">*</span><span class="ident" id="4815493">encoderState</span><span class="op" id="4815505">)</span>&nbsp;<span class="ident" id="4815507">encodeInt</span><span class="op" id="4815516">(</span><span class="ident" id="4815517">i</span>&nbsp;<span class="ident" id="4815519">int64</span><span class="op" id="4815524">)</span>&nbsp;<span class="op" id="4815526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815529">var</span>&nbsp;<span class="ident" id="4815533">x</span>&nbsp;<span class="ident" id="4815535">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815543">if</span>&nbsp;<span class="ident" id="4815546">i</span>&nbsp;<span class="op" id="4815548">&lt;</span>&nbsp;<span class="num" id="4815550">0</span>&nbsp;<span class="op" id="4815552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815556">x</span>&nbsp;<span class="op" id="4815558">=</span>&nbsp;<span class="ident" id="4815560">uint64</span><span class="op" id="4815566">(</span><span class="op" id="4815567">^</span><span class="ident" id="4815568">i</span><span class="op" id="4815569">&lt;&lt;</span><span class="num" id="4815571">1</span><span class="op" id="4815572">)</span>&nbsp;<span class="op" id="4815574">|</span>&nbsp;<span class="num" id="4815576">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815579">}</span>&nbsp;<span class="keyword" id="4815581">else</span>&nbsp;<span class="op" id="4815586">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815590">x</span>&nbsp;<span class="op" id="4815592">=</span>&nbsp;<span class="ident" id="4815594">uint64</span><span class="op" id="4815600">(</span><span class="ident" id="4815601">i</span>&nbsp;<span class="op" id="4815603">&lt;&lt;</span>&nbsp;<span class="num" id="4815606">1</span><span class="op" id="4815607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815613">state</span><span class="op" id="4815618">.</span><span class="ident" id="4815619">encodeUint</span><span class="op" id="4815629">(</span><span class="ident" id="4815630">uint64</span><span class="op" id="4815636">(</span><span class="ident" id="4815637">x</span><span class="op" id="4815638">)</span><span class="op" id="4815639">)</span><br>
<span class="lineno"></span><span class="op" id="4815641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="4815644">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4815712">type</span>&nbsp;<span class="ident" id="4815717">encOp</span>&nbsp;<span class="keyword" id="4815723">func</span><span class="op" id="4815727">(</span><span class="ident" id="4815728">i</span>&nbsp;<span class="op" id="4815730">*</span><span class="ident" id="4815731">encInstr</span><span class="op" id="4815739">,</span>&nbsp;<span class="ident" id="4815741">state</span>&nbsp;<span class="op" id="4815747">*</span><span class="ident" id="4815748">encoderState</span><span class="op" id="4815760">,</span>&nbsp;<span class="ident" id="4815762">v</span>&nbsp;<span class="ident" id="4815764">reflect</span><span class="op" id="4815771">.</span><span class="ident" id="4815772">Value</span><span class="op" id="4815777">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4815780">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="4815826">type</span>&nbsp;<span class="ident" id="4815831">encInstr</span>&nbsp;<span class="keyword" id="4815840">struct</span>&nbsp;<span class="op" id="4815847">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815850">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4815856">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815863">field</span>&nbsp;<span class="builtintype" id="4815869">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4815875">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815901">index</span>&nbsp;<span class="op" id="4815907">[</span><span class="op" id="4815908">]</span><span class="builtintype" id="4815909">int</span>&nbsp;<span class="comment" id="4815913">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815930">indir</span>&nbsp;<span class="builtintype" id="4815936">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4815942">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="4816008">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4816011">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="4816104">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="4816158">func</span>&nbsp;<span class="op" id="4816163">(</span><span class="ident" id="4816164">state</span>&nbsp;<span class="op" id="4816170">*</span><span class="ident" id="4816171">encoderState</span><span class="op" id="4816183">)</span>&nbsp;<span class="ident" id="4816185">update</span><span class="op" id="4816191">(</span><span class="ident" id="4816192">instr</span>&nbsp;<span class="op" id="4816198">*</span><span class="ident" id="4816199">encInstr</span><span class="op" id="4816207">)</span>&nbsp;<span class="op" id="4816209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816212">if</span>&nbsp;<span class="ident" id="4816215">instr</span>&nbsp;<span class="op" id="4816221">!=</span>&nbsp;<span class="ident" id="4816224">nil</span>&nbsp;<span class="op" id="4816228">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816232">state</span><span class="op" id="4816237">.</span><span class="ident" id="4816238">encodeUint</span><span class="op" id="4816248">(</span><span class="ident" id="4816249">uint64</span><span class="op" id="4816255">(</span><span class="ident" id="4816256">instr</span><span class="op" id="4816261">.</span><span class="ident" id="4816262">field</span>&nbsp;<span class="op" id="4816268">-</span>&nbsp;<span class="ident" id="4816270">state</span><span class="op" id="4816275">.</span><span class="ident" id="4816276">fieldnum</span><span class="op" id="4816284">)</span><span class="op" id="4816285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816289">state</span><span class="op" id="4816294">.</span><span class="ident" id="4816295">fieldnum</span>&nbsp;<span class="op" id="4816304">=</span>&nbsp;<span class="ident" id="4816306">instr</span><span class="op" id="4816311">.</span><span class="ident" id="4816312">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816319">}</span><br>
<span class="lineno"></span><span class="op" id="4816321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="4816324">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4816388">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="4816456">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4816523">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="4816590">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="4816654">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4816721">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="4816787">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4816799">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="4816866">func</span>&nbsp;<span class="ident" id="4816871">encIndirect</span><span class="op" id="4816882">(</span><span class="ident" id="4816883">pv</span>&nbsp;<span class="ident" id="4816886">reflect</span><span class="op" id="4816893">.</span><span class="ident" id="4816894">Value</span><span class="op" id="4816899">,</span>&nbsp;<span class="ident" id="4816901">indir</span>&nbsp;<span class="builtintype" id="4816907">int</span><span class="op" id="4816910">)</span>&nbsp;<span class="ident" id="4816912">reflect</span><span class="op" id="4816919">.</span><span class="ident" id="4816920">Value</span>&nbsp;<span class="op" id="4816926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816929">for</span>&nbsp;<span class="op" id="4816933">;</span>&nbsp;<span class="ident" id="4816935">indir</span>&nbsp;<span class="op" id="4816941">&gt;</span>&nbsp;<span class="num" id="4816943">0</span><span class="op" id="4816944">;</span>&nbsp;<span class="ident" id="4816946">indir</span><span class="op" id="4816951">--</span>&nbsp;<span class="op" id="4816954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816958">if</span>&nbsp;<span class="ident" id="4816961">pv</span><span class="op" id="4816963">.</span><span class="ident" id="4816964">IsNil</span><span class="op" id="4816969">(</span><span class="op" id="4816970">)</span>&nbsp;<span class="op" id="4816972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816977">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816985">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816989">pv</span>&nbsp;<span class="op" id="4816992">=</span>&nbsp;<span class="ident" id="4816994">pv</span><span class="op" id="4816996">.</span><span class="ident" id="4816997">Elem</span><span class="op" id="4817001">(</span><span class="op" id="4817002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817008">return</span>&nbsp;<span class="ident" id="4817015">pv</span><br>
<span class="lineno"></span><span class="op" id="4817018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="4817021">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="4817088">func</span>&nbsp;<span class="ident" id="4817093">encBool</span><span class="op" id="4817100">(</span><span class="ident" id="4817101">i</span>&nbsp;<span class="op" id="4817103">*</span><span class="ident" id="4817104">encInstr</span><span class="op" id="4817112">,</span>&nbsp;<span class="ident" id="4817114">state</span>&nbsp;<span class="op" id="4817120">*</span><span class="ident" id="4817121">encoderState</span><span class="op" id="4817133">,</span>&nbsp;<span class="ident" id="4817135">v</span>&nbsp;<span class="ident" id="4817137">reflect</span><span class="op" id="4817144">.</span><span class="ident" id="4817145">Value</span><span class="op" id="4817150">)</span>&nbsp;<span class="op" id="4817152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817155">b</span>&nbsp;<span class="op" id="4817157">:=</span>&nbsp;<span class="ident" id="4817160">v</span><span class="op" id="4817161">.</span><span class="ident" id="4817162">Bool</span><span class="op" id="4817166">(</span><span class="op" id="4817167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817170">if</span>&nbsp;<span class="ident" id="4817173">b</span>&nbsp;<span class="op" id="4817175">||</span>&nbsp;<span class="ident" id="4817178">state</span><span class="op" id="4817183">.</span><span class="ident" id="4817184">sendZero</span>&nbsp;<span class="op" id="4817193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817197">state</span><span class="op" id="4817202">.</span><span class="ident" id="4817203">update</span><span class="op" id="4817209">(</span><span class="ident" id="4817210">i</span><span class="op" id="4817211">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817215">if</span>&nbsp;<span class="ident" id="4817218">b</span>&nbsp;<span class="op" id="4817220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817225">state</span><span class="op" id="4817230">.</span><span class="ident" id="4817231">encodeUint</span><span class="op" id="4817241">(</span><span class="num" id="4817242">1</span><span class="op" id="4817243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817247">}</span>&nbsp;<span class="keyword" id="4817249">else</span>&nbsp;<span class="op" id="4817254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817259">state</span><span class="op" id="4817264">.</span><span class="ident" id="4817265">encodeUint</span><span class="op" id="4817275">(</span><span class="num" id="4817276">0</span><span class="op" id="4817277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817281">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817284">}</span><br>
<span class="lineno"></span><span class="op" id="4817286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4817289">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4817372">func</span>&nbsp;<span class="ident" id="4817377">encInt</span><span class="op" id="4817383">(</span><span class="ident" id="4817384">i</span>&nbsp;<span class="op" id="4817386">*</span><span class="ident" id="4817387">encInstr</span><span class="op" id="4817395">,</span>&nbsp;<span class="ident" id="4817397">state</span>&nbsp;<span class="op" id="4817403">*</span><span class="ident" id="4817404">encoderState</span><span class="op" id="4817416">,</span>&nbsp;<span class="ident" id="4817418">v</span>&nbsp;<span class="ident" id="4817420">reflect</span><span class="op" id="4817427">.</span><span class="ident" id="4817428">Value</span><span class="op" id="4817433">)</span>&nbsp;<span class="op" id="4817435">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817438">value</span>&nbsp;<span class="op" id="4817444">:=</span>&nbsp;<span class="ident" id="4817447">v</span><span class="op" id="4817448">.</span><span class="ident" id="4817449">Int</span><span class="op" id="4817452">(</span><span class="op" id="4817453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817456">if</span>&nbsp;<span class="ident" id="4817459">value</span>&nbsp;<span class="op" id="4817465">!=</span>&nbsp;<span class="num" id="4817468">0</span>&nbsp;<span class="op" id="4817470">||</span>&nbsp;<span class="ident" id="4817473">state</span><span class="op" id="4817478">.</span><span class="ident" id="4817479">sendZero</span>&nbsp;<span class="op" id="4817488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817492">state</span><span class="op" id="4817497">.</span><span class="ident" id="4817498">update</span><span class="op" id="4817504">(</span><span class="ident" id="4817505">i</span><span class="op" id="4817506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817510">state</span><span class="op" id="4817515">.</span><span class="ident" id="4817516">encodeInt</span><span class="op" id="4817525">(</span><span class="ident" id="4817526">value</span><span class="op" id="4817531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817534">}</span><br>
<span class="lineno">180</span><span class="op" id="4817536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4817539">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4817638">func</span>&nbsp;<span class="ident" id="4817643">encUint</span><span class="op" id="4817650">(</span><span class="ident" id="4817651">i</span>&nbsp;<span class="op" id="4817653">*</span><span class="ident" id="4817654">encInstr</span><span class="op" id="4817662">,</span>&nbsp;<span class="ident" id="4817664">state</span>&nbsp;<span class="op" id="4817670">*</span><span class="ident" id="4817671">encoderState</span><span class="op" id="4817683">,</span>&nbsp;<span class="ident" id="4817685">v</span>&nbsp;<span class="ident" id="4817687">reflect</span><span class="op" id="4817694">.</span><span class="ident" id="4817695">Value</span><span class="op" id="4817700">)</span>&nbsp;<span class="op" id="4817702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817705">value</span>&nbsp;<span class="op" id="4817711">:=</span>&nbsp;<span class="ident" id="4817714">v</span><span class="op" id="4817715">.</span><span class="ident" id="4817716">Uint</span><span class="op" id="4817720">(</span><span class="op" id="4817721">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817724">if</span>&nbsp;<span class="ident" id="4817727">value</span>&nbsp;<span class="op" id="4817733">!=</span>&nbsp;<span class="num" id="4817736">0</span>&nbsp;<span class="op" id="4817738">||</span>&nbsp;<span class="ident" id="4817741">state</span><span class="op" id="4817746">.</span><span class="ident" id="4817747">sendZero</span>&nbsp;<span class="op" id="4817756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817760">state</span><span class="op" id="4817765">.</span><span class="ident" id="4817766">update</span><span class="op" id="4817772">(</span><span class="ident" id="4817773">i</span><span class="op" id="4817774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817778">state</span><span class="op" id="4817783">.</span><span class="ident" id="4817784">encodeUint</span><span class="op" id="4817794">(</span><span class="ident" id="4817795">value</span><span class="op" id="4817800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817803">}</span><br>
<span class="lineno"></span><span class="op" id="4817805">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4817808">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="4817883">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="4817953">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4818025">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="4818097">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4818162">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="4818176">func</span>&nbsp;<span class="ident" id="4818181">floatBits</span><span class="op" id="4818190">(</span><span class="ident" id="4818191">f</span>&nbsp;<span class="builtintype" id="4818193">float64</span><span class="op" id="4818200">)</span>&nbsp;<span class="ident" id="4818202">uint64</span>&nbsp;<span class="op" id="4818209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818212">u</span>&nbsp;<span class="op" id="4818214">:=</span>&nbsp;<span class="ident" id="4818217">math</span><span class="op" id="4818221">.</span><span class="ident" id="4818222">Float64bits</span><span class="op" id="4818233">(</span><span class="ident" id="4818234">f</span><span class="op" id="4818235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818238">var</span>&nbsp;<span class="ident" id="4818242">v</span>&nbsp;<span class="ident" id="4818244">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818252">for</span>&nbsp;<span class="ident" id="4818256">i</span>&nbsp;<span class="op" id="4818258">:=</span>&nbsp;<span class="num" id="4818261">0</span><span class="op" id="4818262">;</span>&nbsp;<span class="ident" id="4818264">i</span>&nbsp;<span class="op" id="4818266">&lt;</span>&nbsp;<span class="num" id="4818268">8</span><span class="op" id="4818269">;</span>&nbsp;<span class="ident" id="4818271">i</span><span class="op" id="4818272">++</span>&nbsp;<span class="op" id="4818275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818279">v</span>&nbsp;<span class="op" id="4818281">&lt;&lt;=</span>&nbsp;<span class="num" id="4818285">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818289">v</span>&nbsp;<span class="op" id="4818291">|=</span>&nbsp;<span class="ident" id="4818294">u</span>&nbsp;<span class="op" id="4818296">&amp;</span>&nbsp;<span class="num" id="4818298">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818305">u</span>&nbsp;<span class="op" id="4818307">&gt;&gt;=</span>&nbsp;<span class="num" id="4818311">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818314">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818317">return</span>&nbsp;<span class="ident" id="4818324">v</span><br>
<span class="lineno"></span><span class="op" id="4818326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4818329">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4818409">func</span>&nbsp;<span class="ident" id="4818414">encFloat</span><span class="op" id="4818422">(</span><span class="ident" id="4818423">i</span>&nbsp;<span class="op" id="4818425">*</span><span class="ident" id="4818426">encInstr</span><span class="op" id="4818434">,</span>&nbsp;<span class="ident" id="4818436">state</span>&nbsp;<span class="op" id="4818442">*</span><span class="ident" id="4818443">encoderState</span><span class="op" id="4818455">,</span>&nbsp;<span class="ident" id="4818457">v</span>&nbsp;<span class="ident" id="4818459">reflect</span><span class="op" id="4818466">.</span><span class="ident" id="4818467">Value</span><span class="op" id="4818472">)</span>&nbsp;<span class="op" id="4818474">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818477">f</span>&nbsp;<span class="op" id="4818479">:=</span>&nbsp;<span class="ident" id="4818482">v</span><span class="op" id="4818483">.</span><span class="ident" id="4818484">Float</span><span class="op" id="4818489">(</span><span class="op" id="4818490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818493">if</span>&nbsp;<span class="ident" id="4818496">f</span>&nbsp;<span class="op" id="4818498">!=</span>&nbsp;<span class="num" id="4818501">0</span>&nbsp;<span class="op" id="4818503">||</span>&nbsp;<span class="ident" id="4818506">state</span><span class="op" id="4818511">.</span><span class="ident" id="4818512">sendZero</span>&nbsp;<span class="op" id="4818521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818525">bits</span>&nbsp;<span class="op" id="4818530">:=</span>&nbsp;<span class="ident" id="4818533">floatBits</span><span class="op" id="4818542">(</span><span class="ident" id="4818543">f</span><span class="op" id="4818544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818548">state</span><span class="op" id="4818553">.</span><span class="ident" id="4818554">update</span><span class="op" id="4818560">(</span><span class="ident" id="4818561">i</span><span class="op" id="4818562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818566">state</span><span class="op" id="4818571">.</span><span class="ident" id="4818572">encodeUint</span><span class="op" id="4818582">(</span><span class="ident" id="4818583">bits</span><span class="op" id="4818587">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818590">}</span><br>
<span class="lineno"></span><span class="op" id="4818592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4818595">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4818675">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="4818754">func</span>&nbsp;<span class="ident" id="4818759">encComplex</span><span class="op" id="4818769">(</span><span class="ident" id="4818770">i</span>&nbsp;<span class="op" id="4818772">*</span><span class="ident" id="4818773">encInstr</span><span class="op" id="4818781">,</span>&nbsp;<span class="ident" id="4818783">state</span>&nbsp;<span class="op" id="4818789">*</span><span class="ident" id="4818790">encoderState</span><span class="op" id="4818802">,</span>&nbsp;<span class="ident" id="4818804">v</span>&nbsp;<span class="ident" id="4818806">reflect</span><span class="op" id="4818813">.</span><span class="ident" id="4818814">Value</span><span class="op" id="4818819">)</span>&nbsp;<span class="op" id="4818821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818824">c</span>&nbsp;<span class="op" id="4818826">:=</span>&nbsp;<span class="ident" id="4818829">v</span><span class="op" id="4818830">.</span><span class="ident" id="4818831">Complex</span><span class="op" id="4818838">(</span><span class="op" id="4818839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818842">if</span>&nbsp;<span class="ident" id="4818845">c</span>&nbsp;<span class="op" id="4818847">!=</span>&nbsp;<span class="num" id="4818850">0</span><span class="op" id="4818851">+</span><span class="num" id="4818852">0i</span>&nbsp;<span class="op" id="4818855">||</span>&nbsp;<span class="ident" id="4818858">state</span><span class="op" id="4818863">.</span><span class="ident" id="4818864">sendZero</span>&nbsp;<span class="op" id="4818873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818877">rpart</span>&nbsp;<span class="op" id="4818883">:=</span>&nbsp;<span class="ident" id="4818886">floatBits</span><span class="op" id="4818895">(</span><span class="builtinfunc" id="4818896">real</span><span class="op" id="4818900">(</span><span class="ident" id="4818901">c</span><span class="op" id="4818902">)</span><span class="op" id="4818903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818907">ipart</span>&nbsp;<span class="op" id="4818913">:=</span>&nbsp;<span class="ident" id="4818916">floatBits</span><span class="op" id="4818925">(</span><span class="builtinfunc" id="4818926">imag</span><span class="op" id="4818930">(</span><span class="ident" id="4818931">c</span><span class="op" id="4818932">)</span><span class="op" id="4818933">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818937">state</span><span class="op" id="4818942">.</span><span class="ident" id="4818943">update</span><span class="op" id="4818949">(</span><span class="ident" id="4818950">i</span><span class="op" id="4818951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818955">state</span><span class="op" id="4818960">.</span><span class="ident" id="4818961">encodeUint</span><span class="op" id="4818971">(</span><span class="ident" id="4818972">rpart</span><span class="op" id="4818977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818981">state</span><span class="op" id="4818986">.</span><span class="ident" id="4818987">encodeUint</span><span class="op" id="4818997">(</span><span class="ident" id="4818998">ipart</span><span class="op" id="4819003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819006">}</span><br>
<span class="lineno"></span><span class="op" id="4819008">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="4819011">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4819068">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4819143">func</span>&nbsp;<span class="ident" id="4819148">encUint8Array</span><span class="op" id="4819161">(</span><span class="ident" id="4819162">i</span>&nbsp;<span class="op" id="4819164">*</span><span class="ident" id="4819165">encInstr</span><span class="op" id="4819173">,</span>&nbsp;<span class="ident" id="4819175">state</span>&nbsp;<span class="op" id="4819181">*</span><span class="ident" id="4819182">encoderState</span><span class="op" id="4819194">,</span>&nbsp;<span class="ident" id="4819196">v</span>&nbsp;<span class="ident" id="4819198">reflect</span><span class="op" id="4819205">.</span><span class="ident" id="4819206">Value</span><span class="op" id="4819211">)</span>&nbsp;<span class="op" id="4819213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819216">b</span>&nbsp;<span class="op" id="4819218">:=</span>&nbsp;<span class="ident" id="4819221">v</span><span class="op" id="4819222">.</span><span class="ident" id="4819223">Bytes</span><span class="op" id="4819228">(</span><span class="op" id="4819229">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819232">if</span>&nbsp;<span class="builtinfunc" id="4819235">len</span><span class="op" id="4819238">(</span><span class="ident" id="4819239">b</span><span class="op" id="4819240">)</span>&nbsp;<span class="op" id="4819242">&gt;</span>&nbsp;<span class="num" id="4819244">0</span>&nbsp;<span class="op" id="4819246">||</span>&nbsp;<span class="ident" id="4819249">state</span><span class="op" id="4819254">.</span><span class="ident" id="4819255">sendZero</span>&nbsp;<span class="op" id="4819264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819268">state</span><span class="op" id="4819273">.</span><span class="ident" id="4819274">update</span><span class="op" id="4819280">(</span><span class="ident" id="4819281">i</span><span class="op" id="4819282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819286">state</span><span class="op" id="4819291">.</span><span class="ident" id="4819292">encodeUint</span><span class="op" id="4819302">(</span><span class="ident" id="4819303">uint64</span><span class="op" id="4819309">(</span><span class="builtinfunc" id="4819310">len</span><span class="op" id="4819313">(</span><span class="ident" id="4819314">b</span><span class="op" id="4819315">)</span><span class="op" id="4819316">)</span><span class="op" id="4819317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819321">state</span><span class="op" id="4819326">.</span><span class="ident" id="4819327">b</span><span class="op" id="4819328">.</span><span class="ident" id="4819329">Write</span><span class="op" id="4819334">(</span><span class="ident" id="4819335">b</span><span class="op" id="4819336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819339">}</span><br>
<span class="lineno">240</span><span class="op" id="4819341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4819344">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4819393">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4819464">func</span>&nbsp;<span class="ident" id="4819469">encString</span><span class="op" id="4819478">(</span><span class="ident" id="4819479">i</span>&nbsp;<span class="op" id="4819481">*</span><span class="ident" id="4819482">encInstr</span><span class="op" id="4819490">,</span>&nbsp;<span class="ident" id="4819492">state</span>&nbsp;<span class="op" id="4819498">*</span><span class="ident" id="4819499">encoderState</span><span class="op" id="4819511">,</span>&nbsp;<span class="ident" id="4819513">v</span>&nbsp;<span class="ident" id="4819515">reflect</span><span class="op" id="4819522">.</span><span class="ident" id="4819523">Value</span><span class="op" id="4819528">)</span>&nbsp;<span class="op" id="4819530">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819533">s</span>&nbsp;<span class="op" id="4819535">:=</span>&nbsp;<span class="ident" id="4819538">v</span><span class="op" id="4819539">.</span><span class="ident" id="4819540">String</span><span class="op" id="4819546">(</span><span class="op" id="4819547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819550">if</span>&nbsp;<span class="builtinfunc" id="4819553">len</span><span class="op" id="4819556">(</span><span class="ident" id="4819557">s</span><span class="op" id="4819558">)</span>&nbsp;<span class="op" id="4819560">&gt;</span>&nbsp;<span class="num" id="4819562">0</span>&nbsp;<span class="op" id="4819564">||</span>&nbsp;<span class="ident" id="4819567">state</span><span class="op" id="4819572">.</span><span class="ident" id="4819573">sendZero</span>&nbsp;<span class="op" id="4819582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819586">state</span><span class="op" id="4819591">.</span><span class="ident" id="4819592">update</span><span class="op" id="4819598">(</span><span class="ident" id="4819599">i</span><span class="op" id="4819600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819604">state</span><span class="op" id="4819609">.</span><span class="ident" id="4819610">encodeUint</span><span class="op" id="4819620">(</span><span class="ident" id="4819621">uint64</span><span class="op" id="4819627">(</span><span class="builtinfunc" id="4819628">len</span><span class="op" id="4819631">(</span><span class="ident" id="4819632">s</span><span class="op" id="4819633">)</span><span class="op" id="4819634">)</span><span class="op" id="4819635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819639">state</span><span class="op" id="4819644">.</span><span class="ident" id="4819645">b</span><span class="op" id="4819646">.</span><span class="ident" id="4819647">WriteString</span><span class="op" id="4819658">(</span><span class="ident" id="4819659">s</span><span class="op" id="4819660">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819663">}</span><br>
<span class="lineno"></span><span class="op" id="4819665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4819668">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="4819728">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="4819759">func</span>&nbsp;<span class="ident" id="4819764">encStructTerminator</span><span class="op" id="4819783">(</span><span class="ident" id="4819784">i</span>&nbsp;<span class="op" id="4819786">*</span><span class="ident" id="4819787">encInstr</span><span class="op" id="4819795">,</span>&nbsp;<span class="ident" id="4819797">state</span>&nbsp;<span class="op" id="4819803">*</span><span class="ident" id="4819804">encoderState</span><span class="op" id="4819816">,</span>&nbsp;<span class="ident" id="4819818">v</span>&nbsp;<span class="ident" id="4819820">reflect</span><span class="op" id="4819827">.</span><span class="ident" id="4819828">Value</span><span class="op" id="4819833">)</span>&nbsp;<span class="op" id="4819835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819838">state</span><span class="op" id="4819843">.</span><span class="ident" id="4819844">encodeUint</span><span class="op" id="4819854">(</span><span class="num" id="4819855">0</span><span class="op" id="4819856">)</span><br>
<span class="lineno"></span><span class="op" id="4819858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4819861">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="4819882">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="4819960">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="4820040">type</span>&nbsp;<span class="ident" id="4820045">encEngine</span>&nbsp;<span class="keyword" id="4820055">struct</span>&nbsp;<span class="op" id="4820062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820065">instr</span>&nbsp;<span class="op" id="4820071">[</span><span class="op" id="4820072">]</span><span class="ident" id="4820073">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="4820082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4820085">const</span>&nbsp;<span class="ident" id="4820091">singletonField</span>&nbsp;<span class="op" id="4820106">=</span>&nbsp;<span class="num" id="4820108">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4820111">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="4820178">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="4820232">func</span>&nbsp;<span class="ident" id="4820237">valid</span><span class="op" id="4820242">(</span><span class="ident" id="4820243">v</span>&nbsp;<span class="ident" id="4820245">reflect</span><span class="op" id="4820252">.</span><span class="ident" id="4820253">Value</span><span class="op" id="4820258">)</span>&nbsp;<span class="builtintype" id="4820260">bool</span>&nbsp;<span class="op" id="4820265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820268">switch</span>&nbsp;<span class="ident" id="4820275">v</span><span class="op" id="4820276">.</span><span class="ident" id="4820277">Kind</span><span class="op" id="4820281">(</span><span class="op" id="4820282">)</span>&nbsp;<span class="op" id="4820284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820287">case</span>&nbsp;<span class="ident" id="4820292">reflect</span><span class="op" id="4820299">.</span><span class="ident" id="4820300">Invalid</span><span class="op" id="4820307">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820311">return</span>&nbsp;<span class="builtintype" id="4820318">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820325">case</span>&nbsp;<span class="ident" id="4820330">reflect</span><span class="op" id="4820337">.</span><span class="ident" id="4820338">Ptr</span><span class="op" id="4820341">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820345">return</span>&nbsp;<span class="op" id="4820352">!</span><span class="ident" id="4820353">v</span><span class="op" id="4820354">.</span><span class="ident" id="4820355">IsNil</span><span class="op" id="4820360">(</span><span class="op" id="4820361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4820364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820367">return</span>&nbsp;<span class="builtintype" id="4820374">true</span><br>
<span class="lineno"></span><span class="op" id="4820379">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4820382">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4820443">func</span>&nbsp;<span class="op" id="4820448">(</span><span class="ident" id="4820449">enc</span>&nbsp;<span class="op" id="4820453">*</span><span class="ident" id="4820454">Encoder</span><span class="op" id="4820461">)</span>&nbsp;<span class="ident" id="4820463">encodeSingle</span><span class="op" id="4820475">(</span><span class="ident" id="4820476">b</span>&nbsp;<span class="op" id="4820478">*</span><span class="ident" id="4820479">encBuffer</span><span class="op" id="4820488">,</span>&nbsp;<span class="ident" id="4820490">engine</span>&nbsp;<span class="op" id="4820497">*</span><span class="ident" id="4820498">encEngine</span><span class="op" id="4820507">,</span>&nbsp;<span class="ident" id="4820509">value</span>&nbsp;<span class="ident" id="4820515">reflect</span><span class="op" id="4820522">.</span><span class="ident" id="4820523">Value</span><span class="op" id="4820528">)</span>&nbsp;<span class="op" id="4820530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820533">state</span>&nbsp;<span class="op" id="4820539">:=</span>&nbsp;<span class="ident" id="4820542">enc</span><span class="op" id="4820545">.</span><span class="ident" id="4820546">newEncoderState</span><span class="op" id="4820561">(</span><span class="ident" id="4820562">b</span><span class="op" id="4820563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820566">defer</span>&nbsp;<span class="ident" id="4820572">enc</span><span class="op" id="4820575">.</span><span class="ident" id="4820576">freeEncoderState</span><span class="op" id="4820592">(</span><span class="ident" id="4820593">state</span><span class="op" id="4820598">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820601">state</span><span class="op" id="4820606">.</span><span class="ident" id="4820607">fieldnum</span>&nbsp;<span class="op" id="4820616">=</span>&nbsp;<span class="ident" id="4820618">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4820634">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4820707">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820778">state</span><span class="op" id="4820783">.</span><span class="ident" id="4820784">sendZero</span>&nbsp;<span class="op" id="4820793">=</span>&nbsp;<span class="builtintype" id="4820795">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820801">instr</span>&nbsp;<span class="op" id="4820807">:=</span>&nbsp;<span class="op" id="4820810">&amp;</span><span class="ident" id="4820811">engine</span><span class="op" id="4820817">.</span><span class="ident" id="4820818">instr</span><span class="op" id="4820823">[</span><span class="ident" id="4820824">singletonField</span><span class="op" id="4820838">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820841">if</span>&nbsp;<span class="ident" id="4820844">instr</span><span class="op" id="4820849">.</span><span class="ident" id="4820850">indir</span>&nbsp;<span class="op" id="4820856">&gt;</span>&nbsp;<span class="num" id="4820858">0</span>&nbsp;<span class="op" id="4820860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820864">value</span>&nbsp;<span class="op" id="4820870">=</span>&nbsp;<span class="ident" id="4820872">encIndirect</span><span class="op" id="4820883">(</span><span class="ident" id="4820884">value</span><span class="op" id="4820889">,</span>&nbsp;<span class="ident" id="4820891">instr</span><span class="op" id="4820896">.</span><span class="ident" id="4820897">indir</span><span class="op" id="4820902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4820905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4820908">if</span>&nbsp;<span class="ident" id="4820911">valid</span><span class="op" id="4820916">(</span><span class="ident" id="4820917">value</span><span class="op" id="4820922">)</span>&nbsp;<span class="op" id="4820924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820928">instr</span><span class="op" id="4820933">.</span><span class="ident" id="4820934">op</span><span class="op" id="4820936">(</span><span class="ident" id="4820937">instr</span><span class="op" id="4820942">,</span>&nbsp;<span class="ident" id="4820944">state</span><span class="op" id="4820949">,</span>&nbsp;<span class="ident" id="4820951">value</span><span class="op" id="4820956">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4820959">}</span><br>
<span class="lineno"></span><span class="op" id="4820961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4820964">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4821011">func</span>&nbsp;<span class="op" id="4821016">(</span><span class="ident" id="4821017">enc</span>&nbsp;<span class="op" id="4821021">*</span><span class="ident" id="4821022">Encoder</span><span class="op" id="4821029">)</span>&nbsp;<span class="ident" id="4821031">encodeStruct</span><span class="op" id="4821043">(</span><span class="ident" id="4821044">b</span>&nbsp;<span class="op" id="4821046">*</span><span class="ident" id="4821047">encBuffer</span><span class="op" id="4821056">,</span>&nbsp;<span class="ident" id="4821058">engine</span>&nbsp;<span class="op" id="4821065">*</span><span class="ident" id="4821066">encEngine</span><span class="op" id="4821075">,</span>&nbsp;<span class="ident" id="4821077">value</span>&nbsp;<span class="ident" id="4821083">reflect</span><span class="op" id="4821090">.</span><span class="ident" id="4821091">Value</span><span class="op" id="4821096">)</span>&nbsp;<span class="op" id="4821098">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821101">if</span>&nbsp;<span class="op" id="4821104">!</span><span class="ident" id="4821105">valid</span><span class="op" id="4821110">(</span><span class="ident" id="4821111">value</span><span class="op" id="4821116">)</span>&nbsp;<span class="op" id="4821118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821122">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821133">state</span>&nbsp;<span class="op" id="4821139">:=</span>&nbsp;<span class="ident" id="4821142">enc</span><span class="op" id="4821145">.</span><span class="ident" id="4821146">newEncoderState</span><span class="op" id="4821161">(</span><span class="ident" id="4821162">b</span><span class="op" id="4821163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821166">defer</span>&nbsp;<span class="ident" id="4821172">enc</span><span class="op" id="4821175">.</span><span class="ident" id="4821176">freeEncoderState</span><span class="op" id="4821192">(</span><span class="ident" id="4821193">state</span><span class="op" id="4821198">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821201">state</span><span class="op" id="4821206">.</span><span class="ident" id="4821207">fieldnum</span>&nbsp;<span class="op" id="4821216">=</span>&nbsp;<span class="op" id="4821218">-</span><span class="num" id="4821219">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821222">for</span>&nbsp;<span class="ident" id="4821226">i</span>&nbsp;<span class="op" id="4821228">:=</span>&nbsp;<span class="num" id="4821231">0</span><span class="op" id="4821232">;</span>&nbsp;<span class="ident" id="4821234">i</span>&nbsp;<span class="op" id="4821236">&lt;</span>&nbsp;<span class="builtinfunc" id="4821238">len</span><span class="op" id="4821241">(</span><span class="ident" id="4821242">engine</span><span class="op" id="4821248">.</span><span class="ident" id="4821249">instr</span><span class="op" id="4821254">)</span><span class="op" id="4821255">;</span>&nbsp;<span class="ident" id="4821257">i</span><span class="op" id="4821258">++</span>&nbsp;<span class="op" id="4821261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821265">instr</span>&nbsp;<span class="op" id="4821271">:=</span>&nbsp;<span class="op" id="4821274">&amp;</span><span class="ident" id="4821275">engine</span><span class="op" id="4821281">.</span><span class="ident" id="4821282">instr</span><span class="op" id="4821287">[</span><span class="ident" id="4821288">i</span><span class="op" id="4821289">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821293">if</span>&nbsp;<span class="ident" id="4821296">i</span>&nbsp;<span class="op" id="4821298">&gt;=</span>&nbsp;<span class="ident" id="4821301">value</span><span class="op" id="4821306">.</span><span class="ident" id="4821307">NumField</span><span class="op" id="4821315">(</span><span class="op" id="4821316">)</span>&nbsp;<span class="op" id="4821318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821323">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821349">instr</span><span class="op" id="4821354">.</span><span class="ident" id="4821355">op</span><span class="op" id="4821357">(</span><span class="ident" id="4821358">instr</span><span class="op" id="4821363">,</span>&nbsp;<span class="ident" id="4821365">state</span><span class="op" id="4821370">,</span>&nbsp;<span class="ident" id="4821372">reflect</span><span class="op" id="4821379">.</span><span class="ident" id="4821380">Value</span><span class="op" id="4821385">{</span><span class="op" id="4821386">}</span><span class="op" id="4821387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821392">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821404">field</span>&nbsp;<span class="op" id="4821410">:=</span>&nbsp;<span class="ident" id="4821413">value</span><span class="op" id="4821418">.</span><span class="ident" id="4821419">FieldByIndex</span><span class="op" id="4821431">(</span><span class="ident" id="4821432">instr</span><span class="op" id="4821437">.</span><span class="ident" id="4821438">index</span><span class="op" id="4821443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821447">if</span>&nbsp;<span class="ident" id="4821450">instr</span><span class="op" id="4821455">.</span><span class="ident" id="4821456">indir</span>&nbsp;<span class="op" id="4821462">&gt;</span>&nbsp;<span class="num" id="4821464">0</span>&nbsp;<span class="op" id="4821466">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821471">field</span>&nbsp;<span class="op" id="4821477">=</span>&nbsp;<span class="ident" id="4821479">encIndirect</span><span class="op" id="4821490">(</span><span class="ident" id="4821491">field</span><span class="op" id="4821496">,</span>&nbsp;<span class="ident" id="4821498">instr</span><span class="op" id="4821503">.</span><span class="ident" id="4821504">indir</span><span class="op" id="4821509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821514">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821586">if</span>&nbsp;<span class="op" id="4821589">!</span><span class="ident" id="4821590">valid</span><span class="op" id="4821595">(</span><span class="ident" id="4821596">field</span><span class="op" id="4821601">)</span>&nbsp;<span class="op" id="4821603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821609">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821621">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821629">instr</span><span class="op" id="4821634">.</span><span class="ident" id="4821635">op</span><span class="op" id="4821637">(</span><span class="ident" id="4821638">instr</span><span class="op" id="4821643">,</span>&nbsp;<span class="ident" id="4821645">state</span><span class="op" id="4821650">,</span>&nbsp;<span class="ident" id="4821652">field</span><span class="op" id="4821657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4821660">}</span><br>
<span class="lineno"></span><span class="op" id="4821662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="4821665">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="4821698">func</span>&nbsp;<span class="op" id="4821703">(</span><span class="ident" id="4821704">enc</span>&nbsp;<span class="op" id="4821708">*</span><span class="ident" id="4821709">Encoder</span><span class="op" id="4821716">)</span>&nbsp;<span class="ident" id="4821718">encodeArray</span><span class="op" id="4821729">(</span><span class="ident" id="4821730">b</span>&nbsp;<span class="op" id="4821732">*</span><span class="ident" id="4821733">encBuffer</span><span class="op" id="4821742">,</span>&nbsp;<span class="ident" id="4821744">value</span>&nbsp;<span class="ident" id="4821750">reflect</span><span class="op" id="4821757">.</span><span class="ident" id="4821758">Value</span><span class="op" id="4821763">,</span>&nbsp;<span class="ident" id="4821765">op</span>&nbsp;<span class="ident" id="4821768">encOp</span><span class="op" id="4821773">,</span>&nbsp;<span class="ident" id="4821775">elemIndir</span>&nbsp;<span class="builtintype" id="4821785">int</span><span class="op" id="4821788">,</span>&nbsp;<span class="ident" id="4821790">length</span>&nbsp;<span class="builtintype" id="4821797">int</span><span class="op" id="4821800">,</span>&nbsp;<span class="ident" id="4821802">helper</span>&nbsp;<span class="ident" id="4821809">encHelper</span><span class="op" id="4821818">)</span>&nbsp;<span class="op" id="4821820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821823">state</span>&nbsp;<span class="op" id="4821829">:=</span>&nbsp;<span class="ident" id="4821832">enc</span><span class="op" id="4821835">.</span><span class="ident" id="4821836">newEncoderState</span><span class="op" id="4821851">(</span><span class="ident" id="4821852">b</span><span class="op" id="4821853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821856">defer</span>&nbsp;<span class="ident" id="4821862">enc</span><span class="op" id="4821865">.</span><span class="ident" id="4821866">freeEncoderState</span><span class="op" id="4821882">(</span><span class="ident" id="4821883">state</span><span class="op" id="4821888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821891">state</span><span class="op" id="4821896">.</span><span class="ident" id="4821897">fieldnum</span>&nbsp;<span class="op" id="4821906">=</span>&nbsp;<span class="op" id="4821908">-</span><span class="num" id="4821909">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821912">state</span><span class="op" id="4821917">.</span><span class="ident" id="4821918">sendZero</span>&nbsp;<span class="op" id="4821927">=</span>&nbsp;<span class="builtintype" id="4821929">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821935">state</span><span class="op" id="4821940">.</span><span class="ident" id="4821941">encodeUint</span><span class="op" id="4821951">(</span><span class="ident" id="4821952">uint64</span><span class="op" id="4821958">(</span><span class="ident" id="4821959">length</span><span class="op" id="4821965">)</span><span class="op" id="4821966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4821969">if</span>&nbsp;<span class="ident" id="4821972">helper</span>&nbsp;<span class="op" id="4821979">!=</span>&nbsp;<span class="ident" id="4821982">nil</span>&nbsp;<span class="op" id="4821986">&amp;&amp;</span>&nbsp;<span class="ident" id="4821989">helper</span><span class="op" id="4821995">(</span><span class="ident" id="4821996">state</span><span class="op" id="4822001">,</span>&nbsp;<span class="ident" id="4822003">value</span><span class="op" id="4822008">)</span>&nbsp;<span class="op" id="4822010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822014">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4822022">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822025">for</span>&nbsp;<span class="ident" id="4822029">i</span>&nbsp;<span class="op" id="4822031">:=</span>&nbsp;<span class="num" id="4822034">0</span><span class="op" id="4822035">;</span>&nbsp;<span class="ident" id="4822037">i</span>&nbsp;<span class="op" id="4822039">&lt;</span>&nbsp;<span class="ident" id="4822041">length</span><span class="op" id="4822047">;</span>&nbsp;<span class="ident" id="4822049">i</span><span class="op" id="4822050">++</span>&nbsp;<span class="op" id="4822053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822057">elem</span>&nbsp;<span class="op" id="4822062">:=</span>&nbsp;<span class="ident" id="4822065">value</span><span class="op" id="4822070">.</span><span class="ident" id="4822071">Index</span><span class="op" id="4822076">(</span><span class="ident" id="4822077">i</span><span class="op" id="4822078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822082">if</span>&nbsp;<span class="ident" id="4822085">elemIndir</span>&nbsp;<span class="op" id="4822095">&gt;</span>&nbsp;<span class="num" id="4822097">0</span>&nbsp;<span class="op" id="4822099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822104">elem</span>&nbsp;<span class="op" id="4822109">=</span>&nbsp;<span class="ident" id="4822111">encIndirect</span><span class="op" id="4822122">(</span><span class="ident" id="4822123">elem</span><span class="op" id="4822127">,</span>&nbsp;<span class="ident" id="4822129">elemIndir</span><span class="op" id="4822138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822143">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822214">if</span>&nbsp;<span class="op" id="4822217">!</span><span class="ident" id="4822218">valid</span><span class="op" id="4822223">(</span><span class="ident" id="4822224">elem</span><span class="op" id="4822228">)</span>&nbsp;<span class="op" id="4822230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822236">errorf</span><span class="op" id="4822242">(</span><span class="string" id="4822243">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="4822269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4822274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4822278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822282">op</span><span class="op" id="4822284">(</span><span class="ident" id="4822285">nil</span><span class="op" id="4822288">,</span>&nbsp;<span class="ident" id="4822290">state</span><span class="op" id="4822295">,</span>&nbsp;<span class="ident" id="4822297">elem</span><span class="op" id="4822301">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4822304">}</span><br>
<span class="lineno"></span><span class="op" id="4822306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4822309">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4822377">func</span>&nbsp;<span class="ident" id="4822382">encodeReflectValue</span><span class="op" id="4822400">(</span><span class="ident" id="4822401">state</span>&nbsp;<span class="op" id="4822407">*</span><span class="ident" id="4822408">encoderState</span><span class="op" id="4822420">,</span>&nbsp;<span class="ident" id="4822422">v</span>&nbsp;<span class="ident" id="4822424">reflect</span><span class="op" id="4822431">.</span><span class="ident" id="4822432">Value</span><span class="op" id="4822437">,</span>&nbsp;<span class="ident" id="4822439">op</span>&nbsp;<span class="ident" id="4822442">encOp</span><span class="op" id="4822447">,</span>&nbsp;<span class="ident" id="4822449">indir</span>&nbsp;<span class="builtintype" id="4822455">int</span><span class="op" id="4822458">)</span>&nbsp;<span class="op" id="4822460">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822463">for</span>&nbsp;<span class="ident" id="4822467">i</span>&nbsp;<span class="op" id="4822469">:=</span>&nbsp;<span class="num" id="4822472">0</span><span class="op" id="4822473">;</span>&nbsp;<span class="ident" id="4822475">i</span>&nbsp;<span class="op" id="4822477">&lt;</span>&nbsp;<span class="ident" id="4822479">indir</span>&nbsp;<span class="op" id="4822485">&amp;&amp;</span>&nbsp;<span class="ident" id="4822488">v</span><span class="op" id="4822489">.</span><span class="ident" id="4822490">IsValid</span><span class="op" id="4822497">(</span><span class="op" id="4822498">)</span><span class="op" id="4822499">;</span>&nbsp;<span class="ident" id="4822501">i</span><span class="op" id="4822502">++</span>&nbsp;<span class="op" id="4822505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822509">v</span>&nbsp;<span class="op" id="4822511">=</span>&nbsp;<span class="ident" id="4822513">reflect</span><span class="op" id="4822520">.</span><span class="ident" id="4822521">Indirect</span><span class="op" id="4822529">(</span><span class="ident" id="4822530">v</span><span class="op" id="4822531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4822534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822537">if</span>&nbsp;<span class="op" id="4822540">!</span><span class="ident" id="4822541">v</span><span class="op" id="4822542">.</span><span class="ident" id="4822543">IsValid</span><span class="op" id="4822550">(</span><span class="op" id="4822551">)</span>&nbsp;<span class="op" id="4822553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822557">errorf</span><span class="op" id="4822563">(</span><span class="string" id="4822564">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="4822597">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4822600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822603">op</span><span class="op" id="4822605">(</span><span class="ident" id="4822606">nil</span><span class="op" id="4822609">,</span>&nbsp;<span class="ident" id="4822611">state</span><span class="op" id="4822616">,</span>&nbsp;<span class="ident" id="4822618">v</span><span class="op" id="4822619">)</span><br>
<span class="lineno"></span><span class="op" id="4822621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4822624">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="4822698">func</span>&nbsp;<span class="op" id="4822703">(</span><span class="ident" id="4822704">enc</span>&nbsp;<span class="op" id="4822708">*</span><span class="ident" id="4822709">Encoder</span><span class="op" id="4822716">)</span>&nbsp;<span class="ident" id="4822718">encodeMap</span><span class="op" id="4822727">(</span><span class="ident" id="4822728">b</span>&nbsp;<span class="op" id="4822730">*</span><span class="ident" id="4822731">encBuffer</span><span class="op" id="4822740">,</span>&nbsp;<span class="ident" id="4822742">mv</span>&nbsp;<span class="ident" id="4822745">reflect</span><span class="op" id="4822752">.</span><span class="ident" id="4822753">Value</span><span class="op" id="4822758">,</span>&nbsp;<span class="ident" id="4822760">keyOp</span><span class="op" id="4822765">,</span>&nbsp;<span class="ident" id="4822767">elemOp</span>&nbsp;<span class="ident" id="4822774">encOp</span><span class="op" id="4822779">,</span>&nbsp;<span class="ident" id="4822781">keyIndir</span><span class="op" id="4822789">,</span>&nbsp;<span class="ident" id="4822791">elemIndir</span>&nbsp;<span class="builtintype" id="4822801">int</span><span class="op" id="4822804">)</span>&nbsp;<span class="op" id="4822806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822809">state</span>&nbsp;<span class="op" id="4822815">:=</span>&nbsp;<span class="ident" id="4822818">enc</span><span class="op" id="4822821">.</span><span class="ident" id="4822822">newEncoderState</span><span class="op" id="4822837">(</span><span class="ident" id="4822838">b</span><span class="op" id="4822839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822842">state</span><span class="op" id="4822847">.</span><span class="ident" id="4822848">fieldnum</span>&nbsp;<span class="op" id="4822857">=</span>&nbsp;<span class="op" id="4822859">-</span><span class="num" id="4822860">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822863">state</span><span class="op" id="4822868">.</span><span class="ident" id="4822869">sendZero</span>&nbsp;<span class="op" id="4822878">=</span>&nbsp;<span class="builtintype" id="4822880">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822886">keys</span>&nbsp;<span class="op" id="4822891">:=</span>&nbsp;<span class="ident" id="4822894">mv</span><span class="op" id="4822896">.</span><span class="ident" id="4822897">MapKeys</span><span class="op" id="4822904">(</span><span class="op" id="4822905">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822908">state</span><span class="op" id="4822913">.</span><span class="ident" id="4822914">encodeUint</span><span class="op" id="4822924">(</span><span class="ident" id="4822925">uint64</span><span class="op" id="4822931">(</span><span class="builtinfunc" id="4822932">len</span><span class="op" id="4822935">(</span><span class="ident" id="4822936">keys</span><span class="op" id="4822940">)</span><span class="op" id="4822941">)</span><span class="op" id="4822942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4822945">for</span>&nbsp;<span class="ident" id="4822949">_</span><span class="op" id="4822950">,</span>&nbsp;<span class="ident" id="4822952">key</span>&nbsp;<span class="op" id="4822956">:=</span>&nbsp;<span class="keyword" id="4822959">range</span>&nbsp;<span class="ident" id="4822965">keys</span>&nbsp;<span class="op" id="4822970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822974">encodeReflectValue</span><span class="op" id="4822992">(</span><span class="ident" id="4822993">state</span><span class="op" id="4822998">,</span>&nbsp;<span class="ident" id="4823000">key</span><span class="op" id="4823003">,</span>&nbsp;<span class="ident" id="4823005">keyOp</span><span class="op" id="4823010">,</span>&nbsp;<span class="ident" id="4823012">keyIndir</span><span class="op" id="4823020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823024">encodeReflectValue</span><span class="op" id="4823042">(</span><span class="ident" id="4823043">state</span><span class="op" id="4823048">,</span>&nbsp;<span class="ident" id="4823050">mv</span><span class="op" id="4823052">.</span><span class="ident" id="4823053">MapIndex</span><span class="op" id="4823061">(</span><span class="ident" id="4823062">key</span><span class="op" id="4823065">)</span><span class="op" id="4823066">,</span>&nbsp;<span class="ident" id="4823068">elemOp</span><span class="op" id="4823074">,</span>&nbsp;<span class="ident" id="4823076">elemIndir</span><span class="op" id="4823085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4823088">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823091">enc</span><span class="op" id="4823094">.</span><span class="ident" id="4823095">freeEncoderState</span><span class="op" id="4823111">(</span><span class="ident" id="4823112">state</span><span class="op" id="4823117">)</span><br>
<span class="lineno"></span><span class="op" id="4823119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4823122">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="4823173">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="4823255">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="4823342">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="4823425">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4823450">func</span>&nbsp;<span class="op" id="4823455">(</span><span class="ident" id="4823456">enc</span>&nbsp;<span class="op" id="4823460">*</span><span class="ident" id="4823461">Encoder</span><span class="op" id="4823468">)</span>&nbsp;<span class="ident" id="4823470">encodeInterface</span><span class="op" id="4823485">(</span><span class="ident" id="4823486">b</span>&nbsp;<span class="op" id="4823488">*</span><span class="ident" id="4823489">encBuffer</span><span class="op" id="4823498">,</span>&nbsp;<span class="ident" id="4823500">iv</span>&nbsp;<span class="ident" id="4823503">reflect</span><span class="op" id="4823510">.</span><span class="ident" id="4823511">Value</span><span class="op" id="4823516">)</span>&nbsp;<span class="op" id="4823518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4823521">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4823586">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823657">elem</span>&nbsp;<span class="op" id="4823662">:=</span>&nbsp;<span class="ident" id="4823665">iv</span><span class="op" id="4823667">.</span><span class="ident" id="4823668">Elem</span><span class="op" id="4823672">(</span><span class="op" id="4823673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4823676">if</span>&nbsp;<span class="ident" id="4823679">elem</span><span class="op" id="4823683">.</span><span class="ident" id="4823684">Kind</span><span class="op" id="4823688">(</span><span class="op" id="4823689">)</span>&nbsp;<span class="op" id="4823691">==</span>&nbsp;<span class="ident" id="4823694">reflect</span><span class="op" id="4823701">.</span><span class="ident" id="4823702">Ptr</span>&nbsp;<span class="op" id="4823706">&amp;&amp;</span>&nbsp;<span class="ident" id="4823709">elem</span><span class="op" id="4823713">.</span><span class="ident" id="4823714">IsNil</span><span class="op" id="4823719">(</span><span class="op" id="4823720">)</span>&nbsp;<span class="op" id="4823722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823726">errorf</span><span class="op" id="4823732">(</span><span class="string" id="4823733">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="4823793">,</span>&nbsp;<span class="ident" id="4823795">iv</span><span class="op" id="4823797">.</span><span class="ident" id="4823798">Elem</span><span class="op" id="4823802">(</span><span class="op" id="4823803">)</span><span class="op" id="4823804">.</span><span class="ident" id="4823805">Type</span><span class="op" id="4823809">(</span><span class="op" id="4823810">)</span><span class="op" id="4823811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4823814">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823817">state</span>&nbsp;<span class="op" id="4823823">:=</span>&nbsp;<span class="ident" id="4823826">enc</span><span class="op" id="4823829">.</span><span class="ident" id="4823830">newEncoderState</span><span class="op" id="4823845">(</span><span class="ident" id="4823846">b</span><span class="op" id="4823847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823850">state</span><span class="op" id="4823855">.</span><span class="ident" id="4823856">fieldnum</span>&nbsp;<span class="op" id="4823865">=</span>&nbsp;<span class="op" id="4823867">-</span><span class="num" id="4823868">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823871">state</span><span class="op" id="4823876">.</span><span class="ident" id="4823877">sendZero</span>&nbsp;<span class="op" id="4823886">=</span>&nbsp;<span class="builtintype" id="4823888">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4823894">if</span>&nbsp;<span class="ident" id="4823897">iv</span><span class="op" id="4823899">.</span><span class="ident" id="4823900">IsNil</span><span class="op" id="4823905">(</span><span class="op" id="4823906">)</span>&nbsp;<span class="op" id="4823908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823912">state</span><span class="op" id="4823917">.</span><span class="ident" id="4823918">encodeUint</span><span class="op" id="4823928">(</span><span class="num" id="4823929">0</span><span class="op" id="4823930">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4823934">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4823942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823946">ut</span>&nbsp;<span class="op" id="4823949">:=</span>&nbsp;<span class="ident" id="4823952">userType</span><span class="op" id="4823960">(</span><span class="ident" id="4823961">iv</span><span class="op" id="4823963">.</span><span class="ident" id="4823964">Elem</span><span class="op" id="4823968">(</span><span class="op" id="4823969">)</span><span class="op" id="4823970">.</span><span class="ident" id="4823971">Type</span><span class="op" id="4823975">(</span><span class="op" id="4823976">)</span><span class="op" id="4823977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823980">registerLock</span><span class="op" id="4823992">.</span><span class="ident" id="4823993">RLock</span><span class="op" id="4823998">(</span><span class="op" id="4823999">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824002">name</span><span class="op" id="4824006">,</span>&nbsp;<span class="ident" id="4824008">ok</span>&nbsp;<span class="op" id="4824011">:=</span>&nbsp;<span class="ident" id="4824014">concreteTypeToName</span><span class="op" id="4824032">[</span><span class="ident" id="4824033">ut</span><span class="op" id="4824035">.</span><span class="ident" id="4824036">base</span><span class="op" id="4824040">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824043">registerLock</span><span class="op" id="4824055">.</span><span class="ident" id="4824056">RUnlock</span><span class="op" id="4824063">(</span><span class="op" id="4824064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824067">if</span>&nbsp;<span class="op" id="4824070">!</span><span class="ident" id="4824071">ok</span>&nbsp;<span class="op" id="4824074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824078">errorf</span><span class="op" id="4824084">(</span><span class="string" id="4824085">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="4824124">,</span>&nbsp;<span class="ident" id="4824126">ut</span><span class="op" id="4824128">.</span><span class="ident" id="4824129">base</span><span class="op" id="4824133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824136">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4824139">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824158">state</span><span class="op" id="4824163">.</span><span class="ident" id="4824164">encodeUint</span><span class="op" id="4824174">(</span><span class="ident" id="4824175">uint64</span><span class="op" id="4824181">(</span><span class="builtinfunc" id="4824182">len</span><span class="op" id="4824185">(</span><span class="ident" id="4824186">name</span><span class="op" id="4824190">)</span><span class="op" id="4824191">)</span><span class="op" id="4824192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824195">state</span><span class="op" id="4824200">.</span><span class="ident" id="4824201">b</span><span class="op" id="4824202">.</span><span class="ident" id="4824203">WriteString</span><span class="op" id="4824214">(</span><span class="ident" id="4824215">name</span><span class="op" id="4824219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4824222">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824259">enc</span><span class="op" id="4824262">.</span><span class="ident" id="4824263">sendTypeDescriptor</span><span class="op" id="4824281">(</span><span class="ident" id="4824282">enc</span><span class="op" id="4824285">.</span><span class="ident" id="4824286">writer</span><span class="op" id="4824292">(</span><span class="op" id="4824293">)</span><span class="op" id="4824294">,</span>&nbsp;<span class="ident" id="4824296">state</span><span class="op" id="4824301">,</span>&nbsp;<span class="ident" id="4824303">ut</span><span class="op" id="4824305">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4824308">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824330">enc</span><span class="op" id="4824333">.</span><span class="ident" id="4824334">sendTypeId</span><span class="op" id="4824344">(</span><span class="ident" id="4824345">state</span><span class="op" id="4824350">,</span>&nbsp;<span class="ident" id="4824352">ut</span><span class="op" id="4824354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4824357">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4824426">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824480">enc</span><span class="op" id="4824483">.</span><span class="ident" id="4824484">pushWriter</span><span class="op" id="4824494">(</span><span class="ident" id="4824495">b</span><span class="op" id="4824496">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824499">data</span>&nbsp;<span class="op" id="4824504">:=</span>&nbsp;<span class="builtinfunc" id="4824507">new</span><span class="op" id="4824510">(</span><span class="ident" id="4824511">encBuffer</span><span class="op" id="4824520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824523">data</span><span class="op" id="4824527">.</span><span class="ident" id="4824528">Write</span><span class="op" id="4824533">(</span><span class="ident" id="4824534">spaceForLength</span><span class="op" id="4824548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824551">enc</span><span class="op" id="4824554">.</span><span class="ident" id="4824555">encode</span><span class="op" id="4824561">(</span><span class="ident" id="4824562">data</span><span class="op" id="4824566">,</span>&nbsp;<span class="ident" id="4824568">elem</span><span class="op" id="4824572">,</span>&nbsp;<span class="ident" id="4824574">ut</span><span class="op" id="4824576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824579">if</span>&nbsp;<span class="ident" id="4824582">enc</span><span class="op" id="4824585">.</span><span class="ident" id="4824586">err</span>&nbsp;<span class="op" id="4824590">!=</span>&nbsp;<span class="ident" id="4824593">nil</span>&nbsp;<span class="op" id="4824597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824601">error_</span><span class="op" id="4824607">(</span><span class="ident" id="4824608">enc</span><span class="op" id="4824611">.</span><span class="ident" id="4824612">err</span><span class="op" id="4824615">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824621">enc</span><span class="op" id="4824624">.</span><span class="ident" id="4824625">popWriter</span><span class="op" id="4824634">(</span><span class="op" id="4824635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824638">enc</span><span class="op" id="4824641">.</span><span class="ident" id="4824642">writeMessage</span><span class="op" id="4824654">(</span><span class="ident" id="4824655">b</span><span class="op" id="4824656">,</span>&nbsp;<span class="ident" id="4824658">data</span><span class="op" id="4824662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824665">if</span>&nbsp;<span class="ident" id="4824668">enc</span><span class="op" id="4824671">.</span><span class="ident" id="4824672">err</span>&nbsp;<span class="op" id="4824676">!=</span>&nbsp;<span class="ident" id="4824679">nil</span>&nbsp;<span class="op" id="4824683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824687">error_</span><span class="op" id="4824693">(</span><span class="ident" id="4824694">enc</span><span class="op" id="4824697">.</span><span class="ident" id="4824698">err</span><span class="op" id="4824701">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824707">enc</span><span class="op" id="4824710">.</span><span class="ident" id="4824711">freeEncoderState</span><span class="op" id="4824727">(</span><span class="ident" id="4824728">state</span><span class="op" id="4824733">)</span><br>
<span class="lineno"></span><span class="op" id="4824735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4824738">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="4824799">func</span>&nbsp;<span class="ident" id="4824804">isZero</span><span class="op" id="4824810">(</span><span class="ident" id="4824811">val</span>&nbsp;<span class="ident" id="4824815">reflect</span><span class="op" id="4824822">.</span><span class="ident" id="4824823">Value</span><span class="op" id="4824828">)</span>&nbsp;<span class="builtintype" id="4824830">bool</span>&nbsp;<span class="op" id="4824835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824838">switch</span>&nbsp;<span class="ident" id="4824845">val</span><span class="op" id="4824848">.</span><span class="ident" id="4824849">Kind</span><span class="op" id="4824853">(</span><span class="op" id="4824854">)</span>&nbsp;<span class="op" id="4824856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824859">case</span>&nbsp;<span class="ident" id="4824864">reflect</span><span class="op" id="4824871">.</span><span class="ident" id="4824872">Array</span><span class="op" id="4824877">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824881">for</span>&nbsp;<span class="ident" id="4824885">i</span>&nbsp;<span class="op" id="4824887">:=</span>&nbsp;<span class="num" id="4824890">0</span><span class="op" id="4824891">;</span>&nbsp;<span class="ident" id="4824893">i</span>&nbsp;<span class="op" id="4824895">&lt;</span>&nbsp;<span class="ident" id="4824897">val</span><span class="op" id="4824900">.</span><span class="ident" id="4824901">Len</span><span class="op" id="4824904">(</span><span class="op" id="4824905">)</span><span class="op" id="4824906">;</span>&nbsp;<span class="ident" id="4824908">i</span><span class="op" id="4824909">++</span>&nbsp;<span class="op" id="4824912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824917">if</span>&nbsp;<span class="op" id="4824920">!</span><span class="ident" id="4824921">isZero</span><span class="op" id="4824927">(</span><span class="ident" id="4824928">val</span><span class="op" id="4824931">.</span><span class="ident" id="4824932">Index</span><span class="op" id="4824937">(</span><span class="ident" id="4824938">i</span><span class="op" id="4824939">)</span><span class="op" id="4824940">)</span>&nbsp;<span class="op" id="4824942">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824948">return</span>&nbsp;<span class="builtintype" id="4824955">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824972">return</span>&nbsp;<span class="builtintype" id="4824979">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824985">case</span>&nbsp;<span class="ident" id="4824990">reflect</span><span class="op" id="4824997">.</span><span class="ident" id="4824998">Map</span><span class="op" id="4825001">,</span>&nbsp;<span class="ident" id="4825003">reflect</span><span class="op" id="4825010">.</span><span class="ident" id="4825011">Slice</span><span class="op" id="4825016">,</span>&nbsp;<span class="ident" id="4825018">reflect</span><span class="op" id="4825025">.</span><span class="ident" id="4825026">String</span><span class="op" id="4825032">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825036">return</span>&nbsp;<span class="ident" id="4825043">val</span><span class="op" id="4825046">.</span><span class="ident" id="4825047">Len</span><span class="op" id="4825050">(</span><span class="op" id="4825051">)</span>&nbsp;<span class="op" id="4825053">==</span>&nbsp;<span class="num" id="4825056">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825059">case</span>&nbsp;<span class="ident" id="4825064">reflect</span><span class="op" id="4825071">.</span><span class="ident" id="4825072">Bool</span><span class="op" id="4825076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825080">return</span>&nbsp;<span class="op" id="4825087">!</span><span class="ident" id="4825088">val</span><span class="op" id="4825091">.</span><span class="ident" id="4825092">Bool</span><span class="op" id="4825096">(</span><span class="op" id="4825097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825100">case</span>&nbsp;<span class="ident" id="4825105">reflect</span><span class="op" id="4825112">.</span><span class="ident" id="4825113">Complex64</span><span class="op" id="4825122">,</span>&nbsp;<span class="ident" id="4825124">reflect</span><span class="op" id="4825131">.</span><span class="ident" id="4825132">Complex128</span><span class="op" id="4825142">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825146">return</span>&nbsp;<span class="ident" id="4825153">val</span><span class="op" id="4825156">.</span><span class="ident" id="4825157">Complex</span><span class="op" id="4825164">(</span><span class="op" id="4825165">)</span>&nbsp;<span class="op" id="4825167">==</span>&nbsp;<span class="num" id="4825170">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825173">case</span>&nbsp;<span class="ident" id="4825178">reflect</span><span class="op" id="4825185">.</span><span class="ident" id="4825186">Chan</span><span class="op" id="4825190">,</span>&nbsp;<span class="ident" id="4825192">reflect</span><span class="op" id="4825199">.</span><span class="ident" id="4825200">Func</span><span class="op" id="4825204">,</span>&nbsp;<span class="ident" id="4825206">reflect</span><span class="op" id="4825213">.</span><span class="ident" id="4825214">Interface</span><span class="op" id="4825223">,</span>&nbsp;<span class="ident" id="4825225">reflect</span><span class="op" id="4825232">.</span><span class="ident" id="4825233">Ptr</span><span class="op" id="4825236">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825240">return</span>&nbsp;<span class="ident" id="4825247">val</span><span class="op" id="4825250">.</span><span class="ident" id="4825251">IsNil</span><span class="op" id="4825256">(</span><span class="op" id="4825257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825260">case</span>&nbsp;<span class="ident" id="4825265">reflect</span><span class="op" id="4825272">.</span><span class="ident" id="4825273">Int</span><span class="op" id="4825276">,</span>&nbsp;<span class="ident" id="4825278">reflect</span><span class="op" id="4825285">.</span><span class="ident" id="4825286">Int8</span><span class="op" id="4825290">,</span>&nbsp;<span class="ident" id="4825292">reflect</span><span class="op" id="4825299">.</span><span class="ident" id="4825300">Int16</span><span class="op" id="4825305">,</span>&nbsp;<span class="ident" id="4825307">reflect</span><span class="op" id="4825314">.</span><span class="ident" id="4825315">Int32</span><span class="op" id="4825320">,</span>&nbsp;<span class="ident" id="4825322">reflect</span><span class="op" id="4825329">.</span><span class="ident" id="4825330">Int64</span><span class="op" id="4825335">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825339">return</span>&nbsp;<span class="ident" id="4825346">val</span><span class="op" id="4825349">.</span><span class="ident" id="4825350">Int</span><span class="op" id="4825353">(</span><span class="op" id="4825354">)</span>&nbsp;<span class="op" id="4825356">==</span>&nbsp;<span class="num" id="4825359">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825362">case</span>&nbsp;<span class="ident" id="4825367">reflect</span><span class="op" id="4825374">.</span><span class="ident" id="4825375">Float32</span><span class="op" id="4825382">,</span>&nbsp;<span class="ident" id="4825384">reflect</span><span class="op" id="4825391">.</span><span class="ident" id="4825392">Float64</span><span class="op" id="4825399">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825403">return</span>&nbsp;<span class="ident" id="4825410">val</span><span class="op" id="4825413">.</span><span class="ident" id="4825414">Float</span><span class="op" id="4825419">(</span><span class="op" id="4825420">)</span>&nbsp;<span class="op" id="4825422">==</span>&nbsp;<span class="num" id="4825425">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825428">case</span>&nbsp;<span class="ident" id="4825433">reflect</span><span class="op" id="4825440">.</span><span class="ident" id="4825441">Uint</span><span class="op" id="4825445">,</span>&nbsp;<span class="ident" id="4825447">reflect</span><span class="op" id="4825454">.</span><span class="ident" id="4825455">Uint8</span><span class="op" id="4825460">,</span>&nbsp;<span class="ident" id="4825462">reflect</span><span class="op" id="4825469">.</span><span class="ident" id="4825470">Uint16</span><span class="op" id="4825476">,</span>&nbsp;<span class="ident" id="4825478">reflect</span><span class="op" id="4825485">.</span><span class="ident" id="4825486">Uint32</span><span class="op" id="4825492">,</span>&nbsp;<span class="ident" id="4825494">reflect</span><span class="op" id="4825501">.</span><span class="ident" id="4825502">Uint64</span><span class="op" id="4825508">,</span>&nbsp;<span class="ident" id="4825510">reflect</span><span class="op" id="4825517">.</span><span class="ident" id="4825518">Uintptr</span><span class="op" id="4825525">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825529">return</span>&nbsp;<span class="ident" id="4825536">val</span><span class="op" id="4825539">.</span><span class="ident" id="4825540">Uint</span><span class="op" id="4825544">(</span><span class="op" id="4825545">)</span>&nbsp;<span class="op" id="4825547">==</span>&nbsp;<span class="num" id="4825550">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825553">case</span>&nbsp;<span class="ident" id="4825558">reflect</span><span class="op" id="4825565">.</span><span class="ident" id="4825566">Struct</span><span class="op" id="4825572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825576">for</span>&nbsp;<span class="ident" id="4825580">i</span>&nbsp;<span class="op" id="4825582">:=</span>&nbsp;<span class="num" id="4825585">0</span><span class="op" id="4825586">;</span>&nbsp;<span class="ident" id="4825588">i</span>&nbsp;<span class="op" id="4825590">&lt;</span>&nbsp;<span class="ident" id="4825592">val</span><span class="op" id="4825595">.</span><span class="ident" id="4825596">NumField</span><span class="op" id="4825604">(</span><span class="op" id="4825605">)</span><span class="op" id="4825606">;</span>&nbsp;<span class="ident" id="4825608">i</span><span class="op" id="4825609">++</span>&nbsp;<span class="op" id="4825612">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825617">if</span>&nbsp;<span class="op" id="4825620">!</span><span class="ident" id="4825621">isZero</span><span class="op" id="4825627">(</span><span class="ident" id="4825628">val</span><span class="op" id="4825631">.</span><span class="ident" id="4825632">Field</span><span class="op" id="4825637">(</span><span class="ident" id="4825638">i</span><span class="op" id="4825639">)</span><span class="op" id="4825640">)</span>&nbsp;<span class="op" id="4825642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825648">return</span>&nbsp;<span class="builtintype" id="4825655">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825672">return</span>&nbsp;<span class="builtintype" id="4825679">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4825688">panic</span><span class="op" id="4825693">(</span><span class="string" id="4825694">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="4825720">+</span>&nbsp;<span class="ident" id="4825722">val</span><span class="op" id="4825725">.</span><span class="ident" id="4825726">Type</span><span class="op" id="4825730">(</span><span class="op" id="4825731">)</span><span class="op" id="4825732">.</span><span class="ident" id="4825733">String</span><span class="op" id="4825739">(</span><span class="op" id="4825740">)</span><span class="op" id="4825741">)</span><br>
<span class="lineno"></span><span class="op" id="4825743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4825746">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="4825821">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="4825858">func</span>&nbsp;<span class="op" id="4825863">(</span><span class="ident" id="4825864">enc</span>&nbsp;<span class="op" id="4825868">*</span><span class="ident" id="4825869">Encoder</span><span class="op" id="4825876">)</span>&nbsp;<span class="ident" id="4825878">encodeGobEncoder</span><span class="op" id="4825894">(</span><span class="ident" id="4825895">b</span>&nbsp;<span class="op" id="4825897">*</span><span class="ident" id="4825898">encBuffer</span><span class="op" id="4825907">,</span>&nbsp;<span class="ident" id="4825909">ut</span>&nbsp;<span class="op" id="4825912">*</span><span class="ident" id="4825913">userTypeInfo</span><span class="op" id="4825925">,</span>&nbsp;<span class="ident" id="4825927">v</span>&nbsp;<span class="ident" id="4825929">reflect</span><span class="op" id="4825936">.</span><span class="ident" id="4825937">Value</span><span class="op" id="4825942">)</span>&nbsp;<span class="op" id="4825944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4825947">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826005">var</span>&nbsp;<span class="ident" id="4826009">data</span>&nbsp;<span class="op" id="4826014">[</span><span class="op" id="4826015">]</span><span class="builtintype" id="4826016">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826022">var</span>&nbsp;<span class="ident" id="4826026">err</span>&nbsp;<span class="builtintype" id="4826030">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826037">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826068">switch</span>&nbsp;<span class="ident" id="4826075">ut</span><span class="op" id="4826077">.</span><span class="ident" id="4826078">externalEnc</span>&nbsp;<span class="op" id="4826090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826093">case</span>&nbsp;<span class="ident" id="4826098">xGob</span><span class="op" id="4826102">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826106">data</span><span class="op" id="4826110">,</span>&nbsp;<span class="ident" id="4826112">err</span>&nbsp;<span class="op" id="4826116">=</span>&nbsp;<span class="ident" id="4826118">v</span><span class="op" id="4826119">.</span><span class="ident" id="4826120">Interface</span><span class="op" id="4826129">(</span><span class="op" id="4826130">)</span><span class="op" id="4826131">.</span><span class="op" id="4826132">(</span><span class="ident" id="4826133">GobEncoder</span><span class="op" id="4826143">)</span><span class="op" id="4826144">.</span><span class="ident" id="4826145">GobEncode</span><span class="op" id="4826154">(</span><span class="op" id="4826155">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826158">case</span>&nbsp;<span class="ident" id="4826163">xBinary</span><span class="op" id="4826170">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826174">data</span><span class="op" id="4826178">,</span>&nbsp;<span class="ident" id="4826180">err</span>&nbsp;<span class="op" id="4826184">=</span>&nbsp;<span class="ident" id="4826186">v</span><span class="op" id="4826187">.</span><span class="ident" id="4826188">Interface</span><span class="op" id="4826197">(</span><span class="op" id="4826198">)</span><span class="op" id="4826199">.</span><span class="op" id="4826200">(</span><span class="ident" id="4826201">encoding</span><span class="op" id="4826209">.</span><span class="ident" id="4826210">BinaryMarshaler</span><span class="op" id="4826225">)</span><span class="op" id="4826226">.</span><span class="ident" id="4826227">MarshalBinary</span><span class="op" id="4826240">(</span><span class="op" id="4826241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826244">case</span>&nbsp;<span class="ident" id="4826249">xText</span><span class="op" id="4826254">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826258">data</span><span class="op" id="4826262">,</span>&nbsp;<span class="ident" id="4826264">err</span>&nbsp;<span class="op" id="4826268">=</span>&nbsp;<span class="ident" id="4826270">v</span><span class="op" id="4826271">.</span><span class="ident" id="4826272">Interface</span><span class="op" id="4826281">(</span><span class="op" id="4826282">)</span><span class="op" id="4826283">.</span><span class="op" id="4826284">(</span><span class="ident" id="4826285">encoding</span><span class="op" id="4826293">.</span><span class="ident" id="4826294">TextMarshaler</span><span class="op" id="4826307">)</span><span class="op" id="4826308">.</span><span class="ident" id="4826309">MarshalText</span><span class="op" id="4826320">(</span><span class="op" id="4826321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826324">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826327">if</span>&nbsp;<span class="ident" id="4826330">err</span>&nbsp;<span class="op" id="4826334">!=</span>&nbsp;<span class="ident" id="4826337">nil</span>&nbsp;<span class="op" id="4826341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826345">error_</span><span class="op" id="4826351">(</span><span class="ident" id="4826352">err</span><span class="op" id="4826355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826361">state</span>&nbsp;<span class="op" id="4826367">:=</span>&nbsp;<span class="ident" id="4826370">enc</span><span class="op" id="4826373">.</span><span class="ident" id="4826374">newEncoderState</span><span class="op" id="4826389">(</span><span class="ident" id="4826390">b</span><span class="op" id="4826391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826394">state</span><span class="op" id="4826399">.</span><span class="ident" id="4826400">fieldnum</span>&nbsp;<span class="op" id="4826409">=</span>&nbsp;<span class="op" id="4826411">-</span><span class="num" id="4826412">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826415">state</span><span class="op" id="4826420">.</span><span class="ident" id="4826421">encodeUint</span><span class="op" id="4826431">(</span><span class="ident" id="4826432">uint64</span><span class="op" id="4826438">(</span><span class="builtinfunc" id="4826439">len</span><span class="op" id="4826442">(</span><span class="ident" id="4826443">data</span><span class="op" id="4826447">)</span><span class="op" id="4826448">)</span><span class="op" id="4826449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826452">state</span><span class="op" id="4826457">.</span><span class="ident" id="4826458">b</span><span class="op" id="4826459">.</span><span class="ident" id="4826460">Write</span><span class="op" id="4826465">(</span><span class="ident" id="4826466">data</span><span class="op" id="4826470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826473">enc</span><span class="op" id="4826476">.</span><span class="ident" id="4826477">freeEncoderState</span><span class="op" id="4826493">(</span><span class="ident" id="4826494">state</span><span class="op" id="4826499">)</span><br>
<span class="lineno"></span><span class="op" id="4826501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="4826504">var</span>&nbsp;<span class="ident" id="4826508">encOpTable</span>&nbsp;<span class="op" id="4826519">=</span>&nbsp;<span class="op" id="4826521">[</span><span class="op" id="4826522">...</span><span class="op" id="4826525">]</span><span class="ident" id="4826526">encOp</span><span class="op" id="4826531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826534">reflect</span><span class="op" id="4826541">.</span><span class="ident" id="4826542">Bool</span><span class="op" id="4826546">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826554">encBool</span><span class="op" id="4826561">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826564">reflect</span><span class="op" id="4826571">.</span><span class="ident" id="4826572">Int</span><span class="op" id="4826575">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826584">encInt</span><span class="op" id="4826590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826593">reflect</span><span class="op" id="4826600">.</span><span class="ident" id="4826601">Int8</span><span class="op" id="4826605">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826613">encInt</span><span class="op" id="4826619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826622">reflect</span><span class="op" id="4826629">.</span><span class="ident" id="4826630">Int16</span><span class="op" id="4826635">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826642">encInt</span><span class="op" id="4826648">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826651">reflect</span><span class="op" id="4826658">.</span><span class="ident" id="4826659">Int32</span><span class="op" id="4826664">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826671">encInt</span><span class="op" id="4826677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826680">reflect</span><span class="op" id="4826687">.</span><span class="ident" id="4826688">Int64</span><span class="op" id="4826693">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826700">encInt</span><span class="op" id="4826706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826709">reflect</span><span class="op" id="4826716">.</span><span class="ident" id="4826717">Uint</span><span class="op" id="4826721">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826729">encUint</span><span class="op" id="4826736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826739">reflect</span><span class="op" id="4826746">.</span><span class="ident" id="4826747">Uint8</span><span class="op" id="4826752">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826759">encUint</span><span class="op" id="4826766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826769">reflect</span><span class="op" id="4826776">.</span><span class="ident" id="4826777">Uint16</span><span class="op" id="4826783">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826789">encUint</span><span class="op" id="4826796">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826799">reflect</span><span class="op" id="4826806">.</span><span class="ident" id="4826807">Uint32</span><span class="op" id="4826813">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826819">encUint</span><span class="op" id="4826826">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826829">reflect</span><span class="op" id="4826836">.</span><span class="ident" id="4826837">Uint64</span><span class="op" id="4826843">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826849">encUint</span><span class="op" id="4826856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826859">reflect</span><span class="op" id="4826866">.</span><span class="ident" id="4826867">Uintptr</span><span class="op" id="4826874">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826879">encUint</span><span class="op" id="4826886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826889">reflect</span><span class="op" id="4826896">.</span><span class="ident" id="4826897">Float32</span><span class="op" id="4826904">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826909">encFloat</span><span class="op" id="4826917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826920">reflect</span><span class="op" id="4826927">.</span><span class="ident" id="4826928">Float64</span><span class="op" id="4826935">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4826940">encFloat</span><span class="op" id="4826948">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826951">reflect</span><span class="op" id="4826958">.</span><span class="ident" id="4826959">Complex64</span><span class="op" id="4826968">:</span>&nbsp;&nbsp;<span class="ident" id="4826971">encComplex</span><span class="op" id="4826981">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826984">reflect</span><span class="op" id="4826991">.</span><span class="ident" id="4826992">Complex128</span><span class="op" id="4827002">:</span>&nbsp;<span class="ident" id="4827004">encComplex</span><span class="op" id="4827014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827017">reflect</span><span class="op" id="4827024">.</span><span class="ident" id="4827025">String</span><span class="op" id="4827031">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4827037">encString</span><span class="op" id="4827046">,</span><br>
<span class="lineno"></span><span class="op" id="4827048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="4827051">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4827133">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4827171">func</span>&nbsp;<span class="ident" id="4827176">encOpFor</span><span class="op" id="4827184">(</span><span class="ident" id="4827185">rt</span>&nbsp;<span class="ident" id="4827188">reflect</span><span class="op" id="4827195">.</span><span class="ident" id="4827196">Type</span><span class="op" id="4827200">,</span>&nbsp;<span class="ident" id="4827202">inProgress</span>&nbsp;<span class="keyword" id="4827213">map</span><span class="op" id="4827216">[</span><span class="ident" id="4827217">reflect</span><span class="op" id="4827224">.</span><span class="ident" id="4827225">Type</span><span class="op" id="4827229">]</span><span class="op" id="4827230">*</span><span class="ident" id="4827231">encOp</span><span class="op" id="4827236">,</span>&nbsp;<span class="ident" id="4827238">building</span>&nbsp;<span class="keyword" id="4827247">map</span><span class="op" id="4827250">[</span><span class="op" id="4827251">*</span><span class="ident" id="4827252">typeInfo</span><span class="op" id="4827260">]</span><span class="builtintype" id="4827261">bool</span><span class="op" id="4827265">)</span>&nbsp;<span class="op" id="4827267">(</span><span class="op" id="4827268">*</span><span class="ident" id="4827269">encOp</span><span class="op" id="4827274">,</span>&nbsp;<span class="builtintype" id="4827276">int</span><span class="op" id="4827279">)</span>&nbsp;<span class="op" id="4827281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827284">ut</span>&nbsp;<span class="op" id="4827287">:=</span>&nbsp;<span class="ident" id="4827290">userType</span><span class="op" id="4827298">(</span><span class="ident" id="4827299">rt</span><span class="op" id="4827301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827304">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827384">if</span>&nbsp;<span class="ident" id="4827387">ut</span><span class="op" id="4827389">.</span><span class="ident" id="4827390">externalEnc</span>&nbsp;<span class="op" id="4827402">!=</span>&nbsp;<span class="num" id="4827405">0</span>&nbsp;<span class="op" id="4827407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827411">return</span>&nbsp;<span class="ident" id="4827418">gobEncodeOpFor</span><span class="op" id="4827432">(</span><span class="ident" id="4827433">ut</span><span class="op" id="4827435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827441">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827526">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827583">if</span>&nbsp;<span class="ident" id="4827586">opPtr</span>&nbsp;<span class="op" id="4827592">:=</span>&nbsp;<span class="ident" id="4827595">inProgress</span><span class="op" id="4827605">[</span><span class="ident" id="4827606">rt</span><span class="op" id="4827608">]</span><span class="op" id="4827609">;</span>&nbsp;<span class="ident" id="4827611">opPtr</span>&nbsp;<span class="op" id="4827617">!=</span>&nbsp;<span class="ident" id="4827620">nil</span>&nbsp;<span class="op" id="4827624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827628">return</span>&nbsp;<span class="ident" id="4827635">opPtr</span><span class="op" id="4827640">,</span>&nbsp;<span class="ident" id="4827642">ut</span><span class="op" id="4827644">.</span><span class="ident" id="4827645">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827655">typ</span>&nbsp;<span class="op" id="4827659">:=</span>&nbsp;<span class="ident" id="4827662">ut</span><span class="op" id="4827664">.</span><span class="ident" id="4827665">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827671">indir</span>&nbsp;<span class="op" id="4827677">:=</span>&nbsp;<span class="ident" id="4827680">ut</span><span class="op" id="4827682">.</span><span class="ident" id="4827683">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827690">k</span>&nbsp;<span class="op" id="4827692">:=</span>&nbsp;<span class="ident" id="4827695">typ</span><span class="op" id="4827698">.</span><span class="ident" id="4827699">Kind</span><span class="op" id="4827703">(</span><span class="op" id="4827704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827707">var</span>&nbsp;<span class="ident" id="4827711">op</span>&nbsp;<span class="ident" id="4827714">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827721">if</span>&nbsp;<span class="builtintype" id="4827724">int</span><span class="op" id="4827727">(</span><span class="ident" id="4827728">k</span><span class="op" id="4827729">)</span>&nbsp;<span class="op" id="4827731">&lt;</span>&nbsp;<span class="builtinfunc" id="4827733">len</span><span class="op" id="4827736">(</span><span class="ident" id="4827737">encOpTable</span><span class="op" id="4827747">)</span>&nbsp;<span class="op" id="4827749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827753">op</span>&nbsp;<span class="op" id="4827756">=</span>&nbsp;<span class="ident" id="4827758">encOpTable</span><span class="op" id="4827768">[</span><span class="ident" id="4827769">k</span><span class="op" id="4827770">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827773">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827776">if</span>&nbsp;<span class="ident" id="4827779">op</span>&nbsp;<span class="op" id="4827782">==</span>&nbsp;<span class="ident" id="4827785">nil</span>&nbsp;<span class="op" id="4827789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827793">inProgress</span><span class="op" id="4827803">[</span><span class="ident" id="4827804">rt</span><span class="op" id="4827806">]</span>&nbsp;<span class="op" id="4827808">=</span>&nbsp;<span class="op" id="4827810">&amp;</span><span class="ident" id="4827811">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827816">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827835">switch</span>&nbsp;<span class="ident" id="4827842">t</span>&nbsp;<span class="op" id="4827844">:=</span>&nbsp;<span class="ident" id="4827847">typ</span><span class="op" id="4827850">;</span>&nbsp;<span class="ident" id="4827852">t</span><span class="op" id="4827853">.</span><span class="ident" id="4827854">Kind</span><span class="op" id="4827858">(</span><span class="op" id="4827859">)</span>&nbsp;<span class="op" id="4827861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827865">case</span>&nbsp;<span class="ident" id="4827870">reflect</span><span class="op" id="4827877">.</span><span class="ident" id="4827878">Slice</span><span class="op" id="4827883">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827888">if</span>&nbsp;<span class="ident" id="4827891">t</span><span class="op" id="4827892">.</span><span class="ident" id="4827893">Elem</span><span class="op" id="4827897">(</span><span class="op" id="4827898">)</span><span class="op" id="4827899">.</span><span class="ident" id="4827900">Kind</span><span class="op" id="4827904">(</span><span class="op" id="4827905">)</span>&nbsp;<span class="op" id="4827907">==</span>&nbsp;<span class="ident" id="4827910">reflect</span><span class="op" id="4827917">.</span><span class="ident" id="4827918">Uint8</span>&nbsp;<span class="op" id="4827924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827930">op</span>&nbsp;<span class="op" id="4827933">=</span>&nbsp;<span class="ident" id="4827935">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827953">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827967">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828038">elemOp</span><span class="op" id="4828044">,</span>&nbsp;<span class="ident" id="4828046">elemIndir</span>&nbsp;<span class="op" id="4828056">:=</span>&nbsp;<span class="ident" id="4828059">encOpFor</span><span class="op" id="4828067">(</span><span class="ident" id="4828068">t</span><span class="op" id="4828069">.</span><span class="ident" id="4828070">Elem</span><span class="op" id="4828074">(</span><span class="op" id="4828075">)</span><span class="op" id="4828076">,</span>&nbsp;<span class="ident" id="4828078">inProgress</span><span class="op" id="4828088">,</span>&nbsp;<span class="ident" id="4828090">building</span><span class="op" id="4828098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828103">helper</span>&nbsp;<span class="op" id="4828110">:=</span>&nbsp;<span class="ident" id="4828113">encSliceHelper</span><span class="op" id="4828127">[</span><span class="ident" id="4828128">t</span><span class="op" id="4828129">.</span><span class="ident" id="4828130">Elem</span><span class="op" id="4828134">(</span><span class="op" id="4828135">)</span><span class="op" id="4828136">.</span><span class="ident" id="4828137">Kind</span><span class="op" id="4828141">(</span><span class="op" id="4828142">)</span><span class="op" id="4828143">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828148">op</span>&nbsp;<span class="op" id="4828151">=</span>&nbsp;<span class="keyword" id="4828153">func</span><span class="op" id="4828157">(</span><span class="ident" id="4828158">i</span>&nbsp;<span class="op" id="4828160">*</span><span class="ident" id="4828161">encInstr</span><span class="op" id="4828169">,</span>&nbsp;<span class="ident" id="4828171">state</span>&nbsp;<span class="op" id="4828177">*</span><span class="ident" id="4828178">encoderState</span><span class="op" id="4828190">,</span>&nbsp;<span class="ident" id="4828192">slice</span>&nbsp;<span class="ident" id="4828198">reflect</span><span class="op" id="4828205">.</span><span class="ident" id="4828206">Value</span><span class="op" id="4828211">)</span>&nbsp;<span class="op" id="4828213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828219">if</span>&nbsp;<span class="op" id="4828222">!</span><span class="ident" id="4828223">state</span><span class="op" id="4828228">.</span><span class="ident" id="4828229">sendZero</span>&nbsp;<span class="op" id="4828238">&amp;&amp;</span>&nbsp;<span class="ident" id="4828241">slice</span><span class="op" id="4828246">.</span><span class="ident" id="4828247">Len</span><span class="op" id="4828250">(</span><span class="op" id="4828251">)</span>&nbsp;<span class="op" id="4828253">==</span>&nbsp;<span class="num" id="4828256">0</span>&nbsp;<span class="op" id="4828258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828265">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4828276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828282">state</span><span class="op" id="4828287">.</span><span class="ident" id="4828288">update</span><span class="op" id="4828294">(</span><span class="ident" id="4828295">i</span><span class="op" id="4828296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828302">state</span><span class="op" id="4828307">.</span><span class="ident" id="4828308">enc</span><span class="op" id="4828311">.</span><span class="ident" id="4828312">encodeArray</span><span class="op" id="4828323">(</span><span class="ident" id="4828324">state</span><span class="op" id="4828329">.</span><span class="ident" id="4828330">b</span><span class="op" id="4828331">,</span>&nbsp;<span class="ident" id="4828333">slice</span><span class="op" id="4828338">,</span>&nbsp;<span class="op" id="4828340">*</span><span class="ident" id="4828341">elemOp</span><span class="op" id="4828347">,</span>&nbsp;<span class="ident" id="4828349">elemIndir</span><span class="op" id="4828358">,</span>&nbsp;<span class="ident" id="4828360">slice</span><span class="op" id="4828365">.</span><span class="ident" id="4828366">Len</span><span class="op" id="4828369">(</span><span class="op" id="4828370">)</span><span class="op" id="4828371">,</span>&nbsp;<span class="ident" id="4828373">helper</span><span class="op" id="4828379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4828384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828388">case</span>&nbsp;<span class="ident" id="4828393">reflect</span><span class="op" id="4828400">.</span><span class="ident" id="4828401">Array</span><span class="op" id="4828406">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828411">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828452">elemOp</span><span class="op" id="4828458">,</span>&nbsp;<span class="ident" id="4828460">elemIndir</span>&nbsp;<span class="op" id="4828470">:=</span>&nbsp;<span class="ident" id="4828473">encOpFor</span><span class="op" id="4828481">(</span><span class="ident" id="4828482">t</span><span class="op" id="4828483">.</span><span class="ident" id="4828484">Elem</span><span class="op" id="4828488">(</span><span class="op" id="4828489">)</span><span class="op" id="4828490">,</span>&nbsp;<span class="ident" id="4828492">inProgress</span><span class="op" id="4828502">,</span>&nbsp;<span class="ident" id="4828504">building</span><span class="op" id="4828512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828517">helper</span>&nbsp;<span class="op" id="4828524">:=</span>&nbsp;<span class="ident" id="4828527">encArrayHelper</span><span class="op" id="4828541">[</span><span class="ident" id="4828542">t</span><span class="op" id="4828543">.</span><span class="ident" id="4828544">Elem</span><span class="op" id="4828548">(</span><span class="op" id="4828549">)</span><span class="op" id="4828550">.</span><span class="ident" id="4828551">Kind</span><span class="op" id="4828555">(</span><span class="op" id="4828556">)</span><span class="op" id="4828557">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828562">op</span>&nbsp;<span class="op" id="4828565">=</span>&nbsp;<span class="keyword" id="4828567">func</span><span class="op" id="4828571">(</span><span class="ident" id="4828572">i</span>&nbsp;<span class="op" id="4828574">*</span><span class="ident" id="4828575">encInstr</span><span class="op" id="4828583">,</span>&nbsp;<span class="ident" id="4828585">state</span>&nbsp;<span class="op" id="4828591">*</span><span class="ident" id="4828592">encoderState</span><span class="op" id="4828604">,</span>&nbsp;<span class="ident" id="4828606">array</span>&nbsp;<span class="ident" id="4828612">reflect</span><span class="op" id="4828619">.</span><span class="ident" id="4828620">Value</span><span class="op" id="4828625">)</span>&nbsp;<span class="op" id="4828627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828633">state</span><span class="op" id="4828638">.</span><span class="ident" id="4828639">update</span><span class="op" id="4828645">(</span><span class="ident" id="4828646">i</span><span class="op" id="4828647">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828653">state</span><span class="op" id="4828658">.</span><span class="ident" id="4828659">enc</span><span class="op" id="4828662">.</span><span class="ident" id="4828663">encodeArray</span><span class="op" id="4828674">(</span><span class="ident" id="4828675">state</span><span class="op" id="4828680">.</span><span class="ident" id="4828681">b</span><span class="op" id="4828682">,</span>&nbsp;<span class="ident" id="4828684">array</span><span class="op" id="4828689">,</span>&nbsp;<span class="op" id="4828691">*</span><span class="ident" id="4828692">elemOp</span><span class="op" id="4828698">,</span>&nbsp;<span class="ident" id="4828700">elemIndir</span><span class="op" id="4828709">,</span>&nbsp;<span class="ident" id="4828711">array</span><span class="op" id="4828716">.</span><span class="ident" id="4828717">Len</span><span class="op" id="4828720">(</span><span class="op" id="4828721">)</span><span class="op" id="4828722">,</span>&nbsp;<span class="ident" id="4828724">helper</span><span class="op" id="4828730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4828735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828739">case</span>&nbsp;<span class="ident" id="4828744">reflect</span><span class="op" id="4828751">.</span><span class="ident" id="4828752">Map</span><span class="op" id="4828755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828760">keyOp</span><span class="op" id="4828765">,</span>&nbsp;<span class="ident" id="4828767">keyIndir</span>&nbsp;<span class="op" id="4828776">:=</span>&nbsp;<span class="ident" id="4828779">encOpFor</span><span class="op" id="4828787">(</span><span class="ident" id="4828788">t</span><span class="op" id="4828789">.</span><span class="ident" id="4828790">Key</span><span class="op" id="4828793">(</span><span class="op" id="4828794">)</span><span class="op" id="4828795">,</span>&nbsp;<span class="ident" id="4828797">inProgress</span><span class="op" id="4828807">,</span>&nbsp;<span class="ident" id="4828809">building</span><span class="op" id="4828817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828822">elemOp</span><span class="op" id="4828828">,</span>&nbsp;<span class="ident" id="4828830">elemIndir</span>&nbsp;<span class="op" id="4828840">:=</span>&nbsp;<span class="ident" id="4828843">encOpFor</span><span class="op" id="4828851">(</span><span class="ident" id="4828852">t</span><span class="op" id="4828853">.</span><span class="ident" id="4828854">Elem</span><span class="op" id="4828858">(</span><span class="op" id="4828859">)</span><span class="op" id="4828860">,</span>&nbsp;<span class="ident" id="4828862">inProgress</span><span class="op" id="4828872">,</span>&nbsp;<span class="ident" id="4828874">building</span><span class="op" id="4828882">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828887">op</span>&nbsp;<span class="op" id="4828890">=</span>&nbsp;<span class="keyword" id="4828892">func</span><span class="op" id="4828896">(</span><span class="ident" id="4828897">i</span>&nbsp;<span class="op" id="4828899">*</span><span class="ident" id="4828900">encInstr</span><span class="op" id="4828908">,</span>&nbsp;<span class="ident" id="4828910">state</span>&nbsp;<span class="op" id="4828916">*</span><span class="ident" id="4828917">encoderState</span><span class="op" id="4828929">,</span>&nbsp;<span class="ident" id="4828931">mv</span>&nbsp;<span class="ident" id="4828934">reflect</span><span class="op" id="4828941">.</span><span class="ident" id="4828942">Value</span><span class="op" id="4828947">)</span>&nbsp;<span class="op" id="4828949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828955">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829013">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829082">if</span>&nbsp;<span class="op" id="4829085">!</span><span class="ident" id="4829086">state</span><span class="op" id="4829091">.</span><span class="ident" id="4829092">sendZero</span>&nbsp;<span class="op" id="4829101">&amp;&amp;</span>&nbsp;<span class="ident" id="4829104">mv</span><span class="op" id="4829106">.</span><span class="ident" id="4829107">IsNil</span><span class="op" id="4829112">(</span><span class="op" id="4829113">)</span>&nbsp;<span class="op" id="4829115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829122">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829139">state</span><span class="op" id="4829144">.</span><span class="ident" id="4829145">update</span><span class="op" id="4829151">(</span><span class="ident" id="4829152">i</span><span class="op" id="4829153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829159">state</span><span class="op" id="4829164">.</span><span class="ident" id="4829165">enc</span><span class="op" id="4829168">.</span><span class="ident" id="4829169">encodeMap</span><span class="op" id="4829178">(</span><span class="ident" id="4829179">state</span><span class="op" id="4829184">.</span><span class="ident" id="4829185">b</span><span class="op" id="4829186">,</span>&nbsp;<span class="ident" id="4829188">mv</span><span class="op" id="4829190">,</span>&nbsp;<span class="op" id="4829192">*</span><span class="ident" id="4829193">keyOp</span><span class="op" id="4829198">,</span>&nbsp;<span class="op" id="4829200">*</span><span class="ident" id="4829201">elemOp</span><span class="op" id="4829207">,</span>&nbsp;<span class="ident" id="4829209">keyIndir</span><span class="op" id="4829217">,</span>&nbsp;<span class="ident" id="4829219">elemIndir</span><span class="op" id="4829228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829237">case</span>&nbsp;<span class="ident" id="4829242">reflect</span><span class="op" id="4829249">.</span><span class="ident" id="4829250">Struct</span><span class="op" id="4829256">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829261">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829336">getEncEngine</span><span class="op" id="4829348">(</span><span class="ident" id="4829349">userType</span><span class="op" id="4829357">(</span><span class="ident" id="4829358">typ</span><span class="op" id="4829361">)</span><span class="op" id="4829362">,</span>&nbsp;<span class="ident" id="4829364">building</span><span class="op" id="4829372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829377">info</span>&nbsp;<span class="op" id="4829382">:=</span>&nbsp;<span class="ident" id="4829385">mustGetTypeInfo</span><span class="op" id="4829400">(</span><span class="ident" id="4829401">typ</span><span class="op" id="4829404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829409">op</span>&nbsp;<span class="op" id="4829412">=</span>&nbsp;<span class="keyword" id="4829414">func</span><span class="op" id="4829418">(</span><span class="ident" id="4829419">i</span>&nbsp;<span class="op" id="4829421">*</span><span class="ident" id="4829422">encInstr</span><span class="op" id="4829430">,</span>&nbsp;<span class="ident" id="4829432">state</span>&nbsp;<span class="op" id="4829438">*</span><span class="ident" id="4829439">encoderState</span><span class="op" id="4829451">,</span>&nbsp;<span class="ident" id="4829453">sv</span>&nbsp;<span class="ident" id="4829456">reflect</span><span class="op" id="4829463">.</span><span class="ident" id="4829464">Value</span><span class="op" id="4829469">)</span>&nbsp;<span class="op" id="4829471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829477">state</span><span class="op" id="4829482">.</span><span class="ident" id="4829483">update</span><span class="op" id="4829489">(</span><span class="ident" id="4829490">i</span><span class="op" id="4829491">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829497">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829568">enc</span>&nbsp;<span class="op" id="4829572">:=</span>&nbsp;<span class="ident" id="4829575">info</span><span class="op" id="4829579">.</span><span class="ident" id="4829580">encoder</span><span class="op" id="4829587">.</span><span class="ident" id="4829588">Load</span><span class="op" id="4829592">(</span><span class="op" id="4829593">)</span><span class="op" id="4829594">.</span><span class="op" id="4829595">(</span><span class="op" id="4829596">*</span><span class="ident" id="4829597">encEngine</span><span class="op" id="4829606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829612">state</span><span class="op" id="4829617">.</span><span class="ident" id="4829618">enc</span><span class="op" id="4829621">.</span><span class="ident" id="4829622">encodeStruct</span><span class="op" id="4829634">(</span><span class="ident" id="4829635">state</span><span class="op" id="4829640">.</span><span class="ident" id="4829641">b</span><span class="op" id="4829642">,</span>&nbsp;<span class="ident" id="4829644">enc</span><span class="op" id="4829647">,</span>&nbsp;<span class="ident" id="4829649">sv</span><span class="op" id="4829651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829660">case</span>&nbsp;<span class="ident" id="4829665">reflect</span><span class="op" id="4829672">.</span><span class="ident" id="4829673">Interface</span><span class="op" id="4829682">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829687">op</span>&nbsp;<span class="op" id="4829690">=</span>&nbsp;<span class="keyword" id="4829692">func</span><span class="op" id="4829696">(</span><span class="ident" id="4829697">i</span>&nbsp;<span class="op" id="4829699">*</span><span class="ident" id="4829700">encInstr</span><span class="op" id="4829708">,</span>&nbsp;<span class="ident" id="4829710">state</span>&nbsp;<span class="op" id="4829716">*</span><span class="ident" id="4829717">encoderState</span><span class="op" id="4829729">,</span>&nbsp;<span class="ident" id="4829731">iv</span>&nbsp;<span class="ident" id="4829734">reflect</span><span class="op" id="4829741">.</span><span class="ident" id="4829742">Value</span><span class="op" id="4829747">)</span>&nbsp;<span class="op" id="4829749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829755">if</span>&nbsp;<span class="op" id="4829758">!</span><span class="ident" id="4829759">state</span><span class="op" id="4829764">.</span><span class="ident" id="4829765">sendZero</span>&nbsp;<span class="op" id="4829774">&amp;&amp;</span>&nbsp;<span class="op" id="4829777">(</span><span class="op" id="4829778">!</span><span class="ident" id="4829779">iv</span><span class="op" id="4829781">.</span><span class="ident" id="4829782">IsValid</span><span class="op" id="4829789">(</span><span class="op" id="4829790">)</span>&nbsp;<span class="op" id="4829792">||</span>&nbsp;<span class="ident" id="4829795">iv</span><span class="op" id="4829797">.</span><span class="ident" id="4829798">IsNil</span><span class="op" id="4829803">(</span><span class="op" id="4829804">)</span><span class="op" id="4829805">)</span>&nbsp;<span class="op" id="4829807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829814">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829831">state</span><span class="op" id="4829836">.</span><span class="ident" id="4829837">update</span><span class="op" id="4829843">(</span><span class="ident" id="4829844">i</span><span class="op" id="4829845">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829851">state</span><span class="op" id="4829856">.</span><span class="ident" id="4829857">enc</span><span class="op" id="4829860">.</span><span class="ident" id="4829861">encodeInterface</span><span class="op" id="4829876">(</span><span class="ident" id="4829877">state</span><span class="op" id="4829882">.</span><span class="ident" id="4829883">b</span><span class="op" id="4829884">,</span>&nbsp;<span class="ident" id="4829886">iv</span><span class="op" id="4829888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829903">if</span>&nbsp;<span class="ident" id="4829906">op</span>&nbsp;<span class="op" id="4829909">==</span>&nbsp;<span class="ident" id="4829912">nil</span>&nbsp;<span class="op" id="4829916">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829920">errorf</span><span class="op" id="4829926">(</span><span class="string" id="4829927">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4829957">,</span>&nbsp;<span class="ident" id="4829959">rt</span><span class="op" id="4829961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829967">return</span>&nbsp;<span class="op" id="4829974">&amp;</span><span class="ident" id="4829975">op</span><span class="op" id="4829977">,</span>&nbsp;<span class="ident" id="4829979">indir</span><br>
<span class="lineno"></span><span class="op" id="4829985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="4829988">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4830071">func</span>&nbsp;<span class="ident" id="4830076">gobEncodeOpFor</span><span class="op" id="4830090">(</span><span class="ident" id="4830091">ut</span>&nbsp;<span class="op" id="4830094">*</span><span class="ident" id="4830095">userTypeInfo</span><span class="op" id="4830107">)</span>&nbsp;<span class="op" id="4830109">(</span><span class="op" id="4830110">*</span><span class="ident" id="4830111">encOp</span><span class="op" id="4830116">,</span>&nbsp;<span class="builtintype" id="4830118">int</span><span class="op" id="4830121">)</span>&nbsp;<span class="op" id="4830123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830126">rt</span>&nbsp;<span class="op" id="4830129">:=</span>&nbsp;<span class="ident" id="4830132">ut</span><span class="op" id="4830134">.</span><span class="ident" id="4830135">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830141">if</span>&nbsp;<span class="ident" id="4830144">ut</span><span class="op" id="4830146">.</span><span class="ident" id="4830147">encIndir</span>&nbsp;<span class="op" id="4830156">==</span>&nbsp;<span class="op" id="4830159">-</span><span class="num" id="4830160">1</span>&nbsp;<span class="op" id="4830162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830166">rt</span>&nbsp;<span class="op" id="4830169">=</span>&nbsp;<span class="ident" id="4830171">reflect</span><span class="op" id="4830178">.</span><span class="ident" id="4830179">PtrTo</span><span class="op" id="4830184">(</span><span class="ident" id="4830185">rt</span><span class="op" id="4830187">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830190">}</span>&nbsp;<span class="keyword" id="4830192">else</span>&nbsp;<span class="keyword" id="4830197">if</span>&nbsp;<span class="ident" id="4830200">ut</span><span class="op" id="4830202">.</span><span class="ident" id="4830203">encIndir</span>&nbsp;<span class="op" id="4830212">&gt;</span>&nbsp;<span class="num" id="4830214">0</span>&nbsp;<span class="op" id="4830216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830220">for</span>&nbsp;<span class="ident" id="4830224">i</span>&nbsp;<span class="op" id="4830226">:=</span>&nbsp;<span class="builtintype" id="4830229">int8</span><span class="op" id="4830233">(</span><span class="num" id="4830234">0</span><span class="op" id="4830235">)</span><span class="op" id="4830236">;</span>&nbsp;<span class="ident" id="4830238">i</span>&nbsp;<span class="op" id="4830240">&lt;</span>&nbsp;<span class="ident" id="4830242">ut</span><span class="op" id="4830244">.</span><span class="ident" id="4830245">encIndir</span><span class="op" id="4830253">;</span>&nbsp;<span class="ident" id="4830255">i</span><span class="op" id="4830256">++</span>&nbsp;<span class="op" id="4830259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830264">rt</span>&nbsp;<span class="op" id="4830267">=</span>&nbsp;<span class="ident" id="4830269">rt</span><span class="op" id="4830271">.</span><span class="ident" id="4830272">Elem</span><span class="op" id="4830276">(</span><span class="op" id="4830277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830284">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830287">var</span>&nbsp;<span class="ident" id="4830291">op</span>&nbsp;<span class="ident" id="4830294">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830301">op</span>&nbsp;<span class="op" id="4830304">=</span>&nbsp;<span class="keyword" id="4830306">func</span><span class="op" id="4830310">(</span><span class="ident" id="4830311">i</span>&nbsp;<span class="op" id="4830313">*</span><span class="ident" id="4830314">encInstr</span><span class="op" id="4830322">,</span>&nbsp;<span class="ident" id="4830324">state</span>&nbsp;<span class="op" id="4830330">*</span><span class="ident" id="4830331">encoderState</span><span class="op" id="4830343">,</span>&nbsp;<span class="ident" id="4830345">v</span>&nbsp;<span class="ident" id="4830347">reflect</span><span class="op" id="4830354">.</span><span class="ident" id="4830355">Value</span><span class="op" id="4830360">)</span>&nbsp;<span class="op" id="4830362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830366">if</span>&nbsp;<span class="ident" id="4830369">ut</span><span class="op" id="4830371">.</span><span class="ident" id="4830372">encIndir</span>&nbsp;<span class="op" id="4830381">==</span>&nbsp;<span class="op" id="4830384">-</span><span class="num" id="4830385">1</span>&nbsp;<span class="op" id="4830387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4830392">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830453">if</span>&nbsp;<span class="op" id="4830456">!</span><span class="ident" id="4830457">v</span><span class="op" id="4830458">.</span><span class="ident" id="4830459">CanAddr</span><span class="op" id="4830466">(</span><span class="op" id="4830467">)</span>&nbsp;<span class="op" id="4830469">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830475">errorf</span><span class="op" id="4830481">(</span><span class="string" id="4830482">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4830514">,</span>&nbsp;<span class="ident" id="4830516">rt</span><span class="op" id="4830518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830528">v</span>&nbsp;<span class="op" id="4830530">=</span>&nbsp;<span class="ident" id="4830532">v</span><span class="op" id="4830533">.</span><span class="ident" id="4830534">Addr</span><span class="op" id="4830538">(</span><span class="op" id="4830539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830547">if</span>&nbsp;<span class="op" id="4830550">!</span><span class="ident" id="4830551">state</span><span class="op" id="4830556">.</span><span class="ident" id="4830557">sendZero</span>&nbsp;<span class="op" id="4830566">&amp;&amp;</span>&nbsp;<span class="ident" id="4830569">isZero</span><span class="op" id="4830575">(</span><span class="ident" id="4830576">v</span><span class="op" id="4830577">)</span>&nbsp;<span class="op" id="4830579">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830584">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830597">state</span><span class="op" id="4830602">.</span><span class="ident" id="4830603">update</span><span class="op" id="4830609">(</span><span class="ident" id="4830610">i</span><span class="op" id="4830611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830615">state</span><span class="op" id="4830620">.</span><span class="ident" id="4830621">enc</span><span class="op" id="4830624">.</span><span class="ident" id="4830625">encodeGobEncoder</span><span class="op" id="4830641">(</span><span class="ident" id="4830642">state</span><span class="op" id="4830647">.</span><span class="ident" id="4830648">b</span><span class="op" id="4830649">,</span>&nbsp;<span class="ident" id="4830651">ut</span><span class="op" id="4830653">,</span>&nbsp;<span class="ident" id="4830655">v</span><span class="op" id="4830656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830659">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830662">return</span>&nbsp;<span class="op" id="4830669">&amp;</span><span class="ident" id="4830670">op</span><span class="op" id="4830672">,</span>&nbsp;<span class="builtintype" id="4830674">int</span><span class="op" id="4830677">(</span><span class="ident" id="4830678">ut</span><span class="op" id="4830680">.</span><span class="ident" id="4830681">encIndir</span><span class="op" id="4830689">)</span>&nbsp;<span class="comment" id="4830691">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="4830754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4830757">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4830811">func</span>&nbsp;<span class="ident" id="4830816">compileEnc</span><span class="op" id="4830826">(</span><span class="ident" id="4830827">ut</span>&nbsp;<span class="op" id="4830830">*</span><span class="ident" id="4830831">userTypeInfo</span><span class="op" id="4830843">,</span>&nbsp;<span class="ident" id="4830845">building</span>&nbsp;<span class="keyword" id="4830854">map</span><span class="op" id="4830857">[</span><span class="op" id="4830858">*</span><span class="ident" id="4830859">typeInfo</span><span class="op" id="4830867">]</span><span class="builtintype" id="4830868">bool</span><span class="op" id="4830872">)</span>&nbsp;<span class="op" id="4830874">*</span><span class="ident" id="4830875">encEngine</span>&nbsp;<span class="op" id="4830885">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830888">srt</span>&nbsp;<span class="op" id="4830892">:=</span>&nbsp;<span class="ident" id="4830895">ut</span><span class="op" id="4830897">.</span><span class="ident" id="4830898">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830904">engine</span>&nbsp;<span class="op" id="4830911">:=</span>&nbsp;<span class="builtinfunc" id="4830914">new</span><span class="op" id="4830917">(</span><span class="ident" id="4830918">encEngine</span><span class="op" id="4830927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830930">seen</span>&nbsp;<span class="op" id="4830935">:=</span>&nbsp;<span class="builtinfunc" id="4830938">make</span><span class="op" id="4830942">(</span><span class="keyword" id="4830943">map</span><span class="op" id="4830946">[</span><span class="ident" id="4830947">reflect</span><span class="op" id="4830954">.</span><span class="ident" id="4830955">Type</span><span class="op" id="4830959">]</span><span class="op" id="4830960">*</span><span class="ident" id="4830961">encOp</span><span class="op" id="4830966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830969">rt</span>&nbsp;<span class="op" id="4830972">:=</span>&nbsp;<span class="ident" id="4830975">ut</span><span class="op" id="4830977">.</span><span class="ident" id="4830978">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830984">if</span>&nbsp;<span class="ident" id="4830987">ut</span><span class="op" id="4830989">.</span><span class="ident" id="4830990">externalEnc</span>&nbsp;<span class="op" id="4831002">!=</span>&nbsp;<span class="num" id="4831005">0</span>&nbsp;<span class="op" id="4831007">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831011">rt</span>&nbsp;<span class="op" id="4831014">=</span>&nbsp;<span class="ident" id="4831016">ut</span><span class="op" id="4831018">.</span><span class="ident" id="4831019">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831028">if</span>&nbsp;<span class="ident" id="4831031">ut</span><span class="op" id="4831033">.</span><span class="ident" id="4831034">externalEnc</span>&nbsp;<span class="op" id="4831046">==</span>&nbsp;<span class="num" id="4831049">0</span>&nbsp;<span class="op" id="4831051">&amp;&amp;</span>&nbsp;<span class="ident" id="4831054">srt</span><span class="op" id="4831057">.</span><span class="ident" id="4831058">Kind</span><span class="op" id="4831062">(</span><span class="op" id="4831063">)</span>&nbsp;<span class="op" id="4831065">==</span>&nbsp;<span class="ident" id="4831068">reflect</span><span class="op" id="4831075">.</span><span class="ident" id="4831076">Struct</span>&nbsp;<span class="op" id="4831083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831087">for</span>&nbsp;<span class="ident" id="4831091">fieldNum</span><span class="op" id="4831099">,</span>&nbsp;<span class="ident" id="4831101">wireFieldNum</span>&nbsp;<span class="op" id="4831114">:=</span>&nbsp;<span class="num" id="4831117">0</span><span class="op" id="4831118">,</span>&nbsp;<span class="num" id="4831120">0</span><span class="op" id="4831121">;</span>&nbsp;<span class="ident" id="4831123">fieldNum</span>&nbsp;<span class="op" id="4831132">&lt;</span>&nbsp;<span class="ident" id="4831134">srt</span><span class="op" id="4831137">.</span><span class="ident" id="4831138">NumField</span><span class="op" id="4831146">(</span><span class="op" id="4831147">)</span><span class="op" id="4831148">;</span>&nbsp;<span class="ident" id="4831150">fieldNum</span><span class="op" id="4831158">++</span>&nbsp;<span class="op" id="4831161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831166">f</span>&nbsp;<span class="op" id="4831168">:=</span>&nbsp;<span class="ident" id="4831171">srt</span><span class="op" id="4831174">.</span><span class="ident" id="4831175">Field</span><span class="op" id="4831180">(</span><span class="ident" id="4831181">fieldNum</span><span class="op" id="4831189">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831194">if</span>&nbsp;<span class="op" id="4831197">!</span><span class="ident" id="4831198">isSent</span><span class="op" id="4831204">(</span><span class="op" id="4831205">&amp;</span><span class="ident" id="4831206">f</span><span class="op" id="4831207">)</span>&nbsp;<span class="op" id="4831209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831215">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831232">op</span><span class="op" id="4831234">,</span>&nbsp;<span class="ident" id="4831236">indir</span>&nbsp;<span class="op" id="4831242">:=</span>&nbsp;<span class="ident" id="4831245">encOpFor</span><span class="op" id="4831253">(</span><span class="ident" id="4831254">f</span><span class="op" id="4831255">.</span><span class="ident" id="4831256">Type</span><span class="op" id="4831260">,</span>&nbsp;<span class="ident" id="4831262">seen</span><span class="op" id="4831266">,</span>&nbsp;<span class="ident" id="4831268">building</span><span class="op" id="4831276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831281">engine</span><span class="op" id="4831287">.</span><span class="ident" id="4831288">instr</span>&nbsp;<span class="op" id="4831294">=</span>&nbsp;<span class="builtinfunc" id="4831296">append</span><span class="op" id="4831302">(</span><span class="ident" id="4831303">engine</span><span class="op" id="4831309">.</span><span class="ident" id="4831310">instr</span><span class="op" id="4831315">,</span>&nbsp;<span class="ident" id="4831317">encInstr</span><span class="op" id="4831325">{</span><span class="op" id="4831326">*</span><span class="ident" id="4831327">op</span><span class="op" id="4831329">,</span>&nbsp;<span class="ident" id="4831331">wireFieldNum</span><span class="op" id="4831343">,</span>&nbsp;<span class="ident" id="4831345">f</span><span class="op" id="4831346">.</span><span class="ident" id="4831347">Index</span><span class="op" id="4831352">,</span>&nbsp;<span class="ident" id="4831354">indir</span><span class="op" id="4831359">}</span><span class="op" id="4831360">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831365">wireFieldNum</span><span class="op" id="4831377">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831386">if</span>&nbsp;<span class="ident" id="4831389">srt</span><span class="op" id="4831392">.</span><span class="ident" id="4831393">NumField</span><span class="op" id="4831401">(</span><span class="op" id="4831402">)</span>&nbsp;<span class="op" id="4831404">&gt;</span>&nbsp;<span class="num" id="4831406">0</span>&nbsp;<span class="op" id="4831408">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4831411">len</span><span class="op" id="4831414">(</span><span class="ident" id="4831415">engine</span><span class="op" id="4831421">.</span><span class="ident" id="4831422">instr</span><span class="op" id="4831427">)</span>&nbsp;<span class="op" id="4831429">==</span>&nbsp;<span class="num" id="4831432">0</span>&nbsp;<span class="op" id="4831434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831439">errorf</span><span class="op" id="4831445">(</span><span class="string" id="4831446">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="4831478">,</span>&nbsp;<span class="ident" id="4831480">rt</span><span class="op" id="4831482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831486">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831490">engine</span><span class="op" id="4831496">.</span><span class="ident" id="4831497">instr</span>&nbsp;<span class="op" id="4831503">=</span>&nbsp;<span class="builtinfunc" id="4831505">append</span><span class="op" id="4831511">(</span><span class="ident" id="4831512">engine</span><span class="op" id="4831518">.</span><span class="ident" id="4831519">instr</span><span class="op" id="4831524">,</span>&nbsp;<span class="ident" id="4831526">encInstr</span><span class="op" id="4831534">{</span><span class="ident" id="4831535">encStructTerminator</span><span class="op" id="4831554">,</span>&nbsp;<span class="num" id="4831556">0</span><span class="op" id="4831557">,</span>&nbsp;<span class="ident" id="4831559">nil</span><span class="op" id="4831562">,</span>&nbsp;<span class="num" id="4831564">0</span><span class="op" id="4831565">}</span><span class="op" id="4831566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831569">}</span>&nbsp;<span class="keyword" id="4831571">else</span>&nbsp;<span class="op" id="4831576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831580">engine</span><span class="op" id="4831586">.</span><span class="ident" id="4831587">instr</span>&nbsp;<span class="op" id="4831593">=</span>&nbsp;<span class="builtinfunc" id="4831595">make</span><span class="op" id="4831599">(</span><span class="op" id="4831600">[</span><span class="op" id="4831601">]</span><span class="ident" id="4831602">encInstr</span><span class="op" id="4831610">,</span>&nbsp;<span class="num" id="4831612">1</span><span class="op" id="4831613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831617">op</span><span class="op" id="4831619">,</span>&nbsp;<span class="ident" id="4831621">indir</span>&nbsp;<span class="op" id="4831627">:=</span>&nbsp;<span class="ident" id="4831630">encOpFor</span><span class="op" id="4831638">(</span><span class="ident" id="4831639">rt</span><span class="op" id="4831641">,</span>&nbsp;<span class="ident" id="4831643">seen</span><span class="op" id="4831647">,</span>&nbsp;<span class="ident" id="4831649">building</span><span class="op" id="4831657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831661">engine</span><span class="op" id="4831667">.</span><span class="ident" id="4831668">instr</span><span class="op" id="4831673">[</span><span class="num" id="4831674">0</span><span class="op" id="4831675">]</span>&nbsp;<span class="op" id="4831677">=</span>&nbsp;<span class="ident" id="4831679">encInstr</span><span class="op" id="4831687">{</span><span class="op" id="4831688">*</span><span class="ident" id="4831689">op</span><span class="op" id="4831691">,</span>&nbsp;<span class="ident" id="4831693">singletonField</span><span class="op" id="4831707">,</span>&nbsp;<span class="ident" id="4831709">nil</span><span class="op" id="4831712">,</span>&nbsp;<span class="ident" id="4831714">indir</span><span class="op" id="4831719">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831725">return</span>&nbsp;<span class="ident" id="4831732">engine</span><br>
<span class="lineno"></span><span class="op" id="4831739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4831742">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="4831798">func</span>&nbsp;<span class="ident" id="4831803">getEncEngine</span><span class="op" id="4831815">(</span><span class="ident" id="4831816">ut</span>&nbsp;<span class="op" id="4831819">*</span><span class="ident" id="4831820">userTypeInfo</span><span class="op" id="4831832">,</span>&nbsp;<span class="ident" id="4831834">building</span>&nbsp;<span class="keyword" id="4831843">map</span><span class="op" id="4831846">[</span><span class="op" id="4831847">*</span><span class="ident" id="4831848">typeInfo</span><span class="op" id="4831856">]</span><span class="builtintype" id="4831857">bool</span><span class="op" id="4831861">)</span>&nbsp;<span class="op" id="4831863">*</span><span class="ident" id="4831864">encEngine</span>&nbsp;<span class="op" id="4831874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831877">info</span><span class="op" id="4831881">,</span>&nbsp;<span class="ident" id="4831883">err</span>&nbsp;<span class="op" id="4831887">:=</span>&nbsp;<span class="ident" id="4831890">getTypeInfo</span><span class="op" id="4831901">(</span><span class="ident" id="4831902">ut</span><span class="op" id="4831904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831907">if</span>&nbsp;<span class="ident" id="4831910">err</span>&nbsp;<span class="op" id="4831914">!=</span>&nbsp;<span class="ident" id="4831917">nil</span>&nbsp;<span class="op" id="4831921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831925">error_</span><span class="op" id="4831931">(</span><span class="ident" id="4831932">err</span><span class="op" id="4831935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831938">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831941">enc</span><span class="op" id="4831944">,</span>&nbsp;<span class="ident" id="4831946">ok</span>&nbsp;<span class="op" id="4831949">:=</span>&nbsp;<span class="ident" id="4831952">info</span><span class="op" id="4831956">.</span><span class="ident" id="4831957">encoder</span><span class="op" id="4831964">.</span><span class="ident" id="4831965">Load</span><span class="op" id="4831969">(</span><span class="op" id="4831970">)</span><span class="op" id="4831971">.</span><span class="op" id="4831972">(</span><span class="op" id="4831973">*</span><span class="ident" id="4831974">encEngine</span><span class="op" id="4831983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831986">if</span>&nbsp;<span class="op" id="4831989">!</span><span class="ident" id="4831990">ok</span>&nbsp;<span class="op" id="4831993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831997">enc</span>&nbsp;<span class="op" id="4832001">=</span>&nbsp;<span class="ident" id="4832003">buildEncEngine</span><span class="op" id="4832017">(</span><span class="ident" id="4832018">info</span><span class="op" id="4832022">,</span>&nbsp;<span class="ident" id="4832024">ut</span><span class="op" id="4832026">,</span>&nbsp;<span class="ident" id="4832028">building</span><span class="op" id="4832036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832042">return</span>&nbsp;<span class="ident" id="4832049">enc</span><br>
<span class="lineno">660</span><span class="op" id="4832053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4832056">func</span>&nbsp;<span class="ident" id="4832061">buildEncEngine</span><span class="op" id="4832075">(</span><span class="ident" id="4832076">info</span>&nbsp;<span class="op" id="4832081">*</span><span class="ident" id="4832082">typeInfo</span><span class="op" id="4832090">,</span>&nbsp;<span class="ident" id="4832092">ut</span>&nbsp;<span class="op" id="4832095">*</span><span class="ident" id="4832096">userTypeInfo</span><span class="op" id="4832108">,</span>&nbsp;<span class="ident" id="4832110">building</span>&nbsp;<span class="keyword" id="4832119">map</span><span class="op" id="4832122">[</span><span class="op" id="4832123">*</span><span class="ident" id="4832124">typeInfo</span><span class="op" id="4832132">]</span><span class="builtintype" id="4832133">bool</span><span class="op" id="4832137">)</span>&nbsp;<span class="op" id="4832139">*</span><span class="ident" id="4832140">encEngine</span>&nbsp;<span class="op" id="4832150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4832153">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832184">if</span>&nbsp;<span class="ident" id="4832187">building</span>&nbsp;<span class="op" id="4832196">!=</span>&nbsp;<span class="ident" id="4832199">nil</span>&nbsp;<span class="op" id="4832203">&amp;&amp;</span>&nbsp;<span class="ident" id="4832206">building</span><span class="op" id="4832214">[</span><span class="ident" id="4832215">info</span><span class="op" id="4832219">]</span>&nbsp;<span class="op" id="4832221">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832225">return</span>&nbsp;<span class="ident" id="4832232">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832240">info</span><span class="op" id="4832244">.</span><span class="ident" id="4832245">encInit</span><span class="op" id="4832252">.</span><span class="ident" id="4832253">Lock</span><span class="op" id="4832257">(</span><span class="op" id="4832258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832261">defer</span>&nbsp;<span class="ident" id="4832267">info</span><span class="op" id="4832271">.</span><span class="ident" id="4832272">encInit</span><span class="op" id="4832279">.</span><span class="ident" id="4832280">Unlock</span><span class="op" id="4832286">(</span><span class="op" id="4832287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832290">enc</span><span class="op" id="4832293">,</span>&nbsp;<span class="ident" id="4832295">ok</span>&nbsp;<span class="op" id="4832298">:=</span>&nbsp;<span class="ident" id="4832301">info</span><span class="op" id="4832305">.</span><span class="ident" id="4832306">encoder</span><span class="op" id="4832313">.</span><span class="ident" id="4832314">Load</span><span class="op" id="4832318">(</span><span class="op" id="4832319">)</span><span class="op" id="4832320">.</span><span class="op" id="4832321">(</span><span class="op" id="4832322">*</span><span class="ident" id="4832323">encEngine</span><span class="op" id="4832332">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832335">if</span>&nbsp;<span class="op" id="4832338">!</span><span class="ident" id="4832339">ok</span>&nbsp;<span class="op" id="4832342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832346">if</span>&nbsp;<span class="ident" id="4832349">building</span>&nbsp;<span class="op" id="4832358">==</span>&nbsp;<span class="ident" id="4832361">nil</span>&nbsp;<span class="op" id="4832365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832370">building</span>&nbsp;<span class="op" id="4832379">=</span>&nbsp;<span class="builtinfunc" id="4832381">make</span><span class="op" id="4832385">(</span><span class="keyword" id="4832386">map</span><span class="op" id="4832389">[</span><span class="op" id="4832390">*</span><span class="ident" id="4832391">typeInfo</span><span class="op" id="4832399">]</span><span class="builtintype" id="4832400">bool</span><span class="op" id="4832404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832412">building</span><span class="op" id="4832420">[</span><span class="ident" id="4832421">info</span><span class="op" id="4832425">]</span>&nbsp;<span class="op" id="4832427">=</span>&nbsp;<span class="builtintype" id="4832429">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832436">enc</span>&nbsp;<span class="op" id="4832440">=</span>&nbsp;<span class="ident" id="4832442">compileEnc</span><span class="op" id="4832452">(</span><span class="ident" id="4832453">ut</span><span class="op" id="4832455">,</span>&nbsp;<span class="ident" id="4832457">building</span><span class="op" id="4832465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832469">info</span><span class="op" id="4832473">.</span><span class="ident" id="4832474">encoder</span><span class="op" id="4832481">.</span><span class="ident" id="4832482">Store</span><span class="op" id="4832487">(</span><span class="ident" id="4832488">enc</span><span class="op" id="4832491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832497">return</span>&nbsp;<span class="ident" id="4832504">enc</span><br>
<span class="lineno"></span><span class="op" id="4832508">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="4832511">func</span>&nbsp;<span class="op" id="4832516">(</span><span class="ident" id="4832517">enc</span>&nbsp;<span class="op" id="4832521">*</span><span class="ident" id="4832522">Encoder</span><span class="op" id="4832529">)</span>&nbsp;<span class="ident" id="4832531">encode</span><span class="op" id="4832537">(</span><span class="ident" id="4832538">b</span>&nbsp;<span class="op" id="4832540">*</span><span class="ident" id="4832541">encBuffer</span><span class="op" id="4832550">,</span>&nbsp;<span class="ident" id="4832552">value</span>&nbsp;<span class="ident" id="4832558">reflect</span><span class="op" id="4832565">.</span><span class="ident" id="4832566">Value</span><span class="op" id="4832571">,</span>&nbsp;<span class="ident" id="4832573">ut</span>&nbsp;<span class="op" id="4832576">*</span><span class="ident" id="4832577">userTypeInfo</span><span class="op" id="4832589">)</span>&nbsp;<span class="op" id="4832591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832594">defer</span>&nbsp;<span class="ident" id="4832600">catchError</span><span class="op" id="4832610">(</span><span class="op" id="4832611">&amp;</span><span class="ident" id="4832612">enc</span><span class="op" id="4832615">.</span><span class="ident" id="4832616">err</span><span class="op" id="4832619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832622">engine</span>&nbsp;<span class="op" id="4832629">:=</span>&nbsp;<span class="ident" id="4832632">getEncEngine</span><span class="op" id="4832644">(</span><span class="ident" id="4832645">ut</span><span class="op" id="4832647">,</span>&nbsp;<span class="ident" id="4832649">nil</span><span class="op" id="4832652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832655">indir</span>&nbsp;<span class="op" id="4832661">:=</span>&nbsp;<span class="ident" id="4832664">ut</span><span class="op" id="4832666">.</span><span class="ident" id="4832667">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832674">if</span>&nbsp;<span class="ident" id="4832677">ut</span><span class="op" id="4832679">.</span><span class="ident" id="4832680">externalEnc</span>&nbsp;<span class="op" id="4832692">!=</span>&nbsp;<span class="num" id="4832695">0</span>&nbsp;<span class="op" id="4832697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832701">indir</span>&nbsp;<span class="op" id="4832707">=</span>&nbsp;<span class="builtintype" id="4832709">int</span><span class="op" id="4832712">(</span><span class="ident" id="4832713">ut</span><span class="op" id="4832715">.</span><span class="ident" id="4832716">encIndir</span><span class="op" id="4832724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832730">for</span>&nbsp;<span class="ident" id="4832734">i</span>&nbsp;<span class="op" id="4832736">:=</span>&nbsp;<span class="num" id="4832739">0</span><span class="op" id="4832740">;</span>&nbsp;<span class="ident" id="4832742">i</span>&nbsp;<span class="op" id="4832744">&lt;</span>&nbsp;<span class="ident" id="4832746">indir</span><span class="op" id="4832751">;</span>&nbsp;<span class="ident" id="4832753">i</span><span class="op" id="4832754">++</span>&nbsp;<span class="op" id="4832757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832761">value</span>&nbsp;<span class="op" id="4832767">=</span>&nbsp;<span class="ident" id="4832769">reflect</span><span class="op" id="4832776">.</span><span class="ident" id="4832777">Indirect</span><span class="op" id="4832785">(</span><span class="ident" id="4832786">value</span><span class="op" id="4832791">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832797">if</span>&nbsp;<span class="ident" id="4832800">ut</span><span class="op" id="4832802">.</span><span class="ident" id="4832803">externalEnc</span>&nbsp;<span class="op" id="4832815">==</span>&nbsp;<span class="num" id="4832818">0</span>&nbsp;<span class="op" id="4832820">&amp;&amp;</span>&nbsp;<span class="ident" id="4832823">value</span><span class="op" id="4832828">.</span><span class="ident" id="4832829">Type</span><span class="op" id="4832833">(</span><span class="op" id="4832834">)</span><span class="op" id="4832835">.</span><span class="ident" id="4832836">Kind</span><span class="op" id="4832840">(</span><span class="op" id="4832841">)</span>&nbsp;<span class="op" id="4832843">==</span>&nbsp;<span class="ident" id="4832846">reflect</span><span class="op" id="4832853">.</span><span class="ident" id="4832854">Struct</span>&nbsp;<span class="op" id="4832861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832865">enc</span><span class="op" id="4832868">.</span><span class="ident" id="4832869">encodeStruct</span><span class="op" id="4832881">(</span><span class="ident" id="4832882">b</span><span class="op" id="4832883">,</span>&nbsp;<span class="ident" id="4832885">engine</span><span class="op" id="4832891">,</span>&nbsp;<span class="ident" id="4832893">value</span><span class="op" id="4832898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832901">}</span>&nbsp;<span class="keyword" id="4832903">else</span>&nbsp;<span class="op" id="4832908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832912">enc</span><span class="op" id="4832915">.</span><span class="ident" id="4832916">encodeSingle</span><span class="op" id="4832928">(</span><span class="ident" id="4832929">b</span><span class="op" id="4832930">,</span>&nbsp;<span class="ident" id="4832932">engine</span><span class="op" id="4832938">,</span>&nbsp;<span class="ident" id="4832940">value</span><span class="op" id="4832945">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832948">}</span><br>
<span class="lineno"></span><span class="op" id="4832950">}</span>
</div>
</body>
</html>
