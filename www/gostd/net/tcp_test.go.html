<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7887574">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7887629">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7887683">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7887734">package</span>&nbsp;<span class="ident" id="7887742">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7887747">import</span>&nbsp;<span class="op" id="7887754">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7887757">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7887764">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7887770">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7887781">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7887792">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7887800">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7887811">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="7887818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7887821">func</span>&nbsp;<span class="ident" id="7887826">BenchmarkTCP4OneShot</span><span class="op" id="7887846">(</span><span class="ident" id="7887847">b</span>&nbsp;<span class="op" id="7887849">*</span><span class="ident" id="7887850">testing</span><span class="op" id="7887857">.</span><span class="ident" id="7887858">B</span><span class="op" id="7887859">)</span>&nbsp;<span class="op" id="7887861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887864">benchmarkTCP</span><span class="op" id="7887876">(</span><span class="ident" id="7887877">b</span><span class="op" id="7887878">,</span>&nbsp;<span class="builtintype" id="7887880">false</span><span class="op" id="7887885">,</span>&nbsp;<span class="builtintype" id="7887887">false</span><span class="op" id="7887892">,</span>&nbsp;<span class="string" id="7887894">&#34;127.0.0.1:0&#34;</span><span class="op" id="7887907">)</span><br>
<span class="lineno"></span><span class="op" id="7887909">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7887912">func</span>&nbsp;<span class="ident" id="7887917">BenchmarkTCP4OneShotTimeout</span><span class="op" id="7887944">(</span><span class="ident" id="7887945">b</span>&nbsp;<span class="op" id="7887947">*</span><span class="ident" id="7887948">testing</span><span class="op" id="7887955">.</span><span class="ident" id="7887956">B</span><span class="op" id="7887957">)</span>&nbsp;<span class="op" id="7887959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887962">benchmarkTCP</span><span class="op" id="7887974">(</span><span class="ident" id="7887975">b</span><span class="op" id="7887976">,</span>&nbsp;<span class="builtintype" id="7887978">false</span><span class="op" id="7887983">,</span>&nbsp;<span class="builtintype" id="7887985">true</span><span class="op" id="7887989">,</span>&nbsp;<span class="string" id="7887991">&#34;127.0.0.1:0&#34;</span><span class="op" id="7888004">)</span><br>
<span class="lineno"></span><span class="op" id="7888006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7888009">func</span>&nbsp;<span class="ident" id="7888014">BenchmarkTCP4Persistent</span><span class="op" id="7888037">(</span><span class="ident" id="7888038">b</span>&nbsp;<span class="op" id="7888040">*</span><span class="ident" id="7888041">testing</span><span class="op" id="7888048">.</span><span class="ident" id="7888049">B</span><span class="op" id="7888050">)</span>&nbsp;<span class="op" id="7888052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888055">benchmarkTCP</span><span class="op" id="7888067">(</span><span class="ident" id="7888068">b</span><span class="op" id="7888069">,</span>&nbsp;<span class="builtintype" id="7888071">true</span><span class="op" id="7888075">,</span>&nbsp;<span class="builtintype" id="7888077">false</span><span class="op" id="7888082">,</span>&nbsp;<span class="string" id="7888084">&#34;127.0.0.1:0&#34;</span><span class="op" id="7888097">)</span><br>
<span class="lineno"></span><span class="op" id="7888099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7888102">func</span>&nbsp;<span class="ident" id="7888107">BenchmarkTCP4PersistentTimeout</span><span class="op" id="7888137">(</span><span class="ident" id="7888138">b</span>&nbsp;<span class="op" id="7888140">*</span><span class="ident" id="7888141">testing</span><span class="op" id="7888148">.</span><span class="ident" id="7888149">B</span><span class="op" id="7888150">)</span>&nbsp;<span class="op" id="7888152">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888155">benchmarkTCP</span><span class="op" id="7888167">(</span><span class="ident" id="7888168">b</span><span class="op" id="7888169">,</span>&nbsp;<span class="builtintype" id="7888171">true</span><span class="op" id="7888175">,</span>&nbsp;<span class="builtintype" id="7888177">true</span><span class="op" id="7888181">,</span>&nbsp;<span class="string" id="7888183">&#34;127.0.0.1:0&#34;</span><span class="op" id="7888196">)</span><br>
<span class="lineno"></span><span class="op" id="7888198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7888201">func</span>&nbsp;<span class="ident" id="7888206">BenchmarkTCP6OneShot</span><span class="op" id="7888226">(</span><span class="ident" id="7888227">b</span>&nbsp;<span class="op" id="7888229">*</span><span class="ident" id="7888230">testing</span><span class="op" id="7888237">.</span><span class="ident" id="7888238">B</span><span class="op" id="7888239">)</span>&nbsp;<span class="op" id="7888241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888244">if</span>&nbsp;<span class="op" id="7888247">!</span><span class="ident" id="7888248">supportsIPv6</span>&nbsp;<span class="op" id="7888261">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888265">b</span><span class="op" id="7888266">.</span><span class="ident" id="7888267">Skip</span><span class="op" id="7888271">(</span><span class="string" id="7888272">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7888295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888301">benchmarkTCP</span><span class="op" id="7888313">(</span><span class="ident" id="7888314">b</span><span class="op" id="7888315">,</span>&nbsp;<span class="builtintype" id="7888317">false</span><span class="op" id="7888322">,</span>&nbsp;<span class="builtintype" id="7888324">false</span><span class="op" id="7888329">,</span>&nbsp;<span class="string" id="7888331">&#34;[::1]:0&#34;</span><span class="op" id="7888340">)</span><br>
<span class="lineno"></span><span class="op" id="7888342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="7888345">func</span>&nbsp;<span class="ident" id="7888350">BenchmarkTCP6OneShotTimeout</span><span class="op" id="7888377">(</span><span class="ident" id="7888378">b</span>&nbsp;<span class="op" id="7888380">*</span><span class="ident" id="7888381">testing</span><span class="op" id="7888388">.</span><span class="ident" id="7888389">B</span><span class="op" id="7888390">)</span>&nbsp;<span class="op" id="7888392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888395">if</span>&nbsp;<span class="op" id="7888398">!</span><span class="ident" id="7888399">supportsIPv6</span>&nbsp;<span class="op" id="7888412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888416">b</span><span class="op" id="7888417">.</span><span class="ident" id="7888418">Skip</span><span class="op" id="7888422">(</span><span class="string" id="7888423">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7888446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888452">benchmarkTCP</span><span class="op" id="7888464">(</span><span class="ident" id="7888465">b</span><span class="op" id="7888466">,</span>&nbsp;<span class="builtintype" id="7888468">false</span><span class="op" id="7888473">,</span>&nbsp;<span class="builtintype" id="7888475">true</span><span class="op" id="7888479">,</span>&nbsp;<span class="string" id="7888481">&#34;[::1]:0&#34;</span><span class="op" id="7888490">)</span><br>
<span class="lineno">45</span><span class="op" id="7888492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7888495">func</span>&nbsp;<span class="ident" id="7888500">BenchmarkTCP6Persistent</span><span class="op" id="7888523">(</span><span class="ident" id="7888524">b</span>&nbsp;<span class="op" id="7888526">*</span><span class="ident" id="7888527">testing</span><span class="op" id="7888534">.</span><span class="ident" id="7888535">B</span><span class="op" id="7888536">)</span>&nbsp;<span class="op" id="7888538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888541">if</span>&nbsp;<span class="op" id="7888544">!</span><span class="ident" id="7888545">supportsIPv6</span>&nbsp;<span class="op" id="7888558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888562">b</span><span class="op" id="7888563">.</span><span class="ident" id="7888564">Skip</span><span class="op" id="7888568">(</span><span class="string" id="7888569">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7888592">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888598">benchmarkTCP</span><span class="op" id="7888610">(</span><span class="ident" id="7888611">b</span><span class="op" id="7888612">,</span>&nbsp;<span class="builtintype" id="7888614">true</span><span class="op" id="7888618">,</span>&nbsp;<span class="builtintype" id="7888620">false</span><span class="op" id="7888625">,</span>&nbsp;<span class="string" id="7888627">&#34;[::1]:0&#34;</span><span class="op" id="7888636">)</span><br>
<span class="lineno"></span><span class="op" id="7888638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7888641">func</span>&nbsp;<span class="ident" id="7888646">BenchmarkTCP6PersistentTimeout</span><span class="op" id="7888676">(</span><span class="ident" id="7888677">b</span>&nbsp;<span class="op" id="7888679">*</span><span class="ident" id="7888680">testing</span><span class="op" id="7888687">.</span><span class="ident" id="7888688">B</span><span class="op" id="7888689">)</span>&nbsp;<span class="op" id="7888691">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888694">if</span>&nbsp;<span class="op" id="7888697">!</span><span class="ident" id="7888698">supportsIPv6</span>&nbsp;<span class="op" id="7888711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888715">b</span><span class="op" id="7888716">.</span><span class="ident" id="7888717">Skip</span><span class="op" id="7888721">(</span><span class="string" id="7888722">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7888745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888751">benchmarkTCP</span><span class="op" id="7888763">(</span><span class="ident" id="7888764">b</span><span class="op" id="7888765">,</span>&nbsp;<span class="builtintype" id="7888767">true</span><span class="op" id="7888771">,</span>&nbsp;<span class="builtintype" id="7888773">true</span><span class="op" id="7888777">,</span>&nbsp;<span class="string" id="7888779">&#34;[::1]:0&#34;</span><span class="op" id="7888788">)</span><br>
<span class="lineno"></span><span class="op" id="7888790">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="7888793">func</span>&nbsp;<span class="ident" id="7888798">benchmarkTCP</span><span class="op" id="7888810">(</span><span class="ident" id="7888811">b</span>&nbsp;<span class="op" id="7888813">*</span><span class="ident" id="7888814">testing</span><span class="op" id="7888821">.</span><span class="ident" id="7888822">B</span><span class="op" id="7888823">,</span>&nbsp;<span class="ident" id="7888825">persistent</span><span class="op" id="7888835">,</span>&nbsp;<span class="ident" id="7888837">timeout</span>&nbsp;<span class="builtintype" id="7888845">bool</span><span class="op" id="7888849">,</span>&nbsp;<span class="ident" id="7888851">laddr</span>&nbsp;<span class="builtintype" id="7888857">string</span><span class="op" id="7888863">)</span>&nbsp;<span class="op" id="7888865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888868">const</span>&nbsp;<span class="ident" id="7888874">msgLen</span>&nbsp;<span class="op" id="7888881">=</span>&nbsp;<span class="num" id="7888883">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888888">conns</span>&nbsp;<span class="op" id="7888894">:=</span>&nbsp;<span class="ident" id="7888897">b</span><span class="op" id="7888898">.</span><span class="ident" id="7888899">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888902">numConcurrent</span>&nbsp;<span class="op" id="7888916">:=</span>&nbsp;<span class="ident" id="7888919">runtime</span><span class="op" id="7888926">.</span><span class="ident" id="7888927">GOMAXPROCS</span><span class="op" id="7888937">(</span><span class="op" id="7888938">-</span><span class="num" id="7888939">1</span><span class="op" id="7888940">)</span>&nbsp;<span class="op" id="7888942">*</span>&nbsp;<span class="num" id="7888944">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888947">msgs</span>&nbsp;<span class="op" id="7888952">:=</span>&nbsp;<span class="num" id="7888955">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888958">if</span>&nbsp;<span class="ident" id="7888961">persistent</span>&nbsp;<span class="op" id="7888972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888976">conns</span>&nbsp;<span class="op" id="7888982">=</span>&nbsp;<span class="ident" id="7888984">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889000">msgs</span>&nbsp;<span class="op" id="7889005">=</span>&nbsp;<span class="ident" id="7889007">b</span><span class="op" id="7889008">.</span><span class="ident" id="7889009">N</span>&nbsp;<span class="op" id="7889011">/</span>&nbsp;<span class="ident" id="7889013">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889021">if</span>&nbsp;<span class="ident" id="7889024">msgs</span>&nbsp;<span class="op" id="7889029">==</span>&nbsp;<span class="num" id="7889032">0</span>&nbsp;<span class="op" id="7889034">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889039">msgs</span>&nbsp;<span class="op" id="7889044">=</span>&nbsp;<span class="num" id="7889046">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889054">if</span>&nbsp;<span class="ident" id="7889057">conns</span>&nbsp;<span class="op" id="7889063">&gt;</span>&nbsp;<span class="ident" id="7889065">b</span><span class="op" id="7889066">.</span><span class="ident" id="7889067">N</span>&nbsp;<span class="op" id="7889069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889074">conns</span>&nbsp;<span class="op" id="7889080">=</span>&nbsp;<span class="ident" id="7889082">b</span><span class="op" id="7889083">.</span><span class="ident" id="7889084">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889088">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889094">sendMsg</span>&nbsp;<span class="op" id="7889102">:=</span>&nbsp;<span class="keyword" id="7889105">func</span><span class="op" id="7889109">(</span><span class="ident" id="7889110">c</span>&nbsp;<span class="ident" id="7889112">Conn</span><span class="op" id="7889116">,</span>&nbsp;<span class="ident" id="7889118">buf</span>&nbsp;<span class="op" id="7889122">[</span><span class="op" id="7889123">]</span><span class="builtintype" id="7889124">byte</span><span class="op" id="7889128">)</span>&nbsp;<span class="builtintype" id="7889130">bool</span>&nbsp;<span class="op" id="7889135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889139">n</span><span class="op" id="7889140">,</span>&nbsp;<span class="ident" id="7889142">err</span>&nbsp;<span class="op" id="7889146">:=</span>&nbsp;<span class="ident" id="7889149">c</span><span class="op" id="7889150">.</span><span class="ident" id="7889151">Write</span><span class="op" id="7889156">(</span><span class="ident" id="7889157">buf</span><span class="op" id="7889160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889164">if</span>&nbsp;<span class="ident" id="7889167">n</span>&nbsp;<span class="op" id="7889169">!=</span>&nbsp;<span class="builtinfunc" id="7889172">len</span><span class="op" id="7889175">(</span><span class="ident" id="7889176">buf</span><span class="op" id="7889179">)</span>&nbsp;<span class="op" id="7889181">||</span>&nbsp;<span class="ident" id="7889184">err</span>&nbsp;<span class="op" id="7889188">!=</span>&nbsp;<span class="ident" id="7889191">nil</span>&nbsp;<span class="op" id="7889195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889200">b</span><span class="op" id="7889201">.</span><span class="ident" id="7889202">Logf</span><span class="op" id="7889206">(</span><span class="string" id="7889207">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7889225">,</span>&nbsp;<span class="ident" id="7889227">err</span><span class="op" id="7889230">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889235">return</span>&nbsp;<span class="builtintype" id="7889242">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889254">return</span>&nbsp;<span class="builtintype" id="7889261">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889270">recvMsg</span>&nbsp;<span class="op" id="7889278">:=</span>&nbsp;<span class="keyword" id="7889281">func</span><span class="op" id="7889285">(</span><span class="ident" id="7889286">c</span>&nbsp;<span class="ident" id="7889288">Conn</span><span class="op" id="7889292">,</span>&nbsp;<span class="ident" id="7889294">buf</span>&nbsp;<span class="op" id="7889298">[</span><span class="op" id="7889299">]</span><span class="builtintype" id="7889300">byte</span><span class="op" id="7889304">)</span>&nbsp;<span class="builtintype" id="7889306">bool</span>&nbsp;<span class="op" id="7889311">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889315">for</span>&nbsp;<span class="ident" id="7889319">read</span>&nbsp;<span class="op" id="7889324">:=</span>&nbsp;<span class="num" id="7889327">0</span><span class="op" id="7889328">;</span>&nbsp;<span class="ident" id="7889330">read</span>&nbsp;<span class="op" id="7889335">!=</span>&nbsp;<span class="builtinfunc" id="7889338">len</span><span class="op" id="7889341">(</span><span class="ident" id="7889342">buf</span><span class="op" id="7889345">)</span><span class="op" id="7889346">;</span>&nbsp;<span class="op" id="7889348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889353">n</span><span class="op" id="7889354">,</span>&nbsp;<span class="ident" id="7889356">err</span>&nbsp;<span class="op" id="7889360">:=</span>&nbsp;<span class="ident" id="7889363">c</span><span class="op" id="7889364">.</span><span class="ident" id="7889365">Read</span><span class="op" id="7889369">(</span><span class="ident" id="7889370">buf</span><span class="op" id="7889373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889378">read</span>&nbsp;<span class="op" id="7889383">+=</span>&nbsp;<span class="ident" id="7889386">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889391">if</span>&nbsp;<span class="ident" id="7889394">err</span>&nbsp;<span class="op" id="7889398">!=</span>&nbsp;<span class="ident" id="7889401">nil</span>&nbsp;<span class="op" id="7889405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889411">b</span><span class="op" id="7889412">.</span><span class="ident" id="7889413">Logf</span><span class="op" id="7889417">(</span><span class="string" id="7889418">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7889435">,</span>&nbsp;<span class="ident" id="7889437">err</span><span class="op" id="7889440">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889446">return</span>&nbsp;<span class="builtintype" id="7889453">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889470">return</span>&nbsp;<span class="builtintype" id="7889477">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889483">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889486">ln</span><span class="op" id="7889488">,</span>&nbsp;<span class="ident" id="7889490">err</span>&nbsp;<span class="op" id="7889494">:=</span>&nbsp;<span class="ident" id="7889497">Listen</span><span class="op" id="7889503">(</span><span class="string" id="7889504">&#34;tcp&#34;</span><span class="op" id="7889509">,</span>&nbsp;<span class="ident" id="7889511">laddr</span><span class="op" id="7889516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889519">if</span>&nbsp;<span class="ident" id="7889522">err</span>&nbsp;<span class="op" id="7889526">!=</span>&nbsp;<span class="ident" id="7889529">nil</span>&nbsp;<span class="op" id="7889533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889537">b</span><span class="op" id="7889538">.</span><span class="ident" id="7889539">Fatalf</span><span class="op" id="7889545">(</span><span class="string" id="7889546">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7889565">,</span>&nbsp;<span class="ident" id="7889567">err</span><span class="op" id="7889570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889576">defer</span>&nbsp;<span class="ident" id="7889582">ln</span><span class="op" id="7889584">.</span><span class="ident" id="7889585">Close</span><span class="op" id="7889590">(</span><span class="op" id="7889591">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889594">serverSem</span>&nbsp;<span class="op" id="7889604">:=</span>&nbsp;<span class="builtinfunc" id="7889607">make</span><span class="op" id="7889611">(</span><span class="keyword" id="7889612">chan</span>&nbsp;<span class="builtintype" id="7889617">bool</span><span class="op" id="7889621">,</span>&nbsp;<span class="ident" id="7889623">numConcurrent</span><span class="op" id="7889636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7889639">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889653">go</span>&nbsp;<span class="keyword" id="7889656">func</span><span class="op" id="7889660">(</span><span class="op" id="7889661">)</span>&nbsp;<span class="op" id="7889663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889667">for</span>&nbsp;<span class="op" id="7889671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889676">c</span><span class="op" id="7889677">,</span>&nbsp;<span class="ident" id="7889679">err</span>&nbsp;<span class="op" id="7889683">:=</span>&nbsp;<span class="ident" id="7889686">ln</span><span class="op" id="7889688">.</span><span class="ident" id="7889689">Accept</span><span class="op" id="7889695">(</span><span class="op" id="7889696">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889701">if</span>&nbsp;<span class="ident" id="7889704">err</span>&nbsp;<span class="op" id="7889708">!=</span>&nbsp;<span class="ident" id="7889711">nil</span>&nbsp;<span class="op" id="7889715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889721">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889735">serverSem</span>&nbsp;<span class="op" id="7889745">&lt;-</span>&nbsp;<span class="builtintype" id="7889748">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7889756">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889781">go</span>&nbsp;<span class="keyword" id="7889784">func</span><span class="op" id="7889788">(</span><span class="ident" id="7889789">c</span>&nbsp;<span class="ident" id="7889791">Conn</span><span class="op" id="7889795">)</span>&nbsp;<span class="op" id="7889797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889803">defer</span>&nbsp;<span class="keyword" id="7889809">func</span><span class="op" id="7889813">(</span><span class="op" id="7889814">)</span>&nbsp;<span class="op" id="7889816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889823">c</span><span class="op" id="7889824">.</span><span class="ident" id="7889825">Close</span><span class="op" id="7889830">(</span><span class="op" id="7889831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889838">&lt;-</span><span class="ident" id="7889840">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889854">}</span><span class="op" id="7889855">(</span><span class="op" id="7889856">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889862">if</span>&nbsp;<span class="ident" id="7889865">timeout</span>&nbsp;<span class="op" id="7889873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889880">c</span><span class="op" id="7889881">.</span><span class="ident" id="7889882">SetDeadline</span><span class="op" id="7889893">(</span><span class="ident" id="7889894">time</span><span class="op" id="7889898">.</span><span class="ident" id="7889899">Now</span><span class="op" id="7889902">(</span><span class="op" id="7889903">)</span><span class="op" id="7889904">.</span><span class="ident" id="7889905">Add</span><span class="op" id="7889908">(</span><span class="ident" id="7889909">time</span><span class="op" id="7889913">.</span><span class="ident" id="7889914">Hour</span><span class="op" id="7889918">)</span><span class="op" id="7889919">)</span>&nbsp;<span class="comment" id="7889921">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889956">var</span>&nbsp;<span class="ident" id="7889960">buf</span>&nbsp;<span class="op" id="7889964">[</span><span class="ident" id="7889965">msgLen</span><span class="op" id="7889971">]</span><span class="builtintype" id="7889972">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889981">for</span>&nbsp;<span class="ident" id="7889985">m</span>&nbsp;<span class="op" id="7889987">:=</span>&nbsp;<span class="num" id="7889990">0</span><span class="op" id="7889991">;</span>&nbsp;<span class="ident" id="7889993">m</span>&nbsp;<span class="op" id="7889995">&lt;</span>&nbsp;<span class="ident" id="7889997">msgs</span><span class="op" id="7890001">;</span>&nbsp;<span class="ident" id="7890003">m</span><span class="op" id="7890004">++</span>&nbsp;<span class="op" id="7890007">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890014">if</span>&nbsp;<span class="op" id="7890017">!</span><span class="ident" id="7890018">recvMsg</span><span class="op" id="7890025">(</span><span class="ident" id="7890026">c</span><span class="op" id="7890027">,</span>&nbsp;<span class="ident" id="7890029">buf</span><span class="op" id="7890032">[</span><span class="op" id="7890033">:</span><span class="op" id="7890034">]</span><span class="op" id="7890035">)</span>&nbsp;<span class="op" id="7890037">||</span>&nbsp;<span class="op" id="7890040">!</span><span class="ident" id="7890041">sendMsg</span><span class="op" id="7890048">(</span><span class="ident" id="7890049">c</span><span class="op" id="7890050">,</span>&nbsp;<span class="ident" id="7890052">buf</span><span class="op" id="7890055">[</span><span class="op" id="7890056">:</span><span class="op" id="7890057">]</span><span class="op" id="7890058">)</span>&nbsp;<span class="op" id="7890060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890068">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890090">}</span><span class="op" id="7890091">(</span><span class="ident" id="7890092">c</span><span class="op" id="7890093">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890100">}</span><span class="op" id="7890101">(</span><span class="op" id="7890102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890105">clientSem</span>&nbsp;<span class="op" id="7890115">:=</span>&nbsp;<span class="builtinfunc" id="7890118">make</span><span class="op" id="7890122">(</span><span class="keyword" id="7890123">chan</span>&nbsp;<span class="builtintype" id="7890128">bool</span><span class="op" id="7890132">,</span>&nbsp;<span class="ident" id="7890134">numConcurrent</span><span class="op" id="7890147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890150">for</span>&nbsp;<span class="ident" id="7890154">i</span>&nbsp;<span class="op" id="7890156">:=</span>&nbsp;<span class="num" id="7890159">0</span><span class="op" id="7890160">;</span>&nbsp;<span class="ident" id="7890162">i</span>&nbsp;<span class="op" id="7890164">&lt;</span>&nbsp;<span class="ident" id="7890166">conns</span><span class="op" id="7890171">;</span>&nbsp;<span class="ident" id="7890173">i</span><span class="op" id="7890174">++</span>&nbsp;<span class="op" id="7890177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890181">clientSem</span>&nbsp;<span class="op" id="7890191">&lt;-</span>&nbsp;<span class="builtintype" id="7890194">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7890201">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890225">go</span>&nbsp;<span class="keyword" id="7890228">func</span><span class="op" id="7890232">(</span><span class="op" id="7890233">)</span>&nbsp;<span class="op" id="7890235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890240">defer</span>&nbsp;<span class="keyword" id="7890246">func</span><span class="op" id="7890250">(</span><span class="op" id="7890251">)</span>&nbsp;<span class="op" id="7890253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890259">&lt;-</span><span class="ident" id="7890261">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890274">}</span><span class="op" id="7890275">(</span><span class="op" id="7890276">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890281">c</span><span class="op" id="7890282">,</span>&nbsp;<span class="ident" id="7890284">err</span>&nbsp;<span class="op" id="7890288">:=</span>&nbsp;<span class="ident" id="7890291">Dial</span><span class="op" id="7890295">(</span><span class="string" id="7890296">&#34;tcp&#34;</span><span class="op" id="7890301">,</span>&nbsp;<span class="ident" id="7890303">ln</span><span class="op" id="7890305">.</span><span class="ident" id="7890306">Addr</span><span class="op" id="7890310">(</span><span class="op" id="7890311">)</span><span class="op" id="7890312">.</span><span class="ident" id="7890313">String</span><span class="op" id="7890319">(</span><span class="op" id="7890320">)</span><span class="op" id="7890321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890326">if</span>&nbsp;<span class="ident" id="7890329">err</span>&nbsp;<span class="op" id="7890333">!=</span>&nbsp;<span class="ident" id="7890336">nil</span>&nbsp;<span class="op" id="7890340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890346">b</span><span class="op" id="7890347">.</span><span class="ident" id="7890348">Logf</span><span class="op" id="7890352">(</span><span class="string" id="7890353">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7890370">,</span>&nbsp;<span class="ident" id="7890372">err</span><span class="op" id="7890375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890381">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890391">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890396">defer</span>&nbsp;<span class="ident" id="7890402">c</span><span class="op" id="7890403">.</span><span class="ident" id="7890404">Close</span><span class="op" id="7890409">(</span><span class="op" id="7890410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890415">if</span>&nbsp;<span class="ident" id="7890418">timeout</span>&nbsp;<span class="op" id="7890426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890432">c</span><span class="op" id="7890433">.</span><span class="ident" id="7890434">SetDeadline</span><span class="op" id="7890445">(</span><span class="ident" id="7890446">time</span><span class="op" id="7890450">.</span><span class="ident" id="7890451">Now</span><span class="op" id="7890454">(</span><span class="op" id="7890455">)</span><span class="op" id="7890456">.</span><span class="ident" id="7890457">Add</span><span class="op" id="7890460">(</span><span class="ident" id="7890461">time</span><span class="op" id="7890465">.</span><span class="ident" id="7890466">Hour</span><span class="op" id="7890470">)</span><span class="op" id="7890471">)</span>&nbsp;<span class="comment" id="7890473">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890506">var</span>&nbsp;<span class="ident" id="7890510">buf</span>&nbsp;<span class="op" id="7890514">[</span><span class="ident" id="7890515">msgLen</span><span class="op" id="7890521">]</span><span class="builtintype" id="7890522">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890530">for</span>&nbsp;<span class="ident" id="7890534">m</span>&nbsp;<span class="op" id="7890536">:=</span>&nbsp;<span class="num" id="7890539">0</span><span class="op" id="7890540">;</span>&nbsp;<span class="ident" id="7890542">m</span>&nbsp;<span class="op" id="7890544">&lt;</span>&nbsp;<span class="ident" id="7890546">msgs</span><span class="op" id="7890550">;</span>&nbsp;<span class="ident" id="7890552">m</span><span class="op" id="7890553">++</span>&nbsp;<span class="op" id="7890556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890562">if</span>&nbsp;<span class="op" id="7890565">!</span><span class="ident" id="7890566">sendMsg</span><span class="op" id="7890573">(</span><span class="ident" id="7890574">c</span><span class="op" id="7890575">,</span>&nbsp;<span class="ident" id="7890577">buf</span><span class="op" id="7890580">[</span><span class="op" id="7890581">:</span><span class="op" id="7890582">]</span><span class="op" id="7890583">)</span>&nbsp;<span class="op" id="7890585">||</span>&nbsp;<span class="op" id="7890588">!</span><span class="ident" id="7890589">recvMsg</span><span class="op" id="7890596">(</span><span class="ident" id="7890597">c</span><span class="op" id="7890598">,</span>&nbsp;<span class="ident" id="7890600">buf</span><span class="op" id="7890603">[</span><span class="op" id="7890604">:</span><span class="op" id="7890605">]</span><span class="op" id="7890606">)</span>&nbsp;<span class="op" id="7890608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890615">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890630">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890634">}</span><span class="op" id="7890635">(</span><span class="op" id="7890636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890642">for</span>&nbsp;<span class="ident" id="7890646">i</span>&nbsp;<span class="op" id="7890648">:=</span>&nbsp;<span class="num" id="7890651">0</span><span class="op" id="7890652">;</span>&nbsp;<span class="ident" id="7890654">i</span>&nbsp;<span class="op" id="7890656">&lt;</span>&nbsp;<span class="ident" id="7890658">numConcurrent</span><span class="op" id="7890671">;</span>&nbsp;<span class="ident" id="7890673">i</span><span class="op" id="7890674">++</span>&nbsp;<span class="op" id="7890677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890681">clientSem</span>&nbsp;<span class="op" id="7890691">&lt;-</span>&nbsp;<span class="builtintype" id="7890694">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890701">serverSem</span>&nbsp;<span class="op" id="7890711">&lt;-</span>&nbsp;<span class="builtintype" id="7890714">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890720">}</span><br>
<span class="lineno"></span><span class="op" id="7890722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7890725">func</span>&nbsp;<span class="ident" id="7890730">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="7890762">(</span><span class="ident" id="7890763">b</span>&nbsp;<span class="op" id="7890765">*</span><span class="ident" id="7890766">testing</span><span class="op" id="7890773">.</span><span class="ident" id="7890774">B</span><span class="op" id="7890775">)</span>&nbsp;<span class="op" id="7890777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890780">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7890811">(</span><span class="ident" id="7890812">b</span><span class="op" id="7890813">,</span>&nbsp;<span class="string" id="7890815">&#34;127.0.0.1:0&#34;</span><span class="op" id="7890828">)</span><br>
<span class="lineno">160</span><span class="op" id="7890830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7890833">func</span>&nbsp;<span class="ident" id="7890838">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="7890870">(</span><span class="ident" id="7890871">b</span>&nbsp;<span class="op" id="7890873">*</span><span class="ident" id="7890874">testing</span><span class="op" id="7890881">.</span><span class="ident" id="7890882">B</span><span class="op" id="7890883">)</span>&nbsp;<span class="op" id="7890885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890888">if</span>&nbsp;<span class="op" id="7890891">!</span><span class="ident" id="7890892">supportsIPv6</span>&nbsp;<span class="op" id="7890905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890909">b</span><span class="op" id="7890910">.</span><span class="ident" id="7890911">Skip</span><span class="op" id="7890915">(</span><span class="string" id="7890916">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7890939">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890945">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7890976">(</span><span class="ident" id="7890977">b</span><span class="op" id="7890978">,</span>&nbsp;<span class="string" id="7890980">&#34;[::1]:0&#34;</span><span class="op" id="7890989">)</span><br>
<span class="lineno"></span><span class="op" id="7890991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7890994">func</span>&nbsp;<span class="ident" id="7890999">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7891030">(</span><span class="ident" id="7891031">b</span>&nbsp;<span class="op" id="7891033">*</span><span class="ident" id="7891034">testing</span><span class="op" id="7891041">.</span><span class="ident" id="7891042">B</span><span class="op" id="7891043">,</span>&nbsp;<span class="ident" id="7891045">laddr</span>&nbsp;<span class="builtintype" id="7891051">string</span><span class="op" id="7891057">)</span>&nbsp;<span class="op" id="7891059">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891062">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891120">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891203">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891285">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891336">b</span><span class="op" id="7891337">.</span><span class="ident" id="7891338">StopTimer</span><span class="op" id="7891347">(</span><span class="op" id="7891348">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891352">P</span>&nbsp;<span class="op" id="7891354">:=</span>&nbsp;<span class="ident" id="7891357">runtime</span><span class="op" id="7891364">.</span><span class="ident" id="7891365">GOMAXPROCS</span><span class="op" id="7891375">(</span><span class="num" id="7891376">0</span><span class="op" id="7891377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891380">N</span>&nbsp;<span class="op" id="7891382">:=</span>&nbsp;<span class="ident" id="7891385">b</span><span class="op" id="7891386">.</span><span class="ident" id="7891387">N</span>&nbsp;<span class="op" id="7891389">/</span>&nbsp;<span class="ident" id="7891391">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891394">W</span>&nbsp;<span class="op" id="7891396">:=</span>&nbsp;<span class="num" id="7891399">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7891406">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891445">clients</span>&nbsp;<span class="op" id="7891453">:=</span>&nbsp;<span class="builtinfunc" id="7891456">make</span><span class="op" id="7891460">(</span><span class="op" id="7891461">[</span><span class="op" id="7891462">]</span><span class="ident" id="7891463">Conn</span><span class="op" id="7891467">,</span>&nbsp;<span class="ident" id="7891469">P</span><span class="op" id="7891470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891473">servers</span>&nbsp;<span class="op" id="7891481">:=</span>&nbsp;<span class="builtinfunc" id="7891484">make</span><span class="op" id="7891488">(</span><span class="op" id="7891489">[</span><span class="op" id="7891490">]</span><span class="ident" id="7891491">Conn</span><span class="op" id="7891495">,</span>&nbsp;<span class="ident" id="7891497">P</span><span class="op" id="7891498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891501">ln</span><span class="op" id="7891503">,</span>&nbsp;<span class="ident" id="7891505">err</span>&nbsp;<span class="op" id="7891509">:=</span>&nbsp;<span class="ident" id="7891512">Listen</span><span class="op" id="7891518">(</span><span class="string" id="7891519">&#34;tcp&#34;</span><span class="op" id="7891524">,</span>&nbsp;<span class="ident" id="7891526">laddr</span><span class="op" id="7891531">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891534">if</span>&nbsp;<span class="ident" id="7891537">err</span>&nbsp;<span class="op" id="7891541">!=</span>&nbsp;<span class="ident" id="7891544">nil</span>&nbsp;<span class="op" id="7891548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891552">b</span><span class="op" id="7891553">.</span><span class="ident" id="7891554">Fatalf</span><span class="op" id="7891560">(</span><span class="string" id="7891561">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7891580">,</span>&nbsp;<span class="ident" id="7891582">err</span><span class="op" id="7891585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891591">defer</span>&nbsp;<span class="ident" id="7891597">ln</span><span class="op" id="7891599">.</span><span class="ident" id="7891600">Close</span><span class="op" id="7891605">(</span><span class="op" id="7891606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891609">done</span>&nbsp;<span class="op" id="7891614">:=</span>&nbsp;<span class="builtinfunc" id="7891617">make</span><span class="op" id="7891621">(</span><span class="keyword" id="7891622">chan</span>&nbsp;<span class="builtintype" id="7891627">bool</span><span class="op" id="7891631">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891634">go</span>&nbsp;<span class="keyword" id="7891637">func</span><span class="op" id="7891641">(</span><span class="op" id="7891642">)</span>&nbsp;<span class="op" id="7891644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891648">for</span>&nbsp;<span class="ident" id="7891652">p</span>&nbsp;<span class="op" id="7891654">:=</span>&nbsp;<span class="num" id="7891657">0</span><span class="op" id="7891658">;</span>&nbsp;<span class="ident" id="7891660">p</span>&nbsp;<span class="op" id="7891662">&lt;</span>&nbsp;<span class="ident" id="7891664">P</span><span class="op" id="7891665">;</span>&nbsp;<span class="ident" id="7891667">p</span><span class="op" id="7891668">++</span>&nbsp;<span class="op" id="7891671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891676">s</span><span class="op" id="7891677">,</span>&nbsp;<span class="ident" id="7891679">err</span>&nbsp;<span class="op" id="7891683">:=</span>&nbsp;<span class="ident" id="7891686">ln</span><span class="op" id="7891688">.</span><span class="ident" id="7891689">Accept</span><span class="op" id="7891695">(</span><span class="op" id="7891696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891701">if</span>&nbsp;<span class="ident" id="7891704">err</span>&nbsp;<span class="op" id="7891708">!=</span>&nbsp;<span class="ident" id="7891711">nil</span>&nbsp;<span class="op" id="7891715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891721">b</span><span class="op" id="7891722">.</span><span class="ident" id="7891723">Errorf</span><span class="op" id="7891729">(</span><span class="string" id="7891730">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7891749">,</span>&nbsp;<span class="ident" id="7891751">err</span><span class="op" id="7891754">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891760">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891775">servers</span><span class="op" id="7891782">[</span><span class="ident" id="7891783">p</span><span class="op" id="7891784">]</span>&nbsp;<span class="op" id="7891786">=</span>&nbsp;<span class="ident" id="7891788">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891796">done</span>&nbsp;<span class="op" id="7891801">&lt;-</span>&nbsp;<span class="builtintype" id="7891804">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891810">}</span><span class="op" id="7891811">(</span><span class="op" id="7891812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891815">for</span>&nbsp;<span class="ident" id="7891819">p</span>&nbsp;<span class="op" id="7891821">:=</span>&nbsp;<span class="num" id="7891824">0</span><span class="op" id="7891825">;</span>&nbsp;<span class="ident" id="7891827">p</span>&nbsp;<span class="op" id="7891829">&lt;</span>&nbsp;<span class="ident" id="7891831">P</span><span class="op" id="7891832">;</span>&nbsp;<span class="ident" id="7891834">p</span><span class="op" id="7891835">++</span>&nbsp;<span class="op" id="7891838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891842">c</span><span class="op" id="7891843">,</span>&nbsp;<span class="ident" id="7891845">err</span>&nbsp;<span class="op" id="7891849">:=</span>&nbsp;<span class="ident" id="7891852">Dial</span><span class="op" id="7891856">(</span><span class="string" id="7891857">&#34;tcp&#34;</span><span class="op" id="7891862">,</span>&nbsp;<span class="ident" id="7891864">ln</span><span class="op" id="7891866">.</span><span class="ident" id="7891867">Addr</span><span class="op" id="7891871">(</span><span class="op" id="7891872">)</span><span class="op" id="7891873">.</span><span class="ident" id="7891874">String</span><span class="op" id="7891880">(</span><span class="op" id="7891881">)</span><span class="op" id="7891882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891886">if</span>&nbsp;<span class="ident" id="7891889">err</span>&nbsp;<span class="op" id="7891893">!=</span>&nbsp;<span class="ident" id="7891896">nil</span>&nbsp;<span class="op" id="7891900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891905">b</span><span class="op" id="7891906">.</span><span class="ident" id="7891907">Fatalf</span><span class="op" id="7891913">(</span><span class="string" id="7891914">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7891931">,</span>&nbsp;<span class="ident" id="7891933">err</span><span class="op" id="7891936">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891944">clients</span><span class="op" id="7891951">[</span><span class="ident" id="7891952">p</span><span class="op" id="7891953">]</span>&nbsp;<span class="op" id="7891955">=</span>&nbsp;<span class="ident" id="7891957">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7891963">&lt;-</span><span class="ident" id="7891965">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7891972">b</span><span class="op" id="7891973">.</span><span class="ident" id="7891974">StartTimer</span><span class="op" id="7891984">(</span><span class="op" id="7891985">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7891989">var</span>&nbsp;<span class="ident" id="7891993">wg</span>&nbsp;<span class="ident" id="7891996">sync</span><span class="op" id="7892000">.</span><span class="ident" id="7892001">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892012">wg</span><span class="op" id="7892014">.</span><span class="ident" id="7892015">Add</span><span class="op" id="7892018">(</span><span class="num" id="7892019">4</span>&nbsp;<span class="op" id="7892021">*</span>&nbsp;<span class="ident" id="7892023">P</span><span class="op" id="7892024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892027">for</span>&nbsp;<span class="ident" id="7892031">p</span>&nbsp;<span class="op" id="7892033">:=</span>&nbsp;<span class="num" id="7892036">0</span><span class="op" id="7892037">;</span>&nbsp;<span class="ident" id="7892039">p</span>&nbsp;<span class="op" id="7892041">&lt;</span>&nbsp;<span class="ident" id="7892043">P</span><span class="op" id="7892044">;</span>&nbsp;<span class="ident" id="7892046">p</span><span class="op" id="7892047">++</span>&nbsp;<span class="op" id="7892050">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7892054">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892074">go</span>&nbsp;<span class="keyword" id="7892077">func</span><span class="op" id="7892081">(</span><span class="ident" id="7892082">c</span>&nbsp;<span class="ident" id="7892084">Conn</span><span class="op" id="7892088">)</span>&nbsp;<span class="op" id="7892090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892095">defer</span>&nbsp;<span class="ident" id="7892101">wg</span><span class="op" id="7892103">.</span><span class="ident" id="7892104">Done</span><span class="op" id="7892108">(</span><span class="op" id="7892109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892114">var</span>&nbsp;<span class="ident" id="7892118">buf</span>&nbsp;<span class="op" id="7892122">[</span><span class="num" id="7892123">1</span><span class="op" id="7892124">]</span><span class="builtintype" id="7892125">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892133">for</span>&nbsp;<span class="ident" id="7892137">i</span>&nbsp;<span class="op" id="7892139">:=</span>&nbsp;<span class="num" id="7892142">0</span><span class="op" id="7892143">;</span>&nbsp;<span class="ident" id="7892145">i</span>&nbsp;<span class="op" id="7892147">&lt;</span>&nbsp;<span class="ident" id="7892149">N</span><span class="op" id="7892150">;</span>&nbsp;<span class="ident" id="7892152">i</span><span class="op" id="7892153">++</span>&nbsp;<span class="op" id="7892156">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892162">v</span>&nbsp;<span class="op" id="7892164">:=</span>&nbsp;<span class="builtintype" id="7892167">byte</span><span class="op" id="7892171">(</span><span class="ident" id="7892172">i</span><span class="op" id="7892173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892179">for</span>&nbsp;<span class="ident" id="7892183">w</span>&nbsp;<span class="op" id="7892185">:=</span>&nbsp;<span class="num" id="7892188">0</span><span class="op" id="7892189">;</span>&nbsp;<span class="ident" id="7892191">w</span>&nbsp;<span class="op" id="7892193">&lt;</span>&nbsp;<span class="ident" id="7892195">W</span><span class="op" id="7892196">;</span>&nbsp;<span class="ident" id="7892198">w</span><span class="op" id="7892199">++</span>&nbsp;<span class="op" id="7892202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892209">v</span>&nbsp;<span class="op" id="7892211">*=</span>&nbsp;<span class="ident" id="7892214">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892226">buf</span><span class="op" id="7892229">[</span><span class="num" id="7892230">0</span><span class="op" id="7892231">]</span>&nbsp;<span class="op" id="7892233">=</span>&nbsp;<span class="ident" id="7892235">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892241">_</span><span class="op" id="7892242">,</span>&nbsp;<span class="ident" id="7892244">err</span>&nbsp;<span class="op" id="7892248">:=</span>&nbsp;<span class="ident" id="7892251">c</span><span class="op" id="7892252">.</span><span class="ident" id="7892253">Write</span><span class="op" id="7892258">(</span><span class="ident" id="7892259">buf</span><span class="op" id="7892262">[</span><span class="op" id="7892263">:</span><span class="op" id="7892264">]</span><span class="op" id="7892265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892271">if</span>&nbsp;<span class="ident" id="7892274">err</span>&nbsp;<span class="op" id="7892278">!=</span>&nbsp;<span class="ident" id="7892281">nil</span>&nbsp;<span class="op" id="7892285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892292">b</span><span class="op" id="7892293">.</span><span class="ident" id="7892294">Errorf</span><span class="op" id="7892300">(</span><span class="string" id="7892301">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7892319">,</span>&nbsp;<span class="ident" id="7892321">err</span><span class="op" id="7892324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892331">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892342">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892351">}</span><span class="op" id="7892352">(</span><span class="ident" id="7892353">clients</span><span class="op" id="7892360">[</span><span class="ident" id="7892361">p</span><span class="op" id="7892362">]</span><span class="op" id="7892363">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7892368">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892419">pipe</span>&nbsp;<span class="op" id="7892424">:=</span>&nbsp;<span class="builtinfunc" id="7892427">make</span><span class="op" id="7892431">(</span><span class="keyword" id="7892432">chan</span>&nbsp;<span class="builtintype" id="7892437">byte</span><span class="op" id="7892441">,</span>&nbsp;<span class="num" id="7892443">128</span><span class="op" id="7892446">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7892451">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892471">go</span>&nbsp;<span class="keyword" id="7892474">func</span><span class="op" id="7892478">(</span><span class="ident" id="7892479">s</span>&nbsp;<span class="ident" id="7892481">Conn</span><span class="op" id="7892485">)</span>&nbsp;<span class="op" id="7892487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892492">defer</span>&nbsp;<span class="ident" id="7892498">wg</span><span class="op" id="7892500">.</span><span class="ident" id="7892501">Done</span><span class="op" id="7892505">(</span><span class="op" id="7892506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892511">var</span>&nbsp;<span class="ident" id="7892515">buf</span>&nbsp;<span class="op" id="7892519">[</span><span class="num" id="7892520">1</span><span class="op" id="7892521">]</span><span class="builtintype" id="7892522">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892530">for</span>&nbsp;<span class="ident" id="7892534">i</span>&nbsp;<span class="op" id="7892536">:=</span>&nbsp;<span class="num" id="7892539">0</span><span class="op" id="7892540">;</span>&nbsp;<span class="ident" id="7892542">i</span>&nbsp;<span class="op" id="7892544">&lt;</span>&nbsp;<span class="ident" id="7892546">N</span><span class="op" id="7892547">;</span>&nbsp;<span class="ident" id="7892549">i</span><span class="op" id="7892550">++</span>&nbsp;<span class="op" id="7892553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892559">_</span><span class="op" id="7892560">,</span>&nbsp;<span class="ident" id="7892562">err</span>&nbsp;<span class="op" id="7892566">:=</span>&nbsp;<span class="ident" id="7892569">s</span><span class="op" id="7892570">.</span><span class="ident" id="7892571">Read</span><span class="op" id="7892575">(</span><span class="ident" id="7892576">buf</span><span class="op" id="7892579">[</span><span class="op" id="7892580">:</span><span class="op" id="7892581">]</span><span class="op" id="7892582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892588">if</span>&nbsp;<span class="ident" id="7892591">err</span>&nbsp;<span class="op" id="7892595">!=</span>&nbsp;<span class="ident" id="7892598">nil</span>&nbsp;<span class="op" id="7892602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892609">b</span><span class="op" id="7892610">.</span><span class="ident" id="7892611">Errorf</span><span class="op" id="7892617">(</span><span class="string" id="7892618">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7892635">,</span>&nbsp;<span class="ident" id="7892637">err</span><span class="op" id="7892640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892647">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892664">pipe</span>&nbsp;<span class="op" id="7892669">&lt;-</span>&nbsp;<span class="ident" id="7892672">buf</span><span class="op" id="7892675">[</span><span class="num" id="7892676">0</span><span class="op" id="7892677">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892686">}</span><span class="op" id="7892687">(</span><span class="ident" id="7892688">servers</span><span class="op" id="7892695">[</span><span class="ident" id="7892696">p</span><span class="op" id="7892697">]</span><span class="op" id="7892698">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7892703">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892723">go</span>&nbsp;<span class="keyword" id="7892726">func</span><span class="op" id="7892730">(</span><span class="ident" id="7892731">s</span>&nbsp;<span class="ident" id="7892733">Conn</span><span class="op" id="7892737">)</span>&nbsp;<span class="op" id="7892739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892744">defer</span>&nbsp;<span class="ident" id="7892750">wg</span><span class="op" id="7892752">.</span><span class="ident" id="7892753">Done</span><span class="op" id="7892757">(</span><span class="op" id="7892758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892763">var</span>&nbsp;<span class="ident" id="7892767">buf</span>&nbsp;<span class="op" id="7892771">[</span><span class="num" id="7892772">1</span><span class="op" id="7892773">]</span><span class="builtintype" id="7892774">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892782">for</span>&nbsp;<span class="ident" id="7892786">i</span>&nbsp;<span class="op" id="7892788">:=</span>&nbsp;<span class="num" id="7892791">0</span><span class="op" id="7892792">;</span>&nbsp;<span class="ident" id="7892794">i</span>&nbsp;<span class="op" id="7892796">&lt;</span>&nbsp;<span class="ident" id="7892798">N</span><span class="op" id="7892799">;</span>&nbsp;<span class="ident" id="7892801">i</span><span class="op" id="7892802">++</span>&nbsp;<span class="op" id="7892805">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892811">v</span>&nbsp;<span class="op" id="7892813">:=</span>&nbsp;<span class="op" id="7892816">&lt;-</span><span class="ident" id="7892818">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892827">for</span>&nbsp;<span class="ident" id="7892831">w</span>&nbsp;<span class="op" id="7892833">:=</span>&nbsp;<span class="num" id="7892836">0</span><span class="op" id="7892837">;</span>&nbsp;<span class="ident" id="7892839">w</span>&nbsp;<span class="op" id="7892841">&lt;</span>&nbsp;<span class="ident" id="7892843">W</span><span class="op" id="7892844">;</span>&nbsp;<span class="ident" id="7892846">w</span><span class="op" id="7892847">++</span>&nbsp;<span class="op" id="7892850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892857">v</span>&nbsp;<span class="op" id="7892859">*=</span>&nbsp;<span class="ident" id="7892862">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892874">buf</span><span class="op" id="7892877">[</span><span class="num" id="7892878">0</span><span class="op" id="7892879">]</span>&nbsp;<span class="op" id="7892881">=</span>&nbsp;<span class="ident" id="7892883">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892889">_</span><span class="op" id="7892890">,</span>&nbsp;<span class="ident" id="7892892">err</span>&nbsp;<span class="op" id="7892896">:=</span>&nbsp;<span class="ident" id="7892899">s</span><span class="op" id="7892900">.</span><span class="ident" id="7892901">Write</span><span class="op" id="7892906">(</span><span class="ident" id="7892907">buf</span><span class="op" id="7892910">[</span><span class="op" id="7892911">:</span><span class="op" id="7892912">]</span><span class="op" id="7892913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892919">if</span>&nbsp;<span class="ident" id="7892922">err</span>&nbsp;<span class="op" id="7892926">!=</span>&nbsp;<span class="ident" id="7892929">nil</span>&nbsp;<span class="op" id="7892933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892940">b</span><span class="op" id="7892941">.</span><span class="ident" id="7892942">Errorf</span><span class="op" id="7892948">(</span><span class="string" id="7892949">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7892967">,</span>&nbsp;<span class="ident" id="7892969">err</span><span class="op" id="7892972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892979">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892990">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893000">s</span><span class="op" id="7893001">.</span><span class="ident" id="7893002">Close</span><span class="op" id="7893007">(</span><span class="op" id="7893008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893012">}</span><span class="op" id="7893013">(</span><span class="ident" id="7893014">servers</span><span class="op" id="7893021">[</span><span class="ident" id="7893022">p</span><span class="op" id="7893023">]</span><span class="op" id="7893024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7893029">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893049">go</span>&nbsp;<span class="keyword" id="7893052">func</span><span class="op" id="7893056">(</span><span class="ident" id="7893057">c</span>&nbsp;<span class="ident" id="7893059">Conn</span><span class="op" id="7893063">)</span>&nbsp;<span class="op" id="7893065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893070">defer</span>&nbsp;<span class="ident" id="7893076">wg</span><span class="op" id="7893078">.</span><span class="ident" id="7893079">Done</span><span class="op" id="7893083">(</span><span class="op" id="7893084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893089">var</span>&nbsp;<span class="ident" id="7893093">buf</span>&nbsp;<span class="op" id="7893097">[</span><span class="num" id="7893098">1</span><span class="op" id="7893099">]</span><span class="builtintype" id="7893100">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893108">for</span>&nbsp;<span class="ident" id="7893112">i</span>&nbsp;<span class="op" id="7893114">:=</span>&nbsp;<span class="num" id="7893117">0</span><span class="op" id="7893118">;</span>&nbsp;<span class="ident" id="7893120">i</span>&nbsp;<span class="op" id="7893122">&lt;</span>&nbsp;<span class="ident" id="7893124">N</span><span class="op" id="7893125">;</span>&nbsp;<span class="ident" id="7893127">i</span><span class="op" id="7893128">++</span>&nbsp;<span class="op" id="7893131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893137">_</span><span class="op" id="7893138">,</span>&nbsp;<span class="ident" id="7893140">err</span>&nbsp;<span class="op" id="7893144">:=</span>&nbsp;<span class="ident" id="7893147">c</span><span class="op" id="7893148">.</span><span class="ident" id="7893149">Read</span><span class="op" id="7893153">(</span><span class="ident" id="7893154">buf</span><span class="op" id="7893157">[</span><span class="op" id="7893158">:</span><span class="op" id="7893159">]</span><span class="op" id="7893160">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893166">if</span>&nbsp;<span class="ident" id="7893169">err</span>&nbsp;<span class="op" id="7893173">!=</span>&nbsp;<span class="ident" id="7893176">nil</span>&nbsp;<span class="op" id="7893180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893187">b</span><span class="op" id="7893188">.</span><span class="ident" id="7893189">Errorf</span><span class="op" id="7893195">(</span><span class="string" id="7893196">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7893213">,</span>&nbsp;<span class="ident" id="7893215">err</span><span class="op" id="7893218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893241">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893246">c</span><span class="op" id="7893247">.</span><span class="ident" id="7893248">Close</span><span class="op" id="7893253">(</span><span class="op" id="7893254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893258">}</span><span class="op" id="7893259">(</span><span class="ident" id="7893260">clients</span><span class="op" id="7893267">[</span><span class="ident" id="7893268">p</span><span class="op" id="7893269">]</span><span class="op" id="7893270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893276">wg</span><span class="op" id="7893278">.</span><span class="ident" id="7893279">Wait</span><span class="op" id="7893283">(</span><span class="op" id="7893284">)</span><br>
<span class="lineno"></span><span class="op" id="7893286">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="7893289">type</span>&nbsp;<span class="ident" id="7893294">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="7893313">struct</span>&nbsp;<span class="op" id="7893320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893323">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7893337">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893345">litAddrOrName</span>&nbsp;<span class="builtintype" id="7893359">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893367">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7893381">*</span><span class="ident" id="7893382">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893391">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7893405">error</span><br>
<span class="lineno"></span><span class="op" id="7893411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7893414">var</span>&nbsp;<span class="ident" id="7893418">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7893438">=</span>&nbsp;<span class="op" id="7893440">[</span><span class="op" id="7893441">]</span><span class="ident" id="7893442">resolveTCPAddrTest</span><span class="op" id="7893460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893463">{</span><span class="string" id="7893464">&#34;tcp&#34;</span><span class="op" id="7893469">,</span>&nbsp;<span class="string" id="7893471">&#34;127.0.0.1:0&#34;</span><span class="op" id="7893484">,</span>&nbsp;<span class="op" id="7893486">&amp;</span><span class="ident" id="7893487">TCPAddr</span><span class="op" id="7893494">{</span><span class="ident" id="7893495">IP</span><span class="op" id="7893497">:</span>&nbsp;<span class="ident" id="7893499">IPv4</span><span class="op" id="7893503">(</span><span class="num" id="7893504">127</span><span class="op" id="7893507">,</span>&nbsp;<span class="num" id="7893509">0</span><span class="op" id="7893510">,</span>&nbsp;<span class="num" id="7893512">0</span><span class="op" id="7893513">,</span>&nbsp;<span class="num" id="7893515">1</span><span class="op" id="7893516">)</span><span class="op" id="7893517">,</span>&nbsp;<span class="ident" id="7893519">Port</span><span class="op" id="7893523">:</span>&nbsp;<span class="num" id="7893525">0</span><span class="op" id="7893526">}</span><span class="op" id="7893527">,</span>&nbsp;<span class="ident" id="7893529">nil</span><span class="op" id="7893532">}</span><span class="op" id="7893533">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893536">{</span><span class="string" id="7893537">&#34;tcp4&#34;</span><span class="op" id="7893543">,</span>&nbsp;<span class="string" id="7893545">&#34;127.0.0.1:65535&#34;</span><span class="op" id="7893562">,</span>&nbsp;<span class="op" id="7893564">&amp;</span><span class="ident" id="7893565">TCPAddr</span><span class="op" id="7893572">{</span><span class="ident" id="7893573">IP</span><span class="op" id="7893575">:</span>&nbsp;<span class="ident" id="7893577">IPv4</span><span class="op" id="7893581">(</span><span class="num" id="7893582">127</span><span class="op" id="7893585">,</span>&nbsp;<span class="num" id="7893587">0</span><span class="op" id="7893588">,</span>&nbsp;<span class="num" id="7893590">0</span><span class="op" id="7893591">,</span>&nbsp;<span class="num" id="7893593">1</span><span class="op" id="7893594">)</span><span class="op" id="7893595">,</span>&nbsp;<span class="ident" id="7893597">Port</span><span class="op" id="7893601">:</span>&nbsp;<span class="num" id="7893603">65535</span><span class="op" id="7893608">}</span><span class="op" id="7893609">,</span>&nbsp;<span class="ident" id="7893611">nil</span><span class="op" id="7893614">}</span><span class="op" id="7893615">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893619">{</span><span class="string" id="7893620">&#34;tcp&#34;</span><span class="op" id="7893625">,</span>&nbsp;<span class="string" id="7893627">&#34;[::1]:1&#34;</span><span class="op" id="7893636">,</span>&nbsp;<span class="op" id="7893638">&amp;</span><span class="ident" id="7893639">TCPAddr</span><span class="op" id="7893646">{</span><span class="ident" id="7893647">IP</span><span class="op" id="7893649">:</span>&nbsp;<span class="ident" id="7893651">ParseIP</span><span class="op" id="7893658">(</span><span class="string" id="7893659">&#34;::1&#34;</span><span class="op" id="7893664">)</span><span class="op" id="7893665">,</span>&nbsp;<span class="ident" id="7893667">Port</span><span class="op" id="7893671">:</span>&nbsp;<span class="num" id="7893673">1</span><span class="op" id="7893674">}</span><span class="op" id="7893675">,</span>&nbsp;<span class="ident" id="7893677">nil</span><span class="op" id="7893680">}</span><span class="op" id="7893681">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893684">{</span><span class="string" id="7893685">&#34;tcp6&#34;</span><span class="op" id="7893691">,</span>&nbsp;<span class="string" id="7893693">&#34;[::1]:65534&#34;</span><span class="op" id="7893706">,</span>&nbsp;<span class="op" id="7893708">&amp;</span><span class="ident" id="7893709">TCPAddr</span><span class="op" id="7893716">{</span><span class="ident" id="7893717">IP</span><span class="op" id="7893719">:</span>&nbsp;<span class="ident" id="7893721">ParseIP</span><span class="op" id="7893728">(</span><span class="string" id="7893729">&#34;::1&#34;</span><span class="op" id="7893734">)</span><span class="op" id="7893735">,</span>&nbsp;<span class="ident" id="7893737">Port</span><span class="op" id="7893741">:</span>&nbsp;<span class="num" id="7893743">65534</span><span class="op" id="7893748">}</span><span class="op" id="7893749">,</span>&nbsp;<span class="ident" id="7893751">nil</span><span class="op" id="7893754">}</span><span class="op" id="7893755">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893759">{</span><span class="string" id="7893760">&#34;tcp&#34;</span><span class="op" id="7893765">,</span>&nbsp;<span class="string" id="7893767">&#34;[::1%en0]:1&#34;</span><span class="op" id="7893780">,</span>&nbsp;<span class="op" id="7893782">&amp;</span><span class="ident" id="7893783">TCPAddr</span><span class="op" id="7893790">{</span><span class="ident" id="7893791">IP</span><span class="op" id="7893793">:</span>&nbsp;<span class="ident" id="7893795">ParseIP</span><span class="op" id="7893802">(</span><span class="string" id="7893803">&#34;::1&#34;</span><span class="op" id="7893808">)</span><span class="op" id="7893809">,</span>&nbsp;<span class="ident" id="7893811">Port</span><span class="op" id="7893815">:</span>&nbsp;<span class="num" id="7893817">1</span><span class="op" id="7893818">,</span>&nbsp;<span class="ident" id="7893820">Zone</span><span class="op" id="7893824">:</span>&nbsp;<span class="string" id="7893826">&#34;en0&#34;</span><span class="op" id="7893831">}</span><span class="op" id="7893832">,</span>&nbsp;<span class="ident" id="7893834">nil</span><span class="op" id="7893837">}</span><span class="op" id="7893838">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893841">{</span><span class="string" id="7893842">&#34;tcp6&#34;</span><span class="op" id="7893848">,</span>&nbsp;<span class="string" id="7893850">&#34;[::1%911]:2&#34;</span><span class="op" id="7893863">,</span>&nbsp;<span class="op" id="7893865">&amp;</span><span class="ident" id="7893866">TCPAddr</span><span class="op" id="7893873">{</span><span class="ident" id="7893874">IP</span><span class="op" id="7893876">:</span>&nbsp;<span class="ident" id="7893878">ParseIP</span><span class="op" id="7893885">(</span><span class="string" id="7893886">&#34;::1&#34;</span><span class="op" id="7893891">)</span><span class="op" id="7893892">,</span>&nbsp;<span class="ident" id="7893894">Port</span><span class="op" id="7893898">:</span>&nbsp;<span class="num" id="7893900">2</span><span class="op" id="7893901">,</span>&nbsp;<span class="ident" id="7893903">Zone</span><span class="op" id="7893907">:</span>&nbsp;<span class="string" id="7893909">&#34;911&#34;</span><span class="op" id="7893914">}</span><span class="op" id="7893915">,</span>&nbsp;<span class="ident" id="7893917">nil</span><span class="op" id="7893920">}</span><span class="op" id="7893921">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893925">{</span><span class="string" id="7893926">&#34;&#34;</span><span class="op" id="7893928">,</span>&nbsp;<span class="string" id="7893930">&#34;127.0.0.1:0&#34;</span><span class="op" id="7893943">,</span>&nbsp;<span class="op" id="7893945">&amp;</span><span class="ident" id="7893946">TCPAddr</span><span class="op" id="7893953">{</span><span class="ident" id="7893954">IP</span><span class="op" id="7893956">:</span>&nbsp;<span class="ident" id="7893958">IPv4</span><span class="op" id="7893962">(</span><span class="num" id="7893963">127</span><span class="op" id="7893966">,</span>&nbsp;<span class="num" id="7893968">0</span><span class="op" id="7893969">,</span>&nbsp;<span class="num" id="7893971">0</span><span class="op" id="7893972">,</span>&nbsp;<span class="num" id="7893974">1</span><span class="op" id="7893975">)</span><span class="op" id="7893976">,</span>&nbsp;<span class="ident" id="7893978">Port</span><span class="op" id="7893982">:</span>&nbsp;<span class="num" id="7893984">0</span><span class="op" id="7893985">}</span><span class="op" id="7893986">,</span>&nbsp;<span class="ident" id="7893988">nil</span><span class="op" id="7893991">}</span><span class="op" id="7893992">,</span>&nbsp;<span class="comment" id="7893994">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894014">{</span><span class="string" id="7894015">&#34;&#34;</span><span class="op" id="7894017">,</span>&nbsp;<span class="string" id="7894019">&#34;[::1]:0&#34;</span><span class="op" id="7894028">,</span>&nbsp;<span class="op" id="7894030">&amp;</span><span class="ident" id="7894031">TCPAddr</span><span class="op" id="7894038">{</span><span class="ident" id="7894039">IP</span><span class="op" id="7894041">:</span>&nbsp;<span class="ident" id="7894043">ParseIP</span><span class="op" id="7894050">(</span><span class="string" id="7894051">&#34;::1&#34;</span><span class="op" id="7894056">)</span><span class="op" id="7894057">,</span>&nbsp;<span class="ident" id="7894059">Port</span><span class="op" id="7894063">:</span>&nbsp;<span class="num" id="7894065">0</span><span class="op" id="7894066">}</span><span class="op" id="7894067">,</span>&nbsp;<span class="ident" id="7894069">nil</span><span class="op" id="7894072">}</span><span class="op" id="7894073">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7894083">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894104">{</span><span class="string" id="7894105">&#34;tcp&#34;</span><span class="op" id="7894110">,</span>&nbsp;<span class="string" id="7894112">&#34;:12345&#34;</span><span class="op" id="7894120">,</span>&nbsp;<span class="op" id="7894122">&amp;</span><span class="ident" id="7894123">TCPAddr</span><span class="op" id="7894130">{</span><span class="ident" id="7894131">Port</span><span class="op" id="7894135">:</span>&nbsp;<span class="num" id="7894137">12345</span><span class="op" id="7894142">}</span><span class="op" id="7894143">,</span>&nbsp;<span class="ident" id="7894145">nil</span><span class="op" id="7894148">}</span><span class="op" id="7894149">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894153">{</span><span class="string" id="7894154">&#34;http&#34;</span><span class="op" id="7894160">,</span>&nbsp;<span class="string" id="7894162">&#34;127.0.0.1:0&#34;</span><span class="op" id="7894175">,</span>&nbsp;<span class="ident" id="7894177">nil</span><span class="op" id="7894180">,</span>&nbsp;<span class="ident" id="7894182">UnknownNetworkError</span><span class="op" id="7894201">(</span><span class="string" id="7894202">&#34;http&#34;</span><span class="op" id="7894208">)</span><span class="op" id="7894209">}</span><span class="op" id="7894210">,</span><br>
<span class="lineno"></span><span class="op" id="7894212">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="7894215">func</span>&nbsp;<span class="ident" id="7894220">init</span><span class="op" id="7894224">(</span><span class="op" id="7894225">)</span>&nbsp;<span class="op" id="7894227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894230">if</span>&nbsp;<span class="ident" id="7894233">ifi</span>&nbsp;<span class="op" id="7894237">:=</span>&nbsp;<span class="ident" id="7894240">loopbackInterface</span><span class="op" id="7894257">(</span><span class="op" id="7894258">)</span><span class="op" id="7894259">;</span>&nbsp;<span class="ident" id="7894261">ifi</span>&nbsp;<span class="op" id="7894265">!=</span>&nbsp;<span class="ident" id="7894268">nil</span>&nbsp;<span class="op" id="7894272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894276">index</span>&nbsp;<span class="op" id="7894282">:=</span>&nbsp;<span class="ident" id="7894285">fmt</span><span class="op" id="7894288">.</span><span class="ident" id="7894289">Sprintf</span><span class="op" id="7894296">(</span><span class="string" id="7894297">&#34;%v&#34;</span><span class="op" id="7894301">,</span>&nbsp;<span class="ident" id="7894303">ifi</span><span class="op" id="7894306">.</span><span class="ident" id="7894307">Index</span><span class="op" id="7894312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894316">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7894336">=</span>&nbsp;<span class="builtinfunc" id="7894338">append</span><span class="op" id="7894344">(</span><span class="ident" id="7894345">resolveTCPAddrTests</span><span class="op" id="7894364">,</span>&nbsp;<span class="op" id="7894366">[</span><span class="op" id="7894367">]</span><span class="ident" id="7894368">resolveTCPAddrTest</span><span class="op" id="7894386">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894391">{</span><span class="string" id="7894392">&#34;tcp6&#34;</span><span class="op" id="7894398">,</span>&nbsp;<span class="string" id="7894400">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="7894412">+</span>&nbsp;<span class="ident" id="7894414">ifi</span><span class="op" id="7894417">.</span><span class="ident" id="7894418">Name</span>&nbsp;<span class="op" id="7894423">+</span>&nbsp;<span class="string" id="7894425">&#34;]:3&#34;</span><span class="op" id="7894430">,</span>&nbsp;<span class="op" id="7894432">&amp;</span><span class="ident" id="7894433">TCPAddr</span><span class="op" id="7894440">{</span><span class="ident" id="7894441">IP</span><span class="op" id="7894443">:</span>&nbsp;<span class="ident" id="7894445">ParseIP</span><span class="op" id="7894452">(</span><span class="string" id="7894453">&#34;fe80::1&#34;</span><span class="op" id="7894462">)</span><span class="op" id="7894463">,</span>&nbsp;<span class="ident" id="7894465">Port</span><span class="op" id="7894469">:</span>&nbsp;<span class="num" id="7894471">3</span><span class="op" id="7894472">,</span>&nbsp;<span class="ident" id="7894474">Zone</span><span class="op" id="7894478">:</span>&nbsp;<span class="ident" id="7894480">zoneToString</span><span class="op" id="7894492">(</span><span class="ident" id="7894493">ifi</span><span class="op" id="7894496">.</span><span class="ident" id="7894497">Index</span><span class="op" id="7894502">)</span><span class="op" id="7894503">}</span><span class="op" id="7894504">,</span>&nbsp;<span class="ident" id="7894506">nil</span><span class="op" id="7894509">}</span><span class="op" id="7894510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894515">{</span><span class="string" id="7894516">&#34;tcp6&#34;</span><span class="op" id="7894522">,</span>&nbsp;<span class="string" id="7894524">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="7894536">+</span>&nbsp;<span class="ident" id="7894538">index</span>&nbsp;<span class="op" id="7894544">+</span>&nbsp;<span class="string" id="7894546">&#34;]:4&#34;</span><span class="op" id="7894551">,</span>&nbsp;<span class="op" id="7894553">&amp;</span><span class="ident" id="7894554">TCPAddr</span><span class="op" id="7894561">{</span><span class="ident" id="7894562">IP</span><span class="op" id="7894564">:</span>&nbsp;<span class="ident" id="7894566">ParseIP</span><span class="op" id="7894573">(</span><span class="string" id="7894574">&#34;fe80::1&#34;</span><span class="op" id="7894583">)</span><span class="op" id="7894584">,</span>&nbsp;<span class="ident" id="7894586">Port</span><span class="op" id="7894590">:</span>&nbsp;<span class="num" id="7894592">4</span><span class="op" id="7894593">,</span>&nbsp;<span class="ident" id="7894595">Zone</span><span class="op" id="7894599">:</span>&nbsp;<span class="ident" id="7894601">index</span><span class="op" id="7894606">}</span><span class="op" id="7894607">,</span>&nbsp;<span class="ident" id="7894609">nil</span><span class="op" id="7894612">}</span><span class="op" id="7894613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894617">}</span><span class="op" id="7894618">...</span><span class="op" id="7894621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894627">if</span>&nbsp;<span class="ident" id="7894630">ips</span><span class="op" id="7894633">,</span>&nbsp;<span class="ident" id="7894635">err</span>&nbsp;<span class="op" id="7894639">:=</span>&nbsp;<span class="ident" id="7894642">LookupIP</span><span class="op" id="7894650">(</span><span class="string" id="7894651">&#34;localhost&#34;</span><span class="op" id="7894662">)</span><span class="op" id="7894663">;</span>&nbsp;<span class="ident" id="7894665">err</span>&nbsp;<span class="op" id="7894669">==</span>&nbsp;<span class="ident" id="7894672">nil</span>&nbsp;<span class="op" id="7894676">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="7894679">len</span><span class="op" id="7894682">(</span><span class="ident" id="7894683">ips</span><span class="op" id="7894686">)</span>&nbsp;<span class="op" id="7894688">&gt;</span>&nbsp;<span class="num" id="7894690">1</span>&nbsp;<span class="op" id="7894692">&amp;&amp;</span>&nbsp;<span class="ident" id="7894695">supportsIPv4</span>&nbsp;<span class="op" id="7894708">&amp;&amp;</span>&nbsp;<span class="ident" id="7894711">supportsIPv6</span>&nbsp;<span class="op" id="7894724">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894728">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7894748">=</span>&nbsp;<span class="builtinfunc" id="7894750">append</span><span class="op" id="7894756">(</span><span class="ident" id="7894757">resolveTCPAddrTests</span><span class="op" id="7894776">,</span>&nbsp;<span class="op" id="7894778">[</span><span class="op" id="7894779">]</span><span class="ident" id="7894780">resolveTCPAddrTest</span><span class="op" id="7894798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894803">{</span><span class="string" id="7894804">&#34;tcp&#34;</span><span class="op" id="7894809">,</span>&nbsp;<span class="string" id="7894811">&#34;localhost:5&#34;</span><span class="op" id="7894824">,</span>&nbsp;<span class="op" id="7894826">&amp;</span><span class="ident" id="7894827">TCPAddr</span><span class="op" id="7894834">{</span><span class="ident" id="7894835">IP</span><span class="op" id="7894837">:</span>&nbsp;<span class="ident" id="7894839">IPv4</span><span class="op" id="7894843">(</span><span class="num" id="7894844">127</span><span class="op" id="7894847">,</span>&nbsp;<span class="num" id="7894849">0</span><span class="op" id="7894850">,</span>&nbsp;<span class="num" id="7894852">0</span><span class="op" id="7894853">,</span>&nbsp;<span class="num" id="7894855">1</span><span class="op" id="7894856">)</span><span class="op" id="7894857">,</span>&nbsp;<span class="ident" id="7894859">Port</span><span class="op" id="7894863">:</span>&nbsp;<span class="num" id="7894865">5</span><span class="op" id="7894866">}</span><span class="op" id="7894867">,</span>&nbsp;<span class="ident" id="7894869">nil</span><span class="op" id="7894872">}</span><span class="op" id="7894873">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894878">{</span><span class="string" id="7894879">&#34;tcp4&#34;</span><span class="op" id="7894885">,</span>&nbsp;<span class="string" id="7894887">&#34;localhost:6&#34;</span><span class="op" id="7894900">,</span>&nbsp;<span class="op" id="7894902">&amp;</span><span class="ident" id="7894903">TCPAddr</span><span class="op" id="7894910">{</span><span class="ident" id="7894911">IP</span><span class="op" id="7894913">:</span>&nbsp;<span class="ident" id="7894915">IPv4</span><span class="op" id="7894919">(</span><span class="num" id="7894920">127</span><span class="op" id="7894923">,</span>&nbsp;<span class="num" id="7894925">0</span><span class="op" id="7894926">,</span>&nbsp;<span class="num" id="7894928">0</span><span class="op" id="7894929">,</span>&nbsp;<span class="num" id="7894931">1</span><span class="op" id="7894932">)</span><span class="op" id="7894933">,</span>&nbsp;<span class="ident" id="7894935">Port</span><span class="op" id="7894939">:</span>&nbsp;<span class="num" id="7894941">6</span><span class="op" id="7894942">}</span><span class="op" id="7894943">,</span>&nbsp;<span class="ident" id="7894945">nil</span><span class="op" id="7894948">}</span><span class="op" id="7894949">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894954">{</span><span class="string" id="7894955">&#34;tcp6&#34;</span><span class="op" id="7894961">,</span>&nbsp;<span class="string" id="7894963">&#34;localhost:7&#34;</span><span class="op" id="7894976">,</span>&nbsp;<span class="op" id="7894978">&amp;</span><span class="ident" id="7894979">TCPAddr</span><span class="op" id="7894986">{</span><span class="ident" id="7894987">IP</span><span class="op" id="7894989">:</span>&nbsp;<span class="ident" id="7894991">IPv6loopback</span><span class="op" id="7895003">,</span>&nbsp;<span class="ident" id="7895005">Port</span><span class="op" id="7895009">:</span>&nbsp;<span class="num" id="7895011">7</span><span class="op" id="7895012">}</span><span class="op" id="7895013">,</span>&nbsp;<span class="ident" id="7895015">nil</span><span class="op" id="7895018">}</span><span class="op" id="7895019">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895023">}</span><span class="op" id="7895024">...</span><span class="op" id="7895027">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895030">}</span><br>
<span class="lineno"></span><span class="op" id="7895032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7895035">func</span>&nbsp;<span class="ident" id="7895040">TestResolveTCPAddr</span><span class="op" id="7895058">(</span><span class="ident" id="7895059">t</span>&nbsp;<span class="op" id="7895061">*</span><span class="ident" id="7895062">testing</span><span class="op" id="7895069">.</span><span class="ident" id="7895070">T</span><span class="op" id="7895071">)</span>&nbsp;<span class="op" id="7895073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895076">for</span>&nbsp;<span class="ident" id="7895080">_</span><span class="op" id="7895081">,</span>&nbsp;<span class="ident" id="7895083">tt</span>&nbsp;<span class="op" id="7895086">:=</span>&nbsp;<span class="keyword" id="7895089">range</span>&nbsp;<span class="ident" id="7895095">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7895115">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895119">addr</span><span class="op" id="7895123">,</span>&nbsp;<span class="ident" id="7895125">err</span>&nbsp;<span class="op" id="7895129">:=</span>&nbsp;<span class="ident" id="7895132">ResolveTCPAddr</span><span class="op" id="7895146">(</span><span class="ident" id="7895147">tt</span><span class="op" id="7895149">.</span><span class="ident" id="7895150">net</span><span class="op" id="7895153">,</span>&nbsp;<span class="ident" id="7895155">tt</span><span class="op" id="7895157">.</span><span class="ident" id="7895158">litAddrOrName</span><span class="op" id="7895171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895175">if</span>&nbsp;<span class="ident" id="7895178">err</span>&nbsp;<span class="op" id="7895182">!=</span>&nbsp;<span class="ident" id="7895185">tt</span><span class="op" id="7895187">.</span><span class="ident" id="7895188">err</span>&nbsp;<span class="op" id="7895192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895197">t</span><span class="op" id="7895198">.</span><span class="ident" id="7895199">Fatalf</span><span class="op" id="7895205">(</span><span class="string" id="7895206">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7895241">,</span>&nbsp;<span class="ident" id="7895243">tt</span><span class="op" id="7895245">.</span><span class="ident" id="7895246">net</span><span class="op" id="7895249">,</span>&nbsp;<span class="ident" id="7895251">tt</span><span class="op" id="7895253">.</span><span class="ident" id="7895254">litAddrOrName</span><span class="op" id="7895267">,</span>&nbsp;<span class="ident" id="7895269">err</span><span class="op" id="7895272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895280">if</span>&nbsp;<span class="op" id="7895283">!</span><span class="ident" id="7895284">reflect</span><span class="op" id="7895291">.</span><span class="ident" id="7895292">DeepEqual</span><span class="op" id="7895301">(</span><span class="ident" id="7895302">addr</span><span class="op" id="7895306">,</span>&nbsp;<span class="ident" id="7895308">tt</span><span class="op" id="7895310">.</span><span class="ident" id="7895311">addr</span><span class="op" id="7895315">)</span>&nbsp;<span class="op" id="7895317">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895322">t</span><span class="op" id="7895323">.</span><span class="ident" id="7895324">Fatalf</span><span class="op" id="7895330">(</span><span class="string" id="7895331">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7895371">,</span>&nbsp;<span class="ident" id="7895373">tt</span><span class="op" id="7895375">.</span><span class="ident" id="7895376">net</span><span class="op" id="7895379">,</span>&nbsp;<span class="ident" id="7895381">tt</span><span class="op" id="7895383">.</span><span class="ident" id="7895384">litAddrOrName</span><span class="op" id="7895397">,</span>&nbsp;<span class="ident" id="7895399">addr</span><span class="op" id="7895403">,</span>&nbsp;<span class="ident" id="7895405">tt</span><span class="op" id="7895407">.</span><span class="ident" id="7895408">addr</span><span class="op" id="7895412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895420">if</span>&nbsp;<span class="ident" id="7895423">err</span>&nbsp;<span class="op" id="7895427">==</span>&nbsp;<span class="ident" id="7895430">nil</span>&nbsp;<span class="op" id="7895434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895439">str</span>&nbsp;<span class="op" id="7895443">:=</span>&nbsp;<span class="ident" id="7895446">addr</span><span class="op" id="7895450">.</span><span class="ident" id="7895451">String</span><span class="op" id="7895457">(</span><span class="op" id="7895458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895463">addr1</span><span class="op" id="7895468">,</span>&nbsp;<span class="ident" id="7895470">err</span>&nbsp;<span class="op" id="7895474">:=</span>&nbsp;<span class="ident" id="7895477">ResolveTCPAddr</span><span class="op" id="7895491">(</span><span class="ident" id="7895492">tt</span><span class="op" id="7895494">.</span><span class="ident" id="7895495">net</span><span class="op" id="7895498">,</span>&nbsp;<span class="ident" id="7895500">str</span><span class="op" id="7895503">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895508">if</span>&nbsp;<span class="ident" id="7895511">err</span>&nbsp;<span class="op" id="7895515">!=</span>&nbsp;<span class="ident" id="7895518">nil</span>&nbsp;<span class="op" id="7895522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895528">t</span><span class="op" id="7895529">.</span><span class="ident" id="7895530">Fatalf</span><span class="op" id="7895536">(</span><span class="string" id="7895537">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="7895575">,</span>&nbsp;<span class="ident" id="7895577">tt</span><span class="op" id="7895579">.</span><span class="ident" id="7895580">net</span><span class="op" id="7895583">,</span>&nbsp;<span class="ident" id="7895585">str</span><span class="op" id="7895588">,</span>&nbsp;<span class="ident" id="7895590">tt</span><span class="op" id="7895592">.</span><span class="ident" id="7895593">litAddrOrName</span><span class="op" id="7895606">,</span>&nbsp;<span class="ident" id="7895608">err</span><span class="op" id="7895611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895621">if</span>&nbsp;<span class="op" id="7895624">!</span><span class="ident" id="7895625">reflect</span><span class="op" id="7895632">.</span><span class="ident" id="7895633">DeepEqual</span><span class="op" id="7895642">(</span><span class="ident" id="7895643">addr1</span><span class="op" id="7895648">,</span>&nbsp;<span class="ident" id="7895650">addr</span><span class="op" id="7895654">)</span>&nbsp;<span class="op" id="7895656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895662">t</span><span class="op" id="7895663">.</span><span class="ident" id="7895664">Fatalf</span><span class="op" id="7895670">(</span><span class="string" id="7895671">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7895721">,</span>&nbsp;<span class="ident" id="7895723">tt</span><span class="op" id="7895725">.</span><span class="ident" id="7895726">net</span><span class="op" id="7895729">,</span>&nbsp;<span class="ident" id="7895731">str</span><span class="op" id="7895734">,</span>&nbsp;<span class="ident" id="7895736">tt</span><span class="op" id="7895738">.</span><span class="ident" id="7895739">litAddrOrName</span><span class="op" id="7895752">,</span>&nbsp;<span class="ident" id="7895754">addr1</span><span class="op" id="7895759">,</span>&nbsp;<span class="ident" id="7895761">addr</span><span class="op" id="7895765">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895777">}</span><br>
<span class="lineno"></span><span class="op" id="7895779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="7895782">var</span>&nbsp;<span class="ident" id="7895786">tcpListenerNameTests</span>&nbsp;<span class="op" id="7895807">=</span>&nbsp;<span class="op" id="7895809">[</span><span class="op" id="7895810">]</span><span class="keyword" id="7895811">struct</span>&nbsp;<span class="op" id="7895818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895821">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7895827">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895835">laddr</span>&nbsp;<span class="op" id="7895841">*</span><span class="ident" id="7895842">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="7895850">}</span><span class="op" id="7895851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895854">{</span><span class="string" id="7895855">&#34;tcp4&#34;</span><span class="op" id="7895861">,</span>&nbsp;<span class="op" id="7895863">&amp;</span><span class="ident" id="7895864">TCPAddr</span><span class="op" id="7895871">{</span><span class="ident" id="7895872">IP</span><span class="op" id="7895874">:</span>&nbsp;<span class="ident" id="7895876">IPv4</span><span class="op" id="7895880">(</span><span class="num" id="7895881">127</span><span class="op" id="7895884">,</span>&nbsp;<span class="num" id="7895886">0</span><span class="op" id="7895887">,</span>&nbsp;<span class="num" id="7895889">0</span><span class="op" id="7895890">,</span>&nbsp;<span class="num" id="7895892">1</span><span class="op" id="7895893">)</span><span class="op" id="7895894">}</span><span class="op" id="7895895">}</span><span class="op" id="7895896">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895899">{</span><span class="string" id="7895900">&#34;tcp4&#34;</span><span class="op" id="7895906">,</span>&nbsp;<span class="op" id="7895908">&amp;</span><span class="ident" id="7895909">TCPAddr</span><span class="op" id="7895916">{</span><span class="op" id="7895917">}</span><span class="op" id="7895918">}</span><span class="op" id="7895919">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895922">{</span><span class="string" id="7895923">&#34;tcp4&#34;</span><span class="op" id="7895929">,</span>&nbsp;<span class="ident" id="7895931">nil</span><span class="op" id="7895934">}</span><span class="op" id="7895935">,</span><br>
<span class="lineno"></span><span class="op" id="7895937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7895940">func</span>&nbsp;<span class="ident" id="7895945">TestTCPListenerName</span><span class="op" id="7895964">(</span><span class="ident" id="7895965">t</span>&nbsp;<span class="op" id="7895967">*</span><span class="ident" id="7895968">testing</span><span class="op" id="7895975">.</span><span class="ident" id="7895976">T</span><span class="op" id="7895977">)</span>&nbsp;<span class="op" id="7895979">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895982">if</span>&nbsp;<span class="ident" id="7895985">testing</span><span class="op" id="7895992">.</span><span class="ident" id="7895993">Short</span><span class="op" id="7895998">(</span><span class="op" id="7895999">)</span>&nbsp;<span class="op" id="7896001">||</span>&nbsp;<span class="op" id="7896004">!</span><span class="op" id="7896005">*</span><span class="ident" id="7896006">testExternal</span>&nbsp;<span class="op" id="7896019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896023">t</span><span class="op" id="7896024">.</span><span class="ident" id="7896025">Skip</span><span class="op" id="7896029">(</span><span class="string" id="7896030">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7896071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896078">for</span>&nbsp;<span class="ident" id="7896082">_</span><span class="op" id="7896083">,</span>&nbsp;<span class="ident" id="7896085">tt</span>&nbsp;<span class="op" id="7896088">:=</span>&nbsp;<span class="keyword" id="7896091">range</span>&nbsp;<span class="ident" id="7896097">tcpListenerNameTests</span>&nbsp;<span class="op" id="7896118">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896122">ln</span><span class="op" id="7896124">,</span>&nbsp;<span class="ident" id="7896126">err</span>&nbsp;<span class="op" id="7896130">:=</span>&nbsp;<span class="ident" id="7896133">ListenTCP</span><span class="op" id="7896142">(</span><span class="ident" id="7896143">tt</span><span class="op" id="7896145">.</span><span class="ident" id="7896146">net</span><span class="op" id="7896149">,</span>&nbsp;<span class="ident" id="7896151">tt</span><span class="op" id="7896153">.</span><span class="ident" id="7896154">laddr</span><span class="op" id="7896159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896163">if</span>&nbsp;<span class="ident" id="7896166">err</span>&nbsp;<span class="op" id="7896170">!=</span>&nbsp;<span class="ident" id="7896173">nil</span>&nbsp;<span class="op" id="7896177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896182">t</span><span class="op" id="7896183">.</span><span class="ident" id="7896184">Fatalf</span><span class="op" id="7896190">(</span><span class="string" id="7896191">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7896213">,</span>&nbsp;<span class="ident" id="7896215">err</span><span class="op" id="7896218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896226">defer</span>&nbsp;<span class="ident" id="7896232">ln</span><span class="op" id="7896234">.</span><span class="ident" id="7896235">Close</span><span class="op" id="7896240">(</span><span class="op" id="7896241">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896245">la</span>&nbsp;<span class="op" id="7896248">:=</span>&nbsp;<span class="ident" id="7896251">ln</span><span class="op" id="7896253">.</span><span class="ident" id="7896254">Addr</span><span class="op" id="7896258">(</span><span class="op" id="7896259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896263">if</span>&nbsp;<span class="ident" id="7896266">a</span><span class="op" id="7896267">,</span>&nbsp;<span class="ident" id="7896269">ok</span>&nbsp;<span class="op" id="7896272">:=</span>&nbsp;<span class="ident" id="7896275">la</span><span class="op" id="7896277">.</span><span class="op" id="7896278">(</span><span class="op" id="7896279">*</span><span class="ident" id="7896280">TCPAddr</span><span class="op" id="7896287">)</span><span class="op" id="7896288">;</span>&nbsp;<span class="op" id="7896290">!</span><span class="ident" id="7896291">ok</span>&nbsp;<span class="op" id="7896294">||</span>&nbsp;<span class="ident" id="7896297">a</span><span class="op" id="7896298">.</span><span class="ident" id="7896299">Port</span>&nbsp;<span class="op" id="7896304">==</span>&nbsp;<span class="num" id="7896307">0</span>&nbsp;<span class="op" id="7896309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896314">t</span><span class="op" id="7896315">.</span><span class="ident" id="7896316">Fatalf</span><span class="op" id="7896322">(</span><span class="string" id="7896323">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="7896384">,</span>&nbsp;<span class="ident" id="7896386">la</span><span class="op" id="7896388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896395">}</span><br>
<span class="lineno">375</span><span class="op" id="7896397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7896400">func</span>&nbsp;<span class="ident" id="7896405">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="7896432">(</span><span class="ident" id="7896433">t</span>&nbsp;<span class="op" id="7896435">*</span><span class="ident" id="7896436">testing</span><span class="op" id="7896443">.</span><span class="ident" id="7896444">T</span><span class="op" id="7896445">)</span>&nbsp;<span class="op" id="7896447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896450">if</span>&nbsp;<span class="ident" id="7896453">testing</span><span class="op" id="7896460">.</span><span class="ident" id="7896461">Short</span><span class="op" id="7896466">(</span><span class="op" id="7896467">)</span>&nbsp;<span class="op" id="7896469">||</span>&nbsp;<span class="op" id="7896472">!</span><span class="op" id="7896473">*</span><span class="ident" id="7896474">testExternal</span>&nbsp;<span class="op" id="7896487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896491">t</span><span class="op" id="7896492">.</span><span class="ident" id="7896493">Skip</span><span class="op" id="7896497">(</span><span class="string" id="7896498">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7896539">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896545">if</span>&nbsp;<span class="op" id="7896548">!</span><span class="ident" id="7896549">supportsIPv6</span>&nbsp;<span class="op" id="7896562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896566">t</span><span class="op" id="7896567">.</span><span class="ident" id="7896568">Skip</span><span class="op" id="7896572">(</span><span class="string" id="7896573">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7896596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896602">ifi</span>&nbsp;<span class="op" id="7896606">:=</span>&nbsp;<span class="ident" id="7896609">loopbackInterface</span><span class="op" id="7896626">(</span><span class="op" id="7896627">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896630">if</span>&nbsp;<span class="ident" id="7896633">ifi</span>&nbsp;<span class="op" id="7896637">==</span>&nbsp;<span class="ident" id="7896640">nil</span>&nbsp;<span class="op" id="7896644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896648">t</span><span class="op" id="7896649">.</span><span class="ident" id="7896650">Skip</span><span class="op" id="7896654">(</span><span class="string" id="7896655">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="7896685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896691">laddr</span>&nbsp;<span class="op" id="7896697">:=</span>&nbsp;<span class="ident" id="7896700">ipv6LinkLocalUnicastAddr</span><span class="op" id="7896724">(</span><span class="ident" id="7896725">ifi</span><span class="op" id="7896728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896731">if</span>&nbsp;<span class="ident" id="7896734">laddr</span>&nbsp;<span class="op" id="7896740">==</span>&nbsp;<span class="string" id="7896743">&#34;&#34;</span>&nbsp;<span class="op" id="7896746">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896750">t</span><span class="op" id="7896751">.</span><span class="ident" id="7896752">Skip</span><span class="op" id="7896756">(</span><span class="string" id="7896757">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="7896801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896808">type</span>&nbsp;<span class="ident" id="7896813">test</span>&nbsp;<span class="keyword" id="7896818">struct</span>&nbsp;<span class="op" id="7896825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896829">net</span><span class="op" id="7896832">,</span>&nbsp;<span class="ident" id="7896834">addr</span>&nbsp;&nbsp;<span class="builtintype" id="7896840">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896849">nameLookup</span>&nbsp;<span class="builtintype" id="7896860">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896869">var</span>&nbsp;<span class="ident" id="7896873">tests</span>&nbsp;<span class="op" id="7896879">=</span>&nbsp;<span class="op" id="7896881">[</span><span class="op" id="7896882">]</span><span class="ident" id="7896883">test</span><span class="op" id="7896887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896891">{</span><span class="string" id="7896892">&#34;tcp&#34;</span><span class="op" id="7896897">,</span>&nbsp;<span class="string" id="7896899">&#34;[&#34;</span>&nbsp;<span class="op" id="7896903">+</span>&nbsp;<span class="ident" id="7896905">laddr</span>&nbsp;<span class="op" id="7896911">+</span>&nbsp;<span class="string" id="7896913">&#34;%&#34;</span>&nbsp;<span class="op" id="7896917">+</span>&nbsp;<span class="ident" id="7896919">ifi</span><span class="op" id="7896922">.</span><span class="ident" id="7896923">Name</span>&nbsp;<span class="op" id="7896928">+</span>&nbsp;<span class="string" id="7896930">&#34;]:0&#34;</span><span class="op" id="7896935">,</span>&nbsp;<span class="builtintype" id="7896937">false</span><span class="op" id="7896942">}</span><span class="op" id="7896943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896947">{</span><span class="string" id="7896948">&#34;tcp6&#34;</span><span class="op" id="7896954">,</span>&nbsp;<span class="string" id="7896956">&#34;[&#34;</span>&nbsp;<span class="op" id="7896960">+</span>&nbsp;<span class="ident" id="7896962">laddr</span>&nbsp;<span class="op" id="7896968">+</span>&nbsp;<span class="string" id="7896970">&#34;%&#34;</span>&nbsp;<span class="op" id="7896974">+</span>&nbsp;<span class="ident" id="7896976">ifi</span><span class="op" id="7896979">.</span><span class="ident" id="7896980">Name</span>&nbsp;<span class="op" id="7896985">+</span>&nbsp;<span class="string" id="7896987">&#34;]:0&#34;</span><span class="op" id="7896992">,</span>&nbsp;<span class="builtintype" id="7896994">false</span><span class="op" id="7896999">}</span><span class="op" id="7897000">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897006">switch</span>&nbsp;<span class="ident" id="7897013">runtime</span><span class="op" id="7897020">.</span><span class="ident" id="7897021">GOOS</span>&nbsp;<span class="op" id="7897026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897029">case</span>&nbsp;<span class="string" id="7897034">&#34;darwin&#34;</span><span class="op" id="7897042">,</span>&nbsp;<span class="string" id="7897044">&#34;freebsd&#34;</span><span class="op" id="7897053">,</span>&nbsp;<span class="string" id="7897055">&#34;openbsd&#34;</span><span class="op" id="7897064">,</span>&nbsp;<span class="string" id="7897066">&#34;netbsd&#34;</span><span class="op" id="7897074">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897078">tests</span>&nbsp;<span class="op" id="7897084">=</span>&nbsp;<span class="builtinfunc" id="7897086">append</span><span class="op" id="7897092">(</span><span class="ident" id="7897093">tests</span><span class="op" id="7897098">,</span>&nbsp;<span class="op" id="7897100">[</span><span class="op" id="7897101">]</span><span class="ident" id="7897102">test</span><span class="op" id="7897106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897111">{</span><span class="string" id="7897112">&#34;tcp&#34;</span><span class="op" id="7897117">,</span>&nbsp;<span class="string" id="7897119">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="7897133">+</span>&nbsp;<span class="ident" id="7897135">ifi</span><span class="op" id="7897138">.</span><span class="ident" id="7897139">Name</span>&nbsp;<span class="op" id="7897144">+</span>&nbsp;<span class="string" id="7897146">&#34;]:0&#34;</span><span class="op" id="7897151">,</span>&nbsp;<span class="builtintype" id="7897153">true</span><span class="op" id="7897157">}</span><span class="op" id="7897158">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897163">{</span><span class="string" id="7897164">&#34;tcp6&#34;</span><span class="op" id="7897170">,</span>&nbsp;<span class="string" id="7897172">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="7897186">+</span>&nbsp;<span class="ident" id="7897188">ifi</span><span class="op" id="7897191">.</span><span class="ident" id="7897192">Name</span>&nbsp;<span class="op" id="7897197">+</span>&nbsp;<span class="string" id="7897199">&#34;]:0&#34;</span><span class="op" id="7897204">,</span>&nbsp;<span class="builtintype" id="7897206">true</span><span class="op" id="7897210">}</span><span class="op" id="7897211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897215">}</span><span class="op" id="7897216">...</span><span class="op" id="7897219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897222">case</span>&nbsp;<span class="string" id="7897227">&#34;linux&#34;</span><span class="op" id="7897234">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897238">tests</span>&nbsp;<span class="op" id="7897244">=</span>&nbsp;<span class="builtinfunc" id="7897246">append</span><span class="op" id="7897252">(</span><span class="ident" id="7897253">tests</span><span class="op" id="7897258">,</span>&nbsp;<span class="op" id="7897260">[</span><span class="op" id="7897261">]</span><span class="ident" id="7897262">test</span><span class="op" id="7897266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897271">{</span><span class="string" id="7897272">&#34;tcp&#34;</span><span class="op" id="7897277">,</span>&nbsp;<span class="string" id="7897279">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="7897297">+</span>&nbsp;<span class="ident" id="7897299">ifi</span><span class="op" id="7897302">.</span><span class="ident" id="7897303">Name</span>&nbsp;<span class="op" id="7897308">+</span>&nbsp;<span class="string" id="7897310">&#34;]:0&#34;</span><span class="op" id="7897315">,</span>&nbsp;<span class="builtintype" id="7897317">true</span><span class="op" id="7897321">}</span><span class="op" id="7897322">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897327">{</span><span class="string" id="7897328">&#34;tcp6&#34;</span><span class="op" id="7897334">,</span>&nbsp;<span class="string" id="7897336">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="7897354">+</span>&nbsp;<span class="ident" id="7897356">ifi</span><span class="op" id="7897359">.</span><span class="ident" id="7897360">Name</span>&nbsp;<span class="op" id="7897365">+</span>&nbsp;<span class="string" id="7897367">&#34;]:0&#34;</span><span class="op" id="7897372">,</span>&nbsp;<span class="builtintype" id="7897374">true</span><span class="op" id="7897378">}</span><span class="op" id="7897379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897383">}</span><span class="op" id="7897384">...</span><span class="op" id="7897387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897393">for</span>&nbsp;<span class="ident" id="7897397">_</span><span class="op" id="7897398">,</span>&nbsp;<span class="ident" id="7897400">tt</span>&nbsp;<span class="op" id="7897403">:=</span>&nbsp;<span class="keyword" id="7897406">range</span>&nbsp;<span class="ident" id="7897412">tests</span>&nbsp;<span class="op" id="7897418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897422">ln</span><span class="op" id="7897424">,</span>&nbsp;<span class="ident" id="7897426">err</span>&nbsp;<span class="op" id="7897430">:=</span>&nbsp;<span class="ident" id="7897433">Listen</span><span class="op" id="7897439">(</span><span class="ident" id="7897440">tt</span><span class="op" id="7897442">.</span><span class="ident" id="7897443">net</span><span class="op" id="7897446">,</span>&nbsp;<span class="ident" id="7897448">tt</span><span class="op" id="7897450">.</span><span class="ident" id="7897451">addr</span><span class="op" id="7897455">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897459">if</span>&nbsp;<span class="ident" id="7897462">err</span>&nbsp;<span class="op" id="7897466">!=</span>&nbsp;<span class="ident" id="7897469">nil</span>&nbsp;<span class="op" id="7897473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7897478">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7897524">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897573">t</span><span class="op" id="7897574">.</span><span class="ident" id="7897575">Logf</span><span class="op" id="7897579">(</span><span class="string" id="7897580">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7897599">,</span>&nbsp;<span class="ident" id="7897601">err</span><span class="op" id="7897604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897609">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897624">defer</span>&nbsp;<span class="ident" id="7897630">ln</span><span class="op" id="7897632">.</span><span class="ident" id="7897633">Close</span><span class="op" id="7897638">(</span><span class="op" id="7897639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897643">if</span>&nbsp;<span class="ident" id="7897646">la</span><span class="op" id="7897648">,</span>&nbsp;<span class="ident" id="7897650">ok</span>&nbsp;<span class="op" id="7897653">:=</span>&nbsp;<span class="ident" id="7897656">ln</span><span class="op" id="7897658">.</span><span class="ident" id="7897659">Addr</span><span class="op" id="7897663">(</span><span class="op" id="7897664">)</span><span class="op" id="7897665">.</span><span class="op" id="7897666">(</span><span class="op" id="7897667">*</span><span class="ident" id="7897668">TCPAddr</span><span class="op" id="7897675">)</span><span class="op" id="7897676">;</span>&nbsp;<span class="op" id="7897678">!</span><span class="ident" id="7897679">ok</span>&nbsp;<span class="op" id="7897682">||</span>&nbsp;<span class="op" id="7897685">!</span><span class="ident" id="7897686">tt</span><span class="op" id="7897688">.</span><span class="ident" id="7897689">nameLookup</span>&nbsp;<span class="op" id="7897700">&amp;&amp;</span>&nbsp;<span class="ident" id="7897703">la</span><span class="op" id="7897705">.</span><span class="ident" id="7897706">Zone</span>&nbsp;<span class="op" id="7897711">==</span>&nbsp;<span class="string" id="7897714">&#34;&#34;</span>&nbsp;<span class="op" id="7897717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897722">t</span><span class="op" id="7897723">.</span><span class="ident" id="7897724">Fatalf</span><span class="op" id="7897730">(</span><span class="string" id="7897731">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7897787">,</span>&nbsp;<span class="ident" id="7897789">la</span><span class="op" id="7897791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897795">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897800">done</span>&nbsp;<span class="op" id="7897805">:=</span>&nbsp;<span class="builtinfunc" id="7897808">make</span><span class="op" id="7897812">(</span><span class="keyword" id="7897813">chan</span>&nbsp;<span class="builtintype" id="7897818">int</span><span class="op" id="7897821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897825">go</span>&nbsp;<span class="ident" id="7897828">transponder</span><span class="op" id="7897839">(</span><span class="ident" id="7897840">t</span><span class="op" id="7897841">,</span>&nbsp;<span class="ident" id="7897843">ln</span><span class="op" id="7897845">,</span>&nbsp;<span class="ident" id="7897847">done</span><span class="op" id="7897851">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897856">c</span><span class="op" id="7897857">,</span>&nbsp;<span class="ident" id="7897859">err</span>&nbsp;<span class="op" id="7897863">:=</span>&nbsp;<span class="ident" id="7897866">Dial</span><span class="op" id="7897870">(</span><span class="ident" id="7897871">tt</span><span class="op" id="7897873">.</span><span class="ident" id="7897874">net</span><span class="op" id="7897877">,</span>&nbsp;<span class="ident" id="7897879">ln</span><span class="op" id="7897881">.</span><span class="ident" id="7897882">Addr</span><span class="op" id="7897886">(</span><span class="op" id="7897887">)</span><span class="op" id="7897888">.</span><span class="ident" id="7897889">String</span><span class="op" id="7897895">(</span><span class="op" id="7897896">)</span><span class="op" id="7897897">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897901">if</span>&nbsp;<span class="ident" id="7897904">err</span>&nbsp;<span class="op" id="7897908">!=</span>&nbsp;<span class="ident" id="7897911">nil</span>&nbsp;<span class="op" id="7897915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897920">t</span><span class="op" id="7897921">.</span><span class="ident" id="7897922">Fatalf</span><span class="op" id="7897928">(</span><span class="string" id="7897929">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7897946">,</span>&nbsp;<span class="ident" id="7897948">err</span><span class="op" id="7897951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897959">defer</span>&nbsp;<span class="ident" id="7897965">c</span><span class="op" id="7897966">.</span><span class="ident" id="7897967">Close</span><span class="op" id="7897972">(</span><span class="op" id="7897973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897977">if</span>&nbsp;<span class="ident" id="7897980">la</span><span class="op" id="7897982">,</span>&nbsp;<span class="ident" id="7897984">ok</span>&nbsp;<span class="op" id="7897987">:=</span>&nbsp;<span class="ident" id="7897990">c</span><span class="op" id="7897991">.</span><span class="ident" id="7897992">LocalAddr</span><span class="op" id="7898001">(</span><span class="op" id="7898002">)</span><span class="op" id="7898003">.</span><span class="op" id="7898004">(</span><span class="op" id="7898005">*</span><span class="ident" id="7898006">TCPAddr</span><span class="op" id="7898013">)</span><span class="op" id="7898014">;</span>&nbsp;<span class="op" id="7898016">!</span><span class="ident" id="7898017">ok</span>&nbsp;<span class="op" id="7898020">||</span>&nbsp;<span class="op" id="7898023">!</span><span class="ident" id="7898024">tt</span><span class="op" id="7898026">.</span><span class="ident" id="7898027">nameLookup</span>&nbsp;<span class="op" id="7898038">&amp;&amp;</span>&nbsp;<span class="ident" id="7898041">la</span><span class="op" id="7898043">.</span><span class="ident" id="7898044">Zone</span>&nbsp;<span class="op" id="7898049">==</span>&nbsp;<span class="string" id="7898052">&#34;&#34;</span>&nbsp;<span class="op" id="7898055">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898060">t</span><span class="op" id="7898061">.</span><span class="ident" id="7898062">Fatalf</span><span class="op" id="7898068">(</span><span class="string" id="7898069">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7898125">,</span>&nbsp;<span class="ident" id="7898127">la</span><span class="op" id="7898129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898137">if</span>&nbsp;<span class="ident" id="7898140">ra</span><span class="op" id="7898142">,</span>&nbsp;<span class="ident" id="7898144">ok</span>&nbsp;<span class="op" id="7898147">:=</span>&nbsp;<span class="ident" id="7898150">c</span><span class="op" id="7898151">.</span><span class="ident" id="7898152">RemoteAddr</span><span class="op" id="7898162">(</span><span class="op" id="7898163">)</span><span class="op" id="7898164">.</span><span class="op" id="7898165">(</span><span class="op" id="7898166">*</span><span class="ident" id="7898167">TCPAddr</span><span class="op" id="7898174">)</span><span class="op" id="7898175">;</span>&nbsp;<span class="op" id="7898177">!</span><span class="ident" id="7898178">ok</span>&nbsp;<span class="op" id="7898181">||</span>&nbsp;<span class="op" id="7898184">!</span><span class="ident" id="7898185">tt</span><span class="op" id="7898187">.</span><span class="ident" id="7898188">nameLookup</span>&nbsp;<span class="op" id="7898199">&amp;&amp;</span>&nbsp;<span class="ident" id="7898202">ra</span><span class="op" id="7898204">.</span><span class="ident" id="7898205">Zone</span>&nbsp;<span class="op" id="7898210">==</span>&nbsp;<span class="string" id="7898213">&#34;&#34;</span>&nbsp;<span class="op" id="7898216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898221">t</span><span class="op" id="7898222">.</span><span class="ident" id="7898223">Fatalf</span><span class="op" id="7898229">(</span><span class="string" id="7898230">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7898286">,</span>&nbsp;<span class="ident" id="7898288">ra</span><span class="op" id="7898290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898294">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898299">if</span>&nbsp;<span class="ident" id="7898302">_</span><span class="op" id="7898303">,</span>&nbsp;<span class="ident" id="7898305">err</span>&nbsp;<span class="op" id="7898309">:=</span>&nbsp;<span class="ident" id="7898312">c</span><span class="op" id="7898313">.</span><span class="ident" id="7898314">Write</span><span class="op" id="7898319">(</span><span class="op" id="7898320">[</span><span class="op" id="7898321">]</span><span class="builtintype" id="7898322">byte</span><span class="op" id="7898326">(</span><span class="string" id="7898327">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="7898357">)</span><span class="op" id="7898358">)</span><span class="op" id="7898359">;</span>&nbsp;<span class="ident" id="7898361">err</span>&nbsp;<span class="op" id="7898365">!=</span>&nbsp;<span class="ident" id="7898368">nil</span>&nbsp;<span class="op" id="7898372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898377">t</span><span class="op" id="7898378">.</span><span class="ident" id="7898379">Fatalf</span><span class="op" id="7898385">(</span><span class="string" id="7898386">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7898409">,</span>&nbsp;<span class="ident" id="7898411">err</span><span class="op" id="7898414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898422">b</span>&nbsp;<span class="op" id="7898424">:=</span>&nbsp;<span class="builtinfunc" id="7898427">make</span><span class="op" id="7898431">(</span><span class="op" id="7898432">[</span><span class="op" id="7898433">]</span><span class="builtintype" id="7898434">byte</span><span class="op" id="7898438">,</span>&nbsp;<span class="num" id="7898440">32</span><span class="op" id="7898442">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898446">if</span>&nbsp;<span class="ident" id="7898449">_</span><span class="op" id="7898450">,</span>&nbsp;<span class="ident" id="7898452">err</span>&nbsp;<span class="op" id="7898456">:=</span>&nbsp;<span class="ident" id="7898459">c</span><span class="op" id="7898460">.</span><span class="ident" id="7898461">Read</span><span class="op" id="7898465">(</span><span class="ident" id="7898466">b</span><span class="op" id="7898467">)</span><span class="op" id="7898468">;</span>&nbsp;<span class="ident" id="7898470">err</span>&nbsp;<span class="op" id="7898474">!=</span>&nbsp;<span class="ident" id="7898477">nil</span>&nbsp;<span class="op" id="7898481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898486">t</span><span class="op" id="7898487">.</span><span class="ident" id="7898488">Fatalf</span><span class="op" id="7898494">(</span><span class="string" id="7898495">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7898517">,</span>&nbsp;<span class="ident" id="7898519">err</span><span class="op" id="7898522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898531">&lt;-</span><span class="ident" id="7898533">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898539">}</span><br>
<span class="lineno"></span><span class="op" id="7898541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7898544">func</span>&nbsp;<span class="ident" id="7898549">TestTCPConcurrentAccept</span><span class="op" id="7898572">(</span><span class="ident" id="7898573">t</span>&nbsp;<span class="op" id="7898575">*</span><span class="ident" id="7898576">testing</span><span class="op" id="7898583">.</span><span class="ident" id="7898584">T</span><span class="op" id="7898585">)</span>&nbsp;<span class="op" id="7898587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898590">defer</span>&nbsp;<span class="ident" id="7898596">runtime</span><span class="op" id="7898603">.</span><span class="ident" id="7898604">GOMAXPROCS</span><span class="op" id="7898614">(</span><span class="ident" id="7898615">runtime</span><span class="op" id="7898622">.</span><span class="ident" id="7898623">GOMAXPROCS</span><span class="op" id="7898633">(</span><span class="num" id="7898634">4</span><span class="op" id="7898635">)</span><span class="op" id="7898636">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898639">ln</span><span class="op" id="7898641">,</span>&nbsp;<span class="ident" id="7898643">err</span>&nbsp;<span class="op" id="7898647">:=</span>&nbsp;<span class="ident" id="7898650">Listen</span><span class="op" id="7898656">(</span><span class="string" id="7898657">&#34;tcp&#34;</span><span class="op" id="7898662">,</span>&nbsp;<span class="string" id="7898664">&#34;127.0.0.1:0&#34;</span><span class="op" id="7898677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898680">if</span>&nbsp;<span class="ident" id="7898683">err</span>&nbsp;<span class="op" id="7898687">!=</span>&nbsp;<span class="ident" id="7898690">nil</span>&nbsp;<span class="op" id="7898694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898698">t</span><span class="op" id="7898699">.</span><span class="ident" id="7898700">Fatalf</span><span class="op" id="7898706">(</span><span class="string" id="7898707">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7898726">,</span>&nbsp;<span class="ident" id="7898728">err</span><span class="op" id="7898731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898737">const</span>&nbsp;<span class="ident" id="7898743">N</span>&nbsp;<span class="op" id="7898745">=</span>&nbsp;<span class="num" id="7898747">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898751">var</span>&nbsp;<span class="ident" id="7898755">wg</span>&nbsp;<span class="ident" id="7898758">sync</span><span class="op" id="7898762">.</span><span class="ident" id="7898763">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898774">wg</span><span class="op" id="7898776">.</span><span class="ident" id="7898777">Add</span><span class="op" id="7898780">(</span><span class="ident" id="7898781">N</span><span class="op" id="7898782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898785">for</span>&nbsp;<span class="ident" id="7898789">i</span>&nbsp;<span class="op" id="7898791">:=</span>&nbsp;<span class="num" id="7898794">0</span><span class="op" id="7898795">;</span>&nbsp;<span class="ident" id="7898797">i</span>&nbsp;<span class="op" id="7898799">&lt;</span>&nbsp;<span class="ident" id="7898801">N</span><span class="op" id="7898802">;</span>&nbsp;<span class="ident" id="7898804">i</span><span class="op" id="7898805">++</span>&nbsp;<span class="op" id="7898808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898812">go</span>&nbsp;<span class="keyword" id="7898815">func</span><span class="op" id="7898819">(</span><span class="op" id="7898820">)</span>&nbsp;<span class="op" id="7898822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898827">for</span>&nbsp;<span class="op" id="7898831">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898837">c</span><span class="op" id="7898838">,</span>&nbsp;<span class="ident" id="7898840">err</span>&nbsp;<span class="op" id="7898844">:=</span>&nbsp;<span class="ident" id="7898847">ln</span><span class="op" id="7898849">.</span><span class="ident" id="7898850">Accept</span><span class="op" id="7898856">(</span><span class="op" id="7898857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898863">if</span>&nbsp;<span class="ident" id="7898866">err</span>&nbsp;<span class="op" id="7898870">!=</span>&nbsp;<span class="ident" id="7898873">nil</span>&nbsp;<span class="op" id="7898877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898884">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898900">c</span><span class="op" id="7898901">.</span><span class="ident" id="7898902">Close</span><span class="op" id="7898907">(</span><span class="op" id="7898908">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898918">wg</span><span class="op" id="7898920">.</span><span class="ident" id="7898921">Done</span><span class="op" id="7898925">(</span><span class="op" id="7898926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898930">}</span><span class="op" id="7898931">(</span><span class="op" id="7898932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898938">attempts</span>&nbsp;<span class="op" id="7898947">:=</span>&nbsp;<span class="num" id="7898950">10</span>&nbsp;<span class="op" id="7898953">*</span>&nbsp;<span class="ident" id="7898955">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898958">fails</span>&nbsp;<span class="op" id="7898964">:=</span>&nbsp;<span class="num" id="7898967">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898970">d</span>&nbsp;<span class="op" id="7898972">:=</span>&nbsp;<span class="op" id="7898975">&amp;</span><span class="ident" id="7898976">Dialer</span><span class="op" id="7898982">{</span><span class="ident" id="7898983">Timeout</span><span class="op" id="7898990">:</span>&nbsp;<span class="num" id="7898992">200</span>&nbsp;<span class="op" id="7898996">*</span>&nbsp;<span class="ident" id="7898998">time</span><span class="op" id="7899002">.</span><span class="ident" id="7899003">Millisecond</span><span class="op" id="7899014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899017">for</span>&nbsp;<span class="ident" id="7899021">i</span>&nbsp;<span class="op" id="7899023">:=</span>&nbsp;<span class="num" id="7899026">0</span><span class="op" id="7899027">;</span>&nbsp;<span class="ident" id="7899029">i</span>&nbsp;<span class="op" id="7899031">&lt;</span>&nbsp;<span class="ident" id="7899033">attempts</span><span class="op" id="7899041">;</span>&nbsp;<span class="ident" id="7899043">i</span><span class="op" id="7899044">++</span>&nbsp;<span class="op" id="7899047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899051">c</span><span class="op" id="7899052">,</span>&nbsp;<span class="ident" id="7899054">err</span>&nbsp;<span class="op" id="7899058">:=</span>&nbsp;<span class="ident" id="7899061">d</span><span class="op" id="7899062">.</span><span class="ident" id="7899063">Dial</span><span class="op" id="7899067">(</span><span class="string" id="7899068">&#34;tcp&#34;</span><span class="op" id="7899073">,</span>&nbsp;<span class="ident" id="7899075">ln</span><span class="op" id="7899077">.</span><span class="ident" id="7899078">Addr</span><span class="op" id="7899082">(</span><span class="op" id="7899083">)</span><span class="op" id="7899084">.</span><span class="ident" id="7899085">String</span><span class="op" id="7899091">(</span><span class="op" id="7899092">)</span><span class="op" id="7899093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899097">if</span>&nbsp;<span class="ident" id="7899100">err</span>&nbsp;<span class="op" id="7899104">!=</span>&nbsp;<span class="ident" id="7899107">nil</span>&nbsp;<span class="op" id="7899111">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899116">fails</span><span class="op" id="7899121">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899126">}</span>&nbsp;<span class="keyword" id="7899128">else</span>&nbsp;<span class="op" id="7899133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899138">c</span><span class="op" id="7899139">.</span><span class="ident" id="7899140">Close</span><span class="op" id="7899145">(</span><span class="op" id="7899146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899153">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899156">ln</span><span class="op" id="7899158">.</span><span class="ident" id="7899159">Close</span><span class="op" id="7899164">(</span><span class="op" id="7899165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899168">wg</span><span class="op" id="7899170">.</span><span class="ident" id="7899171">Wait</span><span class="op" id="7899175">(</span><span class="op" id="7899176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899179">if</span>&nbsp;<span class="ident" id="7899182">fails</span>&nbsp;<span class="op" id="7899188">&gt;</span>&nbsp;<span class="ident" id="7899190">attempts</span><span class="op" id="7899198">/</span><span class="num" id="7899199">9</span>&nbsp;<span class="op" id="7899201">{</span>&nbsp;<span class="comment" id="7899203">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899233">t</span><span class="op" id="7899234">.</span><span class="ident" id="7899235">Fatalf</span><span class="op" id="7899241">(</span><span class="string" id="7899242">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7899268">,</span>&nbsp;<span class="ident" id="7899270">fails</span><span class="op" id="7899275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899278">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899281">if</span>&nbsp;<span class="ident" id="7899284">fails</span>&nbsp;<span class="op" id="7899290">&gt;</span>&nbsp;<span class="num" id="7899292">0</span>&nbsp;<span class="op" id="7899294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899298">t</span><span class="op" id="7899299">.</span><span class="ident" id="7899300">Logf</span><span class="op" id="7899304">(</span><span class="string" id="7899305">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="7899328">,</span>&nbsp;<span class="ident" id="7899330">fails</span><span class="op" id="7899335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899338">}</span><br>
<span class="lineno"></span><span class="op" id="7899340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="7899343">func</span>&nbsp;<span class="ident" id="7899348">TestTCPReadWriteMallocs</span><span class="op" id="7899371">(</span><span class="ident" id="7899372">t</span>&nbsp;<span class="op" id="7899374">*</span><span class="ident" id="7899375">testing</span><span class="op" id="7899382">.</span><span class="ident" id="7899383">T</span><span class="op" id="7899384">)</span>&nbsp;<span class="op" id="7899386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899389">if</span>&nbsp;<span class="ident" id="7899392">testing</span><span class="op" id="7899399">.</span><span class="ident" id="7899400">Short</span><span class="op" id="7899405">(</span><span class="op" id="7899406">)</span>&nbsp;<span class="op" id="7899408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899412">t</span><span class="op" id="7899413">.</span><span class="ident" id="7899414">Skip</span><span class="op" id="7899418">(</span><span class="string" id="7899419">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7899456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899462">ln</span><span class="op" id="7899464">,</span>&nbsp;<span class="ident" id="7899466">err</span>&nbsp;<span class="op" id="7899470">:=</span>&nbsp;<span class="ident" id="7899473">Listen</span><span class="op" id="7899479">(</span><span class="string" id="7899480">&#34;tcp&#34;</span><span class="op" id="7899485">,</span>&nbsp;<span class="string" id="7899487">&#34;127.0.0.1:0&#34;</span><span class="op" id="7899500">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899503">if</span>&nbsp;<span class="ident" id="7899506">err</span>&nbsp;<span class="op" id="7899510">!=</span>&nbsp;<span class="ident" id="7899513">nil</span>&nbsp;<span class="op" id="7899517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899521">t</span><span class="op" id="7899522">.</span><span class="ident" id="7899523">Fatalf</span><span class="op" id="7899529">(</span><span class="string" id="7899530">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7899549">,</span>&nbsp;<span class="ident" id="7899551">err</span><span class="op" id="7899554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899560">defer</span>&nbsp;<span class="ident" id="7899566">ln</span><span class="op" id="7899568">.</span><span class="ident" id="7899569">Close</span><span class="op" id="7899574">(</span><span class="op" id="7899575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899578">var</span>&nbsp;<span class="ident" id="7899582">server</span>&nbsp;<span class="ident" id="7899589">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899595">errc</span>&nbsp;<span class="op" id="7899600">:=</span>&nbsp;<span class="builtinfunc" id="7899603">make</span><span class="op" id="7899607">(</span><span class="keyword" id="7899608">chan</span>&nbsp;<span class="builtintype" id="7899613">error</span><span class="op" id="7899618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899621">go</span>&nbsp;<span class="keyword" id="7899624">func</span><span class="op" id="7899628">(</span><span class="op" id="7899629">)</span>&nbsp;<span class="op" id="7899631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899635">var</span>&nbsp;<span class="ident" id="7899639">err</span>&nbsp;<span class="builtintype" id="7899643">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899651">server</span><span class="op" id="7899657">,</span>&nbsp;<span class="ident" id="7899659">err</span>&nbsp;<span class="op" id="7899663">=</span>&nbsp;<span class="ident" id="7899665">ln</span><span class="op" id="7899667">.</span><span class="ident" id="7899668">Accept</span><span class="op" id="7899674">(</span><span class="op" id="7899675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899679">errc</span>&nbsp;<span class="op" id="7899684">&lt;-</span>&nbsp;<span class="ident" id="7899687">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899692">}</span><span class="op" id="7899693">(</span><span class="op" id="7899694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899697">client</span><span class="op" id="7899703">,</span>&nbsp;<span class="ident" id="7899705">err</span>&nbsp;<span class="op" id="7899709">:=</span>&nbsp;<span class="ident" id="7899712">Dial</span><span class="op" id="7899716">(</span><span class="string" id="7899717">&#34;tcp&#34;</span><span class="op" id="7899722">,</span>&nbsp;<span class="ident" id="7899724">ln</span><span class="op" id="7899726">.</span><span class="ident" id="7899727">Addr</span><span class="op" id="7899731">(</span><span class="op" id="7899732">)</span><span class="op" id="7899733">.</span><span class="ident" id="7899734">String</span><span class="op" id="7899740">(</span><span class="op" id="7899741">)</span><span class="op" id="7899742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899745">if</span>&nbsp;<span class="ident" id="7899748">err</span>&nbsp;<span class="op" id="7899752">!=</span>&nbsp;<span class="ident" id="7899755">nil</span>&nbsp;<span class="op" id="7899759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899763">t</span><span class="op" id="7899764">.</span><span class="ident" id="7899765">Fatalf</span><span class="op" id="7899771">(</span><span class="string" id="7899772">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7899789">,</span>&nbsp;<span class="ident" id="7899791">err</span><span class="op" id="7899794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899797">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899800">if</span>&nbsp;<span class="ident" id="7899803">err</span>&nbsp;<span class="op" id="7899807">:=</span>&nbsp;<span class="op" id="7899810">&lt;-</span><span class="ident" id="7899812">errc</span><span class="op" id="7899816">;</span>&nbsp;<span class="ident" id="7899818">err</span>&nbsp;<span class="op" id="7899822">!=</span>&nbsp;<span class="ident" id="7899825">nil</span>&nbsp;<span class="op" id="7899829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899833">t</span><span class="op" id="7899834">.</span><span class="ident" id="7899835">Fatalf</span><span class="op" id="7899841">(</span><span class="string" id="7899842">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7899861">,</span>&nbsp;<span class="ident" id="7899863">err</span><span class="op" id="7899866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899872">defer</span>&nbsp;<span class="ident" id="7899878">server</span><span class="op" id="7899884">.</span><span class="ident" id="7899885">Close</span><span class="op" id="7899890">(</span><span class="op" id="7899891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899894">var</span>&nbsp;<span class="ident" id="7899898">buf</span>&nbsp;<span class="op" id="7899902">[</span><span class="num" id="7899903">128</span><span class="op" id="7899906">]</span><span class="builtintype" id="7899907">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899913">mallocs</span>&nbsp;<span class="op" id="7899921">:=</span>&nbsp;<span class="ident" id="7899924">testing</span><span class="op" id="7899931">.</span><span class="ident" id="7899932">AllocsPerRun</span><span class="op" id="7899944">(</span><span class="num" id="7899945">1000</span><span class="op" id="7899949">,</span>&nbsp;<span class="keyword" id="7899951">func</span><span class="op" id="7899955">(</span><span class="op" id="7899956">)</span>&nbsp;<span class="op" id="7899958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899962">_</span><span class="op" id="7899963">,</span>&nbsp;<span class="ident" id="7899965">err</span>&nbsp;<span class="op" id="7899969">:=</span>&nbsp;<span class="ident" id="7899972">server</span><span class="op" id="7899978">.</span><span class="ident" id="7899979">Write</span><span class="op" id="7899984">(</span><span class="ident" id="7899985">buf</span><span class="op" id="7899988">[</span><span class="op" id="7899989">:</span><span class="op" id="7899990">]</span><span class="op" id="7899991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899995">if</span>&nbsp;<span class="ident" id="7899998">err</span>&nbsp;<span class="op" id="7900002">!=</span>&nbsp;<span class="ident" id="7900005">nil</span>&nbsp;<span class="op" id="7900009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900014">t</span><span class="op" id="7900015">.</span><span class="ident" id="7900016">Fatalf</span><span class="op" id="7900022">(</span><span class="string" id="7900023">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7900041">,</span>&nbsp;<span class="ident" id="7900043">err</span><span class="op" id="7900046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900050">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900054">_</span><span class="op" id="7900055">,</span>&nbsp;<span class="ident" id="7900057">err</span>&nbsp;<span class="op" id="7900061">=</span>&nbsp;<span class="ident" id="7900063">io</span><span class="op" id="7900065">.</span><span class="ident" id="7900066">ReadFull</span><span class="op" id="7900074">(</span><span class="ident" id="7900075">client</span><span class="op" id="7900081">,</span>&nbsp;<span class="ident" id="7900083">buf</span><span class="op" id="7900086">[</span><span class="op" id="7900087">:</span><span class="op" id="7900088">]</span><span class="op" id="7900089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900093">if</span>&nbsp;<span class="ident" id="7900096">err</span>&nbsp;<span class="op" id="7900100">!=</span>&nbsp;<span class="ident" id="7900103">nil</span>&nbsp;<span class="op" id="7900107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900112">t</span><span class="op" id="7900113">.</span><span class="ident" id="7900114">Fatalf</span><span class="op" id="7900120">(</span><span class="string" id="7900121">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7900138">,</span>&nbsp;<span class="ident" id="7900140">err</span><span class="op" id="7900143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900150">}</span><span class="op" id="7900151">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900154">if</span>&nbsp;<span class="ident" id="7900157">mallocs</span>&nbsp;<span class="op" id="7900165">&gt;</span>&nbsp;<span class="num" id="7900167">0</span>&nbsp;<span class="op" id="7900169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900173">t</span><span class="op" id="7900174">.</span><span class="ident" id="7900175">Fatalf</span><span class="op" id="7900181">(</span><span class="string" id="7900182">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="7900205">,</span>&nbsp;<span class="ident" id="7900207">mallocs</span><span class="op" id="7900214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900217">}</span><br>
<span class="lineno"></span><span class="op" id="7900219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7900222">func</span>&nbsp;<span class="ident" id="7900227">TestTCPStress</span><span class="op" id="7900240">(</span><span class="ident" id="7900241">t</span>&nbsp;<span class="op" id="7900243">*</span><span class="ident" id="7900244">testing</span><span class="op" id="7900251">.</span><span class="ident" id="7900252">T</span><span class="op" id="7900253">)</span>&nbsp;<span class="op" id="7900255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900258">const</span>&nbsp;<span class="ident" id="7900264">conns</span>&nbsp;<span class="op" id="7900270">=</span>&nbsp;<span class="num" id="7900272">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900275">const</span>&nbsp;<span class="ident" id="7900281">msgLen</span>&nbsp;<span class="op" id="7900288">=</span>&nbsp;<span class="num" id="7900290">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900295">msgs</span>&nbsp;<span class="op" id="7900300">:=</span>&nbsp;<span class="builtintype" id="7900303">int</span><span class="op" id="7900306">(</span><span class="num" id="7900307">1e4</span><span class="op" id="7900310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900313">if</span>&nbsp;<span class="ident" id="7900316">testing</span><span class="op" id="7900323">.</span><span class="ident" id="7900324">Short</span><span class="op" id="7900329">(</span><span class="op" id="7900330">)</span>&nbsp;<span class="op" id="7900332">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900336">msgs</span>&nbsp;<span class="op" id="7900341">=</span>&nbsp;<span class="num" id="7900343">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900352">sendMsg</span>&nbsp;<span class="op" id="7900360">:=</span>&nbsp;<span class="keyword" id="7900363">func</span><span class="op" id="7900367">(</span><span class="ident" id="7900368">c</span>&nbsp;<span class="ident" id="7900370">Conn</span><span class="op" id="7900374">,</span>&nbsp;<span class="ident" id="7900376">buf</span>&nbsp;<span class="op" id="7900380">[</span><span class="op" id="7900381">]</span><span class="builtintype" id="7900382">byte</span><span class="op" id="7900386">)</span>&nbsp;<span class="builtintype" id="7900388">bool</span>&nbsp;<span class="op" id="7900393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900397">n</span><span class="op" id="7900398">,</span>&nbsp;<span class="ident" id="7900400">err</span>&nbsp;<span class="op" id="7900404">:=</span>&nbsp;<span class="ident" id="7900407">c</span><span class="op" id="7900408">.</span><span class="ident" id="7900409">Write</span><span class="op" id="7900414">(</span><span class="ident" id="7900415">buf</span><span class="op" id="7900418">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900422">if</span>&nbsp;<span class="ident" id="7900425">n</span>&nbsp;<span class="op" id="7900427">!=</span>&nbsp;<span class="builtinfunc" id="7900430">len</span><span class="op" id="7900433">(</span><span class="ident" id="7900434">buf</span><span class="op" id="7900437">)</span>&nbsp;<span class="op" id="7900439">||</span>&nbsp;<span class="ident" id="7900442">err</span>&nbsp;<span class="op" id="7900446">!=</span>&nbsp;<span class="ident" id="7900449">nil</span>&nbsp;<span class="op" id="7900453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900458">t</span><span class="op" id="7900459">.</span><span class="ident" id="7900460">Logf</span><span class="op" id="7900464">(</span><span class="string" id="7900465">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7900483">,</span>&nbsp;<span class="ident" id="7900485">err</span><span class="op" id="7900488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900493">return</span>&nbsp;<span class="builtintype" id="7900500">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900512">return</span>&nbsp;<span class="builtintype" id="7900519">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900528">recvMsg</span>&nbsp;<span class="op" id="7900536">:=</span>&nbsp;<span class="keyword" id="7900539">func</span><span class="op" id="7900543">(</span><span class="ident" id="7900544">c</span>&nbsp;<span class="ident" id="7900546">Conn</span><span class="op" id="7900550">,</span>&nbsp;<span class="ident" id="7900552">buf</span>&nbsp;<span class="op" id="7900556">[</span><span class="op" id="7900557">]</span><span class="builtintype" id="7900558">byte</span><span class="op" id="7900562">)</span>&nbsp;<span class="builtintype" id="7900564">bool</span>&nbsp;<span class="op" id="7900569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900573">for</span>&nbsp;<span class="ident" id="7900577">read</span>&nbsp;<span class="op" id="7900582">:=</span>&nbsp;<span class="num" id="7900585">0</span><span class="op" id="7900586">;</span>&nbsp;<span class="ident" id="7900588">read</span>&nbsp;<span class="op" id="7900593">!=</span>&nbsp;<span class="builtinfunc" id="7900596">len</span><span class="op" id="7900599">(</span><span class="ident" id="7900600">buf</span><span class="op" id="7900603">)</span><span class="op" id="7900604">;</span>&nbsp;<span class="op" id="7900606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900611">n</span><span class="op" id="7900612">,</span>&nbsp;<span class="ident" id="7900614">err</span>&nbsp;<span class="op" id="7900618">:=</span>&nbsp;<span class="ident" id="7900621">c</span><span class="op" id="7900622">.</span><span class="ident" id="7900623">Read</span><span class="op" id="7900627">(</span><span class="ident" id="7900628">buf</span><span class="op" id="7900631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900636">read</span>&nbsp;<span class="op" id="7900641">+=</span>&nbsp;<span class="ident" id="7900644">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900649">if</span>&nbsp;<span class="ident" id="7900652">err</span>&nbsp;<span class="op" id="7900656">!=</span>&nbsp;<span class="ident" id="7900659">nil</span>&nbsp;<span class="op" id="7900663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900669">t</span><span class="op" id="7900670">.</span><span class="ident" id="7900671">Logf</span><span class="op" id="7900675">(</span><span class="string" id="7900676">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7900693">,</span>&nbsp;<span class="ident" id="7900695">err</span><span class="op" id="7900698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900704">return</span>&nbsp;<span class="builtintype" id="7900711">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900724">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900728">return</span>&nbsp;<span class="builtintype" id="7900735">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900745">ln</span><span class="op" id="7900747">,</span>&nbsp;<span class="ident" id="7900749">err</span>&nbsp;<span class="op" id="7900753">:=</span>&nbsp;<span class="ident" id="7900756">Listen</span><span class="op" id="7900762">(</span><span class="string" id="7900763">&#34;tcp&#34;</span><span class="op" id="7900768">,</span>&nbsp;<span class="string" id="7900770">&#34;127.0.0.1:0&#34;</span><span class="op" id="7900783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900786">if</span>&nbsp;<span class="ident" id="7900789">err</span>&nbsp;<span class="op" id="7900793">!=</span>&nbsp;<span class="ident" id="7900796">nil</span>&nbsp;<span class="op" id="7900800">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900804">t</span><span class="op" id="7900805">.</span><span class="ident" id="7900806">Fatalf</span><span class="op" id="7900812">(</span><span class="string" id="7900813">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7900832">,</span>&nbsp;<span class="ident" id="7900834">err</span><span class="op" id="7900837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900843">defer</span>&nbsp;<span class="ident" id="7900849">ln</span><span class="op" id="7900851">.</span><span class="ident" id="7900852">Close</span><span class="op" id="7900857">(</span><span class="op" id="7900858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7900861">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900875">go</span>&nbsp;<span class="keyword" id="7900878">func</span><span class="op" id="7900882">(</span><span class="op" id="7900883">)</span>&nbsp;<span class="op" id="7900885">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900889">for</span>&nbsp;<span class="op" id="7900893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900898">c</span><span class="op" id="7900899">,</span>&nbsp;<span class="ident" id="7900901">err</span>&nbsp;<span class="op" id="7900905">:=</span>&nbsp;<span class="ident" id="7900908">ln</span><span class="op" id="7900910">.</span><span class="ident" id="7900911">Accept</span><span class="op" id="7900917">(</span><span class="op" id="7900918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900923">if</span>&nbsp;<span class="ident" id="7900926">err</span>&nbsp;<span class="op" id="7900930">!=</span>&nbsp;<span class="ident" id="7900933">nil</span>&nbsp;<span class="op" id="7900937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900943">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900952">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7900957">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900982">go</span>&nbsp;<span class="keyword" id="7900985">func</span><span class="op" id="7900989">(</span><span class="ident" id="7900990">c</span>&nbsp;<span class="ident" id="7900992">Conn</span><span class="op" id="7900996">)</span>&nbsp;<span class="op" id="7900998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901004">defer</span>&nbsp;<span class="ident" id="7901010">c</span><span class="op" id="7901011">.</span><span class="ident" id="7901012">Close</span><span class="op" id="7901017">(</span><span class="op" id="7901018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901024">var</span>&nbsp;<span class="ident" id="7901028">buf</span>&nbsp;<span class="op" id="7901032">[</span><span class="ident" id="7901033">msgLen</span><span class="op" id="7901039">]</span><span class="builtintype" id="7901040">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901049">for</span>&nbsp;<span class="ident" id="7901053">m</span>&nbsp;<span class="op" id="7901055">:=</span>&nbsp;<span class="num" id="7901058">0</span><span class="op" id="7901059">;</span>&nbsp;<span class="ident" id="7901061">m</span>&nbsp;<span class="op" id="7901063">&lt;</span>&nbsp;<span class="ident" id="7901065">msgs</span><span class="op" id="7901069">;</span>&nbsp;<span class="ident" id="7901071">m</span><span class="op" id="7901072">++</span>&nbsp;<span class="op" id="7901075">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901082">if</span>&nbsp;<span class="op" id="7901085">!</span><span class="ident" id="7901086">recvMsg</span><span class="op" id="7901093">(</span><span class="ident" id="7901094">c</span><span class="op" id="7901095">,</span>&nbsp;<span class="ident" id="7901097">buf</span><span class="op" id="7901100">[</span><span class="op" id="7901101">:</span><span class="op" id="7901102">]</span><span class="op" id="7901103">)</span>&nbsp;<span class="op" id="7901105">||</span>&nbsp;<span class="op" id="7901108">!</span><span class="ident" id="7901109">sendMsg</span><span class="op" id="7901116">(</span><span class="ident" id="7901117">c</span><span class="op" id="7901118">,</span>&nbsp;<span class="ident" id="7901120">buf</span><span class="op" id="7901123">[</span><span class="op" id="7901124">:</span><span class="op" id="7901125">]</span><span class="op" id="7901126">)</span>&nbsp;<span class="op" id="7901128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901136">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901158">}</span><span class="op" id="7901159">(</span><span class="ident" id="7901160">c</span><span class="op" id="7901161">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901168">}</span><span class="op" id="7901169">(</span><span class="op" id="7901170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7901173">done</span>&nbsp;<span class="op" id="7901178">:=</span>&nbsp;<span class="builtinfunc" id="7901181">make</span><span class="op" id="7901185">(</span><span class="keyword" id="7901186">chan</span>&nbsp;<span class="builtintype" id="7901191">bool</span><span class="op" id="7901195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901198">for</span>&nbsp;<span class="ident" id="7901202">i</span>&nbsp;<span class="op" id="7901204">:=</span>&nbsp;<span class="num" id="7901207">0</span><span class="op" id="7901208">;</span>&nbsp;<span class="ident" id="7901210">i</span>&nbsp;<span class="op" id="7901212">&lt;</span>&nbsp;<span class="ident" id="7901214">conns</span><span class="op" id="7901219">;</span>&nbsp;<span class="ident" id="7901221">i</span><span class="op" id="7901222">++</span>&nbsp;<span class="op" id="7901225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7901229">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901253">go</span>&nbsp;<span class="keyword" id="7901256">func</span><span class="op" id="7901260">(</span><span class="op" id="7901261">)</span>&nbsp;<span class="op" id="7901263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901268">defer</span>&nbsp;<span class="keyword" id="7901274">func</span><span class="op" id="7901278">(</span><span class="op" id="7901279">)</span>&nbsp;<span class="op" id="7901281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7901287">done</span>&nbsp;<span class="op" id="7901292">&lt;-</span>&nbsp;<span class="builtintype" id="7901295">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901303">}</span><span class="op" id="7901304">(</span><span class="op" id="7901305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7901310">c</span><span class="op" id="7901311">,</span>&nbsp;<span class="ident" id="7901313">err</span>&nbsp;<span class="op" id="7901317">:=</span>&nbsp;<span class="ident" id="7901320">Dial</span><span class="op" id="7901324">(</span><span class="string" id="7901325">&#34;tcp&#34;</span><span class="op" id="7901330">,</span>&nbsp;<span class="ident" id="7901332">ln</span><span class="op" id="7901334">.</span><span class="ident" id="7901335">Addr</span><span class="op" id="7901339">(</span><span class="op" id="7901340">)</span><span class="op" id="7901341">.</span><span class="ident" id="7901342">String</span><span class="op" id="7901348">(</span><span class="op" id="7901349">)</span><span class="op" id="7901350">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901355">if</span>&nbsp;<span class="ident" id="7901358">err</span>&nbsp;<span class="op" id="7901362">!=</span>&nbsp;<span class="ident" id="7901365">nil</span>&nbsp;<span class="op" id="7901369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7901375">t</span><span class="op" id="7901376">.</span><span class="ident" id="7901377">Logf</span><span class="op" id="7901381">(</span><span class="string" id="7901382">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7901399">,</span>&nbsp;<span class="ident" id="7901401">err</span><span class="op" id="7901404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901410">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901425">defer</span>&nbsp;<span class="ident" id="7901431">c</span><span class="op" id="7901432">.</span><span class="ident" id="7901433">Close</span><span class="op" id="7901438">(</span><span class="op" id="7901439">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901444">var</span>&nbsp;<span class="ident" id="7901448">buf</span>&nbsp;<span class="op" id="7901452">[</span><span class="ident" id="7901453">msgLen</span><span class="op" id="7901459">]</span><span class="builtintype" id="7901460">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901468">for</span>&nbsp;<span class="ident" id="7901472">m</span>&nbsp;<span class="op" id="7901474">:=</span>&nbsp;<span class="num" id="7901477">0</span><span class="op" id="7901478">;</span>&nbsp;<span class="ident" id="7901480">m</span>&nbsp;<span class="op" id="7901482">&lt;</span>&nbsp;<span class="ident" id="7901484">msgs</span><span class="op" id="7901488">;</span>&nbsp;<span class="ident" id="7901490">m</span><span class="op" id="7901491">++</span>&nbsp;<span class="op" id="7901494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901500">if</span>&nbsp;<span class="op" id="7901503">!</span><span class="ident" id="7901504">sendMsg</span><span class="op" id="7901511">(</span><span class="ident" id="7901512">c</span><span class="op" id="7901513">,</span>&nbsp;<span class="ident" id="7901515">buf</span><span class="op" id="7901518">[</span><span class="op" id="7901519">:</span><span class="op" id="7901520">]</span><span class="op" id="7901521">)</span>&nbsp;<span class="op" id="7901523">||</span>&nbsp;<span class="op" id="7901526">!</span><span class="ident" id="7901527">recvMsg</span><span class="op" id="7901534">(</span><span class="ident" id="7901535">c</span><span class="op" id="7901536">,</span>&nbsp;<span class="ident" id="7901538">buf</span><span class="op" id="7901541">[</span><span class="op" id="7901542">:</span><span class="op" id="7901543">]</span><span class="op" id="7901544">)</span>&nbsp;<span class="op" id="7901546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901553">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901563">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901572">}</span><span class="op" id="7901573">(</span><span class="op" id="7901574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7901580">for</span>&nbsp;<span class="ident" id="7901584">i</span>&nbsp;<span class="op" id="7901586">:=</span>&nbsp;<span class="num" id="7901589">0</span><span class="op" id="7901590">;</span>&nbsp;<span class="ident" id="7901592">i</span>&nbsp;<span class="op" id="7901594">&lt;</span>&nbsp;<span class="ident" id="7901596">conns</span><span class="op" id="7901601">;</span>&nbsp;<span class="ident" id="7901603">i</span><span class="op" id="7901604">++</span>&nbsp;<span class="op" id="7901607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901611">&lt;-</span><span class="ident" id="7901613">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7901619">}</span><br>
<span class="lineno"></span><span class="op" id="7901621">}</span>
</div>
</body>
</html>
