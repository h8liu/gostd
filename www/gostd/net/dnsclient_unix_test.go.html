<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8208146">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8208201">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8208255">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8208306">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8208371">package</span>&nbsp;<span class="ident" id="8208379">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8208384">import</span>&nbsp;<span class="op" id="8208391">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208394">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208400">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208413">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208419">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208427">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208438">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8208449">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8208456">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8208459">var</span>&nbsp;<span class="ident" id="8208463">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="8208489">=</span>&nbsp;<span class="op" id="8208491">[</span><span class="op" id="8208492">]</span><span class="keyword" id="8208493">struct</span>&nbsp;<span class="op" id="8208500">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208503">server</span>&nbsp;&nbsp;<span class="builtintype" id="8208511">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208519">name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8208527">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208535">qtype</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8208543">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208551">timeout</span>&nbsp;<span class="builtintype" id="8208559">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208564">rcode</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8208572">int</span><br>
<span class="lineno">25</span><span class="op" id="8208576">}</span><span class="op" id="8208577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208580">//&nbsp;Querying&nbsp;&#34;com.&#34;&nbsp;with&nbsp;qtype=255&nbsp;usually&nbsp;makes&nbsp;an&nbsp;answer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208639">//&nbsp;which&nbsp;requires&nbsp;more&nbsp;than&nbsp;512&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208679">{</span><span class="string" id="8208680">&#34;8.8.8.8:53&#34;</span><span class="op" id="8208692">,</span>&nbsp;<span class="string" id="8208694">&#34;com.&#34;</span><span class="op" id="8208700">,</span>&nbsp;<span class="ident" id="8208702">dnsTypeALL</span><span class="op" id="8208712">,</span>&nbsp;<span class="num" id="8208714">2</span><span class="op" id="8208715">,</span>&nbsp;<span class="ident" id="8208717">dnsRcodeSuccess</span><span class="op" id="8208732">}</span><span class="op" id="8208733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208736">{</span><span class="string" id="8208737">&#34;8.8.4.4:53&#34;</span><span class="op" id="8208749">,</span>&nbsp;<span class="string" id="8208751">&#34;com.&#34;</span><span class="op" id="8208757">,</span>&nbsp;<span class="ident" id="8208759">dnsTypeALL</span><span class="op" id="8208769">,</span>&nbsp;<span class="num" id="8208771">4</span><span class="op" id="8208772">,</span>&nbsp;<span class="ident" id="8208774">dnsRcodeSuccess</span><span class="op" id="8208789">}</span><span class="op" id="8208790">,</span><br>
<span class="lineno">30</span><span class="op" id="8208792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8208795">func</span>&nbsp;<span class="ident" id="8208800">TestDNSTransportFallback</span><span class="op" id="8208824">(</span><span class="ident" id="8208825">t</span>&nbsp;<span class="op" id="8208827">*</span><span class="ident" id="8208828">testing</span><span class="op" id="8208835">.</span><span class="ident" id="8208836">T</span><span class="op" id="8208837">)</span>&nbsp;<span class="op" id="8208839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208842">if</span>&nbsp;<span class="ident" id="8208845">testing</span><span class="op" id="8208852">.</span><span class="ident" id="8208853">Short</span><span class="op" id="8208858">(</span><span class="op" id="8208859">)</span>&nbsp;<span class="op" id="8208861">||</span>&nbsp;<span class="op" id="8208864">!</span><span class="op" id="8208865">*</span><span class="ident" id="8208866">testExternal</span>&nbsp;<span class="op" id="8208879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208883">t</span><span class="op" id="8208884">.</span><span class="ident" id="8208885">Skip</span><span class="op" id="8208889">(</span><span class="string" id="8208890">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8208931">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208938">for</span>&nbsp;<span class="ident" id="8208942">_</span><span class="op" id="8208943">,</span>&nbsp;<span class="ident" id="8208945">tt</span>&nbsp;<span class="op" id="8208948">:=</span>&nbsp;<span class="keyword" id="8208951">range</span>&nbsp;<span class="ident" id="8208957">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="8208983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208987">timeout</span>&nbsp;<span class="op" id="8208995">:=</span>&nbsp;<span class="ident" id="8208998">time</span><span class="op" id="8209002">.</span><span class="ident" id="8209003">Duration</span><span class="op" id="8209011">(</span><span class="ident" id="8209012">tt</span><span class="op" id="8209014">.</span><span class="ident" id="8209015">timeout</span><span class="op" id="8209022">)</span>&nbsp;<span class="op" id="8209024">*</span>&nbsp;<span class="ident" id="8209026">time</span><span class="op" id="8209030">.</span><span class="ident" id="8209031">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209040">msg</span><span class="op" id="8209043">,</span>&nbsp;<span class="ident" id="8209045">err</span>&nbsp;<span class="op" id="8209049">:=</span>&nbsp;<span class="ident" id="8209052">exchange</span><span class="op" id="8209060">(</span><span class="ident" id="8209061">tt</span><span class="op" id="8209063">.</span><span class="ident" id="8209064">server</span><span class="op" id="8209070">,</span>&nbsp;<span class="ident" id="8209072">tt</span><span class="op" id="8209074">.</span><span class="ident" id="8209075">name</span><span class="op" id="8209079">,</span>&nbsp;<span class="ident" id="8209081">tt</span><span class="op" id="8209083">.</span><span class="ident" id="8209084">qtype</span><span class="op" id="8209089">,</span>&nbsp;<span class="ident" id="8209091">timeout</span><span class="op" id="8209098">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209102">if</span>&nbsp;<span class="ident" id="8209105">err</span>&nbsp;<span class="op" id="8209109">!=</span>&nbsp;<span class="ident" id="8209112">nil</span>&nbsp;<span class="op" id="8209116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209121">t</span><span class="op" id="8209122">.</span><span class="ident" id="8209123">Error</span><span class="op" id="8209128">(</span><span class="ident" id="8209129">err</span><span class="op" id="8209132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209137">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209152">switch</span>&nbsp;<span class="ident" id="8209159">msg</span><span class="op" id="8209162">.</span><span class="ident" id="8209163">rcode</span>&nbsp;<span class="op" id="8209169">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209173">case</span>&nbsp;<span class="ident" id="8209178">tt</span><span class="op" id="8209180">.</span><span class="ident" id="8209181">rcode</span><span class="op" id="8209186">,</span>&nbsp;<span class="ident" id="8209188">dnsRcodeServerFailure</span><span class="op" id="8209209">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209213">default</span><span class="op" id="8209220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209225">t</span><span class="op" id="8209226">.</span><span class="ident" id="8209227">Errorf</span><span class="op" id="8209233">(</span><span class="string" id="8209234">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8209259">,</span>&nbsp;<span class="ident" id="8209261">msg</span><span class="op" id="8209264">.</span><span class="ident" id="8209265">rcode</span><span class="op" id="8209270">,</span>&nbsp;<span class="ident" id="8209272">tt</span><span class="op" id="8209274">.</span><span class="ident" id="8209275">server</span><span class="op" id="8209281">,</span>&nbsp;<span class="ident" id="8209283">tt</span><span class="op" id="8209285">.</span><span class="ident" id="8209286">rcode</span><span class="op" id="8209291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209296">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209307">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209310">}</span><br>
<span class="lineno"></span><span class="op" id="8209312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8209315">//&nbsp;See&nbsp;RFC&nbsp;6761&nbsp;for&nbsp;further&nbsp;information&nbsp;about&nbsp;the&nbsp;reserved,&nbsp;pseudo</span><br>
<span class="lineno"></span><span class="comment" id="8209382">//&nbsp;domain&nbsp;names.</span><br>
<span class="lineno">55</span><span class="keyword" id="8209399">var</span>&nbsp;<span class="ident" id="8209403">specialDomainNameTests</span>&nbsp;<span class="op" id="8209426">=</span>&nbsp;<span class="op" id="8209428">[</span><span class="op" id="8209429">]</span><span class="keyword" id="8209430">struct</span>&nbsp;<span class="op" id="8209437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209440">name</span>&nbsp;&nbsp;<span class="builtintype" id="8209446">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209454">qtype</span>&nbsp;<span class="builtintype" id="8209460">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209468">rcode</span>&nbsp;<span class="builtintype" id="8209474">int</span><br>
<span class="lineno"></span><span class="op" id="8209478">}</span><span class="op" id="8209479">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209482">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;not&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209546">//&nbsp;followings&nbsp;as&nbsp;special.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209573">{</span><span class="string" id="8209574">&#34;1.0.168.192.in-addr.arpa.&#34;</span><span class="op" id="8209601">,</span>&nbsp;<span class="ident" id="8209603">dnsTypePTR</span><span class="op" id="8209613">,</span>&nbsp;<span class="ident" id="8209615">dnsRcodeNameError</span><span class="op" id="8209632">}</span><span class="op" id="8209633">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209636">{</span><span class="string" id="8209637">&#34;test.&#34;</span><span class="op" id="8209644">,</span>&nbsp;<span class="ident" id="8209646">dnsTypeALL</span><span class="op" id="8209656">,</span>&nbsp;<span class="ident" id="8209658">dnsRcodeNameError</span><span class="op" id="8209675">}</span><span class="op" id="8209676">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209679">{</span><span class="string" id="8209680">&#34;example.com.&#34;</span><span class="op" id="8209694">,</span>&nbsp;<span class="ident" id="8209696">dnsTypeALL</span><span class="op" id="8209706">,</span>&nbsp;<span class="ident" id="8209708">dnsRcodeSuccess</span><span class="op" id="8209723">}</span><span class="op" id="8209724">,</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209728">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209788">//&nbsp;followings&nbsp;as&nbsp;special&nbsp;and&nbsp;should&nbsp;not&nbsp;send&nbsp;any&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209847">//&nbsp;Though,&nbsp;we&nbsp;test&nbsp;those&nbsp;names&nbsp;here&nbsp;for&nbsp;verifying&nbsp;nagative</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209907">//&nbsp;answers&nbsp;at&nbsp;DNS&nbsp;query-response&nbsp;interaction&nbsp;level.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209960">{</span><span class="string" id="8209961">&#34;localhost.&#34;</span><span class="op" id="8209973">,</span>&nbsp;<span class="ident" id="8209975">dnsTypeALL</span><span class="op" id="8209985">,</span>&nbsp;<span class="ident" id="8209987">dnsRcodeNameError</span><span class="op" id="8210004">}</span><span class="op" id="8210005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210008">{</span><span class="string" id="8210009">&#34;invalid.&#34;</span><span class="op" id="8210019">,</span>&nbsp;<span class="ident" id="8210021">dnsTypeALL</span><span class="op" id="8210031">,</span>&nbsp;<span class="ident" id="8210033">dnsRcodeNameError</span><span class="op" id="8210050">}</span><span class="op" id="8210051">,</span><br>
<span class="lineno"></span><span class="op" id="8210053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8210056">func</span>&nbsp;<span class="ident" id="8210061">TestSpecialDomainName</span><span class="op" id="8210082">(</span><span class="ident" id="8210083">t</span>&nbsp;<span class="op" id="8210085">*</span><span class="ident" id="8210086">testing</span><span class="op" id="8210093">.</span><span class="ident" id="8210094">T</span><span class="op" id="8210095">)</span>&nbsp;<span class="op" id="8210097">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210100">if</span>&nbsp;<span class="ident" id="8210103">testing</span><span class="op" id="8210110">.</span><span class="ident" id="8210111">Short</span><span class="op" id="8210116">(</span><span class="op" id="8210117">)</span>&nbsp;<span class="op" id="8210119">||</span>&nbsp;<span class="op" id="8210122">!</span><span class="op" id="8210123">*</span><span class="ident" id="8210124">testExternal</span>&nbsp;<span class="op" id="8210137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210141">t</span><span class="op" id="8210142">.</span><span class="ident" id="8210143">Skip</span><span class="op" id="8210147">(</span><span class="string" id="8210148">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8210189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210196">server</span>&nbsp;<span class="op" id="8210203">:=</span>&nbsp;<span class="string" id="8210206">&#34;8.8.8.8:53&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210220">for</span>&nbsp;<span class="ident" id="8210224">_</span><span class="op" id="8210225">,</span>&nbsp;<span class="ident" id="8210227">tt</span>&nbsp;<span class="op" id="8210230">:=</span>&nbsp;<span class="keyword" id="8210233">range</span>&nbsp;<span class="ident" id="8210239">specialDomainNameTests</span>&nbsp;<span class="op" id="8210262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210266">msg</span><span class="op" id="8210269">,</span>&nbsp;<span class="ident" id="8210271">err</span>&nbsp;<span class="op" id="8210275">:=</span>&nbsp;<span class="ident" id="8210278">exchange</span><span class="op" id="8210286">(</span><span class="ident" id="8210287">server</span><span class="op" id="8210293">,</span>&nbsp;<span class="ident" id="8210295">tt</span><span class="op" id="8210297">.</span><span class="ident" id="8210298">name</span><span class="op" id="8210302">,</span>&nbsp;<span class="ident" id="8210304">tt</span><span class="op" id="8210306">.</span><span class="ident" id="8210307">qtype</span><span class="op" id="8210312">,</span>&nbsp;<span class="num" id="8210314">0</span><span class="op" id="8210315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210319">if</span>&nbsp;<span class="ident" id="8210322">err</span>&nbsp;<span class="op" id="8210326">!=</span>&nbsp;<span class="ident" id="8210329">nil</span>&nbsp;<span class="op" id="8210333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210338">t</span><span class="op" id="8210339">.</span><span class="ident" id="8210340">Error</span><span class="op" id="8210345">(</span><span class="ident" id="8210346">err</span><span class="op" id="8210349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210354">continue</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210369">switch</span>&nbsp;<span class="ident" id="8210376">msg</span><span class="op" id="8210379">.</span><span class="ident" id="8210380">rcode</span>&nbsp;<span class="op" id="8210386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210390">case</span>&nbsp;<span class="ident" id="8210395">tt</span><span class="op" id="8210397">.</span><span class="ident" id="8210398">rcode</span><span class="op" id="8210403">,</span>&nbsp;<span class="ident" id="8210405">dnsRcodeServerFailure</span><span class="op" id="8210426">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210430">default</span><span class="op" id="8210437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210442">t</span><span class="op" id="8210443">.</span><span class="ident" id="8210444">Errorf</span><span class="op" id="8210450">(</span><span class="string" id="8210451">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8210476">,</span>&nbsp;<span class="ident" id="8210478">msg</span><span class="op" id="8210481">.</span><span class="ident" id="8210482">rcode</span><span class="op" id="8210487">,</span>&nbsp;<span class="ident" id="8210489">server</span><span class="op" id="8210495">,</span>&nbsp;<span class="ident" id="8210497">tt</span><span class="op" id="8210499">.</span><span class="ident" id="8210500">rcode</span><span class="op" id="8210505">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210510">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210524">}</span><br>
<span class="lineno"></span><span class="op" id="8210526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8210529">type</span>&nbsp;<span class="ident" id="8210534">resolvConfTest</span>&nbsp;<span class="keyword" id="8210549">struct</span>&nbsp;<span class="op" id="8210556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210559">*</span><span class="ident" id="8210560">testing</span><span class="op" id="8210567">.</span><span class="ident" id="8210568">T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210571">dir</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8210579">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210587">path</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8210595">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210603">started</span>&nbsp;<span class="builtintype" id="8210611">bool</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210617">quitc</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="8210625">chan</span>&nbsp;<span class="keyword" id="8210630">chan</span>&nbsp;<span class="keyword" id="8210635">struct</span><span class="op" id="8210641">{</span><span class="op" id="8210642">}</span><br>
<span class="lineno"></span><span class="op" id="8210644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8210647">func</span>&nbsp;<span class="ident" id="8210652">newResolvConfTest</span><span class="op" id="8210669">(</span><span class="ident" id="8210670">t</span>&nbsp;<span class="op" id="8210672">*</span><span class="ident" id="8210673">testing</span><span class="op" id="8210680">.</span><span class="ident" id="8210681">T</span><span class="op" id="8210682">)</span>&nbsp;<span class="op" id="8210684">*</span><span class="ident" id="8210685">resolvConfTest</span>&nbsp;<span class="op" id="8210700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210703">dir</span><span class="op" id="8210706">,</span>&nbsp;<span class="ident" id="8210708">err</span>&nbsp;<span class="op" id="8210712">:=</span>&nbsp;<span class="ident" id="8210715">ioutil</span><span class="op" id="8210721">.</span><span class="ident" id="8210722">TempDir</span><span class="op" id="8210729">(</span><span class="string" id="8210730">&#34;&#34;</span><span class="op" id="8210732">,</span>&nbsp;<span class="string" id="8210734">&#34;resolvConfTest&#34;</span><span class="op" id="8210750">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210753">if</span>&nbsp;<span class="ident" id="8210756">err</span>&nbsp;<span class="op" id="8210760">!=</span>&nbsp;<span class="ident" id="8210763">nil</span>&nbsp;<span class="op" id="8210767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210771">t</span><span class="op" id="8210772">.</span><span class="ident" id="8210773">Fatalf</span><span class="op" id="8210779">(</span><span class="string" id="8210780">&#34;could&nbsp;not&nbsp;create&nbsp;temp&nbsp;dir:&nbsp;%v&#34;</span><span class="op" id="8210811">,</span>&nbsp;<span class="ident" id="8210813">err</span><span class="op" id="8210816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8210823">//&nbsp;Disable&nbsp;the&nbsp;default&nbsp;loadConfig</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210858">onceLoadConfig</span><span class="op" id="8210872">.</span><span class="ident" id="8210873">Do</span><span class="op" id="8210875">(</span><span class="keyword" id="8210876">func</span><span class="op" id="8210880">(</span><span class="op" id="8210881">)</span>&nbsp;<span class="op" id="8210883">{</span><span class="op" id="8210884">}</span><span class="op" id="8210885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210889">r</span>&nbsp;<span class="op" id="8210891">:=</span>&nbsp;<span class="op" id="8210894">&amp;</span><span class="ident" id="8210895">resolvConfTest</span><span class="op" id="8210909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210913">T</span><span class="op" id="8210914">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8210920">t</span><span class="op" id="8210921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210925">dir</span><span class="op" id="8210928">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8210932">dir</span><span class="op" id="8210935">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210939">path</span><span class="op" id="8210943">:</span>&nbsp;&nbsp;<span class="ident" id="8210946">path</span><span class="op" id="8210950">.</span><span class="ident" id="8210951">Join</span><span class="op" id="8210955">(</span><span class="ident" id="8210956">dir</span><span class="op" id="8210959">,</span>&nbsp;<span class="string" id="8210961">&#34;resolv.conf&#34;</span><span class="op" id="8210974">)</span><span class="op" id="8210975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210979">quitc</span><span class="op" id="8210984">:</span>&nbsp;<span class="builtinfunc" id="8210986">make</span><span class="op" id="8210990">(</span><span class="keyword" id="8210991">chan</span>&nbsp;<span class="keyword" id="8210996">chan</span>&nbsp;<span class="keyword" id="8211001">struct</span><span class="op" id="8211007">{</span><span class="op" id="8211008">}</span><span class="op" id="8211009">)</span><span class="op" id="8211010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211017">return</span>&nbsp;<span class="ident" id="8211024">r</span><br>
<span class="lineno">120</span><span class="op" id="8211026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8211029">func</span>&nbsp;<span class="op" id="8211034">(</span><span class="ident" id="8211035">r</span>&nbsp;<span class="op" id="8211037">*</span><span class="ident" id="8211038">resolvConfTest</span><span class="op" id="8211052">)</span>&nbsp;<span class="ident" id="8211054">Start</span><span class="op" id="8211059">(</span><span class="op" id="8211060">)</span>&nbsp;<span class="op" id="8211062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211065">loadConfig</span><span class="op" id="8211075">(</span><span class="ident" id="8211076">r</span><span class="op" id="8211077">.</span><span class="ident" id="8211078">path</span><span class="op" id="8211082">,</span>&nbsp;<span class="num" id="8211084">100</span><span class="op" id="8211087">*</span><span class="ident" id="8211088">time</span><span class="op" id="8211092">.</span><span class="ident" id="8211093">Millisecond</span><span class="op" id="8211104">,</span>&nbsp;<span class="ident" id="8211106">r</span><span class="op" id="8211107">.</span><span class="ident" id="8211108">quitc</span><span class="op" id="8211113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211116">r</span><span class="op" id="8211117">.</span><span class="ident" id="8211118">started</span>&nbsp;<span class="op" id="8211126">=</span>&nbsp;<span class="builtintype" id="8211128">true</span><br>
<span class="lineno">125</span><span class="op" id="8211133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8211136">func</span>&nbsp;<span class="op" id="8211141">(</span><span class="ident" id="8211142">r</span>&nbsp;<span class="op" id="8211144">*</span><span class="ident" id="8211145">resolvConfTest</span><span class="op" id="8211159">)</span>&nbsp;<span class="ident" id="8211161">SetConf</span><span class="op" id="8211168">(</span><span class="ident" id="8211169">s</span>&nbsp;<span class="builtintype" id="8211171">string</span><span class="op" id="8211177">)</span>&nbsp;<span class="op" id="8211179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211182">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;file&nbsp;mtime&nbsp;will&nbsp;be&nbsp;different&nbsp;once&nbsp;we&#39;re&nbsp;done&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211251">//&nbsp;even&nbsp;on&nbsp;systems&nbsp;with&nbsp;coarse&nbsp;(1s)&nbsp;mtime&nbsp;resolution.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211306">time</span><span class="op" id="8211310">.</span><span class="ident" id="8211311">Sleep</span><span class="op" id="8211316">(</span><span class="ident" id="8211317">time</span><span class="op" id="8211321">.</span><span class="ident" id="8211322">Second</span><span class="op" id="8211328">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211332">f</span><span class="op" id="8211333">,</span>&nbsp;<span class="ident" id="8211335">err</span>&nbsp;<span class="op" id="8211339">:=</span>&nbsp;<span class="ident" id="8211342">os</span><span class="op" id="8211344">.</span><span class="ident" id="8211345">OpenFile</span><span class="op" id="8211353">(</span><span class="ident" id="8211354">r</span><span class="op" id="8211355">.</span><span class="ident" id="8211356">path</span><span class="op" id="8211360">,</span>&nbsp;<span class="ident" id="8211362">os</span><span class="op" id="8211364">.</span><span class="ident" id="8211365">O_CREATE</span><span class="op" id="8211373">|</span><span class="ident" id="8211374">os</span><span class="op" id="8211376">.</span><span class="ident" id="8211377">O_TRUNC</span><span class="op" id="8211384">|</span><span class="ident" id="8211385">os</span><span class="op" id="8211387">.</span><span class="ident" id="8211388">O_WRONLY</span><span class="op" id="8211396">,</span>&nbsp;<span class="num" id="8211398">0600</span><span class="op" id="8211402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211405">if</span>&nbsp;<span class="ident" id="8211408">err</span>&nbsp;<span class="op" id="8211412">!=</span>&nbsp;<span class="ident" id="8211415">nil</span>&nbsp;<span class="op" id="8211419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211423">r</span><span class="op" id="8211424">.</span><span class="ident" id="8211425">Fatalf</span><span class="op" id="8211431">(</span><span class="string" id="8211432">&#34;failed&nbsp;to&nbsp;create&nbsp;temp&nbsp;file&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8211467">,</span>&nbsp;<span class="ident" id="8211469">r</span><span class="op" id="8211470">.</span><span class="ident" id="8211471">path</span><span class="op" id="8211475">,</span>&nbsp;<span class="ident" id="8211477">err</span><span class="op" id="8211480">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211486">if</span>&nbsp;<span class="ident" id="8211489">_</span><span class="op" id="8211490">,</span>&nbsp;<span class="ident" id="8211492">err</span>&nbsp;<span class="op" id="8211496">:=</span>&nbsp;<span class="ident" id="8211499">io</span><span class="op" id="8211501">.</span><span class="ident" id="8211502">WriteString</span><span class="op" id="8211513">(</span><span class="ident" id="8211514">f</span><span class="op" id="8211515">,</span>&nbsp;<span class="ident" id="8211517">s</span><span class="op" id="8211518">)</span><span class="op" id="8211519">;</span>&nbsp;<span class="ident" id="8211521">err</span>&nbsp;<span class="op" id="8211525">!=</span>&nbsp;<span class="ident" id="8211528">nil</span>&nbsp;<span class="op" id="8211532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211536">f</span><span class="op" id="8211537">.</span><span class="ident" id="8211538">Close</span><span class="op" id="8211543">(</span><span class="op" id="8211544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211548">r</span><span class="op" id="8211549">.</span><span class="ident" id="8211550">Fatalf</span><span class="op" id="8211556">(</span><span class="string" id="8211557">&#34;failed&nbsp;to&nbsp;write&nbsp;temp&nbsp;file:&nbsp;%v&#34;</span><span class="op" id="8211588">,</span>&nbsp;<span class="ident" id="8211590">err</span><span class="op" id="8211593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211596">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211599">f</span><span class="op" id="8211600">.</span><span class="ident" id="8211601">Close</span><span class="op" id="8211606">(</span><span class="op" id="8211607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211611">if</span>&nbsp;<span class="ident" id="8211614">r</span><span class="op" id="8211615">.</span><span class="ident" id="8211616">started</span>&nbsp;<span class="op" id="8211624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211628">cfg</span><span class="op" id="8211631">.</span><span class="ident" id="8211632">ch</span>&nbsp;<span class="op" id="8211635">&lt;-</span>&nbsp;<span class="keyword" id="8211638">struct</span><span class="op" id="8211644">{</span><span class="op" id="8211645">}</span><span class="op" id="8211646">{</span><span class="op" id="8211647">}</span>&nbsp;<span class="comment" id="8211649">//&nbsp;fill&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211666">cfg</span><span class="op" id="8211669">.</span><span class="ident" id="8211670">ch</span>&nbsp;<span class="op" id="8211673">&lt;-</span>&nbsp;<span class="keyword" id="8211676">struct</span><span class="op" id="8211682">{</span><span class="op" id="8211683">}</span><span class="op" id="8211684">{</span><span class="op" id="8211685">}</span>&nbsp;<span class="comment" id="8211687">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;begin</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211717">cfg</span><span class="op" id="8211720">.</span><span class="ident" id="8211721">ch</span>&nbsp;<span class="op" id="8211724">&lt;-</span>&nbsp;<span class="keyword" id="8211727">struct</span><span class="op" id="8211733">{</span><span class="op" id="8211734">}</span><span class="op" id="8211735">{</span><span class="op" id="8211736">}</span>&nbsp;<span class="comment" id="8211738">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;complete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8211770">}</span><br>
<span class="lineno"></span><span class="op" id="8211772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8211775">func</span>&nbsp;<span class="op" id="8211780">(</span><span class="ident" id="8211781">r</span>&nbsp;<span class="op" id="8211783">*</span><span class="ident" id="8211784">resolvConfTest</span><span class="op" id="8211798">)</span>&nbsp;<span class="ident" id="8211800">WantServers</span><span class="op" id="8211811">(</span><span class="ident" id="8211812">want</span>&nbsp;<span class="op" id="8211817">[</span><span class="op" id="8211818">]</span><span class="builtintype" id="8211819">string</span><span class="op" id="8211825">)</span>&nbsp;<span class="op" id="8211827">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211830">cfg</span><span class="op" id="8211833">.</span><span class="ident" id="8211834">mu</span><span class="op" id="8211836">.</span><span class="ident" id="8211837">RLock</span><span class="op" id="8211842">(</span><span class="op" id="8211843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211846">defer</span>&nbsp;<span class="ident" id="8211852">cfg</span><span class="op" id="8211855">.</span><span class="ident" id="8211856">mu</span><span class="op" id="8211858">.</span><span class="ident" id="8211859">RUnlock</span><span class="op" id="8211866">(</span><span class="op" id="8211867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211870">if</span>&nbsp;<span class="ident" id="8211873">got</span>&nbsp;<span class="op" id="8211877">:=</span>&nbsp;<span class="ident" id="8211880">cfg</span><span class="op" id="8211883">.</span><span class="ident" id="8211884">dnsConfig</span><span class="op" id="8211893">.</span><span class="ident" id="8211894">servers</span><span class="op" id="8211901">;</span>&nbsp;<span class="op" id="8211903">!</span><span class="ident" id="8211904">reflect</span><span class="op" id="8211911">.</span><span class="ident" id="8211912">DeepEqual</span><span class="op" id="8211921">(</span><span class="ident" id="8211922">got</span><span class="op" id="8211925">,</span>&nbsp;<span class="ident" id="8211927">want</span><span class="op" id="8211931">)</span>&nbsp;<span class="op" id="8211933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211937">r</span><span class="op" id="8211938">.</span><span class="ident" id="8211939">Fatalf</span><span class="op" id="8211945">(</span><span class="string" id="8211946">&#34;Unexpected&nbsp;dns&nbsp;server&nbsp;loaded,&nbsp;got&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8211992">,</span>&nbsp;<span class="ident" id="8211994">got</span><span class="op" id="8211997">,</span>&nbsp;<span class="ident" id="8211999">want</span><span class="op" id="8212003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212006">}</span><br>
<span class="lineno">155</span><span class="op" id="8212008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8212011">func</span>&nbsp;<span class="op" id="8212016">(</span><span class="ident" id="8212017">r</span>&nbsp;<span class="op" id="8212019">*</span><span class="ident" id="8212020">resolvConfTest</span><span class="op" id="8212034">)</span>&nbsp;<span class="ident" id="8212036">Close</span><span class="op" id="8212041">(</span><span class="op" id="8212042">)</span>&nbsp;<span class="op" id="8212044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212047">resp</span>&nbsp;<span class="op" id="8212052">:=</span>&nbsp;<span class="builtinfunc" id="8212055">make</span><span class="op" id="8212059">(</span><span class="keyword" id="8212060">chan</span>&nbsp;<span class="keyword" id="8212065">struct</span><span class="op" id="8212071">{</span><span class="op" id="8212072">}</span><span class="op" id="8212073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212076">r</span><span class="op" id="8212077">.</span><span class="ident" id="8212078">quitc</span>&nbsp;<span class="op" id="8212084">&lt;-</span>&nbsp;<span class="ident" id="8212087">resp</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212093">&lt;-</span><span class="ident" id="8212095">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212101">if</span>&nbsp;<span class="ident" id="8212104">err</span>&nbsp;<span class="op" id="8212108">:=</span>&nbsp;<span class="ident" id="8212111">os</span><span class="op" id="8212113">.</span><span class="ident" id="8212114">RemoveAll</span><span class="op" id="8212123">(</span><span class="ident" id="8212124">r</span><span class="op" id="8212125">.</span><span class="ident" id="8212126">dir</span><span class="op" id="8212129">)</span><span class="op" id="8212130">;</span>&nbsp;<span class="ident" id="8212132">err</span>&nbsp;<span class="op" id="8212136">!=</span>&nbsp;<span class="ident" id="8212139">nil</span>&nbsp;<span class="op" id="8212143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212147">r</span><span class="op" id="8212148">.</span><span class="ident" id="8212149">Logf</span><span class="op" id="8212153">(</span><span class="string" id="8212154">&#34;failed&nbsp;to&nbsp;remove&nbsp;temp&nbsp;dir&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8212188">,</span>&nbsp;<span class="ident" id="8212190">r</span><span class="op" id="8212191">.</span><span class="ident" id="8212192">dir</span><span class="op" id="8212195">,</span>&nbsp;<span class="ident" id="8212197">err</span><span class="op" id="8212200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212203">}</span><br>
<span class="lineno"></span><span class="op" id="8212205">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="8212208">func</span>&nbsp;<span class="ident" id="8212213">TestReloadResolvConfFail</span><span class="op" id="8212237">(</span><span class="ident" id="8212238">t</span>&nbsp;<span class="op" id="8212240">*</span><span class="ident" id="8212241">testing</span><span class="op" id="8212248">.</span><span class="ident" id="8212249">T</span><span class="op" id="8212250">)</span>&nbsp;<span class="op" id="8212252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212255">if</span>&nbsp;<span class="ident" id="8212258">testing</span><span class="op" id="8212265">.</span><span class="ident" id="8212266">Short</span><span class="op" id="8212271">(</span><span class="op" id="8212272">)</span>&nbsp;<span class="op" id="8212274">||</span>&nbsp;<span class="op" id="8212277">!</span><span class="op" id="8212278">*</span><span class="ident" id="8212279">testExternal</span>&nbsp;<span class="op" id="8212292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212296">t</span><span class="op" id="8212297">.</span><span class="ident" id="8212298">Skip</span><span class="op" id="8212302">(</span><span class="string" id="8212303">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8212344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212347">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212351">r</span>&nbsp;<span class="op" id="8212353">:=</span>&nbsp;<span class="ident" id="8212356">newResolvConfTest</span><span class="op" id="8212373">(</span><span class="ident" id="8212374">t</span><span class="op" id="8212375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212378">defer</span>&nbsp;<span class="ident" id="8212384">r</span><span class="op" id="8212385">.</span><span class="ident" id="8212386">Close</span><span class="op" id="8212391">(</span><span class="op" id="8212392">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8212396">//&nbsp;resolv.conf.tmp&nbsp;does&nbsp;not&nbsp;exist&nbsp;yet</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212435">r</span><span class="op" id="8212436">.</span><span class="ident" id="8212437">Start</span><span class="op" id="8212442">(</span><span class="op" id="8212443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212446">if</span>&nbsp;<span class="ident" id="8212449">_</span><span class="op" id="8212450">,</span>&nbsp;<span class="ident" id="8212452">err</span>&nbsp;<span class="op" id="8212456">:=</span>&nbsp;<span class="ident" id="8212459">goLookupIP</span><span class="op" id="8212469">(</span><span class="string" id="8212470">&#34;golang.org&#34;</span><span class="op" id="8212482">)</span><span class="op" id="8212483">;</span>&nbsp;<span class="ident" id="8212485">err</span>&nbsp;<span class="op" id="8212489">==</span>&nbsp;<span class="ident" id="8212492">nil</span>&nbsp;<span class="op" id="8212496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212500">t</span><span class="op" id="8212501">.</span><span class="ident" id="8212502">Fatal</span><span class="op" id="8212507">(</span><span class="string" id="8212508">&#34;goLookupIP(missing)&nbsp;succeeded&#34;</span><span class="op" id="8212539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212546">r</span><span class="op" id="8212547">.</span><span class="ident" id="8212548">SetConf</span><span class="op" id="8212555">(</span><span class="string" id="8212556">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="8212576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212579">if</span>&nbsp;<span class="ident" id="8212582">_</span><span class="op" id="8212583">,</span>&nbsp;<span class="ident" id="8212585">err</span>&nbsp;<span class="op" id="8212589">:=</span>&nbsp;<span class="ident" id="8212592">goLookupIP</span><span class="op" id="8212602">(</span><span class="string" id="8212603">&#34;golang.org&#34;</span><span class="op" id="8212615">)</span><span class="op" id="8212616">;</span>&nbsp;<span class="ident" id="8212618">err</span>&nbsp;<span class="op" id="8212622">!=</span>&nbsp;<span class="ident" id="8212625">nil</span>&nbsp;<span class="op" id="8212629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212633">t</span><span class="op" id="8212634">.</span><span class="ident" id="8212635">Fatalf</span><span class="op" id="8212641">(</span><span class="string" id="8212642">&#34;goLookupIP(missing;&nbsp;good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8212680">,</span>&nbsp;<span class="ident" id="8212682">err</span><span class="op" id="8212685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8212692">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;while&nbsp;we&nbsp;had&nbsp;a&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8212740">//&nbsp;one&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212784">r</span><span class="op" id="8212785">.</span><span class="ident" id="8212786">SetConf</span><span class="op" id="8212793">(</span><span class="string" id="8212794">&#34;&#34;</span><span class="op" id="8212796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212799">if</span>&nbsp;<span class="ident" id="8212802">_</span><span class="op" id="8212803">,</span>&nbsp;<span class="ident" id="8212805">err</span>&nbsp;<span class="op" id="8212809">:=</span>&nbsp;<span class="ident" id="8212812">goLookupIP</span><span class="op" id="8212822">(</span><span class="string" id="8212823">&#34;golang.org&#34;</span><span class="op" id="8212835">)</span><span class="op" id="8212836">;</span>&nbsp;<span class="ident" id="8212838">err</span>&nbsp;<span class="op" id="8212842">!=</span>&nbsp;<span class="ident" id="8212845">nil</span>&nbsp;<span class="op" id="8212849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212853">t</span><span class="op" id="8212854">.</span><span class="ident" id="8212855">Fatalf</span><span class="op" id="8212861">(</span><span class="string" id="8212862">&#34;goLookupIP(missing;&nbsp;good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8212905">,</span>&nbsp;<span class="ident" id="8212907">err</span><span class="op" id="8212910">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212913">}</span><br>
<span class="lineno"></span><span class="op" id="8212915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8212918">func</span>&nbsp;<span class="ident" id="8212923">TestReloadResolvConfChange</span><span class="op" id="8212949">(</span><span class="ident" id="8212950">t</span>&nbsp;<span class="op" id="8212952">*</span><span class="ident" id="8212953">testing</span><span class="op" id="8212960">.</span><span class="ident" id="8212961">T</span><span class="op" id="8212962">)</span>&nbsp;<span class="op" id="8212964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212967">if</span>&nbsp;<span class="ident" id="8212970">testing</span><span class="op" id="8212977">.</span><span class="ident" id="8212978">Short</span><span class="op" id="8212983">(</span><span class="op" id="8212984">)</span>&nbsp;<span class="op" id="8212986">||</span>&nbsp;<span class="op" id="8212989">!</span><span class="op" id="8212990">*</span><span class="ident" id="8212991">testExternal</span>&nbsp;<span class="op" id="8213004">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213008">t</span><span class="op" id="8213009">.</span><span class="ident" id="8213010">Skip</span><span class="op" id="8213014">(</span><span class="string" id="8213015">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8213056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213063">r</span>&nbsp;<span class="op" id="8213065">:=</span>&nbsp;<span class="ident" id="8213068">newResolvConfTest</span><span class="op" id="8213085">(</span><span class="ident" id="8213086">t</span><span class="op" id="8213087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213090">defer</span>&nbsp;<span class="ident" id="8213096">r</span><span class="op" id="8213097">.</span><span class="ident" id="8213098">Close</span><span class="op" id="8213103">(</span><span class="op" id="8213104">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213108">r</span><span class="op" id="8213109">.</span><span class="ident" id="8213110">SetConf</span><span class="op" id="8213117">(</span><span class="string" id="8213118">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="8213138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213141">r</span><span class="op" id="8213142">.</span><span class="ident" id="8213143">Start</span><span class="op" id="8213148">(</span><span class="op" id="8213149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213153">if</span>&nbsp;<span class="ident" id="8213156">_</span><span class="op" id="8213157">,</span>&nbsp;<span class="ident" id="8213159">err</span>&nbsp;<span class="op" id="8213163">:=</span>&nbsp;<span class="ident" id="8213166">goLookupIP</span><span class="op" id="8213176">(</span><span class="string" id="8213177">&#34;golang.org&#34;</span><span class="op" id="8213189">)</span><span class="op" id="8213190">;</span>&nbsp;<span class="ident" id="8213192">err</span>&nbsp;<span class="op" id="8213196">!=</span>&nbsp;<span class="ident" id="8213199">nil</span>&nbsp;<span class="op" id="8213203">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213207">t</span><span class="op" id="8213208">.</span><span class="ident" id="8213209">Fatalf</span><span class="op" id="8213215">(</span><span class="string" id="8213216">&#34;goLookupIP(good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8213245">,</span>&nbsp;<span class="ident" id="8213247">err</span><span class="op" id="8213250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213256">r</span><span class="op" id="8213257">.</span><span class="ident" id="8213258">WantServers</span><span class="op" id="8213269">(</span><span class="op" id="8213270">[</span><span class="op" id="8213271">]</span><span class="builtintype" id="8213272">string</span><span class="op" id="8213278">{</span><span class="string" id="8213279">&#34;8.8.8.8&#34;</span><span class="op" id="8213288">}</span><span class="op" id="8213289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8213293">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;when&nbsp;we&nbsp;had&nbsp;a&nbsp;good&nbsp;one</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8213344">//&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213384">r</span><span class="op" id="8213385">.</span><span class="ident" id="8213386">SetConf</span><span class="op" id="8213393">(</span><span class="string" id="8213394">&#34;&#34;</span><span class="op" id="8213396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213399">if</span>&nbsp;<span class="ident" id="8213402">_</span><span class="op" id="8213403">,</span>&nbsp;<span class="ident" id="8213405">err</span>&nbsp;<span class="op" id="8213409">:=</span>&nbsp;<span class="ident" id="8213412">goLookupIP</span><span class="op" id="8213422">(</span><span class="string" id="8213423">&#34;golang.org&#34;</span><span class="op" id="8213435">)</span><span class="op" id="8213436">;</span>&nbsp;<span class="ident" id="8213438">err</span>&nbsp;<span class="op" id="8213442">!=</span>&nbsp;<span class="ident" id="8213445">nil</span>&nbsp;<span class="op" id="8213449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213453">t</span><span class="op" id="8213454">.</span><span class="ident" id="8213455">Fatalf</span><span class="op" id="8213461">(</span><span class="string" id="8213462">&#34;goLookupIP(good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8213496">,</span>&nbsp;<span class="ident" id="8213498">err</span><span class="op" id="8213501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213504">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8213508">//&nbsp;A&nbsp;new&nbsp;good&nbsp;config&nbsp;should&nbsp;get&nbsp;picked&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213551">r</span><span class="op" id="8213552">.</span><span class="ident" id="8213553">SetConf</span><span class="op" id="8213560">(</span><span class="string" id="8213561">&#34;nameserver&nbsp;8.8.4.4&#34;</span><span class="op" id="8213581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213584">r</span><span class="op" id="8213585">.</span><span class="ident" id="8213586">WantServers</span><span class="op" id="8213597">(</span><span class="op" id="8213598">[</span><span class="op" id="8213599">]</span><span class="builtintype" id="8213600">string</span><span class="op" id="8213606">{</span><span class="string" id="8213607">&#34;8.8.4.4&#34;</span><span class="op" id="8213616">}</span><span class="op" id="8213617">)</span><br>
<span class="lineno"></span><span class="op" id="8213619">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="8213622">func</span>&nbsp;<span class="ident" id="8213627">BenchmarkGoLookupIP</span><span class="op" id="8213646">(</span><span class="ident" id="8213647">b</span>&nbsp;<span class="op" id="8213649">*</span><span class="ident" id="8213650">testing</span><span class="op" id="8213657">.</span><span class="ident" id="8213658">B</span><span class="op" id="8213659">)</span>&nbsp;<span class="op" id="8213661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213664">for</span>&nbsp;<span class="ident" id="8213668">i</span>&nbsp;<span class="op" id="8213670">:=</span>&nbsp;<span class="num" id="8213673">0</span><span class="op" id="8213674">;</span>&nbsp;<span class="ident" id="8213676">i</span>&nbsp;<span class="op" id="8213678">&lt;</span>&nbsp;<span class="ident" id="8213680">b</span><span class="op" id="8213681">.</span><span class="ident" id="8213682">N</span><span class="op" id="8213683">;</span>&nbsp;<span class="ident" id="8213685">i</span><span class="op" id="8213686">++</span>&nbsp;<span class="op" id="8213689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213693">goLookupIP</span><span class="op" id="8213703">(</span><span class="string" id="8213704">&#34;www.example.com&#34;</span><span class="op" id="8213721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213724">}</span><br>
<span class="lineno">225</span><span class="op" id="8213726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8213729">func</span>&nbsp;<span class="ident" id="8213734">BenchmarkGoLookupIPNoSuchHost</span><span class="op" id="8213763">(</span><span class="ident" id="8213764">b</span>&nbsp;<span class="op" id="8213766">*</span><span class="ident" id="8213767">testing</span><span class="op" id="8213774">.</span><span class="ident" id="8213775">B</span><span class="op" id="8213776">)</span>&nbsp;<span class="op" id="8213778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213781">for</span>&nbsp;<span class="ident" id="8213785">i</span>&nbsp;<span class="op" id="8213787">:=</span>&nbsp;<span class="num" id="8213790">0</span><span class="op" id="8213791">;</span>&nbsp;<span class="ident" id="8213793">i</span>&nbsp;<span class="op" id="8213795">&lt;</span>&nbsp;<span class="ident" id="8213797">b</span><span class="op" id="8213798">.</span><span class="ident" id="8213799">N</span><span class="op" id="8213800">;</span>&nbsp;<span class="ident" id="8213802">i</span><span class="op" id="8213803">++</span>&nbsp;<span class="op" id="8213806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213810">goLookupIP</span><span class="op" id="8213820">(</span><span class="string" id="8213821">&#34;some.nonexistent&#34;</span><span class="op" id="8213839">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8213842">}</span><br>
<span class="lineno"></span><span class="op" id="8213844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8213847">func</span>&nbsp;<span class="ident" id="8213852">BenchmarkGoLookupIPWithBrokenNameServer</span><span class="op" id="8213891">(</span><span class="ident" id="8213892">b</span>&nbsp;<span class="op" id="8213894">*</span><span class="ident" id="8213895">testing</span><span class="op" id="8213902">.</span><span class="ident" id="8213903">B</span><span class="op" id="8213904">)</span>&nbsp;<span class="op" id="8213906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213909">onceLoadConfig</span><span class="op" id="8213923">.</span><span class="ident" id="8213924">Do</span><span class="op" id="8213926">(</span><span class="ident" id="8213927">loadDefaultConfig</span><span class="op" id="8213944">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8213947">if</span>&nbsp;<span class="ident" id="8213950">cfg</span><span class="op" id="8213953">.</span><span class="ident" id="8213954">dnserr</span>&nbsp;<span class="op" id="8213961">!=</span>&nbsp;<span class="ident" id="8213964">nil</span>&nbsp;<span class="op" id="8213968">||</span>&nbsp;<span class="ident" id="8213971">cfg</span><span class="op" id="8213974">.</span><span class="ident" id="8213975">dnsConfig</span>&nbsp;<span class="op" id="8213985">==</span>&nbsp;<span class="ident" id="8213988">nil</span>&nbsp;<span class="op" id="8213992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8213996">b</span><span class="op" id="8213997">.</span><span class="ident" id="8213998">Fatalf</span><span class="op" id="8214004">(</span><span class="string" id="8214005">&#34;loadConfig&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8214028">,</span>&nbsp;<span class="ident" id="8214030">cfg</span><span class="op" id="8214033">.</span><span class="ident" id="8214034">dnserr</span><span class="op" id="8214040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8214043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8214046">//&nbsp;This&nbsp;looks&nbsp;ugly&nbsp;but&nbsp;it&#39;s&nbsp;safe&nbsp;as&nbsp;long&nbsp;as&nbsp;benchmarks&nbsp;are&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8214110">//&nbsp;sequentially&nbsp;in&nbsp;package&nbsp;testing.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8214147">orig</span>&nbsp;<span class="op" id="8214152">:=</span>&nbsp;<span class="ident" id="8214155">cfg</span><span class="op" id="8214158">.</span><span class="ident" id="8214159">dnsConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8214170">cfg</span><span class="op" id="8214173">.</span><span class="ident" id="8214174">dnsConfig</span><span class="op" id="8214183">.</span><span class="ident" id="8214184">servers</span>&nbsp;<span class="op" id="8214192">=</span>&nbsp;<span class="builtinfunc" id="8214194">append</span><span class="op" id="8214200">(</span><span class="op" id="8214201">[</span><span class="op" id="8214202">]</span><span class="builtintype" id="8214203">string</span><span class="op" id="8214209">{</span><span class="string" id="8214210">&#34;203.0.113.254&#34;</span><span class="op" id="8214225">}</span><span class="op" id="8214226">,</span>&nbsp;<span class="ident" id="8214228">cfg</span><span class="op" id="8214231">.</span><span class="ident" id="8214232">dnsConfig</span><span class="op" id="8214241">.</span><span class="ident" id="8214242">servers</span><span class="op" id="8214249">...</span><span class="op" id="8214252">)</span>&nbsp;<span class="comment" id="8214254">//&nbsp;use&nbsp;TEST-NET-3&nbsp;block,&nbsp;see&nbsp;RFC&nbsp;5737</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8214293">for</span>&nbsp;<span class="ident" id="8214297">i</span>&nbsp;<span class="op" id="8214299">:=</span>&nbsp;<span class="num" id="8214302">0</span><span class="op" id="8214303">;</span>&nbsp;<span class="ident" id="8214305">i</span>&nbsp;<span class="op" id="8214307">&lt;</span>&nbsp;<span class="ident" id="8214309">b</span><span class="op" id="8214310">.</span><span class="ident" id="8214311">N</span><span class="op" id="8214312">;</span>&nbsp;<span class="ident" id="8214314">i</span><span class="op" id="8214315">++</span>&nbsp;<span class="op" id="8214318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8214322">goLookupIP</span><span class="op" id="8214332">(</span><span class="string" id="8214333">&#34;www.example.com&#34;</span><span class="op" id="8214350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8214353">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8214356">cfg</span><span class="op" id="8214359">.</span><span class="ident" id="8214360">dnsConfig</span>&nbsp;<span class="op" id="8214370">=</span>&nbsp;<span class="ident" id="8214372">orig</span><br>
<span class="lineno"></span><span class="op" id="8214377">}</span>
</div>
</body>
</html>
