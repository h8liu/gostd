<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>reflect</h2>
<ul>
<li><a href="/gostd/reflect/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/reflect/deepequal.go.html">deepequal.go</a></li>
<li><a href="/gostd/reflect/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/reflect/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/reflect/makefunc.go.html" class="current">makefunc.go</a></li>
<li><a href="/gostd/reflect/set_test.go.html">set_test.go</a></li>
<li><a href="/gostd/reflect/tostring_test.go.html">tostring_test.go</a></li>
<li><a href="/gostd/reflect/type.go.html">type.go</a></li>
<li><a href="/gostd/reflect/value.go.html">value.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2665609">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2665665">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2665719">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2665770">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2665799">package</span>&nbsp;<span class="ident" id="2665807">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2665816">import</span>&nbsp;<span class="op" id="2665823">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2665826">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2665835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2665838">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2665901">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2665926">type</span>&nbsp;<span class="ident" id="2665931">makeFuncImpl</span>&nbsp;<span class="keyword" id="2665944">struct</span>&nbsp;<span class="op" id="2665951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2665954">code</span>&nbsp;&nbsp;<span class="builtintype" id="2665960">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2665969">stack</span>&nbsp;<span class="op" id="2665975">*</span><span class="ident" id="2665976">bitVector</span>&nbsp;<span class="comment" id="2665986">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2666038">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2666044">*</span><span class="ident" id="2666045">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2666055">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2666061">func</span><span class="op" id="2666065">(</span><span class="op" id="2666066">[</span><span class="op" id="2666067">]</span><span class="ident" id="2666068">Value</span><span class="op" id="2666073">)</span>&nbsp;<span class="op" id="2666075">[</span><span class="op" id="2666076">]</span><span class="ident" id="2666077">Value</span><br>
<span class="lineno">20</span><span class="op" id="2666083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2666086">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2666139">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2666201">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2666224">//</span><br>
<span class="lineno"></span><span class="comment" id="2666227">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2666277">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2666308">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2666378">//</span><br>
<span class="lineno">30</span><span class="comment" id="2666381">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2666447">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2666501">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2666568">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2666626">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2666696">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2666754">//</span><br>
<span class="lineno"></span><span class="comment" id="2666757">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2666827">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2666903">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2666943">//</span><br>
<span class="lineno"></span><span class="comment" id="2666946">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2667016">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2667088">//</span><br>
<span class="lineno"></span><span class="keyword" id="2667091">func</span>&nbsp;<span class="ident" id="2667096">MakeFunc</span><span class="op" id="2667104">(</span><span class="ident" id="2667105">typ</span>&nbsp;<span class="ident" id="2667109">Type</span><span class="op" id="2667113">,</span>&nbsp;<span class="ident" id="2667115">fn</span>&nbsp;<span class="keyword" id="2667118">func</span><span class="op" id="2667122">(</span><span class="ident" id="2667123">args</span>&nbsp;<span class="op" id="2667128">[</span><span class="op" id="2667129">]</span><span class="ident" id="2667130">Value</span><span class="op" id="2667135">)</span>&nbsp;<span class="op" id="2667137">(</span><span class="ident" id="2667138">results</span>&nbsp;<span class="op" id="2667146">[</span><span class="op" id="2667147">]</span><span class="ident" id="2667148">Value</span><span class="op" id="2667153">)</span><span class="op" id="2667154">)</span>&nbsp;<span class="ident" id="2667156">Value</span>&nbsp;<span class="op" id="2667162">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2667165">if</span>&nbsp;<span class="ident" id="2667168">typ</span><span class="op" id="2667171">.</span><span class="ident" id="2667172">Kind</span><span class="op" id="2667176">(</span><span class="op" id="2667177">)</span>&nbsp;<span class="op" id="2667179">!=</span>&nbsp;<span class="ident" id="2667182">Func</span>&nbsp;<span class="op" id="2667187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2667191">panic</span><span class="op" id="2667196">(</span><span class="string" id="2667197">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2667243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2667246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2667250">t</span>&nbsp;<span class="op" id="2667252">:=</span>&nbsp;<span class="ident" id="2667255">typ</span><span class="op" id="2667258">.</span><span class="ident" id="2667259">common</span><span class="op" id="2667265">(</span><span class="op" id="2667266">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2667269">ftyp</span>&nbsp;<span class="op" id="2667274">:=</span>&nbsp;<span class="op" id="2667277">(</span><span class="op" id="2667278">*</span><span class="ident" id="2667279">funcType</span><span class="op" id="2667287">)</span><span class="op" id="2667288">(</span><span class="ident" id="2667289">unsafe</span><span class="op" id="2667295">.</span><span class="ident" id="2667296">Pointer</span><span class="op" id="2667303">(</span><span class="ident" id="2667304">t</span><span class="op" id="2667305">)</span><span class="op" id="2667306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2667310">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2667355">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2667410">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2667470">dummy</span>&nbsp;<span class="op" id="2667476">:=</span>&nbsp;<span class="ident" id="2667479">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2667493">code</span>&nbsp;<span class="op" id="2667498">:=</span>&nbsp;<span class="op" id="2667501">*</span><span class="op" id="2667502">*</span><span class="op" id="2667503">(</span><span class="op" id="2667504">*</span><span class="op" id="2667505">*</span><span class="builtintype" id="2667506">uintptr</span><span class="op" id="2667513">)</span><span class="op" id="2667514">(</span><span class="ident" id="2667515">unsafe</span><span class="op" id="2667521">.</span><span class="ident" id="2667522">Pointer</span><span class="op" id="2667529">(</span><span class="op" id="2667530">&amp;</span><span class="ident" id="2667531">dummy</span><span class="op" id="2667536">)</span><span class="op" id="2667537">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2667541">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2667602">_</span><span class="op" id="2667603">,</span>&nbsp;<span class="ident" id="2667605">_</span><span class="op" id="2667606">,</span>&nbsp;<span class="ident" id="2667608">_</span><span class="op" id="2667609">,</span>&nbsp;<span class="ident" id="2667611">stack</span>&nbsp;<span class="op" id="2667617">:=</span>&nbsp;<span class="ident" id="2667620">funcLayout</span><span class="op" id="2667630">(</span><span class="ident" id="2667631">t</span><span class="op" id="2667632">,</span>&nbsp;<span class="ident" id="2667634">nil</span><span class="op" id="2667637">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2667641">impl</span>&nbsp;<span class="op" id="2667646">:=</span>&nbsp;<span class="op" id="2667649">&amp;</span><span class="ident" id="2667650">makeFuncImpl</span><span class="op" id="2667662">{</span><span class="ident" id="2667663">code</span><span class="op" id="2667667">:</span>&nbsp;<span class="ident" id="2667669">code</span><span class="op" id="2667673">,</span>&nbsp;<span class="ident" id="2667675">stack</span><span class="op" id="2667680">:</span>&nbsp;<span class="ident" id="2667682">stack</span><span class="op" id="2667687">,</span>&nbsp;<span class="ident" id="2667689">typ</span><span class="op" id="2667692">:</span>&nbsp;<span class="ident" id="2667694">ftyp</span><span class="op" id="2667698">,</span>&nbsp;<span class="ident" id="2667700">fn</span><span class="op" id="2667702">:</span>&nbsp;<span class="ident" id="2667704">fn</span><span class="op" id="2667706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2667710">return</span>&nbsp;<span class="ident" id="2667717">Value</span><span class="op" id="2667722">{</span><span class="ident" id="2667723">t</span><span class="op" id="2667724">,</span>&nbsp;<span class="ident" id="2667726">unsafe</span><span class="op" id="2667732">.</span><span class="ident" id="2667733">Pointer</span><span class="op" id="2667740">(</span><span class="ident" id="2667741">impl</span><span class="op" id="2667745">)</span><span class="op" id="2667746">,</span>&nbsp;<span class="ident" id="2667748">flag</span><span class="op" id="2667752">(</span><span class="ident" id="2667753">Func</span><span class="op" id="2667757">)</span><span class="op" id="2667758">}</span><br>
<span class="lineno"></span><span class="op" id="2667760">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2667763">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2667828">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2667898">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2667976">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2668050">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2668091">func</span>&nbsp;<span class="ident" id="2668096">makeFuncStub</span><span class="op" id="2668108">(</span><span class="op" id="2668109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2668112">type</span>&nbsp;<span class="ident" id="2668117">methodValue</span>&nbsp;<span class="keyword" id="2668129">struct</span>&nbsp;<span class="op" id="2668136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2668139">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2668146">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2668155">stack</span>&nbsp;&nbsp;<span class="op" id="2668162">*</span><span class="ident" id="2668163">bitVector</span>&nbsp;<span class="comment" id="2668173">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2668225">method</span>&nbsp;<span class="builtintype" id="2668232">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2668237">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2668244">Value</span><br>
<span class="lineno"></span><span class="op" id="2668250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2668253">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2668325">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2668387">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2668455">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2668517">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2668587">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2668656">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2668706">func</span>&nbsp;<span class="ident" id="2668711">makeMethodValue</span><span class="op" id="2668726">(</span><span class="ident" id="2668727">op</span>&nbsp;<span class="builtintype" id="2668730">string</span><span class="op" id="2668736">,</span>&nbsp;<span class="ident" id="2668738">v</span>&nbsp;<span class="ident" id="2668740">Value</span><span class="op" id="2668745">)</span>&nbsp;<span class="ident" id="2668747">Value</span>&nbsp;<span class="op" id="2668753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2668756">if</span>&nbsp;<span class="ident" id="2668759">v</span><span class="op" id="2668760">.</span><span class="ident" id="2668761">flag</span><span class="op" id="2668765">&amp;</span><span class="ident" id="2668766">flagMethod</span>&nbsp;<span class="op" id="2668777">==</span>&nbsp;<span class="num" id="2668780">0</span>&nbsp;<span class="op" id="2668782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2668786">panic</span><span class="op" id="2668791">(</span><span class="string" id="2668792">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2668849">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2668852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2668856">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2668936">fl</span>&nbsp;<span class="op" id="2668939">:=</span>&nbsp;<span class="ident" id="2668942">v</span><span class="op" id="2668943">.</span><span class="ident" id="2668944">flag</span>&nbsp;<span class="op" id="2668949">&amp;</span>&nbsp;<span class="op" id="2668951">(</span><span class="ident" id="2668952">flagRO</span>&nbsp;<span class="op" id="2668959">|</span>&nbsp;<span class="ident" id="2668961">flagAddr</span>&nbsp;<span class="op" id="2668970">|</span>&nbsp;<span class="ident" id="2668972">flagIndir</span><span class="op" id="2668981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2668984">fl</span>&nbsp;<span class="op" id="2668987">|=</span>&nbsp;<span class="ident" id="2668990">flag</span><span class="op" id="2668994">(</span><span class="ident" id="2668995">v</span><span class="op" id="2668996">.</span><span class="ident" id="2668997">typ</span><span class="op" id="2669000">.</span><span class="ident" id="2669001">Kind</span><span class="op" id="2669005">(</span><span class="op" id="2669006">)</span><span class="op" id="2669007">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669010">rcvr</span>&nbsp;<span class="op" id="2669015">:=</span>&nbsp;<span class="ident" id="2669018">Value</span><span class="op" id="2669023">{</span><span class="ident" id="2669024">v</span><span class="op" id="2669025">.</span><span class="ident" id="2669026">typ</span><span class="op" id="2669029">,</span>&nbsp;<span class="ident" id="2669031">v</span><span class="op" id="2669032">.</span><span class="ident" id="2669033">ptr</span><span class="op" id="2669036">,</span>&nbsp;<span class="ident" id="2669038">fl</span><span class="op" id="2669040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2669044">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669100">funcType</span>&nbsp;<span class="op" id="2669109">:=</span>&nbsp;<span class="ident" id="2669112">v</span><span class="op" id="2669113">.</span><span class="ident" id="2669114">Type</span><span class="op" id="2669118">(</span><span class="op" id="2669119">)</span><span class="op" id="2669120">.</span><span class="op" id="2669121">(</span><span class="op" id="2669122">*</span><span class="ident" id="2669123">rtype</span><span class="op" id="2669128">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2669132">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2669177">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2669232">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669292">dummy</span>&nbsp;<span class="op" id="2669298">:=</span>&nbsp;<span class="ident" id="2669301">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669318">code</span>&nbsp;<span class="op" id="2669323">:=</span>&nbsp;<span class="op" id="2669326">*</span><span class="op" id="2669327">*</span><span class="op" id="2669328">(</span><span class="op" id="2669329">*</span><span class="op" id="2669330">*</span><span class="builtintype" id="2669331">uintptr</span><span class="op" id="2669338">)</span><span class="op" id="2669339">(</span><span class="ident" id="2669340">unsafe</span><span class="op" id="2669346">.</span><span class="ident" id="2669347">Pointer</span><span class="op" id="2669354">(</span><span class="op" id="2669355">&amp;</span><span class="ident" id="2669356">dummy</span><span class="op" id="2669361">)</span><span class="op" id="2669362">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2669366">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669426">_</span><span class="op" id="2669427">,</span>&nbsp;<span class="ident" id="2669429">_</span><span class="op" id="2669430">,</span>&nbsp;<span class="ident" id="2669432">_</span><span class="op" id="2669433">,</span>&nbsp;<span class="ident" id="2669435">stack</span>&nbsp;<span class="op" id="2669441">:=</span>&nbsp;<span class="ident" id="2669444">funcLayout</span><span class="op" id="2669454">(</span><span class="ident" id="2669455">funcType</span><span class="op" id="2669463">,</span>&nbsp;<span class="ident" id="2669465">nil</span><span class="op" id="2669468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669472">fv</span>&nbsp;<span class="op" id="2669475">:=</span>&nbsp;<span class="op" id="2669478">&amp;</span><span class="ident" id="2669479">methodValue</span><span class="op" id="2669490">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669494">fn</span><span class="op" id="2669496">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2669502">code</span><span class="op" id="2669506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669510">stack</span><span class="op" id="2669515">:</span>&nbsp;&nbsp;<span class="ident" id="2669518">stack</span><span class="op" id="2669523">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669527">method</span><span class="op" id="2669533">:</span>&nbsp;<span class="builtintype" id="2669535">int</span><span class="op" id="2669538">(</span><span class="ident" id="2669539">v</span><span class="op" id="2669540">.</span><span class="ident" id="2669541">flag</span><span class="op" id="2669545">)</span>&nbsp;<span class="op" id="2669547">&gt;&gt;</span>&nbsp;<span class="ident" id="2669550">flagMethodShift</span><span class="op" id="2669565">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669569">rcvr</span><span class="op" id="2669573">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2669577">rcvr</span><span class="op" id="2669581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2669584">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2669588">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2669634">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2669700">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2669764">methodReceiver</span><span class="op" id="2669778">(</span><span class="ident" id="2669779">op</span><span class="op" id="2669781">,</span>&nbsp;<span class="ident" id="2669783">fv</span><span class="op" id="2669785">.</span><span class="ident" id="2669786">rcvr</span><span class="op" id="2669790">,</span>&nbsp;<span class="ident" id="2669792">fv</span><span class="op" id="2669794">.</span><span class="ident" id="2669795">method</span><span class="op" id="2669801">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2669805">return</span>&nbsp;<span class="ident" id="2669812">Value</span><span class="op" id="2669817">{</span><span class="ident" id="2669818">funcType</span><span class="op" id="2669826">,</span>&nbsp;<span class="ident" id="2669828">unsafe</span><span class="op" id="2669834">.</span><span class="ident" id="2669835">Pointer</span><span class="op" id="2669842">(</span><span class="ident" id="2669843">fv</span><span class="op" id="2669845">)</span><span class="op" id="2669846">,</span>&nbsp;<span class="ident" id="2669848">v</span><span class="op" id="2669849">.</span><span class="ident" id="2669850">flag</span><span class="op" id="2669854">&amp;</span><span class="ident" id="2669855">flagRO</span>&nbsp;<span class="op" id="2669862">|</span>&nbsp;<span class="ident" id="2669864">flag</span><span class="op" id="2669868">(</span><span class="ident" id="2669869">Func</span><span class="op" id="2669873">)</span><span class="op" id="2669874">}</span><br>
<span class="lineno"></span><span class="op" id="2669876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2669879">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2669947">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2670020">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2670097">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2670171">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2670212">func</span>&nbsp;<span class="ident" id="2670217">methodValueCall</span><span class="op" id="2670232">(</span><span class="op" id="2670233">)</span>
</div>
</body>
</html>
