<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html" class="current">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1420782">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1420837">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1420891">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1420942">package</span>&nbsp;<span class="ident" id="1420950">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1420956">import</span>&nbsp;<span class="op" id="1420963">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1420966">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1420981">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1420990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1420993">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1421049">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1421107">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1421130">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1421175">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1421222">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1421244">type</span>&nbsp;<span class="ident" id="1421249">RWMutex</span>&nbsp;<span class="keyword" id="1421257">struct</span>&nbsp;<span class="op" id="1421264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421267">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421279">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1421286">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421324">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1421336">uint32</span>&nbsp;<span class="comment" id="1421343">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421400">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1421412">uint32</span>&nbsp;<span class="comment" id="1421419">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421476">readerCount</span>&nbsp;<span class="builtintype" id="1421488">int32</span>&nbsp;&nbsp;<span class="comment" id="1421495">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421525">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1421537">int32</span>&nbsp;&nbsp;<span class="comment" id="1421544">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1421575">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1421578">const</span>&nbsp;<span class="ident" id="1421584">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1421602">=</span>&nbsp;<span class="num" id="1421604">1</span>&nbsp;<span class="op" id="1421606">&lt;&lt;</span>&nbsp;<span class="num" id="1421609">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1421613">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1421644">func</span>&nbsp;<span class="op" id="1421649">(</span><span class="ident" id="1421650">rw</span>&nbsp;<span class="op" id="1421653">*</span><span class="ident" id="1421654">RWMutex</span><span class="op" id="1421661">)</span>&nbsp;<span class="ident" id="1421663">RLock</span><span class="op" id="1421668">(</span><span class="op" id="1421669">)</span>&nbsp;<span class="op" id="1421671">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1421674">if</span>&nbsp;<span class="ident" id="1421677">raceenabled</span>&nbsp;<span class="op" id="1421689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421693">_</span>&nbsp;<span class="op" id="1421695">=</span>&nbsp;<span class="ident" id="1421697">rw</span><span class="op" id="1421699">.</span><span class="ident" id="1421700">w</span><span class="op" id="1421701">.</span><span class="ident" id="1421702">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421710">raceDisable</span><span class="op" id="1421721">(</span><span class="op" id="1421722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1421725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1421728">if</span>&nbsp;<span class="ident" id="1421731">atomic</span><span class="op" id="1421737">.</span><span class="ident" id="1421738">AddInt32</span><span class="op" id="1421746">(</span><span class="op" id="1421747">&amp;</span><span class="ident" id="1421748">rw</span><span class="op" id="1421750">.</span><span class="ident" id="1421751">readerCount</span><span class="op" id="1421762">,</span>&nbsp;<span class="num" id="1421764">1</span><span class="op" id="1421765">)</span>&nbsp;<span class="op" id="1421767">&lt;</span>&nbsp;<span class="num" id="1421769">0</span>&nbsp;<span class="op" id="1421771">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1421775">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421814">runtime_Semacquire</span><span class="op" id="1421832">(</span><span class="op" id="1421833">&amp;</span><span class="ident" id="1421834">rw</span><span class="op" id="1421836">.</span><span class="ident" id="1421837">readerSem</span><span class="op" id="1421846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1421849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1421852">if</span>&nbsp;<span class="ident" id="1421855">raceenabled</span>&nbsp;<span class="op" id="1421867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421871">raceEnable</span><span class="op" id="1421881">(</span><span class="op" id="1421882">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1421886">raceAcquire</span><span class="op" id="1421897">(</span><span class="ident" id="1421898">unsafe</span><span class="op" id="1421904">.</span><span class="ident" id="1421905">Pointer</span><span class="op" id="1421912">(</span><span class="op" id="1421913">&amp;</span><span class="ident" id="1421914">rw</span><span class="op" id="1421916">.</span><span class="ident" id="1421917">readerSem</span><span class="op" id="1421926">)</span><span class="op" id="1421927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1421930">}</span><br>
<span class="lineno"></span><span class="op" id="1421932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1421935">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1421974">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1422024">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1422082">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1422106">func</span>&nbsp;<span class="op" id="1422111">(</span><span class="ident" id="1422112">rw</span>&nbsp;<span class="op" id="1422115">*</span><span class="ident" id="1422116">RWMutex</span><span class="op" id="1422123">)</span>&nbsp;<span class="ident" id="1422125">RUnlock</span><span class="op" id="1422132">(</span><span class="op" id="1422133">)</span>&nbsp;<span class="op" id="1422135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1422138">if</span>&nbsp;<span class="ident" id="1422141">raceenabled</span>&nbsp;<span class="op" id="1422153">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422157">_</span>&nbsp;<span class="op" id="1422159">=</span>&nbsp;<span class="ident" id="1422161">rw</span><span class="op" id="1422163">.</span><span class="ident" id="1422164">w</span><span class="op" id="1422165">.</span><span class="ident" id="1422166">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422174">raceReleaseMerge</span><span class="op" id="1422190">(</span><span class="ident" id="1422191">unsafe</span><span class="op" id="1422197">.</span><span class="ident" id="1422198">Pointer</span><span class="op" id="1422205">(</span><span class="op" id="1422206">&amp;</span><span class="ident" id="1422207">rw</span><span class="op" id="1422209">.</span><span class="ident" id="1422210">writerSem</span><span class="op" id="1422219">)</span><span class="op" id="1422220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422224">raceDisable</span><span class="op" id="1422235">(</span><span class="op" id="1422236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1422242">if</span>&nbsp;<span class="ident" id="1422245">r</span>&nbsp;<span class="op" id="1422247">:=</span>&nbsp;<span class="ident" id="1422250">atomic</span><span class="op" id="1422256">.</span><span class="ident" id="1422257">AddInt32</span><span class="op" id="1422265">(</span><span class="op" id="1422266">&amp;</span><span class="ident" id="1422267">rw</span><span class="op" id="1422269">.</span><span class="ident" id="1422270">readerCount</span><span class="op" id="1422281">,</span>&nbsp;<span class="op" id="1422283">-</span><span class="num" id="1422284">1</span><span class="op" id="1422285">)</span><span class="op" id="1422286">;</span>&nbsp;<span class="ident" id="1422288">r</span>&nbsp;<span class="op" id="1422290">&lt;</span>&nbsp;<span class="num" id="1422292">0</span>&nbsp;<span class="op" id="1422294">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1422298">if</span>&nbsp;<span class="ident" id="1422301">r</span><span class="op" id="1422302">+</span><span class="num" id="1422303">1</span>&nbsp;<span class="op" id="1422305">==</span>&nbsp;<span class="num" id="1422308">0</span>&nbsp;<span class="op" id="1422310">||</span>&nbsp;<span class="ident" id="1422313">r</span><span class="op" id="1422314">+</span><span class="num" id="1422315">1</span>&nbsp;<span class="op" id="1422317">==</span>&nbsp;<span class="op" id="1422320">-</span><span class="ident" id="1422321">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1422339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422344">raceEnable</span><span class="op" id="1422354">(</span><span class="op" id="1422355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1422360">panic</span><span class="op" id="1422365">(</span><span class="string" id="1422366">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1422401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422409">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1422435">if</span>&nbsp;<span class="ident" id="1422438">atomic</span><span class="op" id="1422444">.</span><span class="ident" id="1422445">AddInt32</span><span class="op" id="1422453">(</span><span class="op" id="1422454">&amp;</span><span class="ident" id="1422455">rw</span><span class="op" id="1422457">.</span><span class="ident" id="1422458">readerWait</span><span class="op" id="1422468">,</span>&nbsp;<span class="op" id="1422470">-</span><span class="num" id="1422471">1</span><span class="op" id="1422472">)</span>&nbsp;<span class="op" id="1422474">==</span>&nbsp;<span class="num" id="1422477">0</span>&nbsp;<span class="op" id="1422479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422484">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422527">runtime_Semrelease</span><span class="op" id="1422545">(</span><span class="op" id="1422546">&amp;</span><span class="ident" id="1422547">rw</span><span class="op" id="1422549">.</span><span class="ident" id="1422550">writerSem</span><span class="op" id="1422559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422566">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1422569">if</span>&nbsp;<span class="ident" id="1422572">raceenabled</span>&nbsp;<span class="op" id="1422584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422588">raceEnable</span><span class="op" id="1422598">(</span><span class="op" id="1422599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422602">}</span><br>
<span class="lineno"></span><span class="op" id="1422604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1422607">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1422637">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1422694">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1422738">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1422795">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1422854">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1422867">func</span>&nbsp;<span class="op" id="1422872">(</span><span class="ident" id="1422873">rw</span>&nbsp;<span class="op" id="1422876">*</span><span class="ident" id="1422877">RWMutex</span><span class="op" id="1422884">)</span>&nbsp;<span class="ident" id="1422886">Lock</span><span class="op" id="1422890">(</span><span class="op" id="1422891">)</span>&nbsp;<span class="op" id="1422893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1422896">if</span>&nbsp;<span class="ident" id="1422899">raceenabled</span>&nbsp;<span class="op" id="1422911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422915">_</span>&nbsp;<span class="op" id="1422917">=</span>&nbsp;<span class="ident" id="1422919">rw</span><span class="op" id="1422921">.</span><span class="ident" id="1422922">w</span><span class="op" id="1422923">.</span><span class="ident" id="1422924">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422932">raceDisable</span><span class="op" id="1422943">(</span><span class="op" id="1422944">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422950">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423001">rw</span><span class="op" id="1423003">.</span><span class="ident" id="1423004">w</span><span class="op" id="1423005">.</span><span class="ident" id="1423006">Lock</span><span class="op" id="1423010">(</span><span class="op" id="1423011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1423014">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423065">r</span>&nbsp;<span class="op" id="1423067">:=</span>&nbsp;<span class="ident" id="1423070">atomic</span><span class="op" id="1423076">.</span><span class="ident" id="1423077">AddInt32</span><span class="op" id="1423085">(</span><span class="op" id="1423086">&amp;</span><span class="ident" id="1423087">rw</span><span class="op" id="1423089">.</span><span class="ident" id="1423090">readerCount</span><span class="op" id="1423101">,</span>&nbsp;<span class="op" id="1423103">-</span><span class="ident" id="1423104">rwmutexMaxReaders</span><span class="op" id="1423121">)</span>&nbsp;<span class="op" id="1423123">+</span>&nbsp;<span class="ident" id="1423125">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1423144">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1423173">if</span>&nbsp;<span class="ident" id="1423176">r</span>&nbsp;<span class="op" id="1423178">!=</span>&nbsp;<span class="num" id="1423181">0</span>&nbsp;<span class="op" id="1423183">&amp;&amp;</span>&nbsp;<span class="ident" id="1423186">atomic</span><span class="op" id="1423192">.</span><span class="ident" id="1423193">AddInt32</span><span class="op" id="1423201">(</span><span class="op" id="1423202">&amp;</span><span class="ident" id="1423203">rw</span><span class="op" id="1423205">.</span><span class="ident" id="1423206">readerWait</span><span class="op" id="1423216">,</span>&nbsp;<span class="ident" id="1423218">r</span><span class="op" id="1423219">)</span>&nbsp;<span class="op" id="1423221">!=</span>&nbsp;<span class="num" id="1423224">0</span>&nbsp;<span class="op" id="1423226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423230">runtime_Semacquire</span><span class="op" id="1423248">(</span><span class="op" id="1423249">&amp;</span><span class="ident" id="1423250">rw</span><span class="op" id="1423252">.</span><span class="ident" id="1423253">writerSem</span><span class="op" id="1423262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1423265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1423268">if</span>&nbsp;<span class="ident" id="1423271">raceenabled</span>&nbsp;<span class="op" id="1423283">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423287">raceEnable</span><span class="op" id="1423297">(</span><span class="op" id="1423298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423302">raceAcquire</span><span class="op" id="1423313">(</span><span class="ident" id="1423314">unsafe</span><span class="op" id="1423320">.</span><span class="ident" id="1423321">Pointer</span><span class="op" id="1423328">(</span><span class="op" id="1423329">&amp;</span><span class="ident" id="1423330">rw</span><span class="op" id="1423332">.</span><span class="ident" id="1423333">readerSem</span><span class="op" id="1423342">)</span><span class="op" id="1423343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423347">raceAcquire</span><span class="op" id="1423358">(</span><span class="ident" id="1423359">unsafe</span><span class="op" id="1423365">.</span><span class="ident" id="1423366">Pointer</span><span class="op" id="1423373">(</span><span class="op" id="1423374">&amp;</span><span class="ident" id="1423375">rw</span><span class="op" id="1423377">.</span><span class="ident" id="1423378">writerSem</span><span class="op" id="1423387">)</span><span class="op" id="1423388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1423391">}</span><br>
<span class="lineno"></span><span class="op" id="1423393">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1423396">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1423463">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1423509">//</span><br>
<span class="lineno"></span><span class="comment" id="1423512">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1423585">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1423651">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1423708">func</span>&nbsp;<span class="op" id="1423713">(</span><span class="ident" id="1423714">rw</span>&nbsp;<span class="op" id="1423717">*</span><span class="ident" id="1423718">RWMutex</span><span class="op" id="1423725">)</span>&nbsp;<span class="ident" id="1423727">Unlock</span><span class="op" id="1423733">(</span><span class="op" id="1423734">)</span>&nbsp;<span class="op" id="1423736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1423739">if</span>&nbsp;<span class="ident" id="1423742">raceenabled</span>&nbsp;<span class="op" id="1423754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423758">_</span>&nbsp;<span class="op" id="1423760">=</span>&nbsp;<span class="ident" id="1423762">rw</span><span class="op" id="1423764">.</span><span class="ident" id="1423765">w</span><span class="op" id="1423766">.</span><span class="ident" id="1423767">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423775">raceRelease</span><span class="op" id="1423786">(</span><span class="ident" id="1423787">unsafe</span><span class="op" id="1423793">.</span><span class="ident" id="1423794">Pointer</span><span class="op" id="1423801">(</span><span class="op" id="1423802">&amp;</span><span class="ident" id="1423803">rw</span><span class="op" id="1423805">.</span><span class="ident" id="1423806">readerSem</span><span class="op" id="1423815">)</span><span class="op" id="1423816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423820">raceRelease</span><span class="op" id="1423831">(</span><span class="ident" id="1423832">unsafe</span><span class="op" id="1423838">.</span><span class="ident" id="1423839">Pointer</span><span class="op" id="1423846">(</span><span class="op" id="1423847">&amp;</span><span class="ident" id="1423848">rw</span><span class="op" id="1423850">.</span><span class="ident" id="1423851">writerSem</span><span class="op" id="1423860">)</span><span class="op" id="1423861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423865">raceDisable</span><span class="op" id="1423876">(</span><span class="op" id="1423877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1423880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1423884">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423935">r</span>&nbsp;<span class="op" id="1423937">:=</span>&nbsp;<span class="ident" id="1423940">atomic</span><span class="op" id="1423946">.</span><span class="ident" id="1423947">AddInt32</span><span class="op" id="1423955">(</span><span class="op" id="1423956">&amp;</span><span class="ident" id="1423957">rw</span><span class="op" id="1423959">.</span><span class="ident" id="1423960">readerCount</span><span class="op" id="1423971">,</span>&nbsp;<span class="ident" id="1423973">rwmutexMaxReaders</span><span class="op" id="1423990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1423993">if</span>&nbsp;<span class="ident" id="1423996">r</span>&nbsp;<span class="op" id="1423998">&gt;=</span>&nbsp;<span class="ident" id="1424001">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1424019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424023">raceEnable</span><span class="op" id="1424033">(</span><span class="op" id="1424034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1424038">panic</span><span class="op" id="1424043">(</span><span class="string" id="1424044">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1424078">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1424081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424084">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1424121">for</span>&nbsp;<span class="ident" id="1424125">i</span>&nbsp;<span class="op" id="1424127">:=</span>&nbsp;<span class="num" id="1424130">0</span><span class="op" id="1424131">;</span>&nbsp;<span class="ident" id="1424133">i</span>&nbsp;<span class="op" id="1424135">&lt;</span>&nbsp;<span class="builtintype" id="1424137">int</span><span class="op" id="1424140">(</span><span class="ident" id="1424141">r</span><span class="op" id="1424142">)</span><span class="op" id="1424143">;</span>&nbsp;<span class="ident" id="1424145">i</span><span class="op" id="1424146">++</span>&nbsp;<span class="op" id="1424149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424153">runtime_Semrelease</span><span class="op" id="1424171">(</span><span class="op" id="1424172">&amp;</span><span class="ident" id="1424173">rw</span><span class="op" id="1424175">.</span><span class="ident" id="1424176">readerSem</span><span class="op" id="1424185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1424188">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424191">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424227">rw</span><span class="op" id="1424229">.</span><span class="ident" id="1424230">w</span><span class="op" id="1424231">.</span><span class="ident" id="1424232">Unlock</span><span class="op" id="1424238">(</span><span class="op" id="1424239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1424242">if</span>&nbsp;<span class="ident" id="1424245">raceenabled</span>&nbsp;<span class="op" id="1424257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424261">raceEnable</span><span class="op" id="1424271">(</span><span class="op" id="1424272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1424275">}</span><br>
<span class="lineno">125</span><span class="op" id="1424277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1424280">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1424334">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1424401">func</span>&nbsp;<span class="op" id="1424406">(</span><span class="ident" id="1424407">rw</span>&nbsp;<span class="op" id="1424410">*</span><span class="ident" id="1424411">RWMutex</span><span class="op" id="1424418">)</span>&nbsp;<span class="ident" id="1424420">RLocker</span><span class="op" id="1424427">(</span><span class="op" id="1424428">)</span>&nbsp;<span class="ident" id="1424430">Locker</span>&nbsp;<span class="op" id="1424437">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1424440">return</span>&nbsp;<span class="op" id="1424447">(</span><span class="op" id="1424448">*</span><span class="ident" id="1424449">rlocker</span><span class="op" id="1424456">)</span><span class="op" id="1424457">(</span><span class="ident" id="1424458">rw</span><span class="op" id="1424460">)</span><br>
<span class="lineno"></span><span class="op" id="1424462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1424465">type</span>&nbsp;<span class="ident" id="1424470">rlocker</span>&nbsp;<span class="ident" id="1424478">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1424487">func</span>&nbsp;<span class="op" id="1424492">(</span><span class="ident" id="1424493">r</span>&nbsp;<span class="op" id="1424495">*</span><span class="ident" id="1424496">rlocker</span><span class="op" id="1424503">)</span>&nbsp;<span class="ident" id="1424505">Lock</span><span class="op" id="1424509">(</span><span class="op" id="1424510">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1424514">{</span>&nbsp;<span class="op" id="1424516">(</span><span class="op" id="1424517">*</span><span class="ident" id="1424518">RWMutex</span><span class="op" id="1424525">)</span><span class="op" id="1424526">(</span><span class="ident" id="1424527">r</span><span class="op" id="1424528">)</span><span class="op" id="1424529">.</span><span class="ident" id="1424530">RLock</span><span class="op" id="1424535">(</span><span class="op" id="1424536">)</span>&nbsp;<span class="op" id="1424538">}</span><br>
<span class="lineno"></span><span class="keyword" id="1424540">func</span>&nbsp;<span class="op" id="1424545">(</span><span class="ident" id="1424546">r</span>&nbsp;<span class="op" id="1424548">*</span><span class="ident" id="1424549">rlocker</span><span class="op" id="1424556">)</span>&nbsp;<span class="ident" id="1424558">Unlock</span><span class="op" id="1424564">(</span><span class="op" id="1424565">)</span>&nbsp;<span class="op" id="1424567">{</span>&nbsp;<span class="op" id="1424569">(</span><span class="op" id="1424570">*</span><span class="ident" id="1424571">RWMutex</span><span class="op" id="1424578">)</span><span class="op" id="1424579">(</span><span class="ident" id="1424580">r</span><span class="op" id="1424581">)</span><span class="op" id="1424582">.</span><span class="ident" id="1424583">RUnlock</span><span class="op" id="1424590">(</span><span class="op" id="1424591">)</span>&nbsp;<span class="op" id="1424593">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
