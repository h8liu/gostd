<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html" class="current">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6044550">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6044605">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6044659">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6044710">//&nbsp;Package&nbsp;jpeg&nbsp;implements&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="6044771">//</span><br>
<span class="lineno"></span><span class="comment" id="6044774">//&nbsp;JPEG&nbsp;is&nbsp;defined&nbsp;in&nbsp;ITU-T&nbsp;T.81:&nbsp;http://www.w3.org/Graphics/JPEG/itu-t81.pdf.</span><br>
<span class="lineno"></span><span class="keyword" id="6044853">package</span>&nbsp;<span class="ident" id="6044861">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6044867">import</span>&nbsp;<span class="op" id="6044874">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6044877">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6044886">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6044901">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6044906">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6044909">//&nbsp;TODO(nigeltao):&nbsp;fix&nbsp;up&nbsp;the&nbsp;doc&nbsp;comment&nbsp;style&nbsp;so&nbsp;that&nbsp;sentences&nbsp;start&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="6044986">//&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;or&nbsp;function&nbsp;that&nbsp;they&nbsp;annotate.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6045043">//&nbsp;A&nbsp;FormatError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;JPEG.</span><br>
<span class="lineno">20</span><span class="keyword" id="6045104">type</span>&nbsp;<span class="ident" id="6045109">FormatError</span>&nbsp;<span class="builtintype" id="6045121">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6045129">func</span>&nbsp;<span class="op" id="6045134">(</span><span class="ident" id="6045135">e</span>&nbsp;<span class="ident" id="6045137">FormatError</span><span class="op" id="6045148">)</span>&nbsp;<span class="ident" id="6045150">Error</span><span class="op" id="6045155">(</span><span class="op" id="6045156">)</span>&nbsp;<span class="builtintype" id="6045158">string</span>&nbsp;<span class="op" id="6045165">{</span>&nbsp;<span class="keyword" id="6045167">return</span>&nbsp;<span class="string" id="6045174">&#34;invalid&nbsp;JPEG&nbsp;format:&nbsp;&#34;</span>&nbsp;<span class="op" id="6045198">+</span>&nbsp;<span class="builtintype" id="6045200">string</span><span class="op" id="6045206">(</span><span class="ident" id="6045207">e</span><span class="op" id="6045208">)</span>&nbsp;<span class="op" id="6045210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6045213">//&nbsp;An&nbsp;UnsupportedError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;uses&nbsp;a&nbsp;valid&nbsp;but&nbsp;unimplemented&nbsp;JPEG&nbsp;feature.</span><br>
<span class="lineno">25</span><span class="keyword" id="6045304">type</span>&nbsp;<span class="ident" id="6045309">UnsupportedError</span>&nbsp;<span class="builtintype" id="6045326">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6045334">func</span>&nbsp;<span class="op" id="6045339">(</span><span class="ident" id="6045340">e</span>&nbsp;<span class="ident" id="6045342">UnsupportedError</span><span class="op" id="6045358">)</span>&nbsp;<span class="ident" id="6045360">Error</span><span class="op" id="6045365">(</span><span class="op" id="6045366">)</span>&nbsp;<span class="builtintype" id="6045368">string</span>&nbsp;<span class="op" id="6045375">{</span>&nbsp;<span class="keyword" id="6045377">return</span>&nbsp;<span class="string" id="6045384">&#34;unsupported&nbsp;JPEG&nbsp;feature:&nbsp;&#34;</span>&nbsp;<span class="op" id="6045413">+</span>&nbsp;<span class="builtintype" id="6045415">string</span><span class="op" id="6045421">(</span><span class="ident" id="6045422">e</span><span class="op" id="6045423">)</span>&nbsp;<span class="op" id="6045425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6045428">//&nbsp;Component&nbsp;specification,&nbsp;specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno">30</span><span class="keyword" id="6045484">type</span>&nbsp;<span class="ident" id="6045489">component</span>&nbsp;<span class="keyword" id="6045499">struct</span>&nbsp;<span class="op" id="6045506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045509">h</span>&nbsp;&nbsp;<span class="builtintype" id="6045512">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6045518">//&nbsp;Horizontal&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045550">v</span>&nbsp;&nbsp;<span class="builtintype" id="6045553">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6045559">//&nbsp;Vertical&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045589">c</span>&nbsp;&nbsp;<span class="builtintype" id="6045592">uint8</span>&nbsp;<span class="comment" id="6045598">//&nbsp;Component&nbsp;identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045624">tq</span>&nbsp;<span class="builtintype" id="6045627">uint8</span>&nbsp;<span class="comment" id="6045633">//&nbsp;Quantization&nbsp;table&nbsp;destination&nbsp;selector.</span><br>
<span class="lineno">35</span><span class="op" id="6045677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6045680">const</span>&nbsp;<span class="op" id="6045686">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045689">dcTable</span>&nbsp;<span class="op" id="6045697">=</span>&nbsp;<span class="num" id="6045699">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045702">acTable</span>&nbsp;<span class="op" id="6045710">=</span>&nbsp;<span class="num" id="6045712">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045715">maxTc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6045723">=</span>&nbsp;<span class="num" id="6045725">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045728">maxTh</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6045736">=</span>&nbsp;<span class="num" id="6045738">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045741">maxTq</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6045749">=</span>&nbsp;<span class="num" id="6045751">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6045755">//&nbsp;A&nbsp;grayscale&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;a&nbsp;Y&nbsp;component.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045806">nGrayComponent</span>&nbsp;<span class="op" id="6045821">=</span>&nbsp;<span class="num" id="6045823">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6045826">//&nbsp;A&nbsp;color&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;Y,&nbsp;Cb&nbsp;and&nbsp;Cr&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045878">nColorComponent</span>&nbsp;<span class="op" id="6045894">=</span>&nbsp;<span class="num" id="6045896">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6045900">//&nbsp;We&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;and&nbsp;4:2:0&nbsp;downsampling,&nbsp;and&nbsp;therefore&nbsp;the</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6045982">//&nbsp;number&nbsp;of&nbsp;luma&nbsp;samples&nbsp;per&nbsp;chroma&nbsp;sample&nbsp;is&nbsp;at&nbsp;most&nbsp;2&nbsp;in&nbsp;the&nbsp;horizontal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6046058">//&nbsp;and&nbsp;2&nbsp;in&nbsp;the&nbsp;vertical&nbsp;direction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046095">maxH</span>&nbsp;<span class="op" id="6046100">=</span>&nbsp;<span class="num" id="6046102">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046105">maxV</span>&nbsp;<span class="op" id="6046110">=</span>&nbsp;<span class="num" id="6046112">2</span><br>
<span class="lineno"></span><span class="op" id="6046114">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6046117">const</span>&nbsp;<span class="op" id="6046123">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046126">soiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6046138">=</span>&nbsp;<span class="num" id="6046140">0xd8</span>&nbsp;<span class="comment" id="6046145">//&nbsp;Start&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046165">eoiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6046177">=</span>&nbsp;<span class="num" id="6046179">0xd9</span>&nbsp;<span class="comment" id="6046184">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046202">sof0Marker</span>&nbsp;&nbsp;<span class="op" id="6046214">=</span>&nbsp;<span class="num" id="6046216">0xc0</span>&nbsp;<span class="comment" id="6046221">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline).</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046252">sof2Marker</span>&nbsp;&nbsp;<span class="op" id="6046264">=</span>&nbsp;<span class="num" id="6046266">0xc2</span>&nbsp;<span class="comment" id="6046271">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Progressive).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046305">dhtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6046317">=</span>&nbsp;<span class="num" id="6046319">0xc4</span>&nbsp;<span class="comment" id="6046324">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046350">dqtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6046362">=</span>&nbsp;<span class="num" id="6046364">0xdb</span>&nbsp;<span class="comment" id="6046369">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046400">sosMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6046412">=</span>&nbsp;<span class="num" id="6046414">0xda</span>&nbsp;<span class="comment" id="6046419">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046438">driMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6046450">=</span>&nbsp;<span class="num" id="6046452">0xdd</span>&nbsp;<span class="comment" id="6046457">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046486">rst0Marker</span>&nbsp;&nbsp;<span class="op" id="6046498">=</span>&nbsp;<span class="num" id="6046500">0xd0</span>&nbsp;<span class="comment" id="6046505">//&nbsp;ReSTart&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046522">rst7Marker</span>&nbsp;&nbsp;<span class="op" id="6046534">=</span>&nbsp;<span class="num" id="6046536">0xd7</span>&nbsp;<span class="comment" id="6046541">//&nbsp;ReSTart&nbsp;(7).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046558">app0Marker</span>&nbsp;&nbsp;<span class="op" id="6046570">=</span>&nbsp;<span class="num" id="6046572">0xe0</span>&nbsp;<span class="comment" id="6046577">//&nbsp;APPlication&nbsp;specific&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046607">app15Marker</span>&nbsp;<span class="op" id="6046619">=</span>&nbsp;<span class="num" id="6046621">0xef</span>&nbsp;<span class="comment" id="6046626">//&nbsp;APPlication&nbsp;specific&nbsp;(15).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046657">comMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6046669">=</span>&nbsp;<span class="num" id="6046671">0xfe</span>&nbsp;<span class="comment" id="6046676">//&nbsp;COMment.</span><br>
<span class="lineno">70</span><span class="op" id="6046688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6046691">//&nbsp;unzig&nbsp;maps&nbsp;from&nbsp;the&nbsp;zig-zag&nbsp;ordering&nbsp;to&nbsp;the&nbsp;natural&nbsp;ordering.&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="6046769">//&nbsp;unzig[3]&nbsp;is&nbsp;the&nbsp;column&nbsp;and&nbsp;row&nbsp;of&nbsp;the&nbsp;fourth&nbsp;element&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="6046847">//&nbsp;value&nbsp;is&nbsp;16,&nbsp;which&nbsp;means&nbsp;first&nbsp;column&nbsp;(16%8&nbsp;==&nbsp;0)&nbsp;and&nbsp;third&nbsp;row&nbsp;(16/8&nbsp;==&nbsp;2).</span><br>
<span class="lineno">75</span><span class="keyword" id="6046927">var</span>&nbsp;<span class="ident" id="6046931">unzig</span>&nbsp;<span class="op" id="6046937">=</span>&nbsp;<span class="op" id="6046939">[</span><span class="ident" id="6046940">blockSize</span><span class="op" id="6046949">]</span><span class="builtintype" id="6046950">int</span><span class="op" id="6046953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6046956">0</span><span class="op" id="6046957">,</span>&nbsp;<span class="num" id="6046959">1</span><span class="op" id="6046960">,</span>&nbsp;<span class="num" id="6046962">8</span><span class="op" id="6046963">,</span>&nbsp;<span class="num" id="6046965">16</span><span class="op" id="6046967">,</span>&nbsp;<span class="num" id="6046969">9</span><span class="op" id="6046970">,</span>&nbsp;<span class="num" id="6046972">2</span><span class="op" id="6046973">,</span>&nbsp;<span class="num" id="6046975">3</span><span class="op" id="6046976">,</span>&nbsp;<span class="num" id="6046978">10</span><span class="op" id="6046980">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6046983">17</span><span class="op" id="6046985">,</span>&nbsp;<span class="num" id="6046987">24</span><span class="op" id="6046989">,</span>&nbsp;<span class="num" id="6046991">32</span><span class="op" id="6046993">,</span>&nbsp;<span class="num" id="6046995">25</span><span class="op" id="6046997">,</span>&nbsp;<span class="num" id="6046999">18</span><span class="op" id="6047001">,</span>&nbsp;<span class="num" id="6047003">11</span><span class="op" id="6047005">,</span>&nbsp;<span class="num" id="6047007">4</span><span class="op" id="6047008">,</span>&nbsp;<span class="num" id="6047010">5</span><span class="op" id="6047011">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6047014">12</span><span class="op" id="6047016">,</span>&nbsp;<span class="num" id="6047018">19</span><span class="op" id="6047020">,</span>&nbsp;<span class="num" id="6047022">26</span><span class="op" id="6047024">,</span>&nbsp;<span class="num" id="6047026">33</span><span class="op" id="6047028">,</span>&nbsp;<span class="num" id="6047030">40</span><span class="op" id="6047032">,</span>&nbsp;<span class="num" id="6047034">48</span><span class="op" id="6047036">,</span>&nbsp;<span class="num" id="6047038">41</span><span class="op" id="6047040">,</span>&nbsp;<span class="num" id="6047042">34</span><span class="op" id="6047044">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6047047">27</span><span class="op" id="6047049">,</span>&nbsp;<span class="num" id="6047051">20</span><span class="op" id="6047053">,</span>&nbsp;<span class="num" id="6047055">13</span><span class="op" id="6047057">,</span>&nbsp;<span class="num" id="6047059">6</span><span class="op" id="6047060">,</span>&nbsp;<span class="num" id="6047062">7</span><span class="op" id="6047063">,</span>&nbsp;<span class="num" id="6047065">14</span><span class="op" id="6047067">,</span>&nbsp;<span class="num" id="6047069">21</span><span class="op" id="6047071">,</span>&nbsp;<span class="num" id="6047073">28</span><span class="op" id="6047075">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6047078">35</span><span class="op" id="6047080">,</span>&nbsp;<span class="num" id="6047082">42</span><span class="op" id="6047084">,</span>&nbsp;<span class="num" id="6047086">49</span><span class="op" id="6047088">,</span>&nbsp;<span class="num" id="6047090">56</span><span class="op" id="6047092">,</span>&nbsp;<span class="num" id="6047094">57</span><span class="op" id="6047096">,</span>&nbsp;<span class="num" id="6047098">50</span><span class="op" id="6047100">,</span>&nbsp;<span class="num" id="6047102">43</span><span class="op" id="6047104">,</span>&nbsp;<span class="num" id="6047106">36</span><span class="op" id="6047108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6047111">29</span><span class="op" id="6047113">,</span>&nbsp;<span class="num" id="6047115">22</span><span class="op" id="6047117">,</span>&nbsp;<span class="num" id="6047119">15</span><span class="op" id="6047121">,</span>&nbsp;<span class="num" id="6047123">23</span><span class="op" id="6047125">,</span>&nbsp;<span class="num" id="6047127">30</span><span class="op" id="6047129">,</span>&nbsp;<span class="num" id="6047131">37</span><span class="op" id="6047133">,</span>&nbsp;<span class="num" id="6047135">44</span><span class="op" id="6047137">,</span>&nbsp;<span class="num" id="6047139">51</span><span class="op" id="6047141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6047144">58</span><span class="op" id="6047146">,</span>&nbsp;<span class="num" id="6047148">59</span><span class="op" id="6047150">,</span>&nbsp;<span class="num" id="6047152">52</span><span class="op" id="6047154">,</span>&nbsp;<span class="num" id="6047156">45</span><span class="op" id="6047158">,</span>&nbsp;<span class="num" id="6047160">38</span><span class="op" id="6047162">,</span>&nbsp;<span class="num" id="6047164">31</span><span class="op" id="6047166">,</span>&nbsp;<span class="num" id="6047168">39</span><span class="op" id="6047170">,</span>&nbsp;<span class="num" id="6047172">46</span><span class="op" id="6047174">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6047177">53</span><span class="op" id="6047179">,</span>&nbsp;<span class="num" id="6047181">60</span><span class="op" id="6047183">,</span>&nbsp;<span class="num" id="6047185">61</span><span class="op" id="6047187">,</span>&nbsp;<span class="num" id="6047189">54</span><span class="op" id="6047191">,</span>&nbsp;<span class="num" id="6047193">47</span><span class="op" id="6047195">,</span>&nbsp;<span class="num" id="6047197">55</span><span class="op" id="6047199">,</span>&nbsp;<span class="num" id="6047201">62</span><span class="op" id="6047203">,</span>&nbsp;<span class="num" id="6047205">63</span><span class="op" id="6047207">,</span><br>
<span class="lineno"></span><span class="op" id="6047209">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="6047212">//&nbsp;Reader&nbsp;is&nbsp;deprecated.</span><br>
<span class="lineno"></span><span class="keyword" id="6047237">type</span>&nbsp;<span class="ident" id="6047242">Reader</span>&nbsp;<span class="keyword" id="6047249">interface</span>&nbsp;<span class="op" id="6047259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047262">io</span><span class="op" id="6047264">.</span><span class="ident" id="6047265">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047277">io</span><span class="op" id="6047279">.</span><span class="ident" id="6047280">Reader</span><br>
<span class="lineno">90</span><span class="op" id="6047287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6047290">//&nbsp;bits&nbsp;holds&nbsp;the&nbsp;unprocessed&nbsp;bits&nbsp;that&nbsp;have&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;byte-stream.</span><br>
<span class="lineno"></span><span class="comment" id="6047368">//&nbsp;The&nbsp;n&nbsp;least&nbsp;significant&nbsp;bits&nbsp;of&nbsp;a&nbsp;form&nbsp;the&nbsp;unread&nbsp;bits,&nbsp;to&nbsp;be&nbsp;read&nbsp;in&nbsp;MSB&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6047448">//&nbsp;LSB&nbsp;order.</span><br>
<span class="lineno">95</span><span class="keyword" id="6047462">type</span>&nbsp;<span class="ident" id="6047467">bits</span>&nbsp;<span class="keyword" id="6047472">struct</span>&nbsp;<span class="op" id="6047479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047482">a</span>&nbsp;<span class="builtintype" id="6047484">uint32</span>&nbsp;<span class="comment" id="6047491">//&nbsp;accumulator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047508">m</span>&nbsp;<span class="builtintype" id="6047510">uint32</span>&nbsp;<span class="comment" id="6047517">//&nbsp;mask.&nbsp;m==1&lt;&lt;(n-1)&nbsp;when&nbsp;n&gt;0,&nbsp;with&nbsp;m==0&nbsp;when&nbsp;n==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047570">n</span>&nbsp;<span class="builtintype" id="6047572">int32</span>&nbsp;&nbsp;<span class="comment" id="6047579">//&nbsp;the&nbsp;number&nbsp;of&nbsp;unread&nbsp;bits&nbsp;in&nbsp;a.</span><br>
<span class="lineno"></span><span class="op" id="6047614">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6047617">type</span>&nbsp;<span class="ident" id="6047622">decoder</span>&nbsp;<span class="keyword" id="6047630">struct</span>&nbsp;<span class="op" id="6047637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047640">r</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6047645">io</span><span class="op" id="6047647">.</span><span class="ident" id="6047648">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047656">bits</span>&nbsp;<span class="ident" id="6047661">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047667">//&nbsp;bytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;buffer,&nbsp;similar&nbsp;to&nbsp;a&nbsp;bufio.Reader,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047737">//&nbsp;has&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;unread&nbsp;more&nbsp;than&nbsp;1&nbsp;byte,&nbsp;due&nbsp;to&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047806">//&nbsp;Byte&nbsp;stuffing&nbsp;is&nbsp;specified&nbsp;in&nbsp;section&nbsp;F.1.2.3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047857">bytes</span>&nbsp;<span class="keyword" id="6047863">struct</span>&nbsp;<span class="op" id="6047870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047874">//&nbsp;buf[i:j]&nbsp;are&nbsp;the&nbsp;buffered&nbsp;bytes&nbsp;read&nbsp;from&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047936">//&nbsp;io.Reader&nbsp;that&nbsp;haven&#39;t&nbsp;yet&nbsp;been&nbsp;passed&nbsp;further&nbsp;on.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047992">buf</span>&nbsp;&nbsp;<span class="op" id="6047997">[</span><span class="num" id="6047998">4096</span><span class="op" id="6048002">]</span><span class="builtintype" id="6048003">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048010">i</span><span class="op" id="6048011">,</span>&nbsp;<span class="ident" id="6048013">j</span>&nbsp;<span class="builtintype" id="6048015">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048021">//&nbsp;nUnreadable&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;back&nbsp;up&nbsp;i&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048080">//&nbsp;overshooting.&nbsp;It&nbsp;can&nbsp;be&nbsp;0,&nbsp;1&nbsp;or&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048120">nUnreadable</span>&nbsp;<span class="builtintype" id="6048132">int</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048140">width</span><span class="op" id="6048145">,</span>&nbsp;<span class="ident" id="6048147">height</span>&nbsp;<span class="builtintype" id="6048154">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048159">img1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6048173">*</span><span class="ident" id="6048174">image</span><span class="op" id="6048179">.</span><span class="ident" id="6048180">Gray</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048186">img3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6048200">*</span><span class="ident" id="6048201">image</span><span class="op" id="6048206">.</span><span class="ident" id="6048207">YCbCr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048214">ri</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6048228">int</span>&nbsp;<span class="comment" id="6048232">//&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048254">nComp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6048268">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048273">progressive</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6048287">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048293">eobRun</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6048307">uint16</span>&nbsp;<span class="comment" id="6048314">//&nbsp;End-of-Band&nbsp;run,&nbsp;specified&nbsp;in&nbsp;section&nbsp;G.1.2.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048365">comp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6048379">[</span><span class="ident" id="6048380">nColorComponent</span><span class="op" id="6048395">]</span><span class="ident" id="6048396">component</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048407">progCoeffs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6048421">[</span><span class="ident" id="6048422">nColorComponent</span><span class="op" id="6048437">]</span><span class="op" id="6048438">[</span><span class="op" id="6048439">]</span><span class="ident" id="6048440">block</span>&nbsp;<span class="comment" id="6048446">//&nbsp;Saved&nbsp;state&nbsp;between&nbsp;progressive-mode&nbsp;scans.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048494">huff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6048508">[</span><span class="ident" id="6048509">maxTc</span>&nbsp;<span class="op" id="6048515">+</span>&nbsp;<span class="num" id="6048517">1</span><span class="op" id="6048518">]</span><span class="op" id="6048519">[</span><span class="ident" id="6048520">maxTh</span>&nbsp;<span class="op" id="6048526">+</span>&nbsp;<span class="num" id="6048528">1</span><span class="op" id="6048529">]</span><span class="ident" id="6048530">huffman</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048539">quant</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6048553">[</span><span class="ident" id="6048554">maxTq</span>&nbsp;<span class="op" id="6048560">+</span>&nbsp;<span class="num" id="6048562">1</span><span class="op" id="6048563">]</span><span class="ident" id="6048564">block</span>&nbsp;<span class="comment" id="6048570">//&nbsp;Quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048613">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6048627">[</span><span class="ident" id="6048628">blockSize</span>&nbsp;<span class="op" id="6048638">+</span>&nbsp;<span class="num" id="6048640">1</span><span class="op" id="6048641">]</span><span class="builtintype" id="6048642">byte</span><br>
<span class="lineno"></span><span class="op" id="6048647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6048650">//&nbsp;fill&nbsp;fills&nbsp;up&nbsp;the&nbsp;d.bytes.buf&nbsp;buffer&nbsp;from&nbsp;the&nbsp;underlying&nbsp;io.Reader.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment" id="6048724">//&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;d.bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="6048792">func</span>&nbsp;<span class="op" id="6048797">(</span><span class="ident" id="6048798">d</span>&nbsp;<span class="op" id="6048800">*</span><span class="ident" id="6048801">decoder</span><span class="op" id="6048808">)</span>&nbsp;<span class="ident" id="6048810">fill</span><span class="op" id="6048814">(</span><span class="op" id="6048815">)</span>&nbsp;<span class="builtintype" id="6048817">error</span>&nbsp;<span class="op" id="6048823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048826">if</span>&nbsp;<span class="ident" id="6048829">d</span><span class="op" id="6048830">.</span><span class="ident" id="6048831">bytes</span><span class="op" id="6048836">.</span><span class="ident" id="6048837">i</span>&nbsp;<span class="op" id="6048839">!=</span>&nbsp;<span class="ident" id="6048842">d</span><span class="op" id="6048843">.</span><span class="ident" id="6048844">bytes</span><span class="op" id="6048849">.</span><span class="ident" id="6048850">j</span>&nbsp;<span class="op" id="6048852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6048856">panic</span><span class="op" id="6048861">(</span><span class="string" id="6048862">&#34;jpeg:&nbsp;fill&nbsp;called&nbsp;when&nbsp;unread&nbsp;bytes&nbsp;exist&#34;</span><span class="op" id="6048905">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048911">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;2&nbsp;bytes&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;in&nbsp;case&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048981">//&nbsp;to&nbsp;call&nbsp;unreadByteStuffedByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049016">if</span>&nbsp;<span class="ident" id="6049019">d</span><span class="op" id="6049020">.</span><span class="ident" id="6049021">bytes</span><span class="op" id="6049026">.</span><span class="ident" id="6049027">j</span>&nbsp;<span class="op" id="6049029">&gt;</span>&nbsp;<span class="num" id="6049031">2</span>&nbsp;<span class="op" id="6049033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049037">d</span><span class="op" id="6049038">.</span><span class="ident" id="6049039">bytes</span><span class="op" id="6049044">.</span><span class="ident" id="6049045">buf</span><span class="op" id="6049048">[</span><span class="num" id="6049049">0</span><span class="op" id="6049050">]</span>&nbsp;<span class="op" id="6049052">=</span>&nbsp;<span class="ident" id="6049054">d</span><span class="op" id="6049055">.</span><span class="ident" id="6049056">bytes</span><span class="op" id="6049061">.</span><span class="ident" id="6049062">buf</span><span class="op" id="6049065">[</span><span class="ident" id="6049066">d</span><span class="op" id="6049067">.</span><span class="ident" id="6049068">bytes</span><span class="op" id="6049073">.</span><span class="ident" id="6049074">j</span><span class="op" id="6049075">-</span><span class="num" id="6049076">2</span><span class="op" id="6049077">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049081">d</span><span class="op" id="6049082">.</span><span class="ident" id="6049083">bytes</span><span class="op" id="6049088">.</span><span class="ident" id="6049089">buf</span><span class="op" id="6049092">[</span><span class="num" id="6049093">1</span><span class="op" id="6049094">]</span>&nbsp;<span class="op" id="6049096">=</span>&nbsp;<span class="ident" id="6049098">d</span><span class="op" id="6049099">.</span><span class="ident" id="6049100">bytes</span><span class="op" id="6049105">.</span><span class="ident" id="6049106">buf</span><span class="op" id="6049109">[</span><span class="ident" id="6049110">d</span><span class="op" id="6049111">.</span><span class="ident" id="6049112">bytes</span><span class="op" id="6049117">.</span><span class="ident" id="6049118">j</span><span class="op" id="6049119">-</span><span class="num" id="6049120">1</span><span class="op" id="6049121">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049125">d</span><span class="op" id="6049126">.</span><span class="ident" id="6049127">bytes</span><span class="op" id="6049132">.</span><span class="ident" id="6049133">i</span><span class="op" id="6049134">,</span>&nbsp;<span class="ident" id="6049136">d</span><span class="op" id="6049137">.</span><span class="ident" id="6049138">bytes</span><span class="op" id="6049143">.</span><span class="ident" id="6049144">j</span>&nbsp;<span class="op" id="6049146">=</span>&nbsp;<span class="num" id="6049148">2</span><span class="op" id="6049149">,</span>&nbsp;<span class="num" id="6049151">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6049157">//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049193">n</span><span class="op" id="6049194">,</span>&nbsp;<span class="ident" id="6049196">err</span>&nbsp;<span class="op" id="6049200">:=</span>&nbsp;<span class="ident" id="6049203">d</span><span class="op" id="6049204">.</span><span class="ident" id="6049205">r</span><span class="op" id="6049206">.</span><span class="ident" id="6049207">Read</span><span class="op" id="6049211">(</span><span class="ident" id="6049212">d</span><span class="op" id="6049213">.</span><span class="ident" id="6049214">bytes</span><span class="op" id="6049219">.</span><span class="ident" id="6049220">buf</span><span class="op" id="6049223">[</span><span class="ident" id="6049224">d</span><span class="op" id="6049225">.</span><span class="ident" id="6049226">bytes</span><span class="op" id="6049231">.</span><span class="ident" id="6049232">j</span><span class="op" id="6049233">:</span><span class="op" id="6049234">]</span><span class="op" id="6049235">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049238">d</span><span class="op" id="6049239">.</span><span class="ident" id="6049240">bytes</span><span class="op" id="6049245">.</span><span class="ident" id="6049246">j</span>&nbsp;<span class="op" id="6049248">+=</span>&nbsp;<span class="ident" id="6049251">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049254">if</span>&nbsp;<span class="ident" id="6049257">n</span>&nbsp;<span class="op" id="6049259">&gt;</span>&nbsp;<span class="num" id="6049261">0</span>&nbsp;<span class="op" id="6049263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049267">err</span>&nbsp;<span class="op" id="6049271">=</span>&nbsp;<span class="ident" id="6049273">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049281">return</span>&nbsp;<span class="ident" id="6049288">err</span><br>
<span class="lineno">150</span><span class="op" id="6049292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6049295">//&nbsp;unreadByteStuffedByte&nbsp;undoes&nbsp;the&nbsp;most&nbsp;recent&nbsp;readByteStuffedByte&nbsp;call,</span><br>
<span class="lineno"></span><span class="comment" id="6049369">//&nbsp;giving&nbsp;a&nbsp;byte&nbsp;of&nbsp;data&nbsp;back&nbsp;from&nbsp;d.bits&nbsp;to&nbsp;d.bytes.&nbsp;The&nbsp;Huffman&nbsp;look-up&nbsp;table</span><br>
<span class="lineno"></span><span class="comment" id="6049449">//&nbsp;requires&nbsp;at&nbsp;least&nbsp;8&nbsp;bits&nbsp;for&nbsp;look-up,&nbsp;which&nbsp;means&nbsp;that&nbsp;Huffman&nbsp;decoding&nbsp;can</span><br>
<span class="lineno">155</span><span class="comment" id="6049528">//&nbsp;sometimes&nbsp;overshoot&nbsp;and&nbsp;read&nbsp;one&nbsp;or&nbsp;two&nbsp;too&nbsp;many&nbsp;bytes.&nbsp;Two-byte&nbsp;overshoot</span><br>
<span class="lineno"></span><span class="comment" id="6049606">//&nbsp;can&nbsp;happen&nbsp;when&nbsp;expecting&nbsp;to&nbsp;read&nbsp;a&nbsp;0xff&nbsp;0x00&nbsp;byte-stuffed&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="6049674">func</span>&nbsp;<span class="op" id="6049679">(</span><span class="ident" id="6049680">d</span>&nbsp;<span class="op" id="6049682">*</span><span class="ident" id="6049683">decoder</span><span class="op" id="6049690">)</span>&nbsp;<span class="ident" id="6049692">unreadByteStuffedByte</span><span class="op" id="6049713">(</span><span class="op" id="6049714">)</span>&nbsp;<span class="op" id="6049716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049719">if</span>&nbsp;<span class="ident" id="6049722">d</span><span class="op" id="6049723">.</span><span class="ident" id="6049724">bytes</span><span class="op" id="6049729">.</span><span class="ident" id="6049730">nUnreadable</span>&nbsp;<span class="op" id="6049742">==</span>&nbsp;<span class="num" id="6049745">0</span>&nbsp;<span class="op" id="6049747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6049751">panic</span><span class="op" id="6049756">(</span><span class="string" id="6049757">&#34;jpeg:&nbsp;unreadByteStuffedByte&nbsp;call&nbsp;cannot&nbsp;be&nbsp;fulfilled&#34;</span><span class="op" id="6049811">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049817">d</span><span class="op" id="6049818">.</span><span class="ident" id="6049819">bytes</span><span class="op" id="6049824">.</span><span class="ident" id="6049825">i</span>&nbsp;<span class="op" id="6049827">-=</span>&nbsp;<span class="ident" id="6049830">d</span><span class="op" id="6049831">.</span><span class="ident" id="6049832">bytes</span><span class="op" id="6049837">.</span><span class="ident" id="6049838">nUnreadable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049851">d</span><span class="op" id="6049852">.</span><span class="ident" id="6049853">bytes</span><span class="op" id="6049858">.</span><span class="ident" id="6049859">nUnreadable</span>&nbsp;<span class="op" id="6049871">=</span>&nbsp;<span class="num" id="6049873">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049876">if</span>&nbsp;<span class="ident" id="6049879">d</span><span class="op" id="6049880">.</span><span class="ident" id="6049881">bits</span><span class="op" id="6049885">.</span><span class="ident" id="6049886">n</span>&nbsp;<span class="op" id="6049888">&gt;=</span>&nbsp;<span class="num" id="6049891">8</span>&nbsp;<span class="op" id="6049893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049897">d</span><span class="op" id="6049898">.</span><span class="ident" id="6049899">bits</span><span class="op" id="6049903">.</span><span class="ident" id="6049904">a</span>&nbsp;<span class="op" id="6049906">&gt;&gt;=</span>&nbsp;<span class="num" id="6049910">8</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049914">d</span><span class="op" id="6049915">.</span><span class="ident" id="6049916">bits</span><span class="op" id="6049920">.</span><span class="ident" id="6049921">n</span>&nbsp;<span class="op" id="6049923">-=</span>&nbsp;<span class="num" id="6049926">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049930">d</span><span class="op" id="6049931">.</span><span class="ident" id="6049932">bits</span><span class="op" id="6049936">.</span><span class="ident" id="6049937">m</span>&nbsp;<span class="op" id="6049939">&gt;&gt;=</span>&nbsp;<span class="num" id="6049943">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049946">}</span><br>
<span class="lineno"></span><span class="op" id="6049948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6049951">//&nbsp;readByte&nbsp;returns&nbsp;the&nbsp;next&nbsp;byte,&nbsp;whether&nbsp;buffered&nbsp;or&nbsp;not&nbsp;buffered.&nbsp;It&nbsp;does</span><br>
<span class="lineno"></span><span class="comment" id="6050028">//&nbsp;not&nbsp;care&nbsp;about&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="6050061">func</span>&nbsp;<span class="op" id="6050066">(</span><span class="ident" id="6050067">d</span>&nbsp;<span class="op" id="6050069">*</span><span class="ident" id="6050070">decoder</span><span class="op" id="6050077">)</span>&nbsp;<span class="ident" id="6050079">readByte</span><span class="op" id="6050087">(</span><span class="op" id="6050088">)</span>&nbsp;<span class="op" id="6050090">(</span><span class="ident" id="6050091">x</span>&nbsp;<span class="builtintype" id="6050093">byte</span><span class="op" id="6050097">,</span>&nbsp;<span class="ident" id="6050099">err</span>&nbsp;<span class="builtintype" id="6050103">error</span><span class="op" id="6050108">)</span>&nbsp;<span class="op" id="6050110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050113">for</span>&nbsp;<span class="ident" id="6050117">d</span><span class="op" id="6050118">.</span><span class="ident" id="6050119">bytes</span><span class="op" id="6050124">.</span><span class="ident" id="6050125">i</span>&nbsp;<span class="op" id="6050127">==</span>&nbsp;<span class="ident" id="6050130">d</span><span class="op" id="6050131">.</span><span class="ident" id="6050132">bytes</span><span class="op" id="6050137">.</span><span class="ident" id="6050138">j</span>&nbsp;<span class="op" id="6050140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050144">if</span>&nbsp;<span class="ident" id="6050147">err</span>&nbsp;<span class="op" id="6050151">=</span>&nbsp;<span class="ident" id="6050153">d</span><span class="op" id="6050154">.</span><span class="ident" id="6050155">fill</span><span class="op" id="6050159">(</span><span class="op" id="6050160">)</span><span class="op" id="6050161">;</span>&nbsp;<span class="ident" id="6050163">err</span>&nbsp;<span class="op" id="6050167">!=</span>&nbsp;<span class="ident" id="6050170">nil</span>&nbsp;<span class="op" id="6050174">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050179">return</span>&nbsp;<span class="num" id="6050186">0</span><span class="op" id="6050187">,</span>&nbsp;<span class="ident" id="6050189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050201">x</span>&nbsp;<span class="op" id="6050203">=</span>&nbsp;<span class="ident" id="6050205">d</span><span class="op" id="6050206">.</span><span class="ident" id="6050207">bytes</span><span class="op" id="6050212">.</span><span class="ident" id="6050213">buf</span><span class="op" id="6050216">[</span><span class="ident" id="6050217">d</span><span class="op" id="6050218">.</span><span class="ident" id="6050219">bytes</span><span class="op" id="6050224">.</span><span class="ident" id="6050225">i</span><span class="op" id="6050226">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050229">d</span><span class="op" id="6050230">.</span><span class="ident" id="6050231">bytes</span><span class="op" id="6050236">.</span><span class="ident" id="6050237">i</span><span class="op" id="6050238">++</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050242">d</span><span class="op" id="6050243">.</span><span class="ident" id="6050244">bytes</span><span class="op" id="6050249">.</span><span class="ident" id="6050250">nUnreadable</span>&nbsp;<span class="op" id="6050262">=</span>&nbsp;<span class="num" id="6050264">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050267">return</span>&nbsp;<span class="ident" id="6050274">x</span><span class="op" id="6050275">,</span>&nbsp;<span class="ident" id="6050277">nil</span><br>
<span class="lineno"></span><span class="op" id="6050281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6050284">//&nbsp;errMissingFF00&nbsp;means&nbsp;that&nbsp;readByteStuffedByte&nbsp;encountered&nbsp;an&nbsp;0xff&nbsp;byte&nbsp;(a</span><br>
<span class="lineno">185</span><span class="comment" id="6050361">//&nbsp;marker&nbsp;byte)&nbsp;that&nbsp;wasn&#39;t&nbsp;the&nbsp;expected&nbsp;byte-stuffed&nbsp;sequence&nbsp;0xff,&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword" id="6050436">var</span>&nbsp;<span class="ident" id="6050440">errMissingFF00</span>&nbsp;<span class="op" id="6050455">=</span>&nbsp;<span class="ident" id="6050457">FormatError</span><span class="op" id="6050468">(</span><span class="string" id="6050469">&#34;missing&nbsp;0xff00&nbsp;sequence&#34;</span><span class="op" id="6050494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6050497">//&nbsp;readByteStuffedByte&nbsp;is&nbsp;like&nbsp;readByte&nbsp;but&nbsp;is&nbsp;for&nbsp;byte-stuffed&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6050575">func</span>&nbsp;<span class="op" id="6050580">(</span><span class="ident" id="6050581">d</span>&nbsp;<span class="op" id="6050583">*</span><span class="ident" id="6050584">decoder</span><span class="op" id="6050591">)</span>&nbsp;<span class="ident" id="6050593">readByteStuffedByte</span><span class="op" id="6050612">(</span><span class="op" id="6050613">)</span>&nbsp;<span class="op" id="6050615">(</span><span class="ident" id="6050616">x</span>&nbsp;<span class="builtintype" id="6050618">byte</span><span class="op" id="6050622">,</span>&nbsp;<span class="ident" id="6050624">err</span>&nbsp;<span class="builtintype" id="6050628">error</span><span class="op" id="6050633">)</span>&nbsp;<span class="op" id="6050635">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050638">//&nbsp;Take&nbsp;the&nbsp;fast&nbsp;path&nbsp;if&nbsp;d.bytes.buf&nbsp;contains&nbsp;at&nbsp;least&nbsp;two&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050705">if</span>&nbsp;<span class="ident" id="6050708">d</span><span class="op" id="6050709">.</span><span class="ident" id="6050710">bytes</span><span class="op" id="6050715">.</span><span class="ident" id="6050716">i</span><span class="op" id="6050717">+</span><span class="num" id="6050718">2</span>&nbsp;<span class="op" id="6050720">&lt;=</span>&nbsp;<span class="ident" id="6050723">d</span><span class="op" id="6050724">.</span><span class="ident" id="6050725">bytes</span><span class="op" id="6050730">.</span><span class="ident" id="6050731">j</span>&nbsp;<span class="op" id="6050733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050737">x</span>&nbsp;<span class="op" id="6050739">=</span>&nbsp;<span class="ident" id="6050741">d</span><span class="op" id="6050742">.</span><span class="ident" id="6050743">bytes</span><span class="op" id="6050748">.</span><span class="ident" id="6050749">buf</span><span class="op" id="6050752">[</span><span class="ident" id="6050753">d</span><span class="op" id="6050754">.</span><span class="ident" id="6050755">bytes</span><span class="op" id="6050760">.</span><span class="ident" id="6050761">i</span><span class="op" id="6050762">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050766">d</span><span class="op" id="6050767">.</span><span class="ident" id="6050768">bytes</span><span class="op" id="6050773">.</span><span class="ident" id="6050774">i</span><span class="op" id="6050775">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050780">d</span><span class="op" id="6050781">.</span><span class="ident" id="6050782">bytes</span><span class="op" id="6050787">.</span><span class="ident" id="6050788">nUnreadable</span>&nbsp;<span class="op" id="6050800">=</span>&nbsp;<span class="num" id="6050802">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050806">if</span>&nbsp;<span class="ident" id="6050809">x</span>&nbsp;<span class="op" id="6050811">!=</span>&nbsp;<span class="num" id="6050814">0xff</span>&nbsp;<span class="op" id="6050819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050824">return</span>&nbsp;<span class="ident" id="6050831">x</span><span class="op" id="6050832">,</span>&nbsp;<span class="ident" id="6050834">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050844">if</span>&nbsp;<span class="ident" id="6050847">d</span><span class="op" id="6050848">.</span><span class="ident" id="6050849">bytes</span><span class="op" id="6050854">.</span><span class="ident" id="6050855">buf</span><span class="op" id="6050858">[</span><span class="ident" id="6050859">d</span><span class="op" id="6050860">.</span><span class="ident" id="6050861">bytes</span><span class="op" id="6050866">.</span><span class="ident" id="6050867">i</span><span class="op" id="6050868">]</span>&nbsp;<span class="op" id="6050870">!=</span>&nbsp;<span class="num" id="6050873">0x00</span>&nbsp;<span class="op" id="6050878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050883">return</span>&nbsp;<span class="num" id="6050890">0</span><span class="op" id="6050891">,</span>&nbsp;<span class="ident" id="6050893">errMissingFF00</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050914">d</span><span class="op" id="6050915">.</span><span class="ident" id="6050916">bytes</span><span class="op" id="6050921">.</span><span class="ident" id="6050922">i</span><span class="op" id="6050923">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050928">d</span><span class="op" id="6050929">.</span><span class="ident" id="6050930">bytes</span><span class="op" id="6050935">.</span><span class="ident" id="6050936">nUnreadable</span>&nbsp;<span class="op" id="6050948">=</span>&nbsp;<span class="num" id="6050950">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050954">return</span>&nbsp;<span class="num" id="6050961">0xff</span><span class="op" id="6050965">,</span>&nbsp;<span class="ident" id="6050967">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050972">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050976">x</span><span class="op" id="6050977">,</span>&nbsp;<span class="ident" id="6050979">err</span>&nbsp;<span class="op" id="6050983">=</span>&nbsp;<span class="ident" id="6050985">d</span><span class="op" id="6050986">.</span><span class="ident" id="6050987">readByte</span><span class="op" id="6050995">(</span><span class="op" id="6050996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050999">if</span>&nbsp;<span class="ident" id="6051002">err</span>&nbsp;<span class="op" id="6051006">!=</span>&nbsp;<span class="ident" id="6051009">nil</span>&nbsp;<span class="op" id="6051013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051017">return</span>&nbsp;<span class="num" id="6051024">0</span><span class="op" id="6051025">,</span>&nbsp;<span class="ident" id="6051027">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051032">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051035">if</span>&nbsp;<span class="ident" id="6051038">x</span>&nbsp;<span class="op" id="6051040">!=</span>&nbsp;<span class="num" id="6051043">0xff</span>&nbsp;<span class="op" id="6051048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051052">d</span><span class="op" id="6051053">.</span><span class="ident" id="6051054">bytes</span><span class="op" id="6051059">.</span><span class="ident" id="6051060">nUnreadable</span>&nbsp;<span class="op" id="6051072">=</span>&nbsp;<span class="num" id="6051074">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051078">return</span>&nbsp;<span class="ident" id="6051085">x</span><span class="op" id="6051086">,</span>&nbsp;<span class="ident" id="6051088">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051097">x</span><span class="op" id="6051098">,</span>&nbsp;<span class="ident" id="6051100">err</span>&nbsp;<span class="op" id="6051104">=</span>&nbsp;<span class="ident" id="6051106">d</span><span class="op" id="6051107">.</span><span class="ident" id="6051108">readByte</span><span class="op" id="6051116">(</span><span class="op" id="6051117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051120">if</span>&nbsp;<span class="ident" id="6051123">err</span>&nbsp;<span class="op" id="6051127">!=</span>&nbsp;<span class="ident" id="6051130">nil</span>&nbsp;<span class="op" id="6051134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051138">d</span><span class="op" id="6051139">.</span><span class="ident" id="6051140">bytes</span><span class="op" id="6051145">.</span><span class="ident" id="6051146">nUnreadable</span>&nbsp;<span class="op" id="6051158">=</span>&nbsp;<span class="num" id="6051160">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051164">return</span>&nbsp;<span class="num" id="6051171">0</span><span class="op" id="6051172">,</span>&nbsp;<span class="ident" id="6051174">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051179">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051182">d</span><span class="op" id="6051183">.</span><span class="ident" id="6051184">bytes</span><span class="op" id="6051189">.</span><span class="ident" id="6051190">nUnreadable</span>&nbsp;<span class="op" id="6051202">=</span>&nbsp;<span class="num" id="6051204">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051207">if</span>&nbsp;<span class="ident" id="6051210">x</span>&nbsp;<span class="op" id="6051212">!=</span>&nbsp;<span class="num" id="6051215">0x00</span>&nbsp;<span class="op" id="6051220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051224">return</span>&nbsp;<span class="num" id="6051231">0</span><span class="op" id="6051232">,</span>&nbsp;<span class="ident" id="6051234">errMissingFF00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051253">return</span>&nbsp;<span class="num" id="6051260">0xff</span><span class="op" id="6051264">,</span>&nbsp;<span class="ident" id="6051266">nil</span><br>
<span class="lineno">225</span><span class="op" id="6051270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6051273">//&nbsp;readFull&nbsp;reads&nbsp;exactly&nbsp;len(p)&nbsp;bytes&nbsp;into&nbsp;p.&nbsp;It&nbsp;does&nbsp;not&nbsp;care&nbsp;about&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="6051348">//&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="6051361">func</span>&nbsp;<span class="op" id="6051366">(</span><span class="ident" id="6051367">d</span>&nbsp;<span class="op" id="6051369">*</span><span class="ident" id="6051370">decoder</span><span class="op" id="6051377">)</span>&nbsp;<span class="ident" id="6051379">readFull</span><span class="op" id="6051387">(</span><span class="ident" id="6051388">p</span>&nbsp;<span class="op" id="6051390">[</span><span class="op" id="6051391">]</span><span class="builtintype" id="6051392">byte</span><span class="op" id="6051396">)</span>&nbsp;<span class="builtintype" id="6051398">error</span>&nbsp;<span class="op" id="6051404">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051407">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051446">if</span>&nbsp;<span class="ident" id="6051449">d</span><span class="op" id="6051450">.</span><span class="ident" id="6051451">bytes</span><span class="op" id="6051456">.</span><span class="ident" id="6051457">nUnreadable</span>&nbsp;<span class="op" id="6051469">!=</span>&nbsp;<span class="num" id="6051472">0</span>&nbsp;<span class="op" id="6051474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051478">if</span>&nbsp;<span class="ident" id="6051481">d</span><span class="op" id="6051482">.</span><span class="ident" id="6051483">bits</span><span class="op" id="6051487">.</span><span class="ident" id="6051488">n</span>&nbsp;<span class="op" id="6051490">&gt;=</span>&nbsp;<span class="num" id="6051493">8</span>&nbsp;<span class="op" id="6051495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051500">d</span><span class="op" id="6051501">.</span><span class="ident" id="6051502">unreadByteStuffedByte</span><span class="op" id="6051523">(</span><span class="op" id="6051524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051528">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051532">d</span><span class="op" id="6051533">.</span><span class="ident" id="6051534">bytes</span><span class="op" id="6051539">.</span><span class="ident" id="6051540">nUnreadable</span>&nbsp;<span class="op" id="6051552">=</span>&nbsp;<span class="num" id="6051554">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051561">for</span>&nbsp;<span class="op" id="6051565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051569">n</span>&nbsp;<span class="op" id="6051571">:=</span>&nbsp;<span class="builtinfunc" id="6051574">copy</span><span class="op" id="6051578">(</span><span class="ident" id="6051579">p</span><span class="op" id="6051580">,</span>&nbsp;<span class="ident" id="6051582">d</span><span class="op" id="6051583">.</span><span class="ident" id="6051584">bytes</span><span class="op" id="6051589">.</span><span class="ident" id="6051590">buf</span><span class="op" id="6051593">[</span><span class="ident" id="6051594">d</span><span class="op" id="6051595">.</span><span class="ident" id="6051596">bytes</span><span class="op" id="6051601">.</span><span class="ident" id="6051602">i</span><span class="op" id="6051603">:</span><span class="ident" id="6051604">d</span><span class="op" id="6051605">.</span><span class="ident" id="6051606">bytes</span><span class="op" id="6051611">.</span><span class="ident" id="6051612">j</span><span class="op" id="6051613">]</span><span class="op" id="6051614">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051618">p</span>&nbsp;<span class="op" id="6051620">=</span>&nbsp;<span class="ident" id="6051622">p</span><span class="op" id="6051623">[</span><span class="ident" id="6051624">n</span><span class="op" id="6051625">:</span><span class="op" id="6051626">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051630">d</span><span class="op" id="6051631">.</span><span class="ident" id="6051632">bytes</span><span class="op" id="6051637">.</span><span class="ident" id="6051638">i</span>&nbsp;<span class="op" id="6051640">+=</span>&nbsp;<span class="ident" id="6051643">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051647">if</span>&nbsp;<span class="builtinfunc" id="6051650">len</span><span class="op" id="6051653">(</span><span class="ident" id="6051654">p</span><span class="op" id="6051655">)</span>&nbsp;<span class="op" id="6051657">==</span>&nbsp;<span class="num" id="6051660">0</span>&nbsp;<span class="op" id="6051662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051667">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051675">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051679">if</span>&nbsp;<span class="ident" id="6051682">err</span>&nbsp;<span class="op" id="6051686">:=</span>&nbsp;<span class="ident" id="6051689">d</span><span class="op" id="6051690">.</span><span class="ident" id="6051691">fill</span><span class="op" id="6051695">(</span><span class="op" id="6051696">)</span><span class="op" id="6051697">;</span>&nbsp;<span class="ident" id="6051699">err</span>&nbsp;<span class="op" id="6051703">!=</span>&nbsp;<span class="ident" id="6051706">nil</span>&nbsp;<span class="op" id="6051710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051715">if</span>&nbsp;<span class="ident" id="6051718">err</span>&nbsp;<span class="op" id="6051722">==</span>&nbsp;<span class="ident" id="6051725">io</span><span class="op" id="6051727">.</span><span class="ident" id="6051728">EOF</span>&nbsp;<span class="op" id="6051732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051738">err</span>&nbsp;<span class="op" id="6051742">=</span>&nbsp;<span class="ident" id="6051744">io</span><span class="op" id="6051746">.</span><span class="ident" id="6051747">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051772">return</span>&nbsp;<span class="ident" id="6051779">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051791">return</span>&nbsp;<span class="ident" id="6051798">nil</span><br>
<span class="lineno"></span><span class="op" id="6051802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6051805">//&nbsp;ignore&nbsp;ignores&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="6051841">func</span>&nbsp;<span class="op" id="6051846">(</span><span class="ident" id="6051847">d</span>&nbsp;<span class="op" id="6051849">*</span><span class="ident" id="6051850">decoder</span><span class="op" id="6051857">)</span>&nbsp;<span class="ident" id="6051859">ignore</span><span class="op" id="6051865">(</span><span class="ident" id="6051866">n</span>&nbsp;<span class="builtintype" id="6051868">int</span><span class="op" id="6051871">)</span>&nbsp;<span class="builtintype" id="6051873">error</span>&nbsp;<span class="op" id="6051879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051882">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051921">if</span>&nbsp;<span class="ident" id="6051924">d</span><span class="op" id="6051925">.</span><span class="ident" id="6051926">bytes</span><span class="op" id="6051931">.</span><span class="ident" id="6051932">nUnreadable</span>&nbsp;<span class="op" id="6051944">!=</span>&nbsp;<span class="num" id="6051947">0</span>&nbsp;<span class="op" id="6051949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051953">if</span>&nbsp;<span class="ident" id="6051956">d</span><span class="op" id="6051957">.</span><span class="ident" id="6051958">bits</span><span class="op" id="6051962">.</span><span class="ident" id="6051963">n</span>&nbsp;<span class="op" id="6051965">&gt;=</span>&nbsp;<span class="num" id="6051968">8</span>&nbsp;<span class="op" id="6051970">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051975">d</span><span class="op" id="6051976">.</span><span class="ident" id="6051977">unreadByteStuffedByte</span><span class="op" id="6051998">(</span><span class="op" id="6051999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052007">d</span><span class="op" id="6052008">.</span><span class="ident" id="6052009">bytes</span><span class="op" id="6052014">.</span><span class="ident" id="6052015">nUnreadable</span>&nbsp;<span class="op" id="6052027">=</span>&nbsp;<span class="num" id="6052029">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052036">for</span>&nbsp;<span class="op" id="6052040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052044">m</span>&nbsp;<span class="op" id="6052046">:=</span>&nbsp;<span class="ident" id="6052049">d</span><span class="op" id="6052050">.</span><span class="ident" id="6052051">bytes</span><span class="op" id="6052056">.</span><span class="ident" id="6052057">j</span>&nbsp;<span class="op" id="6052059">-</span>&nbsp;<span class="ident" id="6052061">d</span><span class="op" id="6052062">.</span><span class="ident" id="6052063">bytes</span><span class="op" id="6052068">.</span><span class="ident" id="6052069">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052073">if</span>&nbsp;<span class="ident" id="6052076">m</span>&nbsp;<span class="op" id="6052078">&gt;</span>&nbsp;<span class="ident" id="6052080">n</span>&nbsp;<span class="op" id="6052082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052087">m</span>&nbsp;<span class="op" id="6052089">=</span>&nbsp;<span class="ident" id="6052091">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052095">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052099">d</span><span class="op" id="6052100">.</span><span class="ident" id="6052101">bytes</span><span class="op" id="6052106">.</span><span class="ident" id="6052107">i</span>&nbsp;<span class="op" id="6052109">+=</span>&nbsp;<span class="ident" id="6052112">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052116">n</span>&nbsp;<span class="op" id="6052118">-=</span>&nbsp;<span class="ident" id="6052121">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052125">if</span>&nbsp;<span class="ident" id="6052128">n</span>&nbsp;<span class="op" id="6052130">==</span>&nbsp;<span class="num" id="6052133">0</span>&nbsp;<span class="op" id="6052135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052140">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052148">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052152">if</span>&nbsp;<span class="ident" id="6052155">err</span>&nbsp;<span class="op" id="6052159">:=</span>&nbsp;<span class="ident" id="6052162">d</span><span class="op" id="6052163">.</span><span class="ident" id="6052164">fill</span><span class="op" id="6052168">(</span><span class="op" id="6052169">)</span><span class="op" id="6052170">;</span>&nbsp;<span class="ident" id="6052172">err</span>&nbsp;<span class="op" id="6052176">!=</span>&nbsp;<span class="ident" id="6052179">nil</span>&nbsp;<span class="op" id="6052183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052188">if</span>&nbsp;<span class="ident" id="6052191">err</span>&nbsp;<span class="op" id="6052195">==</span>&nbsp;<span class="ident" id="6052198">io</span><span class="op" id="6052200">.</span><span class="ident" id="6052201">EOF</span>&nbsp;<span class="op" id="6052205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052211">err</span>&nbsp;<span class="op" id="6052215">=</span>&nbsp;<span class="ident" id="6052217">io</span><span class="op" id="6052219">.</span><span class="ident" id="6052220">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052245">return</span>&nbsp;<span class="ident" id="6052252">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052264">return</span>&nbsp;<span class="ident" id="6052271">nil</span><br>
<span class="lineno"></span><span class="op" id="6052275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="6052278">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6052309">func</span>&nbsp;<span class="op" id="6052314">(</span><span class="ident" id="6052315">d</span>&nbsp;<span class="op" id="6052317">*</span><span class="ident" id="6052318">decoder</span><span class="op" id="6052325">)</span>&nbsp;<span class="ident" id="6052327">processSOF</span><span class="op" id="6052337">(</span><span class="ident" id="6052338">n</span>&nbsp;<span class="builtintype" id="6052340">int</span><span class="op" id="6052343">)</span>&nbsp;<span class="builtintype" id="6052345">error</span>&nbsp;<span class="op" id="6052351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052354">switch</span>&nbsp;<span class="ident" id="6052361">n</span>&nbsp;<span class="op" id="6052363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052366">case</span>&nbsp;<span class="num" id="6052371">6</span>&nbsp;<span class="op" id="6052373">+</span>&nbsp;<span class="num" id="6052375">3</span><span class="op" id="6052376">*</span><span class="ident" id="6052377">nGrayComponent</span><span class="op" id="6052391">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052395">d</span><span class="op" id="6052396">.</span><span class="ident" id="6052397">nComp</span>&nbsp;<span class="op" id="6052403">=</span>&nbsp;<span class="ident" id="6052405">nGrayComponent</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052421">case</span>&nbsp;<span class="num" id="6052426">6</span>&nbsp;<span class="op" id="6052428">+</span>&nbsp;<span class="num" id="6052430">3</span><span class="op" id="6052431">*</span><span class="ident" id="6052432">nColorComponent</span><span class="op" id="6052447">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052451">d</span><span class="op" id="6052452">.</span><span class="ident" id="6052453">nComp</span>&nbsp;<span class="op" id="6052459">=</span>&nbsp;<span class="ident" id="6052461">nColorComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052478">default</span><span class="op" id="6052485">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052489">return</span>&nbsp;<span class="ident" id="6052496">UnsupportedError</span><span class="op" id="6052512">(</span><span class="string" id="6052513">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6052535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052538">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052541">if</span>&nbsp;<span class="ident" id="6052544">err</span>&nbsp;<span class="op" id="6052548">:=</span>&nbsp;<span class="ident" id="6052551">d</span><span class="op" id="6052552">.</span><span class="ident" id="6052553">readFull</span><span class="op" id="6052561">(</span><span class="ident" id="6052562">d</span><span class="op" id="6052563">.</span><span class="ident" id="6052564">tmp</span><span class="op" id="6052567">[</span><span class="op" id="6052568">:</span><span class="ident" id="6052569">n</span><span class="op" id="6052570">]</span><span class="op" id="6052571">)</span><span class="op" id="6052572">;</span>&nbsp;<span class="ident" id="6052574">err</span>&nbsp;<span class="op" id="6052578">!=</span>&nbsp;<span class="ident" id="6052581">nil</span>&nbsp;<span class="op" id="6052585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052589">return</span>&nbsp;<span class="ident" id="6052596">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052604">//&nbsp;We&nbsp;only&nbsp;support&nbsp;8-bit&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052641">if</span>&nbsp;<span class="ident" id="6052644">d</span><span class="op" id="6052645">.</span><span class="ident" id="6052646">tmp</span><span class="op" id="6052649">[</span><span class="num" id="6052650">0</span><span class="op" id="6052651">]</span>&nbsp;<span class="op" id="6052653">!=</span>&nbsp;<span class="num" id="6052656">8</span>&nbsp;<span class="op" id="6052658">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052662">return</span>&nbsp;<span class="ident" id="6052669">UnsupportedError</span><span class="op" id="6052685">(</span><span class="string" id="6052686">&#34;precision&#34;</span><span class="op" id="6052697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052703">d</span><span class="op" id="6052704">.</span><span class="ident" id="6052705">height</span>&nbsp;<span class="op" id="6052712">=</span>&nbsp;<span class="builtintype" id="6052714">int</span><span class="op" id="6052717">(</span><span class="ident" id="6052718">d</span><span class="op" id="6052719">.</span><span class="ident" id="6052720">tmp</span><span class="op" id="6052723">[</span><span class="num" id="6052724">1</span><span class="op" id="6052725">]</span><span class="op" id="6052726">)</span><span class="op" id="6052727">&lt;&lt;</span><span class="num" id="6052729">8</span>&nbsp;<span class="op" id="6052731">+</span>&nbsp;<span class="builtintype" id="6052733">int</span><span class="op" id="6052736">(</span><span class="ident" id="6052737">d</span><span class="op" id="6052738">.</span><span class="ident" id="6052739">tmp</span><span class="op" id="6052742">[</span><span class="num" id="6052743">2</span><span class="op" id="6052744">]</span><span class="op" id="6052745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052748">d</span><span class="op" id="6052749">.</span><span class="ident" id="6052750">width</span>&nbsp;<span class="op" id="6052756">=</span>&nbsp;<span class="builtintype" id="6052758">int</span><span class="op" id="6052761">(</span><span class="ident" id="6052762">d</span><span class="op" id="6052763">.</span><span class="ident" id="6052764">tmp</span><span class="op" id="6052767">[</span><span class="num" id="6052768">3</span><span class="op" id="6052769">]</span><span class="op" id="6052770">)</span><span class="op" id="6052771">&lt;&lt;</span><span class="num" id="6052773">8</span>&nbsp;<span class="op" id="6052775">+</span>&nbsp;<span class="builtintype" id="6052777">int</span><span class="op" id="6052780">(</span><span class="ident" id="6052781">d</span><span class="op" id="6052782">.</span><span class="ident" id="6052783">tmp</span><span class="op" id="6052786">[</span><span class="num" id="6052787">4</span><span class="op" id="6052788">]</span><span class="op" id="6052789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052792">if</span>&nbsp;<span class="builtintype" id="6052795">int</span><span class="op" id="6052798">(</span><span class="ident" id="6052799">d</span><span class="op" id="6052800">.</span><span class="ident" id="6052801">tmp</span><span class="op" id="6052804">[</span><span class="num" id="6052805">5</span><span class="op" id="6052806">]</span><span class="op" id="6052807">)</span>&nbsp;<span class="op" id="6052809">!=</span>&nbsp;<span class="ident" id="6052812">d</span><span class="op" id="6052813">.</span><span class="ident" id="6052814">nComp</span>&nbsp;<span class="op" id="6052820">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052824">return</span>&nbsp;<span class="ident" id="6052831">UnsupportedError</span><span class="op" id="6052847">(</span><span class="string" id="6052848">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;image&nbsp;components&#34;</span><span class="op" id="6052890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052896">for</span>&nbsp;<span class="ident" id="6052900">i</span>&nbsp;<span class="op" id="6052902">:=</span>&nbsp;<span class="num" id="6052905">0</span><span class="op" id="6052906">;</span>&nbsp;<span class="ident" id="6052908">i</span>&nbsp;<span class="op" id="6052910">&lt;</span>&nbsp;<span class="ident" id="6052912">d</span><span class="op" id="6052913">.</span><span class="ident" id="6052914">nComp</span><span class="op" id="6052919">;</span>&nbsp;<span class="ident" id="6052921">i</span><span class="op" id="6052922">++</span>&nbsp;<span class="op" id="6052925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052929">d</span><span class="op" id="6052930">.</span><span class="ident" id="6052931">comp</span><span class="op" id="6052935">[</span><span class="ident" id="6052936">i</span><span class="op" id="6052937">]</span><span class="op" id="6052938">.</span><span class="ident" id="6052939">c</span>&nbsp;<span class="op" id="6052941">=</span>&nbsp;<span class="ident" id="6052943">d</span><span class="op" id="6052944">.</span><span class="ident" id="6052945">tmp</span><span class="op" id="6052948">[</span><span class="num" id="6052949">6</span><span class="op" id="6052950">+</span><span class="num" id="6052951">3</span><span class="op" id="6052952">*</span><span class="ident" id="6052953">i</span><span class="op" id="6052954">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052958">d</span><span class="op" id="6052959">.</span><span class="ident" id="6052960">comp</span><span class="op" id="6052964">[</span><span class="ident" id="6052965">i</span><span class="op" id="6052966">]</span><span class="op" id="6052967">.</span><span class="ident" id="6052968">tq</span>&nbsp;<span class="op" id="6052971">=</span>&nbsp;<span class="ident" id="6052973">d</span><span class="op" id="6052974">.</span><span class="ident" id="6052975">tmp</span><span class="op" id="6052978">[</span><span class="num" id="6052979">8</span><span class="op" id="6052980">+</span><span class="num" id="6052981">3</span><span class="op" id="6052982">*</span><span class="ident" id="6052983">i</span><span class="op" id="6052984">]</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052988">if</span>&nbsp;<span class="ident" id="6052991">d</span><span class="op" id="6052992">.</span><span class="ident" id="6052993">nComp</span>&nbsp;<span class="op" id="6052999">==</span>&nbsp;<span class="ident" id="6053002">nGrayComponent</span>&nbsp;<span class="op" id="6053017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053022">//&nbsp;If&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;one&nbsp;component,&nbsp;section&nbsp;A.2&nbsp;says&nbsp;&#34;this&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053096">//&nbsp;is&nbsp;non-interleaved&nbsp;by&nbsp;definition&#34;&nbsp;and&nbsp;section&nbsp;A.2.2&nbsp;says&nbsp;&#34;[in&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053169">//&nbsp;case...]&nbsp;the&nbsp;order&nbsp;of&nbsp;data&nbsp;units&nbsp;within&nbsp;a&nbsp;scan&nbsp;shall&nbsp;be&nbsp;left-to-right</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053245">//&nbsp;and&nbsp;top-to-bottom...&nbsp;regardless&nbsp;of&nbsp;the&nbsp;values&nbsp;of&nbsp;H_1&nbsp;and&nbsp;V_1&#34;.&nbsp;Section</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053322">//&nbsp;4.8.2&nbsp;also&nbsp;says&nbsp;&#34;[for&nbsp;non-interleaved&nbsp;data],&nbsp;the&nbsp;MCU&nbsp;is&nbsp;defined&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053398">//&nbsp;one&nbsp;data&nbsp;unit&#34;.&nbsp;Similarly,&nbsp;section&nbsp;A.1.1&nbsp;explains&nbsp;that&nbsp;it&nbsp;is&nbsp;the&nbsp;ratio</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053475">//&nbsp;of&nbsp;H_i&nbsp;to&nbsp;max_j(H_j)&nbsp;that&nbsp;matters,&nbsp;and&nbsp;similarly&nbsp;for&nbsp;V.&nbsp;For&nbsp;grayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053551">//&nbsp;images,&nbsp;H_1&nbsp;is&nbsp;the&nbsp;maximum&nbsp;H_j&nbsp;for&nbsp;all&nbsp;components&nbsp;j,&nbsp;so&nbsp;that&nbsp;ratio&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053627">//&nbsp;always&nbsp;1.&nbsp;The&nbsp;component&#39;s&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;effectively&nbsp;always&nbsp;(1,&nbsp;1):&nbsp;even&nbsp;if</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053704">//&nbsp;the&nbsp;nominal&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;(2,&nbsp;1),&nbsp;a&nbsp;20x5&nbsp;image&nbsp;is&nbsp;encoded&nbsp;in&nbsp;three&nbsp;8x8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053777">//&nbsp;MCUs,&nbsp;not&nbsp;two&nbsp;16x8&nbsp;MCUs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053808">d</span><span class="op" id="6053809">.</span><span class="ident" id="6053810">comp</span><span class="op" id="6053814">[</span><span class="ident" id="6053815">i</span><span class="op" id="6053816">]</span><span class="op" id="6053817">.</span><span class="ident" id="6053818">h</span>&nbsp;<span class="op" id="6053820">=</span>&nbsp;<span class="num" id="6053822">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053827">d</span><span class="op" id="6053828">.</span><span class="ident" id="6053829">comp</span><span class="op" id="6053833">[</span><span class="ident" id="6053834">i</span><span class="op" id="6053835">]</span><span class="op" id="6053836">.</span><span class="ident" id="6053837">v</span>&nbsp;<span class="op" id="6053839">=</span>&nbsp;<span class="num" id="6053841">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053846">continue</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053861">hv</span>&nbsp;<span class="op" id="6053864">:=</span>&nbsp;<span class="ident" id="6053867">d</span><span class="op" id="6053868">.</span><span class="ident" id="6053869">tmp</span><span class="op" id="6053872">[</span><span class="num" id="6053873">7</span><span class="op" id="6053874">+</span><span class="num" id="6053875">3</span><span class="op" id="6053876">*</span><span class="ident" id="6053877">i</span><span class="op" id="6053878">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053882">d</span><span class="op" id="6053883">.</span><span class="ident" id="6053884">comp</span><span class="op" id="6053888">[</span><span class="ident" id="6053889">i</span><span class="op" id="6053890">]</span><span class="op" id="6053891">.</span><span class="ident" id="6053892">h</span>&nbsp;<span class="op" id="6053894">=</span>&nbsp;<span class="builtintype" id="6053896">int</span><span class="op" id="6053899">(</span><span class="ident" id="6053900">hv</span>&nbsp;<span class="op" id="6053903">&gt;&gt;</span>&nbsp;<span class="num" id="6053906">4</span><span class="op" id="6053907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053911">d</span><span class="op" id="6053912">.</span><span class="ident" id="6053913">comp</span><span class="op" id="6053917">[</span><span class="ident" id="6053918">i</span><span class="op" id="6053919">]</span><span class="op" id="6053920">.</span><span class="ident" id="6053921">v</span>&nbsp;<span class="op" id="6053923">=</span>&nbsp;<span class="builtintype" id="6053925">int</span><span class="op" id="6053928">(</span><span class="ident" id="6053929">hv</span>&nbsp;<span class="op" id="6053932">&amp;</span>&nbsp;<span class="num" id="6053934">0x0f</span><span class="op" id="6053938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053942">//&nbsp;For&nbsp;color&nbsp;images,&nbsp;we&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;or&nbsp;4:2:0&nbsp;chroma</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054017">//&nbsp;downsampling&nbsp;ratios.&nbsp;This&nbsp;implies&nbsp;that&nbsp;the&nbsp;(h,&nbsp;v)&nbsp;values&nbsp;for&nbsp;the&nbsp;Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054089">//&nbsp;component&nbsp;are&nbsp;either&nbsp;(1,&nbsp;1),&nbsp;(1,&nbsp;2),&nbsp;(2,&nbsp;1)&nbsp;or&nbsp;(2,&nbsp;2),&nbsp;and&nbsp;the&nbsp;(h,&nbsp;v)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054164">//&nbsp;values&nbsp;for&nbsp;the&nbsp;Cr&nbsp;and&nbsp;Cb&nbsp;components&nbsp;must&nbsp;be&nbsp;(1,&nbsp;1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054221">if</span>&nbsp;<span class="ident" id="6054224">i</span>&nbsp;<span class="op" id="6054226">==</span>&nbsp;<span class="num" id="6054229">0</span>&nbsp;<span class="op" id="6054231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054236">if</span>&nbsp;<span class="ident" id="6054239">hv</span>&nbsp;<span class="op" id="6054242">!=</span>&nbsp;<span class="num" id="6054245">0x11</span>&nbsp;<span class="op" id="6054250">&amp;&amp;</span>&nbsp;<span class="ident" id="6054253">hv</span>&nbsp;<span class="op" id="6054256">!=</span>&nbsp;<span class="num" id="6054259">0x21</span>&nbsp;<span class="op" id="6054264">&amp;&amp;</span>&nbsp;<span class="ident" id="6054267">hv</span>&nbsp;<span class="op" id="6054270">!=</span>&nbsp;<span class="num" id="6054273">0x22</span>&nbsp;<span class="op" id="6054278">&amp;&amp;</span>&nbsp;<span class="ident" id="6054281">hv</span>&nbsp;<span class="op" id="6054284">!=</span>&nbsp;<span class="num" id="6054287">0x12</span>&nbsp;<span class="op" id="6054292">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054298">return</span>&nbsp;<span class="ident" id="6054305">UnsupportedError</span><span class="op" id="6054321">(</span><span class="string" id="6054322">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="6054352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054361">}</span>&nbsp;<span class="keyword" id="6054363">else</span>&nbsp;<span class="keyword" id="6054368">if</span>&nbsp;<span class="ident" id="6054371">hv</span>&nbsp;<span class="op" id="6054374">!=</span>&nbsp;<span class="num" id="6054377">0x11</span>&nbsp;<span class="op" id="6054382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054387">return</span>&nbsp;<span class="ident" id="6054394">UnsupportedError</span><span class="op" id="6054410">(</span><span class="string" id="6054411">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="6054441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054445">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054451">return</span>&nbsp;<span class="ident" id="6054458">nil</span><br>
<span class="lineno"></span><span class="op" id="6054462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6054465">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.1.</span><br>
<span class="lineno">345</span><span class="keyword" id="6054498">func</span>&nbsp;<span class="op" id="6054503">(</span><span class="ident" id="6054504">d</span>&nbsp;<span class="op" id="6054506">*</span><span class="ident" id="6054507">decoder</span><span class="op" id="6054514">)</span>&nbsp;<span class="ident" id="6054516">processDQT</span><span class="op" id="6054526">(</span><span class="ident" id="6054527">n</span>&nbsp;<span class="builtintype" id="6054529">int</span><span class="op" id="6054532">)</span>&nbsp;<span class="builtintype" id="6054534">error</span>&nbsp;<span class="op" id="6054540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054543">const</span>&nbsp;<span class="ident" id="6054549">qtLength</span>&nbsp;<span class="op" id="6054558">=</span>&nbsp;<span class="num" id="6054560">1</span>&nbsp;<span class="op" id="6054562">+</span>&nbsp;<span class="ident" id="6054564">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054575">for</span>&nbsp;<span class="op" id="6054579">;</span>&nbsp;<span class="ident" id="6054581">n</span>&nbsp;<span class="op" id="6054583">&gt;=</span>&nbsp;<span class="ident" id="6054586">qtLength</span><span class="op" id="6054594">;</span>&nbsp;<span class="ident" id="6054596">n</span>&nbsp;<span class="op" id="6054598">-=</span>&nbsp;<span class="ident" id="6054601">qtLength</span>&nbsp;<span class="op" id="6054610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054614">if</span>&nbsp;<span class="ident" id="6054617">err</span>&nbsp;<span class="op" id="6054621">:=</span>&nbsp;<span class="ident" id="6054624">d</span><span class="op" id="6054625">.</span><span class="ident" id="6054626">readFull</span><span class="op" id="6054634">(</span><span class="ident" id="6054635">d</span><span class="op" id="6054636">.</span><span class="ident" id="6054637">tmp</span><span class="op" id="6054640">[</span><span class="op" id="6054641">:</span><span class="ident" id="6054642">qtLength</span><span class="op" id="6054650">]</span><span class="op" id="6054651">)</span><span class="op" id="6054652">;</span>&nbsp;<span class="ident" id="6054654">err</span>&nbsp;<span class="op" id="6054658">!=</span>&nbsp;<span class="ident" id="6054661">nil</span>&nbsp;<span class="op" id="6054665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054670">return</span>&nbsp;<span class="ident" id="6054677">err</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054687">pq</span>&nbsp;<span class="op" id="6054690">:=</span>&nbsp;<span class="ident" id="6054693">d</span><span class="op" id="6054694">.</span><span class="ident" id="6054695">tmp</span><span class="op" id="6054698">[</span><span class="num" id="6054699">0</span><span class="op" id="6054700">]</span>&nbsp;<span class="op" id="6054702">&gt;&gt;</span>&nbsp;<span class="num" id="6054705">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054709">if</span>&nbsp;<span class="ident" id="6054712">pq</span>&nbsp;<span class="op" id="6054715">!=</span>&nbsp;<span class="num" id="6054718">0</span>&nbsp;<span class="op" id="6054720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054725">return</span>&nbsp;<span class="ident" id="6054732">UnsupportedError</span><span class="op" id="6054748">(</span><span class="string" id="6054749">&#34;bad&nbsp;Pq&nbsp;value&#34;</span><span class="op" id="6054763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054767">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054771">tq</span>&nbsp;<span class="op" id="6054774">:=</span>&nbsp;<span class="ident" id="6054777">d</span><span class="op" id="6054778">.</span><span class="ident" id="6054779">tmp</span><span class="op" id="6054782">[</span><span class="num" id="6054783">0</span><span class="op" id="6054784">]</span>&nbsp;<span class="op" id="6054786">&amp;</span>&nbsp;<span class="num" id="6054788">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054795">if</span>&nbsp;<span class="ident" id="6054798">tq</span>&nbsp;<span class="op" id="6054801">&gt;</span>&nbsp;<span class="ident" id="6054803">maxTq</span>&nbsp;<span class="op" id="6054809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054814">return</span>&nbsp;<span class="ident" id="6054821">FormatError</span><span class="op" id="6054832">(</span><span class="string" id="6054833">&#34;bad&nbsp;Tq&nbsp;value&#34;</span><span class="op" id="6054847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054855">for</span>&nbsp;<span class="ident" id="6054859">i</span>&nbsp;<span class="op" id="6054861">:=</span>&nbsp;<span class="keyword" id="6054864">range</span>&nbsp;<span class="ident" id="6054870">d</span><span class="op" id="6054871">.</span><span class="ident" id="6054872">quant</span><span class="op" id="6054877">[</span><span class="ident" id="6054878">tq</span><span class="op" id="6054880">]</span>&nbsp;<span class="op" id="6054882">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054887">d</span><span class="op" id="6054888">.</span><span class="ident" id="6054889">quant</span><span class="op" id="6054894">[</span><span class="ident" id="6054895">tq</span><span class="op" id="6054897">]</span><span class="op" id="6054898">[</span><span class="ident" id="6054899">i</span><span class="op" id="6054900">]</span>&nbsp;<span class="op" id="6054902">=</span>&nbsp;<span class="builtintype" id="6054904">int32</span><span class="op" id="6054909">(</span><span class="ident" id="6054910">d</span><span class="op" id="6054911">.</span><span class="ident" id="6054912">tmp</span><span class="op" id="6054915">[</span><span class="ident" id="6054916">i</span><span class="op" id="6054917">+</span><span class="num" id="6054918">1</span><span class="op" id="6054919">]</span><span class="op" id="6054920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054930">if</span>&nbsp;<span class="ident" id="6054933">n</span>&nbsp;<span class="op" id="6054935">!=</span>&nbsp;<span class="num" id="6054938">0</span>&nbsp;<span class="op" id="6054940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054944">return</span>&nbsp;<span class="ident" id="6054951">FormatError</span><span class="op" id="6054962">(</span><span class="string" id="6054963">&#34;DQT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6054985">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054991">return</span>&nbsp;<span class="ident" id="6054998">nil</span><br>
<span class="lineno"></span><span class="op" id="6055002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6055005">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.4.</span><br>
<span class="lineno">370</span><span class="keyword" id="6055038">func</span>&nbsp;<span class="op" id="6055043">(</span><span class="ident" id="6055044">d</span>&nbsp;<span class="op" id="6055046">*</span><span class="ident" id="6055047">decoder</span><span class="op" id="6055054">)</span>&nbsp;<span class="ident" id="6055056">processDRI</span><span class="op" id="6055066">(</span><span class="ident" id="6055067">n</span>&nbsp;<span class="builtintype" id="6055069">int</span><span class="op" id="6055072">)</span>&nbsp;<span class="builtintype" id="6055074">error</span>&nbsp;<span class="op" id="6055080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055083">if</span>&nbsp;<span class="ident" id="6055086">n</span>&nbsp;<span class="op" id="6055088">!=</span>&nbsp;<span class="num" id="6055091">2</span>&nbsp;<span class="op" id="6055093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055097">return</span>&nbsp;<span class="ident" id="6055104">FormatError</span><span class="op" id="6055115">(</span><span class="string" id="6055116">&#34;DRI&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6055138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055144">if</span>&nbsp;<span class="ident" id="6055147">err</span>&nbsp;<span class="op" id="6055151">:=</span>&nbsp;<span class="ident" id="6055154">d</span><span class="op" id="6055155">.</span><span class="ident" id="6055156">readFull</span><span class="op" id="6055164">(</span><span class="ident" id="6055165">d</span><span class="op" id="6055166">.</span><span class="ident" id="6055167">tmp</span><span class="op" id="6055170">[</span><span class="op" id="6055171">:</span><span class="num" id="6055172">2</span><span class="op" id="6055173">]</span><span class="op" id="6055174">)</span><span class="op" id="6055175">;</span>&nbsp;<span class="ident" id="6055177">err</span>&nbsp;<span class="op" id="6055181">!=</span>&nbsp;<span class="ident" id="6055184">nil</span>&nbsp;<span class="op" id="6055188">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055192">return</span>&nbsp;<span class="ident" id="6055199">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055207">d</span><span class="op" id="6055208">.</span><span class="ident" id="6055209">ri</span>&nbsp;<span class="op" id="6055212">=</span>&nbsp;<span class="builtintype" id="6055214">int</span><span class="op" id="6055217">(</span><span class="ident" id="6055218">d</span><span class="op" id="6055219">.</span><span class="ident" id="6055220">tmp</span><span class="op" id="6055223">[</span><span class="num" id="6055224">0</span><span class="op" id="6055225">]</span><span class="op" id="6055226">)</span><span class="op" id="6055227">&lt;&lt;</span><span class="num" id="6055229">8</span>&nbsp;<span class="op" id="6055231">+</span>&nbsp;<span class="builtintype" id="6055233">int</span><span class="op" id="6055236">(</span><span class="ident" id="6055237">d</span><span class="op" id="6055238">.</span><span class="ident" id="6055239">tmp</span><span class="op" id="6055242">[</span><span class="num" id="6055243">1</span><span class="op" id="6055244">]</span><span class="op" id="6055245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055248">return</span>&nbsp;<span class="ident" id="6055255">nil</span><br>
<span class="lineno"></span><span class="op" id="6055259">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6055262">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6055332">func</span>&nbsp;<span class="op" id="6055337">(</span><span class="ident" id="6055338">d</span>&nbsp;<span class="op" id="6055340">*</span><span class="ident" id="6055341">decoder</span><span class="op" id="6055348">)</span>&nbsp;<span class="ident" id="6055350">decode</span><span class="op" id="6055356">(</span><span class="ident" id="6055357">r</span>&nbsp;<span class="ident" id="6055359">io</span><span class="op" id="6055361">.</span><span class="ident" id="6055362">Reader</span><span class="op" id="6055368">,</span>&nbsp;<span class="ident" id="6055370">configOnly</span>&nbsp;<span class="builtintype" id="6055381">bool</span><span class="op" id="6055385">)</span>&nbsp;<span class="op" id="6055387">(</span><span class="ident" id="6055388">image</span><span class="op" id="6055393">.</span><span class="ident" id="6055394">Image</span><span class="op" id="6055399">,</span>&nbsp;<span class="builtintype" id="6055401">error</span><span class="op" id="6055406">)</span>&nbsp;<span class="op" id="6055408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055411">d</span><span class="op" id="6055412">.</span><span class="ident" id="6055413">r</span>&nbsp;<span class="op" id="6055415">=</span>&nbsp;<span class="ident" id="6055417">r</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055421">//&nbsp;Check&nbsp;for&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055462">if</span>&nbsp;<span class="ident" id="6055465">err</span>&nbsp;<span class="op" id="6055469">:=</span>&nbsp;<span class="ident" id="6055472">d</span><span class="op" id="6055473">.</span><span class="ident" id="6055474">readFull</span><span class="op" id="6055482">(</span><span class="ident" id="6055483">d</span><span class="op" id="6055484">.</span><span class="ident" id="6055485">tmp</span><span class="op" id="6055488">[</span><span class="op" id="6055489">:</span><span class="num" id="6055490">2</span><span class="op" id="6055491">]</span><span class="op" id="6055492">)</span><span class="op" id="6055493">;</span>&nbsp;<span class="ident" id="6055495">err</span>&nbsp;<span class="op" id="6055499">!=</span>&nbsp;<span class="ident" id="6055502">nil</span>&nbsp;<span class="op" id="6055506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055510">return</span>&nbsp;<span class="ident" id="6055517">nil</span><span class="op" id="6055520">,</span>&nbsp;<span class="ident" id="6055522">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055530">if</span>&nbsp;<span class="ident" id="6055533">d</span><span class="op" id="6055534">.</span><span class="ident" id="6055535">tmp</span><span class="op" id="6055538">[</span><span class="num" id="6055539">0</span><span class="op" id="6055540">]</span>&nbsp;<span class="op" id="6055542">!=</span>&nbsp;<span class="num" id="6055545">0xff</span>&nbsp;<span class="op" id="6055550">||</span>&nbsp;<span class="ident" id="6055553">d</span><span class="op" id="6055554">.</span><span class="ident" id="6055555">tmp</span><span class="op" id="6055558">[</span><span class="num" id="6055559">1</span><span class="op" id="6055560">]</span>&nbsp;<span class="op" id="6055562">!=</span>&nbsp;<span class="ident" id="6055565">soiMarker</span>&nbsp;<span class="op" id="6055575">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055579">return</span>&nbsp;<span class="ident" id="6055586">nil</span><span class="op" id="6055589">,</span>&nbsp;<span class="ident" id="6055591">FormatError</span><span class="op" id="6055602">(</span><span class="string" id="6055603">&#34;missing&nbsp;SOI&nbsp;marker&#34;</span><span class="op" id="6055623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055630">//&nbsp;Process&nbsp;the&nbsp;remaining&nbsp;segments&nbsp;until&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055696">for</span>&nbsp;<span class="op" id="6055700">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055704">err</span>&nbsp;<span class="op" id="6055708">:=</span>&nbsp;<span class="ident" id="6055711">d</span><span class="op" id="6055712">.</span><span class="ident" id="6055713">readFull</span><span class="op" id="6055721">(</span><span class="ident" id="6055722">d</span><span class="op" id="6055723">.</span><span class="ident" id="6055724">tmp</span><span class="op" id="6055727">[</span><span class="op" id="6055728">:</span><span class="num" id="6055729">2</span><span class="op" id="6055730">]</span><span class="op" id="6055731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055735">if</span>&nbsp;<span class="ident" id="6055738">err</span>&nbsp;<span class="op" id="6055742">!=</span>&nbsp;<span class="ident" id="6055745">nil</span>&nbsp;<span class="op" id="6055749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055754">return</span>&nbsp;<span class="ident" id="6055761">nil</span><span class="op" id="6055764">,</span>&nbsp;<span class="ident" id="6055766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055776">for</span>&nbsp;<span class="ident" id="6055780">d</span><span class="op" id="6055781">.</span><span class="ident" id="6055782">tmp</span><span class="op" id="6055785">[</span><span class="num" id="6055786">0</span><span class="op" id="6055787">]</span>&nbsp;<span class="op" id="6055789">!=</span>&nbsp;<span class="num" id="6055792">0xff</span>&nbsp;<span class="op" id="6055797">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055802">//&nbsp;Strictly&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;format&nbsp;error.&nbsp;However,&nbsp;libjpeg&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055871">//&nbsp;liberal&nbsp;in&nbsp;what&nbsp;it&nbsp;accepts.&nbsp;As&nbsp;of&nbsp;version&nbsp;9,&nbsp;next_marker&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055937">//&nbsp;jdmarker.c&nbsp;treats&nbsp;this&nbsp;as&nbsp;a&nbsp;warning&nbsp;(JWRN_EXTRANEOUS_DATA)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056006">//&nbsp;continues&nbsp;to&nbsp;decode&nbsp;the&nbsp;stream.&nbsp;Even&nbsp;before&nbsp;next_marker&nbsp;sees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056073">//&nbsp;extraneous&nbsp;data,&nbsp;jpeg_fill_bit_buffer&nbsp;in&nbsp;jdhuff.c&nbsp;reads&nbsp;as&nbsp;many</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056143">//&nbsp;bytes&nbsp;as&nbsp;it&nbsp;can,&nbsp;possibly&nbsp;past&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;scan&#39;s&nbsp;data.&nbsp;It</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056209">//&nbsp;effectively&nbsp;puts&nbsp;back&nbsp;any&nbsp;markers&nbsp;that&nbsp;it&nbsp;overscanned&nbsp;(e.g.&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056278">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker),&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;put&nbsp;back&nbsp;non-marker&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056350">//&nbsp;and&nbsp;thus&nbsp;it&nbsp;can&nbsp;silently&nbsp;ignore&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;extraneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056417">//&nbsp;non-marker&nbsp;bytes&nbsp;before&nbsp;next_marker&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;see&nbsp;them&nbsp;(and</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056489">//&nbsp;print&nbsp;a&nbsp;warning).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056513">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056519">//&nbsp;We&nbsp;are&nbsp;therefore&nbsp;also&nbsp;liberal&nbsp;in&nbsp;what&nbsp;we&nbsp;accept.&nbsp;Extraneous&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056590">//&nbsp;is&nbsp;silently&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056617">//</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056623">//&nbsp;This&nbsp;is&nbsp;similar&nbsp;to,&nbsp;but&nbsp;not&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as,&nbsp;the&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056690">//&nbsp;mechanism&nbsp;within&nbsp;a&nbsp;scan&nbsp;(the&nbsp;RST[0-7]&nbsp;markers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056744">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056750">//&nbsp;Note&nbsp;that&nbsp;extraneous&nbsp;0xff&nbsp;bytes&nbsp;in&nbsp;e.g.&nbsp;SOS&nbsp;data&nbsp;are&nbsp;escaped&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6056820">//&nbsp;&#34;\xff\x00&#34;,&nbsp;and&nbsp;so&nbsp;are&nbsp;detected&nbsp;a&nbsp;little&nbsp;further&nbsp;down&nbsp;below.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056887">d</span><span class="op" id="6056888">.</span><span class="ident" id="6056889">tmp</span><span class="op" id="6056892">[</span><span class="num" id="6056893">0</span><span class="op" id="6056894">]</span>&nbsp;<span class="op" id="6056896">=</span>&nbsp;<span class="ident" id="6056898">d</span><span class="op" id="6056899">.</span><span class="ident" id="6056900">tmp</span><span class="op" id="6056903">[</span><span class="num" id="6056904">1</span><span class="op" id="6056905">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056910">d</span><span class="op" id="6056911">.</span><span class="ident" id="6056912">tmp</span><span class="op" id="6056915">[</span><span class="num" id="6056916">1</span><span class="op" id="6056917">]</span><span class="op" id="6056918">,</span>&nbsp;<span class="ident" id="6056920">err</span>&nbsp;<span class="op" id="6056924">=</span>&nbsp;<span class="ident" id="6056926">d</span><span class="op" id="6056927">.</span><span class="ident" id="6056928">readByte</span><span class="op" id="6056936">(</span><span class="op" id="6056937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056942">if</span>&nbsp;<span class="ident" id="6056945">err</span>&nbsp;<span class="op" id="6056949">!=</span>&nbsp;<span class="ident" id="6056952">nil</span>&nbsp;<span class="op" id="6056956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056962">return</span>&nbsp;<span class="ident" id="6056969">nil</span><span class="op" id="6056972">,</span>&nbsp;<span class="ident" id="6056974">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056981">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056989">marker</span>&nbsp;<span class="op" id="6056996">:=</span>&nbsp;<span class="ident" id="6056999">d</span><span class="op" id="6057000">.</span><span class="ident" id="6057001">tmp</span><span class="op" id="6057004">[</span><span class="num" id="6057005">1</span><span class="op" id="6057006">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057010">if</span>&nbsp;<span class="ident" id="6057013">marker</span>&nbsp;<span class="op" id="6057020">==</span>&nbsp;<span class="num" id="6057023">0</span>&nbsp;<span class="op" id="6057025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057030">//&nbsp;Treat&nbsp;&#34;\xff\x00&#34;&nbsp;as&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057073">continue</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057088">for</span>&nbsp;<span class="ident" id="6057092">marker</span>&nbsp;<span class="op" id="6057099">==</span>&nbsp;<span class="num" id="6057102">0xff</span>&nbsp;<span class="op" id="6057107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057112">//&nbsp;Section&nbsp;B.1.1.2&nbsp;says,&nbsp;&#34;Any&nbsp;marker&nbsp;may&nbsp;optionally&nbsp;be&nbsp;preceded&nbsp;by&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057186">//&nbsp;number&nbsp;of&nbsp;fill&nbsp;bytes,&nbsp;which&nbsp;are&nbsp;bytes&nbsp;assigned&nbsp;code&nbsp;X&#39;FF&#39;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057252">marker</span><span class="op" id="6057258">,</span>&nbsp;<span class="ident" id="6057260">err</span>&nbsp;<span class="op" id="6057264">=</span>&nbsp;<span class="ident" id="6057266">d</span><span class="op" id="6057267">.</span><span class="ident" id="6057268">readByte</span><span class="op" id="6057276">(</span><span class="op" id="6057277">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057282">if</span>&nbsp;<span class="ident" id="6057285">err</span>&nbsp;<span class="op" id="6057289">!=</span>&nbsp;<span class="ident" id="6057292">nil</span>&nbsp;<span class="op" id="6057296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057302">return</span>&nbsp;<span class="ident" id="6057309">nil</span><span class="op" id="6057312">,</span>&nbsp;<span class="ident" id="6057314">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057329">if</span>&nbsp;<span class="ident" id="6057332">marker</span>&nbsp;<span class="op" id="6057339">==</span>&nbsp;<span class="ident" id="6057342">eoiMarker</span>&nbsp;<span class="op" id="6057352">{</span>&nbsp;<span class="comment" id="6057354">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057374">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057386">if</span>&nbsp;<span class="ident" id="6057389">rst0Marker</span>&nbsp;<span class="op" id="6057400">&lt;=</span>&nbsp;<span class="ident" id="6057403">marker</span>&nbsp;<span class="op" id="6057410">&amp;&amp;</span>&nbsp;<span class="ident" id="6057413">marker</span>&nbsp;<span class="op" id="6057420">&lt;=</span>&nbsp;<span class="ident" id="6057423">rst7Marker</span>&nbsp;<span class="op" id="6057434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057439">//&nbsp;Figures&nbsp;B.2&nbsp;and&nbsp;B.16&nbsp;of&nbsp;the&nbsp;specification&nbsp;suggest&nbsp;that&nbsp;restart&nbsp;markers&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057523">//&nbsp;only&nbsp;occur&nbsp;between&nbsp;Entropy&nbsp;Coded&nbsp;Segments&nbsp;and&nbsp;not&nbsp;after&nbsp;the&nbsp;final&nbsp;ECS.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057600">//&nbsp;However,&nbsp;some&nbsp;encoders&nbsp;may&nbsp;generate&nbsp;incorrect&nbsp;JPEGs&nbsp;with&nbsp;a&nbsp;final&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057679">//&nbsp;marker.&nbsp;That&nbsp;restart&nbsp;marker&nbsp;will&nbsp;be&nbsp;seen&nbsp;here&nbsp;instead&nbsp;of&nbsp;inside&nbsp;the&nbsp;processSOS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057764">//&nbsp;method,&nbsp;and&nbsp;is&nbsp;ignored&nbsp;as&nbsp;a&nbsp;harmless&nbsp;error.&nbsp;Restart&nbsp;markers&nbsp;have&nbsp;no&nbsp;extra&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057850">//&nbsp;so&nbsp;we&nbsp;check&nbsp;for&nbsp;this&nbsp;before&nbsp;we&nbsp;read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057926">continue</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6057942">//&nbsp;Read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.&nbsp;The&nbsp;value&nbsp;includes&nbsp;the&nbsp;2&nbsp;bytes&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058025">//&nbsp;length&nbsp;itself,&nbsp;so&nbsp;we&nbsp;subtract&nbsp;2&nbsp;to&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;remaining&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058100">if</span>&nbsp;<span class="ident" id="6058103">err</span>&nbsp;<span class="op" id="6058107">=</span>&nbsp;<span class="ident" id="6058109">d</span><span class="op" id="6058110">.</span><span class="ident" id="6058111">readFull</span><span class="op" id="6058119">(</span><span class="ident" id="6058120">d</span><span class="op" id="6058121">.</span><span class="ident" id="6058122">tmp</span><span class="op" id="6058125">[</span><span class="op" id="6058126">:</span><span class="num" id="6058127">2</span><span class="op" id="6058128">]</span><span class="op" id="6058129">)</span><span class="op" id="6058130">;</span>&nbsp;<span class="ident" id="6058132">err</span>&nbsp;<span class="op" id="6058136">!=</span>&nbsp;<span class="ident" id="6058139">nil</span>&nbsp;<span class="op" id="6058143">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058148">return</span>&nbsp;<span class="ident" id="6058155">nil</span><span class="op" id="6058158">,</span>&nbsp;<span class="ident" id="6058160">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058170">n</span>&nbsp;<span class="op" id="6058172">:=</span>&nbsp;<span class="builtintype" id="6058175">int</span><span class="op" id="6058178">(</span><span class="ident" id="6058179">d</span><span class="op" id="6058180">.</span><span class="ident" id="6058181">tmp</span><span class="op" id="6058184">[</span><span class="num" id="6058185">0</span><span class="op" id="6058186">]</span><span class="op" id="6058187">)</span><span class="op" id="6058188">&lt;&lt;</span><span class="num" id="6058190">8</span>&nbsp;<span class="op" id="6058192">+</span>&nbsp;<span class="builtintype" id="6058194">int</span><span class="op" id="6058197">(</span><span class="ident" id="6058198">d</span><span class="op" id="6058199">.</span><span class="ident" id="6058200">tmp</span><span class="op" id="6058203">[</span><span class="num" id="6058204">1</span><span class="op" id="6058205">]</span><span class="op" id="6058206">)</span>&nbsp;<span class="op" id="6058208">-</span>&nbsp;<span class="num" id="6058210">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058214">if</span>&nbsp;<span class="ident" id="6058217">n</span>&nbsp;<span class="op" id="6058219">&lt;</span>&nbsp;<span class="num" id="6058221">0</span>&nbsp;<span class="op" id="6058223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058228">return</span>&nbsp;<span class="ident" id="6058235">nil</span><span class="op" id="6058238">,</span>&nbsp;<span class="ident" id="6058240">FormatError</span><span class="op" id="6058251">(</span><span class="string" id="6058252">&#34;short&nbsp;segment&nbsp;length&#34;</span><span class="op" id="6058274">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058283">switch</span>&nbsp;<span class="op" id="6058290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058294">case</span>&nbsp;<span class="ident" id="6058299">marker</span>&nbsp;<span class="op" id="6058306">==</span>&nbsp;<span class="ident" id="6058309">sof0Marker</span>&nbsp;<span class="op" id="6058320">||</span>&nbsp;<span class="ident" id="6058323">marker</span>&nbsp;<span class="op" id="6058330">==</span>&nbsp;<span class="ident" id="6058333">sof2Marker</span><span class="op" id="6058343">:</span>&nbsp;<span class="comment" id="6058345">//&nbsp;Start&nbsp;Of&nbsp;Frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058367">d</span><span class="op" id="6058368">.</span><span class="ident" id="6058369">progressive</span>&nbsp;<span class="op" id="6058381">=</span>&nbsp;<span class="ident" id="6058383">marker</span>&nbsp;<span class="op" id="6058390">==</span>&nbsp;<span class="ident" id="6058393">sof2Marker</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058407">err</span>&nbsp;<span class="op" id="6058411">=</span>&nbsp;<span class="ident" id="6058413">d</span><span class="op" id="6058414">.</span><span class="ident" id="6058415">processSOF</span><span class="op" id="6058425">(</span><span class="ident" id="6058426">n</span><span class="op" id="6058427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058432">if</span>&nbsp;<span class="ident" id="6058435">configOnly</span>&nbsp;<span class="op" id="6058446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058452">return</span>&nbsp;<span class="ident" id="6058459">nil</span><span class="op" id="6058462">,</span>&nbsp;<span class="ident" id="6058464">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058475">case</span>&nbsp;<span class="ident" id="6058480">marker</span>&nbsp;<span class="op" id="6058487">==</span>&nbsp;<span class="ident" id="6058490">dhtMarker</span><span class="op" id="6058499">:</span>&nbsp;<span class="comment" id="6058501">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058529">err</span>&nbsp;<span class="op" id="6058533">=</span>&nbsp;<span class="ident" id="6058535">d</span><span class="op" id="6058536">.</span><span class="ident" id="6058537">processDHT</span><span class="op" id="6058547">(</span><span class="ident" id="6058548">n</span><span class="op" id="6058549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058553">case</span>&nbsp;<span class="ident" id="6058558">marker</span>&nbsp;<span class="op" id="6058565">==</span>&nbsp;<span class="ident" id="6058568">dqtMarker</span><span class="op" id="6058577">:</span>&nbsp;<span class="comment" id="6058579">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058612">err</span>&nbsp;<span class="op" id="6058616">=</span>&nbsp;<span class="ident" id="6058618">d</span><span class="op" id="6058619">.</span><span class="ident" id="6058620">processDQT</span><span class="op" id="6058630">(</span><span class="ident" id="6058631">n</span><span class="op" id="6058632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058636">case</span>&nbsp;<span class="ident" id="6058641">marker</span>&nbsp;<span class="op" id="6058648">==</span>&nbsp;<span class="ident" id="6058651">sosMarker</span><span class="op" id="6058660">:</span>&nbsp;<span class="comment" id="6058662">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058683">err</span>&nbsp;<span class="op" id="6058687">=</span>&nbsp;<span class="ident" id="6058689">d</span><span class="op" id="6058690">.</span><span class="ident" id="6058691">processSOS</span><span class="op" id="6058701">(</span><span class="ident" id="6058702">n</span><span class="op" id="6058703">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058707">case</span>&nbsp;<span class="ident" id="6058712">marker</span>&nbsp;<span class="op" id="6058719">==</span>&nbsp;<span class="ident" id="6058722">driMarker</span><span class="op" id="6058731">:</span>&nbsp;<span class="comment" id="6058733">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058764">err</span>&nbsp;<span class="op" id="6058768">=</span>&nbsp;<span class="ident" id="6058770">d</span><span class="op" id="6058771">.</span><span class="ident" id="6058772">processDRI</span><span class="op" id="6058782">(</span><span class="ident" id="6058783">n</span><span class="op" id="6058784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058788">case</span>&nbsp;<span class="ident" id="6058793">app0Marker</span>&nbsp;<span class="op" id="6058804">&lt;=</span>&nbsp;<span class="ident" id="6058807">marker</span>&nbsp;<span class="op" id="6058814">&amp;&amp;</span>&nbsp;<span class="ident" id="6058817">marker</span>&nbsp;<span class="op" id="6058824">&lt;=</span>&nbsp;<span class="ident" id="6058827">app15Marker</span>&nbsp;<span class="op" id="6058839">||</span>&nbsp;<span class="ident" id="6058842">marker</span>&nbsp;<span class="op" id="6058849">==</span>&nbsp;<span class="ident" id="6058852">comMarker</span><span class="op" id="6058861">:</span>&nbsp;<span class="comment" id="6058863">//&nbsp;APPlication&nbsp;specific,&nbsp;or&nbsp;COMment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058903">err</span>&nbsp;<span class="op" id="6058907">=</span>&nbsp;<span class="ident" id="6058909">d</span><span class="op" id="6058910">.</span><span class="ident" id="6058911">ignore</span><span class="op" id="6058917">(</span><span class="ident" id="6058918">n</span><span class="op" id="6058919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058923">default</span><span class="op" id="6058930">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058935">err</span>&nbsp;<span class="op" id="6058939">=</span>&nbsp;<span class="ident" id="6058941">UnsupportedError</span><span class="op" id="6058957">(</span><span class="string" id="6058958">&#34;unknown&nbsp;marker&#34;</span><span class="op" id="6058974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058982">if</span>&nbsp;<span class="ident" id="6058985">err</span>&nbsp;<span class="op" id="6058989">!=</span>&nbsp;<span class="ident" id="6058992">nil</span>&nbsp;<span class="op" id="6058996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059001">return</span>&nbsp;<span class="ident" id="6059008">nil</span><span class="op" id="6059011">,</span>&nbsp;<span class="ident" id="6059013">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059019">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059025">if</span>&nbsp;<span class="ident" id="6059028">d</span><span class="op" id="6059029">.</span><span class="ident" id="6059030">img1</span>&nbsp;<span class="op" id="6059035">!=</span>&nbsp;<span class="ident" id="6059038">nil</span>&nbsp;<span class="op" id="6059042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059046">return</span>&nbsp;<span class="ident" id="6059053">d</span><span class="op" id="6059054">.</span><span class="ident" id="6059055">img1</span><span class="op" id="6059059">,</span>&nbsp;<span class="ident" id="6059061">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059069">if</span>&nbsp;<span class="ident" id="6059072">d</span><span class="op" id="6059073">.</span><span class="ident" id="6059074">img3</span>&nbsp;<span class="op" id="6059079">!=</span>&nbsp;<span class="ident" id="6059082">nil</span>&nbsp;<span class="op" id="6059086">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059090">return</span>&nbsp;<span class="ident" id="6059097">d</span><span class="op" id="6059098">.</span><span class="ident" id="6059099">img3</span><span class="op" id="6059103">,</span>&nbsp;<span class="ident" id="6059105">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059113">return</span>&nbsp;<span class="ident" id="6059120">nil</span><span class="op" id="6059123">,</span>&nbsp;<span class="ident" id="6059125">FormatError</span><span class="op" id="6059136">(</span><span class="string" id="6059137">&#34;missing&nbsp;SOS&nbsp;marker&#34;</span><span class="op" id="6059157">)</span><br>
<span class="lineno"></span><span class="op" id="6059159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="6059162">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6059232">func</span>&nbsp;<span class="ident" id="6059237">Decode</span><span class="op" id="6059243">(</span><span class="ident" id="6059244">r</span>&nbsp;<span class="ident" id="6059246">io</span><span class="op" id="6059248">.</span><span class="ident" id="6059249">Reader</span><span class="op" id="6059255">)</span>&nbsp;<span class="op" id="6059257">(</span><span class="ident" id="6059258">image</span><span class="op" id="6059263">.</span><span class="ident" id="6059264">Image</span><span class="op" id="6059269">,</span>&nbsp;<span class="builtintype" id="6059271">error</span><span class="op" id="6059276">)</span>&nbsp;<span class="op" id="6059278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059281">var</span>&nbsp;<span class="ident" id="6059285">d</span>&nbsp;<span class="ident" id="6059287">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059296">return</span>&nbsp;<span class="ident" id="6059303">d</span><span class="op" id="6059304">.</span><span class="ident" id="6059305">decode</span><span class="op" id="6059311">(</span><span class="ident" id="6059312">r</span><span class="op" id="6059313">,</span>&nbsp;<span class="builtintype" id="6059315">false</span><span class="op" id="6059320">)</span><br>
<span class="lineno"></span><span class="op" id="6059322">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment" id="6059325">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="6059404">//&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6059434">func</span>&nbsp;<span class="ident" id="6059439">DecodeConfig</span><span class="op" id="6059451">(</span><span class="ident" id="6059452">r</span>&nbsp;<span class="ident" id="6059454">io</span><span class="op" id="6059456">.</span><span class="ident" id="6059457">Reader</span><span class="op" id="6059463">)</span>&nbsp;<span class="op" id="6059465">(</span><span class="ident" id="6059466">image</span><span class="op" id="6059471">.</span><span class="ident" id="6059472">Config</span><span class="op" id="6059478">,</span>&nbsp;<span class="builtintype" id="6059480">error</span><span class="op" id="6059485">)</span>&nbsp;<span class="op" id="6059487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059490">var</span>&nbsp;<span class="ident" id="6059494">d</span>&nbsp;<span class="ident" id="6059496">decoder</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059505">if</span>&nbsp;<span class="ident" id="6059508">_</span><span class="op" id="6059509">,</span>&nbsp;<span class="ident" id="6059511">err</span>&nbsp;<span class="op" id="6059515">:=</span>&nbsp;<span class="ident" id="6059518">d</span><span class="op" id="6059519">.</span><span class="ident" id="6059520">decode</span><span class="op" id="6059526">(</span><span class="ident" id="6059527">r</span><span class="op" id="6059528">,</span>&nbsp;<span class="builtintype" id="6059530">true</span><span class="op" id="6059534">)</span><span class="op" id="6059535">;</span>&nbsp;<span class="ident" id="6059537">err</span>&nbsp;<span class="op" id="6059541">!=</span>&nbsp;<span class="ident" id="6059544">nil</span>&nbsp;<span class="op" id="6059548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059552">return</span>&nbsp;<span class="ident" id="6059559">image</span><span class="op" id="6059564">.</span><span class="ident" id="6059565">Config</span><span class="op" id="6059571">{</span><span class="op" id="6059572">}</span><span class="op" id="6059573">,</span>&nbsp;<span class="ident" id="6059575">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059583">switch</span>&nbsp;<span class="ident" id="6059590">d</span><span class="op" id="6059591">.</span><span class="ident" id="6059592">nComp</span>&nbsp;<span class="op" id="6059598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059601">case</span>&nbsp;<span class="ident" id="6059606">nGrayComponent</span><span class="op" id="6059620">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059624">return</span>&nbsp;<span class="ident" id="6059631">image</span><span class="op" id="6059636">.</span><span class="ident" id="6059637">Config</span><span class="op" id="6059643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059648">ColorModel</span><span class="op" id="6059658">:</span>&nbsp;<span class="ident" id="6059660">color</span><span class="op" id="6059665">.</span><span class="ident" id="6059666">GrayModel</span><span class="op" id="6059675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059680">Width</span><span class="op" id="6059685">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059692">d</span><span class="op" id="6059693">.</span><span class="ident" id="6059694">width</span><span class="op" id="6059699">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059704">Height</span><span class="op" id="6059710">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059716">d</span><span class="op" id="6059717">.</span><span class="ident" id="6059718">height</span><span class="op" id="6059724">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059728">}</span><span class="op" id="6059729">,</span>&nbsp;<span class="ident" id="6059731">nil</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059736">case</span>&nbsp;<span class="ident" id="6059741">nColorComponent</span><span class="op" id="6059756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059760">return</span>&nbsp;<span class="ident" id="6059767">image</span><span class="op" id="6059772">.</span><span class="ident" id="6059773">Config</span><span class="op" id="6059779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059784">ColorModel</span><span class="op" id="6059794">:</span>&nbsp;<span class="ident" id="6059796">color</span><span class="op" id="6059801">.</span><span class="ident" id="6059802">YCbCrModel</span><span class="op" id="6059812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059817">Width</span><span class="op" id="6059822">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059829">d</span><span class="op" id="6059830">.</span><span class="ident" id="6059831">width</span><span class="op" id="6059836">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059841">Height</span><span class="op" id="6059847">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059853">d</span><span class="op" id="6059854">.</span><span class="ident" id="6059855">height</span><span class="op" id="6059861">,</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059865">}</span><span class="op" id="6059866">,</span>&nbsp;<span class="ident" id="6059868">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059876">return</span>&nbsp;<span class="ident" id="6059883">image</span><span class="op" id="6059888">.</span><span class="ident" id="6059889">Config</span><span class="op" id="6059895">{</span><span class="op" id="6059896">}</span><span class="op" id="6059897">,</span>&nbsp;<span class="ident" id="6059899">FormatError</span><span class="op" id="6059910">(</span><span class="string" id="6059911">&#34;missing&nbsp;SOF&nbsp;marker&#34;</span><span class="op" id="6059931">)</span><br>
<span class="lineno"></span><span class="op" id="6059933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="keyword" id="6059936">func</span>&nbsp;<span class="ident" id="6059941">init</span><span class="op" id="6059945">(</span><span class="op" id="6059946">)</span>&nbsp;<span class="op" id="6059948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6059951">image</span><span class="op" id="6059956">.</span><span class="ident" id="6059957">RegisterFormat</span><span class="op" id="6059971">(</span><span class="string" id="6059972">&#34;jpeg&#34;</span><span class="op" id="6059978">,</span>&nbsp;<span class="string" id="6059980">&#34;\xff\xd8&#34;</span><span class="op" id="6059990">,</span>&nbsp;<span class="ident" id="6059992">Decode</span><span class="op" id="6059998">,</span>&nbsp;<span class="ident" id="6060000">DecodeConfig</span><span class="op" id="6060012">)</span><br>
<span class="lineno"></span><span class="op" id="6060014">}</span>
</div>
</body>
</html>
