<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html" class="current">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1375399">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1375455">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1375509">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1375560">package</span>&nbsp;<span class="ident" id="1375568">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1375574">import</span>&nbsp;<span class="op" id="1375581">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1375584">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1375590">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1375607">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1375615">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1375626">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1375634">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1375641">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="1375644">var</span>&nbsp;<span class="ident" id="1375648">raceEnabled</span>&nbsp;<span class="op" id="1375660">=</span>&nbsp;<span class="builtintype" id="1375662">false</span>&nbsp;<span class="comment" id="1375668">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1375687">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="1375749">type</span>&nbsp;<span class="ident" id="1375754">Header</span>&nbsp;<span class="keyword" id="1375761">map</span><span class="op" id="1375764">[</span><span class="builtintype" id="1375765">string</span><span class="op" id="1375771">]</span><span class="op" id="1375772">[</span><span class="op" id="1375773">]</span><span class="builtintype" id="1375774">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="1375782">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="1375829">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="1375887">func</span>&nbsp;<span class="op" id="1375892">(</span><span class="ident" id="1375893">h</span>&nbsp;<span class="ident" id="1375895">Header</span><span class="op" id="1375901">)</span>&nbsp;<span class="ident" id="1375903">Add</span><span class="op" id="1375906">(</span><span class="ident" id="1375907">key</span><span class="op" id="1375910">,</span>&nbsp;<span class="ident" id="1375912">value</span>&nbsp;<span class="builtintype" id="1375918">string</span><span class="op" id="1375924">)</span>&nbsp;<span class="op" id="1375926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375929">textproto</span><span class="op" id="1375938">.</span><span class="ident" id="1375939">MIMEHeader</span><span class="op" id="1375949">(</span><span class="ident" id="1375950">h</span><span class="op" id="1375951">)</span><span class="op" id="1375952">.</span><span class="ident" id="1375953">Add</span><span class="op" id="1375956">(</span><span class="ident" id="1375957">key</span><span class="op" id="1375960">,</span>&nbsp;<span class="ident" id="1375962">value</span><span class="op" id="1375967">)</span><br>
<span class="lineno">25</span><span class="op" id="1375969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1375972">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1376026">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="1376081">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="1376112">func</span>&nbsp;<span class="op" id="1376117">(</span><span class="ident" id="1376118">h</span>&nbsp;<span class="ident" id="1376120">Header</span><span class="op" id="1376126">)</span>&nbsp;<span class="ident" id="1376128">Set</span><span class="op" id="1376131">(</span><span class="ident" id="1376132">key</span><span class="op" id="1376135">,</span>&nbsp;<span class="ident" id="1376137">value</span>&nbsp;<span class="builtintype" id="1376143">string</span><span class="op" id="1376149">)</span>&nbsp;<span class="op" id="1376151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1376154">textproto</span><span class="op" id="1376163">.</span><span class="ident" id="1376164">MIMEHeader</span><span class="op" id="1376174">(</span><span class="ident" id="1376175">h</span><span class="op" id="1376176">)</span><span class="op" id="1376177">.</span><span class="ident" id="1376178">Set</span><span class="op" id="1376181">(</span><span class="ident" id="1376182">key</span><span class="op" id="1376185">,</span>&nbsp;<span class="ident" id="1376187">value</span><span class="op" id="1376192">)</span><br>
<span class="lineno"></span><span class="op" id="1376194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1376197">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="1376256">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="1376323">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="1376386">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="1376414">func</span>&nbsp;<span class="op" id="1376419">(</span><span class="ident" id="1376420">h</span>&nbsp;<span class="ident" id="1376422">Header</span><span class="op" id="1376428">)</span>&nbsp;<span class="ident" id="1376430">Get</span><span class="op" id="1376433">(</span><span class="ident" id="1376434">key</span>&nbsp;<span class="builtintype" id="1376438">string</span><span class="op" id="1376444">)</span>&nbsp;<span class="builtintype" id="1376446">string</span>&nbsp;<span class="op" id="1376453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1376456">return</span>&nbsp;<span class="ident" id="1376463">textproto</span><span class="op" id="1376472">.</span><span class="ident" id="1376473">MIMEHeader</span><span class="op" id="1376483">(</span><span class="ident" id="1376484">h</span><span class="op" id="1376485">)</span><span class="op" id="1376486">.</span><span class="ident" id="1376487">Get</span><span class="op" id="1376490">(</span><span class="ident" id="1376491">key</span><span class="op" id="1376494">)</span><br>
<span class="lineno">40</span><span class="op" id="1376496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1376499">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="1376571">func</span>&nbsp;<span class="op" id="1376576">(</span><span class="ident" id="1376577">h</span>&nbsp;<span class="ident" id="1376579">Header</span><span class="op" id="1376585">)</span>&nbsp;<span class="ident" id="1376587">get</span><span class="op" id="1376590">(</span><span class="ident" id="1376591">key</span>&nbsp;<span class="builtintype" id="1376595">string</span><span class="op" id="1376601">)</span>&nbsp;<span class="builtintype" id="1376603">string</span>&nbsp;<span class="op" id="1376610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1376613">if</span>&nbsp;<span class="ident" id="1376616">v</span>&nbsp;<span class="op" id="1376618">:=</span>&nbsp;<span class="ident" id="1376621">h</span><span class="op" id="1376622">[</span><span class="ident" id="1376623">key</span><span class="op" id="1376626">]</span><span class="op" id="1376627">;</span>&nbsp;<span class="builtinfunc" id="1376629">len</span><span class="op" id="1376632">(</span><span class="ident" id="1376633">v</span><span class="op" id="1376634">)</span>&nbsp;<span class="op" id="1376636">&gt;</span>&nbsp;<span class="num" id="1376638">0</span>&nbsp;<span class="op" id="1376640">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1376644">return</span>&nbsp;<span class="ident" id="1376651">v</span><span class="op" id="1376652">[</span><span class="num" id="1376653">0</span><span class="op" id="1376654">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1376657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1376660">return</span>&nbsp;<span class="string" id="1376667">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="1376670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1376673">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="1376720">func</span>&nbsp;<span class="op" id="1376725">(</span><span class="ident" id="1376726">h</span>&nbsp;<span class="ident" id="1376728">Header</span><span class="op" id="1376734">)</span>&nbsp;<span class="ident" id="1376736">Del</span><span class="op" id="1376739">(</span><span class="ident" id="1376740">key</span>&nbsp;<span class="builtintype" id="1376744">string</span><span class="op" id="1376750">)</span>&nbsp;<span class="op" id="1376752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1376755">textproto</span><span class="op" id="1376764">.</span><span class="ident" id="1376765">MIMEHeader</span><span class="op" id="1376775">(</span><span class="ident" id="1376776">h</span><span class="op" id="1376777">)</span><span class="op" id="1376778">.</span><span class="ident" id="1376779">Del</span><span class="op" id="1376782">(</span><span class="ident" id="1376783">key</span><span class="op" id="1376786">)</span><br>
<span class="lineno"></span><span class="op" id="1376788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="1376791">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="1376832">func</span>&nbsp;<span class="op" id="1376837">(</span><span class="ident" id="1376838">h</span>&nbsp;<span class="ident" id="1376840">Header</span><span class="op" id="1376846">)</span>&nbsp;<span class="ident" id="1376848">Write</span><span class="op" id="1376853">(</span><span class="ident" id="1376854">w</span>&nbsp;<span class="ident" id="1376856">io</span><span class="op" id="1376858">.</span><span class="ident" id="1376859">Writer</span><span class="op" id="1376865">)</span>&nbsp;<span class="builtintype" id="1376867">error</span>&nbsp;<span class="op" id="1376873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1376876">return</span>&nbsp;<span class="ident" id="1376883">h</span><span class="op" id="1376884">.</span><span class="ident" id="1376885">WriteSubset</span><span class="op" id="1376896">(</span><span class="ident" id="1376897">w</span><span class="op" id="1376898">,</span>&nbsp;<span class="ident" id="1376900">nil</span><span class="op" id="1376903">)</span><br>
<span class="lineno"></span><span class="op" id="1376905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1376908">func</span>&nbsp;<span class="op" id="1376913">(</span><span class="ident" id="1376914">h</span>&nbsp;<span class="ident" id="1376916">Header</span><span class="op" id="1376922">)</span>&nbsp;<span class="ident" id="1376924">clone</span><span class="op" id="1376929">(</span><span class="op" id="1376930">)</span>&nbsp;<span class="ident" id="1376932">Header</span>&nbsp;<span class="op" id="1376939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1376942">h2</span>&nbsp;<span class="op" id="1376945">:=</span>&nbsp;<span class="builtinfunc" id="1376948">make</span><span class="op" id="1376952">(</span><span class="ident" id="1376953">Header</span><span class="op" id="1376959">,</span>&nbsp;<span class="builtinfunc" id="1376961">len</span><span class="op" id="1376964">(</span><span class="ident" id="1376965">h</span><span class="op" id="1376966">)</span><span class="op" id="1376967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1376970">for</span>&nbsp;<span class="ident" id="1376974">k</span><span class="op" id="1376975">,</span>&nbsp;<span class="ident" id="1376977">vv</span>&nbsp;<span class="op" id="1376980">:=</span>&nbsp;<span class="keyword" id="1376983">range</span>&nbsp;<span class="ident" id="1376989">h</span>&nbsp;<span class="op" id="1376991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1376995">vv2</span>&nbsp;<span class="op" id="1376999">:=</span>&nbsp;<span class="builtinfunc" id="1377002">make</span><span class="op" id="1377006">(</span><span class="op" id="1377007">[</span><span class="op" id="1377008">]</span><span class="builtintype" id="1377009">string</span><span class="op" id="1377015">,</span>&nbsp;<span class="builtinfunc" id="1377017">len</span><span class="op" id="1377020">(</span><span class="ident" id="1377021">vv</span><span class="op" id="1377023">)</span><span class="op" id="1377024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1377028">copy</span><span class="op" id="1377032">(</span><span class="ident" id="1377033">vv2</span><span class="op" id="1377036">,</span>&nbsp;<span class="ident" id="1377038">vv</span><span class="op" id="1377040">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377044">h2</span><span class="op" id="1377046">[</span><span class="ident" id="1377047">k</span><span class="op" id="1377048">]</span>&nbsp;<span class="op" id="1377050">=</span>&nbsp;<span class="ident" id="1377052">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1377057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1377060">return</span>&nbsp;<span class="ident" id="1377067">h2</span><br>
<span class="lineno"></span><span class="op" id="1377070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="1377073">var</span>&nbsp;<span class="ident" id="1377077">timeFormats</span>&nbsp;<span class="op" id="1377089">=</span>&nbsp;<span class="op" id="1377091">[</span><span class="op" id="1377092">]</span><span class="builtintype" id="1377093">string</span><span class="op" id="1377099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377102">TimeFormat</span><span class="op" id="1377112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377115">time</span><span class="op" id="1377119">.</span><span class="ident" id="1377120">RFC850</span><span class="op" id="1377126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377129">time</span><span class="op" id="1377133">.</span><span class="ident" id="1377134">ANSIC</span><span class="op" id="1377139">,</span><br>
<span class="lineno"></span><span class="op" id="1377141">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1377144">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="1377206">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="1377263">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="1377307">func</span>&nbsp;<span class="ident" id="1377312">ParseTime</span><span class="op" id="1377321">(</span><span class="ident" id="1377322">text</span>&nbsp;<span class="builtintype" id="1377327">string</span><span class="op" id="1377333">)</span>&nbsp;<span class="op" id="1377335">(</span><span class="ident" id="1377336">t</span>&nbsp;<span class="ident" id="1377338">time</span><span class="op" id="1377342">.</span><span class="ident" id="1377343">Time</span><span class="op" id="1377347">,</span>&nbsp;<span class="ident" id="1377349">err</span>&nbsp;<span class="builtintype" id="1377353">error</span><span class="op" id="1377358">)</span>&nbsp;<span class="op" id="1377360">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1377363">for</span>&nbsp;<span class="ident" id="1377367">_</span><span class="op" id="1377368">,</span>&nbsp;<span class="ident" id="1377370">layout</span>&nbsp;<span class="op" id="1377377">:=</span>&nbsp;<span class="keyword" id="1377380">range</span>&nbsp;<span class="ident" id="1377386">timeFormats</span>&nbsp;<span class="op" id="1377398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377402">t</span><span class="op" id="1377403">,</span>&nbsp;<span class="ident" id="1377405">err</span>&nbsp;<span class="op" id="1377409">=</span>&nbsp;<span class="ident" id="1377411">time</span><span class="op" id="1377415">.</span><span class="ident" id="1377416">Parse</span><span class="op" id="1377421">(</span><span class="ident" id="1377422">layout</span><span class="op" id="1377428">,</span>&nbsp;<span class="ident" id="1377430">text</span><span class="op" id="1377434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1377438">if</span>&nbsp;<span class="ident" id="1377441">err</span>&nbsp;<span class="op" id="1377445">==</span>&nbsp;<span class="ident" id="1377448">nil</span>&nbsp;<span class="op" id="1377452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1377457">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1377466">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1377469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1377472">return</span><br>
<span class="lineno"></span><span class="op" id="1377479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1377482">var</span>&nbsp;<span class="ident" id="1377486">headerNewlineToSpace</span>&nbsp;<span class="op" id="1377507">=</span>&nbsp;<span class="ident" id="1377509">strings</span><span class="op" id="1377516">.</span><span class="ident" id="1377517">NewReplacer</span><span class="op" id="1377528">(</span><span class="string" id="1377529">&#34;\n&#34;</span><span class="op" id="1377533">,</span>&nbsp;<span class="string" id="1377535">&#34;&nbsp;&#34;</span><span class="op" id="1377538">,</span>&nbsp;<span class="string" id="1377540">&#34;\r&#34;</span><span class="op" id="1377544">,</span>&nbsp;<span class="string" id="1377546">&#34;&nbsp;&#34;</span><span class="op" id="1377549">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1377552">type</span>&nbsp;<span class="ident" id="1377557">writeStringer</span>&nbsp;<span class="keyword" id="1377571">interface</span>&nbsp;<span class="op" id="1377581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377584">WriteString</span><span class="op" id="1377595">(</span><span class="builtintype" id="1377596">string</span><span class="op" id="1377602">)</span>&nbsp;<span class="op" id="1377604">(</span><span class="builtintype" id="1377605">int</span><span class="op" id="1377608">,</span>&nbsp;<span class="builtintype" id="1377610">error</span><span class="op" id="1377615">)</span><br>
<span class="lineno"></span><span class="op" id="1377617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="1377620">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="1377672">type</span>&nbsp;<span class="ident" id="1377677">stringWriter</span>&nbsp;<span class="keyword" id="1377690">struct</span>&nbsp;<span class="op" id="1377697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377700">w</span>&nbsp;<span class="ident" id="1377702">io</span><span class="op" id="1377704">.</span><span class="ident" id="1377705">Writer</span><br>
<span class="lineno"></span><span class="op" id="1377712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1377715">func</span>&nbsp;<span class="op" id="1377720">(</span><span class="ident" id="1377721">w</span>&nbsp;<span class="ident" id="1377723">stringWriter</span><span class="op" id="1377735">)</span>&nbsp;<span class="ident" id="1377737">WriteString</span><span class="op" id="1377748">(</span><span class="ident" id="1377749">s</span>&nbsp;<span class="builtintype" id="1377751">string</span><span class="op" id="1377757">)</span>&nbsp;<span class="op" id="1377759">(</span><span class="ident" id="1377760">n</span>&nbsp;<span class="builtintype" id="1377762">int</span><span class="op" id="1377765">,</span>&nbsp;<span class="ident" id="1377767">err</span>&nbsp;<span class="builtintype" id="1377771">error</span><span class="op" id="1377776">)</span>&nbsp;<span class="op" id="1377778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1377781">return</span>&nbsp;<span class="ident" id="1377788">w</span><span class="op" id="1377789">.</span><span class="ident" id="1377790">w</span><span class="op" id="1377791">.</span><span class="ident" id="1377792">Write</span><span class="op" id="1377797">(</span><span class="op" id="1377798">[</span><span class="op" id="1377799">]</span><span class="builtintype" id="1377800">byte</span><span class="op" id="1377804">(</span><span class="ident" id="1377805">s</span><span class="op" id="1377806">)</span><span class="op" id="1377807">)</span><br>
<span class="lineno"></span><span class="op" id="1377809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1377812">type</span>&nbsp;<span class="ident" id="1377817">keyValues</span>&nbsp;<span class="keyword" id="1377827">struct</span>&nbsp;<span class="op" id="1377834">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377837">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1377844">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377852">values</span>&nbsp;<span class="op" id="1377859">[</span><span class="op" id="1377860">]</span><span class="builtintype" id="1377861">string</span><br>
<span class="lineno"></span><span class="op" id="1377868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1377871">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="1377940">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="1378009">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="1378048">type</span>&nbsp;<span class="ident" id="1378053">headerSorter</span>&nbsp;<span class="keyword" id="1378066">struct</span>&nbsp;<span class="op" id="1378073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378076">kvs</span>&nbsp;<span class="op" id="1378080">[</span><span class="op" id="1378081">]</span><span class="ident" id="1378082">keyValues</span><br>
<span class="lineno"></span><span class="op" id="1378092">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="1378095">func</span>&nbsp;<span class="op" id="1378100">(</span><span class="ident" id="1378101">s</span>&nbsp;<span class="op" id="1378103">*</span><span class="ident" id="1378104">headerSorter</span><span class="op" id="1378116">)</span>&nbsp;<span class="ident" id="1378118">Len</span><span class="op" id="1378121">(</span><span class="op" id="1378122">)</span>&nbsp;<span class="builtintype" id="1378124">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1378138">{</span>&nbsp;<span class="keyword" id="1378140">return</span>&nbsp;<span class="builtinfunc" id="1378147">len</span><span class="op" id="1378150">(</span><span class="ident" id="1378151">s</span><span class="op" id="1378152">.</span><span class="ident" id="1378153">kvs</span><span class="op" id="1378156">)</span>&nbsp;<span class="op" id="1378158">}</span><br>
<span class="lineno"></span><span class="keyword" id="1378160">func</span>&nbsp;<span class="op" id="1378165">(</span><span class="ident" id="1378166">s</span>&nbsp;<span class="op" id="1378168">*</span><span class="ident" id="1378169">headerSorter</span><span class="op" id="1378181">)</span>&nbsp;<span class="ident" id="1378183">Swap</span><span class="op" id="1378187">(</span><span class="ident" id="1378188">i</span><span class="op" id="1378189">,</span>&nbsp;<span class="ident" id="1378191">j</span>&nbsp;<span class="builtintype" id="1378193">int</span><span class="op" id="1378196">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1378203">{</span>&nbsp;<span class="ident" id="1378205">s</span><span class="op" id="1378206">.</span><span class="ident" id="1378207">kvs</span><span class="op" id="1378210">[</span><span class="ident" id="1378211">i</span><span class="op" id="1378212">]</span><span class="op" id="1378213">,</span>&nbsp;<span class="ident" id="1378215">s</span><span class="op" id="1378216">.</span><span class="ident" id="1378217">kvs</span><span class="op" id="1378220">[</span><span class="ident" id="1378221">j</span><span class="op" id="1378222">]</span>&nbsp;<span class="op" id="1378224">=</span>&nbsp;<span class="ident" id="1378226">s</span><span class="op" id="1378227">.</span><span class="ident" id="1378228">kvs</span><span class="op" id="1378231">[</span><span class="ident" id="1378232">j</span><span class="op" id="1378233">]</span><span class="op" id="1378234">,</span>&nbsp;<span class="ident" id="1378236">s</span><span class="op" id="1378237">.</span><span class="ident" id="1378238">kvs</span><span class="op" id="1378241">[</span><span class="ident" id="1378242">i</span><span class="op" id="1378243">]</span>&nbsp;<span class="op" id="1378245">}</span><br>
<span class="lineno"></span><span class="keyword" id="1378247">func</span>&nbsp;<span class="op" id="1378252">(</span><span class="ident" id="1378253">s</span>&nbsp;<span class="op" id="1378255">*</span><span class="ident" id="1378256">headerSorter</span><span class="op" id="1378268">)</span>&nbsp;<span class="ident" id="1378270">Less</span><span class="op" id="1378274">(</span><span class="ident" id="1378275">i</span><span class="op" id="1378276">,</span>&nbsp;<span class="ident" id="1378278">j</span>&nbsp;<span class="builtintype" id="1378280">int</span><span class="op" id="1378283">)</span>&nbsp;<span class="builtintype" id="1378285">bool</span>&nbsp;<span class="op" id="1378290">{</span>&nbsp;<span class="keyword" id="1378292">return</span>&nbsp;<span class="ident" id="1378299">s</span><span class="op" id="1378300">.</span><span class="ident" id="1378301">kvs</span><span class="op" id="1378304">[</span><span class="ident" id="1378305">i</span><span class="op" id="1378306">]</span><span class="op" id="1378307">.</span><span class="ident" id="1378308">key</span>&nbsp;<span class="op" id="1378312">&lt;</span>&nbsp;<span class="ident" id="1378314">s</span><span class="op" id="1378315">.</span><span class="ident" id="1378316">kvs</span><span class="op" id="1378319">[</span><span class="ident" id="1378320">j</span><span class="op" id="1378321">]</span><span class="op" id="1378322">.</span><span class="ident" id="1378323">key</span>&nbsp;<span class="op" id="1378327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1378330">var</span>&nbsp;<span class="ident" id="1378334">headerSorterPool</span>&nbsp;<span class="op" id="1378351">=</span>&nbsp;<span class="ident" id="1378353">sync</span><span class="op" id="1378357">.</span><span class="ident" id="1378358">Pool</span><span class="op" id="1378362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378365">New</span><span class="op" id="1378368">:</span>&nbsp;<span class="keyword" id="1378370">func</span><span class="op" id="1378374">(</span><span class="op" id="1378375">)</span>&nbsp;<span class="keyword" id="1378377">interface</span><span class="op" id="1378386">{</span><span class="op" id="1378387">}</span>&nbsp;<span class="op" id="1378389">{</span>&nbsp;<span class="keyword" id="1378391">return</span>&nbsp;<span class="builtinfunc" id="1378398">new</span><span class="op" id="1378401">(</span><span class="ident" id="1378402">headerSorter</span><span class="op" id="1378414">)</span>&nbsp;<span class="op" id="1378416">}</span><span class="op" id="1378417">,</span><br>
<span class="lineno"></span><span class="op" id="1378419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1378422">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="1378485">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="1378556">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="1378588">func</span>&nbsp;<span class="op" id="1378593">(</span><span class="ident" id="1378594">h</span>&nbsp;<span class="ident" id="1378596">Header</span><span class="op" id="1378602">)</span>&nbsp;<span class="ident" id="1378604">sortedKeyValues</span><span class="op" id="1378619">(</span><span class="ident" id="1378620">exclude</span>&nbsp;<span class="keyword" id="1378628">map</span><span class="op" id="1378631">[</span><span class="builtintype" id="1378632">string</span><span class="op" id="1378638">]</span><span class="builtintype" id="1378639">bool</span><span class="op" id="1378643">)</span>&nbsp;<span class="op" id="1378645">(</span><span class="ident" id="1378646">kvs</span>&nbsp;<span class="op" id="1378650">[</span><span class="op" id="1378651">]</span><span class="ident" id="1378652">keyValues</span><span class="op" id="1378661">,</span>&nbsp;<span class="ident" id="1378663">hs</span>&nbsp;<span class="op" id="1378666">*</span><span class="ident" id="1378667">headerSorter</span><span class="op" id="1378679">)</span>&nbsp;<span class="op" id="1378681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378684">hs</span>&nbsp;<span class="op" id="1378687">=</span>&nbsp;<span class="ident" id="1378689">headerSorterPool</span><span class="op" id="1378705">.</span><span class="ident" id="1378706">Get</span><span class="op" id="1378709">(</span><span class="op" id="1378710">)</span><span class="op" id="1378711">.</span><span class="op" id="1378712">(</span><span class="op" id="1378713">*</span><span class="ident" id="1378714">headerSorter</span><span class="op" id="1378726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378729">if</span>&nbsp;<span class="builtinfunc" id="1378732">cap</span><span class="op" id="1378735">(</span><span class="ident" id="1378736">hs</span><span class="op" id="1378738">.</span><span class="ident" id="1378739">kvs</span><span class="op" id="1378742">)</span>&nbsp;<span class="op" id="1378744">&lt;</span>&nbsp;<span class="builtinfunc" id="1378746">len</span><span class="op" id="1378749">(</span><span class="ident" id="1378750">h</span><span class="op" id="1378751">)</span>&nbsp;<span class="op" id="1378753">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378757">hs</span><span class="op" id="1378759">.</span><span class="ident" id="1378760">kvs</span>&nbsp;<span class="op" id="1378764">=</span>&nbsp;<span class="builtinfunc" id="1378766">make</span><span class="op" id="1378770">(</span><span class="op" id="1378771">[</span><span class="op" id="1378772">]</span><span class="ident" id="1378773">keyValues</span><span class="op" id="1378782">,</span>&nbsp;<span class="num" id="1378784">0</span><span class="op" id="1378785">,</span>&nbsp;<span class="builtinfunc" id="1378787">len</span><span class="op" id="1378790">(</span><span class="ident" id="1378791">h</span><span class="op" id="1378792">)</span><span class="op" id="1378793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378799">kvs</span>&nbsp;<span class="op" id="1378803">=</span>&nbsp;<span class="ident" id="1378805">hs</span><span class="op" id="1378807">.</span><span class="ident" id="1378808">kvs</span><span class="op" id="1378811">[</span><span class="op" id="1378812">:</span><span class="num" id="1378813">0</span><span class="op" id="1378814">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378817">for</span>&nbsp;<span class="ident" id="1378821">k</span><span class="op" id="1378822">,</span>&nbsp;<span class="ident" id="1378824">vv</span>&nbsp;<span class="op" id="1378827">:=</span>&nbsp;<span class="keyword" id="1378830">range</span>&nbsp;<span class="ident" id="1378836">h</span>&nbsp;<span class="op" id="1378838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378842">if</span>&nbsp;<span class="op" id="1378845">!</span><span class="ident" id="1378846">exclude</span><span class="op" id="1378853">[</span><span class="ident" id="1378854">k</span><span class="op" id="1378855">]</span>&nbsp;<span class="op" id="1378857">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378862">kvs</span>&nbsp;<span class="op" id="1378866">=</span>&nbsp;<span class="builtinfunc" id="1378868">append</span><span class="op" id="1378874">(</span><span class="ident" id="1378875">kvs</span><span class="op" id="1378878">,</span>&nbsp;<span class="ident" id="1378880">keyValues</span><span class="op" id="1378889">{</span><span class="ident" id="1378890">k</span><span class="op" id="1378891">,</span>&nbsp;<span class="ident" id="1378893">vv</span><span class="op" id="1378895">}</span><span class="op" id="1378896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378906">hs</span><span class="op" id="1378908">.</span><span class="ident" id="1378909">kvs</span>&nbsp;<span class="op" id="1378913">=</span>&nbsp;<span class="ident" id="1378915">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378920">sort</span><span class="op" id="1378924">.</span><span class="ident" id="1378925">Sort</span><span class="op" id="1378929">(</span><span class="ident" id="1378930">hs</span><span class="op" id="1378932">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378935">return</span>&nbsp;<span class="ident" id="1378942">kvs</span><span class="op" id="1378945">,</span>&nbsp;<span class="ident" id="1378947">hs</span><br>
<span class="lineno"></span><span class="op" id="1378950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1378953">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="1379000">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="1379075">func</span>&nbsp;<span class="op" id="1379080">(</span><span class="ident" id="1379081">h</span>&nbsp;<span class="ident" id="1379083">Header</span><span class="op" id="1379089">)</span>&nbsp;<span class="ident" id="1379091">WriteSubset</span><span class="op" id="1379102">(</span><span class="ident" id="1379103">w</span>&nbsp;<span class="ident" id="1379105">io</span><span class="op" id="1379107">.</span><span class="ident" id="1379108">Writer</span><span class="op" id="1379114">,</span>&nbsp;<span class="ident" id="1379116">exclude</span>&nbsp;<span class="keyword" id="1379124">map</span><span class="op" id="1379127">[</span><span class="builtintype" id="1379128">string</span><span class="op" id="1379134">]</span><span class="builtintype" id="1379135">bool</span><span class="op" id="1379139">)</span>&nbsp;<span class="builtintype" id="1379141">error</span>&nbsp;<span class="op" id="1379147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379150">ws</span><span class="op" id="1379152">,</span>&nbsp;<span class="ident" id="1379154">ok</span>&nbsp;<span class="op" id="1379157">:=</span>&nbsp;<span class="ident" id="1379160">w</span><span class="op" id="1379161">.</span><span class="op" id="1379162">(</span><span class="ident" id="1379163">writeStringer</span><span class="op" id="1379176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379179">if</span>&nbsp;<span class="op" id="1379182">!</span><span class="ident" id="1379183">ok</span>&nbsp;<span class="op" id="1379186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379190">ws</span>&nbsp;<span class="op" id="1379193">=</span>&nbsp;<span class="ident" id="1379195">stringWriter</span><span class="op" id="1379207">{</span><span class="ident" id="1379208">w</span><span class="op" id="1379209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379212">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379215">kvs</span><span class="op" id="1379218">,</span>&nbsp;<span class="ident" id="1379220">sorter</span>&nbsp;<span class="op" id="1379227">:=</span>&nbsp;<span class="ident" id="1379230">h</span><span class="op" id="1379231">.</span><span class="ident" id="1379232">sortedKeyValues</span><span class="op" id="1379247">(</span><span class="ident" id="1379248">exclude</span><span class="op" id="1379255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379258">for</span>&nbsp;<span class="ident" id="1379262">_</span><span class="op" id="1379263">,</span>&nbsp;<span class="ident" id="1379265">kv</span>&nbsp;<span class="op" id="1379268">:=</span>&nbsp;<span class="keyword" id="1379271">range</span>&nbsp;<span class="ident" id="1379277">kvs</span>&nbsp;<span class="op" id="1379281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379285">for</span>&nbsp;<span class="ident" id="1379289">_</span><span class="op" id="1379290">,</span>&nbsp;<span class="ident" id="1379292">v</span>&nbsp;<span class="op" id="1379294">:=</span>&nbsp;<span class="keyword" id="1379297">range</span>&nbsp;<span class="ident" id="1379303">kv</span><span class="op" id="1379305">.</span><span class="ident" id="1379306">values</span>&nbsp;<span class="op" id="1379313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379318">v</span>&nbsp;<span class="op" id="1379320">=</span>&nbsp;<span class="ident" id="1379322">headerNewlineToSpace</span><span class="op" id="1379342">.</span><span class="ident" id="1379343">Replace</span><span class="op" id="1379350">(</span><span class="ident" id="1379351">v</span><span class="op" id="1379352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379357">v</span>&nbsp;<span class="op" id="1379359">=</span>&nbsp;<span class="ident" id="1379361">textproto</span><span class="op" id="1379370">.</span><span class="ident" id="1379371">TrimString</span><span class="op" id="1379381">(</span><span class="ident" id="1379382">v</span><span class="op" id="1379383">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379388">for</span>&nbsp;<span class="ident" id="1379392">_</span><span class="op" id="1379393">,</span>&nbsp;<span class="ident" id="1379395">s</span>&nbsp;<span class="op" id="1379397">:=</span>&nbsp;<span class="keyword" id="1379400">range</span>&nbsp;<span class="op" id="1379406">[</span><span class="op" id="1379407">]</span><span class="builtintype" id="1379408">string</span><span class="op" id="1379414">{</span><span class="ident" id="1379415">kv</span><span class="op" id="1379417">.</span><span class="ident" id="1379418">key</span><span class="op" id="1379421">,</span>&nbsp;<span class="string" id="1379423">&#34;:&nbsp;&#34;</span><span class="op" id="1379427">,</span>&nbsp;<span class="ident" id="1379429">v</span><span class="op" id="1379430">,</span>&nbsp;<span class="string" id="1379432">&#34;\r\n&#34;</span><span class="op" id="1379438">}</span>&nbsp;<span class="op" id="1379440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379446">if</span>&nbsp;<span class="ident" id="1379449">_</span><span class="op" id="1379450">,</span>&nbsp;<span class="ident" id="1379452">err</span>&nbsp;<span class="op" id="1379456">:=</span>&nbsp;<span class="ident" id="1379459">ws</span><span class="op" id="1379461">.</span><span class="ident" id="1379462">WriteString</span><span class="op" id="1379473">(</span><span class="ident" id="1379474">s</span><span class="op" id="1379475">)</span><span class="op" id="1379476">;</span>&nbsp;<span class="ident" id="1379478">err</span>&nbsp;<span class="op" id="1379482">!=</span>&nbsp;<span class="ident" id="1379485">nil</span>&nbsp;<span class="op" id="1379489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379496">return</span>&nbsp;<span class="ident" id="1379503">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379516">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379526">headerSorterPool</span><span class="op" id="1379542">.</span><span class="ident" id="1379543">Put</span><span class="op" id="1379546">(</span><span class="ident" id="1379547">sorter</span><span class="op" id="1379553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379556">return</span>&nbsp;<span class="ident" id="1379563">nil</span><br>
<span class="lineno"></span><span class="op" id="1379567">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="1379570">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1379628">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="1379686">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="1379745">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="1379803">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="1379864">func</span>&nbsp;<span class="ident" id="1379869">CanonicalHeaderKey</span><span class="op" id="1379887">(</span><span class="ident" id="1379888">s</span>&nbsp;<span class="builtintype" id="1379890">string</span><span class="op" id="1379896">)</span>&nbsp;<span class="builtintype" id="1379898">string</span>&nbsp;<span class="op" id="1379905">{</span>&nbsp;<span class="keyword" id="1379907">return</span>&nbsp;<span class="ident" id="1379914">textproto</span><span class="op" id="1379923">.</span><span class="ident" id="1379924">CanonicalMIMEHeaderKey</span><span class="op" id="1379946">(</span><span class="ident" id="1379947">s</span><span class="op" id="1379948">)</span>&nbsp;<span class="op" id="1379950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1379953">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="1380009">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="1380062">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="1380094">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="1380124">func</span>&nbsp;<span class="ident" id="1380129">hasToken</span><span class="op" id="1380137">(</span><span class="ident" id="1380138">v</span><span class="op" id="1380139">,</span>&nbsp;<span class="ident" id="1380141">token</span>&nbsp;<span class="builtintype" id="1380147">string</span><span class="op" id="1380153">)</span>&nbsp;<span class="builtintype" id="1380155">bool</span>&nbsp;<span class="op" id="1380160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380163">if</span>&nbsp;<span class="builtinfunc" id="1380166">len</span><span class="op" id="1380169">(</span><span class="ident" id="1380170">token</span><span class="op" id="1380175">)</span>&nbsp;<span class="op" id="1380177">&gt;</span>&nbsp;<span class="builtinfunc" id="1380179">len</span><span class="op" id="1380182">(</span><span class="ident" id="1380183">v</span><span class="op" id="1380184">)</span>&nbsp;<span class="op" id="1380186">||</span>&nbsp;<span class="ident" id="1380189">token</span>&nbsp;<span class="op" id="1380195">==</span>&nbsp;<span class="string" id="1380198">&#34;&#34;</span>&nbsp;<span class="op" id="1380201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380205">return</span>&nbsp;<span class="builtintype" id="1380212">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380222">if</span>&nbsp;<span class="ident" id="1380225">v</span>&nbsp;<span class="op" id="1380227">==</span>&nbsp;<span class="ident" id="1380230">token</span>&nbsp;<span class="op" id="1380236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380240">return</span>&nbsp;<span class="builtintype" id="1380247">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380256">for</span>&nbsp;<span class="ident" id="1380260">sp</span>&nbsp;<span class="op" id="1380263">:=</span>&nbsp;<span class="num" id="1380266">0</span><span class="op" id="1380267">;</span>&nbsp;<span class="ident" id="1380269">sp</span>&nbsp;<span class="op" id="1380272">&lt;=</span>&nbsp;<span class="builtinfunc" id="1380275">len</span><span class="op" id="1380278">(</span><span class="ident" id="1380279">v</span><span class="op" id="1380280">)</span><span class="op" id="1380281">-</span><span class="builtinfunc" id="1380282">len</span><span class="op" id="1380285">(</span><span class="ident" id="1380286">token</span><span class="op" id="1380291">)</span><span class="op" id="1380292">;</span>&nbsp;<span class="ident" id="1380294">sp</span><span class="op" id="1380296">++</span>&nbsp;<span class="op" id="1380299">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380303">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380344">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380400">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380453">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380508">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380562">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380621">if</span>&nbsp;<span class="ident" id="1380624">b</span>&nbsp;<span class="op" id="1380626">:=</span>&nbsp;<span class="ident" id="1380629">v</span><span class="op" id="1380630">[</span><span class="ident" id="1380631">sp</span><span class="op" id="1380633">]</span><span class="op" id="1380634">;</span>&nbsp;<span class="ident" id="1380636">b</span>&nbsp;<span class="op" id="1380638">!=</span>&nbsp;<span class="ident" id="1380641">token</span><span class="op" id="1380646">[</span><span class="num" id="1380647">0</span><span class="op" id="1380648">]</span>&nbsp;<span class="op" id="1380650">&amp;&amp;</span>&nbsp;<span class="ident" id="1380653">b</span><span class="op" id="1380654">|</span><span class="num" id="1380655">0x20</span>&nbsp;<span class="op" id="1380660">!=</span>&nbsp;<span class="ident" id="1380663">token</span><span class="op" id="1380668">[</span><span class="num" id="1380669">0</span><span class="op" id="1380670">]</span>&nbsp;<span class="op" id="1380672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380677">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380692">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380748">if</span>&nbsp;<span class="ident" id="1380751">sp</span>&nbsp;<span class="op" id="1380754">&gt;</span>&nbsp;<span class="num" id="1380756">0</span>&nbsp;<span class="op" id="1380758">&amp;&amp;</span>&nbsp;<span class="op" id="1380761">!</span><span class="ident" id="1380762">isTokenBoundary</span><span class="op" id="1380777">(</span><span class="ident" id="1380778">v</span><span class="op" id="1380779">[</span><span class="ident" id="1380780">sp</span><span class="op" id="1380782">-</span><span class="num" id="1380783">1</span><span class="op" id="1380784">]</span><span class="op" id="1380785">)</span>&nbsp;<span class="op" id="1380787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380792">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380807">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380861">if</span>&nbsp;<span class="ident" id="1380864">endPos</span>&nbsp;<span class="op" id="1380871">:=</span>&nbsp;<span class="ident" id="1380874">sp</span>&nbsp;<span class="op" id="1380877">+</span>&nbsp;<span class="builtinfunc" id="1380879">len</span><span class="op" id="1380882">(</span><span class="ident" id="1380883">token</span><span class="op" id="1380888">)</span><span class="op" id="1380889">;</span>&nbsp;<span class="ident" id="1380891">endPos</span>&nbsp;<span class="op" id="1380898">!=</span>&nbsp;<span class="builtinfunc" id="1380901">len</span><span class="op" id="1380904">(</span><span class="ident" id="1380905">v</span><span class="op" id="1380906">)</span>&nbsp;<span class="op" id="1380908">&amp;&amp;</span>&nbsp;<span class="op" id="1380911">!</span><span class="ident" id="1380912">isTokenBoundary</span><span class="op" id="1380927">(</span><span class="ident" id="1380928">v</span><span class="op" id="1380929">[</span><span class="ident" id="1380930">endPos</span><span class="op" id="1380936">]</span><span class="op" id="1380937">)</span>&nbsp;<span class="op" id="1380939">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380944">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380959">if</span>&nbsp;<span class="ident" id="1380962">strings</span><span class="op" id="1380969">.</span><span class="ident" id="1380970">EqualFold</span><span class="op" id="1380979">(</span><span class="ident" id="1380980">v</span><span class="op" id="1380981">[</span><span class="ident" id="1380982">sp</span><span class="op" id="1380984">:</span><span class="ident" id="1380985">sp</span><span class="op" id="1380987">+</span><span class="builtinfunc" id="1380988">len</span><span class="op" id="1380991">(</span><span class="ident" id="1380992">token</span><span class="op" id="1380997">)</span><span class="op" id="1380998">]</span><span class="op" id="1380999">,</span>&nbsp;<span class="ident" id="1381001">token</span><span class="op" id="1381006">)</span>&nbsp;<span class="op" id="1381008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1381013">return</span>&nbsp;<span class="builtintype" id="1381020">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1381027">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1381030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1381033">return</span>&nbsp;<span class="builtintype" id="1381040">false</span><br>
<span class="lineno"></span><span class="op" id="1381046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1381049">func</span>&nbsp;<span class="ident" id="1381054">isTokenBoundary</span><span class="op" id="1381069">(</span><span class="ident" id="1381070">b</span>&nbsp;<span class="builtintype" id="1381072">byte</span><span class="op" id="1381076">)</span>&nbsp;<span class="builtintype" id="1381078">bool</span>&nbsp;<span class="op" id="1381083">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1381086">return</span>&nbsp;<span class="ident" id="1381093">b</span>&nbsp;<span class="op" id="1381095">==</span>&nbsp;<span class="string" id="1381098">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="1381102">||</span>&nbsp;<span class="ident" id="1381105">b</span>&nbsp;<span class="op" id="1381107">==</span>&nbsp;<span class="string" id="1381110">&#39;,&#39;</span>&nbsp;<span class="op" id="1381114">||</span>&nbsp;<span class="ident" id="1381117">b</span>&nbsp;<span class="op" id="1381119">==</span>&nbsp;<span class="string" id="1381122">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="1381127">}</span>
</div>
</body>
</html>
