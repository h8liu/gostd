<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2520475">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2520530">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2520584">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2520635">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2520700">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2520727">package</span>&nbsp;<span class="ident" id="2520735">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2520744">import</span>&nbsp;<span class="op" id="2520751">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2520754">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2520765">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2520773">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2520782">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2520785">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2520851">//</span><br>
<span class="lineno"></span><span class="comment" id="2520854">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2520919">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2520980">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2521044">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2521100">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2521164">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2521226">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2521293">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2521357">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2521402">//</span><br>
<span class="lineno"></span><span class="comment" id="2521405">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2521473">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2521544">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2521613">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2521646">//</span><br>
<span class="lineno"></span><span class="comment" id="2521649">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2521713">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2521779">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2521845">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2521882">//</span><br>
<span class="lineno"></span><span class="comment" id="2521885">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2521946">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2522019">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2522087">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2522153">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2522222">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2522287">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2522329">//</span><br>
<span class="lineno"></span><span class="comment" id="2522332">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2522396">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2522463">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2522526">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2522579">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2522646">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2522674">//</span><br>
<span class="lineno"></span><span class="comment" id="2522677">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2522727">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2522777">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2522838">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2522884">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2522947">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2522993">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2523043">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2523100">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2523167">var</span>&nbsp;<span class="ident" id="2523171">ForkLock</span>&nbsp;<span class="ident" id="2523180">sync</span><span class="op" id="2523184">.</span><span class="ident" id="2523185">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2523194">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2523260">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2523326">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2523352">func</span>&nbsp;<span class="ident" id="2523357">StringSlicePtr</span><span class="op" id="2523371">(</span><span class="ident" id="2523372">ss</span>&nbsp;<span class="op" id="2523375">[</span><span class="op" id="2523376">]</span><span class="builtintype" id="2523377">string</span><span class="op" id="2523383">)</span>&nbsp;<span class="op" id="2523385">[</span><span class="op" id="2523386">]</span><span class="op" id="2523387">*</span><span class="builtintype" id="2523388">byte</span>&nbsp;<span class="op" id="2523393">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2523396">bb</span>&nbsp;<span class="op" id="2523399">:=</span>&nbsp;<span class="builtinfunc" id="2523402">make</span><span class="op" id="2523406">(</span><span class="op" id="2523407">[</span><span class="op" id="2523408">]</span><span class="op" id="2523409">*</span><span class="builtintype" id="2523410">byte</span><span class="op" id="2523414">,</span>&nbsp;<span class="builtinfunc" id="2523416">len</span><span class="op" id="2523419">(</span><span class="ident" id="2523420">ss</span><span class="op" id="2523422">)</span><span class="op" id="2523423">+</span><span class="num" id="2523424">1</span><span class="op" id="2523425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2523428">for</span>&nbsp;<span class="ident" id="2523432">i</span>&nbsp;<span class="op" id="2523434">:=</span>&nbsp;<span class="num" id="2523437">0</span><span class="op" id="2523438">;</span>&nbsp;<span class="ident" id="2523440">i</span>&nbsp;<span class="op" id="2523442">&lt;</span>&nbsp;<span class="builtinfunc" id="2523444">len</span><span class="op" id="2523447">(</span><span class="ident" id="2523448">ss</span><span class="op" id="2523450">)</span><span class="op" id="2523451">;</span>&nbsp;<span class="ident" id="2523453">i</span><span class="op" id="2523454">++</span>&nbsp;<span class="op" id="2523457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2523461">bb</span><span class="op" id="2523463">[</span><span class="ident" id="2523464">i</span><span class="op" id="2523465">]</span>&nbsp;<span class="op" id="2523467">=</span>&nbsp;<span class="ident" id="2523469">StringBytePtr</span><span class="op" id="2523482">(</span><span class="ident" id="2523483">ss</span><span class="op" id="2523485">[</span><span class="ident" id="2523486">i</span><span class="op" id="2523487">]</span><span class="op" id="2523488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2523491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2523494">bb</span><span class="op" id="2523496">[</span><span class="builtinfunc" id="2523497">len</span><span class="op" id="2523500">(</span><span class="ident" id="2523501">ss</span><span class="op" id="2523503">)</span><span class="op" id="2523504">]</span>&nbsp;<span class="op" id="2523506">=</span>&nbsp;<span class="ident" id="2523508">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2523513">return</span>&nbsp;<span class="ident" id="2523520">bb</span><br>
<span class="lineno"></span><span class="op" id="2523523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2523526">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2523591">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2523657">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2523698">func</span>&nbsp;<span class="ident" id="2523703">SlicePtrFromStrings</span><span class="op" id="2523722">(</span><span class="ident" id="2523723">ss</span>&nbsp;<span class="op" id="2523726">[</span><span class="op" id="2523727">]</span><span class="builtintype" id="2523728">string</span><span class="op" id="2523734">)</span>&nbsp;<span class="op" id="2523736">(</span><span class="op" id="2523737">[</span><span class="op" id="2523738">]</span><span class="op" id="2523739">*</span><span class="builtintype" id="2523740">byte</span><span class="op" id="2523744">,</span>&nbsp;<span class="builtintype" id="2523746">error</span><span class="op" id="2523751">)</span>&nbsp;<span class="op" id="2523753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2523756">var</span>&nbsp;<span class="ident" id="2523760">err</span>&nbsp;<span class="builtintype" id="2523764">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2523771">bb</span>&nbsp;<span class="op" id="2523774">:=</span>&nbsp;<span class="builtinfunc" id="2523777">make</span><span class="op" id="2523781">(</span><span class="op" id="2523782">[</span><span class="op" id="2523783">]</span><span class="op" id="2523784">*</span><span class="builtintype" id="2523785">byte</span><span class="op" id="2523789">,</span>&nbsp;<span class="builtinfunc" id="2523791">len</span><span class="op" id="2523794">(</span><span class="ident" id="2523795">ss</span><span class="op" id="2523797">)</span><span class="op" id="2523798">+</span><span class="num" id="2523799">1</span><span class="op" id="2523800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2523803">for</span>&nbsp;<span class="ident" id="2523807">i</span>&nbsp;<span class="op" id="2523809">:=</span>&nbsp;<span class="num" id="2523812">0</span><span class="op" id="2523813">;</span>&nbsp;<span class="ident" id="2523815">i</span>&nbsp;<span class="op" id="2523817">&lt;</span>&nbsp;<span class="builtinfunc" id="2523819">len</span><span class="op" id="2523822">(</span><span class="ident" id="2523823">ss</span><span class="op" id="2523825">)</span><span class="op" id="2523826">;</span>&nbsp;<span class="ident" id="2523828">i</span><span class="op" id="2523829">++</span>&nbsp;<span class="op" id="2523832">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2523836">bb</span><span class="op" id="2523838">[</span><span class="ident" id="2523839">i</span><span class="op" id="2523840">]</span><span class="op" id="2523841">,</span>&nbsp;<span class="ident" id="2523843">err</span>&nbsp;<span class="op" id="2523847">=</span>&nbsp;<span class="ident" id="2523849">BytePtrFromString</span><span class="op" id="2523866">(</span><span class="ident" id="2523867">ss</span><span class="op" id="2523869">[</span><span class="ident" id="2523870">i</span><span class="op" id="2523871">]</span><span class="op" id="2523872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2523876">if</span>&nbsp;<span class="ident" id="2523879">err</span>&nbsp;<span class="op" id="2523883">!=</span>&nbsp;<span class="ident" id="2523886">nil</span>&nbsp;<span class="op" id="2523890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2523895">return</span>&nbsp;<span class="ident" id="2523902">nil</span><span class="op" id="2523905">,</span>&nbsp;<span class="ident" id="2523907">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2523913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2523916">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2523919">bb</span><span class="op" id="2523921">[</span><span class="builtinfunc" id="2523922">len</span><span class="op" id="2523925">(</span><span class="ident" id="2523926">ss</span><span class="op" id="2523928">)</span><span class="op" id="2523929">]</span>&nbsp;<span class="op" id="2523931">=</span>&nbsp;<span class="ident" id="2523933">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2523938">return</span>&nbsp;<span class="ident" id="2523945">bb</span><span class="op" id="2523947">,</span>&nbsp;<span class="ident" id="2523949">nil</span><br>
<span class="lineno"></span><span class="op" id="2523953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2523956">func</span>&nbsp;<span class="ident" id="2523961">CloseOnExec</span><span class="op" id="2523972">(</span><span class="ident" id="2523973">fd</span>&nbsp;<span class="builtintype" id="2523976">int</span><span class="op" id="2523979">)</span>&nbsp;<span class="op" id="2523981">{</span>&nbsp;<span class="ident" id="2523983">fcntl</span><span class="op" id="2523988">(</span><span class="ident" id="2523989">fd</span><span class="op" id="2523991">,</span>&nbsp;<span class="ident" id="2523993">F_SETFD</span><span class="op" id="2524000">,</span>&nbsp;<span class="ident" id="2524002">FD_CLOEXEC</span><span class="op" id="2524012">)</span>&nbsp;<span class="op" id="2524014">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2524017">func</span>&nbsp;<span class="ident" id="2524022">SetNonblock</span><span class="op" id="2524033">(</span><span class="ident" id="2524034">fd</span>&nbsp;<span class="builtintype" id="2524037">int</span><span class="op" id="2524040">,</span>&nbsp;<span class="ident" id="2524042">nonblocking</span>&nbsp;<span class="builtintype" id="2524054">bool</span><span class="op" id="2524058">)</span>&nbsp;<span class="op" id="2524060">(</span><span class="ident" id="2524061">err</span>&nbsp;<span class="builtintype" id="2524065">error</span><span class="op" id="2524070">)</span>&nbsp;<span class="op" id="2524072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524075">flag</span><span class="op" id="2524079">,</span>&nbsp;<span class="ident" id="2524081">err</span>&nbsp;<span class="op" id="2524085">:=</span>&nbsp;<span class="ident" id="2524088">fcntl</span><span class="op" id="2524093">(</span><span class="ident" id="2524094">fd</span><span class="op" id="2524096">,</span>&nbsp;<span class="ident" id="2524098">F_GETFL</span><span class="op" id="2524105">,</span>&nbsp;<span class="num" id="2524107">0</span><span class="op" id="2524108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524111">if</span>&nbsp;<span class="ident" id="2524114">err</span>&nbsp;<span class="op" id="2524118">!=</span>&nbsp;<span class="ident" id="2524121">nil</span>&nbsp;<span class="op" id="2524125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524129">return</span>&nbsp;<span class="ident" id="2524136">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2524141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524144">if</span>&nbsp;<span class="ident" id="2524147">nonblocking</span>&nbsp;<span class="op" id="2524159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524163">flag</span>&nbsp;<span class="op" id="2524168">|=</span>&nbsp;<span class="ident" id="2524171">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2524183">}</span>&nbsp;<span class="keyword" id="2524185">else</span>&nbsp;<span class="op" id="2524190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524194">flag</span>&nbsp;<span class="op" id="2524199">&amp;=</span>&nbsp;<span class="op" id="2524202">^</span><span class="ident" id="2524203">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2524215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524218">_</span><span class="op" id="2524219">,</span>&nbsp;<span class="ident" id="2524221">err</span>&nbsp;<span class="op" id="2524225">=</span>&nbsp;<span class="ident" id="2524227">fcntl</span><span class="op" id="2524232">(</span><span class="ident" id="2524233">fd</span><span class="op" id="2524235">,</span>&nbsp;<span class="ident" id="2524237">F_SETFL</span><span class="op" id="2524244">,</span>&nbsp;<span class="ident" id="2524246">flag</span><span class="op" id="2524250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524253">return</span>&nbsp;<span class="ident" id="2524260">err</span><br>
<span class="lineno"></span><span class="op" id="2524264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2524267">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2524327">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2524374">type</span>&nbsp;<span class="ident" id="2524379">Credential</span>&nbsp;<span class="keyword" id="2524390">struct</span>&nbsp;<span class="op" id="2524397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524400">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2524407">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2524416">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524429">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2524436">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2524445">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524459">Groups</span>&nbsp;<span class="op" id="2524466">[</span><span class="op" id="2524467">]</span><span class="builtintype" id="2524468">uint32</span>&nbsp;<span class="comment" id="2524475">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2524503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2524506">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2524581">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2524601">type</span>&nbsp;<span class="ident" id="2524606">ProcAttr</span>&nbsp;<span class="keyword" id="2524615">struct</span>&nbsp;<span class="op" id="2524622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524625">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2524631">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2524641">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524672">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2524678">[</span><span class="op" id="2524679">]</span><span class="builtintype" id="2524680">string</span>&nbsp;&nbsp;<span class="comment" id="2524688">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524705">Files</span>&nbsp;<span class="op" id="2524711">[</span><span class="op" id="2524712">]</span><span class="builtintype" id="2524713">uintptr</span>&nbsp;<span class="comment" id="2524721">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524743">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2524749">*</span><span class="ident" id="2524750">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2524762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2524765">var</span>&nbsp;<span class="ident" id="2524769">zeroProcAttr</span>&nbsp;<span class="ident" id="2524782">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2524791">var</span>&nbsp;<span class="ident" id="2524795">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2524811">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2524824">func</span>&nbsp;<span class="ident" id="2524829">forkExec</span><span class="op" id="2524837">(</span><span class="ident" id="2524838">argv0</span>&nbsp;<span class="builtintype" id="2524844">string</span><span class="op" id="2524850">,</span>&nbsp;<span class="ident" id="2524852">argv</span>&nbsp;<span class="op" id="2524857">[</span><span class="op" id="2524858">]</span><span class="builtintype" id="2524859">string</span><span class="op" id="2524865">,</span>&nbsp;<span class="ident" id="2524867">attr</span>&nbsp;<span class="op" id="2524872">*</span><span class="ident" id="2524873">ProcAttr</span><span class="op" id="2524881">)</span>&nbsp;<span class="op" id="2524883">(</span><span class="ident" id="2524884">pid</span>&nbsp;<span class="builtintype" id="2524888">int</span><span class="op" id="2524891">,</span>&nbsp;<span class="ident" id="2524893">err</span>&nbsp;<span class="builtintype" id="2524897">error</span><span class="op" id="2524902">)</span>&nbsp;<span class="op" id="2524904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524907">var</span>&nbsp;<span class="ident" id="2524911">p</span>&nbsp;<span class="op" id="2524913">[</span><span class="num" id="2524914">2</span><span class="op" id="2524915">]</span><span class="builtintype" id="2524916">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524921">var</span>&nbsp;<span class="ident" id="2524925">n</span>&nbsp;<span class="builtintype" id="2524927">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524932">var</span>&nbsp;<span class="ident" id="2524936">err1</span>&nbsp;<span class="ident" id="2524941">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524948">var</span>&nbsp;<span class="ident" id="2524952">wstatus</span>&nbsp;<span class="ident" id="2524960">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2524973">if</span>&nbsp;<span class="ident" id="2524976">attr</span>&nbsp;<span class="op" id="2524981">==</span>&nbsp;<span class="ident" id="2524984">nil</span>&nbsp;<span class="op" id="2524988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2524992">attr</span>&nbsp;<span class="op" id="2524997">=</span>&nbsp;<span class="op" id="2524999">&amp;</span><span class="ident" id="2525000">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525017">sys</span>&nbsp;<span class="op" id="2525021">:=</span>&nbsp;<span class="ident" id="2525024">attr</span><span class="op" id="2525028">.</span><span class="ident" id="2525029">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525034">if</span>&nbsp;<span class="ident" id="2525037">sys</span>&nbsp;<span class="op" id="2525041">==</span>&nbsp;<span class="ident" id="2525044">nil</span>&nbsp;<span class="op" id="2525048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525052">sys</span>&nbsp;<span class="op" id="2525056">=</span>&nbsp;<span class="op" id="2525058">&amp;</span><span class="ident" id="2525059">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525080">p</span><span class="op" id="2525081">[</span><span class="num" id="2525082">0</span><span class="op" id="2525083">]</span>&nbsp;<span class="op" id="2525085">=</span>&nbsp;<span class="op" id="2525087">-</span><span class="num" id="2525088">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525091">p</span><span class="op" id="2525092">[</span><span class="num" id="2525093">1</span><span class="op" id="2525094">]</span>&nbsp;<span class="op" id="2525096">=</span>&nbsp;<span class="op" id="2525098">-</span><span class="num" id="2525099">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2525103">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525131">argv0p</span><span class="op" id="2525137">,</span>&nbsp;<span class="ident" id="2525139">err</span>&nbsp;<span class="op" id="2525143">:=</span>&nbsp;<span class="ident" id="2525146">BytePtrFromString</span><span class="op" id="2525163">(</span><span class="ident" id="2525164">argv0</span><span class="op" id="2525169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525172">if</span>&nbsp;<span class="ident" id="2525175">err</span>&nbsp;<span class="op" id="2525179">!=</span>&nbsp;<span class="ident" id="2525182">nil</span>&nbsp;<span class="op" id="2525186">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525190">return</span>&nbsp;<span class="num" id="2525197">0</span><span class="op" id="2525198">,</span>&nbsp;<span class="ident" id="2525200">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525208">argvp</span><span class="op" id="2525213">,</span>&nbsp;<span class="ident" id="2525215">err</span>&nbsp;<span class="op" id="2525219">:=</span>&nbsp;<span class="ident" id="2525222">SlicePtrFromStrings</span><span class="op" id="2525241">(</span><span class="ident" id="2525242">argv</span><span class="op" id="2525246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525249">if</span>&nbsp;<span class="ident" id="2525252">err</span>&nbsp;<span class="op" id="2525256">!=</span>&nbsp;<span class="ident" id="2525259">nil</span>&nbsp;<span class="op" id="2525263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525267">return</span>&nbsp;<span class="num" id="2525274">0</span><span class="op" id="2525275">,</span>&nbsp;<span class="ident" id="2525277">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525285">envvp</span><span class="op" id="2525290">,</span>&nbsp;<span class="ident" id="2525292">err</span>&nbsp;<span class="op" id="2525296">:=</span>&nbsp;<span class="ident" id="2525299">SlicePtrFromStrings</span><span class="op" id="2525318">(</span><span class="ident" id="2525319">attr</span><span class="op" id="2525323">.</span><span class="ident" id="2525324">Env</span><span class="op" id="2525327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525330">if</span>&nbsp;<span class="ident" id="2525333">err</span>&nbsp;<span class="op" id="2525337">!=</span>&nbsp;<span class="ident" id="2525340">nil</span>&nbsp;<span class="op" id="2525344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525348">return</span>&nbsp;<span class="num" id="2525355">0</span><span class="op" id="2525356">,</span>&nbsp;<span class="ident" id="2525358">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525363">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525367">if</span>&nbsp;<span class="op" id="2525370">(</span><span class="ident" id="2525371">runtime</span><span class="op" id="2525378">.</span><span class="ident" id="2525379">GOOS</span>&nbsp;<span class="op" id="2525384">==</span>&nbsp;<span class="string" id="2525387">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2525397">||</span>&nbsp;<span class="ident" id="2525400">runtime</span><span class="op" id="2525407">.</span><span class="ident" id="2525408">GOOS</span>&nbsp;<span class="op" id="2525413">==</span>&nbsp;<span class="string" id="2525416">&#34;dragonfly&#34;</span><span class="op" id="2525427">)</span>&nbsp;<span class="op" id="2525429">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2525432">len</span><span class="op" id="2525435">(</span><span class="ident" id="2525436">argv</span><span class="op" id="2525440">[</span><span class="num" id="2525441">0</span><span class="op" id="2525442">]</span><span class="op" id="2525443">)</span>&nbsp;<span class="op" id="2525445">&gt;</span>&nbsp;<span class="builtinfunc" id="2525447">len</span><span class="op" id="2525450">(</span><span class="ident" id="2525451">argv0</span><span class="op" id="2525456">)</span>&nbsp;<span class="op" id="2525458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525462">argvp</span><span class="op" id="2525467">[</span><span class="num" id="2525468">0</span><span class="op" id="2525469">]</span>&nbsp;<span class="op" id="2525471">=</span>&nbsp;<span class="ident" id="2525473">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525485">var</span>&nbsp;<span class="ident" id="2525489">chroot</span>&nbsp;<span class="op" id="2525496">*</span><span class="builtintype" id="2525497">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525503">if</span>&nbsp;<span class="ident" id="2525506">sys</span><span class="op" id="2525509">.</span><span class="ident" id="2525510">Chroot</span>&nbsp;<span class="op" id="2525517">!=</span>&nbsp;<span class="string" id="2525520">&#34;&#34;</span>&nbsp;<span class="op" id="2525523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525527">chroot</span><span class="op" id="2525533">,</span>&nbsp;<span class="ident" id="2525535">err</span>&nbsp;<span class="op" id="2525539">=</span>&nbsp;<span class="ident" id="2525541">BytePtrFromString</span><span class="op" id="2525558">(</span><span class="ident" id="2525559">sys</span><span class="op" id="2525562">.</span><span class="ident" id="2525563">Chroot</span><span class="op" id="2525569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525573">if</span>&nbsp;<span class="ident" id="2525576">err</span>&nbsp;<span class="op" id="2525580">!=</span>&nbsp;<span class="ident" id="2525583">nil</span>&nbsp;<span class="op" id="2525587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525592">return</span>&nbsp;<span class="num" id="2525599">0</span><span class="op" id="2525600">,</span>&nbsp;<span class="ident" id="2525602">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525614">var</span>&nbsp;<span class="ident" id="2525618">dir</span>&nbsp;<span class="op" id="2525622">*</span><span class="builtintype" id="2525623">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525629">if</span>&nbsp;<span class="ident" id="2525632">attr</span><span class="op" id="2525636">.</span><span class="ident" id="2525637">Dir</span>&nbsp;<span class="op" id="2525641">!=</span>&nbsp;<span class="string" id="2525644">&#34;&#34;</span>&nbsp;<span class="op" id="2525647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525651">dir</span><span class="op" id="2525654">,</span>&nbsp;<span class="ident" id="2525656">err</span>&nbsp;<span class="op" id="2525660">=</span>&nbsp;<span class="ident" id="2525662">BytePtrFromString</span><span class="op" id="2525679">(</span><span class="ident" id="2525680">attr</span><span class="op" id="2525684">.</span><span class="ident" id="2525685">Dir</span><span class="op" id="2525688">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525692">if</span>&nbsp;<span class="ident" id="2525695">err</span>&nbsp;<span class="op" id="2525699">!=</span>&nbsp;<span class="ident" id="2525702">nil</span>&nbsp;<span class="op" id="2525706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525711">return</span>&nbsp;<span class="num" id="2525718">0</span><span class="op" id="2525719">,</span>&nbsp;<span class="ident" id="2525721">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2525734">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2525785">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2525835">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525855">ForkLock</span><span class="op" id="2525863">.</span><span class="ident" id="2525864">Lock</span><span class="op" id="2525868">(</span><span class="op" id="2525869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2525873">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525919">if</span>&nbsp;<span class="ident" id="2525922">err</span>&nbsp;<span class="op" id="2525926">=</span>&nbsp;<span class="ident" id="2525928">forkExecPipe</span><span class="op" id="2525940">(</span><span class="ident" id="2525941">p</span><span class="op" id="2525942">[</span><span class="op" id="2525943">:</span><span class="op" id="2525944">]</span><span class="op" id="2525945">)</span><span class="op" id="2525946">;</span>&nbsp;<span class="ident" id="2525948">err</span>&nbsp;<span class="op" id="2525952">!=</span>&nbsp;<span class="ident" id="2525955">nil</span>&nbsp;<span class="op" id="2525959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2525963">goto</span>&nbsp;<span class="builtintype" id="2525968">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2525975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2525979">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2525999">pid</span><span class="op" id="2526002">,</span>&nbsp;<span class="ident" id="2526004">err1</span>&nbsp;<span class="op" id="2526009">=</span>&nbsp;<span class="ident" id="2526011">forkAndExecInChild</span><span class="op" id="2526029">(</span><span class="ident" id="2526030">argv0p</span><span class="op" id="2526036">,</span>&nbsp;<span class="ident" id="2526038">argvp</span><span class="op" id="2526043">,</span>&nbsp;<span class="ident" id="2526045">envvp</span><span class="op" id="2526050">,</span>&nbsp;<span class="ident" id="2526052">chroot</span><span class="op" id="2526058">,</span>&nbsp;<span class="ident" id="2526060">dir</span><span class="op" id="2526063">,</span>&nbsp;<span class="ident" id="2526065">attr</span><span class="op" id="2526069">,</span>&nbsp;<span class="ident" id="2526071">sys</span><span class="op" id="2526074">,</span>&nbsp;<span class="ident" id="2526076">p</span><span class="op" id="2526077">[</span><span class="num" id="2526078">1</span><span class="op" id="2526079">]</span><span class="op" id="2526080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526083">if</span>&nbsp;<span class="ident" id="2526086">err1</span>&nbsp;<span class="op" id="2526091">!=</span>&nbsp;<span class="num" id="2526094">0</span>&nbsp;<span class="op" id="2526096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526100">err</span>&nbsp;<span class="op" id="2526104">=</span>&nbsp;<span class="ident" id="2526106">Errno</span><span class="op" id="2526111">(</span><span class="ident" id="2526112">err1</span><span class="op" id="2526116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526120">goto</span>&nbsp;<span class="builtintype" id="2526125">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2526132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526135">ForkLock</span><span class="op" id="2526143">.</span><span class="ident" id="2526144">Unlock</span><span class="op" id="2526150">(</span><span class="op" id="2526151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2526155">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526194">Close</span><span class="op" id="2526199">(</span><span class="ident" id="2526200">p</span><span class="op" id="2526201">[</span><span class="num" id="2526202">1</span><span class="op" id="2526203">]</span><span class="op" id="2526204">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526207">n</span><span class="op" id="2526208">,</span>&nbsp;<span class="ident" id="2526210">err</span>&nbsp;<span class="op" id="2526214">=</span>&nbsp;<span class="ident" id="2526216">readlen</span><span class="op" id="2526223">(</span><span class="ident" id="2526224">p</span><span class="op" id="2526225">[</span><span class="num" id="2526226">0</span><span class="op" id="2526227">]</span><span class="op" id="2526228">,</span>&nbsp;<span class="op" id="2526230">(</span><span class="op" id="2526231">*</span><span class="builtintype" id="2526232">byte</span><span class="op" id="2526236">)</span><span class="op" id="2526237">(</span><span class="ident" id="2526238">unsafe</span><span class="op" id="2526244">.</span><span class="ident" id="2526245">Pointer</span><span class="op" id="2526252">(</span><span class="op" id="2526253">&amp;</span><span class="ident" id="2526254">err1</span><span class="op" id="2526258">)</span><span class="op" id="2526259">)</span><span class="op" id="2526260">,</span>&nbsp;<span class="builtintype" id="2526262">int</span><span class="op" id="2526265">(</span><span class="ident" id="2526266">unsafe</span><span class="op" id="2526272">.</span><span class="ident" id="2526273">Sizeof</span><span class="op" id="2526279">(</span><span class="ident" id="2526280">err1</span><span class="op" id="2526284">)</span><span class="op" id="2526285">)</span><span class="op" id="2526286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526289">Close</span><span class="op" id="2526294">(</span><span class="ident" id="2526295">p</span><span class="op" id="2526296">[</span><span class="num" id="2526297">0</span><span class="op" id="2526298">]</span><span class="op" id="2526299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526302">if</span>&nbsp;<span class="ident" id="2526305">err</span>&nbsp;<span class="op" id="2526309">!=</span>&nbsp;<span class="ident" id="2526312">nil</span>&nbsp;<span class="op" id="2526316">||</span>&nbsp;<span class="ident" id="2526319">n</span>&nbsp;<span class="op" id="2526321">!=</span>&nbsp;<span class="num" id="2526324">0</span>&nbsp;<span class="op" id="2526326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526330">if</span>&nbsp;<span class="ident" id="2526333">n</span>&nbsp;<span class="op" id="2526335">==</span>&nbsp;<span class="builtintype" id="2526338">int</span><span class="op" id="2526341">(</span><span class="ident" id="2526342">unsafe</span><span class="op" id="2526348">.</span><span class="ident" id="2526349">Sizeof</span><span class="op" id="2526355">(</span><span class="ident" id="2526356">err1</span><span class="op" id="2526360">)</span><span class="op" id="2526361">)</span>&nbsp;<span class="op" id="2526363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526368">err</span>&nbsp;<span class="op" id="2526372">=</span>&nbsp;<span class="ident" id="2526374">Errno</span><span class="op" id="2526379">(</span><span class="ident" id="2526380">err1</span><span class="op" id="2526384">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2526388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526392">if</span>&nbsp;<span class="ident" id="2526395">err</span>&nbsp;<span class="op" id="2526399">==</span>&nbsp;<span class="ident" id="2526402">nil</span>&nbsp;<span class="op" id="2526406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526411">err</span>&nbsp;<span class="op" id="2526415">=</span>&nbsp;<span class="ident" id="2526417">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2526425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2526430">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2526483">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526518">_</span><span class="op" id="2526519">,</span>&nbsp;<span class="ident" id="2526521">err1</span>&nbsp;<span class="op" id="2526526">:=</span>&nbsp;<span class="ident" id="2526529">Wait4</span><span class="op" id="2526534">(</span><span class="ident" id="2526535">pid</span><span class="op" id="2526538">,</span>&nbsp;<span class="op" id="2526540">&amp;</span><span class="ident" id="2526541">wstatus</span><span class="op" id="2526548">,</span>&nbsp;<span class="num" id="2526550">0</span><span class="op" id="2526551">,</span>&nbsp;<span class="ident" id="2526553">nil</span><span class="op" id="2526556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526560">for</span>&nbsp;<span class="ident" id="2526564">err1</span>&nbsp;<span class="op" id="2526569">==</span>&nbsp;<span class="ident" id="2526572">EINTR</span>&nbsp;<span class="op" id="2526578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526583">_</span><span class="op" id="2526584">,</span>&nbsp;<span class="ident" id="2526586">err1</span>&nbsp;<span class="op" id="2526591">=</span>&nbsp;<span class="ident" id="2526593">Wait4</span><span class="op" id="2526598">(</span><span class="ident" id="2526599">pid</span><span class="op" id="2526602">,</span>&nbsp;<span class="op" id="2526604">&amp;</span><span class="ident" id="2526605">wstatus</span><span class="op" id="2526612">,</span>&nbsp;<span class="num" id="2526614">0</span><span class="op" id="2526615">,</span>&nbsp;<span class="ident" id="2526617">nil</span><span class="op" id="2526620">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2526624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526628">return</span>&nbsp;<span class="num" id="2526635">0</span><span class="op" id="2526636">,</span>&nbsp;<span class="ident" id="2526638">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2526643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2526647">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526708">return</span>&nbsp;<span class="ident" id="2526715">pid</span><span class="op" id="2526718">,</span>&nbsp;<span class="ident" id="2526720">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2526725">error</span><span class="op" id="2526730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526733">if</span>&nbsp;<span class="ident" id="2526736">p</span><span class="op" id="2526737">[</span><span class="num" id="2526738">0</span><span class="op" id="2526739">]</span>&nbsp;<span class="op" id="2526741">&gt;=</span>&nbsp;<span class="num" id="2526744">0</span>&nbsp;<span class="op" id="2526746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526750">Close</span><span class="op" id="2526755">(</span><span class="ident" id="2526756">p</span><span class="op" id="2526757">[</span><span class="num" id="2526758">0</span><span class="op" id="2526759">]</span><span class="op" id="2526760">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526764">Close</span><span class="op" id="2526769">(</span><span class="ident" id="2526770">p</span><span class="op" id="2526771">[</span><span class="num" id="2526772">1</span><span class="op" id="2526773">]</span><span class="op" id="2526774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2526777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2526780">ForkLock</span><span class="op" id="2526788">.</span><span class="ident" id="2526789">Unlock</span><span class="op" id="2526795">(</span><span class="op" id="2526796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526799">return</span>&nbsp;<span class="num" id="2526806">0</span><span class="op" id="2526807">,</span>&nbsp;<span class="ident" id="2526809">err</span><br>
<span class="lineno"></span><span class="op" id="2526813">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2526816">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2526876">func</span>&nbsp;<span class="ident" id="2526881">ForkExec</span><span class="op" id="2526889">(</span><span class="ident" id="2526890">argv0</span>&nbsp;<span class="builtintype" id="2526896">string</span><span class="op" id="2526902">,</span>&nbsp;<span class="ident" id="2526904">argv</span>&nbsp;<span class="op" id="2526909">[</span><span class="op" id="2526910">]</span><span class="builtintype" id="2526911">string</span><span class="op" id="2526917">,</span>&nbsp;<span class="ident" id="2526919">attr</span>&nbsp;<span class="op" id="2526924">*</span><span class="ident" id="2526925">ProcAttr</span><span class="op" id="2526933">)</span>&nbsp;<span class="op" id="2526935">(</span><span class="ident" id="2526936">pid</span>&nbsp;<span class="builtintype" id="2526940">int</span><span class="op" id="2526943">,</span>&nbsp;<span class="ident" id="2526945">err</span>&nbsp;<span class="builtintype" id="2526949">error</span><span class="op" id="2526954">)</span>&nbsp;<span class="op" id="2526956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2526959">return</span>&nbsp;<span class="ident" id="2526966">forkExec</span><span class="op" id="2526974">(</span><span class="ident" id="2526975">argv0</span><span class="op" id="2526980">,</span>&nbsp;<span class="ident" id="2526982">argv</span><span class="op" id="2526986">,</span>&nbsp;<span class="ident" id="2526988">attr</span><span class="op" id="2526992">)</span><br>
<span class="lineno"></span><span class="op" id="2526994">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2526997">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2527044">func</span>&nbsp;<span class="ident" id="2527049">StartProcess</span><span class="op" id="2527061">(</span><span class="ident" id="2527062">argv0</span>&nbsp;<span class="builtintype" id="2527068">string</span><span class="op" id="2527074">,</span>&nbsp;<span class="ident" id="2527076">argv</span>&nbsp;<span class="op" id="2527081">[</span><span class="op" id="2527082">]</span><span class="builtintype" id="2527083">string</span><span class="op" id="2527089">,</span>&nbsp;<span class="ident" id="2527091">attr</span>&nbsp;<span class="op" id="2527096">*</span><span class="ident" id="2527097">ProcAttr</span><span class="op" id="2527105">)</span>&nbsp;<span class="op" id="2527107">(</span><span class="ident" id="2527108">pid</span>&nbsp;<span class="builtintype" id="2527112">int</span><span class="op" id="2527115">,</span>&nbsp;<span class="ident" id="2527117">handle</span>&nbsp;<span class="builtintype" id="2527124">uintptr</span><span class="op" id="2527131">,</span>&nbsp;<span class="ident" id="2527133">err</span>&nbsp;<span class="builtintype" id="2527137">error</span><span class="op" id="2527142">)</span>&nbsp;<span class="op" id="2527144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2527147">pid</span><span class="op" id="2527150">,</span>&nbsp;<span class="ident" id="2527152">err</span>&nbsp;<span class="op" id="2527156">=</span>&nbsp;<span class="ident" id="2527158">forkExec</span><span class="op" id="2527166">(</span><span class="ident" id="2527167">argv0</span><span class="op" id="2527172">,</span>&nbsp;<span class="ident" id="2527174">argv</span><span class="op" id="2527178">,</span>&nbsp;<span class="ident" id="2527180">attr</span><span class="op" id="2527184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2527187">return</span>&nbsp;<span class="ident" id="2527194">pid</span><span class="op" id="2527197">,</span>&nbsp;<span class="num" id="2527199">0</span><span class="op" id="2527200">,</span>&nbsp;<span class="ident" id="2527202">err</span><br>
<span class="lineno">240</span><span class="op" id="2527206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2527209">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2527227">func</span>&nbsp;<span class="ident" id="2527232">Exec</span><span class="op" id="2527236">(</span><span class="ident" id="2527237">argv0</span>&nbsp;<span class="builtintype" id="2527243">string</span><span class="op" id="2527249">,</span>&nbsp;<span class="ident" id="2527251">argv</span>&nbsp;<span class="op" id="2527256">[</span><span class="op" id="2527257">]</span><span class="builtintype" id="2527258">string</span><span class="op" id="2527264">,</span>&nbsp;<span class="ident" id="2527266">envv</span>&nbsp;<span class="op" id="2527271">[</span><span class="op" id="2527272">]</span><span class="builtintype" id="2527273">string</span><span class="op" id="2527279">)</span>&nbsp;<span class="op" id="2527281">(</span><span class="ident" id="2527282">err</span>&nbsp;<span class="builtintype" id="2527286">error</span><span class="op" id="2527291">)</span>&nbsp;<span class="op" id="2527293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2527296">argv0p</span><span class="op" id="2527302">,</span>&nbsp;<span class="ident" id="2527304">err</span>&nbsp;<span class="op" id="2527308">:=</span>&nbsp;<span class="ident" id="2527311">BytePtrFromString</span><span class="op" id="2527328">(</span><span class="ident" id="2527329">argv0</span><span class="op" id="2527334">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2527337">if</span>&nbsp;<span class="ident" id="2527340">err</span>&nbsp;<span class="op" id="2527344">!=</span>&nbsp;<span class="ident" id="2527347">nil</span>&nbsp;<span class="op" id="2527351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2527355">return</span>&nbsp;<span class="ident" id="2527362">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2527367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2527370">argvp</span><span class="op" id="2527375">,</span>&nbsp;<span class="ident" id="2527377">err</span>&nbsp;<span class="op" id="2527381">:=</span>&nbsp;<span class="ident" id="2527384">SlicePtrFromStrings</span><span class="op" id="2527403">(</span><span class="ident" id="2527404">argv</span><span class="op" id="2527408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2527411">if</span>&nbsp;<span class="ident" id="2527414">err</span>&nbsp;<span class="op" id="2527418">!=</span>&nbsp;<span class="ident" id="2527421">nil</span>&nbsp;<span class="op" id="2527425">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2527429">return</span>&nbsp;<span class="ident" id="2527436">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2527441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2527444">envvp</span><span class="op" id="2527449">,</span>&nbsp;<span class="ident" id="2527451">err</span>&nbsp;<span class="op" id="2527455">:=</span>&nbsp;<span class="ident" id="2527458">SlicePtrFromStrings</span><span class="op" id="2527477">(</span><span class="ident" id="2527478">envv</span><span class="op" id="2527482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2527485">if</span>&nbsp;<span class="ident" id="2527488">err</span>&nbsp;<span class="op" id="2527492">!=</span>&nbsp;<span class="ident" id="2527495">nil</span>&nbsp;<span class="op" id="2527499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2527503">return</span>&nbsp;<span class="ident" id="2527510">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2527515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2527518">_</span><span class="op" id="2527519">,</span>&nbsp;<span class="ident" id="2527521">_</span><span class="op" id="2527522">,</span>&nbsp;<span class="ident" id="2527524">err1</span>&nbsp;<span class="op" id="2527529">:=</span>&nbsp;<span class="ident" id="2527532">RawSyscall</span><span class="op" id="2527542">(</span><span class="ident" id="2527543">SYS_EXECVE</span><span class="op" id="2527553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2527557">uintptr</span><span class="op" id="2527564">(</span><span class="ident" id="2527565">unsafe</span><span class="op" id="2527571">.</span><span class="ident" id="2527572">Pointer</span><span class="op" id="2527579">(</span><span class="ident" id="2527580">argv0p</span><span class="op" id="2527586">)</span><span class="op" id="2527587">)</span><span class="op" id="2527588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2527592">uintptr</span><span class="op" id="2527599">(</span><span class="ident" id="2527600">unsafe</span><span class="op" id="2527606">.</span><span class="ident" id="2527607">Pointer</span><span class="op" id="2527614">(</span><span class="op" id="2527615">&amp;</span><span class="ident" id="2527616">argvp</span><span class="op" id="2527621">[</span><span class="num" id="2527622">0</span><span class="op" id="2527623">]</span><span class="op" id="2527624">)</span><span class="op" id="2527625">)</span><span class="op" id="2527626">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2527630">uintptr</span><span class="op" id="2527637">(</span><span class="ident" id="2527638">unsafe</span><span class="op" id="2527644">.</span><span class="ident" id="2527645">Pointer</span><span class="op" id="2527652">(</span><span class="op" id="2527653">&amp;</span><span class="ident" id="2527654">envvp</span><span class="op" id="2527659">[</span><span class="num" id="2527660">0</span><span class="op" id="2527661">]</span><span class="op" id="2527662">)</span><span class="op" id="2527663">)</span><span class="op" id="2527664">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2527667">return</span>&nbsp;<span class="ident" id="2527674">Errno</span><span class="op" id="2527679">(</span><span class="ident" id="2527680">err1</span><span class="op" id="2527684">)</span><br>
<span class="lineno"></span><span class="op" id="2527686">}</span>
</div>
</body>
</html>
