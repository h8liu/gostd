<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strconv&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Note:&nbsp;see&nbsp;comment&nbsp;in&nbsp;handshake_test.go&nbsp;for&nbsp;details&nbsp;of&nbsp;how&nbsp;the&nbsp;reference</span><br>
<span class="lineno">25</span><span class="comment">//&nbsp;tests&nbsp;work.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;blockingSource&nbsp;is&nbsp;an&nbsp;io.Reader&nbsp;that&nbsp;blocks&nbsp;a&nbsp;Read&nbsp;call&nbsp;until&nbsp;it&#39;s&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">blockingSource</span>&nbsp;<span class="keyword">chan</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="ident">blockingSource</span><span class="op">)</span>&nbsp;<span class="ident">Read</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&lt;-</span><span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;clientTest&nbsp;represents&nbsp;a&nbsp;test&nbsp;of&nbsp;the&nbsp;TLS&nbsp;client&nbsp;handshake&nbsp;against&nbsp;a&nbsp;reference</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">clientTest</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;name&nbsp;is&nbsp;a&nbsp;freeform&nbsp;string&nbsp;identifying&nbsp;the&nbsp;test&nbsp;and&nbsp;the&nbsp;file&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;expected&nbsp;results&nbsp;will&nbsp;be&nbsp;stored.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;command,&nbsp;if&nbsp;not&nbsp;empty,&nbsp;contains&nbsp;a&nbsp;series&nbsp;of&nbsp;arguments&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;command&nbsp;to&nbsp;run&nbsp;for&nbsp;the&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;config,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;contains&nbsp;a&nbsp;custom&nbsp;Config&nbsp;to&nbsp;use&nbsp;for&nbsp;this&nbsp;test.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span>&nbsp;<span class="op">*</span><span class="ident">Config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;cert,&nbsp;if&nbsp;not&nbsp;empty,&nbsp;contains&nbsp;a&nbsp;DER-encoded&nbsp;certificate&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;key,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;contains&nbsp;either&nbsp;a&nbsp;*rsa.PrivateKey&nbsp;or</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;*ecdsa.PrivateKey&nbsp;which&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;validate,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;is&nbsp;a&nbsp;function&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;ConnectionState&nbsp;of&nbsp;the&nbsp;resulting&nbsp;connection.&nbsp;It&nbsp;returns&nbsp;a&nbsp;non-nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;error&nbsp;if&nbsp;the&nbsp;ConnectionState&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">validate</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">ConnectionState</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">defaultServerCommand</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment">//&nbsp;connFromCommand&nbsp;starts&nbsp;the&nbsp;reference&nbsp;server&nbsp;process,&nbsp;connects&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;returns&nbsp;a&nbsp;recordingConn&nbsp;for&nbsp;the&nbsp;connection.&nbsp;The&nbsp;stdin&nbsp;return&nbsp;value&nbsp;is&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;blockingSource&nbsp;for&nbsp;the&nbsp;stdin&nbsp;of&nbsp;the&nbsp;child&nbsp;process.&nbsp;It&nbsp;must&nbsp;be&nbsp;closed&nbsp;before</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Waiting&nbsp;for&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">test</span>&nbsp;<span class="op">*</span><span class="ident">clientTest</span><span class="op">)</span>&nbsp;<span class="ident">connFromCommand</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">conn</span>&nbsp;<span class="op">*</span><span class="ident">recordingConn</span><span class="op">,</span>&nbsp;<span class="ident">child</span>&nbsp;<span class="op">*</span><span class="ident">exec</span><span class="op">.</span><span class="ident">Cmd</span><span class="op">,</span>&nbsp;<span class="ident">stdin</span>&nbsp;<span class="ident">blockingSource</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">testRSACertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">test</span><span class="op">.</span><span class="ident">cert</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">certPath</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">tempFile</span><span class="op">(</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">cert</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">certPath</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">key</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">testRSAPrivateKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">key</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">key</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">pemType</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">derBytes</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">key</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">key</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">rsa</span><span class="op">.</span><span class="ident">PrivateKey</span><span class="op">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pemType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;RSA&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">derBytes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x509</span><span class="op">.</span><span class="ident">MarshalPKCS1PrivateKey</span><span class="op">(</span><span class="ident">key</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">ecdsa</span><span class="op">.</span><span class="ident">PrivateKey</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pemType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;EC&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">derBytes</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x509</span><span class="op">.</span><span class="ident">MarshalECPrivateKey</span><span class="op">(</span><span class="ident">key</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;unknown&nbsp;key&nbsp;type&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">pemOut</span>&nbsp;<span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pem</span><span class="op">.</span><span class="ident">Encode</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">pemOut</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">pem</span><span class="op">.</span><span class="ident">Block</span><span class="op">{</span><span class="ident">Type</span><span class="op">:</span>&nbsp;<span class="ident">pemType</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Bytes</span><span class="op">:</span>&nbsp;<span class="ident">derBytes</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyPath</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">tempFile</span><span class="op">(</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">pemOut</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">keyPath</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">command</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">test</span><span class="op">.</span><span class="ident">command</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">command</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">command</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">command</span><span class="op">,</span>&nbsp;<span class="ident">defaultServerCommand</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">command</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cert&#34;</span><span class="op">,</span>&nbsp;<span class="ident">certPath</span><span class="op">,</span>&nbsp;<span class="string">&#34;-certform&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;DER&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-key&#34;</span><span class="op">,</span>&nbsp;<span class="ident">keyPath</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;serverPort&nbsp;contains&nbsp;the&nbsp;port&nbsp;that&nbsp;OpenSSL&nbsp;will&nbsp;listen&nbsp;on.&nbsp;OpenSSL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;can&#39;t&nbsp;take&nbsp;&#34;0&#34;&nbsp;as&nbsp;an&nbsp;argument&nbsp;here&nbsp;so&nbsp;we&nbsp;have&nbsp;to&nbsp;pick&nbsp;a&nbsp;number&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;hope&nbsp;that&nbsp;it&#39;s&nbsp;not&nbsp;in&nbsp;use&nbsp;on&nbsp;the&nbsp;machine.&nbsp;Since&nbsp;this&nbsp;only&nbsp;occurs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;when&nbsp;-update&nbsp;is&nbsp;given&nbsp;and&nbsp;thus&nbsp;when&nbsp;there&#39;s&nbsp;a&nbsp;human&nbsp;watching&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;test,&nbsp;this&nbsp;isn&#39;t&nbsp;too&nbsp;bad.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">serverPort</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">24323</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">command</span><span class="op">,</span>&nbsp;<span class="string">&#34;-accept&#34;</span><span class="op">,</span>&nbsp;<span class="ident">strconv</span><span class="op">.</span><span class="ident">Itoa</span><span class="op">(</span><span class="ident">serverPort</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cmd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">exec</span><span class="op">.</span><span class="ident">Command</span><span class="op">(</span><span class="ident">command</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">command</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stdin</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">blockingSource</span><span class="op">(</span><span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cmd</span><span class="op">.</span><span class="ident">Stdin</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">stdin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">out</span>&nbsp;<span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cmd</span><span class="op">.</span><span class="ident">Stdout</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cmd</span><span class="op">.</span><span class="ident">Stderr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">out</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cmd</span><span class="op">.</span><span class="ident">Start</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;OpenSSL&nbsp;does&nbsp;print&nbsp;an&nbsp;&#34;ACCEPT&#34;&nbsp;banner,&nbsp;but&nbsp;it&nbsp;does&nbsp;so&nbsp;*before*</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;opening&nbsp;the&nbsp;listening&nbsp;socket,&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;use&nbsp;that&nbsp;to&nbsp;wait&nbsp;until&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;has&nbsp;started&nbsp;listening.&nbsp;Thus&nbsp;we&nbsp;are&nbsp;forced&nbsp;to&nbsp;poll&nbsp;until&nbsp;we&nbsp;get&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">tcpConn</span>&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">5</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tcpConn</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">DialTCP</span><span class="op">(</span><span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">net</span><span class="op">.</span><span class="ident">TCPAddr</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">IP</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">IPv4</span><span class="op">(</span><span class="num">127</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Port</span><span class="op">:</span>&nbsp;<span class="ident">serverPort</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">time</span><span class="op">.</span><span class="ident">Sleep</span><span class="op">(</span><span class="op">(</span><span class="num">1</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">i</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">5</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Millisecond</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tcpConn</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">close</span><span class="op">(</span><span class="ident">stdin</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">.</span><span class="ident">WriteTo</span><span class="op">(</span><span class="ident">os</span><span class="op">.</span><span class="ident">Stdout</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cmd</span><span class="op">.</span><span class="ident">Process</span><span class="op">.</span><span class="ident">Kill</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">cmd</span><span class="op">.</span><span class="ident">Wait</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">record</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">recordingConn</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Conn</span><span class="op">:</span>&nbsp;<span class="ident">tcpConn</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">record</span><span class="op">,</span>&nbsp;<span class="ident">cmd</span><span class="op">,</span>&nbsp;<span class="ident">stdin</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">test</span>&nbsp;<span class="op">*</span><span class="ident">clientTest</span><span class="op">)</span>&nbsp;<span class="ident">dataPath</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">filepath</span><span class="op">.</span><span class="ident">Join</span><span class="op">(</span><span class="string">&#34;testdata&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;Client-&#34;</span><span class="op">+</span><span class="ident">test</span><span class="op">.</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">test</span>&nbsp;<span class="op">*</span><span class="ident">clientTest</span><span class="op">)</span>&nbsp;<span class="ident">loadData</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">flows</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">in</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">Open</span><span class="op">(</span><span class="ident">test</span><span class="op">.</span><span class="ident">dataPath</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">in</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">parseTestData</span><span class="op">(</span><span class="ident">in</span><span class="op">)</span><br>
<span class="lineno">165</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">test</span>&nbsp;<span class="op">*</span><span class="ident">clientTest</span><span class="op">)</span>&nbsp;<span class="ident">run</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">write</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">clientConn</span><span class="op">,</span>&nbsp;<span class="ident">serverConn</span>&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">recordingConn</span>&nbsp;<span class="op">*</span><span class="ident">recordingConn</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">childProcess</span>&nbsp;<span class="op">*</span><span class="ident">exec</span><span class="op">.</span><span class="ident">Cmd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">stdin</span>&nbsp;<span class="ident">blockingSource</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">write</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">recordingConn</span><span class="op">,</span>&nbsp;<span class="ident">childProcess</span><span class="op">,</span>&nbsp;<span class="ident">stdin</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">connFromCommand</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Failed&nbsp;to&nbsp;start&nbsp;subcommand:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">clientConn</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">recordingConn</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">clientConn</span><span class="op">,</span>&nbsp;<span class="ident">serverConn</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">Pipe</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">config</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">config</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Client</span><span class="op">(</span><span class="ident">clientConn</span><span class="op">,</span>&nbsp;<span class="ident">config</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">doneChan</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;hello\n&#34;</span><span class="op">)</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Logf</span><span class="op">(</span><span class="string">&#34;Client.Write&nbsp;failed:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">validate</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">validate</span><span class="op">(</span><span class="ident">client</span><span class="op">.</span><span class="ident">ConnectionState</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Logf</span><span class="op">(</span><span class="string">&#34;validate&nbsp;callback&nbsp;returned&nbsp;error:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">clientConn</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">doneChan</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">write</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flows</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">loadData</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;%s:&nbsp;failed&nbsp;to&nbsp;load&nbsp;data&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">dataPath</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">flows</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span><span class="op">%</span><span class="num">2</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">serverConn</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bb</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">serverConn</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;#%d:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">bytes</span><span class="op">.</span><span class="ident">Equal</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;#%d:&nbsp;mismatch&nbsp;on&nbsp;read:&nbsp;got:%x&nbsp;want:%x&#34;</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">bb</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">serverConn</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&lt;-</span><span class="ident">doneChan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">write</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">path</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">dataPath</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">OpenFile</span><span class="op">(</span><span class="ident">path</span><span class="op">,</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">O_WRONLY</span><span class="op">|</span><span class="ident">os</span><span class="op">.</span><span class="ident">O_CREATE</span><span class="op">|</span><span class="ident">os</span><span class="op">.</span><span class="ident">O_TRUNC</span><span class="op">,</span>&nbsp;<span class="num">0644</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Failed&nbsp;to&nbsp;create&nbsp;output&nbsp;file:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">out</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">recordingConn</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">close</span><span class="op">(</span><span class="ident">stdin</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">childProcess</span><span class="op">.</span><span class="ident">Process</span><span class="op">.</span><span class="ident">Kill</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">childProcess</span><span class="op">.</span><span class="ident">Wait</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">recordingConn</span><span class="op">.</span><span class="ident">flows</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">3</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">childProcess</span><span class="op">.</span><span class="ident">Stdout</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><span class="op">)</span><span class="op">.</span><span class="ident">WriteTo</span><span class="op">(</span><span class="ident">os</span><span class="op">.</span><span class="ident">Stdout</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Client&nbsp;connection&nbsp;didn&#39;t&nbsp;work&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">recordingConn</span><span class="op">.</span><span class="ident">WriteTo</span><span class="op">(</span><span class="ident">out</span><span class="op">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Printf</span><span class="op">(</span><span class="string">&#34;Wrote&nbsp;%s\n&#34;</span><span class="op">,</span>&nbsp;<span class="ident">path</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">runClientTestForVersion</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">template</span>&nbsp;<span class="op">*</span><span class="ident">clientTest</span><span class="op">,</span>&nbsp;<span class="ident">prefix</span><span class="op">,</span>&nbsp;<span class="ident">option</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="ident">template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span><span class="op">.</span><span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">prefix</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">test</span><span class="op">.</span><span class="ident">command</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span><span class="op">.</span><span class="ident">command</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">defaultClientCommand</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span><span class="op">.</span><span class="ident">command</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">command</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span><span class="op">.</span><span class="ident">command</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">test</span><span class="op">.</span><span class="ident">command</span><span class="op">,</span>&nbsp;<span class="ident">option</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span><span class="op">.</span><span class="ident">run</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">update</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword">func</span>&nbsp;<span class="ident">runClientTestTLS10</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">template</span>&nbsp;<span class="op">*</span><span class="ident">clientTest</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestForVersion</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">template</span><span class="op">,</span>&nbsp;<span class="string">&#34;TLSv10-&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-tls1&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">runClientTestTLS11</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">template</span>&nbsp;<span class="op">*</span><span class="ident">clientTest</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestForVersion</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">template</span><span class="op">,</span>&nbsp;<span class="string">&#34;TLSv11-&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-tls1_1&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">template</span>&nbsp;<span class="op">*</span><span class="ident">clientTest</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestForVersion</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">template</span><span class="op">,</span>&nbsp;<span class="string">&#34;TLSv12-&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-tls1_2&#34;</span><span class="op">)</span><br>
<span class="lineno">270</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestHandshakeClientRSARC4</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;RSA-RC4&#34;</span><span class="op">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cipher&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;RC4-SHA&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS10</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS11</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno">280</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestHandshakeClientECDHERSAAES</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;ECDHE-RSA-AES&#34;</span><span class="op">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cipher&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ECDHE-RSA-AES128-SHA&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS10</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS11</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno">290</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestHandshakeClientECDHEECDSAAES</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;ECDHE-ECDSA-AES&#34;</span><span class="op">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cipher&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">testECDSACertificate</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">testECDSAPrivateKey</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS10</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS11</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestHandshakeClientECDHEECDSAAESGCM</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;ECDHE-ECDSA-AES-GCM&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cipher&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ECDHE-ECDSA-AES128-GCM-SHA256&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">testECDSACertificate</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">testECDSAPrivateKey</span><span class="op">,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestHandshakeClientCertRSA</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="ident">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">X509KeyPair</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">clientCertificatePEM</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">clientKeyPEM</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">.</span><span class="ident">Certificates</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">Certificate</span><span class="op">{</span><span class="ident">cert</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;ClientCert-RSA-RSA&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cipher&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;RC4-SHA&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-verify&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">:</span>&nbsp;&nbsp;<span class="op">&amp;</span><span class="ident">config</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS10</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;ClientCert-RSA-ECDSA&#34;</span><span class="op">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cipher&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-verify&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">:</span>&nbsp;&nbsp;<span class="op">&amp;</span><span class="ident">config</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">testECDSACertificate</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">testECDSAPrivateKey</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS10</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="keyword">func</span>&nbsp;<span class="ident">TestHandshakeClientCertECDSA</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="ident">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">X509KeyPair</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">clientECDSACertificatePEM</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">clientECDSAKeyPEM</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">.</span><span class="ident">Certificates</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">Certificate</span><span class="op">{</span><span class="ident">cert</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;ClientCert-ECDSA-RSA&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cipher&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;RC4-SHA&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-verify&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">:</span>&nbsp;&nbsp;<span class="op">&amp;</span><span class="ident">config</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS10</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;ClientCert-ECDSA-ECDSA&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-cipher&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-verify&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">:</span>&nbsp;&nbsp;<span class="op">&amp;</span><span class="ident">config</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cert</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">testECDSACertificate</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">testECDSAPrivateKey</span><span class="op">,</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS10</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestClientResumption</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">serverConfig</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">Config</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">CipherSuites</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint16</span><span class="op">{</span><span class="ident">TLS_RSA_WITH_RC4_128_SHA</span><span class="op">,</span>&nbsp;<span class="ident">TLS_ECDHE_RSA_WITH_RC4_128_SHA</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Certificates</span><span class="op">:</span>&nbsp;<span class="ident">testConfig</span><span class="op">.</span><span class="ident">Certificates</span><span class="op">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">clientConfig</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">Config</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">CipherSuites</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint16</span><span class="op">{</span><span class="ident">TLS_RSA_WITH_RC4_128_SHA</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">InsecureSkipVerify</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ClientSessionCache</span><span class="op">:</span>&nbsp;<span class="ident">NewLRUClientSessionCache</span><span class="op">(</span><span class="num">32</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testResumeState</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">test</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">didResume</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hs</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">testHandshake</span><span class="op">(</span><span class="ident">clientConfig</span><span class="op">,</span>&nbsp;<span class="ident">serverConfig</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;%s:&nbsp;handshake&nbsp;failed:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">hs</span><span class="op">.</span><span class="ident">DidResume</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">didResume</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;resumed:&nbsp;%v,&nbsp;expected:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">,</span>&nbsp;<span class="ident">hs</span><span class="op">.</span><span class="ident">DidResume</span><span class="op">,</span>&nbsp;<span class="ident">didResume</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testResumeState</span><span class="op">(</span><span class="string">&#34;Handshake&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testResumeState</span><span class="op">(</span><span class="string">&#34;Resume&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">serverConfig</span><span class="op">.</span><span class="ident">rand</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">serverConfig</span><span class="op">.</span><span class="ident">SessionTicketKey</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Failed&nbsp;to&nbsp;invalidate&nbsp;SessionTicketKey&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testResumeState</span><span class="op">(</span><span class="string">&#34;InvalidSessionTicketKey&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testResumeState</span><span class="op">(</span><span class="string">&#34;ResumeAfterInvalidSessionTicketKey&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">clientConfig</span><span class="op">.</span><span class="ident">CipherSuites</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint16</span><span class="op">{</span><span class="ident">TLS_ECDHE_RSA_WITH_RC4_128_SHA</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testResumeState</span><span class="op">(</span><span class="string">&#34;DifferentCipherSuite&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testResumeState</span><span class="op">(</span><span class="string">&#34;DifferentCipherSuiteRecovers&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">clientConfig</span><span class="op">.</span><span class="ident">ClientSessionCache</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testResumeState</span><span class="op">(</span><span class="string">&#34;WithoutSessionCache&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestLRUClientSessionCache</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Initialize&nbsp;cache&nbsp;of&nbsp;capacity&nbsp;4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cache</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">NewLRUClientSessionCache</span><span class="op">(</span><span class="num">4</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">ClientSessionState</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keys</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;0&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;1&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;2&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;3&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;5&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;6&#34;</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Add&nbsp;4&nbsp;entries&nbsp;to&nbsp;the&nbsp;cache&nbsp;and&nbsp;look&nbsp;them&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cache</span><span class="op">.</span><span class="ident">Put</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cs</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cache</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="op">&amp;</span><span class="ident">cs</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;session&nbsp;cache&nbsp;failed&nbsp;lookup&nbsp;for&nbsp;added&nbsp;key:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">keys</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Add&nbsp;2&nbsp;more&nbsp;entries&nbsp;to&nbsp;the&nbsp;cache.&nbsp;First&nbsp;2&nbsp;should&nbsp;be&nbsp;evicted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">6</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cache</span><span class="op">.</span><span class="ident">Put</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cs</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cache</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;session&nbsp;cache&nbsp;should&nbsp;have&nbsp;evicted&nbsp;key:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">keys</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Touch&nbsp;entry&nbsp;2.&nbsp;LRU&nbsp;should&nbsp;evict&nbsp;3&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cache</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cache</span><span class="op">.</span><span class="ident">Put</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cs</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cache</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="num">3</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;session&nbsp;cache&nbsp;should&nbsp;have&nbsp;evicted&nbsp;key&nbsp;3&#34;</span><span class="op">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Update&nbsp;entry&nbsp;0&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cache</span><span class="op">.</span><span class="ident">Put</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cs</span><span class="op">[</span><span class="num">3</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cache</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="op">&amp;</span><span class="ident">cs</span><span class="op">[</span><span class="num">3</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;session&nbsp;cache&nbsp;failed&nbsp;update&nbsp;for&nbsp;key&nbsp;0&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Adding&nbsp;a&nbsp;nil&nbsp;entry&nbsp;is&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cache</span><span class="op">.</span><span class="ident">Put</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cache</span><span class="op">.</span><span class="ident">Get</span><span class="op">(</span><span class="ident">keys</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;failed&nbsp;to&nbsp;add&nbsp;nil&nbsp;entry&nbsp;to&nbsp;cache&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span><span class="keyword">func</span>&nbsp;<span class="ident">TestHandshakeClientALPNMatch</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="ident">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">.</span><span class="ident">NextProtos</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;proto2&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;proto1&#34;</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;<span class="string">&#34;ALPN&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Note&nbsp;that&nbsp;this&nbsp;needs&nbsp;OpenSSL&nbsp;1.0.2&nbsp;because&nbsp;that&nbsp;is&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;version&nbsp;that&nbsp;supports&nbsp;the&nbsp;-alpn&nbsp;flag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-alpn&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;proto1,proto2&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">:</span>&nbsp;&nbsp;<span class="op">&amp;</span><span class="ident">config</span><span class="op">,</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">validate</span><span class="op">:</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="ident">ConnectionState</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;server&#39;s&nbsp;preferences&nbsp;should&nbsp;override&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">NegotiatedProtocol</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;proto1&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;Got&nbsp;protocol&nbsp;%q,&nbsp;wanted&nbsp;proto1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">NegotiatedProtocol</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestHandshakeClientALPNNoMatch</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="ident">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">.</span><span class="ident">NextProtos</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;proto3&#34;</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">clientTest</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">:</span>&nbsp;<span class="string">&#34;ALPN-NoMatch&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Note&nbsp;that&nbsp;this&nbsp;needs&nbsp;OpenSSL&nbsp;1.0.2&nbsp;because&nbsp;that&nbsp;is&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;version&nbsp;that&nbsp;supports&nbsp;the&nbsp;-alpn&nbsp;flag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">command</span><span class="op">:</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;openssl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;s_server&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;-alpn&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;proto1,proto2&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">config</span><span class="op">:</span>&nbsp;&nbsp;<span class="op">&amp;</span><span class="ident">config</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">validate</span><span class="op">:</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="ident">ConnectionState</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;There&#39;s&nbsp;no&nbsp;overlap&nbsp;so&nbsp;OpenSSL&nbsp;will&nbsp;not&nbsp;select&nbsp;a&nbsp;protocol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">NegotiatedProtocol</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;Got&nbsp;protocol&nbsp;%q,&nbsp;wanted&nbsp;&#39;&#39;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">NegotiatedProtocol</span><span class="op">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runClientTestTLS12</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">)</span><br>
<span class="lineno">490</span><span class="op">}</span>
</div>
</body>
</html>
