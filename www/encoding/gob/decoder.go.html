<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3174102">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3174157">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3174211">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3174262">package</span>&nbsp;<span class="ident" id="3174270">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3174275">import</span>&nbsp;<span class="op" id="3174282">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3174285">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3174294">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3174304">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3174310">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3174321">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3174328">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="3174331">//&nbsp;tooBig&nbsp;provides&nbsp;a&nbsp;sanity&nbsp;check&nbsp;for&nbsp;sizes;&nbsp;used&nbsp;in&nbsp;several&nbsp;places.</span><br>
<span class="lineno"></span><span class="comment" id="3174400">//&nbsp;Upper&nbsp;limit&nbsp;of&nbsp;1GB,&nbsp;allowing&nbsp;room&nbsp;to&nbsp;grow&nbsp;a&nbsp;little&nbsp;without&nbsp;overflow.</span><br>
<span class="lineno"></span><span class="comment" id="3174472">//&nbsp;TODO:&nbsp;make&nbsp;this&nbsp;adjustable?</span><br>
<span class="lineno"></span><span class="keyword" id="3174503">const</span>&nbsp;<span class="ident" id="3174509">tooBig</span>&nbsp;<span class="op" id="3174516">=</span>&nbsp;<span class="num" id="3174518">1</span>&nbsp;<span class="op" id="3174520">&lt;&lt;</span>&nbsp;<span class="num" id="3174523">30</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="3174527">//&nbsp;A&nbsp;Decoder&nbsp;manages&nbsp;the&nbsp;receipt&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;read&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3174603">//&nbsp;remote&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3174635">type</span>&nbsp;<span class="ident" id="3174640">Decoder</span>&nbsp;<span class="keyword" id="3174648">struct</span>&nbsp;<span class="op" id="3174655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174658">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3174671">sync</span><span class="op" id="3174675">.</span><span class="ident" id="3174676">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3174711">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;received&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174753">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3174766">io</span><span class="op" id="3174768">.</span><span class="ident" id="3174769">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3174806">//&nbsp;source&nbsp;of&nbsp;the&nbsp;data</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174829">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3174842">decBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3174882">//&nbsp;buffer&nbsp;for&nbsp;more&nbsp;efficient&nbsp;i/o&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174923">wireType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3174936">map</span><span class="op" id="3174939">[</span><span class="ident" id="3174940">typeId</span><span class="op" id="3174946">]</span><span class="op" id="3174947">*</span><span class="ident" id="3174948">wireType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3174976">//&nbsp;map&nbsp;from&nbsp;remote&nbsp;ID&nbsp;to&nbsp;local&nbsp;description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175020">decoderCache</span>&nbsp;<span class="keyword" id="3175033">map</span><span class="op" id="3175036">[</span><span class="ident" id="3175037">reflect</span><span class="op" id="3175044">.</span><span class="ident" id="3175045">Type</span><span class="op" id="3175049">]</span><span class="keyword" id="3175050">map</span><span class="op" id="3175053">[</span><span class="ident" id="3175054">typeId</span><span class="op" id="3175060">]</span><span class="op" id="3175061">*</span><span class="op" id="3175062">*</span><span class="ident" id="3175063">decEngine</span>&nbsp;<span class="comment" id="3175073">//&nbsp;cache&nbsp;of&nbsp;compiled&nbsp;engines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175103">ignorerCache</span>&nbsp;<span class="keyword" id="3175116">map</span><span class="op" id="3175119">[</span><span class="ident" id="3175120">typeId</span><span class="op" id="3175126">]</span><span class="op" id="3175127">*</span><span class="op" id="3175128">*</span><span class="ident" id="3175129">decEngine</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3175156">//&nbsp;ditto&nbsp;for&nbsp;ignored&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175186">freeList</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3175199">*</span><span class="ident" id="3175200">decoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3175239">//&nbsp;list&nbsp;of&nbsp;free&nbsp;decoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175291">countBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3175304">[</span><span class="op" id="3175305">]</span><span class="builtintype" id="3175306">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3175344">//&nbsp;used&nbsp;for&nbsp;decoding&nbsp;integers&nbsp;while&nbsp;parsing&nbsp;messages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175398">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3175411">error</span><br>
<span class="lineno"></span><span class="op" id="3175417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3175420">//&nbsp;NewDecoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;decoder&nbsp;that&nbsp;reads&nbsp;from&nbsp;the&nbsp;io.Reader.</span><br>
<span class="lineno">35</span><span class="comment" id="3175487">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,&nbsp;it&nbsp;will&nbsp;be&nbsp;wrapped&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3175558">//&nbsp;bufio.Reader.</span><br>
<span class="lineno"></span><span class="keyword" id="3175575">func</span>&nbsp;<span class="ident" id="3175580">NewDecoder</span><span class="op" id="3175590">(</span><span class="ident" id="3175591">r</span>&nbsp;<span class="ident" id="3175593">io</span><span class="op" id="3175595">.</span><span class="ident" id="3175596">Reader</span><span class="op" id="3175602">)</span>&nbsp;<span class="op" id="3175604">*</span><span class="ident" id="3175605">Decoder</span>&nbsp;<span class="op" id="3175613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175616">dec</span>&nbsp;<span class="op" id="3175620">:=</span>&nbsp;<span class="builtinfunc" id="3175623">new</span><span class="op" id="3175626">(</span><span class="ident" id="3175627">Decoder</span><span class="op" id="3175634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175637">//&nbsp;We&nbsp;use&nbsp;the&nbsp;ability&nbsp;to&nbsp;read&nbsp;bytes&nbsp;as&nbsp;a&nbsp;plausible&nbsp;surrogate&nbsp;for&nbsp;buffering.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175714">if</span>&nbsp;<span class="ident" id="3175717">_</span><span class="op" id="3175718">,</span>&nbsp;<span class="ident" id="3175720">ok</span>&nbsp;<span class="op" id="3175723">:=</span>&nbsp;<span class="ident" id="3175726">r</span><span class="op" id="3175727">.</span><span class="op" id="3175728">(</span><span class="ident" id="3175729">io</span><span class="op" id="3175731">.</span><span class="ident" id="3175732">ByteReader</span><span class="op" id="3175742">)</span><span class="op" id="3175743">;</span>&nbsp;<span class="op" id="3175745">!</span><span class="ident" id="3175746">ok</span>&nbsp;<span class="op" id="3175749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175753">r</span>&nbsp;<span class="op" id="3175755">=</span>&nbsp;<span class="ident" id="3175757">bufio</span><span class="op" id="3175762">.</span><span class="ident" id="3175763">NewReader</span><span class="op" id="3175772">(</span><span class="ident" id="3175773">r</span><span class="op" id="3175774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175780">dec</span><span class="op" id="3175783">.</span><span class="ident" id="3175784">r</span>&nbsp;<span class="op" id="3175786">=</span>&nbsp;<span class="ident" id="3175788">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175791">dec</span><span class="op" id="3175794">.</span><span class="ident" id="3175795">wireType</span>&nbsp;<span class="op" id="3175804">=</span>&nbsp;<span class="builtinfunc" id="3175806">make</span><span class="op" id="3175810">(</span><span class="keyword" id="3175811">map</span><span class="op" id="3175814">[</span><span class="ident" id="3175815">typeId</span><span class="op" id="3175821">]</span><span class="op" id="3175822">*</span><span class="ident" id="3175823">wireType</span><span class="op" id="3175831">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175834">dec</span><span class="op" id="3175837">.</span><span class="ident" id="3175838">decoderCache</span>&nbsp;<span class="op" id="3175851">=</span>&nbsp;<span class="builtinfunc" id="3175853">make</span><span class="op" id="3175857">(</span><span class="keyword" id="3175858">map</span><span class="op" id="3175861">[</span><span class="ident" id="3175862">reflect</span><span class="op" id="3175869">.</span><span class="ident" id="3175870">Type</span><span class="op" id="3175874">]</span><span class="keyword" id="3175875">map</span><span class="op" id="3175878">[</span><span class="ident" id="3175879">typeId</span><span class="op" id="3175885">]</span><span class="op" id="3175886">*</span><span class="op" id="3175887">*</span><span class="ident" id="3175888">decEngine</span><span class="op" id="3175897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175900">dec</span><span class="op" id="3175903">.</span><span class="ident" id="3175904">ignorerCache</span>&nbsp;<span class="op" id="3175917">=</span>&nbsp;<span class="builtinfunc" id="3175919">make</span><span class="op" id="3175923">(</span><span class="keyword" id="3175924">map</span><span class="op" id="3175927">[</span><span class="ident" id="3175928">typeId</span><span class="op" id="3175934">]</span><span class="op" id="3175935">*</span><span class="op" id="3175936">*</span><span class="ident" id="3175937">decEngine</span><span class="op" id="3175946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175949">dec</span><span class="op" id="3175952">.</span><span class="ident" id="3175953">countBuf</span>&nbsp;<span class="op" id="3175962">=</span>&nbsp;<span class="builtinfunc" id="3175964">make</span><span class="op" id="3175968">(</span><span class="op" id="3175969">[</span><span class="op" id="3175970">]</span><span class="builtintype" id="3175971">byte</span><span class="op" id="3175975">,</span>&nbsp;<span class="num" id="3175977">9</span><span class="op" id="3175978">)</span>&nbsp;<span class="comment" id="3175980">//&nbsp;counts&nbsp;may&nbsp;be&nbsp;uint64s&nbsp;(unlikely!),&nbsp;require&nbsp;9&nbsp;bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176036">return</span>&nbsp;<span class="ident" id="3176043">dec</span><br>
<span class="lineno">50</span><span class="op" id="3176047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3176050">//&nbsp;recvType&nbsp;loads&nbsp;the&nbsp;definition&nbsp;of&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3176094">func</span>&nbsp;<span class="op" id="3176099">(</span><span class="ident" id="3176100">dec</span>&nbsp;<span class="op" id="3176104">*</span><span class="ident" id="3176105">Decoder</span><span class="op" id="3176112">)</span>&nbsp;<span class="ident" id="3176114">recvType</span><span class="op" id="3176122">(</span><span class="ident" id="3176123">id</span>&nbsp;<span class="ident" id="3176126">typeId</span><span class="op" id="3176132">)</span>&nbsp;<span class="op" id="3176134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176137">//&nbsp;Have&nbsp;we&nbsp;already&nbsp;seen&nbsp;this&nbsp;type?&nbsp;&nbsp;That&#39;s&nbsp;an&nbsp;error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176190">if</span>&nbsp;<span class="ident" id="3176193">id</span>&nbsp;<span class="op" id="3176196">&lt;</span>&nbsp;<span class="ident" id="3176198">firstUserId</span>&nbsp;<span class="op" id="3176210">||</span>&nbsp;<span class="ident" id="3176213">dec</span><span class="op" id="3176216">.</span><span class="ident" id="3176217">wireType</span><span class="op" id="3176225">[</span><span class="ident" id="3176226">id</span><span class="op" id="3176228">]</span>&nbsp;<span class="op" id="3176230">!=</span>&nbsp;<span class="ident" id="3176233">nil</span>&nbsp;<span class="op" id="3176237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176241">dec</span><span class="op" id="3176244">.</span><span class="ident" id="3176245">err</span>&nbsp;<span class="op" id="3176249">=</span>&nbsp;<span class="ident" id="3176251">errors</span><span class="op" id="3176257">.</span><span class="ident" id="3176258">New</span><span class="op" id="3176261">(</span><span class="string" id="3176262">&#34;gob:&nbsp;duplicate&nbsp;type&nbsp;received&#34;</span><span class="op" id="3176292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176296">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176308">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176318">wire</span>&nbsp;<span class="op" id="3176323">:=</span>&nbsp;<span class="builtinfunc" id="3176326">new</span><span class="op" id="3176329">(</span><span class="ident" id="3176330">wireType</span><span class="op" id="3176338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176341">dec</span><span class="op" id="3176344">.</span><span class="ident" id="3176345">decodeValue</span><span class="op" id="3176356">(</span><span class="ident" id="3176357">tWireType</span><span class="op" id="3176366">,</span>&nbsp;<span class="ident" id="3176368">reflect</span><span class="op" id="3176375">.</span><span class="ident" id="3176376">ValueOf</span><span class="op" id="3176383">(</span><span class="ident" id="3176384">wire</span><span class="op" id="3176388">)</span><span class="op" id="3176389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176392">if</span>&nbsp;<span class="ident" id="3176395">dec</span><span class="op" id="3176398">.</span><span class="ident" id="3176399">err</span>&nbsp;<span class="op" id="3176403">!=</span>&nbsp;<span class="ident" id="3176406">nil</span>&nbsp;<span class="op" id="3176410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176414">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176425">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;seen&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176460">dec</span><span class="op" id="3176463">.</span><span class="ident" id="3176464">wireType</span><span class="op" id="3176472">[</span><span class="ident" id="3176473">id</span><span class="op" id="3176475">]</span>&nbsp;<span class="op" id="3176477">=</span>&nbsp;<span class="ident" id="3176479">wire</span><br>
<span class="lineno"></span><span class="op" id="3176484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3176487">var</span>&nbsp;<span class="ident" id="3176491">errBadCount</span>&nbsp;<span class="op" id="3176503">=</span>&nbsp;<span class="ident" id="3176505">errors</span><span class="op" id="3176511">.</span><span class="ident" id="3176512">New</span><span class="op" id="3176515">(</span><span class="string" id="3176516">&#34;invalid&nbsp;message&nbsp;length&#34;</span><span class="op" id="3176540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3176543">//&nbsp;recvMessage&nbsp;reads&nbsp;the&nbsp;next&nbsp;count-delimited&nbsp;item&nbsp;from&nbsp;the&nbsp;input.&nbsp;It&nbsp;is&nbsp;the&nbsp;converse</span><br>
<span class="lineno"></span><span class="comment" id="3176629">//&nbsp;of&nbsp;Encoder.writeMessage.&nbsp;It&nbsp;returns&nbsp;false&nbsp;on&nbsp;EOF&nbsp;or&nbsp;other&nbsp;error&nbsp;reading&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span><span class="keyword" id="3176717">func</span>&nbsp;<span class="op" id="3176722">(</span><span class="ident" id="3176723">dec</span>&nbsp;<span class="op" id="3176727">*</span><span class="ident" id="3176728">Decoder</span><span class="op" id="3176735">)</span>&nbsp;<span class="ident" id="3176737">recvMessage</span><span class="op" id="3176748">(</span><span class="op" id="3176749">)</span>&nbsp;<span class="builtintype" id="3176751">bool</span>&nbsp;<span class="op" id="3176756">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3176759">//&nbsp;Read&nbsp;a&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176777">nbytes</span><span class="op" id="3176783">,</span>&nbsp;<span class="ident" id="3176785">_</span><span class="op" id="3176786">,</span>&nbsp;<span class="ident" id="3176788">err</span>&nbsp;<span class="op" id="3176792">:=</span>&nbsp;<span class="ident" id="3176795">decodeUintReader</span><span class="op" id="3176811">(</span><span class="ident" id="3176812">dec</span><span class="op" id="3176815">.</span><span class="ident" id="3176816">r</span><span class="op" id="3176817">,</span>&nbsp;<span class="ident" id="3176819">dec</span><span class="op" id="3176822">.</span><span class="ident" id="3176823">countBuf</span><span class="op" id="3176831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176834">if</span>&nbsp;<span class="ident" id="3176837">err</span>&nbsp;<span class="op" id="3176841">!=</span>&nbsp;<span class="ident" id="3176844">nil</span>&nbsp;<span class="op" id="3176848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176852">dec</span><span class="op" id="3176855">.</span><span class="ident" id="3176856">err</span>&nbsp;<span class="op" id="3176860">=</span>&nbsp;<span class="ident" id="3176862">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176868">return</span>&nbsp;<span class="ident" id="3176875">false</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176885">if</span>&nbsp;<span class="ident" id="3176888">nbytes</span>&nbsp;<span class="op" id="3176895">&gt;=</span>&nbsp;<span class="ident" id="3176898">tooBig</span>&nbsp;<span class="op" id="3176905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176909">dec</span><span class="op" id="3176912">.</span><span class="ident" id="3176913">err</span>&nbsp;<span class="op" id="3176917">=</span>&nbsp;<span class="ident" id="3176919">errBadCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176933">return</span>&nbsp;<span class="ident" id="3176940">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176947">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176950">dec</span><span class="op" id="3176953">.</span><span class="ident" id="3176954">readMessage</span><span class="op" id="3176965">(</span><span class="builtintype" id="3176966">int</span><span class="op" id="3176969">(</span><span class="ident" id="3176970">nbytes</span><span class="op" id="3176976">)</span><span class="op" id="3176977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176980">return</span>&nbsp;<span class="ident" id="3176987">dec</span><span class="op" id="3176990">.</span><span class="ident" id="3176991">err</span>&nbsp;<span class="op" id="3176995">==</span>&nbsp;<span class="ident" id="3176998">nil</span><br>
<span class="lineno"></span><span class="op" id="3177002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3177005">//&nbsp;readMessage&nbsp;reads&nbsp;the&nbsp;next&nbsp;nbytes&nbsp;bytes&nbsp;from&nbsp;the&nbsp;input.</span><br>
<span class="lineno">90</span><span class="keyword" id="3177064">func</span>&nbsp;<span class="op" id="3177069">(</span><span class="ident" id="3177070">dec</span>&nbsp;<span class="op" id="3177074">*</span><span class="ident" id="3177075">Decoder</span><span class="op" id="3177082">)</span>&nbsp;<span class="ident" id="3177084">readMessage</span><span class="op" id="3177095">(</span><span class="ident" id="3177096">nbytes</span>&nbsp;<span class="builtintype" id="3177103">int</span><span class="op" id="3177106">)</span>&nbsp;<span class="op" id="3177108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177111">if</span>&nbsp;<span class="ident" id="3177114">dec</span><span class="op" id="3177117">.</span><span class="ident" id="3177118">buf</span><span class="op" id="3177121">.</span><span class="ident" id="3177122">Len</span><span class="op" id="3177125">(</span><span class="op" id="3177126">)</span>&nbsp;<span class="op" id="3177128">!=</span>&nbsp;<span class="num" id="3177131">0</span>&nbsp;<span class="op" id="3177133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3177137">//&nbsp;The&nbsp;buffer&nbsp;should&nbsp;always&nbsp;be&nbsp;empty&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3177181">panic</span><span class="op" id="3177186">(</span><span class="string" id="3177187">&#34;non-empty&nbsp;decoder&nbsp;buffer&#34;</span><span class="op" id="3177213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177216">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3177219">//&nbsp;Read&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177237">dec</span><span class="op" id="3177240">.</span><span class="ident" id="3177241">buf</span><span class="op" id="3177244">.</span><span class="ident" id="3177245">Size</span><span class="op" id="3177249">(</span><span class="ident" id="3177250">nbytes</span><span class="op" id="3177256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177259">_</span><span class="op" id="3177260">,</span>&nbsp;<span class="ident" id="3177262">dec</span><span class="op" id="3177265">.</span><span class="ident" id="3177266">err</span>&nbsp;<span class="op" id="3177270">=</span>&nbsp;<span class="ident" id="3177272">io</span><span class="op" id="3177274">.</span><span class="ident" id="3177275">ReadFull</span><span class="op" id="3177283">(</span><span class="ident" id="3177284">dec</span><span class="op" id="3177287">.</span><span class="ident" id="3177288">r</span><span class="op" id="3177289">,</span>&nbsp;<span class="ident" id="3177291">dec</span><span class="op" id="3177294">.</span><span class="ident" id="3177295">buf</span><span class="op" id="3177298">.</span><span class="ident" id="3177299">Bytes</span><span class="op" id="3177304">(</span><span class="op" id="3177305">)</span><span class="op" id="3177306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177309">if</span>&nbsp;<span class="ident" id="3177312">dec</span><span class="op" id="3177315">.</span><span class="ident" id="3177316">err</span>&nbsp;<span class="op" id="3177320">!=</span>&nbsp;<span class="ident" id="3177323">nil</span>&nbsp;<span class="op" id="3177327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177331">if</span>&nbsp;<span class="ident" id="3177334">dec</span><span class="op" id="3177337">.</span><span class="ident" id="3177338">err</span>&nbsp;<span class="op" id="3177342">==</span>&nbsp;<span class="ident" id="3177345">io</span><span class="op" id="3177347">.</span><span class="ident" id="3177348">EOF</span>&nbsp;<span class="op" id="3177352">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177357">dec</span><span class="op" id="3177360">.</span><span class="ident" id="3177361">err</span>&nbsp;<span class="op" id="3177365">=</span>&nbsp;<span class="ident" id="3177367">io</span><span class="op" id="3177369">.</span><span class="ident" id="3177370">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177392">}</span><br>
<span class="lineno"></span><span class="op" id="3177394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3177397">//&nbsp;toInt&nbsp;turns&nbsp;an&nbsp;encoded&nbsp;uint64&nbsp;into&nbsp;an&nbsp;int,&nbsp;according&nbsp;to&nbsp;the&nbsp;marshaling&nbsp;rules.</span><br>
<span class="lineno"></span><span class="keyword" id="3177478">func</span>&nbsp;<span class="ident" id="3177483">toInt</span><span class="op" id="3177488">(</span><span class="ident" id="3177489">x</span>&nbsp;<span class="ident" id="3177491">uint64</span><span class="op" id="3177497">)</span>&nbsp;<span class="ident" id="3177499">int64</span>&nbsp;<span class="op" id="3177505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177508">i</span>&nbsp;<span class="op" id="3177510">:=</span>&nbsp;<span class="ident" id="3177513">int64</span><span class="op" id="3177518">(</span><span class="ident" id="3177519">x</span>&nbsp;<span class="op" id="3177521">&gt;&gt;</span>&nbsp;<span class="num" id="3177524">1</span><span class="op" id="3177525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177528">if</span>&nbsp;<span class="ident" id="3177531">x</span><span class="op" id="3177532">&amp;</span><span class="num" id="3177533">1</span>&nbsp;<span class="op" id="3177535">!=</span>&nbsp;<span class="num" id="3177538">0</span>&nbsp;<span class="op" id="3177540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177544">i</span>&nbsp;<span class="op" id="3177546">=</span>&nbsp;<span class="op" id="3177548">^</span><span class="ident" id="3177549">i</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177555">return</span>&nbsp;<span class="ident" id="3177562">i</span><br>
<span class="lineno"></span><span class="op" id="3177564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3177567">func</span>&nbsp;<span class="op" id="3177572">(</span><span class="ident" id="3177573">dec</span>&nbsp;<span class="op" id="3177577">*</span><span class="ident" id="3177578">Decoder</span><span class="op" id="3177585">)</span>&nbsp;<span class="ident" id="3177587">nextInt</span><span class="op" id="3177594">(</span><span class="op" id="3177595">)</span>&nbsp;<span class="ident" id="3177597">int64</span>&nbsp;<span class="op" id="3177603">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177606">n</span><span class="op" id="3177607">,</span>&nbsp;<span class="ident" id="3177609">_</span><span class="op" id="3177610">,</span>&nbsp;<span class="ident" id="3177612">err</span>&nbsp;<span class="op" id="3177616">:=</span>&nbsp;<span class="ident" id="3177619">decodeUintReader</span><span class="op" id="3177635">(</span><span class="op" id="3177636">&amp;</span><span class="ident" id="3177637">dec</span><span class="op" id="3177640">.</span><span class="ident" id="3177641">buf</span><span class="op" id="3177644">,</span>&nbsp;<span class="ident" id="3177646">dec</span><span class="op" id="3177649">.</span><span class="ident" id="3177650">countBuf</span><span class="op" id="3177658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177661">if</span>&nbsp;<span class="ident" id="3177664">err</span>&nbsp;<span class="op" id="3177668">!=</span>&nbsp;<span class="ident" id="3177671">nil</span>&nbsp;<span class="op" id="3177675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177679">dec</span><span class="op" id="3177682">.</span><span class="ident" id="3177683">err</span>&nbsp;<span class="op" id="3177687">=</span>&nbsp;<span class="ident" id="3177689">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177697">return</span>&nbsp;<span class="ident" id="3177704">toInt</span><span class="op" id="3177709">(</span><span class="ident" id="3177710">n</span><span class="op" id="3177711">)</span><br>
<span class="lineno">120</span><span class="op" id="3177713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3177716">func</span>&nbsp;<span class="op" id="3177721">(</span><span class="ident" id="3177722">dec</span>&nbsp;<span class="op" id="3177726">*</span><span class="ident" id="3177727">Decoder</span><span class="op" id="3177734">)</span>&nbsp;<span class="ident" id="3177736">nextUint</span><span class="op" id="3177744">(</span><span class="op" id="3177745">)</span>&nbsp;<span class="ident" id="3177747">uint64</span>&nbsp;<span class="op" id="3177754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177757">n</span><span class="op" id="3177758">,</span>&nbsp;<span class="ident" id="3177760">_</span><span class="op" id="3177761">,</span>&nbsp;<span class="ident" id="3177763">err</span>&nbsp;<span class="op" id="3177767">:=</span>&nbsp;<span class="ident" id="3177770">decodeUintReader</span><span class="op" id="3177786">(</span><span class="op" id="3177787">&amp;</span><span class="ident" id="3177788">dec</span><span class="op" id="3177791">.</span><span class="ident" id="3177792">buf</span><span class="op" id="3177795">,</span>&nbsp;<span class="ident" id="3177797">dec</span><span class="op" id="3177800">.</span><span class="ident" id="3177801">countBuf</span><span class="op" id="3177809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177812">if</span>&nbsp;<span class="ident" id="3177815">err</span>&nbsp;<span class="op" id="3177819">!=</span>&nbsp;<span class="ident" id="3177822">nil</span>&nbsp;<span class="op" id="3177826">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177830">dec</span><span class="op" id="3177833">.</span><span class="ident" id="3177834">err</span>&nbsp;<span class="op" id="3177838">=</span>&nbsp;<span class="ident" id="3177840">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177848">return</span>&nbsp;<span class="ident" id="3177855">n</span><br>
<span class="lineno"></span><span class="op" id="3177857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="3177860">//&nbsp;decodeTypeSequence&nbsp;parses:</span><br>
<span class="lineno"></span><span class="comment" id="3177890">//&nbsp;TypeSequence</span><br>
<span class="lineno"></span><span class="comment" id="3177906">//&nbsp;&nbsp;&nbsp;&nbsp(TypeDefinition&nbsp;DelimitedTypeDefinition*)?</span><br>
<span class="lineno"></span><span class="comment" id="3177952">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;type&nbsp;id&nbsp;of&nbsp;the&nbsp;next&nbsp;value.&nbsp;&nbsp;It&nbsp;returns&nbsp;-1&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="3178016">//&nbsp;EOF.&nbsp;&nbsp;Upon&nbsp;return,&nbsp;the&nbsp;remainder&nbsp;of&nbsp;dec.buf&nbsp;is&nbsp;the&nbsp;value&nbsp;to&nbsp;be</span><br>
<span class="lineno">135</span><span class="comment" id="3178082">//&nbsp;decoded.&nbsp;&nbsp;If&nbsp;this&nbsp;is&nbsp;an&nbsp;interface&nbsp;value,&nbsp;it&nbsp;can&nbsp;be&nbsp;ignored&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3178147">//&nbsp;resetting&nbsp;that&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3178173">func</span>&nbsp;<span class="op" id="3178178">(</span><span class="ident" id="3178179">dec</span>&nbsp;<span class="op" id="3178183">*</span><span class="ident" id="3178184">Decoder</span><span class="op" id="3178191">)</span>&nbsp;<span class="ident" id="3178193">decodeTypeSequence</span><span class="op" id="3178211">(</span><span class="ident" id="3178212">isInterface</span>&nbsp;<span class="builtintype" id="3178224">bool</span><span class="op" id="3178228">)</span>&nbsp;<span class="ident" id="3178230">typeId</span>&nbsp;<span class="op" id="3178237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178240">for</span>&nbsp;<span class="ident" id="3178244">dec</span><span class="op" id="3178247">.</span><span class="ident" id="3178248">err</span>&nbsp;<span class="op" id="3178252">==</span>&nbsp;<span class="ident" id="3178255">nil</span>&nbsp;<span class="op" id="3178259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178263">if</span>&nbsp;<span class="ident" id="3178266">dec</span><span class="op" id="3178269">.</span><span class="ident" id="3178270">buf</span><span class="op" id="3178273">.</span><span class="ident" id="3178274">Len</span><span class="op" id="3178277">(</span><span class="op" id="3178278">)</span>&nbsp;<span class="op" id="3178280">==</span>&nbsp;<span class="num" id="3178283">0</span>&nbsp;<span class="op" id="3178285">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178290">if</span>&nbsp;<span class="op" id="3178293">!</span><span class="ident" id="3178294">dec</span><span class="op" id="3178297">.</span><span class="ident" id="3178298">recvMessage</span><span class="op" id="3178309">(</span><span class="op" id="3178310">)</span>&nbsp;<span class="op" id="3178312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178318">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178335">//&nbsp;Receive&nbsp;a&nbsp;type&nbsp;id.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178359">id</span>&nbsp;<span class="op" id="3178362">:=</span>&nbsp;<span class="ident" id="3178365">typeId</span><span class="op" id="3178371">(</span><span class="ident" id="3178372">dec</span><span class="op" id="3178375">.</span><span class="ident" id="3178376">nextInt</span><span class="op" id="3178383">(</span><span class="op" id="3178384">)</span><span class="op" id="3178385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178389">if</span>&nbsp;<span class="ident" id="3178392">id</span>&nbsp;<span class="op" id="3178395">&gt;=</span>&nbsp;<span class="num" id="3178398">0</span>&nbsp;<span class="op" id="3178400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178405">//&nbsp;Value&nbsp;follows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178426">return</span>&nbsp;<span class="ident" id="3178433">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178438">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178442">//&nbsp;Type&nbsp;definition&nbsp;for&nbsp;(-id)&nbsp;follows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178482">dec</span><span class="op" id="3178485">.</span><span class="ident" id="3178486">recvType</span><span class="op" id="3178494">(</span><span class="op" id="3178495">-</span><span class="ident" id="3178496">id</span><span class="op" id="3178498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178502">//&nbsp;When&nbsp;decoding&nbsp;an&nbsp;interface,&nbsp;after&nbsp;a&nbsp;type&nbsp;there&nbsp;may&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178563">//&nbsp;DelimitedValue&nbsp;still&nbsp;in&nbsp;the&nbsp;buffer.&nbsp;&nbsp;Skip&nbsp;its&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178621">//&nbsp;(Alternatively,&nbsp;the&nbsp;buffer&nbsp;is&nbsp;empty&nbsp;and&nbsp;the&nbsp;byte&nbsp;count</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3178681">//&nbsp;will&nbsp;be&nbsp;absorbed&nbsp;by&nbsp;recvMessage.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178720">if</span>&nbsp;<span class="ident" id="3178723">dec</span><span class="op" id="3178726">.</span><span class="ident" id="3178727">buf</span><span class="op" id="3178730">.</span><span class="ident" id="3178731">Len</span><span class="op" id="3178734">(</span><span class="op" id="3178735">)</span>&nbsp;<span class="op" id="3178737">&gt;</span>&nbsp;<span class="num" id="3178739">0</span>&nbsp;<span class="op" id="3178741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178746">if</span>&nbsp;<span class="op" id="3178749">!</span><span class="ident" id="3178750">isInterface</span>&nbsp;<span class="op" id="3178762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178768">dec</span><span class="op" id="3178771">.</span><span class="ident" id="3178772">err</span>&nbsp;<span class="op" id="3178776">=</span>&nbsp;<span class="ident" id="3178778">errors</span><span class="op" id="3178784">.</span><span class="ident" id="3178785">New</span><span class="op" id="3178788">(</span><span class="string" id="3178789">&#34;extra&nbsp;data&nbsp;in&nbsp;buffer&#34;</span><span class="op" id="3178811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178817">break</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178831">dec</span><span class="op" id="3178834">.</span><span class="ident" id="3178835">nextUint</span><span class="op" id="3178843">(</span><span class="op" id="3178844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178854">return</span>&nbsp;<span class="op" id="3178861">-</span><span class="num" id="3178862">1</span><br>
<span class="lineno">165</span><span class="op" id="3178864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3178867">//&nbsp;Decode&nbsp;reads&nbsp;the&nbsp;next&nbsp;value&nbsp;from&nbsp;the&nbsp;input&nbsp;stream&nbsp;and&nbsp;stores</span><br>
<span class="lineno"></span><span class="comment" id="3178931">//&nbsp;it&nbsp;in&nbsp;the&nbsp;data&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="3178991">//&nbsp;If&nbsp;e&nbsp;is&nbsp;nil,&nbsp;the&nbsp;value&nbsp;will&nbsp;be&nbsp;discarded.&nbsp;Otherwise,</span><br>
<span class="lineno">170</span><span class="comment" id="3179047">//&nbsp;the&nbsp;value&nbsp;underlying&nbsp;e&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3179098">//&nbsp;correct&nbsp;type&nbsp;for&nbsp;the&nbsp;next&nbsp;data&nbsp;item&nbsp;received.</span><br>
<span class="lineno"></span><span class="comment" id="3179147">//&nbsp;If&nbsp;the&nbsp;input&nbsp;is&nbsp;at&nbsp;EOF,&nbsp;Decode&nbsp;returns&nbsp;io.EOF&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3179200">//&nbsp;does&nbsp;not&nbsp;modify&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="3179222">func</span>&nbsp;<span class="op" id="3179227">(</span><span class="ident" id="3179228">dec</span>&nbsp;<span class="op" id="3179232">*</span><span class="ident" id="3179233">Decoder</span><span class="op" id="3179240">)</span>&nbsp;<span class="ident" id="3179242">Decode</span><span class="op" id="3179248">(</span><span class="ident" id="3179249">e</span>&nbsp;<span class="keyword" id="3179251">interface</span><span class="op" id="3179260">{</span><span class="op" id="3179261">}</span><span class="op" id="3179262">)</span>&nbsp;<span class="builtintype" id="3179264">error</span>&nbsp;<span class="op" id="3179270">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179273">if</span>&nbsp;<span class="ident" id="3179276">e</span>&nbsp;<span class="op" id="3179278">==</span>&nbsp;<span class="ident" id="3179281">nil</span>&nbsp;<span class="op" id="3179285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179289">return</span>&nbsp;<span class="ident" id="3179296">dec</span><span class="op" id="3179299">.</span><span class="ident" id="3179300">DecodeValue</span><span class="op" id="3179311">(</span><span class="ident" id="3179312">reflect</span><span class="op" id="3179319">.</span><span class="ident" id="3179320">Value</span><span class="op" id="3179325">{</span><span class="op" id="3179326">}</span><span class="op" id="3179327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179333">value</span>&nbsp;<span class="op" id="3179339">:=</span>&nbsp;<span class="ident" id="3179342">reflect</span><span class="op" id="3179349">.</span><span class="ident" id="3179350">ValueOf</span><span class="op" id="3179357">(</span><span class="ident" id="3179358">e</span><span class="op" id="3179359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3179362">//&nbsp;If&nbsp;e&nbsp;represents&nbsp;a&nbsp;value&nbsp;as&nbsp;opposed&nbsp;to&nbsp;a&nbsp;pointer,&nbsp;the&nbsp;answer&nbsp;won&#39;t</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3179432">//&nbsp;get&nbsp;back&nbsp;to&nbsp;the&nbsp;caller.&nbsp;&nbsp;Make&nbsp;sure&nbsp;it&#39;s&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179487">if</span>&nbsp;<span class="ident" id="3179490">value</span><span class="op" id="3179495">.</span><span class="ident" id="3179496">Type</span><span class="op" id="3179500">(</span><span class="op" id="3179501">)</span><span class="op" id="3179502">.</span><span class="ident" id="3179503">Kind</span><span class="op" id="3179507">(</span><span class="op" id="3179508">)</span>&nbsp;<span class="op" id="3179510">!=</span>&nbsp;<span class="ident" id="3179513">reflect</span><span class="op" id="3179520">.</span><span class="ident" id="3179521">Ptr</span>&nbsp;<span class="op" id="3179525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179529">dec</span><span class="op" id="3179532">.</span><span class="ident" id="3179533">err</span>&nbsp;<span class="op" id="3179537">=</span>&nbsp;<span class="ident" id="3179539">errors</span><span class="op" id="3179545">.</span><span class="ident" id="3179546">New</span><span class="op" id="3179549">(</span><span class="string" id="3179550">&#34;gob:&nbsp;attempt&nbsp;to&nbsp;decode&nbsp;into&nbsp;a&nbsp;non-pointer&#34;</span><span class="op" id="3179593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179597">return</span>&nbsp;<span class="ident" id="3179604">dec</span><span class="op" id="3179607">.</span><span class="ident" id="3179608">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179613">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179616">return</span>&nbsp;<span class="ident" id="3179623">dec</span><span class="op" id="3179626">.</span><span class="ident" id="3179627">DecodeValue</span><span class="op" id="3179638">(</span><span class="ident" id="3179639">value</span><span class="op" id="3179644">)</span><br>
<span class="lineno"></span><span class="op" id="3179646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3179649">//&nbsp;DecodeValue&nbsp;reads&nbsp;the&nbsp;next&nbsp;value&nbsp;from&nbsp;the&nbsp;input&nbsp;stream.</span><br>
<span class="lineno"></span><span class="comment" id="3179708">//&nbsp;If&nbsp;v&nbsp;is&nbsp;the&nbsp;zero&nbsp;reflect.Value&nbsp;(v.Kind()&nbsp;==&nbsp;Invalid),&nbsp;DecodeValue&nbsp;discards&nbsp;the&nbsp;value.</span><br>
<span class="lineno">190</span><span class="comment" id="3179797">//&nbsp;Otherwise,&nbsp;it&nbsp;stores&nbsp;the&nbsp;value&nbsp;into&nbsp;v.&nbsp;&nbsp;In&nbsp;that&nbsp;case,&nbsp;v&nbsp;must&nbsp;represent</span><br>
<span class="lineno"></span><span class="comment" id="3179871">//&nbsp;a&nbsp;non-nil&nbsp;pointer&nbsp;to&nbsp;data&nbsp;or&nbsp;be&nbsp;an&nbsp;assignable&nbsp;reflect.Value&nbsp;(v.CanSet())</span><br>
<span class="lineno"></span><span class="comment" id="3179947">//&nbsp;If&nbsp;the&nbsp;input&nbsp;is&nbsp;at&nbsp;EOF,&nbsp;DecodeValue&nbsp;returns&nbsp;io.EOF&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3180005">//&nbsp;does&nbsp;not&nbsp;modify&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3180027">func</span>&nbsp;<span class="op" id="3180032">(</span><span class="ident" id="3180033">dec</span>&nbsp;<span class="op" id="3180037">*</span><span class="ident" id="3180038">Decoder</span><span class="op" id="3180045">)</span>&nbsp;<span class="ident" id="3180047">DecodeValue</span><span class="op" id="3180058">(</span><span class="ident" id="3180059">v</span>&nbsp;<span class="ident" id="3180061">reflect</span><span class="op" id="3180068">.</span><span class="ident" id="3180069">Value</span><span class="op" id="3180074">)</span>&nbsp;<span class="builtintype" id="3180076">error</span>&nbsp;<span class="op" id="3180082">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180085">if</span>&nbsp;<span class="ident" id="3180088">v</span><span class="op" id="3180089">.</span><span class="ident" id="3180090">IsValid</span><span class="op" id="3180097">(</span><span class="op" id="3180098">)</span>&nbsp;<span class="op" id="3180100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180104">if</span>&nbsp;<span class="ident" id="3180107">v</span><span class="op" id="3180108">.</span><span class="ident" id="3180109">Kind</span><span class="op" id="3180113">(</span><span class="op" id="3180114">)</span>&nbsp;<span class="op" id="3180116">==</span>&nbsp;<span class="ident" id="3180119">reflect</span><span class="op" id="3180126">.</span><span class="ident" id="3180127">Ptr</span>&nbsp;<span class="op" id="3180131">&amp;&amp;</span>&nbsp;<span class="op" id="3180134">!</span><span class="ident" id="3180135">v</span><span class="op" id="3180136">.</span><span class="ident" id="3180137">IsNil</span><span class="op" id="3180142">(</span><span class="op" id="3180143">)</span>&nbsp;<span class="op" id="3180145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3180150">//&nbsp;That&#39;s&nbsp;okay,&nbsp;we&#39;ll&nbsp;store&nbsp;through&nbsp;the&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180201">}</span>&nbsp;<span class="keyword" id="3180203">else</span>&nbsp;<span class="keyword" id="3180208">if</span>&nbsp;<span class="op" id="3180211">!</span><span class="ident" id="3180212">v</span><span class="op" id="3180213">.</span><span class="ident" id="3180214">CanSet</span><span class="op" id="3180220">(</span><span class="op" id="3180221">)</span>&nbsp;<span class="op" id="3180223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180228">return</span>&nbsp;<span class="ident" id="3180235">errors</span><span class="op" id="3180241">.</span><span class="ident" id="3180242">New</span><span class="op" id="3180245">(</span><span class="string" id="3180246">&#34;gob:&nbsp;DecodeValue&nbsp;of&nbsp;unassignable&nbsp;value&#34;</span><span class="op" id="3180286">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3180296">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3180346">dec</span><span class="op" id="3180349">.</span><span class="ident" id="3180350">mutex</span><span class="op" id="3180355">.</span><span class="ident" id="3180356">Lock</span><span class="op" id="3180360">(</span><span class="op" id="3180361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180364">defer</span>&nbsp;<span class="ident" id="3180370">dec</span><span class="op" id="3180373">.</span><span class="ident" id="3180374">mutex</span><span class="op" id="3180379">.</span><span class="ident" id="3180380">Unlock</span><span class="op" id="3180386">(</span><span class="op" id="3180387">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3180391">dec</span><span class="op" id="3180394">.</span><span class="ident" id="3180395">buf</span><span class="op" id="3180398">.</span><span class="ident" id="3180399">Reset</span><span class="op" id="3180404">(</span><span class="op" id="3180405">)</span>&nbsp;<span class="comment" id="3180407">//&nbsp;In&nbsp;case&nbsp;data&nbsp;lingers&nbsp;from&nbsp;previous&nbsp;invocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3180458">dec</span><span class="op" id="3180461">.</span><span class="ident" id="3180462">err</span>&nbsp;<span class="op" id="3180466">=</span>&nbsp;<span class="ident" id="3180468">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3180473">id</span>&nbsp;<span class="op" id="3180476">:=</span>&nbsp;<span class="ident" id="3180479">dec</span><span class="op" id="3180482">.</span><span class="ident" id="3180483">decodeTypeSequence</span><span class="op" id="3180501">(</span><span class="ident" id="3180502">false</span><span class="op" id="3180507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180510">if</span>&nbsp;<span class="ident" id="3180513">dec</span><span class="op" id="3180516">.</span><span class="ident" id="3180517">err</span>&nbsp;<span class="op" id="3180521">==</span>&nbsp;<span class="ident" id="3180524">nil</span>&nbsp;<span class="op" id="3180528">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3180532">dec</span><span class="op" id="3180535">.</span><span class="ident" id="3180536">decodeValue</span><span class="op" id="3180547">(</span><span class="ident" id="3180548">id</span><span class="op" id="3180550">,</span>&nbsp;<span class="ident" id="3180552">v</span><span class="op" id="3180553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3180556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3180559">return</span>&nbsp;<span class="ident" id="3180566">dec</span><span class="op" id="3180569">.</span><span class="ident" id="3180570">err</span><br>
<span class="lineno"></span><span class="op" id="3180574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="comment" id="3180577">//&nbsp;If&nbsp;debug.go&nbsp;is&nbsp;compiled&nbsp;into&nbsp;the&nbsp;program&nbsp;,&nbsp;debugFunc&nbsp;prints&nbsp;a&nbsp;human-readable</span><br>
<span class="lineno"></span><span class="comment" id="3180657">//&nbsp;representation&nbsp;of&nbsp;the&nbsp;gob&nbsp;data&nbsp;read&nbsp;from&nbsp;r&nbsp;by&nbsp;calling&nbsp;that&nbsp;file&#39;s&nbsp;Debug&nbsp;function.</span><br>
<span class="lineno"></span><span class="comment" id="3180742">//&nbsp;Otherwise&nbsp;it&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3180766">var</span>&nbsp;<span class="ident" id="3180770">debugFunc</span>&nbsp;<span class="keyword" id="3180780">func</span><span class="op" id="3180784">(</span><span class="ident" id="3180785">io</span><span class="op" id="3180787">.</span><span class="ident" id="3180788">Reader</span><span class="op" id="3180794">)</span>
</div>
</body>
</html>
