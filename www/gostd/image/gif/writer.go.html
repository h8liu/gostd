<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6333259">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6333314">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6333368">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6333419">package</span>&nbsp;<span class="ident" id="6333427">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333432">import</span>&nbsp;<span class="op" id="6333439">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6333442">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6333451">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6333467">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6333477">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6333486">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6333501">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6333524">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6333538">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6333543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6333546">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="6333583">const</span>&nbsp;<span class="op" id="6333589">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333592">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333604">=</span>&nbsp;<span class="num" id="6333606">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333612">gcBlockSize</span>&nbsp;<span class="op" id="6333624">=</span>&nbsp;<span class="num" id="6333626">0x04</span><br>
<span class="lineno"></span><span class="op" id="6333631">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333634">var</span>&nbsp;<span class="ident" id="6333638">log2Lookup</span>&nbsp;<span class="op" id="6333649">=</span>&nbsp;<span class="op" id="6333651">[</span><span class="num" id="6333652">8</span><span class="op" id="6333653">]</span><span class="builtintype" id="6333654">int</span><span class="op" id="6333657">{</span><span class="num" id="6333658">2</span><span class="op" id="6333659">,</span>&nbsp;<span class="num" id="6333661">4</span><span class="op" id="6333662">,</span>&nbsp;<span class="num" id="6333664">8</span><span class="op" id="6333665">,</span>&nbsp;<span class="num" id="6333667">16</span><span class="op" id="6333669">,</span>&nbsp;<span class="num" id="6333671">32</span><span class="op" id="6333673">,</span>&nbsp;<span class="num" id="6333675">64</span><span class="op" id="6333677">,</span>&nbsp;<span class="num" id="6333679">128</span><span class="op" id="6333682">,</span>&nbsp;<span class="num" id="6333684">256</span><span class="op" id="6333687">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6333690">func</span>&nbsp;<span class="ident" id="6333695">log2</span><span class="op" id="6333699">(</span><span class="ident" id="6333700">x</span>&nbsp;<span class="builtintype" id="6333702">int</span><span class="op" id="6333705">)</span>&nbsp;<span class="builtintype" id="6333707">int</span>&nbsp;<span class="op" id="6333711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6333714">for</span>&nbsp;<span class="ident" id="6333718">i</span><span class="op" id="6333719">,</span>&nbsp;<span class="ident" id="6333721">v</span>&nbsp;<span class="op" id="6333723">:=</span>&nbsp;<span class="keyword" id="6333726">range</span>&nbsp;<span class="ident" id="6333732">log2Lookup</span>&nbsp;<span class="op" id="6333743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6333747">if</span>&nbsp;<span class="ident" id="6333750">x</span>&nbsp;<span class="op" id="6333752">&lt;=</span>&nbsp;<span class="ident" id="6333755">v</span>&nbsp;<span class="op" id="6333757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6333762">return</span>&nbsp;<span class="ident" id="6333769">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6333773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6333776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6333779">return</span>&nbsp;<span class="op" id="6333786">-</span><span class="num" id="6333787">1</span><br>
<span class="lineno"></span><span class="op" id="6333789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="6333792">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6333810">func</span>&nbsp;<span class="ident" id="6333815">writeUint16</span><span class="op" id="6333826">(</span><span class="ident" id="6333827">b</span>&nbsp;<span class="op" id="6333829">[</span><span class="op" id="6333830">]</span><span class="builtintype" id="6333831">uint8</span><span class="op" id="6333836">,</span>&nbsp;<span class="ident" id="6333838">u</span>&nbsp;<span class="builtintype" id="6333840">uint16</span><span class="op" id="6333846">)</span>&nbsp;<span class="op" id="6333848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333851">b</span><span class="op" id="6333852">[</span><span class="num" id="6333853">0</span><span class="op" id="6333854">]</span>&nbsp;<span class="op" id="6333856">=</span>&nbsp;<span class="builtintype" id="6333858">uint8</span><span class="op" id="6333863">(</span><span class="ident" id="6333864">u</span><span class="op" id="6333865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333868">b</span><span class="op" id="6333869">[</span><span class="num" id="6333870">1</span><span class="op" id="6333871">]</span>&nbsp;<span class="op" id="6333873">=</span>&nbsp;<span class="builtintype" id="6333875">uint8</span><span class="op" id="6333880">(</span><span class="ident" id="6333881">u</span>&nbsp;<span class="op" id="6333883">&gt;&gt;</span>&nbsp;<span class="num" id="6333886">8</span><span class="op" id="6333887">)</span><br>
<span class="lineno"></span><span class="op" id="6333889">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6333892">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6333924">type</span>&nbsp;<span class="ident" id="6333929">writer</span>&nbsp;<span class="keyword" id="6333936">interface</span>&nbsp;<span class="op" id="6333946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333949">Flush</span><span class="op" id="6333954">(</span><span class="op" id="6333955">)</span>&nbsp;<span class="builtintype" id="6333957">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333964">io</span><span class="op" id="6333966">.</span><span class="ident" id="6333967">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333975">io</span><span class="op" id="6333977">.</span><span class="ident" id="6333978">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="6333989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6333992">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6334039">type</span>&nbsp;<span class="ident" id="6334044">encoder</span>&nbsp;<span class="keyword" id="6334052">struct</span>&nbsp;<span class="op" id="6334059">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6334062">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6334137">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334208">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6334212">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334220">err</span>&nbsp;<span class="builtintype" id="6334224">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6334231">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334287">g</span>&nbsp;<span class="op" id="6334289">*</span><span class="ident" id="6334290">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6334295">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334379">buf</span>&nbsp;<span class="op" id="6334383">[</span><span class="num" id="6334384">1024</span><span class="op" id="6334388">]</span><span class="builtintype" id="6334389">byte</span><br>
<span class="lineno"></span><span class="op" id="6334394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6334397">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="6334464">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6334530">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6334594">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="6334607">type</span>&nbsp;<span class="ident" id="6334612">blockWriter</span>&nbsp;<span class="keyword" id="6334624">struct</span>&nbsp;<span class="op" id="6334631">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334634">e</span>&nbsp;<span class="op" id="6334636">*</span><span class="ident" id="6334637">encoder</span><br>
<span class="lineno"></span><span class="op" id="6334645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6334648">func</span>&nbsp;<span class="op" id="6334653">(</span><span class="ident" id="6334654">b</span>&nbsp;<span class="ident" id="6334656">blockWriter</span><span class="op" id="6334667">)</span>&nbsp;<span class="ident" id="6334669">Write</span><span class="op" id="6334674">(</span><span class="ident" id="6334675">data</span>&nbsp;<span class="op" id="6334680">[</span><span class="op" id="6334681">]</span><span class="builtintype" id="6334682">byte</span><span class="op" id="6334686">)</span>&nbsp;<span class="op" id="6334688">(</span><span class="builtintype" id="6334689">int</span><span class="op" id="6334692">,</span>&nbsp;<span class="builtintype" id="6334694">error</span><span class="op" id="6334699">)</span>&nbsp;<span class="op" id="6334701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6334704">if</span>&nbsp;<span class="ident" id="6334707">b</span><span class="op" id="6334708">.</span><span class="ident" id="6334709">e</span><span class="op" id="6334710">.</span><span class="ident" id="6334711">err</span>&nbsp;<span class="op" id="6334715">!=</span>&nbsp;<span class="ident" id="6334718">nil</span>&nbsp;<span class="op" id="6334722">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6334726">return</span>&nbsp;<span class="num" id="6334733">0</span><span class="op" id="6334734">,</span>&nbsp;<span class="ident" id="6334736">b</span><span class="op" id="6334737">.</span><span class="ident" id="6334738">e</span><span class="op" id="6334739">.</span><span class="ident" id="6334740">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6334745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6334748">if</span>&nbsp;<span class="builtinfunc" id="6334751">len</span><span class="op" id="6334754">(</span><span class="ident" id="6334755">data</span><span class="op" id="6334759">)</span>&nbsp;<span class="op" id="6334761">==</span>&nbsp;<span class="num" id="6334764">0</span>&nbsp;<span class="op" id="6334766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6334770">return</span>&nbsp;<span class="num" id="6334777">0</span><span class="op" id="6334778">,</span>&nbsp;<span class="ident" id="6334780">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6334785">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334788">total</span>&nbsp;<span class="op" id="6334794">:=</span>&nbsp;<span class="num" id="6334797">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6334800">for</span>&nbsp;<span class="ident" id="6334804">total</span>&nbsp;<span class="op" id="6334810">&lt;</span>&nbsp;<span class="builtinfunc" id="6334812">len</span><span class="op" id="6334815">(</span><span class="ident" id="6334816">data</span><span class="op" id="6334820">)</span>&nbsp;<span class="op" id="6334822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334826">n</span>&nbsp;<span class="op" id="6334828">:=</span>&nbsp;<span class="builtinfunc" id="6334831">copy</span><span class="op" id="6334835">(</span><span class="ident" id="6334836">b</span><span class="op" id="6334837">.</span><span class="ident" id="6334838">e</span><span class="op" id="6334839">.</span><span class="ident" id="6334840">buf</span><span class="op" id="6334843">[</span><span class="num" id="6334844">1</span><span class="op" id="6334845">:</span><span class="num" id="6334846">256</span><span class="op" id="6334849">]</span><span class="op" id="6334850">,</span>&nbsp;<span class="ident" id="6334852">data</span><span class="op" id="6334856">[</span><span class="ident" id="6334857">total</span><span class="op" id="6334862">:</span><span class="op" id="6334863">]</span><span class="op" id="6334864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334868">total</span>&nbsp;<span class="op" id="6334874">+=</span>&nbsp;<span class="ident" id="6334877">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334881">b</span><span class="op" id="6334882">.</span><span class="ident" id="6334883">e</span><span class="op" id="6334884">.</span><span class="ident" id="6334885">buf</span><span class="op" id="6334888">[</span><span class="num" id="6334889">0</span><span class="op" id="6334890">]</span>&nbsp;<span class="op" id="6334892">=</span>&nbsp;<span class="builtintype" id="6334894">uint8</span><span class="op" id="6334899">(</span><span class="ident" id="6334900">n</span><span class="op" id="6334901">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6334906">n</span><span class="op" id="6334907">,</span>&nbsp;<span class="ident" id="6334909">b</span><span class="op" id="6334910">.</span><span class="ident" id="6334911">e</span><span class="op" id="6334912">.</span><span class="ident" id="6334913">err</span>&nbsp;<span class="op" id="6334917">=</span>&nbsp;<span class="ident" id="6334919">b</span><span class="op" id="6334920">.</span><span class="ident" id="6334921">e</span><span class="op" id="6334922">.</span><span class="ident" id="6334923">w</span><span class="op" id="6334924">.</span><span class="ident" id="6334925">Write</span><span class="op" id="6334930">(</span><span class="ident" id="6334931">b</span><span class="op" id="6334932">.</span><span class="ident" id="6334933">e</span><span class="op" id="6334934">.</span><span class="ident" id="6334935">buf</span><span class="op" id="6334938">[</span><span class="op" id="6334939">:</span><span class="ident" id="6334940">n</span><span class="op" id="6334941">+</span><span class="num" id="6334942">1</span><span class="op" id="6334943">]</span><span class="op" id="6334944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6334948">if</span>&nbsp;<span class="ident" id="6334951">b</span><span class="op" id="6334952">.</span><span class="ident" id="6334953">e</span><span class="op" id="6334954">.</span><span class="ident" id="6334955">err</span>&nbsp;<span class="op" id="6334959">!=</span>&nbsp;<span class="ident" id="6334962">nil</span>&nbsp;<span class="op" id="6334966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6334971">return</span>&nbsp;<span class="num" id="6334978">0</span><span class="op" id="6334979">,</span>&nbsp;<span class="ident" id="6334981">b</span><span class="op" id="6334982">.</span><span class="ident" id="6334983">e</span><span class="op" id="6334984">.</span><span class="ident" id="6334985">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6334991">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6334994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6334997">return</span>&nbsp;<span class="ident" id="6335004">total</span><span class="op" id="6335009">,</span>&nbsp;<span class="ident" id="6335011">b</span><span class="op" id="6335012">.</span><span class="ident" id="6335013">e</span><span class="op" id="6335014">.</span><span class="ident" id="6335015">err</span><br>
<span class="lineno"></span><span class="op" id="6335019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6335022">func</span>&nbsp;<span class="op" id="6335027">(</span><span class="ident" id="6335028">e</span>&nbsp;<span class="op" id="6335030">*</span><span class="ident" id="6335031">encoder</span><span class="op" id="6335038">)</span>&nbsp;<span class="ident" id="6335040">flush</span><span class="op" id="6335045">(</span><span class="op" id="6335046">)</span>&nbsp;<span class="op" id="6335048">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335051">if</span>&nbsp;<span class="ident" id="6335054">e</span><span class="op" id="6335055">.</span><span class="ident" id="6335056">err</span>&nbsp;<span class="op" id="6335060">!=</span>&nbsp;<span class="ident" id="6335063">nil</span>&nbsp;<span class="op" id="6335067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335071">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6335079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335082">e</span><span class="op" id="6335083">.</span><span class="ident" id="6335084">err</span>&nbsp;<span class="op" id="6335088">=</span>&nbsp;<span class="ident" id="6335090">e</span><span class="op" id="6335091">.</span><span class="ident" id="6335092">w</span><span class="op" id="6335093">.</span><span class="ident" id="6335094">Flush</span><span class="op" id="6335099">(</span><span class="op" id="6335100">)</span><br>
<span class="lineno"></span><span class="op" id="6335102">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="6335105">func</span>&nbsp;<span class="op" id="6335110">(</span><span class="ident" id="6335111">e</span>&nbsp;<span class="op" id="6335113">*</span><span class="ident" id="6335114">encoder</span><span class="op" id="6335121">)</span>&nbsp;<span class="ident" id="6335123">write</span><span class="op" id="6335128">(</span><span class="ident" id="6335129">p</span>&nbsp;<span class="op" id="6335131">[</span><span class="op" id="6335132">]</span><span class="builtintype" id="6335133">byte</span><span class="op" id="6335137">)</span>&nbsp;<span class="op" id="6335139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335142">if</span>&nbsp;<span class="ident" id="6335145">e</span><span class="op" id="6335146">.</span><span class="ident" id="6335147">err</span>&nbsp;<span class="op" id="6335151">!=</span>&nbsp;<span class="ident" id="6335154">nil</span>&nbsp;<span class="op" id="6335158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335162">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6335170">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335173">_</span><span class="op" id="6335174">,</span>&nbsp;<span class="ident" id="6335176">e</span><span class="op" id="6335177">.</span><span class="ident" id="6335178">err</span>&nbsp;<span class="op" id="6335182">=</span>&nbsp;<span class="ident" id="6335184">e</span><span class="op" id="6335185">.</span><span class="ident" id="6335186">w</span><span class="op" id="6335187">.</span><span class="ident" id="6335188">Write</span><span class="op" id="6335193">(</span><span class="ident" id="6335194">p</span><span class="op" id="6335195">)</span><br>
<span class="lineno"></span><span class="op" id="6335197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6335200">func</span>&nbsp;<span class="op" id="6335205">(</span><span class="ident" id="6335206">e</span>&nbsp;<span class="op" id="6335208">*</span><span class="ident" id="6335209">encoder</span><span class="op" id="6335216">)</span>&nbsp;<span class="ident" id="6335218">writeByte</span><span class="op" id="6335227">(</span><span class="ident" id="6335228">b</span>&nbsp;<span class="builtintype" id="6335230">byte</span><span class="op" id="6335234">)</span>&nbsp;<span class="op" id="6335236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335239">if</span>&nbsp;<span class="ident" id="6335242">e</span><span class="op" id="6335243">.</span><span class="ident" id="6335244">err</span>&nbsp;<span class="op" id="6335248">!=</span>&nbsp;<span class="ident" id="6335251">nil</span>&nbsp;<span class="op" id="6335255">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335259">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6335267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335270">e</span><span class="op" id="6335271">.</span><span class="ident" id="6335272">err</span>&nbsp;<span class="op" id="6335276">=</span>&nbsp;<span class="ident" id="6335278">e</span><span class="op" id="6335279">.</span><span class="ident" id="6335280">w</span><span class="op" id="6335281">.</span><span class="ident" id="6335282">WriteByte</span><span class="op" id="6335291">(</span><span class="ident" id="6335292">b</span><span class="op" id="6335293">)</span><br>
<span class="lineno"></span><span class="op" id="6335295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6335298">func</span>&nbsp;<span class="op" id="6335303">(</span><span class="ident" id="6335304">e</span>&nbsp;<span class="op" id="6335306">*</span><span class="ident" id="6335307">encoder</span><span class="op" id="6335314">)</span>&nbsp;<span class="ident" id="6335316">writeHeader</span><span class="op" id="6335327">(</span><span class="op" id="6335328">)</span>&nbsp;<span class="op" id="6335330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335333">if</span>&nbsp;<span class="ident" id="6335336">e</span><span class="op" id="6335337">.</span><span class="ident" id="6335338">err</span>&nbsp;<span class="op" id="6335342">!=</span>&nbsp;<span class="ident" id="6335345">nil</span>&nbsp;<span class="op" id="6335349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335353">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6335361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335364">_</span><span class="op" id="6335365">,</span>&nbsp;<span class="ident" id="6335367">e</span><span class="op" id="6335368">.</span><span class="ident" id="6335369">err</span>&nbsp;<span class="op" id="6335373">=</span>&nbsp;<span class="ident" id="6335375">io</span><span class="op" id="6335377">.</span><span class="ident" id="6335378">WriteString</span><span class="op" id="6335389">(</span><span class="ident" id="6335390">e</span><span class="op" id="6335391">.</span><span class="ident" id="6335392">w</span><span class="op" id="6335393">,</span>&nbsp;<span class="string" id="6335395">&#34;GIF89a&#34;</span><span class="op" id="6335403">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335406">if</span>&nbsp;<span class="ident" id="6335409">e</span><span class="op" id="6335410">.</span><span class="ident" id="6335411">err</span>&nbsp;<span class="op" id="6335415">!=</span>&nbsp;<span class="ident" id="6335418">nil</span>&nbsp;<span class="op" id="6335422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335426">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6335434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335438">pm</span>&nbsp;<span class="op" id="6335441">:=</span>&nbsp;<span class="ident" id="6335444">e</span><span class="op" id="6335445">.</span><span class="ident" id="6335446">g</span><span class="op" id="6335447">.</span><span class="ident" id="6335448">Image</span><span class="op" id="6335453">[</span><span class="num" id="6335454">0</span><span class="op" id="6335455">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6335458">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335495">writeUint16</span><span class="op" id="6335506">(</span><span class="ident" id="6335507">e</span><span class="op" id="6335508">.</span><span class="ident" id="6335509">buf</span><span class="op" id="6335512">[</span><span class="num" id="6335513">0</span><span class="op" id="6335514">:</span><span class="num" id="6335515">2</span><span class="op" id="6335516">]</span><span class="op" id="6335517">,</span>&nbsp;<span class="builtintype" id="6335519">uint16</span><span class="op" id="6335525">(</span><span class="ident" id="6335526">pm</span><span class="op" id="6335528">.</span><span class="ident" id="6335529">Bounds</span><span class="op" id="6335535">(</span><span class="op" id="6335536">)</span><span class="op" id="6335537">.</span><span class="ident" id="6335538">Dx</span><span class="op" id="6335540">(</span><span class="op" id="6335541">)</span><span class="op" id="6335542">)</span><span class="op" id="6335543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335546">writeUint16</span><span class="op" id="6335557">(</span><span class="ident" id="6335558">e</span><span class="op" id="6335559">.</span><span class="ident" id="6335560">buf</span><span class="op" id="6335563">[</span><span class="num" id="6335564">2</span><span class="op" id="6335565">:</span><span class="num" id="6335566">4</span><span class="op" id="6335567">]</span><span class="op" id="6335568">,</span>&nbsp;<span class="builtintype" id="6335570">uint16</span><span class="op" id="6335576">(</span><span class="ident" id="6335577">pm</span><span class="op" id="6335579">.</span><span class="ident" id="6335580">Bounds</span><span class="op" id="6335586">(</span><span class="op" id="6335587">)</span><span class="op" id="6335588">.</span><span class="ident" id="6335589">Dy</span><span class="op" id="6335591">(</span><span class="op" id="6335592">)</span><span class="op" id="6335593">)</span><span class="op" id="6335594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335597">e</span><span class="op" id="6335598">.</span><span class="ident" id="6335599">write</span><span class="op" id="6335604">(</span><span class="ident" id="6335605">e</span><span class="op" id="6335606">.</span><span class="ident" id="6335607">buf</span><span class="op" id="6335610">[</span><span class="op" id="6335611">:</span><span class="num" id="6335612">4</span><span class="op" id="6335613">]</span><span class="op" id="6335614">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6335618">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6335683">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335702">e</span><span class="op" id="6335703">.</span><span class="ident" id="6335704">buf</span><span class="op" id="6335707">[</span><span class="num" id="6335708">0</span><span class="op" id="6335709">]</span>&nbsp;<span class="op" id="6335711">=</span>&nbsp;<span class="num" id="6335713">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335719">e</span><span class="op" id="6335720">.</span><span class="ident" id="6335721">buf</span><span class="op" id="6335724">[</span><span class="num" id="6335725">1</span><span class="op" id="6335726">]</span>&nbsp;<span class="op" id="6335728">=</span>&nbsp;<span class="num" id="6335730">0x00</span>&nbsp;<span class="comment" id="6335735">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335763">e</span><span class="op" id="6335764">.</span><span class="ident" id="6335765">buf</span><span class="op" id="6335768">[</span><span class="num" id="6335769">2</span><span class="op" id="6335770">]</span>&nbsp;<span class="op" id="6335772">=</span>&nbsp;<span class="num" id="6335774">0x00</span>&nbsp;<span class="comment" id="6335779">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335803">e</span><span class="op" id="6335804">.</span><span class="ident" id="6335805">write</span><span class="op" id="6335810">(</span><span class="ident" id="6335811">e</span><span class="op" id="6335812">.</span><span class="ident" id="6335813">buf</span><span class="op" id="6335816">[</span><span class="op" id="6335817">:</span><span class="num" id="6335818">3</span><span class="op" id="6335819">]</span><span class="op" id="6335820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6335824">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6335861">if</span>&nbsp;<span class="builtinfunc" id="6335864">len</span><span class="op" id="6335867">(</span><span class="ident" id="6335868">e</span><span class="op" id="6335869">.</span><span class="ident" id="6335870">g</span><span class="op" id="6335871">.</span><span class="ident" id="6335872">Image</span><span class="op" id="6335877">)</span>&nbsp;<span class="op" id="6335879">&gt;</span>&nbsp;<span class="num" id="6335881">1</span>&nbsp;<span class="op" id="6335883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335887">e</span><span class="op" id="6335888">.</span><span class="ident" id="6335889">buf</span><span class="op" id="6335892">[</span><span class="num" id="6335893">0</span><span class="op" id="6335894">]</span>&nbsp;<span class="op" id="6335896">=</span>&nbsp;<span class="num" id="6335898">0x21</span>&nbsp;<span class="comment" id="6335903">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335930">e</span><span class="op" id="6335931">.</span><span class="ident" id="6335932">buf</span><span class="op" id="6335935">[</span><span class="num" id="6335936">1</span><span class="op" id="6335937">]</span>&nbsp;<span class="op" id="6335939">=</span>&nbsp;<span class="num" id="6335941">0xff</span>&nbsp;<span class="comment" id="6335946">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6335970">e</span><span class="op" id="6335971">.</span><span class="ident" id="6335972">buf</span><span class="op" id="6335975">[</span><span class="num" id="6335976">2</span><span class="op" id="6335977">]</span>&nbsp;<span class="op" id="6335979">=</span>&nbsp;<span class="num" id="6335981">0x0b</span>&nbsp;<span class="comment" id="6335986">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336003">e</span><span class="op" id="6336004">.</span><span class="ident" id="6336005">write</span><span class="op" id="6336010">(</span><span class="ident" id="6336011">e</span><span class="op" id="6336012">.</span><span class="ident" id="6336013">buf</span><span class="op" id="6336016">[</span><span class="op" id="6336017">:</span><span class="num" id="6336018">3</span><span class="op" id="6336019">]</span><span class="op" id="6336020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336024">_</span><span class="op" id="6336025">,</span>&nbsp;<span class="ident" id="6336027">e</span><span class="op" id="6336028">.</span><span class="ident" id="6336029">err</span>&nbsp;<span class="op" id="6336033">=</span>&nbsp;<span class="ident" id="6336035">io</span><span class="op" id="6336037">.</span><span class="ident" id="6336038">WriteString</span><span class="op" id="6336049">(</span><span class="ident" id="6336050">e</span><span class="op" id="6336051">.</span><span class="ident" id="6336052">w</span><span class="op" id="6336053">,</span>&nbsp;<span class="string" id="6336055">&#34;NETSCAPE2.0&#34;</span><span class="op" id="6336068">)</span>&nbsp;<span class="comment" id="6336070">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336099">if</span>&nbsp;<span class="ident" id="6336102">e</span><span class="op" id="6336103">.</span><span class="ident" id="6336104">err</span>&nbsp;<span class="op" id="6336108">!=</span>&nbsp;<span class="ident" id="6336111">nil</span>&nbsp;<span class="op" id="6336115">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336120">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6336129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336133">e</span><span class="op" id="6336134">.</span><span class="ident" id="6336135">buf</span><span class="op" id="6336138">[</span><span class="num" id="6336139">0</span><span class="op" id="6336140">]</span>&nbsp;<span class="op" id="6336142">=</span>&nbsp;<span class="num" id="6336144">0x03</span>&nbsp;<span class="comment" id="6336149">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336166">e</span><span class="op" id="6336167">.</span><span class="ident" id="6336168">buf</span><span class="op" id="6336171">[</span><span class="num" id="6336172">1</span><span class="op" id="6336173">]</span>&nbsp;<span class="op" id="6336175">=</span>&nbsp;<span class="num" id="6336177">0x01</span>&nbsp;<span class="comment" id="6336182">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336204">writeUint16</span><span class="op" id="6336215">(</span><span class="ident" id="6336216">e</span><span class="op" id="6336217">.</span><span class="ident" id="6336218">buf</span><span class="op" id="6336221">[</span><span class="num" id="6336222">2</span><span class="op" id="6336223">:</span><span class="num" id="6336224">4</span><span class="op" id="6336225">]</span><span class="op" id="6336226">,</span>&nbsp;<span class="builtintype" id="6336228">uint16</span><span class="op" id="6336234">(</span><span class="ident" id="6336235">e</span><span class="op" id="6336236">.</span><span class="ident" id="6336237">g</span><span class="op" id="6336238">.</span><span class="ident" id="6336239">LoopCount</span><span class="op" id="6336248">)</span><span class="op" id="6336249">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336253">e</span><span class="op" id="6336254">.</span><span class="ident" id="6336255">buf</span><span class="op" id="6336258">[</span><span class="num" id="6336259">4</span><span class="op" id="6336260">]</span>&nbsp;<span class="op" id="6336262">=</span>&nbsp;<span class="num" id="6336264">0x00</span>&nbsp;<span class="comment" id="6336269">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336292">e</span><span class="op" id="6336293">.</span><span class="ident" id="6336294">write</span><span class="op" id="6336299">(</span><span class="ident" id="6336300">e</span><span class="op" id="6336301">.</span><span class="ident" id="6336302">buf</span><span class="op" id="6336305">[</span><span class="op" id="6336306">:</span><span class="num" id="6336307">5</span><span class="op" id="6336308">]</span><span class="op" id="6336309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6336312">}</span><br>
<span class="lineno"></span><span class="op" id="6336314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="6336317">func</span>&nbsp;<span class="op" id="6336322">(</span><span class="ident" id="6336323">e</span>&nbsp;<span class="op" id="6336325">*</span><span class="ident" id="6336326">encoder</span><span class="op" id="6336333">)</span>&nbsp;<span class="ident" id="6336335">writeColorTable</span><span class="op" id="6336350">(</span><span class="ident" id="6336351">p</span>&nbsp;<span class="ident" id="6336353">color</span><span class="op" id="6336358">.</span><span class="ident" id="6336359">Palette</span><span class="op" id="6336366">,</span>&nbsp;<span class="ident" id="6336368">size</span>&nbsp;<span class="builtintype" id="6336373">int</span><span class="op" id="6336376">)</span>&nbsp;<span class="op" id="6336378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336381">if</span>&nbsp;<span class="ident" id="6336384">e</span><span class="op" id="6336385">.</span><span class="ident" id="6336386">err</span>&nbsp;<span class="op" id="6336390">!=</span>&nbsp;<span class="ident" id="6336393">nil</span>&nbsp;<span class="op" id="6336397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336401">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6336409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336413">for</span>&nbsp;<span class="ident" id="6336417">i</span>&nbsp;<span class="op" id="6336419">:=</span>&nbsp;<span class="num" id="6336422">0</span><span class="op" id="6336423">;</span>&nbsp;<span class="ident" id="6336425">i</span>&nbsp;<span class="op" id="6336427">&lt;</span>&nbsp;<span class="ident" id="6336429">log2Lookup</span><span class="op" id="6336439">[</span><span class="ident" id="6336440">size</span><span class="op" id="6336444">]</span><span class="op" id="6336445">;</span>&nbsp;<span class="ident" id="6336447">i</span><span class="op" id="6336448">++</span>&nbsp;<span class="op" id="6336451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336455">if</span>&nbsp;<span class="ident" id="6336458">i</span>&nbsp;<span class="op" id="6336460">&lt;</span>&nbsp;<span class="builtinfunc" id="6336462">len</span><span class="op" id="6336465">(</span><span class="ident" id="6336466">p</span><span class="op" id="6336467">)</span>&nbsp;<span class="op" id="6336469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336474">r</span><span class="op" id="6336475">,</span>&nbsp;<span class="ident" id="6336477">g</span><span class="op" id="6336478">,</span>&nbsp;<span class="ident" id="6336480">b</span><span class="op" id="6336481">,</span>&nbsp;<span class="ident" id="6336483">_</span>&nbsp;<span class="op" id="6336485">:=</span>&nbsp;<span class="ident" id="6336488">p</span><span class="op" id="6336489">[</span><span class="ident" id="6336490">i</span><span class="op" id="6336491">]</span><span class="op" id="6336492">.</span><span class="ident" id="6336493">RGBA</span><span class="op" id="6336497">(</span><span class="op" id="6336498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336503">e</span><span class="op" id="6336504">.</span><span class="ident" id="6336505">buf</span><span class="op" id="6336508">[</span><span class="num" id="6336509">3</span><span class="op" id="6336510">*</span><span class="ident" id="6336511">i</span><span class="op" id="6336512">+</span><span class="num" id="6336513">0</span><span class="op" id="6336514">]</span>&nbsp;<span class="op" id="6336516">=</span>&nbsp;<span class="builtintype" id="6336518">uint8</span><span class="op" id="6336523">(</span><span class="ident" id="6336524">r</span>&nbsp;<span class="op" id="6336526">&gt;&gt;</span>&nbsp;<span class="num" id="6336529">8</span><span class="op" id="6336530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336535">e</span><span class="op" id="6336536">.</span><span class="ident" id="6336537">buf</span><span class="op" id="6336540">[</span><span class="num" id="6336541">3</span><span class="op" id="6336542">*</span><span class="ident" id="6336543">i</span><span class="op" id="6336544">+</span><span class="num" id="6336545">1</span><span class="op" id="6336546">]</span>&nbsp;<span class="op" id="6336548">=</span>&nbsp;<span class="builtintype" id="6336550">uint8</span><span class="op" id="6336555">(</span><span class="ident" id="6336556">g</span>&nbsp;<span class="op" id="6336558">&gt;&gt;</span>&nbsp;<span class="num" id="6336561">8</span><span class="op" id="6336562">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336567">e</span><span class="op" id="6336568">.</span><span class="ident" id="6336569">buf</span><span class="op" id="6336572">[</span><span class="num" id="6336573">3</span><span class="op" id="6336574">*</span><span class="ident" id="6336575">i</span><span class="op" id="6336576">+</span><span class="num" id="6336577">2</span><span class="op" id="6336578">]</span>&nbsp;<span class="op" id="6336580">=</span>&nbsp;<span class="builtintype" id="6336582">uint8</span><span class="op" id="6336587">(</span><span class="ident" id="6336588">b</span>&nbsp;<span class="op" id="6336590">&gt;&gt;</span>&nbsp;<span class="num" id="6336593">8</span><span class="op" id="6336594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6336598">}</span>&nbsp;<span class="keyword" id="6336600">else</span>&nbsp;<span class="op" id="6336605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6336610">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336632">e</span><span class="op" id="6336633">.</span><span class="ident" id="6336634">buf</span><span class="op" id="6336637">[</span><span class="num" id="6336638">3</span><span class="op" id="6336639">*</span><span class="ident" id="6336640">i</span><span class="op" id="6336641">+</span><span class="num" id="6336642">0</span><span class="op" id="6336643">]</span>&nbsp;<span class="op" id="6336645">=</span>&nbsp;<span class="num" id="6336647">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336655">e</span><span class="op" id="6336656">.</span><span class="ident" id="6336657">buf</span><span class="op" id="6336660">[</span><span class="num" id="6336661">3</span><span class="op" id="6336662">*</span><span class="ident" id="6336663">i</span><span class="op" id="6336664">+</span><span class="num" id="6336665">1</span><span class="op" id="6336666">]</span>&nbsp;<span class="op" id="6336668">=</span>&nbsp;<span class="num" id="6336670">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336678">e</span><span class="op" id="6336679">.</span><span class="ident" id="6336680">buf</span><span class="op" id="6336683">[</span><span class="num" id="6336684">3</span><span class="op" id="6336685">*</span><span class="ident" id="6336686">i</span><span class="op" id="6336687">+</span><span class="num" id="6336688">2</span><span class="op" id="6336689">]</span>&nbsp;<span class="op" id="6336691">=</span>&nbsp;<span class="num" id="6336693">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6336700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6336703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336706">e</span><span class="op" id="6336707">.</span><span class="ident" id="6336708">write</span><span class="op" id="6336713">(</span><span class="ident" id="6336714">e</span><span class="op" id="6336715">.</span><span class="ident" id="6336716">buf</span><span class="op" id="6336719">[</span><span class="op" id="6336720">:</span><span class="num" id="6336721">3</span><span class="op" id="6336722">*</span><span class="ident" id="6336723">log2Lookup</span><span class="op" id="6336733">[</span><span class="ident" id="6336734">size</span><span class="op" id="6336738">]</span><span class="op" id="6336739">]</span><span class="op" id="6336740">)</span><br>
<span class="lineno"></span><span class="op" id="6336742">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6336745">func</span>&nbsp;<span class="op" id="6336750">(</span><span class="ident" id="6336751">e</span>&nbsp;<span class="op" id="6336753">*</span><span class="ident" id="6336754">encoder</span><span class="op" id="6336761">)</span>&nbsp;<span class="ident" id="6336763">writeImageBlock</span><span class="op" id="6336778">(</span><span class="ident" id="6336779">pm</span>&nbsp;<span class="op" id="6336782">*</span><span class="ident" id="6336783">image</span><span class="op" id="6336788">.</span><span class="ident" id="6336789">Paletted</span><span class="op" id="6336797">,</span>&nbsp;<span class="ident" id="6336799">delay</span>&nbsp;<span class="builtintype" id="6336805">int</span><span class="op" id="6336808">)</span>&nbsp;<span class="op" id="6336810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336813">if</span>&nbsp;<span class="ident" id="6336816">e</span><span class="op" id="6336817">.</span><span class="ident" id="6336818">err</span>&nbsp;<span class="op" id="6336822">!=</span>&nbsp;<span class="ident" id="6336825">nil</span>&nbsp;<span class="op" id="6336829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336833">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6336841">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336845">if</span>&nbsp;<span class="builtinfunc" id="6336848">len</span><span class="op" id="6336851">(</span><span class="ident" id="6336852">pm</span><span class="op" id="6336854">.</span><span class="ident" id="6336855">Palette</span><span class="op" id="6336862">)</span>&nbsp;<span class="op" id="6336864">==</span>&nbsp;<span class="num" id="6336867">0</span>&nbsp;<span class="op" id="6336869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336873">e</span><span class="op" id="6336874">.</span><span class="ident" id="6336875">err</span>&nbsp;<span class="op" id="6336879">=</span>&nbsp;<span class="ident" id="6336881">errors</span><span class="op" id="6336887">.</span><span class="ident" id="6336888">New</span><span class="op" id="6336891">(</span><span class="string" id="6336892">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="6336943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336947">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6336955">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6336959">b</span>&nbsp;<span class="op" id="6336961">:=</span>&nbsp;<span class="ident" id="6336964">pm</span><span class="op" id="6336966">.</span><span class="ident" id="6336967">Bounds</span><span class="op" id="6336973">(</span><span class="op" id="6336974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6336977">if</span>&nbsp;<span class="ident" id="6336980">b</span><span class="op" id="6336981">.</span><span class="ident" id="6336982">Dx</span><span class="op" id="6336984">(</span><span class="op" id="6336985">)</span>&nbsp;<span class="op" id="6336987">&gt;=</span>&nbsp;<span class="num" id="6336990">1</span><span class="op" id="6336991">&lt;&lt;</span><span class="num" id="6336993">16</span>&nbsp;<span class="op" id="6336996">||</span>&nbsp;<span class="ident" id="6336999">b</span><span class="op" id="6337000">.</span><span class="ident" id="6337001">Dy</span><span class="op" id="6337003">(</span><span class="op" id="6337004">)</span>&nbsp;<span class="op" id="6337006">&gt;=</span>&nbsp;<span class="num" id="6337009">1</span><span class="op" id="6337010">&lt;&lt;</span><span class="num" id="6337012">16</span>&nbsp;<span class="op" id="6337015">||</span>&nbsp;<span class="ident" id="6337018">b</span><span class="op" id="6337019">.</span><span class="ident" id="6337020">Min</span><span class="op" id="6337023">.</span><span class="ident" id="6337024">X</span>&nbsp;<span class="op" id="6337026">&lt;</span>&nbsp;<span class="num" id="6337028">0</span>&nbsp;<span class="op" id="6337030">||</span>&nbsp;<span class="ident" id="6337033">b</span><span class="op" id="6337034">.</span><span class="ident" id="6337035">Min</span><span class="op" id="6337038">.</span><span class="ident" id="6337039">X</span>&nbsp;<span class="op" id="6337041">&gt;=</span>&nbsp;<span class="num" id="6337044">1</span><span class="op" id="6337045">&lt;&lt;</span><span class="num" id="6337047">16</span>&nbsp;<span class="op" id="6337050">||</span>&nbsp;<span class="ident" id="6337053">b</span><span class="op" id="6337054">.</span><span class="ident" id="6337055">Min</span><span class="op" id="6337058">.</span><span class="ident" id="6337059">Y</span>&nbsp;<span class="op" id="6337061">&lt;</span>&nbsp;<span class="num" id="6337063">0</span>&nbsp;<span class="op" id="6337065">||</span>&nbsp;<span class="ident" id="6337068">b</span><span class="op" id="6337069">.</span><span class="ident" id="6337070">Min</span><span class="op" id="6337073">.</span><span class="ident" id="6337074">Y</span>&nbsp;<span class="op" id="6337076">&gt;=</span>&nbsp;<span class="num" id="6337079">1</span><span class="op" id="6337080">&lt;&lt;</span><span class="num" id="6337082">16</span>&nbsp;<span class="op" id="6337085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337089">e</span><span class="op" id="6337090">.</span><span class="ident" id="6337091">err</span>&nbsp;<span class="op" id="6337095">=</span>&nbsp;<span class="ident" id="6337097">errors</span><span class="op" id="6337103">.</span><span class="ident" id="6337104">New</span><span class="op" id="6337107">(</span><span class="string" id="6337108">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6337149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6337153">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6337161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337165">transparentIndex</span>&nbsp;<span class="op" id="6337182">:=</span>&nbsp;<span class="op" id="6337185">-</span><span class="num" id="6337186">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6337189">for</span>&nbsp;<span class="ident" id="6337193">i</span><span class="op" id="6337194">,</span>&nbsp;<span class="ident" id="6337196">c</span>&nbsp;<span class="op" id="6337198">:=</span>&nbsp;<span class="keyword" id="6337201">range</span>&nbsp;<span class="ident" id="6337207">pm</span><span class="op" id="6337209">.</span><span class="ident" id="6337210">Palette</span>&nbsp;<span class="op" id="6337218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6337222">if</span>&nbsp;<span class="ident" id="6337225">_</span><span class="op" id="6337226">,</span>&nbsp;<span class="ident" id="6337228">_</span><span class="op" id="6337229">,</span>&nbsp;<span class="ident" id="6337231">_</span><span class="op" id="6337232">,</span>&nbsp;<span class="ident" id="6337234">a</span>&nbsp;<span class="op" id="6337236">:=</span>&nbsp;<span class="ident" id="6337239">c</span><span class="op" id="6337240">.</span><span class="ident" id="6337241">RGBA</span><span class="op" id="6337245">(</span><span class="op" id="6337246">)</span><span class="op" id="6337247">;</span>&nbsp;<span class="ident" id="6337249">a</span>&nbsp;<span class="op" id="6337251">==</span>&nbsp;<span class="num" id="6337254">0</span>&nbsp;<span class="op" id="6337256">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337261">transparentIndex</span>&nbsp;<span class="op" id="6337278">=</span>&nbsp;<span class="ident" id="6337280">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6337285">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6337293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6337296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6337300">if</span>&nbsp;<span class="ident" id="6337303">delay</span>&nbsp;<span class="op" id="6337309">&gt;</span>&nbsp;<span class="num" id="6337311">0</span>&nbsp;<span class="op" id="6337313">||</span>&nbsp;<span class="ident" id="6337316">transparentIndex</span>&nbsp;<span class="op" id="6337333">!=</span>&nbsp;<span class="op" id="6337336">-</span><span class="num" id="6337337">1</span>&nbsp;<span class="op" id="6337339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337343">e</span><span class="op" id="6337344">.</span><span class="ident" id="6337345">buf</span><span class="op" id="6337348">[</span><span class="num" id="6337349">0</span><span class="op" id="6337350">]</span>&nbsp;<span class="op" id="6337352">=</span>&nbsp;<span class="ident" id="6337354">sExtension</span>&nbsp;&nbsp;<span class="comment" id="6337366">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337393">e</span><span class="op" id="6337394">.</span><span class="ident" id="6337395">buf</span><span class="op" id="6337398">[</span><span class="num" id="6337399">1</span><span class="op" id="6337400">]</span>&nbsp;<span class="op" id="6337402">=</span>&nbsp;<span class="ident" id="6337404">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6337416">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337444">e</span><span class="op" id="6337445">.</span><span class="ident" id="6337446">buf</span><span class="op" id="6337449">[</span><span class="num" id="6337450">2</span><span class="op" id="6337451">]</span>&nbsp;<span class="op" id="6337453">=</span>&nbsp;<span class="ident" id="6337455">gcBlockSize</span>&nbsp;<span class="comment" id="6337467">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6337484">if</span>&nbsp;<span class="ident" id="6337487">transparentIndex</span>&nbsp;<span class="op" id="6337504">!=</span>&nbsp;<span class="op" id="6337507">-</span><span class="num" id="6337508">1</span>&nbsp;<span class="op" id="6337510">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337515">e</span><span class="op" id="6337516">.</span><span class="ident" id="6337517">buf</span><span class="op" id="6337520">[</span><span class="num" id="6337521">3</span><span class="op" id="6337522">]</span>&nbsp;<span class="op" id="6337524">=</span>&nbsp;<span class="num" id="6337526">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6337533">}</span>&nbsp;<span class="keyword" id="6337535">else</span>&nbsp;<span class="op" id="6337540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337545">e</span><span class="op" id="6337546">.</span><span class="ident" id="6337547">buf</span><span class="op" id="6337550">[</span><span class="num" id="6337551">3</span><span class="op" id="6337552">]</span>&nbsp;<span class="op" id="6337554">=</span>&nbsp;<span class="num" id="6337556">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6337563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337567">writeUint16</span><span class="op" id="6337578">(</span><span class="ident" id="6337579">e</span><span class="op" id="6337580">.</span><span class="ident" id="6337581">buf</span><span class="op" id="6337584">[</span><span class="num" id="6337585">4</span><span class="op" id="6337586">:</span><span class="num" id="6337587">6</span><span class="op" id="6337588">]</span><span class="op" id="6337589">,</span>&nbsp;<span class="builtintype" id="6337591">uint16</span><span class="op" id="6337597">(</span><span class="ident" id="6337598">delay</span><span class="op" id="6337603">)</span><span class="op" id="6337604">)</span>&nbsp;<span class="comment" id="6337606">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6337646">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6337676">if</span>&nbsp;<span class="ident" id="6337679">transparentIndex</span>&nbsp;<span class="op" id="6337696">!=</span>&nbsp;<span class="op" id="6337699">-</span><span class="num" id="6337700">1</span>&nbsp;<span class="op" id="6337702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337707">e</span><span class="op" id="6337708">.</span><span class="ident" id="6337709">buf</span><span class="op" id="6337712">[</span><span class="num" id="6337713">6</span><span class="op" id="6337714">]</span>&nbsp;<span class="op" id="6337716">=</span>&nbsp;<span class="builtintype" id="6337718">uint8</span><span class="op" id="6337723">(</span><span class="ident" id="6337724">transparentIndex</span><span class="op" id="6337740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6337744">}</span>&nbsp;<span class="keyword" id="6337746">else</span>&nbsp;<span class="op" id="6337751">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337756">e</span><span class="op" id="6337757">.</span><span class="ident" id="6337758">buf</span><span class="op" id="6337761">[</span><span class="num" id="6337762">6</span><span class="op" id="6337763">]</span>&nbsp;<span class="op" id="6337765">=</span>&nbsp;<span class="num" id="6337767">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6337774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337778">e</span><span class="op" id="6337779">.</span><span class="ident" id="6337780">buf</span><span class="op" id="6337783">[</span><span class="num" id="6337784">7</span><span class="op" id="6337785">]</span>&nbsp;<span class="op" id="6337787">=</span>&nbsp;<span class="num" id="6337789">0x00</span>&nbsp;<span class="comment" id="6337794">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337817">e</span><span class="op" id="6337818">.</span><span class="ident" id="6337819">write</span><span class="op" id="6337824">(</span><span class="ident" id="6337825">e</span><span class="op" id="6337826">.</span><span class="ident" id="6337827">buf</span><span class="op" id="6337830">[</span><span class="op" id="6337831">:</span><span class="num" id="6337832">8</span><span class="op" id="6337833">]</span><span class="op" id="6337834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6337837">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337840">e</span><span class="op" id="6337841">.</span><span class="ident" id="6337842">buf</span><span class="op" id="6337845">[</span><span class="num" id="6337846">0</span><span class="op" id="6337847">]</span>&nbsp;<span class="op" id="6337849">=</span>&nbsp;<span class="ident" id="6337851">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337869">writeUint16</span><span class="op" id="6337880">(</span><span class="ident" id="6337881">e</span><span class="op" id="6337882">.</span><span class="ident" id="6337883">buf</span><span class="op" id="6337886">[</span><span class="num" id="6337887">1</span><span class="op" id="6337888">:</span><span class="num" id="6337889">3</span><span class="op" id="6337890">]</span><span class="op" id="6337891">,</span>&nbsp;<span class="builtintype" id="6337893">uint16</span><span class="op" id="6337899">(</span><span class="ident" id="6337900">b</span><span class="op" id="6337901">.</span><span class="ident" id="6337902">Min</span><span class="op" id="6337905">.</span><span class="ident" id="6337906">X</span><span class="op" id="6337907">)</span><span class="op" id="6337908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337911">writeUint16</span><span class="op" id="6337922">(</span><span class="ident" id="6337923">e</span><span class="op" id="6337924">.</span><span class="ident" id="6337925">buf</span><span class="op" id="6337928">[</span><span class="num" id="6337929">3</span><span class="op" id="6337930">:</span><span class="num" id="6337931">5</span><span class="op" id="6337932">]</span><span class="op" id="6337933">,</span>&nbsp;<span class="builtintype" id="6337935">uint16</span><span class="op" id="6337941">(</span><span class="ident" id="6337942">b</span><span class="op" id="6337943">.</span><span class="ident" id="6337944">Min</span><span class="op" id="6337947">.</span><span class="ident" id="6337948">Y</span><span class="op" id="6337949">)</span><span class="op" id="6337950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337953">writeUint16</span><span class="op" id="6337964">(</span><span class="ident" id="6337965">e</span><span class="op" id="6337966">.</span><span class="ident" id="6337967">buf</span><span class="op" id="6337970">[</span><span class="num" id="6337971">5</span><span class="op" id="6337972">:</span><span class="num" id="6337973">7</span><span class="op" id="6337974">]</span><span class="op" id="6337975">,</span>&nbsp;<span class="builtintype" id="6337977">uint16</span><span class="op" id="6337983">(</span><span class="ident" id="6337984">b</span><span class="op" id="6337985">.</span><span class="ident" id="6337986">Dx</span><span class="op" id="6337988">(</span><span class="op" id="6337989">)</span><span class="op" id="6337990">)</span><span class="op" id="6337991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6337994">writeUint16</span><span class="op" id="6338005">(</span><span class="ident" id="6338006">e</span><span class="op" id="6338007">.</span><span class="ident" id="6338008">buf</span><span class="op" id="6338011">[</span><span class="num" id="6338012">7</span><span class="op" id="6338013">:</span><span class="num" id="6338014">9</span><span class="op" id="6338015">]</span><span class="op" id="6338016">,</span>&nbsp;<span class="builtintype" id="6338018">uint16</span><span class="op" id="6338024">(</span><span class="ident" id="6338025">b</span><span class="op" id="6338026">.</span><span class="ident" id="6338027">Dy</span><span class="op" id="6338029">(</span><span class="op" id="6338030">)</span><span class="op" id="6338031">)</span><span class="op" id="6338032">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338035">e</span><span class="op" id="6338036">.</span><span class="ident" id="6338037">write</span><span class="op" id="6338042">(</span><span class="ident" id="6338043">e</span><span class="op" id="6338044">.</span><span class="ident" id="6338045">buf</span><span class="op" id="6338048">[</span><span class="op" id="6338049">:</span><span class="num" id="6338050">9</span><span class="op" id="6338051">]</span><span class="op" id="6338052">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338056">paddedSize</span>&nbsp;<span class="op" id="6338067">:=</span>&nbsp;<span class="ident" id="6338070">log2</span><span class="op" id="6338074">(</span><span class="builtinfunc" id="6338075">len</span><span class="op" id="6338078">(</span><span class="ident" id="6338079">pm</span><span class="op" id="6338081">.</span><span class="ident" id="6338082">Palette</span><span class="op" id="6338089">)</span><span class="op" id="6338090">)</span>&nbsp;<span class="comment" id="6338092">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6338132">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338166">e</span><span class="op" id="6338167">.</span><span class="ident" id="6338168">writeByte</span><span class="op" id="6338177">(</span><span class="num" id="6338178">0x80</span>&nbsp;<span class="op" id="6338183">|</span>&nbsp;<span class="builtintype" id="6338185">uint8</span><span class="op" id="6338190">(</span><span class="ident" id="6338191">paddedSize</span><span class="op" id="6338201">)</span><span class="op" id="6338202">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6338206">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338229">e</span><span class="op" id="6338230">.</span><span class="ident" id="6338231">writeColorTable</span><span class="op" id="6338246">(</span><span class="ident" id="6338247">pm</span><span class="op" id="6338249">.</span><span class="ident" id="6338250">Palette</span><span class="op" id="6338257">,</span>&nbsp;<span class="ident" id="6338259">paddedSize</span><span class="op" id="6338269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338273">litWidth</span>&nbsp;<span class="op" id="6338282">:=</span>&nbsp;<span class="ident" id="6338285">paddedSize</span>&nbsp;<span class="op" id="6338296">+</span>&nbsp;<span class="num" id="6338298">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6338301">if</span>&nbsp;<span class="ident" id="6338304">litWidth</span>&nbsp;<span class="op" id="6338313">&lt;</span>&nbsp;<span class="num" id="6338315">2</span>&nbsp;<span class="op" id="6338317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338321">litWidth</span>&nbsp;<span class="op" id="6338330">=</span>&nbsp;<span class="num" id="6338332">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6338335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338338">e</span><span class="op" id="6338339">.</span><span class="ident" id="6338340">writeByte</span><span class="op" id="6338349">(</span><span class="builtintype" id="6338350">uint8</span><span class="op" id="6338355">(</span><span class="ident" id="6338356">litWidth</span><span class="op" id="6338364">)</span><span class="op" id="6338365">)</span>&nbsp;<span class="comment" id="6338367">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338395">lzww</span>&nbsp;<span class="op" id="6338400">:=</span>&nbsp;<span class="ident" id="6338403">lzw</span><span class="op" id="6338406">.</span><span class="ident" id="6338407">NewWriter</span><span class="op" id="6338416">(</span><span class="ident" id="6338417">blockWriter</span><span class="op" id="6338428">{</span><span class="ident" id="6338429">e</span><span class="op" id="6338430">:</span>&nbsp;<span class="ident" id="6338432">e</span><span class="op" id="6338433">}</span><span class="op" id="6338434">,</span>&nbsp;<span class="ident" id="6338436">lzw</span><span class="op" id="6338439">.</span><span class="ident" id="6338440">LSB</span><span class="op" id="6338443">,</span>&nbsp;<span class="ident" id="6338445">litWidth</span><span class="op" id="6338453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6338456">if</span>&nbsp;<span class="ident" id="6338459">dx</span>&nbsp;<span class="op" id="6338462">:=</span>&nbsp;<span class="ident" id="6338465">b</span><span class="op" id="6338466">.</span><span class="ident" id="6338467">Dx</span><span class="op" id="6338469">(</span><span class="op" id="6338470">)</span><span class="op" id="6338471">;</span>&nbsp;<span class="ident" id="6338473">dx</span>&nbsp;<span class="op" id="6338476">==</span>&nbsp;<span class="ident" id="6338479">pm</span><span class="op" id="6338481">.</span><span class="ident" id="6338482">Stride</span>&nbsp;<span class="op" id="6338489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338493">_</span><span class="op" id="6338494">,</span>&nbsp;<span class="ident" id="6338496">e</span><span class="op" id="6338497">.</span><span class="ident" id="6338498">err</span>&nbsp;<span class="op" id="6338502">=</span>&nbsp;<span class="ident" id="6338504">lzww</span><span class="op" id="6338508">.</span><span class="ident" id="6338509">Write</span><span class="op" id="6338514">(</span><span class="ident" id="6338515">pm</span><span class="op" id="6338517">.</span><span class="ident" id="6338518">Pix</span><span class="op" id="6338521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6338525">if</span>&nbsp;<span class="ident" id="6338528">e</span><span class="op" id="6338529">.</span><span class="ident" id="6338530">err</span>&nbsp;<span class="op" id="6338534">!=</span>&nbsp;<span class="ident" id="6338537">nil</span>&nbsp;<span class="op" id="6338541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338546">lzww</span><span class="op" id="6338550">.</span><span class="ident" id="6338551">Close</span><span class="op" id="6338556">(</span><span class="op" id="6338557">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6338562">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6338571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6338574">}</span>&nbsp;<span class="keyword" id="6338576">else</span>&nbsp;<span class="op" id="6338581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6338585">for</span>&nbsp;<span class="ident" id="6338589">i</span><span class="op" id="6338590">,</span>&nbsp;<span class="ident" id="6338592">y</span>&nbsp;<span class="op" id="6338594">:=</span>&nbsp;<span class="num" id="6338597">0</span><span class="op" id="6338598">,</span>&nbsp;<span class="ident" id="6338600">b</span><span class="op" id="6338601">.</span><span class="ident" id="6338602">Min</span><span class="op" id="6338605">.</span><span class="ident" id="6338606">Y</span><span class="op" id="6338607">;</span>&nbsp;<span class="ident" id="6338609">y</span>&nbsp;<span class="op" id="6338611">&lt;</span>&nbsp;<span class="ident" id="6338613">b</span><span class="op" id="6338614">.</span><span class="ident" id="6338615">Max</span><span class="op" id="6338618">.</span><span class="ident" id="6338619">Y</span><span class="op" id="6338620">;</span>&nbsp;<span class="ident" id="6338622">i</span><span class="op" id="6338623">,</span>&nbsp;<span class="ident" id="6338625">y</span>&nbsp;<span class="op" id="6338627">=</span>&nbsp;<span class="ident" id="6338629">i</span><span class="op" id="6338630">+</span><span class="ident" id="6338631">pm</span><span class="op" id="6338633">.</span><span class="ident" id="6338634">Stride</span><span class="op" id="6338640">,</span>&nbsp;<span class="ident" id="6338642">y</span><span class="op" id="6338643">+</span><span class="num" id="6338644">1</span>&nbsp;<span class="op" id="6338646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338651">_</span><span class="op" id="6338652">,</span>&nbsp;<span class="ident" id="6338654">e</span><span class="op" id="6338655">.</span><span class="ident" id="6338656">err</span>&nbsp;<span class="op" id="6338660">=</span>&nbsp;<span class="ident" id="6338662">lzww</span><span class="op" id="6338666">.</span><span class="ident" id="6338667">Write</span><span class="op" id="6338672">(</span><span class="ident" id="6338673">pm</span><span class="op" id="6338675">.</span><span class="ident" id="6338676">Pix</span><span class="op" id="6338679">[</span><span class="ident" id="6338680">i</span>&nbsp;<span class="op" id="6338682">:</span>&nbsp;<span class="ident" id="6338684">i</span><span class="op" id="6338685">+</span><span class="ident" id="6338686">dx</span><span class="op" id="6338688">]</span><span class="op" id="6338689">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6338694">if</span>&nbsp;<span class="ident" id="6338697">e</span><span class="op" id="6338698">.</span><span class="ident" id="6338699">err</span>&nbsp;<span class="op" id="6338703">!=</span>&nbsp;<span class="ident" id="6338706">nil</span>&nbsp;<span class="op" id="6338710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338716">lzww</span><span class="op" id="6338720">.</span><span class="ident" id="6338721">Close</span><span class="op" id="6338726">(</span><span class="op" id="6338727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6338733">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6338743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6338747">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6338750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338753">lzww</span><span class="op" id="6338757">.</span><span class="ident" id="6338758">Close</span><span class="op" id="6338763">(</span><span class="op" id="6338764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338767">e</span><span class="op" id="6338768">.</span><span class="ident" id="6338769">writeByte</span><span class="op" id="6338778">(</span><span class="num" id="6338779">0x00</span><span class="op" id="6338783">)</span>&nbsp;<span class="comment" id="6338785">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="6338806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6338809">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="6338849">type</span>&nbsp;<span class="ident" id="6338854">Options</span>&nbsp;<span class="keyword" id="6338862">struct</span>&nbsp;<span class="op" id="6338869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6338872">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6338937">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6338966">NumColors</span>&nbsp;<span class="builtintype" id="6338976">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6338982">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6339046">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339101">Quantizer</span>&nbsp;<span class="ident" id="6339111">draw</span><span class="op" id="6339115">.</span><span class="ident" id="6339116">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6339128">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6339199">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339257">Drawer</span>&nbsp;<span class="ident" id="6339264">draw</span><span class="op" id="6339268">.</span><span class="ident" id="6339269">Drawer</span><br>
<span class="lineno"></span><span class="op" id="6339276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6339279">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6339343">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="6339389">func</span>&nbsp;<span class="ident" id="6339394">EncodeAll</span><span class="op" id="6339403">(</span><span class="ident" id="6339404">w</span>&nbsp;<span class="ident" id="6339406">io</span><span class="op" id="6339408">.</span><span class="ident" id="6339409">Writer</span><span class="op" id="6339415">,</span>&nbsp;<span class="ident" id="6339417">g</span>&nbsp;<span class="op" id="6339419">*</span><span class="ident" id="6339420">GIF</span><span class="op" id="6339423">)</span>&nbsp;<span class="builtintype" id="6339425">error</span>&nbsp;<span class="op" id="6339431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6339434">if</span>&nbsp;<span class="builtinfunc" id="6339437">len</span><span class="op" id="6339440">(</span><span class="ident" id="6339441">g</span><span class="op" id="6339442">.</span><span class="ident" id="6339443">Image</span><span class="op" id="6339448">)</span>&nbsp;<span class="op" id="6339450">==</span>&nbsp;<span class="num" id="6339453">0</span>&nbsp;<span class="op" id="6339455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6339459">return</span>&nbsp;<span class="ident" id="6339466">errors</span><span class="op" id="6339472">.</span><span class="ident" id="6339473">New</span><span class="op" id="6339476">(</span><span class="string" id="6339477">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="6339515">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6339518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6339522">if</span>&nbsp;<span class="builtinfunc" id="6339525">len</span><span class="op" id="6339528">(</span><span class="ident" id="6339529">g</span><span class="op" id="6339530">.</span><span class="ident" id="6339531">Image</span><span class="op" id="6339536">)</span>&nbsp;<span class="op" id="6339538">!=</span>&nbsp;<span class="builtinfunc" id="6339541">len</span><span class="op" id="6339544">(</span><span class="ident" id="6339545">g</span><span class="op" id="6339546">.</span><span class="ident" id="6339547">Delay</span><span class="op" id="6339552">)</span>&nbsp;<span class="op" id="6339554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6339558">return</span>&nbsp;<span class="ident" id="6339565">errors</span><span class="op" id="6339571">.</span><span class="ident" id="6339572">New</span><span class="op" id="6339575">(</span><span class="string" id="6339576">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="6339617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6339620">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6339623">if</span>&nbsp;<span class="ident" id="6339626">g</span><span class="op" id="6339627">.</span><span class="ident" id="6339628">LoopCount</span>&nbsp;<span class="op" id="6339638">&lt;</span>&nbsp;<span class="num" id="6339640">0</span>&nbsp;<span class="op" id="6339642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339646">g</span><span class="op" id="6339647">.</span><span class="ident" id="6339648">LoopCount</span>&nbsp;<span class="op" id="6339658">=</span>&nbsp;<span class="num" id="6339660">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6339663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339667">e</span>&nbsp;<span class="op" id="6339669">:=</span>&nbsp;<span class="ident" id="6339672">encoder</span><span class="op" id="6339679">{</span><span class="ident" id="6339680">g</span><span class="op" id="6339681">:</span>&nbsp;<span class="ident" id="6339683">g</span><span class="op" id="6339684">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6339687">if</span>&nbsp;<span class="ident" id="6339690">ww</span><span class="op" id="6339692">,</span>&nbsp;<span class="ident" id="6339694">ok</span>&nbsp;<span class="op" id="6339697">:=</span>&nbsp;<span class="ident" id="6339700">w</span><span class="op" id="6339701">.</span><span class="op" id="6339702">(</span><span class="ident" id="6339703">writer</span><span class="op" id="6339709">)</span><span class="op" id="6339710">;</span>&nbsp;<span class="ident" id="6339712">ok</span>&nbsp;<span class="op" id="6339715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339719">e</span><span class="op" id="6339720">.</span><span class="ident" id="6339721">w</span>&nbsp;<span class="op" id="6339723">=</span>&nbsp;<span class="ident" id="6339725">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6339729">}</span>&nbsp;<span class="keyword" id="6339731">else</span>&nbsp;<span class="op" id="6339736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339740">e</span><span class="op" id="6339741">.</span><span class="ident" id="6339742">w</span>&nbsp;<span class="op" id="6339744">=</span>&nbsp;<span class="ident" id="6339746">bufio</span><span class="op" id="6339751">.</span><span class="ident" id="6339752">NewWriter</span><span class="op" id="6339761">(</span><span class="ident" id="6339762">w</span><span class="op" id="6339763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6339766">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339770">e</span><span class="op" id="6339771">.</span><span class="ident" id="6339772">writeHeader</span><span class="op" id="6339783">(</span><span class="op" id="6339784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6339787">for</span>&nbsp;<span class="ident" id="6339791">i</span><span class="op" id="6339792">,</span>&nbsp;<span class="ident" id="6339794">pm</span>&nbsp;<span class="op" id="6339797">:=</span>&nbsp;<span class="keyword" id="6339800">range</span>&nbsp;<span class="ident" id="6339806">g</span><span class="op" id="6339807">.</span><span class="ident" id="6339808">Image</span>&nbsp;<span class="op" id="6339814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339818">e</span><span class="op" id="6339819">.</span><span class="ident" id="6339820">writeImageBlock</span><span class="op" id="6339835">(</span><span class="ident" id="6339836">pm</span><span class="op" id="6339838">,</span>&nbsp;<span class="ident" id="6339840">g</span><span class="op" id="6339841">.</span><span class="ident" id="6339842">Delay</span><span class="op" id="6339847">[</span><span class="ident" id="6339848">i</span><span class="op" id="6339849">]</span><span class="op" id="6339850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6339853">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339856">e</span><span class="op" id="6339857">.</span><span class="ident" id="6339858">writeByte</span><span class="op" id="6339867">(</span><span class="ident" id="6339868">sTrailer</span><span class="op" id="6339876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6339879">e</span><span class="op" id="6339880">.</span><span class="ident" id="6339881">flush</span><span class="op" id="6339886">(</span><span class="op" id="6339887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6339890">return</span>&nbsp;<span class="ident" id="6339897">e</span><span class="op" id="6339898">.</span><span class="ident" id="6339899">err</span><br>
<span class="lineno"></span><span class="op" id="6339903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="6339906">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6339955">func</span>&nbsp;<span class="ident" id="6339960">Encode</span><span class="op" id="6339966">(</span><span class="ident" id="6339967">w</span>&nbsp;<span class="ident" id="6339969">io</span><span class="op" id="6339971">.</span><span class="ident" id="6339972">Writer</span><span class="op" id="6339978">,</span>&nbsp;<span class="ident" id="6339980">m</span>&nbsp;<span class="ident" id="6339982">image</span><span class="op" id="6339987">.</span><span class="ident" id="6339988">Image</span><span class="op" id="6339993">,</span>&nbsp;<span class="ident" id="6339995">o</span>&nbsp;<span class="op" id="6339997">*</span><span class="ident" id="6339998">Options</span><span class="op" id="6340005">)</span>&nbsp;<span class="builtintype" id="6340007">error</span>&nbsp;<span class="op" id="6340013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6340016">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340060">b</span>&nbsp;<span class="op" id="6340062">:=</span>&nbsp;<span class="ident" id="6340065">m</span><span class="op" id="6340066">.</span><span class="ident" id="6340067">Bounds</span><span class="op" id="6340073">(</span><span class="op" id="6340074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6340077">if</span>&nbsp;<span class="ident" id="6340080">b</span><span class="op" id="6340081">.</span><span class="ident" id="6340082">Dx</span><span class="op" id="6340084">(</span><span class="op" id="6340085">)</span>&nbsp;<span class="op" id="6340087">&gt;=</span>&nbsp;<span class="num" id="6340090">1</span><span class="op" id="6340091">&lt;&lt;</span><span class="num" id="6340093">16</span>&nbsp;<span class="op" id="6340096">||</span>&nbsp;<span class="ident" id="6340099">b</span><span class="op" id="6340100">.</span><span class="ident" id="6340101">Dy</span><span class="op" id="6340103">(</span><span class="op" id="6340104">)</span>&nbsp;<span class="op" id="6340106">&gt;=</span>&nbsp;<span class="num" id="6340109">1</span><span class="op" id="6340110">&lt;&lt;</span><span class="num" id="6340112">16</span>&nbsp;<span class="op" id="6340115">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6340119">return</span>&nbsp;<span class="ident" id="6340126">errors</span><span class="op" id="6340132">.</span><span class="ident" id="6340133">New</span><span class="op" id="6340136">(</span><span class="string" id="6340137">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6340172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6340175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340179">opts</span>&nbsp;<span class="op" id="6340184">:=</span>&nbsp;<span class="ident" id="6340187">Options</span><span class="op" id="6340194">{</span><span class="op" id="6340195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6340198">if</span>&nbsp;<span class="ident" id="6340201">o</span>&nbsp;<span class="op" id="6340203">!=</span>&nbsp;<span class="ident" id="6340206">nil</span>&nbsp;<span class="op" id="6340210">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340214">opts</span>&nbsp;<span class="op" id="6340219">=</span>&nbsp;<span class="op" id="6340221">*</span><span class="ident" id="6340222">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6340225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6340228">if</span>&nbsp;<span class="ident" id="6340231">opts</span><span class="op" id="6340235">.</span><span class="ident" id="6340236">NumColors</span>&nbsp;<span class="op" id="6340246">&lt;</span>&nbsp;<span class="num" id="6340248">1</span>&nbsp;<span class="op" id="6340250">||</span>&nbsp;<span class="num" id="6340253">256</span>&nbsp;<span class="op" id="6340257">&lt;</span>&nbsp;<span class="ident" id="6340259">opts</span><span class="op" id="6340263">.</span><span class="ident" id="6340264">NumColors</span>&nbsp;<span class="op" id="6340274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340278">opts</span><span class="op" id="6340282">.</span><span class="ident" id="6340283">NumColors</span>&nbsp;<span class="op" id="6340293">=</span>&nbsp;<span class="num" id="6340295">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6340300">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6340303">if</span>&nbsp;<span class="ident" id="6340306">opts</span><span class="op" id="6340310">.</span><span class="ident" id="6340311">Drawer</span>&nbsp;<span class="op" id="6340318">==</span>&nbsp;<span class="ident" id="6340321">nil</span>&nbsp;<span class="op" id="6340325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340329">opts</span><span class="op" id="6340333">.</span><span class="ident" id="6340334">Drawer</span>&nbsp;<span class="op" id="6340341">=</span>&nbsp;<span class="ident" id="6340343">draw</span><span class="op" id="6340347">.</span><span class="ident" id="6340348">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6340364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340368">pm</span><span class="op" id="6340370">,</span>&nbsp;<span class="ident" id="6340372">ok</span>&nbsp;<span class="op" id="6340375">:=</span>&nbsp;<span class="ident" id="6340378">m</span><span class="op" id="6340379">.</span><span class="op" id="6340380">(</span><span class="op" id="6340381">*</span><span class="ident" id="6340382">image</span><span class="op" id="6340387">.</span><span class="ident" id="6340388">Paletted</span><span class="op" id="6340396">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6340399">if</span>&nbsp;<span class="op" id="6340402">!</span><span class="ident" id="6340403">ok</span>&nbsp;<span class="op" id="6340406">||</span>&nbsp;<span class="builtinfunc" id="6340409">len</span><span class="op" id="6340412">(</span><span class="ident" id="6340413">pm</span><span class="op" id="6340415">.</span><span class="ident" id="6340416">Palette</span><span class="op" id="6340423">)</span>&nbsp;<span class="op" id="6340425">&gt;</span>&nbsp;<span class="ident" id="6340427">opts</span><span class="op" id="6340431">.</span><span class="ident" id="6340432">NumColors</span>&nbsp;<span class="op" id="6340442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6340446">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340505">pm</span>&nbsp;<span class="op" id="6340508">=</span>&nbsp;<span class="ident" id="6340510">image</span><span class="op" id="6340515">.</span><span class="ident" id="6340516">NewPaletted</span><span class="op" id="6340527">(</span><span class="ident" id="6340528">b</span><span class="op" id="6340529">,</span>&nbsp;<span class="ident" id="6340531">palette</span><span class="op" id="6340538">.</span><span class="ident" id="6340539">Plan9</span><span class="op" id="6340544">[</span><span class="op" id="6340545">:</span><span class="ident" id="6340546">opts</span><span class="op" id="6340550">.</span><span class="ident" id="6340551">NumColors</span><span class="op" id="6340560">]</span><span class="op" id="6340561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6340565">if</span>&nbsp;<span class="ident" id="6340568">opts</span><span class="op" id="6340572">.</span><span class="ident" id="6340573">Quantizer</span>&nbsp;<span class="op" id="6340583">!=</span>&nbsp;<span class="ident" id="6340586">nil</span>&nbsp;<span class="op" id="6340590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340595">pm</span><span class="op" id="6340597">.</span><span class="ident" id="6340598">Palette</span>&nbsp;<span class="op" id="6340606">=</span>&nbsp;<span class="ident" id="6340608">opts</span><span class="op" id="6340612">.</span><span class="ident" id="6340613">Quantizer</span><span class="op" id="6340622">.</span><span class="ident" id="6340623">Quantize</span><span class="op" id="6340631">(</span><span class="builtinfunc" id="6340632">make</span><span class="op" id="6340636">(</span><span class="ident" id="6340637">color</span><span class="op" id="6340642">.</span><span class="ident" id="6340643">Palette</span><span class="op" id="6340650">,</span>&nbsp;<span class="num" id="6340652">0</span><span class="op" id="6340653">,</span>&nbsp;<span class="ident" id="6340655">opts</span><span class="op" id="6340659">.</span><span class="ident" id="6340660">NumColors</span><span class="op" id="6340669">)</span><span class="op" id="6340670">,</span>&nbsp;<span class="ident" id="6340672">m</span><span class="op" id="6340673">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6340677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340681">opts</span><span class="op" id="6340685">.</span><span class="ident" id="6340686">Drawer</span><span class="op" id="6340692">.</span><span class="ident" id="6340693">Draw</span><span class="op" id="6340697">(</span><span class="ident" id="6340698">pm</span><span class="op" id="6340700">,</span>&nbsp;<span class="ident" id="6340702">b</span><span class="op" id="6340703">,</span>&nbsp;<span class="ident" id="6340705">m</span><span class="op" id="6340706">,</span>&nbsp;<span class="ident" id="6340708">image</span><span class="op" id="6340713">.</span><span class="ident" id="6340714">ZP</span><span class="op" id="6340716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6340719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6340723">return</span>&nbsp;<span class="ident" id="6340730">EncodeAll</span><span class="op" id="6340739">(</span><span class="ident" id="6340740">w</span><span class="op" id="6340741">,</span>&nbsp;<span class="op" id="6340743">&amp;</span><span class="ident" id="6340744">GIF</span><span class="op" id="6340747">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340751">Image</span><span class="op" id="6340756">:</span>&nbsp;<span class="op" id="6340758">[</span><span class="op" id="6340759">]</span><span class="op" id="6340760">*</span><span class="ident" id="6340761">image</span><span class="op" id="6340766">.</span><span class="ident" id="6340767">Paletted</span><span class="op" id="6340775">{</span><span class="ident" id="6340776">pm</span><span class="op" id="6340778">}</span><span class="op" id="6340779">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6340783">Delay</span><span class="op" id="6340788">:</span>&nbsp;<span class="op" id="6340790">[</span><span class="op" id="6340791">]</span><span class="builtintype" id="6340792">int</span><span class="op" id="6340795">{</span><span class="num" id="6340796">0</span><span class="op" id="6340797">}</span><span class="op" id="6340798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6340801">}</span><span class="op" id="6340802">)</span><br>
<span class="lineno"></span><span class="op" id="6340804">}</span>
</div>
</body>
</html>
