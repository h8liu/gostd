<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2251776">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2251831">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2251885">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2251936">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2251953">package</span>&nbsp;<span class="ident" id="2251961">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2251970">import</span>&nbsp;<span class="op" id="2251977">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2251980">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2251989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2251992">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2252082">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2252109">type</span>&nbsp;<span class="ident" id="2252114">SysProcIDMap</span>&nbsp;<span class="keyword" id="2252127">struct</span>&nbsp;<span class="op" id="2252134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252137">ContainerID</span>&nbsp;<span class="builtintype" id="2252149">int</span>&nbsp;<span class="comment" id="2252153">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252171">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252183">int</span>&nbsp;<span class="comment" id="2252187">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252200">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252212">int</span>&nbsp;<span class="comment" id="2252216">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2252225">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2252228">type</span>&nbsp;<span class="ident" id="2252233">SysProcAttr</span>&nbsp;<span class="keyword" id="2252245">struct</span>&nbsp;<span class="op" id="2252252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252255">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252267">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252282">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252294">Credential</span>&nbsp;&nbsp;<span class="op" id="2252306">*</span><span class="ident" id="2252307">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252321">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252337">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252349">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252364">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252384">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252396">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252411">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252431">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252443">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252458">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252509">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252521">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252536">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252611">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252623">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252638">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252680">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2252692">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252707">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252743">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2252755">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252770">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252841">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2252853">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2252868">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252907">UidMappings</span>&nbsp;<span class="op" id="2252919">[</span><span class="op" id="2252920">]</span><span class="ident" id="2252921">SysProcIDMap</span>&nbsp;<span class="comment" id="2252934">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2252976">GidMappings</span>&nbsp;<span class="op" id="2252988">[</span><span class="op" id="2252989">]</span><span class="ident" id="2252990">SysProcIDMap</span>&nbsp;<span class="comment" id="2253003">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2253045">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2253048">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2253083">func</span>&nbsp;<span class="ident" id="2253088">runtime_BeforeFork</span><span class="op" id="2253106">(</span><span class="op" id="2253107">)</span><br>
<span class="lineno"></span><span class="keyword" id="2253109">func</span>&nbsp;<span class="ident" id="2253114">runtime_AfterFork</span><span class="op" id="2253131">(</span><span class="op" id="2253132">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2253135">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2253207">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2253265">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2253332">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2253399">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2253467">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2253531">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2253592">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2253654">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2253695">func</span>&nbsp;<span class="ident" id="2253700">forkAndExecInChild</span><span class="op" id="2253718">(</span><span class="ident" id="2253719">argv0</span>&nbsp;<span class="op" id="2253725">*</span><span class="builtintype" id="2253726">byte</span><span class="op" id="2253730">,</span>&nbsp;<span class="ident" id="2253732">argv</span><span class="op" id="2253736">,</span>&nbsp;<span class="ident" id="2253738">envv</span>&nbsp;<span class="op" id="2253743">[</span><span class="op" id="2253744">]</span><span class="op" id="2253745">*</span><span class="builtintype" id="2253746">byte</span><span class="op" id="2253750">,</span>&nbsp;<span class="ident" id="2253752">chroot</span><span class="op" id="2253758">,</span>&nbsp;<span class="ident" id="2253760">dir</span>&nbsp;<span class="op" id="2253764">*</span><span class="builtintype" id="2253765">byte</span><span class="op" id="2253769">,</span>&nbsp;<span class="ident" id="2253771">attr</span>&nbsp;<span class="op" id="2253776">*</span><span class="ident" id="2253777">ProcAttr</span><span class="op" id="2253785">,</span>&nbsp;<span class="ident" id="2253787">sys</span>&nbsp;<span class="op" id="2253791">*</span><span class="ident" id="2253792">SysProcAttr</span><span class="op" id="2253803">,</span>&nbsp;<span class="ident" id="2253805">pipe</span>&nbsp;<span class="builtintype" id="2253810">int</span><span class="op" id="2253813">)</span>&nbsp;<span class="op" id="2253815">(</span><span class="ident" id="2253816">pid</span>&nbsp;<span class="builtintype" id="2253820">int</span><span class="op" id="2253823">,</span>&nbsp;<span class="ident" id="2253825">err</span>&nbsp;<span class="ident" id="2253829">Errno</span><span class="op" id="2253834">)</span>&nbsp;<span class="op" id="2253836">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2253839">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2253884">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2253939">var</span>&nbsp;<span class="op" id="2253943">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2253947">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2253954">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2253964">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2253971">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2253979">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2253986">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2253994">nextfd</span>&nbsp;<span class="builtintype" id="2254001">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254007">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2254014">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254020">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2254027">[</span><span class="num" id="2254028">2</span><span class="op" id="2254029">]</span><span class="builtintype" id="2254030">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2254035">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2254039">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2254094">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2254158">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254217">fd</span>&nbsp;<span class="op" id="2254220">:=</span>&nbsp;<span class="builtinfunc" id="2254223">make</span><span class="op" id="2254227">(</span><span class="op" id="2254228">[</span><span class="op" id="2254229">]</span><span class="builtintype" id="2254230">int</span><span class="op" id="2254233">,</span>&nbsp;<span class="builtinfunc" id="2254235">len</span><span class="op" id="2254238">(</span><span class="ident" id="2254239">attr</span><span class="op" id="2254243">.</span><span class="ident" id="2254244">Files</span><span class="op" id="2254249">)</span><span class="op" id="2254250">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254253">nextfd</span>&nbsp;<span class="op" id="2254260">=</span>&nbsp;<span class="builtinfunc" id="2254262">len</span><span class="op" id="2254265">(</span><span class="ident" id="2254266">attr</span><span class="op" id="2254270">.</span><span class="ident" id="2254271">Files</span><span class="op" id="2254276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254279">for</span>&nbsp;<span class="ident" id="2254283">i</span><span class="op" id="2254284">,</span>&nbsp;<span class="ident" id="2254286">ufd</span>&nbsp;<span class="op" id="2254290">:=</span>&nbsp;<span class="keyword" id="2254293">range</span>&nbsp;<span class="ident" id="2254299">attr</span><span class="op" id="2254303">.</span><span class="ident" id="2254304">Files</span>&nbsp;<span class="op" id="2254310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254314">if</span>&nbsp;<span class="ident" id="2254317">nextfd</span>&nbsp;<span class="op" id="2254324">&lt;</span>&nbsp;<span class="builtintype" id="2254326">int</span><span class="op" id="2254329">(</span><span class="ident" id="2254330">ufd</span><span class="op" id="2254333">)</span>&nbsp;<span class="op" id="2254335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254340">nextfd</span>&nbsp;<span class="op" id="2254347">=</span>&nbsp;<span class="builtintype" id="2254349">int</span><span class="op" id="2254352">(</span><span class="ident" id="2254353">ufd</span><span class="op" id="2254356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2254360">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254364">fd</span><span class="op" id="2254366">[</span><span class="ident" id="2254367">i</span><span class="op" id="2254368">]</span>&nbsp;<span class="op" id="2254370">=</span>&nbsp;<span class="builtintype" id="2254372">int</span><span class="op" id="2254375">(</span><span class="ident" id="2254376">ufd</span><span class="op" id="2254379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2254382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254385">nextfd</span><span class="op" id="2254391">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2254396">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2254460">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254516">if</span>&nbsp;<span class="ident" id="2254519">sys</span><span class="op" id="2254522">.</span><span class="ident" id="2254523">UidMappings</span>&nbsp;<span class="op" id="2254535">!=</span>&nbsp;<span class="ident" id="2254538">nil</span>&nbsp;<span class="op" id="2254542">||</span>&nbsp;<span class="ident" id="2254545">sys</span><span class="op" id="2254548">.</span><span class="ident" id="2254549">GidMappings</span>&nbsp;<span class="op" id="2254561">!=</span>&nbsp;<span class="ident" id="2254564">nil</span>&nbsp;<span class="op" id="2254568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254572">if</span>&nbsp;<span class="ident" id="2254575">err</span>&nbsp;<span class="op" id="2254579">:=</span>&nbsp;<span class="ident" id="2254582">forkExecPipe</span><span class="op" id="2254594">(</span><span class="ident" id="2254595">p</span><span class="op" id="2254596">[</span><span class="op" id="2254597">:</span><span class="op" id="2254598">]</span><span class="op" id="2254599">)</span><span class="op" id="2254600">;</span>&nbsp;<span class="ident" id="2254602">err</span>&nbsp;<span class="op" id="2254606">!=</span>&nbsp;<span class="ident" id="2254609">nil</span>&nbsp;<span class="op" id="2254613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254618">return</span>&nbsp;<span class="num" id="2254625">0</span><span class="op" id="2254626">,</span>&nbsp;<span class="ident" id="2254628">err</span><span class="op" id="2254631">.</span><span class="op" id="2254632">(</span><span class="ident" id="2254633">Errno</span><span class="op" id="2254638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2254642">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2254645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2254649">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2254673">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254732">runtime_BeforeFork</span><span class="op" id="2254750">(</span><span class="op" id="2254751">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254754">r1</span><span class="op" id="2254756">,</span>&nbsp;<span class="ident" id="2254758">_</span><span class="op" id="2254759">,</span>&nbsp;<span class="ident" id="2254761">err1</span>&nbsp;<span class="op" id="2254766">=</span>&nbsp;<span class="ident" id="2254768">RawSyscall6</span><span class="op" id="2254779">(</span><span class="ident" id="2254780">SYS_CLONE</span><span class="op" id="2254789">,</span>&nbsp;<span class="builtintype" id="2254791">uintptr</span><span class="op" id="2254798">(</span><span class="ident" id="2254799">SIGCHLD</span><span class="op" id="2254806">)</span><span class="op" id="2254807">|</span><span class="ident" id="2254808">sys</span><span class="op" id="2254811">.</span><span class="ident" id="2254812">Cloneflags</span><span class="op" id="2254822">,</span>&nbsp;<span class="num" id="2254824">0</span><span class="op" id="2254825">,</span>&nbsp;<span class="num" id="2254827">0</span><span class="op" id="2254828">,</span>&nbsp;<span class="num" id="2254830">0</span><span class="op" id="2254831">,</span>&nbsp;<span class="num" id="2254833">0</span><span class="op" id="2254834">,</span>&nbsp;<span class="num" id="2254836">0</span><span class="op" id="2254837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254840">if</span>&nbsp;<span class="ident" id="2254843">err1</span>&nbsp;<span class="op" id="2254848">!=</span>&nbsp;<span class="num" id="2254851">0</span>&nbsp;<span class="op" id="2254853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254857">runtime_AfterFork</span><span class="op" id="2254874">(</span><span class="op" id="2254875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254879">return</span>&nbsp;<span class="num" id="2254886">0</span><span class="op" id="2254887">,</span>&nbsp;<span class="ident" id="2254889">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2254895">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254899">if</span>&nbsp;<span class="ident" id="2254902">r1</span>&nbsp;<span class="op" id="2254905">!=</span>&nbsp;<span class="num" id="2254908">0</span>&nbsp;<span class="op" id="2254910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2254914">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254938">runtime_AfterFork</span><span class="op" id="2254955">(</span><span class="op" id="2254956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2254960">pid</span>&nbsp;<span class="op" id="2254964">=</span>&nbsp;<span class="builtintype" id="2254966">int</span><span class="op" id="2254969">(</span><span class="ident" id="2254970">r1</span><span class="op" id="2254972">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2254977">if</span>&nbsp;<span class="ident" id="2254980">sys</span><span class="op" id="2254983">.</span><span class="ident" id="2254984">UidMappings</span>&nbsp;<span class="op" id="2254996">!=</span>&nbsp;<span class="ident" id="2254999">nil</span>&nbsp;<span class="op" id="2255003">||</span>&nbsp;<span class="ident" id="2255006">sys</span><span class="op" id="2255009">.</span><span class="ident" id="2255010">GidMappings</span>&nbsp;<span class="op" id="2255022">!=</span>&nbsp;<span class="ident" id="2255025">nil</span>&nbsp;<span class="op" id="2255029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255034">Close</span><span class="op" id="2255039">(</span><span class="ident" id="2255040">p</span><span class="op" id="2255041">[</span><span class="num" id="2255042">0</span><span class="op" id="2255043">]</span><span class="op" id="2255044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255049">err</span>&nbsp;<span class="op" id="2255053">:=</span>&nbsp;<span class="ident" id="2255056">writeUidGidMappings</span><span class="op" id="2255075">(</span><span class="ident" id="2255076">pid</span><span class="op" id="2255079">,</span>&nbsp;<span class="ident" id="2255081">sys</span><span class="op" id="2255084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255089">if</span>&nbsp;<span class="ident" id="2255092">err</span>&nbsp;<span class="op" id="2255096">!=</span>&nbsp;<span class="ident" id="2255099">nil</span>&nbsp;<span class="op" id="2255103">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255109">err2</span>&nbsp;<span class="op" id="2255114">=</span>&nbsp;<span class="ident" id="2255116">err</span><span class="op" id="2255119">.</span><span class="op" id="2255120">(</span><span class="ident" id="2255121">Errno</span><span class="op" id="2255126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255136">RawSyscall</span><span class="op" id="2255146">(</span><span class="ident" id="2255147">SYS_WRITE</span><span class="op" id="2255156">,</span>&nbsp;<span class="builtintype" id="2255158">uintptr</span><span class="op" id="2255165">(</span><span class="ident" id="2255166">p</span><span class="op" id="2255167">[</span><span class="num" id="2255168">1</span><span class="op" id="2255169">]</span><span class="op" id="2255170">)</span><span class="op" id="2255171">,</span>&nbsp;<span class="builtintype" id="2255173">uintptr</span><span class="op" id="2255180">(</span><span class="ident" id="2255181">unsafe</span><span class="op" id="2255187">.</span><span class="ident" id="2255188">Pointer</span><span class="op" id="2255195">(</span><span class="op" id="2255196">&amp;</span><span class="ident" id="2255197">err2</span><span class="op" id="2255201">)</span><span class="op" id="2255202">)</span><span class="op" id="2255203">,</span>&nbsp;<span class="ident" id="2255205">unsafe</span><span class="op" id="2255211">.</span><span class="ident" id="2255212">Sizeof</span><span class="op" id="2255218">(</span><span class="ident" id="2255219">err2</span><span class="op" id="2255223">)</span><span class="op" id="2255224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255229">Close</span><span class="op" id="2255234">(</span><span class="ident" id="2255235">p</span><span class="op" id="2255236">[</span><span class="num" id="2255237">1</span><span class="op" id="2255238">]</span><span class="op" id="2255239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255243">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255248">return</span>&nbsp;<span class="ident" id="2255255">pid</span><span class="op" id="2255258">,</span>&nbsp;<span class="num" id="2255260">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2255267">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2255302">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255356">if</span>&nbsp;<span class="ident" id="2255359">sys</span><span class="op" id="2255362">.</span><span class="ident" id="2255363">UidMappings</span>&nbsp;<span class="op" id="2255375">!=</span>&nbsp;<span class="ident" id="2255378">nil</span>&nbsp;<span class="op" id="2255382">||</span>&nbsp;<span class="ident" id="2255385">sys</span><span class="op" id="2255388">.</span><span class="ident" id="2255389">GidMappings</span>&nbsp;<span class="op" id="2255401">!=</span>&nbsp;<span class="ident" id="2255404">nil</span>&nbsp;<span class="op" id="2255408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255412">if</span>&nbsp;<span class="ident" id="2255415">_</span><span class="op" id="2255416">,</span>&nbsp;<span class="ident" id="2255418">_</span><span class="op" id="2255419">,</span>&nbsp;<span class="ident" id="2255421">err1</span>&nbsp;<span class="op" id="2255426">=</span>&nbsp;<span class="ident" id="2255428">RawSyscall</span><span class="op" id="2255438">(</span><span class="ident" id="2255439">SYS_CLOSE</span><span class="op" id="2255448">,</span>&nbsp;<span class="builtintype" id="2255450">uintptr</span><span class="op" id="2255457">(</span><span class="ident" id="2255458">p</span><span class="op" id="2255459">[</span><span class="num" id="2255460">1</span><span class="op" id="2255461">]</span><span class="op" id="2255462">)</span><span class="op" id="2255463">,</span>&nbsp;<span class="num" id="2255465">0</span><span class="op" id="2255466">,</span>&nbsp;<span class="num" id="2255468">0</span><span class="op" id="2255469">)</span><span class="op" id="2255470">;</span>&nbsp;<span class="ident" id="2255472">err1</span>&nbsp;<span class="op" id="2255477">!=</span>&nbsp;<span class="num" id="2255480">0</span>&nbsp;<span class="op" id="2255482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255487">goto</span>&nbsp;<span class="ident" id="2255492">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255509">r1</span><span class="op" id="2255511">,</span>&nbsp;<span class="ident" id="2255513">_</span><span class="op" id="2255514">,</span>&nbsp;<span class="ident" id="2255516">err1</span>&nbsp;<span class="op" id="2255521">=</span>&nbsp;<span class="ident" id="2255523">RawSyscall</span><span class="op" id="2255533">(</span><span class="ident" id="2255534">SYS_READ</span><span class="op" id="2255542">,</span>&nbsp;<span class="builtintype" id="2255544">uintptr</span><span class="op" id="2255551">(</span><span class="ident" id="2255552">p</span><span class="op" id="2255553">[</span><span class="num" id="2255554">0</span><span class="op" id="2255555">]</span><span class="op" id="2255556">)</span><span class="op" id="2255557">,</span>&nbsp;<span class="builtintype" id="2255559">uintptr</span><span class="op" id="2255566">(</span><span class="ident" id="2255567">unsafe</span><span class="op" id="2255573">.</span><span class="ident" id="2255574">Pointer</span><span class="op" id="2255581">(</span><span class="op" id="2255582">&amp;</span><span class="ident" id="2255583">err2</span><span class="op" id="2255587">)</span><span class="op" id="2255588">)</span><span class="op" id="2255589">,</span>&nbsp;<span class="ident" id="2255591">unsafe</span><span class="op" id="2255597">.</span><span class="ident" id="2255598">Sizeof</span><span class="op" id="2255604">(</span><span class="ident" id="2255605">err2</span><span class="op" id="2255609">)</span><span class="op" id="2255610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255614">if</span>&nbsp;<span class="ident" id="2255617">err1</span>&nbsp;<span class="op" id="2255622">!=</span>&nbsp;<span class="num" id="2255625">0</span>&nbsp;<span class="op" id="2255627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255632">goto</span>&nbsp;<span class="ident" id="2255637">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255650">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255654">if</span>&nbsp;<span class="ident" id="2255657">r1</span>&nbsp;<span class="op" id="2255660">!=</span>&nbsp;<span class="ident" id="2255663">unsafe</span><span class="op" id="2255669">.</span><span class="ident" id="2255670">Sizeof</span><span class="op" id="2255676">(</span><span class="ident" id="2255677">err2</span><span class="op" id="2255681">)</span>&nbsp;<span class="op" id="2255683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255688">err1</span>&nbsp;<span class="op" id="2255693">=</span>&nbsp;<span class="ident" id="2255695">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255705">goto</span>&nbsp;<span class="ident" id="2255710">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255727">if</span>&nbsp;<span class="ident" id="2255730">err2</span>&nbsp;<span class="op" id="2255735">!=</span>&nbsp;<span class="num" id="2255738">0</span>&nbsp;<span class="op" id="2255740">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255745">err1</span>&nbsp;<span class="op" id="2255750">=</span>&nbsp;<span class="ident" id="2255752">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255760">goto</span>&nbsp;<span class="ident" id="2255765">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2255785">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255809">if</span>&nbsp;<span class="ident" id="2255812">sys</span><span class="op" id="2255815">.</span><span class="ident" id="2255816">Pdeathsig</span>&nbsp;<span class="op" id="2255826">!=</span>&nbsp;<span class="num" id="2255829">0</span>&nbsp;<span class="op" id="2255831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2255835">_</span><span class="op" id="2255836">,</span>&nbsp;<span class="ident" id="2255838">_</span><span class="op" id="2255839">,</span>&nbsp;<span class="ident" id="2255841">err1</span>&nbsp;<span class="op" id="2255846">=</span>&nbsp;<span class="ident" id="2255848">RawSyscall6</span><span class="op" id="2255859">(</span><span class="ident" id="2255860">SYS_PRCTL</span><span class="op" id="2255869">,</span>&nbsp;<span class="ident" id="2255871">PR_SET_PDEATHSIG</span><span class="op" id="2255887">,</span>&nbsp;<span class="builtintype" id="2255889">uintptr</span><span class="op" id="2255896">(</span><span class="ident" id="2255897">sys</span><span class="op" id="2255900">.</span><span class="ident" id="2255901">Pdeathsig</span><span class="op" id="2255910">)</span><span class="op" id="2255911">,</span>&nbsp;<span class="num" id="2255913">0</span><span class="op" id="2255914">,</span>&nbsp;<span class="num" id="2255916">0</span><span class="op" id="2255917">,</span>&nbsp;<span class="num" id="2255919">0</span><span class="op" id="2255920">,</span>&nbsp;<span class="num" id="2255922">0</span><span class="op" id="2255923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255927">if</span>&nbsp;<span class="ident" id="2255930">err1</span>&nbsp;<span class="op" id="2255935">!=</span>&nbsp;<span class="num" id="2255938">0</span>&nbsp;<span class="op" id="2255940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2255945">goto</span>&nbsp;<span class="ident" id="2255950">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2255963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2255968">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2256031">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2256093">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2256113">r1</span><span class="op" id="2256115">,</span>&nbsp;<span class="ident" id="2256117">_</span><span class="op" id="2256118">,</span>&nbsp;<span class="ident" id="2256120">_</span>&nbsp;<span class="op" id="2256122">=</span>&nbsp;<span class="ident" id="2256124">RawSyscall</span><span class="op" id="2256134">(</span><span class="ident" id="2256135">SYS_GETPPID</span><span class="op" id="2256146">,</span>&nbsp;<span class="num" id="2256148">0</span><span class="op" id="2256149">,</span>&nbsp;<span class="num" id="2256151">0</span><span class="op" id="2256152">,</span>&nbsp;<span class="num" id="2256154">0</span><span class="op" id="2256155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256159">if</span>&nbsp;<span class="ident" id="2256162">r1</span>&nbsp;<span class="op" id="2256165">==</span>&nbsp;<span class="num" id="2256168">1</span>&nbsp;<span class="op" id="2256170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2256175">pid</span><span class="op" id="2256178">,</span>&nbsp;<span class="ident" id="2256180">_</span><span class="op" id="2256181">,</span>&nbsp;<span class="ident" id="2256183">_</span>&nbsp;<span class="op" id="2256185">:=</span>&nbsp;<span class="ident" id="2256188">RawSyscall</span><span class="op" id="2256198">(</span><span class="ident" id="2256199">SYS_GETPID</span><span class="op" id="2256209">,</span>&nbsp;<span class="num" id="2256211">0</span><span class="op" id="2256212">,</span>&nbsp;<span class="num" id="2256214">0</span><span class="op" id="2256215">,</span>&nbsp;<span class="num" id="2256217">0</span><span class="op" id="2256218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2256223">_</span><span class="op" id="2256224">,</span>&nbsp;<span class="ident" id="2256226">_</span><span class="op" id="2256227">,</span>&nbsp;<span class="ident" id="2256229">err1</span>&nbsp;<span class="op" id="2256234">:=</span>&nbsp;<span class="ident" id="2256237">RawSyscall</span><span class="op" id="2256247">(</span><span class="ident" id="2256248">SYS_KILL</span><span class="op" id="2256256">,</span>&nbsp;<span class="ident" id="2256258">pid</span><span class="op" id="2256261">,</span>&nbsp;<span class="builtintype" id="2256263">uintptr</span><span class="op" id="2256270">(</span><span class="ident" id="2256271">sys</span><span class="op" id="2256274">.</span><span class="ident" id="2256275">Pdeathsig</span><span class="op" id="2256284">)</span><span class="op" id="2256285">,</span>&nbsp;<span class="num" id="2256287">0</span><span class="op" id="2256288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256293">if</span>&nbsp;<span class="ident" id="2256296">err1</span>&nbsp;<span class="op" id="2256301">!=</span>&nbsp;<span class="num" id="2256304">0</span>&nbsp;<span class="op" id="2256306">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256312">goto</span>&nbsp;<span class="ident" id="2256317">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2256342">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256375">if</span>&nbsp;<span class="ident" id="2256378">sys</span><span class="op" id="2256381">.</span><span class="ident" id="2256382">Ptrace</span>&nbsp;<span class="op" id="2256389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2256393">_</span><span class="op" id="2256394">,</span>&nbsp;<span class="ident" id="2256396">_</span><span class="op" id="2256397">,</span>&nbsp;<span class="ident" id="2256399">err1</span>&nbsp;<span class="op" id="2256404">=</span>&nbsp;<span class="ident" id="2256406">RawSyscall</span><span class="op" id="2256416">(</span><span class="ident" id="2256417">SYS_PTRACE</span><span class="op" id="2256427">,</span>&nbsp;<span class="builtintype" id="2256429">uintptr</span><span class="op" id="2256436">(</span><span class="ident" id="2256437">PTRACE_TRACEME</span><span class="op" id="2256451">)</span><span class="op" id="2256452">,</span>&nbsp;<span class="num" id="2256454">0</span><span class="op" id="2256455">,</span>&nbsp;<span class="num" id="2256457">0</span><span class="op" id="2256458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256462">if</span>&nbsp;<span class="ident" id="2256465">err1</span>&nbsp;<span class="op" id="2256470">!=</span>&nbsp;<span class="num" id="2256473">0</span>&nbsp;<span class="op" id="2256475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256480">goto</span>&nbsp;<span class="ident" id="2256485">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2256505">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256520">if</span>&nbsp;<span class="ident" id="2256523">sys</span><span class="op" id="2256526">.</span><span class="ident" id="2256527">Setsid</span>&nbsp;<span class="op" id="2256534">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2256538">_</span><span class="op" id="2256539">,</span>&nbsp;<span class="ident" id="2256541">_</span><span class="op" id="2256542">,</span>&nbsp;<span class="ident" id="2256544">err1</span>&nbsp;<span class="op" id="2256549">=</span>&nbsp;<span class="ident" id="2256551">RawSyscall</span><span class="op" id="2256561">(</span><span class="ident" id="2256562">SYS_SETSID</span><span class="op" id="2256572">,</span>&nbsp;<span class="num" id="2256574">0</span><span class="op" id="2256575">,</span>&nbsp;<span class="num" id="2256577">0</span><span class="op" id="2256578">,</span>&nbsp;<span class="num" id="2256580">0</span><span class="op" id="2256581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256585">if</span>&nbsp;<span class="ident" id="2256588">err1</span>&nbsp;<span class="op" id="2256593">!=</span>&nbsp;<span class="num" id="2256596">0</span>&nbsp;<span class="op" id="2256598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256603">goto</span>&nbsp;<span class="ident" id="2256608">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256624">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2256628">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256650">if</span>&nbsp;<span class="ident" id="2256653">sys</span><span class="op" id="2256656">.</span><span class="ident" id="2256657">Setpgid</span>&nbsp;<span class="op" id="2256665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2256669">_</span><span class="op" id="2256670">,</span>&nbsp;<span class="ident" id="2256672">_</span><span class="op" id="2256673">,</span>&nbsp;<span class="ident" id="2256675">err1</span>&nbsp;<span class="op" id="2256680">=</span>&nbsp;<span class="ident" id="2256682">RawSyscall</span><span class="op" id="2256692">(</span><span class="ident" id="2256693">SYS_SETPGID</span><span class="op" id="2256704">,</span>&nbsp;<span class="num" id="2256706">0</span><span class="op" id="2256707">,</span>&nbsp;<span class="num" id="2256709">0</span><span class="op" id="2256710">,</span>&nbsp;<span class="num" id="2256712">0</span><span class="op" id="2256713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256717">if</span>&nbsp;<span class="ident" id="2256720">err1</span>&nbsp;<span class="op" id="2256725">!=</span>&nbsp;<span class="num" id="2256728">0</span>&nbsp;<span class="op" id="2256730">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256735">goto</span>&nbsp;<span class="ident" id="2256740">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2256760">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256771">if</span>&nbsp;<span class="ident" id="2256774">chroot</span>&nbsp;<span class="op" id="2256781">!=</span>&nbsp;<span class="ident" id="2256784">nil</span>&nbsp;<span class="op" id="2256788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2256792">_</span><span class="op" id="2256793">,</span>&nbsp;<span class="ident" id="2256795">_</span><span class="op" id="2256796">,</span>&nbsp;<span class="ident" id="2256798">err1</span>&nbsp;<span class="op" id="2256803">=</span>&nbsp;<span class="ident" id="2256805">RawSyscall</span><span class="op" id="2256815">(</span><span class="ident" id="2256816">SYS_CHROOT</span><span class="op" id="2256826">,</span>&nbsp;<span class="builtintype" id="2256828">uintptr</span><span class="op" id="2256835">(</span><span class="ident" id="2256836">unsafe</span><span class="op" id="2256842">.</span><span class="ident" id="2256843">Pointer</span><span class="op" id="2256850">(</span><span class="ident" id="2256851">chroot</span><span class="op" id="2256857">)</span><span class="op" id="2256858">)</span><span class="op" id="2256859">,</span>&nbsp;<span class="num" id="2256861">0</span><span class="op" id="2256862">,</span>&nbsp;<span class="num" id="2256864">0</span><span class="op" id="2256865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256869">if</span>&nbsp;<span class="ident" id="2256872">err1</span>&nbsp;<span class="op" id="2256877">!=</span>&nbsp;<span class="num" id="2256880">0</span>&nbsp;<span class="op" id="2256882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256887">goto</span>&nbsp;<span class="ident" id="2256892">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256905">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2256908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2256912">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2256932">if</span>&nbsp;<span class="ident" id="2256935">cred</span>&nbsp;<span class="op" id="2256940">:=</span>&nbsp;<span class="ident" id="2256943">sys</span><span class="op" id="2256946">.</span><span class="ident" id="2256947">Credential</span><span class="op" id="2256957">;</span>&nbsp;<span class="ident" id="2256959">cred</span>&nbsp;<span class="op" id="2256964">!=</span>&nbsp;<span class="ident" id="2256967">nil</span>&nbsp;<span class="op" id="2256971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2256975">ngroups</span>&nbsp;<span class="op" id="2256983">:=</span>&nbsp;<span class="builtintype" id="2256986">uintptr</span><span class="op" id="2256993">(</span><span class="builtinfunc" id="2256994">len</span><span class="op" id="2256997">(</span><span class="ident" id="2256998">cred</span><span class="op" id="2257002">.</span><span class="ident" id="2257003">Groups</span><span class="op" id="2257009">)</span><span class="op" id="2257010">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257014">var</span>&nbsp;<span class="ident" id="2257018">groups</span>&nbsp;<span class="ident" id="2257025">unsafe</span><span class="op" id="2257031">.</span><span class="ident" id="2257032">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257042">if</span>&nbsp;<span class="ident" id="2257045">ngroups</span>&nbsp;<span class="op" id="2257053">&gt;</span>&nbsp;<span class="num" id="2257055">0</span>&nbsp;<span class="op" id="2257057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257062">groups</span>&nbsp;<span class="op" id="2257069">=</span>&nbsp;<span class="ident" id="2257071">unsafe</span><span class="op" id="2257077">.</span><span class="ident" id="2257078">Pointer</span><span class="op" id="2257085">(</span><span class="op" id="2257086">&amp;</span><span class="ident" id="2257087">cred</span><span class="op" id="2257091">.</span><span class="ident" id="2257092">Groups</span><span class="op" id="2257098">[</span><span class="num" id="2257099">0</span><span class="op" id="2257100">]</span><span class="op" id="2257101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257109">_</span><span class="op" id="2257110">,</span>&nbsp;<span class="ident" id="2257112">_</span><span class="op" id="2257113">,</span>&nbsp;<span class="ident" id="2257115">err1</span>&nbsp;<span class="op" id="2257120">=</span>&nbsp;<span class="ident" id="2257122">RawSyscall</span><span class="op" id="2257132">(</span><span class="ident" id="2257133">SYS_SETGROUPS</span><span class="op" id="2257146">,</span>&nbsp;<span class="ident" id="2257148">ngroups</span><span class="op" id="2257155">,</span>&nbsp;<span class="builtintype" id="2257157">uintptr</span><span class="op" id="2257164">(</span><span class="ident" id="2257165">groups</span><span class="op" id="2257171">)</span><span class="op" id="2257172">,</span>&nbsp;<span class="num" id="2257174">0</span><span class="op" id="2257175">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257179">if</span>&nbsp;<span class="ident" id="2257182">err1</span>&nbsp;<span class="op" id="2257187">!=</span>&nbsp;<span class="num" id="2257190">0</span>&nbsp;<span class="op" id="2257192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257197">goto</span>&nbsp;<span class="ident" id="2257202">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257219">_</span><span class="op" id="2257220">,</span>&nbsp;<span class="ident" id="2257222">_</span><span class="op" id="2257223">,</span>&nbsp;<span class="ident" id="2257225">err1</span>&nbsp;<span class="op" id="2257230">=</span>&nbsp;<span class="ident" id="2257232">RawSyscall</span><span class="op" id="2257242">(</span><span class="ident" id="2257243">SYS_SETGID</span><span class="op" id="2257253">,</span>&nbsp;<span class="builtintype" id="2257255">uintptr</span><span class="op" id="2257262">(</span><span class="ident" id="2257263">cred</span><span class="op" id="2257267">.</span><span class="ident" id="2257268">Gid</span><span class="op" id="2257271">)</span><span class="op" id="2257272">,</span>&nbsp;<span class="num" id="2257274">0</span><span class="op" id="2257275">,</span>&nbsp;<span class="num" id="2257277">0</span><span class="op" id="2257278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257282">if</span>&nbsp;<span class="ident" id="2257285">err1</span>&nbsp;<span class="op" id="2257290">!=</span>&nbsp;<span class="num" id="2257293">0</span>&nbsp;<span class="op" id="2257295">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257300">goto</span>&nbsp;<span class="ident" id="2257305">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257322">_</span><span class="op" id="2257323">,</span>&nbsp;<span class="ident" id="2257325">_</span><span class="op" id="2257326">,</span>&nbsp;<span class="ident" id="2257328">err1</span>&nbsp;<span class="op" id="2257333">=</span>&nbsp;<span class="ident" id="2257335">RawSyscall</span><span class="op" id="2257345">(</span><span class="ident" id="2257346">SYS_SETUID</span><span class="op" id="2257356">,</span>&nbsp;<span class="builtintype" id="2257358">uintptr</span><span class="op" id="2257365">(</span><span class="ident" id="2257366">cred</span><span class="op" id="2257370">.</span><span class="ident" id="2257371">Uid</span><span class="op" id="2257374">)</span><span class="op" id="2257375">,</span>&nbsp;<span class="num" id="2257377">0</span><span class="op" id="2257378">,</span>&nbsp;<span class="num" id="2257380">0</span><span class="op" id="2257381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257385">if</span>&nbsp;<span class="ident" id="2257388">err1</span>&nbsp;<span class="op" id="2257393">!=</span>&nbsp;<span class="num" id="2257396">0</span>&nbsp;<span class="op" id="2257398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257403">goto</span>&nbsp;<span class="ident" id="2257408">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2257428">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257438">if</span>&nbsp;<span class="ident" id="2257441">dir</span>&nbsp;<span class="op" id="2257445">!=</span>&nbsp;<span class="ident" id="2257448">nil</span>&nbsp;<span class="op" id="2257452">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257456">_</span><span class="op" id="2257457">,</span>&nbsp;<span class="ident" id="2257459">_</span><span class="op" id="2257460">,</span>&nbsp;<span class="ident" id="2257462">err1</span>&nbsp;<span class="op" id="2257467">=</span>&nbsp;<span class="ident" id="2257469">RawSyscall</span><span class="op" id="2257479">(</span><span class="ident" id="2257480">SYS_CHDIR</span><span class="op" id="2257489">,</span>&nbsp;<span class="builtintype" id="2257491">uintptr</span><span class="op" id="2257498">(</span><span class="ident" id="2257499">unsafe</span><span class="op" id="2257505">.</span><span class="ident" id="2257506">Pointer</span><span class="op" id="2257513">(</span><span class="ident" id="2257514">dir</span><span class="op" id="2257517">)</span><span class="op" id="2257518">)</span><span class="op" id="2257519">,</span>&nbsp;<span class="num" id="2257521">0</span><span class="op" id="2257522">,</span>&nbsp;<span class="num" id="2257524">0</span><span class="op" id="2257525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257529">if</span>&nbsp;<span class="ident" id="2257532">err1</span>&nbsp;<span class="op" id="2257537">!=</span>&nbsp;<span class="num" id="2257540">0</span>&nbsp;<span class="op" id="2257542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257547">goto</span>&nbsp;<span class="ident" id="2257552">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257568">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2257572">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2257635">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257691">if</span>&nbsp;<span class="ident" id="2257694">pipe</span>&nbsp;<span class="op" id="2257699">&lt;</span>&nbsp;<span class="ident" id="2257701">nextfd</span>&nbsp;<span class="op" id="2257708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257712">_</span><span class="op" id="2257713">,</span>&nbsp;<span class="ident" id="2257715">_</span><span class="op" id="2257716">,</span>&nbsp;<span class="ident" id="2257718">err1</span>&nbsp;<span class="op" id="2257723">=</span>&nbsp;<span class="ident" id="2257725">RawSyscall</span><span class="op" id="2257735">(</span><span class="ident" id="2257736">SYS_DUP2</span><span class="op" id="2257744">,</span>&nbsp;<span class="builtintype" id="2257746">uintptr</span><span class="op" id="2257753">(</span><span class="ident" id="2257754">pipe</span><span class="op" id="2257758">)</span><span class="op" id="2257759">,</span>&nbsp;<span class="builtintype" id="2257761">uintptr</span><span class="op" id="2257768">(</span><span class="ident" id="2257769">nextfd</span><span class="op" id="2257775">)</span><span class="op" id="2257776">,</span>&nbsp;<span class="num" id="2257778">0</span><span class="op" id="2257779">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257783">if</span>&nbsp;<span class="ident" id="2257786">err1</span>&nbsp;<span class="op" id="2257791">!=</span>&nbsp;<span class="num" id="2257794">0</span>&nbsp;<span class="op" id="2257796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257801">goto</span>&nbsp;<span class="ident" id="2257806">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257823">RawSyscall</span><span class="op" id="2257833">(</span><span class="ident" id="2257834">SYS_FCNTL</span><span class="op" id="2257843">,</span>&nbsp;<span class="builtintype" id="2257845">uintptr</span><span class="op" id="2257852">(</span><span class="ident" id="2257853">nextfd</span><span class="op" id="2257859">)</span><span class="op" id="2257860">,</span>&nbsp;<span class="ident" id="2257862">F_SETFD</span><span class="op" id="2257869">,</span>&nbsp;<span class="ident" id="2257871">FD_CLOEXEC</span><span class="op" id="2257881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257885">pipe</span>&nbsp;<span class="op" id="2257890">=</span>&nbsp;<span class="ident" id="2257892">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257901">nextfd</span><span class="op" id="2257907">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2257911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257914">for</span>&nbsp;<span class="ident" id="2257918">i</span>&nbsp;<span class="op" id="2257920">=</span>&nbsp;<span class="num" id="2257922">0</span><span class="op" id="2257923">;</span>&nbsp;<span class="ident" id="2257925">i</span>&nbsp;<span class="op" id="2257927">&lt;</span>&nbsp;<span class="builtinfunc" id="2257929">len</span><span class="op" id="2257932">(</span><span class="ident" id="2257933">fd</span><span class="op" id="2257935">)</span><span class="op" id="2257936">;</span>&nbsp;<span class="ident" id="2257938">i</span><span class="op" id="2257939">++</span>&nbsp;<span class="op" id="2257942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2257946">if</span>&nbsp;<span class="ident" id="2257949">fd</span><span class="op" id="2257951">[</span><span class="ident" id="2257952">i</span><span class="op" id="2257953">]</span>&nbsp;<span class="op" id="2257955">&gt;=</span>&nbsp;<span class="num" id="2257958">0</span>&nbsp;<span class="op" id="2257960">&amp;&amp;</span>&nbsp;<span class="ident" id="2257963">fd</span><span class="op" id="2257965">[</span><span class="ident" id="2257966">i</span><span class="op" id="2257967">]</span>&nbsp;<span class="op" id="2257969">&lt;</span>&nbsp;<span class="builtintype" id="2257971">int</span><span class="op" id="2257974">(</span><span class="ident" id="2257975">i</span><span class="op" id="2257976">)</span>&nbsp;<span class="op" id="2257978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2257983">_</span><span class="op" id="2257984">,</span>&nbsp;<span class="ident" id="2257986">_</span><span class="op" id="2257987">,</span>&nbsp;<span class="ident" id="2257989">err1</span>&nbsp;<span class="op" id="2257994">=</span>&nbsp;<span class="ident" id="2257996">RawSyscall</span><span class="op" id="2258006">(</span><span class="ident" id="2258007">SYS_DUP2</span><span class="op" id="2258015">,</span>&nbsp;<span class="builtintype" id="2258017">uintptr</span><span class="op" id="2258024">(</span><span class="ident" id="2258025">fd</span><span class="op" id="2258027">[</span><span class="ident" id="2258028">i</span><span class="op" id="2258029">]</span><span class="op" id="2258030">)</span><span class="op" id="2258031">,</span>&nbsp;<span class="builtintype" id="2258033">uintptr</span><span class="op" id="2258040">(</span><span class="ident" id="2258041">nextfd</span><span class="op" id="2258047">)</span><span class="op" id="2258048">,</span>&nbsp;<span class="num" id="2258050">0</span><span class="op" id="2258051">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258056">if</span>&nbsp;<span class="ident" id="2258059">err1</span>&nbsp;<span class="op" id="2258064">!=</span>&nbsp;<span class="num" id="2258067">0</span>&nbsp;<span class="op" id="2258069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258075">goto</span>&nbsp;<span class="ident" id="2258080">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2258099">RawSyscall</span><span class="op" id="2258109">(</span><span class="ident" id="2258110">SYS_FCNTL</span><span class="op" id="2258119">,</span>&nbsp;<span class="builtintype" id="2258121">uintptr</span><span class="op" id="2258128">(</span><span class="ident" id="2258129">nextfd</span><span class="op" id="2258135">)</span><span class="op" id="2258136">,</span>&nbsp;<span class="ident" id="2258138">F_SETFD</span><span class="op" id="2258145">,</span>&nbsp;<span class="ident" id="2258147">FD_CLOEXEC</span><span class="op" id="2258157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2258162">fd</span><span class="op" id="2258164">[</span><span class="ident" id="2258165">i</span><span class="op" id="2258166">]</span>&nbsp;<span class="op" id="2258168">=</span>&nbsp;<span class="ident" id="2258170">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2258180">nextfd</span><span class="op" id="2258186">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258192">if</span>&nbsp;<span class="ident" id="2258195">nextfd</span>&nbsp;<span class="op" id="2258202">==</span>&nbsp;<span class="ident" id="2258205">pipe</span>&nbsp;<span class="op" id="2258210">{</span>&nbsp;<span class="comment" id="2258212">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2258239">nextfd</span><span class="op" id="2258245">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258255">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2258262">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258297">for</span>&nbsp;<span class="ident" id="2258301">i</span>&nbsp;<span class="op" id="2258303">=</span>&nbsp;<span class="num" id="2258305">0</span><span class="op" id="2258306">;</span>&nbsp;<span class="ident" id="2258308">i</span>&nbsp;<span class="op" id="2258310">&lt;</span>&nbsp;<span class="builtinfunc" id="2258312">len</span><span class="op" id="2258315">(</span><span class="ident" id="2258316">fd</span><span class="op" id="2258318">)</span><span class="op" id="2258319">;</span>&nbsp;<span class="ident" id="2258321">i</span><span class="op" id="2258322">++</span>&nbsp;<span class="op" id="2258325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258329">if</span>&nbsp;<span class="ident" id="2258332">fd</span><span class="op" id="2258334">[</span><span class="ident" id="2258335">i</span><span class="op" id="2258336">]</span>&nbsp;<span class="op" id="2258338">==</span>&nbsp;<span class="op" id="2258341">-</span><span class="num" id="2258342">1</span>&nbsp;<span class="op" id="2258344">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2258349">RawSyscall</span><span class="op" id="2258359">(</span><span class="ident" id="2258360">SYS_CLOSE</span><span class="op" id="2258369">,</span>&nbsp;<span class="builtintype" id="2258371">uintptr</span><span class="op" id="2258378">(</span><span class="ident" id="2258379">i</span><span class="op" id="2258380">)</span><span class="op" id="2258381">,</span>&nbsp;<span class="num" id="2258383">0</span><span class="op" id="2258384">,</span>&nbsp;<span class="num" id="2258386">0</span><span class="op" id="2258387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258392">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258407">if</span>&nbsp;<span class="ident" id="2258410">fd</span><span class="op" id="2258412">[</span><span class="ident" id="2258413">i</span><span class="op" id="2258414">]</span>&nbsp;<span class="op" id="2258416">==</span>&nbsp;<span class="builtintype" id="2258419">int</span><span class="op" id="2258422">(</span><span class="ident" id="2258423">i</span><span class="op" id="2258424">)</span>&nbsp;<span class="op" id="2258426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2258431">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2258489">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2258526">_</span><span class="op" id="2258527">,</span>&nbsp;<span class="ident" id="2258529">_</span><span class="op" id="2258530">,</span>&nbsp;<span class="ident" id="2258532">err1</span>&nbsp;<span class="op" id="2258537">=</span>&nbsp;<span class="ident" id="2258539">RawSyscall</span><span class="op" id="2258549">(</span><span class="ident" id="2258550">SYS_FCNTL</span><span class="op" id="2258559">,</span>&nbsp;<span class="builtintype" id="2258561">uintptr</span><span class="op" id="2258568">(</span><span class="ident" id="2258569">fd</span><span class="op" id="2258571">[</span><span class="ident" id="2258572">i</span><span class="op" id="2258573">]</span><span class="op" id="2258574">)</span><span class="op" id="2258575">,</span>&nbsp;<span class="ident" id="2258577">F_SETFD</span><span class="op" id="2258584">,</span>&nbsp;<span class="num" id="2258586">0</span><span class="op" id="2258587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258592">if</span>&nbsp;<span class="ident" id="2258595">err1</span>&nbsp;<span class="op" id="2258600">!=</span>&nbsp;<span class="num" id="2258603">0</span>&nbsp;<span class="op" id="2258605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258611">goto</span>&nbsp;<span class="ident" id="2258616">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258630">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258635">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2258650">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2258696">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2258732">_</span><span class="op" id="2258733">,</span>&nbsp;<span class="ident" id="2258735">_</span><span class="op" id="2258736">,</span>&nbsp;<span class="ident" id="2258738">err1</span>&nbsp;<span class="op" id="2258743">=</span>&nbsp;<span class="ident" id="2258745">RawSyscall</span><span class="op" id="2258755">(</span><span class="ident" id="2258756">SYS_DUP2</span><span class="op" id="2258764">,</span>&nbsp;<span class="builtintype" id="2258766">uintptr</span><span class="op" id="2258773">(</span><span class="ident" id="2258774">fd</span><span class="op" id="2258776">[</span><span class="ident" id="2258777">i</span><span class="op" id="2258778">]</span><span class="op" id="2258779">)</span><span class="op" id="2258780">,</span>&nbsp;<span class="builtintype" id="2258782">uintptr</span><span class="op" id="2258789">(</span><span class="ident" id="2258790">i</span><span class="op" id="2258791">)</span><span class="op" id="2258792">,</span>&nbsp;<span class="num" id="2258794">0</span><span class="op" id="2258795">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258799">if</span>&nbsp;<span class="ident" id="2258802">err1</span>&nbsp;<span class="op" id="2258807">!=</span>&nbsp;<span class="num" id="2258810">0</span>&nbsp;<span class="op" id="2258812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2258817">goto</span>&nbsp;<span class="ident" id="2258822">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2258838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2258842">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2258899">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2258961">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2259016">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2259047">for</span>&nbsp;<span class="ident" id="2259051">i</span>&nbsp;<span class="op" id="2259053">=</span>&nbsp;<span class="builtinfunc" id="2259055">len</span><span class="op" id="2259058">(</span><span class="ident" id="2259059">fd</span><span class="op" id="2259061">)</span><span class="op" id="2259062">;</span>&nbsp;<span class="ident" id="2259064">i</span>&nbsp;<span class="op" id="2259066">&lt;</span>&nbsp;<span class="num" id="2259068">3</span><span class="op" id="2259069">;</span>&nbsp;<span class="ident" id="2259071">i</span><span class="op" id="2259072">++</span>&nbsp;<span class="op" id="2259075">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2259079">RawSyscall</span><span class="op" id="2259089">(</span><span class="ident" id="2259090">SYS_CLOSE</span><span class="op" id="2259099">,</span>&nbsp;<span class="builtintype" id="2259101">uintptr</span><span class="op" id="2259108">(</span><span class="ident" id="2259109">i</span><span class="op" id="2259110">)</span><span class="op" id="2259111">,</span>&nbsp;<span class="num" id="2259113">0</span><span class="op" id="2259114">,</span>&nbsp;<span class="num" id="2259116">0</span><span class="op" id="2259117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2259120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2259124">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2259149">if</span>&nbsp;<span class="ident" id="2259152">sys</span><span class="op" id="2259155">.</span><span class="ident" id="2259156">Noctty</span>&nbsp;<span class="op" id="2259163">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2259167">_</span><span class="op" id="2259168">,</span>&nbsp;<span class="ident" id="2259170">_</span><span class="op" id="2259171">,</span>&nbsp;<span class="ident" id="2259173">err1</span>&nbsp;<span class="op" id="2259178">=</span>&nbsp;<span class="ident" id="2259180">RawSyscall</span><span class="op" id="2259190">(</span><span class="ident" id="2259191">SYS_IOCTL</span><span class="op" id="2259200">,</span>&nbsp;<span class="num" id="2259202">0</span><span class="op" id="2259203">,</span>&nbsp;<span class="builtintype" id="2259205">uintptr</span><span class="op" id="2259212">(</span><span class="ident" id="2259213">TIOCNOTTY</span><span class="op" id="2259222">)</span><span class="op" id="2259223">,</span>&nbsp;<span class="num" id="2259225">0</span><span class="op" id="2259226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2259230">if</span>&nbsp;<span class="ident" id="2259233">err1</span>&nbsp;<span class="op" id="2259238">!=</span>&nbsp;<span class="num" id="2259241">0</span>&nbsp;<span class="op" id="2259243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2259248">goto</span>&nbsp;<span class="ident" id="2259253">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2259266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2259269">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2259273">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2259309">if</span>&nbsp;<span class="ident" id="2259312">sys</span><span class="op" id="2259315">.</span><span class="ident" id="2259316">Setctty</span>&nbsp;<span class="op" id="2259324">&amp;&amp;</span>&nbsp;<span class="ident" id="2259327">sys</span><span class="op" id="2259330">.</span><span class="ident" id="2259331">Ctty</span>&nbsp;<span class="op" id="2259336">&gt;=</span>&nbsp;<span class="num" id="2259339">0</span>&nbsp;<span class="op" id="2259341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2259345">_</span><span class="op" id="2259346">,</span>&nbsp;<span class="ident" id="2259348">_</span><span class="op" id="2259349">,</span>&nbsp;<span class="ident" id="2259351">err1</span>&nbsp;<span class="op" id="2259356">=</span>&nbsp;<span class="ident" id="2259358">RawSyscall</span><span class="op" id="2259368">(</span><span class="ident" id="2259369">SYS_IOCTL</span><span class="op" id="2259378">,</span>&nbsp;<span class="builtintype" id="2259380">uintptr</span><span class="op" id="2259387">(</span><span class="ident" id="2259388">sys</span><span class="op" id="2259391">.</span><span class="ident" id="2259392">Ctty</span><span class="op" id="2259396">)</span><span class="op" id="2259397">,</span>&nbsp;<span class="builtintype" id="2259399">uintptr</span><span class="op" id="2259406">(</span><span class="ident" id="2259407">TIOCSCTTY</span><span class="op" id="2259416">)</span><span class="op" id="2259417">,</span>&nbsp;<span class="num" id="2259419">0</span><span class="op" id="2259420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2259424">if</span>&nbsp;<span class="ident" id="2259427">err1</span>&nbsp;<span class="op" id="2259432">!=</span>&nbsp;<span class="num" id="2259435">0</span>&nbsp;<span class="op" id="2259437">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2259442">goto</span>&nbsp;<span class="ident" id="2259447">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2259460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2259463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2259467">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2259485">_</span><span class="op" id="2259486">,</span>&nbsp;<span class="ident" id="2259488">_</span><span class="op" id="2259489">,</span>&nbsp;<span class="ident" id="2259491">err1</span>&nbsp;<span class="op" id="2259496">=</span>&nbsp;<span class="ident" id="2259498">RawSyscall</span><span class="op" id="2259508">(</span><span class="ident" id="2259509">SYS_EXECVE</span><span class="op" id="2259519">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2259523">uintptr</span><span class="op" id="2259530">(</span><span class="ident" id="2259531">unsafe</span><span class="op" id="2259537">.</span><span class="ident" id="2259538">Pointer</span><span class="op" id="2259545">(</span><span class="ident" id="2259546">argv0</span><span class="op" id="2259551">)</span><span class="op" id="2259552">)</span><span class="op" id="2259553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2259557">uintptr</span><span class="op" id="2259564">(</span><span class="ident" id="2259565">unsafe</span><span class="op" id="2259571">.</span><span class="ident" id="2259572">Pointer</span><span class="op" id="2259579">(</span><span class="op" id="2259580">&amp;</span><span class="ident" id="2259581">argv</span><span class="op" id="2259585">[</span><span class="num" id="2259586">0</span><span class="op" id="2259587">]</span><span class="op" id="2259588">)</span><span class="op" id="2259589">)</span><span class="op" id="2259590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2259594">uintptr</span><span class="op" id="2259601">(</span><span class="ident" id="2259602">unsafe</span><span class="op" id="2259608">.</span><span class="ident" id="2259609">Pointer</span><span class="op" id="2259616">(</span><span class="op" id="2259617">&amp;</span><span class="ident" id="2259618">envv</span><span class="op" id="2259622">[</span><span class="num" id="2259623">0</span><span class="op" id="2259624">]</span><span class="op" id="2259625">)</span><span class="op" id="2259626">)</span><span class="op" id="2259627">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2259630">childerror</span><span class="op" id="2259640">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2259643">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2259671">RawSyscall</span><span class="op" id="2259681">(</span><span class="ident" id="2259682">SYS_WRITE</span><span class="op" id="2259691">,</span>&nbsp;<span class="builtintype" id="2259693">uintptr</span><span class="op" id="2259700">(</span><span class="ident" id="2259701">pipe</span><span class="op" id="2259705">)</span><span class="op" id="2259706">,</span>&nbsp;<span class="builtintype" id="2259708">uintptr</span><span class="op" id="2259715">(</span><span class="ident" id="2259716">unsafe</span><span class="op" id="2259722">.</span><span class="ident" id="2259723">Pointer</span><span class="op" id="2259730">(</span><span class="op" id="2259731">&amp;</span><span class="ident" id="2259732">err1</span><span class="op" id="2259736">)</span><span class="op" id="2259737">)</span><span class="op" id="2259738">,</span>&nbsp;<span class="ident" id="2259740">unsafe</span><span class="op" id="2259746">.</span><span class="ident" id="2259747">Sizeof</span><span class="op" id="2259753">(</span><span class="ident" id="2259754">err1</span><span class="op" id="2259758">)</span><span class="op" id="2259759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2259762">for</span>&nbsp;<span class="op" id="2259766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2259770">RawSyscall</span><span class="op" id="2259780">(</span><span class="ident" id="2259781">SYS_EXIT</span><span class="op" id="2259789">,</span>&nbsp;<span class="num" id="2259791">253</span><span class="op" id="2259794">,</span>&nbsp;<span class="num" id="2259796">0</span><span class="op" id="2259797">,</span>&nbsp;<span class="num" id="2259799">0</span><span class="op" id="2259800">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2259803">}</span><br>
<span class="lineno"></span><span class="op" id="2259805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2259808">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2259875">func</span>&nbsp;<span class="ident" id="2259880">forkExecPipe</span><span class="op" id="2259892">(</span><span class="ident" id="2259893">p</span>&nbsp;<span class="op" id="2259895">[</span><span class="op" id="2259896">]</span><span class="builtintype" id="2259897">int</span><span class="op" id="2259900">)</span>&nbsp;<span class="op" id="2259902">(</span><span class="ident" id="2259903">err</span>&nbsp;<span class="builtintype" id="2259907">error</span><span class="op" id="2259912">)</span>&nbsp;<span class="op" id="2259914">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2259917">err</span>&nbsp;<span class="op" id="2259921">=</span>&nbsp;<span class="ident" id="2259923">Pipe2</span><span class="op" id="2259928">(</span><span class="ident" id="2259929">p</span><span class="op" id="2259930">,</span>&nbsp;<span class="ident" id="2259932">O_CLOEXEC</span><span class="op" id="2259941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2259944">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2260019">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260049">if</span>&nbsp;<span class="ident" id="2260052">err</span>&nbsp;<span class="op" id="2260056">==</span>&nbsp;<span class="ident" id="2260059">ENOSYS</span>&nbsp;<span class="op" id="2260066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260070">if</span>&nbsp;<span class="ident" id="2260073">err</span>&nbsp;<span class="op" id="2260077">=</span>&nbsp;<span class="ident" id="2260079">Pipe</span><span class="op" id="2260083">(</span><span class="ident" id="2260084">p</span><span class="op" id="2260085">)</span><span class="op" id="2260086">;</span>&nbsp;<span class="ident" id="2260088">err</span>&nbsp;<span class="op" id="2260092">!=</span>&nbsp;<span class="ident" id="2260095">nil</span>&nbsp;<span class="op" id="2260099">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260104">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2260113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260117">if</span>&nbsp;<span class="ident" id="2260120">_</span><span class="op" id="2260121">,</span>&nbsp;<span class="ident" id="2260123">err</span>&nbsp;<span class="op" id="2260127">=</span>&nbsp;<span class="ident" id="2260129">fcntl</span><span class="op" id="2260134">(</span><span class="ident" id="2260135">p</span><span class="op" id="2260136">[</span><span class="num" id="2260137">0</span><span class="op" id="2260138">]</span><span class="op" id="2260139">,</span>&nbsp;<span class="ident" id="2260141">F_SETFD</span><span class="op" id="2260148">,</span>&nbsp;<span class="ident" id="2260150">FD_CLOEXEC</span><span class="op" id="2260160">)</span><span class="op" id="2260161">;</span>&nbsp;<span class="ident" id="2260163">err</span>&nbsp;<span class="op" id="2260167">!=</span>&nbsp;<span class="ident" id="2260170">nil</span>&nbsp;<span class="op" id="2260174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260179">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2260188">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2260192">_</span><span class="op" id="2260193">,</span>&nbsp;<span class="ident" id="2260195">err</span>&nbsp;<span class="op" id="2260199">=</span>&nbsp;<span class="ident" id="2260201">fcntl</span><span class="op" id="2260206">(</span><span class="ident" id="2260207">p</span><span class="op" id="2260208">[</span><span class="num" id="2260209">1</span><span class="op" id="2260210">]</span><span class="op" id="2260211">,</span>&nbsp;<span class="ident" id="2260213">F_SETFD</span><span class="op" id="2260220">,</span>&nbsp;<span class="ident" id="2260222">FD_CLOEXEC</span><span class="op" id="2260232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2260235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260238">return</span><br>
<span class="lineno"></span><span class="op" id="2260245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2260248">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2260345">func</span>&nbsp;<span class="ident" id="2260350">writeIDMappings</span><span class="op" id="2260365">(</span><span class="ident" id="2260366">path</span>&nbsp;<span class="builtintype" id="2260371">string</span><span class="op" id="2260377">,</span>&nbsp;<span class="ident" id="2260379">idMap</span>&nbsp;<span class="op" id="2260385">[</span><span class="op" id="2260386">]</span><span class="ident" id="2260387">SysProcIDMap</span><span class="op" id="2260399">)</span>&nbsp;<span class="builtintype" id="2260401">error</span>&nbsp;<span class="op" id="2260407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2260410">fd</span><span class="op" id="2260412">,</span>&nbsp;<span class="ident" id="2260414">err</span>&nbsp;<span class="op" id="2260418">:=</span>&nbsp;<span class="ident" id="2260421">Open</span><span class="op" id="2260425">(</span><span class="ident" id="2260426">path</span><span class="op" id="2260430">,</span>&nbsp;<span class="ident" id="2260432">O_RDWR</span><span class="op" id="2260438">,</span>&nbsp;<span class="num" id="2260440">0</span><span class="op" id="2260441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260444">if</span>&nbsp;<span class="ident" id="2260447">err</span>&nbsp;<span class="op" id="2260451">!=</span>&nbsp;<span class="ident" id="2260454">nil</span>&nbsp;<span class="op" id="2260458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260462">return</span>&nbsp;<span class="ident" id="2260469">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2260474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2260478">data</span>&nbsp;<span class="op" id="2260483">:=</span>&nbsp;<span class="string" id="2260486">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260490">for</span>&nbsp;<span class="ident" id="2260494">_</span><span class="op" id="2260495">,</span>&nbsp;<span class="ident" id="2260497">im</span>&nbsp;<span class="op" id="2260500">:=</span>&nbsp;<span class="keyword" id="2260503">range</span>&nbsp;<span class="ident" id="2260509">idMap</span>&nbsp;<span class="op" id="2260515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2260519">data</span>&nbsp;<span class="op" id="2260524">=</span>&nbsp;<span class="ident" id="2260526">data</span>&nbsp;<span class="op" id="2260531">+</span>&nbsp;<span class="ident" id="2260533">itoa</span><span class="op" id="2260537">(</span><span class="ident" id="2260538">im</span><span class="op" id="2260540">.</span><span class="ident" id="2260541">ContainerID</span><span class="op" id="2260552">)</span>&nbsp;<span class="op" id="2260554">+</span>&nbsp;<span class="string" id="2260556">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2260560">+</span>&nbsp;<span class="ident" id="2260562">itoa</span><span class="op" id="2260566">(</span><span class="ident" id="2260567">im</span><span class="op" id="2260569">.</span><span class="ident" id="2260570">HostID</span><span class="op" id="2260576">)</span>&nbsp;<span class="op" id="2260578">+</span>&nbsp;<span class="string" id="2260580">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2260584">+</span>&nbsp;<span class="ident" id="2260586">itoa</span><span class="op" id="2260590">(</span><span class="ident" id="2260591">im</span><span class="op" id="2260593">.</span><span class="ident" id="2260594">Size</span><span class="op" id="2260598">)</span>&nbsp;<span class="op" id="2260600">+</span>&nbsp;<span class="string" id="2260602">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2260608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2260612">bytes</span><span class="op" id="2260617">,</span>&nbsp;<span class="ident" id="2260619">err</span>&nbsp;<span class="op" id="2260623">:=</span>&nbsp;<span class="ident" id="2260626">ByteSliceFromString</span><span class="op" id="2260645">(</span><span class="ident" id="2260646">data</span><span class="op" id="2260650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260653">if</span>&nbsp;<span class="ident" id="2260656">err</span>&nbsp;<span class="op" id="2260660">!=</span>&nbsp;<span class="ident" id="2260663">nil</span>&nbsp;<span class="op" id="2260667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2260671">Close</span><span class="op" id="2260676">(</span><span class="ident" id="2260677">fd</span><span class="op" id="2260679">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260683">return</span>&nbsp;<span class="ident" id="2260690">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2260695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260699">if</span>&nbsp;<span class="ident" id="2260702">_</span><span class="op" id="2260703">,</span>&nbsp;<span class="ident" id="2260705">err</span>&nbsp;<span class="op" id="2260709">:=</span>&nbsp;<span class="ident" id="2260712">Write</span><span class="op" id="2260717">(</span><span class="ident" id="2260718">fd</span><span class="op" id="2260720">,</span>&nbsp;<span class="ident" id="2260722">bytes</span><span class="op" id="2260727">)</span><span class="op" id="2260728">;</span>&nbsp;<span class="ident" id="2260730">err</span>&nbsp;<span class="op" id="2260734">!=</span>&nbsp;<span class="ident" id="2260737">nil</span>&nbsp;<span class="op" id="2260741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2260745">Close</span><span class="op" id="2260750">(</span><span class="ident" id="2260751">fd</span><span class="op" id="2260753">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260757">return</span>&nbsp;<span class="ident" id="2260764">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2260769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260773">if</span>&nbsp;<span class="ident" id="2260776">err</span>&nbsp;<span class="op" id="2260780">:=</span>&nbsp;<span class="ident" id="2260783">Close</span><span class="op" id="2260788">(</span><span class="ident" id="2260789">fd</span><span class="op" id="2260791">)</span><span class="op" id="2260792">;</span>&nbsp;<span class="ident" id="2260794">err</span>&nbsp;<span class="op" id="2260798">!=</span>&nbsp;<span class="ident" id="2260801">nil</span>&nbsp;<span class="op" id="2260805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260809">return</span>&nbsp;<span class="ident" id="2260816">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2260821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2260825">return</span>&nbsp;<span class="ident" id="2260832">nil</span><br>
<span class="lineno"></span><span class="op" id="2260836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2260839">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2260919">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2260978">func</span>&nbsp;<span class="ident" id="2260983">writeUidGidMappings</span><span class="op" id="2261002">(</span><span class="ident" id="2261003">pid</span>&nbsp;<span class="builtintype" id="2261007">int</span><span class="op" id="2261010">,</span>&nbsp;<span class="ident" id="2261012">sys</span>&nbsp;<span class="op" id="2261016">*</span><span class="ident" id="2261017">SysProcAttr</span><span class="op" id="2261028">)</span>&nbsp;<span class="builtintype" id="2261030">error</span>&nbsp;<span class="op" id="2261036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2261039">if</span>&nbsp;<span class="ident" id="2261042">sys</span><span class="op" id="2261045">.</span><span class="ident" id="2261046">UidMappings</span>&nbsp;<span class="op" id="2261058">!=</span>&nbsp;<span class="ident" id="2261061">nil</span>&nbsp;<span class="op" id="2261065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2261069">uidf</span>&nbsp;<span class="op" id="2261074">:=</span>&nbsp;<span class="string" id="2261077">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2261086">+</span>&nbsp;<span class="ident" id="2261088">itoa</span><span class="op" id="2261092">(</span><span class="ident" id="2261093">pid</span><span class="op" id="2261096">)</span>&nbsp;<span class="op" id="2261098">+</span>&nbsp;<span class="string" id="2261100">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2261113">if</span>&nbsp;<span class="ident" id="2261116">err</span>&nbsp;<span class="op" id="2261120">:=</span>&nbsp;<span class="ident" id="2261123">writeIDMappings</span><span class="op" id="2261138">(</span><span class="ident" id="2261139">uidf</span><span class="op" id="2261143">,</span>&nbsp;<span class="ident" id="2261145">sys</span><span class="op" id="2261148">.</span><span class="ident" id="2261149">UidMappings</span><span class="op" id="2261160">)</span><span class="op" id="2261161">;</span>&nbsp;<span class="ident" id="2261163">err</span>&nbsp;<span class="op" id="2261167">!=</span>&nbsp;<span class="ident" id="2261170">nil</span>&nbsp;<span class="op" id="2261174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2261179">return</span>&nbsp;<span class="ident" id="2261186">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2261192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2261195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2261199">if</span>&nbsp;<span class="ident" id="2261202">sys</span><span class="op" id="2261205">.</span><span class="ident" id="2261206">GidMappings</span>&nbsp;<span class="op" id="2261218">!=</span>&nbsp;<span class="ident" id="2261221">nil</span>&nbsp;<span class="op" id="2261225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2261229">gidf</span>&nbsp;<span class="op" id="2261234">:=</span>&nbsp;<span class="string" id="2261237">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2261246">+</span>&nbsp;<span class="ident" id="2261248">itoa</span><span class="op" id="2261252">(</span><span class="ident" id="2261253">pid</span><span class="op" id="2261256">)</span>&nbsp;<span class="op" id="2261258">+</span>&nbsp;<span class="string" id="2261260">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2261273">if</span>&nbsp;<span class="ident" id="2261276">err</span>&nbsp;<span class="op" id="2261280">:=</span>&nbsp;<span class="ident" id="2261283">writeIDMappings</span><span class="op" id="2261298">(</span><span class="ident" id="2261299">gidf</span><span class="op" id="2261303">,</span>&nbsp;<span class="ident" id="2261305">sys</span><span class="op" id="2261308">.</span><span class="ident" id="2261309">GidMappings</span><span class="op" id="2261320">)</span><span class="op" id="2261321">;</span>&nbsp;<span class="ident" id="2261323">err</span>&nbsp;<span class="op" id="2261327">!=</span>&nbsp;<span class="ident" id="2261330">nil</span>&nbsp;<span class="op" id="2261334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2261339">return</span>&nbsp;<span class="ident" id="2261346">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2261352">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2261355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2261359">return</span>&nbsp;<span class="ident" id="2261366">nil</span><br>
<span class="lineno"></span><span class="op" id="2261370">}</span>
</div>
</body>
</html>
