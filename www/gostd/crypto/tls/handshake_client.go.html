<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4463170">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4463225">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4463279">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4463330">package</span>&nbsp;<span class="ident" id="4463338">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4463343">import</span>&nbsp;<span class="op" id="4463350">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463353">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463362">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463372">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463388">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463402">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463419">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463434">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463444">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463451">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463457">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4463464">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="4463474">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4463477">type</span>&nbsp;<span class="ident" id="4463482">clientHandshakeState</span>&nbsp;<span class="keyword" id="4463503">struct</span>&nbsp;<span class="op" id="4463510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463513">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463526">*</span><span class="ident" id="4463527">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463533">serverHello</span>&nbsp;&nbsp;<span class="op" id="4463546">*</span><span class="ident" id="4463547">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463563">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463576">*</span><span class="ident" id="4463577">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463593">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463606">*</span><span class="ident" id="4463607">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463620">finishedHash</span>&nbsp;<span class="ident" id="4463633">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463647">masterSecret</span>&nbsp;<span class="op" id="4463660">[</span><span class="op" id="4463661">]</span><span class="builtintype" id="4463662">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463668">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463681">*</span><span class="ident" id="4463682">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="4463701">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4463704">func</span>&nbsp;<span class="op" id="4463709">(</span><span class="ident" id="4463710">c</span>&nbsp;<span class="op" id="4463712">*</span><span class="ident" id="4463713">Conn</span><span class="op" id="4463717">)</span>&nbsp;<span class="ident" id="4463719">clientHandshake</span><span class="op" id="4463734">(</span><span class="op" id="4463735">)</span>&nbsp;<span class="builtintype" id="4463737">error</span>&nbsp;<span class="op" id="4463743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4463746">if</span>&nbsp;<span class="ident" id="4463749">c</span><span class="op" id="4463750">.</span><span class="ident" id="4463751">config</span>&nbsp;<span class="op" id="4463758">==</span>&nbsp;<span class="ident" id="4463761">nil</span>&nbsp;<span class="op" id="4463765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463769">c</span><span class="op" id="4463770">.</span><span class="ident" id="4463771">config</span>&nbsp;<span class="op" id="4463778">=</span>&nbsp;<span class="ident" id="4463780">defaultConfig</span><span class="op" id="4463793">(</span><span class="op" id="4463794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4463797">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4463801">if</span>&nbsp;<span class="builtinfunc" id="4463804">len</span><span class="op" id="4463807">(</span><span class="ident" id="4463808">c</span><span class="op" id="4463809">.</span><span class="ident" id="4463810">config</span><span class="op" id="4463816">.</span><span class="ident" id="4463817">ServerName</span><span class="op" id="4463827">)</span>&nbsp;<span class="op" id="4463829">==</span>&nbsp;<span class="num" id="4463832">0</span>&nbsp;<span class="op" id="4463834">&amp;&amp;</span>&nbsp;<span class="op" id="4463837">!</span><span class="ident" id="4463838">c</span><span class="op" id="4463839">.</span><span class="ident" id="4463840">config</span><span class="op" id="4463846">.</span><span class="ident" id="4463847">InsecureSkipVerify</span>&nbsp;<span class="op" id="4463866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4463870">return</span>&nbsp;<span class="ident" id="4463877">errors</span><span class="op" id="4463883">.</span><span class="ident" id="4463884">New</span><span class="op" id="4463887">(</span><span class="string" id="4463888">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="4463970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4463973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4463977">nextProtosLength</span>&nbsp;<span class="op" id="4463994">:=</span>&nbsp;<span class="num" id="4463997">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4464000">for</span>&nbsp;<span class="ident" id="4464004">_</span><span class="op" id="4464005">,</span>&nbsp;<span class="ident" id="4464007">proto</span>&nbsp;<span class="op" id="4464013">:=</span>&nbsp;<span class="keyword" id="4464016">range</span>&nbsp;<span class="ident" id="4464022">c</span><span class="op" id="4464023">.</span><span class="ident" id="4464024">config</span><span class="op" id="4464030">.</span><span class="ident" id="4464031">NextProtos</span>&nbsp;<span class="op" id="4464042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4464046">if</span>&nbsp;<span class="ident" id="4464049">l</span>&nbsp;<span class="op" id="4464051">:=</span>&nbsp;<span class="builtinfunc" id="4464054">len</span><span class="op" id="4464057">(</span><span class="ident" id="4464058">proto</span><span class="op" id="4464063">)</span><span class="op" id="4464064">;</span>&nbsp;<span class="ident" id="4464066">l</span>&nbsp;<span class="op" id="4464068">==</span>&nbsp;<span class="num" id="4464071">0</span>&nbsp;<span class="op" id="4464073">||</span>&nbsp;<span class="ident" id="4464076">l</span>&nbsp;<span class="op" id="4464078">&gt;</span>&nbsp;<span class="num" id="4464080">255</span>&nbsp;<span class="op" id="4464084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4464089">return</span>&nbsp;<span class="ident" id="4464096">errors</span><span class="op" id="4464102">.</span><span class="ident" id="4464103">New</span><span class="op" id="4464106">(</span><span class="string" id="4464107">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="4464138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4464142">}</span>&nbsp;<span class="keyword" id="4464144">else</span>&nbsp;<span class="op" id="4464149">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464154">nextProtosLength</span>&nbsp;<span class="op" id="4464171">+=</span>&nbsp;<span class="num" id="4464174">1</span>&nbsp;<span class="op" id="4464176">+</span>&nbsp;<span class="ident" id="4464178">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4464182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4464185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4464188">if</span>&nbsp;<span class="ident" id="4464191">nextProtosLength</span>&nbsp;<span class="op" id="4464208">&gt;</span>&nbsp;<span class="num" id="4464210">0xffff</span>&nbsp;<span class="op" id="4464217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4464221">return</span>&nbsp;<span class="ident" id="4464228">errors</span><span class="op" id="4464234">.</span><span class="ident" id="4464235">New</span><span class="op" id="4464238">(</span><span class="string" id="4464239">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="4464273">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4464276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464280">hello</span>&nbsp;<span class="op" id="4464286">:=</span>&nbsp;<span class="op" id="4464289">&amp;</span><span class="ident" id="4464290">clientHelloMsg</span><span class="op" id="4464304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464308">vers</span><span class="op" id="4464312">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464329">c</span><span class="op" id="4464330">.</span><span class="ident" id="4464331">config</span><span class="op" id="4464337">.</span><span class="ident" id="4464338">maxVersion</span><span class="op" id="4464348">(</span><span class="op" id="4464349">)</span><span class="op" id="4464350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464354">compressionMethods</span><span class="op" id="4464372">:</span>&nbsp;&nbsp;<span class="op" id="4464375">[</span><span class="op" id="4464376">]</span><span class="builtintype" id="4464377">uint8</span><span class="op" id="4464382">{</span><span class="ident" id="4464383">compressionNone</span><span class="op" id="4464398">}</span><span class="op" id="4464399">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464403">random</span><span class="op" id="4464409">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4464424">make</span><span class="op" id="4464428">(</span><span class="op" id="4464429">[</span><span class="op" id="4464430">]</span><span class="builtintype" id="4464431">byte</span><span class="op" id="4464435">,</span>&nbsp;<span class="num" id="4464437">32</span><span class="op" id="4464439">)</span><span class="op" id="4464440">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464444">ocspStapling</span><span class="op" id="4464456">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4464465">true</span><span class="op" id="4464469">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464473">serverName</span><span class="op" id="4464483">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464494">c</span><span class="op" id="4464495">.</span><span class="ident" id="4464496">config</span><span class="op" id="4464502">.</span><span class="ident" id="4464503">ServerName</span><span class="op" id="4464513">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464517">supportedCurves</span><span class="op" id="4464532">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464538">c</span><span class="op" id="4464539">.</span><span class="ident" id="4464540">config</span><span class="op" id="4464546">.</span><span class="ident" id="4464547">curvePreferences</span><span class="op" id="4464563">(</span><span class="op" id="4464564">)</span><span class="op" id="4464565">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464569">supportedPoints</span><span class="op" id="4464584">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4464590">[</span><span class="op" id="4464591">]</span><span class="builtintype" id="4464592">uint8</span><span class="op" id="4464597">{</span><span class="ident" id="4464598">pointFormatUncompressed</span><span class="op" id="4464621">}</span><span class="op" id="4464622">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464626">nextProtoNeg</span><span class="op" id="4464638">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4464647">len</span><span class="op" id="4464650">(</span><span class="ident" id="4464651">c</span><span class="op" id="4464652">.</span><span class="ident" id="4464653">config</span><span class="op" id="4464659">.</span><span class="ident" id="4464660">NextProtos</span><span class="op" id="4464670">)</span>&nbsp;<span class="op" id="4464672">&gt;</span>&nbsp;<span class="num" id="4464674">0</span><span class="op" id="4464675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464679">secureRenegotiation</span><span class="op" id="4464698">:</span>&nbsp;<span class="builtintype" id="4464700">true</span><span class="op" id="4464704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464708">alpnProtocols</span><span class="op" id="4464721">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464729">c</span><span class="op" id="4464730">.</span><span class="ident" id="4464731">config</span><span class="op" id="4464737">.</span><span class="ident" id="4464738">NextProtos</span><span class="op" id="4464748">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4464751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464755">possibleCipherSuites</span>&nbsp;<span class="op" id="4464776">:=</span>&nbsp;<span class="ident" id="4464779">c</span><span class="op" id="4464780">.</span><span class="ident" id="4464781">config</span><span class="op" id="4464787">.</span><span class="ident" id="4464788">cipherSuites</span><span class="op" id="4464800">(</span><span class="op" id="4464801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4464804">hello</span><span class="op" id="4464809">.</span><span class="ident" id="4464810">cipherSuites</span>&nbsp;<span class="op" id="4464823">=</span>&nbsp;<span class="builtinfunc" id="4464825">make</span><span class="op" id="4464829">(</span><span class="op" id="4464830">[</span><span class="op" id="4464831">]</span><span class="builtintype" id="4464832">uint16</span><span class="op" id="4464838">,</span>&nbsp;<span class="num" id="4464840">0</span><span class="op" id="4464841">,</span>&nbsp;<span class="builtinfunc" id="4464843">len</span><span class="op" id="4464846">(</span><span class="ident" id="4464847">possibleCipherSuites</span><span class="op" id="4464867">)</span><span class="op" id="4464868">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4464871">NextCipherSuite</span><span class="op" id="4464886">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4464889">for</span>&nbsp;<span class="ident" id="4464893">_</span><span class="op" id="4464894">,</span>&nbsp;<span class="ident" id="4464896">suiteId</span>&nbsp;<span class="op" id="4464904">:=</span>&nbsp;<span class="keyword" id="4464907">range</span>&nbsp;<span class="ident" id="4464913">possibleCipherSuites</span>&nbsp;<span class="op" id="4464934">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4464938">for</span>&nbsp;<span class="ident" id="4464942">_</span><span class="op" id="4464943">,</span>&nbsp;<span class="ident" id="4464945">suite</span>&nbsp;<span class="op" id="4464951">:=</span>&nbsp;<span class="keyword" id="4464954">range</span>&nbsp;<span class="ident" id="4464960">cipherSuites</span>&nbsp;<span class="op" id="4464973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4464978">if</span>&nbsp;<span class="ident" id="4464981">suite</span><span class="op" id="4464986">.</span><span class="ident" id="4464987">id</span>&nbsp;<span class="op" id="4464990">!=</span>&nbsp;<span class="ident" id="4464993">suiteId</span>&nbsp;<span class="op" id="4465001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465007">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4465019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4465024">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4465080">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465112">if</span>&nbsp;<span class="ident" id="4465115">hello</span><span class="op" id="4465120">.</span><span class="ident" id="4465121">vers</span>&nbsp;<span class="op" id="4465126">&lt;</span>&nbsp;<span class="ident" id="4465128">VersionTLS12</span>&nbsp;<span class="op" id="4465141">&amp;&amp;</span>&nbsp;<span class="ident" id="4465144">suite</span><span class="op" id="4465149">.</span><span class="ident" id="4465150">flags</span><span class="op" id="4465155">&amp;</span><span class="ident" id="4465156">suiteTLS12</span>&nbsp;<span class="op" id="4465167">!=</span>&nbsp;<span class="num" id="4465170">0</span>&nbsp;<span class="op" id="4465172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465178">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4465190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465195">hello</span><span class="op" id="4465200">.</span><span class="ident" id="4465201">cipherSuites</span>&nbsp;<span class="op" id="4465214">=</span>&nbsp;<span class="builtinfunc" id="4465216">append</span><span class="op" id="4465222">(</span><span class="ident" id="4465223">hello</span><span class="op" id="4465228">.</span><span class="ident" id="4465229">cipherSuites</span><span class="op" id="4465241">,</span>&nbsp;<span class="ident" id="4465243">suiteId</span><span class="op" id="4465250">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465255">continue</span>&nbsp;<span class="ident" id="4465264">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4465282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4465285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465289">_</span><span class="op" id="4465290">,</span>&nbsp;<span class="ident" id="4465292">err</span>&nbsp;<span class="op" id="4465296">:=</span>&nbsp;<span class="ident" id="4465299">io</span><span class="op" id="4465301">.</span><span class="ident" id="4465302">ReadFull</span><span class="op" id="4465310">(</span><span class="ident" id="4465311">c</span><span class="op" id="4465312">.</span><span class="ident" id="4465313">config</span><span class="op" id="4465319">.</span><span class="ident" id="4465320">rand</span><span class="op" id="4465324">(</span><span class="op" id="4465325">)</span><span class="op" id="4465326">,</span>&nbsp;<span class="ident" id="4465328">hello</span><span class="op" id="4465333">.</span><span class="ident" id="4465334">random</span><span class="op" id="4465340">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465343">if</span>&nbsp;<span class="ident" id="4465346">err</span>&nbsp;<span class="op" id="4465350">!=</span>&nbsp;<span class="ident" id="4465353">nil</span>&nbsp;<span class="op" id="4465357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465361">c</span><span class="op" id="4465362">.</span><span class="ident" id="4465363">sendAlert</span><span class="op" id="4465372">(</span><span class="ident" id="4465373">alertInternalError</span><span class="op" id="4465391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465395">return</span>&nbsp;<span class="ident" id="4465402">errors</span><span class="op" id="4465408">.</span><span class="ident" id="4465409">New</span><span class="op" id="4465412">(</span><span class="string" id="4465413">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4465443">+</span>&nbsp;<span class="ident" id="4465445">err</span><span class="op" id="4465448">.</span><span class="ident" id="4465449">Error</span><span class="op" id="4465454">(</span><span class="op" id="4465455">)</span><span class="op" id="4465456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4465459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465463">if</span>&nbsp;<span class="ident" id="4465466">hello</span><span class="op" id="4465471">.</span><span class="ident" id="4465472">vers</span>&nbsp;<span class="op" id="4465477">&gt;=</span>&nbsp;<span class="ident" id="4465480">VersionTLS12</span>&nbsp;<span class="op" id="4465493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465497">hello</span><span class="op" id="4465502">.</span><span class="ident" id="4465503">signatureAndHashes</span>&nbsp;<span class="op" id="4465522">=</span>&nbsp;<span class="ident" id="4465524">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4465557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465561">var</span>&nbsp;<span class="ident" id="4465565">session</span>&nbsp;<span class="op" id="4465573">*</span><span class="ident" id="4465574">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465594">var</span>&nbsp;<span class="ident" id="4465598">cacheKey</span>&nbsp;<span class="builtintype" id="4465607">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465615">sessionCache</span>&nbsp;<span class="op" id="4465628">:=</span>&nbsp;<span class="ident" id="4465631">c</span><span class="op" id="4465632">.</span><span class="ident" id="4465633">config</span><span class="op" id="4465639">.</span><span class="ident" id="4465640">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465660">if</span>&nbsp;<span class="ident" id="4465663">c</span><span class="op" id="4465664">.</span><span class="ident" id="4465665">config</span><span class="op" id="4465671">.</span><span class="ident" id="4465672">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4465695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465699">sessionCache</span>&nbsp;<span class="op" id="4465712">=</span>&nbsp;<span class="ident" id="4465714">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4465719">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465723">if</span>&nbsp;<span class="ident" id="4465726">sessionCache</span>&nbsp;<span class="op" id="4465739">!=</span>&nbsp;<span class="ident" id="4465742">nil</span>&nbsp;<span class="op" id="4465746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465750">hello</span><span class="op" id="4465755">.</span><span class="ident" id="4465756">ticketSupported</span>&nbsp;<span class="op" id="4465772">=</span>&nbsp;<span class="builtintype" id="4465774">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4465782">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4465841">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465857">cacheKey</span>&nbsp;<span class="op" id="4465866">=</span>&nbsp;<span class="ident" id="4465868">clientSessionCacheKey</span><span class="op" id="4465889">(</span><span class="ident" id="4465890">c</span><span class="op" id="4465891">.</span><span class="ident" id="4465892">conn</span><span class="op" id="4465896">.</span><span class="ident" id="4465897">RemoteAddr</span><span class="op" id="4465907">(</span><span class="op" id="4465908">)</span><span class="op" id="4465909">,</span>&nbsp;<span class="ident" id="4465911">c</span><span class="op" id="4465912">.</span><span class="ident" id="4465913">config</span><span class="op" id="4465919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4465923">candidateSession</span><span class="op" id="4465939">,</span>&nbsp;<span class="ident" id="4465941">ok</span>&nbsp;<span class="op" id="4465944">:=</span>&nbsp;<span class="ident" id="4465947">sessionCache</span><span class="op" id="4465959">.</span><span class="ident" id="4465960">Get</span><span class="op" id="4465963">(</span><span class="ident" id="4465964">cacheKey</span><span class="op" id="4465972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4465976">if</span>&nbsp;<span class="ident" id="4465979">ok</span>&nbsp;<span class="op" id="4465982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4465987">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4466041">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466081">cipherSuiteOk</span>&nbsp;<span class="op" id="4466095">:=</span>&nbsp;<span class="builtintype" id="4466098">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466107">for</span>&nbsp;<span class="ident" id="4466111">_</span><span class="op" id="4466112">,</span>&nbsp;<span class="ident" id="4466114">id</span>&nbsp;<span class="op" id="4466117">:=</span>&nbsp;<span class="keyword" id="4466120">range</span>&nbsp;<span class="ident" id="4466126">hello</span><span class="op" id="4466131">.</span><span class="ident" id="4466132">cipherSuites</span>&nbsp;<span class="op" id="4466145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466151">if</span>&nbsp;<span class="ident" id="4466154">id</span>&nbsp;<span class="op" id="4466157">==</span>&nbsp;<span class="ident" id="4466160">candidateSession</span><span class="op" id="4466176">.</span><span class="ident" id="4466177">cipherSuite</span>&nbsp;<span class="op" id="4466189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466196">cipherSuiteOk</span>&nbsp;<span class="op" id="4466210">=</span>&nbsp;<span class="builtintype" id="4466212">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466222">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4466232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4466237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466243">versOk</span>&nbsp;<span class="op" id="4466250">:=</span>&nbsp;<span class="ident" id="4466253">candidateSession</span><span class="op" id="4466269">.</span><span class="ident" id="4466270">vers</span>&nbsp;<span class="op" id="4466275">&gt;=</span>&nbsp;<span class="ident" id="4466278">c</span><span class="op" id="4466279">.</span><span class="ident" id="4466280">config</span><span class="op" id="4466286">.</span><span class="ident" id="4466287">minVersion</span><span class="op" id="4466297">(</span><span class="op" id="4466298">)</span>&nbsp;<span class="op" id="4466300">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466307">candidateSession</span><span class="op" id="4466323">.</span><span class="ident" id="4466324">vers</span>&nbsp;<span class="op" id="4466329">&lt;=</span>&nbsp;<span class="ident" id="4466332">c</span><span class="op" id="4466333">.</span><span class="ident" id="4466334">config</span><span class="op" id="4466340">.</span><span class="ident" id="4466341">maxVersion</span><span class="op" id="4466351">(</span><span class="op" id="4466352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466357">if</span>&nbsp;<span class="ident" id="4466360">versOk</span>&nbsp;<span class="op" id="4466367">&amp;&amp;</span>&nbsp;<span class="ident" id="4466370">cipherSuiteOk</span>&nbsp;<span class="op" id="4466384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466390">session</span>&nbsp;<span class="op" id="4466398">=</span>&nbsp;<span class="ident" id="4466400">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4466420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4466424">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4466427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466431">if</span>&nbsp;<span class="ident" id="4466434">session</span>&nbsp;<span class="op" id="4466442">!=</span>&nbsp;<span class="ident" id="4466445">nil</span>&nbsp;<span class="op" id="4466449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466453">hello</span><span class="op" id="4466458">.</span><span class="ident" id="4466459">sessionTicket</span>&nbsp;<span class="op" id="4466473">=</span>&nbsp;<span class="ident" id="4466475">session</span><span class="op" id="4466482">.</span><span class="ident" id="4466483">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4466499">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4466551">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4466609">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466630">hello</span><span class="op" id="4466635">.</span><span class="ident" id="4466636">sessionId</span>&nbsp;<span class="op" id="4466646">=</span>&nbsp;<span class="builtinfunc" id="4466648">make</span><span class="op" id="4466652">(</span><span class="op" id="4466653">[</span><span class="op" id="4466654">]</span><span class="builtintype" id="4466655">byte</span><span class="op" id="4466659">,</span>&nbsp;<span class="num" id="4466661">16</span><span class="op" id="4466663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466667">if</span>&nbsp;<span class="ident" id="4466670">_</span><span class="op" id="4466671">,</span>&nbsp;<span class="ident" id="4466673">err</span>&nbsp;<span class="op" id="4466677">:=</span>&nbsp;<span class="ident" id="4466680">io</span><span class="op" id="4466682">.</span><span class="ident" id="4466683">ReadFull</span><span class="op" id="4466691">(</span><span class="ident" id="4466692">c</span><span class="op" id="4466693">.</span><span class="ident" id="4466694">config</span><span class="op" id="4466700">.</span><span class="ident" id="4466701">rand</span><span class="op" id="4466705">(</span><span class="op" id="4466706">)</span><span class="op" id="4466707">,</span>&nbsp;<span class="ident" id="4466709">hello</span><span class="op" id="4466714">.</span><span class="ident" id="4466715">sessionId</span><span class="op" id="4466724">)</span><span class="op" id="4466725">;</span>&nbsp;<span class="ident" id="4466727">err</span>&nbsp;<span class="op" id="4466731">!=</span>&nbsp;<span class="ident" id="4466734">nil</span>&nbsp;<span class="op" id="4466738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466743">c</span><span class="op" id="4466744">.</span><span class="ident" id="4466745">sendAlert</span><span class="op" id="4466754">(</span><span class="ident" id="4466755">alertInternalError</span><span class="op" id="4466773">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466778">return</span>&nbsp;<span class="ident" id="4466785">errors</span><span class="op" id="4466791">.</span><span class="ident" id="4466792">New</span><span class="op" id="4466795">(</span><span class="string" id="4466796">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4466826">+</span>&nbsp;<span class="ident" id="4466828">err</span><span class="op" id="4466831">.</span><span class="ident" id="4466832">Error</span><span class="op" id="4466837">(</span><span class="op" id="4466838">)</span><span class="op" id="4466839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4466843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4466846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466850">c</span><span class="op" id="4466851">.</span><span class="ident" id="4466852">writeRecord</span><span class="op" id="4466863">(</span><span class="ident" id="4466864">recordTypeHandshake</span><span class="op" id="4466883">,</span>&nbsp;<span class="ident" id="4466885">hello</span><span class="op" id="4466890">.</span><span class="ident" id="4466891">marshal</span><span class="op" id="4466898">(</span><span class="op" id="4466899">)</span><span class="op" id="4466900">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466904">msg</span><span class="op" id="4466907">,</span>&nbsp;<span class="ident" id="4466909">err</span>&nbsp;<span class="op" id="4466913">:=</span>&nbsp;<span class="ident" id="4466916">c</span><span class="op" id="4466917">.</span><span class="ident" id="4466918">readHandshake</span><span class="op" id="4466931">(</span><span class="op" id="4466932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466935">if</span>&nbsp;<span class="ident" id="4466938">err</span>&nbsp;<span class="op" id="4466942">!=</span>&nbsp;<span class="ident" id="4466945">nil</span>&nbsp;<span class="op" id="4466949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4466953">return</span>&nbsp;<span class="ident" id="4466960">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4466965">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4466968">serverHello</span><span class="op" id="4466979">,</span>&nbsp;<span class="ident" id="4466981">ok</span>&nbsp;<span class="op" id="4466984">:=</span>&nbsp;<span class="ident" id="4466987">msg</span><span class="op" id="4466990">.</span><span class="op" id="4466991">(</span><span class="op" id="4466992">*</span><span class="ident" id="4466993">serverHelloMsg</span><span class="op" id="4467007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467010">if</span>&nbsp;<span class="op" id="4467013">!</span><span class="ident" id="4467014">ok</span>&nbsp;<span class="op" id="4467017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467021">c</span><span class="op" id="4467022">.</span><span class="ident" id="4467023">sendAlert</span><span class="op" id="4467032">(</span><span class="ident" id="4467033">alertUnexpectedMessage</span><span class="op" id="4467055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467059">return</span>&nbsp;<span class="ident" id="4467066">unexpectedMessageError</span><span class="op" id="4467088">(</span><span class="ident" id="4467089">serverHello</span><span class="op" id="4467100">,</span>&nbsp;<span class="ident" id="4467102">msg</span><span class="op" id="4467105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4467108">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467112">vers</span><span class="op" id="4467116">,</span>&nbsp;<span class="ident" id="4467118">ok</span>&nbsp;<span class="op" id="4467121">:=</span>&nbsp;<span class="ident" id="4467124">c</span><span class="op" id="4467125">.</span><span class="ident" id="4467126">config</span><span class="op" id="4467132">.</span><span class="ident" id="4467133">mutualVersion</span><span class="op" id="4467146">(</span><span class="ident" id="4467147">serverHello</span><span class="op" id="4467158">.</span><span class="ident" id="4467159">vers</span><span class="op" id="4467163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467166">if</span>&nbsp;<span class="op" id="4467169">!</span><span class="ident" id="4467170">ok</span>&nbsp;<span class="op" id="4467173">||</span>&nbsp;<span class="ident" id="4467176">vers</span>&nbsp;<span class="op" id="4467181">&lt;</span>&nbsp;<span class="ident" id="4467183">VersionTLS10</span>&nbsp;<span class="op" id="4467196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4467200">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467259">c</span><span class="op" id="4467260">.</span><span class="ident" id="4467261">sendAlert</span><span class="op" id="4467270">(</span><span class="ident" id="4467271">alertProtocolVersion</span><span class="op" id="4467291">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467295">return</span>&nbsp;<span class="ident" id="4467302">fmt</span><span class="op" id="4467305">.</span><span class="ident" id="4467306">Errorf</span><span class="op" id="4467312">(</span><span class="string" id="4467313">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4467367">,</span>&nbsp;<span class="ident" id="4467369">serverHello</span><span class="op" id="4467380">.</span><span class="ident" id="4467381">vers</span><span class="op" id="4467385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4467388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467391">c</span><span class="op" id="4467392">.</span><span class="ident" id="4467393">vers</span>&nbsp;<span class="op" id="4467398">=</span>&nbsp;<span class="ident" id="4467400">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467406">c</span><span class="op" id="4467407">.</span><span class="ident" id="4467408">haveVers</span>&nbsp;<span class="op" id="4467417">=</span>&nbsp;<span class="builtintype" id="4467419">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467426">suite</span>&nbsp;<span class="op" id="4467432">:=</span>&nbsp;<span class="ident" id="4467435">mutualCipherSuite</span><span class="op" id="4467452">(</span><span class="ident" id="4467453">c</span><span class="op" id="4467454">.</span><span class="ident" id="4467455">config</span><span class="op" id="4467461">.</span><span class="ident" id="4467462">cipherSuites</span><span class="op" id="4467474">(</span><span class="op" id="4467475">)</span><span class="op" id="4467476">,</span>&nbsp;<span class="ident" id="4467478">serverHello</span><span class="op" id="4467489">.</span><span class="ident" id="4467490">cipherSuite</span><span class="op" id="4467501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467504">if</span>&nbsp;<span class="ident" id="4467507">suite</span>&nbsp;<span class="op" id="4467513">==</span>&nbsp;<span class="ident" id="4467516">nil</span>&nbsp;<span class="op" id="4467520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467524">c</span><span class="op" id="4467525">.</span><span class="ident" id="4467526">sendAlert</span><span class="op" id="4467535">(</span><span class="ident" id="4467536">alertHandshakeFailure</span><span class="op" id="4467557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467561">return</span>&nbsp;<span class="ident" id="4467568">fmt</span><span class="op" id="4467571">.</span><span class="ident" id="4467572">Errorf</span><span class="op" id="4467578">(</span><span class="string" id="4467579">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="4467629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4467632">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467636">hs</span>&nbsp;<span class="op" id="4467639">:=</span>&nbsp;<span class="op" id="4467642">&amp;</span><span class="ident" id="4467643">clientHandshakeState</span><span class="op" id="4467663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467667">c</span><span class="op" id="4467668">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467681">c</span><span class="op" id="4467682">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467686">serverHello</span><span class="op" id="4467697">:</span>&nbsp;&nbsp;<span class="ident" id="4467700">serverHello</span><span class="op" id="4467711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467715">hello</span><span class="op" id="4467720">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467729">hello</span><span class="op" id="4467734">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467738">suite</span><span class="op" id="4467743">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467752">suite</span><span class="op" id="4467757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467761">finishedHash</span><span class="op" id="4467773">:</span>&nbsp;<span class="ident" id="4467775">newFinishedHash</span><span class="op" id="4467790">(</span><span class="ident" id="4467791">c</span><span class="op" id="4467792">.</span><span class="ident" id="4467793">vers</span><span class="op" id="4467797">)</span><span class="op" id="4467798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467802">session</span><span class="op" id="4467809">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467816">session</span><span class="op" id="4467823">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4467826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467830">hs</span><span class="op" id="4467832">.</span><span class="ident" id="4467833">finishedHash</span><span class="op" id="4467845">.</span><span class="ident" id="4467846">Write</span><span class="op" id="4467851">(</span><span class="ident" id="4467852">hs</span><span class="op" id="4467854">.</span><span class="ident" id="4467855">hello</span><span class="op" id="4467860">.</span><span class="ident" id="4467861">marshal</span><span class="op" id="4467868">(</span><span class="op" id="4467869">)</span><span class="op" id="4467870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467873">hs</span><span class="op" id="4467875">.</span><span class="ident" id="4467876">finishedHash</span><span class="op" id="4467888">.</span><span class="ident" id="4467889">Write</span><span class="op" id="4467894">(</span><span class="ident" id="4467895">hs</span><span class="op" id="4467897">.</span><span class="ident" id="4467898">serverHello</span><span class="op" id="4467909">.</span><span class="ident" id="4467910">marshal</span><span class="op" id="4467917">(</span><span class="op" id="4467918">)</span><span class="op" id="4467919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4467923">isResume</span><span class="op" id="4467931">,</span>&nbsp;<span class="ident" id="4467933">err</span>&nbsp;<span class="op" id="4467937">:=</span>&nbsp;<span class="ident" id="4467940">hs</span><span class="op" id="4467942">.</span><span class="ident" id="4467943">processServerHello</span><span class="op" id="4467961">(</span><span class="op" id="4467962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467965">if</span>&nbsp;<span class="ident" id="4467968">err</span>&nbsp;<span class="op" id="4467972">!=</span>&nbsp;<span class="ident" id="4467975">nil</span>&nbsp;<span class="op" id="4467979">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467983">return</span>&nbsp;<span class="ident" id="4467990">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4467995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4467999">if</span>&nbsp;<span class="ident" id="4468002">isResume</span>&nbsp;<span class="op" id="4468011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468015">if</span>&nbsp;<span class="ident" id="4468018">err</span>&nbsp;<span class="op" id="4468022">:=</span>&nbsp;<span class="ident" id="4468025">hs</span><span class="op" id="4468027">.</span><span class="ident" id="4468028">establishKeys</span><span class="op" id="4468041">(</span><span class="op" id="4468042">)</span><span class="op" id="4468043">;</span>&nbsp;<span class="ident" id="4468045">err</span>&nbsp;<span class="op" id="4468049">!=</span>&nbsp;<span class="ident" id="4468052">nil</span>&nbsp;<span class="op" id="4468056">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468061">return</span>&nbsp;<span class="ident" id="4468068">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468078">if</span>&nbsp;<span class="ident" id="4468081">err</span>&nbsp;<span class="op" id="4468085">:=</span>&nbsp;<span class="ident" id="4468088">hs</span><span class="op" id="4468090">.</span><span class="ident" id="4468091">readSessionTicket</span><span class="op" id="4468108">(</span><span class="op" id="4468109">)</span><span class="op" id="4468110">;</span>&nbsp;<span class="ident" id="4468112">err</span>&nbsp;<span class="op" id="4468116">!=</span>&nbsp;<span class="ident" id="4468119">nil</span>&nbsp;<span class="op" id="4468123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468128">return</span>&nbsp;<span class="ident" id="4468135">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468141">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468145">if</span>&nbsp;<span class="ident" id="4468148">err</span>&nbsp;<span class="op" id="4468152">:=</span>&nbsp;<span class="ident" id="4468155">hs</span><span class="op" id="4468157">.</span><span class="ident" id="4468158">readFinished</span><span class="op" id="4468170">(</span><span class="ident" id="4468171">c</span><span class="op" id="4468172">.</span><span class="ident" id="4468173">firstFinished</span><span class="op" id="4468186">[</span><span class="op" id="4468187">:</span><span class="op" id="4468188">]</span><span class="op" id="4468189">)</span><span class="op" id="4468190">;</span>&nbsp;<span class="ident" id="4468192">err</span>&nbsp;<span class="op" id="4468196">!=</span>&nbsp;<span class="ident" id="4468199">nil</span>&nbsp;<span class="op" id="4468203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468208">return</span>&nbsp;<span class="ident" id="4468215">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468225">if</span>&nbsp;<span class="ident" id="4468228">err</span>&nbsp;<span class="op" id="4468232">:=</span>&nbsp;<span class="ident" id="4468235">hs</span><span class="op" id="4468237">.</span><span class="ident" id="4468238">sendFinished</span><span class="op" id="4468250">(</span><span class="ident" id="4468251">nil</span><span class="op" id="4468254">)</span><span class="op" id="4468255">;</span>&nbsp;<span class="ident" id="4468257">err</span>&nbsp;<span class="op" id="4468261">!=</span>&nbsp;<span class="ident" id="4468264">nil</span>&nbsp;<span class="op" id="4468268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468273">return</span>&nbsp;<span class="ident" id="4468280">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468289">}</span>&nbsp;<span class="keyword" id="4468291">else</span>&nbsp;<span class="op" id="4468296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468300">if</span>&nbsp;<span class="ident" id="4468303">err</span>&nbsp;<span class="op" id="4468307">:=</span>&nbsp;<span class="ident" id="4468310">hs</span><span class="op" id="4468312">.</span><span class="ident" id="4468313">doFullHandshake</span><span class="op" id="4468328">(</span><span class="op" id="4468329">)</span><span class="op" id="4468330">;</span>&nbsp;<span class="ident" id="4468332">err</span>&nbsp;<span class="op" id="4468336">!=</span>&nbsp;<span class="ident" id="4468339">nil</span>&nbsp;<span class="op" id="4468343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468348">return</span>&nbsp;<span class="ident" id="4468355">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468361">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468365">if</span>&nbsp;<span class="ident" id="4468368">err</span>&nbsp;<span class="op" id="4468372">:=</span>&nbsp;<span class="ident" id="4468375">hs</span><span class="op" id="4468377">.</span><span class="ident" id="4468378">establishKeys</span><span class="op" id="4468391">(</span><span class="op" id="4468392">)</span><span class="op" id="4468393">;</span>&nbsp;<span class="ident" id="4468395">err</span>&nbsp;<span class="op" id="4468399">!=</span>&nbsp;<span class="ident" id="4468402">nil</span>&nbsp;<span class="op" id="4468406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468411">return</span>&nbsp;<span class="ident" id="4468418">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468428">if</span>&nbsp;<span class="ident" id="4468431">err</span>&nbsp;<span class="op" id="4468435">:=</span>&nbsp;<span class="ident" id="4468438">hs</span><span class="op" id="4468440">.</span><span class="ident" id="4468441">sendFinished</span><span class="op" id="4468453">(</span><span class="ident" id="4468454">c</span><span class="op" id="4468455">.</span><span class="ident" id="4468456">firstFinished</span><span class="op" id="4468469">[</span><span class="op" id="4468470">:</span><span class="op" id="4468471">]</span><span class="op" id="4468472">)</span><span class="op" id="4468473">;</span>&nbsp;<span class="ident" id="4468475">err</span>&nbsp;<span class="op" id="4468479">!=</span>&nbsp;<span class="ident" id="4468482">nil</span>&nbsp;<span class="op" id="4468486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468491">return</span>&nbsp;<span class="ident" id="4468498">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468508">if</span>&nbsp;<span class="ident" id="4468511">err</span>&nbsp;<span class="op" id="4468515">:=</span>&nbsp;<span class="ident" id="4468518">hs</span><span class="op" id="4468520">.</span><span class="ident" id="4468521">readSessionTicket</span><span class="op" id="4468538">(</span><span class="op" id="4468539">)</span><span class="op" id="4468540">;</span>&nbsp;<span class="ident" id="4468542">err</span>&nbsp;<span class="op" id="4468546">!=</span>&nbsp;<span class="ident" id="4468549">nil</span>&nbsp;<span class="op" id="4468553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468558">return</span>&nbsp;<span class="ident" id="4468565">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468575">if</span>&nbsp;<span class="ident" id="4468578">err</span>&nbsp;<span class="op" id="4468582">:=</span>&nbsp;<span class="ident" id="4468585">hs</span><span class="op" id="4468587">.</span><span class="ident" id="4468588">readFinished</span><span class="op" id="4468600">(</span><span class="ident" id="4468601">nil</span><span class="op" id="4468604">)</span><span class="op" id="4468605">;</span>&nbsp;<span class="ident" id="4468607">err</span>&nbsp;<span class="op" id="4468611">!=</span>&nbsp;<span class="ident" id="4468614">nil</span>&nbsp;<span class="op" id="4468618">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468623">return</span>&nbsp;<span class="ident" id="4468630">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468643">if</span>&nbsp;<span class="ident" id="4468646">sessionCache</span>&nbsp;<span class="op" id="4468659">!=</span>&nbsp;<span class="ident" id="4468662">nil</span>&nbsp;<span class="op" id="4468666">&amp;&amp;</span>&nbsp;<span class="ident" id="4468669">hs</span><span class="op" id="4468671">.</span><span class="ident" id="4468672">session</span>&nbsp;<span class="op" id="4468680">!=</span>&nbsp;<span class="ident" id="4468683">nil</span>&nbsp;<span class="op" id="4468687">&amp;&amp;</span>&nbsp;<span class="ident" id="4468690">session</span>&nbsp;<span class="op" id="4468698">!=</span>&nbsp;<span class="ident" id="4468701">hs</span><span class="op" id="4468703">.</span><span class="ident" id="4468704">session</span>&nbsp;<span class="op" id="4468712">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4468716">sessionCache</span><span class="op" id="4468728">.</span><span class="ident" id="4468729">Put</span><span class="op" id="4468732">(</span><span class="ident" id="4468733">cacheKey</span><span class="op" id="4468741">,</span>&nbsp;<span class="ident" id="4468743">hs</span><span class="op" id="4468745">.</span><span class="ident" id="4468746">session</span><span class="op" id="4468753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4468760">c</span><span class="op" id="4468761">.</span><span class="ident" id="4468762">didResume</span>&nbsp;<span class="op" id="4468772">=</span>&nbsp;<span class="ident" id="4468774">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4468784">c</span><span class="op" id="4468785">.</span><span class="ident" id="4468786">handshakeComplete</span>&nbsp;<span class="op" id="4468804">=</span>&nbsp;<span class="builtintype" id="4468806">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4468812">c</span><span class="op" id="4468813">.</span><span class="ident" id="4468814">cipherSuite</span>&nbsp;<span class="op" id="4468826">=</span>&nbsp;<span class="ident" id="4468828">suite</span><span class="op" id="4468833">.</span><span class="ident" id="4468834">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468838">return</span>&nbsp;<span class="ident" id="4468845">nil</span><br>
<span class="lineno"></span><span class="op" id="4468849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4468852">func</span>&nbsp;<span class="op" id="4468857">(</span><span class="ident" id="4468858">hs</span>&nbsp;<span class="op" id="4468861">*</span><span class="ident" id="4468862">clientHandshakeState</span><span class="op" id="4468882">)</span>&nbsp;<span class="ident" id="4468884">doFullHandshake</span><span class="op" id="4468899">(</span><span class="op" id="4468900">)</span>&nbsp;<span class="builtintype" id="4468902">error</span>&nbsp;<span class="op" id="4468908">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4468911">c</span>&nbsp;<span class="op" id="4468913">:=</span>&nbsp;<span class="ident" id="4468916">hs</span><span class="op" id="4468918">.</span><span class="ident" id="4468919">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4468923">msg</span><span class="op" id="4468926">,</span>&nbsp;<span class="ident" id="4468928">err</span>&nbsp;<span class="op" id="4468932">:=</span>&nbsp;<span class="ident" id="4468935">c</span><span class="op" id="4468936">.</span><span class="ident" id="4468937">readHandshake</span><span class="op" id="4468950">(</span><span class="op" id="4468951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468954">if</span>&nbsp;<span class="ident" id="4468957">err</span>&nbsp;<span class="op" id="4468961">!=</span>&nbsp;<span class="ident" id="4468964">nil</span>&nbsp;<span class="op" id="4468968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4468972">return</span>&nbsp;<span class="ident" id="4468979">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4468984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4468987">certMsg</span><span class="op" id="4468994">,</span>&nbsp;<span class="ident" id="4468996">ok</span>&nbsp;<span class="op" id="4468999">:=</span>&nbsp;<span class="ident" id="4469002">msg</span><span class="op" id="4469005">.</span><span class="op" id="4469006">(</span><span class="op" id="4469007">*</span><span class="ident" id="4469008">certificateMsg</span><span class="op" id="4469022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469025">if</span>&nbsp;<span class="op" id="4469028">!</span><span class="ident" id="4469029">ok</span>&nbsp;<span class="op" id="4469032">||</span>&nbsp;<span class="builtinfunc" id="4469035">len</span><span class="op" id="4469038">(</span><span class="ident" id="4469039">certMsg</span><span class="op" id="4469046">.</span><span class="ident" id="4469047">certificates</span><span class="op" id="4469059">)</span>&nbsp;<span class="op" id="4469061">==</span>&nbsp;<span class="num" id="4469064">0</span>&nbsp;<span class="op" id="4469066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469070">c</span><span class="op" id="4469071">.</span><span class="ident" id="4469072">sendAlert</span><span class="op" id="4469081">(</span><span class="ident" id="4469082">alertUnexpectedMessage</span><span class="op" id="4469104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469108">return</span>&nbsp;<span class="ident" id="4469115">unexpectedMessageError</span><span class="op" id="4469137">(</span><span class="ident" id="4469138">certMsg</span><span class="op" id="4469145">,</span>&nbsp;<span class="ident" id="4469147">msg</span><span class="op" id="4469150">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4469153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469156">hs</span><span class="op" id="4469158">.</span><span class="ident" id="4469159">finishedHash</span><span class="op" id="4469171">.</span><span class="ident" id="4469172">Write</span><span class="op" id="4469177">(</span><span class="ident" id="4469178">certMsg</span><span class="op" id="4469185">.</span><span class="ident" id="4469186">marshal</span><span class="op" id="4469193">(</span><span class="op" id="4469194">)</span><span class="op" id="4469195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469199">certs</span>&nbsp;<span class="op" id="4469205">:=</span>&nbsp;<span class="builtinfunc" id="4469208">make</span><span class="op" id="4469212">(</span><span class="op" id="4469213">[</span><span class="op" id="4469214">]</span><span class="op" id="4469215">*</span><span class="ident" id="4469216">x509</span><span class="op" id="4469220">.</span><span class="ident" id="4469221">Certificate</span><span class="op" id="4469232">,</span>&nbsp;<span class="builtinfunc" id="4469234">len</span><span class="op" id="4469237">(</span><span class="ident" id="4469238">certMsg</span><span class="op" id="4469245">.</span><span class="ident" id="4469246">certificates</span><span class="op" id="4469258">)</span><span class="op" id="4469259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469262">for</span>&nbsp;<span class="ident" id="4469266">i</span><span class="op" id="4469267">,</span>&nbsp;<span class="ident" id="4469269">asn1Data</span>&nbsp;<span class="op" id="4469278">:=</span>&nbsp;<span class="keyword" id="4469281">range</span>&nbsp;<span class="ident" id="4469287">certMsg</span><span class="op" id="4469294">.</span><span class="ident" id="4469295">certificates</span>&nbsp;<span class="op" id="4469308">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469312">cert</span><span class="op" id="4469316">,</span>&nbsp;<span class="ident" id="4469318">err</span>&nbsp;<span class="op" id="4469322">:=</span>&nbsp;<span class="ident" id="4469325">x509</span><span class="op" id="4469329">.</span><span class="ident" id="4469330">ParseCertificate</span><span class="op" id="4469346">(</span><span class="ident" id="4469347">asn1Data</span><span class="op" id="4469355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469359">if</span>&nbsp;<span class="ident" id="4469362">err</span>&nbsp;<span class="op" id="4469366">!=</span>&nbsp;<span class="ident" id="4469369">nil</span>&nbsp;<span class="op" id="4469373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469378">c</span><span class="op" id="4469379">.</span><span class="ident" id="4469380">sendAlert</span><span class="op" id="4469389">(</span><span class="ident" id="4469390">alertBadCertificate</span><span class="op" id="4469409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469414">return</span>&nbsp;<span class="ident" id="4469421">errors</span><span class="op" id="4469427">.</span><span class="ident" id="4469428">New</span><span class="op" id="4469431">(</span><span class="string" id="4469432">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="4469481">+</span>&nbsp;<span class="ident" id="4469483">err</span><span class="op" id="4469486">.</span><span class="ident" id="4469487">Error</span><span class="op" id="4469492">(</span><span class="op" id="4469493">)</span><span class="op" id="4469494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4469498">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469502">certs</span><span class="op" id="4469507">[</span><span class="ident" id="4469508">i</span><span class="op" id="4469509">]</span>&nbsp;<span class="op" id="4469511">=</span>&nbsp;<span class="ident" id="4469513">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4469519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469523">if</span>&nbsp;<span class="op" id="4469526">!</span><span class="ident" id="4469527">c</span><span class="op" id="4469528">.</span><span class="ident" id="4469529">config</span><span class="op" id="4469535">.</span><span class="ident" id="4469536">InsecureSkipVerify</span>&nbsp;<span class="op" id="4469555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469559">opts</span>&nbsp;<span class="op" id="4469564">:=</span>&nbsp;<span class="ident" id="4469567">x509</span><span class="op" id="4469571">.</span><span class="ident" id="4469572">VerifyOptions</span><span class="op" id="4469585">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469590">Roots</span><span class="op" id="4469595">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469605">c</span><span class="op" id="4469606">.</span><span class="ident" id="4469607">config</span><span class="op" id="4469613">.</span><span class="ident" id="4469614">RootCAs</span><span class="op" id="4469621">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469626">CurrentTime</span><span class="op" id="4469637">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4469641">c</span><span class="op" id="4469642">.</span><span class="ident" id="4469643">config</span><span class="op" id="4469649">.</span><span class="ident" id="4469650">time</span><span class="op" id="4469654">(</span><span class="op" id="4469655">)</span><span class="op" id="4469656">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469661">DNSName</span><span class="op" id="4469668">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469676">c</span><span class="op" id="4469677">.</span><span class="ident" id="4469678">config</span><span class="op" id="4469684">.</span><span class="ident" id="4469685">ServerName</span><span class="op" id="4469695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469700">Intermediates</span><span class="op" id="4469713">:</span>&nbsp;<span class="ident" id="4469715">x509</span><span class="op" id="4469719">.</span><span class="ident" id="4469720">NewCertPool</span><span class="op" id="4469731">(</span><span class="op" id="4469732">)</span><span class="op" id="4469733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4469737">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469742">for</span>&nbsp;<span class="ident" id="4469746">i</span><span class="op" id="4469747">,</span>&nbsp;<span class="ident" id="4469749">cert</span>&nbsp;<span class="op" id="4469754">:=</span>&nbsp;<span class="keyword" id="4469757">range</span>&nbsp;<span class="ident" id="4469763">certs</span>&nbsp;<span class="op" id="4469769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469774">if</span>&nbsp;<span class="ident" id="4469777">i</span>&nbsp;<span class="op" id="4469779">==</span>&nbsp;<span class="num" id="4469782">0</span>&nbsp;<span class="op" id="4469784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469790">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4469802">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469807">opts</span><span class="op" id="4469811">.</span><span class="ident" id="4469812">Intermediates</span><span class="op" id="4469825">.</span><span class="ident" id="4469826">AddCert</span><span class="op" id="4469833">(</span><span class="ident" id="4469834">cert</span><span class="op" id="4469838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4469842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469846">c</span><span class="op" id="4469847">.</span><span class="ident" id="4469848">verifiedChains</span><span class="op" id="4469862">,</span>&nbsp;<span class="ident" id="4469864">err</span>&nbsp;<span class="op" id="4469868">=</span>&nbsp;<span class="ident" id="4469870">certs</span><span class="op" id="4469875">[</span><span class="num" id="4469876">0</span><span class="op" id="4469877">]</span><span class="op" id="4469878">.</span><span class="ident" id="4469879">Verify</span><span class="op" id="4469885">(</span><span class="ident" id="4469886">opts</span><span class="op" id="4469890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469894">if</span>&nbsp;<span class="ident" id="4469897">err</span>&nbsp;<span class="op" id="4469901">!=</span>&nbsp;<span class="ident" id="4469904">nil</span>&nbsp;<span class="op" id="4469908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4469913">c</span><span class="op" id="4469914">.</span><span class="ident" id="4469915">sendAlert</span><span class="op" id="4469924">(</span><span class="ident" id="4469925">alertBadCertificate</span><span class="op" id="4469944">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469949">return</span>&nbsp;<span class="ident" id="4469956">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4469962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4469965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4469969">switch</span>&nbsp;<span class="ident" id="4469976">certs</span><span class="op" id="4469981">[</span><span class="num" id="4469982">0</span><span class="op" id="4469983">]</span><span class="op" id="4469984">.</span><span class="ident" id="4469985">PublicKey</span><span class="op" id="4469994">.</span><span class="op" id="4469995">(</span><span class="keyword" id="4469996">type</span><span class="op" id="4470000">)</span>&nbsp;<span class="op" id="4470002">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470005">case</span>&nbsp;<span class="op" id="4470010">*</span><span class="ident" id="4470011">rsa</span><span class="op" id="4470014">.</span><span class="ident" id="4470015">PublicKey</span><span class="op" id="4470024">,</span>&nbsp;<span class="op" id="4470026">*</span><span class="ident" id="4470027">ecdsa</span><span class="op" id="4470032">.</span><span class="ident" id="4470033">PublicKey</span><span class="op" id="4470042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470046">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470053">default</span><span class="op" id="4470060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470064">c</span><span class="op" id="4470065">.</span><span class="ident" id="4470066">sendAlert</span><span class="op" id="4470075">(</span><span class="ident" id="4470076">alertUnsupportedCertificate</span><span class="op" id="4470103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470107">return</span>&nbsp;<span class="ident" id="4470114">fmt</span><span class="op" id="4470117">.</span><span class="ident" id="4470118">Errorf</span><span class="op" id="4470124">(</span><span class="string" id="4470125">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="4470199">,</span>&nbsp;<span class="ident" id="4470201">certs</span><span class="op" id="4470206">[</span><span class="num" id="4470207">0</span><span class="op" id="4470208">]</span><span class="op" id="4470209">.</span><span class="ident" id="4470210">PublicKey</span><span class="op" id="4470219">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4470222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470226">c</span><span class="op" id="4470227">.</span><span class="ident" id="4470228">peerCertificates</span>&nbsp;<span class="op" id="4470245">=</span>&nbsp;<span class="ident" id="4470247">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470255">if</span>&nbsp;<span class="ident" id="4470258">hs</span><span class="op" id="4470260">.</span><span class="ident" id="4470261">serverHello</span><span class="op" id="4470272">.</span><span class="ident" id="4470273">ocspStapling</span>&nbsp;<span class="op" id="4470286">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470290">msg</span><span class="op" id="4470293">,</span>&nbsp;<span class="ident" id="4470295">err</span>&nbsp;<span class="op" id="4470299">=</span>&nbsp;<span class="ident" id="4470301">c</span><span class="op" id="4470302">.</span><span class="ident" id="4470303">readHandshake</span><span class="op" id="4470316">(</span><span class="op" id="4470317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470321">if</span>&nbsp;<span class="ident" id="4470324">err</span>&nbsp;<span class="op" id="4470328">!=</span>&nbsp;<span class="ident" id="4470331">nil</span>&nbsp;<span class="op" id="4470335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470340">return</span>&nbsp;<span class="ident" id="4470347">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4470353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470357">cs</span><span class="op" id="4470359">,</span>&nbsp;<span class="ident" id="4470361">ok</span>&nbsp;<span class="op" id="4470364">:=</span>&nbsp;<span class="ident" id="4470367">msg</span><span class="op" id="4470370">.</span><span class="op" id="4470371">(</span><span class="op" id="4470372">*</span><span class="ident" id="4470373">certificateStatusMsg</span><span class="op" id="4470393">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470397">if</span>&nbsp;<span class="op" id="4470400">!</span><span class="ident" id="4470401">ok</span>&nbsp;<span class="op" id="4470404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470409">c</span><span class="op" id="4470410">.</span><span class="ident" id="4470411">sendAlert</span><span class="op" id="4470420">(</span><span class="ident" id="4470421">alertUnexpectedMessage</span><span class="op" id="4470443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470448">return</span>&nbsp;<span class="ident" id="4470455">unexpectedMessageError</span><span class="op" id="4470477">(</span><span class="ident" id="4470478">cs</span><span class="op" id="4470480">,</span>&nbsp;<span class="ident" id="4470482">msg</span><span class="op" id="4470485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4470489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470493">hs</span><span class="op" id="4470495">.</span><span class="ident" id="4470496">finishedHash</span><span class="op" id="4470508">.</span><span class="ident" id="4470509">Write</span><span class="op" id="4470514">(</span><span class="ident" id="4470515">cs</span><span class="op" id="4470517">.</span><span class="ident" id="4470518">marshal</span><span class="op" id="4470525">(</span><span class="op" id="4470526">)</span><span class="op" id="4470527">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470532">if</span>&nbsp;<span class="ident" id="4470535">cs</span><span class="op" id="4470537">.</span><span class="ident" id="4470538">statusType</span>&nbsp;<span class="op" id="4470549">==</span>&nbsp;<span class="ident" id="4470552">statusTypeOCSP</span>&nbsp;<span class="op" id="4470567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470572">c</span><span class="op" id="4470573">.</span><span class="ident" id="4470574">ocspResponse</span>&nbsp;<span class="op" id="4470587">=</span>&nbsp;<span class="ident" id="4470589">cs</span><span class="op" id="4470591">.</span><span class="ident" id="4470592">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4470603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4470606">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470610">msg</span><span class="op" id="4470613">,</span>&nbsp;<span class="ident" id="4470615">err</span>&nbsp;<span class="op" id="4470619">=</span>&nbsp;<span class="ident" id="4470621">c</span><span class="op" id="4470622">.</span><span class="ident" id="4470623">readHandshake</span><span class="op" id="4470636">(</span><span class="op" id="4470637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470640">if</span>&nbsp;<span class="ident" id="4470643">err</span>&nbsp;<span class="op" id="4470647">!=</span>&nbsp;<span class="ident" id="4470650">nil</span>&nbsp;<span class="op" id="4470654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470658">return</span>&nbsp;<span class="ident" id="4470665">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4470670">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470674">keyAgreement</span>&nbsp;<span class="op" id="4470687">:=</span>&nbsp;<span class="ident" id="4470690">hs</span><span class="op" id="4470692">.</span><span class="ident" id="4470693">suite</span><span class="op" id="4470698">.</span><span class="ident" id="4470699">ka</span><span class="op" id="4470701">(</span><span class="ident" id="4470702">c</span><span class="op" id="4470703">.</span><span class="ident" id="4470704">vers</span><span class="op" id="4470708">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470712">skx</span><span class="op" id="4470715">,</span>&nbsp;<span class="ident" id="4470717">ok</span>&nbsp;<span class="op" id="4470720">:=</span>&nbsp;<span class="ident" id="4470723">msg</span><span class="op" id="4470726">.</span><span class="op" id="4470727">(</span><span class="op" id="4470728">*</span><span class="ident" id="4470729">serverKeyExchangeMsg</span><span class="op" id="4470749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470752">if</span>&nbsp;<span class="ident" id="4470755">ok</span>&nbsp;<span class="op" id="4470758">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470762">hs</span><span class="op" id="4470764">.</span><span class="ident" id="4470765">finishedHash</span><span class="op" id="4470777">.</span><span class="ident" id="4470778">Write</span><span class="op" id="4470783">(</span><span class="ident" id="4470784">skx</span><span class="op" id="4470787">.</span><span class="ident" id="4470788">marshal</span><span class="op" id="4470795">(</span><span class="op" id="4470796">)</span><span class="op" id="4470797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470801">err</span>&nbsp;<span class="op" id="4470805">=</span>&nbsp;<span class="ident" id="4470807">keyAgreement</span><span class="op" id="4470819">.</span><span class="ident" id="4470820">processServerKeyExchange</span><span class="op" id="4470844">(</span><span class="ident" id="4470845">c</span><span class="op" id="4470846">.</span><span class="ident" id="4470847">config</span><span class="op" id="4470853">,</span>&nbsp;<span class="ident" id="4470855">hs</span><span class="op" id="4470857">.</span><span class="ident" id="4470858">hello</span><span class="op" id="4470863">,</span>&nbsp;<span class="ident" id="4470865">hs</span><span class="op" id="4470867">.</span><span class="ident" id="4470868">serverHello</span><span class="op" id="4470879">,</span>&nbsp;<span class="ident" id="4470881">certs</span><span class="op" id="4470886">[</span><span class="num" id="4470887">0</span><span class="op" id="4470888">]</span><span class="op" id="4470889">,</span>&nbsp;<span class="ident" id="4470891">skx</span><span class="op" id="4470894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470898">if</span>&nbsp;<span class="ident" id="4470901">err</span>&nbsp;<span class="op" id="4470905">!=</span>&nbsp;<span class="ident" id="4470908">nil</span>&nbsp;<span class="op" id="4470912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470917">c</span><span class="op" id="4470918">.</span><span class="ident" id="4470919">sendAlert</span><span class="op" id="4470928">(</span><span class="ident" id="4470929">alertUnexpectedMessage</span><span class="op" id="4470951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4470956">return</span>&nbsp;<span class="ident" id="4470963">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4470969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4470974">msg</span><span class="op" id="4470977">,</span>&nbsp;<span class="ident" id="4470979">err</span>&nbsp;<span class="op" id="4470983">=</span>&nbsp;<span class="ident" id="4470985">c</span><span class="op" id="4470986">.</span><span class="ident" id="4470987">readHandshake</span><span class="op" id="4471000">(</span><span class="op" id="4471001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471005">if</span>&nbsp;<span class="ident" id="4471008">err</span>&nbsp;<span class="op" id="4471012">!=</span>&nbsp;<span class="ident" id="4471015">nil</span>&nbsp;<span class="op" id="4471019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471024">return</span>&nbsp;<span class="ident" id="4471031">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4471037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4471040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471044">var</span>&nbsp;<span class="ident" id="4471048">chainToSend</span>&nbsp;<span class="op" id="4471060">*</span><span class="ident" id="4471061">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471074">var</span>&nbsp;<span class="ident" id="4471078">certRequested</span>&nbsp;<span class="builtintype" id="4471092">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4471098">certReq</span><span class="op" id="4471105">,</span>&nbsp;<span class="ident" id="4471107">ok</span>&nbsp;<span class="op" id="4471110">:=</span>&nbsp;<span class="ident" id="4471113">msg</span><span class="op" id="4471116">.</span><span class="op" id="4471117">(</span><span class="op" id="4471118">*</span><span class="ident" id="4471119">certificateRequestMsg</span><span class="op" id="4471140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471143">if</span>&nbsp;<span class="ident" id="4471146">ok</span>&nbsp;<span class="op" id="4471149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4471153">certRequested</span>&nbsp;<span class="op" id="4471167">=</span>&nbsp;<span class="builtintype" id="4471169">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471177">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471228">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471293">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471359">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471422">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471487">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471534">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471597">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471642">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471700">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4471735">hs</span><span class="op" id="4471737">.</span><span class="ident" id="4471738">finishedHash</span><span class="op" id="4471750">.</span><span class="ident" id="4471751">Write</span><span class="op" id="4471756">(</span><span class="ident" id="4471757">certReq</span><span class="op" id="4471764">.</span><span class="ident" id="4471765">marshal</span><span class="op" id="4471772">(</span><span class="op" id="4471773">)</span><span class="op" id="4471774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471779">var</span>&nbsp;<span class="ident" id="4471783">rsaAvail</span><span class="op" id="4471791">,</span>&nbsp;<span class="ident" id="4471793">ecdsaAvail</span>&nbsp;<span class="builtintype" id="4471804">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471811">for</span>&nbsp;<span class="ident" id="4471815">_</span><span class="op" id="4471816">,</span>&nbsp;<span class="ident" id="4471818">certType</span>&nbsp;<span class="op" id="4471827">:=</span>&nbsp;<span class="keyword" id="4471830">range</span>&nbsp;<span class="ident" id="4471836">certReq</span><span class="op" id="4471843">.</span><span class="ident" id="4471844">certificateTypes</span>&nbsp;<span class="op" id="4471861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471866">switch</span>&nbsp;<span class="ident" id="4471873">certType</span>&nbsp;<span class="op" id="4471882">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471887">case</span>&nbsp;<span class="ident" id="4471892">certTypeRSASign</span><span class="op" id="4471907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4471913">rsaAvail</span>&nbsp;<span class="op" id="4471922">=</span>&nbsp;<span class="builtintype" id="4471924">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4471932">case</span>&nbsp;<span class="ident" id="4471937">certTypeECDSASign</span><span class="op" id="4471954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4471960">ecdsaAvail</span>&nbsp;<span class="op" id="4471971">=</span>&nbsp;<span class="builtintype" id="4471973">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4471981">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4471985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4471990">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4472046">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4472112">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4472160">findCert</span><span class="op" id="4472168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472172">for</span>&nbsp;<span class="ident" id="4472176">i</span><span class="op" id="4472177">,</span>&nbsp;<span class="ident" id="4472179">chain</span>&nbsp;<span class="op" id="4472185">:=</span>&nbsp;<span class="keyword" id="4472188">range</span>&nbsp;<span class="ident" id="4472194">c</span><span class="op" id="4472195">.</span><span class="ident" id="4472196">config</span><span class="op" id="4472202">.</span><span class="ident" id="4472203">Certificates</span>&nbsp;<span class="op" id="4472216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472221">if</span>&nbsp;<span class="op" id="4472224">!</span><span class="ident" id="4472225">rsaAvail</span>&nbsp;<span class="op" id="4472234">&amp;&amp;</span>&nbsp;<span class="op" id="4472237">!</span><span class="ident" id="4472238">ecdsaAvail</span>&nbsp;<span class="op" id="4472249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472255">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4472267">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472273">for</span>&nbsp;<span class="ident" id="4472277">j</span><span class="op" id="4472278">,</span>&nbsp;<span class="ident" id="4472280">cert</span>&nbsp;<span class="op" id="4472285">:=</span>&nbsp;<span class="keyword" id="4472288">range</span>&nbsp;<span class="ident" id="4472294">chain</span><span class="op" id="4472299">.</span><span class="ident" id="4472300">Certificate</span>&nbsp;<span class="op" id="4472312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4472318">x509Cert</span>&nbsp;<span class="op" id="4472327">:=</span>&nbsp;<span class="ident" id="4472330">chain</span><span class="op" id="4472335">.</span><span class="ident" id="4472336">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4472345">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4472397">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472435">if</span>&nbsp;<span class="ident" id="4472438">j</span>&nbsp;<span class="op" id="4472440">!=</span>&nbsp;<span class="num" id="4472443">0</span>&nbsp;<span class="op" id="4472445">||</span>&nbsp;<span class="ident" id="4472448">x509Cert</span>&nbsp;<span class="op" id="4472457">==</span>&nbsp;<span class="ident" id="4472460">nil</span>&nbsp;<span class="op" id="4472464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472471">if</span>&nbsp;<span class="ident" id="4472474">x509Cert</span><span class="op" id="4472482">,</span>&nbsp;<span class="ident" id="4472484">err</span>&nbsp;<span class="op" id="4472488">=</span>&nbsp;<span class="ident" id="4472490">x509</span><span class="op" id="4472494">.</span><span class="ident" id="4472495">ParseCertificate</span><span class="op" id="4472511">(</span><span class="ident" id="4472512">cert</span><span class="op" id="4472516">)</span><span class="op" id="4472517">;</span>&nbsp;<span class="ident" id="4472519">err</span>&nbsp;<span class="op" id="4472523">!=</span>&nbsp;<span class="ident" id="4472526">nil</span>&nbsp;<span class="op" id="4472530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4472538">c</span><span class="op" id="4472539">.</span><span class="ident" id="4472540">sendAlert</span><span class="op" id="4472549">(</span><span class="ident" id="4472550">alertInternalError</span><span class="op" id="4472568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472576">return</span>&nbsp;<span class="ident" id="4472583">errors</span><span class="op" id="4472589">.</span><span class="ident" id="4472590">New</span><span class="op" id="4472593">(</span><span class="string" id="4472594">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="4472638">+</span>&nbsp;<span class="ident" id="4472640">strconv</span><span class="op" id="4472647">.</span><span class="ident" id="4472648">Itoa</span><span class="op" id="4472652">(</span><span class="ident" id="4472653">i</span><span class="op" id="4472654">)</span>&nbsp;<span class="op" id="4472656">+</span>&nbsp;<span class="string" id="4472658">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4472663">+</span>&nbsp;<span class="ident" id="4472665">err</span><span class="op" id="4472668">.</span><span class="ident" id="4472669">Error</span><span class="op" id="4472674">(</span><span class="op" id="4472675">)</span><span class="op" id="4472676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4472683">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4472689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472696">switch</span>&nbsp;<span class="op" id="4472703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472709">case</span>&nbsp;<span class="ident" id="4472714">rsaAvail</span>&nbsp;<span class="op" id="4472723">&amp;&amp;</span>&nbsp;<span class="ident" id="4472726">x509Cert</span><span class="op" id="4472734">.</span><span class="ident" id="4472735">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4472754">==</span>&nbsp;<span class="ident" id="4472757">x509</span><span class="op" id="4472761">.</span><span class="ident" id="4472762">RSA</span><span class="op" id="4472765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472771">case</span>&nbsp;<span class="ident" id="4472776">ecdsaAvail</span>&nbsp;<span class="op" id="4472787">&amp;&amp;</span>&nbsp;<span class="ident" id="4472790">x509Cert</span><span class="op" id="4472798">.</span><span class="ident" id="4472799">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4472818">==</span>&nbsp;<span class="ident" id="4472821">x509</span><span class="op" id="4472825">.</span><span class="ident" id="4472826">ECDSA</span><span class="op" id="4472831">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472837">default</span><span class="op" id="4472844">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472851">continue</span>&nbsp;<span class="ident" id="4472860">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4472873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4472880">if</span>&nbsp;<span class="builtinfunc" id="4472883">len</span><span class="op" id="4472886">(</span><span class="ident" id="4472887">certReq</span><span class="op" id="4472894">.</span><span class="ident" id="4472895">certificateAuthorities</span><span class="op" id="4472917">)</span>&nbsp;<span class="op" id="4472919">==</span>&nbsp;<span class="num" id="4472922">0</span>&nbsp;<span class="op" id="4472924">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4472931">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4472984">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473030">chainToSend</span>&nbsp;<span class="op" id="4473042">=</span>&nbsp;<span class="op" id="4473044">&amp;</span><span class="ident" id="4473045">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473056">break</span>&nbsp;<span class="ident" id="4473062">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473075">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473082">for</span>&nbsp;<span class="ident" id="4473086">_</span><span class="op" id="4473087">,</span>&nbsp;<span class="ident" id="4473089">ca</span>&nbsp;<span class="op" id="4473092">:=</span>&nbsp;<span class="keyword" id="4473095">range</span>&nbsp;<span class="ident" id="4473101">certReq</span><span class="op" id="4473108">.</span><span class="ident" id="4473109">certificateAuthorities</span>&nbsp;<span class="op" id="4473132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473139">if</span>&nbsp;<span class="ident" id="4473142">bytes</span><span class="op" id="4473147">.</span><span class="ident" id="4473148">Equal</span><span class="op" id="4473153">(</span><span class="ident" id="4473154">x509Cert</span><span class="op" id="4473162">.</span><span class="ident" id="4473163">RawIssuer</span><span class="op" id="4473172">,</span>&nbsp;<span class="ident" id="4473174">ca</span><span class="op" id="4473176">)</span>&nbsp;<span class="op" id="4473178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473186">chainToSend</span>&nbsp;<span class="op" id="4473198">=</span>&nbsp;<span class="op" id="4473200">&amp;</span><span class="ident" id="4473201">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473213">break</span>&nbsp;<span class="ident" id="4473219">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473253">msg</span><span class="op" id="4473256">,</span>&nbsp;<span class="ident" id="4473258">err</span>&nbsp;<span class="op" id="4473262">=</span>&nbsp;<span class="ident" id="4473264">c</span><span class="op" id="4473265">.</span><span class="ident" id="4473266">readHandshake</span><span class="op" id="4473279">(</span><span class="op" id="4473280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473284">if</span>&nbsp;<span class="ident" id="4473287">err</span>&nbsp;<span class="op" id="4473291">!=</span>&nbsp;<span class="ident" id="4473294">nil</span>&nbsp;<span class="op" id="4473298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473303">return</span>&nbsp;<span class="ident" id="4473310">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473319">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473323">shd</span><span class="op" id="4473326">,</span>&nbsp;<span class="ident" id="4473328">ok</span>&nbsp;<span class="op" id="4473331">:=</span>&nbsp;<span class="ident" id="4473334">msg</span><span class="op" id="4473337">.</span><span class="op" id="4473338">(</span><span class="op" id="4473339">*</span><span class="ident" id="4473340">serverHelloDoneMsg</span><span class="op" id="4473358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473361">if</span>&nbsp;<span class="op" id="4473364">!</span><span class="ident" id="4473365">ok</span>&nbsp;<span class="op" id="4473368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473372">c</span><span class="op" id="4473373">.</span><span class="ident" id="4473374">sendAlert</span><span class="op" id="4473383">(</span><span class="ident" id="4473384">alertUnexpectedMessage</span><span class="op" id="4473406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473410">return</span>&nbsp;<span class="ident" id="4473417">unexpectedMessageError</span><span class="op" id="4473439">(</span><span class="ident" id="4473440">shd</span><span class="op" id="4473443">,</span>&nbsp;<span class="ident" id="4473445">msg</span><span class="op" id="4473448">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473454">hs</span><span class="op" id="4473456">.</span><span class="ident" id="4473457">finishedHash</span><span class="op" id="4473469">.</span><span class="ident" id="4473470">Write</span><span class="op" id="4473475">(</span><span class="ident" id="4473476">shd</span><span class="op" id="4473479">.</span><span class="ident" id="4473480">marshal</span><span class="op" id="4473487">(</span><span class="op" id="4473488">)</span><span class="op" id="4473489">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4473493">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4473558">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4473626">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473651">if</span>&nbsp;<span class="ident" id="4473654">certRequested</span>&nbsp;<span class="op" id="4473668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473672">certMsg</span>&nbsp;<span class="op" id="4473680">=</span>&nbsp;<span class="builtinfunc" id="4473682">new</span><span class="op" id="4473685">(</span><span class="ident" id="4473686">certificateMsg</span><span class="op" id="4473700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473704">if</span>&nbsp;<span class="ident" id="4473707">chainToSend</span>&nbsp;<span class="op" id="4473719">!=</span>&nbsp;<span class="ident" id="4473722">nil</span>&nbsp;<span class="op" id="4473726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473731">certMsg</span><span class="op" id="4473738">.</span><span class="ident" id="4473739">certificates</span>&nbsp;<span class="op" id="4473752">=</span>&nbsp;<span class="ident" id="4473754">chainToSend</span><span class="op" id="4473765">.</span><span class="ident" id="4473766">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473784">hs</span><span class="op" id="4473786">.</span><span class="ident" id="4473787">finishedHash</span><span class="op" id="4473799">.</span><span class="ident" id="4473800">Write</span><span class="op" id="4473805">(</span><span class="ident" id="4473806">certMsg</span><span class="op" id="4473813">.</span><span class="ident" id="4473814">marshal</span><span class="op" id="4473821">(</span><span class="op" id="4473822">)</span><span class="op" id="4473823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473827">c</span><span class="op" id="4473828">.</span><span class="ident" id="4473829">writeRecord</span><span class="op" id="4473840">(</span><span class="ident" id="4473841">recordTypeHandshake</span><span class="op" id="4473860">,</span>&nbsp;<span class="ident" id="4473862">certMsg</span><span class="op" id="4473869">.</span><span class="ident" id="4473870">marshal</span><span class="op" id="4473877">(</span><span class="op" id="4473878">)</span><span class="op" id="4473879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4473882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473886">preMasterSecret</span><span class="op" id="4473901">,</span>&nbsp;<span class="ident" id="4473903">ckx</span><span class="op" id="4473906">,</span>&nbsp;<span class="ident" id="4473908">err</span>&nbsp;<span class="op" id="4473912">:=</span>&nbsp;<span class="ident" id="4473915">keyAgreement</span><span class="op" id="4473927">.</span><span class="ident" id="4473928">generateClientKeyExchange</span><span class="op" id="4473953">(</span><span class="ident" id="4473954">c</span><span class="op" id="4473955">.</span><span class="ident" id="4473956">config</span><span class="op" id="4473962">,</span>&nbsp;<span class="ident" id="4473964">hs</span><span class="op" id="4473966">.</span><span class="ident" id="4473967">hello</span><span class="op" id="4473972">,</span>&nbsp;<span class="ident" id="4473974">certs</span><span class="op" id="4473979">[</span><span class="num" id="4473980">0</span><span class="op" id="4473981">]</span><span class="op" id="4473982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473985">if</span>&nbsp;<span class="ident" id="4473988">err</span>&nbsp;<span class="op" id="4473992">!=</span>&nbsp;<span class="ident" id="4473995">nil</span>&nbsp;<span class="op" id="4473999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474003">c</span><span class="op" id="4474004">.</span><span class="ident" id="4474005">sendAlert</span><span class="op" id="4474014">(</span><span class="ident" id="4474015">alertInternalError</span><span class="op" id="4474033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474037">return</span>&nbsp;<span class="ident" id="4474044">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4474049">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474052">if</span>&nbsp;<span class="ident" id="4474055">ckx</span>&nbsp;<span class="op" id="4474059">!=</span>&nbsp;<span class="ident" id="4474062">nil</span>&nbsp;<span class="op" id="4474066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474070">hs</span><span class="op" id="4474072">.</span><span class="ident" id="4474073">finishedHash</span><span class="op" id="4474085">.</span><span class="ident" id="4474086">Write</span><span class="op" id="4474091">(</span><span class="ident" id="4474092">ckx</span><span class="op" id="4474095">.</span><span class="ident" id="4474096">marshal</span><span class="op" id="4474103">(</span><span class="op" id="4474104">)</span><span class="op" id="4474105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474109">c</span><span class="op" id="4474110">.</span><span class="ident" id="4474111">writeRecord</span><span class="op" id="4474122">(</span><span class="ident" id="4474123">recordTypeHandshake</span><span class="op" id="4474142">,</span>&nbsp;<span class="ident" id="4474144">ckx</span><span class="op" id="4474147">.</span><span class="ident" id="4474148">marshal</span><span class="op" id="4474155">(</span><span class="op" id="4474156">)</span><span class="op" id="4474157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4474160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474164">if</span>&nbsp;<span class="ident" id="4474167">chainToSend</span>&nbsp;<span class="op" id="4474179">!=</span>&nbsp;<span class="ident" id="4474182">nil</span>&nbsp;<span class="op" id="4474186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474190">var</span>&nbsp;<span class="ident" id="4474194">signed</span>&nbsp;<span class="op" id="4474201">[</span><span class="op" id="4474202">]</span><span class="builtintype" id="4474203">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474210">certVerify</span>&nbsp;<span class="op" id="4474221">:=</span>&nbsp;<span class="op" id="4474224">&amp;</span><span class="ident" id="4474225">certificateVerifyMsg</span><span class="op" id="4474245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474250">hasSignatureAndHash</span><span class="op" id="4474269">:</span>&nbsp;<span class="ident" id="4474271">c</span><span class="op" id="4474272">.</span><span class="ident" id="4474273">vers</span>&nbsp;<span class="op" id="4474278">&gt;=</span>&nbsp;<span class="ident" id="4474281">VersionTLS12</span><span class="op" id="4474293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4474297">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474302">key</span><span class="op" id="4474305">,</span>&nbsp;<span class="ident" id="4474307">ok</span>&nbsp;<span class="op" id="4474310">:=</span>&nbsp;<span class="ident" id="4474313">chainToSend</span><span class="op" id="4474324">.</span><span class="ident" id="4474325">PrivateKey</span><span class="op" id="4474335">.</span><span class="op" id="4474336">(</span><span class="ident" id="4474337">crypto</span><span class="op" id="4474343">.</span><span class="ident" id="4474344">Signer</span><span class="op" id="4474350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474354">if</span>&nbsp;<span class="op" id="4474357">!</span><span class="ident" id="4474358">ok</span>&nbsp;<span class="op" id="4474361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474366">c</span><span class="op" id="4474367">.</span><span class="ident" id="4474368">sendAlert</span><span class="op" id="4474377">(</span><span class="ident" id="4474378">alertInternalError</span><span class="op" id="4474396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474401">return</span>&nbsp;<span class="ident" id="4474408">fmt</span><span class="op" id="4474411">.</span><span class="ident" id="4474412">Errorf</span><span class="op" id="4474418">(</span><span class="string" id="4474419">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="4474500">,</span>&nbsp;<span class="ident" id="4474502">chainToSend</span><span class="op" id="4474513">.</span><span class="ident" id="4474514">PrivateKey</span><span class="op" id="4474524">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4474528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474532">switch</span>&nbsp;<span class="ident" id="4474539">key</span><span class="op" id="4474542">.</span><span class="ident" id="4474543">Public</span><span class="op" id="4474549">(</span><span class="op" id="4474550">)</span><span class="op" id="4474551">.</span><span class="op" id="4474552">(</span><span class="keyword" id="4474553">type</span><span class="op" id="4474557">)</span>&nbsp;<span class="op" id="4474559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474563">case</span>&nbsp;<span class="op" id="4474568">*</span><span class="ident" id="4474569">ecdsa</span><span class="op" id="4474574">.</span><span class="ident" id="4474575">PublicKey</span><span class="op" id="4474584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474589">digest</span><span class="op" id="4474595">,</span>&nbsp;<span class="ident" id="4474597">hashFunc</span><span class="op" id="4474605">,</span>&nbsp;<span class="ident" id="4474607">hashId</span>&nbsp;<span class="op" id="4474614">:=</span>&nbsp;<span class="ident" id="4474617">hs</span><span class="op" id="4474619">.</span><span class="ident" id="4474620">finishedHash</span><span class="op" id="4474632">.</span><span class="ident" id="4474633">hashForClientCertificate</span><span class="op" id="4474657">(</span><span class="ident" id="4474658">signatureECDSA</span><span class="op" id="4474672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474677">signed</span><span class="op" id="4474683">,</span>&nbsp;<span class="ident" id="4474685">err</span>&nbsp;<span class="op" id="4474689">=</span>&nbsp;<span class="ident" id="4474691">key</span><span class="op" id="4474694">.</span><span class="ident" id="4474695">Sign</span><span class="op" id="4474699">(</span><span class="ident" id="4474700">c</span><span class="op" id="4474701">.</span><span class="ident" id="4474702">config</span><span class="op" id="4474708">.</span><span class="ident" id="4474709">rand</span><span class="op" id="4474713">(</span><span class="op" id="4474714">)</span><span class="op" id="4474715">,</span>&nbsp;<span class="ident" id="4474717">digest</span><span class="op" id="4474723">,</span>&nbsp;<span class="ident" id="4474725">hashFunc</span><span class="op" id="4474733">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474738">certVerify</span><span class="op" id="4474748">.</span><span class="ident" id="4474749">signatureAndHash</span><span class="op" id="4474765">.</span><span class="ident" id="4474766">signature</span>&nbsp;<span class="op" id="4474776">=</span>&nbsp;<span class="ident" id="4474778">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474796">certVerify</span><span class="op" id="4474806">.</span><span class="ident" id="4474807">signatureAndHash</span><span class="op" id="4474823">.</span><span class="ident" id="4474824">hash</span>&nbsp;<span class="op" id="4474829">=</span>&nbsp;<span class="ident" id="4474831">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474840">case</span>&nbsp;<span class="op" id="4474845">*</span><span class="ident" id="4474846">rsa</span><span class="op" id="4474849">.</span><span class="ident" id="4474850">PublicKey</span><span class="op" id="4474859">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474864">digest</span><span class="op" id="4474870">,</span>&nbsp;<span class="ident" id="4474872">hashFunc</span><span class="op" id="4474880">,</span>&nbsp;<span class="ident" id="4474882">hashId</span>&nbsp;<span class="op" id="4474889">:=</span>&nbsp;<span class="ident" id="4474892">hs</span><span class="op" id="4474894">.</span><span class="ident" id="4474895">finishedHash</span><span class="op" id="4474907">.</span><span class="ident" id="4474908">hashForClientCertificate</span><span class="op" id="4474932">(</span><span class="ident" id="4474933">signatureRSA</span><span class="op" id="4474945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474950">signed</span><span class="op" id="4474956">,</span>&nbsp;<span class="ident" id="4474958">err</span>&nbsp;<span class="op" id="4474962">=</span>&nbsp;<span class="ident" id="4474964">key</span><span class="op" id="4474967">.</span><span class="ident" id="4474968">Sign</span><span class="op" id="4474972">(</span><span class="ident" id="4474973">c</span><span class="op" id="4474974">.</span><span class="ident" id="4474975">config</span><span class="op" id="4474981">.</span><span class="ident" id="4474982">rand</span><span class="op" id="4474986">(</span><span class="op" id="4474987">)</span><span class="op" id="4474988">,</span>&nbsp;<span class="ident" id="4474990">digest</span><span class="op" id="4474996">,</span>&nbsp;<span class="ident" id="4474998">hashFunc</span><span class="op" id="4475006">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475011">certVerify</span><span class="op" id="4475021">.</span><span class="ident" id="4475022">signatureAndHash</span><span class="op" id="4475038">.</span><span class="ident" id="4475039">signature</span>&nbsp;<span class="op" id="4475049">=</span>&nbsp;<span class="ident" id="4475051">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475067">certVerify</span><span class="op" id="4475077">.</span><span class="ident" id="4475078">signatureAndHash</span><span class="op" id="4475094">.</span><span class="ident" id="4475095">hash</span>&nbsp;<span class="op" id="4475100">=</span>&nbsp;<span class="ident" id="4475102">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475111">default</span><span class="op" id="4475118">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475123">err</span>&nbsp;<span class="op" id="4475127">=</span>&nbsp;<span class="ident" id="4475129">fmt</span><span class="op" id="4475132">.</span><span class="ident" id="4475133">Errorf</span><span class="op" id="4475139">(</span><span class="string" id="4475140">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="4475186">,</span>&nbsp;<span class="ident" id="4475188">key</span><span class="op" id="4475191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4475195">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475199">if</span>&nbsp;<span class="ident" id="4475202">err</span>&nbsp;<span class="op" id="4475206">!=</span>&nbsp;<span class="ident" id="4475209">nil</span>&nbsp;<span class="op" id="4475213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475218">c</span><span class="op" id="4475219">.</span><span class="ident" id="4475220">sendAlert</span><span class="op" id="4475229">(</span><span class="ident" id="4475230">alertInternalError</span><span class="op" id="4475248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475253">return</span>&nbsp;<span class="ident" id="4475260">errors</span><span class="op" id="4475266">.</span><span class="ident" id="4475267">New</span><span class="op" id="4475270">(</span><span class="string" id="4475271">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4475329">+</span>&nbsp;<span class="ident" id="4475331">err</span><span class="op" id="4475334">.</span><span class="ident" id="4475335">Error</span><span class="op" id="4475340">(</span><span class="op" id="4475341">)</span><span class="op" id="4475342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4475346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475350">certVerify</span><span class="op" id="4475360">.</span><span class="ident" id="4475361">signature</span>&nbsp;<span class="op" id="4475371">=</span>&nbsp;<span class="ident" id="4475373">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475383">hs</span><span class="op" id="4475385">.</span><span class="ident" id="4475386">finishedHash</span><span class="op" id="4475398">.</span><span class="ident" id="4475399">Write</span><span class="op" id="4475404">(</span><span class="ident" id="4475405">certVerify</span><span class="op" id="4475415">.</span><span class="ident" id="4475416">marshal</span><span class="op" id="4475423">(</span><span class="op" id="4475424">)</span><span class="op" id="4475425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475429">c</span><span class="op" id="4475430">.</span><span class="ident" id="4475431">writeRecord</span><span class="op" id="4475442">(</span><span class="ident" id="4475443">recordTypeHandshake</span><span class="op" id="4475462">,</span>&nbsp;<span class="ident" id="4475464">certVerify</span><span class="op" id="4475474">.</span><span class="ident" id="4475475">marshal</span><span class="op" id="4475482">(</span><span class="op" id="4475483">)</span><span class="op" id="4475484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4475487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475491">hs</span><span class="op" id="4475493">.</span><span class="ident" id="4475494">masterSecret</span>&nbsp;<span class="op" id="4475507">=</span>&nbsp;<span class="ident" id="4475509">masterFromPreMasterSecret</span><span class="op" id="4475534">(</span><span class="ident" id="4475535">c</span><span class="op" id="4475536">.</span><span class="ident" id="4475537">vers</span><span class="op" id="4475541">,</span>&nbsp;<span class="ident" id="4475543">preMasterSecret</span><span class="op" id="4475558">,</span>&nbsp;<span class="ident" id="4475560">hs</span><span class="op" id="4475562">.</span><span class="ident" id="4475563">hello</span><span class="op" id="4475568">.</span><span class="ident" id="4475569">random</span><span class="op" id="4475575">,</span>&nbsp;<span class="ident" id="4475577">hs</span><span class="op" id="4475579">.</span><span class="ident" id="4475580">serverHello</span><span class="op" id="4475591">.</span><span class="ident" id="4475592">random</span><span class="op" id="4475598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475601">return</span>&nbsp;<span class="ident" id="4475608">nil</span><br>
<span class="lineno"></span><span class="op" id="4475612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4475615">func</span>&nbsp;<span class="op" id="4475620">(</span><span class="ident" id="4475621">hs</span>&nbsp;<span class="op" id="4475624">*</span><span class="ident" id="4475625">clientHandshakeState</span><span class="op" id="4475645">)</span>&nbsp;<span class="ident" id="4475647">establishKeys</span><span class="op" id="4475660">(</span><span class="op" id="4475661">)</span>&nbsp;<span class="builtintype" id="4475663">error</span>&nbsp;<span class="op" id="4475669">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475672">c</span>&nbsp;<span class="op" id="4475674">:=</span>&nbsp;<span class="ident" id="4475677">hs</span><span class="op" id="4475679">.</span><span class="ident" id="4475680">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475684">clientMAC</span><span class="op" id="4475693">,</span>&nbsp;<span class="ident" id="4475695">serverMAC</span><span class="op" id="4475704">,</span>&nbsp;<span class="ident" id="4475706">clientKey</span><span class="op" id="4475715">,</span>&nbsp;<span class="ident" id="4475717">serverKey</span><span class="op" id="4475726">,</span>&nbsp;<span class="ident" id="4475728">clientIV</span><span class="op" id="4475736">,</span>&nbsp;<span class="ident" id="4475738">serverIV</span>&nbsp;<span class="op" id="4475747">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475752">keysFromMasterSecret</span><span class="op" id="4475772">(</span><span class="ident" id="4475773">c</span><span class="op" id="4475774">.</span><span class="ident" id="4475775">vers</span><span class="op" id="4475779">,</span>&nbsp;<span class="ident" id="4475781">hs</span><span class="op" id="4475783">.</span><span class="ident" id="4475784">masterSecret</span><span class="op" id="4475796">,</span>&nbsp;<span class="ident" id="4475798">hs</span><span class="op" id="4475800">.</span><span class="ident" id="4475801">hello</span><span class="op" id="4475806">.</span><span class="ident" id="4475807">random</span><span class="op" id="4475813">,</span>&nbsp;<span class="ident" id="4475815">hs</span><span class="op" id="4475817">.</span><span class="ident" id="4475818">serverHello</span><span class="op" id="4475829">.</span><span class="ident" id="4475830">random</span><span class="op" id="4475836">,</span>&nbsp;<span class="ident" id="4475838">hs</span><span class="op" id="4475840">.</span><span class="ident" id="4475841">suite</span><span class="op" id="4475846">.</span><span class="ident" id="4475847">macLen</span><span class="op" id="4475853">,</span>&nbsp;<span class="ident" id="4475855">hs</span><span class="op" id="4475857">.</span><span class="ident" id="4475858">suite</span><span class="op" id="4475863">.</span><span class="ident" id="4475864">keyLen</span><span class="op" id="4475870">,</span>&nbsp;<span class="ident" id="4475872">hs</span><span class="op" id="4475874">.</span><span class="ident" id="4475875">suite</span><span class="op" id="4475880">.</span><span class="ident" id="4475881">ivLen</span><span class="op" id="4475886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475889">var</span>&nbsp;<span class="ident" id="4475893">clientCipher</span><span class="op" id="4475905">,</span>&nbsp;<span class="ident" id="4475907">serverCipher</span>&nbsp;<span class="keyword" id="4475920">interface</span><span class="op" id="4475929">{</span><span class="op" id="4475930">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475933">var</span>&nbsp;<span class="ident" id="4475937">clientHash</span><span class="op" id="4475947">,</span>&nbsp;<span class="ident" id="4475949">serverHash</span>&nbsp;<span class="ident" id="4475960">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475973">if</span>&nbsp;<span class="ident" id="4475976">hs</span><span class="op" id="4475978">.</span><span class="ident" id="4475979">suite</span><span class="op" id="4475984">.</span><span class="ident" id="4475985">cipher</span>&nbsp;<span class="op" id="4475992">!=</span>&nbsp;<span class="ident" id="4475995">nil</span>&nbsp;<span class="op" id="4475999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476003">clientCipher</span>&nbsp;<span class="op" id="4476016">=</span>&nbsp;<span class="ident" id="4476018">hs</span><span class="op" id="4476020">.</span><span class="ident" id="4476021">suite</span><span class="op" id="4476026">.</span><span class="ident" id="4476027">cipher</span><span class="op" id="4476033">(</span><span class="ident" id="4476034">clientKey</span><span class="op" id="4476043">,</span>&nbsp;<span class="ident" id="4476045">clientIV</span><span class="op" id="4476053">,</span>&nbsp;<span class="builtintype" id="4476055">false</span>&nbsp;<span class="comment" id="4476061">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4476082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476086">clientHash</span>&nbsp;<span class="op" id="4476097">=</span>&nbsp;<span class="ident" id="4476099">hs</span><span class="op" id="4476101">.</span><span class="ident" id="4476102">suite</span><span class="op" id="4476107">.</span><span class="ident" id="4476108">mac</span><span class="op" id="4476111">(</span><span class="ident" id="4476112">c</span><span class="op" id="4476113">.</span><span class="ident" id="4476114">vers</span><span class="op" id="4476118">,</span>&nbsp;<span class="ident" id="4476120">clientMAC</span><span class="op" id="4476129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476133">serverCipher</span>&nbsp;<span class="op" id="4476146">=</span>&nbsp;<span class="ident" id="4476148">hs</span><span class="op" id="4476150">.</span><span class="ident" id="4476151">suite</span><span class="op" id="4476156">.</span><span class="ident" id="4476157">cipher</span><span class="op" id="4476163">(</span><span class="ident" id="4476164">serverKey</span><span class="op" id="4476173">,</span>&nbsp;<span class="ident" id="4476175">serverIV</span><span class="op" id="4476183">,</span>&nbsp;<span class="builtintype" id="4476185">true</span>&nbsp;<span class="comment" id="4476190">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4476207">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476211">serverHash</span>&nbsp;<span class="op" id="4476222">=</span>&nbsp;<span class="ident" id="4476224">hs</span><span class="op" id="4476226">.</span><span class="ident" id="4476227">suite</span><span class="op" id="4476232">.</span><span class="ident" id="4476233">mac</span><span class="op" id="4476236">(</span><span class="ident" id="4476237">c</span><span class="op" id="4476238">.</span><span class="ident" id="4476239">vers</span><span class="op" id="4476243">,</span>&nbsp;<span class="ident" id="4476245">serverMAC</span><span class="op" id="4476254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4476257">}</span>&nbsp;<span class="keyword" id="4476259">else</span>&nbsp;<span class="op" id="4476264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476268">clientCipher</span>&nbsp;<span class="op" id="4476281">=</span>&nbsp;<span class="ident" id="4476283">hs</span><span class="op" id="4476285">.</span><span class="ident" id="4476286">suite</span><span class="op" id="4476291">.</span><span class="ident" id="4476292">aead</span><span class="op" id="4476296">(</span><span class="ident" id="4476297">clientKey</span><span class="op" id="4476306">,</span>&nbsp;<span class="ident" id="4476308">clientIV</span><span class="op" id="4476316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476320">serverCipher</span>&nbsp;<span class="op" id="4476333">=</span>&nbsp;<span class="ident" id="4476335">hs</span><span class="op" id="4476337">.</span><span class="ident" id="4476338">suite</span><span class="op" id="4476343">.</span><span class="ident" id="4476344">aead</span><span class="op" id="4476348">(</span><span class="ident" id="4476349">serverKey</span><span class="op" id="4476358">,</span>&nbsp;<span class="ident" id="4476360">serverIV</span><span class="op" id="4476368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4476371">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476375">c</span><span class="op" id="4476376">.</span><span class="ident" id="4476377">in</span><span class="op" id="4476379">.</span><span class="ident" id="4476380">prepareCipherSpec</span><span class="op" id="4476397">(</span><span class="ident" id="4476398">c</span><span class="op" id="4476399">.</span><span class="ident" id="4476400">vers</span><span class="op" id="4476404">,</span>&nbsp;<span class="ident" id="4476406">serverCipher</span><span class="op" id="4476418">,</span>&nbsp;<span class="ident" id="4476420">serverHash</span><span class="op" id="4476430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476433">c</span><span class="op" id="4476434">.</span><span class="ident" id="4476435">out</span><span class="op" id="4476438">.</span><span class="ident" id="4476439">prepareCipherSpec</span><span class="op" id="4476456">(</span><span class="ident" id="4476457">c</span><span class="op" id="4476458">.</span><span class="ident" id="4476459">vers</span><span class="op" id="4476463">,</span>&nbsp;<span class="ident" id="4476465">clientCipher</span><span class="op" id="4476477">,</span>&nbsp;<span class="ident" id="4476479">clientHash</span><span class="op" id="4476489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476492">return</span>&nbsp;<span class="ident" id="4476499">nil</span><br>
<span class="lineno"></span><span class="op" id="4476503">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="4476506">func</span>&nbsp;<span class="op" id="4476511">(</span><span class="ident" id="4476512">hs</span>&nbsp;<span class="op" id="4476515">*</span><span class="ident" id="4476516">clientHandshakeState</span><span class="op" id="4476536">)</span>&nbsp;<span class="ident" id="4476538">serverResumedSession</span><span class="op" id="4476558">(</span><span class="op" id="4476559">)</span>&nbsp;<span class="builtintype" id="4476561">bool</span>&nbsp;<span class="op" id="4476566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4476569">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4476639">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476696">return</span>&nbsp;<span class="ident" id="4476703">hs</span><span class="op" id="4476705">.</span><span class="ident" id="4476706">session</span>&nbsp;<span class="op" id="4476714">!=</span>&nbsp;<span class="ident" id="4476717">nil</span>&nbsp;<span class="op" id="4476721">&amp;&amp;</span>&nbsp;<span class="ident" id="4476724">hs</span><span class="op" id="4476726">.</span><span class="ident" id="4476727">hello</span><span class="op" id="4476732">.</span><span class="ident" id="4476733">sessionId</span>&nbsp;<span class="op" id="4476743">!=</span>&nbsp;<span class="ident" id="4476746">nil</span>&nbsp;<span class="op" id="4476750">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476755">bytes</span><span class="op" id="4476760">.</span><span class="ident" id="4476761">Equal</span><span class="op" id="4476766">(</span><span class="ident" id="4476767">hs</span><span class="op" id="4476769">.</span><span class="ident" id="4476770">serverHello</span><span class="op" id="4476781">.</span><span class="ident" id="4476782">sessionId</span><span class="op" id="4476791">,</span>&nbsp;<span class="ident" id="4476793">hs</span><span class="op" id="4476795">.</span><span class="ident" id="4476796">hello</span><span class="op" id="4476801">.</span><span class="ident" id="4476802">sessionId</span><span class="op" id="4476811">)</span><br>
<span class="lineno"></span><span class="op" id="4476813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4476816">func</span>&nbsp;<span class="op" id="4476821">(</span><span class="ident" id="4476822">hs</span>&nbsp;<span class="op" id="4476825">*</span><span class="ident" id="4476826">clientHandshakeState</span><span class="op" id="4476846">)</span>&nbsp;<span class="ident" id="4476848">processServerHello</span><span class="op" id="4476866">(</span><span class="op" id="4476867">)</span>&nbsp;<span class="op" id="4476869">(</span><span class="builtintype" id="4476870">bool</span><span class="op" id="4476874">,</span>&nbsp;<span class="builtintype" id="4476876">error</span><span class="op" id="4476881">)</span>&nbsp;<span class="op" id="4476883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476886">c</span>&nbsp;<span class="op" id="4476888">:=</span>&nbsp;<span class="ident" id="4476891">hs</span><span class="op" id="4476893">.</span><span class="ident" id="4476894">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476898">if</span>&nbsp;<span class="ident" id="4476901">hs</span><span class="op" id="4476903">.</span><span class="ident" id="4476904">serverHello</span><span class="op" id="4476915">.</span><span class="ident" id="4476916">compressionMethod</span>&nbsp;<span class="op" id="4476934">!=</span>&nbsp;<span class="ident" id="4476937">compressionNone</span>&nbsp;<span class="op" id="4476953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476957">c</span><span class="op" id="4476958">.</span><span class="ident" id="4476959">sendAlert</span><span class="op" id="4476968">(</span><span class="ident" id="4476969">alertUnexpectedMessage</span><span class="op" id="4476991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476995">return</span>&nbsp;<span class="builtintype" id="4477002">false</span><span class="op" id="4477007">,</span>&nbsp;<span class="ident" id="4477009">errors</span><span class="op" id="4477015">.</span><span class="ident" id="4477016">New</span><span class="op" id="4477019">(</span><span class="string" id="4477020">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="4477073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477076">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477080">clientDidNPN</span>&nbsp;<span class="op" id="4477093">:=</span>&nbsp;<span class="ident" id="4477096">hs</span><span class="op" id="4477098">.</span><span class="ident" id="4477099">hello</span><span class="op" id="4477104">.</span><span class="ident" id="4477105">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477119">clientDidALPN</span>&nbsp;<span class="op" id="4477133">:=</span>&nbsp;<span class="builtinfunc" id="4477136">len</span><span class="op" id="4477139">(</span><span class="ident" id="4477140">hs</span><span class="op" id="4477142">.</span><span class="ident" id="4477143">hello</span><span class="op" id="4477148">.</span><span class="ident" id="4477149">alpnProtocols</span><span class="op" id="4477162">)</span>&nbsp;<span class="op" id="4477164">&gt;</span>&nbsp;<span class="num" id="4477166">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477169">serverHasNPN</span>&nbsp;<span class="op" id="4477182">:=</span>&nbsp;<span class="ident" id="4477185">hs</span><span class="op" id="4477187">.</span><span class="ident" id="4477188">serverHello</span><span class="op" id="4477199">.</span><span class="ident" id="4477200">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477214">serverHasALPN</span>&nbsp;<span class="op" id="4477228">:=</span>&nbsp;<span class="builtinfunc" id="4477231">len</span><span class="op" id="4477234">(</span><span class="ident" id="4477235">hs</span><span class="op" id="4477237">.</span><span class="ident" id="4477238">serverHello</span><span class="op" id="4477249">.</span><span class="ident" id="4477250">alpnProtocol</span><span class="op" id="4477262">)</span>&nbsp;<span class="op" id="4477264">&gt;</span>&nbsp;<span class="num" id="4477266">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477270">if</span>&nbsp;<span class="op" id="4477273">!</span><span class="ident" id="4477274">clientDidNPN</span>&nbsp;<span class="op" id="4477287">&amp;&amp;</span>&nbsp;<span class="ident" id="4477290">serverHasNPN</span>&nbsp;<span class="op" id="4477303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477307">c</span><span class="op" id="4477308">.</span><span class="ident" id="4477309">sendAlert</span><span class="op" id="4477318">(</span><span class="ident" id="4477319">alertHandshakeFailure</span><span class="op" id="4477340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477344">return</span>&nbsp;<span class="builtintype" id="4477351">false</span><span class="op" id="4477356">,</span>&nbsp;<span class="ident" id="4477358">errors</span><span class="op" id="4477364">.</span><span class="ident" id="4477365">New</span><span class="op" id="4477368">(</span><span class="string" id="4477369">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="4477414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477417">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477421">if</span>&nbsp;<span class="op" id="4477424">!</span><span class="ident" id="4477425">clientDidALPN</span>&nbsp;<span class="op" id="4477439">&amp;&amp;</span>&nbsp;<span class="ident" id="4477442">serverHasALPN</span>&nbsp;<span class="op" id="4477456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477460">c</span><span class="op" id="4477461">.</span><span class="ident" id="4477462">sendAlert</span><span class="op" id="4477471">(</span><span class="ident" id="4477472">alertHandshakeFailure</span><span class="op" id="4477493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477497">return</span>&nbsp;<span class="builtintype" id="4477504">false</span><span class="op" id="4477509">,</span>&nbsp;<span class="ident" id="4477511">errors</span><span class="op" id="4477517">.</span><span class="ident" id="4477518">New</span><span class="op" id="4477521">(</span><span class="string" id="4477522">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="4477568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477571">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477575">if</span>&nbsp;<span class="ident" id="4477578">serverHasNPN</span>&nbsp;<span class="op" id="4477591">&amp;&amp;</span>&nbsp;<span class="ident" id="4477594">serverHasALPN</span>&nbsp;<span class="op" id="4477608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477612">c</span><span class="op" id="4477613">.</span><span class="ident" id="4477614">sendAlert</span><span class="op" id="4477623">(</span><span class="ident" id="4477624">alertHandshakeFailure</span><span class="op" id="4477645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477649">return</span>&nbsp;<span class="builtintype" id="4477656">false</span><span class="op" id="4477661">,</span>&nbsp;<span class="ident" id="4477663">errors</span><span class="op" id="4477669">.</span><span class="ident" id="4477670">New</span><span class="op" id="4477673">(</span><span class="string" id="4477674">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="4477722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477725">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477729">if</span>&nbsp;<span class="ident" id="4477732">serverHasALPN</span>&nbsp;<span class="op" id="4477746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477750">c</span><span class="op" id="4477751">.</span><span class="ident" id="4477752">clientProtocol</span>&nbsp;<span class="op" id="4477767">=</span>&nbsp;<span class="ident" id="4477769">hs</span><span class="op" id="4477771">.</span><span class="ident" id="4477772">serverHello</span><span class="op" id="4477783">.</span><span class="ident" id="4477784">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477799">c</span><span class="op" id="4477800">.</span><span class="ident" id="4477801">clientProtocolFallback</span>&nbsp;<span class="op" id="4477824">=</span>&nbsp;<span class="builtintype" id="4477826">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477833">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477837">if</span>&nbsp;<span class="ident" id="4477840">hs</span><span class="op" id="4477842">.</span><span class="ident" id="4477843">serverResumedSession</span><span class="op" id="4477863">(</span><span class="op" id="4477864">)</span>&nbsp;<span class="op" id="4477866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4477870">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477930">hs</span><span class="op" id="4477932">.</span><span class="ident" id="4477933">masterSecret</span>&nbsp;<span class="op" id="4477946">=</span>&nbsp;<span class="ident" id="4477948">hs</span><span class="op" id="4477950">.</span><span class="ident" id="4477951">session</span><span class="op" id="4477958">.</span><span class="ident" id="4477959">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477974">c</span><span class="op" id="4477975">.</span><span class="ident" id="4477976">peerCertificates</span>&nbsp;<span class="op" id="4477993">=</span>&nbsp;<span class="ident" id="4477995">hs</span><span class="op" id="4477997">.</span><span class="ident" id="4477998">session</span><span class="op" id="4478005">.</span><span class="ident" id="4478006">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478027">return</span>&nbsp;<span class="builtintype" id="4478034">true</span><span class="op" id="4478038">,</span>&nbsp;<span class="ident" id="4478040">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478048">return</span>&nbsp;<span class="builtintype" id="4478055">false</span><span class="op" id="4478060">,</span>&nbsp;<span class="ident" id="4478062">nil</span><br>
<span class="lineno"></span><span class="op" id="4478066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="4478069">func</span>&nbsp;<span class="op" id="4478074">(</span><span class="ident" id="4478075">hs</span>&nbsp;<span class="op" id="4478078">*</span><span class="ident" id="4478079">clientHandshakeState</span><span class="op" id="4478099">)</span>&nbsp;<span class="ident" id="4478101">readFinished</span><span class="op" id="4478113">(</span><span class="ident" id="4478114">out</span>&nbsp;<span class="op" id="4478118">[</span><span class="op" id="4478119">]</span><span class="builtintype" id="4478120">byte</span><span class="op" id="4478124">)</span>&nbsp;<span class="builtintype" id="4478126">error</span>&nbsp;<span class="op" id="4478132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478135">c</span>&nbsp;<span class="op" id="4478137">:=</span>&nbsp;<span class="ident" id="4478140">hs</span><span class="op" id="4478142">.</span><span class="ident" id="4478143">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478147">c</span><span class="op" id="4478148">.</span><span class="ident" id="4478149">readRecord</span><span class="op" id="4478159">(</span><span class="ident" id="4478160">recordTypeChangeCipherSpec</span><span class="op" id="4478186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478189">if</span>&nbsp;<span class="ident" id="4478192">err</span>&nbsp;<span class="op" id="4478196">:=</span>&nbsp;<span class="ident" id="4478199">c</span><span class="op" id="4478200">.</span><span class="ident" id="4478201">in</span><span class="op" id="4478203">.</span><span class="builtintype" id="4478204">error</span><span class="op" id="4478209">(</span><span class="op" id="4478210">)</span><span class="op" id="4478211">;</span>&nbsp;<span class="ident" id="4478213">err</span>&nbsp;<span class="op" id="4478217">!=</span>&nbsp;<span class="ident" id="4478220">nil</span>&nbsp;<span class="op" id="4478224">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478228">return</span>&nbsp;<span class="ident" id="4478235">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478244">msg</span><span class="op" id="4478247">,</span>&nbsp;<span class="ident" id="4478249">err</span>&nbsp;<span class="op" id="4478253">:=</span>&nbsp;<span class="ident" id="4478256">c</span><span class="op" id="4478257">.</span><span class="ident" id="4478258">readHandshake</span><span class="op" id="4478271">(</span><span class="op" id="4478272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478275">if</span>&nbsp;<span class="ident" id="4478278">err</span>&nbsp;<span class="op" id="4478282">!=</span>&nbsp;<span class="ident" id="4478285">nil</span>&nbsp;<span class="op" id="4478289">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478293">return</span>&nbsp;<span class="ident" id="4478300">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478308">serverFinished</span><span class="op" id="4478322">,</span>&nbsp;<span class="ident" id="4478324">ok</span>&nbsp;<span class="op" id="4478327">:=</span>&nbsp;<span class="ident" id="4478330">msg</span><span class="op" id="4478333">.</span><span class="op" id="4478334">(</span><span class="op" id="4478335">*</span><span class="ident" id="4478336">finishedMsg</span><span class="op" id="4478347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478350">if</span>&nbsp;<span class="op" id="4478353">!</span><span class="ident" id="4478354">ok</span>&nbsp;<span class="op" id="4478357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478361">c</span><span class="op" id="4478362">.</span><span class="ident" id="4478363">sendAlert</span><span class="op" id="4478372">(</span><span class="ident" id="4478373">alertUnexpectedMessage</span><span class="op" id="4478395">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478399">return</span>&nbsp;<span class="ident" id="4478406">unexpectedMessageError</span><span class="op" id="4478428">(</span><span class="ident" id="4478429">serverFinished</span><span class="op" id="4478443">,</span>&nbsp;<span class="ident" id="4478445">msg</span><span class="op" id="4478448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478455">verify</span>&nbsp;<span class="op" id="4478462">:=</span>&nbsp;<span class="ident" id="4478465">hs</span><span class="op" id="4478467">.</span><span class="ident" id="4478468">finishedHash</span><span class="op" id="4478480">.</span><span class="ident" id="4478481">serverSum</span><span class="op" id="4478490">(</span><span class="ident" id="4478491">hs</span><span class="op" id="4478493">.</span><span class="ident" id="4478494">masterSecret</span><span class="op" id="4478506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478509">if</span>&nbsp;<span class="builtinfunc" id="4478512">len</span><span class="op" id="4478515">(</span><span class="ident" id="4478516">verify</span><span class="op" id="4478522">)</span>&nbsp;<span class="op" id="4478524">!=</span>&nbsp;<span class="builtinfunc" id="4478527">len</span><span class="op" id="4478530">(</span><span class="ident" id="4478531">serverFinished</span><span class="op" id="4478545">.</span><span class="ident" id="4478546">verifyData</span><span class="op" id="4478556">)</span>&nbsp;<span class="op" id="4478558">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478563">subtle</span><span class="op" id="4478569">.</span><span class="ident" id="4478570">ConstantTimeCompare</span><span class="op" id="4478589">(</span><span class="ident" id="4478590">verify</span><span class="op" id="4478596">,</span>&nbsp;<span class="ident" id="4478598">serverFinished</span><span class="op" id="4478612">.</span><span class="ident" id="4478613">verifyData</span><span class="op" id="4478623">)</span>&nbsp;<span class="op" id="4478625">!=</span>&nbsp;<span class="num" id="4478628">1</span>&nbsp;<span class="op" id="4478630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478634">c</span><span class="op" id="4478635">.</span><span class="ident" id="4478636">sendAlert</span><span class="op" id="4478645">(</span><span class="ident" id="4478646">alertHandshakeFailure</span><span class="op" id="4478667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478671">return</span>&nbsp;<span class="ident" id="4478678">errors</span><span class="op" id="4478684">.</span><span class="ident" id="4478685">New</span><span class="op" id="4478688">(</span><span class="string" id="4478689">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="4478735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478741">hs</span><span class="op" id="4478743">.</span><span class="ident" id="4478744">finishedHash</span><span class="op" id="4478756">.</span><span class="ident" id="4478757">Write</span><span class="op" id="4478762">(</span><span class="ident" id="4478763">serverFinished</span><span class="op" id="4478777">.</span><span class="ident" id="4478778">marshal</span><span class="op" id="4478785">(</span><span class="op" id="4478786">)</span><span class="op" id="4478787">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4478790">copy</span><span class="op" id="4478794">(</span><span class="ident" id="4478795">out</span><span class="op" id="4478798">,</span>&nbsp;<span class="ident" id="4478800">verify</span><span class="op" id="4478806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478809">return</span>&nbsp;<span class="ident" id="4478816">nil</span><br>
<span class="lineno"></span><span class="op" id="4478820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4478823">func</span>&nbsp;<span class="op" id="4478828">(</span><span class="ident" id="4478829">hs</span>&nbsp;<span class="op" id="4478832">*</span><span class="ident" id="4478833">clientHandshakeState</span><span class="op" id="4478853">)</span>&nbsp;<span class="ident" id="4478855">readSessionTicket</span><span class="op" id="4478872">(</span><span class="op" id="4478873">)</span>&nbsp;<span class="builtintype" id="4478875">error</span>&nbsp;<span class="op" id="4478881">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478884">if</span>&nbsp;<span class="op" id="4478887">!</span><span class="ident" id="4478888">hs</span><span class="op" id="4478890">.</span><span class="ident" id="4478891">serverHello</span><span class="op" id="4478902">.</span><span class="ident" id="4478903">ticketSupported</span>&nbsp;<span class="op" id="4478919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478923">return</span>&nbsp;<span class="ident" id="4478930">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478939">c</span>&nbsp;<span class="op" id="4478941">:=</span>&nbsp;<span class="ident" id="4478944">hs</span><span class="op" id="4478946">.</span><span class="ident" id="4478947">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478950">msg</span><span class="op" id="4478953">,</span>&nbsp;<span class="ident" id="4478955">err</span>&nbsp;<span class="op" id="4478959">:=</span>&nbsp;<span class="ident" id="4478962">c</span><span class="op" id="4478963">.</span><span class="ident" id="4478964">readHandshake</span><span class="op" id="4478977">(</span><span class="op" id="4478978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478981">if</span>&nbsp;<span class="ident" id="4478984">err</span>&nbsp;<span class="op" id="4478988">!=</span>&nbsp;<span class="ident" id="4478991">nil</span>&nbsp;<span class="op" id="4478995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478999">return</span>&nbsp;<span class="ident" id="4479006">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4479011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479014">sessionTicketMsg</span><span class="op" id="4479030">,</span>&nbsp;<span class="ident" id="4479032">ok</span>&nbsp;<span class="op" id="4479035">:=</span>&nbsp;<span class="ident" id="4479038">msg</span><span class="op" id="4479041">.</span><span class="op" id="4479042">(</span><span class="op" id="4479043">*</span><span class="ident" id="4479044">newSessionTicketMsg</span><span class="op" id="4479063">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4479066">if</span>&nbsp;<span class="op" id="4479069">!</span><span class="ident" id="4479070">ok</span>&nbsp;<span class="op" id="4479073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479077">c</span><span class="op" id="4479078">.</span><span class="ident" id="4479079">sendAlert</span><span class="op" id="4479088">(</span><span class="ident" id="4479089">alertUnexpectedMessage</span><span class="op" id="4479111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4479115">return</span>&nbsp;<span class="ident" id="4479122">unexpectedMessageError</span><span class="op" id="4479144">(</span><span class="ident" id="4479145">sessionTicketMsg</span><span class="op" id="4479161">,</span>&nbsp;<span class="ident" id="4479163">msg</span><span class="op" id="4479166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4479169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479172">hs</span><span class="op" id="4479174">.</span><span class="ident" id="4479175">finishedHash</span><span class="op" id="4479187">.</span><span class="ident" id="4479188">Write</span><span class="op" id="4479193">(</span><span class="ident" id="4479194">sessionTicketMsg</span><span class="op" id="4479210">.</span><span class="ident" id="4479211">marshal</span><span class="op" id="4479218">(</span><span class="op" id="4479219">)</span><span class="op" id="4479220">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479224">hs</span><span class="op" id="4479226">.</span><span class="ident" id="4479227">session</span>&nbsp;<span class="op" id="4479235">=</span>&nbsp;<span class="op" id="4479237">&amp;</span><span class="ident" id="4479238">ClientSessionState</span><span class="op" id="4479256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479260">sessionTicket</span><span class="op" id="4479273">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479280">sessionTicketMsg</span><span class="op" id="4479296">.</span><span class="ident" id="4479297">ticket</span><span class="op" id="4479303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479307">vers</span><span class="op" id="4479311">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479327">c</span><span class="op" id="4479328">.</span><span class="ident" id="4479329">vers</span><span class="op" id="4479333">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479337">cipherSuite</span><span class="op" id="4479348">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479357">hs</span><span class="op" id="4479359">.</span><span class="ident" id="4479360">suite</span><span class="op" id="4479365">.</span><span class="ident" id="4479366">id</span><span class="op" id="4479368">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479372">masterSecret</span><span class="op" id="4479384">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479392">hs</span><span class="op" id="4479394">.</span><span class="ident" id="4479395">masterSecret</span><span class="op" id="4479407">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479411">serverCertificates</span><span class="op" id="4479429">:</span>&nbsp;<span class="ident" id="4479431">c</span><span class="op" id="4479432">.</span><span class="ident" id="4479433">peerCertificates</span><span class="op" id="4479449">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4479452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4479456">return</span>&nbsp;<span class="ident" id="4479463">nil</span><br>
<span class="lineno">590</span><span class="op" id="4479467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4479470">func</span>&nbsp;<span class="op" id="4479475">(</span><span class="ident" id="4479476">hs</span>&nbsp;<span class="op" id="4479479">*</span><span class="ident" id="4479480">clientHandshakeState</span><span class="op" id="4479500">)</span>&nbsp;<span class="ident" id="4479502">sendFinished</span><span class="op" id="4479514">(</span><span class="ident" id="4479515">out</span>&nbsp;<span class="op" id="4479519">[</span><span class="op" id="4479520">]</span><span class="builtintype" id="4479521">byte</span><span class="op" id="4479525">)</span>&nbsp;<span class="builtintype" id="4479527">error</span>&nbsp;<span class="op" id="4479533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479536">c</span>&nbsp;<span class="op" id="4479538">:=</span>&nbsp;<span class="ident" id="4479541">hs</span><span class="op" id="4479543">.</span><span class="ident" id="4479544">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479548">c</span><span class="op" id="4479549">.</span><span class="ident" id="4479550">writeRecord</span><span class="op" id="4479561">(</span><span class="ident" id="4479562">recordTypeChangeCipherSpec</span><span class="op" id="4479588">,</span>&nbsp;<span class="op" id="4479590">[</span><span class="op" id="4479591">]</span><span class="builtintype" id="4479592">byte</span><span class="op" id="4479596">{</span><span class="num" id="4479597">1</span><span class="op" id="4479598">}</span><span class="op" id="4479599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4479602">if</span>&nbsp;<span class="ident" id="4479605">hs</span><span class="op" id="4479607">.</span><span class="ident" id="4479608">serverHello</span><span class="op" id="4479619">.</span><span class="ident" id="4479620">nextProtoNeg</span>&nbsp;<span class="op" id="4479633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479637">nextProto</span>&nbsp;<span class="op" id="4479647">:=</span>&nbsp;<span class="builtinfunc" id="4479650">new</span><span class="op" id="4479653">(</span><span class="ident" id="4479654">nextProtoMsg</span><span class="op" id="4479666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479670">proto</span><span class="op" id="4479675">,</span>&nbsp;<span class="ident" id="4479677">fallback</span>&nbsp;<span class="op" id="4479686">:=</span>&nbsp;<span class="ident" id="4479689">mutualProtocol</span><span class="op" id="4479703">(</span><span class="ident" id="4479704">c</span><span class="op" id="4479705">.</span><span class="ident" id="4479706">config</span><span class="op" id="4479712">.</span><span class="ident" id="4479713">NextProtos</span><span class="op" id="4479723">,</span>&nbsp;<span class="ident" id="4479725">hs</span><span class="op" id="4479727">.</span><span class="ident" id="4479728">serverHello</span><span class="op" id="4479739">.</span><span class="ident" id="4479740">nextProtos</span><span class="op" id="4479750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479754">nextProto</span><span class="op" id="4479763">.</span><span class="ident" id="4479764">proto</span>&nbsp;<span class="op" id="4479770">=</span>&nbsp;<span class="ident" id="4479772">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479780">c</span><span class="op" id="4479781">.</span><span class="ident" id="4479782">clientProtocol</span>&nbsp;<span class="op" id="4479797">=</span>&nbsp;<span class="ident" id="4479799">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479807">c</span><span class="op" id="4479808">.</span><span class="ident" id="4479809">clientProtocolFallback</span>&nbsp;<span class="op" id="4479832">=</span>&nbsp;<span class="ident" id="4479834">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479846">hs</span><span class="op" id="4479848">.</span><span class="ident" id="4479849">finishedHash</span><span class="op" id="4479861">.</span><span class="ident" id="4479862">Write</span><span class="op" id="4479867">(</span><span class="ident" id="4479868">nextProto</span><span class="op" id="4479877">.</span><span class="ident" id="4479878">marshal</span><span class="op" id="4479885">(</span><span class="op" id="4479886">)</span><span class="op" id="4479887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479891">c</span><span class="op" id="4479892">.</span><span class="ident" id="4479893">writeRecord</span><span class="op" id="4479904">(</span><span class="ident" id="4479905">recordTypeHandshake</span><span class="op" id="4479924">,</span>&nbsp;<span class="ident" id="4479926">nextProto</span><span class="op" id="4479935">.</span><span class="ident" id="4479936">marshal</span><span class="op" id="4479943">(</span><span class="op" id="4479944">)</span><span class="op" id="4479945">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4479948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479952">finished</span>&nbsp;<span class="op" id="4479961">:=</span>&nbsp;<span class="builtinfunc" id="4479964">new</span><span class="op" id="4479967">(</span><span class="ident" id="4479968">finishedMsg</span><span class="op" id="4479979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479982">finished</span><span class="op" id="4479990">.</span><span class="ident" id="4479991">verifyData</span>&nbsp;<span class="op" id="4480002">=</span>&nbsp;<span class="ident" id="4480004">hs</span><span class="op" id="4480006">.</span><span class="ident" id="4480007">finishedHash</span><span class="op" id="4480019">.</span><span class="ident" id="4480020">clientSum</span><span class="op" id="4480029">(</span><span class="ident" id="4480030">hs</span><span class="op" id="4480032">.</span><span class="ident" id="4480033">masterSecret</span><span class="op" id="4480045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480048">hs</span><span class="op" id="4480050">.</span><span class="ident" id="4480051">finishedHash</span><span class="op" id="4480063">.</span><span class="ident" id="4480064">Write</span><span class="op" id="4480069">(</span><span class="ident" id="4480070">finished</span><span class="op" id="4480078">.</span><span class="ident" id="4480079">marshal</span><span class="op" id="4480086">(</span><span class="op" id="4480087">)</span><span class="op" id="4480088">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480091">c</span><span class="op" id="4480092">.</span><span class="ident" id="4480093">writeRecord</span><span class="op" id="4480104">(</span><span class="ident" id="4480105">recordTypeHandshake</span><span class="op" id="4480124">,</span>&nbsp;<span class="ident" id="4480126">finished</span><span class="op" id="4480134">.</span><span class="ident" id="4480135">marshal</span><span class="op" id="4480142">(</span><span class="op" id="4480143">)</span><span class="op" id="4480144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4480147">copy</span><span class="op" id="4480151">(</span><span class="ident" id="4480152">out</span><span class="op" id="4480155">,</span>&nbsp;<span class="ident" id="4480157">finished</span><span class="op" id="4480165">.</span><span class="ident" id="4480166">verifyData</span><span class="op" id="4480176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480179">return</span>&nbsp;<span class="ident" id="4480186">nil</span><br>
<span class="lineno"></span><span class="op" id="4480190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="4480193">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="4480272">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4480343">func</span>&nbsp;<span class="ident" id="4480348">clientSessionCacheKey</span><span class="op" id="4480369">(</span><span class="ident" id="4480370">serverAddr</span>&nbsp;<span class="ident" id="4480381">net</span><span class="op" id="4480384">.</span><span class="ident" id="4480385">Addr</span><span class="op" id="4480389">,</span>&nbsp;<span class="ident" id="4480391">config</span>&nbsp;<span class="op" id="4480398">*</span><span class="ident" id="4480399">Config</span><span class="op" id="4480405">)</span>&nbsp;<span class="builtintype" id="4480407">string</span>&nbsp;<span class="op" id="4480414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480417">if</span>&nbsp;<span class="builtinfunc" id="4480420">len</span><span class="op" id="4480423">(</span><span class="ident" id="4480424">config</span><span class="op" id="4480430">.</span><span class="ident" id="4480431">ServerName</span><span class="op" id="4480441">)</span>&nbsp;<span class="op" id="4480443">&gt;</span>&nbsp;<span class="num" id="4480445">0</span>&nbsp;<span class="op" id="4480447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480451">return</span>&nbsp;<span class="ident" id="4480458">config</span><span class="op" id="4480464">.</span><span class="ident" id="4480465">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4480477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480480">return</span>&nbsp;<span class="ident" id="4480487">serverAddr</span><span class="op" id="4480497">.</span><span class="ident" id="4480498">String</span><span class="op" id="4480504">(</span><span class="op" id="4480505">)</span><br>
<span class="lineno"></span><span class="op" id="4480507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4480510">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="4480588">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4480664">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="4480740">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="4480788">func</span>&nbsp;<span class="ident" id="4480793">mutualProtocol</span><span class="op" id="4480807">(</span><span class="ident" id="4480808">protos</span><span class="op" id="4480814">,</span>&nbsp;<span class="ident" id="4480816">preferenceProtos</span>&nbsp;<span class="op" id="4480833">[</span><span class="op" id="4480834">]</span><span class="builtintype" id="4480835">string</span><span class="op" id="4480841">)</span>&nbsp;<span class="op" id="4480843">(</span><span class="builtintype" id="4480844">string</span><span class="op" id="4480850">,</span>&nbsp;<span class="builtintype" id="4480852">bool</span><span class="op" id="4480856">)</span>&nbsp;<span class="op" id="4480858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480861">for</span>&nbsp;<span class="ident" id="4480865">_</span><span class="op" id="4480866">,</span>&nbsp;<span class="ident" id="4480868">s</span>&nbsp;<span class="op" id="4480870">:=</span>&nbsp;<span class="keyword" id="4480873">range</span>&nbsp;<span class="ident" id="4480879">preferenceProtos</span>&nbsp;<span class="op" id="4480896">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480900">for</span>&nbsp;<span class="ident" id="4480904">_</span><span class="op" id="4480905">,</span>&nbsp;<span class="ident" id="4480907">c</span>&nbsp;<span class="op" id="4480909">:=</span>&nbsp;<span class="keyword" id="4480912">range</span>&nbsp;<span class="ident" id="4480918">protos</span>&nbsp;<span class="op" id="4480925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480930">if</span>&nbsp;<span class="ident" id="4480933">s</span>&nbsp;<span class="op" id="4480935">==</span>&nbsp;<span class="ident" id="4480938">c</span>&nbsp;<span class="op" id="4480940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480946">return</span>&nbsp;<span class="ident" id="4480953">s</span><span class="op" id="4480954">,</span>&nbsp;<span class="builtintype" id="4480956">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4480965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4480969">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4480972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480976">return</span>&nbsp;<span class="ident" id="4480983">protos</span><span class="op" id="4480989">[</span><span class="num" id="4480990">0</span><span class="op" id="4480991">]</span><span class="op" id="4480992">,</span>&nbsp;<span class="builtintype" id="4480994">true</span><br>
<span class="lineno"></span><span class="op" id="4480999">}</span>
</div>
</body>
</html>
