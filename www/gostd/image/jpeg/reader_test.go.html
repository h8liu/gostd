<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8128144">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8128199">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8128253">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8128304">package</span>&nbsp;<span class="ident" id="8128312">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8128318">import</span>&nbsp;<span class="op" id="8128325">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128328">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128337">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128344">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128353">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128368">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128374">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128387">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128400">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128406">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128417">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="8128427">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="8128430">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="8128504">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="8128582">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="8128643">func</span>&nbsp;<span class="ident" id="8128648">TestDecodeProgressive</span><span class="op" id="8128669">(</span><span class="ident" id="8128670">t</span>&nbsp;<span class="op" id="8128672">*</span><span class="ident" id="8128673">testing</span><span class="op" id="8128680">.</span><span class="ident" id="8128681">T</span><span class="op" id="8128682">)</span>&nbsp;<span class="op" id="8128684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8128687">testCases</span>&nbsp;<span class="op" id="8128697">:=</span>&nbsp;<span class="op" id="8128700">[</span><span class="op" id="8128701">]</span><span class="builtintype" id="8128702">string</span><span class="op" id="8128708">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128712">&#34;../testdata/video-001&#34;</span><span class="op" id="8128735">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128739">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="8128770">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128774">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="8128805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128809">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="8128840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128844">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="8128875">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128879">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="8128911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128915">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="8128951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8128955">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="8129002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8129005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129008">for</span>&nbsp;<span class="ident" id="8129012">_</span><span class="op" id="8129013">,</span>&nbsp;<span class="ident" id="8129015">tc</span>&nbsp;<span class="op" id="8129018">:=</span>&nbsp;<span class="keyword" id="8129021">range</span>&nbsp;<span class="ident" id="8129027">testCases</span>&nbsp;<span class="op" id="8129037">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129041">m0</span><span class="op" id="8129043">,</span>&nbsp;<span class="ident" id="8129045">err</span>&nbsp;<span class="op" id="8129049">:=</span>&nbsp;<span class="ident" id="8129052">decodeFile</span><span class="op" id="8129062">(</span><span class="ident" id="8129063">tc</span>&nbsp;<span class="op" id="8129066">+</span>&nbsp;<span class="string" id="8129068">&#34;.jpeg&#34;</span><span class="op" id="8129075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129079">if</span>&nbsp;<span class="ident" id="8129082">err</span>&nbsp;<span class="op" id="8129086">!=</span>&nbsp;<span class="ident" id="8129089">nil</span>&nbsp;<span class="op" id="8129093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129098">t</span><span class="op" id="8129099">.</span><span class="ident" id="8129100">Errorf</span><span class="op" id="8129106">(</span><span class="string" id="8129107">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="8129115">,</span>&nbsp;<span class="ident" id="8129117">tc</span><span class="op" id="8129119">+</span><span class="string" id="8129120">&#34;.jpeg&#34;</span><span class="op" id="8129127">,</span>&nbsp;<span class="ident" id="8129129">err</span><span class="op" id="8129132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129137">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8129148">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129152">m1</span><span class="op" id="8129154">,</span>&nbsp;<span class="ident" id="8129156">err</span>&nbsp;<span class="op" id="8129160">:=</span>&nbsp;<span class="ident" id="8129163">decodeFile</span><span class="op" id="8129173">(</span><span class="ident" id="8129174">tc</span>&nbsp;<span class="op" id="8129177">+</span>&nbsp;<span class="string" id="8129179">&#34;.progressive.jpeg&#34;</span><span class="op" id="8129198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129202">if</span>&nbsp;<span class="ident" id="8129205">err</span>&nbsp;<span class="op" id="8129209">!=</span>&nbsp;<span class="ident" id="8129212">nil</span>&nbsp;<span class="op" id="8129216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129221">t</span><span class="op" id="8129222">.</span><span class="ident" id="8129223">Errorf</span><span class="op" id="8129229">(</span><span class="string" id="8129230">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="8129238">,</span>&nbsp;<span class="ident" id="8129240">tc</span><span class="op" id="8129242">+</span><span class="string" id="8129243">&#34;.progressive.jpeg&#34;</span><span class="op" id="8129262">,</span>&nbsp;<span class="ident" id="8129264">err</span><span class="op" id="8129267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129272">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8129283">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129287">if</span>&nbsp;<span class="ident" id="8129290">m0</span><span class="op" id="8129292">.</span><span class="ident" id="8129293">Bounds</span><span class="op" id="8129299">(</span><span class="op" id="8129300">)</span>&nbsp;<span class="op" id="8129302">!=</span>&nbsp;<span class="ident" id="8129305">m1</span><span class="op" id="8129307">.</span><span class="ident" id="8129308">Bounds</span><span class="op" id="8129314">(</span><span class="op" id="8129315">)</span>&nbsp;<span class="op" id="8129317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129322">t</span><span class="op" id="8129323">.</span><span class="ident" id="8129324">Errorf</span><span class="op" id="8129330">(</span><span class="string" id="8129331">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="8129361">,</span>&nbsp;<span class="ident" id="8129363">tc</span><span class="op" id="8129365">,</span>&nbsp;<span class="ident" id="8129367">m0</span><span class="op" id="8129369">.</span><span class="ident" id="8129370">Bounds</span><span class="op" id="8129376">(</span><span class="op" id="8129377">)</span><span class="op" id="8129378">,</span>&nbsp;<span class="ident" id="8129380">m1</span><span class="op" id="8129382">.</span><span class="ident" id="8129383">Bounds</span><span class="op" id="8129389">(</span><span class="op" id="8129390">)</span><span class="op" id="8129391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129396">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8129407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8129411">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129459">if</span>&nbsp;<span class="ident" id="8129462">m0</span><span class="op" id="8129464">.</span><span class="ident" id="8129465">Bounds</span><span class="op" id="8129471">(</span><span class="op" id="8129472">)</span>&nbsp;<span class="op" id="8129474">!=</span>&nbsp;<span class="ident" id="8129477">image</span><span class="op" id="8129482">.</span><span class="ident" id="8129483">Rect</span><span class="op" id="8129487">(</span><span class="num" id="8129488">0</span><span class="op" id="8129489">,</span>&nbsp;<span class="num" id="8129491">0</span><span class="op" id="8129492">,</span>&nbsp;<span class="num" id="8129494">150</span><span class="op" id="8129497">,</span>&nbsp;<span class="num" id="8129499">103</span><span class="op" id="8129502">)</span>&nbsp;<span class="op" id="8129504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129509">t</span><span class="op" id="8129510">.</span><span class="ident" id="8129511">Errorf</span><span class="op" id="8129517">(</span><span class="string" id="8129518">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="8129538">,</span>&nbsp;<span class="ident" id="8129540">tc</span><span class="op" id="8129542">,</span>&nbsp;<span class="ident" id="8129544">m0</span><span class="op" id="8129546">.</span><span class="ident" id="8129547">Bounds</span><span class="op" id="8129553">(</span><span class="op" id="8129554">)</span><span class="op" id="8129555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129560">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8129571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129576">switch</span>&nbsp;<span class="ident" id="8129583">m0</span>&nbsp;<span class="op" id="8129586">:=</span>&nbsp;<span class="ident" id="8129589">m0</span><span class="op" id="8129591">.</span><span class="op" id="8129592">(</span><span class="keyword" id="8129593">type</span><span class="op" id="8129597">)</span>&nbsp;<span class="op" id="8129599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129603">case</span>&nbsp;<span class="op" id="8129608">*</span><span class="ident" id="8129609">image</span><span class="op" id="8129614">.</span><span class="ident" id="8129615">YCbCr</span><span class="op" id="8129620">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129625">m1</span>&nbsp;<span class="op" id="8129628">:=</span>&nbsp;<span class="ident" id="8129631">m1</span><span class="op" id="8129633">.</span><span class="op" id="8129634">(</span><span class="op" id="8129635">*</span><span class="ident" id="8129636">image</span><span class="op" id="8129641">.</span><span class="ident" id="8129642">YCbCr</span><span class="op" id="8129647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129652">if</span>&nbsp;<span class="ident" id="8129655">err</span>&nbsp;<span class="op" id="8129659">:=</span>&nbsp;<span class="ident" id="8129662">check</span><span class="op" id="8129667">(</span><span class="ident" id="8129668">m0</span><span class="op" id="8129670">.</span><span class="ident" id="8129671">Bounds</span><span class="op" id="8129677">(</span><span class="op" id="8129678">)</span><span class="op" id="8129679">,</span>&nbsp;<span class="ident" id="8129681">m0</span><span class="op" id="8129683">.</span><span class="ident" id="8129684">Y</span><span class="op" id="8129685">,</span>&nbsp;<span class="ident" id="8129687">m1</span><span class="op" id="8129689">.</span><span class="ident" id="8129690">Y</span><span class="op" id="8129691">,</span>&nbsp;<span class="ident" id="8129693">m0</span><span class="op" id="8129695">.</span><span class="ident" id="8129696">YStride</span><span class="op" id="8129703">,</span>&nbsp;<span class="ident" id="8129705">m1</span><span class="op" id="8129707">.</span><span class="ident" id="8129708">YStride</span><span class="op" id="8129715">)</span><span class="op" id="8129716">;</span>&nbsp;<span class="ident" id="8129718">err</span>&nbsp;<span class="op" id="8129722">!=</span>&nbsp;<span class="ident" id="8129725">nil</span>&nbsp;<span class="op" id="8129729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129735">t</span><span class="op" id="8129736">.</span><span class="ident" id="8129737">Errorf</span><span class="op" id="8129743">(</span><span class="string" id="8129744">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="8129756">,</span>&nbsp;<span class="ident" id="8129758">tc</span><span class="op" id="8129760">,</span>&nbsp;<span class="ident" id="8129762">err</span><span class="op" id="8129765">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129771">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8129783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129788">if</span>&nbsp;<span class="ident" id="8129791">err</span>&nbsp;<span class="op" id="8129795">:=</span>&nbsp;<span class="ident" id="8129798">check</span><span class="op" id="8129803">(</span><span class="ident" id="8129804">m0</span><span class="op" id="8129806">.</span><span class="ident" id="8129807">Bounds</span><span class="op" id="8129813">(</span><span class="op" id="8129814">)</span><span class="op" id="8129815">,</span>&nbsp;<span class="ident" id="8129817">m0</span><span class="op" id="8129819">.</span><span class="ident" id="8129820">Cb</span><span class="op" id="8129822">,</span>&nbsp;<span class="ident" id="8129824">m1</span><span class="op" id="8129826">.</span><span class="ident" id="8129827">Cb</span><span class="op" id="8129829">,</span>&nbsp;<span class="ident" id="8129831">m0</span><span class="op" id="8129833">.</span><span class="ident" id="8129834">CStride</span><span class="op" id="8129841">,</span>&nbsp;<span class="ident" id="8129843">m1</span><span class="op" id="8129845">.</span><span class="ident" id="8129846">CStride</span><span class="op" id="8129853">)</span><span class="op" id="8129854">;</span>&nbsp;<span class="ident" id="8129856">err</span>&nbsp;<span class="op" id="8129860">!=</span>&nbsp;<span class="ident" id="8129863">nil</span>&nbsp;<span class="op" id="8129867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8129873">t</span><span class="op" id="8129874">.</span><span class="ident" id="8129875">Errorf</span><span class="op" id="8129881">(</span><span class="string" id="8129882">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="8129895">,</span>&nbsp;<span class="ident" id="8129897">tc</span><span class="op" id="8129899">,</span>&nbsp;<span class="ident" id="8129901">err</span><span class="op" id="8129904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129910">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8129922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8129927">if</span>&nbsp;<span class="ident" id="8129930">err</span>&nbsp;<span class="op" id="8129934">:=</span>&nbsp;<span class="ident" id="8129937">check</span><span class="op" id="8129942">(</span><span class="ident" id="8129943">m0</span><span class="op" id="8129945">.</span><span class="ident" id="8129946">Bounds</span><span class="op" id="8129952">(</span><span class="op" id="8129953">)</span><span class="op" id="8129954">,</span>&nbsp;<span class="ident" id="8129956">m0</span><span class="op" id="8129958">.</span><span class="ident" id="8129959">Cr</span><span class="op" id="8129961">,</span>&nbsp;<span class="ident" id="8129963">m1</span><span class="op" id="8129965">.</span><span class="ident" id="8129966">Cr</span><span class="op" id="8129968">,</span>&nbsp;<span class="ident" id="8129970">m0</span><span class="op" id="8129972">.</span><span class="ident" id="8129973">CStride</span><span class="op" id="8129980">,</span>&nbsp;<span class="ident" id="8129982">m1</span><span class="op" id="8129984">.</span><span class="ident" id="8129985">CStride</span><span class="op" id="8129992">)</span><span class="op" id="8129993">;</span>&nbsp;<span class="ident" id="8129995">err</span>&nbsp;<span class="op" id="8129999">!=</span>&nbsp;<span class="ident" id="8130002">nil</span>&nbsp;<span class="op" id="8130006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130012">t</span><span class="op" id="8130013">.</span><span class="ident" id="8130014">Errorf</span><span class="op" id="8130020">(</span><span class="string" id="8130021">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="8130034">,</span>&nbsp;<span class="ident" id="8130036">tc</span><span class="op" id="8130038">,</span>&nbsp;<span class="ident" id="8130040">err</span><span class="op" id="8130043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130049">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130061">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130065">case</span>&nbsp;<span class="op" id="8130070">*</span><span class="ident" id="8130071">image</span><span class="op" id="8130076">.</span><span class="ident" id="8130077">Gray</span><span class="op" id="8130081">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130086">m1</span>&nbsp;<span class="op" id="8130089">:=</span>&nbsp;<span class="ident" id="8130092">m1</span><span class="op" id="8130094">.</span><span class="op" id="8130095">(</span><span class="op" id="8130096">*</span><span class="ident" id="8130097">image</span><span class="op" id="8130102">.</span><span class="ident" id="8130103">Gray</span><span class="op" id="8130107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130112">if</span>&nbsp;<span class="ident" id="8130115">err</span>&nbsp;<span class="op" id="8130119">:=</span>&nbsp;<span class="ident" id="8130122">check</span><span class="op" id="8130127">(</span><span class="ident" id="8130128">m0</span><span class="op" id="8130130">.</span><span class="ident" id="8130131">Bounds</span><span class="op" id="8130137">(</span><span class="op" id="8130138">)</span><span class="op" id="8130139">,</span>&nbsp;<span class="ident" id="8130141">m0</span><span class="op" id="8130143">.</span><span class="ident" id="8130144">Pix</span><span class="op" id="8130147">,</span>&nbsp;<span class="ident" id="8130149">m1</span><span class="op" id="8130151">.</span><span class="ident" id="8130152">Pix</span><span class="op" id="8130155">,</span>&nbsp;<span class="ident" id="8130157">m0</span><span class="op" id="8130159">.</span><span class="ident" id="8130160">Stride</span><span class="op" id="8130166">,</span>&nbsp;<span class="ident" id="8130168">m1</span><span class="op" id="8130170">.</span><span class="ident" id="8130171">Stride</span><span class="op" id="8130177">)</span><span class="op" id="8130178">;</span>&nbsp;<span class="ident" id="8130180">err</span>&nbsp;<span class="op" id="8130184">!=</span>&nbsp;<span class="ident" id="8130187">nil</span>&nbsp;<span class="op" id="8130191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130197">t</span><span class="op" id="8130198">.</span><span class="ident" id="8130199">Errorf</span><span class="op" id="8130205">(</span><span class="string" id="8130206">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="8130214">,</span>&nbsp;<span class="ident" id="8130216">tc</span><span class="op" id="8130218">,</span>&nbsp;<span class="ident" id="8130220">err</span><span class="op" id="8130223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130229">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130245">default</span><span class="op" id="8130252">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130257">t</span><span class="op" id="8130258">.</span><span class="ident" id="8130259">Errorf</span><span class="op" id="8130265">(</span><span class="string" id="8130266">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="8130296">,</span>&nbsp;<span class="ident" id="8130298">tc</span><span class="op" id="8130300">,</span>&nbsp;<span class="ident" id="8130302">m0</span><span class="op" id="8130304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130309">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130320">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130323">}</span><br>
<span class="lineno"></span><span class="op" id="8130325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8130328">func</span>&nbsp;<span class="ident" id="8130333">decodeFile</span><span class="op" id="8130343">(</span><span class="ident" id="8130344">filename</span>&nbsp;<span class="builtintype" id="8130353">string</span><span class="op" id="8130359">)</span>&nbsp;<span class="op" id="8130361">(</span><span class="ident" id="8130362">image</span><span class="op" id="8130367">.</span><span class="ident" id="8130368">Image</span><span class="op" id="8130373">,</span>&nbsp;<span class="builtintype" id="8130375">error</span><span class="op" id="8130380">)</span>&nbsp;<span class="op" id="8130382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130385">f</span><span class="op" id="8130386">,</span>&nbsp;<span class="ident" id="8130388">err</span>&nbsp;<span class="op" id="8130392">:=</span>&nbsp;<span class="ident" id="8130395">os</span><span class="op" id="8130397">.</span><span class="ident" id="8130398">Open</span><span class="op" id="8130402">(</span><span class="ident" id="8130403">filename</span><span class="op" id="8130411">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130414">if</span>&nbsp;<span class="ident" id="8130417">err</span>&nbsp;<span class="op" id="8130421">!=</span>&nbsp;<span class="ident" id="8130424">nil</span>&nbsp;<span class="op" id="8130428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130432">return</span>&nbsp;<span class="ident" id="8130439">nil</span><span class="op" id="8130442">,</span>&nbsp;<span class="ident" id="8130444">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130452">defer</span>&nbsp;<span class="ident" id="8130458">f</span><span class="op" id="8130459">.</span><span class="ident" id="8130460">Close</span><span class="op" id="8130465">(</span><span class="op" id="8130466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130469">return</span>&nbsp;<span class="ident" id="8130476">Decode</span><span class="op" id="8130482">(</span><span class="ident" id="8130483">f</span><span class="op" id="8130484">)</span><br>
<span class="lineno">90</span><span class="op" id="8130486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8130489">type</span>&nbsp;<span class="ident" id="8130494">eofReader</span>&nbsp;<span class="keyword" id="8130504">struct</span>&nbsp;<span class="op" id="8130511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130514">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8130523">[</span><span class="op" id="8130524">]</span><span class="builtintype" id="8130525">byte</span>&nbsp;<span class="comment" id="8130530">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130564">dataEOF</span>&nbsp;&nbsp;<span class="op" id="8130573">[</span><span class="op" id="8130574">]</span><span class="builtintype" id="8130575">byte</span>&nbsp;<span class="comment" id="8130580">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130630">lenAtEOF</span>&nbsp;<span class="builtintype" id="8130639">int</span><br>
<span class="lineno"></span><span class="op" id="8130643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8130646">func</span>&nbsp;<span class="op" id="8130651">(</span><span class="ident" id="8130652">r</span>&nbsp;<span class="op" id="8130654">*</span><span class="ident" id="8130655">eofReader</span><span class="op" id="8130664">)</span>&nbsp;<span class="ident" id="8130666">Read</span><span class="op" id="8130670">(</span><span class="ident" id="8130671">b</span>&nbsp;<span class="op" id="8130673">[</span><span class="op" id="8130674">]</span><span class="builtintype" id="8130675">byte</span><span class="op" id="8130679">)</span>&nbsp;<span class="op" id="8130681">(</span><span class="ident" id="8130682">n</span>&nbsp;<span class="builtintype" id="8130684">int</span><span class="op" id="8130687">,</span>&nbsp;<span class="ident" id="8130689">err</span>&nbsp;<span class="builtintype" id="8130693">error</span><span class="op" id="8130698">)</span>&nbsp;<span class="op" id="8130700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130703">if</span>&nbsp;<span class="builtinfunc" id="8130706">len</span><span class="op" id="8130709">(</span><span class="ident" id="8130710">r</span><span class="op" id="8130711">.</span><span class="ident" id="8130712">data</span><span class="op" id="8130716">)</span>&nbsp;<span class="op" id="8130718">&gt;</span>&nbsp;<span class="num" id="8130720">0</span>&nbsp;<span class="op" id="8130722">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130726">n</span>&nbsp;<span class="op" id="8130728">=</span>&nbsp;<span class="builtinfunc" id="8130730">copy</span><span class="op" id="8130734">(</span><span class="ident" id="8130735">b</span><span class="op" id="8130736">,</span>&nbsp;<span class="ident" id="8130738">r</span><span class="op" id="8130739">.</span><span class="ident" id="8130740">data</span><span class="op" id="8130744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130748">r</span><span class="op" id="8130749">.</span><span class="ident" id="8130750">data</span>&nbsp;<span class="op" id="8130755">=</span>&nbsp;<span class="ident" id="8130757">r</span><span class="op" id="8130758">.</span><span class="ident" id="8130759">data</span><span class="op" id="8130763">[</span><span class="ident" id="8130764">n</span><span class="op" id="8130765">:</span><span class="op" id="8130766">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130769">}</span>&nbsp;<span class="keyword" id="8130771">else</span>&nbsp;<span class="op" id="8130776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130780">n</span>&nbsp;<span class="op" id="8130782">=</span>&nbsp;<span class="builtinfunc" id="8130784">copy</span><span class="op" id="8130788">(</span><span class="ident" id="8130789">b</span><span class="op" id="8130790">,</span>&nbsp;<span class="ident" id="8130792">r</span><span class="op" id="8130793">.</span><span class="ident" id="8130794">dataEOF</span><span class="op" id="8130801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130805">r</span><span class="op" id="8130806">.</span><span class="ident" id="8130807">dataEOF</span>&nbsp;<span class="op" id="8130815">=</span>&nbsp;<span class="ident" id="8130817">r</span><span class="op" id="8130818">.</span><span class="ident" id="8130819">dataEOF</span><span class="op" id="8130826">[</span><span class="ident" id="8130827">n</span><span class="op" id="8130828">:</span><span class="op" id="8130829">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130833">if</span>&nbsp;<span class="builtinfunc" id="8130836">len</span><span class="op" id="8130839">(</span><span class="ident" id="8130840">r</span><span class="op" id="8130841">.</span><span class="ident" id="8130842">dataEOF</span><span class="op" id="8130849">)</span>&nbsp;<span class="op" id="8130851">==</span>&nbsp;<span class="num" id="8130854">0</span>&nbsp;<span class="op" id="8130856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130861">err</span>&nbsp;<span class="op" id="8130865">=</span>&nbsp;<span class="ident" id="8130867">io</span><span class="op" id="8130869">.</span><span class="ident" id="8130870">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130877">if</span>&nbsp;<span class="ident" id="8130880">r</span><span class="op" id="8130881">.</span><span class="ident" id="8130882">lenAtEOF</span>&nbsp;<span class="op" id="8130891">==</span>&nbsp;<span class="op" id="8130894">-</span><span class="num" id="8130895">1</span>&nbsp;<span class="op" id="8130897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8130903">r</span><span class="op" id="8130904">.</span><span class="ident" id="8130905">lenAtEOF</span>&nbsp;<span class="op" id="8130914">=</span>&nbsp;<span class="ident" id="8130916">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130921">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8130928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8130931">return</span><br>
<span class="lineno"></span><span class="op" id="8130938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="8130941">func</span>&nbsp;<span class="ident" id="8130946">TestDecodeEOF</span><span class="op" id="8130959">(</span><span class="ident" id="8130960">t</span>&nbsp;<span class="op" id="8130962">*</span><span class="ident" id="8130963">testing</span><span class="op" id="8130970">.</span><span class="ident" id="8130971">T</span><span class="op" id="8130972">)</span>&nbsp;<span class="op" id="8130974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8130977">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8131060">data</span><span class="op" id="8131064">,</span>&nbsp;<span class="ident" id="8131066">err</span>&nbsp;<span class="op" id="8131070">:=</span>&nbsp;<span class="ident" id="8131073">ioutil</span><span class="op" id="8131079">.</span><span class="ident" id="8131080">ReadFile</span><span class="op" id="8131088">(</span><span class="string" id="8131089">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="8131117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131120">if</span>&nbsp;<span class="ident" id="8131123">err</span>&nbsp;<span class="op" id="8131127">!=</span>&nbsp;<span class="ident" id="8131130">nil</span>&nbsp;<span class="op" id="8131134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8131138">t</span><span class="op" id="8131139">.</span><span class="ident" id="8131140">Fatal</span><span class="op" id="8131145">(</span><span class="ident" id="8131146">err</span><span class="op" id="8131149">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8131152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8131156">n</span>&nbsp;<span class="op" id="8131158">:=</span>&nbsp;<span class="builtinfunc" id="8131161">len</span><span class="op" id="8131164">(</span><span class="ident" id="8131165">data</span><span class="op" id="8131169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131172">for</span>&nbsp;<span class="ident" id="8131176">i</span>&nbsp;<span class="op" id="8131178">:=</span>&nbsp;<span class="num" id="8131181">0</span><span class="op" id="8131182">;</span>&nbsp;<span class="ident" id="8131184">i</span>&nbsp;<span class="op" id="8131186">&lt;</span>&nbsp;<span class="ident" id="8131188">n</span><span class="op" id="8131189">;</span>&nbsp;<span class="op" id="8131191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8131195">r</span>&nbsp;<span class="op" id="8131197">:=</span>&nbsp;<span class="op" id="8131200">&amp;</span><span class="ident" id="8131201">eofReader</span><span class="op" id="8131210">{</span><span class="ident" id="8131211">data</span><span class="op" id="8131215">[</span><span class="op" id="8131216">:</span><span class="ident" id="8131217">n</span><span class="op" id="8131218">-</span><span class="ident" id="8131219">i</span><span class="op" id="8131220">]</span><span class="op" id="8131221">,</span>&nbsp;<span class="ident" id="8131223">data</span><span class="op" id="8131227">[</span><span class="ident" id="8131228">n</span><span class="op" id="8131229">-</span><span class="ident" id="8131230">i</span><span class="op" id="8131231">:</span><span class="op" id="8131232">]</span><span class="op" id="8131233">,</span>&nbsp;<span class="op" id="8131235">-</span><span class="num" id="8131236">1</span><span class="op" id="8131237">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8131241">_</span><span class="op" id="8131242">,</span>&nbsp;<span class="ident" id="8131244">err</span>&nbsp;<span class="op" id="8131248">:=</span>&nbsp;<span class="ident" id="8131251">Decode</span><span class="op" id="8131257">(</span><span class="ident" id="8131258">r</span><span class="op" id="8131259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131263">if</span>&nbsp;<span class="ident" id="8131266">err</span>&nbsp;<span class="op" id="8131270">!=</span>&nbsp;<span class="ident" id="8131273">nil</span>&nbsp;<span class="op" id="8131277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8131282">t</span><span class="op" id="8131283">.</span><span class="ident" id="8131284">Errorf</span><span class="op" id="8131290">(</span><span class="string" id="8131291">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="8131325">,</span>&nbsp;<span class="ident" id="8131327">r</span><span class="op" id="8131328">.</span><span class="ident" id="8131329">lenAtEOF</span><span class="op" id="8131337">,</span>&nbsp;<span class="ident" id="8131339">err</span><span class="op" id="8131342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8131346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131350">if</span>&nbsp;<span class="ident" id="8131353">i</span>&nbsp;<span class="op" id="8131355">==</span>&nbsp;<span class="num" id="8131358">0</span>&nbsp;<span class="op" id="8131360">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8131365">i</span>&nbsp;<span class="op" id="8131367">=</span>&nbsp;<span class="num" id="8131369">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8131373">}</span>&nbsp;<span class="keyword" id="8131375">else</span>&nbsp;<span class="op" id="8131380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8131385">i</span>&nbsp;<span class="op" id="8131387">*=</span>&nbsp;<span class="num" id="8131390">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8131394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8131397">}</span><br>
<span class="lineno">135</span><span class="op" id="8131399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8131402">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="8131476">func</span>&nbsp;<span class="ident" id="8131481">check</span><span class="op" id="8131486">(</span><span class="ident" id="8131487">bounds</span>&nbsp;<span class="ident" id="8131494">image</span><span class="op" id="8131499">.</span><span class="ident" id="8131500">Rectangle</span><span class="op" id="8131509">,</span>&nbsp;<span class="ident" id="8131511">pix0</span><span class="op" id="8131515">,</span>&nbsp;<span class="ident" id="8131517">pix1</span>&nbsp;<span class="op" id="8131522">[</span><span class="op" id="8131523">]</span><span class="builtintype" id="8131524">byte</span><span class="op" id="8131528">,</span>&nbsp;<span class="ident" id="8131530">stride0</span><span class="op" id="8131537">,</span>&nbsp;<span class="ident" id="8131539">stride1</span>&nbsp;<span class="builtintype" id="8131547">int</span><span class="op" id="8131550">)</span>&nbsp;<span class="builtintype" id="8131552">error</span>&nbsp;<span class="op" id="8131558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131561">if</span>&nbsp;<span class="ident" id="8131564">stride0</span>&nbsp;<span class="op" id="8131572">&lt;=</span>&nbsp;<span class="num" id="8131575">0</span>&nbsp;<span class="op" id="8131577">||</span>&nbsp;<span class="ident" id="8131580">stride0</span><span class="op" id="8131587">%</span><span class="num" id="8131588">8</span>&nbsp;<span class="op" id="8131590">!=</span>&nbsp;<span class="num" id="8131593">0</span>&nbsp;<span class="op" id="8131595">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131599">return</span>&nbsp;<span class="ident" id="8131606">fmt</span><span class="op" id="8131609">.</span><span class="ident" id="8131610">Errorf</span><span class="op" id="8131616">(</span><span class="string" id="8131617">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="8131632">,</span>&nbsp;<span class="ident" id="8131634">stride0</span><span class="op" id="8131641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8131644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131647">if</span>&nbsp;<span class="ident" id="8131650">stride1</span>&nbsp;<span class="op" id="8131658">&lt;=</span>&nbsp;<span class="num" id="8131661">0</span>&nbsp;<span class="op" id="8131663">||</span>&nbsp;<span class="ident" id="8131666">stride1</span><span class="op" id="8131673">%</span><span class="num" id="8131674">8</span>&nbsp;<span class="op" id="8131676">!=</span>&nbsp;<span class="num" id="8131679">0</span>&nbsp;<span class="op" id="8131681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131685">return</span>&nbsp;<span class="ident" id="8131692">fmt</span><span class="op" id="8131695">.</span><span class="ident" id="8131696">Errorf</span><span class="op" id="8131702">(</span><span class="string" id="8131703">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="8131718">,</span>&nbsp;<span class="ident" id="8131720">stride1</span><span class="op" id="8131727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8131730">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8131733">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131788">for</span>&nbsp;<span class="ident" id="8131792">y</span>&nbsp;<span class="op" id="8131794">:=</span>&nbsp;<span class="num" id="8131797">0</span><span class="op" id="8131798">;</span>&nbsp;<span class="ident" id="8131800">y</span>&nbsp;<span class="op" id="8131802">&lt;</span>&nbsp;<span class="builtinfunc" id="8131804">len</span><span class="op" id="8131807">(</span><span class="ident" id="8131808">pix0</span><span class="op" id="8131812">)</span><span class="op" id="8131813">/</span><span class="ident" id="8131814">stride0</span>&nbsp;<span class="op" id="8131822">&amp;&amp;</span>&nbsp;<span class="ident" id="8131825">y</span>&nbsp;<span class="op" id="8131827">&lt;</span>&nbsp;<span class="builtinfunc" id="8131829">len</span><span class="op" id="8131832">(</span><span class="ident" id="8131833">pix1</span><span class="op" id="8131837">)</span><span class="op" id="8131838">/</span><span class="ident" id="8131839">stride1</span><span class="op" id="8131846">;</span>&nbsp;<span class="ident" id="8131848">y</span>&nbsp;<span class="op" id="8131850">+=</span>&nbsp;<span class="num" id="8131853">8</span>&nbsp;<span class="op" id="8131855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131859">for</span>&nbsp;<span class="ident" id="8131863">x</span>&nbsp;<span class="op" id="8131865">:=</span>&nbsp;<span class="num" id="8131868">0</span><span class="op" id="8131869">;</span>&nbsp;<span class="ident" id="8131871">x</span>&nbsp;<span class="op" id="8131873">&lt;</span>&nbsp;<span class="ident" id="8131875">stride0</span>&nbsp;<span class="op" id="8131883">&amp;&amp;</span>&nbsp;<span class="ident" id="8131886">x</span>&nbsp;<span class="op" id="8131888">&lt;</span>&nbsp;<span class="ident" id="8131890">stride1</span><span class="op" id="8131897">;</span>&nbsp;<span class="ident" id="8131899">x</span>&nbsp;<span class="op" id="8131901">+=</span>&nbsp;<span class="num" id="8131904">8</span>&nbsp;<span class="op" id="8131906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8131911">if</span>&nbsp;<span class="ident" id="8131914">x</span>&nbsp;<span class="op" id="8131916">&gt;=</span>&nbsp;<span class="ident" id="8131919">bounds</span><span class="op" id="8131925">.</span><span class="ident" id="8131926">Max</span><span class="op" id="8131929">.</span><span class="ident" id="8131930">X</span>&nbsp;<span class="op" id="8131932">||</span>&nbsp;<span class="ident" id="8131935">y</span>&nbsp;<span class="op" id="8131937">&gt;=</span>&nbsp;<span class="ident" id="8131940">bounds</span><span class="op" id="8131946">.</span><span class="ident" id="8131947">Max</span><span class="op" id="8131950">.</span><span class="ident" id="8131951">Y</span>&nbsp;<span class="op" id="8131953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8131959">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8132027">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8132096">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8132167">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8132234">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8132302">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132370">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132388">for</span>&nbsp;<span class="ident" id="8132392">j</span>&nbsp;<span class="op" id="8132394">:=</span>&nbsp;<span class="num" id="8132397">0</span><span class="op" id="8132398">;</span>&nbsp;<span class="ident" id="8132400">j</span>&nbsp;<span class="op" id="8132402">&lt;</span>&nbsp;<span class="num" id="8132404">8</span><span class="op" id="8132405">;</span>&nbsp;<span class="ident" id="8132407">j</span><span class="op" id="8132408">++</span>&nbsp;<span class="op" id="8132411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132417">for</span>&nbsp;<span class="ident" id="8132421">i</span>&nbsp;<span class="op" id="8132423">:=</span>&nbsp;<span class="num" id="8132426">0</span><span class="op" id="8132427">;</span>&nbsp;<span class="ident" id="8132429">i</span>&nbsp;<span class="op" id="8132431">&lt;</span>&nbsp;<span class="num" id="8132433">8</span><span class="op" id="8132434">;</span>&nbsp;<span class="ident" id="8132436">i</span><span class="op" id="8132437">++</span>&nbsp;<span class="op" id="8132440">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8132447">index0</span>&nbsp;<span class="op" id="8132454">:=</span>&nbsp;<span class="op" id="8132457">(</span><span class="ident" id="8132458">y</span><span class="op" id="8132459">+</span><span class="ident" id="8132460">j</span><span class="op" id="8132461">)</span><span class="op" id="8132462">*</span><span class="ident" id="8132463">stride0</span>&nbsp;<span class="op" id="8132471">+</span>&nbsp;<span class="op" id="8132473">(</span><span class="ident" id="8132474">x</span>&nbsp;<span class="op" id="8132476">+</span>&nbsp;<span class="ident" id="8132478">i</span><span class="op" id="8132479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8132486">index1</span>&nbsp;<span class="op" id="8132493">:=</span>&nbsp;<span class="op" id="8132496">(</span><span class="ident" id="8132497">y</span><span class="op" id="8132498">+</span><span class="ident" id="8132499">j</span><span class="op" id="8132500">)</span><span class="op" id="8132501">*</span><span class="ident" id="8132502">stride1</span>&nbsp;<span class="op" id="8132510">+</span>&nbsp;<span class="op" id="8132512">(</span><span class="ident" id="8132513">x</span>&nbsp;<span class="op" id="8132515">+</span>&nbsp;<span class="ident" id="8132517">i</span><span class="op" id="8132518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132525">if</span>&nbsp;<span class="ident" id="8132528">pix0</span><span class="op" id="8132532">[</span><span class="ident" id="8132533">index0</span><span class="op" id="8132539">]</span>&nbsp;<span class="op" id="8132541">!=</span>&nbsp;<span class="ident" id="8132544">pix1</span><span class="op" id="8132548">[</span><span class="ident" id="8132549">index1</span><span class="op" id="8132555">]</span>&nbsp;<span class="op" id="8132557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132565">return</span>&nbsp;<span class="ident" id="8132572">fmt</span><span class="op" id="8132575">.</span><span class="ident" id="8132576">Errorf</span><span class="op" id="8132582">(</span><span class="string" id="8132583">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="8132622">,</span>&nbsp;<span class="ident" id="8132624">x</span><span class="op" id="8132625">,</span>&nbsp;<span class="ident" id="8132627">y</span><span class="op" id="8132628">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8132637">pixString</span><span class="op" id="8132646">(</span><span class="ident" id="8132647">pix0</span><span class="op" id="8132651">,</span>&nbsp;<span class="ident" id="8132653">stride0</span><span class="op" id="8132660">,</span>&nbsp;<span class="ident" id="8132662">x</span><span class="op" id="8132663">,</span>&nbsp;<span class="ident" id="8132665">y</span><span class="op" id="8132666">)</span><span class="op" id="8132667">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8132676">pixString</span><span class="op" id="8132685">(</span><span class="ident" id="8132686">pix1</span><span class="op" id="8132690">,</span>&nbsp;<span class="ident" id="8132692">stride1</span><span class="op" id="8132699">,</span>&nbsp;<span class="ident" id="8132701">x</span><span class="op" id="8132702">,</span>&nbsp;<span class="ident" id="8132704">y</span><span class="op" id="8132705">)</span><span class="op" id="8132706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132732">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132742">return</span>&nbsp;<span class="ident" id="8132749">nil</span><br>
<span class="lineno"></span><span class="op" id="8132753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="8132756">func</span>&nbsp;<span class="ident" id="8132761">pixString</span><span class="op" id="8132770">(</span><span class="ident" id="8132771">pix</span>&nbsp;<span class="op" id="8132775">[</span><span class="op" id="8132776">]</span><span class="builtintype" id="8132777">byte</span><span class="op" id="8132781">,</span>&nbsp;<span class="ident" id="8132783">stride</span><span class="op" id="8132789">,</span>&nbsp;<span class="ident" id="8132791">x</span><span class="op" id="8132792">,</span>&nbsp;<span class="ident" id="8132794">y</span>&nbsp;<span class="builtintype" id="8132796">int</span><span class="op" id="8132799">)</span>&nbsp;<span class="builtintype" id="8132801">string</span>&nbsp;<span class="op" id="8132808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8132811">s</span>&nbsp;<span class="op" id="8132813">:=</span>&nbsp;<span class="ident" id="8132816">bytes</span><span class="op" id="8132821">.</span><span class="ident" id="8132822">NewBuffer</span><span class="op" id="8132831">(</span><span class="ident" id="8132832">nil</span><span class="op" id="8132835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132838">for</span>&nbsp;<span class="ident" id="8132842">j</span>&nbsp;<span class="op" id="8132844">:=</span>&nbsp;<span class="num" id="8132847">0</span><span class="op" id="8132848">;</span>&nbsp;<span class="ident" id="8132850">j</span>&nbsp;<span class="op" id="8132852">&lt;</span>&nbsp;<span class="num" id="8132854">8</span><span class="op" id="8132855">;</span>&nbsp;<span class="ident" id="8132857">j</span><span class="op" id="8132858">++</span>&nbsp;<span class="op" id="8132861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8132865">fmt</span><span class="op" id="8132868">.</span><span class="ident" id="8132869">Fprintf</span><span class="op" id="8132876">(</span><span class="ident" id="8132877">s</span><span class="op" id="8132878">,</span>&nbsp;<span class="string" id="8132880">&#34;\t&#34;</span><span class="op" id="8132884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132888">for</span>&nbsp;<span class="ident" id="8132892">i</span>&nbsp;<span class="op" id="8132894">:=</span>&nbsp;<span class="num" id="8132897">0</span><span class="op" id="8132898">;</span>&nbsp;<span class="ident" id="8132900">i</span>&nbsp;<span class="op" id="8132902">&lt;</span>&nbsp;<span class="num" id="8132904">8</span><span class="op" id="8132905">;</span>&nbsp;<span class="ident" id="8132907">i</span><span class="op" id="8132908">++</span>&nbsp;<span class="op" id="8132911">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8132916">fmt</span><span class="op" id="8132919">.</span><span class="ident" id="8132920">Fprintf</span><span class="op" id="8132927">(</span><span class="ident" id="8132928">s</span><span class="op" id="8132929">,</span>&nbsp;<span class="string" id="8132931">&#34;%02x&nbsp;&#34;</span><span class="op" id="8132938">,</span>&nbsp;<span class="ident" id="8132940">pix</span><span class="op" id="8132943">[</span><span class="op" id="8132944">(</span><span class="ident" id="8132945">y</span><span class="op" id="8132946">+</span><span class="ident" id="8132947">j</span><span class="op" id="8132948">)</span><span class="op" id="8132949">*</span><span class="ident" id="8132950">stride</span><span class="op" id="8132956">+</span><span class="op" id="8132957">(</span><span class="ident" id="8132958">x</span><span class="op" id="8132959">+</span><span class="ident" id="8132960">i</span><span class="op" id="8132961">)</span><span class="op" id="8132962">]</span><span class="op" id="8132963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8132971">fmt</span><span class="op" id="8132974">.</span><span class="ident" id="8132975">Fprintf</span><span class="op" id="8132982">(</span><span class="ident" id="8132983">s</span><span class="op" id="8132984">,</span>&nbsp;<span class="string" id="8132986">&#34;\n&#34;</span><span class="op" id="8132990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8132993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8132996">return</span>&nbsp;<span class="ident" id="8133003">s</span><span class="op" id="8133004">.</span><span class="ident" id="8133005">String</span><span class="op" id="8133011">(</span><span class="op" id="8133012">)</span><br>
<span class="lineno">185</span><span class="op" id="8133014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8133017">func</span>&nbsp;<span class="ident" id="8133022">TestExtraneousData</span><span class="op" id="8133040">(</span><span class="ident" id="8133041">t</span>&nbsp;<span class="op" id="8133043">*</span><span class="ident" id="8133044">testing</span><span class="op" id="8133051">.</span><span class="ident" id="8133052">T</span><span class="op" id="8133053">)</span>&nbsp;<span class="op" id="8133055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8133058">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133086">src</span>&nbsp;<span class="op" id="8133090">:=</span>&nbsp;<span class="ident" id="8133093">image</span><span class="op" id="8133098">.</span><span class="ident" id="8133099">NewRGBA</span><span class="op" id="8133106">(</span><span class="ident" id="8133107">image</span><span class="op" id="8133112">.</span><span class="ident" id="8133113">Rect</span><span class="op" id="8133117">(</span><span class="num" id="8133118">0</span><span class="op" id="8133119">,</span>&nbsp;<span class="num" id="8133121">0</span><span class="op" id="8133122">,</span>&nbsp;<span class="num" id="8133124">1</span><span class="op" id="8133125">,</span>&nbsp;<span class="num" id="8133127">1</span><span class="op" id="8133128">)</span><span class="op" id="8133129">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133132">src</span><span class="op" id="8133135">.</span><span class="ident" id="8133136">Set</span><span class="op" id="8133139">(</span><span class="num" id="8133140">0</span><span class="op" id="8133141">,</span>&nbsp;<span class="num" id="8133143">0</span><span class="op" id="8133144">,</span>&nbsp;<span class="ident" id="8133146">color</span><span class="op" id="8133151">.</span><span class="ident" id="8133152">RGBA</span><span class="op" id="8133156">{</span><span class="num" id="8133157">0xff</span><span class="op" id="8133161">,</span>&nbsp;<span class="num" id="8133163">0x00</span><span class="op" id="8133167">,</span>&nbsp;<span class="num" id="8133169">0x00</span><span class="op" id="8133173">,</span>&nbsp;<span class="num" id="8133175">0xff</span><span class="op" id="8133179">}</span><span class="op" id="8133180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133183">buf</span>&nbsp;<span class="op" id="8133187">:=</span>&nbsp;<span class="builtinfunc" id="8133190">new</span><span class="op" id="8133193">(</span><span class="ident" id="8133194">bytes</span><span class="op" id="8133199">.</span><span class="ident" id="8133200">Buffer</span><span class="op" id="8133206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8133209">if</span>&nbsp;<span class="ident" id="8133212">err</span>&nbsp;<span class="op" id="8133216">:=</span>&nbsp;<span class="ident" id="8133219">Encode</span><span class="op" id="8133225">(</span><span class="ident" id="8133226">buf</span><span class="op" id="8133229">,</span>&nbsp;<span class="ident" id="8133231">src</span><span class="op" id="8133234">,</span>&nbsp;<span class="ident" id="8133236">nil</span><span class="op" id="8133239">)</span><span class="op" id="8133240">;</span>&nbsp;<span class="ident" id="8133242">err</span>&nbsp;<span class="op" id="8133246">!=</span>&nbsp;<span class="ident" id="8133249">nil</span>&nbsp;<span class="op" id="8133253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133257">t</span><span class="op" id="8133258">.</span><span class="ident" id="8133259">Fatalf</span><span class="op" id="8133265">(</span><span class="string" id="8133266">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="8133278">,</span>&nbsp;<span class="ident" id="8133280">err</span><span class="op" id="8133283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8133286">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133289">enc</span>&nbsp;<span class="op" id="8133293">:=</span>&nbsp;<span class="ident" id="8133296">buf</span><span class="op" id="8133299">.</span><span class="ident" id="8133300">String</span><span class="op" id="8133306">(</span><span class="op" id="8133307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8133310">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8133383">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8133455">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8133492">if</span>&nbsp;<span class="builtinfunc" id="8133495">len</span><span class="op" id="8133498">(</span><span class="ident" id="8133499">enc</span><span class="op" id="8133502">)</span>&nbsp;<span class="op" id="8133504">&lt;</span>&nbsp;<span class="num" id="8133506">64</span>&nbsp;<span class="op" id="8133509">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133513">t</span><span class="op" id="8133514">.</span><span class="ident" id="8133515">Fatalf</span><span class="op" id="8133521">(</span><span class="string" id="8133522">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="8133559">,</span>&nbsp;<span class="builtinfunc" id="8133561">len</span><span class="op" id="8133564">(</span><span class="ident" id="8133565">enc</span><span class="op" id="8133568">)</span><span class="op" id="8133569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8133572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8133575">if</span>&nbsp;<span class="ident" id="8133578">got</span><span class="op" id="8133581">,</span>&nbsp;<span class="ident" id="8133583">want</span>&nbsp;<span class="op" id="8133588">:=</span>&nbsp;<span class="ident" id="8133591">enc</span><span class="op" id="8133594">[</span><span class="builtinfunc" id="8133595">len</span><span class="op" id="8133598">(</span><span class="ident" id="8133599">enc</span><span class="op" id="8133602">)</span><span class="op" id="8133603">-</span><span class="num" id="8133604">2</span><span class="op" id="8133605">:</span><span class="op" id="8133606">]</span><span class="op" id="8133607">,</span>&nbsp;<span class="string" id="8133609">&#34;\xff\xd9&#34;</span><span class="op" id="8133619">;</span>&nbsp;<span class="ident" id="8133621">got</span>&nbsp;<span class="op" id="8133625">!=</span>&nbsp;<span class="ident" id="8133628">want</span>&nbsp;<span class="op" id="8133633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133637">t</span><span class="op" id="8133638">.</span><span class="ident" id="8133639">Fatalf</span><span class="op" id="8133645">(</span><span class="string" id="8133646">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8133682">,</span>&nbsp;<span class="ident" id="8133684">got</span><span class="op" id="8133687">,</span>&nbsp;<span class="ident" id="8133689">want</span><span class="op" id="8133693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8133696">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8133699">if</span>&nbsp;<span class="ident" id="8133702">s</span>&nbsp;<span class="op" id="8133704">:=</span>&nbsp;<span class="ident" id="8133707">enc</span><span class="op" id="8133710">[</span><span class="builtinfunc" id="8133711">len</span><span class="op" id="8133714">(</span><span class="ident" id="8133715">enc</span><span class="op" id="8133718">)</span><span class="op" id="8133719">-</span><span class="num" id="8133720">64</span><span class="op" id="8133722">:</span><span class="op" id="8133723">]</span><span class="op" id="8133724">;</span>&nbsp;<span class="op" id="8133726">!</span><span class="ident" id="8133727">strings</span><span class="op" id="8133734">.</span><span class="ident" id="8133735">Contains</span><span class="op" id="8133743">(</span><span class="ident" id="8133744">s</span><span class="op" id="8133745">,</span>&nbsp;<span class="string" id="8133747">&#34;\xff\xda&#34;</span><span class="op" id="8133757">)</span>&nbsp;<span class="op" id="8133759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133763">t</span><span class="op" id="8133764">.</span><span class="ident" id="8133765">Fatalf</span><span class="op" id="8133771">(</span><span class="string" id="8133772">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="8133842">,</span>&nbsp;<span class="ident" id="8133844">s</span><span class="op" id="8133845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8133848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8133851">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8133920">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8133965">rnd</span>&nbsp;<span class="op" id="8133969">:=</span>&nbsp;<span class="ident" id="8133972">rand</span><span class="op" id="8133976">.</span><span class="ident" id="8133977">New</span><span class="op" id="8133980">(</span><span class="ident" id="8133981">rand</span><span class="op" id="8133985">.</span><span class="ident" id="8133986">NewSource</span><span class="op" id="8133995">(</span><span class="num" id="8133996">1</span><span class="op" id="8133997">)</span><span class="op" id="8133998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134001">for</span>&nbsp;<span class="ident" id="8134005">i</span><span class="op" id="8134006">,</span>&nbsp;<span class="ident" id="8134008">nerr</span>&nbsp;<span class="op" id="8134013">:=</span>&nbsp;<span class="num" id="8134016">0</span><span class="op" id="8134017">,</span>&nbsp;<span class="num" id="8134019">0</span><span class="op" id="8134020">;</span>&nbsp;<span class="ident" id="8134022">i</span>&nbsp;<span class="op" id="8134024">&lt;</span>&nbsp;<span class="num" id="8134026">1000</span>&nbsp;<span class="op" id="8134031">&amp;&amp;</span>&nbsp;<span class="ident" id="8134034">nerr</span>&nbsp;<span class="op" id="8134039">&lt;</span>&nbsp;<span class="num" id="8134041">10</span><span class="op" id="8134043">;</span>&nbsp;<span class="ident" id="8134045">i</span><span class="op" id="8134046">++</span>&nbsp;<span class="op" id="8134049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134053">buf</span><span class="op" id="8134056">.</span><span class="ident" id="8134057">Reset</span><span class="op" id="8134062">(</span><span class="op" id="8134063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8134067">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134122">buf</span><span class="op" id="8134125">.</span><span class="ident" id="8134126">WriteString</span><span class="op" id="8134137">(</span><span class="ident" id="8134138">enc</span><span class="op" id="8134141">[</span><span class="op" id="8134142">:</span><span class="builtinfunc" id="8134143">len</span><span class="op" id="8134146">(</span><span class="ident" id="8134147">enc</span><span class="op" id="8134150">)</span><span class="op" id="8134151">-</span><span class="num" id="8134152">2</span><span class="op" id="8134153">]</span><span class="op" id="8134154">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8134158">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134198">for</span>&nbsp;<span class="ident" id="8134202">n</span>&nbsp;<span class="op" id="8134204">:=</span>&nbsp;<span class="ident" id="8134207">rnd</span><span class="op" id="8134210">.</span><span class="ident" id="8134211">Intn</span><span class="op" id="8134215">(</span><span class="num" id="8134216">10</span><span class="op" id="8134218">)</span><span class="op" id="8134219">;</span>&nbsp;<span class="ident" id="8134221">n</span>&nbsp;<span class="op" id="8134223">&gt;</span>&nbsp;<span class="num" id="8134225">0</span><span class="op" id="8134226">;</span>&nbsp;<span class="ident" id="8134228">n</span><span class="op" id="8134229">--</span>&nbsp;<span class="op" id="8134232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134237">if</span>&nbsp;<span class="ident" id="8134240">x</span>&nbsp;<span class="op" id="8134242">:=</span>&nbsp;<span class="builtintype" id="8134245">byte</span><span class="op" id="8134249">(</span><span class="ident" id="8134250">rnd</span><span class="op" id="8134253">.</span><span class="ident" id="8134254">Intn</span><span class="op" id="8134258">(</span><span class="num" id="8134259">256</span><span class="op" id="8134262">)</span><span class="op" id="8134263">)</span><span class="op" id="8134264">;</span>&nbsp;<span class="ident" id="8134266">x</span>&nbsp;<span class="op" id="8134268">!=</span>&nbsp;<span class="num" id="8134271">0xff</span>&nbsp;<span class="op" id="8134276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134282">buf</span><span class="op" id="8134285">.</span><span class="ident" id="8134286">WriteByte</span><span class="op" id="8134295">(</span><span class="ident" id="8134296">x</span><span class="op" id="8134297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8134302">}</span>&nbsp;<span class="keyword" id="8134304">else</span>&nbsp;<span class="op" id="8134309">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8134315">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134382">buf</span><span class="op" id="8134385">.</span><span class="ident" id="8134386">WriteString</span><span class="op" id="8134397">(</span><span class="string" id="8134398">&#34;\xff\x00&#34;</span><span class="op" id="8134408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8134413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8134417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8134421">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134459">buf</span><span class="op" id="8134462">.</span><span class="ident" id="8134463">WriteString</span><span class="op" id="8134474">(</span><span class="string" id="8134475">&#34;\xff\xd9&#34;</span><span class="op" id="8134485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8134490">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134547">got</span><span class="op" id="8134550">,</span>&nbsp;<span class="ident" id="8134552">err</span>&nbsp;<span class="op" id="8134556">:=</span>&nbsp;<span class="ident" id="8134559">Decode</span><span class="op" id="8134565">(</span><span class="ident" id="8134566">buf</span><span class="op" id="8134569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134573">if</span>&nbsp;<span class="ident" id="8134576">err</span>&nbsp;<span class="op" id="8134580">!=</span>&nbsp;<span class="ident" id="8134583">nil</span>&nbsp;<span class="op" id="8134587">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134592">t</span><span class="op" id="8134593">.</span><span class="ident" id="8134594">Errorf</span><span class="op" id="8134600">(</span><span class="string" id="8134601">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="8134633">,</span>&nbsp;<span class="ident" id="8134635">i</span><span class="op" id="8134636">,</span>&nbsp;<span class="ident" id="8134638">err</span><span class="op" id="8134641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134646">nerr</span><span class="op" id="8134650">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134656">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8134667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134671">if</span>&nbsp;<span class="ident" id="8134674">got</span><span class="op" id="8134677">.</span><span class="ident" id="8134678">Bounds</span><span class="op" id="8134684">(</span><span class="op" id="8134685">)</span>&nbsp;<span class="op" id="8134687">!=</span>&nbsp;<span class="ident" id="8134690">src</span><span class="op" id="8134693">.</span><span class="ident" id="8134694">Bounds</span><span class="op" id="8134700">(</span><span class="op" id="8134701">)</span>&nbsp;<span class="op" id="8134703">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134708">t</span><span class="op" id="8134709">.</span><span class="ident" id="8134710">Errorf</span><span class="op" id="8134716">(</span><span class="string" id="8134717">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="8134754">,</span>&nbsp;<span class="ident" id="8134756">i</span><span class="op" id="8134757">,</span>&nbsp;<span class="ident" id="8134759">got</span><span class="op" id="8134762">.</span><span class="ident" id="8134763">Bounds</span><span class="op" id="8134769">(</span><span class="op" id="8134770">)</span><span class="op" id="8134771">,</span>&nbsp;<span class="ident" id="8134773">src</span><span class="op" id="8134776">.</span><span class="ident" id="8134777">Bounds</span><span class="op" id="8134783">(</span><span class="op" id="8134784">)</span><span class="op" id="8134785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134790">nerr</span><span class="op" id="8134794">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134800">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8134811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134815">if</span>&nbsp;<span class="ident" id="8134818">averageDelta</span><span class="op" id="8134830">(</span><span class="ident" id="8134831">got</span><span class="op" id="8134834">,</span>&nbsp;<span class="ident" id="8134836">src</span><span class="op" id="8134839">)</span>&nbsp;<span class="op" id="8134841">&gt;</span>&nbsp;<span class="num" id="8134843">2</span><span class="op" id="8134844">&lt;&lt;</span><span class="num" id="8134846">8</span>&nbsp;<span class="op" id="8134848">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134853">t</span><span class="op" id="8134854">.</span><span class="ident" id="8134855">Errorf</span><span class="op" id="8134861">(</span><span class="string" id="8134862">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="8134909">,</span>&nbsp;<span class="ident" id="8134911">i</span><span class="op" id="8134912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8134917">nerr</span><span class="op" id="8134921">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8134927">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8134938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8134941">}</span><br>
<span class="lineno">245</span><span class="op" id="8134943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8134946">func</span>&nbsp;<span class="ident" id="8134951">benchmarkDecode</span><span class="op" id="8134966">(</span><span class="ident" id="8134967">b</span>&nbsp;<span class="op" id="8134969">*</span><span class="ident" id="8134970">testing</span><span class="op" id="8134977">.</span><span class="ident" id="8134978">B</span><span class="op" id="8134979">,</span>&nbsp;<span class="ident" id="8134981">filename</span>&nbsp;<span class="builtintype" id="8134990">string</span><span class="op" id="8134996">)</span>&nbsp;<span class="op" id="8134998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135001">b</span><span class="op" id="8135002">.</span><span class="ident" id="8135003">StopTimer</span><span class="op" id="8135012">(</span><span class="op" id="8135013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135016">data</span><span class="op" id="8135020">,</span>&nbsp;<span class="ident" id="8135022">err</span>&nbsp;<span class="op" id="8135026">:=</span>&nbsp;<span class="ident" id="8135029">ioutil</span><span class="op" id="8135035">.</span><span class="ident" id="8135036">ReadFile</span><span class="op" id="8135044">(</span><span class="ident" id="8135045">filename</span><span class="op" id="8135053">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8135056">if</span>&nbsp;<span class="ident" id="8135059">err</span>&nbsp;<span class="op" id="8135063">!=</span>&nbsp;<span class="ident" id="8135066">nil</span>&nbsp;<span class="op" id="8135070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135074">b</span><span class="op" id="8135075">.</span><span class="ident" id="8135076">Fatal</span><span class="op" id="8135081">(</span><span class="ident" id="8135082">err</span><span class="op" id="8135085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8135088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135091">cfg</span><span class="op" id="8135094">,</span>&nbsp;<span class="ident" id="8135096">err</span>&nbsp;<span class="op" id="8135100">:=</span>&nbsp;<span class="ident" id="8135103">DecodeConfig</span><span class="op" id="8135115">(</span><span class="ident" id="8135116">bytes</span><span class="op" id="8135121">.</span><span class="ident" id="8135122">NewReader</span><span class="op" id="8135131">(</span><span class="ident" id="8135132">data</span><span class="op" id="8135136">)</span><span class="op" id="8135137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8135140">if</span>&nbsp;<span class="ident" id="8135143">err</span>&nbsp;<span class="op" id="8135147">!=</span>&nbsp;<span class="ident" id="8135150">nil</span>&nbsp;<span class="op" id="8135154">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135158">b</span><span class="op" id="8135159">.</span><span class="ident" id="8135160">Fatal</span><span class="op" id="8135165">(</span><span class="ident" id="8135166">err</span><span class="op" id="8135169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8135172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135175">b</span><span class="op" id="8135176">.</span><span class="ident" id="8135177">SetBytes</span><span class="op" id="8135185">(</span><span class="ident" id="8135186">int64</span><span class="op" id="8135191">(</span><span class="ident" id="8135192">cfg</span><span class="op" id="8135195">.</span><span class="ident" id="8135196">Width</span>&nbsp;<span class="op" id="8135202">*</span>&nbsp;<span class="ident" id="8135204">cfg</span><span class="op" id="8135207">.</span><span class="ident" id="8135208">Height</span>&nbsp;<span class="op" id="8135215">*</span>&nbsp;<span class="num" id="8135217">4</span><span class="op" id="8135218">)</span><span class="op" id="8135219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135222">b</span><span class="op" id="8135223">.</span><span class="ident" id="8135224">StartTimer</span><span class="op" id="8135234">(</span><span class="op" id="8135235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8135238">for</span>&nbsp;<span class="ident" id="8135242">i</span>&nbsp;<span class="op" id="8135244">:=</span>&nbsp;<span class="num" id="8135247">0</span><span class="op" id="8135248">;</span>&nbsp;<span class="ident" id="8135250">i</span>&nbsp;<span class="op" id="8135252">&lt;</span>&nbsp;<span class="ident" id="8135254">b</span><span class="op" id="8135255">.</span><span class="ident" id="8135256">N</span><span class="op" id="8135257">;</span>&nbsp;<span class="ident" id="8135259">i</span><span class="op" id="8135260">++</span>&nbsp;<span class="op" id="8135263">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135267">Decode</span><span class="op" id="8135273">(</span><span class="ident" id="8135274">bytes</span><span class="op" id="8135279">.</span><span class="ident" id="8135280">NewReader</span><span class="op" id="8135289">(</span><span class="ident" id="8135290">data</span><span class="op" id="8135294">)</span><span class="op" id="8135295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8135298">}</span><br>
<span class="lineno"></span><span class="op" id="8135300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8135303">func</span>&nbsp;<span class="ident" id="8135308">BenchmarkDecodeBaseline</span><span class="op" id="8135331">(</span><span class="ident" id="8135332">b</span>&nbsp;<span class="op" id="8135334">*</span><span class="ident" id="8135335">testing</span><span class="op" id="8135342">.</span><span class="ident" id="8135343">B</span><span class="op" id="8135344">)</span>&nbsp;<span class="op" id="8135346">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135349">benchmarkDecode</span><span class="op" id="8135364">(</span><span class="ident" id="8135365">b</span><span class="op" id="8135366">,</span>&nbsp;<span class="string" id="8135368">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="8135396">)</span><br>
<span class="lineno"></span><span class="op" id="8135398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8135401">func</span>&nbsp;<span class="ident" id="8135406">BenchmarkDecodeProgressive</span><span class="op" id="8135432">(</span><span class="ident" id="8135433">b</span>&nbsp;<span class="op" id="8135435">*</span><span class="ident" id="8135436">testing</span><span class="op" id="8135443">.</span><span class="ident" id="8135444">B</span><span class="op" id="8135445">)</span>&nbsp;<span class="op" id="8135447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8135450">benchmarkDecode</span><span class="op" id="8135465">(</span><span class="ident" id="8135466">b</span><span class="op" id="8135467">,</span>&nbsp;<span class="string" id="8135469">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="8135509">)</span><br>
<span class="lineno">270</span><span class="op" id="8135511">}</span>
</div>
</body>
</html>
