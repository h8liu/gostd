<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>bufio</h2>
<ul>
<li><a href="/gostd/bufio/bufio.go.html">bufio.go</a></li>
<li><a href="/gostd/bufio/bufio_test.go.html">bufio_test.go</a></li>
<li><a href="/gostd/bufio/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/bufio/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/bufio/scan.go.html">scan.go</a></li>
<li><a href="/gostd/bufio/scan_test.go.html">scan_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3837880">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3837935">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3837989">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3838040">//&nbsp;Package&nbsp;bufio&nbsp;implements&nbsp;buffered&nbsp;I/O.&nbsp;&nbsp;It&nbsp;wraps&nbsp;an&nbsp;io.Reader&nbsp;or&nbsp;io.Writer</span><br>
<span class="lineno"></span><span class="comment" id="3838118">//&nbsp;object,&nbsp;creating&nbsp;another&nbsp;object&nbsp;(Reader&nbsp;or&nbsp;Writer)&nbsp;that&nbsp;also&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="3838193">//&nbsp;the&nbsp;interface&nbsp;but&nbsp;provides&nbsp;buffering&nbsp;and&nbsp;some&nbsp;help&nbsp;for&nbsp;textual&nbsp;I/O.</span><br>
<span class="lineno"></span><span class="keyword" id="3838264">package</span>&nbsp;<span class="ident" id="3838272">bufio</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3838279">import</span>&nbsp;<span class="op" id="3838286">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3838289">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3838298">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3838308">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3838314">&#34;unicode/utf8&#34;</span><br>
<span class="lineno">15</span><span class="op" id="3838329">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3838332">const</span>&nbsp;<span class="op" id="3838338">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838341">defaultBufSize</span>&nbsp;<span class="op" id="3838356">=</span>&nbsp;<span class="num" id="3838358">4096</span><br>
<span class="lineno"></span><span class="op" id="3838363">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3838366">var</span>&nbsp;<span class="op" id="3838370">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838373">ErrInvalidUnreadByte</span>&nbsp;<span class="op" id="3838394">=</span>&nbsp;<span class="ident" id="3838396">errors</span><span class="op" id="3838402">.</span><span class="ident" id="3838403">New</span><span class="op" id="3838406">(</span><span class="string" id="3838407">&#34;bufio:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;UnreadByte&#34;</span><span class="op" id="3838441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838444">ErrInvalidUnreadRune</span>&nbsp;<span class="op" id="3838465">=</span>&nbsp;<span class="ident" id="3838467">errors</span><span class="op" id="3838473">.</span><span class="ident" id="3838474">New</span><span class="op" id="3838477">(</span><span class="string" id="3838478">&#34;bufio:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;UnreadRune&#34;</span><span class="op" id="3838512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838515">ErrBufferFull</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3838536">=</span>&nbsp;<span class="ident" id="3838538">errors</span><span class="op" id="3838544">.</span><span class="ident" id="3838545">New</span><span class="op" id="3838548">(</span><span class="string" id="3838549">&#34;bufio:&nbsp;buffer&nbsp;full&#34;</span><span class="op" id="3838569">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838572">ErrNegativeCount</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3838593">=</span>&nbsp;<span class="ident" id="3838595">errors</span><span class="op" id="3838601">.</span><span class="ident" id="3838602">New</span><span class="op" id="3838605">(</span><span class="string" id="3838606">&#34;bufio:&nbsp;negative&nbsp;count&#34;</span><span class="op" id="3838629">)</span><br>
<span class="lineno"></span><span class="op" id="3838631">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3838634">//&nbsp;Buffered&nbsp;input.</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="3838654">//&nbsp;Reader&nbsp;implements&nbsp;buffering&nbsp;for&nbsp;an&nbsp;io.Reader&nbsp;object.</span><br>
<span class="lineno"></span><span class="keyword" id="3838710">type</span>&nbsp;<span class="ident" id="3838715">Reader</span>&nbsp;<span class="keyword" id="3838722">struct</span>&nbsp;<span class="op" id="3838729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838732">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3838745">[</span><span class="op" id="3838746">]</span><span class="builtintype" id="3838747">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838753">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838766">io</span><span class="op" id="3838768">.</span><span class="ident" id="3838769">Reader</span>&nbsp;<span class="comment" id="3838776">//&nbsp;reader&nbsp;provided&nbsp;by&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838810">r</span><span class="op" id="3838811">,</span>&nbsp;<span class="ident" id="3838813">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3838823">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3838833">//&nbsp;buf&nbsp;read&nbsp;and&nbsp;write&nbsp;positions</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838866">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3838879">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838886">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3838899">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838904">lastRuneSize</span>&nbsp;<span class="builtintype" id="3838917">int</span><br>
<span class="lineno"></span><span class="op" id="3838921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="3838924">const</span>&nbsp;<span class="ident" id="3838930">minReadBufferSize</span>&nbsp;<span class="op" id="3838948">=</span>&nbsp;<span class="num" id="3838950">16</span><br>
<span class="lineno"></span><span class="keyword" id="3838953">const</span>&nbsp;<span class="ident" id="3838959">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="3838984">=</span>&nbsp;<span class="num" id="3838986">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3838991">//&nbsp;NewReaderSize&nbsp;returns&nbsp;a&nbsp;new&nbsp;Reader&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;at&nbsp;least&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="3839069">//&nbsp;size.&nbsp;If&nbsp;the&nbsp;argument&nbsp;io.Reader&nbsp;is&nbsp;already&nbsp;a&nbsp;Reader&nbsp;with&nbsp;large&nbsp;enough</span><br>
<span class="lineno">45</span><span class="comment" id="3839142">//&nbsp;size,&nbsp;it&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;Reader.</span><br>
<span class="lineno"></span><span class="keyword" id="3839185">func</span>&nbsp;<span class="ident" id="3839190">NewReaderSize</span><span class="op" id="3839203">(</span><span class="ident" id="3839204">rd</span>&nbsp;<span class="ident" id="3839207">io</span><span class="op" id="3839209">.</span><span class="ident" id="3839210">Reader</span><span class="op" id="3839216">,</span>&nbsp;<span class="ident" id="3839218">size</span>&nbsp;<span class="builtintype" id="3839223">int</span><span class="op" id="3839226">)</span>&nbsp;<span class="op" id="3839228">*</span><span class="ident" id="3839229">Reader</span>&nbsp;<span class="op" id="3839236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3839239">//&nbsp;Is&nbsp;it&nbsp;already&nbsp;a&nbsp;Reader?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839267">b</span><span class="op" id="3839268">,</span>&nbsp;<span class="ident" id="3839270">ok</span>&nbsp;<span class="op" id="3839273">:=</span>&nbsp;<span class="ident" id="3839276">rd</span><span class="op" id="3839278">.</span><span class="op" id="3839279">(</span><span class="op" id="3839280">*</span><span class="ident" id="3839281">Reader</span><span class="op" id="3839287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839290">if</span>&nbsp;<span class="ident" id="3839293">ok</span>&nbsp;<span class="op" id="3839296">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3839299">len</span><span class="op" id="3839302">(</span><span class="ident" id="3839303">b</span><span class="op" id="3839304">.</span><span class="ident" id="3839305">buf</span><span class="op" id="3839308">)</span>&nbsp;<span class="op" id="3839310">&gt;=</span>&nbsp;<span class="ident" id="3839313">size</span>&nbsp;<span class="op" id="3839318">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839322">return</span>&nbsp;<span class="ident" id="3839329">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839335">if</span>&nbsp;<span class="ident" id="3839338">size</span>&nbsp;<span class="op" id="3839343">&lt;</span>&nbsp;<span class="ident" id="3839345">minReadBufferSize</span>&nbsp;<span class="op" id="3839363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839367">size</span>&nbsp;<span class="op" id="3839372">=</span>&nbsp;<span class="ident" id="3839374">minReadBufferSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839393">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839396">r</span>&nbsp;<span class="op" id="3839398">:=</span>&nbsp;<span class="builtinfunc" id="3839401">new</span><span class="op" id="3839404">(</span><span class="ident" id="3839405">Reader</span><span class="op" id="3839411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839414">r</span><span class="op" id="3839415">.</span><span class="ident" id="3839416">reset</span><span class="op" id="3839421">(</span><span class="builtinfunc" id="3839422">make</span><span class="op" id="3839426">(</span><span class="op" id="3839427">[</span><span class="op" id="3839428">]</span><span class="builtintype" id="3839429">byte</span><span class="op" id="3839433">,</span>&nbsp;<span class="ident" id="3839435">size</span><span class="op" id="3839439">)</span><span class="op" id="3839440">,</span>&nbsp;<span class="ident" id="3839442">rd</span><span class="op" id="3839444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839447">return</span>&nbsp;<span class="ident" id="3839454">r</span><br>
<span class="lineno"></span><span class="op" id="3839456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3839459">//&nbsp;NewReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;Reader&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;the&nbsp;default&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="3839528">func</span>&nbsp;<span class="ident" id="3839533">NewReader</span><span class="op" id="3839542">(</span><span class="ident" id="3839543">rd</span>&nbsp;<span class="ident" id="3839546">io</span><span class="op" id="3839548">.</span><span class="ident" id="3839549">Reader</span><span class="op" id="3839555">)</span>&nbsp;<span class="op" id="3839557">*</span><span class="ident" id="3839558">Reader</span>&nbsp;<span class="op" id="3839565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839568">return</span>&nbsp;<span class="ident" id="3839575">NewReaderSize</span><span class="op" id="3839588">(</span><span class="ident" id="3839589">rd</span><span class="op" id="3839591">,</span>&nbsp;<span class="ident" id="3839593">defaultBufSize</span><span class="op" id="3839607">)</span><br>
<span class="lineno"></span><span class="op" id="3839609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3839612">//&nbsp;Reset&nbsp;discards&nbsp;any&nbsp;buffered&nbsp;data,&nbsp;resets&nbsp;all&nbsp;state,&nbsp;and&nbsp;switches</span><br>
<span class="lineno"></span><span class="comment" id="3839680">//&nbsp;the&nbsp;buffered&nbsp;reader&nbsp;to&nbsp;read&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="3839719">func</span>&nbsp;<span class="op" id="3839724">(</span><span class="ident" id="3839725">b</span>&nbsp;<span class="op" id="3839727">*</span><span class="ident" id="3839728">Reader</span><span class="op" id="3839734">)</span>&nbsp;<span class="ident" id="3839736">Reset</span><span class="op" id="3839741">(</span><span class="ident" id="3839742">r</span>&nbsp;<span class="ident" id="3839744">io</span><span class="op" id="3839746">.</span><span class="ident" id="3839747">Reader</span><span class="op" id="3839753">)</span>&nbsp;<span class="op" id="3839755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839758">b</span><span class="op" id="3839759">.</span><span class="ident" id="3839760">reset</span><span class="op" id="3839765">(</span><span class="ident" id="3839766">b</span><span class="op" id="3839767">.</span><span class="ident" id="3839768">buf</span><span class="op" id="3839771">,</span>&nbsp;<span class="ident" id="3839773">r</span><span class="op" id="3839774">)</span><br>
<span class="lineno"></span><span class="op" id="3839776">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3839779">func</span>&nbsp;<span class="op" id="3839784">(</span><span class="ident" id="3839785">b</span>&nbsp;<span class="op" id="3839787">*</span><span class="ident" id="3839788">Reader</span><span class="op" id="3839794">)</span>&nbsp;<span class="ident" id="3839796">reset</span><span class="op" id="3839801">(</span><span class="ident" id="3839802">buf</span>&nbsp;<span class="op" id="3839806">[</span><span class="op" id="3839807">]</span><span class="builtintype" id="3839808">byte</span><span class="op" id="3839812">,</span>&nbsp;<span class="ident" id="3839814">r</span>&nbsp;<span class="ident" id="3839816">io</span><span class="op" id="3839818">.</span><span class="ident" id="3839819">Reader</span><span class="op" id="3839825">)</span>&nbsp;<span class="op" id="3839827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839830">*</span><span class="ident" id="3839831">b</span>&nbsp;<span class="op" id="3839833">=</span>&nbsp;<span class="ident" id="3839835">Reader</span><span class="op" id="3839841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839845">buf</span><span class="op" id="3839848">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839859">buf</span><span class="op" id="3839862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839866">rd</span><span class="op" id="3839868">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839880">r</span><span class="op" id="3839881">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839885">lastByte</span><span class="op" id="3839893">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839899">-</span><span class="num" id="3839900">1</span><span class="op" id="3839901">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839905">lastRuneSize</span><span class="op" id="3839917">:</span>&nbsp;<span class="op" id="3839919">-</span><span class="num" id="3839920">1</span><span class="op" id="3839921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839924">}</span><br>
<span class="lineno"></span><span class="op" id="3839926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3839929">var</span>&nbsp;<span class="ident" id="3839933">errNegativeRead</span>&nbsp;<span class="op" id="3839949">=</span>&nbsp;<span class="ident" id="3839951">errors</span><span class="op" id="3839957">.</span><span class="ident" id="3839958">New</span><span class="op" id="3839961">(</span><span class="string" id="3839962">&#34;bufio:&nbsp;reader&nbsp;returned&nbsp;negative&nbsp;count&nbsp;from&nbsp;Read&#34;</span><span class="op" id="3840011">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3840014">//&nbsp;fill&nbsp;reads&nbsp;a&nbsp;new&nbsp;chunk&nbsp;into&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3840057">func</span>&nbsp;<span class="op" id="3840062">(</span><span class="ident" id="3840063">b</span>&nbsp;<span class="op" id="3840065">*</span><span class="ident" id="3840066">Reader</span><span class="op" id="3840072">)</span>&nbsp;<span class="ident" id="3840074">fill</span><span class="op" id="3840078">(</span><span class="op" id="3840079">)</span>&nbsp;<span class="op" id="3840081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3840084">//&nbsp;Slide&nbsp;existing&nbsp;data&nbsp;to&nbsp;beginning.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840122">if</span>&nbsp;<span class="ident" id="3840125">b</span><span class="op" id="3840126">.</span><span class="ident" id="3840127">r</span>&nbsp;<span class="op" id="3840129">&gt;</span>&nbsp;<span class="num" id="3840131">0</span>&nbsp;<span class="op" id="3840133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3840137">copy</span><span class="op" id="3840141">(</span><span class="ident" id="3840142">b</span><span class="op" id="3840143">.</span><span class="ident" id="3840144">buf</span><span class="op" id="3840147">,</span>&nbsp;<span class="ident" id="3840149">b</span><span class="op" id="3840150">.</span><span class="ident" id="3840151">buf</span><span class="op" id="3840154">[</span><span class="ident" id="3840155">b</span><span class="op" id="3840156">.</span><span class="ident" id="3840157">r</span><span class="op" id="3840158">:</span><span class="ident" id="3840159">b</span><span class="op" id="3840160">.</span><span class="ident" id="3840161">w</span><span class="op" id="3840162">]</span><span class="op" id="3840163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840167">b</span><span class="op" id="3840168">.</span><span class="ident" id="3840169">w</span>&nbsp;<span class="op" id="3840171">-=</span>&nbsp;<span class="ident" id="3840174">b</span><span class="op" id="3840175">.</span><span class="ident" id="3840176">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840180">b</span><span class="op" id="3840181">.</span><span class="ident" id="3840182">r</span>&nbsp;<span class="op" id="3840184">=</span>&nbsp;<span class="num" id="3840186">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840189">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840193">if</span>&nbsp;<span class="ident" id="3840196">b</span><span class="op" id="3840197">.</span><span class="ident" id="3840198">w</span>&nbsp;<span class="op" id="3840200">&gt;=</span>&nbsp;<span class="builtinfunc" id="3840203">len</span><span class="op" id="3840206">(</span><span class="ident" id="3840207">b</span><span class="op" id="3840208">.</span><span class="ident" id="3840209">buf</span><span class="op" id="3840212">)</span>&nbsp;<span class="op" id="3840214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3840218">panic</span><span class="op" id="3840223">(</span><span class="string" id="3840224">&#34;bufio:&nbsp;tried&nbsp;to&nbsp;fill&nbsp;full&nbsp;buffer&#34;</span><span class="op" id="3840258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3840265">//&nbsp;Read&nbsp;new&nbsp;data:&nbsp;try&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840315">for</span>&nbsp;<span class="ident" id="3840319">i</span>&nbsp;<span class="op" id="3840321">:=</span>&nbsp;<span class="ident" id="3840324">maxConsecutiveEmptyReads</span><span class="op" id="3840348">;</span>&nbsp;<span class="ident" id="3840350">i</span>&nbsp;<span class="op" id="3840352">&gt;</span>&nbsp;<span class="num" id="3840354">0</span><span class="op" id="3840355">;</span>&nbsp;<span class="ident" id="3840357">i</span><span class="op" id="3840358">--</span>&nbsp;<span class="op" id="3840361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840365">n</span><span class="op" id="3840366">,</span>&nbsp;<span class="ident" id="3840368">err</span>&nbsp;<span class="op" id="3840372">:=</span>&nbsp;<span class="ident" id="3840375">b</span><span class="op" id="3840376">.</span><span class="ident" id="3840377">rd</span><span class="op" id="3840379">.</span><span class="ident" id="3840380">Read</span><span class="op" id="3840384">(</span><span class="ident" id="3840385">b</span><span class="op" id="3840386">.</span><span class="ident" id="3840387">buf</span><span class="op" id="3840390">[</span><span class="ident" id="3840391">b</span><span class="op" id="3840392">.</span><span class="ident" id="3840393">w</span><span class="op" id="3840394">:</span><span class="op" id="3840395">]</span><span class="op" id="3840396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840400">if</span>&nbsp;<span class="ident" id="3840403">n</span>&nbsp;<span class="op" id="3840405">&lt;</span>&nbsp;<span class="num" id="3840407">0</span>&nbsp;<span class="op" id="3840409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3840414">panic</span><span class="op" id="3840419">(</span><span class="ident" id="3840420">errNegativeRead</span><span class="op" id="3840435">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840443">b</span><span class="op" id="3840444">.</span><span class="ident" id="3840445">w</span>&nbsp;<span class="op" id="3840447">+=</span>&nbsp;<span class="ident" id="3840450">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840454">if</span>&nbsp;<span class="ident" id="3840457">err</span>&nbsp;<span class="op" id="3840461">!=</span>&nbsp;<span class="ident" id="3840464">nil</span>&nbsp;<span class="op" id="3840468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840473">b</span><span class="op" id="3840474">.</span><span class="ident" id="3840475">err</span>&nbsp;<span class="op" id="3840479">=</span>&nbsp;<span class="ident" id="3840481">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840488">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840501">if</span>&nbsp;<span class="ident" id="3840504">n</span>&nbsp;<span class="op" id="3840506">&gt;</span>&nbsp;<span class="num" id="3840508">0</span>&nbsp;<span class="op" id="3840510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840515">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840527">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840530">b</span><span class="op" id="3840531">.</span><span class="ident" id="3840532">err</span>&nbsp;<span class="op" id="3840536">=</span>&nbsp;<span class="ident" id="3840538">io</span><span class="op" id="3840540">.</span><span class="ident" id="3840541">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3840555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3840558">func</span>&nbsp;<span class="op" id="3840563">(</span><span class="ident" id="3840564">b</span>&nbsp;<span class="op" id="3840566">*</span><span class="ident" id="3840567">Reader</span><span class="op" id="3840573">)</span>&nbsp;<span class="ident" id="3840575">readErr</span><span class="op" id="3840582">(</span><span class="op" id="3840583">)</span>&nbsp;<span class="builtintype" id="3840585">error</span>&nbsp;<span class="op" id="3840591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840594">err</span>&nbsp;<span class="op" id="3840598">:=</span>&nbsp;<span class="ident" id="3840601">b</span><span class="op" id="3840602">.</span><span class="ident" id="3840603">err</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840608">b</span><span class="op" id="3840609">.</span><span class="ident" id="3840610">err</span>&nbsp;<span class="op" id="3840614">=</span>&nbsp;<span class="ident" id="3840616">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840621">return</span>&nbsp;<span class="ident" id="3840628">err</span><br>
<span class="lineno"></span><span class="op" id="3840632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3840635">//&nbsp;Peek&nbsp;returns&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes&nbsp;without&nbsp;advancing&nbsp;the&nbsp;reader.&nbsp;The&nbsp;bytes&nbsp;stop</span><br>
<span class="lineno">120</span><span class="comment" id="3840713">//&nbsp;being&nbsp;valid&nbsp;at&nbsp;the&nbsp;next&nbsp;read&nbsp;call.&nbsp;If&nbsp;Peek&nbsp;returns&nbsp;fewer&nbsp;than&nbsp;n&nbsp;bytes,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3840790">//&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining&nbsp;why&nbsp;the&nbsp;read&nbsp;is&nbsp;short.&nbsp;The&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3840862">//&nbsp;ErrBufferFull&nbsp;if&nbsp;n&nbsp;is&nbsp;larger&nbsp;than&nbsp;b&#39;s&nbsp;buffer&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="3840916">func</span>&nbsp;<span class="op" id="3840921">(</span><span class="ident" id="3840922">b</span>&nbsp;<span class="op" id="3840924">*</span><span class="ident" id="3840925">Reader</span><span class="op" id="3840931">)</span>&nbsp;<span class="ident" id="3840933">Peek</span><span class="op" id="3840937">(</span><span class="ident" id="3840938">n</span>&nbsp;<span class="builtintype" id="3840940">int</span><span class="op" id="3840943">)</span>&nbsp;<span class="op" id="3840945">(</span><span class="op" id="3840946">[</span><span class="op" id="3840947">]</span><span class="builtintype" id="3840948">byte</span><span class="op" id="3840952">,</span>&nbsp;<span class="builtintype" id="3840954">error</span><span class="op" id="3840959">)</span>&nbsp;<span class="op" id="3840961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840964">if</span>&nbsp;<span class="ident" id="3840967">n</span>&nbsp;<span class="op" id="3840969">&lt;</span>&nbsp;<span class="num" id="3840971">0</span>&nbsp;<span class="op" id="3840973">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840977">return</span>&nbsp;<span class="ident" id="3840984">nil</span><span class="op" id="3840987">,</span>&nbsp;<span class="ident" id="3840989">ErrNegativeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841010">if</span>&nbsp;<span class="ident" id="3841013">n</span>&nbsp;<span class="op" id="3841015">&gt;</span>&nbsp;<span class="builtinfunc" id="3841017">len</span><span class="op" id="3841020">(</span><span class="ident" id="3841021">b</span><span class="op" id="3841022">.</span><span class="ident" id="3841023">buf</span><span class="op" id="3841026">)</span>&nbsp;<span class="op" id="3841028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841032">return</span>&nbsp;<span class="ident" id="3841039">nil</span><span class="op" id="3841042">,</span>&nbsp;<span class="ident" id="3841044">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841059">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3841062">//&nbsp;0&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;len(b.buf)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841087">for</span>&nbsp;<span class="ident" id="3841091">b</span><span class="op" id="3841092">.</span><span class="ident" id="3841093">w</span><span class="op" id="3841094">-</span><span class="ident" id="3841095">b</span><span class="op" id="3841096">.</span><span class="ident" id="3841097">r</span>&nbsp;<span class="op" id="3841099">&lt;</span>&nbsp;<span class="ident" id="3841101">n</span>&nbsp;<span class="op" id="3841103">&amp;&amp;</span>&nbsp;<span class="ident" id="3841106">b</span><span class="op" id="3841107">.</span><span class="ident" id="3841108">err</span>&nbsp;<span class="op" id="3841112">==</span>&nbsp;<span class="ident" id="3841115">nil</span>&nbsp;<span class="op" id="3841119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841123">b</span><span class="op" id="3841124">.</span><span class="ident" id="3841125">fill</span><span class="op" id="3841129">(</span><span class="op" id="3841130">)</span>&nbsp;<span class="comment" id="3841132">//&nbsp;b.w-b.r&nbsp;&lt;&nbsp;len(b.buf)&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841183">var</span>&nbsp;<span class="ident" id="3841187">err</span>&nbsp;<span class="builtintype" id="3841191">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841198">if</span>&nbsp;<span class="ident" id="3841201">avail</span>&nbsp;<span class="op" id="3841207">:=</span>&nbsp;<span class="ident" id="3841210">b</span><span class="op" id="3841211">.</span><span class="ident" id="3841212">w</span>&nbsp;<span class="op" id="3841214">-</span>&nbsp;<span class="ident" id="3841216">b</span><span class="op" id="3841217">.</span><span class="ident" id="3841218">r</span><span class="op" id="3841219">;</span>&nbsp;<span class="ident" id="3841221">avail</span>&nbsp;<span class="op" id="3841227">&lt;</span>&nbsp;<span class="ident" id="3841229">n</span>&nbsp;<span class="op" id="3841231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3841235">//&nbsp;not&nbsp;enough&nbsp;data&nbsp;in&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841266">n</span>&nbsp;<span class="op" id="3841268">=</span>&nbsp;<span class="ident" id="3841270">avail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841278">err</span>&nbsp;<span class="op" id="3841282">=</span>&nbsp;<span class="ident" id="3841284">b</span><span class="op" id="3841285">.</span><span class="ident" id="3841286">readErr</span><span class="op" id="3841293">(</span><span class="op" id="3841294">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841298">if</span>&nbsp;<span class="ident" id="3841301">err</span>&nbsp;<span class="op" id="3841305">==</span>&nbsp;<span class="ident" id="3841308">nil</span>&nbsp;<span class="op" id="3841312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841317">err</span>&nbsp;<span class="op" id="3841321">=</span>&nbsp;<span class="ident" id="3841323">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841345">return</span>&nbsp;<span class="ident" id="3841352">b</span><span class="op" id="3841353">.</span><span class="ident" id="3841354">buf</span><span class="op" id="3841357">[</span><span class="ident" id="3841358">b</span><span class="op" id="3841359">.</span><span class="ident" id="3841360">r</span>&nbsp;<span class="op" id="3841362">:</span>&nbsp;<span class="ident" id="3841364">b</span><span class="op" id="3841365">.</span><span class="ident" id="3841366">r</span><span class="op" id="3841367">+</span><span class="ident" id="3841368">n</span><span class="op" id="3841369">]</span><span class="op" id="3841370">,</span>&nbsp;<span class="ident" id="3841372">err</span><br>
<span class="lineno">145</span><span class="op" id="3841376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3841379">//&nbsp;Read&nbsp;reads&nbsp;data&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="3841406">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="3841453">//&nbsp;It&nbsp;calls&nbsp;Read&nbsp;at&nbsp;most&nbsp;once&nbsp;on&nbsp;the&nbsp;underlying&nbsp;Reader,</span><br>
<span class="lineno">150</span><span class="comment" id="3841509">//&nbsp;hence&nbsp;n&nbsp;may&nbsp;be&nbsp;less&nbsp;than&nbsp;len(p).</span><br>
<span class="lineno"></span><span class="comment" id="3841545">//&nbsp;At&nbsp;EOF,&nbsp;the&nbsp;count&nbsp;will&nbsp;be&nbsp;zero&nbsp;and&nbsp;err&nbsp;will&nbsp;be&nbsp;io.EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="3841603">func</span>&nbsp;<span class="op" id="3841608">(</span><span class="ident" id="3841609">b</span>&nbsp;<span class="op" id="3841611">*</span><span class="ident" id="3841612">Reader</span><span class="op" id="3841618">)</span>&nbsp;<span class="ident" id="3841620">Read</span><span class="op" id="3841624">(</span><span class="ident" id="3841625">p</span>&nbsp;<span class="op" id="3841627">[</span><span class="op" id="3841628">]</span><span class="builtintype" id="3841629">byte</span><span class="op" id="3841633">)</span>&nbsp;<span class="op" id="3841635">(</span><span class="ident" id="3841636">n</span>&nbsp;<span class="builtintype" id="3841638">int</span><span class="op" id="3841641">,</span>&nbsp;<span class="ident" id="3841643">err</span>&nbsp;<span class="builtintype" id="3841647">error</span><span class="op" id="3841652">)</span>&nbsp;<span class="op" id="3841654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841657">n</span>&nbsp;<span class="op" id="3841659">=</span>&nbsp;<span class="builtinfunc" id="3841661">len</span><span class="op" id="3841664">(</span><span class="ident" id="3841665">p</span><span class="op" id="3841666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841669">if</span>&nbsp;<span class="ident" id="3841672">n</span>&nbsp;<span class="op" id="3841674">==</span>&nbsp;<span class="num" id="3841677">0</span>&nbsp;<span class="op" id="3841679">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841683">return</span>&nbsp;<span class="num" id="3841690">0</span><span class="op" id="3841691">,</span>&nbsp;<span class="ident" id="3841693">b</span><span class="op" id="3841694">.</span><span class="ident" id="3841695">readErr</span><span class="op" id="3841702">(</span><span class="op" id="3841703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841709">if</span>&nbsp;<span class="ident" id="3841712">b</span><span class="op" id="3841713">.</span><span class="ident" id="3841714">r</span>&nbsp;<span class="op" id="3841716">==</span>&nbsp;<span class="ident" id="3841719">b</span><span class="op" id="3841720">.</span><span class="ident" id="3841721">w</span>&nbsp;<span class="op" id="3841723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841727">if</span>&nbsp;<span class="ident" id="3841730">b</span><span class="op" id="3841731">.</span><span class="ident" id="3841732">err</span>&nbsp;<span class="op" id="3841736">!=</span>&nbsp;<span class="ident" id="3841739">nil</span>&nbsp;<span class="op" id="3841743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841748">return</span>&nbsp;<span class="num" id="3841755">0</span><span class="op" id="3841756">,</span>&nbsp;<span class="ident" id="3841758">b</span><span class="op" id="3841759">.</span><span class="ident" id="3841760">readErr</span><span class="op" id="3841767">(</span><span class="op" id="3841768">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841776">if</span>&nbsp;<span class="builtinfunc" id="3841779">len</span><span class="op" id="3841782">(</span><span class="ident" id="3841783">p</span><span class="op" id="3841784">)</span>&nbsp;<span class="op" id="3841786">&gt;=</span>&nbsp;<span class="builtinfunc" id="3841789">len</span><span class="op" id="3841792">(</span><span class="ident" id="3841793">b</span><span class="op" id="3841794">.</span><span class="ident" id="3841795">buf</span><span class="op" id="3841798">)</span>&nbsp;<span class="op" id="3841800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3841805">//&nbsp;Large&nbsp;read,&nbsp;empty&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3841837">//&nbsp;Read&nbsp;directly&nbsp;into&nbsp;p&nbsp;to&nbsp;avoid&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841879">n</span><span class="op" id="3841880">,</span>&nbsp;<span class="ident" id="3841882">b</span><span class="op" id="3841883">.</span><span class="ident" id="3841884">err</span>&nbsp;<span class="op" id="3841888">=</span>&nbsp;<span class="ident" id="3841890">b</span><span class="op" id="3841891">.</span><span class="ident" id="3841892">rd</span><span class="op" id="3841894">.</span><span class="ident" id="3841895">Read</span><span class="op" id="3841899">(</span><span class="ident" id="3841900">p</span><span class="op" id="3841901">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841906">if</span>&nbsp;<span class="ident" id="3841909">n</span>&nbsp;<span class="op" id="3841911">&lt;</span>&nbsp;<span class="num" id="3841913">0</span>&nbsp;<span class="op" id="3841915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3841921">panic</span><span class="op" id="3841926">(</span><span class="ident" id="3841927">errNegativeRead</span><span class="op" id="3841942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841952">if</span>&nbsp;<span class="ident" id="3841955">n</span>&nbsp;<span class="op" id="3841957">&gt;</span>&nbsp;<span class="num" id="3841959">0</span>&nbsp;<span class="op" id="3841961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841967">b</span><span class="op" id="3841968">.</span><span class="ident" id="3841969">lastByte</span>&nbsp;<span class="op" id="3841978">=</span>&nbsp;<span class="builtintype" id="3841980">int</span><span class="op" id="3841983">(</span><span class="ident" id="3841984">p</span><span class="op" id="3841985">[</span><span class="ident" id="3841986">n</span><span class="op" id="3841987">-</span><span class="num" id="3841988">1</span><span class="op" id="3841989">]</span><span class="op" id="3841990">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841996">b</span><span class="op" id="3841997">.</span><span class="ident" id="3841998">lastRuneSize</span>&nbsp;<span class="op" id="3842011">=</span>&nbsp;<span class="op" id="3842013">-</span><span class="num" id="3842014">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842024">return</span>&nbsp;<span class="ident" id="3842031">n</span><span class="op" id="3842032">,</span>&nbsp;<span class="ident" id="3842034">b</span><span class="op" id="3842035">.</span><span class="ident" id="3842036">readErr</span><span class="op" id="3842043">(</span><span class="op" id="3842044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842052">b</span><span class="op" id="3842053">.</span><span class="ident" id="3842054">fill</span><span class="op" id="3842058">(</span><span class="op" id="3842059">)</span>&nbsp;<span class="comment" id="3842061">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842082">if</span>&nbsp;<span class="ident" id="3842085">b</span><span class="op" id="3842086">.</span><span class="ident" id="3842087">r</span>&nbsp;<span class="op" id="3842089">==</span>&nbsp;<span class="ident" id="3842092">b</span><span class="op" id="3842093">.</span><span class="ident" id="3842094">w</span>&nbsp;<span class="op" id="3842096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842101">return</span>&nbsp;<span class="num" id="3842108">0</span><span class="op" id="3842109">,</span>&nbsp;<span class="ident" id="3842111">b</span><span class="op" id="3842112">.</span><span class="ident" id="3842113">readErr</span><span class="op" id="3842120">(</span><span class="op" id="3842121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3842132">//&nbsp;copy&nbsp;as&nbsp;much&nbsp;as&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842159">n</span>&nbsp;<span class="op" id="3842161">=</span>&nbsp;<span class="builtinfunc" id="3842163">copy</span><span class="op" id="3842167">(</span><span class="ident" id="3842168">p</span><span class="op" id="3842169">,</span>&nbsp;<span class="ident" id="3842171">b</span><span class="op" id="3842172">.</span><span class="ident" id="3842173">buf</span><span class="op" id="3842176">[</span><span class="ident" id="3842177">b</span><span class="op" id="3842178">.</span><span class="ident" id="3842179">r</span><span class="op" id="3842180">:</span><span class="ident" id="3842181">b</span><span class="op" id="3842182">.</span><span class="ident" id="3842183">w</span><span class="op" id="3842184">]</span><span class="op" id="3842185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842188">b</span><span class="op" id="3842189">.</span><span class="ident" id="3842190">r</span>&nbsp;<span class="op" id="3842192">+=</span>&nbsp;<span class="ident" id="3842195">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842198">b</span><span class="op" id="3842199">.</span><span class="ident" id="3842200">lastByte</span>&nbsp;<span class="op" id="3842209">=</span>&nbsp;<span class="builtintype" id="3842211">int</span><span class="op" id="3842214">(</span><span class="ident" id="3842215">b</span><span class="op" id="3842216">.</span><span class="ident" id="3842217">buf</span><span class="op" id="3842220">[</span><span class="ident" id="3842221">b</span><span class="op" id="3842222">.</span><span class="ident" id="3842223">r</span><span class="op" id="3842224">-</span><span class="num" id="3842225">1</span><span class="op" id="3842226">]</span><span class="op" id="3842227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842230">b</span><span class="op" id="3842231">.</span><span class="ident" id="3842232">lastRuneSize</span>&nbsp;<span class="op" id="3842245">=</span>&nbsp;<span class="op" id="3842247">-</span><span class="num" id="3842248">1</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842251">return</span>&nbsp;<span class="ident" id="3842258">n</span><span class="op" id="3842259">,</span>&nbsp;<span class="ident" id="3842261">nil</span><br>
<span class="lineno"></span><span class="op" id="3842265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3842268">//&nbsp;ReadByte&nbsp;reads&nbsp;and&nbsp;returns&nbsp;a&nbsp;single&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="3842313">//&nbsp;If&nbsp;no&nbsp;byte&nbsp;is&nbsp;available,&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">190</span><span class="keyword" id="3842359">func</span>&nbsp;<span class="op" id="3842364">(</span><span class="ident" id="3842365">b</span>&nbsp;<span class="op" id="3842367">*</span><span class="ident" id="3842368">Reader</span><span class="op" id="3842374">)</span>&nbsp;<span class="ident" id="3842376">ReadByte</span><span class="op" id="3842384">(</span><span class="op" id="3842385">)</span>&nbsp;<span class="op" id="3842387">(</span><span class="ident" id="3842388">c</span>&nbsp;<span class="builtintype" id="3842390">byte</span><span class="op" id="3842394">,</span>&nbsp;<span class="ident" id="3842396">err</span>&nbsp;<span class="builtintype" id="3842400">error</span><span class="op" id="3842405">)</span>&nbsp;<span class="op" id="3842407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842410">b</span><span class="op" id="3842411">.</span><span class="ident" id="3842412">lastRuneSize</span>&nbsp;<span class="op" id="3842425">=</span>&nbsp;<span class="op" id="3842427">-</span><span class="num" id="3842428">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842431">for</span>&nbsp;<span class="ident" id="3842435">b</span><span class="op" id="3842436">.</span><span class="ident" id="3842437">r</span>&nbsp;<span class="op" id="3842439">==</span>&nbsp;<span class="ident" id="3842442">b</span><span class="op" id="3842443">.</span><span class="ident" id="3842444">w</span>&nbsp;<span class="op" id="3842446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842450">if</span>&nbsp;<span class="ident" id="3842453">b</span><span class="op" id="3842454">.</span><span class="ident" id="3842455">err</span>&nbsp;<span class="op" id="3842459">!=</span>&nbsp;<span class="ident" id="3842462">nil</span>&nbsp;<span class="op" id="3842466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842471">return</span>&nbsp;<span class="num" id="3842478">0</span><span class="op" id="3842479">,</span>&nbsp;<span class="ident" id="3842481">b</span><span class="op" id="3842482">.</span><span class="ident" id="3842483">readErr</span><span class="op" id="3842490">(</span><span class="op" id="3842491">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842499">b</span><span class="op" id="3842500">.</span><span class="ident" id="3842501">fill</span><span class="op" id="3842505">(</span><span class="op" id="3842506">)</span>&nbsp;<span class="comment" id="3842508">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842531">c</span>&nbsp;<span class="op" id="3842533">=</span>&nbsp;<span class="ident" id="3842535">b</span><span class="op" id="3842536">.</span><span class="ident" id="3842537">buf</span><span class="op" id="3842540">[</span><span class="ident" id="3842541">b</span><span class="op" id="3842542">.</span><span class="ident" id="3842543">r</span><span class="op" id="3842544">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842547">b</span><span class="op" id="3842548">.</span><span class="ident" id="3842549">r</span><span class="op" id="3842550">++</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842554">b</span><span class="op" id="3842555">.</span><span class="ident" id="3842556">lastByte</span>&nbsp;<span class="op" id="3842565">=</span>&nbsp;<span class="builtintype" id="3842567">int</span><span class="op" id="3842570">(</span><span class="ident" id="3842571">c</span><span class="op" id="3842572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842575">return</span>&nbsp;<span class="ident" id="3842582">c</span><span class="op" id="3842583">,</span>&nbsp;<span class="ident" id="3842585">nil</span><br>
<span class="lineno"></span><span class="op" id="3842589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3842592">//&nbsp;UnreadByte&nbsp;unreads&nbsp;the&nbsp;last&nbsp;byte.&nbsp;&nbsp;Only&nbsp;the&nbsp;most&nbsp;recently&nbsp;read&nbsp;byte&nbsp;can&nbsp;be&nbsp;unread.</span><br>
<span class="lineno">205</span><span class="keyword" id="3842678">func</span>&nbsp;<span class="op" id="3842683">(</span><span class="ident" id="3842684">b</span>&nbsp;<span class="op" id="3842686">*</span><span class="ident" id="3842687">Reader</span><span class="op" id="3842693">)</span>&nbsp;<span class="ident" id="3842695">UnreadByte</span><span class="op" id="3842705">(</span><span class="op" id="3842706">)</span>&nbsp;<span class="builtintype" id="3842708">error</span>&nbsp;<span class="op" id="3842714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842717">if</span>&nbsp;<span class="ident" id="3842720">b</span><span class="op" id="3842721">.</span><span class="ident" id="3842722">lastByte</span>&nbsp;<span class="op" id="3842731">&lt;</span>&nbsp;<span class="num" id="3842733">0</span>&nbsp;<span class="op" id="3842735">||</span>&nbsp;<span class="ident" id="3842738">b</span><span class="op" id="3842739">.</span><span class="ident" id="3842740">r</span>&nbsp;<span class="op" id="3842742">==</span>&nbsp;<span class="num" id="3842745">0</span>&nbsp;<span class="op" id="3842747">&amp;&amp;</span>&nbsp;<span class="ident" id="3842750">b</span><span class="op" id="3842751">.</span><span class="ident" id="3842752">w</span>&nbsp;<span class="op" id="3842754">&gt;</span>&nbsp;<span class="num" id="3842756">0</span>&nbsp;<span class="op" id="3842758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842762">return</span>&nbsp;<span class="ident" id="3842769">ErrInvalidUnreadByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3842794">//&nbsp;b.r&nbsp;&gt;&nbsp;0&nbsp;||&nbsp;b.w&nbsp;==&nbsp;0</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842818">if</span>&nbsp;<span class="ident" id="3842821">b</span><span class="op" id="3842822">.</span><span class="ident" id="3842823">r</span>&nbsp;<span class="op" id="3842825">&gt;</span>&nbsp;<span class="num" id="3842827">0</span>&nbsp;<span class="op" id="3842829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842833">b</span><span class="op" id="3842834">.</span><span class="ident" id="3842835">r</span><span class="op" id="3842836">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842840">}</span>&nbsp;<span class="keyword" id="3842842">else</span>&nbsp;<span class="op" id="3842847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3842851">//&nbsp;b.r&nbsp;==&nbsp;0&nbsp;&amp;&amp;&nbsp;b.w&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842877">b</span><span class="op" id="3842878">.</span><span class="ident" id="3842879">w</span>&nbsp;<span class="op" id="3842881">=</span>&nbsp;<span class="num" id="3842883">1</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842889">b</span><span class="op" id="3842890">.</span><span class="ident" id="3842891">buf</span><span class="op" id="3842894">[</span><span class="ident" id="3842895">b</span><span class="op" id="3842896">.</span><span class="ident" id="3842897">r</span><span class="op" id="3842898">]</span>&nbsp;<span class="op" id="3842900">=</span>&nbsp;<span class="builtintype" id="3842902">byte</span><span class="op" id="3842906">(</span><span class="ident" id="3842907">b</span><span class="op" id="3842908">.</span><span class="ident" id="3842909">lastByte</span><span class="op" id="3842917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842920">b</span><span class="op" id="3842921">.</span><span class="ident" id="3842922">lastByte</span>&nbsp;<span class="op" id="3842931">=</span>&nbsp;<span class="op" id="3842933">-</span><span class="num" id="3842934">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842937">b</span><span class="op" id="3842938">.</span><span class="ident" id="3842939">lastRuneSize</span>&nbsp;<span class="op" id="3842952">=</span>&nbsp;<span class="op" id="3842954">-</span><span class="num" id="3842955">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842958">return</span>&nbsp;<span class="ident" id="3842965">nil</span><br>
<span class="lineno">220</span><span class="op" id="3842969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3842972">//&nbsp;ReadRune&nbsp;reads&nbsp;a&nbsp;single&nbsp;UTF-8&nbsp;encoded&nbsp;Unicode&nbsp;character&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3843047">//&nbsp;rune&nbsp;and&nbsp;its&nbsp;size&nbsp;in&nbsp;bytes.&nbsp;If&nbsp;the&nbsp;encoded&nbsp;rune&nbsp;is&nbsp;invalid,&nbsp;it&nbsp;consumes&nbsp;one&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="3843131">//&nbsp;and&nbsp;returns&nbsp;unicode.ReplacementChar&nbsp;(U+FFFD)&nbsp;with&nbsp;a&nbsp;size&nbsp;of&nbsp;1.</span><br>
<span class="lineno">225</span><span class="keyword" id="3843197">func</span>&nbsp;<span class="op" id="3843202">(</span><span class="ident" id="3843203">b</span>&nbsp;<span class="op" id="3843205">*</span><span class="ident" id="3843206">Reader</span><span class="op" id="3843212">)</span>&nbsp;<span class="ident" id="3843214">ReadRune</span><span class="op" id="3843222">(</span><span class="op" id="3843223">)</span>&nbsp;<span class="op" id="3843225">(</span><span class="ident" id="3843226">r</span>&nbsp;<span class="builtintype" id="3843228">rune</span><span class="op" id="3843232">,</span>&nbsp;<span class="ident" id="3843234">size</span>&nbsp;<span class="builtintype" id="3843239">int</span><span class="op" id="3843242">,</span>&nbsp;<span class="ident" id="3843244">err</span>&nbsp;<span class="builtintype" id="3843248">error</span><span class="op" id="3843253">)</span>&nbsp;<span class="op" id="3843255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843258">for</span>&nbsp;<span class="ident" id="3843262">b</span><span class="op" id="3843263">.</span><span class="ident" id="3843264">r</span><span class="op" id="3843265">+</span><span class="ident" id="3843266">utf8</span><span class="op" id="3843270">.</span><span class="ident" id="3843271">UTFMax</span>&nbsp;<span class="op" id="3843278">&gt;</span>&nbsp;<span class="ident" id="3843280">b</span><span class="op" id="3843281">.</span><span class="ident" id="3843282">w</span>&nbsp;<span class="op" id="3843284">&amp;&amp;</span>&nbsp;<span class="op" id="3843287">!</span><span class="ident" id="3843288">utf8</span><span class="op" id="3843292">.</span><span class="ident" id="3843293">FullRune</span><span class="op" id="3843301">(</span><span class="ident" id="3843302">b</span><span class="op" id="3843303">.</span><span class="ident" id="3843304">buf</span><span class="op" id="3843307">[</span><span class="ident" id="3843308">b</span><span class="op" id="3843309">.</span><span class="ident" id="3843310">r</span><span class="op" id="3843311">:</span><span class="ident" id="3843312">b</span><span class="op" id="3843313">.</span><span class="ident" id="3843314">w</span><span class="op" id="3843315">]</span><span class="op" id="3843316">)</span>&nbsp;<span class="op" id="3843318">&amp;&amp;</span>&nbsp;<span class="ident" id="3843321">b</span><span class="op" id="3843322">.</span><span class="ident" id="3843323">err</span>&nbsp;<span class="op" id="3843327">==</span>&nbsp;<span class="ident" id="3843330">nil</span>&nbsp;<span class="op" id="3843334">&amp;&amp;</span>&nbsp;<span class="ident" id="3843337">b</span><span class="op" id="3843338">.</span><span class="ident" id="3843339">w</span><span class="op" id="3843340">-</span><span class="ident" id="3843341">b</span><span class="op" id="3843342">.</span><span class="ident" id="3843343">r</span>&nbsp;<span class="op" id="3843345">&lt;</span>&nbsp;<span class="builtinfunc" id="3843347">len</span><span class="op" id="3843350">(</span><span class="ident" id="3843351">b</span><span class="op" id="3843352">.</span><span class="ident" id="3843353">buf</span><span class="op" id="3843356">)</span>&nbsp;<span class="op" id="3843358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843362">b</span><span class="op" id="3843363">.</span><span class="ident" id="3843364">fill</span><span class="op" id="3843368">(</span><span class="op" id="3843369">)</span>&nbsp;<span class="comment" id="3843371">//&nbsp;b.w-b.r&nbsp;&lt;&nbsp;len(buf)&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843419">b</span><span class="op" id="3843420">.</span><span class="ident" id="3843421">lastRuneSize</span>&nbsp;<span class="op" id="3843434">=</span>&nbsp;<span class="op" id="3843436">-</span><span class="num" id="3843437">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843440">if</span>&nbsp;<span class="ident" id="3843443">b</span><span class="op" id="3843444">.</span><span class="ident" id="3843445">r</span>&nbsp;<span class="op" id="3843447">==</span>&nbsp;<span class="ident" id="3843450">b</span><span class="op" id="3843451">.</span><span class="ident" id="3843452">w</span>&nbsp;<span class="op" id="3843454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843458">return</span>&nbsp;<span class="num" id="3843465">0</span><span class="op" id="3843466">,</span>&nbsp;<span class="num" id="3843468">0</span><span class="op" id="3843469">,</span>&nbsp;<span class="ident" id="3843471">b</span><span class="op" id="3843472">.</span><span class="ident" id="3843473">readErr</span><span class="op" id="3843480">(</span><span class="op" id="3843481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843487">r</span><span class="op" id="3843488">,</span>&nbsp;<span class="ident" id="3843490">size</span>&nbsp;<span class="op" id="3843495">=</span>&nbsp;<span class="builtintype" id="3843497">rune</span><span class="op" id="3843501">(</span><span class="ident" id="3843502">b</span><span class="op" id="3843503">.</span><span class="ident" id="3843504">buf</span><span class="op" id="3843507">[</span><span class="ident" id="3843508">b</span><span class="op" id="3843509">.</span><span class="ident" id="3843510">r</span><span class="op" id="3843511">]</span><span class="op" id="3843512">)</span><span class="op" id="3843513">,</span>&nbsp;<span class="num" id="3843515">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843518">if</span>&nbsp;<span class="ident" id="3843521">r</span>&nbsp;<span class="op" id="3843523">&gt;=</span>&nbsp;<span class="num" id="3843526">0x80</span>&nbsp;<span class="op" id="3843531">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843535">r</span><span class="op" id="3843536">,</span>&nbsp;<span class="ident" id="3843538">size</span>&nbsp;<span class="op" id="3843543">=</span>&nbsp;<span class="ident" id="3843545">utf8</span><span class="op" id="3843549">.</span><span class="ident" id="3843550">DecodeRune</span><span class="op" id="3843560">(</span><span class="ident" id="3843561">b</span><span class="op" id="3843562">.</span><span class="ident" id="3843563">buf</span><span class="op" id="3843566">[</span><span class="ident" id="3843567">b</span><span class="op" id="3843568">.</span><span class="ident" id="3843569">r</span><span class="op" id="3843570">:</span><span class="ident" id="3843571">b</span><span class="op" id="3843572">.</span><span class="ident" id="3843573">w</span><span class="op" id="3843574">]</span><span class="op" id="3843575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843581">b</span><span class="op" id="3843582">.</span><span class="ident" id="3843583">r</span>&nbsp;<span class="op" id="3843585">+=</span>&nbsp;<span class="ident" id="3843588">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843594">b</span><span class="op" id="3843595">.</span><span class="ident" id="3843596">lastByte</span>&nbsp;<span class="op" id="3843605">=</span>&nbsp;<span class="builtintype" id="3843607">int</span><span class="op" id="3843610">(</span><span class="ident" id="3843611">b</span><span class="op" id="3843612">.</span><span class="ident" id="3843613">buf</span><span class="op" id="3843616">[</span><span class="ident" id="3843617">b</span><span class="op" id="3843618">.</span><span class="ident" id="3843619">r</span><span class="op" id="3843620">-</span><span class="num" id="3843621">1</span><span class="op" id="3843622">]</span><span class="op" id="3843623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843626">b</span><span class="op" id="3843627">.</span><span class="ident" id="3843628">lastRuneSize</span>&nbsp;<span class="op" id="3843641">=</span>&nbsp;<span class="ident" id="3843643">size</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843649">return</span>&nbsp;<span class="ident" id="3843656">r</span><span class="op" id="3843657">,</span>&nbsp;<span class="ident" id="3843659">size</span><span class="op" id="3843663">,</span>&nbsp;<span class="ident" id="3843665">nil</span><br>
<span class="lineno"></span><span class="op" id="3843669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3843672">//&nbsp;UnreadRune&nbsp;unreads&nbsp;the&nbsp;last&nbsp;rune.&nbsp;&nbsp;If&nbsp;the&nbsp;most&nbsp;recent&nbsp;read&nbsp;operation&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3843747">//&nbsp;the&nbsp;buffer&nbsp;was&nbsp;not&nbsp;a&nbsp;ReadRune,&nbsp;UnreadRune&nbsp;returns&nbsp;an&nbsp;error.&nbsp;&nbsp;(In&nbsp;this</span><br>
<span class="lineno">245</span><span class="comment" id="3843820">//&nbsp;regard&nbsp;it&nbsp;is&nbsp;stricter&nbsp;than&nbsp;UnreadByte,&nbsp;which&nbsp;will&nbsp;unread&nbsp;the&nbsp;last&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="3843894">//&nbsp;from&nbsp;any&nbsp;read&nbsp;operation.)</span><br>
<span class="lineno"></span><span class="keyword" id="3843923">func</span>&nbsp;<span class="op" id="3843928">(</span><span class="ident" id="3843929">b</span>&nbsp;<span class="op" id="3843931">*</span><span class="ident" id="3843932">Reader</span><span class="op" id="3843938">)</span>&nbsp;<span class="ident" id="3843940">UnreadRune</span><span class="op" id="3843950">(</span><span class="op" id="3843951">)</span>&nbsp;<span class="builtintype" id="3843953">error</span>&nbsp;<span class="op" id="3843959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843962">if</span>&nbsp;<span class="ident" id="3843965">b</span><span class="op" id="3843966">.</span><span class="ident" id="3843967">lastRuneSize</span>&nbsp;<span class="op" id="3843980">&lt;</span>&nbsp;<span class="num" id="3843982">0</span>&nbsp;<span class="op" id="3843984">||</span>&nbsp;<span class="ident" id="3843987">b</span><span class="op" id="3843988">.</span><span class="ident" id="3843989">r</span>&nbsp;<span class="op" id="3843991">&lt;</span>&nbsp;<span class="ident" id="3843993">b</span><span class="op" id="3843994">.</span><span class="ident" id="3843995">lastRuneSize</span>&nbsp;<span class="op" id="3844008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844012">return</span>&nbsp;<span class="ident" id="3844019">ErrInvalidUnreadRune</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3844041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844044">b</span><span class="op" id="3844045">.</span><span class="ident" id="3844046">r</span>&nbsp;<span class="op" id="3844048">-=</span>&nbsp;<span class="ident" id="3844051">b</span><span class="op" id="3844052">.</span><span class="ident" id="3844053">lastRuneSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844067">b</span><span class="op" id="3844068">.</span><span class="ident" id="3844069">lastByte</span>&nbsp;<span class="op" id="3844078">=</span>&nbsp;<span class="op" id="3844080">-</span><span class="num" id="3844081">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844084">b</span><span class="op" id="3844085">.</span><span class="ident" id="3844086">lastRuneSize</span>&nbsp;<span class="op" id="3844099">=</span>&nbsp;<span class="op" id="3844101">-</span><span class="num" id="3844102">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844105">return</span>&nbsp;<span class="ident" id="3844112">nil</span><br>
<span class="lineno">255</span><span class="op" id="3844116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3844119">//&nbsp;Buffered&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;that&nbsp;can&nbsp;be&nbsp;read&nbsp;from&nbsp;the&nbsp;current&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3844201">func</span>&nbsp;<span class="op" id="3844206">(</span><span class="ident" id="3844207">b</span>&nbsp;<span class="op" id="3844209">*</span><span class="ident" id="3844210">Reader</span><span class="op" id="3844216">)</span>&nbsp;<span class="ident" id="3844218">Buffered</span><span class="op" id="3844226">(</span><span class="op" id="3844227">)</span>&nbsp;<span class="builtintype" id="3844229">int</span>&nbsp;<span class="op" id="3844233">{</span>&nbsp;<span class="keyword" id="3844235">return</span>&nbsp;<span class="ident" id="3844242">b</span><span class="op" id="3844243">.</span><span class="ident" id="3844244">w</span>&nbsp;<span class="op" id="3844246">-</span>&nbsp;<span class="ident" id="3844248">b</span><span class="op" id="3844249">.</span><span class="ident" id="3844250">r</span>&nbsp;<span class="op" id="3844252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3844255">//&nbsp;ReadSlice&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="3844324">//&nbsp;returning&nbsp;a&nbsp;slice&nbsp;pointing&nbsp;at&nbsp;the&nbsp;bytes&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="3844382">//&nbsp;The&nbsp;bytes&nbsp;stop&nbsp;being&nbsp;valid&nbsp;at&nbsp;the&nbsp;next&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="3844430">//&nbsp;If&nbsp;ReadSlice&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="3844494">//&nbsp;it&nbsp;returns&nbsp;all&nbsp;the&nbsp;data&nbsp;in&nbsp;the&nbsp;buffer&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno">265</span><span class="comment" id="3844572">//&nbsp;ReadSlice&nbsp;fails&nbsp;with&nbsp;error&nbsp;ErrBufferFull&nbsp;if&nbsp;the&nbsp;buffer&nbsp;fills&nbsp;without&nbsp;a&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="3844653">//&nbsp;Because&nbsp;the&nbsp;data&nbsp;returned&nbsp;from&nbsp;ReadSlice&nbsp;will&nbsp;be&nbsp;overwritten</span><br>
<span class="lineno"></span><span class="comment" id="3844717">//&nbsp;by&nbsp;the&nbsp;next&nbsp;I/O&nbsp;operation,&nbsp;most&nbsp;clients&nbsp;should&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="3844771">//&nbsp;ReadBytes&nbsp;or&nbsp;ReadString&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3844807">//&nbsp;ReadSlice&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;line&nbsp;does&nbsp;not&nbsp;end&nbsp;in&nbsp;delim.</span><br>
<span class="lineno">270</span><span class="keyword" id="3844882">func</span>&nbsp;<span class="op" id="3844887">(</span><span class="ident" id="3844888">b</span>&nbsp;<span class="op" id="3844890">*</span><span class="ident" id="3844891">Reader</span><span class="op" id="3844897">)</span>&nbsp;<span class="ident" id="3844899">ReadSlice</span><span class="op" id="3844908">(</span><span class="ident" id="3844909">delim</span>&nbsp;<span class="builtintype" id="3844915">byte</span><span class="op" id="3844919">)</span>&nbsp;<span class="op" id="3844921">(</span><span class="ident" id="3844922">line</span>&nbsp;<span class="op" id="3844927">[</span><span class="op" id="3844928">]</span><span class="builtintype" id="3844929">byte</span><span class="op" id="3844933">,</span>&nbsp;<span class="ident" id="3844935">err</span>&nbsp;<span class="builtintype" id="3844939">error</span><span class="op" id="3844944">)</span>&nbsp;<span class="op" id="3844946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844949">for</span>&nbsp;<span class="op" id="3844953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3844957">//&nbsp;Search&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844977">if</span>&nbsp;<span class="ident" id="3844980">i</span>&nbsp;<span class="op" id="3844982">:=</span>&nbsp;<span class="ident" id="3844985">bytes</span><span class="op" id="3844990">.</span><span class="ident" id="3844991">IndexByte</span><span class="op" id="3845000">(</span><span class="ident" id="3845001">b</span><span class="op" id="3845002">.</span><span class="ident" id="3845003">buf</span><span class="op" id="3845006">[</span><span class="ident" id="3845007">b</span><span class="op" id="3845008">.</span><span class="ident" id="3845009">r</span><span class="op" id="3845010">:</span><span class="ident" id="3845011">b</span><span class="op" id="3845012">.</span><span class="ident" id="3845013">w</span><span class="op" id="3845014">]</span><span class="op" id="3845015">,</span>&nbsp;<span class="ident" id="3845017">delim</span><span class="op" id="3845022">)</span><span class="op" id="3845023">;</span>&nbsp;<span class="ident" id="3845025">i</span>&nbsp;<span class="op" id="3845027">&gt;=</span>&nbsp;<span class="num" id="3845030">0</span>&nbsp;<span class="op" id="3845032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845037">line</span>&nbsp;<span class="op" id="3845042">=</span>&nbsp;<span class="ident" id="3845044">b</span><span class="op" id="3845045">.</span><span class="ident" id="3845046">buf</span><span class="op" id="3845049">[</span><span class="ident" id="3845050">b</span><span class="op" id="3845051">.</span><span class="ident" id="3845052">r</span>&nbsp;<span class="op" id="3845054">:</span>&nbsp;<span class="ident" id="3845056">b</span><span class="op" id="3845057">.</span><span class="ident" id="3845058">r</span><span class="op" id="3845059">+</span><span class="ident" id="3845060">i</span><span class="op" id="3845061">+</span><span class="num" id="3845062">1</span><span class="op" id="3845063">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845068">b</span><span class="op" id="3845069">.</span><span class="ident" id="3845070">r</span>&nbsp;<span class="op" id="3845072">+=</span>&nbsp;<span class="ident" id="3845075">i</span>&nbsp;<span class="op" id="3845077">+</span>&nbsp;<span class="num" id="3845079">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845084">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845097">//&nbsp;Pending&nbsp;error?</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845117">if</span>&nbsp;<span class="ident" id="3845120">b</span><span class="op" id="3845121">.</span><span class="ident" id="3845122">err</span>&nbsp;<span class="op" id="3845126">!=</span>&nbsp;<span class="ident" id="3845129">nil</span>&nbsp;<span class="op" id="3845133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845138">line</span>&nbsp;<span class="op" id="3845143">=</span>&nbsp;<span class="ident" id="3845145">b</span><span class="op" id="3845146">.</span><span class="ident" id="3845147">buf</span><span class="op" id="3845150">[</span><span class="ident" id="3845151">b</span><span class="op" id="3845152">.</span><span class="ident" id="3845153">r</span><span class="op" id="3845154">:</span><span class="ident" id="3845155">b</span><span class="op" id="3845156">.</span><span class="ident" id="3845157">w</span><span class="op" id="3845158">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845163">b</span><span class="op" id="3845164">.</span><span class="ident" id="3845165">r</span>&nbsp;<span class="op" id="3845167">=</span>&nbsp;<span class="ident" id="3845169">b</span><span class="op" id="3845170">.</span><span class="ident" id="3845171">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845176">err</span>&nbsp;<span class="op" id="3845180">=</span>&nbsp;<span class="ident" id="3845182">b</span><span class="op" id="3845183">.</span><span class="ident" id="3845184">readErr</span><span class="op" id="3845191">(</span><span class="op" id="3845192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845197">break</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845210">//&nbsp;Buffer&nbsp;full?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845228">if</span>&nbsp;<span class="ident" id="3845231">b</span><span class="op" id="3845232">.</span><span class="ident" id="3845233">Buffered</span><span class="op" id="3845241">(</span><span class="op" id="3845242">)</span>&nbsp;<span class="op" id="3845244">&gt;=</span>&nbsp;<span class="builtinfunc" id="3845247">len</span><span class="op" id="3845250">(</span><span class="ident" id="3845251">b</span><span class="op" id="3845252">.</span><span class="ident" id="3845253">buf</span><span class="op" id="3845256">)</span>&nbsp;<span class="op" id="3845258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845263">b</span><span class="op" id="3845264">.</span><span class="ident" id="3845265">r</span>&nbsp;<span class="op" id="3845267">=</span>&nbsp;<span class="ident" id="3845269">b</span><span class="op" id="3845270">.</span><span class="ident" id="3845271">w</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845276">line</span>&nbsp;<span class="op" id="3845281">=</span>&nbsp;<span class="ident" id="3845283">b</span><span class="op" id="3845284">.</span><span class="ident" id="3845285">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845292">err</span>&nbsp;<span class="op" id="3845296">=</span>&nbsp;<span class="ident" id="3845298">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845315">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845328">b</span><span class="op" id="3845329">.</span><span class="ident" id="3845330">fill</span><span class="op" id="3845334">(</span><span class="op" id="3845335">)</span>&nbsp;<span class="comment" id="3845337">//&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845364">//&nbsp;Handle&nbsp;last&nbsp;byte,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845394">if</span>&nbsp;<span class="ident" id="3845397">i</span>&nbsp;<span class="op" id="3845399">:=</span>&nbsp;<span class="builtinfunc" id="3845402">len</span><span class="op" id="3845405">(</span><span class="ident" id="3845406">line</span><span class="op" id="3845410">)</span>&nbsp;<span class="op" id="3845412">-</span>&nbsp;<span class="num" id="3845414">1</span><span class="op" id="3845415">;</span>&nbsp;<span class="ident" id="3845417">i</span>&nbsp;<span class="op" id="3845419">&gt;=</span>&nbsp;<span class="num" id="3845422">0</span>&nbsp;<span class="op" id="3845424">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845428">b</span><span class="op" id="3845429">.</span><span class="ident" id="3845430">lastByte</span>&nbsp;<span class="op" id="3845439">=</span>&nbsp;<span class="builtintype" id="3845441">int</span><span class="op" id="3845444">(</span><span class="ident" id="3845445">line</span><span class="op" id="3845449">[</span><span class="ident" id="3845450">i</span><span class="op" id="3845451">]</span><span class="op" id="3845452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845456">b</span><span class="op" id="3845457">.</span><span class="ident" id="3845458">lastRuneSize</span>&nbsp;<span class="op" id="3845471">=</span>&nbsp;<span class="op" id="3845473">-</span><span class="num" id="3845474">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845481">return</span><br>
<span class="lineno">305</span><span class="op" id="3845488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3845491">//&nbsp;ReadLine&nbsp;is&nbsp;a&nbsp;low-level&nbsp;line-reading&nbsp;primitive.&nbsp;Most&nbsp;callers&nbsp;should&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="3845566">//&nbsp;ReadBytes(&#39;\n&#39;)&nbsp;or&nbsp;ReadString(&#39;\n&#39;)&nbsp;instead&nbsp;or&nbsp;use&nbsp;a&nbsp;Scanner.</span><br>
<span class="lineno"></span><span class="comment" id="3845631">//</span><br>
<span class="lineno">310</span><span class="comment" id="3845634">//&nbsp;ReadLine&nbsp;tries&nbsp;to&nbsp;return&nbsp;a&nbsp;single&nbsp;line,&nbsp;not&nbsp;including&nbsp;the&nbsp;end-of-line&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="3845714">//&nbsp;If&nbsp;the&nbsp;line&nbsp;was&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;buffer&nbsp;then&nbsp;isPrefix&nbsp;is&nbsp;set&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3845786">//&nbsp;beginning&nbsp;of&nbsp;the&nbsp;line&nbsp;is&nbsp;returned.&nbsp;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;line&nbsp;will&nbsp;be&nbsp;returned</span><br>
<span class="lineno"></span><span class="comment" id="3845862">//&nbsp;from&nbsp;future&nbsp;calls.&nbsp;isPrefix&nbsp;will&nbsp;be&nbsp;false&nbsp;when&nbsp;returning&nbsp;the&nbsp;last&nbsp;fragment</span><br>
<span class="lineno"></span><span class="comment" id="3845940">//&nbsp;of&nbsp;the&nbsp;line.&nbsp;The&nbsp;returned&nbsp;buffer&nbsp;is&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to</span><br>
<span class="lineno">315</span><span class="comment" id="3846013">//&nbsp;ReadLine.&nbsp;ReadLine&nbsp;either&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;line&nbsp;or&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span><span class="comment" id="3846089">//&nbsp;never&nbsp;both.</span><br>
<span class="lineno"></span><span class="comment" id="3846104">//</span><br>
<span class="lineno"></span><span class="comment" id="3846107">//&nbsp;The&nbsp;text&nbsp;returned&nbsp;from&nbsp;ReadLine&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;line&nbsp;end&nbsp;(&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;).</span><br>
<span class="lineno"></span><span class="comment" id="3846190">//&nbsp;No&nbsp;indication&nbsp;or&nbsp;error&nbsp;is&nbsp;given&nbsp;if&nbsp;the&nbsp;input&nbsp;ends&nbsp;without&nbsp;a&nbsp;final&nbsp;line&nbsp;end.</span><br>
<span class="lineno">320</span><span class="comment" id="3846269">//&nbsp;Calling&nbsp;UnreadByte&nbsp;after&nbsp;ReadLine&nbsp;will&nbsp;always&nbsp;unread&nbsp;the&nbsp;last&nbsp;byte&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3846344">//&nbsp;(possibly&nbsp;a&nbsp;character&nbsp;belonging&nbsp;to&nbsp;the&nbsp;line&nbsp;end)&nbsp;even&nbsp;if&nbsp;that&nbsp;byte&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3846421">//&nbsp;part&nbsp;of&nbsp;the&nbsp;line&nbsp;returned&nbsp;by&nbsp;ReadLine.</span><br>
<span class="lineno"></span><span class="keyword" id="3846463">func</span>&nbsp;<span class="op" id="3846468">(</span><span class="ident" id="3846469">b</span>&nbsp;<span class="op" id="3846471">*</span><span class="ident" id="3846472">Reader</span><span class="op" id="3846478">)</span>&nbsp;<span class="ident" id="3846480">ReadLine</span><span class="op" id="3846488">(</span><span class="op" id="3846489">)</span>&nbsp;<span class="op" id="3846491">(</span><span class="ident" id="3846492">line</span>&nbsp;<span class="op" id="3846497">[</span><span class="op" id="3846498">]</span><span class="builtintype" id="3846499">byte</span><span class="op" id="3846503">,</span>&nbsp;<span class="ident" id="3846505">isPrefix</span>&nbsp;<span class="builtintype" id="3846514">bool</span><span class="op" id="3846518">,</span>&nbsp;<span class="ident" id="3846520">err</span>&nbsp;<span class="builtintype" id="3846524">error</span><span class="op" id="3846529">)</span>&nbsp;<span class="op" id="3846531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846534">line</span><span class="op" id="3846538">,</span>&nbsp;<span class="ident" id="3846540">err</span>&nbsp;<span class="op" id="3846544">=</span>&nbsp;<span class="ident" id="3846546">b</span><span class="op" id="3846547">.</span><span class="ident" id="3846548">ReadSlice</span><span class="op" id="3846557">(</span><span class="string" id="3846558">&#39;\n&#39;</span><span class="op" id="3846562">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846565">if</span>&nbsp;<span class="ident" id="3846568">err</span>&nbsp;<span class="op" id="3846572">==</span>&nbsp;<span class="ident" id="3846575">ErrBufferFull</span>&nbsp;<span class="op" id="3846589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846593">//&nbsp;Handle&nbsp;the&nbsp;case&nbsp;where&nbsp;&#34;\r\n&#34;&nbsp;straddles&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846649">if</span>&nbsp;<span class="builtinfunc" id="3846652">len</span><span class="op" id="3846655">(</span><span class="ident" id="3846656">line</span><span class="op" id="3846660">)</span>&nbsp;<span class="op" id="3846662">&gt;</span>&nbsp;<span class="num" id="3846664">0</span>&nbsp;<span class="op" id="3846666">&amp;&amp;</span>&nbsp;<span class="ident" id="3846669">line</span><span class="op" id="3846673">[</span><span class="builtinfunc" id="3846674">len</span><span class="op" id="3846677">(</span><span class="ident" id="3846678">line</span><span class="op" id="3846682">)</span><span class="op" id="3846683">-</span><span class="num" id="3846684">1</span><span class="op" id="3846685">]</span>&nbsp;<span class="op" id="3846687">==</span>&nbsp;<span class="string" id="3846690">&#39;\r&#39;</span>&nbsp;<span class="op" id="3846695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846700">//&nbsp;Put&nbsp;the&nbsp;&#39;\r&#39;&nbsp;back&nbsp;on&nbsp;buf&nbsp;and&nbsp;drop&nbsp;it&nbsp;from&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846754">//&nbsp;Let&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;ReadLine&nbsp;check&nbsp;for&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846808">if</span>&nbsp;<span class="ident" id="3846811">b</span><span class="op" id="3846812">.</span><span class="ident" id="3846813">r</span>&nbsp;<span class="op" id="3846815">==</span>&nbsp;<span class="num" id="3846818">0</span>&nbsp;<span class="op" id="3846820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846826">//&nbsp;should&nbsp;be&nbsp;unreachable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3846855">panic</span><span class="op" id="3846860">(</span><span class="string" id="3846861">&#34;bufio:&nbsp;tried&nbsp;to&nbsp;rewind&nbsp;past&nbsp;start&nbsp;of&nbsp;buffer&#34;</span><span class="op" id="3846906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846916">b</span><span class="op" id="3846917">.</span><span class="ident" id="3846918">r</span><span class="op" id="3846919">--</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846925">line</span>&nbsp;<span class="op" id="3846930">=</span>&nbsp;<span class="ident" id="3846932">line</span><span class="op" id="3846936">[</span><span class="op" id="3846937">:</span><span class="builtinfunc" id="3846938">len</span><span class="op" id="3846941">(</span><span class="ident" id="3846942">line</span><span class="op" id="3846946">)</span><span class="op" id="3846947">-</span><span class="num" id="3846948">1</span><span class="op" id="3846949">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846957">return</span>&nbsp;<span class="ident" id="3846964">line</span><span class="op" id="3846968">,</span>&nbsp;<span class="builtintype" id="3846970">true</span><span class="op" id="3846974">,</span>&nbsp;<span class="ident" id="3846976">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846985">if</span>&nbsp;<span class="builtinfunc" id="3846988">len</span><span class="op" id="3846991">(</span><span class="ident" id="3846992">line</span><span class="op" id="3846996">)</span>&nbsp;<span class="op" id="3846998">==</span>&nbsp;<span class="num" id="3847001">0</span>&nbsp;<span class="op" id="3847003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847007">if</span>&nbsp;<span class="ident" id="3847010">err</span>&nbsp;<span class="op" id="3847014">!=</span>&nbsp;<span class="ident" id="3847017">nil</span>&nbsp;<span class="op" id="3847021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847026">line</span>&nbsp;<span class="op" id="3847031">=</span>&nbsp;<span class="ident" id="3847033">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847043">return</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847054">err</span>&nbsp;<span class="op" id="3847058">=</span>&nbsp;<span class="ident" id="3847060">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847066">if</span>&nbsp;<span class="ident" id="3847069">line</span><span class="op" id="3847073">[</span><span class="builtinfunc" id="3847074">len</span><span class="op" id="3847077">(</span><span class="ident" id="3847078">line</span><span class="op" id="3847082">)</span><span class="op" id="3847083">-</span><span class="num" id="3847084">1</span><span class="op" id="3847085">]</span>&nbsp;<span class="op" id="3847087">==</span>&nbsp;<span class="string" id="3847090">&#39;\n&#39;</span>&nbsp;<span class="op" id="3847095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847099">drop</span>&nbsp;<span class="op" id="3847104">:=</span>&nbsp;<span class="num" id="3847107">1</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847111">if</span>&nbsp;<span class="builtinfunc" id="3847114">len</span><span class="op" id="3847117">(</span><span class="ident" id="3847118">line</span><span class="op" id="3847122">)</span>&nbsp;<span class="op" id="3847124">&gt;</span>&nbsp;<span class="num" id="3847126">1</span>&nbsp;<span class="op" id="3847128">&amp;&amp;</span>&nbsp;<span class="ident" id="3847131">line</span><span class="op" id="3847135">[</span><span class="builtinfunc" id="3847136">len</span><span class="op" id="3847139">(</span><span class="ident" id="3847140">line</span><span class="op" id="3847144">)</span><span class="op" id="3847145">-</span><span class="num" id="3847146">2</span><span class="op" id="3847147">]</span>&nbsp;<span class="op" id="3847149">==</span>&nbsp;<span class="string" id="3847152">&#39;\r&#39;</span>&nbsp;<span class="op" id="3847157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847162">drop</span>&nbsp;<span class="op" id="3847167">=</span>&nbsp;<span class="num" id="3847169">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847177">line</span>&nbsp;<span class="op" id="3847182">=</span>&nbsp;<span class="ident" id="3847184">line</span><span class="op" id="3847188">[</span><span class="op" id="3847189">:</span><span class="builtinfunc" id="3847190">len</span><span class="op" id="3847193">(</span><span class="ident" id="3847194">line</span><span class="op" id="3847198">)</span><span class="op" id="3847199">-</span><span class="ident" id="3847200">drop</span><span class="op" id="3847204">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847207">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847210">return</span><br>
<span class="lineno"></span><span class="op" id="3847217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3847220">//&nbsp;ReadBytes&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="3847289">//&nbsp;returning&nbsp;a&nbsp;slice&nbsp;containing&nbsp;the&nbsp;data&nbsp;up&nbsp;to&nbsp;and&nbsp;including&nbsp;the&nbsp;delimiter.</span><br>
<span class="lineno">360</span><span class="comment" id="3847365">//&nbsp;If&nbsp;ReadBytes&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="3847429">//&nbsp;it&nbsp;returns&nbsp;the&nbsp;data&nbsp;read&nbsp;before&nbsp;the&nbsp;error&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno"></span><span class="comment" id="3847511">//&nbsp;ReadBytes&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;returned&nbsp;data&nbsp;does&nbsp;not&nbsp;end&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3847592">//&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="3847602">//&nbsp;For&nbsp;simple&nbsp;uses,&nbsp;a&nbsp;Scanner&nbsp;may&nbsp;be&nbsp;more&nbsp;convenient.</span><br>
<span class="lineno">365</span><span class="keyword" id="3847656">func</span>&nbsp;<span class="op" id="3847661">(</span><span class="ident" id="3847662">b</span>&nbsp;<span class="op" id="3847664">*</span><span class="ident" id="3847665">Reader</span><span class="op" id="3847671">)</span>&nbsp;<span class="ident" id="3847673">ReadBytes</span><span class="op" id="3847682">(</span><span class="ident" id="3847683">delim</span>&nbsp;<span class="builtintype" id="3847689">byte</span><span class="op" id="3847693">)</span>&nbsp;<span class="op" id="3847695">(</span><span class="ident" id="3847696">line</span>&nbsp;<span class="op" id="3847701">[</span><span class="op" id="3847702">]</span><span class="builtintype" id="3847703">byte</span><span class="op" id="3847707">,</span>&nbsp;<span class="ident" id="3847709">err</span>&nbsp;<span class="builtintype" id="3847713">error</span><span class="op" id="3847718">)</span>&nbsp;<span class="op" id="3847720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847723">//&nbsp;Use&nbsp;ReadSlice&nbsp;to&nbsp;look&nbsp;for&nbsp;array,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847760">//&nbsp;accumulating&nbsp;full&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847791">var</span>&nbsp;<span class="ident" id="3847795">frag</span>&nbsp;<span class="op" id="3847800">[</span><span class="op" id="3847801">]</span><span class="builtintype" id="3847802">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847808">var</span>&nbsp;<span class="ident" id="3847812">full</span>&nbsp;<span class="op" id="3847817">[</span><span class="op" id="3847818">]</span><span class="op" id="3847819">[</span><span class="op" id="3847820">]</span><span class="builtintype" id="3847821">byte</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847827">err</span>&nbsp;<span class="op" id="3847831">=</span>&nbsp;<span class="ident" id="3847833">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847839">for</span>&nbsp;<span class="op" id="3847843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847847">var</span>&nbsp;<span class="ident" id="3847851">e</span>&nbsp;<span class="builtintype" id="3847853">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847861">frag</span><span class="op" id="3847865">,</span>&nbsp;<span class="ident" id="3847867">e</span>&nbsp;<span class="op" id="3847869">=</span>&nbsp;<span class="ident" id="3847871">b</span><span class="op" id="3847872">.</span><span class="ident" id="3847873">ReadSlice</span><span class="op" id="3847882">(</span><span class="ident" id="3847883">delim</span><span class="op" id="3847888">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847892">if</span>&nbsp;<span class="ident" id="3847895">e</span>&nbsp;<span class="op" id="3847897">==</span>&nbsp;<span class="ident" id="3847900">nil</span>&nbsp;<span class="op" id="3847904">{</span>&nbsp;<span class="comment" id="3847906">//&nbsp;got&nbsp;final&nbsp;fragment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847931">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847943">if</span>&nbsp;<span class="ident" id="3847946">e</span>&nbsp;<span class="op" id="3847948">!=</span>&nbsp;<span class="ident" id="3847951">ErrBufferFull</span>&nbsp;<span class="op" id="3847965">{</span>&nbsp;<span class="comment" id="3847967">//&nbsp;unexpected&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847990">err</span>&nbsp;<span class="op" id="3847994">=</span>&nbsp;<span class="ident" id="3847996">e</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848001">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848014">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848046">buf</span>&nbsp;<span class="op" id="3848050">:=</span>&nbsp;<span class="builtinfunc" id="3848053">make</span><span class="op" id="3848057">(</span><span class="op" id="3848058">[</span><span class="op" id="3848059">]</span><span class="builtintype" id="3848060">byte</span><span class="op" id="3848064">,</span>&nbsp;<span class="builtinfunc" id="3848066">len</span><span class="op" id="3848069">(</span><span class="ident" id="3848070">frag</span><span class="op" id="3848074">)</span><span class="op" id="3848075">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3848079">copy</span><span class="op" id="3848083">(</span><span class="ident" id="3848084">buf</span><span class="op" id="3848087">,</span>&nbsp;<span class="ident" id="3848089">frag</span><span class="op" id="3848093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848097">full</span>&nbsp;<span class="op" id="3848102">=</span>&nbsp;<span class="builtinfunc" id="3848104">append</span><span class="op" id="3848110">(</span><span class="ident" id="3848111">full</span><span class="op" id="3848115">,</span>&nbsp;<span class="ident" id="3848117">buf</span><span class="op" id="3848120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848127">//&nbsp;Allocate&nbsp;new&nbsp;buffer&nbsp;to&nbsp;hold&nbsp;the&nbsp;full&nbsp;pieces&nbsp;and&nbsp;the&nbsp;fragment.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848193">n</span>&nbsp;<span class="op" id="3848195">:=</span>&nbsp;<span class="num" id="3848198">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848201">for</span>&nbsp;<span class="ident" id="3848205">i</span>&nbsp;<span class="op" id="3848207">:=</span>&nbsp;<span class="keyword" id="3848210">range</span>&nbsp;<span class="ident" id="3848216">full</span>&nbsp;<span class="op" id="3848221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848225">n</span>&nbsp;<span class="op" id="3848227">+=</span>&nbsp;<span class="builtinfunc" id="3848230">len</span><span class="op" id="3848233">(</span><span class="ident" id="3848234">full</span><span class="op" id="3848238">[</span><span class="ident" id="3848239">i</span><span class="op" id="3848240">]</span><span class="op" id="3848241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848247">n</span>&nbsp;<span class="op" id="3848249">+=</span>&nbsp;<span class="builtinfunc" id="3848252">len</span><span class="op" id="3848255">(</span><span class="ident" id="3848256">frag</span><span class="op" id="3848260">)</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848264">//&nbsp;Copy&nbsp;full&nbsp;pieces&nbsp;and&nbsp;fragment&nbsp;in.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848302">buf</span>&nbsp;<span class="op" id="3848306">:=</span>&nbsp;<span class="builtinfunc" id="3848309">make</span><span class="op" id="3848313">(</span><span class="op" id="3848314">[</span><span class="op" id="3848315">]</span><span class="builtintype" id="3848316">byte</span><span class="op" id="3848320">,</span>&nbsp;<span class="ident" id="3848322">n</span><span class="op" id="3848323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848326">n</span>&nbsp;<span class="op" id="3848328">=</span>&nbsp;<span class="num" id="3848330">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848333">for</span>&nbsp;<span class="ident" id="3848337">i</span>&nbsp;<span class="op" id="3848339">:=</span>&nbsp;<span class="keyword" id="3848342">range</span>&nbsp;<span class="ident" id="3848348">full</span>&nbsp;<span class="op" id="3848353">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848357">n</span>&nbsp;<span class="op" id="3848359">+=</span>&nbsp;<span class="builtinfunc" id="3848362">copy</span><span class="op" id="3848366">(</span><span class="ident" id="3848367">buf</span><span class="op" id="3848370">[</span><span class="ident" id="3848371">n</span><span class="op" id="3848372">:</span><span class="op" id="3848373">]</span><span class="op" id="3848374">,</span>&nbsp;<span class="ident" id="3848376">full</span><span class="op" id="3848380">[</span><span class="ident" id="3848381">i</span><span class="op" id="3848382">]</span><span class="op" id="3848383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3848389">copy</span><span class="op" id="3848393">(</span><span class="ident" id="3848394">buf</span><span class="op" id="3848397">[</span><span class="ident" id="3848398">n</span><span class="op" id="3848399">:</span><span class="op" id="3848400">]</span><span class="op" id="3848401">,</span>&nbsp;<span class="ident" id="3848403">frag</span><span class="op" id="3848407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848410">return</span>&nbsp;<span class="ident" id="3848417">buf</span><span class="op" id="3848420">,</span>&nbsp;<span class="ident" id="3848422">err</span><br>
<span class="lineno"></span><span class="op" id="3848426">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="comment" id="3848429">//&nbsp;ReadString&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="3848499">//&nbsp;returning&nbsp;a&nbsp;string&nbsp;containing&nbsp;the&nbsp;data&nbsp;up&nbsp;to&nbsp;and&nbsp;including&nbsp;the&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="3848576">//&nbsp;If&nbsp;ReadString&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="3848641">//&nbsp;it&nbsp;returns&nbsp;the&nbsp;data&nbsp;read&nbsp;before&nbsp;the&nbsp;error&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno">410</span><span class="comment" id="3848723">//&nbsp;ReadString&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;returned&nbsp;data&nbsp;does&nbsp;not&nbsp;end&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3848805">//&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="3848815">//&nbsp;For&nbsp;simple&nbsp;uses,&nbsp;a&nbsp;Scanner&nbsp;may&nbsp;be&nbsp;more&nbsp;convenient.</span><br>
<span class="lineno"></span><span class="keyword" id="3848869">func</span>&nbsp;<span class="op" id="3848874">(</span><span class="ident" id="3848875">b</span>&nbsp;<span class="op" id="3848877">*</span><span class="ident" id="3848878">Reader</span><span class="op" id="3848884">)</span>&nbsp;<span class="ident" id="3848886">ReadString</span><span class="op" id="3848896">(</span><span class="ident" id="3848897">delim</span>&nbsp;<span class="builtintype" id="3848903">byte</span><span class="op" id="3848907">)</span>&nbsp;<span class="op" id="3848909">(</span><span class="ident" id="3848910">line</span>&nbsp;<span class="builtintype" id="3848915">string</span><span class="op" id="3848921">,</span>&nbsp;<span class="ident" id="3848923">err</span>&nbsp;<span class="builtintype" id="3848927">error</span><span class="op" id="3848932">)</span>&nbsp;<span class="op" id="3848934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848937">bytes</span><span class="op" id="3848942">,</span>&nbsp;<span class="ident" id="3848944">err</span>&nbsp;<span class="op" id="3848948">:=</span>&nbsp;<span class="ident" id="3848951">b</span><span class="op" id="3848952">.</span><span class="ident" id="3848953">ReadBytes</span><span class="op" id="3848962">(</span><span class="ident" id="3848963">delim</span><span class="op" id="3848968">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848971">line</span>&nbsp;<span class="op" id="3848976">=</span>&nbsp;<span class="builtintype" id="3848978">string</span><span class="op" id="3848984">(</span><span class="ident" id="3848985">bytes</span><span class="op" id="3848990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848993">return</span>&nbsp;<span class="ident" id="3849000">line</span><span class="op" id="3849004">,</span>&nbsp;<span class="ident" id="3849006">err</span><br>
<span class="lineno"></span><span class="op" id="3849010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3849013">//&nbsp;WriteTo&nbsp;implements&nbsp;io.WriterTo.</span><br>
<span class="lineno">420</span><span class="keyword" id="3849048">func</span>&nbsp;<span class="op" id="3849053">(</span><span class="ident" id="3849054">b</span>&nbsp;<span class="op" id="3849056">*</span><span class="ident" id="3849057">Reader</span><span class="op" id="3849063">)</span>&nbsp;<span class="ident" id="3849065">WriteTo</span><span class="op" id="3849072">(</span><span class="ident" id="3849073">w</span>&nbsp;<span class="ident" id="3849075">io</span><span class="op" id="3849077">.</span><span class="ident" id="3849078">Writer</span><span class="op" id="3849084">)</span>&nbsp;<span class="op" id="3849086">(</span><span class="ident" id="3849087">n</span>&nbsp;<span class="ident" id="3849089">int64</span><span class="op" id="3849094">,</span>&nbsp;<span class="ident" id="3849096">err</span>&nbsp;<span class="builtintype" id="3849100">error</span><span class="op" id="3849105">)</span>&nbsp;<span class="op" id="3849107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849110">n</span><span class="op" id="3849111">,</span>&nbsp;<span class="ident" id="3849113">err</span>&nbsp;<span class="op" id="3849117">=</span>&nbsp;<span class="ident" id="3849119">b</span><span class="op" id="3849120">.</span><span class="ident" id="3849121">writeBuf</span><span class="op" id="3849129">(</span><span class="ident" id="3849130">w</span><span class="op" id="3849131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849134">if</span>&nbsp;<span class="ident" id="3849137">err</span>&nbsp;<span class="op" id="3849141">!=</span>&nbsp;<span class="ident" id="3849144">nil</span>&nbsp;<span class="op" id="3849148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849152">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849160">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849164">if</span>&nbsp;<span class="ident" id="3849167">r</span><span class="op" id="3849168">,</span>&nbsp;<span class="ident" id="3849170">ok</span>&nbsp;<span class="op" id="3849173">:=</span>&nbsp;<span class="ident" id="3849176">b</span><span class="op" id="3849177">.</span><span class="ident" id="3849178">rd</span><span class="op" id="3849180">.</span><span class="op" id="3849181">(</span><span class="ident" id="3849182">io</span><span class="op" id="3849184">.</span><span class="ident" id="3849185">WriterTo</span><span class="op" id="3849193">)</span><span class="op" id="3849194">;</span>&nbsp;<span class="ident" id="3849196">ok</span>&nbsp;<span class="op" id="3849199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849203">m</span><span class="op" id="3849204">,</span>&nbsp;<span class="ident" id="3849206">err</span>&nbsp;<span class="op" id="3849210">:=</span>&nbsp;<span class="ident" id="3849213">r</span><span class="op" id="3849214">.</span><span class="ident" id="3849215">WriteTo</span><span class="op" id="3849222">(</span><span class="ident" id="3849223">w</span><span class="op" id="3849224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849228">n</span>&nbsp;<span class="op" id="3849230">+=</span>&nbsp;<span class="ident" id="3849233">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849237">return</span>&nbsp;<span class="ident" id="3849244">n</span><span class="op" id="3849245">,</span>&nbsp;<span class="ident" id="3849247">err</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849256">if</span>&nbsp;<span class="ident" id="3849259">w</span><span class="op" id="3849260">,</span>&nbsp;<span class="ident" id="3849262">ok</span>&nbsp;<span class="op" id="3849265">:=</span>&nbsp;<span class="ident" id="3849268">w</span><span class="op" id="3849269">.</span><span class="op" id="3849270">(</span><span class="ident" id="3849271">io</span><span class="op" id="3849273">.</span><span class="ident" id="3849274">ReaderFrom</span><span class="op" id="3849284">)</span><span class="op" id="3849285">;</span>&nbsp;<span class="ident" id="3849287">ok</span>&nbsp;<span class="op" id="3849290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849294">m</span><span class="op" id="3849295">,</span>&nbsp;<span class="ident" id="3849297">err</span>&nbsp;<span class="op" id="3849301">:=</span>&nbsp;<span class="ident" id="3849304">w</span><span class="op" id="3849305">.</span><span class="ident" id="3849306">ReadFrom</span><span class="op" id="3849314">(</span><span class="ident" id="3849315">b</span><span class="op" id="3849316">.</span><span class="ident" id="3849317">rd</span><span class="op" id="3849319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849323">n</span>&nbsp;<span class="op" id="3849325">+=</span>&nbsp;<span class="ident" id="3849328">m</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849332">return</span>&nbsp;<span class="ident" id="3849339">n</span><span class="op" id="3849340">,</span>&nbsp;<span class="ident" id="3849342">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849351">if</span>&nbsp;<span class="ident" id="3849354">b</span><span class="op" id="3849355">.</span><span class="ident" id="3849356">w</span><span class="op" id="3849357">-</span><span class="ident" id="3849358">b</span><span class="op" id="3849359">.</span><span class="ident" id="3849360">r</span>&nbsp;<span class="op" id="3849362">&lt;</span>&nbsp;<span class="builtinfunc" id="3849364">len</span><span class="op" id="3849367">(</span><span class="ident" id="3849368">b</span><span class="op" id="3849369">.</span><span class="ident" id="3849370">buf</span><span class="op" id="3849373">)</span>&nbsp;<span class="op" id="3849375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849379">b</span><span class="op" id="3849380">.</span><span class="ident" id="3849381">fill</span><span class="op" id="3849385">(</span><span class="op" id="3849386">)</span>&nbsp;<span class="comment" id="3849388">//&nbsp;buffer&nbsp;not&nbsp;full</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849412">for</span>&nbsp;<span class="ident" id="3849416">b</span><span class="op" id="3849417">.</span><span class="ident" id="3849418">r</span>&nbsp;<span class="op" id="3849420">&lt;</span>&nbsp;<span class="ident" id="3849422">b</span><span class="op" id="3849423">.</span><span class="ident" id="3849424">w</span>&nbsp;<span class="op" id="3849426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849430">//&nbsp;b.r&nbsp;&lt;&nbsp;b.w&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849468">m</span><span class="op" id="3849469">,</span>&nbsp;<span class="ident" id="3849471">err</span>&nbsp;<span class="op" id="3849475">:=</span>&nbsp;<span class="ident" id="3849478">b</span><span class="op" id="3849479">.</span><span class="ident" id="3849480">writeBuf</span><span class="op" id="3849488">(</span><span class="ident" id="3849489">w</span><span class="op" id="3849490">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849494">n</span>&nbsp;<span class="op" id="3849496">+=</span>&nbsp;<span class="ident" id="3849499">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849503">if</span>&nbsp;<span class="ident" id="3849506">err</span>&nbsp;<span class="op" id="3849510">!=</span>&nbsp;<span class="ident" id="3849513">nil</span>&nbsp;<span class="op" id="3849517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849522">return</span>&nbsp;<span class="ident" id="3849529">n</span><span class="op" id="3849530">,</span>&nbsp;<span class="ident" id="3849532">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849542">b</span><span class="op" id="3849543">.</span><span class="ident" id="3849544">fill</span><span class="op" id="3849548">(</span><span class="op" id="3849549">)</span>&nbsp;<span class="comment" id="3849551">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849575">if</span>&nbsp;<span class="ident" id="3849578">b</span><span class="op" id="3849579">.</span><span class="ident" id="3849580">err</span>&nbsp;<span class="op" id="3849584">==</span>&nbsp;<span class="ident" id="3849587">io</span><span class="op" id="3849589">.</span><span class="ident" id="3849590">EOF</span>&nbsp;<span class="op" id="3849594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849598">b</span><span class="op" id="3849599">.</span><span class="ident" id="3849600">err</span>&nbsp;<span class="op" id="3849604">=</span>&nbsp;<span class="ident" id="3849606">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849611">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849615">return</span>&nbsp;<span class="ident" id="3849622">n</span><span class="op" id="3849623">,</span>&nbsp;<span class="ident" id="3849625">b</span><span class="op" id="3849626">.</span><span class="ident" id="3849627">readErr</span><span class="op" id="3849634">(</span><span class="op" id="3849635">)</span><br>
<span class="lineno"></span><span class="op" id="3849637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3849640">var</span>&nbsp;<span class="ident" id="3849644">errNegativeWrite</span>&nbsp;<span class="op" id="3849661">=</span>&nbsp;<span class="ident" id="3849663">errors</span><span class="op" id="3849669">.</span><span class="ident" id="3849670">New</span><span class="op" id="3849673">(</span><span class="string" id="3849674">&#34;bufio:&nbsp;writer&nbsp;returned&nbsp;negative&nbsp;count&nbsp;from&nbsp;Write&#34;</span><span class="op" id="3849724">)</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="comment" id="3849727">//&nbsp;writeBuf&nbsp;writes&nbsp;the&nbsp;Reader&#39;s&nbsp;buffer&nbsp;to&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3849781">func</span>&nbsp;<span class="op" id="3849786">(</span><span class="ident" id="3849787">b</span>&nbsp;<span class="op" id="3849789">*</span><span class="ident" id="3849790">Reader</span><span class="op" id="3849796">)</span>&nbsp;<span class="ident" id="3849798">writeBuf</span><span class="op" id="3849806">(</span><span class="ident" id="3849807">w</span>&nbsp;<span class="ident" id="3849809">io</span><span class="op" id="3849811">.</span><span class="ident" id="3849812">Writer</span><span class="op" id="3849818">)</span>&nbsp;<span class="op" id="3849820">(</span><span class="ident" id="3849821">int64</span><span class="op" id="3849826">,</span>&nbsp;<span class="builtintype" id="3849828">error</span><span class="op" id="3849833">)</span>&nbsp;<span class="op" id="3849835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849838">n</span><span class="op" id="3849839">,</span>&nbsp;<span class="ident" id="3849841">err</span>&nbsp;<span class="op" id="3849845">:=</span>&nbsp;<span class="ident" id="3849848">w</span><span class="op" id="3849849">.</span><span class="ident" id="3849850">Write</span><span class="op" id="3849855">(</span><span class="ident" id="3849856">b</span><span class="op" id="3849857">.</span><span class="ident" id="3849858">buf</span><span class="op" id="3849861">[</span><span class="ident" id="3849862">b</span><span class="op" id="3849863">.</span><span class="ident" id="3849864">r</span><span class="op" id="3849865">:</span><span class="ident" id="3849866">b</span><span class="op" id="3849867">.</span><span class="ident" id="3849868">w</span><span class="op" id="3849869">]</span><span class="op" id="3849870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849873">if</span>&nbsp;<span class="ident" id="3849876">n</span>&nbsp;<span class="op" id="3849878">&lt;</span>&nbsp;<span class="num" id="3849880">0</span>&nbsp;<span class="op" id="3849882">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3849886">panic</span><span class="op" id="3849891">(</span><span class="ident" id="3849892">errNegativeWrite</span><span class="op" id="3849908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849914">b</span><span class="op" id="3849915">.</span><span class="ident" id="3849916">r</span>&nbsp;<span class="op" id="3849918">+=</span>&nbsp;<span class="ident" id="3849921">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849924">return</span>&nbsp;<span class="ident" id="3849931">int64</span><span class="op" id="3849936">(</span><span class="ident" id="3849937">n</span><span class="op" id="3849938">)</span><span class="op" id="3849939">,</span>&nbsp;<span class="ident" id="3849941">err</span><br>
<span class="lineno"></span><span class="op" id="3849945">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="3849948">//&nbsp;buffered&nbsp;output</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3849968">//&nbsp;Writer&nbsp;implements&nbsp;buffering&nbsp;for&nbsp;an&nbsp;io.Writer&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3850024">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;writing&nbsp;to&nbsp;a&nbsp;Writer,&nbsp;no&nbsp;more&nbsp;data&nbsp;will&nbsp;be</span><br>
<span class="lineno">475</span><span class="comment" id="3850088">//&nbsp;accepted&nbsp;and&nbsp;all&nbsp;subsequent&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="3850149">//&nbsp;After&nbsp;all&nbsp;data&nbsp;has&nbsp;been&nbsp;written,&nbsp;the&nbsp;client&nbsp;should&nbsp;call&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3850212">//&nbsp;Flush&nbsp;method&nbsp;to&nbsp;guarantee&nbsp;all&nbsp;data&nbsp;has&nbsp;been&nbsp;forwarded&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3850272">//&nbsp;the&nbsp;underlying&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3850301">type</span>&nbsp;<span class="ident" id="3850306">Writer</span>&nbsp;<span class="keyword" id="3850313">struct</span>&nbsp;<span class="op" id="3850320">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850323">err</span>&nbsp;<span class="builtintype" id="3850327">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850334">buf</span>&nbsp;<span class="op" id="3850338">[</span><span class="op" id="3850339">]</span><span class="builtintype" id="3850340">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850346">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3850350">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850355">wr</span>&nbsp;&nbsp;<span class="ident" id="3850359">io</span><span class="op" id="3850361">.</span><span class="ident" id="3850362">Writer</span><br>
<span class="lineno"></span><span class="op" id="3850369">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3850372">//&nbsp;NewWriterSize&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;at&nbsp;least&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="3850450">//&nbsp;size.&nbsp;If&nbsp;the&nbsp;argument&nbsp;io.Writer&nbsp;is&nbsp;already&nbsp;a&nbsp;Writer&nbsp;with&nbsp;large&nbsp;enough</span><br>
<span class="lineno"></span><span class="comment" id="3850523">//&nbsp;size,&nbsp;it&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3850566">func</span>&nbsp;<span class="ident" id="3850571">NewWriterSize</span><span class="op" id="3850584">(</span><span class="ident" id="3850585">w</span>&nbsp;<span class="ident" id="3850587">io</span><span class="op" id="3850589">.</span><span class="ident" id="3850590">Writer</span><span class="op" id="3850596">,</span>&nbsp;<span class="ident" id="3850598">size</span>&nbsp;<span class="builtintype" id="3850603">int</span><span class="op" id="3850606">)</span>&nbsp;<span class="op" id="3850608">*</span><span class="ident" id="3850609">Writer</span>&nbsp;<span class="op" id="3850616">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850619">//&nbsp;Is&nbsp;it&nbsp;already&nbsp;a&nbsp;Writer?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850647">b</span><span class="op" id="3850648">,</span>&nbsp;<span class="ident" id="3850650">ok</span>&nbsp;<span class="op" id="3850653">:=</span>&nbsp;<span class="ident" id="3850656">w</span><span class="op" id="3850657">.</span><span class="op" id="3850658">(</span><span class="op" id="3850659">*</span><span class="ident" id="3850660">Writer</span><span class="op" id="3850666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850669">if</span>&nbsp;<span class="ident" id="3850672">ok</span>&nbsp;<span class="op" id="3850675">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3850678">len</span><span class="op" id="3850681">(</span><span class="ident" id="3850682">b</span><span class="op" id="3850683">.</span><span class="ident" id="3850684">buf</span><span class="op" id="3850687">)</span>&nbsp;<span class="op" id="3850689">&gt;=</span>&nbsp;<span class="ident" id="3850692">size</span>&nbsp;<span class="op" id="3850697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850701">return</span>&nbsp;<span class="ident" id="3850708">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850711">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850714">if</span>&nbsp;<span class="ident" id="3850717">size</span>&nbsp;<span class="op" id="3850722">&lt;=</span>&nbsp;<span class="num" id="3850725">0</span>&nbsp;<span class="op" id="3850727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850731">size</span>&nbsp;<span class="op" id="3850736">=</span>&nbsp;<span class="ident" id="3850738">defaultBufSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850757">return</span>&nbsp;<span class="op" id="3850764">&amp;</span><span class="ident" id="3850765">Writer</span><span class="op" id="3850771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850775">buf</span><span class="op" id="3850778">:</span>&nbsp;<span class="builtinfunc" id="3850780">make</span><span class="op" id="3850784">(</span><span class="op" id="3850785">[</span><span class="op" id="3850786">]</span><span class="builtintype" id="3850787">byte</span><span class="op" id="3850791">,</span>&nbsp;<span class="ident" id="3850793">size</span><span class="op" id="3850797">)</span><span class="op" id="3850798">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850802">wr</span><span class="op" id="3850804">:</span>&nbsp;&nbsp;<span class="ident" id="3850807">w</span><span class="op" id="3850808">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850811">}</span><br>
<span class="lineno"></span><span class="op" id="3850813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3850816">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;the&nbsp;default&nbsp;size.</span><br>
<span class="lineno">505</span><span class="keyword" id="3850885">func</span>&nbsp;<span class="ident" id="3850890">NewWriter</span><span class="op" id="3850899">(</span><span class="ident" id="3850900">w</span>&nbsp;<span class="ident" id="3850902">io</span><span class="op" id="3850904">.</span><span class="ident" id="3850905">Writer</span><span class="op" id="3850911">)</span>&nbsp;<span class="op" id="3850913">*</span><span class="ident" id="3850914">Writer</span>&nbsp;<span class="op" id="3850921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850924">return</span>&nbsp;<span class="ident" id="3850931">NewWriterSize</span><span class="op" id="3850944">(</span><span class="ident" id="3850945">w</span><span class="op" id="3850946">,</span>&nbsp;<span class="ident" id="3850948">defaultBufSize</span><span class="op" id="3850962">)</span><br>
<span class="lineno"></span><span class="op" id="3850964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3850967">//&nbsp;Reset&nbsp;discards&nbsp;any&nbsp;unflushed&nbsp;buffered&nbsp;data,&nbsp;clears&nbsp;any&nbsp;error,&nbsp;and</span><br>
<span class="lineno">510</span><span class="comment" id="3851036">//&nbsp;resets&nbsp;b&nbsp;to&nbsp;write&nbsp;its&nbsp;output&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="3851074">func</span>&nbsp;<span class="op" id="3851079">(</span><span class="ident" id="3851080">b</span>&nbsp;<span class="op" id="3851082">*</span><span class="ident" id="3851083">Writer</span><span class="op" id="3851089">)</span>&nbsp;<span class="ident" id="3851091">Reset</span><span class="op" id="3851096">(</span><span class="ident" id="3851097">w</span>&nbsp;<span class="ident" id="3851099">io</span><span class="op" id="3851101">.</span><span class="ident" id="3851102">Writer</span><span class="op" id="3851108">)</span>&nbsp;<span class="op" id="3851110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851113">b</span><span class="op" id="3851114">.</span><span class="ident" id="3851115">err</span>&nbsp;<span class="op" id="3851119">=</span>&nbsp;<span class="ident" id="3851121">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851126">b</span><span class="op" id="3851127">.</span><span class="ident" id="3851128">n</span>&nbsp;<span class="op" id="3851130">=</span>&nbsp;<span class="num" id="3851132">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851135">b</span><span class="op" id="3851136">.</span><span class="ident" id="3851137">wr</span>&nbsp;<span class="op" id="3851140">=</span>&nbsp;<span class="ident" id="3851142">w</span><br>
<span class="lineno">515</span><span class="op" id="3851144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3851147">//&nbsp;Flush&nbsp;writes&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3851210">func</span>&nbsp;<span class="op" id="3851215">(</span><span class="ident" id="3851216">b</span>&nbsp;<span class="op" id="3851218">*</span><span class="ident" id="3851219">Writer</span><span class="op" id="3851225">)</span>&nbsp;<span class="ident" id="3851227">Flush</span><span class="op" id="3851232">(</span><span class="op" id="3851233">)</span>&nbsp;<span class="builtintype" id="3851235">error</span>&nbsp;<span class="op" id="3851241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851244">err</span>&nbsp;<span class="op" id="3851248">:=</span>&nbsp;<span class="ident" id="3851251">b</span><span class="op" id="3851252">.</span><span class="ident" id="3851253">flush</span><span class="op" id="3851258">(</span><span class="op" id="3851259">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851262">return</span>&nbsp;<span class="ident" id="3851269">err</span><br>
<span class="lineno"></span><span class="op" id="3851273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3851276">func</span>&nbsp;<span class="op" id="3851281">(</span><span class="ident" id="3851282">b</span>&nbsp;<span class="op" id="3851284">*</span><span class="ident" id="3851285">Writer</span><span class="op" id="3851291">)</span>&nbsp;<span class="ident" id="3851293">flush</span><span class="op" id="3851298">(</span><span class="op" id="3851299">)</span>&nbsp;<span class="builtintype" id="3851301">error</span>&nbsp;<span class="op" id="3851307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851310">if</span>&nbsp;<span class="ident" id="3851313">b</span><span class="op" id="3851314">.</span><span class="ident" id="3851315">err</span>&nbsp;<span class="op" id="3851319">!=</span>&nbsp;<span class="ident" id="3851322">nil</span>&nbsp;<span class="op" id="3851326">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851330">return</span>&nbsp;<span class="ident" id="3851337">b</span><span class="op" id="3851338">.</span><span class="ident" id="3851339">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851347">if</span>&nbsp;<span class="ident" id="3851350">b</span><span class="op" id="3851351">.</span><span class="ident" id="3851352">n</span>&nbsp;<span class="op" id="3851354">==</span>&nbsp;<span class="num" id="3851357">0</span>&nbsp;<span class="op" id="3851359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851363">return</span>&nbsp;<span class="ident" id="3851370">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851375">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851378">n</span><span class="op" id="3851379">,</span>&nbsp;<span class="ident" id="3851381">err</span>&nbsp;<span class="op" id="3851385">:=</span>&nbsp;<span class="ident" id="3851388">b</span><span class="op" id="3851389">.</span><span class="ident" id="3851390">wr</span><span class="op" id="3851392">.</span><span class="ident" id="3851393">Write</span><span class="op" id="3851398">(</span><span class="ident" id="3851399">b</span><span class="op" id="3851400">.</span><span class="ident" id="3851401">buf</span><span class="op" id="3851404">[</span><span class="num" id="3851405">0</span><span class="op" id="3851406">:</span><span class="ident" id="3851407">b</span><span class="op" id="3851408">.</span><span class="ident" id="3851409">n</span><span class="op" id="3851410">]</span><span class="op" id="3851411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851414">if</span>&nbsp;<span class="ident" id="3851417">n</span>&nbsp;<span class="op" id="3851419">&lt;</span>&nbsp;<span class="ident" id="3851421">b</span><span class="op" id="3851422">.</span><span class="ident" id="3851423">n</span>&nbsp;<span class="op" id="3851425">&amp;&amp;</span>&nbsp;<span class="ident" id="3851428">err</span>&nbsp;<span class="op" id="3851432">==</span>&nbsp;<span class="ident" id="3851435">nil</span>&nbsp;<span class="op" id="3851439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851443">err</span>&nbsp;<span class="op" id="3851447">=</span>&nbsp;<span class="ident" id="3851449">io</span><span class="op" id="3851451">.</span><span class="ident" id="3851452">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851470">if</span>&nbsp;<span class="ident" id="3851473">err</span>&nbsp;<span class="op" id="3851477">!=</span>&nbsp;<span class="ident" id="3851480">nil</span>&nbsp;<span class="op" id="3851484">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851488">if</span>&nbsp;<span class="ident" id="3851491">n</span>&nbsp;<span class="op" id="3851493">&gt;</span>&nbsp;<span class="num" id="3851495">0</span>&nbsp;<span class="op" id="3851497">&amp;&amp;</span>&nbsp;<span class="ident" id="3851500">n</span>&nbsp;<span class="op" id="3851502">&lt;</span>&nbsp;<span class="ident" id="3851504">b</span><span class="op" id="3851505">.</span><span class="ident" id="3851506">n</span>&nbsp;<span class="op" id="3851508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3851513">copy</span><span class="op" id="3851517">(</span><span class="ident" id="3851518">b</span><span class="op" id="3851519">.</span><span class="ident" id="3851520">buf</span><span class="op" id="3851523">[</span><span class="num" id="3851524">0</span><span class="op" id="3851525">:</span><span class="ident" id="3851526">b</span><span class="op" id="3851527">.</span><span class="ident" id="3851528">n</span><span class="op" id="3851529">-</span><span class="ident" id="3851530">n</span><span class="op" id="3851531">]</span><span class="op" id="3851532">,</span>&nbsp;<span class="ident" id="3851534">b</span><span class="op" id="3851535">.</span><span class="ident" id="3851536">buf</span><span class="op" id="3851539">[</span><span class="ident" id="3851540">n</span><span class="op" id="3851541">:</span><span class="ident" id="3851542">b</span><span class="op" id="3851543">.</span><span class="ident" id="3851544">n</span><span class="op" id="3851545">]</span><span class="op" id="3851546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851554">b</span><span class="op" id="3851555">.</span><span class="ident" id="3851556">n</span>&nbsp;<span class="op" id="3851558">-=</span>&nbsp;<span class="ident" id="3851561">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851565">b</span><span class="op" id="3851566">.</span><span class="ident" id="3851567">err</span>&nbsp;<span class="op" id="3851571">=</span>&nbsp;<span class="ident" id="3851573">err</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851579">return</span>&nbsp;<span class="ident" id="3851586">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851594">b</span><span class="op" id="3851595">.</span><span class="ident" id="3851596">n</span>&nbsp;<span class="op" id="3851598">=</span>&nbsp;<span class="num" id="3851600">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851603">return</span>&nbsp;<span class="ident" id="3851610">nil</span><br>
<span class="lineno"></span><span class="op" id="3851614">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="3851617">//&nbsp;Available&nbsp;returns&nbsp;how&nbsp;many&nbsp;bytes&nbsp;are&nbsp;unused&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3851679">func</span>&nbsp;<span class="op" id="3851684">(</span><span class="ident" id="3851685">b</span>&nbsp;<span class="op" id="3851687">*</span><span class="ident" id="3851688">Writer</span><span class="op" id="3851694">)</span>&nbsp;<span class="ident" id="3851696">Available</span><span class="op" id="3851705">(</span><span class="op" id="3851706">)</span>&nbsp;<span class="builtintype" id="3851708">int</span>&nbsp;<span class="op" id="3851712">{</span>&nbsp;<span class="keyword" id="3851714">return</span>&nbsp;<span class="builtinfunc" id="3851721">len</span><span class="op" id="3851724">(</span><span class="ident" id="3851725">b</span><span class="op" id="3851726">.</span><span class="ident" id="3851727">buf</span><span class="op" id="3851730">)</span>&nbsp;<span class="op" id="3851732">-</span>&nbsp;<span class="ident" id="3851734">b</span><span class="op" id="3851735">.</span><span class="ident" id="3851736">n</span>&nbsp;<span class="op" id="3851738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3851741">//&nbsp;Buffered&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;that&nbsp;have&nbsp;been&nbsp;written&nbsp;into&nbsp;the&nbsp;current&nbsp;buffer.</span><br>
<span class="lineno">550</span><span class="keyword" id="3851829">func</span>&nbsp;<span class="op" id="3851834">(</span><span class="ident" id="3851835">b</span>&nbsp;<span class="op" id="3851837">*</span><span class="ident" id="3851838">Writer</span><span class="op" id="3851844">)</span>&nbsp;<span class="ident" id="3851846">Buffered</span><span class="op" id="3851854">(</span><span class="op" id="3851855">)</span>&nbsp;<span class="builtintype" id="3851857">int</span>&nbsp;<span class="op" id="3851861">{</span>&nbsp;<span class="keyword" id="3851863">return</span>&nbsp;<span class="ident" id="3851870">b</span><span class="op" id="3851871">.</span><span class="ident" id="3851872">n</span>&nbsp;<span class="op" id="3851874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3851877">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;contents&nbsp;of&nbsp;p&nbsp;into&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="3851928">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="3851971">//&nbsp;If&nbsp;nn&nbsp;&lt;&nbsp;len(p),&nbsp;it&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining</span><br>
<span class="lineno">555</span><span class="comment" id="3852026">//&nbsp;why&nbsp;the&nbsp;write&nbsp;is&nbsp;short.</span><br>
<span class="lineno"></span><span class="keyword" id="3852053">func</span>&nbsp;<span class="op" id="3852058">(</span><span class="ident" id="3852059">b</span>&nbsp;<span class="op" id="3852061">*</span><span class="ident" id="3852062">Writer</span><span class="op" id="3852068">)</span>&nbsp;<span class="ident" id="3852070">Write</span><span class="op" id="3852075">(</span><span class="ident" id="3852076">p</span>&nbsp;<span class="op" id="3852078">[</span><span class="op" id="3852079">]</span><span class="builtintype" id="3852080">byte</span><span class="op" id="3852084">)</span>&nbsp;<span class="op" id="3852086">(</span><span class="ident" id="3852087">nn</span>&nbsp;<span class="builtintype" id="3852090">int</span><span class="op" id="3852093">,</span>&nbsp;<span class="ident" id="3852095">err</span>&nbsp;<span class="builtintype" id="3852099">error</span><span class="op" id="3852104">)</span>&nbsp;<span class="op" id="3852106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852109">for</span>&nbsp;<span class="builtinfunc" id="3852113">len</span><span class="op" id="3852116">(</span><span class="ident" id="3852117">p</span><span class="op" id="3852118">)</span>&nbsp;<span class="op" id="3852120">&gt;</span>&nbsp;<span class="ident" id="3852122">b</span><span class="op" id="3852123">.</span><span class="ident" id="3852124">Available</span><span class="op" id="3852133">(</span><span class="op" id="3852134">)</span>&nbsp;<span class="op" id="3852136">&amp;&amp;</span>&nbsp;<span class="ident" id="3852139">b</span><span class="op" id="3852140">.</span><span class="ident" id="3852141">err</span>&nbsp;<span class="op" id="3852145">==</span>&nbsp;<span class="ident" id="3852148">nil</span>&nbsp;<span class="op" id="3852152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852156">var</span>&nbsp;<span class="ident" id="3852160">n</span>&nbsp;<span class="builtintype" id="3852162">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852168">if</span>&nbsp;<span class="ident" id="3852171">b</span><span class="op" id="3852172">.</span><span class="ident" id="3852173">Buffered</span><span class="op" id="3852181">(</span><span class="op" id="3852182">)</span>&nbsp;<span class="op" id="3852184">==</span>&nbsp;<span class="num" id="3852187">0</span>&nbsp;<span class="op" id="3852189">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3852194">//&nbsp;Large&nbsp;write,&nbsp;empty&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3852227">//&nbsp;Write&nbsp;directly&nbsp;from&nbsp;p&nbsp;to&nbsp;avoid&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852270">n</span><span class="op" id="3852271">,</span>&nbsp;<span class="ident" id="3852273">b</span><span class="op" id="3852274">.</span><span class="ident" id="3852275">err</span>&nbsp;<span class="op" id="3852279">=</span>&nbsp;<span class="ident" id="3852281">b</span><span class="op" id="3852282">.</span><span class="ident" id="3852283">wr</span><span class="op" id="3852285">.</span><span class="ident" id="3852286">Write</span><span class="op" id="3852291">(</span><span class="ident" id="3852292">p</span><span class="op" id="3852293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852297">}</span>&nbsp;<span class="keyword" id="3852299">else</span>&nbsp;<span class="op" id="3852304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852309">n</span>&nbsp;<span class="op" id="3852311">=</span>&nbsp;<span class="builtinfunc" id="3852313">copy</span><span class="op" id="3852317">(</span><span class="ident" id="3852318">b</span><span class="op" id="3852319">.</span><span class="ident" id="3852320">buf</span><span class="op" id="3852323">[</span><span class="ident" id="3852324">b</span><span class="op" id="3852325">.</span><span class="ident" id="3852326">n</span><span class="op" id="3852327">:</span><span class="op" id="3852328">]</span><span class="op" id="3852329">,</span>&nbsp;<span class="ident" id="3852331">p</span><span class="op" id="3852332">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852337">b</span><span class="op" id="3852338">.</span><span class="ident" id="3852339">n</span>&nbsp;<span class="op" id="3852341">+=</span>&nbsp;<span class="ident" id="3852344">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852349">b</span><span class="op" id="3852350">.</span><span class="ident" id="3852351">flush</span><span class="op" id="3852356">(</span><span class="op" id="3852357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852365">nn</span>&nbsp;<span class="op" id="3852368">+=</span>&nbsp;<span class="ident" id="3852371">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852375">p</span>&nbsp;<span class="op" id="3852377">=</span>&nbsp;<span class="ident" id="3852379">p</span><span class="op" id="3852380">[</span><span class="ident" id="3852381">n</span><span class="op" id="3852382">:</span><span class="op" id="3852383">]</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852389">if</span>&nbsp;<span class="ident" id="3852392">b</span><span class="op" id="3852393">.</span><span class="ident" id="3852394">err</span>&nbsp;<span class="op" id="3852398">!=</span>&nbsp;<span class="ident" id="3852401">nil</span>&nbsp;<span class="op" id="3852405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852409">return</span>&nbsp;<span class="ident" id="3852416">nn</span><span class="op" id="3852418">,</span>&nbsp;<span class="ident" id="3852420">b</span><span class="op" id="3852421">.</span><span class="ident" id="3852422">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852430">n</span>&nbsp;<span class="op" id="3852432">:=</span>&nbsp;<span class="builtinfunc" id="3852435">copy</span><span class="op" id="3852439">(</span><span class="ident" id="3852440">b</span><span class="op" id="3852441">.</span><span class="ident" id="3852442">buf</span><span class="op" id="3852445">[</span><span class="ident" id="3852446">b</span><span class="op" id="3852447">.</span><span class="ident" id="3852448">n</span><span class="op" id="3852449">:</span><span class="op" id="3852450">]</span><span class="op" id="3852451">,</span>&nbsp;<span class="ident" id="3852453">p</span><span class="op" id="3852454">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852457">b</span><span class="op" id="3852458">.</span><span class="ident" id="3852459">n</span>&nbsp;<span class="op" id="3852461">+=</span>&nbsp;<span class="ident" id="3852464">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852467">nn</span>&nbsp;<span class="op" id="3852470">+=</span>&nbsp;<span class="ident" id="3852473">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852476">return</span>&nbsp;<span class="ident" id="3852483">nn</span><span class="op" id="3852485">,</span>&nbsp;<span class="ident" id="3852487">nil</span><br>
<span class="lineno"></span><span class="op" id="3852491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span><span class="comment" id="3852494">//&nbsp;WriteByte&nbsp;writes&nbsp;a&nbsp;single&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="3852529">func</span>&nbsp;<span class="op" id="3852534">(</span><span class="ident" id="3852535">b</span>&nbsp;<span class="op" id="3852537">*</span><span class="ident" id="3852538">Writer</span><span class="op" id="3852544">)</span>&nbsp;<span class="ident" id="3852546">WriteByte</span><span class="op" id="3852555">(</span><span class="ident" id="3852556">c</span>&nbsp;<span class="builtintype" id="3852558">byte</span><span class="op" id="3852562">)</span>&nbsp;<span class="builtintype" id="3852564">error</span>&nbsp;<span class="op" id="3852570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852573">if</span>&nbsp;<span class="ident" id="3852576">b</span><span class="op" id="3852577">.</span><span class="ident" id="3852578">err</span>&nbsp;<span class="op" id="3852582">!=</span>&nbsp;<span class="ident" id="3852585">nil</span>&nbsp;<span class="op" id="3852589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852593">return</span>&nbsp;<span class="ident" id="3852600">b</span><span class="op" id="3852601">.</span><span class="ident" id="3852602">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852607">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852610">if</span>&nbsp;<span class="ident" id="3852613">b</span><span class="op" id="3852614">.</span><span class="ident" id="3852615">Available</span><span class="op" id="3852624">(</span><span class="op" id="3852625">)</span>&nbsp;<span class="op" id="3852627">&lt;=</span>&nbsp;<span class="num" id="3852630">0</span>&nbsp;<span class="op" id="3852632">&amp;&amp;</span>&nbsp;<span class="ident" id="3852635">b</span><span class="op" id="3852636">.</span><span class="ident" id="3852637">flush</span><span class="op" id="3852642">(</span><span class="op" id="3852643">)</span>&nbsp;<span class="op" id="3852645">!=</span>&nbsp;<span class="ident" id="3852648">nil</span>&nbsp;<span class="op" id="3852652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852656">return</span>&nbsp;<span class="ident" id="3852663">b</span><span class="op" id="3852664">.</span><span class="ident" id="3852665">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852673">b</span><span class="op" id="3852674">.</span><span class="ident" id="3852675">buf</span><span class="op" id="3852678">[</span><span class="ident" id="3852679">b</span><span class="op" id="3852680">.</span><span class="ident" id="3852681">n</span><span class="op" id="3852682">]</span>&nbsp;<span class="op" id="3852684">=</span>&nbsp;<span class="ident" id="3852686">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852689">b</span><span class="op" id="3852690">.</span><span class="ident" id="3852691">n</span><span class="op" id="3852692">++</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852696">return</span>&nbsp;<span class="ident" id="3852703">nil</span><br>
<span class="lineno"></span><span class="op" id="3852707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3852710">//&nbsp;WriteRune&nbsp;writes&nbsp;a&nbsp;single&nbsp;Unicode&nbsp;code&nbsp;point,&nbsp;returning</span><br>
<span class="lineno"></span><span class="comment" id="3852769">//&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;and&nbsp;any&nbsp;error.</span><br>
<span class="lineno">595</span><span class="keyword" id="3852815">func</span>&nbsp;<span class="op" id="3852820">(</span><span class="ident" id="3852821">b</span>&nbsp;<span class="op" id="3852823">*</span><span class="ident" id="3852824">Writer</span><span class="op" id="3852830">)</span>&nbsp;<span class="ident" id="3852832">WriteRune</span><span class="op" id="3852841">(</span><span class="ident" id="3852842">r</span>&nbsp;<span class="builtintype" id="3852844">rune</span><span class="op" id="3852848">)</span>&nbsp;<span class="op" id="3852850">(</span><span class="ident" id="3852851">size</span>&nbsp;<span class="builtintype" id="3852856">int</span><span class="op" id="3852859">,</span>&nbsp;<span class="ident" id="3852861">err</span>&nbsp;<span class="builtintype" id="3852865">error</span><span class="op" id="3852870">)</span>&nbsp;<span class="op" id="3852872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852875">if</span>&nbsp;<span class="ident" id="3852878">r</span>&nbsp;<span class="op" id="3852880">&lt;</span>&nbsp;<span class="ident" id="3852882">utf8</span><span class="op" id="3852886">.</span><span class="ident" id="3852887">RuneSelf</span>&nbsp;<span class="op" id="3852896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852900">err</span>&nbsp;<span class="op" id="3852904">=</span>&nbsp;<span class="ident" id="3852906">b</span><span class="op" id="3852907">.</span><span class="ident" id="3852908">WriteByte</span><span class="op" id="3852917">(</span><span class="builtintype" id="3852918">byte</span><span class="op" id="3852922">(</span><span class="ident" id="3852923">r</span><span class="op" id="3852924">)</span><span class="op" id="3852925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852929">if</span>&nbsp;<span class="ident" id="3852932">err</span>&nbsp;<span class="op" id="3852936">!=</span>&nbsp;<span class="ident" id="3852939">nil</span>&nbsp;<span class="op" id="3852943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852948">return</span>&nbsp;<span class="num" id="3852955">0</span><span class="op" id="3852956">,</span>&nbsp;<span class="ident" id="3852958">err</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852968">return</span>&nbsp;<span class="num" id="3852975">1</span><span class="op" id="3852976">,</span>&nbsp;<span class="ident" id="3852978">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852986">if</span>&nbsp;<span class="ident" id="3852989">b</span><span class="op" id="3852990">.</span><span class="ident" id="3852991">err</span>&nbsp;<span class="op" id="3852995">!=</span>&nbsp;<span class="ident" id="3852998">nil</span>&nbsp;<span class="op" id="3853002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853006">return</span>&nbsp;<span class="num" id="3853013">0</span><span class="op" id="3853014">,</span>&nbsp;<span class="ident" id="3853016">b</span><span class="op" id="3853017">.</span><span class="ident" id="3853018">err</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853026">n</span>&nbsp;<span class="op" id="3853028">:=</span>&nbsp;<span class="ident" id="3853031">b</span><span class="op" id="3853032">.</span><span class="ident" id="3853033">Available</span><span class="op" id="3853042">(</span><span class="op" id="3853043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853046">if</span>&nbsp;<span class="ident" id="3853049">n</span>&nbsp;<span class="op" id="3853051">&lt;</span>&nbsp;<span class="ident" id="3853053">utf8</span><span class="op" id="3853057">.</span><span class="ident" id="3853058">UTFMax</span>&nbsp;<span class="op" id="3853065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853069">if</span>&nbsp;<span class="ident" id="3853072">b</span><span class="op" id="3853073">.</span><span class="ident" id="3853074">flush</span><span class="op" id="3853079">(</span><span class="op" id="3853080">)</span><span class="op" id="3853081">;</span>&nbsp;<span class="ident" id="3853083">b</span><span class="op" id="3853084">.</span><span class="ident" id="3853085">err</span>&nbsp;<span class="op" id="3853089">!=</span>&nbsp;<span class="ident" id="3853092">nil</span>&nbsp;<span class="op" id="3853096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853101">return</span>&nbsp;<span class="num" id="3853108">0</span><span class="op" id="3853109">,</span>&nbsp;<span class="ident" id="3853111">b</span><span class="op" id="3853112">.</span><span class="ident" id="3853113">err</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853123">n</span>&nbsp;<span class="op" id="3853125">=</span>&nbsp;<span class="ident" id="3853127">b</span><span class="op" id="3853128">.</span><span class="ident" id="3853129">Available</span><span class="op" id="3853138">(</span><span class="op" id="3853139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853143">if</span>&nbsp;<span class="ident" id="3853146">n</span>&nbsp;<span class="op" id="3853148">&lt;</span>&nbsp;<span class="ident" id="3853150">utf8</span><span class="op" id="3853154">.</span><span class="ident" id="3853155">UTFMax</span>&nbsp;<span class="op" id="3853162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3853167">//&nbsp;Can&nbsp;only&nbsp;happen&nbsp;if&nbsp;buffer&nbsp;is&nbsp;silly&nbsp;small.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853215">return</span>&nbsp;<span class="ident" id="3853222">b</span><span class="op" id="3853223">.</span><span class="ident" id="3853224">WriteString</span><span class="op" id="3853235">(</span><span class="builtintype" id="3853236">string</span><span class="op" id="3853242">(</span><span class="ident" id="3853243">r</span><span class="op" id="3853244">)</span><span class="op" id="3853245">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853255">size</span>&nbsp;<span class="op" id="3853260">=</span>&nbsp;<span class="ident" id="3853262">utf8</span><span class="op" id="3853266">.</span><span class="ident" id="3853267">EncodeRune</span><span class="op" id="3853277">(</span><span class="ident" id="3853278">b</span><span class="op" id="3853279">.</span><span class="ident" id="3853280">buf</span><span class="op" id="3853283">[</span><span class="ident" id="3853284">b</span><span class="op" id="3853285">.</span><span class="ident" id="3853286">n</span><span class="op" id="3853287">:</span><span class="op" id="3853288">]</span><span class="op" id="3853289">,</span>&nbsp;<span class="ident" id="3853291">r</span><span class="op" id="3853292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853295">b</span><span class="op" id="3853296">.</span><span class="ident" id="3853297">n</span>&nbsp;<span class="op" id="3853299">+=</span>&nbsp;<span class="ident" id="3853302">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853308">return</span>&nbsp;<span class="ident" id="3853315">size</span><span class="op" id="3853319">,</span>&nbsp;<span class="ident" id="3853321">nil</span><br>
<span class="lineno">620</span><span class="op" id="3853325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3853328">//&nbsp;WriteString&nbsp;writes&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="comment" id="3853360">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="3853403">//&nbsp;If&nbsp;the&nbsp;count&nbsp;is&nbsp;less&nbsp;than&nbsp;len(s),&nbsp;it&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining</span><br>
<span class="lineno">625</span><span class="comment" id="3853476">//&nbsp;why&nbsp;the&nbsp;write&nbsp;is&nbsp;short.</span><br>
<span class="lineno"></span><span class="keyword" id="3853503">func</span>&nbsp;<span class="op" id="3853508">(</span><span class="ident" id="3853509">b</span>&nbsp;<span class="op" id="3853511">*</span><span class="ident" id="3853512">Writer</span><span class="op" id="3853518">)</span>&nbsp;<span class="ident" id="3853520">WriteString</span><span class="op" id="3853531">(</span><span class="ident" id="3853532">s</span>&nbsp;<span class="builtintype" id="3853534">string</span><span class="op" id="3853540">)</span>&nbsp;<span class="op" id="3853542">(</span><span class="builtintype" id="3853543">int</span><span class="op" id="3853546">,</span>&nbsp;<span class="builtintype" id="3853548">error</span><span class="op" id="3853553">)</span>&nbsp;<span class="op" id="3853555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853558">nn</span>&nbsp;<span class="op" id="3853561">:=</span>&nbsp;<span class="num" id="3853564">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853567">for</span>&nbsp;<span class="builtinfunc" id="3853571">len</span><span class="op" id="3853574">(</span><span class="ident" id="3853575">s</span><span class="op" id="3853576">)</span>&nbsp;<span class="op" id="3853578">&gt;</span>&nbsp;<span class="ident" id="3853580">b</span><span class="op" id="3853581">.</span><span class="ident" id="3853582">Available</span><span class="op" id="3853591">(</span><span class="op" id="3853592">)</span>&nbsp;<span class="op" id="3853594">&amp;&amp;</span>&nbsp;<span class="ident" id="3853597">b</span><span class="op" id="3853598">.</span><span class="ident" id="3853599">err</span>&nbsp;<span class="op" id="3853603">==</span>&nbsp;<span class="ident" id="3853606">nil</span>&nbsp;<span class="op" id="3853610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853614">n</span>&nbsp;<span class="op" id="3853616">:=</span>&nbsp;<span class="builtinfunc" id="3853619">copy</span><span class="op" id="3853623">(</span><span class="ident" id="3853624">b</span><span class="op" id="3853625">.</span><span class="ident" id="3853626">buf</span><span class="op" id="3853629">[</span><span class="ident" id="3853630">b</span><span class="op" id="3853631">.</span><span class="ident" id="3853632">n</span><span class="op" id="3853633">:</span><span class="op" id="3853634">]</span><span class="op" id="3853635">,</span>&nbsp;<span class="ident" id="3853637">s</span><span class="op" id="3853638">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853642">b</span><span class="op" id="3853643">.</span><span class="ident" id="3853644">n</span>&nbsp;<span class="op" id="3853646">+=</span>&nbsp;<span class="ident" id="3853649">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853653">nn</span>&nbsp;<span class="op" id="3853656">+=</span>&nbsp;<span class="ident" id="3853659">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853663">s</span>&nbsp;<span class="op" id="3853665">=</span>&nbsp;<span class="ident" id="3853667">s</span><span class="op" id="3853668">[</span><span class="ident" id="3853669">n</span><span class="op" id="3853670">:</span><span class="op" id="3853671">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853675">b</span><span class="op" id="3853676">.</span><span class="ident" id="3853677">flush</span><span class="op" id="3853682">(</span><span class="op" id="3853683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853686">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853689">if</span>&nbsp;<span class="ident" id="3853692">b</span><span class="op" id="3853693">.</span><span class="ident" id="3853694">err</span>&nbsp;<span class="op" id="3853698">!=</span>&nbsp;<span class="ident" id="3853701">nil</span>&nbsp;<span class="op" id="3853705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853709">return</span>&nbsp;<span class="ident" id="3853716">nn</span><span class="op" id="3853718">,</span>&nbsp;<span class="ident" id="3853720">b</span><span class="op" id="3853721">.</span><span class="ident" id="3853722">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853730">n</span>&nbsp;<span class="op" id="3853732">:=</span>&nbsp;<span class="builtinfunc" id="3853735">copy</span><span class="op" id="3853739">(</span><span class="ident" id="3853740">b</span><span class="op" id="3853741">.</span><span class="ident" id="3853742">buf</span><span class="op" id="3853745">[</span><span class="ident" id="3853746">b</span><span class="op" id="3853747">.</span><span class="ident" id="3853748">n</span><span class="op" id="3853749">:</span><span class="op" id="3853750">]</span><span class="op" id="3853751">,</span>&nbsp;<span class="ident" id="3853753">s</span><span class="op" id="3853754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853757">b</span><span class="op" id="3853758">.</span><span class="ident" id="3853759">n</span>&nbsp;<span class="op" id="3853761">+=</span>&nbsp;<span class="ident" id="3853764">n</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853767">nn</span>&nbsp;<span class="op" id="3853770">+=</span>&nbsp;<span class="ident" id="3853773">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853776">return</span>&nbsp;<span class="ident" id="3853783">nn</span><span class="op" id="3853785">,</span>&nbsp;<span class="ident" id="3853787">nil</span><br>
<span class="lineno"></span><span class="op" id="3853791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3853794">//&nbsp;ReadFrom&nbsp;implements&nbsp;io.ReaderFrom.</span><br>
<span class="lineno">645</span><span class="keyword" id="3853832">func</span>&nbsp;<span class="op" id="3853837">(</span><span class="ident" id="3853838">b</span>&nbsp;<span class="op" id="3853840">*</span><span class="ident" id="3853841">Writer</span><span class="op" id="3853847">)</span>&nbsp;<span class="ident" id="3853849">ReadFrom</span><span class="op" id="3853857">(</span><span class="ident" id="3853858">r</span>&nbsp;<span class="ident" id="3853860">io</span><span class="op" id="3853862">.</span><span class="ident" id="3853863">Reader</span><span class="op" id="3853869">)</span>&nbsp;<span class="op" id="3853871">(</span><span class="ident" id="3853872">n</span>&nbsp;<span class="ident" id="3853874">int64</span><span class="op" id="3853879">,</span>&nbsp;<span class="ident" id="3853881">err</span>&nbsp;<span class="builtintype" id="3853885">error</span><span class="op" id="3853890">)</span>&nbsp;<span class="op" id="3853892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853895">if</span>&nbsp;<span class="ident" id="3853898">b</span><span class="op" id="3853899">.</span><span class="ident" id="3853900">Buffered</span><span class="op" id="3853908">(</span><span class="op" id="3853909">)</span>&nbsp;<span class="op" id="3853911">==</span>&nbsp;<span class="num" id="3853914">0</span>&nbsp;<span class="op" id="3853916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853920">if</span>&nbsp;<span class="ident" id="3853923">w</span><span class="op" id="3853924">,</span>&nbsp;<span class="ident" id="3853926">ok</span>&nbsp;<span class="op" id="3853929">:=</span>&nbsp;<span class="ident" id="3853932">b</span><span class="op" id="3853933">.</span><span class="ident" id="3853934">wr</span><span class="op" id="3853936">.</span><span class="op" id="3853937">(</span><span class="ident" id="3853938">io</span><span class="op" id="3853940">.</span><span class="ident" id="3853941">ReaderFrom</span><span class="op" id="3853951">)</span><span class="op" id="3853952">;</span>&nbsp;<span class="ident" id="3853954">ok</span>&nbsp;<span class="op" id="3853957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853962">return</span>&nbsp;<span class="ident" id="3853969">w</span><span class="op" id="3853970">.</span><span class="ident" id="3853971">ReadFrom</span><span class="op" id="3853979">(</span><span class="ident" id="3853980">r</span><span class="op" id="3853981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853985">}</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853991">var</span>&nbsp;<span class="ident" id="3853995">m</span>&nbsp;<span class="builtintype" id="3853997">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854002">for</span>&nbsp;<span class="op" id="3854006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854010">if</span>&nbsp;<span class="ident" id="3854013">b</span><span class="op" id="3854014">.</span><span class="ident" id="3854015">Available</span><span class="op" id="3854024">(</span><span class="op" id="3854025">)</span>&nbsp;<span class="op" id="3854027">==</span>&nbsp;<span class="num" id="3854030">0</span>&nbsp;<span class="op" id="3854032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854037">if</span>&nbsp;<span class="ident" id="3854040">err1</span>&nbsp;<span class="op" id="3854045">:=</span>&nbsp;<span class="ident" id="3854048">b</span><span class="op" id="3854049">.</span><span class="ident" id="3854050">flush</span><span class="op" id="3854055">(</span><span class="op" id="3854056">)</span><span class="op" id="3854057">;</span>&nbsp;<span class="ident" id="3854059">err1</span>&nbsp;<span class="op" id="3854064">!=</span>&nbsp;<span class="ident" id="3854067">nil</span>&nbsp;<span class="op" id="3854071">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854077">return</span>&nbsp;<span class="ident" id="3854084">n</span><span class="op" id="3854085">,</span>&nbsp;<span class="ident" id="3854087">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854103">nr</span>&nbsp;<span class="op" id="3854106">:=</span>&nbsp;<span class="num" id="3854109">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854113">for</span>&nbsp;<span class="ident" id="3854117">nr</span>&nbsp;<span class="op" id="3854120">&lt;</span>&nbsp;<span class="ident" id="3854122">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="3854147">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854152">m</span><span class="op" id="3854153">,</span>&nbsp;<span class="ident" id="3854155">err</span>&nbsp;<span class="op" id="3854159">=</span>&nbsp;<span class="ident" id="3854161">r</span><span class="op" id="3854162">.</span><span class="ident" id="3854163">Read</span><span class="op" id="3854167">(</span><span class="ident" id="3854168">b</span><span class="op" id="3854169">.</span><span class="ident" id="3854170">buf</span><span class="op" id="3854173">[</span><span class="ident" id="3854174">b</span><span class="op" id="3854175">.</span><span class="ident" id="3854176">n</span><span class="op" id="3854177">:</span><span class="op" id="3854178">]</span><span class="op" id="3854179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854184">if</span>&nbsp;<span class="ident" id="3854187">m</span>&nbsp;<span class="op" id="3854189">!=</span>&nbsp;<span class="num" id="3854192">0</span>&nbsp;<span class="op" id="3854194">||</span>&nbsp;<span class="ident" id="3854197">err</span>&nbsp;<span class="op" id="3854201">!=</span>&nbsp;<span class="ident" id="3854204">nil</span>&nbsp;<span class="op" id="3854208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854214">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854228">nr</span><span class="op" id="3854230">++</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854239">if</span>&nbsp;<span class="ident" id="3854242">nr</span>&nbsp;<span class="op" id="3854245">==</span>&nbsp;<span class="ident" id="3854248">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="3854273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854278">return</span>&nbsp;<span class="ident" id="3854285">n</span><span class="op" id="3854286">,</span>&nbsp;<span class="ident" id="3854288">io</span><span class="op" id="3854290">.</span><span class="ident" id="3854291">ErrNoProgress</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854311">b</span><span class="op" id="3854312">.</span><span class="ident" id="3854313">n</span>&nbsp;<span class="op" id="3854315">+=</span>&nbsp;<span class="ident" id="3854318">m</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854322">n</span>&nbsp;<span class="op" id="3854324">+=</span>&nbsp;<span class="ident" id="3854327">int64</span><span class="op" id="3854332">(</span><span class="ident" id="3854333">m</span><span class="op" id="3854334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854338">if</span>&nbsp;<span class="ident" id="3854341">err</span>&nbsp;<span class="op" id="3854345">!=</span>&nbsp;<span class="ident" id="3854348">nil</span>&nbsp;<span class="op" id="3854352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854357">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854368">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854371">if</span>&nbsp;<span class="ident" id="3854374">err</span>&nbsp;<span class="op" id="3854378">==</span>&nbsp;<span class="ident" id="3854381">io</span><span class="op" id="3854383">.</span><span class="ident" id="3854384">EOF</span>&nbsp;<span class="op" id="3854388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854392">//&nbsp;If&nbsp;we&nbsp;filled&nbsp;the&nbsp;buffer&nbsp;exactly,&nbsp;flush&nbsp;pre-emptively.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854451">if</span>&nbsp;<span class="ident" id="3854454">b</span><span class="op" id="3854455">.</span><span class="ident" id="3854456">Available</span><span class="op" id="3854465">(</span><span class="op" id="3854466">)</span>&nbsp;<span class="op" id="3854468">==</span>&nbsp;<span class="num" id="3854471">0</span>&nbsp;<span class="op" id="3854473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854478">err</span>&nbsp;<span class="op" id="3854482">=</span>&nbsp;<span class="ident" id="3854484">b</span><span class="op" id="3854485">.</span><span class="ident" id="3854486">flush</span><span class="op" id="3854491">(</span><span class="op" id="3854492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854496">}</span>&nbsp;<span class="keyword" id="3854498">else</span>&nbsp;<span class="op" id="3854503">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854508">err</span>&nbsp;<span class="op" id="3854512">=</span>&nbsp;<span class="ident" id="3854514">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854526">return</span>&nbsp;<span class="ident" id="3854533">n</span><span class="op" id="3854534">,</span>&nbsp;<span class="ident" id="3854536">err</span><br>
<span class="lineno"></span><span class="op" id="3854540">}</span><br>
<span class="lineno">685</span><br>
<span class="lineno"></span><span class="comment" id="3854543">//&nbsp;buffered&nbsp;input&nbsp;and&nbsp;output</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3854573">//&nbsp;ReadWriter&nbsp;stores&nbsp;pointers&nbsp;to&nbsp;a&nbsp;Reader&nbsp;and&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="comment" id="3854629">//&nbsp;It&nbsp;implements&nbsp;io.ReadWriter.</span><br>
<span class="lineno">690</span><span class="keyword" id="3854661">type</span>&nbsp;<span class="ident" id="3854666">ReadWriter</span>&nbsp;<span class="keyword" id="3854677">struct</span>&nbsp;<span class="op" id="3854684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854687">*</span><span class="ident" id="3854688">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854696">*</span><span class="ident" id="3854697">Writer</span><br>
<span class="lineno"></span><span class="op" id="3854704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span><span class="comment" id="3854707">//&nbsp;NewReadWriter&nbsp;allocates&nbsp;a&nbsp;new&nbsp;ReadWriter&nbsp;that&nbsp;dispatches&nbsp;to&nbsp;r&nbsp;and&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="3854779">func</span>&nbsp;<span class="ident" id="3854784">NewReadWriter</span><span class="op" id="3854797">(</span><span class="ident" id="3854798">r</span>&nbsp;<span class="op" id="3854800">*</span><span class="ident" id="3854801">Reader</span><span class="op" id="3854807">,</span>&nbsp;<span class="ident" id="3854809">w</span>&nbsp;<span class="op" id="3854811">*</span><span class="ident" id="3854812">Writer</span><span class="op" id="3854818">)</span>&nbsp;<span class="op" id="3854820">*</span><span class="ident" id="3854821">ReadWriter</span>&nbsp;<span class="op" id="3854832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854835">return</span>&nbsp;<span class="op" id="3854842">&amp;</span><span class="ident" id="3854843">ReadWriter</span><span class="op" id="3854853">{</span><span class="ident" id="3854854">r</span><span class="op" id="3854855">,</span>&nbsp;<span class="ident" id="3854857">w</span><span class="op" id="3854858">}</span><br>
<span class="lineno"></span><span class="op" id="3854860">}</span>
</div>
</body>
</html>
