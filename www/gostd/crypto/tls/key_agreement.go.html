<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4185185">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4185240">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4185294">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4185345">package</span>&nbsp;<span class="ident" id="4185353">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4185358">import</span>&nbsp;<span class="op" id="4185365">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185368">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185378">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185394">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185413">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185427">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185441">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185456">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185473">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185488">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185505">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185515">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4185521">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4185532">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4185535">var</span>&nbsp;<span class="ident" id="4185539">errClientKeyExchange</span>&nbsp;<span class="op" id="4185560">=</span>&nbsp;<span class="ident" id="4185562">errors</span><span class="op" id="4185568">.</span><span class="ident" id="4185569">New</span><span class="op" id="4185572">(</span><span class="string" id="4185573">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="4185613">)</span><br>
<span class="lineno"></span><span class="keyword" id="4185615">var</span>&nbsp;<span class="ident" id="4185619">errServerKeyExchange</span>&nbsp;<span class="op" id="4185640">=</span>&nbsp;<span class="ident" id="4185642">errors</span><span class="op" id="4185648">.</span><span class="ident" id="4185649">New</span><span class="op" id="4185652">(</span><span class="string" id="4185653">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4185693">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4185696">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4185774">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4185836">type</span>&nbsp;<span class="ident" id="4185841">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="4185857">struct</span><span class="op" id="4185863">{</span><span class="op" id="4185864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4185867">func</span>&nbsp;<span class="op" id="4185872">(</span><span class="ident" id="4185873">ka</span>&nbsp;<span class="ident" id="4185876">rsaKeyAgreement</span><span class="op" id="4185891">)</span>&nbsp;<span class="ident" id="4185893">generateServerKeyExchange</span><span class="op" id="4185918">(</span><span class="ident" id="4185919">config</span>&nbsp;<span class="op" id="4185926">*</span><span class="ident" id="4185927">Config</span><span class="op" id="4185933">,</span>&nbsp;<span class="ident" id="4185935">cert</span>&nbsp;<span class="op" id="4185940">*</span><span class="ident" id="4185941">Certificate</span><span class="op" id="4185952">,</span>&nbsp;<span class="ident" id="4185954">clientHello</span>&nbsp;<span class="op" id="4185966">*</span><span class="ident" id="4185967">clientHelloMsg</span><span class="op" id="4185981">,</span>&nbsp;<span class="ident" id="4185983">hello</span>&nbsp;<span class="op" id="4185989">*</span><span class="ident" id="4185990">serverHelloMsg</span><span class="op" id="4186004">)</span>&nbsp;<span class="op" id="4186006">(</span><span class="op" id="4186007">*</span><span class="ident" id="4186008">serverKeyExchangeMsg</span><span class="op" id="4186028">,</span>&nbsp;<span class="builtintype" id="4186030">error</span><span class="op" id="4186035">)</span>&nbsp;<span class="op" id="4186037">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186040">return</span>&nbsp;<span class="ident" id="4186047">nil</span><span class="op" id="4186050">,</span>&nbsp;<span class="ident" id="4186052">nil</span><br>
<span class="lineno"></span><span class="op" id="4186056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4186059">func</span>&nbsp;<span class="op" id="4186064">(</span><span class="ident" id="4186065">ka</span>&nbsp;<span class="ident" id="4186068">rsaKeyAgreement</span><span class="op" id="4186083">)</span>&nbsp;<span class="ident" id="4186085">processClientKeyExchange</span><span class="op" id="4186109">(</span><span class="ident" id="4186110">config</span>&nbsp;<span class="op" id="4186117">*</span><span class="ident" id="4186118">Config</span><span class="op" id="4186124">,</span>&nbsp;<span class="ident" id="4186126">cert</span>&nbsp;<span class="op" id="4186131">*</span><span class="ident" id="4186132">Certificate</span><span class="op" id="4186143">,</span>&nbsp;<span class="ident" id="4186145">ckx</span>&nbsp;<span class="op" id="4186149">*</span><span class="ident" id="4186150">clientKeyExchangeMsg</span><span class="op" id="4186170">,</span>&nbsp;<span class="ident" id="4186172">version</span>&nbsp;<span class="builtintype" id="4186180">uint16</span><span class="op" id="4186186">)</span>&nbsp;<span class="op" id="4186188">(</span><span class="op" id="4186189">[</span><span class="op" id="4186190">]</span><span class="builtintype" id="4186191">byte</span><span class="op" id="4186195">,</span>&nbsp;<span class="builtintype" id="4186197">error</span><span class="op" id="4186202">)</span>&nbsp;<span class="op" id="4186204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186207">preMasterSecret</span>&nbsp;<span class="op" id="4186223">:=</span>&nbsp;<span class="builtinfunc" id="4186226">make</span><span class="op" id="4186230">(</span><span class="op" id="4186231">[</span><span class="op" id="4186232">]</span><span class="builtintype" id="4186233">byte</span><span class="op" id="4186237">,</span>&nbsp;<span class="num" id="4186239">48</span><span class="op" id="4186241">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186244">_</span><span class="op" id="4186245">,</span>&nbsp;<span class="ident" id="4186247">err</span>&nbsp;<span class="op" id="4186251">:=</span>&nbsp;<span class="ident" id="4186254">io</span><span class="op" id="4186256">.</span><span class="ident" id="4186257">ReadFull</span><span class="op" id="4186265">(</span><span class="ident" id="4186266">config</span><span class="op" id="4186272">.</span><span class="ident" id="4186273">rand</span><span class="op" id="4186277">(</span><span class="op" id="4186278">)</span><span class="op" id="4186279">,</span>&nbsp;<span class="ident" id="4186281">preMasterSecret</span><span class="op" id="4186296">[</span><span class="num" id="4186297">2</span><span class="op" id="4186298">:</span><span class="op" id="4186299">]</span><span class="op" id="4186300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186303">if</span>&nbsp;<span class="ident" id="4186306">err</span>&nbsp;<span class="op" id="4186310">!=</span>&nbsp;<span class="ident" id="4186313">nil</span>&nbsp;<span class="op" id="4186317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186321">return</span>&nbsp;<span class="ident" id="4186328">nil</span><span class="op" id="4186331">,</span>&nbsp;<span class="ident" id="4186333">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186342">if</span>&nbsp;<span class="builtinfunc" id="4186345">len</span><span class="op" id="4186348">(</span><span class="ident" id="4186349">ckx</span><span class="op" id="4186352">.</span><span class="ident" id="4186353">ciphertext</span><span class="op" id="4186363">)</span>&nbsp;<span class="op" id="4186365">&lt;</span>&nbsp;<span class="num" id="4186367">2</span>&nbsp;<span class="op" id="4186369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186373">return</span>&nbsp;<span class="ident" id="4186380">nil</span><span class="op" id="4186383">,</span>&nbsp;<span class="ident" id="4186385">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186411">ciphertext</span>&nbsp;<span class="op" id="4186422">:=</span>&nbsp;<span class="ident" id="4186425">ckx</span><span class="op" id="4186428">.</span><span class="ident" id="4186429">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186441">if</span>&nbsp;<span class="ident" id="4186444">version</span>&nbsp;<span class="op" id="4186452">!=</span>&nbsp;<span class="ident" id="4186455">VersionSSL30</span>&nbsp;<span class="op" id="4186468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186472">ciphertextLen</span>&nbsp;<span class="op" id="4186486">:=</span>&nbsp;<span class="builtintype" id="4186489">int</span><span class="op" id="4186492">(</span><span class="ident" id="4186493">ckx</span><span class="op" id="4186496">.</span><span class="ident" id="4186497">ciphertext</span><span class="op" id="4186507">[</span><span class="num" id="4186508">0</span><span class="op" id="4186509">]</span><span class="op" id="4186510">)</span><span class="op" id="4186511">&lt;&lt;</span><span class="num" id="4186513">8</span>&nbsp;<span class="op" id="4186515">|</span>&nbsp;<span class="builtintype" id="4186517">int</span><span class="op" id="4186520">(</span><span class="ident" id="4186521">ckx</span><span class="op" id="4186524">.</span><span class="ident" id="4186525">ciphertext</span><span class="op" id="4186535">[</span><span class="num" id="4186536">1</span><span class="op" id="4186537">]</span><span class="op" id="4186538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186542">if</span>&nbsp;<span class="ident" id="4186545">ciphertextLen</span>&nbsp;<span class="op" id="4186559">!=</span>&nbsp;<span class="builtinfunc" id="4186562">len</span><span class="op" id="4186565">(</span><span class="ident" id="4186566">ckx</span><span class="op" id="4186569">.</span><span class="ident" id="4186570">ciphertext</span><span class="op" id="4186580">)</span><span class="op" id="4186581">-</span><span class="num" id="4186582">2</span>&nbsp;<span class="op" id="4186584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186589">return</span>&nbsp;<span class="ident" id="4186596">nil</span><span class="op" id="4186599">,</span>&nbsp;<span class="ident" id="4186601">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186624">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186628">ciphertext</span>&nbsp;<span class="op" id="4186639">=</span>&nbsp;<span class="ident" id="4186641">ckx</span><span class="op" id="4186644">.</span><span class="ident" id="4186645">ciphertext</span><span class="op" id="4186655">[</span><span class="num" id="4186656">2</span><span class="op" id="4186657">:</span><span class="op" id="4186658">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4186665">err</span>&nbsp;<span class="op" id="4186669">=</span>&nbsp;<span class="ident" id="4186671">rsa</span><span class="op" id="4186674">.</span><span class="ident" id="4186675">DecryptPKCS1v15SessionKey</span><span class="op" id="4186700">(</span><span class="ident" id="4186701">config</span><span class="op" id="4186707">.</span><span class="ident" id="4186708">rand</span><span class="op" id="4186712">(</span><span class="op" id="4186713">)</span><span class="op" id="4186714">,</span>&nbsp;<span class="ident" id="4186716">cert</span><span class="op" id="4186720">.</span><span class="ident" id="4186721">PrivateKey</span><span class="op" id="4186731">.</span><span class="op" id="4186732">(</span><span class="op" id="4186733">*</span><span class="ident" id="4186734">rsa</span><span class="op" id="4186737">.</span><span class="ident" id="4186738">PrivateKey</span><span class="op" id="4186748">)</span><span class="op" id="4186749">,</span>&nbsp;<span class="ident" id="4186751">ciphertext</span><span class="op" id="4186761">,</span>&nbsp;<span class="ident" id="4186763">preMasterSecret</span><span class="op" id="4186778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186781">if</span>&nbsp;<span class="ident" id="4186784">err</span>&nbsp;<span class="op" id="4186788">!=</span>&nbsp;<span class="ident" id="4186791">nil</span>&nbsp;<span class="op" id="4186795">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4186799">return</span>&nbsp;<span class="ident" id="4186806">nil</span><span class="op" id="4186809">,</span>&nbsp;<span class="ident" id="4186811">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4186816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4186819">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4186892">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4186964">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4187032">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4187105">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4187172">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187197">return</span>&nbsp;<span class="ident" id="4187204">preMasterSecret</span><span class="op" id="4187219">,</span>&nbsp;<span class="ident" id="4187221">nil</span><br>
<span class="lineno"></span><span class="op" id="4187225">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4187228">func</span>&nbsp;<span class="op" id="4187233">(</span><span class="ident" id="4187234">ka</span>&nbsp;<span class="ident" id="4187237">rsaKeyAgreement</span><span class="op" id="4187252">)</span>&nbsp;<span class="ident" id="4187254">processServerKeyExchange</span><span class="op" id="4187278">(</span><span class="ident" id="4187279">config</span>&nbsp;<span class="op" id="4187286">*</span><span class="ident" id="4187287">Config</span><span class="op" id="4187293">,</span>&nbsp;<span class="ident" id="4187295">clientHello</span>&nbsp;<span class="op" id="4187307">*</span><span class="ident" id="4187308">clientHelloMsg</span><span class="op" id="4187322">,</span>&nbsp;<span class="ident" id="4187324">serverHello</span>&nbsp;<span class="op" id="4187336">*</span><span class="ident" id="4187337">serverHelloMsg</span><span class="op" id="4187351">,</span>&nbsp;<span class="ident" id="4187353">cert</span>&nbsp;<span class="op" id="4187358">*</span><span class="ident" id="4187359">x509</span><span class="op" id="4187363">.</span><span class="ident" id="4187364">Certificate</span><span class="op" id="4187375">,</span>&nbsp;<span class="ident" id="4187377">skx</span>&nbsp;<span class="op" id="4187381">*</span><span class="ident" id="4187382">serverKeyExchangeMsg</span><span class="op" id="4187402">)</span>&nbsp;<span class="builtintype" id="4187404">error</span>&nbsp;<span class="op" id="4187410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187413">return</span>&nbsp;<span class="ident" id="4187420">errors</span><span class="op" id="4187426">.</span><span class="ident" id="4187427">New</span><span class="op" id="4187430">(</span><span class="string" id="4187431">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="4187466">)</span><br>
<span class="lineno"></span><span class="op" id="4187468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4187471">func</span>&nbsp;<span class="op" id="4187476">(</span><span class="ident" id="4187477">ka</span>&nbsp;<span class="ident" id="4187480">rsaKeyAgreement</span><span class="op" id="4187495">)</span>&nbsp;<span class="ident" id="4187497">generateClientKeyExchange</span><span class="op" id="4187522">(</span><span class="ident" id="4187523">config</span>&nbsp;<span class="op" id="4187530">*</span><span class="ident" id="4187531">Config</span><span class="op" id="4187537">,</span>&nbsp;<span class="ident" id="4187539">clientHello</span>&nbsp;<span class="op" id="4187551">*</span><span class="ident" id="4187552">clientHelloMsg</span><span class="op" id="4187566">,</span>&nbsp;<span class="ident" id="4187568">cert</span>&nbsp;<span class="op" id="4187573">*</span><span class="ident" id="4187574">x509</span><span class="op" id="4187578">.</span><span class="ident" id="4187579">Certificate</span><span class="op" id="4187590">)</span>&nbsp;<span class="op" id="4187592">(</span><span class="op" id="4187593">[</span><span class="op" id="4187594">]</span><span class="builtintype" id="4187595">byte</span><span class="op" id="4187599">,</span>&nbsp;<span class="op" id="4187601">*</span><span class="ident" id="4187602">clientKeyExchangeMsg</span><span class="op" id="4187622">,</span>&nbsp;<span class="builtintype" id="4187624">error</span><span class="op" id="4187629">)</span>&nbsp;<span class="op" id="4187631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187634">preMasterSecret</span>&nbsp;<span class="op" id="4187650">:=</span>&nbsp;<span class="builtinfunc" id="4187653">make</span><span class="op" id="4187657">(</span><span class="op" id="4187658">[</span><span class="op" id="4187659">]</span><span class="builtintype" id="4187660">byte</span><span class="op" id="4187664">,</span>&nbsp;<span class="num" id="4187666">48</span><span class="op" id="4187668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187671">preMasterSecret</span><span class="op" id="4187686">[</span><span class="num" id="4187687">0</span><span class="op" id="4187688">]</span>&nbsp;<span class="op" id="4187690">=</span>&nbsp;<span class="builtintype" id="4187692">byte</span><span class="op" id="4187696">(</span><span class="ident" id="4187697">clientHello</span><span class="op" id="4187708">.</span><span class="ident" id="4187709">vers</span>&nbsp;<span class="op" id="4187714">&gt;&gt;</span>&nbsp;<span class="num" id="4187717">8</span><span class="op" id="4187718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187721">preMasterSecret</span><span class="op" id="4187736">[</span><span class="num" id="4187737">1</span><span class="op" id="4187738">]</span>&nbsp;<span class="op" id="4187740">=</span>&nbsp;<span class="builtintype" id="4187742">byte</span><span class="op" id="4187746">(</span><span class="ident" id="4187747">clientHello</span><span class="op" id="4187758">.</span><span class="ident" id="4187759">vers</span><span class="op" id="4187763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187766">_</span><span class="op" id="4187767">,</span>&nbsp;<span class="ident" id="4187769">err</span>&nbsp;<span class="op" id="4187773">:=</span>&nbsp;<span class="ident" id="4187776">io</span><span class="op" id="4187778">.</span><span class="ident" id="4187779">ReadFull</span><span class="op" id="4187787">(</span><span class="ident" id="4187788">config</span><span class="op" id="4187794">.</span><span class="ident" id="4187795">rand</span><span class="op" id="4187799">(</span><span class="op" id="4187800">)</span><span class="op" id="4187801">,</span>&nbsp;<span class="ident" id="4187803">preMasterSecret</span><span class="op" id="4187818">[</span><span class="num" id="4187819">2</span><span class="op" id="4187820">:</span><span class="op" id="4187821">]</span><span class="op" id="4187822">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187825">if</span>&nbsp;<span class="ident" id="4187828">err</span>&nbsp;<span class="op" id="4187832">!=</span>&nbsp;<span class="ident" id="4187835">nil</span>&nbsp;<span class="op" id="4187839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187843">return</span>&nbsp;<span class="ident" id="4187850">nil</span><span class="op" id="4187853">,</span>&nbsp;<span class="ident" id="4187855">nil</span><span class="op" id="4187858">,</span>&nbsp;<span class="ident" id="4187860">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4187865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4187869">encrypted</span><span class="op" id="4187878">,</span>&nbsp;<span class="ident" id="4187880">err</span>&nbsp;<span class="op" id="4187884">:=</span>&nbsp;<span class="ident" id="4187887">rsa</span><span class="op" id="4187890">.</span><span class="ident" id="4187891">EncryptPKCS1v15</span><span class="op" id="4187906">(</span><span class="ident" id="4187907">config</span><span class="op" id="4187913">.</span><span class="ident" id="4187914">rand</span><span class="op" id="4187918">(</span><span class="op" id="4187919">)</span><span class="op" id="4187920">,</span>&nbsp;<span class="ident" id="4187922">cert</span><span class="op" id="4187926">.</span><span class="ident" id="4187927">PublicKey</span><span class="op" id="4187936">.</span><span class="op" id="4187937">(</span><span class="op" id="4187938">*</span><span class="ident" id="4187939">rsa</span><span class="op" id="4187942">.</span><span class="ident" id="4187943">PublicKey</span><span class="op" id="4187952">)</span><span class="op" id="4187953">,</span>&nbsp;<span class="ident" id="4187955">preMasterSecret</span><span class="op" id="4187970">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187973">if</span>&nbsp;<span class="ident" id="4187976">err</span>&nbsp;<span class="op" id="4187980">!=</span>&nbsp;<span class="ident" id="4187983">nil</span>&nbsp;<span class="op" id="4187987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4187991">return</span>&nbsp;<span class="ident" id="4187998">nil</span><span class="op" id="4188001">,</span>&nbsp;<span class="ident" id="4188003">nil</span><span class="op" id="4188006">,</span>&nbsp;<span class="ident" id="4188008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188016">ckx</span>&nbsp;<span class="op" id="4188020">:=</span>&nbsp;<span class="builtinfunc" id="4188023">new</span><span class="op" id="4188026">(</span><span class="ident" id="4188027">clientKeyExchangeMsg</span><span class="op" id="4188047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188050">ckx</span><span class="op" id="4188053">.</span><span class="ident" id="4188054">ciphertext</span>&nbsp;<span class="op" id="4188065">=</span>&nbsp;<span class="builtinfunc" id="4188067">make</span><span class="op" id="4188071">(</span><span class="op" id="4188072">[</span><span class="op" id="4188073">]</span><span class="builtintype" id="4188074">byte</span><span class="op" id="4188078">,</span>&nbsp;<span class="builtinfunc" id="4188080">len</span><span class="op" id="4188083">(</span><span class="ident" id="4188084">encrypted</span><span class="op" id="4188093">)</span><span class="op" id="4188094">+</span><span class="num" id="4188095">2</span><span class="op" id="4188096">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188099">ckx</span><span class="op" id="4188102">.</span><span class="ident" id="4188103">ciphertext</span><span class="op" id="4188113">[</span><span class="num" id="4188114">0</span><span class="op" id="4188115">]</span>&nbsp;<span class="op" id="4188117">=</span>&nbsp;<span class="builtintype" id="4188119">byte</span><span class="op" id="4188123">(</span><span class="builtinfunc" id="4188124">len</span><span class="op" id="4188127">(</span><span class="ident" id="4188128">encrypted</span><span class="op" id="4188137">)</span>&nbsp;<span class="op" id="4188139">&gt;&gt;</span>&nbsp;<span class="num" id="4188142">8</span><span class="op" id="4188143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188146">ckx</span><span class="op" id="4188149">.</span><span class="ident" id="4188150">ciphertext</span><span class="op" id="4188160">[</span><span class="num" id="4188161">1</span><span class="op" id="4188162">]</span>&nbsp;<span class="op" id="4188164">=</span>&nbsp;<span class="builtintype" id="4188166">byte</span><span class="op" id="4188170">(</span><span class="builtinfunc" id="4188171">len</span><span class="op" id="4188174">(</span><span class="ident" id="4188175">encrypted</span><span class="op" id="4188184">)</span><span class="op" id="4188185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4188188">copy</span><span class="op" id="4188192">(</span><span class="ident" id="4188193">ckx</span><span class="op" id="4188196">.</span><span class="ident" id="4188197">ciphertext</span><span class="op" id="4188207">[</span><span class="num" id="4188208">2</span><span class="op" id="4188209">:</span><span class="op" id="4188210">]</span><span class="op" id="4188211">,</span>&nbsp;<span class="ident" id="4188213">encrypted</span><span class="op" id="4188222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188225">return</span>&nbsp;<span class="ident" id="4188232">preMasterSecret</span><span class="op" id="4188247">,</span>&nbsp;<span class="ident" id="4188249">ckx</span><span class="op" id="4188252">,</span>&nbsp;<span class="ident" id="4188254">nil</span><br>
<span class="lineno"></span><span class="op" id="4188258">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4188261">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="4188324">func</span>&nbsp;<span class="ident" id="4188329">sha1Hash</span><span class="op" id="4188337">(</span><span class="ident" id="4188338">slices</span>&nbsp;<span class="op" id="4188345">[</span><span class="op" id="4188346">]</span><span class="op" id="4188347">[</span><span class="op" id="4188348">]</span><span class="builtintype" id="4188349">byte</span><span class="op" id="4188353">)</span>&nbsp;<span class="op" id="4188355">[</span><span class="op" id="4188356">]</span><span class="builtintype" id="4188357">byte</span>&nbsp;<span class="op" id="4188362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188365">hsha1</span>&nbsp;<span class="op" id="4188371">:=</span>&nbsp;<span class="ident" id="4188374">sha1</span><span class="op" id="4188378">.</span><span class="ident" id="4188379">New</span><span class="op" id="4188382">(</span><span class="op" id="4188383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188386">for</span>&nbsp;<span class="ident" id="4188390">_</span><span class="op" id="4188391">,</span>&nbsp;<span class="ident" id="4188393">slice</span>&nbsp;<span class="op" id="4188399">:=</span>&nbsp;<span class="keyword" id="4188402">range</span>&nbsp;<span class="ident" id="4188408">slices</span>&nbsp;<span class="op" id="4188415">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188419">hsha1</span><span class="op" id="4188424">.</span><span class="ident" id="4188425">Write</span><span class="op" id="4188430">(</span><span class="ident" id="4188431">slice</span><span class="op" id="4188436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188442">return</span>&nbsp;<span class="ident" id="4188449">hsha1</span><span class="op" id="4188454">.</span><span class="ident" id="4188455">Sum</span><span class="op" id="4188458">(</span><span class="ident" id="4188459">nil</span><span class="op" id="4188462">)</span><br>
<span class="lineno"></span><span class="op" id="4188464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4188467">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4188546">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="4188588">func</span>&nbsp;<span class="ident" id="4188593">md5SHA1Hash</span><span class="op" id="4188604">(</span><span class="ident" id="4188605">slices</span>&nbsp;<span class="op" id="4188612">[</span><span class="op" id="4188613">]</span><span class="op" id="4188614">[</span><span class="op" id="4188615">]</span><span class="builtintype" id="4188616">byte</span><span class="op" id="4188620">)</span>&nbsp;<span class="op" id="4188622">[</span><span class="op" id="4188623">]</span><span class="builtintype" id="4188624">byte</span>&nbsp;<span class="op" id="4188629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188632">md5sha1</span>&nbsp;<span class="op" id="4188640">:=</span>&nbsp;<span class="builtinfunc" id="4188643">make</span><span class="op" id="4188647">(</span><span class="op" id="4188648">[</span><span class="op" id="4188649">]</span><span class="builtintype" id="4188650">byte</span><span class="op" id="4188654">,</span>&nbsp;<span class="ident" id="4188656">md5</span><span class="op" id="4188659">.</span><span class="ident" id="4188660">Size</span><span class="op" id="4188664">+</span><span class="ident" id="4188665">sha1</span><span class="op" id="4188669">.</span><span class="ident" id="4188670">Size</span><span class="op" id="4188674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188677">hmd5</span>&nbsp;<span class="op" id="4188682">:=</span>&nbsp;<span class="ident" id="4188685">md5</span><span class="op" id="4188688">.</span><span class="ident" id="4188689">New</span><span class="op" id="4188692">(</span><span class="op" id="4188693">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188696">for</span>&nbsp;<span class="ident" id="4188700">_</span><span class="op" id="4188701">,</span>&nbsp;<span class="ident" id="4188703">slice</span>&nbsp;<span class="op" id="4188709">:=</span>&nbsp;<span class="keyword" id="4188712">range</span>&nbsp;<span class="ident" id="4188718">slices</span>&nbsp;<span class="op" id="4188725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188729">hmd5</span><span class="op" id="4188733">.</span><span class="ident" id="4188734">Write</span><span class="op" id="4188739">(</span><span class="ident" id="4188740">slice</span><span class="op" id="4188745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4188748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4188751">copy</span><span class="op" id="4188755">(</span><span class="ident" id="4188756">md5sha1</span><span class="op" id="4188763">,</span>&nbsp;<span class="ident" id="4188765">hmd5</span><span class="op" id="4188769">.</span><span class="ident" id="4188770">Sum</span><span class="op" id="4188773">(</span><span class="ident" id="4188774">nil</span><span class="op" id="4188777">)</span><span class="op" id="4188778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4188781">copy</span><span class="op" id="4188785">(</span><span class="ident" id="4188786">md5sha1</span><span class="op" id="4188793">[</span><span class="ident" id="4188794">md5</span><span class="op" id="4188797">.</span><span class="ident" id="4188798">Size</span><span class="op" id="4188802">:</span><span class="op" id="4188803">]</span><span class="op" id="4188804">,</span>&nbsp;<span class="ident" id="4188806">sha1Hash</span><span class="op" id="4188814">(</span><span class="ident" id="4188815">slices</span><span class="op" id="4188821">)</span><span class="op" id="4188822">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188825">return</span>&nbsp;<span class="ident" id="4188832">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="4188840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4188843">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="4188893">func</span>&nbsp;<span class="ident" id="4188898">sha256Hash</span><span class="op" id="4188908">(</span><span class="ident" id="4188909">slices</span>&nbsp;<span class="op" id="4188916">[</span><span class="op" id="4188917">]</span><span class="op" id="4188918">[</span><span class="op" id="4188919">]</span><span class="builtintype" id="4188920">byte</span><span class="op" id="4188924">)</span>&nbsp;<span class="op" id="4188926">[</span><span class="op" id="4188927">]</span><span class="builtintype" id="4188928">byte</span>&nbsp;<span class="op" id="4188933">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188936">h</span>&nbsp;<span class="op" id="4188938">:=</span>&nbsp;<span class="ident" id="4188941">sha256</span><span class="op" id="4188947">.</span><span class="ident" id="4188948">New</span><span class="op" id="4188951">(</span><span class="op" id="4188952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4188955">for</span>&nbsp;<span class="ident" id="4188959">_</span><span class="op" id="4188960">,</span>&nbsp;<span class="ident" id="4188962">slice</span>&nbsp;<span class="op" id="4188968">:=</span>&nbsp;<span class="keyword" id="4188971">range</span>&nbsp;<span class="ident" id="4188977">slices</span>&nbsp;<span class="op" id="4188984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4188988">h</span><span class="op" id="4188989">.</span><span class="ident" id="4188990">Write</span><span class="op" id="4188995">(</span><span class="ident" id="4188996">slice</span><span class="op" id="4189001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4189004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189007">return</span>&nbsp;<span class="ident" id="4189014">h</span><span class="op" id="4189015">.</span><span class="ident" id="4189016">Sum</span><span class="op" id="4189019">(</span><span class="ident" id="4189020">nil</span><span class="op" id="4189023">)</span><br>
<span class="lineno">120</span><span class="op" id="4189025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4189028">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="4189105">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="4189184">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="4189258">func</span>&nbsp;<span class="ident" id="4189263">hashForServerKeyExchange</span><span class="op" id="4189287">(</span><span class="ident" id="4189288">sigType</span><span class="op" id="4189295">,</span>&nbsp;<span class="ident" id="4189297">hashFunc</span>&nbsp;<span class="builtintype" id="4189306">uint8</span><span class="op" id="4189311">,</span>&nbsp;<span class="ident" id="4189313">version</span>&nbsp;<span class="builtintype" id="4189321">uint16</span><span class="op" id="4189327">,</span>&nbsp;<span class="ident" id="4189329">slices</span>&nbsp;<span class="op" id="4189336">...</span><span class="op" id="4189339">[</span><span class="op" id="4189340">]</span><span class="builtintype" id="4189341">byte</span><span class="op" id="4189345">)</span>&nbsp;<span class="op" id="4189347">(</span><span class="op" id="4189348">[</span><span class="op" id="4189349">]</span><span class="builtintype" id="4189350">byte</span><span class="op" id="4189354">,</span>&nbsp;<span class="ident" id="4189356">crypto</span><span class="op" id="4189362">.</span><span class="ident" id="4189363">Hash</span><span class="op" id="4189367">,</span>&nbsp;<span class="builtintype" id="4189369">error</span><span class="op" id="4189374">)</span>&nbsp;<span class="op" id="4189376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189379">if</span>&nbsp;<span class="ident" id="4189382">version</span>&nbsp;<span class="op" id="4189390">&gt;=</span>&nbsp;<span class="ident" id="4189393">VersionTLS12</span>&nbsp;<span class="op" id="4189406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189410">switch</span>&nbsp;<span class="ident" id="4189417">hashFunc</span>&nbsp;<span class="op" id="4189426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189430">case</span>&nbsp;<span class="ident" id="4189435">hashSHA256</span><span class="op" id="4189445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189450">return</span>&nbsp;<span class="ident" id="4189457">sha256Hash</span><span class="op" id="4189467">(</span><span class="ident" id="4189468">slices</span><span class="op" id="4189474">)</span><span class="op" id="4189475">,</span>&nbsp;<span class="ident" id="4189477">crypto</span><span class="op" id="4189483">.</span><span class="ident" id="4189484">SHA256</span><span class="op" id="4189490">,</span>&nbsp;<span class="ident" id="4189492">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189498">case</span>&nbsp;<span class="ident" id="4189503">hashSHA1</span><span class="op" id="4189511">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189516">return</span>&nbsp;<span class="ident" id="4189523">sha1Hash</span><span class="op" id="4189531">(</span><span class="ident" id="4189532">slices</span><span class="op" id="4189538">)</span><span class="op" id="4189539">,</span>&nbsp;<span class="ident" id="4189541">crypto</span><span class="op" id="4189547">.</span><span class="ident" id="4189548">SHA1</span><span class="op" id="4189552">,</span>&nbsp;<span class="ident" id="4189554">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189560">default</span><span class="op" id="4189567">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189572">return</span>&nbsp;<span class="ident" id="4189579">nil</span><span class="op" id="4189582">,</span>&nbsp;<span class="ident" id="4189584">crypto</span><span class="op" id="4189590">.</span><span class="ident" id="4189591">Hash</span><span class="op" id="4189595">(</span><span class="num" id="4189596">0</span><span class="op" id="4189597">)</span><span class="op" id="4189598">,</span>&nbsp;<span class="ident" id="4189600">errors</span><span class="op" id="4189606">.</span><span class="ident" id="4189607">New</span><span class="op" id="4189610">(</span><span class="string" id="4189611">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="4189652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4189656">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4189659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189662">if</span>&nbsp;<span class="ident" id="4189665">sigType</span>&nbsp;<span class="op" id="4189673">==</span>&nbsp;<span class="ident" id="4189676">signatureECDSA</span>&nbsp;<span class="op" id="4189691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189695">return</span>&nbsp;<span class="ident" id="4189702">sha1Hash</span><span class="op" id="4189710">(</span><span class="ident" id="4189711">slices</span><span class="op" id="4189717">)</span><span class="op" id="4189718">,</span>&nbsp;<span class="ident" id="4189720">crypto</span><span class="op" id="4189726">.</span><span class="ident" id="4189727">SHA1</span><span class="op" id="4189731">,</span>&nbsp;<span class="ident" id="4189733">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4189738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4189741">return</span>&nbsp;<span class="ident" id="4189748">md5SHA1Hash</span><span class="op" id="4189759">(</span><span class="ident" id="4189760">slices</span><span class="op" id="4189766">)</span><span class="op" id="4189767">,</span>&nbsp;<span class="ident" id="4189769">crypto</span><span class="op" id="4189775">.</span><span class="ident" id="4189776">MD5SHA1</span><span class="op" id="4189783">,</span>&nbsp;<span class="ident" id="4189785">nil</span><br>
<span class="lineno">140</span><span class="op" id="4189789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4189792">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4189869">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4189943">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="4190008">func</span>&nbsp;<span class="ident" id="4190013">pickTLS12HashForSignature</span><span class="op" id="4190038">(</span><span class="ident" id="4190039">sigType</span>&nbsp;<span class="builtintype" id="4190047">uint8</span><span class="op" id="4190052">,</span>&nbsp;<span class="ident" id="4190054">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4190079">[</span><span class="op" id="4190080">]</span><span class="ident" id="4190081">signatureAndHash</span><span class="op" id="4190097">)</span>&nbsp;<span class="op" id="4190099">(</span><span class="builtintype" id="4190100">uint8</span><span class="op" id="4190105">,</span>&nbsp;<span class="builtintype" id="4190107">error</span><span class="op" id="4190112">)</span>&nbsp;<span class="op" id="4190114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190117">if</span>&nbsp;<span class="builtinfunc" id="4190120">len</span><span class="op" id="4190123">(</span><span class="ident" id="4190124">clientSignatureAndHashes</span><span class="op" id="4190148">)</span>&nbsp;<span class="op" id="4190150">==</span>&nbsp;<span class="num" id="4190153">0</span>&nbsp;<span class="op" id="4190155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4190159">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4190218">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4190279">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190337">return</span>&nbsp;<span class="ident" id="4190344">hashSHA1</span><span class="op" id="4190352">,</span>&nbsp;<span class="ident" id="4190354">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190363">for</span>&nbsp;<span class="ident" id="4190367">_</span><span class="op" id="4190368">,</span>&nbsp;<span class="ident" id="4190370">sigAndHash</span>&nbsp;<span class="op" id="4190381">:=</span>&nbsp;<span class="keyword" id="4190384">range</span>&nbsp;<span class="ident" id="4190390">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4190415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190419">if</span>&nbsp;<span class="ident" id="4190422">sigAndHash</span><span class="op" id="4190432">.</span><span class="ident" id="4190433">signature</span>&nbsp;<span class="op" id="4190443">!=</span>&nbsp;<span class="ident" id="4190446">sigType</span>&nbsp;<span class="op" id="4190454">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190459">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190474">switch</span>&nbsp;<span class="ident" id="4190481">sigAndHash</span><span class="op" id="4190491">.</span><span class="ident" id="4190492">hash</span>&nbsp;<span class="op" id="4190497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190501">case</span>&nbsp;<span class="ident" id="4190506">hashSHA1</span><span class="op" id="4190514">,</span>&nbsp;<span class="ident" id="4190516">hashSHA256</span><span class="op" id="4190526">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190531">return</span>&nbsp;<span class="ident" id="4190538">sigAndHash</span><span class="op" id="4190548">.</span><span class="ident" id="4190549">hash</span><span class="op" id="4190553">,</span>&nbsp;<span class="ident" id="4190555">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190568">return</span>&nbsp;<span class="num" id="4190575">0</span><span class="op" id="4190576">,</span>&nbsp;<span class="ident" id="4190578">errors</span><span class="op" id="4190584">.</span><span class="ident" id="4190585">New</span><span class="op" id="4190588">(</span><span class="string" id="4190589">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="4190644">)</span><br>
<span class="lineno"></span><span class="op" id="4190646">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4190649">func</span>&nbsp;<span class="ident" id="4190654">curveForCurveID</span><span class="op" id="4190669">(</span><span class="ident" id="4190670">id</span>&nbsp;<span class="ident" id="4190673">CurveID</span><span class="op" id="4190680">)</span>&nbsp;<span class="op" id="4190682">(</span><span class="ident" id="4190683">elliptic</span><span class="op" id="4190691">.</span><span class="ident" id="4190692">Curve</span><span class="op" id="4190697">,</span>&nbsp;<span class="builtintype" id="4190699">bool</span><span class="op" id="4190703">)</span>&nbsp;<span class="op" id="4190705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190708">switch</span>&nbsp;<span class="ident" id="4190715">id</span>&nbsp;<span class="op" id="4190718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190721">case</span>&nbsp;<span class="ident" id="4190726">CurveP256</span><span class="op" id="4190735">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190739">return</span>&nbsp;<span class="ident" id="4190746">elliptic</span><span class="op" id="4190754">.</span><span class="ident" id="4190755">P256</span><span class="op" id="4190759">(</span><span class="op" id="4190760">)</span><span class="op" id="4190761">,</span>&nbsp;<span class="builtintype" id="4190763">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190769">case</span>&nbsp;<span class="ident" id="4190774">CurveP384</span><span class="op" id="4190783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190787">return</span>&nbsp;<span class="ident" id="4190794">elliptic</span><span class="op" id="4190802">.</span><span class="ident" id="4190803">P384</span><span class="op" id="4190807">(</span><span class="op" id="4190808">)</span><span class="op" id="4190809">,</span>&nbsp;<span class="builtintype" id="4190811">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190817">case</span>&nbsp;<span class="ident" id="4190822">CurveP521</span><span class="op" id="4190831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190835">return</span>&nbsp;<span class="ident" id="4190842">elliptic</span><span class="op" id="4190850">.</span><span class="ident" id="4190851">P521</span><span class="op" id="4190855">(</span><span class="op" id="4190856">)</span><span class="op" id="4190857">,</span>&nbsp;<span class="builtintype" id="4190859">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190865">default</span><span class="op" id="4190872">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4190876">return</span>&nbsp;<span class="ident" id="4190883">nil</span><span class="op" id="4190886">,</span>&nbsp;<span class="builtintype" id="4190888">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4190895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4190898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="4190901">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4190973">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4191043">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="4191113">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="4191140">type</span>&nbsp;<span class="ident" id="4191145">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="4191163">struct</span>&nbsp;<span class="op" id="4191170">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191173">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4191184">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191192">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4191203">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191210">privateKey</span>&nbsp;<span class="op" id="4191221">[</span><span class="op" id="4191222">]</span><span class="builtintype" id="4191223">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191229">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191240">elliptic</span><span class="op" id="4191248">.</span><span class="ident" id="4191249">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191256">x</span><span class="op" id="4191257">,</span>&nbsp;<span class="ident" id="4191259">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191267">*</span><span class="ident" id="4191268">big</span><span class="op" id="4191271">.</span><span class="ident" id="4191272">Int</span><br>
<span class="lineno">190</span><span class="op" id="4191276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4191279">func</span>&nbsp;<span class="op" id="4191284">(</span><span class="ident" id="4191285">ka</span>&nbsp;<span class="op" id="4191288">*</span><span class="ident" id="4191289">ecdheKeyAgreement</span><span class="op" id="4191306">)</span>&nbsp;<span class="ident" id="4191308">generateServerKeyExchange</span><span class="op" id="4191333">(</span><span class="ident" id="4191334">config</span>&nbsp;<span class="op" id="4191341">*</span><span class="ident" id="4191342">Config</span><span class="op" id="4191348">,</span>&nbsp;<span class="ident" id="4191350">cert</span>&nbsp;<span class="op" id="4191355">*</span><span class="ident" id="4191356">Certificate</span><span class="op" id="4191367">,</span>&nbsp;<span class="ident" id="4191369">clientHello</span>&nbsp;<span class="op" id="4191381">*</span><span class="ident" id="4191382">clientHelloMsg</span><span class="op" id="4191396">,</span>&nbsp;<span class="ident" id="4191398">hello</span>&nbsp;<span class="op" id="4191404">*</span><span class="ident" id="4191405">serverHelloMsg</span><span class="op" id="4191419">)</span>&nbsp;<span class="op" id="4191421">(</span><span class="op" id="4191422">*</span><span class="ident" id="4191423">serverKeyExchangeMsg</span><span class="op" id="4191443">,</span>&nbsp;<span class="builtintype" id="4191445">error</span><span class="op" id="4191450">)</span>&nbsp;<span class="op" id="4191452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191455">var</span>&nbsp;<span class="ident" id="4191459">curveid</span>&nbsp;<span class="ident" id="4191467">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191476">preferredCurves</span>&nbsp;<span class="op" id="4191492">:=</span>&nbsp;<span class="ident" id="4191495">config</span><span class="op" id="4191501">.</span><span class="ident" id="4191502">curvePreferences</span><span class="op" id="4191518">(</span><span class="op" id="4191519">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="4191522">NextCandidate</span><span class="op" id="4191535">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191538">for</span>&nbsp;<span class="ident" id="4191542">_</span><span class="op" id="4191543">,</span>&nbsp;<span class="ident" id="4191545">candidate</span>&nbsp;<span class="op" id="4191555">:=</span>&nbsp;<span class="keyword" id="4191558">range</span>&nbsp;<span class="ident" id="4191564">preferredCurves</span>&nbsp;<span class="op" id="4191580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191584">for</span>&nbsp;<span class="ident" id="4191588">_</span><span class="op" id="4191589">,</span>&nbsp;<span class="ident" id="4191591">c</span>&nbsp;<span class="op" id="4191593">:=</span>&nbsp;<span class="keyword" id="4191596">range</span>&nbsp;<span class="ident" id="4191602">clientHello</span><span class="op" id="4191613">.</span><span class="ident" id="4191614">supportedCurves</span>&nbsp;<span class="op" id="4191630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191635">if</span>&nbsp;<span class="ident" id="4191638">candidate</span>&nbsp;<span class="op" id="4191648">==</span>&nbsp;<span class="ident" id="4191651">c</span>&nbsp;<span class="op" id="4191653">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191659">curveid</span>&nbsp;<span class="op" id="4191667">=</span>&nbsp;<span class="ident" id="4191669">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191675">break</span>&nbsp;<span class="ident" id="4191681">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191705">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191709">if</span>&nbsp;<span class="ident" id="4191712">curveid</span>&nbsp;<span class="op" id="4191720">==</span>&nbsp;<span class="num" id="4191723">0</span>&nbsp;<span class="op" id="4191725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191729">return</span>&nbsp;<span class="ident" id="4191736">nil</span><span class="op" id="4191739">,</span>&nbsp;<span class="ident" id="4191741">errors</span><span class="op" id="4191747">.</span><span class="ident" id="4191748">New</span><span class="op" id="4191751">(</span><span class="string" id="4191752">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="4191795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191802">var</span>&nbsp;<span class="ident" id="4191806">ok</span>&nbsp;<span class="builtintype" id="4191809">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191815">if</span>&nbsp;<span class="ident" id="4191818">ka</span><span class="op" id="4191820">.</span><span class="ident" id="4191821">curve</span><span class="op" id="4191826">,</span>&nbsp;<span class="ident" id="4191828">ok</span>&nbsp;<span class="op" id="4191831">=</span>&nbsp;<span class="ident" id="4191833">curveForCurveID</span><span class="op" id="4191848">(</span><span class="ident" id="4191849">curveid</span><span class="op" id="4191856">)</span><span class="op" id="4191857">;</span>&nbsp;<span class="op" id="4191859">!</span><span class="ident" id="4191860">ok</span>&nbsp;<span class="op" id="4191863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191867">return</span>&nbsp;<span class="ident" id="4191874">nil</span><span class="op" id="4191877">,</span>&nbsp;<span class="ident" id="4191879">errors</span><span class="op" id="4191885">.</span><span class="ident" id="4191886">New</span><span class="op" id="4191889">(</span><span class="string" id="4191890">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4191939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4191942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191946">var</span>&nbsp;<span class="ident" id="4191950">x</span><span class="op" id="4191951">,</span>&nbsp;<span class="ident" id="4191953">y</span>&nbsp;<span class="op" id="4191955">*</span><span class="ident" id="4191956">big</span><span class="op" id="4191959">.</span><span class="ident" id="4191960">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4191965">var</span>&nbsp;<span class="ident" id="4191969">err</span>&nbsp;<span class="builtintype" id="4191973">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4191980">ka</span><span class="op" id="4191982">.</span><span class="ident" id="4191983">privateKey</span><span class="op" id="4191993">,</span>&nbsp;<span class="ident" id="4191995">x</span><span class="op" id="4191996">,</span>&nbsp;<span class="ident" id="4191998">y</span><span class="op" id="4191999">,</span>&nbsp;<span class="ident" id="4192001">err</span>&nbsp;<span class="op" id="4192005">=</span>&nbsp;<span class="ident" id="4192007">elliptic</span><span class="op" id="4192015">.</span><span class="ident" id="4192016">GenerateKey</span><span class="op" id="4192027">(</span><span class="ident" id="4192028">ka</span><span class="op" id="4192030">.</span><span class="ident" id="4192031">curve</span><span class="op" id="4192036">,</span>&nbsp;<span class="ident" id="4192038">config</span><span class="op" id="4192044">.</span><span class="ident" id="4192045">rand</span><span class="op" id="4192049">(</span><span class="op" id="4192050">)</span><span class="op" id="4192051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192054">if</span>&nbsp;<span class="ident" id="4192057">err</span>&nbsp;<span class="op" id="4192061">!=</span>&nbsp;<span class="ident" id="4192064">nil</span>&nbsp;<span class="op" id="4192068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192072">return</span>&nbsp;<span class="ident" id="4192079">nil</span><span class="op" id="4192082">,</span>&nbsp;<span class="ident" id="4192084">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4192089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192092">ecdhePublic</span>&nbsp;<span class="op" id="4192104">:=</span>&nbsp;<span class="ident" id="4192107">elliptic</span><span class="op" id="4192115">.</span><span class="ident" id="4192116">Marshal</span><span class="op" id="4192123">(</span><span class="ident" id="4192124">ka</span><span class="op" id="4192126">.</span><span class="ident" id="4192127">curve</span><span class="op" id="4192132">,</span>&nbsp;<span class="ident" id="4192134">x</span><span class="op" id="4192135">,</span>&nbsp;<span class="ident" id="4192137">y</span><span class="op" id="4192138">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4192142">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192193">serverECDHParams</span>&nbsp;<span class="op" id="4192210">:=</span>&nbsp;<span class="builtinfunc" id="4192213">make</span><span class="op" id="4192217">(</span><span class="op" id="4192218">[</span><span class="op" id="4192219">]</span><span class="builtintype" id="4192220">byte</span><span class="op" id="4192224">,</span>&nbsp;<span class="num" id="4192226">1</span><span class="op" id="4192227">+</span><span class="num" id="4192228">2</span><span class="op" id="4192229">+</span><span class="num" id="4192230">1</span><span class="op" id="4192231">+</span><span class="builtinfunc" id="4192232">len</span><span class="op" id="4192235">(</span><span class="ident" id="4192236">ecdhePublic</span><span class="op" id="4192247">)</span><span class="op" id="4192248">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192251">serverECDHParams</span><span class="op" id="4192267">[</span><span class="num" id="4192268">0</span><span class="op" id="4192269">]</span>&nbsp;<span class="op" id="4192271">=</span>&nbsp;<span class="num" id="4192273">3</span>&nbsp;<span class="comment" id="4192275">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192291">serverECDHParams</span><span class="op" id="4192307">[</span><span class="num" id="4192308">1</span><span class="op" id="4192309">]</span>&nbsp;<span class="op" id="4192311">=</span>&nbsp;<span class="builtintype" id="4192313">byte</span><span class="op" id="4192317">(</span><span class="ident" id="4192318">curveid</span>&nbsp;<span class="op" id="4192326">&gt;&gt;</span>&nbsp;<span class="num" id="4192329">8</span><span class="op" id="4192330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192333">serverECDHParams</span><span class="op" id="4192349">[</span><span class="num" id="4192350">2</span><span class="op" id="4192351">]</span>&nbsp;<span class="op" id="4192353">=</span>&nbsp;<span class="builtintype" id="4192355">byte</span><span class="op" id="4192359">(</span><span class="ident" id="4192360">curveid</span><span class="op" id="4192367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192370">serverECDHParams</span><span class="op" id="4192386">[</span><span class="num" id="4192387">3</span><span class="op" id="4192388">]</span>&nbsp;<span class="op" id="4192390">=</span>&nbsp;<span class="builtintype" id="4192392">byte</span><span class="op" id="4192396">(</span><span class="builtinfunc" id="4192397">len</span><span class="op" id="4192400">(</span><span class="ident" id="4192401">ecdhePublic</span><span class="op" id="4192412">)</span><span class="op" id="4192413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4192416">copy</span><span class="op" id="4192420">(</span><span class="ident" id="4192421">serverECDHParams</span><span class="op" id="4192437">[</span><span class="num" id="4192438">4</span><span class="op" id="4192439">:</span><span class="op" id="4192440">]</span><span class="op" id="4192441">,</span>&nbsp;<span class="ident" id="4192443">ecdhePublic</span><span class="op" id="4192454">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192458">var</span>&nbsp;<span class="ident" id="4192462">tls12HashId</span>&nbsp;<span class="builtintype" id="4192474">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192481">if</span>&nbsp;<span class="ident" id="4192484">ka</span><span class="op" id="4192486">.</span><span class="ident" id="4192487">version</span>&nbsp;<span class="op" id="4192495">&gt;=</span>&nbsp;<span class="ident" id="4192498">VersionTLS12</span>&nbsp;<span class="op" id="4192511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192515">if</span>&nbsp;<span class="ident" id="4192518">tls12HashId</span><span class="op" id="4192529">,</span>&nbsp;<span class="ident" id="4192531">err</span>&nbsp;<span class="op" id="4192535">=</span>&nbsp;<span class="ident" id="4192537">pickTLS12HashForSignature</span><span class="op" id="4192562">(</span><span class="ident" id="4192563">ka</span><span class="op" id="4192565">.</span><span class="ident" id="4192566">sigType</span><span class="op" id="4192573">,</span>&nbsp;<span class="ident" id="4192575">clientHello</span><span class="op" id="4192586">.</span><span class="ident" id="4192587">signatureAndHashes</span><span class="op" id="4192605">)</span><span class="op" id="4192606">;</span>&nbsp;<span class="ident" id="4192608">err</span>&nbsp;<span class="op" id="4192612">!=</span>&nbsp;<span class="ident" id="4192615">nil</span>&nbsp;<span class="op" id="4192619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192624">return</span>&nbsp;<span class="ident" id="4192631">nil</span><span class="op" id="4192634">,</span>&nbsp;<span class="ident" id="4192636">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4192642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4192645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192649">digest</span><span class="op" id="4192655">,</span>&nbsp;<span class="ident" id="4192657">hashFunc</span><span class="op" id="4192665">,</span>&nbsp;<span class="ident" id="4192667">err</span>&nbsp;<span class="op" id="4192671">:=</span>&nbsp;<span class="ident" id="4192674">hashForServerKeyExchange</span><span class="op" id="4192698">(</span><span class="ident" id="4192699">ka</span><span class="op" id="4192701">.</span><span class="ident" id="4192702">sigType</span><span class="op" id="4192709">,</span>&nbsp;<span class="ident" id="4192711">tls12HashId</span><span class="op" id="4192722">,</span>&nbsp;<span class="ident" id="4192724">ka</span><span class="op" id="4192726">.</span><span class="ident" id="4192727">version</span><span class="op" id="4192734">,</span>&nbsp;<span class="ident" id="4192736">clientHello</span><span class="op" id="4192747">.</span><span class="ident" id="4192748">random</span><span class="op" id="4192754">,</span>&nbsp;<span class="ident" id="4192756">hello</span><span class="op" id="4192761">.</span><span class="ident" id="4192762">random</span><span class="op" id="4192768">,</span>&nbsp;<span class="ident" id="4192770">serverECDHParams</span><span class="op" id="4192786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192789">if</span>&nbsp;<span class="ident" id="4192792">err</span>&nbsp;<span class="op" id="4192796">!=</span>&nbsp;<span class="ident" id="4192799">nil</span>&nbsp;<span class="op" id="4192803">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192807">return</span>&nbsp;<span class="ident" id="4192814">nil</span><span class="op" id="4192817">,</span>&nbsp;<span class="ident" id="4192819">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4192824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192827">var</span>&nbsp;<span class="ident" id="4192831">sig</span>&nbsp;<span class="op" id="4192835">[</span><span class="op" id="4192836">]</span><span class="builtintype" id="4192837">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192843">switch</span>&nbsp;<span class="ident" id="4192850">ka</span><span class="op" id="4192852">.</span><span class="ident" id="4192853">sigType</span>&nbsp;<span class="op" id="4192861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192864">case</span>&nbsp;<span class="ident" id="4192869">signatureECDSA</span><span class="op" id="4192883">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4192887">privKey</span><span class="op" id="4192894">,</span>&nbsp;<span class="ident" id="4192896">ok</span>&nbsp;<span class="op" id="4192899">:=</span>&nbsp;<span class="ident" id="4192902">cert</span><span class="op" id="4192906">.</span><span class="ident" id="4192907">PrivateKey</span><span class="op" id="4192917">.</span><span class="op" id="4192918">(</span><span class="op" id="4192919">*</span><span class="ident" id="4192920">ecdsa</span><span class="op" id="4192925">.</span><span class="ident" id="4192926">PrivateKey</span><span class="op" id="4192936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192940">if</span>&nbsp;<span class="op" id="4192943">!</span><span class="ident" id="4192944">ok</span>&nbsp;<span class="op" id="4192947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4192952">return</span>&nbsp;<span class="ident" id="4192959">nil</span><span class="op" id="4192962">,</span>&nbsp;<span class="ident" id="4192964">errors</span><span class="op" id="4192970">.</span><span class="ident" id="4192971">New</span><span class="op" id="4192974">(</span><span class="string" id="4192975">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4193025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193033">r</span><span class="op" id="4193034">,</span>&nbsp;<span class="ident" id="4193036">s</span><span class="op" id="4193037">,</span>&nbsp;<span class="ident" id="4193039">err</span>&nbsp;<span class="op" id="4193043">:=</span>&nbsp;<span class="ident" id="4193046">ecdsa</span><span class="op" id="4193051">.</span><span class="ident" id="4193052">Sign</span><span class="op" id="4193056">(</span><span class="ident" id="4193057">config</span><span class="op" id="4193063">.</span><span class="ident" id="4193064">rand</span><span class="op" id="4193068">(</span><span class="op" id="4193069">)</span><span class="op" id="4193070">,</span>&nbsp;<span class="ident" id="4193072">privKey</span><span class="op" id="4193079">,</span>&nbsp;<span class="ident" id="4193081">digest</span><span class="op" id="4193087">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193091">if</span>&nbsp;<span class="ident" id="4193094">err</span>&nbsp;<span class="op" id="4193098">!=</span>&nbsp;<span class="ident" id="4193101">nil</span>&nbsp;<span class="op" id="4193105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193110">return</span>&nbsp;<span class="ident" id="4193117">nil</span><span class="op" id="4193120">,</span>&nbsp;<span class="ident" id="4193122">errors</span><span class="op" id="4193128">.</span><span class="ident" id="4193129">New</span><span class="op" id="4193132">(</span><span class="string" id="4193133">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4193169">+</span>&nbsp;<span class="ident" id="4193171">err</span><span class="op" id="4193174">.</span><span class="ident" id="4193175">Error</span><span class="op" id="4193180">(</span><span class="op" id="4193181">)</span><span class="op" id="4193182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193190">sig</span><span class="op" id="4193193">,</span>&nbsp;<span class="ident" id="4193195">err</span>&nbsp;<span class="op" id="4193199">=</span>&nbsp;<span class="ident" id="4193201">asn1</span><span class="op" id="4193205">.</span><span class="ident" id="4193206">Marshal</span><span class="op" id="4193213">(</span><span class="ident" id="4193214">ecdsaSignature</span><span class="op" id="4193228">{</span><span class="ident" id="4193229">r</span><span class="op" id="4193230">,</span>&nbsp;<span class="ident" id="4193232">s</span><span class="op" id="4193233">}</span><span class="op" id="4193234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193237">case</span>&nbsp;<span class="ident" id="4193242">signatureRSA</span><span class="op" id="4193254">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193258">privKey</span><span class="op" id="4193265">,</span>&nbsp;<span class="ident" id="4193267">ok</span>&nbsp;<span class="op" id="4193270">:=</span>&nbsp;<span class="ident" id="4193273">cert</span><span class="op" id="4193277">.</span><span class="ident" id="4193278">PrivateKey</span><span class="op" id="4193288">.</span><span class="op" id="4193289">(</span><span class="op" id="4193290">*</span><span class="ident" id="4193291">rsa</span><span class="op" id="4193294">.</span><span class="ident" id="4193295">PrivateKey</span><span class="op" id="4193305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193309">if</span>&nbsp;<span class="op" id="4193312">!</span><span class="ident" id="4193313">ok</span>&nbsp;<span class="op" id="4193316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193321">return</span>&nbsp;<span class="ident" id="4193328">nil</span><span class="op" id="4193331">,</span>&nbsp;<span class="ident" id="4193333">errors</span><span class="op" id="4193339">.</span><span class="ident" id="4193340">New</span><span class="op" id="4193343">(</span><span class="string" id="4193344">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4193389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193397">sig</span><span class="op" id="4193400">,</span>&nbsp;<span class="ident" id="4193402">err</span>&nbsp;<span class="op" id="4193406">=</span>&nbsp;<span class="ident" id="4193408">rsa</span><span class="op" id="4193411">.</span><span class="ident" id="4193412">SignPKCS1v15</span><span class="op" id="4193424">(</span><span class="ident" id="4193425">config</span><span class="op" id="4193431">.</span><span class="ident" id="4193432">rand</span><span class="op" id="4193436">(</span><span class="op" id="4193437">)</span><span class="op" id="4193438">,</span>&nbsp;<span class="ident" id="4193440">privKey</span><span class="op" id="4193447">,</span>&nbsp;<span class="ident" id="4193449">hashFunc</span><span class="op" id="4193457">,</span>&nbsp;<span class="ident" id="4193459">digest</span><span class="op" id="4193465">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193469">if</span>&nbsp;<span class="ident" id="4193472">err</span>&nbsp;<span class="op" id="4193476">!=</span>&nbsp;<span class="ident" id="4193479">nil</span>&nbsp;<span class="op" id="4193483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193488">return</span>&nbsp;<span class="ident" id="4193495">nil</span><span class="op" id="4193498">,</span>&nbsp;<span class="ident" id="4193500">errors</span><span class="op" id="4193506">.</span><span class="ident" id="4193507">New</span><span class="op" id="4193510">(</span><span class="string" id="4193511">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4193547">+</span>&nbsp;<span class="ident" id="4193549">err</span><span class="op" id="4193552">.</span><span class="ident" id="4193553">Error</span><span class="op" id="4193558">(</span><span class="op" id="4193559">)</span><span class="op" id="4193560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193567">default</span><span class="op" id="4193574">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193578">return</span>&nbsp;<span class="ident" id="4193585">nil</span><span class="op" id="4193588">,</span>&nbsp;<span class="ident" id="4193590">errors</span><span class="op" id="4193596">.</span><span class="ident" id="4193597">New</span><span class="op" id="4193600">(</span><span class="string" id="4193601">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4193636">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193643">skx</span>&nbsp;<span class="op" id="4193647">:=</span>&nbsp;<span class="builtinfunc" id="4193650">new</span><span class="op" id="4193653">(</span><span class="ident" id="4193654">serverKeyExchangeMsg</span><span class="op" id="4193674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193677">sigAndHashLen</span>&nbsp;<span class="op" id="4193691">:=</span>&nbsp;<span class="num" id="4193694">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193697">if</span>&nbsp;<span class="ident" id="4193700">ka</span><span class="op" id="4193702">.</span><span class="ident" id="4193703">version</span>&nbsp;<span class="op" id="4193711">&gt;=</span>&nbsp;<span class="ident" id="4193714">VersionTLS12</span>&nbsp;<span class="op" id="4193727">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193731">sigAndHashLen</span>&nbsp;<span class="op" id="4193745">=</span>&nbsp;<span class="num" id="4193747">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193753">skx</span><span class="op" id="4193756">.</span><span class="ident" id="4193757">key</span>&nbsp;<span class="op" id="4193761">=</span>&nbsp;<span class="builtinfunc" id="4193763">make</span><span class="op" id="4193767">(</span><span class="op" id="4193768">[</span><span class="op" id="4193769">]</span><span class="builtintype" id="4193770">byte</span><span class="op" id="4193774">,</span>&nbsp;<span class="builtinfunc" id="4193776">len</span><span class="op" id="4193779">(</span><span class="ident" id="4193780">serverECDHParams</span><span class="op" id="4193796">)</span><span class="op" id="4193797">+</span><span class="ident" id="4193798">sigAndHashLen</span><span class="op" id="4193811">+</span><span class="num" id="4193812">2</span><span class="op" id="4193813">+</span><span class="builtinfunc" id="4193814">len</span><span class="op" id="4193817">(</span><span class="ident" id="4193818">sig</span><span class="op" id="4193821">)</span><span class="op" id="4193822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4193825">copy</span><span class="op" id="4193829">(</span><span class="ident" id="4193830">skx</span><span class="op" id="4193833">.</span><span class="ident" id="4193834">key</span><span class="op" id="4193837">,</span>&nbsp;<span class="ident" id="4193839">serverECDHParams</span><span class="op" id="4193855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193858">k</span>&nbsp;<span class="op" id="4193860">:=</span>&nbsp;<span class="ident" id="4193863">skx</span><span class="op" id="4193866">.</span><span class="ident" id="4193867">key</span><span class="op" id="4193870">[</span><span class="builtinfunc" id="4193871">len</span><span class="op" id="4193874">(</span><span class="ident" id="4193875">serverECDHParams</span><span class="op" id="4193891">)</span><span class="op" id="4193892">:</span><span class="op" id="4193893">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4193896">if</span>&nbsp;<span class="ident" id="4193899">ka</span><span class="op" id="4193901">.</span><span class="ident" id="4193902">version</span>&nbsp;<span class="op" id="4193910">&gt;=</span>&nbsp;<span class="ident" id="4193913">VersionTLS12</span>&nbsp;<span class="op" id="4193926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193930">k</span><span class="op" id="4193931">[</span><span class="num" id="4193932">0</span><span class="op" id="4193933">]</span>&nbsp;<span class="op" id="4193935">=</span>&nbsp;<span class="ident" id="4193937">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193951">k</span><span class="op" id="4193952">[</span><span class="num" id="4193953">1</span><span class="op" id="4193954">]</span>&nbsp;<span class="op" id="4193956">=</span>&nbsp;<span class="ident" id="4193958">ka</span><span class="op" id="4193960">.</span><span class="ident" id="4193961">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193971">k</span>&nbsp;<span class="op" id="4193973">=</span>&nbsp;<span class="ident" id="4193975">k</span><span class="op" id="4193976">[</span><span class="num" id="4193977">2</span><span class="op" id="4193978">:</span><span class="op" id="4193979">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4193982">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4193985">k</span><span class="op" id="4193986">[</span><span class="num" id="4193987">0</span><span class="op" id="4193988">]</span>&nbsp;<span class="op" id="4193990">=</span>&nbsp;<span class="builtintype" id="4193992">byte</span><span class="op" id="4193996">(</span><span class="builtinfunc" id="4193997">len</span><span class="op" id="4194000">(</span><span class="ident" id="4194001">sig</span><span class="op" id="4194004">)</span>&nbsp;<span class="op" id="4194006">&gt;&gt;</span>&nbsp;<span class="num" id="4194009">8</span><span class="op" id="4194010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194013">k</span><span class="op" id="4194014">[</span><span class="num" id="4194015">1</span><span class="op" id="4194016">]</span>&nbsp;<span class="op" id="4194018">=</span>&nbsp;<span class="builtintype" id="4194020">byte</span><span class="op" id="4194024">(</span><span class="builtinfunc" id="4194025">len</span><span class="op" id="4194028">(</span><span class="ident" id="4194029">sig</span><span class="op" id="4194032">)</span><span class="op" id="4194033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4194036">copy</span><span class="op" id="4194040">(</span><span class="ident" id="4194041">k</span><span class="op" id="4194042">[</span><span class="num" id="4194043">2</span><span class="op" id="4194044">:</span><span class="op" id="4194045">]</span><span class="op" id="4194046">,</span>&nbsp;<span class="ident" id="4194048">sig</span><span class="op" id="4194051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194055">return</span>&nbsp;<span class="ident" id="4194062">skx</span><span class="op" id="4194065">,</span>&nbsp;<span class="ident" id="4194067">nil</span><br>
<span class="lineno">285</span><span class="op" id="4194071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4194074">func</span>&nbsp;<span class="op" id="4194079">(</span><span class="ident" id="4194080">ka</span>&nbsp;<span class="op" id="4194083">*</span><span class="ident" id="4194084">ecdheKeyAgreement</span><span class="op" id="4194101">)</span>&nbsp;<span class="ident" id="4194103">processClientKeyExchange</span><span class="op" id="4194127">(</span><span class="ident" id="4194128">config</span>&nbsp;<span class="op" id="4194135">*</span><span class="ident" id="4194136">Config</span><span class="op" id="4194142">,</span>&nbsp;<span class="ident" id="4194144">cert</span>&nbsp;<span class="op" id="4194149">*</span><span class="ident" id="4194150">Certificate</span><span class="op" id="4194161">,</span>&nbsp;<span class="ident" id="4194163">ckx</span>&nbsp;<span class="op" id="4194167">*</span><span class="ident" id="4194168">clientKeyExchangeMsg</span><span class="op" id="4194188">,</span>&nbsp;<span class="ident" id="4194190">version</span>&nbsp;<span class="builtintype" id="4194198">uint16</span><span class="op" id="4194204">)</span>&nbsp;<span class="op" id="4194206">(</span><span class="op" id="4194207">[</span><span class="op" id="4194208">]</span><span class="builtintype" id="4194209">byte</span><span class="op" id="4194213">,</span>&nbsp;<span class="builtintype" id="4194215">error</span><span class="op" id="4194220">)</span>&nbsp;<span class="op" id="4194222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194225">if</span>&nbsp;<span class="builtinfunc" id="4194228">len</span><span class="op" id="4194231">(</span><span class="ident" id="4194232">ckx</span><span class="op" id="4194235">.</span><span class="ident" id="4194236">ciphertext</span><span class="op" id="4194246">)</span>&nbsp;<span class="op" id="4194248">==</span>&nbsp;<span class="num" id="4194251">0</span>&nbsp;<span class="op" id="4194253">||</span>&nbsp;<span class="builtintype" id="4194256">int</span><span class="op" id="4194259">(</span><span class="ident" id="4194260">ckx</span><span class="op" id="4194263">.</span><span class="ident" id="4194264">ciphertext</span><span class="op" id="4194274">[</span><span class="num" id="4194275">0</span><span class="op" id="4194276">]</span><span class="op" id="4194277">)</span>&nbsp;<span class="op" id="4194279">!=</span>&nbsp;<span class="builtinfunc" id="4194282">len</span><span class="op" id="4194285">(</span><span class="ident" id="4194286">ckx</span><span class="op" id="4194289">.</span><span class="ident" id="4194290">ciphertext</span><span class="op" id="4194300">)</span><span class="op" id="4194301">-</span><span class="num" id="4194302">1</span>&nbsp;<span class="op" id="4194304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194308">return</span>&nbsp;<span class="ident" id="4194315">nil</span><span class="op" id="4194318">,</span>&nbsp;<span class="ident" id="4194320">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4194342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194345">x</span><span class="op" id="4194346">,</span>&nbsp;<span class="ident" id="4194348">y</span>&nbsp;<span class="op" id="4194350">:=</span>&nbsp;<span class="ident" id="4194353">elliptic</span><span class="op" id="4194361">.</span><span class="ident" id="4194362">Unmarshal</span><span class="op" id="4194371">(</span><span class="ident" id="4194372">ka</span><span class="op" id="4194374">.</span><span class="ident" id="4194375">curve</span><span class="op" id="4194380">,</span>&nbsp;<span class="ident" id="4194382">ckx</span><span class="op" id="4194385">.</span><span class="ident" id="4194386">ciphertext</span><span class="op" id="4194396">[</span><span class="num" id="4194397">1</span><span class="op" id="4194398">:</span><span class="op" id="4194399">]</span><span class="op" id="4194400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194403">if</span>&nbsp;<span class="ident" id="4194406">x</span>&nbsp;<span class="op" id="4194408">==</span>&nbsp;<span class="ident" id="4194411">nil</span>&nbsp;<span class="op" id="4194415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194419">return</span>&nbsp;<span class="ident" id="4194426">nil</span><span class="op" id="4194429">,</span>&nbsp;<span class="ident" id="4194431">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4194453">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194456">if</span>&nbsp;<span class="op" id="4194459">!</span><span class="ident" id="4194460">ka</span><span class="op" id="4194462">.</span><span class="ident" id="4194463">curve</span><span class="op" id="4194468">.</span><span class="ident" id="4194469">IsOnCurve</span><span class="op" id="4194478">(</span><span class="ident" id="4194479">x</span><span class="op" id="4194480">,</span>&nbsp;<span class="ident" id="4194482">y</span><span class="op" id="4194483">)</span>&nbsp;<span class="op" id="4194485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194489">return</span>&nbsp;<span class="ident" id="4194496">nil</span><span class="op" id="4194499">,</span>&nbsp;<span class="ident" id="4194501">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4194523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194526">x</span><span class="op" id="4194527">,</span>&nbsp;<span class="ident" id="4194529">_</span>&nbsp;<span class="op" id="4194531">=</span>&nbsp;<span class="ident" id="4194533">ka</span><span class="op" id="4194535">.</span><span class="ident" id="4194536">curve</span><span class="op" id="4194541">.</span><span class="ident" id="4194542">ScalarMult</span><span class="op" id="4194552">(</span><span class="ident" id="4194553">x</span><span class="op" id="4194554">,</span>&nbsp;<span class="ident" id="4194556">y</span><span class="op" id="4194557">,</span>&nbsp;<span class="ident" id="4194559">ka</span><span class="op" id="4194561">.</span><span class="ident" id="4194562">privateKey</span><span class="op" id="4194572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194575">preMasterSecret</span>&nbsp;<span class="op" id="4194591">:=</span>&nbsp;<span class="builtinfunc" id="4194594">make</span><span class="op" id="4194598">(</span><span class="op" id="4194599">[</span><span class="op" id="4194600">]</span><span class="builtintype" id="4194601">byte</span><span class="op" id="4194605">,</span>&nbsp;<span class="op" id="4194607">(</span><span class="ident" id="4194608">ka</span><span class="op" id="4194610">.</span><span class="ident" id="4194611">curve</span><span class="op" id="4194616">.</span><span class="ident" id="4194617">Params</span><span class="op" id="4194623">(</span><span class="op" id="4194624">)</span><span class="op" id="4194625">.</span><span class="ident" id="4194626">BitSize</span><span class="op" id="4194633">+</span><span class="num" id="4194634">7</span><span class="op" id="4194635">)</span><span class="op" id="4194636">&gt;&gt;</span><span class="num" id="4194638">3</span><span class="op" id="4194639">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4194642">xBytes</span>&nbsp;<span class="op" id="4194649">:=</span>&nbsp;<span class="ident" id="4194652">x</span><span class="op" id="4194653">.</span><span class="ident" id="4194654">Bytes</span><span class="op" id="4194659">(</span><span class="op" id="4194660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4194663">copy</span><span class="op" id="4194667">(</span><span class="ident" id="4194668">preMasterSecret</span><span class="op" id="4194683">[</span><span class="builtinfunc" id="4194684">len</span><span class="op" id="4194687">(</span><span class="ident" id="4194688">preMasterSecret</span><span class="op" id="4194703">)</span><span class="op" id="4194704">-</span><span class="builtinfunc" id="4194705">len</span><span class="op" id="4194708">(</span><span class="ident" id="4194709">xBytes</span><span class="op" id="4194715">)</span><span class="op" id="4194716">:</span><span class="op" id="4194717">]</span><span class="op" id="4194718">,</span>&nbsp;<span class="ident" id="4194720">xBytes</span><span class="op" id="4194726">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194730">return</span>&nbsp;<span class="ident" id="4194737">preMasterSecret</span><span class="op" id="4194752">,</span>&nbsp;<span class="ident" id="4194754">nil</span><br>
<span class="lineno"></span><span class="op" id="4194758">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="4194761">func</span>&nbsp;<span class="op" id="4194766">(</span><span class="ident" id="4194767">ka</span>&nbsp;<span class="op" id="4194770">*</span><span class="ident" id="4194771">ecdheKeyAgreement</span><span class="op" id="4194788">)</span>&nbsp;<span class="ident" id="4194790">processServerKeyExchange</span><span class="op" id="4194814">(</span><span class="ident" id="4194815">config</span>&nbsp;<span class="op" id="4194822">*</span><span class="ident" id="4194823">Config</span><span class="op" id="4194829">,</span>&nbsp;<span class="ident" id="4194831">clientHello</span>&nbsp;<span class="op" id="4194843">*</span><span class="ident" id="4194844">clientHelloMsg</span><span class="op" id="4194858">,</span>&nbsp;<span class="ident" id="4194860">serverHello</span>&nbsp;<span class="op" id="4194872">*</span><span class="ident" id="4194873">serverHelloMsg</span><span class="op" id="4194887">,</span>&nbsp;<span class="ident" id="4194889">cert</span>&nbsp;<span class="op" id="4194894">*</span><span class="ident" id="4194895">x509</span><span class="op" id="4194899">.</span><span class="ident" id="4194900">Certificate</span><span class="op" id="4194911">,</span>&nbsp;<span class="ident" id="4194913">skx</span>&nbsp;<span class="op" id="4194917">*</span><span class="ident" id="4194918">serverKeyExchangeMsg</span><span class="op" id="4194938">)</span>&nbsp;<span class="builtintype" id="4194940">error</span>&nbsp;<span class="op" id="4194946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194949">if</span>&nbsp;<span class="builtinfunc" id="4194952">len</span><span class="op" id="4194955">(</span><span class="ident" id="4194956">skx</span><span class="op" id="4194959">.</span><span class="ident" id="4194960">key</span><span class="op" id="4194963">)</span>&nbsp;<span class="op" id="4194965">&lt;</span>&nbsp;<span class="num" id="4194967">4</span>&nbsp;<span class="op" id="4194969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4194973">return</span>&nbsp;<span class="ident" id="4194980">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195002">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195005">if</span>&nbsp;<span class="ident" id="4195008">skx</span><span class="op" id="4195011">.</span><span class="ident" id="4195012">key</span><span class="op" id="4195015">[</span><span class="num" id="4195016">0</span><span class="op" id="4195017">]</span>&nbsp;<span class="op" id="4195019">!=</span>&nbsp;<span class="num" id="4195022">3</span>&nbsp;<span class="op" id="4195024">{</span>&nbsp;<span class="comment" id="4195026">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195043">return</span>&nbsp;<span class="ident" id="4195050">errors</span><span class="op" id="4195056">.</span><span class="ident" id="4195057">New</span><span class="op" id="4195060">(</span><span class="string" id="4195061">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4195101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195107">curveid</span>&nbsp;<span class="op" id="4195115">:=</span>&nbsp;<span class="ident" id="4195118">CurveID</span><span class="op" id="4195125">(</span><span class="ident" id="4195126">skx</span><span class="op" id="4195129">.</span><span class="ident" id="4195130">key</span><span class="op" id="4195133">[</span><span class="num" id="4195134">1</span><span class="op" id="4195135">]</span><span class="op" id="4195136">)</span><span class="op" id="4195137">&lt;&lt;</span><span class="num" id="4195139">8</span>&nbsp;<span class="op" id="4195141">|</span>&nbsp;<span class="ident" id="4195143">CurveID</span><span class="op" id="4195150">(</span><span class="ident" id="4195151">skx</span><span class="op" id="4195154">.</span><span class="ident" id="4195155">key</span><span class="op" id="4195158">[</span><span class="num" id="4195159">2</span><span class="op" id="4195160">]</span><span class="op" id="4195161">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195165">var</span>&nbsp;<span class="ident" id="4195169">ok</span>&nbsp;<span class="builtintype" id="4195172">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195178">if</span>&nbsp;<span class="ident" id="4195181">ka</span><span class="op" id="4195183">.</span><span class="ident" id="4195184">curve</span><span class="op" id="4195189">,</span>&nbsp;<span class="ident" id="4195191">ok</span>&nbsp;<span class="op" id="4195194">=</span>&nbsp;<span class="ident" id="4195196">curveForCurveID</span><span class="op" id="4195211">(</span><span class="ident" id="4195212">curveid</span><span class="op" id="4195219">)</span><span class="op" id="4195220">;</span>&nbsp;<span class="op" id="4195222">!</span><span class="ident" id="4195223">ok</span>&nbsp;<span class="op" id="4195226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195230">return</span>&nbsp;<span class="ident" id="4195237">errors</span><span class="op" id="4195243">.</span><span class="ident" id="4195244">New</span><span class="op" id="4195247">(</span><span class="string" id="4195248">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4195288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195295">publicLen</span>&nbsp;<span class="op" id="4195305">:=</span>&nbsp;<span class="builtintype" id="4195308">int</span><span class="op" id="4195311">(</span><span class="ident" id="4195312">skx</span><span class="op" id="4195315">.</span><span class="ident" id="4195316">key</span><span class="op" id="4195319">[</span><span class="num" id="4195320">3</span><span class="op" id="4195321">]</span><span class="op" id="4195322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195325">if</span>&nbsp;<span class="ident" id="4195328">publicLen</span><span class="op" id="4195337">+</span><span class="num" id="4195338">4</span>&nbsp;<span class="op" id="4195340">&gt;</span>&nbsp;<span class="builtinfunc" id="4195342">len</span><span class="op" id="4195345">(</span><span class="ident" id="4195346">skx</span><span class="op" id="4195349">.</span><span class="ident" id="4195350">key</span><span class="op" id="4195353">)</span>&nbsp;<span class="op" id="4195355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195359">return</span>&nbsp;<span class="ident" id="4195366">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195391">ka</span><span class="op" id="4195393">.</span><span class="ident" id="4195394">x</span><span class="op" id="4195395">,</span>&nbsp;<span class="ident" id="4195397">ka</span><span class="op" id="4195399">.</span><span class="ident" id="4195400">y</span>&nbsp;<span class="op" id="4195402">=</span>&nbsp;<span class="ident" id="4195404">elliptic</span><span class="op" id="4195412">.</span><span class="ident" id="4195413">Unmarshal</span><span class="op" id="4195422">(</span><span class="ident" id="4195423">ka</span><span class="op" id="4195425">.</span><span class="ident" id="4195426">curve</span><span class="op" id="4195431">,</span>&nbsp;<span class="ident" id="4195433">skx</span><span class="op" id="4195436">.</span><span class="ident" id="4195437">key</span><span class="op" id="4195440">[</span><span class="num" id="4195441">4</span><span class="op" id="4195442">:</span><span class="num" id="4195443">4</span><span class="op" id="4195444">+</span><span class="ident" id="4195445">publicLen</span><span class="op" id="4195454">]</span><span class="op" id="4195455">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195458">if</span>&nbsp;<span class="ident" id="4195461">ka</span><span class="op" id="4195463">.</span><span class="ident" id="4195464">x</span>&nbsp;<span class="op" id="4195466">==</span>&nbsp;<span class="ident" id="4195469">nil</span>&nbsp;<span class="op" id="4195473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195477">return</span>&nbsp;<span class="ident" id="4195484">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195509">if</span>&nbsp;<span class="op" id="4195512">!</span><span class="ident" id="4195513">ka</span><span class="op" id="4195515">.</span><span class="ident" id="4195516">curve</span><span class="op" id="4195521">.</span><span class="ident" id="4195522">IsOnCurve</span><span class="op" id="4195531">(</span><span class="ident" id="4195532">ka</span><span class="op" id="4195534">.</span><span class="ident" id="4195535">x</span><span class="op" id="4195536">,</span>&nbsp;<span class="ident" id="4195538">ka</span><span class="op" id="4195540">.</span><span class="ident" id="4195541">y</span><span class="op" id="4195542">)</span>&nbsp;<span class="op" id="4195544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195548">return</span>&nbsp;<span class="ident" id="4195555">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195580">serverECDHParams</span>&nbsp;<span class="op" id="4195597">:=</span>&nbsp;<span class="ident" id="4195600">skx</span><span class="op" id="4195603">.</span><span class="ident" id="4195604">key</span><span class="op" id="4195607">[</span><span class="op" id="4195608">:</span><span class="num" id="4195609">4</span><span class="op" id="4195610">+</span><span class="ident" id="4195611">publicLen</span><span class="op" id="4195620">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195624">sig</span>&nbsp;<span class="op" id="4195628">:=</span>&nbsp;<span class="ident" id="4195631">skx</span><span class="op" id="4195634">.</span><span class="ident" id="4195635">key</span><span class="op" id="4195638">[</span><span class="num" id="4195639">4</span><span class="op" id="4195640">+</span><span class="ident" id="4195641">publicLen</span><span class="op" id="4195650">:</span><span class="op" id="4195651">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195654">if</span>&nbsp;<span class="builtinfunc" id="4195657">len</span><span class="op" id="4195660">(</span><span class="ident" id="4195661">sig</span><span class="op" id="4195664">)</span>&nbsp;<span class="op" id="4195666">&lt;</span>&nbsp;<span class="num" id="4195668">2</span>&nbsp;<span class="op" id="4195670">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195674">return</span>&nbsp;<span class="ident" id="4195681">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195707">var</span>&nbsp;<span class="ident" id="4195711">tls12HashId</span>&nbsp;<span class="builtintype" id="4195723">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195730">if</span>&nbsp;<span class="ident" id="4195733">ka</span><span class="op" id="4195735">.</span><span class="ident" id="4195736">version</span>&nbsp;<span class="op" id="4195744">&gt;=</span>&nbsp;<span class="ident" id="4195747">VersionTLS12</span>&nbsp;<span class="op" id="4195760">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4195764">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195802">var</span>&nbsp;<span class="ident" id="4195806">sigAndHash</span>&nbsp;<span class="op" id="4195817">[</span><span class="op" id="4195818">]</span><span class="builtintype" id="4195819">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195827">sigAndHash</span><span class="op" id="4195837">,</span>&nbsp;<span class="ident" id="4195839">sig</span>&nbsp;<span class="op" id="4195843">=</span>&nbsp;<span class="ident" id="4195845">sig</span><span class="op" id="4195848">[</span><span class="op" id="4195849">:</span><span class="num" id="4195850">2</span><span class="op" id="4195851">]</span><span class="op" id="4195852">,</span>&nbsp;<span class="ident" id="4195854">sig</span><span class="op" id="4195857">[</span><span class="num" id="4195858">2</span><span class="op" id="4195859">:</span><span class="op" id="4195860">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195864">if</span>&nbsp;<span class="ident" id="4195867">sigAndHash</span><span class="op" id="4195877">[</span><span class="num" id="4195878">1</span><span class="op" id="4195879">]</span>&nbsp;<span class="op" id="4195881">!=</span>&nbsp;<span class="ident" id="4195884">ka</span><span class="op" id="4195886">.</span><span class="ident" id="4195887">sigType</span>&nbsp;<span class="op" id="4195895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195900">return</span>&nbsp;<span class="ident" id="4195907">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4195930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195934">tls12HashId</span>&nbsp;<span class="op" id="4195946">=</span>&nbsp;<span class="ident" id="4195948">sigAndHash</span><span class="op" id="4195958">[</span><span class="num" id="4195959">0</span><span class="op" id="4195960">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195964">if</span>&nbsp;<span class="builtinfunc" id="4195967">len</span><span class="op" id="4195970">(</span><span class="ident" id="4195971">sig</span><span class="op" id="4195974">)</span>&nbsp;<span class="op" id="4195976">&lt;</span>&nbsp;<span class="num" id="4195978">2</span>&nbsp;<span class="op" id="4195980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4195985">return</span>&nbsp;<span class="ident" id="4195992">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196015">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196021">sigLen</span>&nbsp;<span class="op" id="4196028">:=</span>&nbsp;<span class="builtintype" id="4196031">int</span><span class="op" id="4196034">(</span><span class="ident" id="4196035">sig</span><span class="op" id="4196038">[</span><span class="num" id="4196039">0</span><span class="op" id="4196040">]</span><span class="op" id="4196041">)</span><span class="op" id="4196042">&lt;&lt;</span><span class="num" id="4196044">8</span>&nbsp;<span class="op" id="4196046">|</span>&nbsp;<span class="builtintype" id="4196048">int</span><span class="op" id="4196051">(</span><span class="ident" id="4196052">sig</span><span class="op" id="4196055">[</span><span class="num" id="4196056">1</span><span class="op" id="4196057">]</span><span class="op" id="4196058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196061">if</span>&nbsp;<span class="ident" id="4196064">sigLen</span><span class="op" id="4196070">+</span><span class="num" id="4196071">2</span>&nbsp;<span class="op" id="4196073">!=</span>&nbsp;<span class="builtinfunc" id="4196076">len</span><span class="op" id="4196079">(</span><span class="ident" id="4196080">sig</span><span class="op" id="4196083">)</span>&nbsp;<span class="op" id="4196085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196089">return</span>&nbsp;<span class="ident" id="4196096">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196118">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196121">sig</span>&nbsp;<span class="op" id="4196125">=</span>&nbsp;<span class="ident" id="4196127">sig</span><span class="op" id="4196130">[</span><span class="num" id="4196131">2</span><span class="op" id="4196132">:</span><span class="op" id="4196133">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196137">digest</span><span class="op" id="4196143">,</span>&nbsp;<span class="ident" id="4196145">hashFunc</span><span class="op" id="4196153">,</span>&nbsp;<span class="ident" id="4196155">err</span>&nbsp;<span class="op" id="4196159">:=</span>&nbsp;<span class="ident" id="4196162">hashForServerKeyExchange</span><span class="op" id="4196186">(</span><span class="ident" id="4196187">ka</span><span class="op" id="4196189">.</span><span class="ident" id="4196190">sigType</span><span class="op" id="4196197">,</span>&nbsp;<span class="ident" id="4196199">tls12HashId</span><span class="op" id="4196210">,</span>&nbsp;<span class="ident" id="4196212">ka</span><span class="op" id="4196214">.</span><span class="ident" id="4196215">version</span><span class="op" id="4196222">,</span>&nbsp;<span class="ident" id="4196224">clientHello</span><span class="op" id="4196235">.</span><span class="ident" id="4196236">random</span><span class="op" id="4196242">,</span>&nbsp;<span class="ident" id="4196244">serverHello</span><span class="op" id="4196255">.</span><span class="ident" id="4196256">random</span><span class="op" id="4196262">,</span>&nbsp;<span class="ident" id="4196264">serverECDHParams</span><span class="op" id="4196280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196283">if</span>&nbsp;<span class="ident" id="4196286">err</span>&nbsp;<span class="op" id="4196290">!=</span>&nbsp;<span class="ident" id="4196293">nil</span>&nbsp;<span class="op" id="4196297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196301">return</span>&nbsp;<span class="ident" id="4196308">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196316">switch</span>&nbsp;<span class="ident" id="4196323">ka</span><span class="op" id="4196325">.</span><span class="ident" id="4196326">sigType</span>&nbsp;<span class="op" id="4196334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196337">case</span>&nbsp;<span class="ident" id="4196342">signatureECDSA</span><span class="op" id="4196356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196360">pubKey</span><span class="op" id="4196366">,</span>&nbsp;<span class="ident" id="4196368">ok</span>&nbsp;<span class="op" id="4196371">:=</span>&nbsp;<span class="ident" id="4196374">cert</span><span class="op" id="4196378">.</span><span class="ident" id="4196379">PublicKey</span><span class="op" id="4196388">.</span><span class="op" id="4196389">(</span><span class="op" id="4196390">*</span><span class="ident" id="4196391">ecdsa</span><span class="op" id="4196396">.</span><span class="ident" id="4196397">PublicKey</span><span class="op" id="4196406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196410">if</span>&nbsp;<span class="op" id="4196413">!</span><span class="ident" id="4196414">ok</span>&nbsp;<span class="op" id="4196417">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196422">return</span>&nbsp;<span class="ident" id="4196429">errors</span><span class="op" id="4196435">.</span><span class="ident" id="4196436">New</span><span class="op" id="4196439">(</span><span class="string" id="4196440">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4196488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196496">ecdsaSig</span>&nbsp;<span class="op" id="4196505">:=</span>&nbsp;<span class="builtinfunc" id="4196508">new</span><span class="op" id="4196511">(</span><span class="ident" id="4196512">ecdsaSignature</span><span class="op" id="4196526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196530">if</span>&nbsp;<span class="ident" id="4196533">_</span><span class="op" id="4196534">,</span>&nbsp;<span class="ident" id="4196536">err</span>&nbsp;<span class="op" id="4196540">:=</span>&nbsp;<span class="ident" id="4196543">asn1</span><span class="op" id="4196547">.</span><span class="ident" id="4196548">Unmarshal</span><span class="op" id="4196557">(</span><span class="ident" id="4196558">sig</span><span class="op" id="4196561">,</span>&nbsp;<span class="ident" id="4196563">ecdsaSig</span><span class="op" id="4196571">)</span><span class="op" id="4196572">;</span>&nbsp;<span class="ident" id="4196574">err</span>&nbsp;<span class="op" id="4196578">!=</span>&nbsp;<span class="ident" id="4196581">nil</span>&nbsp;<span class="op" id="4196585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196590">return</span>&nbsp;<span class="ident" id="4196597">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196607">if</span>&nbsp;<span class="ident" id="4196610">ecdsaSig</span><span class="op" id="4196618">.</span><span class="ident" id="4196619">R</span><span class="op" id="4196620">.</span><span class="ident" id="4196621">Sign</span><span class="op" id="4196625">(</span><span class="op" id="4196626">)</span>&nbsp;<span class="op" id="4196628">&lt;=</span>&nbsp;<span class="num" id="4196631">0</span>&nbsp;<span class="op" id="4196633">||</span>&nbsp;<span class="ident" id="4196636">ecdsaSig</span><span class="op" id="4196644">.</span><span class="ident" id="4196645">S</span><span class="op" id="4196646">.</span><span class="ident" id="4196647">Sign</span><span class="op" id="4196651">(</span><span class="op" id="4196652">)</span>&nbsp;<span class="op" id="4196654">&lt;=</span>&nbsp;<span class="num" id="4196657">0</span>&nbsp;<span class="op" id="4196659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196664">return</span>&nbsp;<span class="ident" id="4196671">errors</span><span class="op" id="4196677">.</span><span class="ident" id="4196678">New</span><span class="op" id="4196681">(</span><span class="string" id="4196682">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4196733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196741">if</span>&nbsp;<span class="op" id="4196744">!</span><span class="ident" id="4196745">ecdsa</span><span class="op" id="4196750">.</span><span class="ident" id="4196751">Verify</span><span class="op" id="4196757">(</span><span class="ident" id="4196758">pubKey</span><span class="op" id="4196764">,</span>&nbsp;<span class="ident" id="4196766">digest</span><span class="op" id="4196772">,</span>&nbsp;<span class="ident" id="4196774">ecdsaSig</span><span class="op" id="4196782">.</span><span class="ident" id="4196783">R</span><span class="op" id="4196784">,</span>&nbsp;<span class="ident" id="4196786">ecdsaSig</span><span class="op" id="4196794">.</span><span class="ident" id="4196795">S</span><span class="op" id="4196796">)</span>&nbsp;<span class="op" id="4196798">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196803">return</span>&nbsp;<span class="ident" id="4196810">errors</span><span class="op" id="4196816">.</span><span class="ident" id="4196817">New</span><span class="op" id="4196820">(</span><span class="string" id="4196821">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4196849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4196853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196856">case</span>&nbsp;<span class="ident" id="4196861">signatureRSA</span><span class="op" id="4196873">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196877">pubKey</span><span class="op" id="4196883">,</span>&nbsp;<span class="ident" id="4196885">ok</span>&nbsp;<span class="op" id="4196888">:=</span>&nbsp;<span class="ident" id="4196891">cert</span><span class="op" id="4196895">.</span><span class="ident" id="4196896">PublicKey</span><span class="op" id="4196905">.</span><span class="op" id="4196906">(</span><span class="op" id="4196907">*</span><span class="ident" id="4196908">rsa</span><span class="op" id="4196911">.</span><span class="ident" id="4196912">PublicKey</span><span class="op" id="4196921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196925">if</span>&nbsp;<span class="op" id="4196928">!</span><span class="ident" id="4196929">ok</span>&nbsp;<span class="op" id="4196932">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196937">return</span>&nbsp;<span class="ident" id="4196944">errors</span><span class="op" id="4196950">.</span><span class="ident" id="4196951">New</span><span class="op" id="4196954">(</span><span class="string" id="4196955">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4196999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197007">if</span>&nbsp;<span class="ident" id="4197010">err</span>&nbsp;<span class="op" id="4197014">:=</span>&nbsp;<span class="ident" id="4197017">rsa</span><span class="op" id="4197020">.</span><span class="ident" id="4197021">VerifyPKCS1v15</span><span class="op" id="4197035">(</span><span class="ident" id="4197036">pubKey</span><span class="op" id="4197042">,</span>&nbsp;<span class="ident" id="4197044">hashFunc</span><span class="op" id="4197052">,</span>&nbsp;<span class="ident" id="4197054">digest</span><span class="op" id="4197060">,</span>&nbsp;<span class="ident" id="4197062">sig</span><span class="op" id="4197065">)</span><span class="op" id="4197066">;</span>&nbsp;<span class="ident" id="4197068">err</span>&nbsp;<span class="op" id="4197072">!=</span>&nbsp;<span class="ident" id="4197075">nil</span>&nbsp;<span class="op" id="4197079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197084">return</span>&nbsp;<span class="ident" id="4197091">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197097">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197100">default</span><span class="op" id="4197107">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197111">return</span>&nbsp;<span class="ident" id="4197118">errors</span><span class="op" id="4197124">.</span><span class="ident" id="4197125">New</span><span class="op" id="4197128">(</span><span class="string" id="4197129">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4197164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197171">return</span>&nbsp;<span class="ident" id="4197178">nil</span><br>
<span class="lineno">390</span><span class="op" id="4197182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4197185">func</span>&nbsp;<span class="op" id="4197190">(</span><span class="ident" id="4197191">ka</span>&nbsp;<span class="op" id="4197194">*</span><span class="ident" id="4197195">ecdheKeyAgreement</span><span class="op" id="4197212">)</span>&nbsp;<span class="ident" id="4197214">generateClientKeyExchange</span><span class="op" id="4197239">(</span><span class="ident" id="4197240">config</span>&nbsp;<span class="op" id="4197247">*</span><span class="ident" id="4197248">Config</span><span class="op" id="4197254">,</span>&nbsp;<span class="ident" id="4197256">clientHello</span>&nbsp;<span class="op" id="4197268">*</span><span class="ident" id="4197269">clientHelloMsg</span><span class="op" id="4197283">,</span>&nbsp;<span class="ident" id="4197285">cert</span>&nbsp;<span class="op" id="4197290">*</span><span class="ident" id="4197291">x509</span><span class="op" id="4197295">.</span><span class="ident" id="4197296">Certificate</span><span class="op" id="4197307">)</span>&nbsp;<span class="op" id="4197309">(</span><span class="op" id="4197310">[</span><span class="op" id="4197311">]</span><span class="builtintype" id="4197312">byte</span><span class="op" id="4197316">,</span>&nbsp;<span class="op" id="4197318">*</span><span class="ident" id="4197319">clientKeyExchangeMsg</span><span class="op" id="4197339">,</span>&nbsp;<span class="builtintype" id="4197341">error</span><span class="op" id="4197346">)</span>&nbsp;<span class="op" id="4197348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197351">if</span>&nbsp;<span class="ident" id="4197354">ka</span><span class="op" id="4197356">.</span><span class="ident" id="4197357">curve</span>&nbsp;<span class="op" id="4197363">==</span>&nbsp;<span class="ident" id="4197366">nil</span>&nbsp;<span class="op" id="4197370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197374">return</span>&nbsp;<span class="ident" id="4197381">nil</span><span class="op" id="4197384">,</span>&nbsp;<span class="ident" id="4197386">nil</span><span class="op" id="4197389">,</span>&nbsp;<span class="ident" id="4197391">errors</span><span class="op" id="4197397">.</span><span class="ident" id="4197398">New</span><span class="op" id="4197401">(</span><span class="string" id="4197402">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4197437">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197443">priv</span><span class="op" id="4197447">,</span>&nbsp;<span class="ident" id="4197449">mx</span><span class="op" id="4197451">,</span>&nbsp;<span class="ident" id="4197453">my</span><span class="op" id="4197455">,</span>&nbsp;<span class="ident" id="4197457">err</span>&nbsp;<span class="op" id="4197461">:=</span>&nbsp;<span class="ident" id="4197464">elliptic</span><span class="op" id="4197472">.</span><span class="ident" id="4197473">GenerateKey</span><span class="op" id="4197484">(</span><span class="ident" id="4197485">ka</span><span class="op" id="4197487">.</span><span class="ident" id="4197488">curve</span><span class="op" id="4197493">,</span>&nbsp;<span class="ident" id="4197495">config</span><span class="op" id="4197501">.</span><span class="ident" id="4197502">rand</span><span class="op" id="4197506">(</span><span class="op" id="4197507">)</span><span class="op" id="4197508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197511">if</span>&nbsp;<span class="ident" id="4197514">err</span>&nbsp;<span class="op" id="4197518">!=</span>&nbsp;<span class="ident" id="4197521">nil</span>&nbsp;<span class="op" id="4197525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197529">return</span>&nbsp;<span class="ident" id="4197536">nil</span><span class="op" id="4197539">,</span>&nbsp;<span class="ident" id="4197541">nil</span><span class="op" id="4197544">,</span>&nbsp;<span class="ident" id="4197546">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197551">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197554">x</span><span class="op" id="4197555">,</span>&nbsp;<span class="ident" id="4197557">_</span>&nbsp;<span class="op" id="4197559">:=</span>&nbsp;<span class="ident" id="4197562">ka</span><span class="op" id="4197564">.</span><span class="ident" id="4197565">curve</span><span class="op" id="4197570">.</span><span class="ident" id="4197571">ScalarMult</span><span class="op" id="4197581">(</span><span class="ident" id="4197582">ka</span><span class="op" id="4197584">.</span><span class="ident" id="4197585">x</span><span class="op" id="4197586">,</span>&nbsp;<span class="ident" id="4197588">ka</span><span class="op" id="4197590">.</span><span class="ident" id="4197591">y</span><span class="op" id="4197592">,</span>&nbsp;<span class="ident" id="4197594">priv</span><span class="op" id="4197598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197601">preMasterSecret</span>&nbsp;<span class="op" id="4197617">:=</span>&nbsp;<span class="builtinfunc" id="4197620">make</span><span class="op" id="4197624">(</span><span class="op" id="4197625">[</span><span class="op" id="4197626">]</span><span class="builtintype" id="4197627">byte</span><span class="op" id="4197631">,</span>&nbsp;<span class="op" id="4197633">(</span><span class="ident" id="4197634">ka</span><span class="op" id="4197636">.</span><span class="ident" id="4197637">curve</span><span class="op" id="4197642">.</span><span class="ident" id="4197643">Params</span><span class="op" id="4197649">(</span><span class="op" id="4197650">)</span><span class="op" id="4197651">.</span><span class="ident" id="4197652">BitSize</span><span class="op" id="4197659">+</span><span class="num" id="4197660">7</span><span class="op" id="4197661">)</span><span class="op" id="4197662">&gt;&gt;</span><span class="num" id="4197664">3</span><span class="op" id="4197665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197668">xBytes</span>&nbsp;<span class="op" id="4197675">:=</span>&nbsp;<span class="ident" id="4197678">x</span><span class="op" id="4197679">.</span><span class="ident" id="4197680">Bytes</span><span class="op" id="4197685">(</span><span class="op" id="4197686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4197689">copy</span><span class="op" id="4197693">(</span><span class="ident" id="4197694">preMasterSecret</span><span class="op" id="4197709">[</span><span class="builtinfunc" id="4197710">len</span><span class="op" id="4197713">(</span><span class="ident" id="4197714">preMasterSecret</span><span class="op" id="4197729">)</span><span class="op" id="4197730">-</span><span class="builtinfunc" id="4197731">len</span><span class="op" id="4197734">(</span><span class="ident" id="4197735">xBytes</span><span class="op" id="4197741">)</span><span class="op" id="4197742">:</span><span class="op" id="4197743">]</span><span class="op" id="4197744">,</span>&nbsp;<span class="ident" id="4197746">xBytes</span><span class="op" id="4197752">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197756">serialized</span>&nbsp;<span class="op" id="4197767">:=</span>&nbsp;<span class="ident" id="4197770">elliptic</span><span class="op" id="4197778">.</span><span class="ident" id="4197779">Marshal</span><span class="op" id="4197786">(</span><span class="ident" id="4197787">ka</span><span class="op" id="4197789">.</span><span class="ident" id="4197790">curve</span><span class="op" id="4197795">,</span>&nbsp;<span class="ident" id="4197797">mx</span><span class="op" id="4197799">,</span>&nbsp;<span class="ident" id="4197801">my</span><span class="op" id="4197803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197807">ckx</span>&nbsp;<span class="op" id="4197811">:=</span>&nbsp;<span class="builtinfunc" id="4197814">new</span><span class="op" id="4197817">(</span><span class="ident" id="4197818">clientKeyExchangeMsg</span><span class="op" id="4197838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197841">ckx</span><span class="op" id="4197844">.</span><span class="ident" id="4197845">ciphertext</span>&nbsp;<span class="op" id="4197856">=</span>&nbsp;<span class="builtinfunc" id="4197858">make</span><span class="op" id="4197862">(</span><span class="op" id="4197863">[</span><span class="op" id="4197864">]</span><span class="builtintype" id="4197865">byte</span><span class="op" id="4197869">,</span>&nbsp;<span class="num" id="4197871">1</span><span class="op" id="4197872">+</span><span class="builtinfunc" id="4197873">len</span><span class="op" id="4197876">(</span><span class="ident" id="4197877">serialized</span><span class="op" id="4197887">)</span><span class="op" id="4197888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197891">ckx</span><span class="op" id="4197894">.</span><span class="ident" id="4197895">ciphertext</span><span class="op" id="4197905">[</span><span class="num" id="4197906">0</span><span class="op" id="4197907">]</span>&nbsp;<span class="op" id="4197909">=</span>&nbsp;<span class="builtintype" id="4197911">byte</span><span class="op" id="4197915">(</span><span class="builtinfunc" id="4197916">len</span><span class="op" id="4197919">(</span><span class="ident" id="4197920">serialized</span><span class="op" id="4197930">)</span><span class="op" id="4197931">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4197934">copy</span><span class="op" id="4197938">(</span><span class="ident" id="4197939">ckx</span><span class="op" id="4197942">.</span><span class="ident" id="4197943">ciphertext</span><span class="op" id="4197953">[</span><span class="num" id="4197954">1</span><span class="op" id="4197955">:</span><span class="op" id="4197956">]</span><span class="op" id="4197957">,</span>&nbsp;<span class="ident" id="4197959">serialized</span><span class="op" id="4197969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197973">return</span>&nbsp;<span class="ident" id="4197980">preMasterSecret</span><span class="op" id="4197995">,</span>&nbsp;<span class="ident" id="4197997">ckx</span><span class="op" id="4198000">,</span>&nbsp;<span class="ident" id="4198002">nil</span><br>
<span class="lineno"></span><span class="op" id="4198006">}</span>
</div>
</body>
</html>
