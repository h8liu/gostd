<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html" class="current">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8372660">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8372715">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8372769">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8372820">package</span>&nbsp;<span class="ident" id="8372828">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8372833">import</span>&nbsp;<span class="op" id="8372840">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372843">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372866">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372876">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372883">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372896">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372907">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372918">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372929">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372937">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8372948">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8372955">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8372958">func</span>&nbsp;<span class="ident" id="8372963">init</span><span class="op" id="8372967">(</span><span class="op" id="8372968">)</span>&nbsp;<span class="op" id="8372970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372973">type</span>&nbsp;<span class="ident" id="8372978">dbConn</span>&nbsp;<span class="keyword" id="8372985">struct</span>&nbsp;<span class="op" id="8372992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8372996">db</span>&nbsp;<span class="op" id="8372999">*</span><span class="ident" id="8373000">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373005">c</span>&nbsp;&nbsp;<span class="op" id="8373008">*</span><span class="ident" id="8373009">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8373021">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373024">freedFrom</span>&nbsp;<span class="op" id="8373034">:=</span>&nbsp;<span class="builtinfunc" id="8373037">make</span><span class="op" id="8373041">(</span><span class="keyword" id="8373042">map</span><span class="op" id="8373045">[</span><span class="ident" id="8373046">dbConn</span><span class="op" id="8373052">]</span><span class="builtintype" id="8373053">string</span><span class="op" id="8373059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373062">putConnHook</span>&nbsp;<span class="op" id="8373074">=</span>&nbsp;<span class="keyword" id="8373076">func</span><span class="op" id="8373080">(</span><span class="ident" id="8373081">db</span>&nbsp;<span class="op" id="8373084">*</span><span class="ident" id="8373085">DB</span><span class="op" id="8373087">,</span>&nbsp;<span class="ident" id="8373089">c</span>&nbsp;<span class="op" id="8373091">*</span><span class="ident" id="8373092">driverConn</span><span class="op" id="8373102">)</span>&nbsp;<span class="op" id="8373104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373108">idx</span>&nbsp;<span class="op" id="8373112">:=</span>&nbsp;<span class="op" id="8373115">-</span><span class="num" id="8373116">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8373120">for</span>&nbsp;<span class="ident" id="8373124">i</span><span class="op" id="8373125">,</span>&nbsp;<span class="ident" id="8373127">v</span>&nbsp;<span class="op" id="8373129">:=</span>&nbsp;<span class="keyword" id="8373132">range</span>&nbsp;<span class="ident" id="8373138">db</span><span class="op" id="8373140">.</span><span class="ident" id="8373141">freeConn</span>&nbsp;<span class="op" id="8373150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8373155">if</span>&nbsp;<span class="ident" id="8373158">v</span>&nbsp;<span class="op" id="8373160">==</span>&nbsp;<span class="ident" id="8373163">c</span>&nbsp;<span class="op" id="8373165">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373171">idx</span>&nbsp;<span class="op" id="8373175">=</span>&nbsp;<span class="ident" id="8373177">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8373183">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8373192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8373196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8373200">if</span>&nbsp;<span class="ident" id="8373203">idx</span>&nbsp;<span class="op" id="8373207">&gt;=</span>&nbsp;<span class="num" id="8373210">0</span>&nbsp;<span class="op" id="8373212">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8373217">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8373290">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8373357">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8373391">println</span><span class="op" id="8373398">(</span><span class="string" id="8373399">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="8373442">+</span>&nbsp;<span class="ident" id="8373444">freedFrom</span><span class="op" id="8373453">[</span><span class="ident" id="8373454">dbConn</span><span class="op" id="8373460">{</span><span class="ident" id="8373461">db</span><span class="op" id="8373463">,</span>&nbsp;<span class="ident" id="8373465">c</span><span class="op" id="8373466">}</span><span class="op" id="8373467">]</span>&nbsp;<span class="op" id="8373469">+</span>&nbsp;<span class="string" id="8373471">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="8373486">+</span>&nbsp;<span class="ident" id="8373488">stack</span><span class="op" id="8373493">(</span><span class="op" id="8373494">)</span><span class="op" id="8373495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8373500">panic</span><span class="op" id="8373505">(</span><span class="string" id="8373506">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="8373528">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8373532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373536">freedFrom</span><span class="op" id="8373545">[</span><span class="ident" id="8373546">dbConn</span><span class="op" id="8373552">{</span><span class="ident" id="8373553">db</span><span class="op" id="8373555">,</span>&nbsp;<span class="ident" id="8373557">c</span><span class="op" id="8373558">}</span><span class="op" id="8373559">]</span>&nbsp;<span class="op" id="8373561">=</span>&nbsp;<span class="ident" id="8373563">stack</span><span class="op" id="8373568">(</span><span class="op" id="8373569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8373572">}</span><br>
<span class="lineno"></span><span class="op" id="8373574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="8373577">const</span>&nbsp;<span class="ident" id="8373583">fakeDBName</span>&nbsp;<span class="op" id="8373594">=</span>&nbsp;<span class="string" id="8373596">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8373603">var</span>&nbsp;<span class="ident" id="8373607">chrisBirthday</span>&nbsp;<span class="op" id="8373621">=</span>&nbsp;<span class="ident" id="8373623">time</span><span class="op" id="8373627">.</span><span class="ident" id="8373628">Unix</span><span class="op" id="8373632">(</span><span class="num" id="8373633">123456789</span><span class="op" id="8373642">,</span>&nbsp;<span class="num" id="8373644">0</span><span class="op" id="8373645">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8373648">func</span>&nbsp;<span class="ident" id="8373653">newTestDB</span><span class="op" id="8373662">(</span><span class="ident" id="8373663">t</span>&nbsp;<span class="ident" id="8373665">testing</span><span class="op" id="8373672">.</span><span class="ident" id="8373673">TB</span><span class="op" id="8373675">,</span>&nbsp;<span class="ident" id="8373677">name</span>&nbsp;<span class="builtintype" id="8373682">string</span><span class="op" id="8373688">)</span>&nbsp;<span class="op" id="8373690">*</span><span class="ident" id="8373691">DB</span>&nbsp;<span class="op" id="8373694">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373697">db</span><span class="op" id="8373699">,</span>&nbsp;<span class="ident" id="8373701">err</span>&nbsp;<span class="op" id="8373705">:=</span>&nbsp;<span class="ident" id="8373708">Open</span><span class="op" id="8373712">(</span><span class="string" id="8373713">&#34;test&#34;</span><span class="op" id="8373719">,</span>&nbsp;<span class="ident" id="8373721">fakeDBName</span><span class="op" id="8373731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8373734">if</span>&nbsp;<span class="ident" id="8373737">err</span>&nbsp;<span class="op" id="8373741">!=</span>&nbsp;<span class="builtintype" id="8373744">nil</span>&nbsp;<span class="op" id="8373748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373752">t</span><span class="op" id="8373753">.</span><span class="ident" id="8373754">Fatalf</span><span class="op" id="8373760">(</span><span class="string" id="8373761">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="8373771">,</span>&nbsp;<span class="ident" id="8373773">err</span><span class="op" id="8373776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8373779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8373782">if</span>&nbsp;<span class="ident" id="8373785">_</span><span class="op" id="8373786">,</span>&nbsp;<span class="ident" id="8373788">err</span>&nbsp;<span class="op" id="8373792">:=</span>&nbsp;<span class="ident" id="8373795">db</span><span class="op" id="8373797">.</span><span class="ident" id="8373798">Exec</span><span class="op" id="8373802">(</span><span class="string" id="8373803">&#34;WIPE&#34;</span><span class="op" id="8373809">)</span><span class="op" id="8373810">;</span>&nbsp;<span class="ident" id="8373812">err</span>&nbsp;<span class="op" id="8373816">!=</span>&nbsp;<span class="builtintype" id="8373819">nil</span>&nbsp;<span class="op" id="8373823">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373827">t</span><span class="op" id="8373828">.</span><span class="ident" id="8373829">Fatalf</span><span class="op" id="8373835">(</span><span class="string" id="8373836">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="8373851">,</span>&nbsp;<span class="ident" id="8373853">err</span><span class="op" id="8373856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8373859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8373862">if</span>&nbsp;<span class="ident" id="8373865">name</span>&nbsp;<span class="op" id="8373870">==</span>&nbsp;<span class="string" id="8373873">&#34;people&#34;</span>&nbsp;<span class="op" id="8373882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373886">exec</span><span class="op" id="8373890">(</span><span class="ident" id="8373891">t</span><span class="op" id="8373892">,</span>&nbsp;<span class="ident" id="8373894">db</span><span class="op" id="8373896">,</span>&nbsp;<span class="string" id="8373898">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="8373971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8373975">exec</span><span class="op" id="8373979">(</span><span class="ident" id="8373980">t</span><span class="op" id="8373981">,</span>&nbsp;<span class="ident" id="8373983">db</span><span class="op" id="8373985">,</span>&nbsp;<span class="string" id="8373987">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="8374032">,</span>&nbsp;<span class="num" id="8374034">1</span><span class="op" id="8374035">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374039">exec</span><span class="op" id="8374043">(</span><span class="ident" id="8374044">t</span><span class="op" id="8374045">,</span>&nbsp;<span class="ident" id="8374047">db</span><span class="op" id="8374049">,</span>&nbsp;<span class="string" id="8374051">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="8374094">,</span>&nbsp;<span class="num" id="8374096">2</span><span class="op" id="8374097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374101">exec</span><span class="op" id="8374105">(</span><span class="ident" id="8374106">t</span><span class="op" id="8374107">,</span>&nbsp;<span class="ident" id="8374109">db</span><span class="op" id="8374111">,</span>&nbsp;<span class="string" id="8374113">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8374166">,</span>&nbsp;<span class="num" id="8374168">3</span><span class="op" id="8374169">,</span>&nbsp;<span class="ident" id="8374171">chrisBirthday</span><span class="op" id="8374184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8374187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8374190">if</span>&nbsp;<span class="ident" id="8374193">name</span>&nbsp;<span class="op" id="8374198">==</span>&nbsp;<span class="string" id="8374201">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="8374214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8374218">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374277">exec</span><span class="op" id="8374281">(</span><span class="ident" id="8374282">t</span><span class="op" id="8374283">,</span>&nbsp;<span class="ident" id="8374285">db</span><span class="op" id="8374287">,</span>&nbsp;<span class="string" id="8374289">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="8374331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374335">exec</span><span class="op" id="8374339">(</span><span class="ident" id="8374340">t</span><span class="op" id="8374341">,</span>&nbsp;<span class="ident" id="8374343">db</span><span class="op" id="8374345">,</span>&nbsp;<span class="string" id="8374347">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="8374385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8374388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8374391">return</span>&nbsp;<span class="ident" id="8374398">db</span><br>
<span class="lineno"></span><span class="op" id="8374401">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="8374404">func</span>&nbsp;<span class="ident" id="8374409">exec</span><span class="op" id="8374413">(</span><span class="ident" id="8374414">t</span>&nbsp;<span class="ident" id="8374416">testing</span><span class="op" id="8374423">.</span><span class="ident" id="8374424">TB</span><span class="op" id="8374426">,</span>&nbsp;<span class="ident" id="8374428">db</span>&nbsp;<span class="op" id="8374431">*</span><span class="ident" id="8374432">DB</span><span class="op" id="8374434">,</span>&nbsp;<span class="ident" id="8374436">query</span>&nbsp;<span class="builtintype" id="8374442">string</span><span class="op" id="8374448">,</span>&nbsp;<span class="ident" id="8374450">args</span>&nbsp;<span class="op" id="8374455">...</span><span class="keyword" id="8374458">interface</span><span class="op" id="8374467">{</span><span class="op" id="8374468">}</span><span class="op" id="8374469">)</span>&nbsp;<span class="op" id="8374471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374474">_</span><span class="op" id="8374475">,</span>&nbsp;<span class="ident" id="8374477">err</span>&nbsp;<span class="op" id="8374481">:=</span>&nbsp;<span class="ident" id="8374484">db</span><span class="op" id="8374486">.</span><span class="ident" id="8374487">Exec</span><span class="op" id="8374491">(</span><span class="ident" id="8374492">query</span><span class="op" id="8374497">,</span>&nbsp;<span class="ident" id="8374499">args</span><span class="op" id="8374503">...</span><span class="op" id="8374506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8374509">if</span>&nbsp;<span class="ident" id="8374512">err</span>&nbsp;<span class="op" id="8374516">!=</span>&nbsp;<span class="builtintype" id="8374519">nil</span>&nbsp;<span class="op" id="8374523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374527">t</span><span class="op" id="8374528">.</span><span class="ident" id="8374529">Fatalf</span><span class="op" id="8374535">(</span><span class="string" id="8374536">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="8374552">,</span>&nbsp;<span class="ident" id="8374554">query</span><span class="op" id="8374559">,</span>&nbsp;<span class="ident" id="8374561">err</span><span class="op" id="8374564">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8374567">}</span><br>
<span class="lineno"></span><span class="op" id="8374569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8374572">func</span>&nbsp;<span class="ident" id="8374577">closeDB</span><span class="op" id="8374584">(</span><span class="ident" id="8374585">t</span>&nbsp;<span class="ident" id="8374587">testing</span><span class="op" id="8374594">.</span><span class="ident" id="8374595">TB</span><span class="op" id="8374597">,</span>&nbsp;<span class="ident" id="8374599">db</span>&nbsp;<span class="op" id="8374602">*</span><span class="ident" id="8374603">DB</span><span class="op" id="8374605">)</span>&nbsp;<span class="op" id="8374607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8374610">if</span>&nbsp;<span class="ident" id="8374613">e</span>&nbsp;<span class="op" id="8374615">:=</span>&nbsp;<span class="builtinfunc" id="8374618">recover</span><span class="op" id="8374625">(</span><span class="op" id="8374626">)</span><span class="op" id="8374627">;</span>&nbsp;<span class="ident" id="8374629">e</span>&nbsp;<span class="op" id="8374631">!=</span>&nbsp;<span class="builtintype" id="8374634">nil</span>&nbsp;<span class="op" id="8374638">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374642">fmt</span><span class="op" id="8374645">.</span><span class="ident" id="8374646">Printf</span><span class="op" id="8374652">(</span><span class="string" id="8374653">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="8374666">,</span>&nbsp;<span class="ident" id="8374668">e</span><span class="op" id="8374669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8374673">panic</span><span class="op" id="8374678">(</span><span class="ident" id="8374679">e</span><span class="op" id="8374680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8374683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8374686">defer</span>&nbsp;<span class="ident" id="8374692">setHookpostCloseConn</span><span class="op" id="8374712">(</span><span class="builtintype" id="8374713">nil</span><span class="op" id="8374716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374719">setHookpostCloseConn</span><span class="op" id="8374739">(</span><span class="keyword" id="8374740">func</span><span class="op" id="8374744">(</span><span class="ident" id="8374745">_</span>&nbsp;<span class="op" id="8374747">*</span><span class="ident" id="8374748">fakeConn</span><span class="op" id="8374756">,</span>&nbsp;<span class="ident" id="8374758">err</span>&nbsp;<span class="builtintype" id="8374762">error</span><span class="op" id="8374767">)</span>&nbsp;<span class="op" id="8374769">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8374773">if</span>&nbsp;<span class="ident" id="8374776">err</span>&nbsp;<span class="op" id="8374780">!=</span>&nbsp;<span class="builtintype" id="8374783">nil</span>&nbsp;<span class="op" id="8374787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8374792">t</span><span class="op" id="8374793">.</span><span class="ident" id="8374794">Errorf</span><span class="op" id="8374800">(</span><span class="string" id="8374801">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8374829">,</span>&nbsp;<span class="ident" id="8374831">err</span><span class="op" id="8374834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8374838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8374841">}</span><span class="op" id="8374842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8374845">for</span>&nbsp;<span class="ident" id="8374849">i</span><span class="op" id="8374850">,</span>&nbsp;<span class="ident" id="8374852">dc</span>&nbsp;<span class="op" id="8374855">:=</span>&nbsp;<span class="keyword" id="8374858">range</span>&nbsp;<span class="ident" id="8374864">db</span><span class="op" id="8374866">.</span><span class="ident" id="8374867">freeConn</span>&nbsp;<span class="op" id="8374876">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8374880">if</span>&nbsp;<span class="ident" id="8374883">n</span>&nbsp;<span class="op" id="8374885">:=</span>&nbsp;<span class="builtinfunc" id="8374888">len</span><span class="op" id="8374891">(</span><span class="ident" id="8374892">dc</span><span class="op" id="8374894">.</span><span class="ident" id="8374895">openStmt</span><span class="op" id="8374903">)</span><span class="op" id="8374904">;</span>&nbsp;<span class="ident" id="8374906">n</span>&nbsp;<span class="op" id="8374908">&gt;</span>&nbsp;<span class="num" id="8374910">0</span>&nbsp;<span class="op" id="8374912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8374917">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8374961">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8375010">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8375059">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8375106">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375135">t</span><span class="op" id="8375136">.</span><span class="ident" id="8375137">Errorf</span><span class="op" id="8375143">(</span><span class="string" id="8375144">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8375204">,</span>&nbsp;<span class="ident" id="8375206">i</span><span class="op" id="8375207">,</span>&nbsp;<span class="builtinfunc" id="8375209">len</span><span class="op" id="8375212">(</span><span class="ident" id="8375213">db</span><span class="op" id="8375215">.</span><span class="ident" id="8375216">freeConn</span><span class="op" id="8375224">)</span><span class="op" id="8375225">,</span>&nbsp;<span class="ident" id="8375227">n</span><span class="op" id="8375228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8375232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8375235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375238">err</span>&nbsp;<span class="op" id="8375242">:=</span>&nbsp;<span class="ident" id="8375245">db</span><span class="op" id="8375247">.</span><span class="ident" id="8375248">Close</span><span class="op" id="8375253">(</span><span class="op" id="8375254">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8375257">if</span>&nbsp;<span class="ident" id="8375260">err</span>&nbsp;<span class="op" id="8375264">!=</span>&nbsp;<span class="builtintype" id="8375267">nil</span>&nbsp;<span class="op" id="8375271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375275">t</span><span class="op" id="8375276">.</span><span class="ident" id="8375277">Fatalf</span><span class="op" id="8375283">(</span><span class="string" id="8375284">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="8375306">,</span>&nbsp;<span class="ident" id="8375308">err</span><span class="op" id="8375311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8375314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375317">db</span><span class="op" id="8375319">.</span><span class="ident" id="8375320">mu</span><span class="op" id="8375322">.</span><span class="ident" id="8375323">Lock</span><span class="op" id="8375327">(</span><span class="op" id="8375328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375331">count</span>&nbsp;<span class="op" id="8375337">:=</span>&nbsp;<span class="ident" id="8375340">db</span><span class="op" id="8375342">.</span><span class="ident" id="8375343">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375352">db</span><span class="op" id="8375354">.</span><span class="ident" id="8375355">mu</span><span class="op" id="8375357">.</span><span class="ident" id="8375358">Unlock</span><span class="op" id="8375364">(</span><span class="op" id="8375365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8375368">if</span>&nbsp;<span class="ident" id="8375371">count</span>&nbsp;<span class="op" id="8375377">!=</span>&nbsp;<span class="num" id="8375380">0</span>&nbsp;<span class="op" id="8375382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375386">t</span><span class="op" id="8375387">.</span><span class="ident" id="8375388">Fatalf</span><span class="op" id="8375394">(</span><span class="string" id="8375395">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="8375439">,</span>&nbsp;<span class="ident" id="8375441">db</span><span class="op" id="8375443">.</span><span class="ident" id="8375444">numOpen</span><span class="op" id="8375451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8375454">}</span><br>
<span class="lineno"></span><span class="op" id="8375456">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="8375459">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="8375526">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="8375559">func</span>&nbsp;<span class="ident" id="8375564">numPrepares</span><span class="op" id="8375575">(</span><span class="ident" id="8375576">t</span>&nbsp;<span class="op" id="8375578">*</span><span class="ident" id="8375579">testing</span><span class="op" id="8375586">.</span><span class="ident" id="8375587">T</span><span class="op" id="8375588">,</span>&nbsp;<span class="ident" id="8375590">db</span>&nbsp;<span class="op" id="8375593">*</span><span class="ident" id="8375594">DB</span><span class="op" id="8375596">)</span>&nbsp;<span class="builtintype" id="8375598">int</span>&nbsp;<span class="op" id="8375602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8375605">if</span>&nbsp;<span class="ident" id="8375608">n</span>&nbsp;<span class="op" id="8375610">:=</span>&nbsp;<span class="builtinfunc" id="8375613">len</span><span class="op" id="8375616">(</span><span class="ident" id="8375617">db</span><span class="op" id="8375619">.</span><span class="ident" id="8375620">freeConn</span><span class="op" id="8375628">)</span><span class="op" id="8375629">;</span>&nbsp;<span class="ident" id="8375631">n</span>&nbsp;<span class="op" id="8375633">!=</span>&nbsp;<span class="num" id="8375636">1</span>&nbsp;<span class="op" id="8375638">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375642">t</span><span class="op" id="8375643">.</span><span class="ident" id="8375644">Fatalf</span><span class="op" id="8375650">(</span><span class="string" id="8375651">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8375676">,</span>&nbsp;<span class="ident" id="8375678">n</span><span class="op" id="8375679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8375682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8375685">return</span>&nbsp;<span class="ident" id="8375692">db</span><span class="op" id="8375694">.</span><span class="ident" id="8375695">freeConn</span><span class="op" id="8375703">[</span><span class="num" id="8375704">0</span><span class="op" id="8375705">]</span><span class="op" id="8375706">.</span><span class="ident" id="8375707">ci</span><span class="op" id="8375709">.</span><span class="op" id="8375710">(</span><span class="op" id="8375711">*</span><span class="ident" id="8375712">fakeConn</span><span class="op" id="8375720">)</span><span class="op" id="8375721">.</span><span class="ident" id="8375722">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="8375733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="8375736">func</span>&nbsp;<span class="op" id="8375741">(</span><span class="ident" id="8375742">db</span>&nbsp;<span class="op" id="8375745">*</span><span class="ident" id="8375746">DB</span><span class="op" id="8375748">)</span>&nbsp;<span class="ident" id="8375750">numDeps</span><span class="op" id="8375757">(</span><span class="op" id="8375758">)</span>&nbsp;<span class="builtintype" id="8375760">int</span>&nbsp;<span class="op" id="8375764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8375767">db</span><span class="op" id="8375769">.</span><span class="ident" id="8375770">mu</span><span class="op" id="8375772">.</span><span class="ident" id="8375773">Lock</span><span class="op" id="8375777">(</span><span class="op" id="8375778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8375781">defer</span>&nbsp;<span class="ident" id="8375787">db</span><span class="op" id="8375789">.</span><span class="ident" id="8375790">mu</span><span class="op" id="8375792">.</span><span class="ident" id="8375793">Unlock</span><span class="op" id="8375799">(</span><span class="op" id="8375800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8375803">return</span>&nbsp;<span class="builtinfunc" id="8375810">len</span><span class="op" id="8375813">(</span><span class="ident" id="8375814">db</span><span class="op" id="8375816">.</span><span class="ident" id="8375817">dep</span><span class="op" id="8375820">)</span><br>
<span class="lineno"></span><span class="op" id="8375822">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="8375825">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="8375895">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="8375940">func</span>&nbsp;<span class="op" id="8375945">(</span><span class="ident" id="8375946">db</span>&nbsp;<span class="op" id="8375949">*</span><span class="ident" id="8375950">DB</span><span class="op" id="8375952">)</span>&nbsp;<span class="ident" id="8375954">numDepsPollUntil</span><span class="op" id="8375970">(</span><span class="ident" id="8375971">want</span>&nbsp;<span class="builtintype" id="8375976">int</span><span class="op" id="8375979">,</span>&nbsp;<span class="ident" id="8375981">d</span>&nbsp;<span class="ident" id="8375983">time</span><span class="op" id="8375987">.</span><span class="ident" id="8375988">Duration</span><span class="op" id="8375996">)</span>&nbsp;<span class="builtintype" id="8375998">int</span>&nbsp;<span class="op" id="8376002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376005">deadline</span>&nbsp;<span class="op" id="8376014">:=</span>&nbsp;<span class="ident" id="8376017">time</span><span class="op" id="8376021">.</span><span class="ident" id="8376022">Now</span><span class="op" id="8376025">(</span><span class="op" id="8376026">)</span><span class="op" id="8376027">.</span><span class="ident" id="8376028">Add</span><span class="op" id="8376031">(</span><span class="ident" id="8376032">d</span><span class="op" id="8376033">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376036">for</span>&nbsp;<span class="op" id="8376040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376044">n</span>&nbsp;<span class="op" id="8376046">:=</span>&nbsp;<span class="ident" id="8376049">db</span><span class="op" id="8376051">.</span><span class="ident" id="8376052">numDeps</span><span class="op" id="8376059">(</span><span class="op" id="8376060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376064">if</span>&nbsp;<span class="ident" id="8376067">n</span>&nbsp;<span class="op" id="8376069">&lt;=</span>&nbsp;<span class="ident" id="8376072">want</span>&nbsp;<span class="op" id="8376077">||</span>&nbsp;<span class="ident" id="8376080">time</span><span class="op" id="8376084">.</span><span class="ident" id="8376085">Now</span><span class="op" id="8376088">(</span><span class="op" id="8376089">)</span><span class="op" id="8376090">.</span><span class="ident" id="8376091">After</span><span class="op" id="8376096">(</span><span class="ident" id="8376097">deadline</span><span class="op" id="8376105">)</span>&nbsp;<span class="op" id="8376107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376112">return</span>&nbsp;<span class="ident" id="8376119">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8376123">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376127">time</span><span class="op" id="8376131">.</span><span class="ident" id="8376132">Sleep</span><span class="op" id="8376137">(</span><span class="num" id="8376138">50</span>&nbsp;<span class="op" id="8376141">*</span>&nbsp;<span class="ident" id="8376143">time</span><span class="op" id="8376147">.</span><span class="ident" id="8376148">Millisecond</span><span class="op" id="8376159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8376162">}</span><br>
<span class="lineno"></span><span class="op" id="8376164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8376167">func</span>&nbsp;<span class="op" id="8376172">(</span><span class="ident" id="8376173">db</span>&nbsp;<span class="op" id="8376176">*</span><span class="ident" id="8376177">DB</span><span class="op" id="8376179">)</span>&nbsp;<span class="ident" id="8376181">numFreeConns</span><span class="op" id="8376193">(</span><span class="op" id="8376194">)</span>&nbsp;<span class="builtintype" id="8376196">int</span>&nbsp;<span class="op" id="8376200">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376203">db</span><span class="op" id="8376205">.</span><span class="ident" id="8376206">mu</span><span class="op" id="8376208">.</span><span class="ident" id="8376209">Lock</span><span class="op" id="8376213">(</span><span class="op" id="8376214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376217">defer</span>&nbsp;<span class="ident" id="8376223">db</span><span class="op" id="8376225">.</span><span class="ident" id="8376226">mu</span><span class="op" id="8376228">.</span><span class="ident" id="8376229">Unlock</span><span class="op" id="8376235">(</span><span class="op" id="8376236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376239">return</span>&nbsp;<span class="builtinfunc" id="8376246">len</span><span class="op" id="8376249">(</span><span class="ident" id="8376250">db</span><span class="op" id="8376252">.</span><span class="ident" id="8376253">freeConn</span><span class="op" id="8376261">)</span><br>
<span class="lineno"></span><span class="op" id="8376263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="8376266">func</span>&nbsp;<span class="op" id="8376271">(</span><span class="ident" id="8376272">db</span>&nbsp;<span class="op" id="8376275">*</span><span class="ident" id="8376276">DB</span><span class="op" id="8376278">)</span>&nbsp;<span class="ident" id="8376280">dumpDeps</span><span class="op" id="8376288">(</span><span class="ident" id="8376289">t</span>&nbsp;<span class="op" id="8376291">*</span><span class="ident" id="8376292">testing</span><span class="op" id="8376299">.</span><span class="ident" id="8376300">T</span><span class="op" id="8376301">)</span>&nbsp;<span class="op" id="8376303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376306">for</span>&nbsp;<span class="ident" id="8376310">fc</span>&nbsp;<span class="op" id="8376313">:=</span>&nbsp;<span class="keyword" id="8376316">range</span>&nbsp;<span class="ident" id="8376322">db</span><span class="op" id="8376324">.</span><span class="ident" id="8376325">dep</span>&nbsp;<span class="op" id="8376329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376333">db</span><span class="op" id="8376335">.</span><span class="ident" id="8376336">dumpDep</span><span class="op" id="8376343">(</span><span class="ident" id="8376344">t</span><span class="op" id="8376345">,</span>&nbsp;<span class="num" id="8376347">0</span><span class="op" id="8376348">,</span>&nbsp;<span class="ident" id="8376350">fc</span><span class="op" id="8376352">,</span>&nbsp;<span class="keyword" id="8376354">map</span><span class="op" id="8376357">[</span><span class="ident" id="8376358">finalCloser</span><span class="op" id="8376369">]</span><span class="builtintype" id="8376370">bool</span><span class="op" id="8376374">{</span><span class="op" id="8376375">}</span><span class="op" id="8376376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8376379">}</span><br>
<span class="lineno"></span><span class="op" id="8376381">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="8376384">func</span>&nbsp;<span class="op" id="8376389">(</span><span class="ident" id="8376390">db</span>&nbsp;<span class="op" id="8376393">*</span><span class="ident" id="8376394">DB</span><span class="op" id="8376396">)</span>&nbsp;<span class="ident" id="8376398">dumpDep</span><span class="op" id="8376405">(</span><span class="ident" id="8376406">t</span>&nbsp;<span class="op" id="8376408">*</span><span class="ident" id="8376409">testing</span><span class="op" id="8376416">.</span><span class="ident" id="8376417">T</span><span class="op" id="8376418">,</span>&nbsp;<span class="ident" id="8376420">depth</span>&nbsp;<span class="builtintype" id="8376426">int</span><span class="op" id="8376429">,</span>&nbsp;<span class="ident" id="8376431">dep</span>&nbsp;<span class="ident" id="8376435">finalCloser</span><span class="op" id="8376446">,</span>&nbsp;<span class="ident" id="8376448">seen</span>&nbsp;<span class="keyword" id="8376453">map</span><span class="op" id="8376456">[</span><span class="ident" id="8376457">finalCloser</span><span class="op" id="8376468">]</span><span class="builtintype" id="8376469">bool</span><span class="op" id="8376473">)</span>&nbsp;<span class="op" id="8376475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376478">seen</span><span class="op" id="8376482">[</span><span class="ident" id="8376483">dep</span><span class="op" id="8376486">]</span>&nbsp;<span class="op" id="8376488">=</span>&nbsp;<span class="builtintype" id="8376490">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376496">indent</span>&nbsp;<span class="op" id="8376503">:=</span>&nbsp;<span class="ident" id="8376506">strings</span><span class="op" id="8376513">.</span><span class="ident" id="8376514">Repeat</span><span class="op" id="8376520">(</span><span class="string" id="8376521">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="8376525">,</span>&nbsp;<span class="ident" id="8376527">depth</span><span class="op" id="8376532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376535">ds</span>&nbsp;<span class="op" id="8376538">:=</span>&nbsp;<span class="ident" id="8376541">db</span><span class="op" id="8376543">.</span><span class="ident" id="8376544">dep</span><span class="op" id="8376547">[</span><span class="ident" id="8376548">dep</span><span class="op" id="8376551">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376554">for</span>&nbsp;<span class="ident" id="8376558">k</span>&nbsp;<span class="op" id="8376560">:=</span>&nbsp;<span class="keyword" id="8376563">range</span>&nbsp;<span class="ident" id="8376569">ds</span>&nbsp;<span class="op" id="8376572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376576">t</span><span class="op" id="8376577">.</span><span class="ident" id="8376578">Logf</span><span class="op" id="8376582">(</span><span class="string" id="8376583">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="8376617">,</span>&nbsp;<span class="ident" id="8376619">indent</span><span class="op" id="8376625">,</span>&nbsp;<span class="ident" id="8376627">dep</span><span class="op" id="8376630">,</span>&nbsp;<span class="ident" id="8376632">dep</span><span class="op" id="8376635">,</span>&nbsp;<span class="ident" id="8376637">k</span><span class="op" id="8376638">,</span>&nbsp;<span class="ident" id="8376640">k</span><span class="op" id="8376641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376645">if</span>&nbsp;<span class="ident" id="8376648">fc</span><span class="op" id="8376650">,</span>&nbsp;<span class="ident" id="8376652">ok</span>&nbsp;<span class="op" id="8376655">:=</span>&nbsp;<span class="ident" id="8376658">k</span><span class="op" id="8376659">.</span><span class="op" id="8376660">(</span><span class="ident" id="8376661">finalCloser</span><span class="op" id="8376672">)</span><span class="op" id="8376673">;</span>&nbsp;<span class="ident" id="8376675">ok</span>&nbsp;<span class="op" id="8376678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376683">if</span>&nbsp;<span class="op" id="8376686">!</span><span class="ident" id="8376687">seen</span><span class="op" id="8376691">[</span><span class="ident" id="8376692">fc</span><span class="op" id="8376694">]</span>&nbsp;<span class="op" id="8376696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376702">db</span><span class="op" id="8376704">.</span><span class="ident" id="8376705">dumpDep</span><span class="op" id="8376712">(</span><span class="ident" id="8376713">t</span><span class="op" id="8376714">,</span>&nbsp;<span class="ident" id="8376716">depth</span><span class="op" id="8376721">+</span><span class="num" id="8376722">1</span><span class="op" id="8376723">,</span>&nbsp;<span class="ident" id="8376725">fc</span><span class="op" id="8376727">,</span>&nbsp;<span class="ident" id="8376729">seen</span><span class="op" id="8376733">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8376738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8376742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8376745">}</span><br>
<span class="lineno"></span><span class="op" id="8376747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8376750">func</span>&nbsp;<span class="ident" id="8376755">TestQuery</span><span class="op" id="8376764">(</span><span class="ident" id="8376765">t</span>&nbsp;<span class="op" id="8376767">*</span><span class="ident" id="8376768">testing</span><span class="op" id="8376775">.</span><span class="ident" id="8376776">T</span><span class="op" id="8376777">)</span>&nbsp;<span class="op" id="8376779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376782">db</span>&nbsp;<span class="op" id="8376785">:=</span>&nbsp;<span class="ident" id="8376788">newTestDB</span><span class="op" id="8376797">(</span><span class="ident" id="8376798">t</span><span class="op" id="8376799">,</span>&nbsp;<span class="string" id="8376801">&#34;people&#34;</span><span class="op" id="8376809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376812">defer</span>&nbsp;<span class="ident" id="8376818">closeDB</span><span class="op" id="8376825">(</span><span class="ident" id="8376826">t</span><span class="op" id="8376827">,</span>&nbsp;<span class="ident" id="8376829">db</span><span class="op" id="8376831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376834">prepares0</span>&nbsp;<span class="op" id="8376844">:=</span>&nbsp;<span class="ident" id="8376847">numPrepares</span><span class="op" id="8376858">(</span><span class="ident" id="8376859">t</span><span class="op" id="8376860">,</span>&nbsp;<span class="ident" id="8376862">db</span><span class="op" id="8376864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376867">rows</span><span class="op" id="8376871">,</span>&nbsp;<span class="ident" id="8376873">err</span>&nbsp;<span class="op" id="8376877">:=</span>&nbsp;<span class="ident" id="8376880">db</span><span class="op" id="8376882">.</span><span class="ident" id="8376883">Query</span><span class="op" id="8376888">(</span><span class="string" id="8376889">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8376914">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376917">if</span>&nbsp;<span class="ident" id="8376920">err</span>&nbsp;<span class="op" id="8376924">!=</span>&nbsp;<span class="builtintype" id="8376927">nil</span>&nbsp;<span class="op" id="8376931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376935">t</span><span class="op" id="8376936">.</span><span class="ident" id="8376937">Fatalf</span><span class="op" id="8376943">(</span><span class="string" id="8376944">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8376955">,</span>&nbsp;<span class="ident" id="8376957">err</span><span class="op" id="8376960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8376963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8376966">type</span>&nbsp;<span class="ident" id="8376971">row</span>&nbsp;<span class="keyword" id="8376975">struct</span>&nbsp;<span class="op" id="8376982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376986">age</span>&nbsp;&nbsp;<span class="builtintype" id="8376991">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8376997">name</span>&nbsp;<span class="builtintype" id="8377002">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377013">got</span>&nbsp;<span class="op" id="8377017">:=</span>&nbsp;<span class="op" id="8377020">[</span><span class="op" id="8377021">]</span><span class="ident" id="8377022">row</span><span class="op" id="8377025">{</span><span class="op" id="8377026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377029">for</span>&nbsp;<span class="ident" id="8377033">rows</span><span class="op" id="8377037">.</span><span class="ident" id="8377038">Next</span><span class="op" id="8377042">(</span><span class="op" id="8377043">)</span>&nbsp;<span class="op" id="8377045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377049">var</span>&nbsp;<span class="ident" id="8377053">r</span>&nbsp;<span class="ident" id="8377055">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377061">err</span>&nbsp;<span class="op" id="8377065">=</span>&nbsp;<span class="ident" id="8377067">rows</span><span class="op" id="8377071">.</span><span class="ident" id="8377072">Scan</span><span class="op" id="8377076">(</span><span class="op" id="8377077">&amp;</span><span class="ident" id="8377078">r</span><span class="op" id="8377079">.</span><span class="ident" id="8377080">age</span><span class="op" id="8377083">,</span>&nbsp;<span class="op" id="8377085">&amp;</span><span class="ident" id="8377086">r</span><span class="op" id="8377087">.</span><span class="ident" id="8377088">name</span><span class="op" id="8377092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377096">if</span>&nbsp;<span class="ident" id="8377099">err</span>&nbsp;<span class="op" id="8377103">!=</span>&nbsp;<span class="builtintype" id="8377106">nil</span>&nbsp;<span class="op" id="8377110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377115">t</span><span class="op" id="8377116">.</span><span class="ident" id="8377117">Fatalf</span><span class="op" id="8377123">(</span><span class="string" id="8377124">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="8377134">,</span>&nbsp;<span class="ident" id="8377136">err</span><span class="op" id="8377139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377147">got</span>&nbsp;<span class="op" id="8377151">=</span>&nbsp;<span class="builtinfunc" id="8377153">append</span><span class="op" id="8377159">(</span><span class="ident" id="8377160">got</span><span class="op" id="8377163">,</span>&nbsp;<span class="ident" id="8377165">r</span><span class="op" id="8377166">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377172">err</span>&nbsp;<span class="op" id="8377176">=</span>&nbsp;<span class="ident" id="8377178">rows</span><span class="op" id="8377182">.</span><span class="ident" id="8377183">Err</span><span class="op" id="8377186">(</span><span class="op" id="8377187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377190">if</span>&nbsp;<span class="ident" id="8377193">err</span>&nbsp;<span class="op" id="8377197">!=</span>&nbsp;<span class="builtintype" id="8377200">nil</span>&nbsp;<span class="op" id="8377204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377208">t</span><span class="op" id="8377209">.</span><span class="ident" id="8377210">Fatalf</span><span class="op" id="8377216">(</span><span class="string" id="8377217">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="8377226">,</span>&nbsp;<span class="ident" id="8377228">err</span><span class="op" id="8377231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377234">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377237">want</span>&nbsp;<span class="op" id="8377242">:=</span>&nbsp;<span class="op" id="8377245">[</span><span class="op" id="8377246">]</span><span class="ident" id="8377247">row</span><span class="op" id="8377250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377254">{</span><span class="ident" id="8377255">age</span><span class="op" id="8377258">:</span>&nbsp;<span class="num" id="8377260">1</span><span class="op" id="8377261">,</span>&nbsp;<span class="ident" id="8377263">name</span><span class="op" id="8377267">:</span>&nbsp;<span class="string" id="8377269">&#34;Alice&#34;</span><span class="op" id="8377276">}</span><span class="op" id="8377277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377281">{</span><span class="ident" id="8377282">age</span><span class="op" id="8377285">:</span>&nbsp;<span class="num" id="8377287">2</span><span class="op" id="8377288">,</span>&nbsp;<span class="ident" id="8377290">name</span><span class="op" id="8377294">:</span>&nbsp;<span class="string" id="8377296">&#34;Bob&#34;</span><span class="op" id="8377301">}</span><span class="op" id="8377302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377306">{</span><span class="ident" id="8377307">age</span><span class="op" id="8377310">:</span>&nbsp;<span class="num" id="8377312">3</span><span class="op" id="8377313">,</span>&nbsp;<span class="ident" id="8377315">name</span><span class="op" id="8377319">:</span>&nbsp;<span class="string" id="8377321">&#34;Chris&#34;</span><span class="op" id="8377328">}</span><span class="op" id="8377329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377332">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377335">if</span>&nbsp;<span class="op" id="8377338">!</span><span class="ident" id="8377339">reflect</span><span class="op" id="8377346">.</span><span class="ident" id="8377347">DeepEqual</span><span class="op" id="8377356">(</span><span class="ident" id="8377357">got</span><span class="op" id="8377360">,</span>&nbsp;<span class="ident" id="8377362">want</span><span class="op" id="8377366">)</span>&nbsp;<span class="op" id="8377368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377372">t</span><span class="op" id="8377373">.</span><span class="ident" id="8377374">Errorf</span><span class="op" id="8377380">(</span><span class="string" id="8377381">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="8377414">,</span>&nbsp;<span class="ident" id="8377416">got</span><span class="op" id="8377419">,</span>&nbsp;<span class="ident" id="8377421">want</span><span class="op" id="8377425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8377432">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8377495">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377532">if</span>&nbsp;<span class="ident" id="8377535">n</span>&nbsp;<span class="op" id="8377537">:=</span>&nbsp;<span class="ident" id="8377540">db</span><span class="op" id="8377542">.</span><span class="ident" id="8377543">numFreeConns</span><span class="op" id="8377555">(</span><span class="op" id="8377556">)</span><span class="op" id="8377557">;</span>&nbsp;<span class="ident" id="8377559">n</span>&nbsp;<span class="op" id="8377561">!=</span>&nbsp;<span class="num" id="8377564">1</span>&nbsp;<span class="op" id="8377566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377570">t</span><span class="op" id="8377571">.</span><span class="ident" id="8377572">Fatalf</span><span class="op" id="8377578">(</span><span class="string" id="8377579">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8377628">,</span>&nbsp;<span class="ident" id="8377630">n</span><span class="op" id="8377631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377637">if</span>&nbsp;<span class="ident" id="8377640">prepares</span>&nbsp;<span class="op" id="8377649">:=</span>&nbsp;<span class="ident" id="8377652">numPrepares</span><span class="op" id="8377663">(</span><span class="ident" id="8377664">t</span><span class="op" id="8377665">,</span>&nbsp;<span class="ident" id="8377667">db</span><span class="op" id="8377669">)</span>&nbsp;<span class="op" id="8377671">-</span>&nbsp;<span class="ident" id="8377673">prepares0</span><span class="op" id="8377682">;</span>&nbsp;<span class="ident" id="8377684">prepares</span>&nbsp;<span class="op" id="8377693">!=</span>&nbsp;<span class="num" id="8377696">1</span>&nbsp;<span class="op" id="8377698">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377702">t</span><span class="op" id="8377703">.</span><span class="ident" id="8377704">Errorf</span><span class="op" id="8377710">(</span><span class="string" id="8377711">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8377751">,</span>&nbsp;<span class="ident" id="8377753">prepares</span><span class="op" id="8377761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377764">}</span><br>
<span class="lineno"></span><span class="op" id="8377766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8377769">func</span>&nbsp;<span class="ident" id="8377774">TestByteOwnership</span><span class="op" id="8377791">(</span><span class="ident" id="8377792">t</span>&nbsp;<span class="op" id="8377794">*</span><span class="ident" id="8377795">testing</span><span class="op" id="8377802">.</span><span class="ident" id="8377803">T</span><span class="op" id="8377804">)</span>&nbsp;<span class="op" id="8377806">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377809">db</span>&nbsp;<span class="op" id="8377812">:=</span>&nbsp;<span class="ident" id="8377815">newTestDB</span><span class="op" id="8377824">(</span><span class="ident" id="8377825">t</span><span class="op" id="8377826">,</span>&nbsp;<span class="string" id="8377828">&#34;people&#34;</span><span class="op" id="8377836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377839">defer</span>&nbsp;<span class="ident" id="8377845">closeDB</span><span class="op" id="8377852">(</span><span class="ident" id="8377853">t</span><span class="op" id="8377854">,</span>&nbsp;<span class="ident" id="8377856">db</span><span class="op" id="8377858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377861">rows</span><span class="op" id="8377865">,</span>&nbsp;<span class="ident" id="8377867">err</span>&nbsp;<span class="op" id="8377871">:=</span>&nbsp;<span class="ident" id="8377874">db</span><span class="op" id="8377876">.</span><span class="ident" id="8377877">Query</span><span class="op" id="8377882">(</span><span class="string" id="8377883">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="8377910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377913">if</span>&nbsp;<span class="ident" id="8377916">err</span>&nbsp;<span class="op" id="8377920">!=</span>&nbsp;<span class="builtintype" id="8377923">nil</span>&nbsp;<span class="op" id="8377927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377931">t</span><span class="op" id="8377932">.</span><span class="ident" id="8377933">Fatalf</span><span class="op" id="8377939">(</span><span class="string" id="8377940">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8377951">,</span>&nbsp;<span class="ident" id="8377953">err</span><span class="op" id="8377956">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8377962">type</span>&nbsp;<span class="ident" id="8377967">row</span>&nbsp;<span class="keyword" id="8377971">struct</span>&nbsp;<span class="op" id="8377978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377982">name</span>&nbsp;&nbsp;<span class="op" id="8377988">[</span><span class="op" id="8377989">]</span><span class="builtintype" id="8377990">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8377997">photo</span>&nbsp;<span class="ident" id="8378003">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378013">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378016">got</span>&nbsp;<span class="op" id="8378020">:=</span>&nbsp;<span class="op" id="8378023">[</span><span class="op" id="8378024">]</span><span class="ident" id="8378025">row</span><span class="op" id="8378028">{</span><span class="op" id="8378029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378032">for</span>&nbsp;<span class="ident" id="8378036">rows</span><span class="op" id="8378040">.</span><span class="ident" id="8378041">Next</span><span class="op" id="8378045">(</span><span class="op" id="8378046">)</span>&nbsp;<span class="op" id="8378048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378052">var</span>&nbsp;<span class="ident" id="8378056">r</span>&nbsp;<span class="ident" id="8378058">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378064">err</span>&nbsp;<span class="op" id="8378068">=</span>&nbsp;<span class="ident" id="8378070">rows</span><span class="op" id="8378074">.</span><span class="ident" id="8378075">Scan</span><span class="op" id="8378079">(</span><span class="op" id="8378080">&amp;</span><span class="ident" id="8378081">r</span><span class="op" id="8378082">.</span><span class="ident" id="8378083">name</span><span class="op" id="8378087">,</span>&nbsp;<span class="op" id="8378089">&amp;</span><span class="ident" id="8378090">r</span><span class="op" id="8378091">.</span><span class="ident" id="8378092">photo</span><span class="op" id="8378097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378101">if</span>&nbsp;<span class="ident" id="8378104">err</span>&nbsp;<span class="op" id="8378108">!=</span>&nbsp;<span class="builtintype" id="8378111">nil</span>&nbsp;<span class="op" id="8378115">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378120">t</span><span class="op" id="8378121">.</span><span class="ident" id="8378122">Fatalf</span><span class="op" id="8378128">(</span><span class="string" id="8378129">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="8378139">,</span>&nbsp;<span class="ident" id="8378141">err</span><span class="op" id="8378144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378152">got</span>&nbsp;<span class="op" id="8378156">=</span>&nbsp;<span class="builtinfunc" id="8378158">append</span><span class="op" id="8378164">(</span><span class="ident" id="8378165">got</span><span class="op" id="8378168">,</span>&nbsp;<span class="ident" id="8378170">r</span><span class="op" id="8378171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378177">corruptMemory</span>&nbsp;<span class="op" id="8378191">:=</span>&nbsp;<span class="op" id="8378194">[</span><span class="op" id="8378195">]</span><span class="builtintype" id="8378196">byte</span><span class="op" id="8378200">(</span><span class="string" id="8378201">&#34;\xffPHOTO&#34;</span><span class="op" id="8378212">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378215">want</span>&nbsp;<span class="op" id="8378220">:=</span>&nbsp;<span class="op" id="8378223">[</span><span class="op" id="8378224">]</span><span class="ident" id="8378225">row</span><span class="op" id="8378228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378232">{</span><span class="ident" id="8378233">name</span><span class="op" id="8378237">:</span>&nbsp;<span class="op" id="8378239">[</span><span class="op" id="8378240">]</span><span class="builtintype" id="8378241">byte</span><span class="op" id="8378245">(</span><span class="string" id="8378246">&#34;Alice&#34;</span><span class="op" id="8378253">)</span><span class="op" id="8378254">,</span>&nbsp;<span class="ident" id="8378256">photo</span><span class="op" id="8378261">:</span>&nbsp;<span class="ident" id="8378263">corruptMemory</span><span class="op" id="8378276">}</span><span class="op" id="8378277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378281">{</span><span class="ident" id="8378282">name</span><span class="op" id="8378286">:</span>&nbsp;<span class="op" id="8378288">[</span><span class="op" id="8378289">]</span><span class="builtintype" id="8378290">byte</span><span class="op" id="8378294">(</span><span class="string" id="8378295">&#34;Bob&#34;</span><span class="op" id="8378300">)</span><span class="op" id="8378301">,</span>&nbsp;<span class="ident" id="8378303">photo</span><span class="op" id="8378308">:</span>&nbsp;<span class="ident" id="8378310">corruptMemory</span><span class="op" id="8378323">}</span><span class="op" id="8378324">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378328">{</span><span class="ident" id="8378329">name</span><span class="op" id="8378333">:</span>&nbsp;<span class="op" id="8378335">[</span><span class="op" id="8378336">]</span><span class="builtintype" id="8378337">byte</span><span class="op" id="8378341">(</span><span class="string" id="8378342">&#34;Chris&#34;</span><span class="op" id="8378349">)</span><span class="op" id="8378350">,</span>&nbsp;<span class="ident" id="8378352">photo</span><span class="op" id="8378357">:</span>&nbsp;<span class="ident" id="8378359">corruptMemory</span><span class="op" id="8378372">}</span><span class="op" id="8378373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378376">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378379">if</span>&nbsp;<span class="op" id="8378382">!</span><span class="ident" id="8378383">reflect</span><span class="op" id="8378390">.</span><span class="ident" id="8378391">DeepEqual</span><span class="op" id="8378400">(</span><span class="ident" id="8378401">got</span><span class="op" id="8378404">,</span>&nbsp;<span class="ident" id="8378406">want</span><span class="op" id="8378410">)</span>&nbsp;<span class="op" id="8378412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378416">t</span><span class="op" id="8378417">.</span><span class="ident" id="8378418">Errorf</span><span class="op" id="8378424">(</span><span class="string" id="8378425">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="8378458">,</span>&nbsp;<span class="ident" id="8378460">got</span><span class="op" id="8378463">,</span>&nbsp;<span class="ident" id="8378465">want</span><span class="op" id="8378469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378476">var</span>&nbsp;<span class="ident" id="8378480">photo</span>&nbsp;<span class="ident" id="8378486">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378496">err</span>&nbsp;<span class="op" id="8378500">=</span>&nbsp;<span class="ident" id="8378502">db</span><span class="op" id="8378504">.</span><span class="ident" id="8378505">QueryRow</span><span class="op" id="8378513">(</span><span class="string" id="8378514">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="8378542">,</span>&nbsp;<span class="string" id="8378544">&#34;Alice&#34;</span><span class="op" id="8378551">)</span><span class="op" id="8378552">.</span><span class="ident" id="8378553">Scan</span><span class="op" id="8378557">(</span><span class="op" id="8378558">&amp;</span><span class="ident" id="8378559">photo</span><span class="op" id="8378564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378567">if</span>&nbsp;<span class="ident" id="8378570">err</span>&nbsp;<span class="op" id="8378574">==</span>&nbsp;<span class="builtintype" id="8378577">nil</span>&nbsp;<span class="op" id="8378581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378585">t</span><span class="op" id="8378586">.</span><span class="ident" id="8378587">Error</span><span class="op" id="8378592">(</span><span class="string" id="8378593">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="8378642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378645">}</span><br>
<span class="lineno"></span><span class="op" id="8378647">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="8378650">func</span>&nbsp;<span class="ident" id="8378655">TestRowsColumns</span><span class="op" id="8378670">(</span><span class="ident" id="8378671">t</span>&nbsp;<span class="op" id="8378673">*</span><span class="ident" id="8378674">testing</span><span class="op" id="8378681">.</span><span class="ident" id="8378682">T</span><span class="op" id="8378683">)</span>&nbsp;<span class="op" id="8378685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378688">db</span>&nbsp;<span class="op" id="8378691">:=</span>&nbsp;<span class="ident" id="8378694">newTestDB</span><span class="op" id="8378703">(</span><span class="ident" id="8378704">t</span><span class="op" id="8378705">,</span>&nbsp;<span class="string" id="8378707">&#34;people&#34;</span><span class="op" id="8378715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378718">defer</span>&nbsp;<span class="ident" id="8378724">closeDB</span><span class="op" id="8378731">(</span><span class="ident" id="8378732">t</span><span class="op" id="8378733">,</span>&nbsp;<span class="ident" id="8378735">db</span><span class="op" id="8378737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378740">rows</span><span class="op" id="8378744">,</span>&nbsp;<span class="ident" id="8378746">err</span>&nbsp;<span class="op" id="8378750">:=</span>&nbsp;<span class="ident" id="8378753">db</span><span class="op" id="8378755">.</span><span class="ident" id="8378756">Query</span><span class="op" id="8378761">(</span><span class="string" id="8378762">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8378787">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378790">if</span>&nbsp;<span class="ident" id="8378793">err</span>&nbsp;<span class="op" id="8378797">!=</span>&nbsp;<span class="builtintype" id="8378800">nil</span>&nbsp;<span class="op" id="8378804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378808">t</span><span class="op" id="8378809">.</span><span class="ident" id="8378810">Fatalf</span><span class="op" id="8378816">(</span><span class="string" id="8378817">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8378828">,</span>&nbsp;<span class="ident" id="8378830">err</span><span class="op" id="8378833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378839">cols</span><span class="op" id="8378843">,</span>&nbsp;<span class="ident" id="8378845">err</span>&nbsp;<span class="op" id="8378849">:=</span>&nbsp;<span class="ident" id="8378852">rows</span><span class="op" id="8378856">.</span><span class="ident" id="8378857">Columns</span><span class="op" id="8378864">(</span><span class="op" id="8378865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378868">if</span>&nbsp;<span class="ident" id="8378871">err</span>&nbsp;<span class="op" id="8378875">!=</span>&nbsp;<span class="builtintype" id="8378878">nil</span>&nbsp;<span class="op" id="8378882">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378886">t</span><span class="op" id="8378887">.</span><span class="ident" id="8378888">Fatalf</span><span class="op" id="8378894">(</span><span class="string" id="8378895">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="8378908">,</span>&nbsp;<span class="ident" id="8378910">err</span><span class="op" id="8378913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8378916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378919">want</span>&nbsp;<span class="op" id="8378924">:=</span>&nbsp;<span class="op" id="8378927">[</span><span class="op" id="8378928">]</span><span class="builtintype" id="8378929">string</span><span class="op" id="8378935">{</span><span class="string" id="8378936">&#34;age&#34;</span><span class="op" id="8378941">,</span>&nbsp;<span class="string" id="8378943">&#34;name&#34;</span><span class="op" id="8378949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8378952">if</span>&nbsp;<span class="op" id="8378955">!</span><span class="ident" id="8378956">reflect</span><span class="op" id="8378963">.</span><span class="ident" id="8378964">DeepEqual</span><span class="op" id="8378973">(</span><span class="ident" id="8378974">cols</span><span class="op" id="8378978">,</span>&nbsp;<span class="ident" id="8378980">want</span><span class="op" id="8378984">)</span>&nbsp;<span class="op" id="8378986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8378990">t</span><span class="op" id="8378991">.</span><span class="ident" id="8378992">Errorf</span><span class="op" id="8378998">(</span><span class="string" id="8378999">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8379018">,</span>&nbsp;<span class="ident" id="8379020">cols</span><span class="op" id="8379024">,</span>&nbsp;<span class="ident" id="8379026">want</span><span class="op" id="8379030">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8379033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379036">if</span>&nbsp;<span class="ident" id="8379039">err</span>&nbsp;<span class="op" id="8379043">:=</span>&nbsp;<span class="ident" id="8379046">rows</span><span class="op" id="8379050">.</span><span class="ident" id="8379051">Close</span><span class="op" id="8379056">(</span><span class="op" id="8379057">)</span><span class="op" id="8379058">;</span>&nbsp;<span class="ident" id="8379060">err</span>&nbsp;<span class="op" id="8379064">!=</span>&nbsp;<span class="builtintype" id="8379067">nil</span>&nbsp;<span class="op" id="8379071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379075">t</span><span class="op" id="8379076">.</span><span class="ident" id="8379077">Errorf</span><span class="op" id="8379083">(</span><span class="string" id="8379084">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="8379108">,</span>&nbsp;<span class="ident" id="8379110">err</span><span class="op" id="8379113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8379116">}</span><br>
<span class="lineno"></span><span class="op" id="8379118">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="8379121">func</span>&nbsp;<span class="ident" id="8379126">TestQueryRow</span><span class="op" id="8379138">(</span><span class="ident" id="8379139">t</span>&nbsp;<span class="op" id="8379141">*</span><span class="ident" id="8379142">testing</span><span class="op" id="8379149">.</span><span class="ident" id="8379150">T</span><span class="op" id="8379151">)</span>&nbsp;<span class="op" id="8379153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379156">db</span>&nbsp;<span class="op" id="8379159">:=</span>&nbsp;<span class="ident" id="8379162">newTestDB</span><span class="op" id="8379171">(</span><span class="ident" id="8379172">t</span><span class="op" id="8379173">,</span>&nbsp;<span class="string" id="8379175">&#34;people&#34;</span><span class="op" id="8379183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379186">defer</span>&nbsp;<span class="ident" id="8379192">closeDB</span><span class="op" id="8379199">(</span><span class="ident" id="8379200">t</span><span class="op" id="8379201">,</span>&nbsp;<span class="ident" id="8379203">db</span><span class="op" id="8379205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379208">var</span>&nbsp;<span class="ident" id="8379212">name</span>&nbsp;<span class="builtintype" id="8379217">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379225">var</span>&nbsp;<span class="ident" id="8379229">age</span>&nbsp;<span class="builtintype" id="8379233">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379238">var</span>&nbsp;<span class="ident" id="8379242">birthday</span>&nbsp;<span class="ident" id="8379251">time</span><span class="op" id="8379255">.</span><span class="ident" id="8379256">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379263">err</span>&nbsp;<span class="op" id="8379267">:=</span>&nbsp;<span class="ident" id="8379270">db</span><span class="op" id="8379272">.</span><span class="ident" id="8379273">QueryRow</span><span class="op" id="8379281">(</span><span class="string" id="8379282">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8379312">,</span>&nbsp;<span class="num" id="8379314">3</span><span class="op" id="8379315">)</span><span class="op" id="8379316">.</span><span class="ident" id="8379317">Scan</span><span class="op" id="8379321">(</span><span class="op" id="8379322">&amp;</span><span class="ident" id="8379323">age</span><span class="op" id="8379326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379329">if</span>&nbsp;<span class="ident" id="8379332">err</span>&nbsp;<span class="op" id="8379336">==</span>&nbsp;<span class="builtintype" id="8379339">nil</span>&nbsp;<span class="op" id="8379343">||</span>&nbsp;<span class="op" id="8379346">!</span><span class="ident" id="8379347">strings</span><span class="op" id="8379354">.</span><span class="ident" id="8379355">Contains</span><span class="op" id="8379363">(</span><span class="ident" id="8379364">err</span><span class="op" id="8379367">.</span><span class="ident" id="8379368">Error</span><span class="op" id="8379373">(</span><span class="op" id="8379374">)</span><span class="op" id="8379375">,</span>&nbsp;<span class="string" id="8379377">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="8379411">)</span>&nbsp;<span class="op" id="8379413">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379417">t</span><span class="op" id="8379418">.</span><span class="ident" id="8379419">Errorf</span><span class="op" id="8379425">(</span><span class="string" id="8379426">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="8379491">,</span>&nbsp;<span class="ident" id="8379493">err</span><span class="op" id="8379496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8379499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379503">err</span>&nbsp;<span class="op" id="8379507">=</span>&nbsp;<span class="ident" id="8379509">db</span><span class="op" id="8379511">.</span><span class="ident" id="8379512">QueryRow</span><span class="op" id="8379520">(</span><span class="string" id="8379521">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="8379548">,</span>&nbsp;<span class="num" id="8379550">3</span><span class="op" id="8379551">)</span><span class="op" id="8379552">.</span><span class="ident" id="8379553">Scan</span><span class="op" id="8379557">(</span><span class="op" id="8379558">&amp;</span><span class="ident" id="8379559">birthday</span><span class="op" id="8379567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379570">if</span>&nbsp;<span class="ident" id="8379573">err</span>&nbsp;<span class="op" id="8379577">!=</span>&nbsp;<span class="builtintype" id="8379580">nil</span>&nbsp;<span class="op" id="8379584">||</span>&nbsp;<span class="op" id="8379587">!</span><span class="ident" id="8379588">birthday</span><span class="op" id="8379596">.</span><span class="ident" id="8379597">Equal</span><span class="op" id="8379602">(</span><span class="ident" id="8379603">chrisBirthday</span><span class="op" id="8379616">)</span>&nbsp;<span class="op" id="8379618">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379622">t</span><span class="op" id="8379623">.</span><span class="ident" id="8379624">Errorf</span><span class="op" id="8379630">(</span><span class="string" id="8379631">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8379671">,</span>&nbsp;<span class="ident" id="8379673">birthday</span><span class="op" id="8379681">,</span>&nbsp;<span class="ident" id="8379683">err</span><span class="op" id="8379686">,</span>&nbsp;<span class="ident" id="8379688">chrisBirthday</span><span class="op" id="8379701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8379704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379708">err</span>&nbsp;<span class="op" id="8379712">=</span>&nbsp;<span class="ident" id="8379714">db</span><span class="op" id="8379716">.</span><span class="ident" id="8379717">QueryRow</span><span class="op" id="8379725">(</span><span class="string" id="8379726">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8379756">,</span>&nbsp;<span class="num" id="8379758">2</span><span class="op" id="8379759">)</span><span class="op" id="8379760">.</span><span class="ident" id="8379761">Scan</span><span class="op" id="8379765">(</span><span class="op" id="8379766">&amp;</span><span class="ident" id="8379767">age</span><span class="op" id="8379770">,</span>&nbsp;<span class="op" id="8379772">&amp;</span><span class="ident" id="8379773">name</span><span class="op" id="8379777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379780">if</span>&nbsp;<span class="ident" id="8379783">err</span>&nbsp;<span class="op" id="8379787">!=</span>&nbsp;<span class="builtintype" id="8379790">nil</span>&nbsp;<span class="op" id="8379794">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379798">t</span><span class="op" id="8379799">.</span><span class="ident" id="8379800">Fatalf</span><span class="op" id="8379806">(</span><span class="string" id="8379807">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8379830">,</span>&nbsp;<span class="ident" id="8379832">err</span><span class="op" id="8379835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8379838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379841">if</span>&nbsp;<span class="ident" id="8379844">name</span>&nbsp;<span class="op" id="8379849">!=</span>&nbsp;<span class="string" id="8379852">&#34;Bob&#34;</span>&nbsp;<span class="op" id="8379858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379862">t</span><span class="op" id="8379863">.</span><span class="ident" id="8379864">Errorf</span><span class="op" id="8379870">(</span><span class="string" id="8379871">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8379898">,</span>&nbsp;<span class="ident" id="8379900">name</span><span class="op" id="8379904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8379907">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8379910">if</span>&nbsp;<span class="ident" id="8379913">age</span>&nbsp;<span class="op" id="8379917">!=</span>&nbsp;<span class="num" id="8379920">2</span>&nbsp;<span class="op" id="8379922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379926">t</span><span class="op" id="8379927">.</span><span class="ident" id="8379928">Errorf</span><span class="op" id="8379934">(</span><span class="string" id="8379935">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8379959">,</span>&nbsp;<span class="ident" id="8379961">age</span><span class="op" id="8379964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8379967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8379971">err</span>&nbsp;<span class="op" id="8379975">=</span>&nbsp;<span class="ident" id="8379977">db</span><span class="op" id="8379979">.</span><span class="ident" id="8379980">QueryRow</span><span class="op" id="8379988">(</span><span class="string" id="8379989">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="8380020">,</span>&nbsp;<span class="string" id="8380022">&#34;Alice&#34;</span><span class="op" id="8380029">)</span><span class="op" id="8380030">.</span><span class="ident" id="8380031">Scan</span><span class="op" id="8380035">(</span><span class="op" id="8380036">&amp;</span><span class="ident" id="8380037">age</span><span class="op" id="8380040">,</span>&nbsp;<span class="op" id="8380042">&amp;</span><span class="ident" id="8380043">name</span><span class="op" id="8380047">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380050">if</span>&nbsp;<span class="ident" id="8380053">err</span>&nbsp;<span class="op" id="8380057">!=</span>&nbsp;<span class="builtintype" id="8380060">nil</span>&nbsp;<span class="op" id="8380064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380068">t</span><span class="op" id="8380069">.</span><span class="ident" id="8380070">Fatalf</span><span class="op" id="8380076">(</span><span class="string" id="8380077">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8380101">,</span>&nbsp;<span class="ident" id="8380103">err</span><span class="op" id="8380106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8380109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380112">if</span>&nbsp;<span class="ident" id="8380115">name</span>&nbsp;<span class="op" id="8380120">!=</span>&nbsp;<span class="string" id="8380123">&#34;Alice&#34;</span>&nbsp;<span class="op" id="8380131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380135">t</span><span class="op" id="8380136">.</span><span class="ident" id="8380137">Errorf</span><span class="op" id="8380143">(</span><span class="string" id="8380144">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8380173">,</span>&nbsp;<span class="ident" id="8380175">name</span><span class="op" id="8380179">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8380182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380185">if</span>&nbsp;<span class="ident" id="8380188">age</span>&nbsp;<span class="op" id="8380192">!=</span>&nbsp;<span class="num" id="8380195">1</span>&nbsp;<span class="op" id="8380197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380201">t</span><span class="op" id="8380202">.</span><span class="ident" id="8380203">Errorf</span><span class="op" id="8380209">(</span><span class="string" id="8380210">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8380234">,</span>&nbsp;<span class="ident" id="8380236">age</span><span class="op" id="8380239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8380242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380246">var</span>&nbsp;<span class="ident" id="8380250">photo</span>&nbsp;<span class="op" id="8380256">[</span><span class="op" id="8380257">]</span><span class="builtintype" id="8380258">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380264">err</span>&nbsp;<span class="op" id="8380268">=</span>&nbsp;<span class="ident" id="8380270">db</span><span class="op" id="8380272">.</span><span class="ident" id="8380273">QueryRow</span><span class="op" id="8380281">(</span><span class="string" id="8380282">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="8380310">,</span>&nbsp;<span class="string" id="8380312">&#34;Alice&#34;</span><span class="op" id="8380319">)</span><span class="op" id="8380320">.</span><span class="ident" id="8380321">Scan</span><span class="op" id="8380325">(</span><span class="op" id="8380326">&amp;</span><span class="ident" id="8380327">photo</span><span class="op" id="8380332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380335">if</span>&nbsp;<span class="ident" id="8380338">err</span>&nbsp;<span class="op" id="8380342">!=</span>&nbsp;<span class="builtintype" id="8380345">nil</span>&nbsp;<span class="op" id="8380349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380353">t</span><span class="op" id="8380354">.</span><span class="ident" id="8380355">Fatalf</span><span class="op" id="8380361">(</span><span class="string" id="8380362">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8380387">,</span>&nbsp;<span class="ident" id="8380389">err</span><span class="op" id="8380392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8380395">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380398">want</span>&nbsp;<span class="op" id="8380403">:=</span>&nbsp;<span class="op" id="8380406">[</span><span class="op" id="8380407">]</span><span class="builtintype" id="8380408">byte</span><span class="op" id="8380412">(</span><span class="string" id="8380413">&#34;APHOTO&#34;</span><span class="op" id="8380421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380424">if</span>&nbsp;<span class="op" id="8380427">!</span><span class="ident" id="8380428">reflect</span><span class="op" id="8380435">.</span><span class="ident" id="8380436">DeepEqual</span><span class="op" id="8380445">(</span><span class="ident" id="8380446">photo</span><span class="op" id="8380451">,</span>&nbsp;<span class="ident" id="8380453">want</span><span class="op" id="8380457">)</span>&nbsp;<span class="op" id="8380459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380463">t</span><span class="op" id="8380464">.</span><span class="ident" id="8380465">Errorf</span><span class="op" id="8380471">(</span><span class="string" id="8380472">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8380493">,</span>&nbsp;<span class="ident" id="8380495">photo</span><span class="op" id="8380500">,</span>&nbsp;<span class="ident" id="8380502">want</span><span class="op" id="8380506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8380509">}</span><br>
<span class="lineno"></span><span class="op" id="8380511">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="8380514">func</span>&nbsp;<span class="ident" id="8380519">TestStatementErrorAfterClose</span><span class="op" id="8380547">(</span><span class="ident" id="8380548">t</span>&nbsp;<span class="op" id="8380550">*</span><span class="ident" id="8380551">testing</span><span class="op" id="8380558">.</span><span class="ident" id="8380559">T</span><span class="op" id="8380560">)</span>&nbsp;<span class="op" id="8380562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380565">db</span>&nbsp;<span class="op" id="8380568">:=</span>&nbsp;<span class="ident" id="8380571">newTestDB</span><span class="op" id="8380580">(</span><span class="ident" id="8380581">t</span><span class="op" id="8380582">,</span>&nbsp;<span class="string" id="8380584">&#34;people&#34;</span><span class="op" id="8380592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380595">defer</span>&nbsp;<span class="ident" id="8380601">closeDB</span><span class="op" id="8380608">(</span><span class="ident" id="8380609">t</span><span class="op" id="8380610">,</span>&nbsp;<span class="ident" id="8380612">db</span><span class="op" id="8380614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380617">stmt</span><span class="op" id="8380621">,</span>&nbsp;<span class="ident" id="8380623">err</span>&nbsp;<span class="op" id="8380627">:=</span>&nbsp;<span class="ident" id="8380630">db</span><span class="op" id="8380632">.</span><span class="ident" id="8380633">Prepare</span><span class="op" id="8380640">(</span><span class="string" id="8380641">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8380667">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380670">if</span>&nbsp;<span class="ident" id="8380673">err</span>&nbsp;<span class="op" id="8380677">!=</span>&nbsp;<span class="builtintype" id="8380680">nil</span>&nbsp;<span class="op" id="8380684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380688">t</span><span class="op" id="8380689">.</span><span class="ident" id="8380690">Fatalf</span><span class="op" id="8380696">(</span><span class="string" id="8380697">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8380710">,</span>&nbsp;<span class="ident" id="8380712">err</span><span class="op" id="8380715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8380718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380721">err</span>&nbsp;<span class="op" id="8380725">=</span>&nbsp;<span class="ident" id="8380727">stmt</span><span class="op" id="8380731">.</span><span class="ident" id="8380732">Close</span><span class="op" id="8380737">(</span><span class="op" id="8380738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380741">if</span>&nbsp;<span class="ident" id="8380744">err</span>&nbsp;<span class="op" id="8380748">!=</span>&nbsp;<span class="builtintype" id="8380751">nil</span>&nbsp;<span class="op" id="8380755">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380759">t</span><span class="op" id="8380760">.</span><span class="ident" id="8380761">Fatalf</span><span class="op" id="8380767">(</span><span class="string" id="8380768">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="8380779">,</span>&nbsp;<span class="ident" id="8380781">err</span><span class="op" id="8380784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8380787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380790">var</span>&nbsp;<span class="ident" id="8380794">name</span>&nbsp;<span class="builtintype" id="8380799">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380807">err</span>&nbsp;<span class="op" id="8380811">=</span>&nbsp;<span class="ident" id="8380813">stmt</span><span class="op" id="8380817">.</span><span class="ident" id="8380818">QueryRow</span><span class="op" id="8380826">(</span><span class="string" id="8380827">&#34;foo&#34;</span><span class="op" id="8380832">)</span><span class="op" id="8380833">.</span><span class="ident" id="8380834">Scan</span><span class="op" id="8380838">(</span><span class="op" id="8380839">&amp;</span><span class="ident" id="8380840">name</span><span class="op" id="8380844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8380847">if</span>&nbsp;<span class="ident" id="8380850">err</span>&nbsp;<span class="op" id="8380854">==</span>&nbsp;<span class="builtintype" id="8380857">nil</span>&nbsp;<span class="op" id="8380861">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380865">t</span><span class="op" id="8380866">.</span><span class="ident" id="8380867">Errorf</span><span class="op" id="8380873">(</span><span class="string" id="8380874">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="8380926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8380929">}</span><br>
<span class="lineno"></span><span class="op" id="8380931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8380934">func</span>&nbsp;<span class="ident" id="8380939">TestStatementQueryRow</span><span class="op" id="8380960">(</span><span class="ident" id="8380961">t</span>&nbsp;<span class="op" id="8380963">*</span><span class="ident" id="8380964">testing</span><span class="op" id="8380971">.</span><span class="ident" id="8380972">T</span><span class="op" id="8380973">)</span>&nbsp;<span class="op" id="8380975">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8380978">db</span>&nbsp;<span class="op" id="8380981">:=</span>&nbsp;<span class="ident" id="8380984">newTestDB</span><span class="op" id="8380993">(</span><span class="ident" id="8380994">t</span><span class="op" id="8380995">,</span>&nbsp;<span class="string" id="8380997">&#34;people&#34;</span><span class="op" id="8381005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381008">defer</span>&nbsp;<span class="ident" id="8381014">closeDB</span><span class="op" id="8381021">(</span><span class="ident" id="8381022">t</span><span class="op" id="8381023">,</span>&nbsp;<span class="ident" id="8381025">db</span><span class="op" id="8381027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381030">stmt</span><span class="op" id="8381034">,</span>&nbsp;<span class="ident" id="8381036">err</span>&nbsp;<span class="op" id="8381040">:=</span>&nbsp;<span class="ident" id="8381043">db</span><span class="op" id="8381045">.</span><span class="ident" id="8381046">Prepare</span><span class="op" id="8381053">(</span><span class="string" id="8381054">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8381080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381083">if</span>&nbsp;<span class="ident" id="8381086">err</span>&nbsp;<span class="op" id="8381090">!=</span>&nbsp;<span class="builtintype" id="8381093">nil</span>&nbsp;<span class="op" id="8381097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381101">t</span><span class="op" id="8381102">.</span><span class="ident" id="8381103">Fatalf</span><span class="op" id="8381109">(</span><span class="string" id="8381110">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8381123">,</span>&nbsp;<span class="ident" id="8381125">err</span><span class="op" id="8381128">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381134">defer</span>&nbsp;<span class="ident" id="8381140">stmt</span><span class="op" id="8381144">.</span><span class="ident" id="8381145">Close</span><span class="op" id="8381150">(</span><span class="op" id="8381151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381154">var</span>&nbsp;<span class="ident" id="8381158">age</span>&nbsp;<span class="builtintype" id="8381162">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381167">for</span>&nbsp;<span class="ident" id="8381171">n</span><span class="op" id="8381172">,</span>&nbsp;<span class="ident" id="8381174">tt</span>&nbsp;<span class="op" id="8381177">:=</span>&nbsp;<span class="keyword" id="8381180">range</span>&nbsp;<span class="op" id="8381186">[</span><span class="op" id="8381187">]</span><span class="keyword" id="8381188">struct</span>&nbsp;<span class="op" id="8381195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381199">name</span>&nbsp;<span class="builtintype" id="8381204">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381213">want</span>&nbsp;<span class="builtintype" id="8381218">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381223">}</span><span class="op" id="8381224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381228">{</span><span class="string" id="8381229">&#34;Alice&#34;</span><span class="op" id="8381236">,</span>&nbsp;<span class="num" id="8381238">1</span><span class="op" id="8381239">}</span><span class="op" id="8381240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381244">{</span><span class="string" id="8381245">&#34;Bob&#34;</span><span class="op" id="8381250">,</span>&nbsp;<span class="num" id="8381252">2</span><span class="op" id="8381253">}</span><span class="op" id="8381254">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381258">{</span><span class="string" id="8381259">&#34;Chris&#34;</span><span class="op" id="8381266">,</span>&nbsp;<span class="num" id="8381268">3</span><span class="op" id="8381269">}</span><span class="op" id="8381270">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381273">}</span>&nbsp;<span class="op" id="8381275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381279">if</span>&nbsp;<span class="ident" id="8381282">err</span>&nbsp;<span class="op" id="8381286">:=</span>&nbsp;<span class="ident" id="8381289">stmt</span><span class="op" id="8381293">.</span><span class="ident" id="8381294">QueryRow</span><span class="op" id="8381302">(</span><span class="ident" id="8381303">tt</span><span class="op" id="8381305">.</span><span class="ident" id="8381306">name</span><span class="op" id="8381310">)</span><span class="op" id="8381311">.</span><span class="ident" id="8381312">Scan</span><span class="op" id="8381316">(</span><span class="op" id="8381317">&amp;</span><span class="ident" id="8381318">age</span><span class="op" id="8381321">)</span><span class="op" id="8381322">;</span>&nbsp;<span class="ident" id="8381324">err</span>&nbsp;<span class="op" id="8381328">!=</span>&nbsp;<span class="builtintype" id="8381331">nil</span>&nbsp;<span class="op" id="8381335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381340">t</span><span class="op" id="8381341">.</span><span class="ident" id="8381342">Errorf</span><span class="op" id="8381348">(</span><span class="string" id="8381349">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="8381379">,</span>&nbsp;<span class="ident" id="8381381">n</span><span class="op" id="8381382">,</span>&nbsp;<span class="ident" id="8381384">tt</span><span class="op" id="8381386">.</span><span class="ident" id="8381387">name</span><span class="op" id="8381391">,</span>&nbsp;<span class="ident" id="8381393">err</span><span class="op" id="8381396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381400">}</span>&nbsp;<span class="keyword" id="8381402">else</span>&nbsp;<span class="keyword" id="8381407">if</span>&nbsp;<span class="ident" id="8381410">age</span>&nbsp;<span class="op" id="8381414">!=</span>&nbsp;<span class="ident" id="8381417">tt</span><span class="op" id="8381419">.</span><span class="ident" id="8381420">want</span>&nbsp;<span class="op" id="8381425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381430">t</span><span class="op" id="8381431">.</span><span class="ident" id="8381432">Errorf</span><span class="op" id="8381438">(</span><span class="string" id="8381439">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8381460">,</span>&nbsp;<span class="ident" id="8381462">n</span><span class="op" id="8381463">,</span>&nbsp;<span class="ident" id="8381465">age</span><span class="op" id="8381468">,</span>&nbsp;<span class="ident" id="8381470">tt</span><span class="op" id="8381472">.</span><span class="ident" id="8381473">want</span><span class="op" id="8381477">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381484">}</span><br>
<span class="lineno"></span><span class="op" id="8381486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8381489">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="8381514">func</span>&nbsp;<span class="ident" id="8381519">TestStatementQueryRowConcurrent</span><span class="op" id="8381550">(</span><span class="ident" id="8381551">t</span>&nbsp;<span class="op" id="8381553">*</span><span class="ident" id="8381554">testing</span><span class="op" id="8381561">.</span><span class="ident" id="8381562">T</span><span class="op" id="8381563">)</span>&nbsp;<span class="op" id="8381565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381568">db</span>&nbsp;<span class="op" id="8381571">:=</span>&nbsp;<span class="ident" id="8381574">newTestDB</span><span class="op" id="8381583">(</span><span class="ident" id="8381584">t</span><span class="op" id="8381585">,</span>&nbsp;<span class="string" id="8381587">&#34;people&#34;</span><span class="op" id="8381595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381598">defer</span>&nbsp;<span class="ident" id="8381604">closeDB</span><span class="op" id="8381611">(</span><span class="ident" id="8381612">t</span><span class="op" id="8381613">,</span>&nbsp;<span class="ident" id="8381615">db</span><span class="op" id="8381617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381620">stmt</span><span class="op" id="8381624">,</span>&nbsp;<span class="ident" id="8381626">err</span>&nbsp;<span class="op" id="8381630">:=</span>&nbsp;<span class="ident" id="8381633">db</span><span class="op" id="8381635">.</span><span class="ident" id="8381636">Prepare</span><span class="op" id="8381643">(</span><span class="string" id="8381644">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8381670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381673">if</span>&nbsp;<span class="ident" id="8381676">err</span>&nbsp;<span class="op" id="8381680">!=</span>&nbsp;<span class="builtintype" id="8381683">nil</span>&nbsp;<span class="op" id="8381687">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381691">t</span><span class="op" id="8381692">.</span><span class="ident" id="8381693">Fatalf</span><span class="op" id="8381699">(</span><span class="string" id="8381700">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8381713">,</span>&nbsp;<span class="ident" id="8381715">err</span><span class="op" id="8381718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381724">defer</span>&nbsp;<span class="ident" id="8381730">stmt</span><span class="op" id="8381734">.</span><span class="ident" id="8381735">Close</span><span class="op" id="8381740">(</span><span class="op" id="8381741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381745">const</span>&nbsp;<span class="ident" id="8381751">n</span>&nbsp;<span class="op" id="8381753">=</span>&nbsp;<span class="num" id="8381755">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381759">ch</span>&nbsp;<span class="op" id="8381762">:=</span>&nbsp;<span class="builtinfunc" id="8381765">make</span><span class="op" id="8381769">(</span><span class="keyword" id="8381770">chan</span>&nbsp;<span class="builtintype" id="8381775">error</span><span class="op" id="8381780">,</span>&nbsp;<span class="ident" id="8381782">n</span><span class="op" id="8381783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381786">for</span>&nbsp;<span class="ident" id="8381790">i</span>&nbsp;<span class="op" id="8381792">:=</span>&nbsp;<span class="num" id="8381795">0</span><span class="op" id="8381796">;</span>&nbsp;<span class="ident" id="8381798">i</span>&nbsp;<span class="op" id="8381800">&lt;</span>&nbsp;<span class="ident" id="8381802">n</span><span class="op" id="8381803">;</span>&nbsp;<span class="ident" id="8381805">i</span><span class="op" id="8381806">++</span>&nbsp;<span class="op" id="8381809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381813">go</span>&nbsp;<span class="keyword" id="8381816">func</span><span class="op" id="8381820">(</span><span class="op" id="8381821">)</span>&nbsp;<span class="op" id="8381823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381828">var</span>&nbsp;<span class="ident" id="8381832">age</span>&nbsp;<span class="builtintype" id="8381836">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381843">err</span>&nbsp;<span class="op" id="8381847">:=</span>&nbsp;<span class="ident" id="8381850">stmt</span><span class="op" id="8381854">.</span><span class="ident" id="8381855">QueryRow</span><span class="op" id="8381863">(</span><span class="string" id="8381864">&#34;Alice&#34;</span><span class="op" id="8381871">)</span><span class="op" id="8381872">.</span><span class="ident" id="8381873">Scan</span><span class="op" id="8381877">(</span><span class="op" id="8381878">&amp;</span><span class="ident" id="8381879">age</span><span class="op" id="8381882">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381887">if</span>&nbsp;<span class="ident" id="8381890">err</span>&nbsp;<span class="op" id="8381894">==</span>&nbsp;<span class="builtintype" id="8381897">nil</span>&nbsp;<span class="op" id="8381901">&amp;&amp;</span>&nbsp;<span class="ident" id="8381904">age</span>&nbsp;<span class="op" id="8381908">!=</span>&nbsp;<span class="num" id="8381911">1</span>&nbsp;<span class="op" id="8381913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381919">err</span>&nbsp;<span class="op" id="8381923">=</span>&nbsp;<span class="ident" id="8381925">fmt</span><span class="op" id="8381928">.</span><span class="ident" id="8381929">Errorf</span><span class="op" id="8381935">(</span><span class="string" id="8381936">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="8381955">,</span>&nbsp;<span class="ident" id="8381957">age</span><span class="op" id="8381960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8381970">ch</span>&nbsp;<span class="op" id="8381973">&lt;-</span>&nbsp;<span class="ident" id="8381976">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381982">}</span><span class="op" id="8381983">(</span><span class="op" id="8381984">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8381987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8381990">for</span>&nbsp;<span class="ident" id="8381994">i</span>&nbsp;<span class="op" id="8381996">:=</span>&nbsp;<span class="num" id="8381999">0</span><span class="op" id="8382000">;</span>&nbsp;<span class="ident" id="8382002">i</span>&nbsp;<span class="op" id="8382004">&lt;</span>&nbsp;<span class="ident" id="8382006">n</span><span class="op" id="8382007">;</span>&nbsp;<span class="ident" id="8382009">i</span><span class="op" id="8382010">++</span>&nbsp;<span class="op" id="8382013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8382017">if</span>&nbsp;<span class="ident" id="8382020">err</span>&nbsp;<span class="op" id="8382024">:=</span>&nbsp;<span class="op" id="8382027">&lt;-</span><span class="ident" id="8382029">ch</span><span class="op" id="8382031">;</span>&nbsp;<span class="ident" id="8382033">err</span>&nbsp;<span class="op" id="8382037">!=</span>&nbsp;<span class="builtintype" id="8382040">nil</span>&nbsp;<span class="op" id="8382044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382049">t</span><span class="op" id="8382050">.</span><span class="ident" id="8382051">Error</span><span class="op" id="8382056">(</span><span class="ident" id="8382057">err</span><span class="op" id="8382060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382064">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382067">}</span><br>
<span class="lineno"></span><span class="op" id="8382069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8382072">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="8382104">func</span>&nbsp;<span class="ident" id="8382109">TestBogusPreboundParameters</span><span class="op" id="8382136">(</span><span class="ident" id="8382137">t</span>&nbsp;<span class="op" id="8382139">*</span><span class="ident" id="8382140">testing</span><span class="op" id="8382147">.</span><span class="ident" id="8382148">T</span><span class="op" id="8382149">)</span>&nbsp;<span class="op" id="8382151">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382154">db</span>&nbsp;<span class="op" id="8382157">:=</span>&nbsp;<span class="ident" id="8382160">newTestDB</span><span class="op" id="8382169">(</span><span class="ident" id="8382170">t</span><span class="op" id="8382171">,</span>&nbsp;<span class="string" id="8382173">&#34;foo&#34;</span><span class="op" id="8382178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8382181">defer</span>&nbsp;<span class="ident" id="8382187">closeDB</span><span class="op" id="8382194">(</span><span class="ident" id="8382195">t</span><span class="op" id="8382196">,</span>&nbsp;<span class="ident" id="8382198">db</span><span class="op" id="8382200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382203">exec</span><span class="op" id="8382207">(</span><span class="ident" id="8382208">t</span><span class="op" id="8382209">,</span>&nbsp;<span class="ident" id="8382211">db</span><span class="op" id="8382213">,</span>&nbsp;<span class="string" id="8382215">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8382258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382261">_</span><span class="op" id="8382262">,</span>&nbsp;<span class="ident" id="8382264">err</span>&nbsp;<span class="op" id="8382268">:=</span>&nbsp;<span class="ident" id="8382271">db</span><span class="op" id="8382273">.</span><span class="ident" id="8382274">Prepare</span><span class="op" id="8382281">(</span><span class="string" id="8382282">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="8382320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8382323">if</span>&nbsp;<span class="ident" id="8382326">err</span>&nbsp;<span class="op" id="8382330">==</span>&nbsp;<span class="builtintype" id="8382333">nil</span>&nbsp;<span class="op" id="8382337">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382341">t</span><span class="op" id="8382342">.</span><span class="ident" id="8382343">Fatalf</span><span class="op" id="8382349">(</span><span class="string" id="8382350">&#34;expected&nbsp;error&#34;</span><span class="op" id="8382366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8382372">if</span>&nbsp;<span class="ident" id="8382375">err</span><span class="op" id="8382378">.</span><span class="ident" id="8382379">Error</span><span class="op" id="8382384">(</span><span class="op" id="8382385">)</span>&nbsp;<span class="op" id="8382387">!=</span>&nbsp;<span class="string" id="8382390">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="8382451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382455">t</span><span class="op" id="8382456">.</span><span class="ident" id="8382457">Errorf</span><span class="op" id="8382463">(</span><span class="string" id="8382464">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8382486">,</span>&nbsp;<span class="ident" id="8382488">err</span><span class="op" id="8382491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382494">}</span><br>
<span class="lineno">400</span><span class="op" id="8382496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8382499">func</span>&nbsp;<span class="ident" id="8382504">TestExec</span><span class="op" id="8382512">(</span><span class="ident" id="8382513">t</span>&nbsp;<span class="op" id="8382515">*</span><span class="ident" id="8382516">testing</span><span class="op" id="8382523">.</span><span class="ident" id="8382524">T</span><span class="op" id="8382525">)</span>&nbsp;<span class="op" id="8382527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382530">db</span>&nbsp;<span class="op" id="8382533">:=</span>&nbsp;<span class="ident" id="8382536">newTestDB</span><span class="op" id="8382545">(</span><span class="ident" id="8382546">t</span><span class="op" id="8382547">,</span>&nbsp;<span class="string" id="8382549">&#34;foo&#34;</span><span class="op" id="8382554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8382557">defer</span>&nbsp;<span class="ident" id="8382563">closeDB</span><span class="op" id="8382570">(</span><span class="ident" id="8382571">t</span><span class="op" id="8382572">,</span>&nbsp;<span class="ident" id="8382574">db</span><span class="op" id="8382576">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382579">exec</span><span class="op" id="8382583">(</span><span class="ident" id="8382584">t</span><span class="op" id="8382585">,</span>&nbsp;<span class="ident" id="8382587">db</span><span class="op" id="8382589">,</span>&nbsp;<span class="string" id="8382591">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8382634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382637">stmt</span><span class="op" id="8382641">,</span>&nbsp;<span class="ident" id="8382643">err</span>&nbsp;<span class="op" id="8382647">:=</span>&nbsp;<span class="ident" id="8382650">db</span><span class="op" id="8382652">.</span><span class="ident" id="8382653">Prepare</span><span class="op" id="8382660">(</span><span class="string" id="8382661">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8382685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8382688">if</span>&nbsp;<span class="ident" id="8382691">err</span>&nbsp;<span class="op" id="8382695">!=</span>&nbsp;<span class="builtintype" id="8382698">nil</span>&nbsp;<span class="op" id="8382702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382706">t</span><span class="op" id="8382707">.</span><span class="ident" id="8382708">Errorf</span><span class="op" id="8382714">(</span><span class="string" id="8382715">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8382735">,</span>&nbsp;<span class="ident" id="8382737">stmt</span><span class="op" id="8382741">,</span>&nbsp;<span class="ident" id="8382743">err</span><span class="op" id="8382746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382749">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8382752">defer</span>&nbsp;<span class="ident" id="8382758">stmt</span><span class="op" id="8382762">.</span><span class="ident" id="8382763">Close</span><span class="op" id="8382768">(</span><span class="op" id="8382769">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8382773">type</span>&nbsp;<span class="ident" id="8382778">execTest</span>&nbsp;<span class="keyword" id="8382787">struct</span>&nbsp;<span class="op" id="8382794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382798">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382806">[</span><span class="op" id="8382807">]</span><span class="keyword" id="8382808">interface</span><span class="op" id="8382817">{</span><span class="op" id="8382818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382822">wantErr</span>&nbsp;<span class="builtintype" id="8382830">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8382841">execTests</span>&nbsp;<span class="op" id="8382851">:=</span>&nbsp;<span class="op" id="8382854">[</span><span class="op" id="8382855">]</span><span class="ident" id="8382856">execTest</span><span class="op" id="8382864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8382868">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382879">{</span><span class="op" id="8382880">[</span><span class="op" id="8382881">]</span><span class="keyword" id="8382882">interface</span><span class="op" id="8382891">{</span><span class="op" id="8382892">}</span><span class="op" id="8382893">{</span><span class="string" id="8382894">&#34;Brad&#34;</span><span class="op" id="8382900">,</span>&nbsp;<span class="num" id="8382902">31</span><span class="op" id="8382904">}</span><span class="op" id="8382905">,</span>&nbsp;<span class="string" id="8382907">&#34;&#34;</span><span class="op" id="8382909">}</span><span class="op" id="8382910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382914">{</span><span class="op" id="8382915">[</span><span class="op" id="8382916">]</span><span class="keyword" id="8382917">interface</span><span class="op" id="8382926">{</span><span class="op" id="8382927">}</span><span class="op" id="8382928">{</span><span class="string" id="8382929">&#34;Brad&#34;</span><span class="op" id="8382935">,</span>&nbsp;<span class="builtintype" id="8382937">int64</span><span class="op" id="8382942">(</span><span class="num" id="8382943">31</span><span class="op" id="8382945">)</span><span class="op" id="8382946">}</span><span class="op" id="8382947">,</span>&nbsp;<span class="string" id="8382949">&#34;&#34;</span><span class="op" id="8382951">}</span><span class="op" id="8382952">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382956">{</span><span class="op" id="8382957">[</span><span class="op" id="8382958">]</span><span class="keyword" id="8382959">interface</span><span class="op" id="8382968">{</span><span class="op" id="8382969">}</span><span class="op" id="8382970">{</span><span class="string" id="8382971">&#34;Bob&#34;</span><span class="op" id="8382976">,</span>&nbsp;<span class="string" id="8382978">&#34;32&#34;</span><span class="op" id="8382982">}</span><span class="op" id="8382983">,</span>&nbsp;<span class="string" id="8382985">&#34;&#34;</span><span class="op" id="8382987">}</span><span class="op" id="8382988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8382992">{</span><span class="op" id="8382993">[</span><span class="op" id="8382994">]</span><span class="keyword" id="8382995">interface</span><span class="op" id="8383004">{</span><span class="op" id="8383005">}</span><span class="op" id="8383006">{</span><span class="num" id="8383007">7</span><span class="op" id="8383008">,</span>&nbsp;<span class="num" id="8383010">9</span><span class="op" id="8383011">}</span><span class="op" id="8383012">,</span>&nbsp;<span class="string" id="8383014">&#34;&#34;</span><span class="op" id="8383016">}</span><span class="op" id="8383017">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8383022">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383048">{</span><span class="op" id="8383049">[</span><span class="op" id="8383050">]</span><span class="keyword" id="8383051">interface</span><span class="op" id="8383060">{</span><span class="op" id="8383061">}</span><span class="op" id="8383062">{</span><span class="string" id="8383063">&#34;Brad&#34;</span><span class="op" id="8383069">,</span>&nbsp;<span class="builtintype" id="8383071">int64</span><span class="op" id="8383076">(</span><span class="num" id="8383077">0xFFFFFFFF</span><span class="op" id="8383087">)</span><span class="op" id="8383088">}</span><span class="op" id="8383089">,</span>&nbsp;<span class="string" id="8383091">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="8383173">}</span><span class="op" id="8383174">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383178">{</span><span class="op" id="8383179">[</span><span class="op" id="8383180">]</span><span class="keyword" id="8383181">interface</span><span class="op" id="8383190">{</span><span class="op" id="8383191">}</span><span class="op" id="8383192">{</span><span class="string" id="8383193">&#34;Brad&#34;</span><span class="op" id="8383199">,</span>&nbsp;<span class="string" id="8383201">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="8383215">}</span><span class="op" id="8383216">,</span>&nbsp;<span class="string" id="8383218">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="8383318">}</span><span class="op" id="8383319">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8383324">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383351">{</span><span class="op" id="8383352">[</span><span class="op" id="8383353">]</span><span class="keyword" id="8383354">interface</span><span class="op" id="8383363">{</span><span class="op" id="8383364">}</span><span class="op" id="8383365">{</span><span class="op" id="8383366">}</span><span class="op" id="8383367">,</span>&nbsp;<span class="string" id="8383369">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="8383403">}</span><span class="op" id="8383404">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383408">{</span><span class="op" id="8383409">[</span><span class="op" id="8383410">]</span><span class="keyword" id="8383411">interface</span><span class="op" id="8383420">{</span><span class="op" id="8383421">}</span><span class="op" id="8383422">{</span><span class="num" id="8383423">1</span><span class="op" id="8383424">,</span>&nbsp;<span class="num" id="8383426">2</span><span class="op" id="8383427">,</span>&nbsp;<span class="num" id="8383429">3</span><span class="op" id="8383430">}</span><span class="op" id="8383431">,</span>&nbsp;<span class="string" id="8383433">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="8383467">}</span><span class="op" id="8383468">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8383474">for</span>&nbsp;<span class="ident" id="8383478">n</span><span class="op" id="8383479">,</span>&nbsp;<span class="ident" id="8383481">et</span>&nbsp;<span class="op" id="8383484">:=</span>&nbsp;<span class="keyword" id="8383487">range</span>&nbsp;<span class="ident" id="8383493">execTests</span>&nbsp;<span class="op" id="8383503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383507">_</span><span class="op" id="8383508">,</span>&nbsp;<span class="ident" id="8383510">err</span>&nbsp;<span class="op" id="8383514">:=</span>&nbsp;<span class="ident" id="8383517">stmt</span><span class="op" id="8383521">.</span><span class="ident" id="8383522">Exec</span><span class="op" id="8383526">(</span><span class="ident" id="8383527">et</span><span class="op" id="8383529">.</span><span class="ident" id="8383530">args</span><span class="op" id="8383534">...</span><span class="op" id="8383537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383541">errStr</span>&nbsp;<span class="op" id="8383548">:=</span>&nbsp;<span class="string" id="8383551">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8383556">if</span>&nbsp;<span class="ident" id="8383559">err</span>&nbsp;<span class="op" id="8383563">!=</span>&nbsp;<span class="builtintype" id="8383566">nil</span>&nbsp;<span class="op" id="8383570">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383575">errStr</span>&nbsp;<span class="op" id="8383582">=</span>&nbsp;<span class="ident" id="8383584">err</span><span class="op" id="8383587">.</span><span class="ident" id="8383588">Error</span><span class="op" id="8383593">(</span><span class="op" id="8383594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8383602">if</span>&nbsp;<span class="ident" id="8383605">errStr</span>&nbsp;<span class="op" id="8383612">!=</span>&nbsp;<span class="ident" id="8383615">et</span><span class="op" id="8383617">.</span><span class="ident" id="8383618">wantErr</span>&nbsp;<span class="op" id="8383626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383631">t</span><span class="op" id="8383632">.</span><span class="ident" id="8383633">Errorf</span><span class="op" id="8383639">(</span><span class="string" id="8383640">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="8383695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383701">n</span><span class="op" id="8383702">,</span>&nbsp;<span class="ident" id="8383704">et</span><span class="op" id="8383706">.</span><span class="ident" id="8383707">args</span><span class="op" id="8383711">,</span>&nbsp;<span class="ident" id="8383713">errStr</span><span class="op" id="8383719">,</span>&nbsp;<span class="ident" id="8383721">et</span><span class="op" id="8383723">.</span><span class="ident" id="8383724">wantErr</span><span class="op" id="8383731">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383738">}</span><br>
<span class="lineno"></span><span class="op" id="8383740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8383743">func</span>&nbsp;<span class="ident" id="8383748">TestTxPrepare</span><span class="op" id="8383761">(</span><span class="ident" id="8383762">t</span>&nbsp;<span class="op" id="8383764">*</span><span class="ident" id="8383765">testing</span><span class="op" id="8383772">.</span><span class="ident" id="8383773">T</span><span class="op" id="8383774">)</span>&nbsp;<span class="op" id="8383776">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383779">db</span>&nbsp;<span class="op" id="8383782">:=</span>&nbsp;<span class="ident" id="8383785">newTestDB</span><span class="op" id="8383794">(</span><span class="ident" id="8383795">t</span><span class="op" id="8383796">,</span>&nbsp;<span class="string" id="8383798">&#34;&#34;</span><span class="op" id="8383800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8383803">defer</span>&nbsp;<span class="ident" id="8383809">closeDB</span><span class="op" id="8383816">(</span><span class="ident" id="8383817">t</span><span class="op" id="8383818">,</span>&nbsp;<span class="ident" id="8383820">db</span><span class="op" id="8383822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383825">exec</span><span class="op" id="8383829">(</span><span class="ident" id="8383830">t</span><span class="op" id="8383831">,</span>&nbsp;<span class="ident" id="8383833">db</span><span class="op" id="8383835">,</span>&nbsp;<span class="string" id="8383837">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8383880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383883">tx</span><span class="op" id="8383885">,</span>&nbsp;<span class="ident" id="8383887">err</span>&nbsp;<span class="op" id="8383891">:=</span>&nbsp;<span class="ident" id="8383894">db</span><span class="op" id="8383896">.</span><span class="ident" id="8383897">Begin</span><span class="op" id="8383902">(</span><span class="op" id="8383903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8383906">if</span>&nbsp;<span class="ident" id="8383909">err</span>&nbsp;<span class="op" id="8383913">!=</span>&nbsp;<span class="builtintype" id="8383916">nil</span>&nbsp;<span class="op" id="8383920">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383924">t</span><span class="op" id="8383925">.</span><span class="ident" id="8383926">Fatalf</span><span class="op" id="8383932">(</span><span class="string" id="8383933">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8383945">,</span>&nbsp;<span class="ident" id="8383947">err</span><span class="op" id="8383950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8383953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8383956">stmt</span><span class="op" id="8383960">,</span>&nbsp;<span class="ident" id="8383962">err</span>&nbsp;<span class="op" id="8383966">:=</span>&nbsp;<span class="ident" id="8383969">tx</span><span class="op" id="8383971">.</span><span class="ident" id="8383972">Prepare</span><span class="op" id="8383979">(</span><span class="string" id="8383980">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8384004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384007">if</span>&nbsp;<span class="ident" id="8384010">err</span>&nbsp;<span class="op" id="8384014">!=</span>&nbsp;<span class="builtintype" id="8384017">nil</span>&nbsp;<span class="op" id="8384021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384025">t</span><span class="op" id="8384026">.</span><span class="ident" id="8384027">Fatalf</span><span class="op" id="8384033">(</span><span class="string" id="8384034">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8384054">,</span>&nbsp;<span class="ident" id="8384056">stmt</span><span class="op" id="8384060">,</span>&nbsp;<span class="ident" id="8384062">err</span><span class="op" id="8384065">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384071">defer</span>&nbsp;<span class="ident" id="8384077">stmt</span><span class="op" id="8384081">.</span><span class="ident" id="8384082">Close</span><span class="op" id="8384087">(</span><span class="op" id="8384088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384091">_</span><span class="op" id="8384092">,</span>&nbsp;<span class="ident" id="8384094">err</span>&nbsp;<span class="op" id="8384098">=</span>&nbsp;<span class="ident" id="8384100">stmt</span><span class="op" id="8384104">.</span><span class="ident" id="8384105">Exec</span><span class="op" id="8384109">(</span><span class="string" id="8384110">&#34;Bobby&#34;</span><span class="op" id="8384117">,</span>&nbsp;<span class="num" id="8384119">7</span><span class="op" id="8384120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384123">if</span>&nbsp;<span class="ident" id="8384126">err</span>&nbsp;<span class="op" id="8384130">!=</span>&nbsp;<span class="builtintype" id="8384133">nil</span>&nbsp;<span class="op" id="8384137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384141">t</span><span class="op" id="8384142">.</span><span class="ident" id="8384143">Fatalf</span><span class="op" id="8384149">(</span><span class="string" id="8384150">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8384161">,</span>&nbsp;<span class="ident" id="8384163">err</span><span class="op" id="8384166">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384172">err</span>&nbsp;<span class="op" id="8384176">=</span>&nbsp;<span class="ident" id="8384178">tx</span><span class="op" id="8384180">.</span><span class="ident" id="8384181">Commit</span><span class="op" id="8384187">(</span><span class="op" id="8384188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384191">if</span>&nbsp;<span class="ident" id="8384194">err</span>&nbsp;<span class="op" id="8384198">!=</span>&nbsp;<span class="builtintype" id="8384201">nil</span>&nbsp;<span class="op" id="8384205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384209">t</span><span class="op" id="8384210">.</span><span class="ident" id="8384211">Fatalf</span><span class="op" id="8384217">(</span><span class="string" id="8384218">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8384231">,</span>&nbsp;<span class="ident" id="8384233">err</span><span class="op" id="8384236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384239">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8384242">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384288">if</span>&nbsp;<span class="op" id="8384291">!</span><span class="ident" id="8384292">stmt</span><span class="op" id="8384296">.</span><span class="ident" id="8384297">closed</span>&nbsp;<span class="op" id="8384304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384308">t</span><span class="op" id="8384309">.</span><span class="ident" id="8384310">Fatal</span><span class="op" id="8384315">(</span><span class="string" id="8384316">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="8384346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384349">}</span><br>
<span class="lineno"></span><span class="op" id="8384351">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="8384354">func</span>&nbsp;<span class="ident" id="8384359">TestTxStmt</span><span class="op" id="8384369">(</span><span class="ident" id="8384370">t</span>&nbsp;<span class="op" id="8384372">*</span><span class="ident" id="8384373">testing</span><span class="op" id="8384380">.</span><span class="ident" id="8384381">T</span><span class="op" id="8384382">)</span>&nbsp;<span class="op" id="8384384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384387">db</span>&nbsp;<span class="op" id="8384390">:=</span>&nbsp;<span class="ident" id="8384393">newTestDB</span><span class="op" id="8384402">(</span><span class="ident" id="8384403">t</span><span class="op" id="8384404">,</span>&nbsp;<span class="string" id="8384406">&#34;&#34;</span><span class="op" id="8384408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384411">defer</span>&nbsp;<span class="ident" id="8384417">closeDB</span><span class="op" id="8384424">(</span><span class="ident" id="8384425">t</span><span class="op" id="8384426">,</span>&nbsp;<span class="ident" id="8384428">db</span><span class="op" id="8384430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384433">exec</span><span class="op" id="8384437">(</span><span class="ident" id="8384438">t</span><span class="op" id="8384439">,</span>&nbsp;<span class="ident" id="8384441">db</span><span class="op" id="8384443">,</span>&nbsp;<span class="string" id="8384445">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8384488">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384491">stmt</span><span class="op" id="8384495">,</span>&nbsp;<span class="ident" id="8384497">err</span>&nbsp;<span class="op" id="8384501">:=</span>&nbsp;<span class="ident" id="8384504">db</span><span class="op" id="8384506">.</span><span class="ident" id="8384507">Prepare</span><span class="op" id="8384514">(</span><span class="string" id="8384515">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8384539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384542">if</span>&nbsp;<span class="ident" id="8384545">err</span>&nbsp;<span class="op" id="8384549">!=</span>&nbsp;<span class="builtintype" id="8384552">nil</span>&nbsp;<span class="op" id="8384556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384560">t</span><span class="op" id="8384561">.</span><span class="ident" id="8384562">Fatalf</span><span class="op" id="8384568">(</span><span class="string" id="8384569">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8384589">,</span>&nbsp;<span class="ident" id="8384591">stmt</span><span class="op" id="8384595">,</span>&nbsp;<span class="ident" id="8384597">err</span><span class="op" id="8384600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384606">defer</span>&nbsp;<span class="ident" id="8384612">stmt</span><span class="op" id="8384616">.</span><span class="ident" id="8384617">Close</span><span class="op" id="8384622">(</span><span class="op" id="8384623">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384626">tx</span><span class="op" id="8384628">,</span>&nbsp;<span class="ident" id="8384630">err</span>&nbsp;<span class="op" id="8384634">:=</span>&nbsp;<span class="ident" id="8384637">db</span><span class="op" id="8384639">.</span><span class="ident" id="8384640">Begin</span><span class="op" id="8384645">(</span><span class="op" id="8384646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384649">if</span>&nbsp;<span class="ident" id="8384652">err</span>&nbsp;<span class="op" id="8384656">!=</span>&nbsp;<span class="builtintype" id="8384659">nil</span>&nbsp;<span class="op" id="8384663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384667">t</span><span class="op" id="8384668">.</span><span class="ident" id="8384669">Fatalf</span><span class="op" id="8384675">(</span><span class="string" id="8384676">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8384688">,</span>&nbsp;<span class="ident" id="8384690">err</span><span class="op" id="8384693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384699">txs</span>&nbsp;<span class="op" id="8384703">:=</span>&nbsp;<span class="ident" id="8384706">tx</span><span class="op" id="8384708">.</span><span class="ident" id="8384709">Stmt</span><span class="op" id="8384713">(</span><span class="ident" id="8384714">stmt</span><span class="op" id="8384718">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384721">defer</span>&nbsp;<span class="ident" id="8384727">txs</span><span class="op" id="8384730">.</span><span class="ident" id="8384731">Close</span><span class="op" id="8384736">(</span><span class="op" id="8384737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384740">_</span><span class="op" id="8384741">,</span>&nbsp;<span class="ident" id="8384743">err</span>&nbsp;<span class="op" id="8384747">=</span>&nbsp;<span class="ident" id="8384749">txs</span><span class="op" id="8384752">.</span><span class="ident" id="8384753">Exec</span><span class="op" id="8384757">(</span><span class="string" id="8384758">&#34;Bobby&#34;</span><span class="op" id="8384765">,</span>&nbsp;<span class="num" id="8384767">7</span><span class="op" id="8384768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384771">if</span>&nbsp;<span class="ident" id="8384774">err</span>&nbsp;<span class="op" id="8384778">!=</span>&nbsp;<span class="builtintype" id="8384781">nil</span>&nbsp;<span class="op" id="8384785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384789">t</span><span class="op" id="8384790">.</span><span class="ident" id="8384791">Fatalf</span><span class="op" id="8384797">(</span><span class="string" id="8384798">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8384809">,</span>&nbsp;<span class="ident" id="8384811">err</span><span class="op" id="8384814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384817">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384820">err</span>&nbsp;<span class="op" id="8384824">=</span>&nbsp;<span class="ident" id="8384826">tx</span><span class="op" id="8384828">.</span><span class="ident" id="8384829">Commit</span><span class="op" id="8384835">(</span><span class="op" id="8384836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384839">if</span>&nbsp;<span class="ident" id="8384842">err</span>&nbsp;<span class="op" id="8384846">!=</span>&nbsp;<span class="builtintype" id="8384849">nil</span>&nbsp;<span class="op" id="8384853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384857">t</span><span class="op" id="8384858">.</span><span class="ident" id="8384859">Fatalf</span><span class="op" id="8384865">(</span><span class="string" id="8384866">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8384879">,</span>&nbsp;<span class="ident" id="8384881">err</span><span class="op" id="8384884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8384890">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8384936">if</span>&nbsp;<span class="op" id="8384939">!</span><span class="ident" id="8384940">txs</span><span class="op" id="8384943">.</span><span class="ident" id="8384944">closed</span>&nbsp;<span class="op" id="8384951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8384955">t</span><span class="op" id="8384956">.</span><span class="ident" id="8384957">Fatal</span><span class="op" id="8384962">(</span><span class="string" id="8384963">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="8384993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8384996">}</span><br>
<span class="lineno"></span><span class="op" id="8384998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="8385001">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="8385040">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="8385117">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="8385184">func</span>&nbsp;<span class="ident" id="8385189">TestTxQuery</span><span class="op" id="8385200">(</span><span class="ident" id="8385201">t</span>&nbsp;<span class="op" id="8385203">*</span><span class="ident" id="8385204">testing</span><span class="op" id="8385211">.</span><span class="ident" id="8385212">T</span><span class="op" id="8385213">)</span>&nbsp;<span class="op" id="8385215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385218">db</span>&nbsp;<span class="op" id="8385221">:=</span>&nbsp;<span class="ident" id="8385224">newTestDB</span><span class="op" id="8385233">(</span><span class="ident" id="8385234">t</span><span class="op" id="8385235">,</span>&nbsp;<span class="string" id="8385237">&#34;&#34;</span><span class="op" id="8385239">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385242">defer</span>&nbsp;<span class="ident" id="8385248">closeDB</span><span class="op" id="8385255">(</span><span class="ident" id="8385256">t</span><span class="op" id="8385257">,</span>&nbsp;<span class="ident" id="8385259">db</span><span class="op" id="8385261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385264">exec</span><span class="op" id="8385268">(</span><span class="ident" id="8385269">t</span><span class="op" id="8385270">,</span>&nbsp;<span class="ident" id="8385272">db</span><span class="op" id="8385274">,</span>&nbsp;<span class="string" id="8385276">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8385319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385322">exec</span><span class="op" id="8385326">(</span><span class="ident" id="8385327">t</span><span class="op" id="8385328">,</span>&nbsp;<span class="ident" id="8385330">db</span><span class="op" id="8385332">,</span>&nbsp;<span class="string" id="8385334">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="8385356">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385360">tx</span><span class="op" id="8385362">,</span>&nbsp;<span class="ident" id="8385364">err</span>&nbsp;<span class="op" id="8385368">:=</span>&nbsp;<span class="ident" id="8385371">db</span><span class="op" id="8385373">.</span><span class="ident" id="8385374">Begin</span><span class="op" id="8385379">(</span><span class="op" id="8385380">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385383">if</span>&nbsp;<span class="ident" id="8385386">err</span>&nbsp;<span class="op" id="8385390">!=</span>&nbsp;<span class="builtintype" id="8385393">nil</span>&nbsp;<span class="op" id="8385397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385401">t</span><span class="op" id="8385402">.</span><span class="ident" id="8385403">Fatal</span><span class="op" id="8385408">(</span><span class="ident" id="8385409">err</span><span class="op" id="8385412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8385415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385418">defer</span>&nbsp;<span class="ident" id="8385424">tx</span><span class="op" id="8385426">.</span><span class="ident" id="8385427">Rollback</span><span class="op" id="8385435">(</span><span class="op" id="8385436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385440">r</span><span class="op" id="8385441">,</span>&nbsp;<span class="ident" id="8385443">err</span>&nbsp;<span class="op" id="8385447">:=</span>&nbsp;<span class="ident" id="8385450">tx</span><span class="op" id="8385452">.</span><span class="ident" id="8385453">Query</span><span class="op" id="8385458">(</span><span class="string" id="8385459">&#34;SELECT|t1|name|&#34;</span><span class="op" id="8385476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385479">if</span>&nbsp;<span class="ident" id="8385482">err</span>&nbsp;<span class="op" id="8385486">!=</span>&nbsp;<span class="builtintype" id="8385489">nil</span>&nbsp;<span class="op" id="8385493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385497">t</span><span class="op" id="8385498">.</span><span class="ident" id="8385499">Fatal</span><span class="op" id="8385504">(</span><span class="ident" id="8385505">err</span><span class="op" id="8385508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8385511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385514">defer</span>&nbsp;<span class="ident" id="8385520">r</span><span class="op" id="8385521">.</span><span class="ident" id="8385522">Close</span><span class="op" id="8385527">(</span><span class="op" id="8385528">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385532">if</span>&nbsp;<span class="op" id="8385535">!</span><span class="ident" id="8385536">r</span><span class="op" id="8385537">.</span><span class="ident" id="8385538">Next</span><span class="op" id="8385542">(</span><span class="op" id="8385543">)</span>&nbsp;<span class="op" id="8385545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385549">if</span>&nbsp;<span class="ident" id="8385552">r</span><span class="op" id="8385553">.</span><span class="ident" id="8385554">Err</span><span class="op" id="8385557">(</span><span class="op" id="8385558">)</span>&nbsp;<span class="op" id="8385560">!=</span>&nbsp;<span class="builtintype" id="8385563">nil</span>&nbsp;<span class="op" id="8385567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385572">t</span><span class="op" id="8385573">.</span><span class="ident" id="8385574">Fatal</span><span class="op" id="8385579">(</span><span class="ident" id="8385580">r</span><span class="op" id="8385581">.</span><span class="ident" id="8385582">Err</span><span class="op" id="8385585">(</span><span class="op" id="8385586">)</span><span class="op" id="8385587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8385591">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385595">t</span><span class="op" id="8385596">.</span><span class="ident" id="8385597">Fatal</span><span class="op" id="8385602">(</span><span class="string" id="8385603">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="8385621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8385624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385628">var</span>&nbsp;<span class="ident" id="8385632">x</span>&nbsp;<span class="builtintype" id="8385634">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385642">err</span>&nbsp;<span class="op" id="8385646">=</span>&nbsp;<span class="ident" id="8385648">r</span><span class="op" id="8385649">.</span><span class="ident" id="8385650">Scan</span><span class="op" id="8385654">(</span><span class="op" id="8385655">&amp;</span><span class="ident" id="8385656">x</span><span class="op" id="8385657">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385660">if</span>&nbsp;<span class="ident" id="8385663">err</span>&nbsp;<span class="op" id="8385667">!=</span>&nbsp;<span class="builtintype" id="8385670">nil</span>&nbsp;<span class="op" id="8385674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385678">t</span><span class="op" id="8385679">.</span><span class="ident" id="8385680">Fatal</span><span class="op" id="8385685">(</span><span class="ident" id="8385686">err</span><span class="op" id="8385689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8385692">}</span><br>
<span class="lineno"></span><span class="op" id="8385694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="8385697">func</span>&nbsp;<span class="ident" id="8385702">TestTxQueryInvalid</span><span class="op" id="8385720">(</span><span class="ident" id="8385721">t</span>&nbsp;<span class="op" id="8385723">*</span><span class="ident" id="8385724">testing</span><span class="op" id="8385731">.</span><span class="ident" id="8385732">T</span><span class="op" id="8385733">)</span>&nbsp;<span class="op" id="8385735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385738">db</span>&nbsp;<span class="op" id="8385741">:=</span>&nbsp;<span class="ident" id="8385744">newTestDB</span><span class="op" id="8385753">(</span><span class="ident" id="8385754">t</span><span class="op" id="8385755">,</span>&nbsp;<span class="string" id="8385757">&#34;&#34;</span><span class="op" id="8385759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385762">defer</span>&nbsp;<span class="ident" id="8385768">closeDB</span><span class="op" id="8385775">(</span><span class="ident" id="8385776">t</span><span class="op" id="8385777">,</span>&nbsp;<span class="ident" id="8385779">db</span><span class="op" id="8385781">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385785">tx</span><span class="op" id="8385787">,</span>&nbsp;<span class="ident" id="8385789">err</span>&nbsp;<span class="op" id="8385793">:=</span>&nbsp;<span class="ident" id="8385796">db</span><span class="op" id="8385798">.</span><span class="ident" id="8385799">Begin</span><span class="op" id="8385804">(</span><span class="op" id="8385805">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385808">if</span>&nbsp;<span class="ident" id="8385811">err</span>&nbsp;<span class="op" id="8385815">!=</span>&nbsp;<span class="builtintype" id="8385818">nil</span>&nbsp;<span class="op" id="8385822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385826">t</span><span class="op" id="8385827">.</span><span class="ident" id="8385828">Fatal</span><span class="op" id="8385833">(</span><span class="ident" id="8385834">err</span><span class="op" id="8385837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8385840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385843">defer</span>&nbsp;<span class="ident" id="8385849">tx</span><span class="op" id="8385851">.</span><span class="ident" id="8385852">Rollback</span><span class="op" id="8385860">(</span><span class="op" id="8385861">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385865">_</span><span class="op" id="8385866">,</span>&nbsp;<span class="ident" id="8385868">err</span>&nbsp;<span class="op" id="8385872">=</span>&nbsp;<span class="ident" id="8385874">tx</span><span class="op" id="8385876">.</span><span class="ident" id="8385877">Query</span><span class="op" id="8385882">(</span><span class="string" id="8385883">&#34;SELECT|t1|name|&#34;</span><span class="op" id="8385900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8385903">if</span>&nbsp;<span class="ident" id="8385906">err</span>&nbsp;<span class="op" id="8385910">==</span>&nbsp;<span class="builtintype" id="8385913">nil</span>&nbsp;<span class="op" id="8385917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8385921">t</span><span class="op" id="8385922">.</span><span class="ident" id="8385923">Fatal</span><span class="op" id="8385928">(</span><span class="string" id="8385929">&#34;Error&nbsp;expected&#34;</span><span class="op" id="8385945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8385948">}</span><br>
<span class="lineno"></span><span class="op" id="8385950">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="8385953">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="8386016">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="8386051">func</span>&nbsp;<span class="ident" id="8386056">TestTxErrBadConn</span><span class="op" id="8386072">(</span><span class="ident" id="8386073">t</span>&nbsp;<span class="op" id="8386075">*</span><span class="ident" id="8386076">testing</span><span class="op" id="8386083">.</span><span class="ident" id="8386084">T</span><span class="op" id="8386085">)</span>&nbsp;<span class="op" id="8386087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386090">db</span><span class="op" id="8386092">,</span>&nbsp;<span class="ident" id="8386094">err</span>&nbsp;<span class="op" id="8386098">:=</span>&nbsp;<span class="ident" id="8386101">Open</span><span class="op" id="8386105">(</span><span class="string" id="8386106">&#34;test&#34;</span><span class="op" id="8386112">,</span>&nbsp;<span class="ident" id="8386114">fakeDBName</span><span class="op" id="8386124">+</span><span class="string" id="8386125">&#34;;badConn&#34;</span><span class="op" id="8386135">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386138">if</span>&nbsp;<span class="ident" id="8386141">err</span>&nbsp;<span class="op" id="8386145">!=</span>&nbsp;<span class="builtintype" id="8386148">nil</span>&nbsp;<span class="op" id="8386152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386156">t</span><span class="op" id="8386157">.</span><span class="ident" id="8386158">Fatalf</span><span class="op" id="8386164">(</span><span class="string" id="8386165">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="8386175">,</span>&nbsp;<span class="ident" id="8386177">err</span><span class="op" id="8386180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8386183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386186">if</span>&nbsp;<span class="ident" id="8386189">_</span><span class="op" id="8386190">,</span>&nbsp;<span class="ident" id="8386192">err</span>&nbsp;<span class="op" id="8386196">:=</span>&nbsp;<span class="ident" id="8386199">db</span><span class="op" id="8386201">.</span><span class="ident" id="8386202">Exec</span><span class="op" id="8386206">(</span><span class="string" id="8386207">&#34;WIPE&#34;</span><span class="op" id="8386213">)</span><span class="op" id="8386214">;</span>&nbsp;<span class="ident" id="8386216">err</span>&nbsp;<span class="op" id="8386220">!=</span>&nbsp;<span class="builtintype" id="8386223">nil</span>&nbsp;<span class="op" id="8386227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386231">t</span><span class="op" id="8386232">.</span><span class="ident" id="8386233">Fatalf</span><span class="op" id="8386239">(</span><span class="string" id="8386240">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="8386255">,</span>&nbsp;<span class="ident" id="8386257">err</span><span class="op" id="8386260">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8386263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386266">defer</span>&nbsp;<span class="ident" id="8386272">closeDB</span><span class="op" id="8386279">(</span><span class="ident" id="8386280">t</span><span class="op" id="8386281">,</span>&nbsp;<span class="ident" id="8386283">db</span><span class="op" id="8386285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386288">exec</span><span class="op" id="8386292">(</span><span class="ident" id="8386293">t</span><span class="op" id="8386294">,</span>&nbsp;<span class="ident" id="8386296">db</span><span class="op" id="8386298">,</span>&nbsp;<span class="string" id="8386300">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8386343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386346">stmt</span><span class="op" id="8386350">,</span>&nbsp;<span class="ident" id="8386352">err</span>&nbsp;<span class="op" id="8386356">:=</span>&nbsp;<span class="ident" id="8386359">db</span><span class="op" id="8386361">.</span><span class="ident" id="8386362">Prepare</span><span class="op" id="8386369">(</span><span class="string" id="8386370">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8386394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386397">if</span>&nbsp;<span class="ident" id="8386400">err</span>&nbsp;<span class="op" id="8386404">!=</span>&nbsp;<span class="builtintype" id="8386407">nil</span>&nbsp;<span class="op" id="8386411">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386415">t</span><span class="op" id="8386416">.</span><span class="ident" id="8386417">Fatalf</span><span class="op" id="8386423">(</span><span class="string" id="8386424">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8386444">,</span>&nbsp;<span class="ident" id="8386446">stmt</span><span class="op" id="8386450">,</span>&nbsp;<span class="ident" id="8386452">err</span><span class="op" id="8386455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8386458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386461">defer</span>&nbsp;<span class="ident" id="8386467">stmt</span><span class="op" id="8386471">.</span><span class="ident" id="8386472">Close</span><span class="op" id="8386477">(</span><span class="op" id="8386478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386481">tx</span><span class="op" id="8386483">,</span>&nbsp;<span class="ident" id="8386485">err</span>&nbsp;<span class="op" id="8386489">:=</span>&nbsp;<span class="ident" id="8386492">db</span><span class="op" id="8386494">.</span><span class="ident" id="8386495">Begin</span><span class="op" id="8386500">(</span><span class="op" id="8386501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386504">if</span>&nbsp;<span class="ident" id="8386507">err</span>&nbsp;<span class="op" id="8386511">!=</span>&nbsp;<span class="builtintype" id="8386514">nil</span>&nbsp;<span class="op" id="8386518">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386522">t</span><span class="op" id="8386523">.</span><span class="ident" id="8386524">Fatalf</span><span class="op" id="8386530">(</span><span class="string" id="8386531">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8386543">,</span>&nbsp;<span class="ident" id="8386545">err</span><span class="op" id="8386548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8386551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386554">txs</span>&nbsp;<span class="op" id="8386558">:=</span>&nbsp;<span class="ident" id="8386561">tx</span><span class="op" id="8386563">.</span><span class="ident" id="8386564">Stmt</span><span class="op" id="8386568">(</span><span class="ident" id="8386569">stmt</span><span class="op" id="8386573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386576">defer</span>&nbsp;<span class="ident" id="8386582">txs</span><span class="op" id="8386585">.</span><span class="ident" id="8386586">Close</span><span class="op" id="8386591">(</span><span class="op" id="8386592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386595">_</span><span class="op" id="8386596">,</span>&nbsp;<span class="ident" id="8386598">err</span>&nbsp;<span class="op" id="8386602">=</span>&nbsp;<span class="ident" id="8386604">txs</span><span class="op" id="8386607">.</span><span class="ident" id="8386608">Exec</span><span class="op" id="8386612">(</span><span class="string" id="8386613">&#34;Bobby&#34;</span><span class="op" id="8386620">,</span>&nbsp;<span class="num" id="8386622">7</span><span class="op" id="8386623">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386626">if</span>&nbsp;<span class="ident" id="8386629">err</span>&nbsp;<span class="op" id="8386633">!=</span>&nbsp;<span class="builtintype" id="8386636">nil</span>&nbsp;<span class="op" id="8386640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386644">t</span><span class="op" id="8386645">.</span><span class="ident" id="8386646">Fatalf</span><span class="op" id="8386652">(</span><span class="string" id="8386653">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8386664">,</span>&nbsp;<span class="ident" id="8386666">err</span><span class="op" id="8386669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8386672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386675">err</span>&nbsp;<span class="op" id="8386679">=</span>&nbsp;<span class="ident" id="8386681">tx</span><span class="op" id="8386683">.</span><span class="ident" id="8386684">Commit</span><span class="op" id="8386690">(</span><span class="op" id="8386691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386694">if</span>&nbsp;<span class="ident" id="8386697">err</span>&nbsp;<span class="op" id="8386701">!=</span>&nbsp;<span class="builtintype" id="8386704">nil</span>&nbsp;<span class="op" id="8386708">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386712">t</span><span class="op" id="8386713">.</span><span class="ident" id="8386714">Fatalf</span><span class="op" id="8386720">(</span><span class="string" id="8386721">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8386734">,</span>&nbsp;<span class="ident" id="8386736">err</span><span class="op" id="8386739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8386742">}</span><br>
<span class="lineno"></span><span class="op" id="8386744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8386747">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="8386816">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="8386840">func</span>&nbsp;<span class="ident" id="8386845">TestIssue2542Deadlock</span><span class="op" id="8386866">(</span><span class="ident" id="8386867">t</span>&nbsp;<span class="op" id="8386869">*</span><span class="ident" id="8386870">testing</span><span class="op" id="8386877">.</span><span class="ident" id="8386878">T</span><span class="op" id="8386879">)</span>&nbsp;<span class="op" id="8386881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386884">db</span>&nbsp;<span class="op" id="8386887">:=</span>&nbsp;<span class="ident" id="8386890">newTestDB</span><span class="op" id="8386899">(</span><span class="ident" id="8386900">t</span><span class="op" id="8386901">,</span>&nbsp;<span class="string" id="8386903">&#34;people&#34;</span><span class="op" id="8386911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386914">closeDB</span><span class="op" id="8386921">(</span><span class="ident" id="8386922">t</span><span class="op" id="8386923">,</span>&nbsp;<span class="ident" id="8386925">db</span><span class="op" id="8386927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8386930">for</span>&nbsp;<span class="ident" id="8386934">i</span>&nbsp;<span class="op" id="8386936">:=</span>&nbsp;<span class="num" id="8386939">0</span><span class="op" id="8386940">;</span>&nbsp;<span class="ident" id="8386942">i</span>&nbsp;<span class="op" id="8386944">&lt;</span>&nbsp;<span class="num" id="8386946">2</span><span class="op" id="8386947">;</span>&nbsp;<span class="ident" id="8386949">i</span><span class="op" id="8386950">++</span>&nbsp;<span class="op" id="8386953">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8386957">_</span><span class="op" id="8386958">,</span>&nbsp;<span class="ident" id="8386960">err</span>&nbsp;<span class="op" id="8386964">:=</span>&nbsp;<span class="ident" id="8386967">db</span><span class="op" id="8386969">.</span><span class="ident" id="8386970">Query</span><span class="op" id="8386975">(</span><span class="string" id="8386976">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8387001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387005">if</span>&nbsp;<span class="ident" id="8387008">err</span>&nbsp;<span class="op" id="8387012">==</span>&nbsp;<span class="builtintype" id="8387015">nil</span>&nbsp;<span class="op" id="8387019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387024">t</span><span class="op" id="8387025">.</span><span class="ident" id="8387026">Fatalf</span><span class="op" id="8387032">(</span><span class="string" id="8387033">&#34;expected&nbsp;error&#34;</span><span class="op" id="8387049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8387053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8387056">}</span><br>
<span class="lineno">595</span><span class="op" id="8387058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8387061">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="8387091">func</span>&nbsp;<span class="ident" id="8387096">TestCloseStmtBeforeRows</span><span class="op" id="8387119">(</span><span class="ident" id="8387120">t</span>&nbsp;<span class="op" id="8387122">*</span><span class="ident" id="8387123">testing</span><span class="op" id="8387130">.</span><span class="ident" id="8387131">T</span><span class="op" id="8387132">)</span>&nbsp;<span class="op" id="8387134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387137">db</span>&nbsp;<span class="op" id="8387140">:=</span>&nbsp;<span class="ident" id="8387143">newTestDB</span><span class="op" id="8387152">(</span><span class="ident" id="8387153">t</span><span class="op" id="8387154">,</span>&nbsp;<span class="string" id="8387156">&#34;people&#34;</span><span class="op" id="8387164">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387167">defer</span>&nbsp;<span class="ident" id="8387173">closeDB</span><span class="op" id="8387180">(</span><span class="ident" id="8387181">t</span><span class="op" id="8387182">,</span>&nbsp;<span class="ident" id="8387184">db</span><span class="op" id="8387186">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387190">s</span><span class="op" id="8387191">,</span>&nbsp;<span class="ident" id="8387193">err</span>&nbsp;<span class="op" id="8387197">:=</span>&nbsp;<span class="ident" id="8387200">db</span><span class="op" id="8387202">.</span><span class="ident" id="8387203">Prepare</span><span class="op" id="8387210">(</span><span class="string" id="8387211">&#34;SELECT|people|name|&#34;</span><span class="op" id="8387232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387235">if</span>&nbsp;<span class="ident" id="8387238">err</span>&nbsp;<span class="op" id="8387242">!=</span>&nbsp;<span class="builtintype" id="8387245">nil</span>&nbsp;<span class="op" id="8387249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387253">t</span><span class="op" id="8387254">.</span><span class="ident" id="8387255">Fatal</span><span class="op" id="8387260">(</span><span class="ident" id="8387261">err</span><span class="op" id="8387264">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8387267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387271">r</span><span class="op" id="8387272">,</span>&nbsp;<span class="ident" id="8387274">err</span>&nbsp;<span class="op" id="8387278">:=</span>&nbsp;<span class="ident" id="8387281">s</span><span class="op" id="8387282">.</span><span class="ident" id="8387283">Query</span><span class="op" id="8387288">(</span><span class="op" id="8387289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387292">if</span>&nbsp;<span class="ident" id="8387295">err</span>&nbsp;<span class="op" id="8387299">!=</span>&nbsp;<span class="builtintype" id="8387302">nil</span>&nbsp;<span class="op" id="8387306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387310">s</span><span class="op" id="8387311">.</span><span class="ident" id="8387312">Close</span><span class="op" id="8387317">(</span><span class="op" id="8387318">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387322">t</span><span class="op" id="8387323">.</span><span class="ident" id="8387324">Fatal</span><span class="op" id="8387329">(</span><span class="ident" id="8387330">err</span><span class="op" id="8387333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8387336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387340">err</span>&nbsp;<span class="op" id="8387344">=</span>&nbsp;<span class="ident" id="8387346">s</span><span class="op" id="8387347">.</span><span class="ident" id="8387348">Close</span><span class="op" id="8387353">(</span><span class="op" id="8387354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387357">if</span>&nbsp;<span class="ident" id="8387360">err</span>&nbsp;<span class="op" id="8387364">!=</span>&nbsp;<span class="builtintype" id="8387367">nil</span>&nbsp;<span class="op" id="8387371">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387375">t</span><span class="op" id="8387376">.</span><span class="ident" id="8387377">Fatal</span><span class="op" id="8387382">(</span><span class="ident" id="8387383">err</span><span class="op" id="8387386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8387389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387393">r</span><span class="op" id="8387394">.</span><span class="ident" id="8387395">Close</span><span class="op" id="8387400">(</span><span class="op" id="8387401">)</span><br>
<span class="lineno"></span><span class="op" id="8387403">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="8387406">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="8387471">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="8387506">func</span>&nbsp;<span class="ident" id="8387511">TestNullByteSlice</span><span class="op" id="8387528">(</span><span class="ident" id="8387529">t</span>&nbsp;<span class="op" id="8387531">*</span><span class="ident" id="8387532">testing</span><span class="op" id="8387539">.</span><span class="ident" id="8387540">T</span><span class="op" id="8387541">)</span>&nbsp;<span class="op" id="8387543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387546">db</span>&nbsp;<span class="op" id="8387549">:=</span>&nbsp;<span class="ident" id="8387552">newTestDB</span><span class="op" id="8387561">(</span><span class="ident" id="8387562">t</span><span class="op" id="8387563">,</span>&nbsp;<span class="string" id="8387565">&#34;&#34;</span><span class="op" id="8387567">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387570">defer</span>&nbsp;<span class="ident" id="8387576">closeDB</span><span class="op" id="8387583">(</span><span class="ident" id="8387584">t</span><span class="op" id="8387585">,</span>&nbsp;<span class="ident" id="8387587">db</span><span class="op" id="8387589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387592">exec</span><span class="op" id="8387596">(</span><span class="ident" id="8387597">t</span><span class="op" id="8387598">,</span>&nbsp;<span class="ident" id="8387600">db</span><span class="op" id="8387602">,</span>&nbsp;<span class="string" id="8387604">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="8387639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387642">exec</span><span class="op" id="8387646">(</span><span class="ident" id="8387647">t</span><span class="op" id="8387648">,</span>&nbsp;<span class="ident" id="8387650">db</span><span class="op" id="8387652">,</span>&nbsp;<span class="string" id="8387654">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="8387677">,</span>&nbsp;<span class="builtintype" id="8387679">nil</span><span class="op" id="8387682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387686">var</span>&nbsp;<span class="ident" id="8387690">name</span>&nbsp;<span class="op" id="8387695">[</span><span class="op" id="8387696">]</span><span class="builtintype" id="8387697">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387704">err</span>&nbsp;<span class="op" id="8387708">:=</span>&nbsp;<span class="ident" id="8387711">db</span><span class="op" id="8387713">.</span><span class="ident" id="8387714">QueryRow</span><span class="op" id="8387722">(</span><span class="string" id="8387723">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8387743">,</span>&nbsp;<span class="num" id="8387745">10</span><span class="op" id="8387747">)</span><span class="op" id="8387748">.</span><span class="ident" id="8387749">Scan</span><span class="op" id="8387753">(</span><span class="op" id="8387754">&amp;</span><span class="ident" id="8387755">name</span><span class="op" id="8387759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387762">if</span>&nbsp;<span class="ident" id="8387765">err</span>&nbsp;<span class="op" id="8387769">!=</span>&nbsp;<span class="builtintype" id="8387772">nil</span>&nbsp;<span class="op" id="8387776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387780">t</span><span class="op" id="8387781">.</span><span class="ident" id="8387782">Fatal</span><span class="op" id="8387787">(</span><span class="ident" id="8387788">err</span><span class="op" id="8387791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8387794">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387797">if</span>&nbsp;<span class="ident" id="8387800">name</span>&nbsp;<span class="op" id="8387805">!=</span>&nbsp;<span class="builtintype" id="8387808">nil</span>&nbsp;<span class="op" id="8387812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387816">t</span><span class="op" id="8387817">.</span><span class="ident" id="8387818">Fatalf</span><span class="op" id="8387824">(</span><span class="string" id="8387825">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="8387884">,</span>&nbsp;<span class="ident" id="8387886">name</span><span class="op" id="8387890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8387893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387897">exec</span><span class="op" id="8387901">(</span><span class="ident" id="8387902">t</span><span class="op" id="8387903">,</span>&nbsp;<span class="ident" id="8387905">db</span><span class="op" id="8387907">,</span>&nbsp;<span class="string" id="8387909">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="8387932">,</span>&nbsp;<span class="string" id="8387934">&#34;bob&#34;</span><span class="op" id="8387939">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8387942">err</span>&nbsp;<span class="op" id="8387946">=</span>&nbsp;<span class="ident" id="8387948">db</span><span class="op" id="8387950">.</span><span class="ident" id="8387951">QueryRow</span><span class="op" id="8387959">(</span><span class="string" id="8387960">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8387980">,</span>&nbsp;<span class="num" id="8387982">11</span><span class="op" id="8387984">)</span><span class="op" id="8387985">.</span><span class="ident" id="8387986">Scan</span><span class="op" id="8387990">(</span><span class="op" id="8387991">&amp;</span><span class="ident" id="8387992">name</span><span class="op" id="8387996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8387999">if</span>&nbsp;<span class="ident" id="8388002">err</span>&nbsp;<span class="op" id="8388006">!=</span>&nbsp;<span class="builtintype" id="8388009">nil</span>&nbsp;<span class="op" id="8388013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388017">t</span><span class="op" id="8388018">.</span><span class="ident" id="8388019">Fatal</span><span class="op" id="8388024">(</span><span class="ident" id="8388025">err</span><span class="op" id="8388028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8388031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388034">if</span>&nbsp;<span class="builtintype" id="8388037">string</span><span class="op" id="8388043">(</span><span class="ident" id="8388044">name</span><span class="op" id="8388048">)</span>&nbsp;<span class="op" id="8388050">!=</span>&nbsp;<span class="string" id="8388053">&#34;bob&#34;</span>&nbsp;<span class="op" id="8388059">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388063">t</span><span class="op" id="8388064">.</span><span class="ident" id="8388065">Fatalf</span><span class="op" id="8388071">(</span><span class="string" id="8388072">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="8388108">,</span>&nbsp;<span class="builtintype" id="8388110">string</span><span class="op" id="8388116">(</span><span class="ident" id="8388117">name</span><span class="op" id="8388121">)</span><span class="op" id="8388122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8388125">}</span><br>
<span class="lineno"></span><span class="op" id="8388127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8388130">func</span>&nbsp;<span class="ident" id="8388135">TestPointerParamsAndScans</span><span class="op" id="8388160">(</span><span class="ident" id="8388161">t</span>&nbsp;<span class="op" id="8388163">*</span><span class="ident" id="8388164">testing</span><span class="op" id="8388171">.</span><span class="ident" id="8388172">T</span><span class="op" id="8388173">)</span>&nbsp;<span class="op" id="8388175">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388178">db</span>&nbsp;<span class="op" id="8388181">:=</span>&nbsp;<span class="ident" id="8388184">newTestDB</span><span class="op" id="8388193">(</span><span class="ident" id="8388194">t</span><span class="op" id="8388195">,</span>&nbsp;<span class="string" id="8388197">&#34;&#34;</span><span class="op" id="8388199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388202">defer</span>&nbsp;<span class="ident" id="8388208">closeDB</span><span class="op" id="8388215">(</span><span class="ident" id="8388216">t</span><span class="op" id="8388217">,</span>&nbsp;<span class="ident" id="8388219">db</span><span class="op" id="8388221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388224">exec</span><span class="op" id="8388228">(</span><span class="ident" id="8388229">t</span><span class="op" id="8388230">,</span>&nbsp;<span class="ident" id="8388232">db</span><span class="op" id="8388234">,</span>&nbsp;<span class="string" id="8388236">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="8388271">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388275">bob</span>&nbsp;<span class="op" id="8388279">:=</span>&nbsp;<span class="string" id="8388282">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388289">var</span>&nbsp;<span class="ident" id="8388293">name</span>&nbsp;<span class="op" id="8388298">*</span><span class="builtintype" id="8388299">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388308">name</span>&nbsp;<span class="op" id="8388313">=</span>&nbsp;<span class="op" id="8388315">&amp;</span><span class="ident" id="8388316">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388321">exec</span><span class="op" id="8388325">(</span><span class="ident" id="8388326">t</span><span class="op" id="8388327">,</span>&nbsp;<span class="ident" id="8388329">db</span><span class="op" id="8388331">,</span>&nbsp;<span class="string" id="8388333">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="8388356">,</span>&nbsp;<span class="ident" id="8388358">name</span><span class="op" id="8388362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388365">name</span>&nbsp;<span class="op" id="8388370">=</span>&nbsp;<span class="builtintype" id="8388372">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388377">exec</span><span class="op" id="8388381">(</span><span class="ident" id="8388382">t</span><span class="op" id="8388383">,</span>&nbsp;<span class="ident" id="8388385">db</span><span class="op" id="8388387">,</span>&nbsp;<span class="string" id="8388389">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="8388412">,</span>&nbsp;<span class="ident" id="8388414">name</span><span class="op" id="8388418">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388422">err</span>&nbsp;<span class="op" id="8388426">:=</span>&nbsp;<span class="ident" id="8388429">db</span><span class="op" id="8388431">.</span><span class="ident" id="8388432">QueryRow</span><span class="op" id="8388440">(</span><span class="string" id="8388441">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8388461">,</span>&nbsp;<span class="num" id="8388463">10</span><span class="op" id="8388465">)</span><span class="op" id="8388466">.</span><span class="ident" id="8388467">Scan</span><span class="op" id="8388471">(</span><span class="op" id="8388472">&amp;</span><span class="ident" id="8388473">name</span><span class="op" id="8388477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388480">if</span>&nbsp;<span class="ident" id="8388483">err</span>&nbsp;<span class="op" id="8388487">!=</span>&nbsp;<span class="builtintype" id="8388490">nil</span>&nbsp;<span class="op" id="8388494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388498">t</span><span class="op" id="8388499">.</span><span class="ident" id="8388500">Fatalf</span><span class="op" id="8388506">(</span><span class="string" id="8388507">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="8388527">,</span>&nbsp;<span class="ident" id="8388529">err</span><span class="op" id="8388532">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8388535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388538">if</span>&nbsp;<span class="ident" id="8388541">name</span>&nbsp;<span class="op" id="8388546">==</span>&nbsp;<span class="builtintype" id="8388549">nil</span>&nbsp;<span class="op" id="8388553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388557">t</span><span class="op" id="8388558">.</span><span class="ident" id="8388559">Errorf</span><span class="op" id="8388565">(</span><span class="string" id="8388566">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="8388596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8388599">}</span>&nbsp;<span class="keyword" id="8388601">else</span>&nbsp;<span class="keyword" id="8388606">if</span>&nbsp;<span class="op" id="8388609">*</span><span class="ident" id="8388610">name</span>&nbsp;<span class="op" id="8388615">!=</span>&nbsp;<span class="string" id="8388618">&#34;bob&#34;</span>&nbsp;<span class="op" id="8388624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388628">t</span><span class="op" id="8388629">.</span><span class="ident" id="8388630">Errorf</span><span class="op" id="8388636">(</span><span class="string" id="8388637">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="8388666">,</span>&nbsp;<span class="op" id="8388668">*</span><span class="ident" id="8388669">name</span><span class="op" id="8388673">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8388676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388680">err</span>&nbsp;<span class="op" id="8388684">=</span>&nbsp;<span class="ident" id="8388686">db</span><span class="op" id="8388688">.</span><span class="ident" id="8388689">QueryRow</span><span class="op" id="8388697">(</span><span class="string" id="8388698">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8388718">,</span>&nbsp;<span class="num" id="8388720">20</span><span class="op" id="8388722">)</span><span class="op" id="8388723">.</span><span class="ident" id="8388724">Scan</span><span class="op" id="8388728">(</span><span class="op" id="8388729">&amp;</span><span class="ident" id="8388730">name</span><span class="op" id="8388734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388737">if</span>&nbsp;<span class="ident" id="8388740">err</span>&nbsp;<span class="op" id="8388744">!=</span>&nbsp;<span class="builtintype" id="8388747">nil</span>&nbsp;<span class="op" id="8388751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388755">t</span><span class="op" id="8388756">.</span><span class="ident" id="8388757">Fatalf</span><span class="op" id="8388763">(</span><span class="string" id="8388764">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="8388784">,</span>&nbsp;<span class="ident" id="8388786">err</span><span class="op" id="8388789">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8388792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388795">if</span>&nbsp;<span class="ident" id="8388798">name</span>&nbsp;<span class="op" id="8388803">!=</span>&nbsp;<span class="builtintype" id="8388806">nil</span>&nbsp;<span class="op" id="8388810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388814">t</span><span class="op" id="8388815">.</span><span class="ident" id="8388816">Errorf</span><span class="op" id="8388822">(</span><span class="string" id="8388823">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="8388845">,</span>&nbsp;<span class="op" id="8388847">*</span><span class="ident" id="8388848">name</span><span class="op" id="8388852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8388855">}</span><br>
<span class="lineno"></span><span class="op" id="8388857">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="8388860">func</span>&nbsp;<span class="ident" id="8388865">TestQueryRowClosingStmt</span><span class="op" id="8388888">(</span><span class="ident" id="8388889">t</span>&nbsp;<span class="op" id="8388891">*</span><span class="ident" id="8388892">testing</span><span class="op" id="8388899">.</span><span class="ident" id="8388900">T</span><span class="op" id="8388901">)</span>&nbsp;<span class="op" id="8388903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388906">db</span>&nbsp;<span class="op" id="8388909">:=</span>&nbsp;<span class="ident" id="8388912">newTestDB</span><span class="op" id="8388921">(</span><span class="ident" id="8388922">t</span><span class="op" id="8388923">,</span>&nbsp;<span class="string" id="8388925">&#34;people&#34;</span><span class="op" id="8388933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388936">defer</span>&nbsp;<span class="ident" id="8388942">closeDB</span><span class="op" id="8388949">(</span><span class="ident" id="8388950">t</span><span class="op" id="8388951">,</span>&nbsp;<span class="ident" id="8388953">db</span><span class="op" id="8388955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388958">var</span>&nbsp;<span class="ident" id="8388962">name</span>&nbsp;<span class="builtintype" id="8388967">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8388975">var</span>&nbsp;<span class="ident" id="8388979">age</span>&nbsp;<span class="builtintype" id="8388983">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8388988">err</span>&nbsp;<span class="op" id="8388992">:=</span>&nbsp;<span class="ident" id="8388995">db</span><span class="op" id="8388997">.</span><span class="ident" id="8388998">QueryRow</span><span class="op" id="8389006">(</span><span class="string" id="8389007">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8389037">,</span>&nbsp;<span class="num" id="8389039">3</span><span class="op" id="8389040">)</span><span class="op" id="8389041">.</span><span class="ident" id="8389042">Scan</span><span class="op" id="8389046">(</span><span class="op" id="8389047">&amp;</span><span class="ident" id="8389048">age</span><span class="op" id="8389051">,</span>&nbsp;<span class="op" id="8389053">&amp;</span><span class="ident" id="8389054">name</span><span class="op" id="8389058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389061">if</span>&nbsp;<span class="ident" id="8389064">err</span>&nbsp;<span class="op" id="8389068">!=</span>&nbsp;<span class="builtintype" id="8389071">nil</span>&nbsp;<span class="op" id="8389075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389079">t</span><span class="op" id="8389080">.</span><span class="ident" id="8389081">Fatal</span><span class="op" id="8389086">(</span><span class="ident" id="8389087">err</span><span class="op" id="8389090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8389093">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389096">if</span>&nbsp;<span class="builtinfunc" id="8389099">len</span><span class="op" id="8389102">(</span><span class="ident" id="8389103">db</span><span class="op" id="8389105">.</span><span class="ident" id="8389106">freeConn</span><span class="op" id="8389114">)</span>&nbsp;<span class="op" id="8389116">!=</span>&nbsp;<span class="num" id="8389119">1</span>&nbsp;<span class="op" id="8389121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389125">t</span><span class="op" id="8389126">.</span><span class="ident" id="8389127">Fatalf</span><span class="op" id="8389133">(</span><span class="string" id="8389134">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="8389156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8389159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389162">fakeConn</span>&nbsp;<span class="op" id="8389171">:=</span>&nbsp;<span class="ident" id="8389174">db</span><span class="op" id="8389176">.</span><span class="ident" id="8389177">freeConn</span><span class="op" id="8389185">[</span><span class="num" id="8389186">0</span><span class="op" id="8389187">]</span><span class="op" id="8389188">.</span><span class="ident" id="8389189">ci</span><span class="op" id="8389191">.</span><span class="op" id="8389192">(</span><span class="op" id="8389193">*</span><span class="ident" id="8389194">fakeConn</span><span class="op" id="8389202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389205">if</span>&nbsp;<span class="ident" id="8389208">made</span><span class="op" id="8389212">,</span>&nbsp;<span class="ident" id="8389214">closed</span>&nbsp;<span class="op" id="8389221">:=</span>&nbsp;<span class="ident" id="8389224">fakeConn</span><span class="op" id="8389232">.</span><span class="ident" id="8389233">stmtsMade</span><span class="op" id="8389242">,</span>&nbsp;<span class="ident" id="8389244">fakeConn</span><span class="op" id="8389252">.</span><span class="ident" id="8389253">stmtsClosed</span><span class="op" id="8389264">;</span>&nbsp;<span class="ident" id="8389266">made</span>&nbsp;<span class="op" id="8389271">!=</span>&nbsp;<span class="ident" id="8389274">closed</span>&nbsp;<span class="op" id="8389281">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389285">t</span><span class="op" id="8389286">.</span><span class="ident" id="8389287">Errorf</span><span class="op" id="8389293">(</span><span class="string" id="8389294">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="8389340">,</span>&nbsp;<span class="ident" id="8389342">made</span><span class="op" id="8389346">,</span>&nbsp;<span class="ident" id="8389348">closed</span><span class="op" id="8389354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8389357">}</span><br>
<span class="lineno"></span><span class="op" id="8389359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8389362">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="8389381">func</span>&nbsp;<span class="ident" id="8389386">TestIssue6651</span><span class="op" id="8389399">(</span><span class="ident" id="8389400">t</span>&nbsp;<span class="op" id="8389402">*</span><span class="ident" id="8389403">testing</span><span class="op" id="8389410">.</span><span class="ident" id="8389411">T</span><span class="op" id="8389412">)</span>&nbsp;<span class="op" id="8389414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389417">db</span>&nbsp;<span class="op" id="8389420">:=</span>&nbsp;<span class="ident" id="8389423">newTestDB</span><span class="op" id="8389432">(</span><span class="ident" id="8389433">t</span><span class="op" id="8389434">,</span>&nbsp;<span class="string" id="8389436">&#34;people&#34;</span><span class="op" id="8389444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389447">defer</span>&nbsp;<span class="ident" id="8389453">closeDB</span><span class="op" id="8389460">(</span><span class="ident" id="8389461">t</span><span class="op" id="8389462">,</span>&nbsp;<span class="ident" id="8389464">db</span><span class="op" id="8389466">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389470">var</span>&nbsp;<span class="ident" id="8389474">v</span>&nbsp;<span class="builtintype" id="8389476">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389485">want</span>&nbsp;<span class="op" id="8389490">:=</span>&nbsp;<span class="string" id="8389493">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389515">rowsCursorNextHook</span>&nbsp;<span class="op" id="8389534">=</span>&nbsp;<span class="keyword" id="8389536">func</span><span class="op" id="8389540">(</span><span class="ident" id="8389541">dest</span>&nbsp;<span class="op" id="8389546">[</span><span class="op" id="8389547">]</span><span class="ident" id="8389548">driver</span><span class="op" id="8389554">.</span><span class="ident" id="8389555">Value</span><span class="op" id="8389560">)</span>&nbsp;<span class="builtintype" id="8389562">error</span>&nbsp;<span class="op" id="8389568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389572">return</span>&nbsp;<span class="ident" id="8389579">fmt</span><span class="op" id="8389582">.</span><span class="ident" id="8389583">Errorf</span><span class="op" id="8389589">(</span><span class="ident" id="8389590">want</span><span class="op" id="8389594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8389597">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389600">defer</span>&nbsp;<span class="keyword" id="8389606">func</span><span class="op" id="8389610">(</span><span class="op" id="8389611">)</span>&nbsp;<span class="op" id="8389613">{</span>&nbsp;<span class="ident" id="8389615">rowsCursorNextHook</span>&nbsp;<span class="op" id="8389634">=</span>&nbsp;<span class="builtintype" id="8389636">nil</span>&nbsp;<span class="op" id="8389640">}</span><span class="op" id="8389641">(</span><span class="op" id="8389642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389645">err</span>&nbsp;<span class="op" id="8389649">:=</span>&nbsp;<span class="ident" id="8389652">db</span><span class="op" id="8389654">.</span><span class="ident" id="8389655">QueryRow</span><span class="op" id="8389663">(</span><span class="string" id="8389664">&#34;SELECT|people|name|&#34;</span><span class="op" id="8389685">)</span><span class="op" id="8389686">.</span><span class="ident" id="8389687">Scan</span><span class="op" id="8389691">(</span><span class="op" id="8389692">&amp;</span><span class="ident" id="8389693">v</span><span class="op" id="8389694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389697">if</span>&nbsp;<span class="ident" id="8389700">err</span>&nbsp;<span class="op" id="8389704">==</span>&nbsp;<span class="builtintype" id="8389707">nil</span>&nbsp;<span class="op" id="8389711">||</span>&nbsp;<span class="ident" id="8389714">err</span><span class="op" id="8389717">.</span><span class="ident" id="8389718">Error</span><span class="op" id="8389723">(</span><span class="op" id="8389724">)</span>&nbsp;<span class="op" id="8389726">!=</span>&nbsp;<span class="ident" id="8389729">want</span>&nbsp;<span class="op" id="8389734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389738">t</span><span class="op" id="8389739">.</span><span class="ident" id="8389740">Errorf</span><span class="op" id="8389746">(</span><span class="string" id="8389747">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8389768">,</span>&nbsp;<span class="ident" id="8389770">err</span><span class="op" id="8389773">,</span>&nbsp;<span class="ident" id="8389775">want</span><span class="op" id="8389779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8389782">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389785">rowsCursorNextHook</span>&nbsp;<span class="op" id="8389804">=</span>&nbsp;<span class="builtintype" id="8389806">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389812">want</span>&nbsp;<span class="op" id="8389817">=</span>&nbsp;<span class="string" id="8389819">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389842">rowsCloseHook</span>&nbsp;<span class="op" id="8389856">=</span>&nbsp;<span class="keyword" id="8389858">func</span><span class="op" id="8389862">(</span><span class="ident" id="8389863">rows</span>&nbsp;<span class="op" id="8389868">*</span><span class="ident" id="8389869">Rows</span><span class="op" id="8389873">,</span>&nbsp;<span class="ident" id="8389875">err</span>&nbsp;<span class="op" id="8389879">*</span><span class="builtintype" id="8389880">error</span><span class="op" id="8389885">)</span>&nbsp;<span class="op" id="8389887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8389891">*</span><span class="ident" id="8389892">err</span>&nbsp;<span class="op" id="8389896">=</span>&nbsp;<span class="ident" id="8389898">fmt</span><span class="op" id="8389901">.</span><span class="ident" id="8389902">Errorf</span><span class="op" id="8389908">(</span><span class="ident" id="8389909">want</span><span class="op" id="8389913">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8389916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8389919">defer</span>&nbsp;<span class="keyword" id="8389925">func</span><span class="op" id="8389929">(</span><span class="op" id="8389930">)</span>&nbsp;<span class="op" id="8389932">{</span>&nbsp;<span class="ident" id="8389934">rowsCloseHook</span>&nbsp;<span class="op" id="8389948">=</span>&nbsp;<span class="builtintype" id="8389950">nil</span>&nbsp;<span class="op" id="8389954">}</span><span class="op" id="8389955">(</span><span class="op" id="8389956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8389959">err</span>&nbsp;<span class="op" id="8389963">=</span>&nbsp;<span class="ident" id="8389965">db</span><span class="op" id="8389967">.</span><span class="ident" id="8389968">QueryRow</span><span class="op" id="8389976">(</span><span class="string" id="8389977">&#34;SELECT|people|name|&#34;</span><span class="op" id="8389998">)</span><span class="op" id="8389999">.</span><span class="ident" id="8390000">Scan</span><span class="op" id="8390004">(</span><span class="op" id="8390005">&amp;</span><span class="ident" id="8390006">v</span><span class="op" id="8390007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8390010">if</span>&nbsp;<span class="ident" id="8390013">err</span>&nbsp;<span class="op" id="8390017">==</span>&nbsp;<span class="builtintype" id="8390020">nil</span>&nbsp;<span class="op" id="8390024">||</span>&nbsp;<span class="ident" id="8390027">err</span><span class="op" id="8390030">.</span><span class="ident" id="8390031">Error</span><span class="op" id="8390036">(</span><span class="op" id="8390037">)</span>&nbsp;<span class="op" id="8390039">!=</span>&nbsp;<span class="ident" id="8390042">want</span>&nbsp;<span class="op" id="8390047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390051">t</span><span class="op" id="8390052">.</span><span class="ident" id="8390053">Errorf</span><span class="op" id="8390059">(</span><span class="string" id="8390060">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8390081">,</span>&nbsp;<span class="ident" id="8390083">err</span><span class="op" id="8390086">,</span>&nbsp;<span class="ident" id="8390088">want</span><span class="op" id="8390092">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390095">}</span><br>
<span class="lineno"></span><span class="op" id="8390097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8390100">type</span>&nbsp;<span class="ident" id="8390105">nullTestRow</span>&nbsp;<span class="keyword" id="8390117">struct</span>&nbsp;<span class="op" id="8390124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390127">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8390140">interface</span><span class="op" id="8390149">{</span><span class="op" id="8390150">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390153">notNullParam</span>&nbsp;<span class="keyword" id="8390166">interface</span><span class="op" id="8390175">{</span><span class="op" id="8390176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390179">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="8390192">interface</span><span class="op" id="8390201">{</span><span class="op" id="8390202">}</span><br>
<span class="lineno"></span><span class="op" id="8390204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8390207">type</span>&nbsp;<span class="ident" id="8390212">nullTestSpec</span>&nbsp;<span class="keyword" id="8390225">struct</span>&nbsp;<span class="op" id="8390232">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390235">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8390247">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390255">notNullType</span>&nbsp;<span class="builtintype" id="8390267">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390275">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390287">[</span><span class="num" id="8390288">6</span><span class="op" id="8390289">]</span><span class="ident" id="8390290">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="8390302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="8390305">func</span>&nbsp;<span class="ident" id="8390310">TestNullStringParam</span><span class="op" id="8390329">(</span><span class="ident" id="8390330">t</span>&nbsp;<span class="op" id="8390332">*</span><span class="ident" id="8390333">testing</span><span class="op" id="8390340">.</span><span class="ident" id="8390341">T</span><span class="op" id="8390342">)</span>&nbsp;<span class="op" id="8390344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390347">spec</span>&nbsp;<span class="op" id="8390352">:=</span>&nbsp;<span class="ident" id="8390355">nullTestSpec</span><span class="op" id="8390367">{</span><span class="string" id="8390368">&#34;nullstring&#34;</span><span class="op" id="8390380">,</span>&nbsp;<span class="string" id="8390382">&#34;string&#34;</span><span class="op" id="8390390">,</span>&nbsp;<span class="op" id="8390392">[</span><span class="num" id="8390393">6</span><span class="op" id="8390394">]</span><span class="ident" id="8390395">nullTestRow</span><span class="op" id="8390406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390410">{</span><span class="ident" id="8390411">NullString</span><span class="op" id="8390421">{</span><span class="string" id="8390422">&#34;aqua&#34;</span><span class="op" id="8390428">,</span>&nbsp;<span class="builtintype" id="8390430">true</span><span class="op" id="8390434">}</span><span class="op" id="8390435">,</span>&nbsp;<span class="string" id="8390437">&#34;&#34;</span><span class="op" id="8390439">,</span>&nbsp;<span class="ident" id="8390441">NullString</span><span class="op" id="8390451">{</span><span class="string" id="8390452">&#34;aqua&#34;</span><span class="op" id="8390458">,</span>&nbsp;<span class="builtintype" id="8390460">true</span><span class="op" id="8390464">}</span><span class="op" id="8390465">}</span><span class="op" id="8390466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390470">{</span><span class="ident" id="8390471">NullString</span><span class="op" id="8390481">{</span><span class="string" id="8390482">&#34;brown&#34;</span><span class="op" id="8390489">,</span>&nbsp;<span class="builtintype" id="8390491">false</span><span class="op" id="8390496">}</span><span class="op" id="8390497">,</span>&nbsp;<span class="string" id="8390499">&#34;&#34;</span><span class="op" id="8390501">,</span>&nbsp;<span class="ident" id="8390503">NullString</span><span class="op" id="8390513">{</span><span class="string" id="8390514">&#34;&#34;</span><span class="op" id="8390516">,</span>&nbsp;<span class="builtintype" id="8390518">false</span><span class="op" id="8390523">}</span><span class="op" id="8390524">}</span><span class="op" id="8390525">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390529">{</span><span class="string" id="8390530">&#34;chartreuse&#34;</span><span class="op" id="8390542">,</span>&nbsp;<span class="string" id="8390544">&#34;&#34;</span><span class="op" id="8390546">,</span>&nbsp;<span class="ident" id="8390548">NullString</span><span class="op" id="8390558">{</span><span class="string" id="8390559">&#34;chartreuse&#34;</span><span class="op" id="8390571">,</span>&nbsp;<span class="builtintype" id="8390573">true</span><span class="op" id="8390577">}</span><span class="op" id="8390578">}</span><span class="op" id="8390579">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390583">{</span><span class="ident" id="8390584">NullString</span><span class="op" id="8390594">{</span><span class="string" id="8390595">&#34;darkred&#34;</span><span class="op" id="8390604">,</span>&nbsp;<span class="builtintype" id="8390606">true</span><span class="op" id="8390610">}</span><span class="op" id="8390611">,</span>&nbsp;<span class="string" id="8390613">&#34;&#34;</span><span class="op" id="8390615">,</span>&nbsp;<span class="ident" id="8390617">NullString</span><span class="op" id="8390627">{</span><span class="string" id="8390628">&#34;darkred&#34;</span><span class="op" id="8390637">,</span>&nbsp;<span class="builtintype" id="8390639">true</span><span class="op" id="8390643">}</span><span class="op" id="8390644">}</span><span class="op" id="8390645">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390649">{</span><span class="ident" id="8390650">NullString</span><span class="op" id="8390660">{</span><span class="string" id="8390661">&#34;eel&#34;</span><span class="op" id="8390666">,</span>&nbsp;<span class="builtintype" id="8390668">false</span><span class="op" id="8390673">}</span><span class="op" id="8390674">,</span>&nbsp;<span class="string" id="8390676">&#34;&#34;</span><span class="op" id="8390678">,</span>&nbsp;<span class="ident" id="8390680">NullString</span><span class="op" id="8390690">{</span><span class="string" id="8390691">&#34;&#34;</span><span class="op" id="8390693">,</span>&nbsp;<span class="builtintype" id="8390695">false</span><span class="op" id="8390700">}</span><span class="op" id="8390701">}</span><span class="op" id="8390702">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390706">{</span><span class="string" id="8390707">&#34;foo&#34;</span><span class="op" id="8390712">,</span>&nbsp;<span class="ident" id="8390714">NullString</span><span class="op" id="8390724">{</span><span class="string" id="8390725">&#34;black&#34;</span><span class="op" id="8390732">,</span>&nbsp;<span class="builtintype" id="8390734">false</span><span class="op" id="8390739">}</span><span class="op" id="8390740">,</span>&nbsp;<span class="builtintype" id="8390742">nil</span><span class="op" id="8390745">}</span><span class="op" id="8390746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390749">}</span><span class="op" id="8390750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390753">nullTestRun</span><span class="op" id="8390764">(</span><span class="ident" id="8390765">t</span><span class="op" id="8390766">,</span>&nbsp;<span class="ident" id="8390768">spec</span><span class="op" id="8390772">)</span><br>
<span class="lineno">750</span><span class="op" id="8390774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8390777">func</span>&nbsp;<span class="ident" id="8390782">TestNullInt64Param</span><span class="op" id="8390800">(</span><span class="ident" id="8390801">t</span>&nbsp;<span class="op" id="8390803">*</span><span class="ident" id="8390804">testing</span><span class="op" id="8390811">.</span><span class="ident" id="8390812">T</span><span class="op" id="8390813">)</span>&nbsp;<span class="op" id="8390815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8390818">spec</span>&nbsp;<span class="op" id="8390823">:=</span>&nbsp;<span class="ident" id="8390826">nullTestSpec</span><span class="op" id="8390838">{</span><span class="string" id="8390839">&#34;nullint64&#34;</span><span class="op" id="8390850">,</span>&nbsp;<span class="string" id="8390852">&#34;int64&#34;</span><span class="op" id="8390859">,</span>&nbsp;<span class="op" id="8390861">[</span><span class="num" id="8390862">6</span><span class="op" id="8390863">]</span><span class="ident" id="8390864">nullTestRow</span><span class="op" id="8390875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390879">{</span><span class="ident" id="8390880">NullInt64</span><span class="op" id="8390889">{</span><span class="num" id="8390890">31</span><span class="op" id="8390892">,</span>&nbsp;<span class="builtintype" id="8390894">true</span><span class="op" id="8390898">}</span><span class="op" id="8390899">,</span>&nbsp;<span class="num" id="8390901">1</span><span class="op" id="8390902">,</span>&nbsp;<span class="ident" id="8390904">NullInt64</span><span class="op" id="8390913">{</span><span class="num" id="8390914">31</span><span class="op" id="8390916">,</span>&nbsp;<span class="builtintype" id="8390918">true</span><span class="op" id="8390922">}</span><span class="op" id="8390923">}</span><span class="op" id="8390924">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390928">{</span><span class="ident" id="8390929">NullInt64</span><span class="op" id="8390938">{</span><span class="op" id="8390939">-</span><span class="num" id="8390940">22</span><span class="op" id="8390942">,</span>&nbsp;<span class="builtintype" id="8390944">false</span><span class="op" id="8390949">}</span><span class="op" id="8390950">,</span>&nbsp;<span class="num" id="8390952">1</span><span class="op" id="8390953">,</span>&nbsp;<span class="ident" id="8390955">NullInt64</span><span class="op" id="8390964">{</span><span class="num" id="8390965">0</span><span class="op" id="8390966">,</span>&nbsp;<span class="builtintype" id="8390968">false</span><span class="op" id="8390973">}</span><span class="op" id="8390974">}</span><span class="op" id="8390975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390979">{</span><span class="num" id="8390980">22</span><span class="op" id="8390982">,</span>&nbsp;<span class="num" id="8390984">1</span><span class="op" id="8390985">,</span>&nbsp;<span class="ident" id="8390987">NullInt64</span><span class="op" id="8390996">{</span><span class="num" id="8390997">22</span><span class="op" id="8390999">,</span>&nbsp;<span class="builtintype" id="8391001">true</span><span class="op" id="8391005">}</span><span class="op" id="8391006">}</span><span class="op" id="8391007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391011">{</span><span class="ident" id="8391012">NullInt64</span><span class="op" id="8391021">{</span><span class="num" id="8391022">33</span><span class="op" id="8391024">,</span>&nbsp;<span class="builtintype" id="8391026">true</span><span class="op" id="8391030">}</span><span class="op" id="8391031">,</span>&nbsp;<span class="num" id="8391033">1</span><span class="op" id="8391034">,</span>&nbsp;<span class="ident" id="8391036">NullInt64</span><span class="op" id="8391045">{</span><span class="num" id="8391046">33</span><span class="op" id="8391048">,</span>&nbsp;<span class="builtintype" id="8391050">true</span><span class="op" id="8391054">}</span><span class="op" id="8391055">}</span><span class="op" id="8391056">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391060">{</span><span class="ident" id="8391061">NullInt64</span><span class="op" id="8391070">{</span><span class="num" id="8391071">222</span><span class="op" id="8391074">,</span>&nbsp;<span class="builtintype" id="8391076">false</span><span class="op" id="8391081">}</span><span class="op" id="8391082">,</span>&nbsp;<span class="num" id="8391084">1</span><span class="op" id="8391085">,</span>&nbsp;<span class="ident" id="8391087">NullInt64</span><span class="op" id="8391096">{</span><span class="num" id="8391097">0</span><span class="op" id="8391098">,</span>&nbsp;<span class="builtintype" id="8391100">false</span><span class="op" id="8391105">}</span><span class="op" id="8391106">}</span><span class="op" id="8391107">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391111">{</span><span class="num" id="8391112">0</span><span class="op" id="8391113">,</span>&nbsp;<span class="ident" id="8391115">NullInt64</span><span class="op" id="8391124">{</span><span class="num" id="8391125">31</span><span class="op" id="8391127">,</span>&nbsp;<span class="builtintype" id="8391129">false</span><span class="op" id="8391134">}</span><span class="op" id="8391135">,</span>&nbsp;<span class="builtintype" id="8391137">nil</span><span class="op" id="8391140">}</span><span class="op" id="8391141">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391144">}</span><span class="op" id="8391145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8391148">nullTestRun</span><span class="op" id="8391159">(</span><span class="ident" id="8391160">t</span><span class="op" id="8391161">,</span>&nbsp;<span class="ident" id="8391163">spec</span><span class="op" id="8391167">)</span><br>
<span class="lineno"></span><span class="op" id="8391169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8391172">func</span>&nbsp;<span class="ident" id="8391177">TestNullFloat64Param</span><span class="op" id="8391197">(</span><span class="ident" id="8391198">t</span>&nbsp;<span class="op" id="8391200">*</span><span class="ident" id="8391201">testing</span><span class="op" id="8391208">.</span><span class="ident" id="8391209">T</span><span class="op" id="8391210">)</span>&nbsp;<span class="op" id="8391212">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8391215">spec</span>&nbsp;<span class="op" id="8391220">:=</span>&nbsp;<span class="ident" id="8391223">nullTestSpec</span><span class="op" id="8391235">{</span><span class="string" id="8391236">&#34;nullfloat64&#34;</span><span class="op" id="8391249">,</span>&nbsp;<span class="string" id="8391251">&#34;float64&#34;</span><span class="op" id="8391260">,</span>&nbsp;<span class="op" id="8391262">[</span><span class="num" id="8391263">6</span><span class="op" id="8391264">]</span><span class="ident" id="8391265">nullTestRow</span><span class="op" id="8391276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391280">{</span><span class="ident" id="8391281">NullFloat64</span><span class="op" id="8391292">{</span><span class="num" id="8391293">31.2</span><span class="op" id="8391297">,</span>&nbsp;<span class="builtintype" id="8391299">true</span><span class="op" id="8391303">}</span><span class="op" id="8391304">,</span>&nbsp;<span class="num" id="8391306">1</span><span class="op" id="8391307">,</span>&nbsp;<span class="ident" id="8391309">NullFloat64</span><span class="op" id="8391320">{</span><span class="num" id="8391321">31.2</span><span class="op" id="8391325">,</span>&nbsp;<span class="builtintype" id="8391327">true</span><span class="op" id="8391331">}</span><span class="op" id="8391332">}</span><span class="op" id="8391333">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391337">{</span><span class="ident" id="8391338">NullFloat64</span><span class="op" id="8391349">{</span><span class="num" id="8391350">13.1</span><span class="op" id="8391354">,</span>&nbsp;<span class="builtintype" id="8391356">false</span><span class="op" id="8391361">}</span><span class="op" id="8391362">,</span>&nbsp;<span class="num" id="8391364">1</span><span class="op" id="8391365">,</span>&nbsp;<span class="ident" id="8391367">NullFloat64</span><span class="op" id="8391378">{</span><span class="num" id="8391379">0</span><span class="op" id="8391380">,</span>&nbsp;<span class="builtintype" id="8391382">false</span><span class="op" id="8391387">}</span><span class="op" id="8391388">}</span><span class="op" id="8391389">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391393">{</span><span class="op" id="8391394">-</span><span class="num" id="8391395">22.9</span><span class="op" id="8391399">,</span>&nbsp;<span class="num" id="8391401">1</span><span class="op" id="8391402">,</span>&nbsp;<span class="ident" id="8391404">NullFloat64</span><span class="op" id="8391415">{</span><span class="op" id="8391416">-</span><span class="num" id="8391417">22.9</span><span class="op" id="8391421">,</span>&nbsp;<span class="builtintype" id="8391423">true</span><span class="op" id="8391427">}</span><span class="op" id="8391428">}</span><span class="op" id="8391429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391433">{</span><span class="ident" id="8391434">NullFloat64</span><span class="op" id="8391445">{</span><span class="num" id="8391446">33.81</span><span class="op" id="8391451">,</span>&nbsp;<span class="builtintype" id="8391453">true</span><span class="op" id="8391457">}</span><span class="op" id="8391458">,</span>&nbsp;<span class="num" id="8391460">1</span><span class="op" id="8391461">,</span>&nbsp;<span class="ident" id="8391463">NullFloat64</span><span class="op" id="8391474">{</span><span class="num" id="8391475">33.81</span><span class="op" id="8391480">,</span>&nbsp;<span class="builtintype" id="8391482">true</span><span class="op" id="8391486">}</span><span class="op" id="8391487">}</span><span class="op" id="8391488">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391492">{</span><span class="ident" id="8391493">NullFloat64</span><span class="op" id="8391504">{</span><span class="num" id="8391505">222</span><span class="op" id="8391508">,</span>&nbsp;<span class="builtintype" id="8391510">false</span><span class="op" id="8391515">}</span><span class="op" id="8391516">,</span>&nbsp;<span class="num" id="8391518">1</span><span class="op" id="8391519">,</span>&nbsp;<span class="ident" id="8391521">NullFloat64</span><span class="op" id="8391532">{</span><span class="num" id="8391533">0</span><span class="op" id="8391534">,</span>&nbsp;<span class="builtintype" id="8391536">false</span><span class="op" id="8391541">}</span><span class="op" id="8391542">}</span><span class="op" id="8391543">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391547">{</span><span class="num" id="8391548">10</span><span class="op" id="8391550">,</span>&nbsp;<span class="ident" id="8391552">NullFloat64</span><span class="op" id="8391563">{</span><span class="num" id="8391564">31.2</span><span class="op" id="8391568">,</span>&nbsp;<span class="builtintype" id="8391570">false</span><span class="op" id="8391575">}</span><span class="op" id="8391576">,</span>&nbsp;<span class="builtintype" id="8391578">nil</span><span class="op" id="8391581">}</span><span class="op" id="8391582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391585">}</span><span class="op" id="8391586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8391589">nullTestRun</span><span class="op" id="8391600">(</span><span class="ident" id="8391601">t</span><span class="op" id="8391602">,</span>&nbsp;<span class="ident" id="8391604">spec</span><span class="op" id="8391608">)</span><br>
<span class="lineno"></span><span class="op" id="8391610">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="8391613">func</span>&nbsp;<span class="ident" id="8391618">TestNullBoolParam</span><span class="op" id="8391635">(</span><span class="ident" id="8391636">t</span>&nbsp;<span class="op" id="8391638">*</span><span class="ident" id="8391639">testing</span><span class="op" id="8391646">.</span><span class="ident" id="8391647">T</span><span class="op" id="8391648">)</span>&nbsp;<span class="op" id="8391650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8391653">spec</span>&nbsp;<span class="op" id="8391658">:=</span>&nbsp;<span class="ident" id="8391661">nullTestSpec</span><span class="op" id="8391673">{</span><span class="string" id="8391674">&#34;nullbool&#34;</span><span class="op" id="8391684">,</span>&nbsp;<span class="string" id="8391686">&#34;bool&#34;</span><span class="op" id="8391692">,</span>&nbsp;<span class="op" id="8391694">[</span><span class="num" id="8391695">6</span><span class="op" id="8391696">]</span><span class="ident" id="8391697">nullTestRow</span><span class="op" id="8391708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391712">{</span><span class="ident" id="8391713">NullBool</span><span class="op" id="8391721">{</span><span class="builtintype" id="8391722">false</span><span class="op" id="8391727">,</span>&nbsp;<span class="builtintype" id="8391729">true</span><span class="op" id="8391733">}</span><span class="op" id="8391734">,</span>&nbsp;<span class="builtintype" id="8391736">true</span><span class="op" id="8391740">,</span>&nbsp;<span class="ident" id="8391742">NullBool</span><span class="op" id="8391750">{</span><span class="builtintype" id="8391751">false</span><span class="op" id="8391756">,</span>&nbsp;<span class="builtintype" id="8391758">true</span><span class="op" id="8391762">}</span><span class="op" id="8391763">}</span><span class="op" id="8391764">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391768">{</span><span class="ident" id="8391769">NullBool</span><span class="op" id="8391777">{</span><span class="builtintype" id="8391778">true</span><span class="op" id="8391782">,</span>&nbsp;<span class="builtintype" id="8391784">false</span><span class="op" id="8391789">}</span><span class="op" id="8391790">,</span>&nbsp;<span class="builtintype" id="8391792">false</span><span class="op" id="8391797">,</span>&nbsp;<span class="ident" id="8391799">NullBool</span><span class="op" id="8391807">{</span><span class="builtintype" id="8391808">false</span><span class="op" id="8391813">,</span>&nbsp;<span class="builtintype" id="8391815">false</span><span class="op" id="8391820">}</span><span class="op" id="8391821">}</span><span class="op" id="8391822">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391826">{</span><span class="builtintype" id="8391827">true</span><span class="op" id="8391831">,</span>&nbsp;<span class="builtintype" id="8391833">true</span><span class="op" id="8391837">,</span>&nbsp;<span class="ident" id="8391839">NullBool</span><span class="op" id="8391847">{</span><span class="builtintype" id="8391848">true</span><span class="op" id="8391852">,</span>&nbsp;<span class="builtintype" id="8391854">true</span><span class="op" id="8391858">}</span><span class="op" id="8391859">}</span><span class="op" id="8391860">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391864">{</span><span class="ident" id="8391865">NullBool</span><span class="op" id="8391873">{</span><span class="builtintype" id="8391874">true</span><span class="op" id="8391878">,</span>&nbsp;<span class="builtintype" id="8391880">true</span><span class="op" id="8391884">}</span><span class="op" id="8391885">,</span>&nbsp;<span class="builtintype" id="8391887">false</span><span class="op" id="8391892">,</span>&nbsp;<span class="ident" id="8391894">NullBool</span><span class="op" id="8391902">{</span><span class="builtintype" id="8391903">true</span><span class="op" id="8391907">,</span>&nbsp;<span class="builtintype" id="8391909">true</span><span class="op" id="8391913">}</span><span class="op" id="8391914">}</span><span class="op" id="8391915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391919">{</span><span class="ident" id="8391920">NullBool</span><span class="op" id="8391928">{</span><span class="builtintype" id="8391929">true</span><span class="op" id="8391933">,</span>&nbsp;<span class="builtintype" id="8391935">false</span><span class="op" id="8391940">}</span><span class="op" id="8391941">,</span>&nbsp;<span class="builtintype" id="8391943">true</span><span class="op" id="8391947">,</span>&nbsp;<span class="ident" id="8391949">NullBool</span><span class="op" id="8391957">{</span><span class="builtintype" id="8391958">false</span><span class="op" id="8391963">,</span>&nbsp;<span class="builtintype" id="8391965">false</span><span class="op" id="8391970">}</span><span class="op" id="8391971">}</span><span class="op" id="8391972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8391976">{</span><span class="builtintype" id="8391977">true</span><span class="op" id="8391981">,</span>&nbsp;<span class="ident" id="8391983">NullBool</span><span class="op" id="8391991">{</span><span class="builtintype" id="8391992">true</span><span class="op" id="8391996">,</span>&nbsp;<span class="builtintype" id="8391998">false</span><span class="op" id="8392003">}</span><span class="op" id="8392004">,</span>&nbsp;<span class="builtintype" id="8392006">nil</span><span class="op" id="8392009">}</span><span class="op" id="8392010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8392013">}</span><span class="op" id="8392014">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392017">nullTestRun</span><span class="op" id="8392028">(</span><span class="ident" id="8392029">t</span><span class="op" id="8392030">,</span>&nbsp;<span class="ident" id="8392032">spec</span><span class="op" id="8392036">)</span><br>
<span class="lineno"></span><span class="op" id="8392038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8392041">func</span>&nbsp;<span class="ident" id="8392046">nullTestRun</span><span class="op" id="8392057">(</span><span class="ident" id="8392058">t</span>&nbsp;<span class="op" id="8392060">*</span><span class="ident" id="8392061">testing</span><span class="op" id="8392068">.</span><span class="ident" id="8392069">T</span><span class="op" id="8392070">,</span>&nbsp;<span class="ident" id="8392072">spec</span>&nbsp;<span class="ident" id="8392077">nullTestSpec</span><span class="op" id="8392089">)</span>&nbsp;<span class="op" id="8392091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392094">db</span>&nbsp;<span class="op" id="8392097">:=</span>&nbsp;<span class="ident" id="8392100">newTestDB</span><span class="op" id="8392109">(</span><span class="ident" id="8392110">t</span><span class="op" id="8392111">,</span>&nbsp;<span class="string" id="8392113">&#34;&#34;</span><span class="op" id="8392115">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8392118">defer</span>&nbsp;<span class="ident" id="8392124">closeDB</span><span class="op" id="8392131">(</span><span class="ident" id="8392132">t</span><span class="op" id="8392133">,</span>&nbsp;<span class="ident" id="8392135">db</span><span class="op" id="8392137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392140">exec</span><span class="op" id="8392144">(</span><span class="ident" id="8392145">t</span><span class="op" id="8392146">,</span>&nbsp;<span class="ident" id="8392148">db</span><span class="op" id="8392150">,</span>&nbsp;<span class="ident" id="8392152">fmt</span><span class="op" id="8392155">.</span><span class="ident" id="8392156">Sprintf</span><span class="op" id="8392163">(</span><span class="string" id="8392164">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="8392216">,</span>&nbsp;<span class="ident" id="8392218">spec</span><span class="op" id="8392222">.</span><span class="ident" id="8392223">nullType</span><span class="op" id="8392231">,</span>&nbsp;<span class="ident" id="8392233">spec</span><span class="op" id="8392237">.</span><span class="ident" id="8392238">notNullType</span><span class="op" id="8392249">)</span><span class="op" id="8392250">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8392254">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392280">exec</span><span class="op" id="8392284">(</span><span class="ident" id="8392285">t</span><span class="op" id="8392286">,</span>&nbsp;<span class="ident" id="8392288">db</span><span class="op" id="8392290">,</span>&nbsp;<span class="string" id="8392292">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8392333">,</span>&nbsp;<span class="num" id="8392335">1</span><span class="op" id="8392336">,</span>&nbsp;<span class="string" id="8392338">&#34;alice&#34;</span><span class="op" id="8392345">,</span>&nbsp;<span class="ident" id="8392347">spec</span><span class="op" id="8392351">.</span><span class="ident" id="8392352">rows</span><span class="op" id="8392356">[</span><span class="num" id="8392357">0</span><span class="op" id="8392358">]</span><span class="op" id="8392359">.</span><span class="ident" id="8392360">nullParam</span><span class="op" id="8392369">,</span>&nbsp;<span class="ident" id="8392371">spec</span><span class="op" id="8392375">.</span><span class="ident" id="8392376">rows</span><span class="op" id="8392380">[</span><span class="num" id="8392381">0</span><span class="op" id="8392382">]</span><span class="op" id="8392383">.</span><span class="ident" id="8392384">notNullParam</span><span class="op" id="8392396">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392399">exec</span><span class="op" id="8392403">(</span><span class="ident" id="8392404">t</span><span class="op" id="8392405">,</span>&nbsp;<span class="ident" id="8392407">db</span><span class="op" id="8392409">,</span>&nbsp;<span class="string" id="8392411">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8392452">,</span>&nbsp;<span class="num" id="8392454">2</span><span class="op" id="8392455">,</span>&nbsp;<span class="string" id="8392457">&#34;bob&#34;</span><span class="op" id="8392462">,</span>&nbsp;<span class="ident" id="8392464">spec</span><span class="op" id="8392468">.</span><span class="ident" id="8392469">rows</span><span class="op" id="8392473">[</span><span class="num" id="8392474">1</span><span class="op" id="8392475">]</span><span class="op" id="8392476">.</span><span class="ident" id="8392477">nullParam</span><span class="op" id="8392486">,</span>&nbsp;<span class="ident" id="8392488">spec</span><span class="op" id="8392492">.</span><span class="ident" id="8392493">rows</span><span class="op" id="8392497">[</span><span class="num" id="8392498">1</span><span class="op" id="8392499">]</span><span class="op" id="8392500">.</span><span class="ident" id="8392501">notNullParam</span><span class="op" id="8392513">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8392517">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392556">stmt</span><span class="op" id="8392560">,</span>&nbsp;<span class="ident" id="8392562">err</span>&nbsp;<span class="op" id="8392566">:=</span>&nbsp;<span class="ident" id="8392569">db</span><span class="op" id="8392571">.</span><span class="ident" id="8392572">Prepare</span><span class="op" id="8392579">(</span><span class="string" id="8392580">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8392621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8392624">if</span>&nbsp;<span class="ident" id="8392627">err</span>&nbsp;<span class="op" id="8392631">!=</span>&nbsp;<span class="builtintype" id="8392634">nil</span>&nbsp;<span class="op" id="8392638">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392642">t</span><span class="op" id="8392643">.</span><span class="ident" id="8392644">Fatalf</span><span class="op" id="8392650">(</span><span class="string" id="8392651">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8392664">,</span>&nbsp;<span class="ident" id="8392666">err</span><span class="op" id="8392669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8392672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8392675">defer</span>&nbsp;<span class="ident" id="8392681">stmt</span><span class="op" id="8392685">.</span><span class="ident" id="8392686">Close</span><span class="op" id="8392691">(</span><span class="op" id="8392692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8392695">if</span>&nbsp;<span class="ident" id="8392698">_</span><span class="op" id="8392699">,</span>&nbsp;<span class="ident" id="8392701">err</span>&nbsp;<span class="op" id="8392705">:=</span>&nbsp;<span class="ident" id="8392708">stmt</span><span class="op" id="8392712">.</span><span class="ident" id="8392713">Exec</span><span class="op" id="8392717">(</span><span class="num" id="8392718">3</span><span class="op" id="8392719">,</span>&nbsp;<span class="string" id="8392721">&#34;chris&#34;</span><span class="op" id="8392728">,</span>&nbsp;<span class="ident" id="8392730">spec</span><span class="op" id="8392734">.</span><span class="ident" id="8392735">rows</span><span class="op" id="8392739">[</span><span class="num" id="8392740">2</span><span class="op" id="8392741">]</span><span class="op" id="8392742">.</span><span class="ident" id="8392743">nullParam</span><span class="op" id="8392752">,</span>&nbsp;<span class="ident" id="8392754">spec</span><span class="op" id="8392758">.</span><span class="ident" id="8392759">rows</span><span class="op" id="8392763">[</span><span class="num" id="8392764">2</span><span class="op" id="8392765">]</span><span class="op" id="8392766">.</span><span class="ident" id="8392767">notNullParam</span><span class="op" id="8392779">)</span><span class="op" id="8392780">;</span>&nbsp;<span class="ident" id="8392782">err</span>&nbsp;<span class="op" id="8392786">!=</span>&nbsp;<span class="builtintype" id="8392789">nil</span>&nbsp;<span class="op" id="8392793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392797">t</span><span class="op" id="8392798">.</span><span class="ident" id="8392799">Errorf</span><span class="op" id="8392805">(</span><span class="string" id="8392806">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="8392829">,</span>&nbsp;<span class="ident" id="8392831">err</span><span class="op" id="8392834">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8392837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8392840">if</span>&nbsp;<span class="ident" id="8392843">_</span><span class="op" id="8392844">,</span>&nbsp;<span class="ident" id="8392846">err</span>&nbsp;<span class="op" id="8392850">:=</span>&nbsp;<span class="ident" id="8392853">stmt</span><span class="op" id="8392857">.</span><span class="ident" id="8392858">Exec</span><span class="op" id="8392862">(</span><span class="num" id="8392863">4</span><span class="op" id="8392864">,</span>&nbsp;<span class="string" id="8392866">&#34;dave&#34;</span><span class="op" id="8392872">,</span>&nbsp;<span class="ident" id="8392874">spec</span><span class="op" id="8392878">.</span><span class="ident" id="8392879">rows</span><span class="op" id="8392883">[</span><span class="num" id="8392884">3</span><span class="op" id="8392885">]</span><span class="op" id="8392886">.</span><span class="ident" id="8392887">nullParam</span><span class="op" id="8392896">,</span>&nbsp;<span class="ident" id="8392898">spec</span><span class="op" id="8392902">.</span><span class="ident" id="8392903">rows</span><span class="op" id="8392907">[</span><span class="num" id="8392908">3</span><span class="op" id="8392909">]</span><span class="op" id="8392910">.</span><span class="ident" id="8392911">notNullParam</span><span class="op" id="8392923">)</span><span class="op" id="8392924">;</span>&nbsp;<span class="ident" id="8392926">err</span>&nbsp;<span class="op" id="8392930">!=</span>&nbsp;<span class="builtintype" id="8392933">nil</span>&nbsp;<span class="op" id="8392937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8392941">t</span><span class="op" id="8392942">.</span><span class="ident" id="8392943">Errorf</span><span class="op" id="8392949">(</span><span class="string" id="8392950">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="8392972">,</span>&nbsp;<span class="ident" id="8392974">err</span><span class="op" id="8392977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8392980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8392983">if</span>&nbsp;<span class="ident" id="8392986">_</span><span class="op" id="8392987">,</span>&nbsp;<span class="ident" id="8392989">err</span>&nbsp;<span class="op" id="8392993">:=</span>&nbsp;<span class="ident" id="8392996">stmt</span><span class="op" id="8393000">.</span><span class="ident" id="8393001">Exec</span><span class="op" id="8393005">(</span><span class="num" id="8393006">5</span><span class="op" id="8393007">,</span>&nbsp;<span class="string" id="8393009">&#34;eleanor&#34;</span><span class="op" id="8393018">,</span>&nbsp;<span class="ident" id="8393020">spec</span><span class="op" id="8393024">.</span><span class="ident" id="8393025">rows</span><span class="op" id="8393029">[</span><span class="num" id="8393030">4</span><span class="op" id="8393031">]</span><span class="op" id="8393032">.</span><span class="ident" id="8393033">nullParam</span><span class="op" id="8393042">,</span>&nbsp;<span class="ident" id="8393044">spec</span><span class="op" id="8393048">.</span><span class="ident" id="8393049">rows</span><span class="op" id="8393053">[</span><span class="num" id="8393054">4</span><span class="op" id="8393055">]</span><span class="op" id="8393056">.</span><span class="ident" id="8393057">notNullParam</span><span class="op" id="8393069">)</span><span class="op" id="8393070">;</span>&nbsp;<span class="ident" id="8393072">err</span>&nbsp;<span class="op" id="8393076">!=</span>&nbsp;<span class="builtintype" id="8393079">nil</span>&nbsp;<span class="op" id="8393083">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8393087">t</span><span class="op" id="8393088">.</span><span class="ident" id="8393089">Errorf</span><span class="op" id="8393095">(</span><span class="string" id="8393096">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="8393121">,</span>&nbsp;<span class="ident" id="8393123">err</span><span class="op" id="8393126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8393129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8393133">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8393174">if</span>&nbsp;<span class="ident" id="8393177">_</span><span class="op" id="8393178">,</span>&nbsp;<span class="ident" id="8393180">err</span>&nbsp;<span class="op" id="8393184">:=</span>&nbsp;<span class="ident" id="8393187">stmt</span><span class="op" id="8393191">.</span><span class="ident" id="8393192">Exec</span><span class="op" id="8393196">(</span><span class="num" id="8393197">6</span><span class="op" id="8393198">,</span>&nbsp;<span class="string" id="8393200">&#34;bob&#34;</span><span class="op" id="8393205">,</span>&nbsp;<span class="ident" id="8393207">spec</span><span class="op" id="8393211">.</span><span class="ident" id="8393212">rows</span><span class="op" id="8393216">[</span><span class="num" id="8393217">5</span><span class="op" id="8393218">]</span><span class="op" id="8393219">.</span><span class="ident" id="8393220">nullParam</span><span class="op" id="8393229">,</span>&nbsp;<span class="ident" id="8393231">spec</span><span class="op" id="8393235">.</span><span class="ident" id="8393236">rows</span><span class="op" id="8393240">[</span><span class="num" id="8393241">5</span><span class="op" id="8393242">]</span><span class="op" id="8393243">.</span><span class="ident" id="8393244">notNullParam</span><span class="op" id="8393256">)</span><span class="op" id="8393257">;</span>&nbsp;<span class="ident" id="8393259">err</span>&nbsp;<span class="op" id="8393263">==</span>&nbsp;<span class="builtintype" id="8393266">nil</span>&nbsp;<span class="op" id="8393270">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8393274">t</span><span class="op" id="8393275">.</span><span class="ident" id="8393276">Errorf</span><span class="op" id="8393282">(</span><span class="string" id="8393283">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="8393346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8393349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8393353">_</span><span class="op" id="8393354">,</span>&nbsp;<span class="ident" id="8393356">err</span>&nbsp;<span class="op" id="8393360">=</span>&nbsp;<span class="ident" id="8393362">db</span><span class="op" id="8393364">.</span><span class="ident" id="8393365">Exec</span><span class="op" id="8393369">(</span><span class="string" id="8393370">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="8393400">,</span>&nbsp;<span class="num" id="8393402">999</span><span class="op" id="8393405">,</span>&nbsp;<span class="builtintype" id="8393407">nil</span><span class="op" id="8393410">,</span>&nbsp;<span class="builtintype" id="8393412">nil</span><span class="op" id="8393415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8393418">if</span>&nbsp;<span class="ident" id="8393421">err</span>&nbsp;<span class="op" id="8393425">==</span>&nbsp;<span class="builtintype" id="8393428">nil</span>&nbsp;<span class="op" id="8393432">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8393436">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8393486">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8393542">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8393594">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8393642">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8393686">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8393746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8393750">paramtype</span>&nbsp;<span class="op" id="8393760">:=</span>&nbsp;<span class="ident" id="8393763">reflect</span><span class="op" id="8393770">.</span><span class="ident" id="8393771">TypeOf</span><span class="op" id="8393777">(</span><span class="ident" id="8393778">spec</span><span class="op" id="8393782">.</span><span class="ident" id="8393783">rows</span><span class="op" id="8393787">[</span><span class="num" id="8393788">0</span><span class="op" id="8393789">]</span><span class="op" id="8393790">.</span><span class="ident" id="8393791">nullParam</span><span class="op" id="8393800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8393803">bindVal</span>&nbsp;<span class="op" id="8393811">:=</span>&nbsp;<span class="ident" id="8393814">reflect</span><span class="op" id="8393821">.</span><span class="ident" id="8393822">New</span><span class="op" id="8393825">(</span><span class="ident" id="8393826">paramtype</span><span class="op" id="8393835">)</span><span class="op" id="8393836">.</span><span class="ident" id="8393837">Interface</span><span class="op" id="8393846">(</span><span class="op" id="8393847">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8393851">for</span>&nbsp;<span class="ident" id="8393855">i</span>&nbsp;<span class="op" id="8393857">:=</span>&nbsp;<span class="num" id="8393860">0</span><span class="op" id="8393861">;</span>&nbsp;<span class="ident" id="8393863">i</span>&nbsp;<span class="op" id="8393865">&lt;</span>&nbsp;<span class="num" id="8393867">5</span><span class="op" id="8393868">;</span>&nbsp;<span class="ident" id="8393870">i</span><span class="op" id="8393871">++</span>&nbsp;<span class="op" id="8393874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8393878">id</span>&nbsp;<span class="op" id="8393881">:=</span>&nbsp;<span class="ident" id="8393884">i</span>&nbsp;<span class="op" id="8393886">+</span>&nbsp;<span class="num" id="8393888">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8393892">if</span>&nbsp;<span class="ident" id="8393895">err</span>&nbsp;<span class="op" id="8393899">:=</span>&nbsp;<span class="ident" id="8393902">db</span><span class="op" id="8393904">.</span><span class="ident" id="8393905">QueryRow</span><span class="op" id="8393913">(</span><span class="string" id="8393914">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="8393935">,</span>&nbsp;<span class="ident" id="8393937">id</span><span class="op" id="8393939">)</span><span class="op" id="8393940">.</span><span class="ident" id="8393941">Scan</span><span class="op" id="8393945">(</span><span class="ident" id="8393946">bindVal</span><span class="op" id="8393953">)</span><span class="op" id="8393954">;</span>&nbsp;<span class="ident" id="8393956">err</span>&nbsp;<span class="op" id="8393960">!=</span>&nbsp;<span class="builtintype" id="8393963">nil</span>&nbsp;<span class="op" id="8393967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8393972">t</span><span class="op" id="8393973">.</span><span class="ident" id="8393974">Errorf</span><span class="op" id="8393980">(</span><span class="string" id="8393981">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="8393997">,</span>&nbsp;<span class="ident" id="8393999">id</span><span class="op" id="8394001">,</span>&nbsp;<span class="ident" id="8394003">err</span><span class="op" id="8394006">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8394010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394014">bindValDeref</span>&nbsp;<span class="op" id="8394027">:=</span>&nbsp;<span class="ident" id="8394030">reflect</span><span class="op" id="8394037">.</span><span class="ident" id="8394038">ValueOf</span><span class="op" id="8394045">(</span><span class="ident" id="8394046">bindVal</span><span class="op" id="8394053">)</span><span class="op" id="8394054">.</span><span class="ident" id="8394055">Elem</span><span class="op" id="8394059">(</span><span class="op" id="8394060">)</span><span class="op" id="8394061">.</span><span class="ident" id="8394062">Interface</span><span class="op" id="8394071">(</span><span class="op" id="8394072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394076">if</span>&nbsp;<span class="op" id="8394079">!</span><span class="ident" id="8394080">reflect</span><span class="op" id="8394087">.</span><span class="ident" id="8394088">DeepEqual</span><span class="op" id="8394097">(</span><span class="ident" id="8394098">bindValDeref</span><span class="op" id="8394110">,</span>&nbsp;<span class="ident" id="8394112">spec</span><span class="op" id="8394116">.</span><span class="ident" id="8394117">rows</span><span class="op" id="8394121">[</span><span class="ident" id="8394122">i</span><span class="op" id="8394123">]</span><span class="op" id="8394124">.</span><span class="ident" id="8394125">scanNullVal</span><span class="op" id="8394136">)</span>&nbsp;<span class="op" id="8394138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394143">t</span><span class="op" id="8394144">.</span><span class="ident" id="8394145">Errorf</span><span class="op" id="8394151">(</span><span class="string" id="8394152">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8394177">,</span>&nbsp;<span class="ident" id="8394179">id</span><span class="op" id="8394181">,</span>&nbsp;<span class="ident" id="8394183">bindValDeref</span><span class="op" id="8394195">,</span>&nbsp;<span class="ident" id="8394197">spec</span><span class="op" id="8394201">.</span><span class="ident" id="8394202">rows</span><span class="op" id="8394206">[</span><span class="ident" id="8394207">i</span><span class="op" id="8394208">]</span><span class="op" id="8394209">.</span><span class="ident" id="8394210">scanNullVal</span><span class="op" id="8394221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8394225">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8394228">}</span><br>
<span class="lineno"></span><span class="op" id="8394230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8394233">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="8394258">func</span>&nbsp;<span class="ident" id="8394263">TestQueryRowNilScanDest</span><span class="op" id="8394286">(</span><span class="ident" id="8394287">t</span>&nbsp;<span class="op" id="8394289">*</span><span class="ident" id="8394290">testing</span><span class="op" id="8394297">.</span><span class="ident" id="8394298">T</span><span class="op" id="8394299">)</span>&nbsp;<span class="op" id="8394301">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394304">db</span>&nbsp;<span class="op" id="8394307">:=</span>&nbsp;<span class="ident" id="8394310">newTestDB</span><span class="op" id="8394319">(</span><span class="ident" id="8394320">t</span><span class="op" id="8394321">,</span>&nbsp;<span class="string" id="8394323">&#34;people&#34;</span><span class="op" id="8394331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394334">defer</span>&nbsp;<span class="ident" id="8394340">closeDB</span><span class="op" id="8394347">(</span><span class="ident" id="8394348">t</span><span class="op" id="8394349">,</span>&nbsp;<span class="ident" id="8394351">db</span><span class="op" id="8394353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394356">var</span>&nbsp;<span class="ident" id="8394360">name</span>&nbsp;<span class="op" id="8394365">*</span><span class="builtintype" id="8394366">string</span>&nbsp;<span class="comment" id="8394373">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394389">err</span>&nbsp;<span class="op" id="8394393">:=</span>&nbsp;<span class="ident" id="8394396">db</span><span class="op" id="8394398">.</span><span class="ident" id="8394399">QueryRow</span><span class="op" id="8394407">(</span><span class="string" id="8394408">&#34;SELECT|people|name|&#34;</span><span class="op" id="8394429">)</span><span class="op" id="8394430">.</span><span class="ident" id="8394431">Scan</span><span class="op" id="8394435">(</span><span class="ident" id="8394436">name</span><span class="op" id="8394440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394443">want</span>&nbsp;<span class="op" id="8394448">:=</span>&nbsp;<span class="string" id="8394451">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394516">if</span>&nbsp;<span class="ident" id="8394519">err</span>&nbsp;<span class="op" id="8394523">==</span>&nbsp;<span class="builtintype" id="8394526">nil</span>&nbsp;<span class="op" id="8394530">||</span>&nbsp;<span class="ident" id="8394533">err</span><span class="op" id="8394536">.</span><span class="ident" id="8394537">Error</span><span class="op" id="8394542">(</span><span class="op" id="8394543">)</span>&nbsp;<span class="op" id="8394545">!=</span>&nbsp;<span class="ident" id="8394548">want</span>&nbsp;<span class="op" id="8394553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394557">t</span><span class="op" id="8394558">.</span><span class="ident" id="8394559">Errorf</span><span class="op" id="8394565">(</span><span class="string" id="8394566">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8394587">,</span>&nbsp;<span class="ident" id="8394589">err</span><span class="op" id="8394592">.</span><span class="ident" id="8394593">Error</span><span class="op" id="8394598">(</span><span class="op" id="8394599">)</span><span class="op" id="8394600">,</span>&nbsp;<span class="ident" id="8394602">want</span><span class="op" id="8394606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8394609">}</span><br>
<span class="lineno"></span><span class="op" id="8394611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="8394614">func</span>&nbsp;<span class="ident" id="8394619">TestIssue4902</span><span class="op" id="8394632">(</span><span class="ident" id="8394633">t</span>&nbsp;<span class="op" id="8394635">*</span><span class="ident" id="8394636">testing</span><span class="op" id="8394643">.</span><span class="ident" id="8394644">T</span><span class="op" id="8394645">)</span>&nbsp;<span class="op" id="8394647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394650">db</span>&nbsp;<span class="op" id="8394653">:=</span>&nbsp;<span class="ident" id="8394656">newTestDB</span><span class="op" id="8394665">(</span><span class="ident" id="8394666">t</span><span class="op" id="8394667">,</span>&nbsp;<span class="string" id="8394669">&#34;people&#34;</span><span class="op" id="8394677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394680">defer</span>&nbsp;<span class="ident" id="8394686">closeDB</span><span class="op" id="8394693">(</span><span class="ident" id="8394694">t</span><span class="op" id="8394695">,</span>&nbsp;<span class="ident" id="8394697">db</span><span class="op" id="8394699">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394703">driver</span>&nbsp;<span class="op" id="8394710">:=</span>&nbsp;<span class="ident" id="8394713">db</span><span class="op" id="8394715">.</span><span class="ident" id="8394716">driver</span><span class="op" id="8394722">.</span><span class="op" id="8394723">(</span><span class="op" id="8394724">*</span><span class="ident" id="8394725">fakeDriver</span><span class="op" id="8394735">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394738">opens0</span>&nbsp;<span class="op" id="8394745">:=</span>&nbsp;<span class="ident" id="8394748">driver</span><span class="op" id="8394754">.</span><span class="ident" id="8394755">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394767">var</span>&nbsp;<span class="ident" id="8394771">stmt</span>&nbsp;<span class="op" id="8394776">*</span><span class="ident" id="8394777">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394783">var</span>&nbsp;<span class="ident" id="8394787">err</span>&nbsp;<span class="builtintype" id="8394791">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394798">for</span>&nbsp;<span class="ident" id="8394802">i</span>&nbsp;<span class="op" id="8394804">:=</span>&nbsp;<span class="num" id="8394807">0</span><span class="op" id="8394808">;</span>&nbsp;<span class="ident" id="8394810">i</span>&nbsp;<span class="op" id="8394812">&lt;</span>&nbsp;<span class="num" id="8394814">10</span><span class="op" id="8394816">;</span>&nbsp;<span class="ident" id="8394818">i</span><span class="op" id="8394819">++</span>&nbsp;<span class="op" id="8394822">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394826">stmt</span><span class="op" id="8394830">,</span>&nbsp;<span class="ident" id="8394832">err</span>&nbsp;<span class="op" id="8394836">=</span>&nbsp;<span class="ident" id="8394838">db</span><span class="op" id="8394840">.</span><span class="ident" id="8394841">Prepare</span><span class="op" id="8394848">(</span><span class="string" id="8394849">&#34;SELECT|people|name|&#34;</span><span class="op" id="8394870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394874">if</span>&nbsp;<span class="ident" id="8394877">err</span>&nbsp;<span class="op" id="8394881">!=</span>&nbsp;<span class="builtintype" id="8394884">nil</span>&nbsp;<span class="op" id="8394888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394893">t</span><span class="op" id="8394894">.</span><span class="ident" id="8394895">Fatal</span><span class="op" id="8394900">(</span><span class="ident" id="8394901">err</span><span class="op" id="8394904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8394908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394912">err</span>&nbsp;<span class="op" id="8394916">=</span>&nbsp;<span class="ident" id="8394918">stmt</span><span class="op" id="8394922">.</span><span class="ident" id="8394923">Close</span><span class="op" id="8394928">(</span><span class="op" id="8394929">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8394933">if</span>&nbsp;<span class="ident" id="8394936">err</span>&nbsp;<span class="op" id="8394940">!=</span>&nbsp;<span class="builtintype" id="8394943">nil</span>&nbsp;<span class="op" id="8394947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394952">t</span><span class="op" id="8394953">.</span><span class="ident" id="8394954">Fatal</span><span class="op" id="8394959">(</span><span class="ident" id="8394960">err</span><span class="op" id="8394963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8394967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8394970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8394974">opens</span>&nbsp;<span class="op" id="8394980">:=</span>&nbsp;<span class="ident" id="8394983">driver</span><span class="op" id="8394989">.</span><span class="ident" id="8394990">openCount</span>&nbsp;<span class="op" id="8395000">-</span>&nbsp;<span class="ident" id="8395002">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395010">if</span>&nbsp;<span class="ident" id="8395013">opens</span>&nbsp;<span class="op" id="8395019">&gt;</span>&nbsp;<span class="num" id="8395021">1</span>&nbsp;<span class="op" id="8395023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395027">t</span><span class="op" id="8395028">.</span><span class="ident" id="8395029">Errorf</span><span class="op" id="8395035">(</span><span class="string" id="8395036">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="8395059">,</span>&nbsp;<span class="ident" id="8395061">opens</span><span class="op" id="8395066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395070">t</span><span class="op" id="8395071">.</span><span class="ident" id="8395072">Logf</span><span class="op" id="8395076">(</span><span class="string" id="8395077">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8395087">,</span>&nbsp;<span class="ident" id="8395089">db</span><span class="op" id="8395091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395095">t</span><span class="op" id="8395096">.</span><span class="ident" id="8395097">Logf</span><span class="op" id="8395101">(</span><span class="string" id="8395102">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8395116">,</span>&nbsp;<span class="ident" id="8395118">driver</span><span class="op" id="8395124">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395128">t</span><span class="op" id="8395129">.</span><span class="ident" id="8395130">Logf</span><span class="op" id="8395134">(</span><span class="string" id="8395135">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8395147">,</span>&nbsp;<span class="ident" id="8395149">stmt</span><span class="op" id="8395153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8395156">}</span><br>
<span class="lineno"></span><span class="op" id="8395158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8395161">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="8395175">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="8395201">func</span>&nbsp;<span class="ident" id="8395206">TestSimultaneousQueries</span><span class="op" id="8395229">(</span><span class="ident" id="8395230">t</span>&nbsp;<span class="op" id="8395232">*</span><span class="ident" id="8395233">testing</span><span class="op" id="8395240">.</span><span class="ident" id="8395241">T</span><span class="op" id="8395242">)</span>&nbsp;<span class="op" id="8395244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395247">db</span>&nbsp;<span class="op" id="8395250">:=</span>&nbsp;<span class="ident" id="8395253">newTestDB</span><span class="op" id="8395262">(</span><span class="ident" id="8395263">t</span><span class="op" id="8395264">,</span>&nbsp;<span class="string" id="8395266">&#34;people&#34;</span><span class="op" id="8395274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395277">defer</span>&nbsp;<span class="ident" id="8395283">closeDB</span><span class="op" id="8395290">(</span><span class="ident" id="8395291">t</span><span class="op" id="8395292">,</span>&nbsp;<span class="ident" id="8395294">db</span><span class="op" id="8395296">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395300">tx</span><span class="op" id="8395302">,</span>&nbsp;<span class="ident" id="8395304">err</span>&nbsp;<span class="op" id="8395308">:=</span>&nbsp;<span class="ident" id="8395311">db</span><span class="op" id="8395313">.</span><span class="ident" id="8395314">Begin</span><span class="op" id="8395319">(</span><span class="op" id="8395320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395323">if</span>&nbsp;<span class="ident" id="8395326">err</span>&nbsp;<span class="op" id="8395330">!=</span>&nbsp;<span class="builtintype" id="8395333">nil</span>&nbsp;<span class="op" id="8395337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395341">t</span><span class="op" id="8395342">.</span><span class="ident" id="8395343">Fatal</span><span class="op" id="8395348">(</span><span class="ident" id="8395349">err</span><span class="op" id="8395352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8395355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395358">defer</span>&nbsp;<span class="ident" id="8395364">tx</span><span class="op" id="8395366">.</span><span class="ident" id="8395367">Rollback</span><span class="op" id="8395375">(</span><span class="op" id="8395376">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395380">r1</span><span class="op" id="8395382">,</span>&nbsp;<span class="ident" id="8395384">err</span>&nbsp;<span class="op" id="8395388">:=</span>&nbsp;<span class="ident" id="8395391">tx</span><span class="op" id="8395393">.</span><span class="ident" id="8395394">Query</span><span class="op" id="8395399">(</span><span class="string" id="8395400">&#34;SELECT|people|name|&#34;</span><span class="op" id="8395421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395424">if</span>&nbsp;<span class="ident" id="8395427">err</span>&nbsp;<span class="op" id="8395431">!=</span>&nbsp;<span class="builtintype" id="8395434">nil</span>&nbsp;<span class="op" id="8395438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395442">t</span><span class="op" id="8395443">.</span><span class="ident" id="8395444">Fatal</span><span class="op" id="8395449">(</span><span class="ident" id="8395450">err</span><span class="op" id="8395453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8395456">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395459">defer</span>&nbsp;<span class="ident" id="8395465">r1</span><span class="op" id="8395467">.</span><span class="ident" id="8395468">Close</span><span class="op" id="8395473">(</span><span class="op" id="8395474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395478">r2</span><span class="op" id="8395480">,</span>&nbsp;<span class="ident" id="8395482">err</span>&nbsp;<span class="op" id="8395486">:=</span>&nbsp;<span class="ident" id="8395489">tx</span><span class="op" id="8395491">.</span><span class="ident" id="8395492">Query</span><span class="op" id="8395497">(</span><span class="string" id="8395498">&#34;SELECT|people|name|&#34;</span><span class="op" id="8395519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395522">if</span>&nbsp;<span class="ident" id="8395525">err</span>&nbsp;<span class="op" id="8395529">!=</span>&nbsp;<span class="builtintype" id="8395532">nil</span>&nbsp;<span class="op" id="8395536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395540">t</span><span class="op" id="8395541">.</span><span class="ident" id="8395542">Fatal</span><span class="op" id="8395547">(</span><span class="ident" id="8395548">err</span><span class="op" id="8395551">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8395554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395557">defer</span>&nbsp;<span class="ident" id="8395563">r2</span><span class="op" id="8395565">.</span><span class="ident" id="8395566">Close</span><span class="op" id="8395571">(</span><span class="op" id="8395572">)</span><br>
<span class="lineno"></span><span class="op" id="8395574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8395577">func</span>&nbsp;<span class="ident" id="8395582">TestMaxIdleConns</span><span class="op" id="8395598">(</span><span class="ident" id="8395599">t</span>&nbsp;<span class="op" id="8395601">*</span><span class="ident" id="8395602">testing</span><span class="op" id="8395609">.</span><span class="ident" id="8395610">T</span><span class="op" id="8395611">)</span>&nbsp;<span class="op" id="8395613">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395616">db</span>&nbsp;<span class="op" id="8395619">:=</span>&nbsp;<span class="ident" id="8395622">newTestDB</span><span class="op" id="8395631">(</span><span class="ident" id="8395632">t</span><span class="op" id="8395633">,</span>&nbsp;<span class="string" id="8395635">&#34;people&#34;</span><span class="op" id="8395643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395646">defer</span>&nbsp;<span class="ident" id="8395652">closeDB</span><span class="op" id="8395659">(</span><span class="ident" id="8395660">t</span><span class="op" id="8395661">,</span>&nbsp;<span class="ident" id="8395663">db</span><span class="op" id="8395665">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395669">tx</span><span class="op" id="8395671">,</span>&nbsp;<span class="ident" id="8395673">err</span>&nbsp;<span class="op" id="8395677">:=</span>&nbsp;<span class="ident" id="8395680">db</span><span class="op" id="8395682">.</span><span class="ident" id="8395683">Begin</span><span class="op" id="8395688">(</span><span class="op" id="8395689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395692">if</span>&nbsp;<span class="ident" id="8395695">err</span>&nbsp;<span class="op" id="8395699">!=</span>&nbsp;<span class="builtintype" id="8395702">nil</span>&nbsp;<span class="op" id="8395706">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395710">t</span><span class="op" id="8395711">.</span><span class="ident" id="8395712">Fatal</span><span class="op" id="8395717">(</span><span class="ident" id="8395718">err</span><span class="op" id="8395721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8395724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395727">tx</span><span class="op" id="8395729">.</span><span class="ident" id="8395730">Commit</span><span class="op" id="8395736">(</span><span class="op" id="8395737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395740">if</span>&nbsp;<span class="ident" id="8395743">got</span>&nbsp;<span class="op" id="8395747">:=</span>&nbsp;<span class="builtinfunc" id="8395750">len</span><span class="op" id="8395753">(</span><span class="ident" id="8395754">db</span><span class="op" id="8395756">.</span><span class="ident" id="8395757">freeConn</span><span class="op" id="8395765">)</span><span class="op" id="8395766">;</span>&nbsp;<span class="ident" id="8395768">got</span>&nbsp;<span class="op" id="8395772">!=</span>&nbsp;<span class="num" id="8395775">1</span>&nbsp;<span class="op" id="8395777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395781">t</span><span class="op" id="8395782">.</span><span class="ident" id="8395783">Errorf</span><span class="op" id="8395789">(</span><span class="string" id="8395790">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8395814">,</span>&nbsp;<span class="ident" id="8395816">got</span><span class="op" id="8395819">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8395822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395826">db</span><span class="op" id="8395828">.</span><span class="ident" id="8395829">SetMaxIdleConns</span><span class="op" id="8395844">(</span><span class="num" id="8395845">0</span><span class="op" id="8395846">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395850">if</span>&nbsp;<span class="ident" id="8395853">got</span>&nbsp;<span class="op" id="8395857">:=</span>&nbsp;<span class="builtinfunc" id="8395860">len</span><span class="op" id="8395863">(</span><span class="ident" id="8395864">db</span><span class="op" id="8395866">.</span><span class="ident" id="8395867">freeConn</span><span class="op" id="8395875">)</span><span class="op" id="8395876">;</span>&nbsp;<span class="ident" id="8395878">got</span>&nbsp;<span class="op" id="8395882">!=</span>&nbsp;<span class="num" id="8395885">0</span>&nbsp;<span class="op" id="8395887">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395891">t</span><span class="op" id="8395892">.</span><span class="ident" id="8395893">Errorf</span><span class="op" id="8395899">(</span><span class="string" id="8395900">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8395942">,</span>&nbsp;<span class="ident" id="8395944">got</span><span class="op" id="8395947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8395950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395954">tx</span><span class="op" id="8395956">,</span>&nbsp;<span class="ident" id="8395958">err</span>&nbsp;<span class="op" id="8395962">=</span>&nbsp;<span class="ident" id="8395964">db</span><span class="op" id="8395966">.</span><span class="ident" id="8395967">Begin</span><span class="op" id="8395972">(</span><span class="op" id="8395973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8395976">if</span>&nbsp;<span class="ident" id="8395979">err</span>&nbsp;<span class="op" id="8395983">!=</span>&nbsp;<span class="builtintype" id="8395986">nil</span>&nbsp;<span class="op" id="8395990">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8395994">t</span><span class="op" id="8395995">.</span><span class="ident" id="8395996">Fatal</span><span class="op" id="8396001">(</span><span class="ident" id="8396002">err</span><span class="op" id="8396005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8396008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396011">tx</span><span class="op" id="8396013">.</span><span class="ident" id="8396014">Commit</span><span class="op" id="8396020">(</span><span class="op" id="8396021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8396024">if</span>&nbsp;<span class="ident" id="8396027">got</span>&nbsp;<span class="op" id="8396031">:=</span>&nbsp;<span class="builtinfunc" id="8396034">len</span><span class="op" id="8396037">(</span><span class="ident" id="8396038">db</span><span class="op" id="8396040">.</span><span class="ident" id="8396041">freeConn</span><span class="op" id="8396049">)</span><span class="op" id="8396050">;</span>&nbsp;<span class="ident" id="8396052">got</span>&nbsp;<span class="op" id="8396056">!=</span>&nbsp;<span class="num" id="8396059">0</span>&nbsp;<span class="op" id="8396061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396065">t</span><span class="op" id="8396066">.</span><span class="ident" id="8396067">Errorf</span><span class="op" id="8396073">(</span><span class="string" id="8396074">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8396098">,</span>&nbsp;<span class="ident" id="8396100">got</span><span class="op" id="8396103">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8396106">}</span><br>
<span class="lineno"></span><span class="op" id="8396108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8396111">func</span>&nbsp;<span class="ident" id="8396116">TestMaxOpenConns</span><span class="op" id="8396132">(</span><span class="ident" id="8396133">t</span>&nbsp;<span class="op" id="8396135">*</span><span class="ident" id="8396136">testing</span><span class="op" id="8396143">.</span><span class="ident" id="8396144">T</span><span class="op" id="8396145">)</span>&nbsp;<span class="op" id="8396147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8396150">if</span>&nbsp;<span class="ident" id="8396153">testing</span><span class="op" id="8396160">.</span><span class="ident" id="8396161">Short</span><span class="op" id="8396166">(</span><span class="op" id="8396167">)</span>&nbsp;<span class="op" id="8396169">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396173">t</span><span class="op" id="8396174">.</span><span class="ident" id="8396175">Skip</span><span class="op" id="8396179">(</span><span class="string" id="8396180">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8396204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8396207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8396210">defer</span>&nbsp;<span class="ident" id="8396216">setHookpostCloseConn</span><span class="op" id="8396236">(</span><span class="builtintype" id="8396237">nil</span><span class="op" id="8396240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396243">setHookpostCloseConn</span><span class="op" id="8396263">(</span><span class="keyword" id="8396264">func</span><span class="op" id="8396268">(</span><span class="ident" id="8396269">_</span>&nbsp;<span class="op" id="8396271">*</span><span class="ident" id="8396272">fakeConn</span><span class="op" id="8396280">,</span>&nbsp;<span class="ident" id="8396282">err</span>&nbsp;<span class="builtintype" id="8396286">error</span><span class="op" id="8396291">)</span>&nbsp;<span class="op" id="8396293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8396297">if</span>&nbsp;<span class="ident" id="8396300">err</span>&nbsp;<span class="op" id="8396304">!=</span>&nbsp;<span class="builtintype" id="8396307">nil</span>&nbsp;<span class="op" id="8396311">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396316">t</span><span class="op" id="8396317">.</span><span class="ident" id="8396318">Errorf</span><span class="op" id="8396324">(</span><span class="string" id="8396325">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8396353">,</span>&nbsp;<span class="ident" id="8396355">err</span><span class="op" id="8396358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8396362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8396365">}</span><span class="op" id="8396366">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396370">db</span>&nbsp;<span class="op" id="8396373">:=</span>&nbsp;<span class="ident" id="8396376">newTestDB</span><span class="op" id="8396385">(</span><span class="ident" id="8396386">t</span><span class="op" id="8396387">,</span>&nbsp;<span class="string" id="8396389">&#34;magicquery&#34;</span><span class="op" id="8396401">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8396404">defer</span>&nbsp;<span class="ident" id="8396410">closeDB</span><span class="op" id="8396417">(</span><span class="ident" id="8396418">t</span><span class="op" id="8396419">,</span>&nbsp;<span class="ident" id="8396421">db</span><span class="op" id="8396423">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396427">driver</span>&nbsp;<span class="op" id="8396434">:=</span>&nbsp;<span class="ident" id="8396437">db</span><span class="op" id="8396439">.</span><span class="ident" id="8396440">driver</span><span class="op" id="8396446">.</span><span class="op" id="8396447">(</span><span class="op" id="8396448">*</span><span class="ident" id="8396449">fakeDriver</span><span class="op" id="8396459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8396463">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8396535">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396558">db</span><span class="op" id="8396560">.</span><span class="ident" id="8396561">SetMaxIdleConns</span><span class="op" id="8396576">(</span><span class="num" id="8396577">0</span><span class="op" id="8396578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8396582">if</span>&nbsp;<span class="ident" id="8396585">g</span><span class="op" id="8396586">,</span>&nbsp;<span class="ident" id="8396588">w</span>&nbsp;<span class="op" id="8396590">:=</span>&nbsp;<span class="ident" id="8396593">db</span><span class="op" id="8396595">.</span><span class="ident" id="8396596">numFreeConns</span><span class="op" id="8396608">(</span><span class="op" id="8396609">)</span><span class="op" id="8396610">,</span>&nbsp;<span class="num" id="8396612">0</span><span class="op" id="8396613">;</span>&nbsp;<span class="ident" id="8396615">g</span>&nbsp;<span class="op" id="8396617">!=</span>&nbsp;<span class="ident" id="8396620">w</span>&nbsp;<span class="op" id="8396622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396626">t</span><span class="op" id="8396627">.</span><span class="ident" id="8396628">Errorf</span><span class="op" id="8396634">(</span><span class="string" id="8396635">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8396661">,</span>&nbsp;<span class="ident" id="8396663">g</span><span class="op" id="8396664">,</span>&nbsp;<span class="ident" id="8396666">w</span><span class="op" id="8396667">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8396670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8396674">if</span>&nbsp;<span class="ident" id="8396677">n</span>&nbsp;<span class="op" id="8396679">:=</span>&nbsp;<span class="ident" id="8396682">db</span><span class="op" id="8396684">.</span><span class="ident" id="8396685">numDepsPollUntil</span><span class="op" id="8396701">(</span><span class="num" id="8396702">0</span><span class="op" id="8396703">,</span>&nbsp;<span class="ident" id="8396705">time</span><span class="op" id="8396709">.</span><span class="ident" id="8396710">Second</span><span class="op" id="8396716">)</span><span class="op" id="8396717">;</span>&nbsp;<span class="ident" id="8396719">n</span>&nbsp;<span class="op" id="8396721">&gt;</span>&nbsp;<span class="num" id="8396723">0</span>&nbsp;<span class="op" id="8396725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396729">t</span><span class="op" id="8396730">.</span><span class="ident" id="8396731">Errorf</span><span class="op" id="8396737">(</span><span class="string" id="8396738">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8396779">,</span>&nbsp;<span class="ident" id="8396781">n</span><span class="op" id="8396782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396786">db</span><span class="op" id="8396788">.</span><span class="ident" id="8396789">dumpDeps</span><span class="op" id="8396797">(</span><span class="ident" id="8396798">t</span><span class="op" id="8396799">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8396802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396806">driver</span><span class="op" id="8396812">.</span><span class="ident" id="8396813">mu</span><span class="op" id="8396815">.</span><span class="ident" id="8396816">Lock</span><span class="op" id="8396820">(</span><span class="op" id="8396821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396824">opens0</span>&nbsp;<span class="op" id="8396831">:=</span>&nbsp;<span class="ident" id="8396834">driver</span><span class="op" id="8396840">.</span><span class="ident" id="8396841">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396852">closes0</span>&nbsp;<span class="op" id="8396860">:=</span>&nbsp;<span class="ident" id="8396863">driver</span><span class="op" id="8396869">.</span><span class="ident" id="8396870">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396882">driver</span><span class="op" id="8396888">.</span><span class="ident" id="8396889">mu</span><span class="op" id="8396891">.</span><span class="ident" id="8396892">Unlock</span><span class="op" id="8396898">(</span><span class="op" id="8396899">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396903">db</span><span class="op" id="8396905">.</span><span class="ident" id="8396906">SetMaxIdleConns</span><span class="op" id="8396921">(</span><span class="num" id="8396922">10</span><span class="op" id="8396924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396927">db</span><span class="op" id="8396929">.</span><span class="ident" id="8396930">SetMaxOpenConns</span><span class="op" id="8396945">(</span><span class="num" id="8396946">10</span><span class="op" id="8396948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396952">stmt</span><span class="op" id="8396956">,</span>&nbsp;<span class="ident" id="8396958">err</span>&nbsp;<span class="op" id="8396962">:=</span>&nbsp;<span class="ident" id="8396965">db</span><span class="op" id="8396967">.</span><span class="ident" id="8396968">Prepare</span><span class="op" id="8396975">(</span><span class="string" id="8396976">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="8397012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397015">if</span>&nbsp;<span class="ident" id="8397018">err</span>&nbsp;<span class="op" id="8397022">!=</span>&nbsp;<span class="builtintype" id="8397025">nil</span>&nbsp;<span class="op" id="8397029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397033">t</span><span class="op" id="8397034">.</span><span class="ident" id="8397035">Fatal</span><span class="op" id="8397040">(</span><span class="ident" id="8397041">err</span><span class="op" id="8397044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8397051">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397087">const</span>&nbsp;<span class="op" id="8397093">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397097">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397109">=</span>&nbsp;<span class="num" id="8397111">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397116">sleepMillis</span>&nbsp;<span class="op" id="8397128">=</span>&nbsp;<span class="num" id="8397130">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397135">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397147">=</span>&nbsp;<span class="num" id="8397149">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397155">var</span>&nbsp;<span class="ident" id="8397159">wg</span>&nbsp;<span class="ident" id="8397162">sync</span><span class="op" id="8397166">.</span><span class="ident" id="8397167">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397178">for</span>&nbsp;<span class="ident" id="8397182">batch</span>&nbsp;<span class="op" id="8397188">:=</span>&nbsp;<span class="num" id="8397191">0</span><span class="op" id="8397192">;</span>&nbsp;<span class="ident" id="8397194">batch</span>&nbsp;<span class="op" id="8397200">&lt;</span>&nbsp;<span class="ident" id="8397202">nbatch</span><span class="op" id="8397208">;</span>&nbsp;<span class="ident" id="8397210">batch</span><span class="op" id="8397215">++</span>&nbsp;<span class="op" id="8397218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397222">for</span>&nbsp;<span class="ident" id="8397226">i</span>&nbsp;<span class="op" id="8397228">:=</span>&nbsp;<span class="num" id="8397231">0</span><span class="op" id="8397232">;</span>&nbsp;<span class="ident" id="8397234">i</span>&nbsp;<span class="op" id="8397236">&lt;</span>&nbsp;<span class="ident" id="8397238">nquery</span><span class="op" id="8397244">;</span>&nbsp;<span class="ident" id="8397246">i</span><span class="op" id="8397247">++</span>&nbsp;<span class="op" id="8397250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397255">wg</span><span class="op" id="8397257">.</span><span class="ident" id="8397258">Add</span><span class="op" id="8397261">(</span><span class="num" id="8397262">1</span><span class="op" id="8397263">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397268">go</span>&nbsp;<span class="keyword" id="8397271">func</span><span class="op" id="8397275">(</span><span class="op" id="8397276">)</span>&nbsp;<span class="op" id="8397278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397284">defer</span>&nbsp;<span class="ident" id="8397290">wg</span><span class="op" id="8397292">.</span><span class="ident" id="8397293">Done</span><span class="op" id="8397297">(</span><span class="op" id="8397298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397304">var</span>&nbsp;<span class="ident" id="8397308">op</span>&nbsp;<span class="builtintype" id="8397311">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397322">if</span>&nbsp;<span class="ident" id="8397325">err</span>&nbsp;<span class="op" id="8397329">:=</span>&nbsp;<span class="ident" id="8397332">stmt</span><span class="op" id="8397336">.</span><span class="ident" id="8397337">QueryRow</span><span class="op" id="8397345">(</span><span class="string" id="8397346">&#34;sleep&#34;</span><span class="op" id="8397353">,</span>&nbsp;<span class="ident" id="8397355">sleepMillis</span><span class="op" id="8397366">)</span><span class="op" id="8397367">.</span><span class="ident" id="8397368">Scan</span><span class="op" id="8397372">(</span><span class="op" id="8397373">&amp;</span><span class="ident" id="8397374">op</span><span class="op" id="8397376">)</span><span class="op" id="8397377">;</span>&nbsp;<span class="ident" id="8397379">err</span>&nbsp;<span class="op" id="8397383">!=</span>&nbsp;<span class="builtintype" id="8397386">nil</span>&nbsp;<span class="op" id="8397390">&amp;&amp;</span>&nbsp;<span class="ident" id="8397393">err</span>&nbsp;<span class="op" id="8397397">!=</span>&nbsp;<span class="ident" id="8397400">ErrNoRows</span>&nbsp;<span class="op" id="8397410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397417">t</span><span class="op" id="8397418">.</span><span class="ident" id="8397419">Error</span><span class="op" id="8397424">(</span><span class="ident" id="8397425">err</span><span class="op" id="8397428">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397439">}</span><span class="op" id="8397440">(</span><span class="op" id="8397441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8397449">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8397506">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8397563">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397584">time</span><span class="op" id="8397588">.</span><span class="ident" id="8397589">Sleep</span><span class="op" id="8397594">(</span><span class="num" id="8397595">2</span>&nbsp;<span class="op" id="8397597">*</span>&nbsp;<span class="ident" id="8397599">sleepMillis</span>&nbsp;<span class="op" id="8397611">*</span>&nbsp;<span class="ident" id="8397613">time</span><span class="op" id="8397617">.</span><span class="ident" id="8397618">Millisecond</span><span class="op" id="8397629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397635">wg</span><span class="op" id="8397637">.</span><span class="ident" id="8397638">Wait</span><span class="op" id="8397642">(</span><span class="op" id="8397643">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397647">if</span>&nbsp;<span class="ident" id="8397650">g</span><span class="op" id="8397651">,</span>&nbsp;<span class="ident" id="8397653">w</span>&nbsp;<span class="op" id="8397655">:=</span>&nbsp;<span class="ident" id="8397658">db</span><span class="op" id="8397660">.</span><span class="ident" id="8397661">numFreeConns</span><span class="op" id="8397673">(</span><span class="op" id="8397674">)</span><span class="op" id="8397675">,</span>&nbsp;<span class="num" id="8397677">10</span><span class="op" id="8397679">;</span>&nbsp;<span class="ident" id="8397681">g</span>&nbsp;<span class="op" id="8397683">!=</span>&nbsp;<span class="ident" id="8397686">w</span>&nbsp;<span class="op" id="8397688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397692">t</span><span class="op" id="8397693">.</span><span class="ident" id="8397694">Errorf</span><span class="op" id="8397700">(</span><span class="string" id="8397701">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8397727">,</span>&nbsp;<span class="ident" id="8397729">g</span><span class="op" id="8397730">,</span>&nbsp;<span class="ident" id="8397732">w</span><span class="op" id="8397733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397740">if</span>&nbsp;<span class="ident" id="8397743">n</span>&nbsp;<span class="op" id="8397745">:=</span>&nbsp;<span class="ident" id="8397748">db</span><span class="op" id="8397750">.</span><span class="ident" id="8397751">numDepsPollUntil</span><span class="op" id="8397767">(</span><span class="num" id="8397768">20</span><span class="op" id="8397770">,</span>&nbsp;<span class="ident" id="8397772">time</span><span class="op" id="8397776">.</span><span class="ident" id="8397777">Second</span><span class="op" id="8397783">)</span><span class="op" id="8397784">;</span>&nbsp;<span class="ident" id="8397786">n</span>&nbsp;<span class="op" id="8397788">&gt;</span>&nbsp;<span class="num" id="8397790">20</span>&nbsp;<span class="op" id="8397793">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397797">t</span><span class="op" id="8397798">.</span><span class="ident" id="8397799">Errorf</span><span class="op" id="8397805">(</span><span class="string" id="8397806">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="8397851">,</span>&nbsp;<span class="ident" id="8397853">n</span><span class="op" id="8397854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397858">db</span><span class="op" id="8397860">.</span><span class="ident" id="8397861">dumpDeps</span><span class="op" id="8397869">(</span><span class="ident" id="8397870">t</span><span class="op" id="8397871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8397874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397878">driver</span><span class="op" id="8397884">.</span><span class="ident" id="8397885">mu</span><span class="op" id="8397887">.</span><span class="ident" id="8397888">Lock</span><span class="op" id="8397892">(</span><span class="op" id="8397893">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397896">opens</span>&nbsp;<span class="op" id="8397902">:=</span>&nbsp;<span class="ident" id="8397905">driver</span><span class="op" id="8397911">.</span><span class="ident" id="8397912">openCount</span>&nbsp;<span class="op" id="8397922">-</span>&nbsp;<span class="ident" id="8397924">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397932">closes</span>&nbsp;<span class="op" id="8397939">:=</span>&nbsp;<span class="ident" id="8397942">driver</span><span class="op" id="8397948">.</span><span class="ident" id="8397949">closeCount</span>&nbsp;<span class="op" id="8397960">-</span>&nbsp;<span class="ident" id="8397962">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8397971">driver</span><span class="op" id="8397977">.</span><span class="ident" id="8397978">mu</span><span class="op" id="8397980">.</span><span class="ident" id="8397981">Unlock</span><span class="op" id="8397987">(</span><span class="op" id="8397988">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8397992">if</span>&nbsp;<span class="ident" id="8397995">opens</span>&nbsp;<span class="op" id="8398001">&gt;</span>&nbsp;<span class="num" id="8398003">10</span>&nbsp;<span class="op" id="8398006">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398010">t</span><span class="op" id="8398011">.</span><span class="ident" id="8398012">Logf</span><span class="op" id="8398016">(</span><span class="string" id="8398017">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8398034">,</span>&nbsp;<span class="ident" id="8398036">opens</span><span class="op" id="8398041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398045">t</span><span class="op" id="8398046">.</span><span class="ident" id="8398047">Logf</span><span class="op" id="8398051">(</span><span class="string" id="8398052">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8398070">,</span>&nbsp;<span class="ident" id="8398072">closes</span><span class="op" id="8398078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398082">t</span><span class="op" id="8398083">.</span><span class="ident" id="8398084">Errorf</span><span class="op" id="8398090">(</span><span class="string" id="8398091">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="8398131">,</span>&nbsp;<span class="ident" id="8398133">opens</span><span class="op" id="8398138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398142">db</span><span class="op" id="8398144">.</span><span class="ident" id="8398145">dumpDeps</span><span class="op" id="8398153">(</span><span class="ident" id="8398154">t</span><span class="op" id="8398155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398158">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398162">if</span>&nbsp;<span class="ident" id="8398165">err</span>&nbsp;<span class="op" id="8398169">:=</span>&nbsp;<span class="ident" id="8398172">stmt</span><span class="op" id="8398176">.</span><span class="ident" id="8398177">Close</span><span class="op" id="8398182">(</span><span class="op" id="8398183">)</span><span class="op" id="8398184">;</span>&nbsp;<span class="ident" id="8398186">err</span>&nbsp;<span class="op" id="8398190">!=</span>&nbsp;<span class="builtintype" id="8398193">nil</span>&nbsp;<span class="op" id="8398197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398201">t</span><span class="op" id="8398202">.</span><span class="ident" id="8398203">Fatal</span><span class="op" id="8398208">(</span><span class="ident" id="8398209">err</span><span class="op" id="8398212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398219">if</span>&nbsp;<span class="ident" id="8398222">g</span><span class="op" id="8398223">,</span>&nbsp;<span class="ident" id="8398225">w</span>&nbsp;<span class="op" id="8398227">:=</span>&nbsp;<span class="ident" id="8398230">db</span><span class="op" id="8398232">.</span><span class="ident" id="8398233">numFreeConns</span><span class="op" id="8398245">(</span><span class="op" id="8398246">)</span><span class="op" id="8398247">,</span>&nbsp;<span class="num" id="8398249">10</span><span class="op" id="8398251">;</span>&nbsp;<span class="ident" id="8398253">g</span>&nbsp;<span class="op" id="8398255">!=</span>&nbsp;<span class="ident" id="8398258">w</span>&nbsp;<span class="op" id="8398260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398264">t</span><span class="op" id="8398265">.</span><span class="ident" id="8398266">Errorf</span><span class="op" id="8398272">(</span><span class="string" id="8398273">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8398299">,</span>&nbsp;<span class="ident" id="8398301">g</span><span class="op" id="8398302">,</span>&nbsp;<span class="ident" id="8398304">w</span><span class="op" id="8398305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398312">if</span>&nbsp;<span class="ident" id="8398315">n</span>&nbsp;<span class="op" id="8398317">:=</span>&nbsp;<span class="ident" id="8398320">db</span><span class="op" id="8398322">.</span><span class="ident" id="8398323">numDepsPollUntil</span><span class="op" id="8398339">(</span><span class="num" id="8398340">10</span><span class="op" id="8398342">,</span>&nbsp;<span class="ident" id="8398344">time</span><span class="op" id="8398348">.</span><span class="ident" id="8398349">Second</span><span class="op" id="8398355">)</span><span class="op" id="8398356">;</span>&nbsp;<span class="ident" id="8398358">n</span>&nbsp;<span class="op" id="8398360">&gt;</span>&nbsp;<span class="num" id="8398362">10</span>&nbsp;<span class="op" id="8398365">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398369">t</span><span class="op" id="8398370">.</span><span class="ident" id="8398371">Errorf</span><span class="op" id="8398377">(</span><span class="string" id="8398378">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="8398423">,</span>&nbsp;<span class="ident" id="8398425">n</span><span class="op" id="8398426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398430">db</span><span class="op" id="8398432">.</span><span class="ident" id="8398433">dumpDeps</span><span class="op" id="8398441">(</span><span class="ident" id="8398442">t</span><span class="op" id="8398443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398450">db</span><span class="op" id="8398452">.</span><span class="ident" id="8398453">SetMaxOpenConns</span><span class="op" id="8398468">(</span><span class="num" id="8398469">5</span><span class="op" id="8398470">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398474">if</span>&nbsp;<span class="ident" id="8398477">g</span><span class="op" id="8398478">,</span>&nbsp;<span class="ident" id="8398480">w</span>&nbsp;<span class="op" id="8398482">:=</span>&nbsp;<span class="ident" id="8398485">db</span><span class="op" id="8398487">.</span><span class="ident" id="8398488">numFreeConns</span><span class="op" id="8398500">(</span><span class="op" id="8398501">)</span><span class="op" id="8398502">,</span>&nbsp;<span class="num" id="8398504">5</span><span class="op" id="8398505">;</span>&nbsp;<span class="ident" id="8398507">g</span>&nbsp;<span class="op" id="8398509">!=</span>&nbsp;<span class="ident" id="8398512">w</span>&nbsp;<span class="op" id="8398514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398518">t</span><span class="op" id="8398519">.</span><span class="ident" id="8398520">Errorf</span><span class="op" id="8398526">(</span><span class="string" id="8398527">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8398553">,</span>&nbsp;<span class="ident" id="8398555">g</span><span class="op" id="8398556">,</span>&nbsp;<span class="ident" id="8398558">w</span><span class="op" id="8398559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398566">if</span>&nbsp;<span class="ident" id="8398569">n</span>&nbsp;<span class="op" id="8398571">:=</span>&nbsp;<span class="ident" id="8398574">db</span><span class="op" id="8398576">.</span><span class="ident" id="8398577">numDepsPollUntil</span><span class="op" id="8398593">(</span><span class="num" id="8398594">5</span><span class="op" id="8398595">,</span>&nbsp;<span class="ident" id="8398597">time</span><span class="op" id="8398601">.</span><span class="ident" id="8398602">Second</span><span class="op" id="8398608">)</span><span class="op" id="8398609">;</span>&nbsp;<span class="ident" id="8398611">n</span>&nbsp;<span class="op" id="8398613">&gt;</span>&nbsp;<span class="num" id="8398615">5</span>&nbsp;<span class="op" id="8398617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398621">t</span><span class="op" id="8398622">.</span><span class="ident" id="8398623">Errorf</span><span class="op" id="8398629">(</span><span class="string" id="8398630">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8398671">,</span>&nbsp;<span class="ident" id="8398673">n</span><span class="op" id="8398674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398678">db</span><span class="op" id="8398680">.</span><span class="ident" id="8398681">dumpDeps</span><span class="op" id="8398689">(</span><span class="ident" id="8398690">t</span><span class="op" id="8398691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398698">db</span><span class="op" id="8398700">.</span><span class="ident" id="8398701">SetMaxOpenConns</span><span class="op" id="8398716">(</span><span class="num" id="8398717">0</span><span class="op" id="8398718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398722">if</span>&nbsp;<span class="ident" id="8398725">g</span><span class="op" id="8398726">,</span>&nbsp;<span class="ident" id="8398728">w</span>&nbsp;<span class="op" id="8398730">:=</span>&nbsp;<span class="ident" id="8398733">db</span><span class="op" id="8398735">.</span><span class="ident" id="8398736">numFreeConns</span><span class="op" id="8398748">(</span><span class="op" id="8398749">)</span><span class="op" id="8398750">,</span>&nbsp;<span class="num" id="8398752">5</span><span class="op" id="8398753">;</span>&nbsp;<span class="ident" id="8398755">g</span>&nbsp;<span class="op" id="8398757">!=</span>&nbsp;<span class="ident" id="8398760">w</span>&nbsp;<span class="op" id="8398762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398766">t</span><span class="op" id="8398767">.</span><span class="ident" id="8398768">Errorf</span><span class="op" id="8398774">(</span><span class="string" id="8398775">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8398801">,</span>&nbsp;<span class="ident" id="8398803">g</span><span class="op" id="8398804">,</span>&nbsp;<span class="ident" id="8398806">w</span><span class="op" id="8398807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398810">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398814">if</span>&nbsp;<span class="ident" id="8398817">n</span>&nbsp;<span class="op" id="8398819">:=</span>&nbsp;<span class="ident" id="8398822">db</span><span class="op" id="8398824">.</span><span class="ident" id="8398825">numDepsPollUntil</span><span class="op" id="8398841">(</span><span class="num" id="8398842">5</span><span class="op" id="8398843">,</span>&nbsp;<span class="ident" id="8398845">time</span><span class="op" id="8398849">.</span><span class="ident" id="8398850">Second</span><span class="op" id="8398856">)</span><span class="op" id="8398857">;</span>&nbsp;<span class="ident" id="8398859">n</span>&nbsp;<span class="op" id="8398861">&gt;</span>&nbsp;<span class="num" id="8398863">5</span>&nbsp;<span class="op" id="8398865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398869">t</span><span class="op" id="8398870">.</span><span class="ident" id="8398871">Errorf</span><span class="op" id="8398877">(</span><span class="string" id="8398878">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8398919">,</span>&nbsp;<span class="ident" id="8398921">n</span><span class="op" id="8398922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398926">db</span><span class="op" id="8398928">.</span><span class="ident" id="8398929">dumpDeps</span><span class="op" id="8398937">(</span><span class="ident" id="8398938">t</span><span class="op" id="8398939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398942">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8398946">db</span><span class="op" id="8398948">.</span><span class="ident" id="8398949">SetMaxIdleConns</span><span class="op" id="8398964">(</span><span class="num" id="8398965">0</span><span class="op" id="8398966">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398970">if</span>&nbsp;<span class="ident" id="8398973">g</span><span class="op" id="8398974">,</span>&nbsp;<span class="ident" id="8398976">w</span>&nbsp;<span class="op" id="8398978">:=</span>&nbsp;<span class="ident" id="8398981">db</span><span class="op" id="8398983">.</span><span class="ident" id="8398984">numFreeConns</span><span class="op" id="8398996">(</span><span class="op" id="8398997">)</span><span class="op" id="8398998">,</span>&nbsp;<span class="num" id="8399000">0</span><span class="op" id="8399001">;</span>&nbsp;<span class="ident" id="8399003">g</span>&nbsp;<span class="op" id="8399005">!=</span>&nbsp;<span class="ident" id="8399008">w</span>&nbsp;<span class="op" id="8399010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399014">t</span><span class="op" id="8399015">.</span><span class="ident" id="8399016">Errorf</span><span class="op" id="8399022">(</span><span class="string" id="8399023">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8399049">,</span>&nbsp;<span class="ident" id="8399051">g</span><span class="op" id="8399052">,</span>&nbsp;<span class="ident" id="8399054">w</span><span class="op" id="8399055">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399062">if</span>&nbsp;<span class="ident" id="8399065">n</span>&nbsp;<span class="op" id="8399067">:=</span>&nbsp;<span class="ident" id="8399070">db</span><span class="op" id="8399072">.</span><span class="ident" id="8399073">numDepsPollUntil</span><span class="op" id="8399089">(</span><span class="num" id="8399090">0</span><span class="op" id="8399091">,</span>&nbsp;<span class="ident" id="8399093">time</span><span class="op" id="8399097">.</span><span class="ident" id="8399098">Second</span><span class="op" id="8399104">)</span><span class="op" id="8399105">;</span>&nbsp;<span class="ident" id="8399107">n</span>&nbsp;<span class="op" id="8399109">&gt;</span>&nbsp;<span class="num" id="8399111">0</span>&nbsp;<span class="op" id="8399113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399117">t</span><span class="op" id="8399118">.</span><span class="ident" id="8399119">Errorf</span><span class="op" id="8399125">(</span><span class="string" id="8399126">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8399167">,</span>&nbsp;<span class="ident" id="8399169">n</span><span class="op" id="8399170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399174">db</span><span class="op" id="8399176">.</span><span class="ident" id="8399177">dumpDeps</span><span class="op" id="8399185">(</span><span class="ident" id="8399186">t</span><span class="op" id="8399187">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399190">}</span><br>
<span class="lineno"></span><span class="op" id="8399192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8399195">func</span>&nbsp;<span class="ident" id="8399200">TestSingleOpenConn</span><span class="op" id="8399218">(</span><span class="ident" id="8399219">t</span>&nbsp;<span class="op" id="8399221">*</span><span class="ident" id="8399222">testing</span><span class="op" id="8399229">.</span><span class="ident" id="8399230">T</span><span class="op" id="8399231">)</span>&nbsp;<span class="op" id="8399233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399236">db</span>&nbsp;<span class="op" id="8399239">:=</span>&nbsp;<span class="ident" id="8399242">newTestDB</span><span class="op" id="8399251">(</span><span class="ident" id="8399252">t</span><span class="op" id="8399253">,</span>&nbsp;<span class="string" id="8399255">&#34;people&#34;</span><span class="op" id="8399263">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399266">defer</span>&nbsp;<span class="ident" id="8399272">closeDB</span><span class="op" id="8399279">(</span><span class="ident" id="8399280">t</span><span class="op" id="8399281">,</span>&nbsp;<span class="ident" id="8399283">db</span><span class="op" id="8399285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399289">db</span><span class="op" id="8399291">.</span><span class="ident" id="8399292">SetMaxOpenConns</span><span class="op" id="8399307">(</span><span class="num" id="8399308">1</span><span class="op" id="8399309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399313">rows</span><span class="op" id="8399317">,</span>&nbsp;<span class="ident" id="8399319">err</span>&nbsp;<span class="op" id="8399323">:=</span>&nbsp;<span class="ident" id="8399326">db</span><span class="op" id="8399328">.</span><span class="ident" id="8399329">Query</span><span class="op" id="8399334">(</span><span class="string" id="8399335">&#34;SELECT|people|name|&#34;</span><span class="op" id="8399356">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399359">if</span>&nbsp;<span class="ident" id="8399362">err</span>&nbsp;<span class="op" id="8399366">!=</span>&nbsp;<span class="builtintype" id="8399369">nil</span>&nbsp;<span class="op" id="8399373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399377">t</span><span class="op" id="8399378">.</span><span class="ident" id="8399379">Fatal</span><span class="op" id="8399384">(</span><span class="ident" id="8399385">err</span><span class="op" id="8399388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399394">if</span>&nbsp;<span class="ident" id="8399397">err</span>&nbsp;<span class="op" id="8399401">=</span>&nbsp;<span class="ident" id="8399403">rows</span><span class="op" id="8399407">.</span><span class="ident" id="8399408">Close</span><span class="op" id="8399413">(</span><span class="op" id="8399414">)</span><span class="op" id="8399415">;</span>&nbsp;<span class="ident" id="8399417">err</span>&nbsp;<span class="op" id="8399421">!=</span>&nbsp;<span class="builtintype" id="8399424">nil</span>&nbsp;<span class="op" id="8399428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399432">t</span><span class="op" id="8399433">.</span><span class="ident" id="8399434">Fatal</span><span class="op" id="8399439">(</span><span class="ident" id="8399440">err</span><span class="op" id="8399443">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8399449">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399472">rows</span><span class="op" id="8399476">,</span>&nbsp;<span class="ident" id="8399478">err</span>&nbsp;<span class="op" id="8399482">=</span>&nbsp;<span class="ident" id="8399484">db</span><span class="op" id="8399486">.</span><span class="ident" id="8399487">Query</span><span class="op" id="8399492">(</span><span class="string" id="8399493">&#34;SELECT|people|name|&#34;</span><span class="op" id="8399514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399517">if</span>&nbsp;<span class="ident" id="8399520">err</span>&nbsp;<span class="op" id="8399524">!=</span>&nbsp;<span class="builtintype" id="8399527">nil</span>&nbsp;<span class="op" id="8399531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399535">t</span><span class="op" id="8399536">.</span><span class="ident" id="8399537">Fatal</span><span class="op" id="8399542">(</span><span class="ident" id="8399543">err</span><span class="op" id="8399546">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399552">if</span>&nbsp;<span class="ident" id="8399555">err</span>&nbsp;<span class="op" id="8399559">=</span>&nbsp;<span class="ident" id="8399561">rows</span><span class="op" id="8399565">.</span><span class="ident" id="8399566">Close</span><span class="op" id="8399571">(</span><span class="op" id="8399572">)</span><span class="op" id="8399573">;</span>&nbsp;<span class="ident" id="8399575">err</span>&nbsp;<span class="op" id="8399579">!=</span>&nbsp;<span class="builtintype" id="8399582">nil</span>&nbsp;<span class="op" id="8399586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399590">t</span><span class="op" id="8399591">.</span><span class="ident" id="8399592">Fatal</span><span class="op" id="8399597">(</span><span class="ident" id="8399598">err</span><span class="op" id="8399601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399604">}</span><br>
<span class="lineno"></span><span class="op" id="8399606">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="8399609">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="8399634">func</span>&nbsp;<span class="ident" id="8399639">TestStmtCloseDeps</span><span class="op" id="8399656">(</span><span class="ident" id="8399657">t</span>&nbsp;<span class="op" id="8399659">*</span><span class="ident" id="8399660">testing</span><span class="op" id="8399667">.</span><span class="ident" id="8399668">T</span><span class="op" id="8399669">)</span>&nbsp;<span class="op" id="8399671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399674">if</span>&nbsp;<span class="ident" id="8399677">testing</span><span class="op" id="8399684">.</span><span class="ident" id="8399685">Short</span><span class="op" id="8399690">(</span><span class="op" id="8399691">)</span>&nbsp;<span class="op" id="8399693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399697">t</span><span class="op" id="8399698">.</span><span class="ident" id="8399699">Skip</span><span class="op" id="8399703">(</span><span class="string" id="8399704">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8399728">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399734">defer</span>&nbsp;<span class="ident" id="8399740">setHookpostCloseConn</span><span class="op" id="8399760">(</span><span class="builtintype" id="8399761">nil</span><span class="op" id="8399764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399767">setHookpostCloseConn</span><span class="op" id="8399787">(</span><span class="keyword" id="8399788">func</span><span class="op" id="8399792">(</span><span class="ident" id="8399793">_</span>&nbsp;<span class="op" id="8399795">*</span><span class="ident" id="8399796">fakeConn</span><span class="op" id="8399804">,</span>&nbsp;<span class="ident" id="8399806">err</span>&nbsp;<span class="builtintype" id="8399810">error</span><span class="op" id="8399815">)</span>&nbsp;<span class="op" id="8399817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399821">if</span>&nbsp;<span class="ident" id="8399824">err</span>&nbsp;<span class="op" id="8399828">!=</span>&nbsp;<span class="builtintype" id="8399831">nil</span>&nbsp;<span class="op" id="8399835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399840">t</span><span class="op" id="8399841">.</span><span class="ident" id="8399842">Errorf</span><span class="op" id="8399848">(</span><span class="string" id="8399849">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8399877">,</span>&nbsp;<span class="ident" id="8399879">err</span><span class="op" id="8399882">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399889">}</span><span class="op" id="8399890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399894">db</span>&nbsp;<span class="op" id="8399897">:=</span>&nbsp;<span class="ident" id="8399900">newTestDB</span><span class="op" id="8399909">(</span><span class="ident" id="8399910">t</span><span class="op" id="8399911">,</span>&nbsp;<span class="string" id="8399913">&#34;magicquery&#34;</span><span class="op" id="8399925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8399928">defer</span>&nbsp;<span class="ident" id="8399934">closeDB</span><span class="op" id="8399941">(</span><span class="ident" id="8399942">t</span><span class="op" id="8399943">,</span>&nbsp;<span class="ident" id="8399945">db</span><span class="op" id="8399947">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399951">driver</span>&nbsp;<span class="op" id="8399958">:=</span>&nbsp;<span class="ident" id="8399961">db</span><span class="op" id="8399963">.</span><span class="ident" id="8399964">driver</span><span class="op" id="8399970">.</span><span class="op" id="8399971">(</span><span class="op" id="8399972">*</span><span class="ident" id="8399973">fakeDriver</span><span class="op" id="8399983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8399987">driver</span><span class="op" id="8399993">.</span><span class="ident" id="8399994">mu</span><span class="op" id="8399996">.</span><span class="ident" id="8399997">Lock</span><span class="op" id="8400001">(</span><span class="op" id="8400002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400005">opens0</span>&nbsp;<span class="op" id="8400012">:=</span>&nbsp;<span class="ident" id="8400015">driver</span><span class="op" id="8400021">.</span><span class="ident" id="8400022">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400033">closes0</span>&nbsp;<span class="op" id="8400041">:=</span>&nbsp;<span class="ident" id="8400044">driver</span><span class="op" id="8400050">.</span><span class="ident" id="8400051">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400063">driver</span><span class="op" id="8400069">.</span><span class="ident" id="8400070">mu</span><span class="op" id="8400072">.</span><span class="ident" id="8400073">Unlock</span><span class="op" id="8400079">(</span><span class="op" id="8400080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400083">openDelta0</span>&nbsp;<span class="op" id="8400094">:=</span>&nbsp;<span class="ident" id="8400097">opens0</span>&nbsp;<span class="op" id="8400104">-</span>&nbsp;<span class="ident" id="8400106">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400116">stmt</span><span class="op" id="8400120">,</span>&nbsp;<span class="ident" id="8400122">err</span>&nbsp;<span class="op" id="8400126">:=</span>&nbsp;<span class="ident" id="8400129">db</span><span class="op" id="8400131">.</span><span class="ident" id="8400132">Prepare</span><span class="op" id="8400139">(</span><span class="string" id="8400140">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="8400176">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400179">if</span>&nbsp;<span class="ident" id="8400182">err</span>&nbsp;<span class="op" id="8400186">!=</span>&nbsp;<span class="builtintype" id="8400189">nil</span>&nbsp;<span class="op" id="8400193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400197">t</span><span class="op" id="8400198">.</span><span class="ident" id="8400199">Fatal</span><span class="op" id="8400204">(</span><span class="ident" id="8400205">err</span><span class="op" id="8400208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8400215">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400251">const</span>&nbsp;<span class="op" id="8400257">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400261">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400273">=</span>&nbsp;<span class="num" id="8400275">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400280">sleepMillis</span>&nbsp;<span class="op" id="8400292">=</span>&nbsp;<span class="num" id="8400294">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400299">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400311">=</span>&nbsp;<span class="num" id="8400313">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400316">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400319">var</span>&nbsp;<span class="ident" id="8400323">wg</span>&nbsp;<span class="ident" id="8400326">sync</span><span class="op" id="8400330">.</span><span class="ident" id="8400331">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400342">for</span>&nbsp;<span class="ident" id="8400346">batch</span>&nbsp;<span class="op" id="8400352">:=</span>&nbsp;<span class="num" id="8400355">0</span><span class="op" id="8400356">;</span>&nbsp;<span class="ident" id="8400358">batch</span>&nbsp;<span class="op" id="8400364">&lt;</span>&nbsp;<span class="ident" id="8400366">nbatch</span><span class="op" id="8400372">;</span>&nbsp;<span class="ident" id="8400374">batch</span><span class="op" id="8400379">++</span>&nbsp;<span class="op" id="8400382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400386">for</span>&nbsp;<span class="ident" id="8400390">i</span>&nbsp;<span class="op" id="8400392">:=</span>&nbsp;<span class="num" id="8400395">0</span><span class="op" id="8400396">;</span>&nbsp;<span class="ident" id="8400398">i</span>&nbsp;<span class="op" id="8400400">&lt;</span>&nbsp;<span class="ident" id="8400402">nquery</span><span class="op" id="8400408">;</span>&nbsp;<span class="ident" id="8400410">i</span><span class="op" id="8400411">++</span>&nbsp;<span class="op" id="8400414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400419">wg</span><span class="op" id="8400421">.</span><span class="ident" id="8400422">Add</span><span class="op" id="8400425">(</span><span class="num" id="8400426">1</span><span class="op" id="8400427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400432">go</span>&nbsp;<span class="keyword" id="8400435">func</span><span class="op" id="8400439">(</span><span class="op" id="8400440">)</span>&nbsp;<span class="op" id="8400442">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400448">defer</span>&nbsp;<span class="ident" id="8400454">wg</span><span class="op" id="8400456">.</span><span class="ident" id="8400457">Done</span><span class="op" id="8400461">(</span><span class="op" id="8400462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400468">var</span>&nbsp;<span class="ident" id="8400472">op</span>&nbsp;<span class="builtintype" id="8400475">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400486">if</span>&nbsp;<span class="ident" id="8400489">err</span>&nbsp;<span class="op" id="8400493">:=</span>&nbsp;<span class="ident" id="8400496">stmt</span><span class="op" id="8400500">.</span><span class="ident" id="8400501">QueryRow</span><span class="op" id="8400509">(</span><span class="string" id="8400510">&#34;sleep&#34;</span><span class="op" id="8400517">,</span>&nbsp;<span class="ident" id="8400519">sleepMillis</span><span class="op" id="8400530">)</span><span class="op" id="8400531">.</span><span class="ident" id="8400532">Scan</span><span class="op" id="8400536">(</span><span class="op" id="8400537">&amp;</span><span class="ident" id="8400538">op</span><span class="op" id="8400540">)</span><span class="op" id="8400541">;</span>&nbsp;<span class="ident" id="8400543">err</span>&nbsp;<span class="op" id="8400547">!=</span>&nbsp;<span class="builtintype" id="8400550">nil</span>&nbsp;<span class="op" id="8400554">&amp;&amp;</span>&nbsp;<span class="ident" id="8400557">err</span>&nbsp;<span class="op" id="8400561">!=</span>&nbsp;<span class="ident" id="8400564">ErrNoRows</span>&nbsp;<span class="op" id="8400574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400581">t</span><span class="op" id="8400582">.</span><span class="ident" id="8400583">Error</span><span class="op" id="8400588">(</span><span class="ident" id="8400589">err</span><span class="op" id="8400592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400598">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400603">}</span><span class="op" id="8400604">(</span><span class="op" id="8400605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8400613">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8400670">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8400727">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400748">time</span><span class="op" id="8400752">.</span><span class="ident" id="8400753">Sleep</span><span class="op" id="8400758">(</span><span class="num" id="8400759">2</span>&nbsp;<span class="op" id="8400761">*</span>&nbsp;<span class="ident" id="8400763">sleepMillis</span>&nbsp;<span class="op" id="8400775">*</span>&nbsp;<span class="ident" id="8400777">time</span><span class="op" id="8400781">.</span><span class="ident" id="8400782">Millisecond</span><span class="op" id="8400793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400799">wg</span><span class="op" id="8400801">.</span><span class="ident" id="8400802">Wait</span><span class="op" id="8400806">(</span><span class="op" id="8400807">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400811">if</span>&nbsp;<span class="ident" id="8400814">g</span><span class="op" id="8400815">,</span>&nbsp;<span class="ident" id="8400817">w</span>&nbsp;<span class="op" id="8400819">:=</span>&nbsp;<span class="ident" id="8400822">db</span><span class="op" id="8400824">.</span><span class="ident" id="8400825">numFreeConns</span><span class="op" id="8400837">(</span><span class="op" id="8400838">)</span><span class="op" id="8400839">,</span>&nbsp;<span class="num" id="8400841">2</span><span class="op" id="8400842">;</span>&nbsp;<span class="ident" id="8400844">g</span>&nbsp;<span class="op" id="8400846">!=</span>&nbsp;<span class="ident" id="8400849">w</span>&nbsp;<span class="op" id="8400851">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400855">t</span><span class="op" id="8400856">.</span><span class="ident" id="8400857">Errorf</span><span class="op" id="8400863">(</span><span class="string" id="8400864">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8400890">,</span>&nbsp;<span class="ident" id="8400892">g</span><span class="op" id="8400893">,</span>&nbsp;<span class="ident" id="8400895">w</span><span class="op" id="8400896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8400899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8400903">if</span>&nbsp;<span class="ident" id="8400906">n</span>&nbsp;<span class="op" id="8400908">:=</span>&nbsp;<span class="ident" id="8400911">db</span><span class="op" id="8400913">.</span><span class="ident" id="8400914">numDepsPollUntil</span><span class="op" id="8400930">(</span><span class="num" id="8400931">4</span><span class="op" id="8400932">,</span>&nbsp;<span class="ident" id="8400934">time</span><span class="op" id="8400938">.</span><span class="ident" id="8400939">Second</span><span class="op" id="8400945">)</span><span class="op" id="8400946">;</span>&nbsp;<span class="ident" id="8400948">n</span>&nbsp;<span class="op" id="8400950">&gt;</span>&nbsp;<span class="num" id="8400952">4</span>&nbsp;<span class="op" id="8400954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8400958">t</span><span class="op" id="8400959">.</span><span class="ident" id="8400960">Errorf</span><span class="op" id="8400966">(</span><span class="string" id="8400967">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="8401011">,</span>&nbsp;<span class="ident" id="8401013">n</span><span class="op" id="8401014">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401018">db</span><span class="op" id="8401020">.</span><span class="ident" id="8401021">dumpDeps</span><span class="op" id="8401029">(</span><span class="ident" id="8401030">t</span><span class="op" id="8401031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8401034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401038">driver</span><span class="op" id="8401044">.</span><span class="ident" id="8401045">mu</span><span class="op" id="8401047">.</span><span class="ident" id="8401048">Lock</span><span class="op" id="8401052">(</span><span class="op" id="8401053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401056">opens</span>&nbsp;<span class="op" id="8401062">:=</span>&nbsp;<span class="ident" id="8401065">driver</span><span class="op" id="8401071">.</span><span class="ident" id="8401072">openCount</span>&nbsp;<span class="op" id="8401082">-</span>&nbsp;<span class="ident" id="8401084">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401092">closes</span>&nbsp;<span class="op" id="8401099">:=</span>&nbsp;<span class="ident" id="8401102">driver</span><span class="op" id="8401108">.</span><span class="ident" id="8401109">closeCount</span>&nbsp;<span class="op" id="8401120">-</span>&nbsp;<span class="ident" id="8401122">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401131">openDelta</span>&nbsp;<span class="op" id="8401141">:=</span>&nbsp;<span class="op" id="8401144">(</span><span class="ident" id="8401145">driver</span><span class="op" id="8401151">.</span><span class="ident" id="8401152">openCount</span>&nbsp;<span class="op" id="8401162">-</span>&nbsp;<span class="ident" id="8401164">driver</span><span class="op" id="8401170">.</span><span class="ident" id="8401171">closeCount</span><span class="op" id="8401181">)</span>&nbsp;<span class="op" id="8401183">-</span>&nbsp;<span class="ident" id="8401185">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401197">driver</span><span class="op" id="8401203">.</span><span class="ident" id="8401204">mu</span><span class="op" id="8401206">.</span><span class="ident" id="8401207">Unlock</span><span class="op" id="8401213">(</span><span class="op" id="8401214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8401218">if</span>&nbsp;<span class="ident" id="8401221">openDelta</span>&nbsp;<span class="op" id="8401231">&gt;</span>&nbsp;<span class="num" id="8401233">2</span>&nbsp;<span class="op" id="8401235">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401239">t</span><span class="op" id="8401240">.</span><span class="ident" id="8401241">Logf</span><span class="op" id="8401245">(</span><span class="string" id="8401246">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8401263">,</span>&nbsp;<span class="ident" id="8401265">opens</span><span class="op" id="8401270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401274">t</span><span class="op" id="8401275">.</span><span class="ident" id="8401276">Logf</span><span class="op" id="8401280">(</span><span class="string" id="8401281">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8401299">,</span>&nbsp;<span class="ident" id="8401301">closes</span><span class="op" id="8401307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401311">t</span><span class="op" id="8401312">.</span><span class="ident" id="8401313">Logf</span><span class="op" id="8401317">(</span><span class="string" id="8401318">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8401335">,</span>&nbsp;<span class="ident" id="8401337">openDelta</span><span class="op" id="8401346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401350">t</span><span class="op" id="8401351">.</span><span class="ident" id="8401352">Errorf</span><span class="op" id="8401358">(</span><span class="string" id="8401359">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="8401398">,</span>&nbsp;<span class="ident" id="8401400">openDelta</span><span class="op" id="8401409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401413">db</span><span class="op" id="8401415">.</span><span class="ident" id="8401416">dumpDeps</span><span class="op" id="8401424">(</span><span class="ident" id="8401425">t</span><span class="op" id="8401426">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8401429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8401433">if</span>&nbsp;<span class="builtinfunc" id="8401436">len</span><span class="op" id="8401439">(</span><span class="ident" id="8401440">stmt</span><span class="op" id="8401444">.</span><span class="ident" id="8401445">css</span><span class="op" id="8401448">)</span>&nbsp;<span class="op" id="8401450">&gt;</span>&nbsp;<span class="ident" id="8401452">nquery</span>&nbsp;<span class="op" id="8401459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401463">t</span><span class="op" id="8401464">.</span><span class="ident" id="8401465">Errorf</span><span class="op" id="8401471">(</span><span class="string" id="8401472">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="8401504">,</span>&nbsp;<span class="builtinfunc" id="8401506">len</span><span class="op" id="8401509">(</span><span class="ident" id="8401510">stmt</span><span class="op" id="8401514">.</span><span class="ident" id="8401515">css</span><span class="op" id="8401518">)</span><span class="op" id="8401519">,</span>&nbsp;<span class="ident" id="8401521">nquery</span><span class="op" id="8401527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8401530">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8401534">if</span>&nbsp;<span class="ident" id="8401537">err</span>&nbsp;<span class="op" id="8401541">:=</span>&nbsp;<span class="ident" id="8401544">stmt</span><span class="op" id="8401548">.</span><span class="ident" id="8401549">Close</span><span class="op" id="8401554">(</span><span class="op" id="8401555">)</span><span class="op" id="8401556">;</span>&nbsp;<span class="ident" id="8401558">err</span>&nbsp;<span class="op" id="8401562">!=</span>&nbsp;<span class="builtintype" id="8401565">nil</span>&nbsp;<span class="op" id="8401569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401573">t</span><span class="op" id="8401574">.</span><span class="ident" id="8401575">Fatal</span><span class="op" id="8401580">(</span><span class="ident" id="8401581">err</span><span class="op" id="8401584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8401587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8401591">if</span>&nbsp;<span class="ident" id="8401594">g</span><span class="op" id="8401595">,</span>&nbsp;<span class="ident" id="8401597">w</span>&nbsp;<span class="op" id="8401599">:=</span>&nbsp;<span class="ident" id="8401602">db</span><span class="op" id="8401604">.</span><span class="ident" id="8401605">numFreeConns</span><span class="op" id="8401617">(</span><span class="op" id="8401618">)</span><span class="op" id="8401619">,</span>&nbsp;<span class="num" id="8401621">2</span><span class="op" id="8401622">;</span>&nbsp;<span class="ident" id="8401624">g</span>&nbsp;<span class="op" id="8401626">!=</span>&nbsp;<span class="ident" id="8401629">w</span>&nbsp;<span class="op" id="8401631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401635">t</span><span class="op" id="8401636">.</span><span class="ident" id="8401637">Errorf</span><span class="op" id="8401643">(</span><span class="string" id="8401644">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8401670">,</span>&nbsp;<span class="ident" id="8401672">g</span><span class="op" id="8401673">,</span>&nbsp;<span class="ident" id="8401675">w</span><span class="op" id="8401676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8401679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8401683">if</span>&nbsp;<span class="ident" id="8401686">n</span>&nbsp;<span class="op" id="8401688">:=</span>&nbsp;<span class="ident" id="8401691">db</span><span class="op" id="8401693">.</span><span class="ident" id="8401694">numDepsPollUntil</span><span class="op" id="8401710">(</span><span class="num" id="8401711">2</span><span class="op" id="8401712">,</span>&nbsp;<span class="ident" id="8401714">time</span><span class="op" id="8401718">.</span><span class="ident" id="8401719">Second</span><span class="op" id="8401725">)</span><span class="op" id="8401726">;</span>&nbsp;<span class="ident" id="8401728">n</span>&nbsp;<span class="op" id="8401730">&gt;</span>&nbsp;<span class="num" id="8401732">2</span>&nbsp;<span class="op" id="8401734">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401738">t</span><span class="op" id="8401739">.</span><span class="ident" id="8401740">Errorf</span><span class="op" id="8401746">(</span><span class="string" id="8401747">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="8401791">,</span>&nbsp;<span class="ident" id="8401793">n</span><span class="op" id="8401794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401798">db</span><span class="op" id="8401800">.</span><span class="ident" id="8401801">dumpDeps</span><span class="op" id="8401809">(</span><span class="ident" id="8401810">t</span><span class="op" id="8401811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8401814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401818">db</span><span class="op" id="8401820">.</span><span class="ident" id="8401821">SetMaxIdleConns</span><span class="op" id="8401836">(</span><span class="num" id="8401837">0</span><span class="op" id="8401838">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8401842">if</span>&nbsp;<span class="ident" id="8401845">g</span><span class="op" id="8401846">,</span>&nbsp;<span class="ident" id="8401848">w</span>&nbsp;<span class="op" id="8401850">:=</span>&nbsp;<span class="ident" id="8401853">db</span><span class="op" id="8401855">.</span><span class="ident" id="8401856">numFreeConns</span><span class="op" id="8401868">(</span><span class="op" id="8401869">)</span><span class="op" id="8401870">,</span>&nbsp;<span class="num" id="8401872">0</span><span class="op" id="8401873">;</span>&nbsp;<span class="ident" id="8401875">g</span>&nbsp;<span class="op" id="8401877">!=</span>&nbsp;<span class="ident" id="8401880">w</span>&nbsp;<span class="op" id="8401882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401886">t</span><span class="op" id="8401887">.</span><span class="ident" id="8401888">Errorf</span><span class="op" id="8401894">(</span><span class="string" id="8401895">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8401921">,</span>&nbsp;<span class="ident" id="8401923">g</span><span class="op" id="8401924">,</span>&nbsp;<span class="ident" id="8401926">w</span><span class="op" id="8401927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8401930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8401934">if</span>&nbsp;<span class="ident" id="8401937">n</span>&nbsp;<span class="op" id="8401939">:=</span>&nbsp;<span class="ident" id="8401942">db</span><span class="op" id="8401944">.</span><span class="ident" id="8401945">numDepsPollUntil</span><span class="op" id="8401961">(</span><span class="num" id="8401962">0</span><span class="op" id="8401963">,</span>&nbsp;<span class="ident" id="8401965">time</span><span class="op" id="8401969">.</span><span class="ident" id="8401970">Second</span><span class="op" id="8401976">)</span><span class="op" id="8401977">;</span>&nbsp;<span class="ident" id="8401979">n</span>&nbsp;<span class="op" id="8401981">&gt;</span>&nbsp;<span class="num" id="8401983">0</span>&nbsp;<span class="op" id="8401985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8401989">t</span><span class="op" id="8401990">.</span><span class="ident" id="8401991">Errorf</span><span class="op" id="8401997">(</span><span class="string" id="8401998">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8402039">,</span>&nbsp;<span class="ident" id="8402041">n</span><span class="op" id="8402042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402046">db</span><span class="op" id="8402048">.</span><span class="ident" id="8402049">dumpDeps</span><span class="op" id="8402057">(</span><span class="ident" id="8402058">t</span><span class="op" id="8402059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402062">}</span><br>
<span class="lineno"></span><span class="op" id="8402064">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="8402067">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="8402092">func</span>&nbsp;<span class="ident" id="8402097">TestCloseConnBeforeStmts</span><span class="op" id="8402121">(</span><span class="ident" id="8402122">t</span>&nbsp;<span class="op" id="8402124">*</span><span class="ident" id="8402125">testing</span><span class="op" id="8402132">.</span><span class="ident" id="8402133">T</span><span class="op" id="8402134">)</span>&nbsp;<span class="op" id="8402136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402139">db</span>&nbsp;<span class="op" id="8402142">:=</span>&nbsp;<span class="ident" id="8402145">newTestDB</span><span class="op" id="8402154">(</span><span class="ident" id="8402155">t</span><span class="op" id="8402156">,</span>&nbsp;<span class="string" id="8402158">&#34;people&#34;</span><span class="op" id="8402166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402169">defer</span>&nbsp;<span class="ident" id="8402175">closeDB</span><span class="op" id="8402182">(</span><span class="ident" id="8402183">t</span><span class="op" id="8402184">,</span>&nbsp;<span class="ident" id="8402186">db</span><span class="op" id="8402188">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402192">defer</span>&nbsp;<span class="ident" id="8402198">setHookpostCloseConn</span><span class="op" id="8402218">(</span><span class="builtintype" id="8402219">nil</span><span class="op" id="8402222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402225">setHookpostCloseConn</span><span class="op" id="8402245">(</span><span class="keyword" id="8402246">func</span><span class="op" id="8402250">(</span><span class="ident" id="8402251">_</span>&nbsp;<span class="op" id="8402253">*</span><span class="ident" id="8402254">fakeConn</span><span class="op" id="8402262">,</span>&nbsp;<span class="ident" id="8402264">err</span>&nbsp;<span class="builtintype" id="8402268">error</span><span class="op" id="8402273">)</span>&nbsp;<span class="op" id="8402275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402279">if</span>&nbsp;<span class="ident" id="8402282">err</span>&nbsp;<span class="op" id="8402286">!=</span>&nbsp;<span class="builtintype" id="8402289">nil</span>&nbsp;<span class="op" id="8402293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402298">t</span><span class="op" id="8402299">.</span><span class="ident" id="8402300">Errorf</span><span class="op" id="8402306">(</span><span class="string" id="8402307">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="8402344">,</span>&nbsp;<span class="ident" id="8402346">err</span><span class="op" id="8402349">,</span>&nbsp;<span class="ident" id="8402351">stack</span><span class="op" id="8402356">(</span><span class="op" id="8402357">)</span><span class="op" id="8402358">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402363">db</span><span class="op" id="8402365">.</span><span class="ident" id="8402366">dumpDeps</span><span class="op" id="8402374">(</span><span class="ident" id="8402375">t</span><span class="op" id="8402376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402381">t</span><span class="op" id="8402382">.</span><span class="ident" id="8402383">Errorf</span><span class="op" id="8402389">(</span><span class="string" id="8402390">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8402400">,</span>&nbsp;<span class="ident" id="8402402">db</span><span class="op" id="8402404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402411">}</span><span class="op" id="8402412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402416">stmt</span><span class="op" id="8402420">,</span>&nbsp;<span class="ident" id="8402422">err</span>&nbsp;<span class="op" id="8402426">:=</span>&nbsp;<span class="ident" id="8402429">db</span><span class="op" id="8402431">.</span><span class="ident" id="8402432">Prepare</span><span class="op" id="8402439">(</span><span class="string" id="8402440">&#34;SELECT|people|name|&#34;</span><span class="op" id="8402461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402464">if</span>&nbsp;<span class="ident" id="8402467">err</span>&nbsp;<span class="op" id="8402471">!=</span>&nbsp;<span class="builtintype" id="8402474">nil</span>&nbsp;<span class="op" id="8402478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402482">t</span><span class="op" id="8402483">.</span><span class="ident" id="8402484">Fatal</span><span class="op" id="8402489">(</span><span class="ident" id="8402490">err</span><span class="op" id="8402493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402500">if</span>&nbsp;<span class="builtinfunc" id="8402503">len</span><span class="op" id="8402506">(</span><span class="ident" id="8402507">db</span><span class="op" id="8402509">.</span><span class="ident" id="8402510">freeConn</span><span class="op" id="8402518">)</span>&nbsp;<span class="op" id="8402520">!=</span>&nbsp;<span class="num" id="8402523">1</span>&nbsp;<span class="op" id="8402525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402529">t</span><span class="op" id="8402530">.</span><span class="ident" id="8402531">Fatalf</span><span class="op" id="8402537">(</span><span class="string" id="8402538">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8402567">,</span>&nbsp;<span class="builtinfunc" id="8402569">len</span><span class="op" id="8402572">(</span><span class="ident" id="8402573">db</span><span class="op" id="8402575">.</span><span class="ident" id="8402576">freeConn</span><span class="op" id="8402584">)</span><span class="op" id="8402585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402591">dc</span>&nbsp;<span class="op" id="8402594">:=</span>&nbsp;<span class="ident" id="8402597">db</span><span class="op" id="8402599">.</span><span class="ident" id="8402600">freeConn</span><span class="op" id="8402608">[</span><span class="num" id="8402609">0</span><span class="op" id="8402610">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402613">if</span>&nbsp;<span class="ident" id="8402616">dc</span><span class="op" id="8402618">.</span><span class="ident" id="8402619">closed</span>&nbsp;<span class="op" id="8402626">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402630">t</span><span class="op" id="8402631">.</span><span class="ident" id="8402632">Errorf</span><span class="op" id="8402638">(</span><span class="string" id="8402639">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8402665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402672">if</span>&nbsp;<span class="ident" id="8402675">n</span>&nbsp;<span class="op" id="8402677">:=</span>&nbsp;<span class="builtinfunc" id="8402680">len</span><span class="op" id="8402683">(</span><span class="ident" id="8402684">dc</span><span class="op" id="8402686">.</span><span class="ident" id="8402687">openStmt</span><span class="op" id="8402695">)</span><span class="op" id="8402696">;</span>&nbsp;<span class="ident" id="8402698">n</span>&nbsp;<span class="op" id="8402700">!=</span>&nbsp;<span class="num" id="8402703">1</span>&nbsp;<span class="op" id="8402705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402709">t</span><span class="op" id="8402710">.</span><span class="ident" id="8402711">Errorf</span><span class="op" id="8402717">(</span><span class="string" id="8402718">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8402756">,</span>&nbsp;<span class="ident" id="8402758">n</span><span class="op" id="8402759">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402765">err</span>&nbsp;<span class="op" id="8402769">=</span>&nbsp;<span class="ident" id="8402771">db</span><span class="op" id="8402773">.</span><span class="ident" id="8402774">Close</span><span class="op" id="8402779">(</span><span class="op" id="8402780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402783">if</span>&nbsp;<span class="ident" id="8402786">err</span>&nbsp;<span class="op" id="8402790">!=</span>&nbsp;<span class="builtintype" id="8402793">nil</span>&nbsp;<span class="op" id="8402797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402801">t</span><span class="op" id="8402802">.</span><span class="ident" id="8402803">Errorf</span><span class="op" id="8402809">(</span><span class="string" id="8402810">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8402825">,</span>&nbsp;<span class="ident" id="8402827">err</span><span class="op" id="8402830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402833">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402836">if</span>&nbsp;<span class="op" id="8402839">!</span><span class="ident" id="8402840">dc</span><span class="op" id="8402842">.</span><span class="ident" id="8402843">closed</span>&nbsp;<span class="op" id="8402850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402854">t</span><span class="op" id="8402855">.</span><span class="ident" id="8402856">Errorf</span><span class="op" id="8402862">(</span><span class="string" id="8402863">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8402908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8402911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8402914">if</span>&nbsp;<span class="ident" id="8402917">n</span>&nbsp;<span class="op" id="8402919">:=</span>&nbsp;<span class="builtinfunc" id="8402922">len</span><span class="op" id="8402925">(</span><span class="ident" id="8402926">dc</span><span class="op" id="8402928">.</span><span class="ident" id="8402929">openStmt</span><span class="op" id="8402937">)</span><span class="op" id="8402938">;</span>&nbsp;<span class="ident" id="8402940">n</span>&nbsp;<span class="op" id="8402942">!=</span>&nbsp;<span class="num" id="8402945">0</span>&nbsp;<span class="op" id="8402947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8402951">t</span><span class="op" id="8402952">.</span><span class="ident" id="8402953">Errorf</span><span class="op" id="8402959">(</span><span class="string" id="8402960">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8402998">,</span>&nbsp;<span class="ident" id="8403000">n</span><span class="op" id="8403001">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403008">err</span>&nbsp;<span class="op" id="8403012">=</span>&nbsp;<span class="ident" id="8403014">stmt</span><span class="op" id="8403018">.</span><span class="ident" id="8403019">Close</span><span class="op" id="8403024">(</span><span class="op" id="8403025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403028">if</span>&nbsp;<span class="ident" id="8403031">err</span>&nbsp;<span class="op" id="8403035">!=</span>&nbsp;<span class="builtintype" id="8403038">nil</span>&nbsp;<span class="op" id="8403042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403046">t</span><span class="op" id="8403047">.</span><span class="ident" id="8403048">Errorf</span><span class="op" id="8403054">(</span><span class="string" id="8403055">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8403072">,</span>&nbsp;<span class="ident" id="8403074">err</span><span class="op" id="8403077">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403084">if</span>&nbsp;<span class="op" id="8403087">!</span><span class="ident" id="8403088">dc</span><span class="op" id="8403090">.</span><span class="ident" id="8403091">closed</span>&nbsp;<span class="op" id="8403098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403102">t</span><span class="op" id="8403103">.</span><span class="ident" id="8403104">Errorf</span><span class="op" id="8403110">(</span><span class="string" id="8403111">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8403134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403137">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403140">if</span>&nbsp;<span class="ident" id="8403143">dc</span><span class="op" id="8403145">.</span><span class="ident" id="8403146">ci</span>&nbsp;<span class="op" id="8403149">!=</span>&nbsp;<span class="builtintype" id="8403152">nil</span>&nbsp;<span class="op" id="8403156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403160">t</span><span class="op" id="8403161">.</span><span class="ident" id="8403162">Errorf</span><span class="op" id="8403168">(</span><span class="string" id="8403169">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="8403230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403233">}</span><br>
<span class="lineno"></span><span class="op" id="8403235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="8403238">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="8403308">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="8403338">func</span>&nbsp;<span class="ident" id="8403343">TestRowsCloseOrder</span><span class="op" id="8403361">(</span><span class="ident" id="8403362">t</span>&nbsp;<span class="op" id="8403364">*</span><span class="ident" id="8403365">testing</span><span class="op" id="8403372">.</span><span class="ident" id="8403373">T</span><span class="op" id="8403374">)</span>&nbsp;<span class="op" id="8403376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403379">db</span>&nbsp;<span class="op" id="8403382">:=</span>&nbsp;<span class="ident" id="8403385">newTestDB</span><span class="op" id="8403394">(</span><span class="ident" id="8403395">t</span><span class="op" id="8403396">,</span>&nbsp;<span class="string" id="8403398">&#34;people&#34;</span><span class="op" id="8403406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403409">defer</span>&nbsp;<span class="ident" id="8403415">closeDB</span><span class="op" id="8403422">(</span><span class="ident" id="8403423">t</span><span class="op" id="8403424">,</span>&nbsp;<span class="ident" id="8403426">db</span><span class="op" id="8403428">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403432">db</span><span class="op" id="8403434">.</span><span class="ident" id="8403435">SetMaxIdleConns</span><span class="op" id="8403450">(</span><span class="num" id="8403451">0</span><span class="op" id="8403452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403455">setStrictFakeConnClose</span><span class="op" id="8403477">(</span><span class="ident" id="8403478">t</span><span class="op" id="8403479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403482">defer</span>&nbsp;<span class="ident" id="8403488">setStrictFakeConnClose</span><span class="op" id="8403510">(</span><span class="builtintype" id="8403511">nil</span><span class="op" id="8403514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403518">rows</span><span class="op" id="8403522">,</span>&nbsp;<span class="ident" id="8403524">err</span>&nbsp;<span class="op" id="8403528">:=</span>&nbsp;<span class="ident" id="8403531">db</span><span class="op" id="8403533">.</span><span class="ident" id="8403534">Query</span><span class="op" id="8403539">(</span><span class="string" id="8403540">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8403565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403568">if</span>&nbsp;<span class="ident" id="8403571">err</span>&nbsp;<span class="op" id="8403575">!=</span>&nbsp;<span class="builtintype" id="8403578">nil</span>&nbsp;<span class="op" id="8403582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403586">t</span><span class="op" id="8403587">.</span><span class="ident" id="8403588">Fatal</span><span class="op" id="8403593">(</span><span class="ident" id="8403594">err</span><span class="op" id="8403597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403603">err</span>&nbsp;<span class="op" id="8403607">=</span>&nbsp;<span class="ident" id="8403609">rows</span><span class="op" id="8403613">.</span><span class="ident" id="8403614">Close</span><span class="op" id="8403619">(</span><span class="op" id="8403620">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403623">if</span>&nbsp;<span class="ident" id="8403626">err</span>&nbsp;<span class="op" id="8403630">!=</span>&nbsp;<span class="builtintype" id="8403633">nil</span>&nbsp;<span class="op" id="8403637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403641">t</span><span class="op" id="8403642">.</span><span class="ident" id="8403643">Fatal</span><span class="op" id="8403648">(</span><span class="ident" id="8403649">err</span><span class="op" id="8403652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403655">}</span><br>
<span class="lineno"></span><span class="op" id="8403657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="8403660">func</span>&nbsp;<span class="ident" id="8403665">TestRowsImplicitClose</span><span class="op" id="8403686">(</span><span class="ident" id="8403687">t</span>&nbsp;<span class="op" id="8403689">*</span><span class="ident" id="8403690">testing</span><span class="op" id="8403697">.</span><span class="ident" id="8403698">T</span><span class="op" id="8403699">)</span>&nbsp;<span class="op" id="8403701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403704">db</span>&nbsp;<span class="op" id="8403707">:=</span>&nbsp;<span class="ident" id="8403710">newTestDB</span><span class="op" id="8403719">(</span><span class="ident" id="8403720">t</span><span class="op" id="8403721">,</span>&nbsp;<span class="string" id="8403723">&#34;people&#34;</span><span class="op" id="8403731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403734">defer</span>&nbsp;<span class="ident" id="8403740">closeDB</span><span class="op" id="8403747">(</span><span class="ident" id="8403748">t</span><span class="op" id="8403749">,</span>&nbsp;<span class="ident" id="8403751">db</span><span class="op" id="8403753">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403757">rows</span><span class="op" id="8403761">,</span>&nbsp;<span class="ident" id="8403763">err</span>&nbsp;<span class="op" id="8403767">:=</span>&nbsp;<span class="ident" id="8403770">db</span><span class="op" id="8403772">.</span><span class="ident" id="8403773">Query</span><span class="op" id="8403778">(</span><span class="string" id="8403779">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8403804">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403807">if</span>&nbsp;<span class="ident" id="8403810">err</span>&nbsp;<span class="op" id="8403814">!=</span>&nbsp;<span class="builtintype" id="8403817">nil</span>&nbsp;<span class="op" id="8403821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403825">t</span><span class="op" id="8403826">.</span><span class="ident" id="8403827">Fatal</span><span class="op" id="8403832">(</span><span class="ident" id="8403833">err</span><span class="op" id="8403836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403843">want</span><span class="op" id="8403847">,</span>&nbsp;<span class="ident" id="8403849">fail</span>&nbsp;<span class="op" id="8403854">:=</span>&nbsp;<span class="num" id="8403857">2</span><span class="op" id="8403858">,</span>&nbsp;<span class="ident" id="8403860">errors</span><span class="op" id="8403866">.</span><span class="ident" id="8403867">New</span><span class="op" id="8403870">(</span><span class="string" id="8403871">&#34;fail&#34;</span><span class="op" id="8403877">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403880">r</span>&nbsp;<span class="op" id="8403882">:=</span>&nbsp;<span class="ident" id="8403885">rows</span><span class="op" id="8403889">.</span><span class="ident" id="8403890">rowsi</span><span class="op" id="8403895">.</span><span class="op" id="8403896">(</span><span class="op" id="8403897">*</span><span class="ident" id="8403898">rowsCursor</span><span class="op" id="8403908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403911">r</span><span class="op" id="8403912">.</span><span class="ident" id="8403913">errPos</span><span class="op" id="8403919">,</span>&nbsp;<span class="ident" id="8403921">r</span><span class="op" id="8403922">.</span><span class="ident" id="8403923">err</span>&nbsp;<span class="op" id="8403927">=</span>&nbsp;<span class="ident" id="8403929">want</span><span class="op" id="8403933">,</span>&nbsp;<span class="ident" id="8403935">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403942">got</span>&nbsp;<span class="op" id="8403946">:=</span>&nbsp;<span class="num" id="8403949">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403952">for</span>&nbsp;<span class="ident" id="8403956">rows</span><span class="op" id="8403960">.</span><span class="ident" id="8403961">Next</span><span class="op" id="8403965">(</span><span class="op" id="8403966">)</span>&nbsp;<span class="op" id="8403968">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403972">got</span><span class="op" id="8403975">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403982">if</span>&nbsp;<span class="ident" id="8403985">got</span>&nbsp;<span class="op" id="8403989">!=</span>&nbsp;<span class="ident" id="8403992">want</span>&nbsp;<span class="op" id="8403997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404001">t</span><span class="op" id="8404002">.</span><span class="ident" id="8404003">Errorf</span><span class="op" id="8404009">(</span><span class="string" id="8404010">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8404032">,</span>&nbsp;<span class="ident" id="8404034">got</span><span class="op" id="8404037">,</span>&nbsp;<span class="ident" id="8404039">want</span><span class="op" id="8404043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404046">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404049">if</span>&nbsp;<span class="ident" id="8404052">err</span>&nbsp;<span class="op" id="8404056">:=</span>&nbsp;<span class="ident" id="8404059">rows</span><span class="op" id="8404063">.</span><span class="ident" id="8404064">Err</span><span class="op" id="8404067">(</span><span class="op" id="8404068">)</span><span class="op" id="8404069">;</span>&nbsp;<span class="ident" id="8404071">err</span>&nbsp;<span class="op" id="8404075">!=</span>&nbsp;<span class="ident" id="8404078">fail</span>&nbsp;<span class="op" id="8404083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404087">t</span><span class="op" id="8404088">.</span><span class="ident" id="8404089">Errorf</span><span class="op" id="8404095">(</span><span class="string" id="8404096">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8404119">,</span>&nbsp;<span class="ident" id="8404121">err</span><span class="op" id="8404124">,</span>&nbsp;<span class="ident" id="8404126">fail</span><span class="op" id="8404130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404136">if</span>&nbsp;<span class="op" id="8404139">!</span><span class="ident" id="8404140">r</span><span class="op" id="8404141">.</span><span class="ident" id="8404142">closed</span>&nbsp;<span class="op" id="8404149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404153">t</span><span class="op" id="8404154">.</span><span class="ident" id="8404155">Errorf</span><span class="op" id="8404161">(</span><span class="string" id="8404162">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="8404192">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404195">}</span><br>
<span class="lineno"></span><span class="op" id="8404197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8404200">func</span>&nbsp;<span class="ident" id="8404205">TestStmtCloseOrder</span><span class="op" id="8404223">(</span><span class="ident" id="8404224">t</span>&nbsp;<span class="op" id="8404226">*</span><span class="ident" id="8404227">testing</span><span class="op" id="8404234">.</span><span class="ident" id="8404235">T</span><span class="op" id="8404236">)</span>&nbsp;<span class="op" id="8404238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404241">db</span>&nbsp;<span class="op" id="8404244">:=</span>&nbsp;<span class="ident" id="8404247">newTestDB</span><span class="op" id="8404256">(</span><span class="ident" id="8404257">t</span><span class="op" id="8404258">,</span>&nbsp;<span class="string" id="8404260">&#34;people&#34;</span><span class="op" id="8404268">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404271">defer</span>&nbsp;<span class="ident" id="8404277">closeDB</span><span class="op" id="8404284">(</span><span class="ident" id="8404285">t</span><span class="op" id="8404286">,</span>&nbsp;<span class="ident" id="8404288">db</span><span class="op" id="8404290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404294">db</span><span class="op" id="8404296">.</span><span class="ident" id="8404297">SetMaxIdleConns</span><span class="op" id="8404312">(</span><span class="num" id="8404313">0</span><span class="op" id="8404314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404317">setStrictFakeConnClose</span><span class="op" id="8404339">(</span><span class="ident" id="8404340">t</span><span class="op" id="8404341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404344">defer</span>&nbsp;<span class="ident" id="8404350">setStrictFakeConnClose</span><span class="op" id="8404372">(</span><span class="builtintype" id="8404373">nil</span><span class="op" id="8404376">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404380">_</span><span class="op" id="8404381">,</span>&nbsp;<span class="ident" id="8404383">err</span>&nbsp;<span class="op" id="8404387">:=</span>&nbsp;<span class="ident" id="8404390">db</span><span class="op" id="8404392">.</span><span class="ident" id="8404393">Query</span><span class="op" id="8404398">(</span><span class="string" id="8404399">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="8404426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404429">if</span>&nbsp;<span class="ident" id="8404432">err</span>&nbsp;<span class="op" id="8404436">==</span>&nbsp;<span class="builtintype" id="8404439">nil</span>&nbsp;<span class="op" id="8404443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404447">t</span><span class="op" id="8404448">.</span><span class="ident" id="8404449">Fatal</span><span class="op" id="8404454">(</span><span class="string" id="8404455">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="8404495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404498">}</span><br>
<span class="lineno">1315</span><span class="op" id="8404500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8404503">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="8404528">func</span>&nbsp;<span class="ident" id="8404533">TestErrBadConnReconnect</span><span class="op" id="8404556">(</span><span class="ident" id="8404557">t</span>&nbsp;<span class="op" id="8404559">*</span><span class="ident" id="8404560">testing</span><span class="op" id="8404567">.</span><span class="ident" id="8404568">T</span><span class="op" id="8404569">)</span>&nbsp;<span class="op" id="8404571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404574">db</span>&nbsp;<span class="op" id="8404577">:=</span>&nbsp;<span class="ident" id="8404580">newTestDB</span><span class="op" id="8404589">(</span><span class="ident" id="8404590">t</span><span class="op" id="8404591">,</span>&nbsp;<span class="string" id="8404593">&#34;foo&#34;</span><span class="op" id="8404598">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404601">defer</span>&nbsp;<span class="ident" id="8404607">closeDB</span><span class="op" id="8404614">(</span><span class="ident" id="8404615">t</span><span class="op" id="8404616">,</span>&nbsp;<span class="ident" id="8404618">db</span><span class="op" id="8404620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404623">exec</span><span class="op" id="8404627">(</span><span class="ident" id="8404628">t</span><span class="op" id="8404629">,</span>&nbsp;<span class="ident" id="8404631">db</span><span class="op" id="8404633">,</span>&nbsp;<span class="string" id="8404635">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8404678">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404682">simulateBadConn</span>&nbsp;<span class="op" id="8404698">:=</span>&nbsp;<span class="keyword" id="8404701">func</span><span class="op" id="8404705">(</span><span class="ident" id="8404706">name</span>&nbsp;<span class="builtintype" id="8404711">string</span><span class="op" id="8404717">,</span>&nbsp;<span class="ident" id="8404719">hook</span>&nbsp;<span class="op" id="8404724">*</span><span class="keyword" id="8404725">func</span><span class="op" id="8404729">(</span><span class="op" id="8404730">)</span>&nbsp;<span class="builtintype" id="8404732">bool</span><span class="op" id="8404736">,</span>&nbsp;<span class="ident" id="8404738">op</span>&nbsp;<span class="keyword" id="8404741">func</span><span class="op" id="8404745">(</span><span class="op" id="8404746">)</span>&nbsp;<span class="builtintype" id="8404748">error</span><span class="op" id="8404753">)</span>&nbsp;<span class="op" id="8404755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404759">broken</span><span class="op" id="8404765">,</span>&nbsp;<span class="ident" id="8404767">retried</span>&nbsp;<span class="op" id="8404775">:=</span>&nbsp;<span class="builtintype" id="8404778">false</span><span class="op" id="8404783">,</span>&nbsp;<span class="builtintype" id="8404785">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404793">numOpen</span>&nbsp;<span class="op" id="8404801">:=</span>&nbsp;<span class="ident" id="8404804">db</span><span class="op" id="8404806">.</span><span class="ident" id="8404807">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8404818">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404869">*</span><span class="ident" id="8404870">hook</span>&nbsp;<span class="op" id="8404875">=</span>&nbsp;<span class="keyword" id="8404877">func</span><span class="op" id="8404881">(</span><span class="op" id="8404882">)</span>&nbsp;<span class="builtintype" id="8404884">bool</span>&nbsp;<span class="op" id="8404889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404894">if</span>&nbsp;<span class="op" id="8404897">!</span><span class="ident" id="8404898">broken</span>&nbsp;<span class="op" id="8404905">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404911">broken</span>&nbsp;<span class="op" id="8404918">=</span>&nbsp;<span class="builtintype" id="8404920">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404929">return</span>&nbsp;<span class="builtintype" id="8404936">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404949">retried</span>&nbsp;<span class="op" id="8404957">=</span>&nbsp;<span class="builtintype" id="8404959">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404967">return</span>&nbsp;<span class="builtintype" id="8404974">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404987">if</span>&nbsp;<span class="ident" id="8404990">err</span>&nbsp;<span class="op" id="8404994">:=</span>&nbsp;<span class="ident" id="8404997">op</span><span class="op" id="8404999">(</span><span class="op" id="8405000">)</span><span class="op" id="8405001">;</span>&nbsp;<span class="ident" id="8405003">err</span>&nbsp;<span class="op" id="8405007">!=</span>&nbsp;<span class="builtintype" id="8405010">nil</span>&nbsp;<span class="op" id="8405014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405019">t</span><span class="op" id="8405020">.</span><span class="ident" id="8405021">Errorf</span><span class="op" id="8405027">(</span><span class="ident" id="8405028">name</span><span class="op" id="8405032">+</span><span class="string" id="8405033">&#34;:&nbsp;%v&#34;</span><span class="op" id="8405039">,</span>&nbsp;<span class="ident" id="8405041">err</span><span class="op" id="8405044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405049">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405063">if</span>&nbsp;<span class="op" id="8405066">!</span><span class="ident" id="8405067">broken</span>&nbsp;<span class="op" id="8405074">||</span>&nbsp;<span class="op" id="8405077">!</span><span class="ident" id="8405078">retried</span>&nbsp;<span class="op" id="8405086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405091">t</span><span class="op" id="8405092">.</span><span class="ident" id="8405093">Error</span><span class="op" id="8405098">(</span><span class="ident" id="8405099">name</span>&nbsp;<span class="op" id="8405104">+</span>&nbsp;<span class="string" id="8405106">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="8405146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405150">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405154">*</span><span class="ident" id="8405155">hook</span>&nbsp;<span class="op" id="8405160">=</span>&nbsp;<span class="builtintype" id="8405162">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405169">if</span>&nbsp;<span class="ident" id="8405172">numOpen</span>&nbsp;<span class="op" id="8405180">!=</span>&nbsp;<span class="ident" id="8405183">db</span><span class="op" id="8405185">.</span><span class="ident" id="8405186">numOpen</span>&nbsp;<span class="op" id="8405194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405199">t</span><span class="op" id="8405200">.</span><span class="ident" id="8405201">Errorf</span><span class="op" id="8405207">(</span><span class="ident" id="8405208">name</span><span class="op" id="8405212">+</span><span class="string" id="8405213">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="8405241">,</span>&nbsp;<span class="ident" id="8405243">db</span><span class="op" id="8405245">.</span><span class="ident" id="8405246">numOpen</span><span class="op" id="8405253">-</span><span class="ident" id="8405254">numOpen</span><span class="op" id="8405261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405266">numOpen</span>&nbsp;<span class="op" id="8405274">=</span>&nbsp;<span class="ident" id="8405276">db</span><span class="op" id="8405278">.</span><span class="ident" id="8405279">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8405296">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405308">dbExec</span>&nbsp;<span class="op" id="8405315">:=</span>&nbsp;<span class="keyword" id="8405318">func</span><span class="op" id="8405322">(</span><span class="op" id="8405323">)</span>&nbsp;<span class="builtintype" id="8405325">error</span>&nbsp;<span class="op" id="8405331">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405335">_</span><span class="op" id="8405336">,</span>&nbsp;<span class="ident" id="8405338">err</span>&nbsp;<span class="op" id="8405342">:=</span>&nbsp;<span class="ident" id="8405345">db</span><span class="op" id="8405347">.</span><span class="ident" id="8405348">Exec</span><span class="op" id="8405352">(</span><span class="string" id="8405353">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8405384">,</span>&nbsp;<span class="string" id="8405386">&#34;Gordon&#34;</span><span class="op" id="8405394">,</span>&nbsp;<span class="num" id="8405396">3</span><span class="op" id="8405397">,</span>&nbsp;<span class="builtintype" id="8405399">true</span><span class="op" id="8405403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405407">return</span>&nbsp;<span class="ident" id="8405414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405422">simulateBadConn</span><span class="op" id="8405437">(</span><span class="string" id="8405438">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="8405455">,</span>&nbsp;<span class="op" id="8405457">&amp;</span><span class="ident" id="8405458">hookPrepareBadConn</span><span class="op" id="8405476">,</span>&nbsp;<span class="ident" id="8405478">dbExec</span><span class="op" id="8405484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405487">simulateBadConn</span><span class="op" id="8405502">(</span><span class="string" id="8405503">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="8405517">,</span>&nbsp;<span class="op" id="8405519">&amp;</span><span class="ident" id="8405520">hookExecBadConn</span><span class="op" id="8405535">,</span>&nbsp;<span class="ident" id="8405537">dbExec</span><span class="op" id="8405543">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8405547">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405560">dbQuery</span>&nbsp;<span class="op" id="8405568">:=</span>&nbsp;<span class="keyword" id="8405571">func</span><span class="op" id="8405575">(</span><span class="op" id="8405576">)</span>&nbsp;<span class="builtintype" id="8405578">error</span>&nbsp;<span class="op" id="8405584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405588">rows</span><span class="op" id="8405592">,</span>&nbsp;<span class="ident" id="8405594">err</span>&nbsp;<span class="op" id="8405598">:=</span>&nbsp;<span class="ident" id="8405601">db</span><span class="op" id="8405603">.</span><span class="ident" id="8405604">Query</span><span class="op" id="8405609">(</span><span class="string" id="8405610">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="8405631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405635">if</span>&nbsp;<span class="ident" id="8405638">err</span>&nbsp;<span class="op" id="8405642">==</span>&nbsp;<span class="builtintype" id="8405645">nil</span>&nbsp;<span class="op" id="8405649">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405654">err</span>&nbsp;<span class="op" id="8405658">=</span>&nbsp;<span class="ident" id="8405660">rows</span><span class="op" id="8405664">.</span><span class="ident" id="8405665">Close</span><span class="op" id="8405670">(</span><span class="op" id="8405671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405679">return</span>&nbsp;<span class="ident" id="8405686">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405694">simulateBadConn</span><span class="op" id="8405709">(</span><span class="string" id="8405710">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="8405728">,</span>&nbsp;<span class="op" id="8405730">&amp;</span><span class="ident" id="8405731">hookPrepareBadConn</span><span class="op" id="8405749">,</span>&nbsp;<span class="ident" id="8405751">dbQuery</span><span class="op" id="8405758">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405761">simulateBadConn</span><span class="op" id="8405776">(</span><span class="string" id="8405777">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="8405793">,</span>&nbsp;<span class="op" id="8405795">&amp;</span><span class="ident" id="8405796">hookQueryBadConn</span><span class="op" id="8405812">,</span>&nbsp;<span class="ident" id="8405814">dbQuery</span><span class="op" id="8405821">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8405825">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405840">simulateBadConn</span><span class="op" id="8405855">(</span><span class="string" id="8405856">&#34;db.Prepare&#34;</span><span class="op" id="8405868">,</span>&nbsp;<span class="op" id="8405870">&amp;</span><span class="ident" id="8405871">hookPrepareBadConn</span><span class="op" id="8405889">,</span>&nbsp;<span class="keyword" id="8405891">func</span><span class="op" id="8405895">(</span><span class="op" id="8405896">)</span>&nbsp;<span class="builtintype" id="8405898">error</span>&nbsp;<span class="op" id="8405904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405908">stmt</span><span class="op" id="8405912">,</span>&nbsp;<span class="ident" id="8405914">err</span>&nbsp;<span class="op" id="8405918">:=</span>&nbsp;<span class="ident" id="8405921">db</span><span class="op" id="8405923">.</span><span class="ident" id="8405924">Prepare</span><span class="op" id="8405931">(</span><span class="string" id="8405932">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8405963">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405967">if</span>&nbsp;<span class="ident" id="8405970">err</span>&nbsp;<span class="op" id="8405974">!=</span>&nbsp;<span class="builtintype" id="8405977">nil</span>&nbsp;<span class="op" id="8405981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405986">return</span>&nbsp;<span class="ident" id="8405993">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406003">stmt</span><span class="op" id="8406007">.</span><span class="ident" id="8406008">Close</span><span class="op" id="8406013">(</span><span class="op" id="8406014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406018">return</span>&nbsp;<span class="builtintype" id="8406025">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406030">}</span><span class="op" id="8406031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8406035">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406108">forcePrepare</span>&nbsp;<span class="op" id="8406121">:=</span>&nbsp;<span class="keyword" id="8406124">func</span><span class="op" id="8406128">(</span><span class="ident" id="8406129">stmt</span>&nbsp;<span class="op" id="8406134">*</span><span class="ident" id="8406135">Stmt</span><span class="op" id="8406139">)</span>&nbsp;<span class="op" id="8406141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406145">stmt</span><span class="op" id="8406149">.</span><span class="ident" id="8406150">css</span>&nbsp;<span class="op" id="8406154">=</span>&nbsp;<span class="builtintype" id="8406156">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8406165">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406179">stmt1</span><span class="op" id="8406184">,</span>&nbsp;<span class="ident" id="8406186">err</span>&nbsp;<span class="op" id="8406190">:=</span>&nbsp;<span class="ident" id="8406193">db</span><span class="op" id="8406195">.</span><span class="ident" id="8406196">Prepare</span><span class="op" id="8406203">(</span><span class="string" id="8406204">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8406235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406238">if</span>&nbsp;<span class="ident" id="8406241">err</span>&nbsp;<span class="op" id="8406245">!=</span>&nbsp;<span class="builtintype" id="8406248">nil</span>&nbsp;<span class="op" id="8406252">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406256">t</span><span class="op" id="8406257">.</span><span class="ident" id="8406258">Fatalf</span><span class="op" id="8406264">(</span><span class="string" id="8406265">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8406278">,</span>&nbsp;<span class="ident" id="8406280">err</span><span class="op" id="8406283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406289">defer</span>&nbsp;<span class="ident" id="8406295">stmt1</span><span class="op" id="8406300">.</span><span class="ident" id="8406301">Close</span><span class="op" id="8406306">(</span><span class="op" id="8406307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8406310">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406355">forcePrepare</span><span class="op" id="8406367">(</span><span class="ident" id="8406368">stmt1</span><span class="op" id="8406373">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406377">stmtExec</span>&nbsp;<span class="op" id="8406386">:=</span>&nbsp;<span class="keyword" id="8406389">func</span><span class="op" id="8406393">(</span><span class="op" id="8406394">)</span>&nbsp;<span class="builtintype" id="8406396">error</span>&nbsp;<span class="op" id="8406402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406406">_</span><span class="op" id="8406407">,</span>&nbsp;<span class="ident" id="8406409">err</span>&nbsp;<span class="op" id="8406413">:=</span>&nbsp;<span class="ident" id="8406416">stmt1</span><span class="op" id="8406421">.</span><span class="ident" id="8406422">Exec</span><span class="op" id="8406426">(</span><span class="string" id="8406427">&#34;Gopher&#34;</span><span class="op" id="8406435">,</span>&nbsp;<span class="num" id="8406437">3</span><span class="op" id="8406438">,</span>&nbsp;<span class="builtintype" id="8406440">false</span><span class="op" id="8406445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406449">return</span>&nbsp;<span class="ident" id="8406456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406461">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406464">simulateBadConn</span><span class="op" id="8406479">(</span><span class="string" id="8406480">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="8406499">,</span>&nbsp;<span class="op" id="8406501">&amp;</span><span class="ident" id="8406502">hookPrepareBadConn</span><span class="op" id="8406520">,</span>&nbsp;<span class="ident" id="8406522">stmtExec</span><span class="op" id="8406530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406533">simulateBadConn</span><span class="op" id="8406548">(</span><span class="string" id="8406549">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="8406565">,</span>&nbsp;<span class="op" id="8406567">&amp;</span><span class="ident" id="8406568">hookExecBadConn</span><span class="op" id="8406583">,</span>&nbsp;<span class="ident" id="8406585">stmtExec</span><span class="op" id="8406593">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8406597">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406612">stmt2</span><span class="op" id="8406617">,</span>&nbsp;<span class="ident" id="8406619">err</span>&nbsp;<span class="op" id="8406623">:=</span>&nbsp;<span class="ident" id="8406626">db</span><span class="op" id="8406628">.</span><span class="ident" id="8406629">Prepare</span><span class="op" id="8406636">(</span><span class="string" id="8406637">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="8406658">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406661">if</span>&nbsp;<span class="ident" id="8406664">err</span>&nbsp;<span class="op" id="8406668">!=</span>&nbsp;<span class="builtintype" id="8406671">nil</span>&nbsp;<span class="op" id="8406675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406679">t</span><span class="op" id="8406680">.</span><span class="ident" id="8406681">Fatalf</span><span class="op" id="8406687">(</span><span class="string" id="8406688">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8406701">,</span>&nbsp;<span class="ident" id="8406703">err</span><span class="op" id="8406706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406712">defer</span>&nbsp;<span class="ident" id="8406718">stmt2</span><span class="op" id="8406723">.</span><span class="ident" id="8406724">Close</span><span class="op" id="8406729">(</span><span class="op" id="8406730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8406733">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406778">forcePrepare</span><span class="op" id="8406790">(</span><span class="ident" id="8406791">stmt2</span><span class="op" id="8406796">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406800">stmtQuery</span>&nbsp;<span class="op" id="8406810">:=</span>&nbsp;<span class="keyword" id="8406813">func</span><span class="op" id="8406817">(</span><span class="op" id="8406818">)</span>&nbsp;<span class="builtintype" id="8406820">error</span>&nbsp;<span class="op" id="8406826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406830">rows</span><span class="op" id="8406834">,</span>&nbsp;<span class="ident" id="8406836">err</span>&nbsp;<span class="op" id="8406840">:=</span>&nbsp;<span class="ident" id="8406843">stmt2</span><span class="op" id="8406848">.</span><span class="ident" id="8406849">Query</span><span class="op" id="8406854">(</span><span class="op" id="8406855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406859">if</span>&nbsp;<span class="ident" id="8406862">err</span>&nbsp;<span class="op" id="8406866">==</span>&nbsp;<span class="builtintype" id="8406869">nil</span>&nbsp;<span class="op" id="8406873">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406878">err</span>&nbsp;<span class="op" id="8406882">=</span>&nbsp;<span class="ident" id="8406884">rows</span><span class="op" id="8406888">.</span><span class="ident" id="8406889">Close</span><span class="op" id="8406894">(</span><span class="op" id="8406895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406903">return</span>&nbsp;<span class="ident" id="8406910">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406918">simulateBadConn</span><span class="op" id="8406933">(</span><span class="string" id="8406934">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="8406954">,</span>&nbsp;<span class="op" id="8406956">&amp;</span><span class="ident" id="8406957">hookPrepareBadConn</span><span class="op" id="8406975">,</span>&nbsp;<span class="ident" id="8406977">stmtQuery</span><span class="op" id="8406986">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406989">simulateBadConn</span><span class="op" id="8407004">(</span><span class="string" id="8407005">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="8407022">,</span>&nbsp;<span class="op" id="8407024">&amp;</span><span class="ident" id="8407025">hookQueryBadConn</span><span class="op" id="8407041">,</span>&nbsp;<span class="ident" id="8407043">stmtQuery</span><span class="op" id="8407052">)</span><br>
<span class="lineno"></span><span class="op" id="8407054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407057">type</span>&nbsp;<span class="ident" id="8407062">concurrentTest</span>&nbsp;<span class="keyword" id="8407077">interface</span>&nbsp;<span class="op" id="8407087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407090">init</span><span class="op" id="8407094">(</span><span class="ident" id="8407095">t</span>&nbsp;<span class="ident" id="8407097">testing</span><span class="op" id="8407104">.</span><span class="ident" id="8407105">TB</span><span class="op" id="8407107">,</span>&nbsp;<span class="ident" id="8407109">db</span>&nbsp;<span class="op" id="8407112">*</span><span class="ident" id="8407113">DB</span><span class="op" id="8407115">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407118">finish</span><span class="op" id="8407124">(</span><span class="ident" id="8407125">t</span>&nbsp;<span class="ident" id="8407127">testing</span><span class="op" id="8407134">.</span><span class="ident" id="8407135">TB</span><span class="op" id="8407137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407140">test</span><span class="op" id="8407144">(</span><span class="ident" id="8407145">t</span>&nbsp;<span class="ident" id="8407147">testing</span><span class="op" id="8407154">.</span><span class="ident" id="8407155">TB</span><span class="op" id="8407157">)</span>&nbsp;<span class="builtintype" id="8407159">error</span><br>
<span class="lineno"></span><span class="op" id="8407165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407168">type</span>&nbsp;<span class="ident" id="8407173">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="8407195">struct</span>&nbsp;<span class="op" id="8407202">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407205">db</span>&nbsp;<span class="op" id="8407208">*</span><span class="ident" id="8407209">DB</span><br>
<span class="lineno"></span><span class="op" id="8407212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407215">func</span>&nbsp;<span class="op" id="8407220">(</span><span class="ident" id="8407221">c</span>&nbsp;<span class="op" id="8407223">*</span><span class="ident" id="8407224">concurrentDBQueryTest</span><span class="op" id="8407245">)</span>&nbsp;<span class="ident" id="8407247">init</span><span class="op" id="8407251">(</span><span class="ident" id="8407252">t</span>&nbsp;<span class="ident" id="8407254">testing</span><span class="op" id="8407261">.</span><span class="ident" id="8407262">TB</span><span class="op" id="8407264">,</span>&nbsp;<span class="ident" id="8407266">db</span>&nbsp;<span class="op" id="8407269">*</span><span class="ident" id="8407270">DB</span><span class="op" id="8407272">)</span>&nbsp;<span class="op" id="8407274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407277">c</span><span class="op" id="8407278">.</span><span class="ident" id="8407279">db</span>&nbsp;<span class="op" id="8407282">=</span>&nbsp;<span class="ident" id="8407284">db</span><br>
<span class="lineno">1435</span><span class="op" id="8407287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407290">func</span>&nbsp;<span class="op" id="8407295">(</span><span class="ident" id="8407296">c</span>&nbsp;<span class="op" id="8407298">*</span><span class="ident" id="8407299">concurrentDBQueryTest</span><span class="op" id="8407320">)</span>&nbsp;<span class="ident" id="8407322">finish</span><span class="op" id="8407328">(</span><span class="ident" id="8407329">t</span>&nbsp;<span class="ident" id="8407331">testing</span><span class="op" id="8407338">.</span><span class="ident" id="8407339">TB</span><span class="op" id="8407341">)</span>&nbsp;<span class="op" id="8407343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407346">c</span><span class="op" id="8407347">.</span><span class="ident" id="8407348">db</span>&nbsp;<span class="op" id="8407351">=</span>&nbsp;<span class="builtintype" id="8407353">nil</span><br>
<span class="lineno"></span><span class="op" id="8407357">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="8407360">func</span>&nbsp;<span class="op" id="8407365">(</span><span class="ident" id="8407366">c</span>&nbsp;<span class="op" id="8407368">*</span><span class="ident" id="8407369">concurrentDBQueryTest</span><span class="op" id="8407390">)</span>&nbsp;<span class="ident" id="8407392">test</span><span class="op" id="8407396">(</span><span class="ident" id="8407397">t</span>&nbsp;<span class="ident" id="8407399">testing</span><span class="op" id="8407406">.</span><span class="ident" id="8407407">TB</span><span class="op" id="8407409">)</span>&nbsp;<span class="builtintype" id="8407411">error</span>&nbsp;<span class="op" id="8407417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407420">rows</span><span class="op" id="8407424">,</span>&nbsp;<span class="ident" id="8407426">err</span>&nbsp;<span class="op" id="8407430">:=</span>&nbsp;<span class="ident" id="8407433">c</span><span class="op" id="8407434">.</span><span class="ident" id="8407435">db</span><span class="op" id="8407437">.</span><span class="ident" id="8407438">Query</span><span class="op" id="8407443">(</span><span class="string" id="8407444">&#34;SELECT|people|name|&#34;</span><span class="op" id="8407465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8407468">if</span>&nbsp;<span class="ident" id="8407471">err</span>&nbsp;<span class="op" id="8407475">!=</span>&nbsp;<span class="builtintype" id="8407478">nil</span>&nbsp;<span class="op" id="8407482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407486">t</span><span class="op" id="8407487">.</span><span class="ident" id="8407488">Error</span><span class="op" id="8407493">(</span><span class="ident" id="8407494">err</span><span class="op" id="8407497">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8407501">return</span>&nbsp;<span class="ident" id="8407508">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8407513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8407516">var</span>&nbsp;<span class="ident" id="8407520">name</span>&nbsp;<span class="builtintype" id="8407525">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8407533">for</span>&nbsp;<span class="ident" id="8407537">rows</span><span class="op" id="8407541">.</span><span class="ident" id="8407542">Next</span><span class="op" id="8407546">(</span><span class="op" id="8407547">)</span>&nbsp;<span class="op" id="8407549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407553">rows</span><span class="op" id="8407557">.</span><span class="ident" id="8407558">Scan</span><span class="op" id="8407562">(</span><span class="op" id="8407563">&amp;</span><span class="ident" id="8407564">name</span><span class="op" id="8407568">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8407571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407574">rows</span><span class="op" id="8407578">.</span><span class="ident" id="8407579">Close</span><span class="op" id="8407584">(</span><span class="op" id="8407585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8407588">return</span>&nbsp;<span class="builtintype" id="8407595">nil</span><br>
<span class="lineno"></span><span class="op" id="8407599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="8407602">type</span>&nbsp;<span class="ident" id="8407607">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="8407628">struct</span>&nbsp;<span class="op" id="8407635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407638">db</span>&nbsp;<span class="op" id="8407641">*</span><span class="ident" id="8407642">DB</span><br>
<span class="lineno"></span><span class="op" id="8407645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407648">func</span>&nbsp;<span class="op" id="8407653">(</span><span class="ident" id="8407654">c</span>&nbsp;<span class="op" id="8407656">*</span><span class="ident" id="8407657">concurrentDBExecTest</span><span class="op" id="8407677">)</span>&nbsp;<span class="ident" id="8407679">init</span><span class="op" id="8407683">(</span><span class="ident" id="8407684">t</span>&nbsp;<span class="ident" id="8407686">testing</span><span class="op" id="8407693">.</span><span class="ident" id="8407694">TB</span><span class="op" id="8407696">,</span>&nbsp;<span class="ident" id="8407698">db</span>&nbsp;<span class="op" id="8407701">*</span><span class="ident" id="8407702">DB</span><span class="op" id="8407704">)</span>&nbsp;<span class="op" id="8407706">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407709">c</span><span class="op" id="8407710">.</span><span class="ident" id="8407711">db</span>&nbsp;<span class="op" id="8407714">=</span>&nbsp;<span class="ident" id="8407716">db</span><br>
<span class="lineno"></span><span class="op" id="8407719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407722">func</span>&nbsp;<span class="op" id="8407727">(</span><span class="ident" id="8407728">c</span>&nbsp;<span class="op" id="8407730">*</span><span class="ident" id="8407731">concurrentDBExecTest</span><span class="op" id="8407751">)</span>&nbsp;<span class="ident" id="8407753">finish</span><span class="op" id="8407759">(</span><span class="ident" id="8407760">t</span>&nbsp;<span class="ident" id="8407762">testing</span><span class="op" id="8407769">.</span><span class="ident" id="8407770">TB</span><span class="op" id="8407772">)</span>&nbsp;<span class="op" id="8407774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407777">c</span><span class="op" id="8407778">.</span><span class="ident" id="8407779">db</span>&nbsp;<span class="op" id="8407782">=</span>&nbsp;<span class="builtintype" id="8407784">nil</span><br>
<span class="lineno">1465</span><span class="op" id="8407788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407791">func</span>&nbsp;<span class="op" id="8407796">(</span><span class="ident" id="8407797">c</span>&nbsp;<span class="op" id="8407799">*</span><span class="ident" id="8407800">concurrentDBExecTest</span><span class="op" id="8407820">)</span>&nbsp;<span class="ident" id="8407822">test</span><span class="op" id="8407826">(</span><span class="ident" id="8407827">t</span>&nbsp;<span class="ident" id="8407829">testing</span><span class="op" id="8407836">.</span><span class="ident" id="8407837">TB</span><span class="op" id="8407839">)</span>&nbsp;<span class="builtintype" id="8407841">error</span>&nbsp;<span class="op" id="8407847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407850">_</span><span class="op" id="8407851">,</span>&nbsp;<span class="ident" id="8407853">err</span>&nbsp;<span class="op" id="8407857">:=</span>&nbsp;<span class="ident" id="8407860">c</span><span class="op" id="8407861">.</span><span class="ident" id="8407862">db</span><span class="op" id="8407864">.</span><span class="ident" id="8407865">Exec</span><span class="op" id="8407869">(</span><span class="string" id="8407870">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8407923">,</span>&nbsp;<span class="num" id="8407925">3</span><span class="op" id="8407926">,</span>&nbsp;<span class="ident" id="8407928">chrisBirthday</span><span class="op" id="8407941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8407944">if</span>&nbsp;<span class="ident" id="8407947">err</span>&nbsp;<span class="op" id="8407951">!=</span>&nbsp;<span class="builtintype" id="8407954">nil</span>&nbsp;<span class="op" id="8407958">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407962">t</span><span class="op" id="8407963">.</span><span class="ident" id="8407964">Error</span><span class="op" id="8407969">(</span><span class="ident" id="8407970">err</span><span class="op" id="8407973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8407977">return</span>&nbsp;<span class="ident" id="8407984">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8407989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8407992">return</span>&nbsp;<span class="builtintype" id="8407999">nil</span><br>
<span class="lineno"></span><span class="op" id="8408003">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="8408006">type</span>&nbsp;<span class="ident" id="8408011">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="8408035">struct</span>&nbsp;<span class="op" id="8408042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408045">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8408050">*</span><span class="ident" id="8408051">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408055">stmt</span>&nbsp;<span class="op" id="8408060">*</span><span class="ident" id="8408061">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8408066">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="8408069">func</span>&nbsp;<span class="op" id="8408074">(</span><span class="ident" id="8408075">c</span>&nbsp;<span class="op" id="8408077">*</span><span class="ident" id="8408078">concurrentStmtQueryTest</span><span class="op" id="8408101">)</span>&nbsp;<span class="ident" id="8408103">init</span><span class="op" id="8408107">(</span><span class="ident" id="8408108">t</span>&nbsp;<span class="ident" id="8408110">testing</span><span class="op" id="8408117">.</span><span class="ident" id="8408118">TB</span><span class="op" id="8408120">,</span>&nbsp;<span class="ident" id="8408122">db</span>&nbsp;<span class="op" id="8408125">*</span><span class="ident" id="8408126">DB</span><span class="op" id="8408128">)</span>&nbsp;<span class="op" id="8408130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408133">c</span><span class="op" id="8408134">.</span><span class="ident" id="8408135">db</span>&nbsp;<span class="op" id="8408138">=</span>&nbsp;<span class="ident" id="8408140">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408144">var</span>&nbsp;<span class="ident" id="8408148">err</span>&nbsp;<span class="builtintype" id="8408152">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408159">c</span><span class="op" id="8408160">.</span><span class="ident" id="8408161">stmt</span><span class="op" id="8408165">,</span>&nbsp;<span class="ident" id="8408167">err</span>&nbsp;<span class="op" id="8408171">=</span>&nbsp;<span class="ident" id="8408173">db</span><span class="op" id="8408175">.</span><span class="ident" id="8408176">Prepare</span><span class="op" id="8408183">(</span><span class="string" id="8408184">&#34;SELECT|people|name|&#34;</span><span class="op" id="8408205">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408208">if</span>&nbsp;<span class="ident" id="8408211">err</span>&nbsp;<span class="op" id="8408215">!=</span>&nbsp;<span class="builtintype" id="8408218">nil</span>&nbsp;<span class="op" id="8408222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408226">t</span><span class="op" id="8408227">.</span><span class="ident" id="8408228">Fatal</span><span class="op" id="8408233">(</span><span class="ident" id="8408234">err</span><span class="op" id="8408237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408240">}</span><br>
<span class="lineno"></span><span class="op" id="8408242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="8408245">func</span>&nbsp;<span class="op" id="8408250">(</span><span class="ident" id="8408251">c</span>&nbsp;<span class="op" id="8408253">*</span><span class="ident" id="8408254">concurrentStmtQueryTest</span><span class="op" id="8408277">)</span>&nbsp;<span class="ident" id="8408279">finish</span><span class="op" id="8408285">(</span><span class="ident" id="8408286">t</span>&nbsp;<span class="ident" id="8408288">testing</span><span class="op" id="8408295">.</span><span class="ident" id="8408296">TB</span><span class="op" id="8408298">)</span>&nbsp;<span class="op" id="8408300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408303">if</span>&nbsp;<span class="ident" id="8408306">c</span><span class="op" id="8408307">.</span><span class="ident" id="8408308">stmt</span>&nbsp;<span class="op" id="8408313">!=</span>&nbsp;<span class="builtintype" id="8408316">nil</span>&nbsp;<span class="op" id="8408320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408324">c</span><span class="op" id="8408325">.</span><span class="ident" id="8408326">stmt</span><span class="op" id="8408330">.</span><span class="ident" id="8408331">Close</span><span class="op" id="8408336">(</span><span class="op" id="8408337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408341">c</span><span class="op" id="8408342">.</span><span class="ident" id="8408343">stmt</span>&nbsp;<span class="op" id="8408348">=</span>&nbsp;<span class="builtintype" id="8408350">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408355">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408358">c</span><span class="op" id="8408359">.</span><span class="ident" id="8408360">db</span>&nbsp;<span class="op" id="8408363">=</span>&nbsp;<span class="builtintype" id="8408365">nil</span><br>
<span class="lineno"></span><span class="op" id="8408369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8408372">func</span>&nbsp;<span class="op" id="8408377">(</span><span class="ident" id="8408378">c</span>&nbsp;<span class="op" id="8408380">*</span><span class="ident" id="8408381">concurrentStmtQueryTest</span><span class="op" id="8408404">)</span>&nbsp;<span class="ident" id="8408406">test</span><span class="op" id="8408410">(</span><span class="ident" id="8408411">t</span>&nbsp;<span class="ident" id="8408413">testing</span><span class="op" id="8408420">.</span><span class="ident" id="8408421">TB</span><span class="op" id="8408423">)</span>&nbsp;<span class="builtintype" id="8408425">error</span>&nbsp;<span class="op" id="8408431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408434">rows</span><span class="op" id="8408438">,</span>&nbsp;<span class="ident" id="8408440">err</span>&nbsp;<span class="op" id="8408444">:=</span>&nbsp;<span class="ident" id="8408447">c</span><span class="op" id="8408448">.</span><span class="ident" id="8408449">stmt</span><span class="op" id="8408453">.</span><span class="ident" id="8408454">Query</span><span class="op" id="8408459">(</span><span class="op" id="8408460">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408463">if</span>&nbsp;<span class="ident" id="8408466">err</span>&nbsp;<span class="op" id="8408470">!=</span>&nbsp;<span class="builtintype" id="8408473">nil</span>&nbsp;<span class="op" id="8408477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408481">t</span><span class="op" id="8408482">.</span><span class="ident" id="8408483">Errorf</span><span class="op" id="8408489">(</span><span class="string" id="8408490">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8408511">,</span>&nbsp;<span class="ident" id="8408513">err</span><span class="op" id="8408516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408520">return</span>&nbsp;<span class="ident" id="8408527">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408536">var</span>&nbsp;<span class="ident" id="8408540">name</span>&nbsp;<span class="builtintype" id="8408545">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408553">for</span>&nbsp;<span class="ident" id="8408557">rows</span><span class="op" id="8408561">.</span><span class="ident" id="8408562">Next</span><span class="op" id="8408566">(</span><span class="op" id="8408567">)</span>&nbsp;<span class="op" id="8408569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408573">rows</span><span class="op" id="8408577">.</span><span class="ident" id="8408578">Scan</span><span class="op" id="8408582">(</span><span class="op" id="8408583">&amp;</span><span class="ident" id="8408584">name</span><span class="op" id="8408588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408594">rows</span><span class="op" id="8408598">.</span><span class="ident" id="8408599">Close</span><span class="op" id="8408604">(</span><span class="op" id="8408605">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408608">return</span>&nbsp;<span class="builtintype" id="8408615">nil</span><br>
<span class="lineno"></span><span class="op" id="8408619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8408622">type</span>&nbsp;<span class="ident" id="8408627">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="8408650">struct</span>&nbsp;<span class="op" id="8408657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408660">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8408665">*</span><span class="ident" id="8408666">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408670">stmt</span>&nbsp;<span class="op" id="8408675">*</span><span class="ident" id="8408676">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8408681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8408684">func</span>&nbsp;<span class="op" id="8408689">(</span><span class="ident" id="8408690">c</span>&nbsp;<span class="op" id="8408692">*</span><span class="ident" id="8408693">concurrentStmtExecTest</span><span class="op" id="8408715">)</span>&nbsp;<span class="ident" id="8408717">init</span><span class="op" id="8408721">(</span><span class="ident" id="8408722">t</span>&nbsp;<span class="ident" id="8408724">testing</span><span class="op" id="8408731">.</span><span class="ident" id="8408732">TB</span><span class="op" id="8408734">,</span>&nbsp;<span class="ident" id="8408736">db</span>&nbsp;<span class="op" id="8408739">*</span><span class="ident" id="8408740">DB</span><span class="op" id="8408742">)</span>&nbsp;<span class="op" id="8408744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408747">c</span><span class="op" id="8408748">.</span><span class="ident" id="8408749">db</span>&nbsp;<span class="op" id="8408752">=</span>&nbsp;<span class="ident" id="8408754">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408758">var</span>&nbsp;<span class="ident" id="8408762">err</span>&nbsp;<span class="builtintype" id="8408766">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408773">c</span><span class="op" id="8408774">.</span><span class="ident" id="8408775">stmt</span><span class="op" id="8408779">,</span>&nbsp;<span class="ident" id="8408781">err</span>&nbsp;<span class="op" id="8408785">=</span>&nbsp;<span class="ident" id="8408787">db</span><span class="op" id="8408789">.</span><span class="ident" id="8408790">Prepare</span><span class="op" id="8408797">(</span><span class="string" id="8408798">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8408851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408854">if</span>&nbsp;<span class="ident" id="8408857">err</span>&nbsp;<span class="op" id="8408861">!=</span>&nbsp;<span class="builtintype" id="8408864">nil</span>&nbsp;<span class="op" id="8408868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408872">t</span><span class="op" id="8408873">.</span><span class="ident" id="8408874">Fatal</span><span class="op" id="8408879">(</span><span class="ident" id="8408880">err</span><span class="op" id="8408883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408886">}</span><br>
<span class="lineno">1525</span><span class="op" id="8408888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8408891">func</span>&nbsp;<span class="op" id="8408896">(</span><span class="ident" id="8408897">c</span>&nbsp;<span class="op" id="8408899">*</span><span class="ident" id="8408900">concurrentStmtExecTest</span><span class="op" id="8408922">)</span>&nbsp;<span class="ident" id="8408924">finish</span><span class="op" id="8408930">(</span><span class="ident" id="8408931">t</span>&nbsp;<span class="ident" id="8408933">testing</span><span class="op" id="8408940">.</span><span class="ident" id="8408941">TB</span><span class="op" id="8408943">)</span>&nbsp;<span class="op" id="8408945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8408948">if</span>&nbsp;<span class="ident" id="8408951">c</span><span class="op" id="8408952">.</span><span class="ident" id="8408953">stmt</span>&nbsp;<span class="op" id="8408958">!=</span>&nbsp;<span class="builtintype" id="8408961">nil</span>&nbsp;<span class="op" id="8408965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408969">c</span><span class="op" id="8408970">.</span><span class="ident" id="8408971">stmt</span><span class="op" id="8408975">.</span><span class="ident" id="8408976">Close</span><span class="op" id="8408981">(</span><span class="op" id="8408982">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408986">c</span><span class="op" id="8408987">.</span><span class="ident" id="8408988">stmt</span>&nbsp;<span class="op" id="8408993">=</span>&nbsp;<span class="builtintype" id="8408995">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409003">c</span><span class="op" id="8409004">.</span><span class="ident" id="8409005">db</span>&nbsp;<span class="op" id="8409008">=</span>&nbsp;<span class="builtintype" id="8409010">nil</span><br>
<span class="lineno"></span><span class="op" id="8409014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="8409017">func</span>&nbsp;<span class="op" id="8409022">(</span><span class="ident" id="8409023">c</span>&nbsp;<span class="op" id="8409025">*</span><span class="ident" id="8409026">concurrentStmtExecTest</span><span class="op" id="8409048">)</span>&nbsp;<span class="ident" id="8409050">test</span><span class="op" id="8409054">(</span><span class="ident" id="8409055">t</span>&nbsp;<span class="ident" id="8409057">testing</span><span class="op" id="8409064">.</span><span class="ident" id="8409065">TB</span><span class="op" id="8409067">)</span>&nbsp;<span class="builtintype" id="8409069">error</span>&nbsp;<span class="op" id="8409075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409078">_</span><span class="op" id="8409079">,</span>&nbsp;<span class="ident" id="8409081">err</span>&nbsp;<span class="op" id="8409085">:=</span>&nbsp;<span class="ident" id="8409088">c</span><span class="op" id="8409089">.</span><span class="ident" id="8409090">stmt</span><span class="op" id="8409094">.</span><span class="ident" id="8409095">Exec</span><span class="op" id="8409099">(</span><span class="num" id="8409100">3</span><span class="op" id="8409101">,</span>&nbsp;<span class="ident" id="8409103">chrisBirthday</span><span class="op" id="8409116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409119">if</span>&nbsp;<span class="ident" id="8409122">err</span>&nbsp;<span class="op" id="8409126">!=</span>&nbsp;<span class="builtintype" id="8409129">nil</span>&nbsp;<span class="op" id="8409133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409137">t</span><span class="op" id="8409138">.</span><span class="ident" id="8409139">Errorf</span><span class="op" id="8409145">(</span><span class="string" id="8409146">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8409166">,</span>&nbsp;<span class="ident" id="8409168">err</span><span class="op" id="8409171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409175">return</span>&nbsp;<span class="ident" id="8409182">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409190">return</span>&nbsp;<span class="builtintype" id="8409197">nil</span><br>
<span class="lineno"></span><span class="op" id="8409201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8409204">type</span>&nbsp;<span class="ident" id="8409209">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="8409231">struct</span>&nbsp;<span class="op" id="8409238">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409241">db</span>&nbsp;<span class="op" id="8409244">*</span><span class="ident" id="8409245">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409249">tx</span>&nbsp;<span class="op" id="8409252">*</span><span class="ident" id="8409253">Tx</span><br>
<span class="lineno"></span><span class="op" id="8409256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8409259">func</span>&nbsp;<span class="op" id="8409264">(</span><span class="ident" id="8409265">c</span>&nbsp;<span class="op" id="8409267">*</span><span class="ident" id="8409268">concurrentTxQueryTest</span><span class="op" id="8409289">)</span>&nbsp;<span class="ident" id="8409291">init</span><span class="op" id="8409295">(</span><span class="ident" id="8409296">t</span>&nbsp;<span class="ident" id="8409298">testing</span><span class="op" id="8409305">.</span><span class="ident" id="8409306">TB</span><span class="op" id="8409308">,</span>&nbsp;<span class="ident" id="8409310">db</span>&nbsp;<span class="op" id="8409313">*</span><span class="ident" id="8409314">DB</span><span class="op" id="8409316">)</span>&nbsp;<span class="op" id="8409318">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409321">c</span><span class="op" id="8409322">.</span><span class="ident" id="8409323">db</span>&nbsp;<span class="op" id="8409326">=</span>&nbsp;<span class="ident" id="8409328">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409332">var</span>&nbsp;<span class="ident" id="8409336">err</span>&nbsp;<span class="builtintype" id="8409340">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409347">c</span><span class="op" id="8409348">.</span><span class="ident" id="8409349">tx</span><span class="op" id="8409351">,</span>&nbsp;<span class="ident" id="8409353">err</span>&nbsp;<span class="op" id="8409357">=</span>&nbsp;<span class="ident" id="8409359">c</span><span class="op" id="8409360">.</span><span class="ident" id="8409361">db</span><span class="op" id="8409363">.</span><span class="ident" id="8409364">Begin</span><span class="op" id="8409369">(</span><span class="op" id="8409370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409373">if</span>&nbsp;<span class="ident" id="8409376">err</span>&nbsp;<span class="op" id="8409380">!=</span>&nbsp;<span class="builtintype" id="8409383">nil</span>&nbsp;<span class="op" id="8409387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409391">t</span><span class="op" id="8409392">.</span><span class="ident" id="8409393">Fatal</span><span class="op" id="8409398">(</span><span class="ident" id="8409399">err</span><span class="op" id="8409402">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409405">}</span><br>
<span class="lineno"></span><span class="op" id="8409407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8409410">func</span>&nbsp;<span class="op" id="8409415">(</span><span class="ident" id="8409416">c</span>&nbsp;<span class="op" id="8409418">*</span><span class="ident" id="8409419">concurrentTxQueryTest</span><span class="op" id="8409440">)</span>&nbsp;<span class="ident" id="8409442">finish</span><span class="op" id="8409448">(</span><span class="ident" id="8409449">t</span>&nbsp;<span class="ident" id="8409451">testing</span><span class="op" id="8409458">.</span><span class="ident" id="8409459">TB</span><span class="op" id="8409461">)</span>&nbsp;<span class="op" id="8409463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409466">if</span>&nbsp;<span class="ident" id="8409469">c</span><span class="op" id="8409470">.</span><span class="ident" id="8409471">tx</span>&nbsp;<span class="op" id="8409474">!=</span>&nbsp;<span class="builtintype" id="8409477">nil</span>&nbsp;<span class="op" id="8409481">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409485">c</span><span class="op" id="8409486">.</span><span class="ident" id="8409487">tx</span><span class="op" id="8409489">.</span><span class="ident" id="8409490">Rollback</span><span class="op" id="8409498">(</span><span class="op" id="8409499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409503">c</span><span class="op" id="8409504">.</span><span class="ident" id="8409505">tx</span>&nbsp;<span class="op" id="8409508">=</span>&nbsp;<span class="builtintype" id="8409510">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409518">c</span><span class="op" id="8409519">.</span><span class="ident" id="8409520">db</span>&nbsp;<span class="op" id="8409523">=</span>&nbsp;<span class="builtintype" id="8409525">nil</span><br>
<span class="lineno"></span><span class="op" id="8409529">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="8409532">func</span>&nbsp;<span class="op" id="8409537">(</span><span class="ident" id="8409538">c</span>&nbsp;<span class="op" id="8409540">*</span><span class="ident" id="8409541">concurrentTxQueryTest</span><span class="op" id="8409562">)</span>&nbsp;<span class="ident" id="8409564">test</span><span class="op" id="8409568">(</span><span class="ident" id="8409569">t</span>&nbsp;<span class="ident" id="8409571">testing</span><span class="op" id="8409578">.</span><span class="ident" id="8409579">TB</span><span class="op" id="8409581">)</span>&nbsp;<span class="builtintype" id="8409583">error</span>&nbsp;<span class="op" id="8409589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409592">rows</span><span class="op" id="8409596">,</span>&nbsp;<span class="ident" id="8409598">err</span>&nbsp;<span class="op" id="8409602">:=</span>&nbsp;<span class="ident" id="8409605">c</span><span class="op" id="8409606">.</span><span class="ident" id="8409607">db</span><span class="op" id="8409609">.</span><span class="ident" id="8409610">Query</span><span class="op" id="8409615">(</span><span class="string" id="8409616">&#34;SELECT|people|name|&#34;</span><span class="op" id="8409637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409640">if</span>&nbsp;<span class="ident" id="8409643">err</span>&nbsp;<span class="op" id="8409647">!=</span>&nbsp;<span class="builtintype" id="8409650">nil</span>&nbsp;<span class="op" id="8409654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409658">t</span><span class="op" id="8409659">.</span><span class="ident" id="8409660">Error</span><span class="op" id="8409665">(</span><span class="ident" id="8409666">err</span><span class="op" id="8409669">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409673">return</span>&nbsp;<span class="ident" id="8409680">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409688">var</span>&nbsp;<span class="ident" id="8409692">name</span>&nbsp;<span class="builtintype" id="8409697">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409705">for</span>&nbsp;<span class="ident" id="8409709">rows</span><span class="op" id="8409713">.</span><span class="ident" id="8409714">Next</span><span class="op" id="8409718">(</span><span class="op" id="8409719">)</span>&nbsp;<span class="op" id="8409721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409725">rows</span><span class="op" id="8409729">.</span><span class="ident" id="8409730">Scan</span><span class="op" id="8409734">(</span><span class="op" id="8409735">&amp;</span><span class="ident" id="8409736">name</span><span class="op" id="8409740">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409746">rows</span><span class="op" id="8409750">.</span><span class="ident" id="8409751">Close</span><span class="op" id="8409756">(</span><span class="op" id="8409757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409760">return</span>&nbsp;<span class="builtintype" id="8409767">nil</span><br>
<span class="lineno"></span><span class="op" id="8409771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="8409774">type</span>&nbsp;<span class="ident" id="8409779">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="8409800">struct</span>&nbsp;<span class="op" id="8409807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409810">db</span>&nbsp;<span class="op" id="8409813">*</span><span class="ident" id="8409814">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409818">tx</span>&nbsp;<span class="op" id="8409821">*</span><span class="ident" id="8409822">Tx</span><br>
<span class="lineno"></span><span class="op" id="8409825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="8409828">func</span>&nbsp;<span class="op" id="8409833">(</span><span class="ident" id="8409834">c</span>&nbsp;<span class="op" id="8409836">*</span><span class="ident" id="8409837">concurrentTxExecTest</span><span class="op" id="8409857">)</span>&nbsp;<span class="ident" id="8409859">init</span><span class="op" id="8409863">(</span><span class="ident" id="8409864">t</span>&nbsp;<span class="ident" id="8409866">testing</span><span class="op" id="8409873">.</span><span class="ident" id="8409874">TB</span><span class="op" id="8409876">,</span>&nbsp;<span class="ident" id="8409878">db</span>&nbsp;<span class="op" id="8409881">*</span><span class="ident" id="8409882">DB</span><span class="op" id="8409884">)</span>&nbsp;<span class="op" id="8409886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409889">c</span><span class="op" id="8409890">.</span><span class="ident" id="8409891">db</span>&nbsp;<span class="op" id="8409894">=</span>&nbsp;<span class="ident" id="8409896">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409900">var</span>&nbsp;<span class="ident" id="8409904">err</span>&nbsp;<span class="builtintype" id="8409908">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409915">c</span><span class="op" id="8409916">.</span><span class="ident" id="8409917">tx</span><span class="op" id="8409919">,</span>&nbsp;<span class="ident" id="8409921">err</span>&nbsp;<span class="op" id="8409925">=</span>&nbsp;<span class="ident" id="8409927">c</span><span class="op" id="8409928">.</span><span class="ident" id="8409929">db</span><span class="op" id="8409931">.</span><span class="ident" id="8409932">Begin</span><span class="op" id="8409937">(</span><span class="op" id="8409938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409941">if</span>&nbsp;<span class="ident" id="8409944">err</span>&nbsp;<span class="op" id="8409948">!=</span>&nbsp;<span class="builtintype" id="8409951">nil</span>&nbsp;<span class="op" id="8409955">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409959">t</span><span class="op" id="8409960">.</span><span class="ident" id="8409961">Fatal</span><span class="op" id="8409966">(</span><span class="ident" id="8409967">err</span><span class="op" id="8409970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409973">}</span><br>
<span class="lineno"></span><span class="op" id="8409975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8409978">func</span>&nbsp;<span class="op" id="8409983">(</span><span class="ident" id="8409984">c</span>&nbsp;<span class="op" id="8409986">*</span><span class="ident" id="8409987">concurrentTxExecTest</span><span class="op" id="8410007">)</span>&nbsp;<span class="ident" id="8410009">finish</span><span class="op" id="8410015">(</span><span class="ident" id="8410016">t</span>&nbsp;<span class="ident" id="8410018">testing</span><span class="op" id="8410025">.</span><span class="ident" id="8410026">TB</span><span class="op" id="8410028">)</span>&nbsp;<span class="op" id="8410030">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410033">if</span>&nbsp;<span class="ident" id="8410036">c</span><span class="op" id="8410037">.</span><span class="ident" id="8410038">tx</span>&nbsp;<span class="op" id="8410041">!=</span>&nbsp;<span class="builtintype" id="8410044">nil</span>&nbsp;<span class="op" id="8410048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410052">c</span><span class="op" id="8410053">.</span><span class="ident" id="8410054">tx</span><span class="op" id="8410056">.</span><span class="ident" id="8410057">Rollback</span><span class="op" id="8410065">(</span><span class="op" id="8410066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410070">c</span><span class="op" id="8410071">.</span><span class="ident" id="8410072">tx</span>&nbsp;<span class="op" id="8410075">=</span>&nbsp;<span class="builtintype" id="8410077">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410085">c</span><span class="op" id="8410086">.</span><span class="ident" id="8410087">db</span>&nbsp;<span class="op" id="8410090">=</span>&nbsp;<span class="builtintype" id="8410092">nil</span><br>
<span class="lineno">1600</span><span class="op" id="8410096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8410099">func</span>&nbsp;<span class="op" id="8410104">(</span><span class="ident" id="8410105">c</span>&nbsp;<span class="op" id="8410107">*</span><span class="ident" id="8410108">concurrentTxExecTest</span><span class="op" id="8410128">)</span>&nbsp;<span class="ident" id="8410130">test</span><span class="op" id="8410134">(</span><span class="ident" id="8410135">t</span>&nbsp;<span class="ident" id="8410137">testing</span><span class="op" id="8410144">.</span><span class="ident" id="8410145">TB</span><span class="op" id="8410147">)</span>&nbsp;<span class="builtintype" id="8410149">error</span>&nbsp;<span class="op" id="8410155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410158">_</span><span class="op" id="8410159">,</span>&nbsp;<span class="ident" id="8410161">err</span>&nbsp;<span class="op" id="8410165">:=</span>&nbsp;<span class="ident" id="8410168">c</span><span class="op" id="8410169">.</span><span class="ident" id="8410170">tx</span><span class="op" id="8410172">.</span><span class="ident" id="8410173">Exec</span><span class="op" id="8410177">(</span><span class="string" id="8410178">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8410231">,</span>&nbsp;<span class="num" id="8410233">3</span><span class="op" id="8410234">,</span>&nbsp;<span class="ident" id="8410236">chrisBirthday</span><span class="op" id="8410249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410252">if</span>&nbsp;<span class="ident" id="8410255">err</span>&nbsp;<span class="op" id="8410259">!=</span>&nbsp;<span class="builtintype" id="8410262">nil</span>&nbsp;<span class="op" id="8410266">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410270">t</span><span class="op" id="8410271">.</span><span class="ident" id="8410272">Error</span><span class="op" id="8410277">(</span><span class="ident" id="8410278">err</span><span class="op" id="8410281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410285">return</span>&nbsp;<span class="ident" id="8410292">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410300">return</span>&nbsp;<span class="builtintype" id="8410307">nil</span><br>
<span class="lineno"></span><span class="op" id="8410311">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="8410314">type</span>&nbsp;<span class="ident" id="8410319">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="8410345">struct</span>&nbsp;<span class="op" id="8410352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410355">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8410360">*</span><span class="ident" id="8410361">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410365">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8410370">*</span><span class="ident" id="8410371">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410375">stmt</span>&nbsp;<span class="op" id="8410380">*</span><span class="ident" id="8410381">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="8410386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8410389">func</span>&nbsp;<span class="op" id="8410394">(</span><span class="ident" id="8410395">c</span>&nbsp;<span class="op" id="8410397">*</span><span class="ident" id="8410398">concurrentTxStmtQueryTest</span><span class="op" id="8410423">)</span>&nbsp;<span class="ident" id="8410425">init</span><span class="op" id="8410429">(</span><span class="ident" id="8410430">t</span>&nbsp;<span class="ident" id="8410432">testing</span><span class="op" id="8410439">.</span><span class="ident" id="8410440">TB</span><span class="op" id="8410442">,</span>&nbsp;<span class="ident" id="8410444">db</span>&nbsp;<span class="op" id="8410447">*</span><span class="ident" id="8410448">DB</span><span class="op" id="8410450">)</span>&nbsp;<span class="op" id="8410452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410455">c</span><span class="op" id="8410456">.</span><span class="ident" id="8410457">db</span>&nbsp;<span class="op" id="8410460">=</span>&nbsp;<span class="ident" id="8410462">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410466">var</span>&nbsp;<span class="ident" id="8410470">err</span>&nbsp;<span class="builtintype" id="8410474">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410481">c</span><span class="op" id="8410482">.</span><span class="ident" id="8410483">tx</span><span class="op" id="8410485">,</span>&nbsp;<span class="ident" id="8410487">err</span>&nbsp;<span class="op" id="8410491">=</span>&nbsp;<span class="ident" id="8410493">c</span><span class="op" id="8410494">.</span><span class="ident" id="8410495">db</span><span class="op" id="8410497">.</span><span class="ident" id="8410498">Begin</span><span class="op" id="8410503">(</span><span class="op" id="8410504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410507">if</span>&nbsp;<span class="ident" id="8410510">err</span>&nbsp;<span class="op" id="8410514">!=</span>&nbsp;<span class="builtintype" id="8410517">nil</span>&nbsp;<span class="op" id="8410521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410525">t</span><span class="op" id="8410526">.</span><span class="ident" id="8410527">Fatal</span><span class="op" id="8410532">(</span><span class="ident" id="8410533">err</span><span class="op" id="8410536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410542">c</span><span class="op" id="8410543">.</span><span class="ident" id="8410544">stmt</span><span class="op" id="8410548">,</span>&nbsp;<span class="ident" id="8410550">err</span>&nbsp;<span class="op" id="8410554">=</span>&nbsp;<span class="ident" id="8410556">c</span><span class="op" id="8410557">.</span><span class="ident" id="8410558">tx</span><span class="op" id="8410560">.</span><span class="ident" id="8410561">Prepare</span><span class="op" id="8410568">(</span><span class="string" id="8410569">&#34;SELECT|people|name|&#34;</span><span class="op" id="8410590">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410593">if</span>&nbsp;<span class="ident" id="8410596">err</span>&nbsp;<span class="op" id="8410600">!=</span>&nbsp;<span class="builtintype" id="8410603">nil</span>&nbsp;<span class="op" id="8410607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410611">t</span><span class="op" id="8410612">.</span><span class="ident" id="8410613">Fatal</span><span class="op" id="8410618">(</span><span class="ident" id="8410619">err</span><span class="op" id="8410622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410625">}</span><br>
<span class="lineno"></span><span class="op" id="8410627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="8410630">func</span>&nbsp;<span class="op" id="8410635">(</span><span class="ident" id="8410636">c</span>&nbsp;<span class="op" id="8410638">*</span><span class="ident" id="8410639">concurrentTxStmtQueryTest</span><span class="op" id="8410664">)</span>&nbsp;<span class="ident" id="8410666">finish</span><span class="op" id="8410672">(</span><span class="ident" id="8410673">t</span>&nbsp;<span class="ident" id="8410675">testing</span><span class="op" id="8410682">.</span><span class="ident" id="8410683">TB</span><span class="op" id="8410685">)</span>&nbsp;<span class="op" id="8410687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410690">if</span>&nbsp;<span class="ident" id="8410693">c</span><span class="op" id="8410694">.</span><span class="ident" id="8410695">stmt</span>&nbsp;<span class="op" id="8410700">!=</span>&nbsp;<span class="builtintype" id="8410703">nil</span>&nbsp;<span class="op" id="8410707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410711">c</span><span class="op" id="8410712">.</span><span class="ident" id="8410713">stmt</span><span class="op" id="8410717">.</span><span class="ident" id="8410718">Close</span><span class="op" id="8410723">(</span><span class="op" id="8410724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410728">c</span><span class="op" id="8410729">.</span><span class="ident" id="8410730">stmt</span>&nbsp;<span class="op" id="8410735">=</span>&nbsp;<span class="builtintype" id="8410737">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410742">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410745">if</span>&nbsp;<span class="ident" id="8410748">c</span><span class="op" id="8410749">.</span><span class="ident" id="8410750">tx</span>&nbsp;<span class="op" id="8410753">!=</span>&nbsp;<span class="builtintype" id="8410756">nil</span>&nbsp;<span class="op" id="8410760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410764">c</span><span class="op" id="8410765">.</span><span class="ident" id="8410766">tx</span><span class="op" id="8410768">.</span><span class="ident" id="8410769">Rollback</span><span class="op" id="8410777">(</span><span class="op" id="8410778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410782">c</span><span class="op" id="8410783">.</span><span class="ident" id="8410784">tx</span>&nbsp;<span class="op" id="8410787">=</span>&nbsp;<span class="builtintype" id="8410789">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410797">c</span><span class="op" id="8410798">.</span><span class="ident" id="8410799">db</span>&nbsp;<span class="op" id="8410802">=</span>&nbsp;<span class="builtintype" id="8410804">nil</span><br>
<span class="lineno">1640</span><span class="op" id="8410808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8410811">func</span>&nbsp;<span class="op" id="8410816">(</span><span class="ident" id="8410817">c</span>&nbsp;<span class="op" id="8410819">*</span><span class="ident" id="8410820">concurrentTxStmtQueryTest</span><span class="op" id="8410845">)</span>&nbsp;<span class="ident" id="8410847">test</span><span class="op" id="8410851">(</span><span class="ident" id="8410852">t</span>&nbsp;<span class="ident" id="8410854">testing</span><span class="op" id="8410861">.</span><span class="ident" id="8410862">TB</span><span class="op" id="8410864">)</span>&nbsp;<span class="builtintype" id="8410866">error</span>&nbsp;<span class="op" id="8410872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410875">rows</span><span class="op" id="8410879">,</span>&nbsp;<span class="ident" id="8410881">err</span>&nbsp;<span class="op" id="8410885">:=</span>&nbsp;<span class="ident" id="8410888">c</span><span class="op" id="8410889">.</span><span class="ident" id="8410890">stmt</span><span class="op" id="8410894">.</span><span class="ident" id="8410895">Query</span><span class="op" id="8410900">(</span><span class="op" id="8410901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410904">if</span>&nbsp;<span class="ident" id="8410907">err</span>&nbsp;<span class="op" id="8410911">!=</span>&nbsp;<span class="builtintype" id="8410914">nil</span>&nbsp;<span class="op" id="8410918">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410922">t</span><span class="op" id="8410923">.</span><span class="ident" id="8410924">Errorf</span><span class="op" id="8410930">(</span><span class="string" id="8410931">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8410952">,</span>&nbsp;<span class="ident" id="8410954">err</span><span class="op" id="8410957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410961">return</span>&nbsp;<span class="ident" id="8410968">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410977">var</span>&nbsp;<span class="ident" id="8410981">name</span>&nbsp;<span class="builtintype" id="8410986">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410994">for</span>&nbsp;<span class="ident" id="8410998">rows</span><span class="op" id="8411002">.</span><span class="ident" id="8411003">Next</span><span class="op" id="8411007">(</span><span class="op" id="8411008">)</span>&nbsp;<span class="op" id="8411010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411014">rows</span><span class="op" id="8411018">.</span><span class="ident" id="8411019">Scan</span><span class="op" id="8411023">(</span><span class="op" id="8411024">&amp;</span><span class="ident" id="8411025">name</span><span class="op" id="8411029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411035">rows</span><span class="op" id="8411039">.</span><span class="ident" id="8411040">Close</span><span class="op" id="8411045">(</span><span class="op" id="8411046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411049">return</span>&nbsp;<span class="builtintype" id="8411056">nil</span><br>
<span class="lineno">1655</span><span class="op" id="8411060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8411063">type</span>&nbsp;<span class="ident" id="8411068">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="8411093">struct</span>&nbsp;<span class="op" id="8411100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411103">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8411108">*</span><span class="ident" id="8411109">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411113">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8411118">*</span><span class="ident" id="8411119">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411123">stmt</span>&nbsp;<span class="op" id="8411128">*</span><span class="ident" id="8411129">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8411134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8411137">func</span>&nbsp;<span class="op" id="8411142">(</span><span class="ident" id="8411143">c</span>&nbsp;<span class="op" id="8411145">*</span><span class="ident" id="8411146">concurrentTxStmtExecTest</span><span class="op" id="8411170">)</span>&nbsp;<span class="ident" id="8411172">init</span><span class="op" id="8411176">(</span><span class="ident" id="8411177">t</span>&nbsp;<span class="ident" id="8411179">testing</span><span class="op" id="8411186">.</span><span class="ident" id="8411187">TB</span><span class="op" id="8411189">,</span>&nbsp;<span class="ident" id="8411191">db</span>&nbsp;<span class="op" id="8411194">*</span><span class="ident" id="8411195">DB</span><span class="op" id="8411197">)</span>&nbsp;<span class="op" id="8411199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411202">c</span><span class="op" id="8411203">.</span><span class="ident" id="8411204">db</span>&nbsp;<span class="op" id="8411207">=</span>&nbsp;<span class="ident" id="8411209">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411213">var</span>&nbsp;<span class="ident" id="8411217">err</span>&nbsp;<span class="builtintype" id="8411221">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411228">c</span><span class="op" id="8411229">.</span><span class="ident" id="8411230">tx</span><span class="op" id="8411232">,</span>&nbsp;<span class="ident" id="8411234">err</span>&nbsp;<span class="op" id="8411238">=</span>&nbsp;<span class="ident" id="8411240">c</span><span class="op" id="8411241">.</span><span class="ident" id="8411242">db</span><span class="op" id="8411244">.</span><span class="ident" id="8411245">Begin</span><span class="op" id="8411250">(</span><span class="op" id="8411251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411254">if</span>&nbsp;<span class="ident" id="8411257">err</span>&nbsp;<span class="op" id="8411261">!=</span>&nbsp;<span class="builtintype" id="8411264">nil</span>&nbsp;<span class="op" id="8411268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411272">t</span><span class="op" id="8411273">.</span><span class="ident" id="8411274">Fatal</span><span class="op" id="8411279">(</span><span class="ident" id="8411280">err</span><span class="op" id="8411283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411286">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411289">c</span><span class="op" id="8411290">.</span><span class="ident" id="8411291">stmt</span><span class="op" id="8411295">,</span>&nbsp;<span class="ident" id="8411297">err</span>&nbsp;<span class="op" id="8411301">=</span>&nbsp;<span class="ident" id="8411303">c</span><span class="op" id="8411304">.</span><span class="ident" id="8411305">tx</span><span class="op" id="8411307">.</span><span class="ident" id="8411308">Prepare</span><span class="op" id="8411315">(</span><span class="string" id="8411316">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8411369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411372">if</span>&nbsp;<span class="ident" id="8411375">err</span>&nbsp;<span class="op" id="8411379">!=</span>&nbsp;<span class="builtintype" id="8411382">nil</span>&nbsp;<span class="op" id="8411386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411390">t</span><span class="op" id="8411391">.</span><span class="ident" id="8411392">Fatal</span><span class="op" id="8411397">(</span><span class="ident" id="8411398">err</span><span class="op" id="8411401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411404">}</span><br>
<span class="lineno"></span><span class="op" id="8411406">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="8411409">func</span>&nbsp;<span class="op" id="8411414">(</span><span class="ident" id="8411415">c</span>&nbsp;<span class="op" id="8411417">*</span><span class="ident" id="8411418">concurrentTxStmtExecTest</span><span class="op" id="8411442">)</span>&nbsp;<span class="ident" id="8411444">finish</span><span class="op" id="8411450">(</span><span class="ident" id="8411451">t</span>&nbsp;<span class="ident" id="8411453">testing</span><span class="op" id="8411460">.</span><span class="ident" id="8411461">TB</span><span class="op" id="8411463">)</span>&nbsp;<span class="op" id="8411465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411468">if</span>&nbsp;<span class="ident" id="8411471">c</span><span class="op" id="8411472">.</span><span class="ident" id="8411473">stmt</span>&nbsp;<span class="op" id="8411478">!=</span>&nbsp;<span class="builtintype" id="8411481">nil</span>&nbsp;<span class="op" id="8411485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411489">c</span><span class="op" id="8411490">.</span><span class="ident" id="8411491">stmt</span><span class="op" id="8411495">.</span><span class="ident" id="8411496">Close</span><span class="op" id="8411501">(</span><span class="op" id="8411502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411506">c</span><span class="op" id="8411507">.</span><span class="ident" id="8411508">stmt</span>&nbsp;<span class="op" id="8411513">=</span>&nbsp;<span class="builtintype" id="8411515">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411523">if</span>&nbsp;<span class="ident" id="8411526">c</span><span class="op" id="8411527">.</span><span class="ident" id="8411528">tx</span>&nbsp;<span class="op" id="8411531">!=</span>&nbsp;<span class="builtintype" id="8411534">nil</span>&nbsp;<span class="op" id="8411538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411542">c</span><span class="op" id="8411543">.</span><span class="ident" id="8411544">tx</span><span class="op" id="8411546">.</span><span class="ident" id="8411547">Rollback</span><span class="op" id="8411555">(</span><span class="op" id="8411556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411560">c</span><span class="op" id="8411561">.</span><span class="ident" id="8411562">tx</span>&nbsp;<span class="op" id="8411565">=</span>&nbsp;<span class="builtintype" id="8411567">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411572">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411575">c</span><span class="op" id="8411576">.</span><span class="ident" id="8411577">db</span>&nbsp;<span class="op" id="8411580">=</span>&nbsp;<span class="builtintype" id="8411582">nil</span><br>
<span class="lineno"></span><span class="op" id="8411586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8411589">func</span>&nbsp;<span class="op" id="8411594">(</span><span class="ident" id="8411595">c</span>&nbsp;<span class="op" id="8411597">*</span><span class="ident" id="8411598">concurrentTxStmtExecTest</span><span class="op" id="8411622">)</span>&nbsp;<span class="ident" id="8411624">test</span><span class="op" id="8411628">(</span><span class="ident" id="8411629">t</span>&nbsp;<span class="ident" id="8411631">testing</span><span class="op" id="8411638">.</span><span class="ident" id="8411639">TB</span><span class="op" id="8411641">)</span>&nbsp;<span class="builtintype" id="8411643">error</span>&nbsp;<span class="op" id="8411649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411652">_</span><span class="op" id="8411653">,</span>&nbsp;<span class="ident" id="8411655">err</span>&nbsp;<span class="op" id="8411659">:=</span>&nbsp;<span class="ident" id="8411662">c</span><span class="op" id="8411663">.</span><span class="ident" id="8411664">stmt</span><span class="op" id="8411668">.</span><span class="ident" id="8411669">Exec</span><span class="op" id="8411673">(</span><span class="num" id="8411674">3</span><span class="op" id="8411675">,</span>&nbsp;<span class="ident" id="8411677">chrisBirthday</span><span class="op" id="8411690">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411693">if</span>&nbsp;<span class="ident" id="8411696">err</span>&nbsp;<span class="op" id="8411700">!=</span>&nbsp;<span class="builtintype" id="8411703">nil</span>&nbsp;<span class="op" id="8411707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411711">t</span><span class="op" id="8411712">.</span><span class="ident" id="8411713">Errorf</span><span class="op" id="8411719">(</span><span class="string" id="8411720">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8411740">,</span>&nbsp;<span class="ident" id="8411742">err</span><span class="op" id="8411745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411749">return</span>&nbsp;<span class="ident" id="8411756">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411764">return</span>&nbsp;<span class="builtintype" id="8411771">nil</span><br>
<span class="lineno">1695</span><span class="op" id="8411775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8411778">type</span>&nbsp;<span class="ident" id="8411783">concurrentRandomTest</span>&nbsp;<span class="keyword" id="8411804">struct</span>&nbsp;<span class="op" id="8411811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411814">tests</span>&nbsp;<span class="op" id="8411820">[</span><span class="op" id="8411821">]</span><span class="ident" id="8411822">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="8411837">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="8411840">func</span>&nbsp;<span class="op" id="8411845">(</span><span class="ident" id="8411846">c</span>&nbsp;<span class="op" id="8411848">*</span><span class="ident" id="8411849">concurrentRandomTest</span><span class="op" id="8411869">)</span>&nbsp;<span class="ident" id="8411871">init</span><span class="op" id="8411875">(</span><span class="ident" id="8411876">t</span>&nbsp;<span class="ident" id="8411878">testing</span><span class="op" id="8411885">.</span><span class="ident" id="8411886">TB</span><span class="op" id="8411888">,</span>&nbsp;<span class="ident" id="8411890">db</span>&nbsp;<span class="op" id="8411893">*</span><span class="ident" id="8411894">DB</span><span class="op" id="8411896">)</span>&nbsp;<span class="op" id="8411898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411901">c</span><span class="op" id="8411902">.</span><span class="ident" id="8411903">tests</span>&nbsp;<span class="op" id="8411909">=</span>&nbsp;<span class="op" id="8411911">[</span><span class="op" id="8411912">]</span><span class="ident" id="8411913">concurrentTest</span><span class="op" id="8411927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8411931">new</span><span class="op" id="8411934">(</span><span class="ident" id="8411935">concurrentDBQueryTest</span><span class="op" id="8411956">)</span><span class="op" id="8411957">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8411961">new</span><span class="op" id="8411964">(</span><span class="ident" id="8411965">concurrentDBExecTest</span><span class="op" id="8411985">)</span><span class="op" id="8411986">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8411990">new</span><span class="op" id="8411993">(</span><span class="ident" id="8411994">concurrentStmtQueryTest</span><span class="op" id="8412017">)</span><span class="op" id="8412018">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8412022">new</span><span class="op" id="8412025">(</span><span class="ident" id="8412026">concurrentStmtExecTest</span><span class="op" id="8412048">)</span><span class="op" id="8412049">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8412053">new</span><span class="op" id="8412056">(</span><span class="ident" id="8412057">concurrentTxQueryTest</span><span class="op" id="8412078">)</span><span class="op" id="8412079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8412083">new</span><span class="op" id="8412086">(</span><span class="ident" id="8412087">concurrentTxExecTest</span><span class="op" id="8412107">)</span><span class="op" id="8412108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8412112">new</span><span class="op" id="8412115">(</span><span class="ident" id="8412116">concurrentTxStmtQueryTest</span><span class="op" id="8412141">)</span><span class="op" id="8412142">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8412146">new</span><span class="op" id="8412149">(</span><span class="ident" id="8412150">concurrentTxStmtExecTest</span><span class="op" id="8412174">)</span><span class="op" id="8412175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412181">for</span>&nbsp;<span class="ident" id="8412185">_</span><span class="op" id="8412186">,</span>&nbsp;<span class="ident" id="8412188">ct</span>&nbsp;<span class="op" id="8412191">:=</span>&nbsp;<span class="keyword" id="8412194">range</span>&nbsp;<span class="ident" id="8412200">c</span><span class="op" id="8412201">.</span><span class="ident" id="8412202">tests</span>&nbsp;<span class="op" id="8412208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412212">ct</span><span class="op" id="8412214">.</span><span class="ident" id="8412215">init</span><span class="op" id="8412219">(</span><span class="ident" id="8412220">t</span><span class="op" id="8412221">,</span>&nbsp;<span class="ident" id="8412223">db</span><span class="op" id="8412225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412228">}</span><br>
<span class="lineno">1715</span><span class="op" id="8412230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8412233">func</span>&nbsp;<span class="op" id="8412238">(</span><span class="ident" id="8412239">c</span>&nbsp;<span class="op" id="8412241">*</span><span class="ident" id="8412242">concurrentRandomTest</span><span class="op" id="8412262">)</span>&nbsp;<span class="ident" id="8412264">finish</span><span class="op" id="8412270">(</span><span class="ident" id="8412271">t</span>&nbsp;<span class="ident" id="8412273">testing</span><span class="op" id="8412280">.</span><span class="ident" id="8412281">TB</span><span class="op" id="8412283">)</span>&nbsp;<span class="op" id="8412285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412288">for</span>&nbsp;<span class="ident" id="8412292">_</span><span class="op" id="8412293">,</span>&nbsp;<span class="ident" id="8412295">ct</span>&nbsp;<span class="op" id="8412298">:=</span>&nbsp;<span class="keyword" id="8412301">range</span>&nbsp;<span class="ident" id="8412307">c</span><span class="op" id="8412308">.</span><span class="ident" id="8412309">tests</span>&nbsp;<span class="op" id="8412315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412319">ct</span><span class="op" id="8412321">.</span><span class="ident" id="8412322">finish</span><span class="op" id="8412328">(</span><span class="ident" id="8412329">t</span><span class="op" id="8412330">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412333">}</span><br>
<span class="lineno"></span><span class="op" id="8412335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8412338">func</span>&nbsp;<span class="op" id="8412343">(</span><span class="ident" id="8412344">c</span>&nbsp;<span class="op" id="8412346">*</span><span class="ident" id="8412347">concurrentRandomTest</span><span class="op" id="8412367">)</span>&nbsp;<span class="ident" id="8412369">test</span><span class="op" id="8412373">(</span><span class="ident" id="8412374">t</span>&nbsp;<span class="ident" id="8412376">testing</span><span class="op" id="8412383">.</span><span class="ident" id="8412384">TB</span><span class="op" id="8412386">)</span>&nbsp;<span class="builtintype" id="8412388">error</span>&nbsp;<span class="op" id="8412394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412397">ct</span>&nbsp;<span class="op" id="8412400">:=</span>&nbsp;<span class="ident" id="8412403">c</span><span class="op" id="8412404">.</span><span class="ident" id="8412405">tests</span><span class="op" id="8412410">[</span><span class="ident" id="8412411">rand</span><span class="op" id="8412415">.</span><span class="ident" id="8412416">Intn</span><span class="op" id="8412420">(</span><span class="builtinfunc" id="8412421">len</span><span class="op" id="8412424">(</span><span class="ident" id="8412425">c</span><span class="op" id="8412426">.</span><span class="ident" id="8412427">tests</span><span class="op" id="8412432">)</span><span class="op" id="8412433">)</span><span class="op" id="8412434">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412437">return</span>&nbsp;<span class="ident" id="8412444">ct</span><span class="op" id="8412446">.</span><span class="ident" id="8412447">test</span><span class="op" id="8412451">(</span><span class="ident" id="8412452">t</span><span class="op" id="8412453">)</span><br>
<span class="lineno"></span><span class="op" id="8412455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8412458">func</span>&nbsp;<span class="ident" id="8412463">doConcurrentTest</span><span class="op" id="8412479">(</span><span class="ident" id="8412480">t</span>&nbsp;<span class="ident" id="8412482">testing</span><span class="op" id="8412489">.</span><span class="ident" id="8412490">TB</span><span class="op" id="8412492">,</span>&nbsp;<span class="ident" id="8412494">ct</span>&nbsp;<span class="ident" id="8412497">concurrentTest</span><span class="op" id="8412511">)</span>&nbsp;<span class="op" id="8412513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412516">maxProcs</span><span class="op" id="8412524">,</span>&nbsp;<span class="ident" id="8412526">numReqs</span>&nbsp;<span class="op" id="8412534">:=</span>&nbsp;<span class="num" id="8412537">1</span><span class="op" id="8412538">,</span>&nbsp;<span class="num" id="8412540">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412545">if</span>&nbsp;<span class="ident" id="8412548">testing</span><span class="op" id="8412555">.</span><span class="ident" id="8412556">Short</span><span class="op" id="8412561">(</span><span class="op" id="8412562">)</span>&nbsp;<span class="op" id="8412564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412568">maxProcs</span><span class="op" id="8412576">,</span>&nbsp;<span class="ident" id="8412578">numReqs</span>&nbsp;<span class="op" id="8412586">=</span>&nbsp;<span class="num" id="8412588">4</span><span class="op" id="8412589">,</span>&nbsp;<span class="num" id="8412591">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412598">defer</span>&nbsp;<span class="ident" id="8412604">runtime</span><span class="op" id="8412611">.</span><span class="ident" id="8412612">GOMAXPROCS</span><span class="op" id="8412622">(</span><span class="ident" id="8412623">runtime</span><span class="op" id="8412630">.</span><span class="ident" id="8412631">GOMAXPROCS</span><span class="op" id="8412641">(</span><span class="ident" id="8412642">maxProcs</span><span class="op" id="8412650">)</span><span class="op" id="8412651">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412655">db</span>&nbsp;<span class="op" id="8412658">:=</span>&nbsp;<span class="ident" id="8412661">newTestDB</span><span class="op" id="8412670">(</span><span class="ident" id="8412671">t</span><span class="op" id="8412672">,</span>&nbsp;<span class="string" id="8412674">&#34;people&#34;</span><span class="op" id="8412682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412685">defer</span>&nbsp;<span class="ident" id="8412691">closeDB</span><span class="op" id="8412698">(</span><span class="ident" id="8412699">t</span><span class="op" id="8412700">,</span>&nbsp;<span class="ident" id="8412702">db</span><span class="op" id="8412704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412708">ct</span><span class="op" id="8412710">.</span><span class="ident" id="8412711">init</span><span class="op" id="8412715">(</span><span class="ident" id="8412716">t</span><span class="op" id="8412717">,</span>&nbsp;<span class="ident" id="8412719">db</span><span class="op" id="8412721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412724">defer</span>&nbsp;<span class="ident" id="8412730">ct</span><span class="op" id="8412732">.</span><span class="ident" id="8412733">finish</span><span class="op" id="8412739">(</span><span class="ident" id="8412740">t</span><span class="op" id="8412741">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412745">var</span>&nbsp;<span class="ident" id="8412749">wg</span>&nbsp;<span class="ident" id="8412752">sync</span><span class="op" id="8412756">.</span><span class="ident" id="8412757">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412768">wg</span><span class="op" id="8412770">.</span><span class="ident" id="8412771">Add</span><span class="op" id="8412774">(</span><span class="ident" id="8412775">numReqs</span><span class="op" id="8412782">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412786">reqs</span>&nbsp;<span class="op" id="8412791">:=</span>&nbsp;<span class="builtinfunc" id="8412794">make</span><span class="op" id="8412798">(</span><span class="keyword" id="8412799">chan</span>&nbsp;<span class="builtintype" id="8412804">bool</span><span class="op" id="8412808">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412811">defer</span>&nbsp;<span class="builtinfunc" id="8412817">close</span><span class="op" id="8412822">(</span><span class="ident" id="8412823">reqs</span><span class="op" id="8412827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412831">for</span>&nbsp;<span class="ident" id="8412835">i</span>&nbsp;<span class="op" id="8412837">:=</span>&nbsp;<span class="num" id="8412840">0</span><span class="op" id="8412841">;</span>&nbsp;<span class="ident" id="8412843">i</span>&nbsp;<span class="op" id="8412845">&lt;</span>&nbsp;<span class="ident" id="8412847">maxProcs</span><span class="op" id="8412855">*</span><span class="num" id="8412856">2</span><span class="op" id="8412857">;</span>&nbsp;<span class="ident" id="8412859">i</span><span class="op" id="8412860">++</span>&nbsp;<span class="op" id="8412863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412867">go</span>&nbsp;<span class="keyword" id="8412870">func</span><span class="op" id="8412874">(</span><span class="op" id="8412875">)</span>&nbsp;<span class="op" id="8412877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412882">for</span>&nbsp;<span class="keyword" id="8412886">range</span>&nbsp;<span class="ident" id="8412892">reqs</span>&nbsp;<span class="op" id="8412897">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412903">err</span>&nbsp;<span class="op" id="8412907">:=</span>&nbsp;<span class="ident" id="8412910">ct</span><span class="op" id="8412912">.</span><span class="ident" id="8412913">test</span><span class="op" id="8412917">(</span><span class="ident" id="8412918">t</span><span class="op" id="8412919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412925">if</span>&nbsp;<span class="ident" id="8412928">err</span>&nbsp;<span class="op" id="8412932">!=</span>&nbsp;<span class="builtintype" id="8412935">nil</span>&nbsp;<span class="op" id="8412939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412946">wg</span><span class="op" id="8412948">.</span><span class="ident" id="8412949">Done</span><span class="op" id="8412953">(</span><span class="op" id="8412954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412961">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412974">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412980">wg</span><span class="op" id="8412982">.</span><span class="ident" id="8412983">Done</span><span class="op" id="8412987">(</span><span class="op" id="8412988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412997">}</span><span class="op" id="8412998">(</span><span class="op" id="8412999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413006">for</span>&nbsp;<span class="ident" id="8413010">i</span>&nbsp;<span class="op" id="8413012">:=</span>&nbsp;<span class="num" id="8413015">0</span><span class="op" id="8413016">;</span>&nbsp;<span class="ident" id="8413018">i</span>&nbsp;<span class="op" id="8413020">&lt;</span>&nbsp;<span class="ident" id="8413022">numReqs</span><span class="op" id="8413029">;</span>&nbsp;<span class="ident" id="8413031">i</span><span class="op" id="8413032">++</span>&nbsp;<span class="op" id="8413035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413039">reqs</span>&nbsp;<span class="op" id="8413044">&lt;-</span>&nbsp;<span class="builtintype" id="8413047">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413057">wg</span><span class="op" id="8413059">.</span><span class="ident" id="8413060">Wait</span><span class="op" id="8413064">(</span><span class="op" id="8413065">)</span><br>
<span class="lineno">1765</span><span class="op" id="8413067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8413070">func</span>&nbsp;<span class="ident" id="8413075">manyConcurrentQueries</span><span class="op" id="8413096">(</span><span class="ident" id="8413097">t</span>&nbsp;<span class="ident" id="8413099">testing</span><span class="op" id="8413106">.</span><span class="ident" id="8413107">TB</span><span class="op" id="8413109">)</span>&nbsp;<span class="op" id="8413111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413114">maxProcs</span><span class="op" id="8413122">,</span>&nbsp;<span class="ident" id="8413124">numReqs</span>&nbsp;<span class="op" id="8413132">:=</span>&nbsp;<span class="num" id="8413135">16</span><span class="op" id="8413137">,</span>&nbsp;<span class="num" id="8413139">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413144">if</span>&nbsp;<span class="ident" id="8413147">testing</span><span class="op" id="8413154">.</span><span class="ident" id="8413155">Short</span><span class="op" id="8413160">(</span><span class="op" id="8413161">)</span>&nbsp;<span class="op" id="8413163">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413167">maxProcs</span><span class="op" id="8413175">,</span>&nbsp;<span class="ident" id="8413177">numReqs</span>&nbsp;<span class="op" id="8413185">=</span>&nbsp;<span class="num" id="8413187">4</span><span class="op" id="8413188">,</span>&nbsp;<span class="num" id="8413190">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413197">defer</span>&nbsp;<span class="ident" id="8413203">runtime</span><span class="op" id="8413210">.</span><span class="ident" id="8413211">GOMAXPROCS</span><span class="op" id="8413221">(</span><span class="ident" id="8413222">runtime</span><span class="op" id="8413229">.</span><span class="ident" id="8413230">GOMAXPROCS</span><span class="op" id="8413240">(</span><span class="ident" id="8413241">maxProcs</span><span class="op" id="8413249">)</span><span class="op" id="8413250">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413254">db</span>&nbsp;<span class="op" id="8413257">:=</span>&nbsp;<span class="ident" id="8413260">newTestDB</span><span class="op" id="8413269">(</span><span class="ident" id="8413270">t</span><span class="op" id="8413271">,</span>&nbsp;<span class="string" id="8413273">&#34;people&#34;</span><span class="op" id="8413281">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413284">defer</span>&nbsp;<span class="ident" id="8413290">closeDB</span><span class="op" id="8413297">(</span><span class="ident" id="8413298">t</span><span class="op" id="8413299">,</span>&nbsp;<span class="ident" id="8413301">db</span><span class="op" id="8413303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413307">stmt</span><span class="op" id="8413311">,</span>&nbsp;<span class="ident" id="8413313">err</span>&nbsp;<span class="op" id="8413317">:=</span>&nbsp;<span class="ident" id="8413320">db</span><span class="op" id="8413322">.</span><span class="ident" id="8413323">Prepare</span><span class="op" id="8413330">(</span><span class="string" id="8413331">&#34;SELECT|people|name|&#34;</span><span class="op" id="8413352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413355">if</span>&nbsp;<span class="ident" id="8413358">err</span>&nbsp;<span class="op" id="8413362">!=</span>&nbsp;<span class="builtintype" id="8413365">nil</span>&nbsp;<span class="op" id="8413369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413373">t</span><span class="op" id="8413374">.</span><span class="ident" id="8413375">Fatal</span><span class="op" id="8413380">(</span><span class="ident" id="8413381">err</span><span class="op" id="8413384">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413390">defer</span>&nbsp;<span class="ident" id="8413396">stmt</span><span class="op" id="8413400">.</span><span class="ident" id="8413401">Close</span><span class="op" id="8413406">(</span><span class="op" id="8413407">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413411">var</span>&nbsp;<span class="ident" id="8413415">wg</span>&nbsp;<span class="ident" id="8413418">sync</span><span class="op" id="8413422">.</span><span class="ident" id="8413423">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413434">wg</span><span class="op" id="8413436">.</span><span class="ident" id="8413437">Add</span><span class="op" id="8413440">(</span><span class="ident" id="8413441">numReqs</span><span class="op" id="8413448">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413452">reqs</span>&nbsp;<span class="op" id="8413457">:=</span>&nbsp;<span class="builtinfunc" id="8413460">make</span><span class="op" id="8413464">(</span><span class="keyword" id="8413465">chan</span>&nbsp;<span class="builtintype" id="8413470">bool</span><span class="op" id="8413474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413477">defer</span>&nbsp;<span class="builtinfunc" id="8413483">close</span><span class="op" id="8413488">(</span><span class="ident" id="8413489">reqs</span><span class="op" id="8413493">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413497">for</span>&nbsp;<span class="ident" id="8413501">i</span>&nbsp;<span class="op" id="8413503">:=</span>&nbsp;<span class="num" id="8413506">0</span><span class="op" id="8413507">;</span>&nbsp;<span class="ident" id="8413509">i</span>&nbsp;<span class="op" id="8413511">&lt;</span>&nbsp;<span class="ident" id="8413513">maxProcs</span><span class="op" id="8413521">*</span><span class="num" id="8413522">2</span><span class="op" id="8413523">;</span>&nbsp;<span class="ident" id="8413525">i</span><span class="op" id="8413526">++</span>&nbsp;<span class="op" id="8413529">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413533">go</span>&nbsp;<span class="keyword" id="8413536">func</span><span class="op" id="8413540">(</span><span class="op" id="8413541">)</span>&nbsp;<span class="op" id="8413543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413548">for</span>&nbsp;<span class="keyword" id="8413552">range</span>&nbsp;<span class="ident" id="8413558">reqs</span>&nbsp;<span class="op" id="8413563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413569">rows</span><span class="op" id="8413573">,</span>&nbsp;<span class="ident" id="8413575">err</span>&nbsp;<span class="op" id="8413579">:=</span>&nbsp;<span class="ident" id="8413582">stmt</span><span class="op" id="8413586">.</span><span class="ident" id="8413587">Query</span><span class="op" id="8413592">(</span><span class="op" id="8413593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413599">if</span>&nbsp;<span class="ident" id="8413602">err</span>&nbsp;<span class="op" id="8413606">!=</span>&nbsp;<span class="builtintype" id="8413609">nil</span>&nbsp;<span class="op" id="8413613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413620">t</span><span class="op" id="8413621">.</span><span class="ident" id="8413622">Errorf</span><span class="op" id="8413628">(</span><span class="string" id="8413629">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8413650">,</span>&nbsp;<span class="ident" id="8413652">err</span><span class="op" id="8413655">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413662">wg</span><span class="op" id="8413664">.</span><span class="ident" id="8413665">Done</span><span class="op" id="8413669">(</span><span class="op" id="8413670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413677">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413697">var</span>&nbsp;<span class="ident" id="8413701">name</span>&nbsp;<span class="builtintype" id="8413706">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413717">for</span>&nbsp;<span class="ident" id="8413721">rows</span><span class="op" id="8413725">.</span><span class="ident" id="8413726">Next</span><span class="op" id="8413730">(</span><span class="op" id="8413731">)</span>&nbsp;<span class="op" id="8413733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413740">rows</span><span class="op" id="8413744">.</span><span class="ident" id="8413745">Scan</span><span class="op" id="8413749">(</span><span class="op" id="8413750">&amp;</span><span class="ident" id="8413751">name</span><span class="op" id="8413755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413767">rows</span><span class="op" id="8413771">.</span><span class="ident" id="8413772">Close</span><span class="op" id="8413777">(</span><span class="op" id="8413778">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413785">wg</span><span class="op" id="8413787">.</span><span class="ident" id="8413788">Done</span><span class="op" id="8413792">(</span><span class="op" id="8413793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413802">}</span><span class="op" id="8413803">(</span><span class="op" id="8413804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413811">for</span>&nbsp;<span class="ident" id="8413815">i</span>&nbsp;<span class="op" id="8413817">:=</span>&nbsp;<span class="num" id="8413820">0</span><span class="op" id="8413821">;</span>&nbsp;<span class="ident" id="8413823">i</span>&nbsp;<span class="op" id="8413825">&lt;</span>&nbsp;<span class="ident" id="8413827">numReqs</span><span class="op" id="8413834">;</span>&nbsp;<span class="ident" id="8413836">i</span><span class="op" id="8413837">++</span>&nbsp;<span class="op" id="8413840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413844">reqs</span>&nbsp;<span class="op" id="8413849">&lt;-</span>&nbsp;<span class="builtintype" id="8413852">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413862">wg</span><span class="op" id="8413864">.</span><span class="ident" id="8413865">Wait</span><span class="op" id="8413869">(</span><span class="op" id="8413870">)</span><br>
<span class="lineno">1815</span><span class="op" id="8413872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8413875">func</span>&nbsp;<span class="ident" id="8413880">TestIssue6081</span><span class="op" id="8413893">(</span><span class="ident" id="8413894">t</span>&nbsp;<span class="op" id="8413896">*</span><span class="ident" id="8413897">testing</span><span class="op" id="8413904">.</span><span class="ident" id="8413905">T</span><span class="op" id="8413906">)</span>&nbsp;<span class="op" id="8413908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413911">db</span>&nbsp;<span class="op" id="8413914">:=</span>&nbsp;<span class="ident" id="8413917">newTestDB</span><span class="op" id="8413926">(</span><span class="ident" id="8413927">t</span><span class="op" id="8413928">,</span>&nbsp;<span class="string" id="8413930">&#34;people&#34;</span><span class="op" id="8413938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413941">defer</span>&nbsp;<span class="ident" id="8413947">closeDB</span><span class="op" id="8413954">(</span><span class="ident" id="8413955">t</span><span class="op" id="8413956">,</span>&nbsp;<span class="ident" id="8413958">db</span><span class="op" id="8413960">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413964">drv</span>&nbsp;<span class="op" id="8413968">:=</span>&nbsp;<span class="ident" id="8413971">db</span><span class="op" id="8413973">.</span><span class="ident" id="8413974">driver</span><span class="op" id="8413980">.</span><span class="op" id="8413981">(</span><span class="op" id="8413982">*</span><span class="ident" id="8413983">fakeDriver</span><span class="op" id="8413993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413996">drv</span><span class="op" id="8413999">.</span><span class="ident" id="8414000">mu</span><span class="op" id="8414002">.</span><span class="ident" id="8414003">Lock</span><span class="op" id="8414007">(</span><span class="op" id="8414008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414011">opens0</span>&nbsp;<span class="op" id="8414018">:=</span>&nbsp;<span class="ident" id="8414021">drv</span><span class="op" id="8414024">.</span><span class="ident" id="8414025">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414036">closes0</span>&nbsp;<span class="op" id="8414044">:=</span>&nbsp;<span class="ident" id="8414047">drv</span><span class="op" id="8414050">.</span><span class="ident" id="8414051">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414063">drv</span><span class="op" id="8414066">.</span><span class="ident" id="8414067">mu</span><span class="op" id="8414069">.</span><span class="ident" id="8414070">Unlock</span><span class="op" id="8414076">(</span><span class="op" id="8414077">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414081">stmt</span><span class="op" id="8414085">,</span>&nbsp;<span class="ident" id="8414087">err</span>&nbsp;<span class="op" id="8414091">:=</span>&nbsp;<span class="ident" id="8414094">db</span><span class="op" id="8414096">.</span><span class="ident" id="8414097">Prepare</span><span class="op" id="8414104">(</span><span class="string" id="8414105">&#34;SELECT|people|name|&#34;</span><span class="op" id="8414126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414129">if</span>&nbsp;<span class="ident" id="8414132">err</span>&nbsp;<span class="op" id="8414136">!=</span>&nbsp;<span class="builtintype" id="8414139">nil</span>&nbsp;<span class="op" id="8414143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414147">t</span><span class="op" id="8414148">.</span><span class="ident" id="8414149">Fatal</span><span class="op" id="8414154">(</span><span class="ident" id="8414155">err</span><span class="op" id="8414158">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414164">rowsCloseHook</span>&nbsp;<span class="op" id="8414178">=</span>&nbsp;<span class="keyword" id="8414180">func</span><span class="op" id="8414184">(</span><span class="ident" id="8414185">rows</span>&nbsp;<span class="op" id="8414190">*</span><span class="ident" id="8414191">Rows</span><span class="op" id="8414195">,</span>&nbsp;<span class="ident" id="8414197">err</span>&nbsp;<span class="op" id="8414201">*</span><span class="builtintype" id="8414202">error</span><span class="op" id="8414207">)</span>&nbsp;<span class="op" id="8414209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414213">*</span><span class="ident" id="8414214">err</span>&nbsp;<span class="op" id="8414218">=</span>&nbsp;<span class="ident" id="8414220">driver</span><span class="op" id="8414226">.</span><span class="ident" id="8414227">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414242">defer</span>&nbsp;<span class="keyword" id="8414248">func</span><span class="op" id="8414252">(</span><span class="op" id="8414253">)</span>&nbsp;<span class="op" id="8414255">{</span>&nbsp;<span class="ident" id="8414257">rowsCloseHook</span>&nbsp;<span class="op" id="8414271">=</span>&nbsp;<span class="builtintype" id="8414273">nil</span>&nbsp;<span class="op" id="8414277">}</span><span class="op" id="8414278">(</span><span class="op" id="8414279">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414282">for</span>&nbsp;<span class="ident" id="8414286">i</span>&nbsp;<span class="op" id="8414288">:=</span>&nbsp;<span class="num" id="8414291">0</span><span class="op" id="8414292">;</span>&nbsp;<span class="ident" id="8414294">i</span>&nbsp;<span class="op" id="8414296">&lt;</span>&nbsp;<span class="num" id="8414298">10</span><span class="op" id="8414300">;</span>&nbsp;<span class="ident" id="8414302">i</span><span class="op" id="8414303">++</span>&nbsp;<span class="op" id="8414306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414310">rows</span><span class="op" id="8414314">,</span>&nbsp;<span class="ident" id="8414316">err</span>&nbsp;<span class="op" id="8414320">:=</span>&nbsp;<span class="ident" id="8414323">stmt</span><span class="op" id="8414327">.</span><span class="ident" id="8414328">Query</span><span class="op" id="8414333">(</span><span class="op" id="8414334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414338">if</span>&nbsp;<span class="ident" id="8414341">err</span>&nbsp;<span class="op" id="8414345">!=</span>&nbsp;<span class="builtintype" id="8414348">nil</span>&nbsp;<span class="op" id="8414352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414357">t</span><span class="op" id="8414358">.</span><span class="ident" id="8414359">Fatal</span><span class="op" id="8414364">(</span><span class="ident" id="8414365">err</span><span class="op" id="8414368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414372">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414376">rows</span><span class="op" id="8414380">.</span><span class="ident" id="8414381">Close</span><span class="op" id="8414386">(</span><span class="op" id="8414387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414393">if</span>&nbsp;<span class="ident" id="8414396">n</span>&nbsp;<span class="op" id="8414398">:=</span>&nbsp;<span class="builtinfunc" id="8414401">len</span><span class="op" id="8414404">(</span><span class="ident" id="8414405">stmt</span><span class="op" id="8414409">.</span><span class="ident" id="8414410">css</span><span class="op" id="8414413">)</span><span class="op" id="8414414">;</span>&nbsp;<span class="ident" id="8414416">n</span>&nbsp;<span class="op" id="8414418">&gt;</span>&nbsp;<span class="num" id="8414420">1</span>&nbsp;<span class="op" id="8414422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414426">t</span><span class="op" id="8414427">.</span><span class="ident" id="8414428">Errorf</span><span class="op" id="8414434">(</span><span class="string" id="8414435">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="8414467">,</span>&nbsp;<span class="ident" id="8414469">n</span><span class="op" id="8414470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414473">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414476">stmt</span><span class="op" id="8414480">.</span><span class="ident" id="8414481">Close</span><span class="op" id="8414486">(</span><span class="op" id="8414487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414490">if</span>&nbsp;<span class="ident" id="8414493">n</span>&nbsp;<span class="op" id="8414495">:=</span>&nbsp;<span class="builtinfunc" id="8414498">len</span><span class="op" id="8414501">(</span><span class="ident" id="8414502">stmt</span><span class="op" id="8414506">.</span><span class="ident" id="8414507">css</span><span class="op" id="8414510">)</span><span class="op" id="8414511">;</span>&nbsp;<span class="ident" id="8414513">n</span>&nbsp;<span class="op" id="8414515">!=</span>&nbsp;<span class="num" id="8414518">0</span>&nbsp;<span class="op" id="8414520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414524">t</span><span class="op" id="8414525">.</span><span class="ident" id="8414526">Errorf</span><span class="op" id="8414532">(</span><span class="string" id="8414533">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8414574">,</span>&nbsp;<span class="ident" id="8414576">n</span><span class="op" id="8414577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414584">drv</span><span class="op" id="8414587">.</span><span class="ident" id="8414588">mu</span><span class="op" id="8414590">.</span><span class="ident" id="8414591">Lock</span><span class="op" id="8414595">(</span><span class="op" id="8414596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414599">opens</span>&nbsp;<span class="op" id="8414605">:=</span>&nbsp;<span class="ident" id="8414608">drv</span><span class="op" id="8414611">.</span><span class="ident" id="8414612">openCount</span>&nbsp;<span class="op" id="8414622">-</span>&nbsp;<span class="ident" id="8414624">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414632">closes</span>&nbsp;<span class="op" id="8414639">:=</span>&nbsp;<span class="ident" id="8414642">drv</span><span class="op" id="8414645">.</span><span class="ident" id="8414646">closeCount</span>&nbsp;<span class="op" id="8414657">-</span>&nbsp;<span class="ident" id="8414659">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414668">drv</span><span class="op" id="8414671">.</span><span class="ident" id="8414672">mu</span><span class="op" id="8414674">.</span><span class="ident" id="8414675">Unlock</span><span class="op" id="8414681">(</span><span class="op" id="8414682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414685">if</span>&nbsp;<span class="ident" id="8414688">opens</span>&nbsp;<span class="op" id="8414694">&lt;</span>&nbsp;<span class="num" id="8414696">9</span>&nbsp;<span class="op" id="8414698">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414702">t</span><span class="op" id="8414703">.</span><span class="ident" id="8414704">Errorf</span><span class="op" id="8414710">(</span><span class="string" id="8414711">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="8414734">,</span>&nbsp;<span class="ident" id="8414736">opens</span><span class="op" id="8414741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414747">if</span>&nbsp;<span class="ident" id="8414750">closes</span>&nbsp;<span class="op" id="8414757">&lt;</span>&nbsp;<span class="num" id="8414759">9</span>&nbsp;<span class="op" id="8414761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414765">t</span><span class="op" id="8414766">.</span><span class="ident" id="8414767">Errorf</span><span class="op" id="8414773">(</span><span class="string" id="8414774">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="8414798">,</span>&nbsp;<span class="ident" id="8414800">closes</span><span class="op" id="8414806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414809">}</span><br>
<span class="lineno">1860</span><span class="op" id="8414811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8414814">func</span>&nbsp;<span class="ident" id="8414819">TestConcurrency</span><span class="op" id="8414834">(</span><span class="ident" id="8414835">t</span>&nbsp;<span class="op" id="8414837">*</span><span class="ident" id="8414838">testing</span><span class="op" id="8414845">.</span><span class="ident" id="8414846">T</span><span class="op" id="8414847">)</span>&nbsp;<span class="op" id="8414849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414852">doConcurrentTest</span><span class="op" id="8414868">(</span><span class="ident" id="8414869">t</span><span class="op" id="8414870">,</span>&nbsp;<span class="builtinfunc" id="8414872">new</span><span class="op" id="8414875">(</span><span class="ident" id="8414876">concurrentDBQueryTest</span><span class="op" id="8414897">)</span><span class="op" id="8414898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414901">doConcurrentTest</span><span class="op" id="8414917">(</span><span class="ident" id="8414918">t</span><span class="op" id="8414919">,</span>&nbsp;<span class="builtinfunc" id="8414921">new</span><span class="op" id="8414924">(</span><span class="ident" id="8414925">concurrentDBExecTest</span><span class="op" id="8414945">)</span><span class="op" id="8414946">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414949">doConcurrentTest</span><span class="op" id="8414965">(</span><span class="ident" id="8414966">t</span><span class="op" id="8414967">,</span>&nbsp;<span class="builtinfunc" id="8414969">new</span><span class="op" id="8414972">(</span><span class="ident" id="8414973">concurrentStmtQueryTest</span><span class="op" id="8414996">)</span><span class="op" id="8414997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415000">doConcurrentTest</span><span class="op" id="8415016">(</span><span class="ident" id="8415017">t</span><span class="op" id="8415018">,</span>&nbsp;<span class="builtinfunc" id="8415020">new</span><span class="op" id="8415023">(</span><span class="ident" id="8415024">concurrentStmtExecTest</span><span class="op" id="8415046">)</span><span class="op" id="8415047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415050">doConcurrentTest</span><span class="op" id="8415066">(</span><span class="ident" id="8415067">t</span><span class="op" id="8415068">,</span>&nbsp;<span class="builtinfunc" id="8415070">new</span><span class="op" id="8415073">(</span><span class="ident" id="8415074">concurrentTxQueryTest</span><span class="op" id="8415095">)</span><span class="op" id="8415096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415099">doConcurrentTest</span><span class="op" id="8415115">(</span><span class="ident" id="8415116">t</span><span class="op" id="8415117">,</span>&nbsp;<span class="builtinfunc" id="8415119">new</span><span class="op" id="8415122">(</span><span class="ident" id="8415123">concurrentTxExecTest</span><span class="op" id="8415143">)</span><span class="op" id="8415144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415147">doConcurrentTest</span><span class="op" id="8415163">(</span><span class="ident" id="8415164">t</span><span class="op" id="8415165">,</span>&nbsp;<span class="builtinfunc" id="8415167">new</span><span class="op" id="8415170">(</span><span class="ident" id="8415171">concurrentTxStmtQueryTest</span><span class="op" id="8415196">)</span><span class="op" id="8415197">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415200">doConcurrentTest</span><span class="op" id="8415216">(</span><span class="ident" id="8415217">t</span><span class="op" id="8415218">,</span>&nbsp;<span class="builtinfunc" id="8415220">new</span><span class="op" id="8415223">(</span><span class="ident" id="8415224">concurrentTxStmtExecTest</span><span class="op" id="8415248">)</span><span class="op" id="8415249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415252">doConcurrentTest</span><span class="op" id="8415268">(</span><span class="ident" id="8415269">t</span><span class="op" id="8415270">,</span>&nbsp;<span class="builtinfunc" id="8415272">new</span><span class="op" id="8415275">(</span><span class="ident" id="8415276">concurrentRandomTest</span><span class="op" id="8415296">)</span><span class="op" id="8415297">)</span><br>
<span class="lineno"></span><span class="op" id="8415299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415302">func</span>&nbsp;<span class="ident" id="8415307">TestConnectionLeak</span><span class="op" id="8415325">(</span><span class="ident" id="8415326">t</span>&nbsp;<span class="op" id="8415328">*</span><span class="ident" id="8415329">testing</span><span class="op" id="8415336">.</span><span class="ident" id="8415337">T</span><span class="op" id="8415338">)</span>&nbsp;<span class="op" id="8415340">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415343">db</span>&nbsp;<span class="op" id="8415346">:=</span>&nbsp;<span class="ident" id="8415349">newTestDB</span><span class="op" id="8415358">(</span><span class="ident" id="8415359">t</span><span class="op" id="8415360">,</span>&nbsp;<span class="string" id="8415362">&#34;people&#34;</span><span class="op" id="8415370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8415373">defer</span>&nbsp;<span class="ident" id="8415379">closeDB</span><span class="op" id="8415386">(</span><span class="ident" id="8415387">t</span><span class="op" id="8415388">,</span>&nbsp;<span class="ident" id="8415390">db</span><span class="op" id="8415392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8415395">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415436">rows</span>&nbsp;<span class="op" id="8415441">:=</span>&nbsp;<span class="builtinfunc" id="8415444">make</span><span class="op" id="8415448">(</span><span class="op" id="8415449">[</span><span class="op" id="8415450">]</span><span class="op" id="8415451">*</span><span class="ident" id="8415452">Rows</span><span class="op" id="8415456">,</span>&nbsp;<span class="ident" id="8415458">defaultMaxIdleConns</span><span class="op" id="8415477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8415480">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8415546">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8415616">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415633">db</span><span class="op" id="8415635">.</span><span class="ident" id="8415636">SetMaxOpenConns</span><span class="op" id="8415651">(</span><span class="builtinfunc" id="8415652">len</span><span class="op" id="8415655">(</span><span class="ident" id="8415656">rows</span><span class="op" id="8415660">)</span>&nbsp;<span class="op" id="8415662">+</span>&nbsp;<span class="num" id="8415664">1</span><span class="op" id="8415665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8415668">for</span>&nbsp;<span class="ident" id="8415672">ii</span>&nbsp;<span class="op" id="8415675">:=</span>&nbsp;<span class="keyword" id="8415678">range</span>&nbsp;<span class="ident" id="8415684">rows</span>&nbsp;<span class="op" id="8415689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415693">r</span><span class="op" id="8415694">,</span>&nbsp;<span class="ident" id="8415696">err</span>&nbsp;<span class="op" id="8415700">:=</span>&nbsp;<span class="ident" id="8415703">db</span><span class="op" id="8415705">.</span><span class="ident" id="8415706">Query</span><span class="op" id="8415711">(</span><span class="string" id="8415712">&#34;SELECT|people|name|&#34;</span><span class="op" id="8415733">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8415737">if</span>&nbsp;<span class="ident" id="8415740">err</span>&nbsp;<span class="op" id="8415744">!=</span>&nbsp;<span class="builtintype" id="8415747">nil</span>&nbsp;<span class="op" id="8415751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415756">t</span><span class="op" id="8415757">.</span><span class="ident" id="8415758">Fatal</span><span class="op" id="8415763">(</span><span class="ident" id="8415764">err</span><span class="op" id="8415767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8415771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415775">r</span><span class="op" id="8415776">.</span><span class="ident" id="8415777">Next</span><span class="op" id="8415781">(</span><span class="op" id="8415782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8415786">if</span>&nbsp;<span class="ident" id="8415789">err</span>&nbsp;<span class="op" id="8415793">:=</span>&nbsp;<span class="ident" id="8415796">r</span><span class="op" id="8415797">.</span><span class="ident" id="8415798">Err</span><span class="op" id="8415801">(</span><span class="op" id="8415802">)</span><span class="op" id="8415803">;</span>&nbsp;<span class="ident" id="8415805">err</span>&nbsp;<span class="op" id="8415809">!=</span>&nbsp;<span class="builtintype" id="8415812">nil</span>&nbsp;<span class="op" id="8415816">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415821">t</span><span class="op" id="8415822">.</span><span class="ident" id="8415823">Fatal</span><span class="op" id="8415828">(</span><span class="ident" id="8415829">err</span><span class="op" id="8415832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8415836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415840">rows</span><span class="op" id="8415844">[</span><span class="ident" id="8415845">ii</span><span class="op" id="8415847">]</span>&nbsp;<span class="op" id="8415849">=</span>&nbsp;<span class="ident" id="8415851">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8415854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8415857">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8415916">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8415980">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416016">drv</span>&nbsp;<span class="op" id="8416020">:=</span>&nbsp;<span class="ident" id="8416023">db</span><span class="op" id="8416025">.</span><span class="ident" id="8416026">driver</span><span class="op" id="8416032">.</span><span class="op" id="8416033">(</span><span class="op" id="8416034">*</span><span class="ident" id="8416035">fakeDriver</span><span class="op" id="8416045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416048">drv</span><span class="op" id="8416051">.</span><span class="ident" id="8416052">waitCh</span>&nbsp;<span class="op" id="8416059">=</span>&nbsp;<span class="builtinfunc" id="8416061">make</span><span class="op" id="8416065">(</span><span class="keyword" id="8416066">chan</span>&nbsp;<span class="keyword" id="8416071">struct</span><span class="op" id="8416077">{</span><span class="op" id="8416078">}</span><span class="op" id="8416079">,</span>&nbsp;<span class="num" id="8416081">1</span><span class="op" id="8416082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416085">drv</span><span class="op" id="8416088">.</span><span class="ident" id="8416089">waitingCh</span>&nbsp;<span class="op" id="8416099">=</span>&nbsp;<span class="builtinfunc" id="8416101">make</span><span class="op" id="8416105">(</span><span class="keyword" id="8416106">chan</span>&nbsp;<span class="keyword" id="8416111">struct</span><span class="op" id="8416117">{</span><span class="op" id="8416118">}</span><span class="op" id="8416119">,</span>&nbsp;<span class="num" id="8416121">1</span><span class="op" id="8416122">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416125">var</span>&nbsp;<span class="ident" id="8416129">wg</span>&nbsp;<span class="ident" id="8416132">sync</span><span class="op" id="8416136">.</span><span class="ident" id="8416137">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416148">wg</span><span class="op" id="8416150">.</span><span class="ident" id="8416151">Add</span><span class="op" id="8416154">(</span><span class="num" id="8416155">1</span><span class="op" id="8416156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416159">go</span>&nbsp;<span class="keyword" id="8416162">func</span><span class="op" id="8416166">(</span><span class="op" id="8416167">)</span>&nbsp;<span class="op" id="8416169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416173">r</span><span class="op" id="8416174">,</span>&nbsp;<span class="ident" id="8416176">err</span>&nbsp;<span class="op" id="8416180">:=</span>&nbsp;<span class="ident" id="8416183">db</span><span class="op" id="8416185">.</span><span class="ident" id="8416186">Query</span><span class="op" id="8416191">(</span><span class="string" id="8416192">&#34;SELECT|people|name|&#34;</span><span class="op" id="8416213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416217">if</span>&nbsp;<span class="ident" id="8416220">err</span>&nbsp;<span class="op" id="8416224">!=</span>&nbsp;<span class="builtintype" id="8416227">nil</span>&nbsp;<span class="op" id="8416231">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416236">t</span><span class="op" id="8416237">.</span><span class="ident" id="8416238">Fatal</span><span class="op" id="8416243">(</span><span class="ident" id="8416244">err</span><span class="op" id="8416247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416255">r</span><span class="op" id="8416256">.</span><span class="ident" id="8416257">Close</span><span class="op" id="8416262">(</span><span class="op" id="8416263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416267">wg</span><span class="op" id="8416269">.</span><span class="ident" id="8416270">Done</span><span class="op" id="8416274">(</span><span class="op" id="8416275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416278">}</span><span class="op" id="8416279">(</span><span class="op" id="8416280">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8416283">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416352">&lt;-</span><span class="ident" id="8416354">drv</span><span class="op" id="8416357">.</span><span class="ident" id="8416358">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8416369">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8416436">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416496">for</span>&nbsp;<span class="ident" id="8416500">_</span><span class="op" id="8416501">,</span>&nbsp;<span class="ident" id="8416503">v</span>&nbsp;<span class="op" id="8416505">:=</span>&nbsp;<span class="keyword" id="8416508">range</span>&nbsp;<span class="ident" id="8416514">rows</span>&nbsp;<span class="op" id="8416519">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416523">v</span><span class="op" id="8416524">.</span><span class="ident" id="8416525">Close</span><span class="op" id="8416530">(</span><span class="op" id="8416531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8416537">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8416608">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8416679">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8416748">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416764">drv</span><span class="op" id="8416767">.</span><span class="ident" id="8416768">waitCh</span>&nbsp;<span class="op" id="8416775">&lt;-</span>&nbsp;<span class="keyword" id="8416778">struct</span><span class="op" id="8416784">{</span><span class="op" id="8416785">}</span><span class="op" id="8416786">{</span><span class="op" id="8416787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416790">wg</span><span class="op" id="8416792">.</span><span class="ident" id="8416793">Wait</span><span class="op" id="8416797">(</span><span class="op" id="8416798">)</span><br>
<span class="lineno"></span><span class="op" id="8416800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="8416803">func</span>&nbsp;<span class="ident" id="8416808">BenchmarkConcurrentDBExec</span><span class="op" id="8416833">(</span><span class="ident" id="8416834">b</span>&nbsp;<span class="op" id="8416836">*</span><span class="ident" id="8416837">testing</span><span class="op" id="8416844">.</span><span class="ident" id="8416845">B</span><span class="op" id="8416846">)</span>&nbsp;<span class="op" id="8416848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416851">b</span><span class="op" id="8416852">.</span><span class="ident" id="8416853">ReportAllocs</span><span class="op" id="8416865">(</span><span class="op" id="8416866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416869">ct</span>&nbsp;<span class="op" id="8416872">:=</span>&nbsp;<span class="builtinfunc" id="8416875">new</span><span class="op" id="8416878">(</span><span class="ident" id="8416879">concurrentDBExecTest</span><span class="op" id="8416899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416902">for</span>&nbsp;<span class="ident" id="8416906">i</span>&nbsp;<span class="op" id="8416908">:=</span>&nbsp;<span class="num" id="8416911">0</span><span class="op" id="8416912">;</span>&nbsp;<span class="ident" id="8416914">i</span>&nbsp;<span class="op" id="8416916">&lt;</span>&nbsp;<span class="ident" id="8416918">b</span><span class="op" id="8416919">.</span><span class="ident" id="8416920">N</span><span class="op" id="8416921">;</span>&nbsp;<span class="ident" id="8416923">i</span><span class="op" id="8416924">++</span>&nbsp;<span class="op" id="8416927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416931">doConcurrentTest</span><span class="op" id="8416947">(</span><span class="ident" id="8416948">b</span><span class="op" id="8416949">,</span>&nbsp;<span class="ident" id="8416951">ct</span><span class="op" id="8416953">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416956">}</span><br>
<span class="lineno"></span><span class="op" id="8416958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416961">func</span>&nbsp;<span class="ident" id="8416966">BenchmarkConcurrentStmtQuery</span><span class="op" id="8416994">(</span><span class="ident" id="8416995">b</span>&nbsp;<span class="op" id="8416997">*</span><span class="ident" id="8416998">testing</span><span class="op" id="8417005">.</span><span class="ident" id="8417006">B</span><span class="op" id="8417007">)</span>&nbsp;<span class="op" id="8417009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417012">b</span><span class="op" id="8417013">.</span><span class="ident" id="8417014">ReportAllocs</span><span class="op" id="8417026">(</span><span class="op" id="8417027">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417030">ct</span>&nbsp;<span class="op" id="8417033">:=</span>&nbsp;<span class="builtinfunc" id="8417036">new</span><span class="op" id="8417039">(</span><span class="ident" id="8417040">concurrentStmtQueryTest</span><span class="op" id="8417063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417066">for</span>&nbsp;<span class="ident" id="8417070">i</span>&nbsp;<span class="op" id="8417072">:=</span>&nbsp;<span class="num" id="8417075">0</span><span class="op" id="8417076">;</span>&nbsp;<span class="ident" id="8417078">i</span>&nbsp;<span class="op" id="8417080">&lt;</span>&nbsp;<span class="ident" id="8417082">b</span><span class="op" id="8417083">.</span><span class="ident" id="8417084">N</span><span class="op" id="8417085">;</span>&nbsp;<span class="ident" id="8417087">i</span><span class="op" id="8417088">++</span>&nbsp;<span class="op" id="8417091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417095">doConcurrentTest</span><span class="op" id="8417111">(</span><span class="ident" id="8417112">b</span><span class="op" id="8417113">,</span>&nbsp;<span class="ident" id="8417115">ct</span><span class="op" id="8417117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417120">}</span><br>
<span class="lineno"></span><span class="op" id="8417122">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="8417125">func</span>&nbsp;<span class="ident" id="8417130">BenchmarkConcurrentStmtExec</span><span class="op" id="8417157">(</span><span class="ident" id="8417158">b</span>&nbsp;<span class="op" id="8417160">*</span><span class="ident" id="8417161">testing</span><span class="op" id="8417168">.</span><span class="ident" id="8417169">B</span><span class="op" id="8417170">)</span>&nbsp;<span class="op" id="8417172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417175">b</span><span class="op" id="8417176">.</span><span class="ident" id="8417177">ReportAllocs</span><span class="op" id="8417189">(</span><span class="op" id="8417190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417193">ct</span>&nbsp;<span class="op" id="8417196">:=</span>&nbsp;<span class="builtinfunc" id="8417199">new</span><span class="op" id="8417202">(</span><span class="ident" id="8417203">concurrentStmtExecTest</span><span class="op" id="8417225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417228">for</span>&nbsp;<span class="ident" id="8417232">i</span>&nbsp;<span class="op" id="8417234">:=</span>&nbsp;<span class="num" id="8417237">0</span><span class="op" id="8417238">;</span>&nbsp;<span class="ident" id="8417240">i</span>&nbsp;<span class="op" id="8417242">&lt;</span>&nbsp;<span class="ident" id="8417244">b</span><span class="op" id="8417245">.</span><span class="ident" id="8417246">N</span><span class="op" id="8417247">;</span>&nbsp;<span class="ident" id="8417249">i</span><span class="op" id="8417250">++</span>&nbsp;<span class="op" id="8417253">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417257">doConcurrentTest</span><span class="op" id="8417273">(</span><span class="ident" id="8417274">b</span><span class="op" id="8417275">,</span>&nbsp;<span class="ident" id="8417277">ct</span><span class="op" id="8417279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417282">}</span><br>
<span class="lineno"></span><span class="op" id="8417284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8417287">func</span>&nbsp;<span class="ident" id="8417292">BenchmarkConcurrentTxQuery</span><span class="op" id="8417318">(</span><span class="ident" id="8417319">b</span>&nbsp;<span class="op" id="8417321">*</span><span class="ident" id="8417322">testing</span><span class="op" id="8417329">.</span><span class="ident" id="8417330">B</span><span class="op" id="8417331">)</span>&nbsp;<span class="op" id="8417333">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417336">b</span><span class="op" id="8417337">.</span><span class="ident" id="8417338">ReportAllocs</span><span class="op" id="8417350">(</span><span class="op" id="8417351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417354">ct</span>&nbsp;<span class="op" id="8417357">:=</span>&nbsp;<span class="builtinfunc" id="8417360">new</span><span class="op" id="8417363">(</span><span class="ident" id="8417364">concurrentTxQueryTest</span><span class="op" id="8417385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417388">for</span>&nbsp;<span class="ident" id="8417392">i</span>&nbsp;<span class="op" id="8417394">:=</span>&nbsp;<span class="num" id="8417397">0</span><span class="op" id="8417398">;</span>&nbsp;<span class="ident" id="8417400">i</span>&nbsp;<span class="op" id="8417402">&lt;</span>&nbsp;<span class="ident" id="8417404">b</span><span class="op" id="8417405">.</span><span class="ident" id="8417406">N</span><span class="op" id="8417407">;</span>&nbsp;<span class="ident" id="8417409">i</span><span class="op" id="8417410">++</span>&nbsp;<span class="op" id="8417413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417417">doConcurrentTest</span><span class="op" id="8417433">(</span><span class="ident" id="8417434">b</span><span class="op" id="8417435">,</span>&nbsp;<span class="ident" id="8417437">ct</span><span class="op" id="8417439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417442">}</span><br>
<span class="lineno">1955</span><span class="op" id="8417444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8417447">func</span>&nbsp;<span class="ident" id="8417452">BenchmarkConcurrentTxExec</span><span class="op" id="8417477">(</span><span class="ident" id="8417478">b</span>&nbsp;<span class="op" id="8417480">*</span><span class="ident" id="8417481">testing</span><span class="op" id="8417488">.</span><span class="ident" id="8417489">B</span><span class="op" id="8417490">)</span>&nbsp;<span class="op" id="8417492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417495">b</span><span class="op" id="8417496">.</span><span class="ident" id="8417497">ReportAllocs</span><span class="op" id="8417509">(</span><span class="op" id="8417510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417513">ct</span>&nbsp;<span class="op" id="8417516">:=</span>&nbsp;<span class="builtinfunc" id="8417519">new</span><span class="op" id="8417522">(</span><span class="ident" id="8417523">concurrentTxExecTest</span><span class="op" id="8417543">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417546">for</span>&nbsp;<span class="ident" id="8417550">i</span>&nbsp;<span class="op" id="8417552">:=</span>&nbsp;<span class="num" id="8417555">0</span><span class="op" id="8417556">;</span>&nbsp;<span class="ident" id="8417558">i</span>&nbsp;<span class="op" id="8417560">&lt;</span>&nbsp;<span class="ident" id="8417562">b</span><span class="op" id="8417563">.</span><span class="ident" id="8417564">N</span><span class="op" id="8417565">;</span>&nbsp;<span class="ident" id="8417567">i</span><span class="op" id="8417568">++</span>&nbsp;<span class="op" id="8417571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417575">doConcurrentTest</span><span class="op" id="8417591">(</span><span class="ident" id="8417592">b</span><span class="op" id="8417593">,</span>&nbsp;<span class="ident" id="8417595">ct</span><span class="op" id="8417597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417600">}</span><br>
<span class="lineno"></span><span class="op" id="8417602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="8417605">func</span>&nbsp;<span class="ident" id="8417610">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="8417640">(</span><span class="ident" id="8417641">b</span>&nbsp;<span class="op" id="8417643">*</span><span class="ident" id="8417644">testing</span><span class="op" id="8417651">.</span><span class="ident" id="8417652">B</span><span class="op" id="8417653">)</span>&nbsp;<span class="op" id="8417655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417658">b</span><span class="op" id="8417659">.</span><span class="ident" id="8417660">ReportAllocs</span><span class="op" id="8417672">(</span><span class="op" id="8417673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417676">ct</span>&nbsp;<span class="op" id="8417679">:=</span>&nbsp;<span class="builtinfunc" id="8417682">new</span><span class="op" id="8417685">(</span><span class="ident" id="8417686">concurrentTxStmtQueryTest</span><span class="op" id="8417711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417714">for</span>&nbsp;<span class="ident" id="8417718">i</span>&nbsp;<span class="op" id="8417720">:=</span>&nbsp;<span class="num" id="8417723">0</span><span class="op" id="8417724">;</span>&nbsp;<span class="ident" id="8417726">i</span>&nbsp;<span class="op" id="8417728">&lt;</span>&nbsp;<span class="ident" id="8417730">b</span><span class="op" id="8417731">.</span><span class="ident" id="8417732">N</span><span class="op" id="8417733">;</span>&nbsp;<span class="ident" id="8417735">i</span><span class="op" id="8417736">++</span>&nbsp;<span class="op" id="8417739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417743">doConcurrentTest</span><span class="op" id="8417759">(</span><span class="ident" id="8417760">b</span><span class="op" id="8417761">,</span>&nbsp;<span class="ident" id="8417763">ct</span><span class="op" id="8417765">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417768">}</span><br>
<span class="lineno"></span><span class="op" id="8417770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8417773">func</span>&nbsp;<span class="ident" id="8417778">BenchmarkConcurrentTxStmtExec</span><span class="op" id="8417807">(</span><span class="ident" id="8417808">b</span>&nbsp;<span class="op" id="8417810">*</span><span class="ident" id="8417811">testing</span><span class="op" id="8417818">.</span><span class="ident" id="8417819">B</span><span class="op" id="8417820">)</span>&nbsp;<span class="op" id="8417822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417825">b</span><span class="op" id="8417826">.</span><span class="ident" id="8417827">ReportAllocs</span><span class="op" id="8417839">(</span><span class="op" id="8417840">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417843">ct</span>&nbsp;<span class="op" id="8417846">:=</span>&nbsp;<span class="builtinfunc" id="8417849">new</span><span class="op" id="8417852">(</span><span class="ident" id="8417853">concurrentTxStmtExecTest</span><span class="op" id="8417877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417880">for</span>&nbsp;<span class="ident" id="8417884">i</span>&nbsp;<span class="op" id="8417886">:=</span>&nbsp;<span class="num" id="8417889">0</span><span class="op" id="8417890">;</span>&nbsp;<span class="ident" id="8417892">i</span>&nbsp;<span class="op" id="8417894">&lt;</span>&nbsp;<span class="ident" id="8417896">b</span><span class="op" id="8417897">.</span><span class="ident" id="8417898">N</span><span class="op" id="8417899">;</span>&nbsp;<span class="ident" id="8417901">i</span><span class="op" id="8417902">++</span>&nbsp;<span class="op" id="8417905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417909">doConcurrentTest</span><span class="op" id="8417925">(</span><span class="ident" id="8417926">b</span><span class="op" id="8417927">,</span>&nbsp;<span class="ident" id="8417929">ct</span><span class="op" id="8417931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417934">}</span><br>
<span class="lineno"></span><span class="op" id="8417936">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="8417939">func</span>&nbsp;<span class="ident" id="8417944">BenchmarkConcurrentRandom</span><span class="op" id="8417969">(</span><span class="ident" id="8417970">b</span>&nbsp;<span class="op" id="8417972">*</span><span class="ident" id="8417973">testing</span><span class="op" id="8417980">.</span><span class="ident" id="8417981">B</span><span class="op" id="8417982">)</span>&nbsp;<span class="op" id="8417984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417987">b</span><span class="op" id="8417988">.</span><span class="ident" id="8417989">ReportAllocs</span><span class="op" id="8418001">(</span><span class="op" id="8418002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418005">ct</span>&nbsp;<span class="op" id="8418008">:=</span>&nbsp;<span class="builtinfunc" id="8418011">new</span><span class="op" id="8418014">(</span><span class="ident" id="8418015">concurrentRandomTest</span><span class="op" id="8418035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8418038">for</span>&nbsp;<span class="ident" id="8418042">i</span>&nbsp;<span class="op" id="8418044">:=</span>&nbsp;<span class="num" id="8418047">0</span><span class="op" id="8418048">;</span>&nbsp;<span class="ident" id="8418050">i</span>&nbsp;<span class="op" id="8418052">&lt;</span>&nbsp;<span class="ident" id="8418054">b</span><span class="op" id="8418055">.</span><span class="ident" id="8418056">N</span><span class="op" id="8418057">;</span>&nbsp;<span class="ident" id="8418059">i</span><span class="op" id="8418060">++</span>&nbsp;<span class="op" id="8418063">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418067">doConcurrentTest</span><span class="op" id="8418083">(</span><span class="ident" id="8418084">b</span><span class="op" id="8418085">,</span>&nbsp;<span class="ident" id="8418087">ct</span><span class="op" id="8418089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8418092">}</span><br>
<span class="lineno"></span><span class="op" id="8418094">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
