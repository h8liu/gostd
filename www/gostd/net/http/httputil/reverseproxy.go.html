<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5000178">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5000233">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5000287">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5000338">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5000369">package</span>&nbsp;<span class="ident" id="5000377">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5000387">import</span>&nbsp;<span class="op" id="5000394">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5000397">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5000403">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5000410">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5000417">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5000429">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5000440">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5000451">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5000459">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5000466">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5000469">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5000542">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="5000568">var</span>&nbsp;<span class="ident" id="5000572">onExitFlushLoop</span>&nbsp;<span class="keyword" id="5000588">func</span><span class="op" id="5000592">(</span><span class="op" id="5000593">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5000596">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="5000666">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5000731">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="5000742">type</span>&nbsp;<span class="ident" id="5000747">ReverseProxy</span>&nbsp;<span class="keyword" id="5000760">struct</span>&nbsp;<span class="op" id="5000767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000770">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000817">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000863">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000912">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000956">Director</span>&nbsp;<span class="keyword" id="5000965">func</span><span class="op" id="5000969">(</span><span class="op" id="5000970">*</span><span class="ident" id="5000971">http</span><span class="op" id="5000975">.</span><span class="ident" id="5000976">Request</span><span class="op" id="5000983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000987">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001037">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001080">Transport</span>&nbsp;<span class="ident" id="5001090">http</span><span class="op" id="5001094">.</span><span class="ident" id="5001095">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001110">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001157">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001202">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001221">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001264">FlushInterval</span>&nbsp;<span class="ident" id="5001278">time</span><span class="op" id="5001282">.</span><span class="ident" id="5001283">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001294">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001347">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001400">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001460">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001481">ErrorLog</span>&nbsp;<span class="op" id="5001490">*</span><span class="ident" id="5001491">log</span><span class="op" id="5001494">.</span><span class="ident" id="5001495">Logger</span><br>
<span class="lineno"></span><span class="op" id="5001502">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5001505">func</span>&nbsp;<span class="ident" id="5001510">singleJoiningSlash</span><span class="op" id="5001528">(</span><span class="ident" id="5001529">a</span><span class="op" id="5001530">,</span>&nbsp;<span class="ident" id="5001532">b</span>&nbsp;<span class="builtintype" id="5001534">string</span><span class="op" id="5001540">)</span>&nbsp;<span class="builtintype" id="5001542">string</span>&nbsp;<span class="op" id="5001549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001552">aslash</span>&nbsp;<span class="op" id="5001559">:=</span>&nbsp;<span class="ident" id="5001562">strings</span><span class="op" id="5001569">.</span><span class="ident" id="5001570">HasSuffix</span><span class="op" id="5001579">(</span><span class="ident" id="5001580">a</span><span class="op" id="5001581">,</span>&nbsp;<span class="string" id="5001583">&#34;/&#34;</span><span class="op" id="5001586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001589">bslash</span>&nbsp;<span class="op" id="5001596">:=</span>&nbsp;<span class="ident" id="5001599">strings</span><span class="op" id="5001606">.</span><span class="ident" id="5001607">HasPrefix</span><span class="op" id="5001616">(</span><span class="ident" id="5001617">b</span><span class="op" id="5001618">,</span>&nbsp;<span class="string" id="5001620">&#34;/&#34;</span><span class="op" id="5001623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001626">switch</span>&nbsp;<span class="op" id="5001633">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001636">case</span>&nbsp;<span class="ident" id="5001641">aslash</span>&nbsp;<span class="op" id="5001648">&amp;&amp;</span>&nbsp;<span class="ident" id="5001651">bslash</span><span class="op" id="5001657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001661">return</span>&nbsp;<span class="ident" id="5001668">a</span>&nbsp;<span class="op" id="5001670">+</span>&nbsp;<span class="ident" id="5001672">b</span><span class="op" id="5001673">[</span><span class="num" id="5001674">1</span><span class="op" id="5001675">:</span><span class="op" id="5001676">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001679">case</span>&nbsp;<span class="op" id="5001684">!</span><span class="ident" id="5001685">aslash</span>&nbsp;<span class="op" id="5001692">&amp;&amp;</span>&nbsp;<span class="op" id="5001695">!</span><span class="ident" id="5001696">bslash</span><span class="op" id="5001702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001706">return</span>&nbsp;<span class="ident" id="5001713">a</span>&nbsp;<span class="op" id="5001715">+</span>&nbsp;<span class="string" id="5001717">&#34;/&#34;</span>&nbsp;<span class="op" id="5001721">+</span>&nbsp;<span class="ident" id="5001723">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001726">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001729">return</span>&nbsp;<span class="ident" id="5001736">a</span>&nbsp;<span class="op" id="5001738">+</span>&nbsp;<span class="ident" id="5001740">b</span><br>
<span class="lineno"></span><span class="op" id="5001742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5001745">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="5001815">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="5001885">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5001954">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="5001999">func</span>&nbsp;<span class="ident" id="5002004">NewSingleHostReverseProxy</span><span class="op" id="5002029">(</span><span class="ident" id="5002030">target</span>&nbsp;<span class="op" id="5002037">*</span><span class="ident" id="5002038">url</span><span class="op" id="5002041">.</span><span class="ident" id="5002042">URL</span><span class="op" id="5002045">)</span>&nbsp;<span class="op" id="5002047">*</span><span class="ident" id="5002048">ReverseProxy</span>&nbsp;<span class="op" id="5002061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002064">targetQuery</span>&nbsp;<span class="op" id="5002076">:=</span>&nbsp;<span class="ident" id="5002079">target</span><span class="op" id="5002085">.</span><span class="ident" id="5002086">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002096">director</span>&nbsp;<span class="op" id="5002105">:=</span>&nbsp;<span class="keyword" id="5002108">func</span><span class="op" id="5002112">(</span><span class="ident" id="5002113">req</span>&nbsp;<span class="op" id="5002117">*</span><span class="ident" id="5002118">http</span><span class="op" id="5002122">.</span><span class="ident" id="5002123">Request</span><span class="op" id="5002130">)</span>&nbsp;<span class="op" id="5002132">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002136">req</span><span class="op" id="5002139">.</span><span class="ident" id="5002140">URL</span><span class="op" id="5002143">.</span><span class="ident" id="5002144">Scheme</span>&nbsp;<span class="op" id="5002151">=</span>&nbsp;<span class="ident" id="5002153">target</span><span class="op" id="5002159">.</span><span class="ident" id="5002160">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002169">req</span><span class="op" id="5002172">.</span><span class="ident" id="5002173">URL</span><span class="op" id="5002176">.</span><span class="ident" id="5002177">Host</span>&nbsp;<span class="op" id="5002182">=</span>&nbsp;<span class="ident" id="5002184">target</span><span class="op" id="5002190">.</span><span class="ident" id="5002191">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002198">req</span><span class="op" id="5002201">.</span><span class="ident" id="5002202">URL</span><span class="op" id="5002205">.</span><span class="ident" id="5002206">Path</span>&nbsp;<span class="op" id="5002211">=</span>&nbsp;<span class="ident" id="5002213">singleJoiningSlash</span><span class="op" id="5002231">(</span><span class="ident" id="5002232">target</span><span class="op" id="5002238">.</span><span class="ident" id="5002239">Path</span><span class="op" id="5002243">,</span>&nbsp;<span class="ident" id="5002245">req</span><span class="op" id="5002248">.</span><span class="ident" id="5002249">URL</span><span class="op" id="5002252">.</span><span class="ident" id="5002253">Path</span><span class="op" id="5002257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002261">if</span>&nbsp;<span class="ident" id="5002264">targetQuery</span>&nbsp;<span class="op" id="5002276">==</span>&nbsp;<span class="string" id="5002279">&#34;&#34;</span>&nbsp;<span class="op" id="5002282">||</span>&nbsp;<span class="ident" id="5002285">req</span><span class="op" id="5002288">.</span><span class="ident" id="5002289">URL</span><span class="op" id="5002292">.</span><span class="ident" id="5002293">RawQuery</span>&nbsp;<span class="op" id="5002302">==</span>&nbsp;<span class="string" id="5002305">&#34;&#34;</span>&nbsp;<span class="op" id="5002308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002313">req</span><span class="op" id="5002316">.</span><span class="ident" id="5002317">URL</span><span class="op" id="5002320">.</span><span class="ident" id="5002321">RawQuery</span>&nbsp;<span class="op" id="5002330">=</span>&nbsp;<span class="ident" id="5002332">targetQuery</span>&nbsp;<span class="op" id="5002344">+</span>&nbsp;<span class="ident" id="5002346">req</span><span class="op" id="5002349">.</span><span class="ident" id="5002350">URL</span><span class="op" id="5002353">.</span><span class="ident" id="5002354">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002365">}</span>&nbsp;<span class="keyword" id="5002367">else</span>&nbsp;<span class="op" id="5002372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002377">req</span><span class="op" id="5002380">.</span><span class="ident" id="5002381">URL</span><span class="op" id="5002384">.</span><span class="ident" id="5002385">RawQuery</span>&nbsp;<span class="op" id="5002394">=</span>&nbsp;<span class="ident" id="5002396">targetQuery</span>&nbsp;<span class="op" id="5002408">+</span>&nbsp;<span class="string" id="5002410">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="5002414">+</span>&nbsp;<span class="ident" id="5002416">req</span><span class="op" id="5002419">.</span><span class="ident" id="5002420">URL</span><span class="op" id="5002423">.</span><span class="ident" id="5002424">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002441">return</span>&nbsp;<span class="op" id="5002448">&amp;</span><span class="ident" id="5002449">ReverseProxy</span><span class="op" id="5002461">{</span><span class="ident" id="5002462">Director</span><span class="op" id="5002470">:</span>&nbsp;<span class="ident" id="5002472">director</span><span class="op" id="5002480">}</span><br>
<span class="lineno">80</span><span class="op" id="5002482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5002485">func</span>&nbsp;<span class="ident" id="5002490">copyHeader</span><span class="op" id="5002500">(</span><span class="ident" id="5002501">dst</span><span class="op" id="5002504">,</span>&nbsp;<span class="ident" id="5002506">src</span>&nbsp;<span class="ident" id="5002510">http</span><span class="op" id="5002514">.</span><span class="ident" id="5002515">Header</span><span class="op" id="5002521">)</span>&nbsp;<span class="op" id="5002523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002526">for</span>&nbsp;<span class="ident" id="5002530">k</span><span class="op" id="5002531">,</span>&nbsp;<span class="ident" id="5002533">vv</span>&nbsp;<span class="op" id="5002536">:=</span>&nbsp;<span class="keyword" id="5002539">range</span>&nbsp;<span class="ident" id="5002545">src</span>&nbsp;<span class="op" id="5002549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002553">for</span>&nbsp;<span class="ident" id="5002557">_</span><span class="op" id="5002558">,</span>&nbsp;<span class="ident" id="5002560">v</span>&nbsp;<span class="op" id="5002562">:=</span>&nbsp;<span class="keyword" id="5002565">range</span>&nbsp;<span class="ident" id="5002571">vv</span>&nbsp;<span class="op" id="5002574">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002579">dst</span><span class="op" id="5002582">.</span><span class="ident" id="5002583">Add</span><span class="op" id="5002586">(</span><span class="ident" id="5002587">k</span><span class="op" id="5002588">,</span>&nbsp;<span class="ident" id="5002590">v</span><span class="op" id="5002591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002598">}</span><br>
<span class="lineno"></span><span class="op" id="5002600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5002603">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="5002670">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="5002728">var</span>&nbsp;<span class="ident" id="5002732">hopHeaders</span>&nbsp;<span class="op" id="5002743">=</span>&nbsp;<span class="op" id="5002745">[</span><span class="op" id="5002746">]</span><span class="builtintype" id="5002747">string</span><span class="op" id="5002753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5002756">&#34;Connection&#34;</span><span class="op" id="5002768">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5002771">&#34;Keep-Alive&#34;</span><span class="op" id="5002783">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5002786">&#34;Proxy-Authenticate&#34;</span><span class="op" id="5002806">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5002809">&#34;Proxy-Authorization&#34;</span><span class="op" id="5002830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5002833">&#34;Te&#34;</span><span class="op" id="5002837">,</span>&nbsp;<span class="comment" id="5002839">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5002873">&#34;Trailers&#34;</span><span class="op" id="5002883">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5002886">&#34;Transfer-Encoding&#34;</span><span class="op" id="5002905">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5002908">&#34;Upgrade&#34;</span><span class="op" id="5002917">,</span><br>
<span class="lineno"></span><span class="op" id="5002919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5002922">func</span>&nbsp;<span class="op" id="5002927">(</span><span class="ident" id="5002928">p</span>&nbsp;<span class="op" id="5002930">*</span><span class="ident" id="5002931">ReverseProxy</span><span class="op" id="5002943">)</span>&nbsp;<span class="ident" id="5002945">ServeHTTP</span><span class="op" id="5002954">(</span><span class="ident" id="5002955">rw</span>&nbsp;<span class="ident" id="5002958">http</span><span class="op" id="5002962">.</span><span class="ident" id="5002963">ResponseWriter</span><span class="op" id="5002977">,</span>&nbsp;<span class="ident" id="5002979">req</span>&nbsp;<span class="op" id="5002983">*</span><span class="ident" id="5002984">http</span><span class="op" id="5002988">.</span><span class="ident" id="5002989">Request</span><span class="op" id="5002996">)</span>&nbsp;<span class="op" id="5002998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003001">transport</span>&nbsp;<span class="op" id="5003011">:=</span>&nbsp;<span class="ident" id="5003014">p</span><span class="op" id="5003015">.</span><span class="ident" id="5003016">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003027">if</span>&nbsp;<span class="ident" id="5003030">transport</span>&nbsp;<span class="op" id="5003040">==</span>&nbsp;<span class="ident" id="5003043">nil</span>&nbsp;<span class="op" id="5003047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003051">transport</span>&nbsp;<span class="op" id="5003061">=</span>&nbsp;<span class="ident" id="5003063">http</span><span class="op" id="5003067">.</span><span class="ident" id="5003068">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003090">outreq</span>&nbsp;<span class="op" id="5003097">:=</span>&nbsp;<span class="builtinfunc" id="5003100">new</span><span class="op" id="5003103">(</span><span class="ident" id="5003104">http</span><span class="op" id="5003108">.</span><span class="ident" id="5003109">Request</span><span class="op" id="5003116">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003119">*</span><span class="ident" id="5003120">outreq</span>&nbsp;<span class="op" id="5003127">=</span>&nbsp;<span class="op" id="5003129">*</span><span class="ident" id="5003130">req</span>&nbsp;<span class="comment" id="5003134">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003181">p</span><span class="op" id="5003182">.</span><span class="ident" id="5003183">Director</span><span class="op" id="5003191">(</span><span class="ident" id="5003192">outreq</span><span class="op" id="5003198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003201">outreq</span><span class="op" id="5003207">.</span><span class="ident" id="5003208">Proto</span>&nbsp;<span class="op" id="5003214">=</span>&nbsp;<span class="string" id="5003216">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003228">outreq</span><span class="op" id="5003234">.</span><span class="ident" id="5003235">ProtoMajor</span>&nbsp;<span class="op" id="5003246">=</span>&nbsp;<span class="num" id="5003248">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003251">outreq</span><span class="op" id="5003257">.</span><span class="ident" id="5003258">ProtoMinor</span>&nbsp;<span class="op" id="5003269">=</span>&nbsp;<span class="num" id="5003271">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003274">outreq</span><span class="op" id="5003280">.</span><span class="ident" id="5003281">Close</span>&nbsp;<span class="op" id="5003287">=</span>&nbsp;<span class="builtintype" id="5003289">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003297">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003355">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003414">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003478">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003537">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003588">copiedHeaders</span>&nbsp;<span class="op" id="5003602">:=</span>&nbsp;<span class="builtintype" id="5003605">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003612">for</span>&nbsp;<span class="ident" id="5003616">_</span><span class="op" id="5003617">,</span>&nbsp;<span class="ident" id="5003619">h</span>&nbsp;<span class="op" id="5003621">:=</span>&nbsp;<span class="keyword" id="5003624">range</span>&nbsp;<span class="ident" id="5003630">hopHeaders</span>&nbsp;<span class="op" id="5003641">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003645">if</span>&nbsp;<span class="ident" id="5003648">outreq</span><span class="op" id="5003654">.</span><span class="ident" id="5003655">Header</span><span class="op" id="5003661">.</span><span class="ident" id="5003662">Get</span><span class="op" id="5003665">(</span><span class="ident" id="5003666">h</span><span class="op" id="5003667">)</span>&nbsp;<span class="op" id="5003669">!=</span>&nbsp;<span class="string" id="5003672">&#34;&#34;</span>&nbsp;<span class="op" id="5003675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003680">if</span>&nbsp;<span class="op" id="5003683">!</span><span class="ident" id="5003684">copiedHeaders</span>&nbsp;<span class="op" id="5003698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003704">outreq</span><span class="op" id="5003710">.</span><span class="ident" id="5003711">Header</span>&nbsp;<span class="op" id="5003718">=</span>&nbsp;<span class="builtinfunc" id="5003720">make</span><span class="op" id="5003724">(</span><span class="ident" id="5003725">http</span><span class="op" id="5003729">.</span><span class="ident" id="5003730">Header</span><span class="op" id="5003736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003742">copyHeader</span><span class="op" id="5003752">(</span><span class="ident" id="5003753">outreq</span><span class="op" id="5003759">.</span><span class="ident" id="5003760">Header</span><span class="op" id="5003766">,</span>&nbsp;<span class="ident" id="5003768">req</span><span class="op" id="5003771">.</span><span class="ident" id="5003772">Header</span><span class="op" id="5003778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003784">copiedHeaders</span>&nbsp;<span class="op" id="5003798">=</span>&nbsp;<span class="builtintype" id="5003800">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003813">outreq</span><span class="op" id="5003819">.</span><span class="ident" id="5003820">Header</span><span class="op" id="5003826">.</span><span class="ident" id="5003827">Del</span><span class="op" id="5003830">(</span><span class="ident" id="5003831">h</span><span class="op" id="5003832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003843">if</span>&nbsp;<span class="ident" id="5003846">clientIP</span><span class="op" id="5003854">,</span>&nbsp;<span class="ident" id="5003856">_</span><span class="op" id="5003857">,</span>&nbsp;<span class="ident" id="5003859">err</span>&nbsp;<span class="op" id="5003863">:=</span>&nbsp;<span class="ident" id="5003866">net</span><span class="op" id="5003869">.</span><span class="ident" id="5003870">SplitHostPort</span><span class="op" id="5003883">(</span><span class="ident" id="5003884">req</span><span class="op" id="5003887">.</span><span class="ident" id="5003888">RemoteAddr</span><span class="op" id="5003898">)</span><span class="op" id="5003899">;</span>&nbsp;<span class="ident" id="5003901">err</span>&nbsp;<span class="op" id="5003905">==</span>&nbsp;<span class="ident" id="5003908">nil</span>&nbsp;<span class="op" id="5003912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003916">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003963">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004013">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004069">if</span>&nbsp;<span class="ident" id="5004072">prior</span><span class="op" id="5004077">,</span>&nbsp;<span class="ident" id="5004079">ok</span>&nbsp;<span class="op" id="5004082">:=</span>&nbsp;<span class="ident" id="5004085">outreq</span><span class="op" id="5004091">.</span><span class="ident" id="5004092">Header</span><span class="op" id="5004098">[</span><span class="string" id="5004099">&#34;X-Forwarded-For&#34;</span><span class="op" id="5004116">]</span><span class="op" id="5004117">;</span>&nbsp;<span class="ident" id="5004119">ok</span>&nbsp;<span class="op" id="5004122">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004127">clientIP</span>&nbsp;<span class="op" id="5004136">=</span>&nbsp;<span class="ident" id="5004138">strings</span><span class="op" id="5004145">.</span><span class="ident" id="5004146">Join</span><span class="op" id="5004150">(</span><span class="ident" id="5004151">prior</span><span class="op" id="5004156">,</span>&nbsp;<span class="string" id="5004158">&#34;,&nbsp;&#34;</span><span class="op" id="5004162">)</span>&nbsp;<span class="op" id="5004164">+</span>&nbsp;<span class="string" id="5004166">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="5004171">+</span>&nbsp;<span class="ident" id="5004173">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004188">outreq</span><span class="op" id="5004194">.</span><span class="ident" id="5004195">Header</span><span class="op" id="5004201">.</span><span class="ident" id="5004202">Set</span><span class="op" id="5004205">(</span><span class="string" id="5004206">&#34;X-Forwarded-For&#34;</span><span class="op" id="5004223">,</span>&nbsp;<span class="ident" id="5004225">clientIP</span><span class="op" id="5004233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004240">res</span><span class="op" id="5004243">,</span>&nbsp;<span class="ident" id="5004245">err</span>&nbsp;<span class="op" id="5004249">:=</span>&nbsp;<span class="ident" id="5004252">transport</span><span class="op" id="5004261">.</span><span class="ident" id="5004262">RoundTrip</span><span class="op" id="5004271">(</span><span class="ident" id="5004272">outreq</span><span class="op" id="5004278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004281">if</span>&nbsp;<span class="ident" id="5004284">err</span>&nbsp;<span class="op" id="5004288">!=</span>&nbsp;<span class="ident" id="5004291">nil</span>&nbsp;<span class="op" id="5004295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004299">p</span><span class="op" id="5004300">.</span><span class="ident" id="5004301">logf</span><span class="op" id="5004305">(</span><span class="string" id="5004306">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="5004329">,</span>&nbsp;<span class="ident" id="5004331">err</span><span class="op" id="5004334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004338">rw</span><span class="op" id="5004340">.</span><span class="ident" id="5004341">WriteHeader</span><span class="op" id="5004352">(</span><span class="ident" id="5004353">http</span><span class="op" id="5004357">.</span><span class="ident" id="5004358">StatusInternalServerError</span><span class="op" id="5004383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004387">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004398">defer</span>&nbsp;<span class="ident" id="5004404">res</span><span class="op" id="5004407">.</span><span class="ident" id="5004408">Body</span><span class="op" id="5004412">.</span><span class="ident" id="5004413">Close</span><span class="op" id="5004418">(</span><span class="op" id="5004419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004423">for</span>&nbsp;<span class="ident" id="5004427">_</span><span class="op" id="5004428">,</span>&nbsp;<span class="ident" id="5004430">h</span>&nbsp;<span class="op" id="5004432">:=</span>&nbsp;<span class="keyword" id="5004435">range</span>&nbsp;<span class="ident" id="5004441">hopHeaders</span>&nbsp;<span class="op" id="5004452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004456">res</span><span class="op" id="5004459">.</span><span class="ident" id="5004460">Header</span><span class="op" id="5004466">.</span><span class="ident" id="5004467">Del</span><span class="op" id="5004470">(</span><span class="ident" id="5004471">h</span><span class="op" id="5004472">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004479">copyHeader</span><span class="op" id="5004489">(</span><span class="ident" id="5004490">rw</span><span class="op" id="5004492">.</span><span class="ident" id="5004493">Header</span><span class="op" id="5004499">(</span><span class="op" id="5004500">)</span><span class="op" id="5004501">,</span>&nbsp;<span class="ident" id="5004503">res</span><span class="op" id="5004506">.</span><span class="ident" id="5004507">Header</span><span class="op" id="5004513">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004517">rw</span><span class="op" id="5004519">.</span><span class="ident" id="5004520">WriteHeader</span><span class="op" id="5004531">(</span><span class="ident" id="5004532">res</span><span class="op" id="5004535">.</span><span class="ident" id="5004536">StatusCode</span><span class="op" id="5004546">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004549">p</span><span class="op" id="5004550">.</span><span class="ident" id="5004551">copyResponse</span><span class="op" id="5004563">(</span><span class="ident" id="5004564">rw</span><span class="op" id="5004566">,</span>&nbsp;<span class="ident" id="5004568">res</span><span class="op" id="5004571">.</span><span class="ident" id="5004572">Body</span><span class="op" id="5004576">)</span><br>
<span class="lineno"></span><span class="op" id="5004578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5004581">func</span>&nbsp;<span class="op" id="5004586">(</span><span class="ident" id="5004587">p</span>&nbsp;<span class="op" id="5004589">*</span><span class="ident" id="5004590">ReverseProxy</span><span class="op" id="5004602">)</span>&nbsp;<span class="ident" id="5004604">copyResponse</span><span class="op" id="5004616">(</span><span class="ident" id="5004617">dst</span>&nbsp;<span class="ident" id="5004621">io</span><span class="op" id="5004623">.</span><span class="ident" id="5004624">Writer</span><span class="op" id="5004630">,</span>&nbsp;<span class="ident" id="5004632">src</span>&nbsp;<span class="ident" id="5004636">io</span><span class="op" id="5004638">.</span><span class="ident" id="5004639">Reader</span><span class="op" id="5004645">)</span>&nbsp;<span class="op" id="5004647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004650">if</span>&nbsp;<span class="ident" id="5004653">p</span><span class="op" id="5004654">.</span><span class="ident" id="5004655">FlushInterval</span>&nbsp;<span class="op" id="5004669">!=</span>&nbsp;<span class="num" id="5004672">0</span>&nbsp;<span class="op" id="5004674">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004678">if</span>&nbsp;<span class="ident" id="5004681">wf</span><span class="op" id="5004683">,</span>&nbsp;<span class="ident" id="5004685">ok</span>&nbsp;<span class="op" id="5004688">:=</span>&nbsp;<span class="ident" id="5004691">dst</span><span class="op" id="5004694">.</span><span class="op" id="5004695">(</span><span class="ident" id="5004696">writeFlusher</span><span class="op" id="5004708">)</span><span class="op" id="5004709">;</span>&nbsp;<span class="ident" id="5004711">ok</span>&nbsp;<span class="op" id="5004714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004719">mlw</span>&nbsp;<span class="op" id="5004723">:=</span>&nbsp;<span class="op" id="5004726">&amp;</span><span class="ident" id="5004727">maxLatencyWriter</span><span class="op" id="5004743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004749">dst</span><span class="op" id="5004752">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5004758">wf</span><span class="op" id="5004760">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004766">latency</span><span class="op" id="5004773">:</span>&nbsp;<span class="ident" id="5004775">p</span><span class="op" id="5004776">.</span><span class="ident" id="5004777">FlushInterval</span><span class="op" id="5004790">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004796">done</span><span class="op" id="5004800">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5004805">make</span><span class="op" id="5004809">(</span><span class="keyword" id="5004810">chan</span>&nbsp;<span class="builtintype" id="5004815">bool</span><span class="op" id="5004819">)</span><span class="op" id="5004820">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004830">go</span>&nbsp;<span class="ident" id="5004833">mlw</span><span class="op" id="5004836">.</span><span class="ident" id="5004837">flushLoop</span><span class="op" id="5004846">(</span><span class="op" id="5004847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004852">defer</span>&nbsp;<span class="ident" id="5004858">mlw</span><span class="op" id="5004861">.</span><span class="ident" id="5004862">stop</span><span class="op" id="5004866">(</span><span class="op" id="5004867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004872">dst</span>&nbsp;<span class="op" id="5004876">=</span>&nbsp;<span class="ident" id="5004878">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004884">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004891">io</span><span class="op" id="5004893">.</span><span class="ident" id="5004894">Copy</span><span class="op" id="5004898">(</span><span class="ident" id="5004899">dst</span><span class="op" id="5004902">,</span>&nbsp;<span class="ident" id="5004904">src</span><span class="op" id="5004907">)</span><br>
<span class="lineno"></span><span class="op" id="5004909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="5004912">func</span>&nbsp;<span class="op" id="5004917">(</span><span class="ident" id="5004918">p</span>&nbsp;<span class="op" id="5004920">*</span><span class="ident" id="5004921">ReverseProxy</span><span class="op" id="5004933">)</span>&nbsp;<span class="ident" id="5004935">logf</span><span class="op" id="5004939">(</span><span class="ident" id="5004940">format</span>&nbsp;<span class="builtintype" id="5004947">string</span><span class="op" id="5004953">,</span>&nbsp;<span class="ident" id="5004955">args</span>&nbsp;<span class="op" id="5004960">...</span><span class="keyword" id="5004963">interface</span><span class="op" id="5004972">{</span><span class="op" id="5004973">}</span><span class="op" id="5004974">)</span>&nbsp;<span class="op" id="5004976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004979">if</span>&nbsp;<span class="ident" id="5004982">p</span><span class="op" id="5004983">.</span><span class="ident" id="5004984">ErrorLog</span>&nbsp;<span class="op" id="5004993">!=</span>&nbsp;<span class="ident" id="5004996">nil</span>&nbsp;<span class="op" id="5005000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005004">p</span><span class="op" id="5005005">.</span><span class="ident" id="5005006">ErrorLog</span><span class="op" id="5005014">.</span><span class="ident" id="5005015">Printf</span><span class="op" id="5005021">(</span><span class="ident" id="5005022">format</span><span class="op" id="5005028">,</span>&nbsp;<span class="ident" id="5005030">args</span><span class="op" id="5005034">...</span><span class="op" id="5005037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5005040">}</span>&nbsp;<span class="keyword" id="5005042">else</span>&nbsp;<span class="op" id="5005047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005051">log</span><span class="op" id="5005054">.</span><span class="ident" id="5005055">Printf</span><span class="op" id="5005061">(</span><span class="ident" id="5005062">format</span><span class="op" id="5005068">,</span>&nbsp;<span class="ident" id="5005070">args</span><span class="op" id="5005074">...</span><span class="op" id="5005077">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5005080">}</span><br>
<span class="lineno"></span><span class="op" id="5005082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5005085">type</span>&nbsp;<span class="ident" id="5005090">writeFlusher</span>&nbsp;<span class="keyword" id="5005103">interface</span>&nbsp;<span class="op" id="5005113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005116">io</span><span class="op" id="5005118">.</span><span class="ident" id="5005119">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005127">http</span><span class="op" id="5005131">.</span><span class="ident" id="5005132">Flusher</span><br>
<span class="lineno"></span><span class="op" id="5005140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5005143">type</span>&nbsp;<span class="ident" id="5005148">maxLatencyWriter</span>&nbsp;<span class="keyword" id="5005165">struct</span>&nbsp;<span class="op" id="5005172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005175">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5005183">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005197">latency</span>&nbsp;<span class="ident" id="5005205">time</span><span class="op" id="5005209">.</span><span class="ident" id="5005210">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005221">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5005226">sync</span><span class="op" id="5005230">.</span><span class="ident" id="5005231">Mutex</span>&nbsp;<span class="comment" id="5005237">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005264">done</span>&nbsp;<span class="keyword" id="5005269">chan</span>&nbsp;<span class="builtintype" id="5005274">bool</span><br>
<span class="lineno"></span><span class="op" id="5005279">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="5005282">func</span>&nbsp;<span class="op" id="5005287">(</span><span class="ident" id="5005288">m</span>&nbsp;<span class="op" id="5005290">*</span><span class="ident" id="5005291">maxLatencyWriter</span><span class="op" id="5005307">)</span>&nbsp;<span class="ident" id="5005309">Write</span><span class="op" id="5005314">(</span><span class="ident" id="5005315">p</span>&nbsp;<span class="op" id="5005317">[</span><span class="op" id="5005318">]</span><span class="builtintype" id="5005319">byte</span><span class="op" id="5005323">)</span>&nbsp;<span class="op" id="5005325">(</span><span class="builtintype" id="5005326">int</span><span class="op" id="5005329">,</span>&nbsp;<span class="builtintype" id="5005331">error</span><span class="op" id="5005336">)</span>&nbsp;<span class="op" id="5005338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005341">m</span><span class="op" id="5005342">.</span><span class="ident" id="5005343">lk</span><span class="op" id="5005345">.</span><span class="ident" id="5005346">Lock</span><span class="op" id="5005350">(</span><span class="op" id="5005351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005354">defer</span>&nbsp;<span class="ident" id="5005360">m</span><span class="op" id="5005361">.</span><span class="ident" id="5005362">lk</span><span class="op" id="5005364">.</span><span class="ident" id="5005365">Unlock</span><span class="op" id="5005371">(</span><span class="op" id="5005372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005375">return</span>&nbsp;<span class="ident" id="5005382">m</span><span class="op" id="5005383">.</span><span class="ident" id="5005384">dst</span><span class="op" id="5005387">.</span><span class="ident" id="5005388">Write</span><span class="op" id="5005393">(</span><span class="ident" id="5005394">p</span><span class="op" id="5005395">)</span><br>
<span class="lineno">205</span><span class="op" id="5005397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5005400">func</span>&nbsp;<span class="op" id="5005405">(</span><span class="ident" id="5005406">m</span>&nbsp;<span class="op" id="5005408">*</span><span class="ident" id="5005409">maxLatencyWriter</span><span class="op" id="5005425">)</span>&nbsp;<span class="ident" id="5005427">flushLoop</span><span class="op" id="5005436">(</span><span class="op" id="5005437">)</span>&nbsp;<span class="op" id="5005439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005442">t</span>&nbsp;<span class="op" id="5005444">:=</span>&nbsp;<span class="ident" id="5005447">time</span><span class="op" id="5005451">.</span><span class="ident" id="5005452">NewTicker</span><span class="op" id="5005461">(</span><span class="ident" id="5005462">m</span><span class="op" id="5005463">.</span><span class="ident" id="5005464">latency</span><span class="op" id="5005471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005474">defer</span>&nbsp;<span class="ident" id="5005480">t</span><span class="op" id="5005481">.</span><span class="ident" id="5005482">Stop</span><span class="op" id="5005486">(</span><span class="op" id="5005487">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005490">for</span>&nbsp;<span class="op" id="5005494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005498">select</span>&nbsp;<span class="op" id="5005505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005509">case</span>&nbsp;<span class="op" id="5005514">&lt;-</span><span class="ident" id="5005516">m</span><span class="op" id="5005517">.</span><span class="ident" id="5005518">done</span><span class="op" id="5005522">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005527">if</span>&nbsp;<span class="ident" id="5005530">onExitFlushLoop</span>&nbsp;<span class="op" id="5005546">!=</span>&nbsp;<span class="ident" id="5005549">nil</span>&nbsp;<span class="op" id="5005553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005559">onExitFlushLoop</span><span class="op" id="5005574">(</span><span class="op" id="5005575">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5005580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005585">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005594">case</span>&nbsp;<span class="op" id="5005599">&lt;-</span><span class="ident" id="5005601">t</span><span class="op" id="5005602">.</span><span class="ident" id="5005603">C</span><span class="op" id="5005604">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005609">m</span><span class="op" id="5005610">.</span><span class="ident" id="5005611">lk</span><span class="op" id="5005613">.</span><span class="ident" id="5005614">Lock</span><span class="op" id="5005618">(</span><span class="op" id="5005619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005624">m</span><span class="op" id="5005625">.</span><span class="ident" id="5005626">dst</span><span class="op" id="5005629">.</span><span class="ident" id="5005630">Flush</span><span class="op" id="5005635">(</span><span class="op" id="5005636">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005641">m</span><span class="op" id="5005642">.</span><span class="ident" id="5005643">lk</span><span class="op" id="5005645">.</span><span class="ident" id="5005646">Unlock</span><span class="op" id="5005652">(</span><span class="op" id="5005653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5005657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5005660">}</span><br>
<span class="lineno"></span><span class="op" id="5005662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="5005665">func</span>&nbsp;<span class="op" id="5005670">(</span><span class="ident" id="5005671">m</span>&nbsp;<span class="op" id="5005673">*</span><span class="ident" id="5005674">maxLatencyWriter</span><span class="op" id="5005690">)</span>&nbsp;<span class="ident" id="5005692">stop</span><span class="op" id="5005696">(</span><span class="op" id="5005697">)</span>&nbsp;<span class="op" id="5005699">{</span>&nbsp;<span class="ident" id="5005701">m</span><span class="op" id="5005702">.</span><span class="ident" id="5005703">done</span>&nbsp;<span class="op" id="5005708">&lt;-</span>&nbsp;<span class="builtintype" id="5005711">true</span>&nbsp;<span class="op" id="5005716">}</span>
</div>
</body>
</html>
