<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5440730">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5440785">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5440839">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5440890">package</span>&nbsp;<span class="ident" id="5440898">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5440908">import</span>&nbsp;<span class="op" id="5440915">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5440918">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5440927">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5440934">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5440942">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5440948">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5440965">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="5440987">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5440990">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5441051">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="5441122">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="5441212">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="5441280">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="5441293">func</span>&nbsp;<span class="ident" id="5441298">escapeTemplate</span><span class="op" id="5441312">(</span><span class="ident" id="5441313">tmpl</span>&nbsp;<span class="op" id="5441318">*</span><span class="ident" id="5441319">Template</span><span class="op" id="5441327">,</span>&nbsp;<span class="ident" id="5441329">node</span>&nbsp;<span class="ident" id="5441334">parse</span><span class="op" id="5441339">.</span><span class="ident" id="5441340">Node</span><span class="op" id="5441344">,</span>&nbsp;<span class="ident" id="5441346">name</span>&nbsp;<span class="builtintype" id="5441351">string</span><span class="op" id="5441357">)</span>&nbsp;<span class="builtintype" id="5441359">error</span>&nbsp;<span class="op" id="5441365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441368">e</span>&nbsp;<span class="op" id="5441370">:=</span>&nbsp;<span class="ident" id="5441373">newEscaper</span><span class="op" id="5441383">(</span><span class="ident" id="5441384">tmpl</span><span class="op" id="5441388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441391">c</span><span class="op" id="5441392">,</span>&nbsp;<span class="ident" id="5441394">_</span>&nbsp;<span class="op" id="5441396">:=</span>&nbsp;<span class="ident" id="5441399">e</span><span class="op" id="5441400">.</span><span class="ident" id="5441401">escapeTree</span><span class="op" id="5441411">(</span><span class="ident" id="5441412">context</span><span class="op" id="5441419">{</span><span class="op" id="5441420">}</span><span class="op" id="5441421">,</span>&nbsp;<span class="ident" id="5441423">node</span><span class="op" id="5441427">,</span>&nbsp;<span class="ident" id="5441429">name</span><span class="op" id="5441433">,</span>&nbsp;<span class="num" id="5441435">0</span><span class="op" id="5441436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441439">var</span>&nbsp;<span class="ident" id="5441443">err</span>&nbsp;<span class="builtintype" id="5441447">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441454">if</span>&nbsp;<span class="ident" id="5441457">c</span><span class="op" id="5441458">.</span><span class="ident" id="5441459">err</span>&nbsp;<span class="op" id="5441463">!=</span>&nbsp;<span class="ident" id="5441466">nil</span>&nbsp;<span class="op" id="5441470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441474">err</span><span class="op" id="5441477">,</span>&nbsp;<span class="ident" id="5441479">c</span><span class="op" id="5441480">.</span><span class="ident" id="5441481">err</span><span class="op" id="5441484">.</span><span class="ident" id="5441485">Name</span>&nbsp;<span class="op" id="5441490">=</span>&nbsp;<span class="ident" id="5441492">c</span><span class="op" id="5441493">.</span><span class="ident" id="5441494">err</span><span class="op" id="5441497">,</span>&nbsp;<span class="ident" id="5441499">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5441505">}</span>&nbsp;<span class="keyword" id="5441507">else</span>&nbsp;<span class="keyword" id="5441512">if</span>&nbsp;<span class="ident" id="5441515">c</span><span class="op" id="5441516">.</span><span class="ident" id="5441517">state</span>&nbsp;<span class="op" id="5441523">!=</span>&nbsp;<span class="ident" id="5441526">stateText</span>&nbsp;<span class="op" id="5441536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441540">err</span>&nbsp;<span class="op" id="5441544">=</span>&nbsp;<span class="op" id="5441546">&amp;</span><span class="ident" id="5441547">Error</span><span class="op" id="5441552">{</span><span class="ident" id="5441553">ErrEndContext</span><span class="op" id="5441566">,</span>&nbsp;<span class="ident" id="5441568">nil</span><span class="op" id="5441571">,</span>&nbsp;<span class="ident" id="5441573">name</span><span class="op" id="5441577">,</span>&nbsp;<span class="num" id="5441579">0</span><span class="op" id="5441580">,</span>&nbsp;<span class="ident" id="5441582">fmt</span><span class="op" id="5441585">.</span><span class="ident" id="5441586">Sprintf</span><span class="op" id="5441593">(</span><span class="string" id="5441594">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="5441626">,</span>&nbsp;<span class="ident" id="5441628">c</span><span class="op" id="5441629">)</span><span class="op" id="5441630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5441633">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441636">if</span>&nbsp;<span class="ident" id="5441639">err</span>&nbsp;<span class="op" id="5441643">!=</span>&nbsp;<span class="ident" id="5441646">nil</span>&nbsp;<span class="op" id="5441650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5441654">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441698">if</span>&nbsp;<span class="ident" id="5441701">t</span>&nbsp;<span class="op" id="5441703">:=</span>&nbsp;<span class="ident" id="5441706">tmpl</span><span class="op" id="5441710">.</span><span class="ident" id="5441711">set</span><span class="op" id="5441714">[</span><span class="ident" id="5441715">name</span><span class="op" id="5441719">]</span><span class="op" id="5441720">;</span>&nbsp;<span class="ident" id="5441722">t</span>&nbsp;<span class="op" id="5441724">!=</span>&nbsp;<span class="ident" id="5441727">nil</span>&nbsp;<span class="op" id="5441731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441736">t</span><span class="op" id="5441737">.</span><span class="ident" id="5441738">escapeErr</span>&nbsp;<span class="op" id="5441748">=</span>&nbsp;<span class="ident" id="5441750">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441757">t</span><span class="op" id="5441758">.</span><span class="ident" id="5441759">text</span><span class="op" id="5441763">.</span><span class="ident" id="5441764">Tree</span>&nbsp;<span class="op" id="5441769">=</span>&nbsp;<span class="ident" id="5441771">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441778">t</span><span class="op" id="5441779">.</span><span class="ident" id="5441780">Tree</span>&nbsp;<span class="op" id="5441785">=</span>&nbsp;<span class="ident" id="5441787">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5441793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441797">return</span>&nbsp;<span class="ident" id="5441804">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5441809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441812">e</span><span class="op" id="5441813">.</span><span class="ident" id="5441814">commit</span><span class="op" id="5441820">(</span><span class="op" id="5441821">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441824">if</span>&nbsp;<span class="ident" id="5441827">t</span>&nbsp;<span class="op" id="5441829">:=</span>&nbsp;<span class="ident" id="5441832">tmpl</span><span class="op" id="5441836">.</span><span class="ident" id="5441837">set</span><span class="op" id="5441840">[</span><span class="ident" id="5441841">name</span><span class="op" id="5441845">]</span><span class="op" id="5441846">;</span>&nbsp;<span class="ident" id="5441848">t</span>&nbsp;<span class="op" id="5441850">!=</span>&nbsp;<span class="ident" id="5441853">nil</span>&nbsp;<span class="op" id="5441857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441861">t</span><span class="op" id="5441862">.</span><span class="ident" id="5441863">escapeErr</span>&nbsp;<span class="op" id="5441873">=</span>&nbsp;<span class="ident" id="5441875">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441886">t</span><span class="op" id="5441887">.</span><span class="ident" id="5441888">Tree</span>&nbsp;<span class="op" id="5441893">=</span>&nbsp;<span class="ident" id="5441895">t</span><span class="op" id="5441896">.</span><span class="ident" id="5441897">text</span><span class="op" id="5441901">.</span><span class="ident" id="5441902">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5441908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441911">return</span>&nbsp;<span class="ident" id="5441918">nil</span><br>
<span class="lineno">45</span><span class="op" id="5441922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5441925">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5441999">var</span>&nbsp;<span class="ident" id="5442003">funcMap</span>&nbsp;<span class="op" id="5442011">=</span>&nbsp;<span class="ident" id="5442013">template</span><span class="op" id="5442021">.</span><span class="ident" id="5442022">FuncMap</span><span class="op" id="5442029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442032">&#34;html_template_attrescaper&#34;</span><span class="op" id="5442059">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442065">attrEscaper</span><span class="op" id="5442076">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442079">&#34;html_template_commentescaper&#34;</span><span class="op" id="5442109">:</span>&nbsp;&nbsp;<span class="ident" id="5442112">commentEscaper</span><span class="op" id="5442126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442129">&#34;html_template_cssescaper&#34;</span><span class="op" id="5442155">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442162">cssEscaper</span><span class="op" id="5442172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442175">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5442205">:</span>&nbsp;&nbsp;<span class="ident" id="5442208">cssValueFilter</span><span class="op" id="5442222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442225">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5442255">:</span>&nbsp;&nbsp;<span class="ident" id="5442258">htmlNameFilter</span><span class="op" id="5442272">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442275">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5442302">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442308">htmlEscaper</span><span class="op" id="5442319">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442322">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5442353">:</span>&nbsp;<span class="ident" id="5442355">jsRegexpEscaper</span><span class="op" id="5442370">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442373">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5442401">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442406">jsStrEscaper</span><span class="op" id="5442418">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442421">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5442449">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442454">jsValEscaper</span><span class="op" id="5442466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442469">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5442499">:</span>&nbsp;&nbsp;<span class="ident" id="5442502">htmlNospaceEscaper</span><span class="op" id="5442520">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442523">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5442552">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5442556">rcdataEscaper</span><span class="op" id="5442569">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442572">&#34;html_template_urlescaper&#34;</span><span class="op" id="5442598">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442605">urlEscaper</span><span class="op" id="5442615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442618">&#34;html_template_urlfilter&#34;</span><span class="op" id="5442643">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442651">urlFilter</span><span class="op" id="5442660">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442663">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5442692">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5442696">urlNormalizer</span><span class="op" id="5442709">,</span><br>
<span class="lineno"></span><span class="op" id="5442711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5442714">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="5442792">var</span>&nbsp;<span class="ident" id="5442796">equivEscapers</span>&nbsp;<span class="op" id="5442810">=</span>&nbsp;<span class="keyword" id="5442812">map</span><span class="op" id="5442815">[</span><span class="builtintype" id="5442816">string</span><span class="op" id="5442822">]</span><span class="builtintype" id="5442823">string</span><span class="op" id="5442829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442832">&#34;html_template_attrescaper&#34;</span><span class="op" id="5442859">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442864">&#34;html&#34;</span><span class="op" id="5442870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442873">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5442900">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442905">&#34;html&#34;</span><span class="op" id="5442911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442914">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5442944">:</span>&nbsp;<span class="string" id="5442946">&#34;html&#34;</span><span class="op" id="5442952">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442955">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5442984">:</span>&nbsp;&nbsp;<span class="string" id="5442987">&#34;html&#34;</span><span class="op" id="5442993">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442996">&#34;html_template_urlescaper&#34;</span><span class="op" id="5443022">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5443028">&#34;urlquery&#34;</span><span class="op" id="5443038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5443041">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5443070">:</span>&nbsp;&nbsp;<span class="string" id="5443073">&#34;urlquery&#34;</span><span class="op" id="5443083">,</span><br>
<span class="lineno"></span><span class="op" id="5443085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="5443088">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="5443167">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5443196">type</span>&nbsp;<span class="ident" id="5443201">escaper</span>&nbsp;<span class="keyword" id="5443209">struct</span>&nbsp;<span class="op" id="5443216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443219">tmpl</span>&nbsp;<span class="op" id="5443224">*</span><span class="ident" id="5443225">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443235">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443306">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443357">output</span>&nbsp;<span class="keyword" id="5443364">map</span><span class="op" id="5443367">[</span><span class="builtintype" id="5443368">string</span><span class="op" id="5443374">]</span><span class="ident" id="5443375">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443384">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443457">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443510">derived</span>&nbsp;<span class="keyword" id="5443518">map</span><span class="op" id="5443521">[</span><span class="builtintype" id="5443522">string</span><span class="op" id="5443528">]</span><span class="op" id="5443529">*</span><span class="ident" id="5443530">template</span><span class="op" id="5443538">.</span><span class="ident" id="5443539">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443549">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443617">called</span>&nbsp;<span class="keyword" id="5443624">map</span><span class="op" id="5443627">[</span><span class="builtintype" id="5443628">string</span><span class="op" id="5443634">]</span><span class="builtintype" id="5443635">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443641">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443708">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443774">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443836">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443854">map</span><span class="op" id="5443857">[</span><span class="op" id="5443858">*</span><span class="ident" id="5443859">parse</span><span class="op" id="5443864">.</span><span class="ident" id="5443865">ActionNode</span><span class="op" id="5443875">]</span><span class="op" id="5443876">[</span><span class="op" id="5443877">]</span><span class="builtintype" id="5443878">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443886">templateNodeEdits</span>&nbsp;<span class="keyword" id="5443904">map</span><span class="op" id="5443907">[</span><span class="op" id="5443908">*</span><span class="ident" id="5443909">parse</span><span class="op" id="5443914">.</span><span class="ident" id="5443915">TemplateNode</span><span class="op" id="5443927">]</span><span class="builtintype" id="5443928">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443936">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443954">map</span><span class="op" id="5443957">[</span><span class="op" id="5443958">*</span><span class="ident" id="5443959">parse</span><span class="op" id="5443964">.</span><span class="ident" id="5443965">TextNode</span><span class="op" id="5443973">]</span><span class="op" id="5443974">[</span><span class="op" id="5443975">]</span><span class="builtintype" id="5443976">byte</span><br>
<span class="lineno"></span><span class="op" id="5443981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5443984">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5444041">func</span>&nbsp;<span class="ident" id="5444046">newEscaper</span><span class="op" id="5444056">(</span><span class="ident" id="5444057">t</span>&nbsp;<span class="op" id="5444059">*</span><span class="ident" id="5444060">Template</span><span class="op" id="5444068">)</span>&nbsp;<span class="op" id="5444070">*</span><span class="ident" id="5444071">escaper</span>&nbsp;<span class="op" id="5444079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444082">return</span>&nbsp;<span class="op" id="5444089">&amp;</span><span class="ident" id="5444090">escaper</span><span class="op" id="5444097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444101">t</span><span class="op" id="5444102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444106">map</span><span class="op" id="5444109">[</span><span class="builtintype" id="5444110">string</span><span class="op" id="5444116">]</span><span class="ident" id="5444117">context</span><span class="op" id="5444124">{</span><span class="op" id="5444125">}</span><span class="op" id="5444126">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444130">map</span><span class="op" id="5444133">[</span><span class="builtintype" id="5444134">string</span><span class="op" id="5444140">]</span><span class="op" id="5444141">*</span><span class="ident" id="5444142">template</span><span class="op" id="5444150">.</span><span class="ident" id="5444151">Template</span><span class="op" id="5444159">{</span><span class="op" id="5444160">}</span><span class="op" id="5444161">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444165">map</span><span class="op" id="5444168">[</span><span class="builtintype" id="5444169">string</span><span class="op" id="5444175">]</span><span class="builtintype" id="5444176">bool</span><span class="op" id="5444180">{</span><span class="op" id="5444181">}</span><span class="op" id="5444182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444186">map</span><span class="op" id="5444189">[</span><span class="op" id="5444190">*</span><span class="ident" id="5444191">parse</span><span class="op" id="5444196">.</span><span class="ident" id="5444197">ActionNode</span><span class="op" id="5444207">]</span><span class="op" id="5444208">[</span><span class="op" id="5444209">]</span><span class="builtintype" id="5444210">string</span><span class="op" id="5444216">{</span><span class="op" id="5444217">}</span><span class="op" id="5444218">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444222">map</span><span class="op" id="5444225">[</span><span class="op" id="5444226">*</span><span class="ident" id="5444227">parse</span><span class="op" id="5444232">.</span><span class="ident" id="5444233">TemplateNode</span><span class="op" id="5444245">]</span><span class="builtintype" id="5444246">string</span><span class="op" id="5444252">{</span><span class="op" id="5444253">}</span><span class="op" id="5444254">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444258">map</span><span class="op" id="5444261">[</span><span class="op" id="5444262">*</span><span class="ident" id="5444263">parse</span><span class="op" id="5444268">.</span><span class="ident" id="5444269">TextNode</span><span class="op" id="5444277">]</span><span class="op" id="5444278">[</span><span class="op" id="5444279">]</span><span class="builtintype" id="5444280">byte</span><span class="op" id="5444284">{</span><span class="op" id="5444285">}</span><span class="op" id="5444286">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5444289">}</span><br>
<span class="lineno"></span><span class="op" id="5444291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444294">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5444375">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="5444451">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5444530">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="5444607">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="5444631">const</span>&nbsp;<span class="ident" id="5444637">filterFailsafe</span>&nbsp;<span class="op" id="5444652">=</span>&nbsp;<span class="string" id="5444654">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="5444666">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5444701">func</span>&nbsp;<span class="op" id="5444706">(</span><span class="ident" id="5444707">e</span>&nbsp;<span class="op" id="5444709">*</span><span class="ident" id="5444710">escaper</span><span class="op" id="5444717">)</span>&nbsp;<span class="ident" id="5444719">escape</span><span class="op" id="5444725">(</span><span class="ident" id="5444726">c</span>&nbsp;<span class="ident" id="5444728">context</span><span class="op" id="5444735">,</span>&nbsp;<span class="ident" id="5444737">n</span>&nbsp;<span class="ident" id="5444739">parse</span><span class="op" id="5444744">.</span><span class="ident" id="5444745">Node</span><span class="op" id="5444749">)</span>&nbsp;<span class="ident" id="5444751">context</span>&nbsp;<span class="op" id="5444759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444762">switch</span>&nbsp;<span class="ident" id="5444769">n</span>&nbsp;<span class="op" id="5444771">:=</span>&nbsp;<span class="ident" id="5444774">n</span><span class="op" id="5444775">.</span><span class="op" id="5444776">(</span><span class="keyword" id="5444777">type</span><span class="op" id="5444781">)</span>&nbsp;<span class="op" id="5444783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444786">case</span>&nbsp;<span class="op" id="5444791">*</span><span class="ident" id="5444792">parse</span><span class="op" id="5444797">.</span><span class="ident" id="5444798">ActionNode</span><span class="op" id="5444808">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444812">return</span>&nbsp;<span class="ident" id="5444819">e</span><span class="op" id="5444820">.</span><span class="ident" id="5444821">escapeAction</span><span class="op" id="5444833">(</span><span class="ident" id="5444834">c</span><span class="op" id="5444835">,</span>&nbsp;<span class="ident" id="5444837">n</span><span class="op" id="5444838">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444841">case</span>&nbsp;<span class="op" id="5444846">*</span><span class="ident" id="5444847">parse</span><span class="op" id="5444852">.</span><span class="ident" id="5444853">IfNode</span><span class="op" id="5444859">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444863">return</span>&nbsp;<span class="ident" id="5444870">e</span><span class="op" id="5444871">.</span><span class="ident" id="5444872">escapeBranch</span><span class="op" id="5444884">(</span><span class="ident" id="5444885">c</span><span class="op" id="5444886">,</span>&nbsp;<span class="op" id="5444888">&amp;</span><span class="ident" id="5444889">n</span><span class="op" id="5444890">.</span><span class="ident" id="5444891">BranchNode</span><span class="op" id="5444901">,</span>&nbsp;<span class="string" id="5444903">&#34;if&#34;</span><span class="op" id="5444907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444910">case</span>&nbsp;<span class="op" id="5444915">*</span><span class="ident" id="5444916">parse</span><span class="op" id="5444921">.</span><span class="ident" id="5444922">ListNode</span><span class="op" id="5444930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444934">return</span>&nbsp;<span class="ident" id="5444941">e</span><span class="op" id="5444942">.</span><span class="ident" id="5444943">escapeList</span><span class="op" id="5444953">(</span><span class="ident" id="5444954">c</span><span class="op" id="5444955">,</span>&nbsp;<span class="ident" id="5444957">n</span><span class="op" id="5444958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444961">case</span>&nbsp;<span class="op" id="5444966">*</span><span class="ident" id="5444967">parse</span><span class="op" id="5444972">.</span><span class="ident" id="5444973">RangeNode</span><span class="op" id="5444982">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444986">return</span>&nbsp;<span class="ident" id="5444993">e</span><span class="op" id="5444994">.</span><span class="ident" id="5444995">escapeBranch</span><span class="op" id="5445007">(</span><span class="ident" id="5445008">c</span><span class="op" id="5445009">,</span>&nbsp;<span class="op" id="5445011">&amp;</span><span class="ident" id="5445012">n</span><span class="op" id="5445013">.</span><span class="ident" id="5445014">BranchNode</span><span class="op" id="5445024">,</span>&nbsp;<span class="string" id="5445026">&#34;range&#34;</span><span class="op" id="5445033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445036">case</span>&nbsp;<span class="op" id="5445041">*</span><span class="ident" id="5445042">parse</span><span class="op" id="5445047">.</span><span class="ident" id="5445048">TemplateNode</span><span class="op" id="5445060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445064">return</span>&nbsp;<span class="ident" id="5445071">e</span><span class="op" id="5445072">.</span><span class="ident" id="5445073">escapeTemplate</span><span class="op" id="5445087">(</span><span class="ident" id="5445088">c</span><span class="op" id="5445089">,</span>&nbsp;<span class="ident" id="5445091">n</span><span class="op" id="5445092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445095">case</span>&nbsp;<span class="op" id="5445100">*</span><span class="ident" id="5445101">parse</span><span class="op" id="5445106">.</span><span class="ident" id="5445107">TextNode</span><span class="op" id="5445115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445119">return</span>&nbsp;<span class="ident" id="5445126">e</span><span class="op" id="5445127">.</span><span class="ident" id="5445128">escapeText</span><span class="op" id="5445138">(</span><span class="ident" id="5445139">c</span><span class="op" id="5445140">,</span>&nbsp;<span class="ident" id="5445142">n</span><span class="op" id="5445143">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445146">case</span>&nbsp;<span class="op" id="5445151">*</span><span class="ident" id="5445152">parse</span><span class="op" id="5445157">.</span><span class="ident" id="5445158">WithNode</span><span class="op" id="5445166">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445170">return</span>&nbsp;<span class="ident" id="5445177">e</span><span class="op" id="5445178">.</span><span class="ident" id="5445179">escapeBranch</span><span class="op" id="5445191">(</span><span class="ident" id="5445192">c</span><span class="op" id="5445193">,</span>&nbsp;<span class="op" id="5445195">&amp;</span><span class="ident" id="5445196">n</span><span class="op" id="5445197">.</span><span class="ident" id="5445198">BranchNode</span><span class="op" id="5445208">,</span>&nbsp;<span class="string" id="5445210">&#34;with&#34;</span><span class="op" id="5445216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5445222">panic</span><span class="op" id="5445227">(</span><span class="string" id="5445228">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="5445240">+</span>&nbsp;<span class="ident" id="5445242">n</span><span class="op" id="5445243">.</span><span class="ident" id="5445244">String</span><span class="op" id="5445250">(</span><span class="op" id="5445251">)</span>&nbsp;<span class="op" id="5445253">+</span>&nbsp;<span class="string" id="5445255">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="5445274">)</span><br>
<span class="lineno"></span><span class="op" id="5445276">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="5445279">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5445328">func</span>&nbsp;<span class="op" id="5445333">(</span><span class="ident" id="5445334">e</span>&nbsp;<span class="op" id="5445336">*</span><span class="ident" id="5445337">escaper</span><span class="op" id="5445344">)</span>&nbsp;<span class="ident" id="5445346">escapeAction</span><span class="op" id="5445358">(</span><span class="ident" id="5445359">c</span>&nbsp;<span class="ident" id="5445361">context</span><span class="op" id="5445368">,</span>&nbsp;<span class="ident" id="5445370">n</span>&nbsp;<span class="op" id="5445372">*</span><span class="ident" id="5445373">parse</span><span class="op" id="5445378">.</span><span class="ident" id="5445379">ActionNode</span><span class="op" id="5445389">)</span>&nbsp;<span class="ident" id="5445391">context</span>&nbsp;<span class="op" id="5445399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445402">if</span>&nbsp;<span class="builtinfunc" id="5445405">len</span><span class="op" id="5445408">(</span><span class="ident" id="5445409">n</span><span class="op" id="5445410">.</span><span class="ident" id="5445411">Pipe</span><span class="op" id="5445415">.</span><span class="ident" id="5445416">Decl</span><span class="op" id="5445420">)</span>&nbsp;<span class="op" id="5445422">!=</span>&nbsp;<span class="num" id="5445425">0</span>&nbsp;<span class="op" id="5445427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5445431">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445487">return</span>&nbsp;<span class="ident" id="5445494">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445500">c</span>&nbsp;<span class="op" id="5445502">=</span>&nbsp;<span class="ident" id="5445504">nudge</span><span class="op" id="5445509">(</span><span class="ident" id="5445510">c</span><span class="op" id="5445511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445514">s</span>&nbsp;<span class="op" id="5445516">:=</span>&nbsp;<span class="builtinfunc" id="5445519">make</span><span class="op" id="5445523">(</span><span class="op" id="5445524">[</span><span class="op" id="5445525">]</span><span class="builtintype" id="5445526">string</span><span class="op" id="5445532">,</span>&nbsp;<span class="num" id="5445534">0</span><span class="op" id="5445535">,</span>&nbsp;<span class="num" id="5445537">3</span><span class="op" id="5445538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445541">switch</span>&nbsp;<span class="ident" id="5445548">c</span><span class="op" id="5445549">.</span><span class="ident" id="5445550">state</span>&nbsp;<span class="op" id="5445556">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445559">case</span>&nbsp;<span class="ident" id="5445564">stateError</span><span class="op" id="5445574">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445578">return</span>&nbsp;<span class="ident" id="5445585">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445588">case</span>&nbsp;<span class="ident" id="5445593">stateURL</span><span class="op" id="5445601">,</span>&nbsp;<span class="ident" id="5445603">stateCSSDqStr</span><span class="op" id="5445616">,</span>&nbsp;<span class="ident" id="5445618">stateCSSSqStr</span><span class="op" id="5445631">,</span>&nbsp;<span class="ident" id="5445633">stateCSSDqURL</span><span class="op" id="5445646">,</span>&nbsp;<span class="ident" id="5445648">stateCSSSqURL</span><span class="op" id="5445661">,</span>&nbsp;<span class="ident" id="5445663">stateCSSURL</span><span class="op" id="5445674">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445678">switch</span>&nbsp;<span class="ident" id="5445685">c</span><span class="op" id="5445686">.</span><span class="ident" id="5445687">urlPart</span>&nbsp;<span class="op" id="5445695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445699">case</span>&nbsp;<span class="ident" id="5445704">urlPartNone</span><span class="op" id="5445715">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445720">s</span>&nbsp;<span class="op" id="5445722">=</span>&nbsp;<span class="builtinfunc" id="5445724">append</span><span class="op" id="5445730">(</span><span class="ident" id="5445731">s</span><span class="op" id="5445732">,</span>&nbsp;<span class="string" id="5445734">&#34;html_template_urlfilter&#34;</span><span class="op" id="5445759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445764">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445778">case</span>&nbsp;<span class="ident" id="5445783">urlPartPreQuery</span><span class="op" id="5445798">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445803">switch</span>&nbsp;<span class="ident" id="5445810">c</span><span class="op" id="5445811">.</span><span class="ident" id="5445812">state</span>&nbsp;<span class="op" id="5445818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445823">case</span>&nbsp;<span class="ident" id="5445828">stateCSSDqStr</span><span class="op" id="5445841">,</span>&nbsp;<span class="ident" id="5445843">stateCSSSqStr</span><span class="op" id="5445856">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445862">s</span>&nbsp;<span class="op" id="5445864">=</span>&nbsp;<span class="builtinfunc" id="5445866">append</span><span class="op" id="5445872">(</span><span class="ident" id="5445873">s</span><span class="op" id="5445874">,</span>&nbsp;<span class="string" id="5445876">&#34;html_template_cssescaper&#34;</span><span class="op" id="5445902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445907">default</span><span class="op" id="5445914">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445920">s</span>&nbsp;<span class="op" id="5445922">=</span>&nbsp;<span class="builtinfunc" id="5445924">append</span><span class="op" id="5445930">(</span><span class="ident" id="5445931">s</span><span class="op" id="5445932">,</span>&nbsp;<span class="string" id="5445934">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5445963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445972">case</span>&nbsp;<span class="ident" id="5445977">urlPartQueryOrFrag</span><span class="op" id="5445995">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446000">s</span>&nbsp;<span class="op" id="5446002">=</span>&nbsp;<span class="builtinfunc" id="5446004">append</span><span class="op" id="5446010">(</span><span class="ident" id="5446011">s</span><span class="op" id="5446012">,</span>&nbsp;<span class="string" id="5446014">&#34;html_template_urlescaper&#34;</span><span class="op" id="5446040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446044">case</span>&nbsp;<span class="ident" id="5446049">urlPartUnknown</span><span class="op" id="5446063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446068">return</span>&nbsp;<span class="ident" id="5446075">context</span><span class="op" id="5446082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446088">state</span><span class="op" id="5446093">:</span>&nbsp;<span class="ident" id="5446095">stateError</span><span class="op" id="5446105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446111">err</span><span class="op" id="5446114">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5446118">errorf</span><span class="op" id="5446124">(</span><span class="ident" id="5446125">ErrAmbigContext</span><span class="op" id="5446140">,</span>&nbsp;<span class="ident" id="5446142">n</span><span class="op" id="5446143">,</span>&nbsp;<span class="ident" id="5446145">n</span><span class="op" id="5446146">.</span><span class="ident" id="5446147">Line</span><span class="op" id="5446151">,</span>&nbsp;<span class="string" id="5446153">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="5446193">,</span>&nbsp;<span class="ident" id="5446195">n</span><span class="op" id="5446196">)</span><span class="op" id="5446197">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446206">default</span><span class="op" id="5446213">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5446218">panic</span><span class="op" id="5446223">(</span><span class="ident" id="5446224">c</span><span class="op" id="5446225">.</span><span class="ident" id="5446226">urlPart</span><span class="op" id="5446233">.</span><span class="ident" id="5446234">String</span><span class="op" id="5446240">(</span><span class="op" id="5446241">)</span><span class="op" id="5446242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446249">case</span>&nbsp;<span class="ident" id="5446254">stateJS</span><span class="op" id="5446261">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446265">s</span>&nbsp;<span class="op" id="5446267">=</span>&nbsp;<span class="builtinfunc" id="5446269">append</span><span class="op" id="5446275">(</span><span class="ident" id="5446276">s</span><span class="op" id="5446277">,</span>&nbsp;<span class="string" id="5446279">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5446307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5446311">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446361">c</span><span class="op" id="5446362">.</span><span class="ident" id="5446363">jsCtx</span>&nbsp;<span class="op" id="5446369">=</span>&nbsp;<span class="ident" id="5446371">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446383">case</span>&nbsp;<span class="ident" id="5446388">stateJSDqStr</span><span class="op" id="5446400">,</span>&nbsp;<span class="ident" id="5446402">stateJSSqStr</span><span class="op" id="5446414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446418">s</span>&nbsp;<span class="op" id="5446420">=</span>&nbsp;<span class="builtinfunc" id="5446422">append</span><span class="op" id="5446428">(</span><span class="ident" id="5446429">s</span><span class="op" id="5446430">,</span>&nbsp;<span class="string" id="5446432">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5446460">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446463">case</span>&nbsp;<span class="ident" id="5446468">stateJSRegexp</span><span class="op" id="5446481">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446485">s</span>&nbsp;<span class="op" id="5446487">=</span>&nbsp;<span class="builtinfunc" id="5446489">append</span><span class="op" id="5446495">(</span><span class="ident" id="5446496">s</span><span class="op" id="5446497">,</span>&nbsp;<span class="string" id="5446499">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5446530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446533">case</span>&nbsp;<span class="ident" id="5446538">stateCSS</span><span class="op" id="5446546">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446550">s</span>&nbsp;<span class="op" id="5446552">=</span>&nbsp;<span class="builtinfunc" id="5446554">append</span><span class="op" id="5446560">(</span><span class="ident" id="5446561">s</span><span class="op" id="5446562">,</span>&nbsp;<span class="string" id="5446564">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5446594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446597">case</span>&nbsp;<span class="ident" id="5446602">stateText</span><span class="op" id="5446611">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446615">s</span>&nbsp;<span class="op" id="5446617">=</span>&nbsp;<span class="builtinfunc" id="5446619">append</span><span class="op" id="5446625">(</span><span class="ident" id="5446626">s</span><span class="op" id="5446627">,</span>&nbsp;<span class="string" id="5446629">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5446656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446659">case</span>&nbsp;<span class="ident" id="5446664">stateRCDATA</span><span class="op" id="5446675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446679">s</span>&nbsp;<span class="op" id="5446681">=</span>&nbsp;<span class="builtinfunc" id="5446683">append</span><span class="op" id="5446689">(</span><span class="ident" id="5446690">s</span><span class="op" id="5446691">,</span>&nbsp;<span class="string" id="5446693">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5446722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446725">case</span>&nbsp;<span class="ident" id="5446730">stateAttr</span><span class="op" id="5446739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5446743">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446777">case</span>&nbsp;<span class="ident" id="5446782">stateAttrName</span><span class="op" id="5446795">,</span>&nbsp;<span class="ident" id="5446797">stateTag</span><span class="op" id="5446805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446809">c</span><span class="op" id="5446810">.</span><span class="ident" id="5446811">state</span>&nbsp;<span class="op" id="5446817">=</span>&nbsp;<span class="ident" id="5446819">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446835">s</span>&nbsp;<span class="op" id="5446837">=</span>&nbsp;<span class="builtinfunc" id="5446839">append</span><span class="op" id="5446845">(</span><span class="ident" id="5446846">s</span><span class="op" id="5446847">,</span>&nbsp;<span class="string" id="5446849">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5446879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446882">default</span><span class="op" id="5446889">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446893">if</span>&nbsp;<span class="ident" id="5446896">isComment</span><span class="op" id="5446905">(</span><span class="ident" id="5446906">c</span><span class="op" id="5446907">.</span><span class="ident" id="5446908">state</span><span class="op" id="5446913">)</span>&nbsp;<span class="op" id="5446915">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446920">s</span>&nbsp;<span class="op" id="5446922">=</span>&nbsp;<span class="builtinfunc" id="5446924">append</span><span class="op" id="5446930">(</span><span class="ident" id="5446931">s</span><span class="op" id="5446932">,</span>&nbsp;<span class="string" id="5446934">&#34;html_template_commentescaper&#34;</span><span class="op" id="5446964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446968">}</span>&nbsp;<span class="keyword" id="5446970">else</span>&nbsp;<span class="op" id="5446975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5446980">panic</span><span class="op" id="5446985">(</span><span class="string" id="5446986">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="5447006">+</span>&nbsp;<span class="ident" id="5447008">c</span><span class="op" id="5447009">.</span><span class="ident" id="5447010">state</span><span class="op" id="5447015">.</span><span class="ident" id="5447016">String</span><span class="op" id="5447022">(</span><span class="op" id="5447023">)</span><span class="op" id="5447024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447031">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447034">switch</span>&nbsp;<span class="ident" id="5447041">c</span><span class="op" id="5447042">.</span><span class="ident" id="5447043">delim</span>&nbsp;<span class="op" id="5447049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447052">case</span>&nbsp;<span class="ident" id="5447057">delimNone</span><span class="op" id="5447066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5447070">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447121">case</span>&nbsp;<span class="ident" id="5447126">delimSpaceOrTagEnd</span><span class="op" id="5447144">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447148">s</span>&nbsp;<span class="op" id="5447150">=</span>&nbsp;<span class="builtinfunc" id="5447152">append</span><span class="op" id="5447158">(</span><span class="ident" id="5447159">s</span><span class="op" id="5447160">,</span>&nbsp;<span class="string" id="5447162">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5447192">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447195">default</span><span class="op" id="5447202">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447206">s</span>&nbsp;<span class="op" id="5447208">=</span>&nbsp;<span class="builtinfunc" id="5447210">append</span><span class="op" id="5447216">(</span><span class="ident" id="5447217">s</span><span class="op" id="5447218">,</span>&nbsp;<span class="string" id="5447220">&#34;html_template_attrescaper&#34;</span><span class="op" id="5447247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447253">e</span><span class="op" id="5447254">.</span><span class="ident" id="5447255">editActionNode</span><span class="op" id="5447269">(</span><span class="ident" id="5447270">n</span><span class="op" id="5447271">,</span>&nbsp;<span class="ident" id="5447273">s</span><span class="op" id="5447274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447277">return</span>&nbsp;<span class="ident" id="5447284">c</span><br>
<span class="lineno">205</span><span class="op" id="5447286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5447289">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="5447374">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="5447437">func</span>&nbsp;<span class="ident" id="5447442">allIdents</span><span class="op" id="5447451">(</span><span class="ident" id="5447452">node</span>&nbsp;<span class="ident" id="5447457">parse</span><span class="op" id="5447462">.</span><span class="ident" id="5447463">Node</span><span class="op" id="5447467">)</span>&nbsp;<span class="op" id="5447469">[</span><span class="op" id="5447470">]</span><span class="builtintype" id="5447471">string</span>&nbsp;<span class="op" id="5447478">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447481">switch</span>&nbsp;<span class="ident" id="5447488">node</span>&nbsp;<span class="op" id="5447493">:=</span>&nbsp;<span class="ident" id="5447496">node</span><span class="op" id="5447500">.</span><span class="op" id="5447501">(</span><span class="keyword" id="5447502">type</span><span class="op" id="5447506">)</span>&nbsp;<span class="op" id="5447508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447511">case</span>&nbsp;<span class="op" id="5447516">*</span><span class="ident" id="5447517">parse</span><span class="op" id="5447522">.</span><span class="ident" id="5447523">IdentifierNode</span><span class="op" id="5447537">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447541">return</span>&nbsp;<span class="op" id="5447548">[</span><span class="op" id="5447549">]</span><span class="builtintype" id="5447550">string</span><span class="op" id="5447556">{</span><span class="ident" id="5447557">node</span><span class="op" id="5447561">.</span><span class="ident" id="5447562">Ident</span><span class="op" id="5447567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447570">case</span>&nbsp;<span class="op" id="5447575">*</span><span class="ident" id="5447576">parse</span><span class="op" id="5447581">.</span><span class="ident" id="5447582">FieldNode</span><span class="op" id="5447591">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447595">return</span>&nbsp;<span class="ident" id="5447602">node</span><span class="op" id="5447606">.</span><span class="ident" id="5447607">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5447617">panic</span><span class="op" id="5447622">(</span><span class="string" id="5447623">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="5447660">)</span><br>
<span class="lineno"></span><span class="op" id="5447662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5447665">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="5447735">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="5447769">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="5447842">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5447919">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="5447993">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="5448023">func</span>&nbsp;<span class="ident" id="5448028">ensurePipelineContains</span><span class="op" id="5448050">(</span><span class="ident" id="5448051">p</span>&nbsp;<span class="op" id="5448053">*</span><span class="ident" id="5448054">parse</span><span class="op" id="5448059">.</span><span class="ident" id="5448060">PipeNode</span><span class="op" id="5448068">,</span>&nbsp;<span class="ident" id="5448070">s</span>&nbsp;<span class="op" id="5448072">[</span><span class="op" id="5448073">]</span><span class="builtintype" id="5448074">string</span><span class="op" id="5448080">)</span>&nbsp;<span class="op" id="5448082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448085">if</span>&nbsp;<span class="builtinfunc" id="5448088">len</span><span class="op" id="5448091">(</span><span class="ident" id="5448092">s</span><span class="op" id="5448093">)</span>&nbsp;<span class="op" id="5448095">==</span>&nbsp;<span class="num" id="5448098">0</span>&nbsp;<span class="op" id="5448100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448104">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448115">n</span>&nbsp;<span class="op" id="5448117">:=</span>&nbsp;<span class="builtinfunc" id="5448120">len</span><span class="op" id="5448123">(</span><span class="ident" id="5448124">p</span><span class="op" id="5448125">.</span><span class="ident" id="5448126">Cmds</span><span class="op" id="5448130">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5448133">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448191">idents</span>&nbsp;<span class="op" id="5448198">:=</span>&nbsp;<span class="ident" id="5448201">p</span><span class="op" id="5448202">.</span><span class="ident" id="5448203">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448209">for</span>&nbsp;<span class="ident" id="5448213">i</span>&nbsp;<span class="op" id="5448215">:=</span>&nbsp;<span class="ident" id="5448218">n</span>&nbsp;<span class="op" id="5448220">-</span>&nbsp;<span class="num" id="5448222">1</span><span class="op" id="5448223">;</span>&nbsp;<span class="ident" id="5448225">i</span>&nbsp;<span class="op" id="5448227">&gt;=</span>&nbsp;<span class="num" id="5448230">0</span><span class="op" id="5448231">;</span>&nbsp;<span class="ident" id="5448233">i</span><span class="op" id="5448234">--</span>&nbsp;<span class="op" id="5448237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448241">if</span>&nbsp;<span class="ident" id="5448244">cmd</span>&nbsp;<span class="op" id="5448248">:=</span>&nbsp;<span class="ident" id="5448251">p</span><span class="op" id="5448252">.</span><span class="ident" id="5448253">Cmds</span><span class="op" id="5448257">[</span><span class="ident" id="5448258">i</span><span class="op" id="5448259">]</span><span class="op" id="5448260">;</span>&nbsp;<span class="builtinfunc" id="5448262">len</span><span class="op" id="5448265">(</span><span class="ident" id="5448266">cmd</span><span class="op" id="5448269">.</span><span class="ident" id="5448270">Args</span><span class="op" id="5448274">)</span>&nbsp;<span class="op" id="5448276">!=</span>&nbsp;<span class="num" id="5448279">0</span>&nbsp;<span class="op" id="5448281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448286">if</span>&nbsp;<span class="ident" id="5448289">_</span><span class="op" id="5448290">,</span>&nbsp;<span class="ident" id="5448292">ok</span>&nbsp;<span class="op" id="5448295">:=</span>&nbsp;<span class="ident" id="5448298">cmd</span><span class="op" id="5448301">.</span><span class="ident" id="5448302">Args</span><span class="op" id="5448306">[</span><span class="num" id="5448307">0</span><span class="op" id="5448308">]</span><span class="op" id="5448309">.</span><span class="op" id="5448310">(</span><span class="op" id="5448311">*</span><span class="ident" id="5448312">parse</span><span class="op" id="5448317">.</span><span class="ident" id="5448318">IdentifierNode</span><span class="op" id="5448332">)</span><span class="op" id="5448333">;</span>&nbsp;<span class="ident" id="5448335">ok</span>&nbsp;<span class="op" id="5448338">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448344">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448364">idents</span>&nbsp;<span class="op" id="5448371">=</span>&nbsp;<span class="ident" id="5448373">p</span><span class="op" id="5448374">.</span><span class="ident" id="5448375">Cmds</span><span class="op" id="5448379">[</span><span class="ident" id="5448380">i</span><span class="op" id="5448381">+</span><span class="num" id="5448382">1</span><span class="op" id="5448383">:</span><span class="op" id="5448384">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448387">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448390">dups</span>&nbsp;<span class="op" id="5448395">:=</span>&nbsp;<span class="num" id="5448398">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448401">for</span>&nbsp;<span class="ident" id="5448405">_</span><span class="op" id="5448406">,</span>&nbsp;<span class="ident" id="5448408">idNode</span>&nbsp;<span class="op" id="5448415">:=</span>&nbsp;<span class="keyword" id="5448418">range</span>&nbsp;<span class="ident" id="5448424">idents</span>&nbsp;<span class="op" id="5448431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448435">for</span>&nbsp;<span class="ident" id="5448439">_</span><span class="op" id="5448440">,</span>&nbsp;<span class="ident" id="5448442">ident</span>&nbsp;<span class="op" id="5448448">:=</span>&nbsp;<span class="keyword" id="5448451">range</span>&nbsp;<span class="ident" id="5448457">allIdents</span><span class="op" id="5448466">(</span><span class="ident" id="5448467">idNode</span><span class="op" id="5448473">.</span><span class="ident" id="5448474">Args</span><span class="op" id="5448478">[</span><span class="num" id="5448479">0</span><span class="op" id="5448480">]</span><span class="op" id="5448481">)</span>&nbsp;<span class="op" id="5448483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448488">if</span>&nbsp;<span class="ident" id="5448491">escFnsEq</span><span class="op" id="5448499">(</span><span class="ident" id="5448500">s</span><span class="op" id="5448501">[</span><span class="ident" id="5448502">dups</span><span class="op" id="5448506">]</span><span class="op" id="5448507">,</span>&nbsp;<span class="ident" id="5448509">ident</span><span class="op" id="5448514">)</span>&nbsp;<span class="op" id="5448516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448522">dups</span><span class="op" id="5448526">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448533">if</span>&nbsp;<span class="ident" id="5448536">dups</span>&nbsp;<span class="op" id="5448541">==</span>&nbsp;<span class="builtinfunc" id="5448544">len</span><span class="op" id="5448547">(</span><span class="ident" id="5448548">s</span><span class="op" id="5448549">)</span>&nbsp;<span class="op" id="5448551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448558">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448578">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448584">newCmds</span>&nbsp;<span class="op" id="5448592">:=</span>&nbsp;<span class="builtinfunc" id="5448595">make</span><span class="op" id="5448599">(</span><span class="op" id="5448600">[</span><span class="op" id="5448601">]</span><span class="op" id="5448602">*</span><span class="ident" id="5448603">parse</span><span class="op" id="5448608">.</span><span class="ident" id="5448609">CommandNode</span><span class="op" id="5448620">,</span>&nbsp;<span class="ident" id="5448622">n</span><span class="op" id="5448623">-</span><span class="builtinfunc" id="5448624">len</span><span class="op" id="5448627">(</span><span class="ident" id="5448628">idents</span><span class="op" id="5448634">)</span><span class="op" id="5448635">,</span>&nbsp;<span class="ident" id="5448637">n</span><span class="op" id="5448638">+</span><span class="builtinfunc" id="5448639">len</span><span class="op" id="5448642">(</span><span class="ident" id="5448643">s</span><span class="op" id="5448644">)</span><span class="op" id="5448645">-</span><span class="ident" id="5448646">dups</span><span class="op" id="5448650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5448653">copy</span><span class="op" id="5448657">(</span><span class="ident" id="5448658">newCmds</span><span class="op" id="5448665">,</span>&nbsp;<span class="ident" id="5448667">p</span><span class="op" id="5448668">.</span><span class="ident" id="5448669">Cmds</span><span class="op" id="5448673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5448676">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448743">for</span>&nbsp;<span class="ident" id="5448747">_</span><span class="op" id="5448748">,</span>&nbsp;<span class="ident" id="5448750">idNode</span>&nbsp;<span class="op" id="5448757">:=</span>&nbsp;<span class="keyword" id="5448760">range</span>&nbsp;<span class="ident" id="5448766">idents</span>&nbsp;<span class="op" id="5448773">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448777">pos</span>&nbsp;<span class="op" id="5448781">:=</span>&nbsp;<span class="ident" id="5448784">idNode</span><span class="op" id="5448790">.</span><span class="ident" id="5448791">Args</span><span class="op" id="5448795">[</span><span class="num" id="5448796">0</span><span class="op" id="5448797">]</span><span class="op" id="5448798">.</span><span class="ident" id="5448799">Position</span><span class="op" id="5448807">(</span><span class="op" id="5448808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448812">for</span>&nbsp;<span class="ident" id="5448816">_</span><span class="op" id="5448817">,</span>&nbsp;<span class="ident" id="5448819">ident</span>&nbsp;<span class="op" id="5448825">:=</span>&nbsp;<span class="keyword" id="5448828">range</span>&nbsp;<span class="ident" id="5448834">allIdents</span><span class="op" id="5448843">(</span><span class="ident" id="5448844">idNode</span><span class="op" id="5448850">.</span><span class="ident" id="5448851">Args</span><span class="op" id="5448855">[</span><span class="num" id="5448856">0</span><span class="op" id="5448857">]</span><span class="op" id="5448858">)</span>&nbsp;<span class="op" id="5448860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448865">i</span>&nbsp;<span class="op" id="5448867">:=</span>&nbsp;<span class="ident" id="5448870">indexOfStr</span><span class="op" id="5448880">(</span><span class="ident" id="5448881">ident</span><span class="op" id="5448886">,</span>&nbsp;<span class="ident" id="5448888">s</span><span class="op" id="5448889">,</span>&nbsp;<span class="ident" id="5448891">escFnsEq</span><span class="op" id="5448899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448904">if</span>&nbsp;<span class="ident" id="5448907">i</span>&nbsp;<span class="op" id="5448909">!=</span>&nbsp;<span class="op" id="5448912">-</span><span class="num" id="5448913">1</span>&nbsp;<span class="op" id="5448915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448921">for</span>&nbsp;<span class="ident" id="5448925">_</span><span class="op" id="5448926">,</span>&nbsp;<span class="ident" id="5448928">name</span>&nbsp;<span class="op" id="5448933">:=</span>&nbsp;<span class="keyword" id="5448936">range</span>&nbsp;<span class="ident" id="5448942">s</span><span class="op" id="5448943">[</span><span class="op" id="5448944">:</span><span class="ident" id="5448945">i</span><span class="op" id="5448946">]</span>&nbsp;<span class="op" id="5448948">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448955">newCmds</span>&nbsp;<span class="op" id="5448963">=</span>&nbsp;<span class="ident" id="5448965">appendCmd</span><span class="op" id="5448974">(</span><span class="ident" id="5448975">newCmds</span><span class="op" id="5448982">,</span>&nbsp;<span class="ident" id="5448984">newIdentCmd</span><span class="op" id="5448995">(</span><span class="ident" id="5448996">name</span><span class="op" id="5449000">,</span>&nbsp;<span class="ident" id="5449002">pos</span><span class="op" id="5449005">)</span><span class="op" id="5449006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449018">s</span>&nbsp;<span class="op" id="5449020">=</span>&nbsp;<span class="ident" id="5449022">s</span><span class="op" id="5449023">[</span><span class="ident" id="5449024">i</span><span class="op" id="5449025">+</span><span class="num" id="5449026">1</span><span class="op" id="5449027">:</span><span class="op" id="5449028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449037">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449041">newCmds</span>&nbsp;<span class="op" id="5449049">=</span>&nbsp;<span class="ident" id="5449051">appendCmd</span><span class="op" id="5449060">(</span><span class="ident" id="5449061">newCmds</span><span class="op" id="5449068">,</span>&nbsp;<span class="ident" id="5449070">idNode</span><span class="op" id="5449076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5449082">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5449119">for</span>&nbsp;<span class="ident" id="5449123">_</span><span class="op" id="5449124">,</span>&nbsp;<span class="ident" id="5449126">name</span>&nbsp;<span class="op" id="5449131">:=</span>&nbsp;<span class="keyword" id="5449134">range</span>&nbsp;<span class="ident" id="5449140">s</span>&nbsp;<span class="op" id="5449142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449146">newCmds</span>&nbsp;<span class="op" id="5449154">=</span>&nbsp;<span class="ident" id="5449156">appendCmd</span><span class="op" id="5449165">(</span><span class="ident" id="5449166">newCmds</span><span class="op" id="5449173">,</span>&nbsp;<span class="ident" id="5449175">newIdentCmd</span><span class="op" id="5449186">(</span><span class="ident" id="5449187">name</span><span class="op" id="5449191">,</span>&nbsp;<span class="ident" id="5449193">p</span><span class="op" id="5449194">.</span><span class="ident" id="5449195">Position</span><span class="op" id="5449203">(</span><span class="op" id="5449204">)</span><span class="op" id="5449205">)</span><span class="op" id="5449206">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5449212">p</span><span class="op" id="5449213">.</span><span class="ident" id="5449214">Cmds</span>&nbsp;<span class="op" id="5449219">=</span>&nbsp;<span class="ident" id="5449221">newCmds</span><br>
<span class="lineno"></span><span class="op" id="5449229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5449232">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="5449312">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="5449326">var</span>&nbsp;<span class="ident" id="5449330">redundantFuncs</span>&nbsp;<span class="op" id="5449345">=</span>&nbsp;<span class="keyword" id="5449347">map</span><span class="op" id="5449350">[</span><span class="builtintype" id="5449351">string</span><span class="op" id="5449357">]</span><span class="keyword" id="5449358">map</span><span class="op" id="5449361">[</span><span class="builtintype" id="5449362">string</span><span class="op" id="5449368">]</span><span class="builtintype" id="5449369">bool</span><span class="op" id="5449373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449376">&#34;html_template_commentescaper&#34;</span><span class="op" id="5449406">:</span>&nbsp;<span class="op" id="5449408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449412">&#34;html_template_attrescaper&#34;</span><span class="op" id="5449439">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5449444">true</span><span class="op" id="5449448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449452">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5449482">:</span>&nbsp;<span class="builtintype" id="5449484">true</span><span class="op" id="5449488">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449492">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5449519">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5449524">true</span><span class="op" id="5449528">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449531">}</span><span class="op" id="5449532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449535">&#34;html_template_cssescaper&#34;</span><span class="op" id="5449561">:</span>&nbsp;<span class="op" id="5449563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449567">&#34;html_template_attrescaper&#34;</span><span class="op" id="5449594">:</span>&nbsp;<span class="builtintype" id="5449596">true</span><span class="op" id="5449600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449603">}</span><span class="op" id="5449604">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449607">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5449638">:</span>&nbsp;<span class="op" id="5449640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449644">&#34;html_template_attrescaper&#34;</span><span class="op" id="5449671">:</span>&nbsp;<span class="builtintype" id="5449673">true</span><span class="op" id="5449677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449680">}</span><span class="op" id="5449681">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449684">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5449712">:</span>&nbsp;<span class="op" id="5449714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449718">&#34;html_template_attrescaper&#34;</span><span class="op" id="5449745">:</span>&nbsp;<span class="builtintype" id="5449747">true</span><span class="op" id="5449751">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449754">}</span><span class="op" id="5449755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449758">&#34;html_template_urlescaper&#34;</span><span class="op" id="5449784">:</span>&nbsp;<span class="op" id="5449786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5449790">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5449819">:</span>&nbsp;<span class="builtintype" id="5449821">true</span><span class="op" id="5449825">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5449828">}</span><span class="op" id="5449829">,</span><br>
<span class="lineno"></span><span class="op" id="5449831">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="5449834">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="5449908">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5449957">func</span>&nbsp;<span class="ident" id="5449962">appendCmd</span><span class="op" id="5449971">(</span><span class="ident" id="5449972">cmds</span>&nbsp;<span class="op" id="5449977">[</span><span class="op" id="5449978">]</span><span class="op" id="5449979">*</span><span class="ident" id="5449980">parse</span><span class="op" id="5449985">.</span><span class="ident" id="5449986">CommandNode</span><span class="op" id="5449997">,</span>&nbsp;<span class="ident" id="5449999">cmd</span>&nbsp;<span class="op" id="5450003">*</span><span class="ident" id="5450004">parse</span><span class="op" id="5450009">.</span><span class="ident" id="5450010">CommandNode</span><span class="op" id="5450021">)</span>&nbsp;<span class="op" id="5450023">[</span><span class="op" id="5450024">]</span><span class="op" id="5450025">*</span><span class="ident" id="5450026">parse</span><span class="op" id="5450031">.</span><span class="ident" id="5450032">CommandNode</span>&nbsp;<span class="op" id="5450044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450047">if</span>&nbsp;<span class="ident" id="5450050">n</span>&nbsp;<span class="op" id="5450052">:=</span>&nbsp;<span class="builtinfunc" id="5450055">len</span><span class="op" id="5450058">(</span><span class="ident" id="5450059">cmds</span><span class="op" id="5450063">)</span><span class="op" id="5450064">;</span>&nbsp;<span class="ident" id="5450066">n</span>&nbsp;<span class="op" id="5450068">!=</span>&nbsp;<span class="num" id="5450071">0</span>&nbsp;<span class="op" id="5450073">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450077">last</span><span class="op" id="5450081">,</span>&nbsp;<span class="ident" id="5450083">ok</span>&nbsp;<span class="op" id="5450086">:=</span>&nbsp;<span class="ident" id="5450089">cmds</span><span class="op" id="5450093">[</span><span class="ident" id="5450094">n</span><span class="op" id="5450095">-</span><span class="num" id="5450096">1</span><span class="op" id="5450097">]</span><span class="op" id="5450098">.</span><span class="ident" id="5450099">Args</span><span class="op" id="5450103">[</span><span class="num" id="5450104">0</span><span class="op" id="5450105">]</span><span class="op" id="5450106">.</span><span class="op" id="5450107">(</span><span class="op" id="5450108">*</span><span class="ident" id="5450109">parse</span><span class="op" id="5450114">.</span><span class="ident" id="5450115">IdentifierNode</span><span class="op" id="5450129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450133">next</span><span class="op" id="5450137">,</span>&nbsp;<span class="ident" id="5450139">_</span>&nbsp;<span class="op" id="5450141">:=</span>&nbsp;<span class="ident" id="5450144">cmd</span><span class="op" id="5450147">.</span><span class="ident" id="5450148">Args</span><span class="op" id="5450152">[</span><span class="num" id="5450153">0</span><span class="op" id="5450154">]</span><span class="op" id="5450155">.</span><span class="op" id="5450156">(</span><span class="op" id="5450157">*</span><span class="ident" id="5450158">parse</span><span class="op" id="5450163">.</span><span class="ident" id="5450164">IdentifierNode</span><span class="op" id="5450178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450182">if</span>&nbsp;<span class="ident" id="5450185">ok</span>&nbsp;<span class="op" id="5450188">&amp;&amp;</span>&nbsp;<span class="ident" id="5450191">redundantFuncs</span><span class="op" id="5450205">[</span><span class="ident" id="5450206">last</span><span class="op" id="5450210">.</span><span class="ident" id="5450211">Ident</span><span class="op" id="5450216">]</span><span class="op" id="5450217">[</span><span class="ident" id="5450218">next</span><span class="op" id="5450222">.</span><span class="ident" id="5450223">Ident</span><span class="op" id="5450228">]</span>&nbsp;<span class="op" id="5450230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450235">return</span>&nbsp;<span class="ident" id="5450242">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5450249">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5450252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450255">return</span>&nbsp;<span class="builtinfunc" id="5450262">append</span><span class="op" id="5450268">(</span><span class="ident" id="5450269">cmds</span><span class="op" id="5450273">,</span>&nbsp;<span class="ident" id="5450275">cmd</span><span class="op" id="5450278">)</span><br>
<span class="lineno"></span><span class="op" id="5450280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5450283">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="5450363">func</span>&nbsp;<span class="ident" id="5450368">indexOfStr</span><span class="op" id="5450378">(</span><span class="ident" id="5450379">s</span>&nbsp;<span class="builtintype" id="5450381">string</span><span class="op" id="5450387">,</span>&nbsp;<span class="ident" id="5450389">strs</span>&nbsp;<span class="op" id="5450394">[</span><span class="op" id="5450395">]</span><span class="builtintype" id="5450396">string</span><span class="op" id="5450402">,</span>&nbsp;<span class="ident" id="5450404">eq</span>&nbsp;<span class="keyword" id="5450407">func</span><span class="op" id="5450411">(</span><span class="ident" id="5450412">a</span><span class="op" id="5450413">,</span>&nbsp;<span class="ident" id="5450415">b</span>&nbsp;<span class="builtintype" id="5450417">string</span><span class="op" id="5450423">)</span>&nbsp;<span class="builtintype" id="5450425">bool</span><span class="op" id="5450429">)</span>&nbsp;<span class="builtintype" id="5450431">int</span>&nbsp;<span class="op" id="5450435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450438">for</span>&nbsp;<span class="ident" id="5450442">i</span><span class="op" id="5450443">,</span>&nbsp;<span class="ident" id="5450445">t</span>&nbsp;<span class="op" id="5450447">:=</span>&nbsp;<span class="keyword" id="5450450">range</span>&nbsp;<span class="ident" id="5450456">strs</span>&nbsp;<span class="op" id="5450461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450465">if</span>&nbsp;<span class="ident" id="5450468">eq</span><span class="op" id="5450470">(</span><span class="ident" id="5450471">s</span><span class="op" id="5450472">,</span>&nbsp;<span class="ident" id="5450474">t</span><span class="op" id="5450475">)</span>&nbsp;<span class="op" id="5450477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450482">return</span>&nbsp;<span class="ident" id="5450489">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5450493">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5450496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450499">return</span>&nbsp;<span class="op" id="5450506">-</span><span class="num" id="5450507">1</span><br>
<span class="lineno"></span><span class="op" id="5450509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5450512">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="5450583">func</span>&nbsp;<span class="ident" id="5450588">escFnsEq</span><span class="op" id="5450596">(</span><span class="ident" id="5450597">a</span><span class="op" id="5450598">,</span>&nbsp;<span class="ident" id="5450600">b</span>&nbsp;<span class="builtintype" id="5450602">string</span><span class="op" id="5450608">)</span>&nbsp;<span class="builtintype" id="5450610">bool</span>&nbsp;<span class="op" id="5450615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450618">if</span>&nbsp;<span class="ident" id="5450621">e</span>&nbsp;<span class="op" id="5450623">:=</span>&nbsp;<span class="ident" id="5450626">equivEscapers</span><span class="op" id="5450639">[</span><span class="ident" id="5450640">a</span><span class="op" id="5450641">]</span><span class="op" id="5450642">;</span>&nbsp;<span class="ident" id="5450644">e</span>&nbsp;<span class="op" id="5450646">!=</span>&nbsp;<span class="string" id="5450649">&#34;&#34;</span>&nbsp;<span class="op" id="5450652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450656">a</span>&nbsp;<span class="op" id="5450658">=</span>&nbsp;<span class="ident" id="5450660">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5450663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450666">if</span>&nbsp;<span class="ident" id="5450669">e</span>&nbsp;<span class="op" id="5450671">:=</span>&nbsp;<span class="ident" id="5450674">equivEscapers</span><span class="op" id="5450687">[</span><span class="ident" id="5450688">b</span><span class="op" id="5450689">]</span><span class="op" id="5450690">;</span>&nbsp;<span class="ident" id="5450692">e</span>&nbsp;<span class="op" id="5450694">!=</span>&nbsp;<span class="string" id="5450697">&#34;&#34;</span>&nbsp;<span class="op" id="5450700">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450704">b</span>&nbsp;<span class="op" id="5450706">=</span>&nbsp;<span class="ident" id="5450708">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5450711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450714">return</span>&nbsp;<span class="ident" id="5450721">a</span>&nbsp;<span class="op" id="5450723">==</span>&nbsp;<span class="ident" id="5450726">b</span><br>
<span class="lineno"></span><span class="op" id="5450728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="5450731">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5450802">func</span>&nbsp;<span class="ident" id="5450807">newIdentCmd</span><span class="op" id="5450818">(</span><span class="ident" id="5450819">identifier</span>&nbsp;<span class="builtintype" id="5450830">string</span><span class="op" id="5450836">,</span>&nbsp;<span class="ident" id="5450838">pos</span>&nbsp;<span class="ident" id="5450842">parse</span><span class="op" id="5450847">.</span><span class="ident" id="5450848">Pos</span><span class="op" id="5450851">)</span>&nbsp;<span class="op" id="5450853">*</span><span class="ident" id="5450854">parse</span><span class="op" id="5450859">.</span><span class="ident" id="5450860">CommandNode</span>&nbsp;<span class="op" id="5450872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5450875">return</span>&nbsp;<span class="op" id="5450882">&amp;</span><span class="ident" id="5450883">parse</span><span class="op" id="5450888">.</span><span class="ident" id="5450889">CommandNode</span><span class="op" id="5450900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450904">NodeType</span><span class="op" id="5450912">:</span>&nbsp;<span class="ident" id="5450914">parse</span><span class="op" id="5450919">.</span><span class="ident" id="5450920">NodeCommand</span><span class="op" id="5450931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5450935">Args</span><span class="op" id="5450939">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5450945">[</span><span class="op" id="5450946">]</span><span class="ident" id="5450947">parse</span><span class="op" id="5450952">.</span><span class="ident" id="5450953">Node</span><span class="op" id="5450957">{</span><span class="ident" id="5450958">parse</span><span class="op" id="5450963">.</span><span class="ident" id="5450964">NewIdentifier</span><span class="op" id="5450977">(</span><span class="ident" id="5450978">identifier</span><span class="op" id="5450988">)</span><span class="op" id="5450989">.</span><span class="ident" id="5450990">SetTree</span><span class="op" id="5450997">(</span><span class="ident" id="5450998">nil</span><span class="op" id="5451001">)</span><span class="op" id="5451002">.</span><span class="ident" id="5451003">SetPos</span><span class="op" id="5451009">(</span><span class="ident" id="5451010">pos</span><span class="op" id="5451013">)</span><span class="op" id="5451014">}</span><span class="op" id="5451015">,</span>&nbsp;<span class="comment" id="5451017">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5451036">}</span><br>
<span class="lineno"></span><span class="op" id="5451038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5451041">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5451116">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="5451155">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="5451180">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="5451198">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="5451277">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="5451296">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="5451355">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="5451418">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5451496">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5451528">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5451594">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="5451659">func</span>&nbsp;<span class="ident" id="5451664">nudge</span><span class="op" id="5451669">(</span><span class="ident" id="5451670">c</span>&nbsp;<span class="ident" id="5451672">context</span><span class="op" id="5451679">)</span>&nbsp;<span class="ident" id="5451681">context</span>&nbsp;<span class="op" id="5451689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451692">switch</span>&nbsp;<span class="ident" id="5451699">c</span><span class="op" id="5451700">.</span><span class="ident" id="5451701">state</span>&nbsp;<span class="op" id="5451707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451710">case</span>&nbsp;<span class="ident" id="5451715">stateTag</span><span class="op" id="5451723">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5451727">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451786">c</span><span class="op" id="5451787">.</span><span class="ident" id="5451788">state</span>&nbsp;<span class="op" id="5451794">=</span>&nbsp;<span class="ident" id="5451796">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451811">case</span>&nbsp;<span class="ident" id="5451816">stateBeforeValue</span><span class="op" id="5451832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5451836">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5451898">c</span><span class="op" id="5451899">.</span><span class="ident" id="5451900">state</span><span class="op" id="5451905">,</span>&nbsp;<span class="ident" id="5451907">c</span><span class="op" id="5451908">.</span><span class="ident" id="5451909">delim</span><span class="op" id="5451914">,</span>&nbsp;<span class="ident" id="5451916">c</span><span class="op" id="5451917">.</span><span class="ident" id="5451918">attr</span>&nbsp;<span class="op" id="5451923">=</span>&nbsp;<span class="ident" id="5451925">attrStartStates</span><span class="op" id="5451940">[</span><span class="ident" id="5451941">c</span><span class="op" id="5451942">.</span><span class="ident" id="5451943">attr</span><span class="op" id="5451947">]</span><span class="op" id="5451948">,</span>&nbsp;<span class="ident" id="5451950">delimSpaceOrTagEnd</span><span class="op" id="5451968">,</span>&nbsp;<span class="ident" id="5451970">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5451980">case</span>&nbsp;<span class="ident" id="5451985">stateAfterName</span><span class="op" id="5451999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452003">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452062">c</span><span class="op" id="5452063">.</span><span class="ident" id="5452064">state</span><span class="op" id="5452069">,</span>&nbsp;<span class="ident" id="5452071">c</span><span class="op" id="5452072">.</span><span class="ident" id="5452073">attr</span>&nbsp;<span class="op" id="5452078">=</span>&nbsp;<span class="ident" id="5452080">stateAttrName</span><span class="op" id="5452093">,</span>&nbsp;<span class="ident" id="5452095">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452108">return</span>&nbsp;<span class="ident" id="5452115">c</span><br>
<span class="lineno"></span><span class="op" id="5452117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="5452120">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5452195">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5452274">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="5452304">func</span>&nbsp;<span class="ident" id="5452309">join</span><span class="op" id="5452313">(</span><span class="ident" id="5452314">a</span><span class="op" id="5452315">,</span>&nbsp;<span class="ident" id="5452317">b</span>&nbsp;<span class="ident" id="5452319">context</span><span class="op" id="5452326">,</span>&nbsp;<span class="ident" id="5452328">node</span>&nbsp;<span class="ident" id="5452333">parse</span><span class="op" id="5452338">.</span><span class="ident" id="5452339">Node</span><span class="op" id="5452343">,</span>&nbsp;<span class="ident" id="5452345">nodeName</span>&nbsp;<span class="builtintype" id="5452354">string</span><span class="op" id="5452360">)</span>&nbsp;<span class="ident" id="5452362">context</span>&nbsp;<span class="op" id="5452370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452373">if</span>&nbsp;<span class="ident" id="5452376">a</span><span class="op" id="5452377">.</span><span class="ident" id="5452378">state</span>&nbsp;<span class="op" id="5452384">==</span>&nbsp;<span class="ident" id="5452387">stateError</span>&nbsp;<span class="op" id="5452398">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452402">return</span>&nbsp;<span class="ident" id="5452409">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452415">if</span>&nbsp;<span class="ident" id="5452418">b</span><span class="op" id="5452419">.</span><span class="ident" id="5452420">state</span>&nbsp;<span class="op" id="5452426">==</span>&nbsp;<span class="ident" id="5452429">stateError</span>&nbsp;<span class="op" id="5452440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452444">return</span>&nbsp;<span class="ident" id="5452451">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452454">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452457">if</span>&nbsp;<span class="ident" id="5452460">a</span><span class="op" id="5452461">.</span><span class="ident" id="5452462">eq</span><span class="op" id="5452464">(</span><span class="ident" id="5452465">b</span><span class="op" id="5452466">)</span>&nbsp;<span class="op" id="5452468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452472">return</span>&nbsp;<span class="ident" id="5452479">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452486">c</span>&nbsp;<span class="op" id="5452488">:=</span>&nbsp;<span class="ident" id="5452491">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452494">c</span><span class="op" id="5452495">.</span><span class="ident" id="5452496">urlPart</span>&nbsp;<span class="op" id="5452504">=</span>&nbsp;<span class="ident" id="5452506">b</span><span class="op" id="5452507">.</span><span class="ident" id="5452508">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452517">if</span>&nbsp;<span class="ident" id="5452520">c</span><span class="op" id="5452521">.</span><span class="ident" id="5452522">eq</span><span class="op" id="5452524">(</span><span class="ident" id="5452525">b</span><span class="op" id="5452526">)</span>&nbsp;<span class="op" id="5452528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452532">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452574">c</span><span class="op" id="5452575">.</span><span class="ident" id="5452576">urlPart</span>&nbsp;<span class="op" id="5452584">=</span>&nbsp;<span class="ident" id="5452586">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452603">return</span>&nbsp;<span class="ident" id="5452610">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452617">c</span>&nbsp;<span class="op" id="5452619">=</span>&nbsp;<span class="ident" id="5452621">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452624">c</span><span class="op" id="5452625">.</span><span class="ident" id="5452626">jsCtx</span>&nbsp;<span class="op" id="5452632">=</span>&nbsp;<span class="ident" id="5452634">b</span><span class="op" id="5452635">.</span><span class="ident" id="5452636">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452643">if</span>&nbsp;<span class="ident" id="5452646">c</span><span class="op" id="5452647">.</span><span class="ident" id="5452648">eq</span><span class="op" id="5452650">(</span><span class="ident" id="5452651">b</span><span class="op" id="5452652">)</span>&nbsp;<span class="op" id="5452654">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452658">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5452698">c</span><span class="op" id="5452699">.</span><span class="ident" id="5452700">jsCtx</span>&nbsp;<span class="op" id="5452706">=</span>&nbsp;<span class="ident" id="5452708">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452723">return</span>&nbsp;<span class="ident" id="5452730">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5452733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452737">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452794">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452814">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452851">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5452915">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5452945">if</span>&nbsp;<span class="ident" id="5452948">c</span><span class="op" id="5452949">,</span>&nbsp;<span class="ident" id="5452951">d</span>&nbsp;<span class="op" id="5452953">:=</span>&nbsp;<span class="ident" id="5452956">nudge</span><span class="op" id="5452961">(</span><span class="ident" id="5452962">a</span><span class="op" id="5452963">)</span><span class="op" id="5452964">,</span>&nbsp;<span class="ident" id="5452966">nudge</span><span class="op" id="5452971">(</span><span class="ident" id="5452972">b</span><span class="op" id="5452973">)</span><span class="op" id="5452974">;</span>&nbsp;<span class="op" id="5452976">!</span><span class="op" id="5452977">(</span><span class="ident" id="5452978">c</span><span class="op" id="5452979">.</span><span class="ident" id="5452980">eq</span><span class="op" id="5452982">(</span><span class="ident" id="5452983">a</span><span class="op" id="5452984">)</span>&nbsp;<span class="op" id="5452986">&amp;&amp;</span>&nbsp;<span class="ident" id="5452989">d</span><span class="op" id="5452990">.</span><span class="ident" id="5452991">eq</span><span class="op" id="5452993">(</span><span class="ident" id="5452994">b</span><span class="op" id="5452995">)</span><span class="op" id="5452996">)</span>&nbsp;<span class="op" id="5452998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453002">if</span>&nbsp;<span class="ident" id="5453005">e</span>&nbsp;<span class="op" id="5453007">:=</span>&nbsp;<span class="ident" id="5453010">join</span><span class="op" id="5453014">(</span><span class="ident" id="5453015">c</span><span class="op" id="5453016">,</span>&nbsp;<span class="ident" id="5453018">d</span><span class="op" id="5453019">,</span>&nbsp;<span class="ident" id="5453021">node</span><span class="op" id="5453025">,</span>&nbsp;<span class="ident" id="5453027">nodeName</span><span class="op" id="5453035">)</span><span class="op" id="5453036">;</span>&nbsp;<span class="ident" id="5453038">e</span><span class="op" id="5453039">.</span><span class="ident" id="5453040">state</span>&nbsp;<span class="op" id="5453046">!=</span>&nbsp;<span class="ident" id="5453049">stateError</span>&nbsp;<span class="op" id="5453060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453065">return</span>&nbsp;<span class="ident" id="5453072">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453079">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453083">return</span>&nbsp;<span class="ident" id="5453090">context</span><span class="op" id="5453097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453101">state</span><span class="op" id="5453106">:</span>&nbsp;<span class="ident" id="5453108">stateError</span><span class="op" id="5453118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453122">err</span><span class="op" id="5453125">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5453129">errorf</span><span class="op" id="5453135">(</span><span class="ident" id="5453136">ErrBranchEnd</span><span class="op" id="5453148">,</span>&nbsp;<span class="ident" id="5453150">node</span><span class="op" id="5453154">,</span>&nbsp;<span class="num" id="5453156">0</span><span class="op" id="5453157">,</span>&nbsp;<span class="string" id="5453159">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="5453210">,</span>&nbsp;<span class="ident" id="5453212">nodeName</span><span class="op" id="5453220">,</span>&nbsp;<span class="ident" id="5453222">a</span><span class="op" id="5453223">,</span>&nbsp;<span class="ident" id="5453225">b</span><span class="op" id="5453226">)</span><span class="op" id="5453227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5453230">}</span><br>
<span class="lineno">410</span><span class="op" id="5453232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5453235">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5453309">func</span>&nbsp;<span class="op" id="5453314">(</span><span class="ident" id="5453315">e</span>&nbsp;<span class="op" id="5453317">*</span><span class="ident" id="5453318">escaper</span><span class="op" id="5453325">)</span>&nbsp;<span class="ident" id="5453327">escapeBranch</span><span class="op" id="5453339">(</span><span class="ident" id="5453340">c</span>&nbsp;<span class="ident" id="5453342">context</span><span class="op" id="5453349">,</span>&nbsp;<span class="ident" id="5453351">n</span>&nbsp;<span class="op" id="5453353">*</span><span class="ident" id="5453354">parse</span><span class="op" id="5453359">.</span><span class="ident" id="5453360">BranchNode</span><span class="op" id="5453370">,</span>&nbsp;<span class="ident" id="5453372">nodeName</span>&nbsp;<span class="builtintype" id="5453381">string</span><span class="op" id="5453387">)</span>&nbsp;<span class="ident" id="5453389">context</span>&nbsp;<span class="op" id="5453397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453400">c0</span>&nbsp;<span class="op" id="5453403">:=</span>&nbsp;<span class="ident" id="5453406">e</span><span class="op" id="5453407">.</span><span class="ident" id="5453408">escapeList</span><span class="op" id="5453418">(</span><span class="ident" id="5453419">c</span><span class="op" id="5453420">,</span>&nbsp;<span class="ident" id="5453422">n</span><span class="op" id="5453423">.</span><span class="ident" id="5453424">List</span><span class="op" id="5453428">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453431">if</span>&nbsp;<span class="ident" id="5453434">nodeName</span>&nbsp;<span class="op" id="5453443">==</span>&nbsp;<span class="string" id="5453446">&#34;range&#34;</span>&nbsp;<span class="op" id="5453454">&amp;&amp;</span>&nbsp;<span class="ident" id="5453457">c0</span><span class="op" id="5453459">.</span><span class="ident" id="5453460">state</span>&nbsp;<span class="op" id="5453466">!=</span>&nbsp;<span class="ident" id="5453469">stateError</span>&nbsp;<span class="op" id="5453480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453484">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453553">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453622">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453654">c1</span><span class="op" id="5453656">,</span>&nbsp;<span class="ident" id="5453658">_</span>&nbsp;<span class="op" id="5453660">:=</span>&nbsp;<span class="ident" id="5453663">e</span><span class="op" id="5453664">.</span><span class="ident" id="5453665">escapeListConditionally</span><span class="op" id="5453688">(</span><span class="ident" id="5453689">c0</span><span class="op" id="5453691">,</span>&nbsp;<span class="ident" id="5453693">n</span><span class="op" id="5453694">.</span><span class="ident" id="5453695">List</span><span class="op" id="5453699">,</span>&nbsp;<span class="ident" id="5453701">nil</span><span class="op" id="5453704">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453708">c0</span>&nbsp;<span class="op" id="5453711">=</span>&nbsp;<span class="ident" id="5453713">join</span><span class="op" id="5453717">(</span><span class="ident" id="5453718">c0</span><span class="op" id="5453720">,</span>&nbsp;<span class="ident" id="5453722">c1</span><span class="op" id="5453724">,</span>&nbsp;<span class="ident" id="5453726">n</span><span class="op" id="5453727">,</span>&nbsp;<span class="ident" id="5453729">nodeName</span><span class="op" id="5453737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5453741">if</span>&nbsp;<span class="ident" id="5453744">c0</span><span class="op" id="5453746">.</span><span class="ident" id="5453747">state</span>&nbsp;<span class="op" id="5453753">==</span>&nbsp;<span class="ident" id="5453756">stateError</span>&nbsp;<span class="op" id="5453767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453772">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453829">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5453886">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453913">c0</span><span class="op" id="5453915">.</span><span class="ident" id="5453916">err</span><span class="op" id="5453919">.</span><span class="ident" id="5453920">Line</span>&nbsp;<span class="op" id="5453925">=</span>&nbsp;<span class="ident" id="5453927">n</span><span class="op" id="5453928">.</span><span class="ident" id="5453929">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5453937">c0</span><span class="op" id="5453939">.</span><span class="ident" id="5453940">err</span><span class="op" id="5453943">.</span><span class="ident" id="5453944">Description</span>&nbsp;<span class="op" id="5453956">=</span>&nbsp;<span class="string" id="5453958">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="5453985">+</span>&nbsp;<span class="ident" id="5453987">c0</span><span class="op" id="5453989">.</span><span class="ident" id="5453990">err</span><span class="op" id="5453993">.</span><span class="ident" id="5453994">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454009">return</span>&nbsp;<span class="ident" id="5454016">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454024">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454027">c1</span>&nbsp;<span class="op" id="5454030">:=</span>&nbsp;<span class="ident" id="5454033">e</span><span class="op" id="5454034">.</span><span class="ident" id="5454035">escapeList</span><span class="op" id="5454045">(</span><span class="ident" id="5454046">c</span><span class="op" id="5454047">,</span>&nbsp;<span class="ident" id="5454049">n</span><span class="op" id="5454050">.</span><span class="ident" id="5454051">ElseList</span><span class="op" id="5454059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454062">return</span>&nbsp;<span class="ident" id="5454069">join</span><span class="op" id="5454073">(</span><span class="ident" id="5454074">c0</span><span class="op" id="5454076">,</span>&nbsp;<span class="ident" id="5454078">c1</span><span class="op" id="5454080">,</span>&nbsp;<span class="ident" id="5454082">n</span><span class="op" id="5454083">,</span>&nbsp;<span class="ident" id="5454085">nodeName</span><span class="op" id="5454093">)</span><br>
<span class="lineno"></span><span class="op" id="5454095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5454098">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="5454142">func</span>&nbsp;<span class="op" id="5454147">(</span><span class="ident" id="5454148">e</span>&nbsp;<span class="op" id="5454150">*</span><span class="ident" id="5454151">escaper</span><span class="op" id="5454158">)</span>&nbsp;<span class="ident" id="5454160">escapeList</span><span class="op" id="5454170">(</span><span class="ident" id="5454171">c</span>&nbsp;<span class="ident" id="5454173">context</span><span class="op" id="5454180">,</span>&nbsp;<span class="ident" id="5454182">n</span>&nbsp;<span class="op" id="5454184">*</span><span class="ident" id="5454185">parse</span><span class="op" id="5454190">.</span><span class="ident" id="5454191">ListNode</span><span class="op" id="5454199">)</span>&nbsp;<span class="ident" id="5454201">context</span>&nbsp;<span class="op" id="5454209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454212">if</span>&nbsp;<span class="ident" id="5454215">n</span>&nbsp;<span class="op" id="5454217">==</span>&nbsp;<span class="ident" id="5454220">nil</span>&nbsp;<span class="op" id="5454224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454228">return</span>&nbsp;<span class="ident" id="5454235">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454241">for</span>&nbsp;<span class="ident" id="5454245">_</span><span class="op" id="5454246">,</span>&nbsp;<span class="ident" id="5454248">m</span>&nbsp;<span class="op" id="5454250">:=</span>&nbsp;<span class="keyword" id="5454253">range</span>&nbsp;<span class="ident" id="5454259">n</span><span class="op" id="5454260">.</span><span class="ident" id="5454261">Nodes</span>&nbsp;<span class="op" id="5454267">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454271">c</span>&nbsp;<span class="op" id="5454273">=</span>&nbsp;<span class="ident" id="5454275">e</span><span class="op" id="5454276">.</span><span class="ident" id="5454277">escape</span><span class="op" id="5454283">(</span><span class="ident" id="5454284">c</span><span class="op" id="5454285">,</span>&nbsp;<span class="ident" id="5454287">m</span><span class="op" id="5454288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454294">return</span>&nbsp;<span class="ident" id="5454301">c</span><br>
<span class="lineno"></span><span class="op" id="5454303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="5454306">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5454382">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="5454454">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="5454534">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5454581">func</span>&nbsp;<span class="op" id="5454586">(</span><span class="ident" id="5454587">e</span>&nbsp;<span class="op" id="5454589">*</span><span class="ident" id="5454590">escaper</span><span class="op" id="5454597">)</span>&nbsp;<span class="ident" id="5454599">escapeListConditionally</span><span class="op" id="5454622">(</span><span class="ident" id="5454623">c</span>&nbsp;<span class="ident" id="5454625">context</span><span class="op" id="5454632">,</span>&nbsp;<span class="ident" id="5454634">n</span>&nbsp;<span class="op" id="5454636">*</span><span class="ident" id="5454637">parse</span><span class="op" id="5454642">.</span><span class="ident" id="5454643">ListNode</span><span class="op" id="5454651">,</span>&nbsp;<span class="ident" id="5454653">filter</span>&nbsp;<span class="keyword" id="5454660">func</span><span class="op" id="5454664">(</span><span class="op" id="5454665">*</span><span class="ident" id="5454666">escaper</span><span class="op" id="5454673">,</span>&nbsp;<span class="ident" id="5454675">context</span><span class="op" id="5454682">)</span>&nbsp;<span class="builtintype" id="5454684">bool</span><span class="op" id="5454688">)</span>&nbsp;<span class="op" id="5454690">(</span><span class="ident" id="5454691">context</span><span class="op" id="5454698">,</span>&nbsp;<span class="builtintype" id="5454700">bool</span><span class="op" id="5454704">)</span>&nbsp;<span class="op" id="5454706">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454709">e1</span>&nbsp;<span class="op" id="5454712">:=</span>&nbsp;<span class="ident" id="5454715">newEscaper</span><span class="op" id="5454725">(</span><span class="ident" id="5454726">e</span><span class="op" id="5454727">.</span><span class="ident" id="5454728">tmpl</span><span class="op" id="5454732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5454735">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454776">for</span>&nbsp;<span class="ident" id="5454780">k</span><span class="op" id="5454781">,</span>&nbsp;<span class="ident" id="5454783">v</span>&nbsp;<span class="op" id="5454785">:=</span>&nbsp;<span class="keyword" id="5454788">range</span>&nbsp;<span class="ident" id="5454794">e</span><span class="op" id="5454795">.</span><span class="ident" id="5454796">output</span>&nbsp;<span class="op" id="5454803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454807">e1</span><span class="op" id="5454809">.</span><span class="ident" id="5454810">output</span><span class="op" id="5454816">[</span><span class="ident" id="5454817">k</span><span class="op" id="5454818">]</span>&nbsp;<span class="op" id="5454820">=</span>&nbsp;<span class="ident" id="5454822">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5454825">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454828">c</span>&nbsp;<span class="op" id="5454830">=</span>&nbsp;<span class="ident" id="5454832">e1</span><span class="op" id="5454834">.</span><span class="ident" id="5454835">escapeList</span><span class="op" id="5454845">(</span><span class="ident" id="5454846">c</span><span class="op" id="5454847">,</span>&nbsp;<span class="ident" id="5454849">n</span><span class="op" id="5454850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454853">ok</span>&nbsp;<span class="op" id="5454856">:=</span>&nbsp;<span class="ident" id="5454859">filter</span>&nbsp;<span class="op" id="5454866">!=</span>&nbsp;<span class="ident" id="5454869">nil</span>&nbsp;<span class="op" id="5454873">&amp;&amp;</span>&nbsp;<span class="ident" id="5454876">filter</span><span class="op" id="5454882">(</span><span class="ident" id="5454883">e1</span><span class="op" id="5454885">,</span>&nbsp;<span class="ident" id="5454887">c</span><span class="op" id="5454888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454891">if</span>&nbsp;<span class="ident" id="5454894">ok</span>&nbsp;<span class="op" id="5454897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5454901">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5454953">for</span>&nbsp;<span class="ident" id="5454957">k</span><span class="op" id="5454958">,</span>&nbsp;<span class="ident" id="5454960">v</span>&nbsp;<span class="op" id="5454962">:=</span>&nbsp;<span class="keyword" id="5454965">range</span>&nbsp;<span class="ident" id="5454971">e1</span><span class="op" id="5454973">.</span><span class="ident" id="5454974">output</span>&nbsp;<span class="op" id="5454981">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5454986">e</span><span class="op" id="5454987">.</span><span class="ident" id="5454988">output</span><span class="op" id="5454994">[</span><span class="ident" id="5454995">k</span><span class="op" id="5454996">]</span>&nbsp;<span class="op" id="5454998">=</span>&nbsp;<span class="ident" id="5455000">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455008">for</span>&nbsp;<span class="ident" id="5455012">k</span><span class="op" id="5455013">,</span>&nbsp;<span class="ident" id="5455015">v</span>&nbsp;<span class="op" id="5455017">:=</span>&nbsp;<span class="keyword" id="5455020">range</span>&nbsp;<span class="ident" id="5455026">e1</span><span class="op" id="5455028">.</span><span class="ident" id="5455029">derived</span>&nbsp;<span class="op" id="5455037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455042">e</span><span class="op" id="5455043">.</span><span class="ident" id="5455044">derived</span><span class="op" id="5455051">[</span><span class="ident" id="5455052">k</span><span class="op" id="5455053">]</span>&nbsp;<span class="op" id="5455055">=</span>&nbsp;<span class="ident" id="5455057">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455061">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455065">for</span>&nbsp;<span class="ident" id="5455069">k</span><span class="op" id="5455070">,</span>&nbsp;<span class="ident" id="5455072">v</span>&nbsp;<span class="op" id="5455074">:=</span>&nbsp;<span class="keyword" id="5455077">range</span>&nbsp;<span class="ident" id="5455083">e1</span><span class="op" id="5455085">.</span><span class="ident" id="5455086">called</span>&nbsp;<span class="op" id="5455093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455098">e</span><span class="op" id="5455099">.</span><span class="ident" id="5455100">called</span><span class="op" id="5455106">[</span><span class="ident" id="5455107">k</span><span class="op" id="5455108">]</span>&nbsp;<span class="op" id="5455110">=</span>&nbsp;<span class="ident" id="5455112">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455120">for</span>&nbsp;<span class="ident" id="5455124">k</span><span class="op" id="5455125">,</span>&nbsp;<span class="ident" id="5455127">v</span>&nbsp;<span class="op" id="5455129">:=</span>&nbsp;<span class="keyword" id="5455132">range</span>&nbsp;<span class="ident" id="5455138">e1</span><span class="op" id="5455140">.</span><span class="ident" id="5455141">actionNodeEdits</span>&nbsp;<span class="op" id="5455157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455162">e</span><span class="op" id="5455163">.</span><span class="ident" id="5455164">editActionNode</span><span class="op" id="5455178">(</span><span class="ident" id="5455179">k</span><span class="op" id="5455180">,</span>&nbsp;<span class="ident" id="5455182">v</span><span class="op" id="5455183">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455191">for</span>&nbsp;<span class="ident" id="5455195">k</span><span class="op" id="5455196">,</span>&nbsp;<span class="ident" id="5455198">v</span>&nbsp;<span class="op" id="5455200">:=</span>&nbsp;<span class="keyword" id="5455203">range</span>&nbsp;<span class="ident" id="5455209">e1</span><span class="op" id="5455211">.</span><span class="ident" id="5455212">templateNodeEdits</span>&nbsp;<span class="op" id="5455230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455235">e</span><span class="op" id="5455236">.</span><span class="ident" id="5455237">editTemplateNode</span><span class="op" id="5455253">(</span><span class="ident" id="5455254">k</span><span class="op" id="5455255">,</span>&nbsp;<span class="ident" id="5455257">v</span><span class="op" id="5455258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455266">for</span>&nbsp;<span class="ident" id="5455270">k</span><span class="op" id="5455271">,</span>&nbsp;<span class="ident" id="5455273">v</span>&nbsp;<span class="op" id="5455275">:=</span>&nbsp;<span class="keyword" id="5455278">range</span>&nbsp;<span class="ident" id="5455284">e1</span><span class="op" id="5455286">.</span><span class="ident" id="5455287">textNodeEdits</span>&nbsp;<span class="op" id="5455301">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455306">e</span><span class="op" id="5455307">.</span><span class="ident" id="5455308">editTextNode</span><span class="op" id="5455320">(</span><span class="ident" id="5455321">k</span><span class="op" id="5455322">,</span>&nbsp;<span class="ident" id="5455324">v</span><span class="op" id="5455325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455335">return</span>&nbsp;<span class="ident" id="5455342">c</span><span class="op" id="5455343">,</span>&nbsp;<span class="ident" id="5455345">ok</span><br>
<span class="lineno"></span><span class="op" id="5455348">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5455351">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5455403">func</span>&nbsp;<span class="op" id="5455408">(</span><span class="ident" id="5455409">e</span>&nbsp;<span class="op" id="5455411">*</span><span class="ident" id="5455412">escaper</span><span class="op" id="5455419">)</span>&nbsp;<span class="ident" id="5455421">escapeTemplate</span><span class="op" id="5455435">(</span><span class="ident" id="5455436">c</span>&nbsp;<span class="ident" id="5455438">context</span><span class="op" id="5455445">,</span>&nbsp;<span class="ident" id="5455447">n</span>&nbsp;<span class="op" id="5455449">*</span><span class="ident" id="5455450">parse</span><span class="op" id="5455455">.</span><span class="ident" id="5455456">TemplateNode</span><span class="op" id="5455468">)</span>&nbsp;<span class="ident" id="5455470">context</span>&nbsp;<span class="op" id="5455478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455481">c</span><span class="op" id="5455482">,</span>&nbsp;<span class="ident" id="5455484">name</span>&nbsp;<span class="op" id="5455489">:=</span>&nbsp;<span class="ident" id="5455492">e</span><span class="op" id="5455493">.</span><span class="ident" id="5455494">escapeTree</span><span class="op" id="5455504">(</span><span class="ident" id="5455505">c</span><span class="op" id="5455506">,</span>&nbsp;<span class="ident" id="5455508">n</span><span class="op" id="5455509">,</span>&nbsp;<span class="ident" id="5455511">n</span><span class="op" id="5455512">.</span><span class="ident" id="5455513">Name</span><span class="op" id="5455517">,</span>&nbsp;<span class="ident" id="5455519">n</span><span class="op" id="5455520">.</span><span class="ident" id="5455521">Line</span><span class="op" id="5455525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455528">if</span>&nbsp;<span class="ident" id="5455531">name</span>&nbsp;<span class="op" id="5455536">!=</span>&nbsp;<span class="ident" id="5455539">n</span><span class="op" id="5455540">.</span><span class="ident" id="5455541">Name</span>&nbsp;<span class="op" id="5455546">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455550">e</span><span class="op" id="5455551">.</span><span class="ident" id="5455552">editTemplateNode</span><span class="op" id="5455568">(</span><span class="ident" id="5455569">n</span><span class="op" id="5455570">,</span>&nbsp;<span class="ident" id="5455572">name</span><span class="op" id="5455576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5455579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455582">return</span>&nbsp;<span class="ident" id="5455589">c</span><br>
<span class="lineno"></span><span class="op" id="5455591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="5455594">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5455668">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="5455713">func</span>&nbsp;<span class="op" id="5455718">(</span><span class="ident" id="5455719">e</span>&nbsp;<span class="op" id="5455721">*</span><span class="ident" id="5455722">escaper</span><span class="op" id="5455729">)</span>&nbsp;<span class="ident" id="5455731">escapeTree</span><span class="op" id="5455741">(</span><span class="ident" id="5455742">c</span>&nbsp;<span class="ident" id="5455744">context</span><span class="op" id="5455751">,</span>&nbsp;<span class="ident" id="5455753">node</span>&nbsp;<span class="ident" id="5455758">parse</span><span class="op" id="5455763">.</span><span class="ident" id="5455764">Node</span><span class="op" id="5455768">,</span>&nbsp;<span class="ident" id="5455770">name</span>&nbsp;<span class="builtintype" id="5455775">string</span><span class="op" id="5455781">,</span>&nbsp;<span class="ident" id="5455783">line</span>&nbsp;<span class="builtintype" id="5455788">int</span><span class="op" id="5455791">)</span>&nbsp;<span class="op" id="5455793">(</span><span class="ident" id="5455794">context</span><span class="op" id="5455801">,</span>&nbsp;<span class="builtintype" id="5455803">string</span><span class="op" id="5455809">)</span>&nbsp;<span class="op" id="5455811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5455814">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5455888">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455904">dname</span>&nbsp;<span class="op" id="5455910">:=</span>&nbsp;<span class="ident" id="5455913">c</span><span class="op" id="5455914">.</span><span class="ident" id="5455915">mangle</span><span class="op" id="5455921">(</span><span class="ident" id="5455922">name</span><span class="op" id="5455926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5455929">e</span><span class="op" id="5455930">.</span><span class="ident" id="5455931">called</span><span class="op" id="5455937">[</span><span class="ident" id="5455938">dname</span><span class="op" id="5455943">]</span>&nbsp;<span class="op" id="5455945">=</span>&nbsp;<span class="builtintype" id="5455947">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5455953">if</span>&nbsp;<span class="ident" id="5455956">out</span><span class="op" id="5455959">,</span>&nbsp;<span class="ident" id="5455961">ok</span>&nbsp;<span class="op" id="5455964">:=</span>&nbsp;<span class="ident" id="5455967">e</span><span class="op" id="5455968">.</span><span class="ident" id="5455969">output</span><span class="op" id="5455975">[</span><span class="ident" id="5455976">dname</span><span class="op" id="5455981">]</span><span class="op" id="5455982">;</span>&nbsp;<span class="ident" id="5455984">ok</span>&nbsp;<span class="op" id="5455987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5455991">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456013">return</span>&nbsp;<span class="ident" id="5456020">out</span><span class="op" id="5456023">,</span>&nbsp;<span class="ident" id="5456025">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456035">t</span>&nbsp;<span class="op" id="5456037">:=</span>&nbsp;<span class="ident" id="5456040">e</span><span class="op" id="5456041">.</span><span class="ident" id="5456042">template</span><span class="op" id="5456050">(</span><span class="ident" id="5456051">name</span><span class="op" id="5456055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456058">if</span>&nbsp;<span class="ident" id="5456061">t</span>&nbsp;<span class="op" id="5456063">==</span>&nbsp;<span class="ident" id="5456066">nil</span>&nbsp;<span class="op" id="5456070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456074">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456155">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456210">if</span>&nbsp;<span class="ident" id="5456213">e</span><span class="op" id="5456214">.</span><span class="ident" id="5456215">tmpl</span><span class="op" id="5456219">.</span><span class="ident" id="5456220">set</span><span class="op" id="5456223">[</span><span class="ident" id="5456224">name</span><span class="op" id="5456228">]</span>&nbsp;<span class="op" id="5456230">!=</span>&nbsp;<span class="ident" id="5456233">nil</span>&nbsp;<span class="op" id="5456237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456242">return</span>&nbsp;<span class="ident" id="5456249">context</span><span class="op" id="5456256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456262">state</span><span class="op" id="5456267">:</span>&nbsp;<span class="ident" id="5456269">stateError</span><span class="op" id="5456279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456285">err</span><span class="op" id="5456288">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5456292">errorf</span><span class="op" id="5456298">(</span><span class="ident" id="5456299">ErrNoSuchTemplate</span><span class="op" id="5456316">,</span>&nbsp;<span class="ident" id="5456318">node</span><span class="op" id="5456322">,</span>&nbsp;<span class="ident" id="5456324">line</span><span class="op" id="5456328">,</span>&nbsp;<span class="string" id="5456330">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="5456369">,</span>&nbsp;<span class="ident" id="5456371">name</span><span class="op" id="5456375">)</span><span class="op" id="5456376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456381">}</span><span class="op" id="5456382">,</span>&nbsp;<span class="ident" id="5456384">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456396">return</span>&nbsp;<span class="ident" id="5456403">context</span><span class="op" id="5456410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456415">state</span><span class="op" id="5456420">:</span>&nbsp;<span class="ident" id="5456422">stateError</span><span class="op" id="5456432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456437">err</span><span class="op" id="5456440">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5456444">errorf</span><span class="op" id="5456450">(</span><span class="ident" id="5456451">ErrNoSuchTemplate</span><span class="op" id="5456468">,</span>&nbsp;<span class="ident" id="5456470">node</span><span class="op" id="5456474">,</span>&nbsp;<span class="ident" id="5456476">line</span><span class="op" id="5456480">,</span>&nbsp;<span class="string" id="5456482">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="5456503">,</span>&nbsp;<span class="ident" id="5456505">name</span><span class="op" id="5456509">)</span><span class="op" id="5456510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456514">}</span><span class="op" id="5456515">,</span>&nbsp;<span class="ident" id="5456517">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456527">if</span>&nbsp;<span class="ident" id="5456530">dname</span>&nbsp;<span class="op" id="5456536">!=</span>&nbsp;<span class="ident" id="5456539">name</span>&nbsp;<span class="op" id="5456544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456548">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5456619">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456683">dt</span>&nbsp;<span class="op" id="5456686">:=</span>&nbsp;<span class="ident" id="5456689">e</span><span class="op" id="5456690">.</span><span class="ident" id="5456691">template</span><span class="op" id="5456699">(</span><span class="ident" id="5456700">dname</span><span class="op" id="5456705">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456709">if</span>&nbsp;<span class="ident" id="5456712">dt</span>&nbsp;<span class="op" id="5456715">==</span>&nbsp;<span class="ident" id="5456718">nil</span>&nbsp;<span class="op" id="5456722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456727">dt</span>&nbsp;<span class="op" id="5456730">=</span>&nbsp;<span class="ident" id="5456732">template</span><span class="op" id="5456740">.</span><span class="ident" id="5456741">New</span><span class="op" id="5456744">(</span><span class="ident" id="5456745">dname</span><span class="op" id="5456750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456755">dt</span><span class="op" id="5456757">.</span><span class="ident" id="5456758">Tree</span>&nbsp;<span class="op" id="5456763">=</span>&nbsp;<span class="op" id="5456765">&amp;</span><span class="ident" id="5456766">parse</span><span class="op" id="5456771">.</span><span class="ident" id="5456772">Tree</span><span class="op" id="5456776">{</span><span class="ident" id="5456777">Name</span><span class="op" id="5456781">:</span>&nbsp;<span class="ident" id="5456783">dname</span><span class="op" id="5456788">,</span>&nbsp;<span class="ident" id="5456790">Root</span><span class="op" id="5456794">:</span>&nbsp;<span class="ident" id="5456796">t</span><span class="op" id="5456797">.</span><span class="ident" id="5456798">Root</span><span class="op" id="5456802">.</span><span class="ident" id="5456803">CopyList</span><span class="op" id="5456811">(</span><span class="op" id="5456812">)</span><span class="op" id="5456813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456818">e</span><span class="op" id="5456819">.</span><span class="ident" id="5456820">derived</span><span class="op" id="5456827">[</span><span class="ident" id="5456828">dname</span><span class="op" id="5456833">]</span>&nbsp;<span class="op" id="5456835">=</span>&nbsp;<span class="ident" id="5456837">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456842">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5456846">t</span>&nbsp;<span class="op" id="5456848">=</span>&nbsp;<span class="ident" id="5456850">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5456854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5456857">return</span>&nbsp;<span class="ident" id="5456864">e</span><span class="op" id="5456865">.</span><span class="ident" id="5456866">computeOutCtx</span><span class="op" id="5456879">(</span><span class="ident" id="5456880">c</span><span class="op" id="5456881">,</span>&nbsp;<span class="ident" id="5456883">t</span><span class="op" id="5456884">)</span><span class="op" id="5456885">,</span>&nbsp;<span class="ident" id="5456887">dname</span><br>
<span class="lineno"></span><span class="op" id="5456893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="5456896">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5456976">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="5457022">func</span>&nbsp;<span class="op" id="5457027">(</span><span class="ident" id="5457028">e</span>&nbsp;<span class="op" id="5457030">*</span><span class="ident" id="5457031">escaper</span><span class="op" id="5457038">)</span>&nbsp;<span class="ident" id="5457040">computeOutCtx</span><span class="op" id="5457053">(</span><span class="ident" id="5457054">c</span>&nbsp;<span class="ident" id="5457056">context</span><span class="op" id="5457063">,</span>&nbsp;<span class="ident" id="5457065">t</span>&nbsp;<span class="op" id="5457067">*</span><span class="ident" id="5457068">template</span><span class="op" id="5457076">.</span><span class="ident" id="5457077">Template</span><span class="op" id="5457085">)</span>&nbsp;<span class="ident" id="5457087">context</span>&nbsp;<span class="op" id="5457095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457098">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457135">c1</span><span class="op" id="5457137">,</span>&nbsp;<span class="ident" id="5457139">ok</span>&nbsp;<span class="op" id="5457142">:=</span>&nbsp;<span class="ident" id="5457145">e</span><span class="op" id="5457146">.</span><span class="ident" id="5457147">escapeTemplateBody</span><span class="op" id="5457165">(</span><span class="ident" id="5457166">c</span><span class="op" id="5457167">,</span>&nbsp;<span class="ident" id="5457169">t</span><span class="op" id="5457170">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457173">if</span>&nbsp;<span class="op" id="5457176">!</span><span class="ident" id="5457177">ok</span>&nbsp;<span class="op" id="5457180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457184">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457250">if</span>&nbsp;<span class="ident" id="5457253">c2</span><span class="op" id="5457255">,</span>&nbsp;<span class="ident" id="5457257">ok2</span>&nbsp;<span class="op" id="5457261">:=</span>&nbsp;<span class="ident" id="5457264">e</span><span class="op" id="5457265">.</span><span class="ident" id="5457266">escapeTemplateBody</span><span class="op" id="5457284">(</span><span class="ident" id="5457285">c1</span><span class="op" id="5457287">,</span>&nbsp;<span class="ident" id="5457289">t</span><span class="op" id="5457290">)</span><span class="op" id="5457291">;</span>&nbsp;<span class="ident" id="5457293">ok2</span>&nbsp;<span class="op" id="5457297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457302">c1</span><span class="op" id="5457304">,</span>&nbsp;<span class="ident" id="5457306">ok</span>&nbsp;<span class="op" id="5457309">=</span>&nbsp;<span class="ident" id="5457311">c2</span><span class="op" id="5457313">,</span>&nbsp;<span class="builtintype" id="5457315">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457322">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457326">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457391">if</span>&nbsp;<span class="op" id="5457394">!</span><span class="ident" id="5457395">ok</span>&nbsp;<span class="op" id="5457398">&amp;&amp;</span>&nbsp;<span class="ident" id="5457401">c1</span><span class="op" id="5457403">.</span><span class="ident" id="5457404">state</span>&nbsp;<span class="op" id="5457410">!=</span>&nbsp;<span class="ident" id="5457413">stateError</span>&nbsp;<span class="op" id="5457424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457428">return</span>&nbsp;<span class="ident" id="5457435">context</span><span class="op" id="5457442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457447">state</span><span class="op" id="5457452">:</span>&nbsp;<span class="ident" id="5457454">stateError</span><span class="op" id="5457464">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457469">err</span><span class="op" id="5457472">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5457476">errorf</span><span class="op" id="5457482">(</span><span class="ident" id="5457483">ErrOutputContext</span><span class="op" id="5457499">,</span>&nbsp;<span class="ident" id="5457501">t</span><span class="op" id="5457502">.</span><span class="ident" id="5457503">Tree</span><span class="op" id="5457507">.</span><span class="ident" id="5457508">Root</span><span class="op" id="5457512">,</span>&nbsp;<span class="num" id="5457514">0</span><span class="op" id="5457515">,</span>&nbsp;<span class="string" id="5457517">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="5457564">,</span>&nbsp;<span class="ident" id="5457566">t</span><span class="op" id="5457567">.</span><span class="ident" id="5457568">Name</span><span class="op" id="5457572">(</span><span class="op" id="5457573">)</span><span class="op" id="5457574">)</span><span class="op" id="5457575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5457582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457585">return</span>&nbsp;<span class="ident" id="5457592">c1</span><br>
<span class="lineno"></span><span class="op" id="5457595">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="5457598">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5457673">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5457750">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="5457777">func</span>&nbsp;<span class="op" id="5457782">(</span><span class="ident" id="5457783">e</span>&nbsp;<span class="op" id="5457785">*</span><span class="ident" id="5457786">escaper</span><span class="op" id="5457793">)</span>&nbsp;<span class="ident" id="5457795">escapeTemplateBody</span><span class="op" id="5457813">(</span><span class="ident" id="5457814">c</span>&nbsp;<span class="ident" id="5457816">context</span><span class="op" id="5457823">,</span>&nbsp;<span class="ident" id="5457825">t</span>&nbsp;<span class="op" id="5457827">*</span><span class="ident" id="5457828">template</span><span class="op" id="5457836">.</span><span class="ident" id="5457837">Template</span><span class="op" id="5457845">)</span>&nbsp;<span class="op" id="5457847">(</span><span class="ident" id="5457848">context</span><span class="op" id="5457855">,</span>&nbsp;<span class="builtintype" id="5457857">bool</span><span class="op" id="5457861">)</span>&nbsp;<span class="op" id="5457863">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5457866">filter</span>&nbsp;<span class="op" id="5457873">:=</span>&nbsp;<span class="keyword" id="5457876">func</span><span class="op" id="5457880">(</span><span class="ident" id="5457881">e1</span>&nbsp;<span class="op" id="5457884">*</span><span class="ident" id="5457885">escaper</span><span class="op" id="5457892">,</span>&nbsp;<span class="ident" id="5457894">c1</span>&nbsp;<span class="ident" id="5457897">context</span><span class="op" id="5457904">)</span>&nbsp;<span class="builtintype" id="5457906">bool</span>&nbsp;<span class="op" id="5457911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457915">if</span>&nbsp;<span class="ident" id="5457918">c1</span><span class="op" id="5457920">.</span><span class="ident" id="5457921">state</span>&nbsp;<span class="op" id="5457927">==</span>&nbsp;<span class="ident" id="5457930">stateError</span>&nbsp;<span class="op" id="5457941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5457946">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5457988">return</span>&nbsp;<span class="builtintype" id="5457995">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458003">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458007">if</span>&nbsp;<span class="op" id="5458010">!</span><span class="ident" id="5458011">e1</span><span class="op" id="5458013">.</span><span class="ident" id="5458014">called</span><span class="op" id="5458020">[</span><span class="ident" id="5458021">t</span><span class="op" id="5458022">.</span><span class="ident" id="5458023">Name</span><span class="op" id="5458027">(</span><span class="op" id="5458028">)</span><span class="op" id="5458029">]</span>&nbsp;<span class="op" id="5458031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458036">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458088">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458119">return</span>&nbsp;<span class="builtintype" id="5458126">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458133">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458137">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458199">return</span>&nbsp;<span class="ident" id="5458206">c</span><span class="op" id="5458207">.</span><span class="ident" id="5458208">eq</span><span class="op" id="5458210">(</span><span class="ident" id="5458211">c1</span><span class="op" id="5458213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5458216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458219">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458292">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458366">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458436">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458464">e</span><span class="op" id="5458465">.</span><span class="ident" id="5458466">output</span><span class="op" id="5458472">[</span><span class="ident" id="5458473">t</span><span class="op" id="5458474">.</span><span class="ident" id="5458475">Name</span><span class="op" id="5458479">(</span><span class="op" id="5458480">)</span><span class="op" id="5458481">]</span>&nbsp;<span class="op" id="5458483">=</span>&nbsp;<span class="ident" id="5458485">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5458488">return</span>&nbsp;<span class="ident" id="5458495">e</span><span class="op" id="5458496">.</span><span class="ident" id="5458497">escapeListConditionally</span><span class="op" id="5458520">(</span><span class="ident" id="5458521">c</span><span class="op" id="5458522">,</span>&nbsp;<span class="ident" id="5458524">t</span><span class="op" id="5458525">.</span><span class="ident" id="5458526">Tree</span><span class="op" id="5458530">.</span><span class="ident" id="5458531">Root</span><span class="op" id="5458535">,</span>&nbsp;<span class="ident" id="5458537">filter</span><span class="op" id="5458543">)</span><br>
<span class="lineno"></span><span class="op" id="5458545">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="5458548">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5458622">var</span>&nbsp;<span class="ident" id="5458626">delimEnds</span>&nbsp;<span class="op" id="5458636">=</span>&nbsp;<span class="op" id="5458638">[</span><span class="op" id="5458639">...</span><span class="op" id="5458642">]</span><span class="builtintype" id="5458643">string</span><span class="op" id="5458649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458652">delimDoubleQuote</span><span class="op" id="5458668">:</span>&nbsp;<span class="string" id="5458670">`&#34;`</span><span class="op" id="5458673">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5458676">delimSingleQuote</span><span class="op" id="5458692">:</span>&nbsp;<span class="string" id="5458694">&#34;&#39;&#34;</span><span class="op" id="5458697">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458700">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458769">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458814">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458854">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5458928">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459000">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459050">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459056">delimSpaceOrTagEnd</span><span class="op" id="5459074">:</span>&nbsp;<span class="string" id="5459076">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="5459088">,</span><br>
<span class="lineno"></span><span class="op" id="5459090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="5459093">var</span>&nbsp;<span class="ident" id="5459097">doctypeBytes</span>&nbsp;<span class="op" id="5459110">=</span>&nbsp;<span class="op" id="5459112">[</span><span class="op" id="5459113">]</span><span class="builtintype" id="5459114">byte</span><span class="op" id="5459118">(</span><span class="string" id="5459119">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="5459130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5459133">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5459177">func</span>&nbsp;<span class="op" id="5459182">(</span><span class="ident" id="5459183">e</span>&nbsp;<span class="op" id="5459185">*</span><span class="ident" id="5459186">escaper</span><span class="op" id="5459193">)</span>&nbsp;<span class="ident" id="5459195">escapeText</span><span class="op" id="5459205">(</span><span class="ident" id="5459206">c</span>&nbsp;<span class="ident" id="5459208">context</span><span class="op" id="5459215">,</span>&nbsp;<span class="ident" id="5459217">n</span>&nbsp;<span class="op" id="5459219">*</span><span class="ident" id="5459220">parse</span><span class="op" id="5459225">.</span><span class="ident" id="5459226">TextNode</span><span class="op" id="5459234">)</span>&nbsp;<span class="ident" id="5459236">context</span>&nbsp;<span class="op" id="5459244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459247">s</span><span class="op" id="5459248">,</span>&nbsp;<span class="ident" id="5459250">written</span><span class="op" id="5459257">,</span>&nbsp;<span class="ident" id="5459259">i</span><span class="op" id="5459260">,</span>&nbsp;<span class="ident" id="5459262">b</span>&nbsp;<span class="op" id="5459264">:=</span>&nbsp;<span class="ident" id="5459267">n</span><span class="op" id="5459268">.</span><span class="ident" id="5459269">Text</span><span class="op" id="5459273">,</span>&nbsp;<span class="num" id="5459275">0</span><span class="op" id="5459276">,</span>&nbsp;<span class="num" id="5459278">0</span><span class="op" id="5459279">,</span>&nbsp;<span class="builtinfunc" id="5459281">new</span><span class="op" id="5459284">(</span><span class="ident" id="5459285">bytes</span><span class="op" id="5459290">.</span><span class="ident" id="5459291">Buffer</span><span class="op" id="5459297">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459300">for</span>&nbsp;<span class="ident" id="5459304">i</span>&nbsp;<span class="op" id="5459306">!=</span>&nbsp;<span class="builtinfunc" id="5459309">len</span><span class="op" id="5459312">(</span><span class="ident" id="5459313">s</span><span class="op" id="5459314">)</span>&nbsp;<span class="op" id="5459316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459320">c1</span><span class="op" id="5459322">,</span>&nbsp;<span class="ident" id="5459324">nread</span>&nbsp;<span class="op" id="5459330">:=</span>&nbsp;<span class="ident" id="5459333">contextAfterText</span><span class="op" id="5459349">(</span><span class="ident" id="5459350">c</span><span class="op" id="5459351">,</span>&nbsp;<span class="ident" id="5459353">s</span><span class="op" id="5459354">[</span><span class="ident" id="5459355">i</span><span class="op" id="5459356">:</span><span class="op" id="5459357">]</span><span class="op" id="5459358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459362">i1</span>&nbsp;<span class="op" id="5459365">:=</span>&nbsp;<span class="ident" id="5459368">i</span>&nbsp;<span class="op" id="5459370">+</span>&nbsp;<span class="ident" id="5459372">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459380">if</span>&nbsp;<span class="ident" id="5459383">c</span><span class="op" id="5459384">.</span><span class="ident" id="5459385">state</span>&nbsp;<span class="op" id="5459391">==</span>&nbsp;<span class="ident" id="5459394">stateText</span>&nbsp;<span class="op" id="5459404">||</span>&nbsp;<span class="ident" id="5459407">c</span><span class="op" id="5459408">.</span><span class="ident" id="5459409">state</span>&nbsp;<span class="op" id="5459415">==</span>&nbsp;<span class="ident" id="5459418">stateRCDATA</span>&nbsp;<span class="op" id="5459430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459435">end</span>&nbsp;<span class="op" id="5459439">:=</span>&nbsp;<span class="ident" id="5459442">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459448">if</span>&nbsp;<span class="ident" id="5459451">c1</span><span class="op" id="5459453">.</span><span class="ident" id="5459454">state</span>&nbsp;<span class="op" id="5459460">!=</span>&nbsp;<span class="ident" id="5459463">c</span><span class="op" id="5459464">.</span><span class="ident" id="5459465">state</span>&nbsp;<span class="op" id="5459471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459477">for</span>&nbsp;<span class="ident" id="5459481">j</span>&nbsp;<span class="op" id="5459483">:=</span>&nbsp;<span class="ident" id="5459486">end</span>&nbsp;<span class="op" id="5459490">-</span>&nbsp;<span class="num" id="5459492">1</span><span class="op" id="5459493">;</span>&nbsp;<span class="ident" id="5459495">j</span>&nbsp;<span class="op" id="5459497">&gt;=</span>&nbsp;<span class="ident" id="5459500">i</span><span class="op" id="5459501">;</span>&nbsp;<span class="ident" id="5459503">j</span><span class="op" id="5459504">--</span>&nbsp;<span class="op" id="5459507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459514">if</span>&nbsp;<span class="ident" id="5459517">s</span><span class="op" id="5459518">[</span><span class="ident" id="5459519">j</span><span class="op" id="5459520">]</span>&nbsp;<span class="op" id="5459522">==</span>&nbsp;<span class="string" id="5459525">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5459529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459537">end</span>&nbsp;<span class="op" id="5459541">=</span>&nbsp;<span class="ident" id="5459543">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459551">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459578">for</span>&nbsp;<span class="ident" id="5459582">j</span>&nbsp;<span class="op" id="5459584">:=</span>&nbsp;<span class="ident" id="5459587">i</span><span class="op" id="5459588">;</span>&nbsp;<span class="ident" id="5459590">j</span>&nbsp;<span class="op" id="5459592">&lt;</span>&nbsp;<span class="ident" id="5459594">end</span><span class="op" id="5459597">;</span>&nbsp;<span class="ident" id="5459599">j</span><span class="op" id="5459600">++</span>&nbsp;<span class="op" id="5459603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459609">if</span>&nbsp;<span class="ident" id="5459612">s</span><span class="op" id="5459613">[</span><span class="ident" id="5459614">j</span><span class="op" id="5459615">]</span>&nbsp;<span class="op" id="5459617">==</span>&nbsp;<span class="string" id="5459620">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5459624">&amp;&amp;</span>&nbsp;<span class="op" id="5459627">!</span><span class="ident" id="5459628">bytes</span><span class="op" id="5459633">.</span><span class="ident" id="5459634">HasPrefix</span><span class="op" id="5459643">(</span><span class="ident" id="5459644">bytes</span><span class="op" id="5459649">.</span><span class="ident" id="5459650">ToUpper</span><span class="op" id="5459657">(</span><span class="ident" id="5459658">s</span><span class="op" id="5459659">[</span><span class="ident" id="5459660">j</span><span class="op" id="5459661">:</span><span class="op" id="5459662">]</span><span class="op" id="5459663">)</span><span class="op" id="5459664">,</span>&nbsp;<span class="ident" id="5459666">doctypeBytes</span><span class="op" id="5459678">)</span>&nbsp;<span class="op" id="5459680">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459687">b</span><span class="op" id="5459688">.</span><span class="ident" id="5459689">Write</span><span class="op" id="5459694">(</span><span class="ident" id="5459695">s</span><span class="op" id="5459696">[</span><span class="ident" id="5459697">written</span><span class="op" id="5459704">:</span><span class="ident" id="5459705">j</span><span class="op" id="5459706">]</span><span class="op" id="5459707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459714">b</span><span class="op" id="5459715">.</span><span class="ident" id="5459716">WriteString</span><span class="op" id="5459727">(</span><span class="string" id="5459728">&#34;&amp;lt;&#34;</span><span class="op" id="5459734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5459741">written</span>&nbsp;<span class="op" id="5459749">=</span>&nbsp;<span class="ident" id="5459751">j</span>&nbsp;<span class="op" id="5459753">+</span>&nbsp;<span class="num" id="5459755">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459766">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5459770">}</span>&nbsp;<span class="keyword" id="5459772">else</span>&nbsp;<span class="keyword" id="5459777">if</span>&nbsp;<span class="ident" id="5459780">isComment</span><span class="op" id="5459789">(</span><span class="ident" id="5459790">c</span><span class="op" id="5459791">.</span><span class="ident" id="5459792">state</span><span class="op" id="5459797">)</span>&nbsp;<span class="op" id="5459799">&amp;&amp;</span>&nbsp;<span class="ident" id="5459802">c</span><span class="op" id="5459803">.</span><span class="ident" id="5459804">delim</span>&nbsp;<span class="op" id="5459810">==</span>&nbsp;<span class="ident" id="5459813">delimNone</span>&nbsp;<span class="op" id="5459823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459828">switch</span>&nbsp;<span class="ident" id="5459835">c</span><span class="op" id="5459836">.</span><span class="ident" id="5459837">state</span>&nbsp;<span class="op" id="5459843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5459848">case</span>&nbsp;<span class="ident" id="5459853">stateJSBlockCmt</span><span class="op" id="5459868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459874">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459910">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5459959">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460011">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460061">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460109">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460158">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460189">if</span>&nbsp;<span class="ident" id="5460192">bytes</span><span class="op" id="5460197">.</span><span class="ident" id="5460198">IndexAny</span><span class="op" id="5460206">(</span><span class="ident" id="5460207">s</span><span class="op" id="5460208">[</span><span class="ident" id="5460209">written</span><span class="op" id="5460216">:</span><span class="ident" id="5460217">i1</span><span class="op" id="5460219">]</span><span class="op" id="5460220">,</span>&nbsp;<span class="string" id="5460222">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="5460240">)</span>&nbsp;<span class="op" id="5460242">!=</span>&nbsp;<span class="op" id="5460245">-</span><span class="num" id="5460246">1</span>&nbsp;<span class="op" id="5460248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460255">b</span><span class="op" id="5460256">.</span><span class="ident" id="5460257">WriteByte</span><span class="op" id="5460266">(</span><span class="string" id="5460267">&#39;\n&#39;</span><span class="op" id="5460271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460277">}</span>&nbsp;<span class="keyword" id="5460279">else</span>&nbsp;<span class="op" id="5460284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460291">b</span><span class="op" id="5460292">.</span><span class="ident" id="5460293">WriteByte</span><span class="op" id="5460302">(</span><span class="string" id="5460303">&#39;&nbsp;&#39;</span><span class="op" id="5460306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460312">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460317">case</span>&nbsp;<span class="ident" id="5460322">stateCSSBlockCmt</span><span class="op" id="5460338">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460344">b</span><span class="op" id="5460345">.</span><span class="ident" id="5460346">WriteByte</span><span class="op" id="5460355">(</span><span class="string" id="5460356">&#39;&nbsp;&#39;</span><span class="op" id="5460359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460369">written</span>&nbsp;<span class="op" id="5460377">=</span>&nbsp;<span class="ident" id="5460379">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460384">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460388">if</span>&nbsp;<span class="ident" id="5460391">c</span><span class="op" id="5460392">.</span><span class="ident" id="5460393">state</span>&nbsp;<span class="op" id="5460399">!=</span>&nbsp;<span class="ident" id="5460402">c1</span><span class="op" id="5460404">.</span><span class="ident" id="5460405">state</span>&nbsp;<span class="op" id="5460411">&amp;&amp;</span>&nbsp;<span class="ident" id="5460414">isComment</span><span class="op" id="5460423">(</span><span class="ident" id="5460424">c1</span><span class="op" id="5460426">.</span><span class="ident" id="5460427">state</span><span class="op" id="5460432">)</span>&nbsp;<span class="op" id="5460434">&amp;&amp;</span>&nbsp;<span class="ident" id="5460437">c1</span><span class="op" id="5460439">.</span><span class="ident" id="5460440">delim</span>&nbsp;<span class="op" id="5460446">==</span>&nbsp;<span class="ident" id="5460449">delimNone</span>&nbsp;<span class="op" id="5460459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460464">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460530">cs</span>&nbsp;<span class="op" id="5460533">:=</span>&nbsp;<span class="ident" id="5460536">i1</span>&nbsp;<span class="op" id="5460539">-</span>&nbsp;<span class="num" id="5460541">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460546">if</span>&nbsp;<span class="ident" id="5460549">c1</span><span class="op" id="5460551">.</span><span class="ident" id="5460552">state</span>&nbsp;<span class="op" id="5460558">==</span>&nbsp;<span class="ident" id="5460561">stateHTMLCmt</span>&nbsp;<span class="op" id="5460574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5460580">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460618">cs</span>&nbsp;<span class="op" id="5460621">-=</span>&nbsp;<span class="num" id="5460624">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460634">b</span><span class="op" id="5460635">.</span><span class="ident" id="5460636">Write</span><span class="op" id="5460641">(</span><span class="ident" id="5460642">s</span><span class="op" id="5460643">[</span><span class="ident" id="5460644">written</span><span class="op" id="5460651">:</span><span class="ident" id="5460652">cs</span><span class="op" id="5460654">]</span><span class="op" id="5460655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460660">written</span>&nbsp;<span class="op" id="5460668">=</span>&nbsp;<span class="ident" id="5460670">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460675">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460679">if</span>&nbsp;<span class="ident" id="5460682">i</span>&nbsp;<span class="op" id="5460684">==</span>&nbsp;<span class="ident" id="5460687">i1</span>&nbsp;<span class="op" id="5460690">&amp;&amp;</span>&nbsp;<span class="ident" id="5460693">c</span><span class="op" id="5460694">.</span><span class="ident" id="5460695">state</span>&nbsp;<span class="op" id="5460701">==</span>&nbsp;<span class="ident" id="5460704">c1</span><span class="op" id="5460706">.</span><span class="ident" id="5460707">state</span>&nbsp;<span class="op" id="5460713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5460718">panic</span><span class="op" id="5460723">(</span><span class="ident" id="5460724">fmt</span><span class="op" id="5460727">.</span><span class="ident" id="5460728">Sprintf</span><span class="op" id="5460735">(</span><span class="string" id="5460736">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="5460775">,</span>&nbsp;<span class="ident" id="5460777">c</span><span class="op" id="5460778">,</span>&nbsp;<span class="ident" id="5460780">c1</span><span class="op" id="5460782">,</span>&nbsp;<span class="ident" id="5460784">s</span><span class="op" id="5460785">[</span><span class="op" id="5460786">:</span><span class="ident" id="5460787">i</span><span class="op" id="5460788">]</span><span class="op" id="5460789">,</span>&nbsp;<span class="ident" id="5460791">s</span><span class="op" id="5460792">[</span><span class="ident" id="5460793">i</span><span class="op" id="5460794">:</span><span class="op" id="5460795">]</span><span class="op" id="5460796">)</span><span class="op" id="5460797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460805">c</span><span class="op" id="5460806">,</span>&nbsp;<span class="ident" id="5460808">i</span>&nbsp;<span class="op" id="5460810">=</span>&nbsp;<span class="ident" id="5460812">c1</span><span class="op" id="5460814">,</span>&nbsp;<span class="ident" id="5460816">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460820">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460824">if</span>&nbsp;<span class="ident" id="5460827">written</span>&nbsp;<span class="op" id="5460835">!=</span>&nbsp;<span class="num" id="5460838">0</span>&nbsp;<span class="op" id="5460840">&amp;&amp;</span>&nbsp;<span class="ident" id="5460843">c</span><span class="op" id="5460844">.</span><span class="ident" id="5460845">state</span>&nbsp;<span class="op" id="5460851">!=</span>&nbsp;<span class="ident" id="5460854">stateError</span>&nbsp;<span class="op" id="5460865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460869">if</span>&nbsp;<span class="op" id="5460872">!</span><span class="ident" id="5460873">isComment</span><span class="op" id="5460882">(</span><span class="ident" id="5460883">c</span><span class="op" id="5460884">.</span><span class="ident" id="5460885">state</span><span class="op" id="5460890">)</span>&nbsp;<span class="op" id="5460892">||</span>&nbsp;<span class="ident" id="5460895">c</span><span class="op" id="5460896">.</span><span class="ident" id="5460897">delim</span>&nbsp;<span class="op" id="5460903">!=</span>&nbsp;<span class="ident" id="5460906">delimNone</span>&nbsp;<span class="op" id="5460916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460921">b</span><span class="op" id="5460922">.</span><span class="ident" id="5460923">Write</span><span class="op" id="5460928">(</span><span class="ident" id="5460929">n</span><span class="op" id="5460930">.</span><span class="ident" id="5460931">Text</span><span class="op" id="5460935">[</span><span class="ident" id="5460936">written</span><span class="op" id="5460943">:</span><span class="op" id="5460944">]</span><span class="op" id="5460945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460949">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460953">e</span><span class="op" id="5460954">.</span><span class="ident" id="5460955">editTextNode</span><span class="op" id="5460967">(</span><span class="ident" id="5460968">n</span><span class="op" id="5460969">,</span>&nbsp;<span class="ident" id="5460971">b</span><span class="op" id="5460972">.</span><span class="ident" id="5460973">Bytes</span><span class="op" id="5460978">(</span><span class="op" id="5460979">)</span><span class="op" id="5460980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5460983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5460986">return</span>&nbsp;<span class="ident" id="5460993">c</span><br>
<span class="lineno"></span><span class="op" id="5460995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="5460998">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5461078">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="5461156">func</span>&nbsp;<span class="ident" id="5461161">contextAfterText</span><span class="op" id="5461177">(</span><span class="ident" id="5461178">c</span>&nbsp;<span class="ident" id="5461180">context</span><span class="op" id="5461187">,</span>&nbsp;<span class="ident" id="5461189">s</span>&nbsp;<span class="op" id="5461191">[</span><span class="op" id="5461192">]</span><span class="builtintype" id="5461193">byte</span><span class="op" id="5461197">)</span>&nbsp;<span class="op" id="5461199">(</span><span class="ident" id="5461200">context</span><span class="op" id="5461207">,</span>&nbsp;<span class="builtintype" id="5461209">int</span><span class="op" id="5461212">)</span>&nbsp;<span class="op" id="5461214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461217">if</span>&nbsp;<span class="ident" id="5461220">c</span><span class="op" id="5461221">.</span><span class="ident" id="5461222">delim</span>&nbsp;<span class="op" id="5461228">==</span>&nbsp;<span class="ident" id="5461231">delimNone</span>&nbsp;<span class="op" id="5461241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461245">c1</span><span class="op" id="5461247">,</span>&nbsp;<span class="ident" id="5461249">i</span>&nbsp;<span class="op" id="5461251">:=</span>&nbsp;<span class="ident" id="5461254">tSpecialTagEnd</span><span class="op" id="5461268">(</span><span class="ident" id="5461269">c</span><span class="op" id="5461270">,</span>&nbsp;<span class="ident" id="5461272">s</span><span class="op" id="5461273">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461277">if</span>&nbsp;<span class="ident" id="5461280">i</span>&nbsp;<span class="op" id="5461282">==</span>&nbsp;<span class="num" id="5461285">0</span>&nbsp;<span class="op" id="5461287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461292">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461348">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461398">return</span>&nbsp;<span class="ident" id="5461405">c1</span><span class="op" id="5461407">,</span>&nbsp;<span class="num" id="5461409">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461413">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461417">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461462">return</span>&nbsp;<span class="ident" id="5461469">transitionFunc</span><span class="op" id="5461483">[</span><span class="ident" id="5461484">c</span><span class="op" id="5461485">.</span><span class="ident" id="5461486">state</span><span class="op" id="5461491">]</span><span class="op" id="5461492">(</span><span class="ident" id="5461493">c</span><span class="op" id="5461494">,</span>&nbsp;<span class="ident" id="5461496">s</span><span class="op" id="5461497">[</span><span class="op" id="5461498">:</span><span class="ident" id="5461499">i</span><span class="op" id="5461500">]</span><span class="op" id="5461501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461508">i</span>&nbsp;<span class="op" id="5461510">:=</span>&nbsp;<span class="ident" id="5461513">bytes</span><span class="op" id="5461518">.</span><span class="ident" id="5461519">IndexAny</span><span class="op" id="5461527">(</span><span class="ident" id="5461528">s</span><span class="op" id="5461529">,</span>&nbsp;<span class="ident" id="5461531">delimEnds</span><span class="op" id="5461540">[</span><span class="ident" id="5461541">c</span><span class="op" id="5461542">.</span><span class="ident" id="5461543">delim</span><span class="op" id="5461548">]</span><span class="op" id="5461549">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461552">if</span>&nbsp;<span class="ident" id="5461555">i</span>&nbsp;<span class="op" id="5461557">==</span>&nbsp;<span class="op" id="5461560">-</span><span class="num" id="5461561">1</span>&nbsp;<span class="op" id="5461563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461567">i</span>&nbsp;<span class="op" id="5461569">=</span>&nbsp;<span class="builtinfunc" id="5461571">len</span><span class="op" id="5461574">(</span><span class="ident" id="5461575">s</span><span class="op" id="5461576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461582">if</span>&nbsp;<span class="ident" id="5461585">c</span><span class="op" id="5461586">.</span><span class="ident" id="5461587">delim</span>&nbsp;<span class="op" id="5461593">==</span>&nbsp;<span class="ident" id="5461596">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5461615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461619">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461696">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461744">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461802">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461868">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461918">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461971">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462016">if</span>&nbsp;<span class="ident" id="5462019">j</span>&nbsp;<span class="op" id="5462021">:=</span>&nbsp;<span class="ident" id="5462024">bytes</span><span class="op" id="5462029">.</span><span class="ident" id="5462030">IndexAny</span><span class="op" id="5462038">(</span><span class="ident" id="5462039">s</span><span class="op" id="5462040">[</span><span class="op" id="5462041">:</span><span class="ident" id="5462042">i</span><span class="op" id="5462043">]</span><span class="op" id="5462044">,</span>&nbsp;<span class="string" id="5462046">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="5462054">)</span><span class="op" id="5462055">;</span>&nbsp;<span class="ident" id="5462057">j</span>&nbsp;<span class="op" id="5462059">&gt;=</span>&nbsp;<span class="num" id="5462062">0</span>&nbsp;<span class="op" id="5462064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462069">return</span>&nbsp;<span class="ident" id="5462076">context</span><span class="op" id="5462083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462089">state</span><span class="op" id="5462094">:</span>&nbsp;<span class="ident" id="5462096">stateError</span><span class="op" id="5462106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462112">err</span><span class="op" id="5462115">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5462119">errorf</span><span class="op" id="5462125">(</span><span class="ident" id="5462126">ErrBadHTML</span><span class="op" id="5462136">,</span>&nbsp;<span class="ident" id="5462138">nil</span><span class="op" id="5462141">,</span>&nbsp;<span class="num" id="5462143">0</span><span class="op" id="5462144">,</span>&nbsp;<span class="string" id="5462146">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="5462171">,</span>&nbsp;<span class="ident" id="5462173">s</span><span class="op" id="5462174">[</span><span class="ident" id="5462175">j</span><span class="op" id="5462176">:</span><span class="ident" id="5462177">j</span><span class="op" id="5462178">+</span><span class="num" id="5462179">1</span><span class="op" id="5462180">]</span><span class="op" id="5462181">,</span>&nbsp;<span class="ident" id="5462183">s</span><span class="op" id="5462184">[</span><span class="op" id="5462185">:</span><span class="ident" id="5462186">i</span><span class="op" id="5462187">]</span><span class="op" id="5462188">)</span><span class="op" id="5462189">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462194">}</span><span class="op" id="5462195">,</span>&nbsp;<span class="builtinfunc" id="5462197">len</span><span class="op" id="5462200">(</span><span class="ident" id="5462201">s</span><span class="op" id="5462202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462212">if</span>&nbsp;<span class="ident" id="5462215">i</span>&nbsp;<span class="op" id="5462217">==</span>&nbsp;<span class="builtinfunc" id="5462220">len</span><span class="op" id="5462223">(</span><span class="ident" id="5462224">s</span><span class="op" id="5462225">)</span>&nbsp;<span class="op" id="5462227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462231">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462265">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462323">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462374">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462429">for</span>&nbsp;<span class="ident" id="5462433">u</span>&nbsp;<span class="op" id="5462435">:=</span>&nbsp;<span class="op" id="5462438">[</span><span class="op" id="5462439">]</span><span class="builtintype" id="5462440">byte</span><span class="op" id="5462444">(</span><span class="ident" id="5462445">html</span><span class="op" id="5462449">.</span><span class="ident" id="5462450">UnescapeString</span><span class="op" id="5462464">(</span><span class="builtintype" id="5462465">string</span><span class="op" id="5462471">(</span><span class="ident" id="5462472">s</span><span class="op" id="5462473">)</span><span class="op" id="5462474">)</span><span class="op" id="5462475">)</span><span class="op" id="5462476">;</span>&nbsp;<span class="builtinfunc" id="5462478">len</span><span class="op" id="5462481">(</span><span class="ident" id="5462482">u</span><span class="op" id="5462483">)</span>&nbsp;<span class="op" id="5462485">!=</span>&nbsp;<span class="num" id="5462488">0</span><span class="op" id="5462489">;</span>&nbsp;<span class="op" id="5462491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462496">c1</span><span class="op" id="5462498">,</span>&nbsp;<span class="ident" id="5462500">i1</span>&nbsp;<span class="op" id="5462503">:=</span>&nbsp;<span class="ident" id="5462506">transitionFunc</span><span class="op" id="5462520">[</span><span class="ident" id="5462521">c</span><span class="op" id="5462522">.</span><span class="ident" id="5462523">state</span><span class="op" id="5462528">]</span><span class="op" id="5462529">(</span><span class="ident" id="5462530">c</span><span class="op" id="5462531">,</span>&nbsp;<span class="ident" id="5462533">u</span><span class="op" id="5462534">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462539">c</span><span class="op" id="5462540">,</span>&nbsp;<span class="ident" id="5462542">u</span>&nbsp;<span class="op" id="5462544">=</span>&nbsp;<span class="ident" id="5462546">c1</span><span class="op" id="5462548">,</span>&nbsp;<span class="ident" id="5462550">u</span><span class="op" id="5462551">[</span><span class="ident" id="5462552">i1</span><span class="op" id="5462554">:</span><span class="op" id="5462555">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462563">return</span>&nbsp;<span class="ident" id="5462570">c</span><span class="op" id="5462571">,</span>&nbsp;<span class="builtinfunc" id="5462573">len</span><span class="op" id="5462576">(</span><span class="ident" id="5462577">s</span><span class="op" id="5462578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462584">if</span>&nbsp;<span class="ident" id="5462587">c</span><span class="op" id="5462588">.</span><span class="ident" id="5462589">delim</span>&nbsp;<span class="op" id="5462595">!=</span>&nbsp;<span class="ident" id="5462598">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5462617">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462621">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462645">i</span><span class="op" id="5462646">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462653">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462715">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462749">return</span>&nbsp;<span class="ident" id="5462756">context</span><span class="op" id="5462763">{</span><span class="ident" id="5462764">state</span><span class="op" id="5462769">:</span>&nbsp;<span class="ident" id="5462771">stateTag</span><span class="op" id="5462779">,</span>&nbsp;<span class="ident" id="5462781">element</span><span class="op" id="5462788">:</span>&nbsp;<span class="ident" id="5462790">c</span><span class="op" id="5462791">.</span><span class="ident" id="5462792">element</span><span class="op" id="5462799">}</span><span class="op" id="5462800">,</span>&nbsp;<span class="ident" id="5462802">i</span><br>
<span class="lineno"></span><span class="op" id="5462804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5462807">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5462882">func</span>&nbsp;<span class="op" id="5462887">(</span><span class="ident" id="5462888">e</span>&nbsp;<span class="op" id="5462890">*</span><span class="ident" id="5462891">escaper</span><span class="op" id="5462898">)</span>&nbsp;<span class="ident" id="5462900">editActionNode</span><span class="op" id="5462914">(</span><span class="ident" id="5462915">n</span>&nbsp;<span class="op" id="5462917">*</span><span class="ident" id="5462918">parse</span><span class="op" id="5462923">.</span><span class="ident" id="5462924">ActionNode</span><span class="op" id="5462934">,</span>&nbsp;<span class="ident" id="5462936">cmds</span>&nbsp;<span class="op" id="5462941">[</span><span class="op" id="5462942">]</span><span class="builtintype" id="5462943">string</span><span class="op" id="5462949">)</span>&nbsp;<span class="op" id="5462951">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462954">if</span>&nbsp;<span class="ident" id="5462957">_</span><span class="op" id="5462958">,</span>&nbsp;<span class="ident" id="5462960">ok</span>&nbsp;<span class="op" id="5462963">:=</span>&nbsp;<span class="ident" id="5462966">e</span><span class="op" id="5462967">.</span><span class="ident" id="5462968">actionNodeEdits</span><span class="op" id="5462983">[</span><span class="ident" id="5462984">n</span><span class="op" id="5462985">]</span><span class="op" id="5462986">;</span>&nbsp;<span class="ident" id="5462988">ok</span>&nbsp;<span class="op" id="5462991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5462995">panic</span><span class="op" id="5463000">(</span><span class="ident" id="5463001">fmt</span><span class="op" id="5463004">.</span><span class="ident" id="5463005">Sprintf</span><span class="op" id="5463012">(</span><span class="string" id="5463013">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5463047">,</span>&nbsp;<span class="ident" id="5463049">n</span><span class="op" id="5463050">)</span><span class="op" id="5463051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463057">e</span><span class="op" id="5463058">.</span><span class="ident" id="5463059">actionNodeEdits</span><span class="op" id="5463074">[</span><span class="ident" id="5463075">n</span><span class="op" id="5463076">]</span>&nbsp;<span class="op" id="5463078">=</span>&nbsp;<span class="ident" id="5463080">cmds</span><br>
<span class="lineno"></span><span class="op" id="5463085">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="5463088">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5463168">func</span>&nbsp;<span class="op" id="5463173">(</span><span class="ident" id="5463174">e</span>&nbsp;<span class="op" id="5463176">*</span><span class="ident" id="5463177">escaper</span><span class="op" id="5463184">)</span>&nbsp;<span class="ident" id="5463186">editTemplateNode</span><span class="op" id="5463202">(</span><span class="ident" id="5463203">n</span>&nbsp;<span class="op" id="5463205">*</span><span class="ident" id="5463206">parse</span><span class="op" id="5463211">.</span><span class="ident" id="5463212">TemplateNode</span><span class="op" id="5463224">,</span>&nbsp;<span class="ident" id="5463226">callee</span>&nbsp;<span class="builtintype" id="5463233">string</span><span class="op" id="5463239">)</span>&nbsp;<span class="op" id="5463241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463244">if</span>&nbsp;<span class="ident" id="5463247">_</span><span class="op" id="5463248">,</span>&nbsp;<span class="ident" id="5463250">ok</span>&nbsp;<span class="op" id="5463253">:=</span>&nbsp;<span class="ident" id="5463256">e</span><span class="op" id="5463257">.</span><span class="ident" id="5463258">templateNodeEdits</span><span class="op" id="5463275">[</span><span class="ident" id="5463276">n</span><span class="op" id="5463277">]</span><span class="op" id="5463278">;</span>&nbsp;<span class="ident" id="5463280">ok</span>&nbsp;<span class="op" id="5463283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5463287">panic</span><span class="op" id="5463292">(</span><span class="ident" id="5463293">fmt</span><span class="op" id="5463296">.</span><span class="ident" id="5463297">Sprintf</span><span class="op" id="5463304">(</span><span class="string" id="5463305">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5463339">,</span>&nbsp;<span class="ident" id="5463341">n</span><span class="op" id="5463342">)</span><span class="op" id="5463343">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463349">e</span><span class="op" id="5463350">.</span><span class="ident" id="5463351">templateNodeEdits</span><span class="op" id="5463368">[</span><span class="ident" id="5463369">n</span><span class="op" id="5463370">]</span>&nbsp;<span class="op" id="5463372">=</span>&nbsp;<span class="ident" id="5463374">callee</span><br>
<span class="lineno"></span><span class="op" id="5463381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5463384">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="5463450">func</span>&nbsp;<span class="op" id="5463455">(</span><span class="ident" id="5463456">e</span>&nbsp;<span class="op" id="5463458">*</span><span class="ident" id="5463459">escaper</span><span class="op" id="5463466">)</span>&nbsp;<span class="ident" id="5463468">editTextNode</span><span class="op" id="5463480">(</span><span class="ident" id="5463481">n</span>&nbsp;<span class="op" id="5463483">*</span><span class="ident" id="5463484">parse</span><span class="op" id="5463489">.</span><span class="ident" id="5463490">TextNode</span><span class="op" id="5463498">,</span>&nbsp;<span class="ident" id="5463500">text</span>&nbsp;<span class="op" id="5463505">[</span><span class="op" id="5463506">]</span><span class="builtintype" id="5463507">byte</span><span class="op" id="5463511">)</span>&nbsp;<span class="op" id="5463513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463516">if</span>&nbsp;<span class="ident" id="5463519">_</span><span class="op" id="5463520">,</span>&nbsp;<span class="ident" id="5463522">ok</span>&nbsp;<span class="op" id="5463525">:=</span>&nbsp;<span class="ident" id="5463528">e</span><span class="op" id="5463529">.</span><span class="ident" id="5463530">textNodeEdits</span><span class="op" id="5463543">[</span><span class="ident" id="5463544">n</span><span class="op" id="5463545">]</span><span class="op" id="5463546">;</span>&nbsp;<span class="ident" id="5463548">ok</span>&nbsp;<span class="op" id="5463551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5463555">panic</span><span class="op" id="5463560">(</span><span class="ident" id="5463561">fmt</span><span class="op" id="5463564">.</span><span class="ident" id="5463565">Sprintf</span><span class="op" id="5463572">(</span><span class="string" id="5463573">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5463607">,</span>&nbsp;<span class="ident" id="5463609">n</span><span class="op" id="5463610">)</span><span class="op" id="5463611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463617">e</span><span class="op" id="5463618">.</span><span class="ident" id="5463619">textNodeEdits</span><span class="op" id="5463632">[</span><span class="ident" id="5463633">n</span><span class="op" id="5463634">]</span>&nbsp;<span class="op" id="5463636">=</span>&nbsp;<span class="ident" id="5463638">text</span><br>
<span class="lineno">735</span><span class="op" id="5463643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5463646">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="5463725">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5463790">func</span>&nbsp;<span class="op" id="5463795">(</span><span class="ident" id="5463796">e</span>&nbsp;<span class="op" id="5463798">*</span><span class="ident" id="5463799">escaper</span><span class="op" id="5463806">)</span>&nbsp;<span class="ident" id="5463808">commit</span><span class="op" id="5463814">(</span><span class="op" id="5463815">)</span>&nbsp;<span class="op" id="5463817">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463820">for</span>&nbsp;<span class="ident" id="5463824">name</span>&nbsp;<span class="op" id="5463829">:=</span>&nbsp;<span class="keyword" id="5463832">range</span>&nbsp;<span class="ident" id="5463838">e</span><span class="op" id="5463839">.</span><span class="ident" id="5463840">output</span>&nbsp;<span class="op" id="5463847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463851">e</span><span class="op" id="5463852">.</span><span class="ident" id="5463853">template</span><span class="op" id="5463861">(</span><span class="ident" id="5463862">name</span><span class="op" id="5463866">)</span><span class="op" id="5463867">.</span><span class="ident" id="5463868">Funcs</span><span class="op" id="5463873">(</span><span class="ident" id="5463874">funcMap</span><span class="op" id="5463881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463887">for</span>&nbsp;<span class="ident" id="5463891">_</span><span class="op" id="5463892">,</span>&nbsp;<span class="ident" id="5463894">t</span>&nbsp;<span class="op" id="5463896">:=</span>&nbsp;<span class="keyword" id="5463899">range</span>&nbsp;<span class="ident" id="5463905">e</span><span class="op" id="5463906">.</span><span class="ident" id="5463907">derived</span>&nbsp;<span class="op" id="5463915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463919">if</span>&nbsp;<span class="ident" id="5463922">_</span><span class="op" id="5463923">,</span>&nbsp;<span class="ident" id="5463925">err</span>&nbsp;<span class="op" id="5463929">:=</span>&nbsp;<span class="ident" id="5463932">e</span><span class="op" id="5463933">.</span><span class="ident" id="5463934">tmpl</span><span class="op" id="5463938">.</span><span class="ident" id="5463939">text</span><span class="op" id="5463943">.</span><span class="ident" id="5463944">AddParseTree</span><span class="op" id="5463956">(</span><span class="ident" id="5463957">t</span><span class="op" id="5463958">.</span><span class="ident" id="5463959">Name</span><span class="op" id="5463963">(</span><span class="op" id="5463964">)</span><span class="op" id="5463965">,</span>&nbsp;<span class="ident" id="5463967">t</span><span class="op" id="5463968">.</span><span class="ident" id="5463969">Tree</span><span class="op" id="5463973">)</span><span class="op" id="5463974">;</span>&nbsp;<span class="ident" id="5463976">err</span>&nbsp;<span class="op" id="5463980">!=</span>&nbsp;<span class="ident" id="5463983">nil</span>&nbsp;<span class="op" id="5463987">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5463992">panic</span><span class="op" id="5463997">(</span><span class="string" id="5463998">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="5464029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464039">for</span>&nbsp;<span class="ident" id="5464043">n</span><span class="op" id="5464044">,</span>&nbsp;<span class="ident" id="5464046">s</span>&nbsp;<span class="op" id="5464048">:=</span>&nbsp;<span class="keyword" id="5464051">range</span>&nbsp;<span class="ident" id="5464057">e</span><span class="op" id="5464058">.</span><span class="ident" id="5464059">actionNodeEdits</span>&nbsp;<span class="op" id="5464075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464079">ensurePipelineContains</span><span class="op" id="5464101">(</span><span class="ident" id="5464102">n</span><span class="op" id="5464103">.</span><span class="ident" id="5464104">Pipe</span><span class="op" id="5464108">,</span>&nbsp;<span class="ident" id="5464110">s</span><span class="op" id="5464111">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464117">for</span>&nbsp;<span class="ident" id="5464121">n</span><span class="op" id="5464122">,</span>&nbsp;<span class="ident" id="5464124">name</span>&nbsp;<span class="op" id="5464129">:=</span>&nbsp;<span class="keyword" id="5464132">range</span>&nbsp;<span class="ident" id="5464138">e</span><span class="op" id="5464139">.</span><span class="ident" id="5464140">templateNodeEdits</span>&nbsp;<span class="op" id="5464158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464162">n</span><span class="op" id="5464163">.</span><span class="ident" id="5464164">Name</span>&nbsp;<span class="op" id="5464169">=</span>&nbsp;<span class="ident" id="5464171">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464180">for</span>&nbsp;<span class="ident" id="5464184">n</span><span class="op" id="5464185">,</span>&nbsp;<span class="ident" id="5464187">s</span>&nbsp;<span class="op" id="5464189">:=</span>&nbsp;<span class="keyword" id="5464192">range</span>&nbsp;<span class="ident" id="5464198">e</span><span class="op" id="5464199">.</span><span class="ident" id="5464200">textNodeEdits</span>&nbsp;<span class="op" id="5464214">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464218">n</span><span class="op" id="5464219">.</span><span class="ident" id="5464220">Text</span>&nbsp;<span class="op" id="5464225">=</span>&nbsp;<span class="ident" id="5464227">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464230">}</span><br>
<span class="lineno"></span><span class="op" id="5464232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5464235">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="5464305">func</span>&nbsp;<span class="op" id="5464310">(</span><span class="ident" id="5464311">e</span>&nbsp;<span class="op" id="5464313">*</span><span class="ident" id="5464314">escaper</span><span class="op" id="5464321">)</span>&nbsp;<span class="ident" id="5464323">template</span><span class="op" id="5464331">(</span><span class="ident" id="5464332">name</span>&nbsp;<span class="builtintype" id="5464337">string</span><span class="op" id="5464343">)</span>&nbsp;<span class="op" id="5464345">*</span><span class="ident" id="5464346">template</span><span class="op" id="5464354">.</span><span class="ident" id="5464355">Template</span>&nbsp;<span class="op" id="5464364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464367">t</span>&nbsp;<span class="op" id="5464369">:=</span>&nbsp;<span class="ident" id="5464372">e</span><span class="op" id="5464373">.</span><span class="ident" id="5464374">tmpl</span><span class="op" id="5464378">.</span><span class="ident" id="5464379">text</span><span class="op" id="5464383">.</span><span class="ident" id="5464384">Lookup</span><span class="op" id="5464390">(</span><span class="ident" id="5464391">name</span><span class="op" id="5464395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464398">if</span>&nbsp;<span class="ident" id="5464401">t</span>&nbsp;<span class="op" id="5464403">==</span>&nbsp;<span class="ident" id="5464406">nil</span>&nbsp;<span class="op" id="5464410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464414">t</span>&nbsp;<span class="op" id="5464416">=</span>&nbsp;<span class="ident" id="5464418">e</span><span class="op" id="5464419">.</span><span class="ident" id="5464420">derived</span><span class="op" id="5464427">[</span><span class="ident" id="5464428">name</span><span class="op" id="5464432">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464435">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464438">return</span>&nbsp;<span class="ident" id="5464445">t</span><br>
<span class="lineno"></span><span class="op" id="5464447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5464450">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5464520">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="5464582">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5464662">func</span>&nbsp;<span class="ident" id="5464667">HTMLEscape</span><span class="op" id="5464677">(</span><span class="ident" id="5464678">w</span>&nbsp;<span class="ident" id="5464680">io</span><span class="op" id="5464682">.</span><span class="ident" id="5464683">Writer</span><span class="op" id="5464689">,</span>&nbsp;<span class="ident" id="5464691">b</span>&nbsp;<span class="op" id="5464693">[</span><span class="op" id="5464694">]</span><span class="builtintype" id="5464695">byte</span><span class="op" id="5464699">)</span>&nbsp;<span class="op" id="5464701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464704">template</span><span class="op" id="5464712">.</span><span class="ident" id="5464713">HTMLEscape</span><span class="op" id="5464723">(</span><span class="ident" id="5464724">w</span><span class="op" id="5464725">,</span>&nbsp;<span class="ident" id="5464727">b</span><span class="op" id="5464728">)</span><br>
<span class="lineno"></span><span class="op" id="5464730">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="5464733">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5464815">func</span>&nbsp;<span class="ident" id="5464820">HTMLEscapeString</span><span class="op" id="5464836">(</span><span class="ident" id="5464837">s</span>&nbsp;<span class="builtintype" id="5464839">string</span><span class="op" id="5464845">)</span>&nbsp;<span class="builtintype" id="5464847">string</span>&nbsp;<span class="op" id="5464854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464857">return</span>&nbsp;<span class="ident" id="5464864">template</span><span class="op" id="5464872">.</span><span class="ident" id="5464873">HTMLEscapeString</span><span class="op" id="5464889">(</span><span class="ident" id="5464890">s</span><span class="op" id="5464891">)</span><br>
<span class="lineno"></span><span class="op" id="5464893">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="5464896">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5464962">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5464998">func</span>&nbsp;<span class="ident" id="5465003">HTMLEscaper</span><span class="op" id="5465014">(</span><span class="ident" id="5465015">args</span>&nbsp;<span class="op" id="5465020">...</span><span class="keyword" id="5465023">interface</span><span class="op" id="5465032">{</span><span class="op" id="5465033">}</span><span class="op" id="5465034">)</span>&nbsp;<span class="builtintype" id="5465036">string</span>&nbsp;<span class="op" id="5465043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465046">return</span>&nbsp;<span class="ident" id="5465053">template</span><span class="op" id="5465061">.</span><span class="ident" id="5465062">HTMLEscaper</span><span class="op" id="5465073">(</span><span class="ident" id="5465074">args</span><span class="op" id="5465078">...</span><span class="op" id="5465081">)</span><br>
<span class="lineno">785</span><span class="op" id="5465083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5465086">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5465170">func</span>&nbsp;<span class="ident" id="5465175">JSEscape</span><span class="op" id="5465183">(</span><span class="ident" id="5465184">w</span>&nbsp;<span class="ident" id="5465186">io</span><span class="op" id="5465188">.</span><span class="ident" id="5465189">Writer</span><span class="op" id="5465195">,</span>&nbsp;<span class="ident" id="5465197">b</span>&nbsp;<span class="op" id="5465199">[</span><span class="op" id="5465200">]</span><span class="builtintype" id="5465201">byte</span><span class="op" id="5465205">)</span>&nbsp;<span class="op" id="5465207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465210">template</span><span class="op" id="5465218">.</span><span class="ident" id="5465219">JSEscape</span><span class="op" id="5465227">(</span><span class="ident" id="5465228">w</span><span class="op" id="5465229">,</span>&nbsp;<span class="ident" id="5465231">b</span><span class="op" id="5465232">)</span><br>
<span class="lineno">790</span><span class="op" id="5465234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5465237">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5465323">func</span>&nbsp;<span class="ident" id="5465328">JSEscapeString</span><span class="op" id="5465342">(</span><span class="ident" id="5465343">s</span>&nbsp;<span class="builtintype" id="5465345">string</span><span class="op" id="5465351">)</span>&nbsp;<span class="builtintype" id="5465353">string</span>&nbsp;<span class="op" id="5465360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465363">return</span>&nbsp;<span class="ident" id="5465370">template</span><span class="op" id="5465378">.</span><span class="ident" id="5465379">JSEscapeString</span><span class="op" id="5465393">(</span><span class="ident" id="5465394">s</span><span class="op" id="5465395">)</span><br>
<span class="lineno">795</span><span class="op" id="5465397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5465400">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5465470">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5465506">func</span>&nbsp;<span class="ident" id="5465511">JSEscaper</span><span class="op" id="5465520">(</span><span class="ident" id="5465521">args</span>&nbsp;<span class="op" id="5465526">...</span><span class="keyword" id="5465529">interface</span><span class="op" id="5465538">{</span><span class="op" id="5465539">}</span><span class="op" id="5465540">)</span>&nbsp;<span class="builtintype" id="5465542">string</span>&nbsp;<span class="op" id="5465549">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465552">return</span>&nbsp;<span class="ident" id="5465559">template</span><span class="op" id="5465567">.</span><span class="ident" id="5465568">JSEscaper</span><span class="op" id="5465577">(</span><span class="ident" id="5465578">args</span><span class="op" id="5465582">...</span><span class="op" id="5465585">)</span><br>
<span class="lineno"></span><span class="op" id="5465587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5465590">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5465668">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="5465734">func</span>&nbsp;<span class="ident" id="5465739">URLQueryEscaper</span><span class="op" id="5465754">(</span><span class="ident" id="5465755">args</span>&nbsp;<span class="op" id="5465760">...</span><span class="keyword" id="5465763">interface</span><span class="op" id="5465772">{</span><span class="op" id="5465773">}</span><span class="op" id="5465774">)</span>&nbsp;<span class="builtintype" id="5465776">string</span>&nbsp;<span class="op" id="5465783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465786">return</span>&nbsp;<span class="ident" id="5465793">template</span><span class="op" id="5465801">.</span><span class="ident" id="5465802">URLQueryEscaper</span><span class="op" id="5465817">(</span><span class="ident" id="5465818">args</span><span class="op" id="5465822">...</span><span class="op" id="5465825">)</span><br>
<span class="lineno"></span><span class="op" id="5465827">}</span>
</div>
</body>
</html>
