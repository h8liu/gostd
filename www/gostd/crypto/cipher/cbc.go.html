<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html" class="current">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4362657">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4362712">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4362766">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4362817">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4362855">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="4362929">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="4363002">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4363036">package</span>&nbsp;<span class="ident" id="4363044">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4363052">type</span>&nbsp;<span class="ident" id="4363057">cbc</span>&nbsp;<span class="keyword" id="4363061">struct</span>&nbsp;<span class="op" id="4363068">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363071">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363081">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363088">blockSize</span>&nbsp;<span class="builtintype" id="4363098">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363103">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363113">[</span><span class="op" id="4363114">]</span><span class="builtintype" id="4363115">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363121">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363131">[</span><span class="op" id="4363132">]</span><span class="builtintype" id="4363133">byte</span><br>
<span class="lineno"></span><span class="op" id="4363138">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4363141">func</span>&nbsp;<span class="ident" id="4363146">newCBC</span><span class="op" id="4363152">(</span><span class="ident" id="4363153">b</span>&nbsp;<span class="ident" id="4363155">Block</span><span class="op" id="4363160">,</span>&nbsp;<span class="ident" id="4363162">iv</span>&nbsp;<span class="op" id="4363165">[</span><span class="op" id="4363166">]</span><span class="builtintype" id="4363167">byte</span><span class="op" id="4363171">)</span>&nbsp;<span class="op" id="4363173">*</span><span class="ident" id="4363174">cbc</span>&nbsp;<span class="op" id="4363178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4363181">return</span>&nbsp;<span class="op" id="4363188">&amp;</span><span class="ident" id="4363189">cbc</span><span class="op" id="4363192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363196">b</span><span class="op" id="4363197">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363207">b</span><span class="op" id="4363208">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363212">blockSize</span><span class="op" id="4363221">:</span>&nbsp;<span class="ident" id="4363223">b</span><span class="op" id="4363224">.</span><span class="ident" id="4363225">BlockSize</span><span class="op" id="4363234">(</span><span class="op" id="4363235">)</span><span class="op" id="4363236">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363240">iv</span><span class="op" id="4363242">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363251">dup</span><span class="op" id="4363254">(</span><span class="ident" id="4363255">iv</span><span class="op" id="4363257">)</span><span class="op" id="4363258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363262">tmp</span><span class="op" id="4363265">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4363273">make</span><span class="op" id="4363277">(</span><span class="op" id="4363278">[</span><span class="op" id="4363279">]</span><span class="builtintype" id="4363280">byte</span><span class="op" id="4363284">,</span>&nbsp;<span class="ident" id="4363286">b</span><span class="op" id="4363287">.</span><span class="ident" id="4363288">BlockSize</span><span class="op" id="4363297">(</span><span class="op" id="4363298">)</span><span class="op" id="4363299">)</span><span class="op" id="4363300">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4363303">}</span><br>
<span class="lineno"></span><span class="op" id="4363305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="4363308">type</span>&nbsp;<span class="ident" id="4363313">cbcEncrypter</span>&nbsp;<span class="ident" id="4363326">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4363331">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="4363410">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4363483">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="4363506">func</span>&nbsp;<span class="ident" id="4363511">NewCBCEncrypter</span><span class="op" id="4363526">(</span><span class="ident" id="4363527">b</span>&nbsp;<span class="ident" id="4363529">Block</span><span class="op" id="4363534">,</span>&nbsp;<span class="ident" id="4363536">iv</span>&nbsp;<span class="op" id="4363539">[</span><span class="op" id="4363540">]</span><span class="builtintype" id="4363541">byte</span><span class="op" id="4363545">)</span>&nbsp;<span class="ident" id="4363547">BlockMode</span>&nbsp;<span class="op" id="4363557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4363560">if</span>&nbsp;<span class="builtinfunc" id="4363563">len</span><span class="op" id="4363566">(</span><span class="ident" id="4363567">iv</span><span class="op" id="4363569">)</span>&nbsp;<span class="op" id="4363571">!=</span>&nbsp;<span class="ident" id="4363574">b</span><span class="op" id="4363575">.</span><span class="ident" id="4363576">BlockSize</span><span class="op" id="4363585">(</span><span class="op" id="4363586">)</span>&nbsp;<span class="op" id="4363588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4363592">panic</span><span class="op" id="4363597">(</span><span class="string" id="4363598">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="4363655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4363658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4363661">return</span>&nbsp;<span class="op" id="4363668">(</span><span class="op" id="4363669">*</span><span class="ident" id="4363670">cbcEncrypter</span><span class="op" id="4363682">)</span><span class="op" id="4363683">(</span><span class="ident" id="4363684">newCBC</span><span class="op" id="4363690">(</span><span class="ident" id="4363691">b</span><span class="op" id="4363692">,</span>&nbsp;<span class="ident" id="4363694">iv</span><span class="op" id="4363696">)</span><span class="op" id="4363697">)</span><br>
<span class="lineno">40</span><span class="op" id="4363699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4363702">func</span>&nbsp;<span class="op" id="4363707">(</span><span class="ident" id="4363708">x</span>&nbsp;<span class="op" id="4363710">*</span><span class="ident" id="4363711">cbcEncrypter</span><span class="op" id="4363723">)</span>&nbsp;<span class="ident" id="4363725">BlockSize</span><span class="op" id="4363734">(</span><span class="op" id="4363735">)</span>&nbsp;<span class="builtintype" id="4363737">int</span>&nbsp;<span class="op" id="4363741">{</span>&nbsp;<span class="keyword" id="4363743">return</span>&nbsp;<span class="ident" id="4363750">x</span><span class="op" id="4363751">.</span><span class="ident" id="4363752">blockSize</span>&nbsp;<span class="op" id="4363762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4363765">func</span>&nbsp;<span class="op" id="4363770">(</span><span class="ident" id="4363771">x</span>&nbsp;<span class="op" id="4363773">*</span><span class="ident" id="4363774">cbcEncrypter</span><span class="op" id="4363786">)</span>&nbsp;<span class="ident" id="4363788">CryptBlocks</span><span class="op" id="4363799">(</span><span class="ident" id="4363800">dst</span><span class="op" id="4363803">,</span>&nbsp;<span class="ident" id="4363805">src</span>&nbsp;<span class="op" id="4363809">[</span><span class="op" id="4363810">]</span><span class="builtintype" id="4363811">byte</span><span class="op" id="4363815">)</span>&nbsp;<span class="op" id="4363817">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4363820">if</span>&nbsp;<span class="builtinfunc" id="4363823">len</span><span class="op" id="4363826">(</span><span class="ident" id="4363827">src</span><span class="op" id="4363830">)</span><span class="op" id="4363831">%</span><span class="ident" id="4363832">x</span><span class="op" id="4363833">.</span><span class="ident" id="4363834">blockSize</span>&nbsp;<span class="op" id="4363844">!=</span>&nbsp;<span class="num" id="4363847">0</span>&nbsp;<span class="op" id="4363849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4363853">panic</span><span class="op" id="4363858">(</span><span class="string" id="4363859">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="4363897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4363900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4363903">if</span>&nbsp;<span class="builtinfunc" id="4363906">len</span><span class="op" id="4363909">(</span><span class="ident" id="4363910">dst</span><span class="op" id="4363913">)</span>&nbsp;<span class="op" id="4363915">&lt;</span>&nbsp;<span class="builtinfunc" id="4363917">len</span><span class="op" id="4363920">(</span><span class="ident" id="4363921">src</span><span class="op" id="4363924">)</span>&nbsp;<span class="op" id="4363926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4363930">panic</span><span class="op" id="4363935">(</span><span class="string" id="4363936">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="4363978">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4363981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4363985">iv</span>&nbsp;<span class="op" id="4363988">:=</span>&nbsp;<span class="ident" id="4363991">x</span><span class="op" id="4363992">.</span><span class="ident" id="4363993">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4363998">for</span>&nbsp;<span class="builtinfunc" id="4364002">len</span><span class="op" id="4364005">(</span><span class="ident" id="4364006">src</span><span class="op" id="4364009">)</span>&nbsp;<span class="op" id="4364011">&gt;</span>&nbsp;<span class="num" id="4364013">0</span>&nbsp;<span class="op" id="4364015">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4364019">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4364069">xorBytes</span><span class="op" id="4364077">(</span><span class="ident" id="4364078">dst</span><span class="op" id="4364081">[</span><span class="op" id="4364082">:</span><span class="ident" id="4364083">x</span><span class="op" id="4364084">.</span><span class="ident" id="4364085">blockSize</span><span class="op" id="4364094">]</span><span class="op" id="4364095">,</span>&nbsp;<span class="ident" id="4364097">src</span><span class="op" id="4364100">[</span><span class="op" id="4364101">:</span><span class="ident" id="4364102">x</span><span class="op" id="4364103">.</span><span class="ident" id="4364104">blockSize</span><span class="op" id="4364113">]</span><span class="op" id="4364114">,</span>&nbsp;<span class="ident" id="4364116">iv</span><span class="op" id="4364118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4364122">x</span><span class="op" id="4364123">.</span><span class="ident" id="4364124">b</span><span class="op" id="4364125">.</span><span class="ident" id="4364126">Encrypt</span><span class="op" id="4364133">(</span><span class="ident" id="4364134">dst</span><span class="op" id="4364137">[</span><span class="op" id="4364138">:</span><span class="ident" id="4364139">x</span><span class="op" id="4364140">.</span><span class="ident" id="4364141">blockSize</span><span class="op" id="4364150">]</span><span class="op" id="4364151">,</span>&nbsp;<span class="ident" id="4364153">dst</span><span class="op" id="4364156">[</span><span class="op" id="4364157">:</span><span class="ident" id="4364158">x</span><span class="op" id="4364159">.</span><span class="ident" id="4364160">blockSize</span><span class="op" id="4364169">]</span><span class="op" id="4364170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4364175">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4364235">iv</span>&nbsp;<span class="op" id="4364238">=</span>&nbsp;<span class="ident" id="4364240">dst</span><span class="op" id="4364243">[</span><span class="op" id="4364244">:</span><span class="ident" id="4364245">x</span><span class="op" id="4364246">.</span><span class="ident" id="4364247">blockSize</span><span class="op" id="4364256">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4364260">src</span>&nbsp;<span class="op" id="4364264">=</span>&nbsp;<span class="ident" id="4364266">src</span><span class="op" id="4364269">[</span><span class="ident" id="4364270">x</span><span class="op" id="4364271">.</span><span class="ident" id="4364272">blockSize</span><span class="op" id="4364281">:</span><span class="op" id="4364282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4364286">dst</span>&nbsp;<span class="op" id="4364290">=</span>&nbsp;<span class="ident" id="4364292">dst</span><span class="op" id="4364295">[</span><span class="ident" id="4364296">x</span><span class="op" id="4364297">.</span><span class="ident" id="4364298">blockSize</span><span class="op" id="4364307">:</span><span class="op" id="4364308">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4364311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4364315">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4364362">copy</span><span class="op" id="4364366">(</span><span class="ident" id="4364367">x</span><span class="op" id="4364368">.</span><span class="ident" id="4364369">iv</span><span class="op" id="4364371">,</span>&nbsp;<span class="ident" id="4364373">iv</span><span class="op" id="4364375">)</span><br>
<span class="lineno"></span><span class="op" id="4364377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4364380">func</span>&nbsp;<span class="op" id="4364385">(</span><span class="ident" id="4364386">x</span>&nbsp;<span class="op" id="4364388">*</span><span class="ident" id="4364389">cbcEncrypter</span><span class="op" id="4364401">)</span>&nbsp;<span class="ident" id="4364403">SetIV</span><span class="op" id="4364408">(</span><span class="ident" id="4364409">iv</span>&nbsp;<span class="op" id="4364412">[</span><span class="op" id="4364413">]</span><span class="builtintype" id="4364414">byte</span><span class="op" id="4364418">)</span>&nbsp;<span class="op" id="4364420">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4364423">if</span>&nbsp;<span class="builtinfunc" id="4364426">len</span><span class="op" id="4364429">(</span><span class="ident" id="4364430">iv</span><span class="op" id="4364432">)</span>&nbsp;<span class="op" id="4364434">!=</span>&nbsp;<span class="builtinfunc" id="4364437">len</span><span class="op" id="4364440">(</span><span class="ident" id="4364441">x</span><span class="op" id="4364442">.</span><span class="ident" id="4364443">iv</span><span class="op" id="4364445">)</span>&nbsp;<span class="op" id="4364447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4364451">panic</span><span class="op" id="4364456">(</span><span class="string" id="4364457">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="4364486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4364489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4364492">copy</span><span class="op" id="4364496">(</span><span class="ident" id="4364497">x</span><span class="op" id="4364498">.</span><span class="ident" id="4364499">iv</span><span class="op" id="4364501">,</span>&nbsp;<span class="ident" id="4364503">iv</span><span class="op" id="4364505">)</span><br>
<span class="lineno"></span><span class="op" id="4364507">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="4364510">type</span>&nbsp;<span class="ident" id="4364515">cbcDecrypter</span>&nbsp;<span class="ident" id="4364528">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4364533">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="4364612">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="4364685">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4364755">func</span>&nbsp;<span class="ident" id="4364760">NewCBCDecrypter</span><span class="op" id="4364775">(</span><span class="ident" id="4364776">b</span>&nbsp;<span class="ident" id="4364778">Block</span><span class="op" id="4364783">,</span>&nbsp;<span class="ident" id="4364785">iv</span>&nbsp;<span class="op" id="4364788">[</span><span class="op" id="4364789">]</span><span class="builtintype" id="4364790">byte</span><span class="op" id="4364794">)</span>&nbsp;<span class="ident" id="4364796">BlockMode</span>&nbsp;<span class="op" id="4364806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4364809">if</span>&nbsp;<span class="builtinfunc" id="4364812">len</span><span class="op" id="4364815">(</span><span class="ident" id="4364816">iv</span><span class="op" id="4364818">)</span>&nbsp;<span class="op" id="4364820">!=</span>&nbsp;<span class="ident" id="4364823">b</span><span class="op" id="4364824">.</span><span class="ident" id="4364825">BlockSize</span><span class="op" id="4364834">(</span><span class="op" id="4364835">)</span>&nbsp;<span class="op" id="4364837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4364841">panic</span><span class="op" id="4364846">(</span><span class="string" id="4364847">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="4364904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4364907">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4364910">return</span>&nbsp;<span class="op" id="4364917">(</span><span class="op" id="4364918">*</span><span class="ident" id="4364919">cbcDecrypter</span><span class="op" id="4364931">)</span><span class="op" id="4364932">(</span><span class="ident" id="4364933">newCBC</span><span class="op" id="4364939">(</span><span class="ident" id="4364940">b</span><span class="op" id="4364941">,</span>&nbsp;<span class="ident" id="4364943">iv</span><span class="op" id="4364945">)</span><span class="op" id="4364946">)</span><br>
<span class="lineno"></span><span class="op" id="4364948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4364951">func</span>&nbsp;<span class="op" id="4364956">(</span><span class="ident" id="4364957">x</span>&nbsp;<span class="op" id="4364959">*</span><span class="ident" id="4364960">cbcDecrypter</span><span class="op" id="4364972">)</span>&nbsp;<span class="ident" id="4364974">BlockSize</span><span class="op" id="4364983">(</span><span class="op" id="4364984">)</span>&nbsp;<span class="builtintype" id="4364986">int</span>&nbsp;<span class="op" id="4364990">{</span>&nbsp;<span class="keyword" id="4364992">return</span>&nbsp;<span class="ident" id="4364999">x</span><span class="op" id="4365000">.</span><span class="ident" id="4365001">blockSize</span>&nbsp;<span class="op" id="4365011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="4365014">func</span>&nbsp;<span class="op" id="4365019">(</span><span class="ident" id="4365020">x</span>&nbsp;<span class="op" id="4365022">*</span><span class="ident" id="4365023">cbcDecrypter</span><span class="op" id="4365035">)</span>&nbsp;<span class="ident" id="4365037">CryptBlocks</span><span class="op" id="4365048">(</span><span class="ident" id="4365049">dst</span><span class="op" id="4365052">,</span>&nbsp;<span class="ident" id="4365054">src</span>&nbsp;<span class="op" id="4365058">[</span><span class="op" id="4365059">]</span><span class="builtintype" id="4365060">byte</span><span class="op" id="4365064">)</span>&nbsp;<span class="op" id="4365066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4365069">if</span>&nbsp;<span class="builtinfunc" id="4365072">len</span><span class="op" id="4365075">(</span><span class="ident" id="4365076">src</span><span class="op" id="4365079">)</span><span class="op" id="4365080">%</span><span class="ident" id="4365081">x</span><span class="op" id="4365082">.</span><span class="ident" id="4365083">blockSize</span>&nbsp;<span class="op" id="4365093">!=</span>&nbsp;<span class="num" id="4365096">0</span>&nbsp;<span class="op" id="4365098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4365102">panic</span><span class="op" id="4365107">(</span><span class="string" id="4365108">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="4365146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4365149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4365152">if</span>&nbsp;<span class="builtinfunc" id="4365155">len</span><span class="op" id="4365158">(</span><span class="ident" id="4365159">dst</span><span class="op" id="4365162">)</span>&nbsp;<span class="op" id="4365164">&lt;</span>&nbsp;<span class="builtinfunc" id="4365166">len</span><span class="op" id="4365169">(</span><span class="ident" id="4365170">src</span><span class="op" id="4365173">)</span>&nbsp;<span class="op" id="4365175">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4365179">panic</span><span class="op" id="4365184">(</span><span class="string" id="4365185">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="4365227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4365230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4365233">if</span>&nbsp;<span class="builtinfunc" id="4365236">len</span><span class="op" id="4365239">(</span><span class="ident" id="4365240">src</span><span class="op" id="4365243">)</span>&nbsp;<span class="op" id="4365245">==</span>&nbsp;<span class="num" id="4365248">0</span>&nbsp;<span class="op" id="4365250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4365254">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4365262">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4365266">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4365367">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365440">end</span>&nbsp;<span class="op" id="4365444">:=</span>&nbsp;<span class="builtinfunc" id="4365447">len</span><span class="op" id="4365450">(</span><span class="ident" id="4365451">src</span><span class="op" id="4365454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365457">start</span>&nbsp;<span class="op" id="4365463">:=</span>&nbsp;<span class="ident" id="4365466">end</span>&nbsp;<span class="op" id="4365470">-</span>&nbsp;<span class="ident" id="4365472">x</span><span class="op" id="4365473">.</span><span class="ident" id="4365474">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365485">prev</span>&nbsp;<span class="op" id="4365490">:=</span>&nbsp;<span class="ident" id="4365493">start</span>&nbsp;<span class="op" id="4365499">-</span>&nbsp;<span class="ident" id="4365501">x</span><span class="op" id="4365502">.</span><span class="ident" id="4365503">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4365515">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4365583">copy</span><span class="op" id="4365587">(</span><span class="ident" id="4365588">x</span><span class="op" id="4365589">.</span><span class="ident" id="4365590">tmp</span><span class="op" id="4365593">,</span>&nbsp;<span class="ident" id="4365595">src</span><span class="op" id="4365598">[</span><span class="ident" id="4365599">start</span><span class="op" id="4365604">:</span><span class="ident" id="4365605">end</span><span class="op" id="4365608">]</span><span class="op" id="4365609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4365613">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4365652">for</span>&nbsp;<span class="ident" id="4365656">start</span>&nbsp;<span class="op" id="4365662">&gt;</span>&nbsp;<span class="num" id="4365664">0</span>&nbsp;<span class="op" id="4365666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365670">x</span><span class="op" id="4365671">.</span><span class="ident" id="4365672">b</span><span class="op" id="4365673">.</span><span class="ident" id="4365674">Decrypt</span><span class="op" id="4365681">(</span><span class="ident" id="4365682">dst</span><span class="op" id="4365685">[</span><span class="ident" id="4365686">start</span><span class="op" id="4365691">:</span><span class="ident" id="4365692">end</span><span class="op" id="4365695">]</span><span class="op" id="4365696">,</span>&nbsp;<span class="ident" id="4365698">src</span><span class="op" id="4365701">[</span><span class="ident" id="4365702">start</span><span class="op" id="4365707">:</span><span class="ident" id="4365708">end</span><span class="op" id="4365711">]</span><span class="op" id="4365712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365716">xorBytes</span><span class="op" id="4365724">(</span><span class="ident" id="4365725">dst</span><span class="op" id="4365728">[</span><span class="ident" id="4365729">start</span><span class="op" id="4365734">:</span><span class="ident" id="4365735">end</span><span class="op" id="4365738">]</span><span class="op" id="4365739">,</span>&nbsp;<span class="ident" id="4365741">dst</span><span class="op" id="4365744">[</span><span class="ident" id="4365745">start</span><span class="op" id="4365750">:</span><span class="ident" id="4365751">end</span><span class="op" id="4365754">]</span><span class="op" id="4365755">,</span>&nbsp;<span class="ident" id="4365757">src</span><span class="op" id="4365760">[</span><span class="ident" id="4365761">prev</span><span class="op" id="4365765">:</span><span class="ident" id="4365766">start</span><span class="op" id="4365771">]</span><span class="op" id="4365772">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365777">end</span>&nbsp;<span class="op" id="4365781">=</span>&nbsp;<span class="ident" id="4365783">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365791">start</span>&nbsp;<span class="op" id="4365797">=</span>&nbsp;<span class="ident" id="4365799">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365806">prev</span>&nbsp;<span class="op" id="4365811">-=</span>&nbsp;<span class="ident" id="4365814">x</span><span class="op" id="4365815">.</span><span class="ident" id="4365816">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4365827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4365831">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365892">x</span><span class="op" id="4365893">.</span><span class="ident" id="4365894">b</span><span class="op" id="4365895">.</span><span class="ident" id="4365896">Decrypt</span><span class="op" id="4365903">(</span><span class="ident" id="4365904">dst</span><span class="op" id="4365907">[</span><span class="ident" id="4365908">start</span><span class="op" id="4365913">:</span><span class="ident" id="4365914">end</span><span class="op" id="4365917">]</span><span class="op" id="4365918">,</span>&nbsp;<span class="ident" id="4365920">src</span><span class="op" id="4365923">[</span><span class="ident" id="4365924">start</span><span class="op" id="4365929">:</span><span class="ident" id="4365930">end</span><span class="op" id="4365933">]</span><span class="op" id="4365934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4365937">xorBytes</span><span class="op" id="4365945">(</span><span class="ident" id="4365946">dst</span><span class="op" id="4365949">[</span><span class="ident" id="4365950">start</span><span class="op" id="4365955">:</span><span class="ident" id="4365956">end</span><span class="op" id="4365959">]</span><span class="op" id="4365960">,</span>&nbsp;<span class="ident" id="4365962">dst</span><span class="op" id="4365965">[</span><span class="ident" id="4365966">start</span><span class="op" id="4365971">:</span><span class="ident" id="4365972">end</span><span class="op" id="4365975">]</span><span class="op" id="4365976">,</span>&nbsp;<span class="ident" id="4365978">x</span><span class="op" id="4365979">.</span><span class="ident" id="4365980">iv</span><span class="op" id="4365982">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4365986">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4366043">x</span><span class="op" id="4366044">.</span><span class="ident" id="4366045">iv</span><span class="op" id="4366047">,</span>&nbsp;<span class="ident" id="4366049">x</span><span class="op" id="4366050">.</span><span class="ident" id="4366051">tmp</span>&nbsp;<span class="op" id="4366055">=</span>&nbsp;<span class="ident" id="4366057">x</span><span class="op" id="4366058">.</span><span class="ident" id="4366059">tmp</span><span class="op" id="4366062">,</span>&nbsp;<span class="ident" id="4366064">x</span><span class="op" id="4366065">.</span><span class="ident" id="4366066">iv</span><br>
<span class="lineno"></span><span class="op" id="4366069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4366072">func</span>&nbsp;<span class="op" id="4366077">(</span><span class="ident" id="4366078">x</span>&nbsp;<span class="op" id="4366080">*</span><span class="ident" id="4366081">cbcDecrypter</span><span class="op" id="4366093">)</span>&nbsp;<span class="ident" id="4366095">SetIV</span><span class="op" id="4366100">(</span><span class="ident" id="4366101">iv</span>&nbsp;<span class="op" id="4366104">[</span><span class="op" id="4366105">]</span><span class="builtintype" id="4366106">byte</span><span class="op" id="4366110">)</span>&nbsp;<span class="op" id="4366112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4366115">if</span>&nbsp;<span class="builtinfunc" id="4366118">len</span><span class="op" id="4366121">(</span><span class="ident" id="4366122">iv</span><span class="op" id="4366124">)</span>&nbsp;<span class="op" id="4366126">!=</span>&nbsp;<span class="builtinfunc" id="4366129">len</span><span class="op" id="4366132">(</span><span class="ident" id="4366133">x</span><span class="op" id="4366134">.</span><span class="ident" id="4366135">iv</span><span class="op" id="4366137">)</span>&nbsp;<span class="op" id="4366139">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4366143">panic</span><span class="op" id="4366148">(</span><span class="string" id="4366149">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="4366178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4366181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4366184">copy</span><span class="op" id="4366188">(</span><span class="ident" id="4366189">x</span><span class="op" id="4366190">.</span><span class="ident" id="4366191">iv</span><span class="op" id="4366193">,</span>&nbsp;<span class="ident" id="4366195">iv</span><span class="op" id="4366197">)</span><br>
<span class="lineno"></span><span class="op" id="4366199">}</span>
</div>
</body>
</html>
