<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html" class="current">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7089500">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7089555">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7089609">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7089660">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7089693">package</span>&nbsp;<span class="ident" id="7089701">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7089709">import</span>&nbsp;<span class="op" id="7089716">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089719">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089728">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089735">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089741">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089754">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089761">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089768">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089774">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089782">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7089793">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="7089800">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7089803">func</span>&nbsp;<span class="ident" id="7089808">runPktSyslog</span><span class="op" id="7089820">(</span><span class="ident" id="7089821">c</span>&nbsp;<span class="ident" id="7089823">net</span><span class="op" id="7089826">.</span><span class="ident" id="7089827">PacketConn</span><span class="op" id="7089837">,</span>&nbsp;<span class="ident" id="7089839">done</span>&nbsp;<span class="keyword" id="7089844">chan</span><span class="op" id="7089848">&lt;-</span>&nbsp;<span class="builtintype" id="7089851">string</span><span class="op" id="7089857">)</span>&nbsp;<span class="op" id="7089859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7089862">var</span>&nbsp;<span class="ident" id="7089866">buf</span>&nbsp;<span class="op" id="7089870">[</span><span class="num" id="7089871">4096</span><span class="op" id="7089875">]</span><span class="builtintype" id="7089876">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7089882">var</span>&nbsp;<span class="ident" id="7089886">rcvd</span>&nbsp;<span class="builtintype" id="7089891">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7089899">ct</span>&nbsp;<span class="op" id="7089902">:=</span>&nbsp;<span class="num" id="7089905">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7089908">for</span>&nbsp;<span class="op" id="7089912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7089916">var</span>&nbsp;<span class="ident" id="7089920">n</span>&nbsp;<span class="builtintype" id="7089922">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7089928">var</span>&nbsp;<span class="ident" id="7089932">err</span>&nbsp;<span class="builtintype" id="7089936">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7089945">c</span><span class="op" id="7089946">.</span><span class="ident" id="7089947">SetReadDeadline</span><span class="op" id="7089962">(</span><span class="ident" id="7089963">time</span><span class="op" id="7089967">.</span><span class="ident" id="7089968">Now</span><span class="op" id="7089971">(</span><span class="op" id="7089972">)</span><span class="op" id="7089973">.</span><span class="ident" id="7089974">Add</span><span class="op" id="7089977">(</span><span class="num" id="7089978">100</span>&nbsp;<span class="op" id="7089982">*</span>&nbsp;<span class="ident" id="7089984">time</span><span class="op" id="7089988">.</span><span class="ident" id="7089989">Millisecond</span><span class="op" id="7090000">)</span><span class="op" id="7090001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090005">n</span><span class="op" id="7090006">,</span>&nbsp;<span class="ident" id="7090008">_</span><span class="op" id="7090009">,</span>&nbsp;<span class="ident" id="7090011">err</span>&nbsp;<span class="op" id="7090015">=</span>&nbsp;<span class="ident" id="7090017">c</span><span class="op" id="7090018">.</span><span class="ident" id="7090019">ReadFrom</span><span class="op" id="7090027">(</span><span class="ident" id="7090028">buf</span><span class="op" id="7090031">[</span><span class="op" id="7090032">:</span><span class="op" id="7090033">]</span><span class="op" id="7090034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090038">rcvd</span>&nbsp;<span class="op" id="7090043">+=</span>&nbsp;<span class="builtintype" id="7090046">string</span><span class="op" id="7090052">(</span><span class="ident" id="7090053">buf</span><span class="op" id="7090056">[</span><span class="op" id="7090057">:</span><span class="ident" id="7090058">n</span><span class="op" id="7090059">]</span><span class="op" id="7090060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090064">if</span>&nbsp;<span class="ident" id="7090067">err</span>&nbsp;<span class="op" id="7090071">!=</span>&nbsp;<span class="builtintype" id="7090074">nil</span>&nbsp;<span class="op" id="7090078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090083">if</span>&nbsp;<span class="ident" id="7090086">oe</span><span class="op" id="7090088">,</span>&nbsp;<span class="ident" id="7090090">ok</span>&nbsp;<span class="op" id="7090093">:=</span>&nbsp;<span class="ident" id="7090096">err</span><span class="op" id="7090099">.</span><span class="op" id="7090100">(</span><span class="op" id="7090101">*</span><span class="ident" id="7090102">net</span><span class="op" id="7090105">.</span><span class="ident" id="7090106">OpError</span><span class="op" id="7090113">)</span><span class="op" id="7090114">;</span>&nbsp;<span class="ident" id="7090116">ok</span>&nbsp;<span class="op" id="7090119">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090125">if</span>&nbsp;<span class="ident" id="7090128">ct</span>&nbsp;<span class="op" id="7090131">&lt;</span>&nbsp;<span class="num" id="7090133">3</span>&nbsp;<span class="op" id="7090135">&amp;&amp;</span>&nbsp;<span class="ident" id="7090138">oe</span><span class="op" id="7090140">.</span><span class="ident" id="7090141">Temporary</span><span class="op" id="7090150">(</span><span class="op" id="7090151">)</span>&nbsp;<span class="op" id="7090153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090160">ct</span><span class="op" id="7090162">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090170">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090188">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090193">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090207">c</span><span class="op" id="7090208">.</span><span class="ident" id="7090209">Close</span><span class="op" id="7090214">(</span><span class="op" id="7090215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090218">done</span>&nbsp;<span class="op" id="7090223">&lt;-</span>&nbsp;<span class="ident" id="7090226">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="7090231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7090234">var</span>&nbsp;<span class="ident" id="7090238">crashy</span>&nbsp;<span class="op" id="7090245">=</span>&nbsp;<span class="builtintype" id="7090247">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7090254">func</span>&nbsp;<span class="ident" id="7090259">runStreamSyslog</span><span class="op" id="7090274">(</span><span class="ident" id="7090275">l</span>&nbsp;<span class="ident" id="7090277">net</span><span class="op" id="7090280">.</span><span class="ident" id="7090281">Listener</span><span class="op" id="7090289">,</span>&nbsp;<span class="ident" id="7090291">done</span>&nbsp;<span class="keyword" id="7090296">chan</span><span class="op" id="7090300">&lt;-</span>&nbsp;<span class="builtintype" id="7090303">string</span><span class="op" id="7090309">,</span>&nbsp;<span class="ident" id="7090311">wg</span>&nbsp;<span class="op" id="7090314">*</span><span class="ident" id="7090315">sync</span><span class="op" id="7090319">.</span><span class="ident" id="7090320">WaitGroup</span><span class="op" id="7090329">)</span>&nbsp;<span class="op" id="7090331">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090334">for</span>&nbsp;<span class="op" id="7090338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090342">var</span>&nbsp;<span class="ident" id="7090346">c</span>&nbsp;<span class="ident" id="7090348">net</span><span class="op" id="7090351">.</span><span class="ident" id="7090352">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090359">var</span>&nbsp;<span class="ident" id="7090363">err</span>&nbsp;<span class="builtintype" id="7090367">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090375">if</span>&nbsp;<span class="ident" id="7090378">c</span><span class="op" id="7090379">,</span>&nbsp;<span class="ident" id="7090381">err</span>&nbsp;<span class="op" id="7090385">=</span>&nbsp;<span class="ident" id="7090387">l</span><span class="op" id="7090388">.</span><span class="ident" id="7090389">Accept</span><span class="op" id="7090395">(</span><span class="op" id="7090396">)</span><span class="op" id="7090397">;</span>&nbsp;<span class="ident" id="7090399">err</span>&nbsp;<span class="op" id="7090403">!=</span>&nbsp;<span class="builtintype" id="7090406">nil</span>&nbsp;<span class="op" id="7090410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090415">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090428">wg</span><span class="op" id="7090430">.</span><span class="ident" id="7090431">Add</span><span class="op" id="7090434">(</span><span class="num" id="7090435">1</span><span class="op" id="7090436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090440">go</span>&nbsp;<span class="keyword" id="7090443">func</span><span class="op" id="7090447">(</span><span class="ident" id="7090448">c</span>&nbsp;<span class="ident" id="7090450">net</span><span class="op" id="7090453">.</span><span class="ident" id="7090454">Conn</span><span class="op" id="7090458">)</span>&nbsp;<span class="op" id="7090460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090465">defer</span>&nbsp;<span class="ident" id="7090471">wg</span><span class="op" id="7090473">.</span><span class="ident" id="7090474">Done</span><span class="op" id="7090478">(</span><span class="op" id="7090479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090484">c</span><span class="op" id="7090485">.</span><span class="ident" id="7090486">SetReadDeadline</span><span class="op" id="7090501">(</span><span class="ident" id="7090502">time</span><span class="op" id="7090506">.</span><span class="ident" id="7090507">Now</span><span class="op" id="7090510">(</span><span class="op" id="7090511">)</span><span class="op" id="7090512">.</span><span class="ident" id="7090513">Add</span><span class="op" id="7090516">(</span><span class="num" id="7090517">5</span>&nbsp;<span class="op" id="7090519">*</span>&nbsp;<span class="ident" id="7090521">time</span><span class="op" id="7090525">.</span><span class="ident" id="7090526">Second</span><span class="op" id="7090532">)</span><span class="op" id="7090533">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090538">b</span>&nbsp;<span class="op" id="7090540">:=</span>&nbsp;<span class="ident" id="7090543">bufio</span><span class="op" id="7090548">.</span><span class="ident" id="7090549">NewReader</span><span class="op" id="7090558">(</span><span class="ident" id="7090559">c</span><span class="op" id="7090560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090565">for</span>&nbsp;<span class="ident" id="7090569">ct</span>&nbsp;<span class="op" id="7090572">:=</span>&nbsp;<span class="num" id="7090575">1</span><span class="op" id="7090576">;</span>&nbsp;<span class="op" id="7090578">!</span><span class="ident" id="7090579">crashy</span>&nbsp;<span class="op" id="7090586">||</span>&nbsp;<span class="ident" id="7090589">ct</span><span class="op" id="7090591">&amp;</span><span class="num" id="7090592">7</span>&nbsp;<span class="op" id="7090594">!=</span>&nbsp;<span class="num" id="7090597">0</span><span class="op" id="7090598">;</span>&nbsp;<span class="ident" id="7090600">ct</span><span class="op" id="7090602">++</span>&nbsp;<span class="op" id="7090605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090611">s</span><span class="op" id="7090612">,</span>&nbsp;<span class="ident" id="7090614">err</span>&nbsp;<span class="op" id="7090618">:=</span>&nbsp;<span class="ident" id="7090621">b</span><span class="op" id="7090622">.</span><span class="ident" id="7090623">ReadString</span><span class="op" id="7090633">(</span><span class="string" id="7090634">&#39;\n&#39;</span><span class="op" id="7090638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090644">if</span>&nbsp;<span class="ident" id="7090647">err</span>&nbsp;<span class="op" id="7090651">!=</span>&nbsp;<span class="builtintype" id="7090654">nil</span>&nbsp;<span class="op" id="7090658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090665">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090681">done</span>&nbsp;<span class="op" id="7090686">&lt;-</span>&nbsp;<span class="ident" id="7090689">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090699">c</span><span class="op" id="7090700">.</span><span class="ident" id="7090701">Close</span><span class="op" id="7090706">(</span><span class="op" id="7090707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090711">}</span><span class="op" id="7090712">(</span><span class="ident" id="7090713">c</span><span class="op" id="7090714">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090717">}</span><br>
<span class="lineno"></span><span class="op" id="7090719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7090722">func</span>&nbsp;<span class="ident" id="7090727">startServer</span><span class="op" id="7090738">(</span><span class="ident" id="7090739">n</span><span class="op" id="7090740">,</span>&nbsp;<span class="ident" id="7090742">la</span>&nbsp;<span class="builtintype" id="7090745">string</span><span class="op" id="7090751">,</span>&nbsp;<span class="ident" id="7090753">done</span>&nbsp;<span class="keyword" id="7090758">chan</span><span class="op" id="7090762">&lt;-</span>&nbsp;<span class="builtintype" id="7090765">string</span><span class="op" id="7090771">)</span>&nbsp;<span class="op" id="7090773">(</span><span class="ident" id="7090774">addr</span>&nbsp;<span class="builtintype" id="7090779">string</span><span class="op" id="7090785">,</span>&nbsp;<span class="ident" id="7090787">sock</span>&nbsp;<span class="ident" id="7090792">io</span><span class="op" id="7090794">.</span><span class="ident" id="7090795">Closer</span><span class="op" id="7090801">,</span>&nbsp;<span class="ident" id="7090803">wg</span>&nbsp;<span class="op" id="7090806">*</span><span class="ident" id="7090807">sync</span><span class="op" id="7090811">.</span><span class="ident" id="7090812">WaitGroup</span><span class="op" id="7090821">)</span>&nbsp;<span class="op" id="7090823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090826">if</span>&nbsp;<span class="ident" id="7090829">n</span>&nbsp;<span class="op" id="7090831">==</span>&nbsp;<span class="string" id="7090834">&#34;udp&#34;</span>&nbsp;<span class="op" id="7090840">||</span>&nbsp;<span class="ident" id="7090843">n</span>&nbsp;<span class="op" id="7090845">==</span>&nbsp;<span class="string" id="7090848">&#34;tcp&#34;</span>&nbsp;<span class="op" id="7090854">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7090858">la</span>&nbsp;<span class="op" id="7090861">=</span>&nbsp;<span class="string" id="7090863">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7090878">}</span>&nbsp;<span class="keyword" id="7090880">else</span>&nbsp;<span class="op" id="7090885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7090889">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7090945">if</span>&nbsp;<span class="ident" id="7090948">la</span>&nbsp;<span class="op" id="7090951">==</span>&nbsp;<span class="string" id="7090954">&#34;&#34;</span>&nbsp;<span class="op" id="7090957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7090962">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091017">f</span><span class="op" id="7091018">,</span>&nbsp;<span class="ident" id="7091020">err</span>&nbsp;<span class="op" id="7091024">:=</span>&nbsp;<span class="ident" id="7091027">ioutil</span><span class="op" id="7091033">.</span><span class="ident" id="7091034">TempFile</span><span class="op" id="7091042">(</span><span class="string" id="7091043">&#34;&#34;</span><span class="op" id="7091045">,</span>&nbsp;<span class="string" id="7091047">&#34;syslogtest&#34;</span><span class="op" id="7091059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091064">if</span>&nbsp;<span class="ident" id="7091067">err</span>&nbsp;<span class="op" id="7091071">!=</span>&nbsp;<span class="builtintype" id="7091074">nil</span>&nbsp;<span class="op" id="7091078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091084">log</span><span class="op" id="7091087">.</span><span class="ident" id="7091088">Fatal</span><span class="op" id="7091093">(</span><span class="string" id="7091094">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="7091106">,</span>&nbsp;<span class="ident" id="7091108">err</span><span class="op" id="7091111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091121">f</span><span class="op" id="7091122">.</span><span class="ident" id="7091123">Close</span><span class="op" id="7091128">(</span><span class="op" id="7091129">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091134">la</span>&nbsp;<span class="op" id="7091137">=</span>&nbsp;<span class="ident" id="7091139">f</span><span class="op" id="7091140">.</span><span class="ident" id="7091141">Name</span><span class="op" id="7091145">(</span><span class="op" id="7091146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091154">os</span><span class="op" id="7091156">.</span><span class="ident" id="7091157">Remove</span><span class="op" id="7091163">(</span><span class="ident" id="7091164">la</span><span class="op" id="7091166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091173">wg</span>&nbsp;<span class="op" id="7091176">=</span>&nbsp;<span class="builtinfunc" id="7091178">new</span><span class="op" id="7091181">(</span><span class="ident" id="7091182">sync</span><span class="op" id="7091186">.</span><span class="ident" id="7091187">WaitGroup</span><span class="op" id="7091196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091199">if</span>&nbsp;<span class="ident" id="7091202">n</span>&nbsp;<span class="op" id="7091204">==</span>&nbsp;<span class="string" id="7091207">&#34;udp&#34;</span>&nbsp;<span class="op" id="7091213">||</span>&nbsp;<span class="ident" id="7091216">n</span>&nbsp;<span class="op" id="7091218">==</span>&nbsp;<span class="string" id="7091221">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7091232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091236">l</span><span class="op" id="7091237">,</span>&nbsp;<span class="ident" id="7091239">e</span>&nbsp;<span class="op" id="7091241">:=</span>&nbsp;<span class="ident" id="7091244">net</span><span class="op" id="7091247">.</span><span class="ident" id="7091248">ListenPacket</span><span class="op" id="7091260">(</span><span class="ident" id="7091261">n</span><span class="op" id="7091262">,</span>&nbsp;<span class="ident" id="7091264">la</span><span class="op" id="7091266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091270">if</span>&nbsp;<span class="ident" id="7091273">e</span>&nbsp;<span class="op" id="7091275">!=</span>&nbsp;<span class="builtintype" id="7091278">nil</span>&nbsp;<span class="op" id="7091282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091287">log</span><span class="op" id="7091290">.</span><span class="ident" id="7091291">Fatalf</span><span class="op" id="7091297">(</span><span class="string" id="7091298">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7091322">,</span>&nbsp;<span class="ident" id="7091324">e</span><span class="op" id="7091325">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091333">addr</span>&nbsp;<span class="op" id="7091338">=</span>&nbsp;<span class="ident" id="7091340">l</span><span class="op" id="7091341">.</span><span class="ident" id="7091342">LocalAddr</span><span class="op" id="7091351">(</span><span class="op" id="7091352">)</span><span class="op" id="7091353">.</span><span class="ident" id="7091354">String</span><span class="op" id="7091360">(</span><span class="op" id="7091361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091365">sock</span>&nbsp;<span class="op" id="7091370">=</span>&nbsp;<span class="ident" id="7091372">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091376">wg</span><span class="op" id="7091378">.</span><span class="ident" id="7091379">Add</span><span class="op" id="7091382">(</span><span class="num" id="7091383">1</span><span class="op" id="7091384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091388">go</span>&nbsp;<span class="keyword" id="7091391">func</span><span class="op" id="7091395">(</span><span class="op" id="7091396">)</span>&nbsp;<span class="op" id="7091398">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091403">defer</span>&nbsp;<span class="ident" id="7091409">wg</span><span class="op" id="7091411">.</span><span class="ident" id="7091412">Done</span><span class="op" id="7091416">(</span><span class="op" id="7091417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091422">runPktSyslog</span><span class="op" id="7091434">(</span><span class="ident" id="7091435">l</span><span class="op" id="7091436">,</span>&nbsp;<span class="ident" id="7091438">done</span><span class="op" id="7091442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091446">}</span><span class="op" id="7091447">(</span><span class="op" id="7091448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091451">}</span>&nbsp;<span class="keyword" id="7091453">else</span>&nbsp;<span class="op" id="7091458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091462">l</span><span class="op" id="7091463">,</span>&nbsp;<span class="ident" id="7091465">e</span>&nbsp;<span class="op" id="7091467">:=</span>&nbsp;<span class="ident" id="7091470">net</span><span class="op" id="7091473">.</span><span class="ident" id="7091474">Listen</span><span class="op" id="7091480">(</span><span class="ident" id="7091481">n</span><span class="op" id="7091482">,</span>&nbsp;<span class="ident" id="7091484">la</span><span class="op" id="7091486">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091490">if</span>&nbsp;<span class="ident" id="7091493">e</span>&nbsp;<span class="op" id="7091495">!=</span>&nbsp;<span class="builtintype" id="7091498">nil</span>&nbsp;<span class="op" id="7091502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091507">log</span><span class="op" id="7091510">.</span><span class="ident" id="7091511">Fatalf</span><span class="op" id="7091517">(</span><span class="string" id="7091518">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7091542">,</span>&nbsp;<span class="ident" id="7091544">e</span><span class="op" id="7091545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091553">addr</span>&nbsp;<span class="op" id="7091558">=</span>&nbsp;<span class="ident" id="7091560">l</span><span class="op" id="7091561">.</span><span class="ident" id="7091562">Addr</span><span class="op" id="7091566">(</span><span class="op" id="7091567">)</span><span class="op" id="7091568">.</span><span class="ident" id="7091569">String</span><span class="op" id="7091575">(</span><span class="op" id="7091576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091580">sock</span>&nbsp;<span class="op" id="7091585">=</span>&nbsp;<span class="ident" id="7091587">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091591">wg</span><span class="op" id="7091593">.</span><span class="ident" id="7091594">Add</span><span class="op" id="7091597">(</span><span class="num" id="7091598">1</span><span class="op" id="7091599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091603">go</span>&nbsp;<span class="keyword" id="7091606">func</span><span class="op" id="7091610">(</span><span class="op" id="7091611">)</span>&nbsp;<span class="op" id="7091613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091618">defer</span>&nbsp;<span class="ident" id="7091624">wg</span><span class="op" id="7091626">.</span><span class="ident" id="7091627">Done</span><span class="op" id="7091631">(</span><span class="op" id="7091632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091637">runStreamSyslog</span><span class="op" id="7091652">(</span><span class="ident" id="7091653">l</span><span class="op" id="7091654">,</span>&nbsp;<span class="ident" id="7091656">done</span><span class="op" id="7091660">,</span>&nbsp;<span class="ident" id="7091662">wg</span><span class="op" id="7091664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091668">}</span><span class="op" id="7091669">(</span><span class="op" id="7091670">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7091673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091676">return</span><br>
<span class="lineno"></span><span class="op" id="7091683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7091686">func</span>&nbsp;<span class="ident" id="7091691">TestWithSimulated</span><span class="op" id="7091708">(</span><span class="ident" id="7091709">t</span>&nbsp;<span class="op" id="7091711">*</span><span class="ident" id="7091712">testing</span><span class="op" id="7091719">.</span><span class="ident" id="7091720">T</span><span class="op" id="7091721">)</span>&nbsp;<span class="op" id="7091723">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091726">msg</span>&nbsp;<span class="op" id="7091730">:=</span>&nbsp;<span class="string" id="7091733">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091745">transport</span>&nbsp;<span class="op" id="7091755">:=</span>&nbsp;<span class="op" id="7091758">[</span><span class="op" id="7091759">]</span><span class="builtintype" id="7091760">string</span><span class="op" id="7091766">{</span><span class="string" id="7091767">&#34;unix&#34;</span><span class="op" id="7091773">,</span>&nbsp;<span class="string" id="7091775">&#34;unixgram&#34;</span><span class="op" id="7091785">,</span>&nbsp;<span class="string" id="7091787">&#34;udp&#34;</span><span class="op" id="7091792">,</span>&nbsp;<span class="string" id="7091794">&#34;tcp&#34;</span><span class="op" id="7091799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091803">for</span>&nbsp;<span class="ident" id="7091807">_</span><span class="op" id="7091808">,</span>&nbsp;<span class="ident" id="7091810">tr</span>&nbsp;<span class="op" id="7091813">:=</span>&nbsp;<span class="keyword" id="7091816">range</span>&nbsp;<span class="ident" id="7091822">transport</span>&nbsp;<span class="op" id="7091832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091836">done</span>&nbsp;<span class="op" id="7091841">:=</span>&nbsp;<span class="builtinfunc" id="7091844">make</span><span class="op" id="7091848">(</span><span class="keyword" id="7091849">chan</span>&nbsp;<span class="builtintype" id="7091854">string</span><span class="op" id="7091860">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7091864">addr</span><span class="op" id="7091868">,</span>&nbsp;<span class="ident" id="7091870">sock</span><span class="op" id="7091874">,</span>&nbsp;<span class="ident" id="7091876">srvWG</span>&nbsp;<span class="op" id="7091882">:=</span>&nbsp;<span class="ident" id="7091885">startServer</span><span class="op" id="7091896">(</span><span class="ident" id="7091897">tr</span><span class="op" id="7091899">,</span>&nbsp;<span class="string" id="7091901">&#34;&#34;</span><span class="op" id="7091903">,</span>&nbsp;<span class="ident" id="7091905">done</span><span class="op" id="7091909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091913">defer</span>&nbsp;<span class="ident" id="7091919">srvWG</span><span class="op" id="7091924">.</span><span class="ident" id="7091925">Wait</span><span class="op" id="7091929">(</span><span class="op" id="7091930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091934">defer</span>&nbsp;<span class="ident" id="7091940">sock</span><span class="op" id="7091944">.</span><span class="ident" id="7091945">Close</span><span class="op" id="7091950">(</span><span class="op" id="7091951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091955">if</span>&nbsp;<span class="ident" id="7091958">tr</span>&nbsp;<span class="op" id="7091961">==</span>&nbsp;<span class="string" id="7091964">&#34;unix&#34;</span>&nbsp;<span class="op" id="7091971">||</span>&nbsp;<span class="ident" id="7091974">tr</span>&nbsp;<span class="op" id="7091977">==</span>&nbsp;<span class="string" id="7091980">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7091991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7091996">defer</span>&nbsp;<span class="ident" id="7092002">os</span><span class="op" id="7092004">.</span><span class="ident" id="7092005">Remove</span><span class="op" id="7092011">(</span><span class="ident" id="7092012">addr</span><span class="op" id="7092016">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7092020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092024">s</span><span class="op" id="7092025">,</span>&nbsp;<span class="ident" id="7092027">err</span>&nbsp;<span class="op" id="7092031">:=</span>&nbsp;<span class="ident" id="7092034">Dial</span><span class="op" id="7092038">(</span><span class="ident" id="7092039">tr</span><span class="op" id="7092041">,</span>&nbsp;<span class="ident" id="7092043">addr</span><span class="op" id="7092047">,</span>&nbsp;<span class="ident" id="7092049">LOG_INFO</span><span class="op" id="7092057">|</span><span class="ident" id="7092058">LOG_USER</span><span class="op" id="7092066">,</span>&nbsp;<span class="string" id="7092068">&#34;syslog_test&#34;</span><span class="op" id="7092081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092085">if</span>&nbsp;<span class="ident" id="7092088">err</span>&nbsp;<span class="op" id="7092092">!=</span>&nbsp;<span class="builtintype" id="7092095">nil</span>&nbsp;<span class="op" id="7092099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092104">t</span><span class="op" id="7092105">.</span><span class="ident" id="7092106">Fatalf</span><span class="op" id="7092112">(</span><span class="string" id="7092113">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7092132">,</span>&nbsp;<span class="ident" id="7092134">err</span><span class="op" id="7092137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7092141">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092145">err</span>&nbsp;<span class="op" id="7092149">=</span>&nbsp;<span class="ident" id="7092151">s</span><span class="op" id="7092152">.</span><span class="ident" id="7092153">Info</span><span class="op" id="7092157">(</span><span class="ident" id="7092158">msg</span><span class="op" id="7092161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092165">if</span>&nbsp;<span class="ident" id="7092168">err</span>&nbsp;<span class="op" id="7092172">!=</span>&nbsp;<span class="builtintype" id="7092175">nil</span>&nbsp;<span class="op" id="7092179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092184">t</span><span class="op" id="7092185">.</span><span class="ident" id="7092186">Fatalf</span><span class="op" id="7092192">(</span><span class="string" id="7092193">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7092209">,</span>&nbsp;<span class="ident" id="7092211">err</span><span class="op" id="7092214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7092218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092222">check</span><span class="op" id="7092227">(</span><span class="ident" id="7092228">t</span><span class="op" id="7092229">,</span>&nbsp;<span class="ident" id="7092231">msg</span><span class="op" id="7092234">,</span>&nbsp;<span class="op" id="7092236">&lt;-</span><span class="ident" id="7092238">done</span><span class="op" id="7092242">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092246">s</span><span class="op" id="7092247">.</span><span class="ident" id="7092248">Close</span><span class="op" id="7092253">(</span><span class="op" id="7092254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7092257">}</span><br>
<span class="lineno"></span><span class="op" id="7092259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7092262">func</span>&nbsp;<span class="ident" id="7092267">TestFlap</span><span class="op" id="7092275">(</span><span class="ident" id="7092276">t</span>&nbsp;<span class="op" id="7092278">*</span><span class="ident" id="7092279">testing</span><span class="op" id="7092286">.</span><span class="ident" id="7092287">T</span><span class="op" id="7092288">)</span>&nbsp;<span class="op" id="7092290">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092293">net</span>&nbsp;<span class="op" id="7092297">:=</span>&nbsp;<span class="string" id="7092300">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092308">done</span>&nbsp;<span class="op" id="7092313">:=</span>&nbsp;<span class="builtinfunc" id="7092316">make</span><span class="op" id="7092320">(</span><span class="keyword" id="7092321">chan</span>&nbsp;<span class="builtintype" id="7092326">string</span><span class="op" id="7092332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092335">addr</span><span class="op" id="7092339">,</span>&nbsp;<span class="ident" id="7092341">sock</span><span class="op" id="7092345">,</span>&nbsp;<span class="ident" id="7092347">srvWG</span>&nbsp;<span class="op" id="7092353">:=</span>&nbsp;<span class="ident" id="7092356">startServer</span><span class="op" id="7092367">(</span><span class="ident" id="7092368">net</span><span class="op" id="7092371">,</span>&nbsp;<span class="string" id="7092373">&#34;&#34;</span><span class="op" id="7092375">,</span>&nbsp;<span class="ident" id="7092377">done</span><span class="op" id="7092381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092384">defer</span>&nbsp;<span class="ident" id="7092390">srvWG</span><span class="op" id="7092395">.</span><span class="ident" id="7092396">Wait</span><span class="op" id="7092400">(</span><span class="op" id="7092401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092404">defer</span>&nbsp;<span class="ident" id="7092410">os</span><span class="op" id="7092412">.</span><span class="ident" id="7092413">Remove</span><span class="op" id="7092419">(</span><span class="ident" id="7092420">addr</span><span class="op" id="7092424">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092427">defer</span>&nbsp;<span class="ident" id="7092433">sock</span><span class="op" id="7092437">.</span><span class="ident" id="7092438">Close</span><span class="op" id="7092443">(</span><span class="op" id="7092444">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092448">s</span><span class="op" id="7092449">,</span>&nbsp;<span class="ident" id="7092451">err</span>&nbsp;<span class="op" id="7092455">:=</span>&nbsp;<span class="ident" id="7092458">Dial</span><span class="op" id="7092462">(</span><span class="ident" id="7092463">net</span><span class="op" id="7092466">,</span>&nbsp;<span class="ident" id="7092468">addr</span><span class="op" id="7092472">,</span>&nbsp;<span class="ident" id="7092474">LOG_INFO</span><span class="op" id="7092482">|</span><span class="ident" id="7092483">LOG_USER</span><span class="op" id="7092491">,</span>&nbsp;<span class="string" id="7092493">&#34;syslog_test&#34;</span><span class="op" id="7092506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092509">if</span>&nbsp;<span class="ident" id="7092512">err</span>&nbsp;<span class="op" id="7092516">!=</span>&nbsp;<span class="builtintype" id="7092519">nil</span>&nbsp;<span class="op" id="7092523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092527">t</span><span class="op" id="7092528">.</span><span class="ident" id="7092529">Fatalf</span><span class="op" id="7092535">(</span><span class="string" id="7092536">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7092555">,</span>&nbsp;<span class="ident" id="7092557">err</span><span class="op" id="7092560">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7092563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092566">msg</span>&nbsp;<span class="op" id="7092570">:=</span>&nbsp;<span class="string" id="7092573">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092582">err</span>&nbsp;<span class="op" id="7092586">=</span>&nbsp;<span class="ident" id="7092588">s</span><span class="op" id="7092589">.</span><span class="ident" id="7092590">Info</span><span class="op" id="7092594">(</span><span class="ident" id="7092595">msg</span><span class="op" id="7092598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092601">if</span>&nbsp;<span class="ident" id="7092604">err</span>&nbsp;<span class="op" id="7092608">!=</span>&nbsp;<span class="builtintype" id="7092611">nil</span>&nbsp;<span class="op" id="7092615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092619">t</span><span class="op" id="7092620">.</span><span class="ident" id="7092621">Fatalf</span><span class="op" id="7092627">(</span><span class="string" id="7092628">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7092644">,</span>&nbsp;<span class="ident" id="7092646">err</span><span class="op" id="7092649">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7092652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092655">check</span><span class="op" id="7092660">(</span><span class="ident" id="7092661">t</span><span class="op" id="7092662">,</span>&nbsp;<span class="ident" id="7092664">msg</span><span class="op" id="7092667">,</span>&nbsp;<span class="op" id="7092669">&lt;-</span><span class="ident" id="7092671">done</span><span class="op" id="7092675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7092679">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092702">_</span><span class="op" id="7092703">,</span>&nbsp;<span class="ident" id="7092705">sock2</span><span class="op" id="7092710">,</span>&nbsp;<span class="ident" id="7092712">srvWG2</span>&nbsp;<span class="op" id="7092719">:=</span>&nbsp;<span class="ident" id="7092722">startServer</span><span class="op" id="7092733">(</span><span class="ident" id="7092734">net</span><span class="op" id="7092737">,</span>&nbsp;<span class="ident" id="7092739">addr</span><span class="op" id="7092743">,</span>&nbsp;<span class="ident" id="7092745">done</span><span class="op" id="7092749">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092752">defer</span>&nbsp;<span class="ident" id="7092758">srvWG2</span><span class="op" id="7092764">.</span><span class="ident" id="7092765">Wait</span><span class="op" id="7092769">(</span><span class="op" id="7092770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092773">defer</span>&nbsp;<span class="ident" id="7092779">sock2</span><span class="op" id="7092784">.</span><span class="ident" id="7092785">Close</span><span class="op" id="7092790">(</span><span class="op" id="7092791">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7092795">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092822">msg</span>&nbsp;<span class="op" id="7092826">=</span>&nbsp;<span class="string" id="7092828">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092837">err</span>&nbsp;<span class="op" id="7092841">=</span>&nbsp;<span class="ident" id="7092843">s</span><span class="op" id="7092844">.</span><span class="ident" id="7092845">Info</span><span class="op" id="7092849">(</span><span class="ident" id="7092850">msg</span><span class="op" id="7092853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092856">if</span>&nbsp;<span class="ident" id="7092859">err</span>&nbsp;<span class="op" id="7092863">!=</span>&nbsp;<span class="builtintype" id="7092866">nil</span>&nbsp;<span class="op" id="7092870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092874">t</span><span class="op" id="7092875">.</span><span class="ident" id="7092876">Fatalf</span><span class="op" id="7092882">(</span><span class="string" id="7092883">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7092899">,</span>&nbsp;<span class="ident" id="7092901">err</span><span class="op" id="7092904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7092907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092910">check</span><span class="op" id="7092915">(</span><span class="ident" id="7092916">t</span><span class="op" id="7092917">,</span>&nbsp;<span class="ident" id="7092919">msg</span><span class="op" id="7092922">,</span>&nbsp;<span class="op" id="7092924">&lt;-</span><span class="ident" id="7092926">done</span><span class="op" id="7092930">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7092934">s</span><span class="op" id="7092935">.</span><span class="ident" id="7092936">Close</span><span class="op" id="7092941">(</span><span class="op" id="7092942">)</span><br>
<span class="lineno"></span><span class="op" id="7092944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7092947">func</span>&nbsp;<span class="ident" id="7092952">TestNew</span><span class="op" id="7092959">(</span><span class="ident" id="7092960">t</span>&nbsp;<span class="op" id="7092962">*</span><span class="ident" id="7092963">testing</span><span class="op" id="7092970">.</span><span class="ident" id="7092971">T</span><span class="op" id="7092972">)</span>&nbsp;<span class="op" id="7092974">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7092977">if</span>&nbsp;<span class="ident" id="7092980">LOG_LOCAL7</span>&nbsp;<span class="op" id="7092991">!=</span>&nbsp;<span class="num" id="7092994">23</span><span class="op" id="7092996">&lt;&lt;</span><span class="num" id="7092998">3</span>&nbsp;<span class="op" id="7093000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093004">t</span><span class="op" id="7093005">.</span><span class="ident" id="7093006">Fatalf</span><span class="op" id="7093012">(</span><span class="string" id="7093013">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="7093041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7093047">if</span>&nbsp;<span class="ident" id="7093050">testing</span><span class="op" id="7093057">.</span><span class="ident" id="7093058">Short</span><span class="op" id="7093063">(</span><span class="op" id="7093064">)</span>&nbsp;<span class="op" id="7093066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7093070">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093133">t</span><span class="op" id="7093134">.</span><span class="ident" id="7093135">Skip</span><span class="op" id="7093139">(</span><span class="string" id="7093140">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7093176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093183">s</span><span class="op" id="7093184">,</span>&nbsp;<span class="ident" id="7093186">err</span>&nbsp;<span class="op" id="7093190">:=</span>&nbsp;<span class="ident" id="7093193">New</span><span class="op" id="7093196">(</span><span class="ident" id="7093197">LOG_INFO</span><span class="op" id="7093205">|</span><span class="ident" id="7093206">LOG_USER</span><span class="op" id="7093214">,</span>&nbsp;<span class="string" id="7093216">&#34;the_tag&#34;</span><span class="op" id="7093225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7093228">if</span>&nbsp;<span class="ident" id="7093231">err</span>&nbsp;<span class="op" id="7093235">!=</span>&nbsp;<span class="builtintype" id="7093238">nil</span>&nbsp;<span class="op" id="7093242">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093246">t</span><span class="op" id="7093247">.</span><span class="ident" id="7093248">Fatalf</span><span class="op" id="7093254">(</span><span class="string" id="7093255">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7093273">,</span>&nbsp;<span class="ident" id="7093275">err</span><span class="op" id="7093278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7093284">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093313">s</span><span class="op" id="7093314">.</span><span class="ident" id="7093315">Close</span><span class="op" id="7093320">(</span><span class="op" id="7093321">)</span><br>
<span class="lineno"></span><span class="op" id="7093323">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="7093326">func</span>&nbsp;<span class="ident" id="7093331">TestNewLogger</span><span class="op" id="7093344">(</span><span class="ident" id="7093345">t</span>&nbsp;<span class="op" id="7093347">*</span><span class="ident" id="7093348">testing</span><span class="op" id="7093355">.</span><span class="ident" id="7093356">T</span><span class="op" id="7093357">)</span>&nbsp;<span class="op" id="7093359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7093362">if</span>&nbsp;<span class="ident" id="7093365">testing</span><span class="op" id="7093372">.</span><span class="ident" id="7093373">Short</span><span class="op" id="7093378">(</span><span class="op" id="7093379">)</span>&nbsp;<span class="op" id="7093381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093385">t</span><span class="op" id="7093386">.</span><span class="ident" id="7093387">Skip</span><span class="op" id="7093391">(</span><span class="string" id="7093392">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7093428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093431">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093434">f</span><span class="op" id="7093435">,</span>&nbsp;<span class="ident" id="7093437">err</span>&nbsp;<span class="op" id="7093441">:=</span>&nbsp;<span class="ident" id="7093444">NewLogger</span><span class="op" id="7093453">(</span><span class="ident" id="7093454">LOG_USER</span><span class="op" id="7093462">|</span><span class="ident" id="7093463">LOG_INFO</span><span class="op" id="7093471">,</span>&nbsp;<span class="num" id="7093473">0</span><span class="op" id="7093474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7093477">if</span>&nbsp;<span class="ident" id="7093480">f</span>&nbsp;<span class="op" id="7093482">==</span>&nbsp;<span class="builtintype" id="7093485">nil</span>&nbsp;<span class="op" id="7093489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093493">t</span><span class="op" id="7093494">.</span><span class="ident" id="7093495">Error</span><span class="op" id="7093500">(</span><span class="ident" id="7093501">err</span><span class="op" id="7093504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093507">}</span><br>
<span class="lineno"></span><span class="op" id="7093509">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7093512">func</span>&nbsp;<span class="ident" id="7093517">TestDial</span><span class="op" id="7093525">(</span><span class="ident" id="7093526">t</span>&nbsp;<span class="op" id="7093528">*</span><span class="ident" id="7093529">testing</span><span class="op" id="7093536">.</span><span class="ident" id="7093537">T</span><span class="op" id="7093538">)</span>&nbsp;<span class="op" id="7093540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7093543">if</span>&nbsp;<span class="ident" id="7093546">testing</span><span class="op" id="7093553">.</span><span class="ident" id="7093554">Short</span><span class="op" id="7093559">(</span><span class="op" id="7093560">)</span>&nbsp;<span class="op" id="7093562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093566">t</span><span class="op" id="7093567">.</span><span class="ident" id="7093568">Skip</span><span class="op" id="7093572">(</span><span class="string" id="7093573">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7093609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093612">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093615">f</span><span class="op" id="7093616">,</span>&nbsp;<span class="ident" id="7093618">err</span>&nbsp;<span class="op" id="7093622">:=</span>&nbsp;<span class="ident" id="7093625">Dial</span><span class="op" id="7093629">(</span><span class="string" id="7093630">&#34;&#34;</span><span class="op" id="7093632">,</span>&nbsp;<span class="string" id="7093634">&#34;&#34;</span><span class="op" id="7093636">,</span>&nbsp;<span class="op" id="7093638">(</span><span class="ident" id="7093639">LOG_LOCAL7</span><span class="op" id="7093649">|</span><span class="ident" id="7093650">LOG_DEBUG</span><span class="op" id="7093659">)</span><span class="op" id="7093660">+</span><span class="num" id="7093661">1</span><span class="op" id="7093662">,</span>&nbsp;<span class="string" id="7093664">&#34;syslog_test&#34;</span><span class="op" id="7093677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7093680">if</span>&nbsp;<span class="ident" id="7093683">f</span>&nbsp;<span class="op" id="7093685">!=</span>&nbsp;<span class="builtintype" id="7093688">nil</span>&nbsp;<span class="op" id="7093692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093696">t</span><span class="op" id="7093697">.</span><span class="ident" id="7093698">Fatalf</span><span class="op" id="7093704">(</span><span class="string" id="7093705">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7093739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093745">f</span><span class="op" id="7093746">,</span>&nbsp;<span class="ident" id="7093748">err</span>&nbsp;<span class="op" id="7093752">=</span>&nbsp;<span class="ident" id="7093754">Dial</span><span class="op" id="7093758">(</span><span class="string" id="7093759">&#34;&#34;</span><span class="op" id="7093761">,</span>&nbsp;<span class="string" id="7093763">&#34;&#34;</span><span class="op" id="7093765">,</span>&nbsp;<span class="op" id="7093767">-</span><span class="num" id="7093768">1</span><span class="op" id="7093769">,</span>&nbsp;<span class="string" id="7093771">&#34;syslog_test&#34;</span><span class="op" id="7093784">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7093787">if</span>&nbsp;<span class="ident" id="7093790">f</span>&nbsp;<span class="op" id="7093792">!=</span>&nbsp;<span class="builtintype" id="7093795">nil</span>&nbsp;<span class="op" id="7093799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093803">t</span><span class="op" id="7093804">.</span><span class="ident" id="7093805">Fatalf</span><span class="op" id="7093811">(</span><span class="string" id="7093812">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7093846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093852">l</span><span class="op" id="7093853">,</span>&nbsp;<span class="ident" id="7093855">err</span>&nbsp;<span class="op" id="7093859">:=</span>&nbsp;<span class="ident" id="7093862">Dial</span><span class="op" id="7093866">(</span><span class="string" id="7093867">&#34;&#34;</span><span class="op" id="7093869">,</span>&nbsp;<span class="string" id="7093871">&#34;&#34;</span><span class="op" id="7093873">,</span>&nbsp;<span class="ident" id="7093875">LOG_USER</span><span class="op" id="7093883">|</span><span class="ident" id="7093884">LOG_ERR</span><span class="op" id="7093891">,</span>&nbsp;<span class="string" id="7093893">&#34;syslog_test&#34;</span><span class="op" id="7093906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7093909">if</span>&nbsp;<span class="ident" id="7093912">err</span>&nbsp;<span class="op" id="7093916">!=</span>&nbsp;<span class="builtintype" id="7093919">nil</span>&nbsp;<span class="op" id="7093923">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093927">t</span><span class="op" id="7093928">.</span><span class="ident" id="7093929">Fatalf</span><span class="op" id="7093935">(</span><span class="string" id="7093936">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7093955">,</span>&nbsp;<span class="ident" id="7093957">err</span><span class="op" id="7093960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7093963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7093966">l</span><span class="op" id="7093967">.</span><span class="ident" id="7093968">Close</span><span class="op" id="7093973">(</span><span class="op" id="7093974">)</span><br>
<span class="lineno"></span><span class="op" id="7093976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="7093979">func</span>&nbsp;<span class="ident" id="7093984">check</span><span class="op" id="7093989">(</span><span class="ident" id="7093990">t</span>&nbsp;<span class="op" id="7093992">*</span><span class="ident" id="7093993">testing</span><span class="op" id="7094000">.</span><span class="ident" id="7094001">T</span><span class="op" id="7094002">,</span>&nbsp;<span class="ident" id="7094004">in</span><span class="op" id="7094006">,</span>&nbsp;<span class="ident" id="7094008">out</span>&nbsp;<span class="builtintype" id="7094012">string</span><span class="op" id="7094018">)</span>&nbsp;<span class="op" id="7094020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094023">tmpl</span>&nbsp;<span class="op" id="7094028">:=</span>&nbsp;<span class="ident" id="7094031">fmt</span><span class="op" id="7094034">.</span><span class="ident" id="7094035">Sprintf</span><span class="op" id="7094042">(</span><span class="string" id="7094043">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="7094079">,</span>&nbsp;<span class="ident" id="7094081">LOG_USER</span><span class="op" id="7094089">+</span><span class="ident" id="7094090">LOG_INFO</span><span class="op" id="7094098">,</span>&nbsp;<span class="ident" id="7094100">in</span><span class="op" id="7094102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7094105">if</span>&nbsp;<span class="ident" id="7094108">hostname</span><span class="op" id="7094116">,</span>&nbsp;<span class="ident" id="7094118">err</span>&nbsp;<span class="op" id="7094122">:=</span>&nbsp;<span class="ident" id="7094125">os</span><span class="op" id="7094127">.</span><span class="ident" id="7094128">Hostname</span><span class="op" id="7094136">(</span><span class="op" id="7094137">)</span><span class="op" id="7094138">;</span>&nbsp;<span class="ident" id="7094140">err</span>&nbsp;<span class="op" id="7094144">!=</span>&nbsp;<span class="builtintype" id="7094147">nil</span>&nbsp;<span class="op" id="7094151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094155">t</span><span class="op" id="7094156">.</span><span class="ident" id="7094157">Error</span><span class="op" id="7094162">(</span><span class="string" id="7094163">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7094190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094193">}</span>&nbsp;<span class="keyword" id="7094195">else</span>&nbsp;<span class="op" id="7094200">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7094204">var</span>&nbsp;<span class="ident" id="7094208">parsedHostname</span><span class="op" id="7094222">,</span>&nbsp;<span class="ident" id="7094224">timestamp</span>&nbsp;<span class="builtintype" id="7094234">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7094243">var</span>&nbsp;<span class="ident" id="7094247">pid</span>&nbsp;<span class="builtintype" id="7094251">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7094257">if</span>&nbsp;<span class="ident" id="7094260">n</span><span class="op" id="7094261">,</span>&nbsp;<span class="ident" id="7094263">err</span>&nbsp;<span class="op" id="7094267">:=</span>&nbsp;<span class="ident" id="7094270">fmt</span><span class="op" id="7094273">.</span><span class="ident" id="7094274">Sscanf</span><span class="op" id="7094280">(</span><span class="ident" id="7094281">out</span><span class="op" id="7094284">,</span>&nbsp;<span class="ident" id="7094286">tmpl</span><span class="op" id="7094290">,</span>&nbsp;<span class="op" id="7094292">&amp;</span><span class="ident" id="7094293">timestamp</span><span class="op" id="7094302">,</span>&nbsp;<span class="op" id="7094304">&amp;</span><span class="ident" id="7094305">parsedHostname</span><span class="op" id="7094319">,</span>&nbsp;<span class="op" id="7094321">&amp;</span><span class="ident" id="7094322">pid</span><span class="op" id="7094325">)</span><span class="op" id="7094326">;</span>&nbsp;<span class="ident" id="7094328">n</span>&nbsp;<span class="op" id="7094330">!=</span>&nbsp;<span class="num" id="7094333">3</span>&nbsp;<span class="op" id="7094335">||</span>&nbsp;<span class="ident" id="7094338">err</span>&nbsp;<span class="op" id="7094342">!=</span>&nbsp;<span class="builtintype" id="7094345">nil</span>&nbsp;<span class="op" id="7094349">||</span>&nbsp;<span class="ident" id="7094352">hostname</span>&nbsp;<span class="op" id="7094361">!=</span>&nbsp;<span class="ident" id="7094364">parsedHostname</span>&nbsp;<span class="op" id="7094379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094384">t</span><span class="op" id="7094385">.</span><span class="ident" id="7094386">Errorf</span><span class="op" id="7094392">(</span><span class="string" id="7094393">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7094437">,</span>&nbsp;<span class="ident" id="7094439">out</span><span class="op" id="7094442">,</span>&nbsp;<span class="ident" id="7094444">tmpl</span><span class="op" id="7094448">,</span>&nbsp;<span class="ident" id="7094450">n</span><span class="op" id="7094451">,</span>&nbsp;<span class="ident" id="7094453">err</span><span class="op" id="7094456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094460">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094463">}</span><br>
<span class="lineno"></span><span class="op" id="7094465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7094468">func</span>&nbsp;<span class="ident" id="7094473">TestWrite</span><span class="op" id="7094482">(</span><span class="ident" id="7094483">t</span>&nbsp;<span class="op" id="7094485">*</span><span class="ident" id="7094486">testing</span><span class="op" id="7094493">.</span><span class="ident" id="7094494">T</span><span class="op" id="7094495">)</span>&nbsp;<span class="op" id="7094497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094500">tests</span>&nbsp;<span class="op" id="7094506">:=</span>&nbsp;<span class="op" id="7094509">[</span><span class="op" id="7094510">]</span><span class="keyword" id="7094511">struct</span>&nbsp;<span class="op" id="7094518">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094522">pri</span>&nbsp;<span class="ident" id="7094526">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094537">pre</span>&nbsp;<span class="builtintype" id="7094541">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094550">msg</span>&nbsp;<span class="builtintype" id="7094554">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094563">exp</span>&nbsp;<span class="builtintype" id="7094567">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094575">}</span><span class="op" id="7094576">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094580">{</span><span class="ident" id="7094581">LOG_USER</span>&nbsp;<span class="op" id="7094590">|</span>&nbsp;<span class="ident" id="7094592">LOG_ERR</span><span class="op" id="7094599">,</span>&nbsp;<span class="string" id="7094601">&#34;syslog_test&#34;</span><span class="op" id="7094614">,</span>&nbsp;<span class="string" id="7094616">&#34;&#34;</span><span class="op" id="7094618">,</span>&nbsp;<span class="string" id="7094620">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="7094647">}</span><span class="op" id="7094648">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094652">{</span><span class="ident" id="7094653">LOG_USER</span>&nbsp;<span class="op" id="7094662">|</span>&nbsp;<span class="ident" id="7094664">LOG_ERR</span><span class="op" id="7094671">,</span>&nbsp;<span class="string" id="7094673">&#34;syslog_test&#34;</span><span class="op" id="7094686">,</span>&nbsp;<span class="string" id="7094688">&#34;write&nbsp;test&#34;</span><span class="op" id="7094700">,</span>&nbsp;<span class="string" id="7094702">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="7094739">}</span><span class="op" id="7094740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7094744">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094797">{</span><span class="ident" id="7094798">LOG_USER</span>&nbsp;<span class="op" id="7094807">|</span>&nbsp;<span class="ident" id="7094809">LOG_ERR</span><span class="op" id="7094816">,</span>&nbsp;<span class="string" id="7094818">&#34;syslog_test&#34;</span><span class="op" id="7094831">,</span>&nbsp;<span class="string" id="7094833">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7094849">,</span>&nbsp;<span class="string" id="7094851">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7094890">}</span><span class="op" id="7094891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094894">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7094898">if</span>&nbsp;<span class="ident" id="7094901">hostname</span><span class="op" id="7094909">,</span>&nbsp;<span class="ident" id="7094911">err</span>&nbsp;<span class="op" id="7094915">:=</span>&nbsp;<span class="ident" id="7094918">os</span><span class="op" id="7094920">.</span><span class="ident" id="7094921">Hostname</span><span class="op" id="7094929">(</span><span class="op" id="7094930">)</span><span class="op" id="7094931">;</span>&nbsp;<span class="ident" id="7094933">err</span>&nbsp;<span class="op" id="7094937">!=</span>&nbsp;<span class="builtintype" id="7094940">nil</span>&nbsp;<span class="op" id="7094944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7094948">t</span><span class="op" id="7094949">.</span><span class="ident" id="7094950">Fatalf</span><span class="op" id="7094956">(</span><span class="string" id="7094957">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7094984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7094987">}</span>&nbsp;<span class="keyword" id="7094989">else</span>&nbsp;<span class="op" id="7094994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7094998">for</span>&nbsp;<span class="ident" id="7095002">_</span><span class="op" id="7095003">,</span>&nbsp;<span class="ident" id="7095005">test</span>&nbsp;<span class="op" id="7095010">:=</span>&nbsp;<span class="keyword" id="7095013">range</span>&nbsp;<span class="ident" id="7095019">tests</span>&nbsp;<span class="op" id="7095025">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095030">done</span>&nbsp;<span class="op" id="7095035">:=</span>&nbsp;<span class="builtinfunc" id="7095038">make</span><span class="op" id="7095042">(</span><span class="keyword" id="7095043">chan</span>&nbsp;<span class="builtintype" id="7095048">string</span><span class="op" id="7095054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095059">addr</span><span class="op" id="7095063">,</span>&nbsp;<span class="ident" id="7095065">sock</span><span class="op" id="7095069">,</span>&nbsp;<span class="ident" id="7095071">srvWG</span>&nbsp;<span class="op" id="7095077">:=</span>&nbsp;<span class="ident" id="7095080">startServer</span><span class="op" id="7095091">(</span><span class="string" id="7095092">&#34;udp&#34;</span><span class="op" id="7095097">,</span>&nbsp;<span class="string" id="7095099">&#34;&#34;</span><span class="op" id="7095101">,</span>&nbsp;<span class="ident" id="7095103">done</span><span class="op" id="7095107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095112">defer</span>&nbsp;<span class="ident" id="7095118">srvWG</span><span class="op" id="7095123">.</span><span class="ident" id="7095124">Wait</span><span class="op" id="7095128">(</span><span class="op" id="7095129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095134">defer</span>&nbsp;<span class="ident" id="7095140">sock</span><span class="op" id="7095144">.</span><span class="ident" id="7095145">Close</span><span class="op" id="7095150">(</span><span class="op" id="7095151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095156">l</span><span class="op" id="7095157">,</span>&nbsp;<span class="ident" id="7095159">err</span>&nbsp;<span class="op" id="7095163">:=</span>&nbsp;<span class="ident" id="7095166">Dial</span><span class="op" id="7095170">(</span><span class="string" id="7095171">&#34;udp&#34;</span><span class="op" id="7095176">,</span>&nbsp;<span class="ident" id="7095178">addr</span><span class="op" id="7095182">,</span>&nbsp;<span class="ident" id="7095184">test</span><span class="op" id="7095188">.</span><span class="ident" id="7095189">pri</span><span class="op" id="7095192">,</span>&nbsp;<span class="ident" id="7095194">test</span><span class="op" id="7095198">.</span><span class="ident" id="7095199">pre</span><span class="op" id="7095202">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095207">if</span>&nbsp;<span class="ident" id="7095210">err</span>&nbsp;<span class="op" id="7095214">!=</span>&nbsp;<span class="builtintype" id="7095217">nil</span>&nbsp;<span class="op" id="7095221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095227">t</span><span class="op" id="7095228">.</span><span class="ident" id="7095229">Fatalf</span><span class="op" id="7095235">(</span><span class="string" id="7095236">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7095262">,</span>&nbsp;<span class="ident" id="7095264">err</span><span class="op" id="7095267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7095272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095277">defer</span>&nbsp;<span class="ident" id="7095283">l</span><span class="op" id="7095284">.</span><span class="ident" id="7095285">Close</span><span class="op" id="7095290">(</span><span class="op" id="7095291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095296">_</span><span class="op" id="7095297">,</span>&nbsp;<span class="ident" id="7095299">err</span>&nbsp;<span class="op" id="7095303">=</span>&nbsp;<span class="ident" id="7095305">io</span><span class="op" id="7095307">.</span><span class="ident" id="7095308">WriteString</span><span class="op" id="7095319">(</span><span class="ident" id="7095320">l</span><span class="op" id="7095321">,</span>&nbsp;<span class="ident" id="7095323">test</span><span class="op" id="7095327">.</span><span class="ident" id="7095328">msg</span><span class="op" id="7095331">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095336">if</span>&nbsp;<span class="ident" id="7095339">err</span>&nbsp;<span class="op" id="7095343">!=</span>&nbsp;<span class="builtintype" id="7095346">nil</span>&nbsp;<span class="op" id="7095350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095356">t</span><span class="op" id="7095357">.</span><span class="ident" id="7095358">Fatalf</span><span class="op" id="7095364">(</span><span class="string" id="7095365">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7095391">,</span>&nbsp;<span class="ident" id="7095393">err</span><span class="op" id="7095396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7095401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095406">rcvd</span>&nbsp;<span class="op" id="7095411">:=</span>&nbsp;<span class="op" id="7095414">&lt;-</span><span class="ident" id="7095416">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095424">test</span><span class="op" id="7095428">.</span><span class="ident" id="7095429">exp</span>&nbsp;<span class="op" id="7095433">=</span>&nbsp;<span class="ident" id="7095435">fmt</span><span class="op" id="7095438">.</span><span class="ident" id="7095439">Sprintf</span><span class="op" id="7095446">(</span><span class="string" id="7095447">&#34;&lt;%d&gt;&#34;</span><span class="op" id="7095453">,</span>&nbsp;<span class="ident" id="7095455">test</span><span class="op" id="7095459">.</span><span class="ident" id="7095460">pri</span><span class="op" id="7095463">)</span>&nbsp;<span class="op" id="7095465">+</span>&nbsp;<span class="ident" id="7095467">test</span><span class="op" id="7095471">.</span><span class="ident" id="7095472">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095479">var</span>&nbsp;<span class="ident" id="7095483">parsedHostname</span><span class="op" id="7095497">,</span>&nbsp;<span class="ident" id="7095499">timestamp</span>&nbsp;<span class="builtintype" id="7095509">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095519">var</span>&nbsp;<span class="ident" id="7095523">pid</span>&nbsp;<span class="builtintype" id="7095527">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095534">if</span>&nbsp;<span class="ident" id="7095537">n</span><span class="op" id="7095538">,</span>&nbsp;<span class="ident" id="7095540">err</span>&nbsp;<span class="op" id="7095544">:=</span>&nbsp;<span class="ident" id="7095547">fmt</span><span class="op" id="7095550">.</span><span class="ident" id="7095551">Sscanf</span><span class="op" id="7095557">(</span><span class="ident" id="7095558">rcvd</span><span class="op" id="7095562">,</span>&nbsp;<span class="ident" id="7095564">test</span><span class="op" id="7095568">.</span><span class="ident" id="7095569">exp</span><span class="op" id="7095572">,</span>&nbsp;<span class="op" id="7095574">&amp;</span><span class="ident" id="7095575">timestamp</span><span class="op" id="7095584">,</span>&nbsp;<span class="op" id="7095586">&amp;</span><span class="ident" id="7095587">parsedHostname</span><span class="op" id="7095601">,</span>&nbsp;<span class="op" id="7095603">&amp;</span><span class="ident" id="7095604">pid</span><span class="op" id="7095607">)</span><span class="op" id="7095608">;</span>&nbsp;<span class="ident" id="7095610">n</span>&nbsp;<span class="op" id="7095612">!=</span>&nbsp;<span class="num" id="7095615">3</span>&nbsp;<span class="op" id="7095617">||</span>&nbsp;<span class="ident" id="7095620">err</span>&nbsp;<span class="op" id="7095624">!=</span>&nbsp;<span class="builtintype" id="7095627">nil</span>&nbsp;<span class="op" id="7095631">||</span>&nbsp;<span class="ident" id="7095634">hostname</span>&nbsp;<span class="op" id="7095643">!=</span>&nbsp;<span class="ident" id="7095646">parsedHostname</span>&nbsp;<span class="op" id="7095661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095667">t</span><span class="op" id="7095668">.</span><span class="ident" id="7095669">Errorf</span><span class="op" id="7095675">(</span><span class="string" id="7095676">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7095720">,</span>&nbsp;<span class="ident" id="7095722">rcvd</span><span class="op" id="7095726">,</span>&nbsp;<span class="ident" id="7095728">test</span><span class="op" id="7095732">.</span><span class="ident" id="7095733">exp</span><span class="op" id="7095736">,</span>&nbsp;<span class="ident" id="7095738">n</span><span class="op" id="7095739">,</span>&nbsp;<span class="ident" id="7095741">err</span><span class="op" id="7095744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7095749">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7095753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7095756">}</span><br>
<span class="lineno"></span><span class="op" id="7095758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7095761">func</span>&nbsp;<span class="ident" id="7095766">TestConcurrentWrite</span><span class="op" id="7095785">(</span><span class="ident" id="7095786">t</span>&nbsp;<span class="op" id="7095788">*</span><span class="ident" id="7095789">testing</span><span class="op" id="7095796">.</span><span class="ident" id="7095797">T</span><span class="op" id="7095798">)</span>&nbsp;<span class="op" id="7095800">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095803">addr</span><span class="op" id="7095807">,</span>&nbsp;<span class="ident" id="7095809">sock</span><span class="op" id="7095813">,</span>&nbsp;<span class="ident" id="7095815">srvWG</span>&nbsp;<span class="op" id="7095821">:=</span>&nbsp;<span class="ident" id="7095824">startServer</span><span class="op" id="7095835">(</span><span class="string" id="7095836">&#34;udp&#34;</span><span class="op" id="7095841">,</span>&nbsp;<span class="string" id="7095843">&#34;&#34;</span><span class="op" id="7095845">,</span>&nbsp;<span class="builtinfunc" id="7095847">make</span><span class="op" id="7095851">(</span><span class="keyword" id="7095852">chan</span>&nbsp;<span class="builtintype" id="7095857">string</span><span class="op" id="7095863">,</span>&nbsp;<span class="num" id="7095865">1</span><span class="op" id="7095866">)</span><span class="op" id="7095867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095870">defer</span>&nbsp;<span class="ident" id="7095876">srvWG</span><span class="op" id="7095881">.</span><span class="ident" id="7095882">Wait</span><span class="op" id="7095886">(</span><span class="op" id="7095887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095890">defer</span>&nbsp;<span class="ident" id="7095896">sock</span><span class="op" id="7095900">.</span><span class="ident" id="7095901">Close</span><span class="op" id="7095906">(</span><span class="op" id="7095907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095910">w</span><span class="op" id="7095911">,</span>&nbsp;<span class="ident" id="7095913">err</span>&nbsp;<span class="op" id="7095917">:=</span>&nbsp;<span class="ident" id="7095920">Dial</span><span class="op" id="7095924">(</span><span class="string" id="7095925">&#34;udp&#34;</span><span class="op" id="7095930">,</span>&nbsp;<span class="ident" id="7095932">addr</span><span class="op" id="7095936">,</span>&nbsp;<span class="ident" id="7095938">LOG_USER</span><span class="op" id="7095946">|</span><span class="ident" id="7095947">LOG_ERR</span><span class="op" id="7095954">,</span>&nbsp;<span class="string" id="7095956">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="7095973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7095976">if</span>&nbsp;<span class="ident" id="7095979">err</span>&nbsp;<span class="op" id="7095983">!=</span>&nbsp;<span class="builtintype" id="7095986">nil</span>&nbsp;<span class="op" id="7095990">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7095994">t</span><span class="op" id="7095995">.</span><span class="ident" id="7095996">Fatalf</span><span class="op" id="7096002">(</span><span class="string" id="7096003">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7096029">,</span>&nbsp;<span class="ident" id="7096031">err</span><span class="op" id="7096034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7096037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096040">var</span>&nbsp;<span class="ident" id="7096044">wg</span>&nbsp;<span class="ident" id="7096047">sync</span><span class="op" id="7096051">.</span><span class="ident" id="7096052">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096063">for</span>&nbsp;<span class="ident" id="7096067">i</span>&nbsp;<span class="op" id="7096069">:=</span>&nbsp;<span class="num" id="7096072">0</span><span class="op" id="7096073">;</span>&nbsp;<span class="ident" id="7096075">i</span>&nbsp;<span class="op" id="7096077">&lt;</span>&nbsp;<span class="num" id="7096079">10</span><span class="op" id="7096081">;</span>&nbsp;<span class="ident" id="7096083">i</span><span class="op" id="7096084">++</span>&nbsp;<span class="op" id="7096087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096091">wg</span><span class="op" id="7096093">.</span><span class="ident" id="7096094">Add</span><span class="op" id="7096097">(</span><span class="num" id="7096098">1</span><span class="op" id="7096099">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096103">go</span>&nbsp;<span class="keyword" id="7096106">func</span><span class="op" id="7096110">(</span><span class="op" id="7096111">)</span>&nbsp;<span class="op" id="7096113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096118">defer</span>&nbsp;<span class="ident" id="7096124">wg</span><span class="op" id="7096126">.</span><span class="ident" id="7096127">Done</span><span class="op" id="7096131">(</span><span class="op" id="7096132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096137">err</span>&nbsp;<span class="op" id="7096141">:=</span>&nbsp;<span class="ident" id="7096144">w</span><span class="op" id="7096145">.</span><span class="ident" id="7096146">Info</span><span class="op" id="7096150">(</span><span class="string" id="7096151">&#34;test&#34;</span><span class="op" id="7096157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096162">if</span>&nbsp;<span class="ident" id="7096165">err</span>&nbsp;<span class="op" id="7096169">!=</span>&nbsp;<span class="builtintype" id="7096172">nil</span>&nbsp;<span class="op" id="7096176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096182">t</span><span class="op" id="7096183">.</span><span class="ident" id="7096184">Errorf</span><span class="op" id="7096190">(</span><span class="string" id="7096191">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7096210">,</span>&nbsp;<span class="ident" id="7096212">err</span><span class="op" id="7096215">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096221">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7096231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7096235">}</span><span class="op" id="7096236">(</span><span class="op" id="7096237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7096240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096243">wg</span><span class="op" id="7096245">.</span><span class="ident" id="7096246">Wait</span><span class="op" id="7096250">(</span><span class="op" id="7096251">)</span><br>
<span class="lineno">300</span><span class="op" id="7096253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7096256">func</span>&nbsp;<span class="ident" id="7096261">TestConcurrentReconnect</span><span class="op" id="7096284">(</span><span class="ident" id="7096285">t</span>&nbsp;<span class="op" id="7096287">*</span><span class="ident" id="7096288">testing</span><span class="op" id="7096295">.</span><span class="ident" id="7096296">T</span><span class="op" id="7096297">)</span>&nbsp;<span class="op" id="7096299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096302">crashy</span>&nbsp;<span class="op" id="7096309">=</span>&nbsp;<span class="builtintype" id="7096311">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096317">defer</span>&nbsp;<span class="keyword" id="7096323">func</span><span class="op" id="7096327">(</span><span class="op" id="7096328">)</span>&nbsp;<span class="op" id="7096330">{</span>&nbsp;<span class="ident" id="7096332">crashy</span>&nbsp;<span class="op" id="7096339">=</span>&nbsp;<span class="builtintype" id="7096341">false</span>&nbsp;<span class="op" id="7096347">}</span><span class="op" id="7096348">(</span><span class="op" id="7096349">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096353">const</span>&nbsp;<span class="ident" id="7096359">N</span>&nbsp;<span class="op" id="7096361">=</span>&nbsp;<span class="num" id="7096363">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096367">const</span>&nbsp;<span class="ident" id="7096373">M</span>&nbsp;<span class="op" id="7096375">=</span>&nbsp;<span class="num" id="7096377">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096382">net</span>&nbsp;<span class="op" id="7096386">:=</span>&nbsp;<span class="string" id="7096389">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096397">done</span>&nbsp;<span class="op" id="7096402">:=</span>&nbsp;<span class="builtinfunc" id="7096405">make</span><span class="op" id="7096409">(</span><span class="keyword" id="7096410">chan</span>&nbsp;<span class="builtintype" id="7096415">string</span><span class="op" id="7096421">,</span>&nbsp;<span class="ident" id="7096423">N</span><span class="op" id="7096424">*</span><span class="ident" id="7096425">M</span><span class="op" id="7096426">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096429">addr</span><span class="op" id="7096433">,</span>&nbsp;<span class="ident" id="7096435">sock</span><span class="op" id="7096439">,</span>&nbsp;<span class="ident" id="7096441">srvWG</span>&nbsp;<span class="op" id="7096447">:=</span>&nbsp;<span class="ident" id="7096450">startServer</span><span class="op" id="7096461">(</span><span class="ident" id="7096462">net</span><span class="op" id="7096465">,</span>&nbsp;<span class="string" id="7096467">&#34;&#34;</span><span class="op" id="7096469">,</span>&nbsp;<span class="ident" id="7096471">done</span><span class="op" id="7096475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096478">defer</span>&nbsp;<span class="ident" id="7096484">os</span><span class="op" id="7096486">.</span><span class="ident" id="7096487">Remove</span><span class="op" id="7096493">(</span><span class="ident" id="7096494">addr</span><span class="op" id="7096498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7096502">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096538">count</span>&nbsp;<span class="op" id="7096544">:=</span>&nbsp;<span class="builtinfunc" id="7096547">make</span><span class="op" id="7096551">(</span><span class="keyword" id="7096552">chan</span>&nbsp;<span class="builtintype" id="7096557">int</span><span class="op" id="7096560">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096563">go</span>&nbsp;<span class="keyword" id="7096566">func</span><span class="op" id="7096570">(</span><span class="op" id="7096571">)</span>&nbsp;<span class="op" id="7096573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096577">ct</span>&nbsp;<span class="op" id="7096580">:=</span>&nbsp;<span class="num" id="7096583">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096587">for</span>&nbsp;<span class="keyword" id="7096591">range</span>&nbsp;<span class="ident" id="7096597">done</span>&nbsp;<span class="op" id="7096602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096607">ct</span><span class="op" id="7096609">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7096615">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7096663">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7096712">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096751">if</span>&nbsp;<span class="ident" id="7096754">ct</span>&nbsp;<span class="op" id="7096757">&gt;</span>&nbsp;<span class="ident" id="7096759">N</span><span class="op" id="7096760">*</span><span class="ident" id="7096761">M</span><span class="op" id="7096762">/</span><span class="num" id="7096763">2</span>&nbsp;<span class="op" id="7096765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096771">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7096780">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7096784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096788">count</span>&nbsp;<span class="op" id="7096794">&lt;-</span>&nbsp;<span class="ident" id="7096797">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7096801">}</span><span class="op" id="7096802">(</span><span class="op" id="7096803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096807">var</span>&nbsp;<span class="ident" id="7096811">wg</span>&nbsp;<span class="ident" id="7096814">sync</span><span class="op" id="7096818">.</span><span class="ident" id="7096819">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096830">wg</span><span class="op" id="7096832">.</span><span class="ident" id="7096833">Add</span><span class="op" id="7096836">(</span><span class="ident" id="7096837">N</span><span class="op" id="7096838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096841">for</span>&nbsp;<span class="ident" id="7096845">i</span>&nbsp;<span class="op" id="7096847">:=</span>&nbsp;<span class="num" id="7096850">0</span><span class="op" id="7096851">;</span>&nbsp;<span class="ident" id="7096853">i</span>&nbsp;<span class="op" id="7096855">&lt;</span>&nbsp;<span class="ident" id="7096857">N</span><span class="op" id="7096858">;</span>&nbsp;<span class="ident" id="7096860">i</span><span class="op" id="7096861">++</span>&nbsp;<span class="op" id="7096864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096868">go</span>&nbsp;<span class="keyword" id="7096871">func</span><span class="op" id="7096875">(</span><span class="op" id="7096876">)</span>&nbsp;<span class="op" id="7096878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096883">defer</span>&nbsp;<span class="ident" id="7096889">wg</span><span class="op" id="7096891">.</span><span class="ident" id="7096892">Done</span><span class="op" id="7096896">(</span><span class="op" id="7096897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096902">w</span><span class="op" id="7096903">,</span>&nbsp;<span class="ident" id="7096905">err</span>&nbsp;<span class="op" id="7096909">:=</span>&nbsp;<span class="ident" id="7096912">Dial</span><span class="op" id="7096916">(</span><span class="ident" id="7096917">net</span><span class="op" id="7096920">,</span>&nbsp;<span class="ident" id="7096922">addr</span><span class="op" id="7096926">,</span>&nbsp;<span class="ident" id="7096928">LOG_USER</span><span class="op" id="7096936">|</span><span class="ident" id="7096937">LOG_ERR</span><span class="op" id="7096944">,</span>&nbsp;<span class="string" id="7096946">&#34;tag&#34;</span><span class="op" id="7096951">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7096956">if</span>&nbsp;<span class="ident" id="7096959">err</span>&nbsp;<span class="op" id="7096963">!=</span>&nbsp;<span class="builtintype" id="7096966">nil</span>&nbsp;<span class="op" id="7096970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7096976">t</span><span class="op" id="7096977">.</span><span class="ident" id="7096978">Fatalf</span><span class="op" id="7096984">(</span><span class="string" id="7096985">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7097011">,</span>&nbsp;<span class="ident" id="7097013">err</span><span class="op" id="7097016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7097021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7097026">defer</span>&nbsp;<span class="ident" id="7097032">w</span><span class="op" id="7097033">.</span><span class="ident" id="7097034">Close</span><span class="op" id="7097039">(</span><span class="op" id="7097040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7097045">for</span>&nbsp;<span class="ident" id="7097049">i</span>&nbsp;<span class="op" id="7097051">:=</span>&nbsp;<span class="num" id="7097054">0</span><span class="op" id="7097055">;</span>&nbsp;<span class="ident" id="7097057">i</span>&nbsp;<span class="op" id="7097059">&lt;</span>&nbsp;<span class="ident" id="7097061">M</span><span class="op" id="7097062">;</span>&nbsp;<span class="ident" id="7097064">i</span><span class="op" id="7097065">++</span>&nbsp;<span class="op" id="7097068">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7097074">err</span>&nbsp;<span class="op" id="7097078">:=</span>&nbsp;<span class="ident" id="7097081">w</span><span class="op" id="7097082">.</span><span class="ident" id="7097083">Info</span><span class="op" id="7097087">(</span><span class="string" id="7097088">&#34;test&#34;</span><span class="op" id="7097094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7097100">if</span>&nbsp;<span class="ident" id="7097103">err</span>&nbsp;<span class="op" id="7097107">!=</span>&nbsp;<span class="builtintype" id="7097110">nil</span>&nbsp;<span class="op" id="7097114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7097121">t</span><span class="op" id="7097122">.</span><span class="ident" id="7097123">Errorf</span><span class="op" id="7097129">(</span><span class="string" id="7097130">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7097149">,</span>&nbsp;<span class="ident" id="7097151">err</span><span class="op" id="7097154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7097161">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7097172">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7097177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7097181">}</span><span class="op" id="7097182">(</span><span class="op" id="7097183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7097186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7097189">wg</span><span class="op" id="7097191">.</span><span class="ident" id="7097192">Wait</span><span class="op" id="7097196">(</span><span class="op" id="7097197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7097200">sock</span><span class="op" id="7097204">.</span><span class="ident" id="7097205">Close</span><span class="op" id="7097210">(</span><span class="op" id="7097211">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7097214">srvWG</span><span class="op" id="7097219">.</span><span class="ident" id="7097220">Wait</span><span class="op" id="7097224">(</span><span class="op" id="7097225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7097228">close</span><span class="op" id="7097233">(</span><span class="ident" id="7097234">done</span><span class="op" id="7097238">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7097242">select</span>&nbsp;<span class="op" id="7097249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7097252">case</span>&nbsp;<span class="op" id="7097257">&lt;-</span><span class="ident" id="7097259">count</span><span class="op" id="7097264">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7097267">case</span>&nbsp;<span class="op" id="7097272">&lt;-</span><span class="ident" id="7097274">time</span><span class="op" id="7097278">.</span><span class="ident" id="7097279">After</span><span class="op" id="7097284">(</span><span class="num" id="7097285">100</span>&nbsp;<span class="op" id="7097289">*</span>&nbsp;<span class="ident" id="7097291">time</span><span class="op" id="7097295">.</span><span class="ident" id="7097296">Millisecond</span><span class="op" id="7097307">)</span><span class="op" id="7097308">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7097312">t</span><span class="op" id="7097313">.</span><span class="ident" id="7097314">Error</span><span class="op" id="7097319">(</span><span class="string" id="7097320">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="7097353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7097356">}</span><br>
<span class="lineno"></span><span class="op" id="7097358">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
