<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/textproto</h2>
<ul>
<li><a href="/gostd/net/textproto/header.go.html">header.go</a></li>
<li><a href="/gostd/net/textproto/pipeline.go.html" class="current">pipeline.go</a></li>
<li><a href="/gostd/net/textproto/reader.go.html">reader.go</a></li>
<li><a href="/gostd/net/textproto/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/net/textproto/textproto.go.html">textproto.go</a></li>
<li><a href="/gostd/net/textproto/writer.go.html">writer.go</a></li>
<li><a href="/gostd/net/textproto/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2979186">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2979242">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2979296">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2979347">package</span>&nbsp;<span class="ident" id="2979355">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2979366">import</span>&nbsp;<span class="op" id="2979373">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2979376">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="2979383">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="2979386">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="2979456">//</span><br>
<span class="lineno"></span><span class="comment" id="2979459">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="2979526">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="2979553">//</span><br>
<span class="lineno"></span><span class="comment" id="2979556">//&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="2979591">//</span><br>
<span class="lineno"></span><span class="comment" id="2979594">//&nbsp;&nbsp;&nbsp;&nbsp;p.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="2979649">//&nbsp;&nbsp;&nbsp;&nbsp;«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="2979669">//&nbsp;&nbsp;&nbsp;&nbsp;p.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="2979729">//</span><br>
<span class="lineno"></span><span class="comment" id="2979732">//&nbsp;&nbsp;&nbsp;&nbsp;p.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="2979789">//&nbsp;&nbsp;&nbsp;&nbsp;«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="2979810">//&nbsp;&nbsp;&nbsp;&nbsp;p.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="2979872">//</span><br>
<span class="lineno"></span><span class="comment" id="2979875">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="2979935">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="2980003">type</span>&nbsp;<span class="ident" id="2980008">Pipeline</span>&nbsp;<span class="keyword" id="2980017">struct</span>&nbsp;<span class="op" id="2980024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980027">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980036">sync</span><span class="op" id="2980040">.</span><span class="ident" id="2980041">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980048">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2980057">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980063">request</span>&nbsp;&nbsp;<span class="ident" id="2980072">sequencer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980083">response</span>&nbsp;<span class="ident" id="2980092">sequencer</span><br>
<span class="lineno"></span><span class="op" id="2980102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="2980105">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="2980162">func</span>&nbsp;<span class="op" id="2980167">(</span><span class="ident" id="2980168">p</span>&nbsp;<span class="op" id="2980170">*</span><span class="ident" id="2980171">Pipeline</span><span class="op" id="2980179">)</span>&nbsp;<span class="ident" id="2980181">Next</span><span class="op" id="2980185">(</span><span class="op" id="2980186">)</span>&nbsp;<span class="builtintype" id="2980188">uint</span>&nbsp;<span class="op" id="2980193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980196">p</span><span class="op" id="2980197">.</span><span class="ident" id="2980198">mu</span><span class="op" id="2980200">.</span><span class="ident" id="2980201">Lock</span><span class="op" id="2980205">(</span><span class="op" id="2980206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980209">id</span>&nbsp;<span class="op" id="2980212">:=</span>&nbsp;<span class="ident" id="2980215">p</span><span class="op" id="2980216">.</span><span class="ident" id="2980217">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980221">p</span><span class="op" id="2980222">.</span><span class="ident" id="2980223">id</span><span class="op" id="2980225">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980229">p</span><span class="op" id="2980230">.</span><span class="ident" id="2980231">mu</span><span class="op" id="2980233">.</span><span class="ident" id="2980234">Unlock</span><span class="op" id="2980240">(</span><span class="op" id="2980241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2980244">return</span>&nbsp;<span class="ident" id="2980251">id</span><br>
<span class="lineno"></span><span class="op" id="2980254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2980257">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="2980340">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="2980374">func</span>&nbsp;<span class="op" id="2980379">(</span><span class="ident" id="2980380">p</span>&nbsp;<span class="op" id="2980382">*</span><span class="ident" id="2980383">Pipeline</span><span class="op" id="2980391">)</span>&nbsp;<span class="ident" id="2980393">StartRequest</span><span class="op" id="2980405">(</span><span class="ident" id="2980406">id</span>&nbsp;<span class="builtintype" id="2980409">uint</span><span class="op" id="2980413">)</span>&nbsp;<span class="op" id="2980415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980418">p</span><span class="op" id="2980419">.</span><span class="ident" id="2980420">request</span><span class="op" id="2980427">.</span><span class="ident" id="2980428">Start</span><span class="op" id="2980433">(</span><span class="ident" id="2980434">id</span><span class="op" id="2980436">)</span><br>
<span class="lineno"></span><span class="op" id="2980438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="2980441">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="2980515">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="2980555">func</span>&nbsp;<span class="op" id="2980560">(</span><span class="ident" id="2980561">p</span>&nbsp;<span class="op" id="2980563">*</span><span class="ident" id="2980564">Pipeline</span><span class="op" id="2980572">)</span>&nbsp;<span class="ident" id="2980574">EndRequest</span><span class="op" id="2980584">(</span><span class="ident" id="2980585">id</span>&nbsp;<span class="builtintype" id="2980588">uint</span><span class="op" id="2980592">)</span>&nbsp;<span class="op" id="2980594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980597">p</span><span class="op" id="2980598">.</span><span class="ident" id="2980599">request</span><span class="op" id="2980606">.</span><span class="ident" id="2980607">End</span><span class="op" id="2980610">(</span><span class="ident" id="2980611">id</span><span class="op" id="2980613">)</span><br>
<span class="lineno"></span><span class="op" id="2980615">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="2980618">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="2980702">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="2980736">func</span>&nbsp;<span class="op" id="2980741">(</span><span class="ident" id="2980742">p</span>&nbsp;<span class="op" id="2980744">*</span><span class="ident" id="2980745">Pipeline</span><span class="op" id="2980753">)</span>&nbsp;<span class="ident" id="2980755">StartResponse</span><span class="op" id="2980768">(</span><span class="ident" id="2980769">id</span>&nbsp;<span class="builtintype" id="2980772">uint</span><span class="op" id="2980776">)</span>&nbsp;<span class="op" id="2980778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980781">p</span><span class="op" id="2980782">.</span><span class="ident" id="2980783">response</span><span class="op" id="2980791">.</span><span class="ident" id="2980792">Start</span><span class="op" id="2980797">(</span><span class="ident" id="2980798">id</span><span class="op" id="2980800">)</span><br>
<span class="lineno">60</span><span class="op" id="2980802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2980805">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="2980885">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="2980921">func</span>&nbsp;<span class="op" id="2980926">(</span><span class="ident" id="2980927">p</span>&nbsp;<span class="op" id="2980929">*</span><span class="ident" id="2980930">Pipeline</span><span class="op" id="2980938">)</span>&nbsp;<span class="ident" id="2980940">EndResponse</span><span class="op" id="2980951">(</span><span class="ident" id="2980952">id</span>&nbsp;<span class="builtintype" id="2980955">uint</span><span class="op" id="2980959">)</span>&nbsp;<span class="op" id="2980961">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2980964">p</span><span class="op" id="2980965">.</span><span class="ident" id="2980966">response</span><span class="op" id="2980974">.</span><span class="ident" id="2980975">End</span><span class="op" id="2980978">(</span><span class="ident" id="2980979">id</span><span class="op" id="2980981">)</span><br>
<span class="lineno"></span><span class="op" id="2980983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2980986">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="2981051">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="2981124">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="2981195">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="2981264">type</span>&nbsp;<span class="ident" id="2981269">sequencer</span>&nbsp;<span class="keyword" id="2981279">struct</span>&nbsp;<span class="op" id="2981286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981289">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2981294">sync</span><span class="op" id="2981298">.</span><span class="ident" id="2981299">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981306">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2981311">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981317">wait</span>&nbsp;<span class="keyword" id="2981322">map</span><span class="op" id="2981325">[</span><span class="builtintype" id="2981326">uint</span><span class="op" id="2981330">]</span><span class="keyword" id="2981331">chan</span>&nbsp;<span class="builtintype" id="2981336">uint</span><br>
<span class="lineno"></span><span class="op" id="2981341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2981344">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="2981412">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="2981481">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="2981497">func</span>&nbsp;<span class="op" id="2981502">(</span><span class="ident" id="2981503">s</span>&nbsp;<span class="op" id="2981505">*</span><span class="ident" id="2981506">sequencer</span><span class="op" id="2981515">)</span>&nbsp;<span class="ident" id="2981517">Start</span><span class="op" id="2981522">(</span><span class="ident" id="2981523">id</span>&nbsp;<span class="builtintype" id="2981526">uint</span><span class="op" id="2981530">)</span>&nbsp;<span class="op" id="2981532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981535">s</span><span class="op" id="2981536">.</span><span class="ident" id="2981537">mu</span><span class="op" id="2981539">.</span><span class="ident" id="2981540">Lock</span><span class="op" id="2981544">(</span><span class="op" id="2981545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2981548">if</span>&nbsp;<span class="ident" id="2981551">s</span><span class="op" id="2981552">.</span><span class="ident" id="2981553">id</span>&nbsp;<span class="op" id="2981556">==</span>&nbsp;<span class="ident" id="2981559">id</span>&nbsp;<span class="op" id="2981562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981566">s</span><span class="op" id="2981567">.</span><span class="ident" id="2981568">mu</span><span class="op" id="2981570">.</span><span class="ident" id="2981571">Unlock</span><span class="op" id="2981577">(</span><span class="op" id="2981578">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2981582">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2981590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981593">c</span>&nbsp;<span class="op" id="2981595">:=</span>&nbsp;<span class="builtinfunc" id="2981598">make</span><span class="op" id="2981602">(</span><span class="keyword" id="2981603">chan</span>&nbsp;<span class="builtintype" id="2981608">uint</span><span class="op" id="2981612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2981615">if</span>&nbsp;<span class="ident" id="2981618">s</span><span class="op" id="2981619">.</span><span class="ident" id="2981620">wait</span>&nbsp;<span class="op" id="2981625">==</span>&nbsp;<span class="ident" id="2981628">nil</span>&nbsp;<span class="op" id="2981632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981636">s</span><span class="op" id="2981637">.</span><span class="ident" id="2981638">wait</span>&nbsp;<span class="op" id="2981643">=</span>&nbsp;<span class="builtinfunc" id="2981645">make</span><span class="op" id="2981649">(</span><span class="keyword" id="2981650">map</span><span class="op" id="2981653">[</span><span class="builtintype" id="2981654">uint</span><span class="op" id="2981658">]</span><span class="keyword" id="2981659">chan</span>&nbsp;<span class="builtintype" id="2981664">uint</span><span class="op" id="2981668">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2981671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981674">s</span><span class="op" id="2981675">.</span><span class="ident" id="2981676">wait</span><span class="op" id="2981680">[</span><span class="ident" id="2981681">id</span><span class="op" id="2981683">]</span>&nbsp;<span class="op" id="2981685">=</span>&nbsp;<span class="ident" id="2981687">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981690">s</span><span class="op" id="2981691">.</span><span class="ident" id="2981692">mu</span><span class="op" id="2981694">.</span><span class="ident" id="2981695">Unlock</span><span class="op" id="2981701">(</span><span class="op" id="2981702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2981705">&lt;-</span><span class="ident" id="2981707">c</span><br>
<span class="lineno"></span><span class="op" id="2981709">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="2981712">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="2981784">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="2981860">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="2981930">func</span>&nbsp;<span class="op" id="2981935">(</span><span class="ident" id="2981936">s</span>&nbsp;<span class="op" id="2981938">*</span><span class="ident" id="2981939">sequencer</span><span class="op" id="2981948">)</span>&nbsp;<span class="ident" id="2981950">End</span><span class="op" id="2981953">(</span><span class="ident" id="2981954">id</span>&nbsp;<span class="builtintype" id="2981957">uint</span><span class="op" id="2981961">)</span>&nbsp;<span class="op" id="2981963">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2981966">s</span><span class="op" id="2981967">.</span><span class="ident" id="2981968">mu</span><span class="op" id="2981970">.</span><span class="ident" id="2981971">Lock</span><span class="op" id="2981975">(</span><span class="op" id="2981976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2981979">if</span>&nbsp;<span class="ident" id="2981982">s</span><span class="op" id="2981983">.</span><span class="ident" id="2981984">id</span>&nbsp;<span class="op" id="2981987">!=</span>&nbsp;<span class="ident" id="2981990">id</span>&nbsp;<span class="op" id="2981993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2981997">panic</span><span class="op" id="2982002">(</span><span class="string" id="2982003">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="2982016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2982019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2982022">id</span><span class="op" id="2982024">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2982028">s</span><span class="op" id="2982029">.</span><span class="ident" id="2982030">id</span>&nbsp;<span class="op" id="2982033">=</span>&nbsp;<span class="ident" id="2982035">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2982039">if</span>&nbsp;<span class="ident" id="2982042">s</span><span class="op" id="2982043">.</span><span class="ident" id="2982044">wait</span>&nbsp;<span class="op" id="2982049">==</span>&nbsp;<span class="ident" id="2982052">nil</span>&nbsp;<span class="op" id="2982056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2982060">s</span><span class="op" id="2982061">.</span><span class="ident" id="2982062">wait</span>&nbsp;<span class="op" id="2982067">=</span>&nbsp;<span class="builtinfunc" id="2982069">make</span><span class="op" id="2982073">(</span><span class="keyword" id="2982074">map</span><span class="op" id="2982077">[</span><span class="builtintype" id="2982078">uint</span><span class="op" id="2982082">]</span><span class="keyword" id="2982083">chan</span>&nbsp;<span class="builtintype" id="2982088">uint</span><span class="op" id="2982092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2982095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2982098">c</span><span class="op" id="2982099">,</span>&nbsp;<span class="ident" id="2982101">ok</span>&nbsp;<span class="op" id="2982104">:=</span>&nbsp;<span class="ident" id="2982107">s</span><span class="op" id="2982108">.</span><span class="ident" id="2982109">wait</span><span class="op" id="2982113">[</span><span class="ident" id="2982114">id</span><span class="op" id="2982116">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2982119">if</span>&nbsp;<span class="ident" id="2982122">ok</span>&nbsp;<span class="op" id="2982125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2982129">delete</span><span class="op" id="2982135">(</span><span class="ident" id="2982136">s</span><span class="op" id="2982137">.</span><span class="ident" id="2982138">wait</span><span class="op" id="2982142">,</span>&nbsp;<span class="ident" id="2982144">id</span><span class="op" id="2982146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2982149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2982152">s</span><span class="op" id="2982153">.</span><span class="ident" id="2982154">mu</span><span class="op" id="2982156">.</span><span class="ident" id="2982157">Unlock</span><span class="op" id="2982163">(</span><span class="op" id="2982164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2982167">if</span>&nbsp;<span class="ident" id="2982170">ok</span>&nbsp;<span class="op" id="2982173">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2982177">c</span>&nbsp;<span class="op" id="2982179">&lt;-</span>&nbsp;<span class="num" id="2982182">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2982185">}</span><br>
<span class="lineno"></span><span class="op" id="2982187">}</span>
</div>
</body>
</html>
