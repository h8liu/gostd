<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html" class="current">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1456955">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1457010">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1457064">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1457115">package</span>&nbsp;<span class="ident" id="1457123">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1457132">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1457190">import</span>&nbsp;<span class="string" id="1457197">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1457207">const</span>&nbsp;<span class="op" id="1457213">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457216">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1457226">=</span>&nbsp;<span class="num" id="1457228">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457231">hchanSize</span>&nbsp;<span class="op" id="1457241">=</span>&nbsp;<span class="ident" id="1457243">unsafe</span><span class="op" id="1457249">.</span><span class="ident" id="1457250">Sizeof</span><span class="op" id="1457256">(</span><span class="ident" id="1457257">hchan</span><span class="op" id="1457262">{</span><span class="op" id="1457263">}</span><span class="op" id="1457264">)</span>&nbsp;<span class="op" id="1457266">+</span>&nbsp;<span class="builtintype" id="1457268">uintptr</span><span class="op" id="1457275">(</span><span class="op" id="1457276">-</span><span class="builtintype" id="1457277">int</span><span class="op" id="1457280">(</span><span class="ident" id="1457281">unsafe</span><span class="op" id="1457287">.</span><span class="ident" id="1457288">Sizeof</span><span class="op" id="1457294">(</span><span class="ident" id="1457295">hchan</span><span class="op" id="1457300">{</span><span class="op" id="1457301">}</span><span class="op" id="1457302">)</span><span class="op" id="1457303">)</span><span class="op" id="1457304">&amp;</span><span class="op" id="1457305">(</span><span class="ident" id="1457306">maxAlign</span><span class="op" id="1457314">-</span><span class="num" id="1457315">1</span><span class="op" id="1457316">)</span><span class="op" id="1457317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457320">debugChan</span>&nbsp;<span class="op" id="1457330">=</span>&nbsp;<span class="builtintype" id="1457332">false</span><br>
<span class="lineno">15</span><span class="op" id="1457338">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1457341">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1457403">func</span>&nbsp;<span class="ident" id="1457408">makechan</span><span class="op" id="1457416">(</span><span class="ident" id="1457417">t</span>&nbsp;<span class="op" id="1457419">*</span><span class="ident" id="1457420">chantype</span><span class="op" id="1457428">,</span>&nbsp;<span class="ident" id="1457430">size</span>&nbsp;<span class="ident" id="1457435">int64</span><span class="op" id="1457440">)</span>&nbsp;<span class="op" id="1457442">*</span><span class="ident" id="1457443">hchan</span>&nbsp;<span class="op" id="1457449">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457452">elem</span>&nbsp;<span class="op" id="1457457">:=</span>&nbsp;<span class="ident" id="1457460">t</span><span class="op" id="1457461">.</span><span class="ident" id="1457462">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1457469">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457507">if</span>&nbsp;<span class="ident" id="1457510">elem</span><span class="op" id="1457514">.</span><span class="ident" id="1457515">size</span>&nbsp;<span class="op" id="1457520">&gt;=</span>&nbsp;<span class="num" id="1457523">1</span><span class="op" id="1457524">&lt;&lt;</span><span class="num" id="1457526">16</span>&nbsp;<span class="op" id="1457529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457533">gothrow</span><span class="op" id="1457540">(</span><span class="string" id="1457541">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1457581">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457587">if</span>&nbsp;<span class="ident" id="1457590">hchanSize</span><span class="op" id="1457599">%</span><span class="ident" id="1457600">maxAlign</span>&nbsp;<span class="op" id="1457609">!=</span>&nbsp;<span class="num" id="1457612">0</span>&nbsp;<span class="op" id="1457614">||</span>&nbsp;<span class="ident" id="1457617">elem</span><span class="op" id="1457621">.</span><span class="ident" id="1457622">align</span>&nbsp;<span class="op" id="1457628">&gt;</span>&nbsp;<span class="ident" id="1457630">maxAlign</span>&nbsp;<span class="op" id="1457639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457643">gothrow</span><span class="op" id="1457650">(</span><span class="string" id="1457651">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1457676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457682">if</span>&nbsp;<span class="ident" id="1457685">size</span>&nbsp;<span class="op" id="1457690">&lt;</span>&nbsp;<span class="num" id="1457692">0</span>&nbsp;<span class="op" id="1457694">||</span>&nbsp;<span class="ident" id="1457697">int64</span><span class="op" id="1457702">(</span><span class="builtintype" id="1457703">uintptr</span><span class="op" id="1457710">(</span><span class="ident" id="1457711">size</span><span class="op" id="1457715">)</span><span class="op" id="1457716">)</span>&nbsp;<span class="op" id="1457718">!=</span>&nbsp;<span class="ident" id="1457721">size</span>&nbsp;<span class="op" id="1457726">||</span>&nbsp;<span class="op" id="1457729">(</span><span class="ident" id="1457730">elem</span><span class="op" id="1457734">.</span><span class="ident" id="1457735">size</span>&nbsp;<span class="op" id="1457740">&gt;</span>&nbsp;<span class="num" id="1457742">0</span>&nbsp;<span class="op" id="1457744">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1457747">uintptr</span><span class="op" id="1457754">(</span><span class="ident" id="1457755">size</span><span class="op" id="1457759">)</span>&nbsp;<span class="op" id="1457761">&gt;</span>&nbsp;<span class="op" id="1457763">(</span><span class="ident" id="1457764">maxmem</span><span class="op" id="1457770">-</span><span class="ident" id="1457771">hchanSize</span><span class="op" id="1457780">)</span><span class="op" id="1457781">/</span><span class="builtintype" id="1457782">uintptr</span><span class="op" id="1457789">(</span><span class="ident" id="1457790">elem</span><span class="op" id="1457794">.</span><span class="ident" id="1457795">size</span><span class="op" id="1457799">)</span><span class="op" id="1457800">)</span>&nbsp;<span class="op" id="1457802">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1457806">panic</span><span class="op" id="1457811">(</span><span class="string" id="1457812">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1457841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457848">var</span>&nbsp;<span class="ident" id="1457852">c</span>&nbsp;<span class="op" id="1457854">*</span><span class="ident" id="1457855">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457862">if</span>&nbsp;<span class="ident" id="1457865">elem</span><span class="op" id="1457869">.</span><span class="ident" id="1457870">kind</span><span class="op" id="1457874">&amp;</span><span class="ident" id="1457875">kindNoPointers</span>&nbsp;<span class="op" id="1457890">!=</span>&nbsp;<span class="num" id="1457893">0</span>&nbsp;<span class="op" id="1457895">||</span>&nbsp;<span class="ident" id="1457898">size</span>&nbsp;<span class="op" id="1457903">==</span>&nbsp;<span class="num" id="1457906">0</span>&nbsp;<span class="op" id="1457908">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1457912">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1457946">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458016">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458082">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458163">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458238">c</span>&nbsp;<span class="op" id="1458240">=</span>&nbsp;<span class="op" id="1458242">(</span><span class="op" id="1458243">*</span><span class="ident" id="1458244">hchan</span><span class="op" id="1458249">)</span><span class="op" id="1458250">(</span><span class="ident" id="1458251">mallocgc</span><span class="op" id="1458259">(</span><span class="ident" id="1458260">hchanSize</span><span class="op" id="1458269">+</span><span class="builtintype" id="1458270">uintptr</span><span class="op" id="1458277">(</span><span class="ident" id="1458278">size</span><span class="op" id="1458282">)</span><span class="op" id="1458283">*</span><span class="builtintype" id="1458284">uintptr</span><span class="op" id="1458291">(</span><span class="ident" id="1458292">elem</span><span class="op" id="1458296">.</span><span class="ident" id="1458297">size</span><span class="op" id="1458301">)</span><span class="op" id="1458302">,</span>&nbsp;<span class="builtintype" id="1458304">nil</span><span class="op" id="1458307">,</span>&nbsp;<span class="ident" id="1458309">flagNoScan</span><span class="op" id="1458319">)</span><span class="op" id="1458320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458324">if</span>&nbsp;<span class="ident" id="1458327">size</span>&nbsp;<span class="op" id="1458332">&gt;</span>&nbsp;<span class="num" id="1458334">0</span>&nbsp;<span class="op" id="1458336">&amp;&amp;</span>&nbsp;<span class="ident" id="1458339">elem</span><span class="op" id="1458343">.</span><span class="ident" id="1458344">size</span>&nbsp;<span class="op" id="1458349">!=</span>&nbsp;<span class="num" id="1458352">0</span>&nbsp;<span class="op" id="1458354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458359">c</span><span class="op" id="1458360">.</span><span class="ident" id="1458361">buf</span>&nbsp;<span class="op" id="1458365">=</span>&nbsp;<span class="op" id="1458367">(</span><span class="op" id="1458368">*</span><span class="builtintype" id="1458369">uint8</span><span class="op" id="1458374">)</span><span class="op" id="1458375">(</span><span class="ident" id="1458376">add</span><span class="op" id="1458379">(</span><span class="ident" id="1458380">unsafe</span><span class="op" id="1458386">.</span><span class="ident" id="1458387">Pointer</span><span class="op" id="1458394">(</span><span class="ident" id="1458395">c</span><span class="op" id="1458396">)</span><span class="op" id="1458397">,</span>&nbsp;<span class="ident" id="1458399">hchanSize</span><span class="op" id="1458408">)</span><span class="op" id="1458409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458413">}</span>&nbsp;<span class="keyword" id="1458415">else</span>&nbsp;<span class="op" id="1458420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458425">c</span><span class="op" id="1458426">.</span><span class="ident" id="1458427">buf</span>&nbsp;<span class="op" id="1458431">=</span>&nbsp;<span class="op" id="1458433">(</span><span class="op" id="1458434">*</span><span class="builtintype" id="1458435">uint8</span><span class="op" id="1458440">)</span><span class="op" id="1458441">(</span><span class="ident" id="1458442">unsafe</span><span class="op" id="1458448">.</span><span class="ident" id="1458449">Pointer</span><span class="op" id="1458456">(</span><span class="ident" id="1458457">c</span><span class="op" id="1458458">)</span><span class="op" id="1458459">)</span>&nbsp;<span class="comment" id="1458461">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458522">}</span>&nbsp;<span class="keyword" id="1458524">else</span>&nbsp;<span class="op" id="1458529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458533">c</span>&nbsp;<span class="op" id="1458535">=</span>&nbsp;<span class="builtinfunc" id="1458537">new</span><span class="op" id="1458540">(</span><span class="ident" id="1458541">hchan</span><span class="op" id="1458546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458550">c</span><span class="op" id="1458551">.</span><span class="ident" id="1458552">buf</span>&nbsp;<span class="op" id="1458556">=</span>&nbsp;<span class="op" id="1458558">(</span><span class="op" id="1458559">*</span><span class="builtintype" id="1458560">uint8</span><span class="op" id="1458565">)</span><span class="op" id="1458566">(</span><span class="ident" id="1458567">newarray</span><span class="op" id="1458575">(</span><span class="ident" id="1458576">elem</span><span class="op" id="1458580">,</span>&nbsp;<span class="builtintype" id="1458582">uintptr</span><span class="op" id="1458589">(</span><span class="ident" id="1458590">size</span><span class="op" id="1458594">)</span><span class="op" id="1458595">)</span><span class="op" id="1458596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458599">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458602">c</span><span class="op" id="1458603">.</span><span class="ident" id="1458604">elemsize</span>&nbsp;<span class="op" id="1458613">=</span>&nbsp;<span class="builtintype" id="1458615">uint16</span><span class="op" id="1458621">(</span><span class="ident" id="1458622">elem</span><span class="op" id="1458626">.</span><span class="ident" id="1458627">size</span><span class="op" id="1458631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458634">c</span><span class="op" id="1458635">.</span><span class="ident" id="1458636">elemtype</span>&nbsp;<span class="op" id="1458645">=</span>&nbsp;<span class="ident" id="1458647">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458653">c</span><span class="op" id="1458654">.</span><span class="ident" id="1458655">dataqsiz</span>&nbsp;<span class="op" id="1458664">=</span>&nbsp;<span class="builtintype" id="1458666">uint</span><span class="op" id="1458670">(</span><span class="ident" id="1458671">size</span><span class="op" id="1458675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458679">if</span>&nbsp;<span class="ident" id="1458682">debugChan</span>&nbsp;<span class="op" id="1458692">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1458696">print</span><span class="op" id="1458701">(</span><span class="string" id="1458702">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1458719">,</span>&nbsp;<span class="ident" id="1458721">c</span><span class="op" id="1458722">,</span>&nbsp;<span class="string" id="1458724">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1458737">,</span>&nbsp;<span class="ident" id="1458739">elem</span><span class="op" id="1458743">.</span><span class="ident" id="1458744">size</span><span class="op" id="1458748">,</span>&nbsp;<span class="string" id="1458750">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1458762">,</span>&nbsp;<span class="ident" id="1458764">elem</span><span class="op" id="1458768">.</span><span class="ident" id="1458769">alg</span><span class="op" id="1458772">,</span>&nbsp;<span class="string" id="1458774">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1458787">,</span>&nbsp;<span class="ident" id="1458789">size</span><span class="op" id="1458793">,</span>&nbsp;<span class="string" id="1458795">&#34;\n&#34;</span><span class="op" id="1458799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458805">return</span>&nbsp;<span class="ident" id="1458812">c</span><br>
<span class="lineno"></span><span class="op" id="1458814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1458817">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1458877">func</span>&nbsp;<span class="ident" id="1458882">chanbuf</span><span class="op" id="1458889">(</span><span class="ident" id="1458890">c</span>&nbsp;<span class="op" id="1458892">*</span><span class="ident" id="1458893">hchan</span><span class="op" id="1458898">,</span>&nbsp;<span class="ident" id="1458900">i</span>&nbsp;<span class="builtintype" id="1458902">uint</span><span class="op" id="1458906">)</span>&nbsp;<span class="ident" id="1458908">unsafe</span><span class="op" id="1458914">.</span><span class="ident" id="1458915">Pointer</span>&nbsp;<span class="op" id="1458923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458926">return</span>&nbsp;<span class="ident" id="1458933">add</span><span class="op" id="1458936">(</span><span class="ident" id="1458937">unsafe</span><span class="op" id="1458943">.</span><span class="ident" id="1458944">Pointer</span><span class="op" id="1458951">(</span><span class="ident" id="1458952">c</span><span class="op" id="1458953">.</span><span class="ident" id="1458954">buf</span><span class="op" id="1458957">)</span><span class="op" id="1458958">,</span>&nbsp;<span class="builtintype" id="1458960">uintptr</span><span class="op" id="1458967">(</span><span class="ident" id="1458968">i</span><span class="op" id="1458969">)</span><span class="op" id="1458970">*</span><span class="builtintype" id="1458971">uintptr</span><span class="op" id="1458978">(</span><span class="ident" id="1458979">c</span><span class="op" id="1458980">.</span><span class="ident" id="1458981">elemsize</span><span class="op" id="1458989">)</span><span class="op" id="1458990">)</span><br>
<span class="lineno"></span><span class="op" id="1458992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1458995">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1459040">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1459053">func</span>&nbsp;<span class="ident" id="1459058">chansend1</span><span class="op" id="1459067">(</span><span class="ident" id="1459068">t</span>&nbsp;<span class="op" id="1459070">*</span><span class="ident" id="1459071">chantype</span><span class="op" id="1459079">,</span>&nbsp;<span class="ident" id="1459081">c</span>&nbsp;<span class="op" id="1459083">*</span><span class="ident" id="1459084">hchan</span><span class="op" id="1459089">,</span>&nbsp;<span class="ident" id="1459091">elem</span>&nbsp;<span class="ident" id="1459096">unsafe</span><span class="op" id="1459102">.</span><span class="ident" id="1459103">Pointer</span><span class="op" id="1459110">)</span>&nbsp;<span class="op" id="1459112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459115">chansend</span><span class="op" id="1459123">(</span><span class="ident" id="1459124">t</span><span class="op" id="1459125">,</span>&nbsp;<span class="ident" id="1459127">c</span><span class="op" id="1459128">,</span>&nbsp;<span class="ident" id="1459130">elem</span><span class="op" id="1459134">,</span>&nbsp;<span class="builtintype" id="1459136">true</span><span class="op" id="1459140">,</span>&nbsp;<span class="ident" id="1459142">getcallerpc</span><span class="op" id="1459153">(</span><span class="ident" id="1459154">unsafe</span><span class="op" id="1459160">.</span><span class="ident" id="1459161">Pointer</span><span class="op" id="1459168">(</span><span class="op" id="1459169">&amp;</span><span class="ident" id="1459170">t</span><span class="op" id="1459171">)</span><span class="op" id="1459172">)</span><span class="op" id="1459173">)</span><br>
<span class="lineno"></span><span class="op" id="1459175">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1459178">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1459512">func</span>&nbsp;<span class="ident" id="1459517">chansend</span><span class="op" id="1459525">(</span><span class="ident" id="1459526">t</span>&nbsp;<span class="op" id="1459528">*</span><span class="ident" id="1459529">chantype</span><span class="op" id="1459537">,</span>&nbsp;<span class="ident" id="1459539">c</span>&nbsp;<span class="op" id="1459541">*</span><span class="ident" id="1459542">hchan</span><span class="op" id="1459547">,</span>&nbsp;<span class="ident" id="1459549">ep</span>&nbsp;<span class="ident" id="1459552">unsafe</span><span class="op" id="1459558">.</span><span class="ident" id="1459559">Pointer</span><span class="op" id="1459566">,</span>&nbsp;<span class="ident" id="1459568">block</span>&nbsp;<span class="builtintype" id="1459574">bool</span><span class="op" id="1459578">,</span>&nbsp;<span class="ident" id="1459580">callerpc</span>&nbsp;<span class="builtintype" id="1459589">uintptr</span><span class="op" id="1459596">)</span>&nbsp;<span class="builtintype" id="1459598">bool</span>&nbsp;<span class="op" id="1459603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459606">if</span>&nbsp;<span class="ident" id="1459609">raceenabled</span>&nbsp;<span class="op" id="1459621">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459625">raceReadObjectPC</span><span class="op" id="1459641">(</span><span class="ident" id="1459642">t</span><span class="op" id="1459643">.</span><span class="ident" id="1459644">elem</span><span class="op" id="1459648">,</span>&nbsp;<span class="ident" id="1459650">ep</span><span class="op" id="1459652">,</span>&nbsp;<span class="ident" id="1459654">callerpc</span><span class="op" id="1459662">,</span>&nbsp;<span class="ident" id="1459664">funcPC</span><span class="op" id="1459670">(</span><span class="ident" id="1459671">chansend</span><span class="op" id="1459679">)</span><span class="op" id="1459680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459687">if</span>&nbsp;<span class="ident" id="1459690">c</span>&nbsp;<span class="op" id="1459692">==</span>&nbsp;<span class="builtintype" id="1459695">nil</span>&nbsp;<span class="op" id="1459699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459703">if</span>&nbsp;<span class="op" id="1459706">!</span><span class="ident" id="1459707">block</span>&nbsp;<span class="op" id="1459713">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459718">return</span>&nbsp;<span class="builtintype" id="1459725">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459737">gopark</span><span class="op" id="1459743">(</span><span class="builtintype" id="1459744">nil</span><span class="op" id="1459747">,</span>&nbsp;<span class="builtintype" id="1459749">nil</span><span class="op" id="1459752">,</span>&nbsp;<span class="string" id="1459754">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1459776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459780">gothrow</span><span class="op" id="1459787">(</span><span class="string" id="1459788">&#34;unreachable&#34;</span><span class="op" id="1459801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459804">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459808">if</span>&nbsp;<span class="ident" id="1459811">debugChan</span>&nbsp;<span class="op" id="1459821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1459825">print</span><span class="op" id="1459830">(</span><span class="string" id="1459831">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1459848">,</span>&nbsp;<span class="ident" id="1459850">c</span><span class="op" id="1459851">,</span>&nbsp;<span class="string" id="1459853">&#34;\n&#34;</span><span class="op" id="1459857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459864">if</span>&nbsp;<span class="ident" id="1459867">raceenabled</span>&nbsp;<span class="op" id="1459879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459883">racereadpc</span><span class="op" id="1459893">(</span><span class="ident" id="1459894">unsafe</span><span class="op" id="1459900">.</span><span class="ident" id="1459901">Pointer</span><span class="op" id="1459908">(</span><span class="ident" id="1459909">c</span><span class="op" id="1459910">)</span><span class="op" id="1459911">,</span>&nbsp;<span class="ident" id="1459913">callerpc</span><span class="op" id="1459921">,</span>&nbsp;<span class="ident" id="1459923">funcPC</span><span class="op" id="1459929">(</span><span class="ident" id="1459930">chansend</span><span class="op" id="1459938">)</span><span class="op" id="1459939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459946">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460029">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460033">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460116">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460198">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460286">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460361">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460450">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460531">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460618">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460663">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460667">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460753">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460837">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460893">if</span>&nbsp;<span class="op" id="1460896">!</span><span class="ident" id="1460897">block</span>&nbsp;<span class="op" id="1460903">&amp;&amp;</span>&nbsp;<span class="ident" id="1460906">c</span><span class="op" id="1460907">.</span><span class="ident" id="1460908">closed</span>&nbsp;<span class="op" id="1460915">==</span>&nbsp;<span class="num" id="1460918">0</span>&nbsp;<span class="op" id="1460920">&amp;&amp;</span>&nbsp;<span class="op" id="1460923">(</span><span class="op" id="1460924">(</span><span class="ident" id="1460925">c</span><span class="op" id="1460926">.</span><span class="ident" id="1460927">dataqsiz</span>&nbsp;<span class="op" id="1460936">==</span>&nbsp;<span class="num" id="1460939">0</span>&nbsp;<span class="op" id="1460941">&amp;&amp;</span>&nbsp;<span class="ident" id="1460944">c</span><span class="op" id="1460945">.</span><span class="ident" id="1460946">recvq</span><span class="op" id="1460951">.</span><span class="ident" id="1460952">first</span>&nbsp;<span class="op" id="1460958">==</span>&nbsp;<span class="builtintype" id="1460961">nil</span><span class="op" id="1460964">)</span>&nbsp;<span class="op" id="1460966">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460971">(</span><span class="ident" id="1460972">c</span><span class="op" id="1460973">.</span><span class="ident" id="1460974">dataqsiz</span>&nbsp;<span class="op" id="1460983">&gt;</span>&nbsp;<span class="num" id="1460985">0</span>&nbsp;<span class="op" id="1460987">&amp;&amp;</span>&nbsp;<span class="ident" id="1460990">c</span><span class="op" id="1460991">.</span><span class="ident" id="1460992">qcount</span>&nbsp;<span class="op" id="1460999">==</span>&nbsp;<span class="ident" id="1461002">c</span><span class="op" id="1461003">.</span><span class="ident" id="1461004">dataqsiz</span><span class="op" id="1461012">)</span><span class="op" id="1461013">)</span>&nbsp;<span class="op" id="1461015">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461019">return</span>&nbsp;<span class="builtintype" id="1461026">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461037">var</span>&nbsp;<span class="ident" id="1461041">t0</span>&nbsp;<span class="ident" id="1461044">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461051">if</span>&nbsp;<span class="ident" id="1461054">blockprofilerate</span>&nbsp;<span class="op" id="1461071">&gt;</span>&nbsp;<span class="num" id="1461073">0</span>&nbsp;<span class="op" id="1461075">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461079">t0</span>&nbsp;<span class="op" id="1461082">=</span>&nbsp;<span class="ident" id="1461084">cputicks</span><span class="op" id="1461092">(</span><span class="op" id="1461093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461100">lock</span><span class="op" id="1461104">(</span><span class="op" id="1461105">&amp;</span><span class="ident" id="1461106">c</span><span class="op" id="1461107">.</span><span class="ident" id="1461108">lock</span><span class="op" id="1461112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461115">if</span>&nbsp;<span class="ident" id="1461118">c</span><span class="op" id="1461119">.</span><span class="ident" id="1461120">closed</span>&nbsp;<span class="op" id="1461127">!=</span>&nbsp;<span class="num" id="1461130">0</span>&nbsp;<span class="op" id="1461132">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461136">unlock</span><span class="op" id="1461142">(</span><span class="op" id="1461143">&amp;</span><span class="ident" id="1461144">c</span><span class="op" id="1461145">.</span><span class="ident" id="1461146">lock</span><span class="op" id="1461150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1461154">panic</span><span class="op" id="1461159">(</span><span class="string" id="1461160">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1461184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461191">if</span>&nbsp;<span class="ident" id="1461194">c</span><span class="op" id="1461195">.</span><span class="ident" id="1461196">dataqsiz</span>&nbsp;<span class="op" id="1461205">==</span>&nbsp;<span class="num" id="1461208">0</span>&nbsp;<span class="op" id="1461210">{</span>&nbsp;<span class="comment" id="1461212">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461237">sg</span>&nbsp;<span class="op" id="1461240">:=</span>&nbsp;<span class="ident" id="1461243">c</span><span class="op" id="1461244">.</span><span class="ident" id="1461245">recvq</span><span class="op" id="1461250">.</span><span class="ident" id="1461251">dequeue</span><span class="op" id="1461258">(</span><span class="op" id="1461259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461263">if</span>&nbsp;<span class="ident" id="1461266">sg</span>&nbsp;<span class="op" id="1461269">!=</span>&nbsp;<span class="builtintype" id="1461272">nil</span>&nbsp;<span class="op" id="1461276">{</span>&nbsp;<span class="comment" id="1461278">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461309">if</span>&nbsp;<span class="ident" id="1461312">raceenabled</span>&nbsp;<span class="op" id="1461324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461330">racesync</span><span class="op" id="1461338">(</span><span class="ident" id="1461339">c</span><span class="op" id="1461340">,</span>&nbsp;<span class="ident" id="1461342">sg</span><span class="op" id="1461344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461349">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461354">unlock</span><span class="op" id="1461360">(</span><span class="op" id="1461361">&amp;</span><span class="ident" id="1461362">c</span><span class="op" id="1461363">.</span><span class="ident" id="1461364">lock</span><span class="op" id="1461368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461374">recvg</span>&nbsp;<span class="op" id="1461380">:=</span>&nbsp;<span class="ident" id="1461383">sg</span><span class="op" id="1461385">.</span><span class="ident" id="1461386">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461391">if</span>&nbsp;<span class="ident" id="1461394">sg</span><span class="op" id="1461396">.</span><span class="ident" id="1461397">elem</span>&nbsp;<span class="op" id="1461402">!=</span>&nbsp;<span class="builtintype" id="1461405">nil</span>&nbsp;<span class="op" id="1461409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461415">memmove</span><span class="op" id="1461422">(</span><span class="ident" id="1461423">unsafe</span><span class="op" id="1461429">.</span><span class="ident" id="1461430">Pointer</span><span class="op" id="1461437">(</span><span class="ident" id="1461438">sg</span><span class="op" id="1461440">.</span><span class="ident" id="1461441">elem</span><span class="op" id="1461445">)</span><span class="op" id="1461446">,</span>&nbsp;<span class="ident" id="1461448">ep</span><span class="op" id="1461450">,</span>&nbsp;<span class="builtintype" id="1461452">uintptr</span><span class="op" id="1461459">(</span><span class="ident" id="1461460">c</span><span class="op" id="1461461">.</span><span class="ident" id="1461462">elemsize</span><span class="op" id="1461470">)</span><span class="op" id="1461471">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461477">sg</span><span class="op" id="1461479">.</span><span class="ident" id="1461480">elem</span>&nbsp;<span class="op" id="1461485">=</span>&nbsp;<span class="builtintype" id="1461487">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461499">recvg</span><span class="op" id="1461504">.</span><span class="ident" id="1461505">param</span>&nbsp;<span class="op" id="1461511">=</span>&nbsp;<span class="ident" id="1461513">unsafe</span><span class="op" id="1461519">.</span><span class="ident" id="1461520">Pointer</span><span class="op" id="1461527">(</span><span class="ident" id="1461528">sg</span><span class="op" id="1461530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461535">if</span>&nbsp;<span class="ident" id="1461538">sg</span><span class="op" id="1461540">.</span><span class="ident" id="1461541">releasetime</span>&nbsp;<span class="op" id="1461553">!=</span>&nbsp;<span class="num" id="1461556">0</span>&nbsp;<span class="op" id="1461558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461564">sg</span><span class="op" id="1461566">.</span><span class="ident" id="1461567">releasetime</span>&nbsp;<span class="op" id="1461579">=</span>&nbsp;<span class="ident" id="1461581">cputicks</span><span class="op" id="1461589">(</span><span class="op" id="1461590">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461600">goready</span><span class="op" id="1461607">(</span><span class="ident" id="1461608">recvg</span><span class="op" id="1461613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461618">return</span>&nbsp;<span class="builtintype" id="1461625">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461637">if</span>&nbsp;<span class="op" id="1461640">!</span><span class="ident" id="1461641">block</span>&nbsp;<span class="op" id="1461647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461652">unlock</span><span class="op" id="1461658">(</span><span class="op" id="1461659">&amp;</span><span class="ident" id="1461660">c</span><span class="op" id="1461661">.</span><span class="ident" id="1461662">lock</span><span class="op" id="1461666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461671">return</span>&nbsp;<span class="builtintype" id="1461678">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461691">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461742">gp</span>&nbsp;<span class="op" id="1461745">:=</span>&nbsp;<span class="ident" id="1461748">getg</span><span class="op" id="1461752">(</span><span class="op" id="1461753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461757">mysg</span>&nbsp;<span class="op" id="1461762">:=</span>&nbsp;<span class="ident" id="1461765">acquireSudog</span><span class="op" id="1461777">(</span><span class="op" id="1461778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461782">mysg</span><span class="op" id="1461786">.</span><span class="ident" id="1461787">releasetime</span>&nbsp;<span class="op" id="1461799">=</span>&nbsp;<span class="num" id="1461801">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461805">if</span>&nbsp;<span class="ident" id="1461808">t0</span>&nbsp;<span class="op" id="1461811">!=</span>&nbsp;<span class="num" id="1461814">0</span>&nbsp;<span class="op" id="1461816">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461821">mysg</span><span class="op" id="1461825">.</span><span class="ident" id="1461826">releasetime</span>&nbsp;<span class="op" id="1461838">=</span>&nbsp;<span class="op" id="1461840">-</span><span class="num" id="1461841">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461849">mysg</span><span class="op" id="1461853">.</span><span class="ident" id="1461854">elem</span>&nbsp;<span class="op" id="1461859">=</span>&nbsp;<span class="ident" id="1461861">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461866">mysg</span><span class="op" id="1461870">.</span><span class="ident" id="1461871">waitlink</span>&nbsp;<span class="op" id="1461880">=</span>&nbsp;<span class="builtintype" id="1461882">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461888">gp</span><span class="op" id="1461890">.</span><span class="ident" id="1461891">waiting</span>&nbsp;<span class="op" id="1461899">=</span>&nbsp;<span class="ident" id="1461901">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461908">mysg</span><span class="op" id="1461912">.</span><span class="ident" id="1461913">g</span>&nbsp;<span class="op" id="1461915">=</span>&nbsp;<span class="ident" id="1461917">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461922">mysg</span><span class="op" id="1461926">.</span><span class="ident" id="1461927">selectdone</span>&nbsp;<span class="op" id="1461938">=</span>&nbsp;<span class="builtintype" id="1461940">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461946">gp</span><span class="op" id="1461948">.</span><span class="ident" id="1461949">param</span>&nbsp;<span class="op" id="1461955">=</span>&nbsp;<span class="builtintype" id="1461957">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461963">c</span><span class="op" id="1461964">.</span><span class="ident" id="1461965">sendq</span><span class="op" id="1461970">.</span><span class="ident" id="1461971">enqueue</span><span class="op" id="1461978">(</span><span class="ident" id="1461979">mysg</span><span class="op" id="1461983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461987">goparkunlock</span><span class="op" id="1461999">(</span><span class="op" id="1462000">&amp;</span><span class="ident" id="1462001">c</span><span class="op" id="1462002">.</span><span class="ident" id="1462003">lock</span><span class="op" id="1462007">,</span>&nbsp;<span class="string" id="1462009">&#34;chan&nbsp;send&#34;</span><span class="op" id="1462020">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462025">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462050">if</span>&nbsp;<span class="ident" id="1462053">mysg</span>&nbsp;<span class="op" id="1462058">!=</span>&nbsp;<span class="ident" id="1462061">gp</span><span class="op" id="1462063">.</span><span class="ident" id="1462064">waiting</span>&nbsp;<span class="op" id="1462072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462077">gothrow</span><span class="op" id="1462084">(</span><span class="string" id="1462085">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1462115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462119">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462123">gp</span><span class="op" id="1462125">.</span><span class="ident" id="1462126">waiting</span>&nbsp;<span class="op" id="1462134">=</span>&nbsp;<span class="builtintype" id="1462136">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462142">if</span>&nbsp;<span class="ident" id="1462145">gp</span><span class="op" id="1462147">.</span><span class="ident" id="1462148">param</span>&nbsp;<span class="op" id="1462154">==</span>&nbsp;<span class="builtintype" id="1462157">nil</span>&nbsp;<span class="op" id="1462161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462166">if</span>&nbsp;<span class="ident" id="1462169">c</span><span class="op" id="1462170">.</span><span class="ident" id="1462171">closed</span>&nbsp;<span class="op" id="1462178">==</span>&nbsp;<span class="num" id="1462181">0</span>&nbsp;<span class="op" id="1462183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462189">gothrow</span><span class="op" id="1462196">(</span><span class="string" id="1462197">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1462224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462229">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1462234">panic</span><span class="op" id="1462239">(</span><span class="string" id="1462240">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1462264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462272">gp</span><span class="op" id="1462274">.</span><span class="ident" id="1462275">param</span>&nbsp;<span class="op" id="1462281">=</span>&nbsp;<span class="builtintype" id="1462283">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462289">if</span>&nbsp;<span class="ident" id="1462292">mysg</span><span class="op" id="1462296">.</span><span class="ident" id="1462297">releasetime</span>&nbsp;<span class="op" id="1462309">&gt;</span>&nbsp;<span class="num" id="1462311">0</span>&nbsp;<span class="op" id="1462313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462318">blockevent</span><span class="op" id="1462328">(</span><span class="ident" id="1462329">int64</span><span class="op" id="1462334">(</span><span class="ident" id="1462335">mysg</span><span class="op" id="1462339">.</span><span class="ident" id="1462340">releasetime</span><span class="op" id="1462351">)</span><span class="op" id="1462352">-</span><span class="ident" id="1462353">t0</span><span class="op" id="1462355">,</span>&nbsp;<span class="num" id="1462357">2</span><span class="op" id="1462358">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462366">releaseSudog</span><span class="op" id="1462378">(</span><span class="ident" id="1462379">mysg</span><span class="op" id="1462383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462387">return</span>&nbsp;<span class="builtintype" id="1462394">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462404">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462429">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462471">var</span>&nbsp;<span class="ident" id="1462475">t1</span>&nbsp;<span class="ident" id="1462478">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462485">for</span>&nbsp;<span class="ident" id="1462489">c</span><span class="op" id="1462490">.</span><span class="ident" id="1462491">qcount</span>&nbsp;<span class="op" id="1462498">&gt;=</span>&nbsp;<span class="ident" id="1462501">c</span><span class="op" id="1462502">.</span><span class="ident" id="1462503">dataqsiz</span>&nbsp;<span class="op" id="1462512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462516">if</span>&nbsp;<span class="op" id="1462519">!</span><span class="ident" id="1462520">block</span>&nbsp;<span class="op" id="1462526">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462531">unlock</span><span class="op" id="1462537">(</span><span class="op" id="1462538">&amp;</span><span class="ident" id="1462539">c</span><span class="op" id="1462540">.</span><span class="ident" id="1462541">lock</span><span class="op" id="1462545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462550">return</span>&nbsp;<span class="builtintype" id="1462557">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462569">gp</span>&nbsp;<span class="op" id="1462572">:=</span>&nbsp;<span class="ident" id="1462575">getg</span><span class="op" id="1462579">(</span><span class="op" id="1462580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462584">mysg</span>&nbsp;<span class="op" id="1462589">:=</span>&nbsp;<span class="ident" id="1462592">acquireSudog</span><span class="op" id="1462604">(</span><span class="op" id="1462605">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462609">mysg</span><span class="op" id="1462613">.</span><span class="ident" id="1462614">releasetime</span>&nbsp;<span class="op" id="1462626">=</span>&nbsp;<span class="num" id="1462628">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462632">if</span>&nbsp;<span class="ident" id="1462635">t0</span>&nbsp;<span class="op" id="1462638">!=</span>&nbsp;<span class="num" id="1462641">0</span>&nbsp;<span class="op" id="1462643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462648">mysg</span><span class="op" id="1462652">.</span><span class="ident" id="1462653">releasetime</span>&nbsp;<span class="op" id="1462665">=</span>&nbsp;<span class="op" id="1462667">-</span><span class="num" id="1462668">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462676">mysg</span><span class="op" id="1462680">.</span><span class="ident" id="1462681">g</span>&nbsp;<span class="op" id="1462683">=</span>&nbsp;<span class="ident" id="1462685">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462690">mysg</span><span class="op" id="1462694">.</span><span class="ident" id="1462695">elem</span>&nbsp;<span class="op" id="1462700">=</span>&nbsp;<span class="builtintype" id="1462702">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462708">mysg</span><span class="op" id="1462712">.</span><span class="ident" id="1462713">selectdone</span>&nbsp;<span class="op" id="1462724">=</span>&nbsp;<span class="builtintype" id="1462726">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462732">c</span><span class="op" id="1462733">.</span><span class="ident" id="1462734">sendq</span><span class="op" id="1462739">.</span><span class="ident" id="1462740">enqueue</span><span class="op" id="1462747">(</span><span class="ident" id="1462748">mysg</span><span class="op" id="1462752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462756">goparkunlock</span><span class="op" id="1462768">(</span><span class="op" id="1462769">&amp;</span><span class="ident" id="1462770">c</span><span class="op" id="1462771">.</span><span class="ident" id="1462772">lock</span><span class="op" id="1462776">,</span>&nbsp;<span class="string" id="1462778">&#34;chan&nbsp;send&#34;</span><span class="op" id="1462789">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462794">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462830">if</span>&nbsp;<span class="ident" id="1462833">mysg</span><span class="op" id="1462837">.</span><span class="ident" id="1462838">releasetime</span>&nbsp;<span class="op" id="1462850">&gt;</span>&nbsp;<span class="num" id="1462852">0</span>&nbsp;<span class="op" id="1462854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462859">t1</span>&nbsp;<span class="op" id="1462862">=</span>&nbsp;<span class="ident" id="1462864">mysg</span><span class="op" id="1462868">.</span><span class="ident" id="1462869">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462887">releaseSudog</span><span class="op" id="1462899">(</span><span class="ident" id="1462900">mysg</span><span class="op" id="1462904">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462908">lock</span><span class="op" id="1462912">(</span><span class="op" id="1462913">&amp;</span><span class="ident" id="1462914">c</span><span class="op" id="1462915">.</span><span class="ident" id="1462916">lock</span><span class="op" id="1462920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462924">if</span>&nbsp;<span class="ident" id="1462927">c</span><span class="op" id="1462928">.</span><span class="ident" id="1462929">closed</span>&nbsp;<span class="op" id="1462936">!=</span>&nbsp;<span class="num" id="1462939">0</span>&nbsp;<span class="op" id="1462941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462946">unlock</span><span class="op" id="1462952">(</span><span class="op" id="1462953">&amp;</span><span class="ident" id="1462954">c</span><span class="op" id="1462955">.</span><span class="ident" id="1462956">lock</span><span class="op" id="1462960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1462965">panic</span><span class="op" id="1462970">(</span><span class="string" id="1462971">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1462995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462999">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1463006">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463049">if</span>&nbsp;<span class="ident" id="1463052">raceenabled</span>&nbsp;<span class="op" id="1463064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463068">raceacquire</span><span class="op" id="1463079">(</span><span class="ident" id="1463080">chanbuf</span><span class="op" id="1463087">(</span><span class="ident" id="1463088">c</span><span class="op" id="1463089">,</span>&nbsp;<span class="ident" id="1463091">c</span><span class="op" id="1463092">.</span><span class="ident" id="1463093">sendx</span><span class="op" id="1463098">)</span><span class="op" id="1463099">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463103">racerelease</span><span class="op" id="1463114">(</span><span class="ident" id="1463115">chanbuf</span><span class="op" id="1463122">(</span><span class="ident" id="1463123">c</span><span class="op" id="1463124">,</span>&nbsp;<span class="ident" id="1463126">c</span><span class="op" id="1463127">.</span><span class="ident" id="1463128">sendx</span><span class="op" id="1463133">)</span><span class="op" id="1463134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463140">memmove</span><span class="op" id="1463147">(</span><span class="ident" id="1463148">chanbuf</span><span class="op" id="1463155">(</span><span class="ident" id="1463156">c</span><span class="op" id="1463157">,</span>&nbsp;<span class="ident" id="1463159">c</span><span class="op" id="1463160">.</span><span class="ident" id="1463161">sendx</span><span class="op" id="1463166">)</span><span class="op" id="1463167">,</span>&nbsp;<span class="ident" id="1463169">ep</span><span class="op" id="1463171">,</span>&nbsp;<span class="builtintype" id="1463173">uintptr</span><span class="op" id="1463180">(</span><span class="ident" id="1463181">c</span><span class="op" id="1463182">.</span><span class="ident" id="1463183">elemsize</span><span class="op" id="1463191">)</span><span class="op" id="1463192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463195">c</span><span class="op" id="1463196">.</span><span class="ident" id="1463197">sendx</span><span class="op" id="1463202">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463206">if</span>&nbsp;<span class="ident" id="1463209">c</span><span class="op" id="1463210">.</span><span class="ident" id="1463211">sendx</span>&nbsp;<span class="op" id="1463217">==</span>&nbsp;<span class="ident" id="1463220">c</span><span class="op" id="1463221">.</span><span class="ident" id="1463222">dataqsiz</span>&nbsp;<span class="op" id="1463231">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463235">c</span><span class="op" id="1463236">.</span><span class="ident" id="1463237">sendx</span>&nbsp;<span class="op" id="1463243">=</span>&nbsp;<span class="num" id="1463245">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463251">c</span><span class="op" id="1463252">.</span><span class="ident" id="1463253">qcount</span><span class="op" id="1463259">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1463264">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463295">sg</span>&nbsp;<span class="op" id="1463298">:=</span>&nbsp;<span class="ident" id="1463301">c</span><span class="op" id="1463302">.</span><span class="ident" id="1463303">recvq</span><span class="op" id="1463308">.</span><span class="ident" id="1463309">dequeue</span><span class="op" id="1463316">(</span><span class="op" id="1463317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463320">if</span>&nbsp;<span class="ident" id="1463323">sg</span>&nbsp;<span class="op" id="1463326">!=</span>&nbsp;<span class="builtintype" id="1463329">nil</span>&nbsp;<span class="op" id="1463333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463337">recvg</span>&nbsp;<span class="op" id="1463343">:=</span>&nbsp;<span class="ident" id="1463346">sg</span><span class="op" id="1463348">.</span><span class="ident" id="1463349">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463353">unlock</span><span class="op" id="1463359">(</span><span class="op" id="1463360">&amp;</span><span class="ident" id="1463361">c</span><span class="op" id="1463362">.</span><span class="ident" id="1463363">lock</span><span class="op" id="1463367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463371">if</span>&nbsp;<span class="ident" id="1463374">sg</span><span class="op" id="1463376">.</span><span class="ident" id="1463377">releasetime</span>&nbsp;<span class="op" id="1463389">!=</span>&nbsp;<span class="num" id="1463392">0</span>&nbsp;<span class="op" id="1463394">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463399">sg</span><span class="op" id="1463401">.</span><span class="ident" id="1463402">releasetime</span>&nbsp;<span class="op" id="1463414">=</span>&nbsp;<span class="ident" id="1463416">cputicks</span><span class="op" id="1463424">(</span><span class="op" id="1463425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463433">goready</span><span class="op" id="1463440">(</span><span class="ident" id="1463441">recvg</span><span class="op" id="1463446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463449">}</span>&nbsp;<span class="keyword" id="1463451">else</span>&nbsp;<span class="op" id="1463456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463460">unlock</span><span class="op" id="1463466">(</span><span class="op" id="1463467">&amp;</span><span class="ident" id="1463468">c</span><span class="op" id="1463469">.</span><span class="ident" id="1463470">lock</span><span class="op" id="1463474">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463480">if</span>&nbsp;<span class="ident" id="1463483">t1</span>&nbsp;<span class="op" id="1463486">&gt;</span>&nbsp;<span class="num" id="1463488">0</span>&nbsp;<span class="op" id="1463490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463494">blockevent</span><span class="op" id="1463504">(</span><span class="ident" id="1463505">t1</span><span class="op" id="1463507">-</span><span class="ident" id="1463508">t0</span><span class="op" id="1463510">,</span>&nbsp;<span class="num" id="1463512">2</span><span class="op" id="1463513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463519">return</span>&nbsp;<span class="builtintype" id="1463526">true</span><br>
<span class="lineno">255</span><span class="op" id="1463531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1463534">func</span>&nbsp;<span class="ident" id="1463539">closechan</span><span class="op" id="1463548">(</span><span class="ident" id="1463549">c</span>&nbsp;<span class="op" id="1463551">*</span><span class="ident" id="1463552">hchan</span><span class="op" id="1463557">)</span>&nbsp;<span class="op" id="1463559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463562">if</span>&nbsp;<span class="ident" id="1463565">c</span>&nbsp;<span class="op" id="1463567">==</span>&nbsp;<span class="builtintype" id="1463570">nil</span>&nbsp;<span class="op" id="1463574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1463578">panic</span><span class="op" id="1463583">(</span><span class="string" id="1463584">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1463606">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463613">lock</span><span class="op" id="1463617">(</span><span class="op" id="1463618">&amp;</span><span class="ident" id="1463619">c</span><span class="op" id="1463620">.</span><span class="ident" id="1463621">lock</span><span class="op" id="1463625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463628">if</span>&nbsp;<span class="ident" id="1463631">c</span><span class="op" id="1463632">.</span><span class="ident" id="1463633">closed</span>&nbsp;<span class="op" id="1463640">!=</span>&nbsp;<span class="num" id="1463643">0</span>&nbsp;<span class="op" id="1463645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463649">unlock</span><span class="op" id="1463655">(</span><span class="op" id="1463656">&amp;</span><span class="ident" id="1463657">c</span><span class="op" id="1463658">.</span><span class="ident" id="1463659">lock</span><span class="op" id="1463663">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1463667">panic</span><span class="op" id="1463672">(</span><span class="string" id="1463673">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1463698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463705">if</span>&nbsp;<span class="ident" id="1463708">raceenabled</span>&nbsp;<span class="op" id="1463720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463724">callerpc</span>&nbsp;<span class="op" id="1463733">:=</span>&nbsp;<span class="ident" id="1463736">getcallerpc</span><span class="op" id="1463747">(</span><span class="ident" id="1463748">unsafe</span><span class="op" id="1463754">.</span><span class="ident" id="1463755">Pointer</span><span class="op" id="1463762">(</span><span class="op" id="1463763">&amp;</span><span class="ident" id="1463764">c</span><span class="op" id="1463765">)</span><span class="op" id="1463766">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463770">racewritepc</span><span class="op" id="1463781">(</span><span class="ident" id="1463782">unsafe</span><span class="op" id="1463788">.</span><span class="ident" id="1463789">Pointer</span><span class="op" id="1463796">(</span><span class="ident" id="1463797">c</span><span class="op" id="1463798">)</span><span class="op" id="1463799">,</span>&nbsp;<span class="ident" id="1463801">callerpc</span><span class="op" id="1463809">,</span>&nbsp;<span class="ident" id="1463811">funcPC</span><span class="op" id="1463817">(</span><span class="ident" id="1463818">closechan</span><span class="op" id="1463827">)</span><span class="op" id="1463828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463832">racerelease</span><span class="op" id="1463843">(</span><span class="ident" id="1463844">unsafe</span><span class="op" id="1463850">.</span><span class="ident" id="1463851">Pointer</span><span class="op" id="1463858">(</span><span class="ident" id="1463859">c</span><span class="op" id="1463860">)</span><span class="op" id="1463861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463868">c</span><span class="op" id="1463869">.</span><span class="ident" id="1463870">closed</span>&nbsp;<span class="op" id="1463877">=</span>&nbsp;<span class="num" id="1463879">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1463883">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463907">for</span>&nbsp;<span class="op" id="1463911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463915">sg</span>&nbsp;<span class="op" id="1463918">:=</span>&nbsp;<span class="ident" id="1463921">c</span><span class="op" id="1463922">.</span><span class="ident" id="1463923">recvq</span><span class="op" id="1463928">.</span><span class="ident" id="1463929">dequeue</span><span class="op" id="1463936">(</span><span class="op" id="1463937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463941">if</span>&nbsp;<span class="ident" id="1463944">sg</span>&nbsp;<span class="op" id="1463947">==</span>&nbsp;<span class="builtintype" id="1463950">nil</span>&nbsp;<span class="op" id="1463954">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463959">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463971">gp</span>&nbsp;<span class="op" id="1463974">:=</span>&nbsp;<span class="ident" id="1463977">sg</span><span class="op" id="1463979">.</span><span class="ident" id="1463980">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463984">sg</span><span class="op" id="1463986">.</span><span class="ident" id="1463987">elem</span>&nbsp;<span class="op" id="1463992">=</span>&nbsp;<span class="builtintype" id="1463994">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464000">gp</span><span class="op" id="1464002">.</span><span class="ident" id="1464003">param</span>&nbsp;<span class="op" id="1464009">=</span>&nbsp;<span class="builtintype" id="1464011">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464017">if</span>&nbsp;<span class="ident" id="1464020">sg</span><span class="op" id="1464022">.</span><span class="ident" id="1464023">releasetime</span>&nbsp;<span class="op" id="1464035">!=</span>&nbsp;<span class="num" id="1464038">0</span>&nbsp;<span class="op" id="1464040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464045">sg</span><span class="op" id="1464047">.</span><span class="ident" id="1464048">releasetime</span>&nbsp;<span class="op" id="1464060">=</span>&nbsp;<span class="ident" id="1464062">cputicks</span><span class="op" id="1464070">(</span><span class="op" id="1464071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464079">goready</span><span class="op" id="1464086">(</span><span class="ident" id="1464087">gp</span><span class="op" id="1464089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464092">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464096">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464120">for</span>&nbsp;<span class="op" id="1464124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464128">sg</span>&nbsp;<span class="op" id="1464131">:=</span>&nbsp;<span class="ident" id="1464134">c</span><span class="op" id="1464135">.</span><span class="ident" id="1464136">sendq</span><span class="op" id="1464141">.</span><span class="ident" id="1464142">dequeue</span><span class="op" id="1464149">(</span><span class="op" id="1464150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464154">if</span>&nbsp;<span class="ident" id="1464157">sg</span>&nbsp;<span class="op" id="1464160">==</span>&nbsp;<span class="builtintype" id="1464163">nil</span>&nbsp;<span class="op" id="1464167">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464172">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464184">gp</span>&nbsp;<span class="op" id="1464187">:=</span>&nbsp;<span class="ident" id="1464190">sg</span><span class="op" id="1464192">.</span><span class="ident" id="1464193">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464197">sg</span><span class="op" id="1464199">.</span><span class="ident" id="1464200">elem</span>&nbsp;<span class="op" id="1464205">=</span>&nbsp;<span class="builtintype" id="1464207">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464213">gp</span><span class="op" id="1464215">.</span><span class="ident" id="1464216">param</span>&nbsp;<span class="op" id="1464222">=</span>&nbsp;<span class="builtintype" id="1464224">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464230">if</span>&nbsp;<span class="ident" id="1464233">sg</span><span class="op" id="1464235">.</span><span class="ident" id="1464236">releasetime</span>&nbsp;<span class="op" id="1464248">!=</span>&nbsp;<span class="num" id="1464251">0</span>&nbsp;<span class="op" id="1464253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464258">sg</span><span class="op" id="1464260">.</span><span class="ident" id="1464261">releasetime</span>&nbsp;<span class="op" id="1464273">=</span>&nbsp;<span class="ident" id="1464275">cputicks</span><span class="op" id="1464283">(</span><span class="op" id="1464284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464292">goready</span><span class="op" id="1464299">(</span><span class="ident" id="1464300">gp</span><span class="op" id="1464302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464305">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464308">unlock</span><span class="op" id="1464314">(</span><span class="op" id="1464315">&amp;</span><span class="ident" id="1464316">c</span><span class="op" id="1464317">.</span><span class="ident" id="1464318">lock</span><span class="op" id="1464322">)</span><br>
<span class="lineno"></span><span class="op" id="1464324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1464327">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1464371">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1464384">func</span>&nbsp;<span class="ident" id="1464389">chanrecv1</span><span class="op" id="1464398">(</span><span class="ident" id="1464399">t</span>&nbsp;<span class="op" id="1464401">*</span><span class="ident" id="1464402">chantype</span><span class="op" id="1464410">,</span>&nbsp;<span class="ident" id="1464412">c</span>&nbsp;<span class="op" id="1464414">*</span><span class="ident" id="1464415">hchan</span><span class="op" id="1464420">,</span>&nbsp;<span class="ident" id="1464422">elem</span>&nbsp;<span class="ident" id="1464427">unsafe</span><span class="op" id="1464433">.</span><span class="ident" id="1464434">Pointer</span><span class="op" id="1464441">)</span>&nbsp;<span class="op" id="1464443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464446">chanrecv</span><span class="op" id="1464454">(</span><span class="ident" id="1464455">t</span><span class="op" id="1464456">,</span>&nbsp;<span class="ident" id="1464458">c</span><span class="op" id="1464459">,</span>&nbsp;<span class="ident" id="1464461">elem</span><span class="op" id="1464465">,</span>&nbsp;<span class="builtintype" id="1464467">true</span><span class="op" id="1464471">)</span><br>
<span class="lineno"></span><span class="op" id="1464473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1464476">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1464489">func</span>&nbsp;<span class="ident" id="1464494">chanrecv2</span><span class="op" id="1464503">(</span><span class="ident" id="1464504">t</span>&nbsp;<span class="op" id="1464506">*</span><span class="ident" id="1464507">chantype</span><span class="op" id="1464515">,</span>&nbsp;<span class="ident" id="1464517">c</span>&nbsp;<span class="op" id="1464519">*</span><span class="ident" id="1464520">hchan</span><span class="op" id="1464525">,</span>&nbsp;<span class="ident" id="1464527">elem</span>&nbsp;<span class="ident" id="1464532">unsafe</span><span class="op" id="1464538">.</span><span class="ident" id="1464539">Pointer</span><span class="op" id="1464546">)</span>&nbsp;<span class="op" id="1464548">(</span><span class="ident" id="1464549">received</span>&nbsp;<span class="builtintype" id="1464558">bool</span><span class="op" id="1464562">)</span>&nbsp;<span class="op" id="1464564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464567">_</span><span class="op" id="1464568">,</span>&nbsp;<span class="ident" id="1464570">received</span>&nbsp;<span class="op" id="1464579">=</span>&nbsp;<span class="ident" id="1464581">chanrecv</span><span class="op" id="1464589">(</span><span class="ident" id="1464590">t</span><span class="op" id="1464591">,</span>&nbsp;<span class="ident" id="1464593">c</span><span class="op" id="1464594">,</span>&nbsp;<span class="ident" id="1464596">elem</span><span class="op" id="1464600">,</span>&nbsp;<span class="builtintype" id="1464602">true</span><span class="op" id="1464606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464609">return</span><br>
<span class="lineno"></span><span class="op" id="1464616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1464619">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1464689">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1464747">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1464823">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1464890">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1464959">func</span>&nbsp;<span class="ident" id="1464964">chanrecv</span><span class="op" id="1464972">(</span><span class="ident" id="1464973">t</span>&nbsp;<span class="op" id="1464975">*</span><span class="ident" id="1464976">chantype</span><span class="op" id="1464984">,</span>&nbsp;<span class="ident" id="1464986">c</span>&nbsp;<span class="op" id="1464988">*</span><span class="ident" id="1464989">hchan</span><span class="op" id="1464994">,</span>&nbsp;<span class="ident" id="1464996">ep</span>&nbsp;<span class="ident" id="1464999">unsafe</span><span class="op" id="1465005">.</span><span class="ident" id="1465006">Pointer</span><span class="op" id="1465013">,</span>&nbsp;<span class="ident" id="1465015">block</span>&nbsp;<span class="builtintype" id="1465021">bool</span><span class="op" id="1465025">)</span>&nbsp;<span class="op" id="1465027">(</span><span class="ident" id="1465028">selected</span><span class="op" id="1465036">,</span>&nbsp;<span class="ident" id="1465038">received</span>&nbsp;<span class="builtintype" id="1465047">bool</span><span class="op" id="1465051">)</span>&nbsp;<span class="op" id="1465053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465056">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465128">if</span>&nbsp;<span class="ident" id="1465131">debugChan</span>&nbsp;<span class="op" id="1465141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1465145">print</span><span class="op" id="1465150">(</span><span class="string" id="1465151">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1465168">,</span>&nbsp;<span class="ident" id="1465170">c</span><span class="op" id="1465171">,</span>&nbsp;<span class="string" id="1465173">&#34;\n&#34;</span><span class="op" id="1465177">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465184">if</span>&nbsp;<span class="ident" id="1465187">c</span>&nbsp;<span class="op" id="1465189">==</span>&nbsp;<span class="builtintype" id="1465192">nil</span>&nbsp;<span class="op" id="1465196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465200">if</span>&nbsp;<span class="op" id="1465203">!</span><span class="ident" id="1465204">block</span>&nbsp;<span class="op" id="1465210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465215">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465228">gopark</span><span class="op" id="1465234">(</span><span class="builtintype" id="1465235">nil</span><span class="op" id="1465238">,</span>&nbsp;<span class="builtintype" id="1465240">nil</span><span class="op" id="1465243">,</span>&nbsp;<span class="string" id="1465245">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1465270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465274">gothrow</span><span class="op" id="1465281">(</span><span class="string" id="1465282">&#34;unreachable&#34;</span><span class="op" id="1465295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465302">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465385">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465389">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465474">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465556">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465616">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465695">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465773">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465851">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465899">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465903">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465987">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466036">if</span>&nbsp;<span class="op" id="1466039">!</span><span class="ident" id="1466040">block</span>&nbsp;<span class="op" id="1466046">&amp;&amp;</span>&nbsp;<span class="op" id="1466049">(</span><span class="ident" id="1466050">c</span><span class="op" id="1466051">.</span><span class="ident" id="1466052">dataqsiz</span>&nbsp;<span class="op" id="1466061">==</span>&nbsp;<span class="num" id="1466064">0</span>&nbsp;<span class="op" id="1466066">&amp;&amp;</span>&nbsp;<span class="ident" id="1466069">c</span><span class="op" id="1466070">.</span><span class="ident" id="1466071">sendq</span><span class="op" id="1466076">.</span><span class="ident" id="1466077">first</span>&nbsp;<span class="op" id="1466083">==</span>&nbsp;<span class="builtintype" id="1466086">nil</span>&nbsp;<span class="op" id="1466090">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466095">c</span><span class="op" id="1466096">.</span><span class="ident" id="1466097">dataqsiz</span>&nbsp;<span class="op" id="1466106">&gt;</span>&nbsp;<span class="num" id="1466108">0</span>&nbsp;<span class="op" id="1466110">&amp;&amp;</span>&nbsp;<span class="ident" id="1466113">atomicloaduint</span><span class="op" id="1466127">(</span><span class="op" id="1466128">&amp;</span><span class="ident" id="1466129">c</span><span class="op" id="1466130">.</span><span class="ident" id="1466131">qcount</span><span class="op" id="1466137">)</span>&nbsp;<span class="op" id="1466139">==</span>&nbsp;<span class="num" id="1466142">0</span><span class="op" id="1466143">)</span>&nbsp;<span class="op" id="1466145">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466150">atomicload</span><span class="op" id="1466160">(</span><span class="op" id="1466161">&amp;</span><span class="ident" id="1466162">c</span><span class="op" id="1466163">.</span><span class="ident" id="1466164">closed</span><span class="op" id="1466170">)</span>&nbsp;<span class="op" id="1466172">==</span>&nbsp;<span class="num" id="1466175">0</span>&nbsp;<span class="op" id="1466177">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466181">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466193">var</span>&nbsp;<span class="ident" id="1466197">t0</span>&nbsp;<span class="ident" id="1466200">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466207">if</span>&nbsp;<span class="ident" id="1466210">blockprofilerate</span>&nbsp;<span class="op" id="1466227">&gt;</span>&nbsp;<span class="num" id="1466229">0</span>&nbsp;<span class="op" id="1466231">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466235">t0</span>&nbsp;<span class="op" id="1466238">=</span>&nbsp;<span class="ident" id="1466240">cputicks</span><span class="op" id="1466248">(</span><span class="op" id="1466249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466256">lock</span><span class="op" id="1466260">(</span><span class="op" id="1466261">&amp;</span><span class="ident" id="1466262">c</span><span class="op" id="1466263">.</span><span class="ident" id="1466264">lock</span><span class="op" id="1466268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466271">if</span>&nbsp;<span class="ident" id="1466274">c</span><span class="op" id="1466275">.</span><span class="ident" id="1466276">dataqsiz</span>&nbsp;<span class="op" id="1466285">==</span>&nbsp;<span class="num" id="1466288">0</span>&nbsp;<span class="op" id="1466290">{</span>&nbsp;<span class="comment" id="1466292">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466317">if</span>&nbsp;<span class="ident" id="1466320">c</span><span class="op" id="1466321">.</span><span class="ident" id="1466322">closed</span>&nbsp;<span class="op" id="1466329">!=</span>&nbsp;<span class="num" id="1466332">0</span>&nbsp;<span class="op" id="1466334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466339">return</span>&nbsp;<span class="ident" id="1466346">recvclosed</span><span class="op" id="1466356">(</span><span class="ident" id="1466357">c</span><span class="op" id="1466358">,</span>&nbsp;<span class="ident" id="1466360">ep</span><span class="op" id="1466362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466371">sg</span>&nbsp;<span class="op" id="1466374">:=</span>&nbsp;<span class="ident" id="1466377">c</span><span class="op" id="1466378">.</span><span class="ident" id="1466379">sendq</span><span class="op" id="1466384">.</span><span class="ident" id="1466385">dequeue</span><span class="op" id="1466392">(</span><span class="op" id="1466393">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466397">if</span>&nbsp;<span class="ident" id="1466400">sg</span>&nbsp;<span class="op" id="1466403">!=</span>&nbsp;<span class="builtintype" id="1466406">nil</span>&nbsp;<span class="op" id="1466410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466415">if</span>&nbsp;<span class="ident" id="1466418">raceenabled</span>&nbsp;<span class="op" id="1466430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466436">racesync</span><span class="op" id="1466444">(</span><span class="ident" id="1466445">c</span><span class="op" id="1466446">,</span>&nbsp;<span class="ident" id="1466448">sg</span><span class="op" id="1466450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466460">unlock</span><span class="op" id="1466466">(</span><span class="op" id="1466467">&amp;</span><span class="ident" id="1466468">c</span><span class="op" id="1466469">.</span><span class="ident" id="1466470">lock</span><span class="op" id="1466474">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466480">if</span>&nbsp;<span class="ident" id="1466483">ep</span>&nbsp;<span class="op" id="1466486">!=</span>&nbsp;<span class="builtintype" id="1466489">nil</span>&nbsp;<span class="op" id="1466493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466499">memmove</span><span class="op" id="1466506">(</span><span class="ident" id="1466507">ep</span><span class="op" id="1466509">,</span>&nbsp;<span class="ident" id="1466511">sg</span><span class="op" id="1466513">.</span><span class="ident" id="1466514">elem</span><span class="op" id="1466518">,</span>&nbsp;<span class="builtintype" id="1466520">uintptr</span><span class="op" id="1466527">(</span><span class="ident" id="1466528">c</span><span class="op" id="1466529">.</span><span class="ident" id="1466530">elemsize</span><span class="op" id="1466538">)</span><span class="op" id="1466539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466549">sg</span><span class="op" id="1466551">.</span><span class="ident" id="1466552">elem</span>&nbsp;<span class="op" id="1466557">=</span>&nbsp;<span class="builtintype" id="1466559">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466566">gp</span>&nbsp;<span class="op" id="1466569">:=</span>&nbsp;<span class="ident" id="1466572">sg</span><span class="op" id="1466574">.</span><span class="ident" id="1466575">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466580">gp</span><span class="op" id="1466582">.</span><span class="ident" id="1466583">param</span>&nbsp;<span class="op" id="1466589">=</span>&nbsp;<span class="ident" id="1466591">unsafe</span><span class="op" id="1466597">.</span><span class="ident" id="1466598">Pointer</span><span class="op" id="1466605">(</span><span class="ident" id="1466606">sg</span><span class="op" id="1466608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466613">if</span>&nbsp;<span class="ident" id="1466616">sg</span><span class="op" id="1466618">.</span><span class="ident" id="1466619">releasetime</span>&nbsp;<span class="op" id="1466631">!=</span>&nbsp;<span class="num" id="1466634">0</span>&nbsp;<span class="op" id="1466636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466642">sg</span><span class="op" id="1466644">.</span><span class="ident" id="1466645">releasetime</span>&nbsp;<span class="op" id="1466657">=</span>&nbsp;<span class="ident" id="1466659">cputicks</span><span class="op" id="1466667">(</span><span class="op" id="1466668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466673">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466678">goready</span><span class="op" id="1466685">(</span><span class="ident" id="1466686">gp</span><span class="op" id="1466688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466693">selected</span>&nbsp;<span class="op" id="1466702">=</span>&nbsp;<span class="builtintype" id="1466704">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466712">received</span>&nbsp;<span class="op" id="1466721">=</span>&nbsp;<span class="builtintype" id="1466723">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466731">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466740">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466745">if</span>&nbsp;<span class="op" id="1466748">!</span><span class="ident" id="1466749">block</span>&nbsp;<span class="op" id="1466755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466760">unlock</span><span class="op" id="1466766">(</span><span class="op" id="1466767">&amp;</span><span class="ident" id="1466768">c</span><span class="op" id="1466769">.</span><span class="ident" id="1466770">lock</span><span class="op" id="1466774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466779">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466788">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466793">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466842">gp</span>&nbsp;<span class="op" id="1466845">:=</span>&nbsp;<span class="ident" id="1466848">getg</span><span class="op" id="1466852">(</span><span class="op" id="1466853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466857">mysg</span>&nbsp;<span class="op" id="1466862">:=</span>&nbsp;<span class="ident" id="1466865">acquireSudog</span><span class="op" id="1466877">(</span><span class="op" id="1466878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466882">mysg</span><span class="op" id="1466886">.</span><span class="ident" id="1466887">releasetime</span>&nbsp;<span class="op" id="1466899">=</span>&nbsp;<span class="num" id="1466901">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466905">if</span>&nbsp;<span class="ident" id="1466908">t0</span>&nbsp;<span class="op" id="1466911">!=</span>&nbsp;<span class="num" id="1466914">0</span>&nbsp;<span class="op" id="1466916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466921">mysg</span><span class="op" id="1466925">.</span><span class="ident" id="1466926">releasetime</span>&nbsp;<span class="op" id="1466938">=</span>&nbsp;<span class="op" id="1466940">-</span><span class="num" id="1466941">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466949">mysg</span><span class="op" id="1466953">.</span><span class="ident" id="1466954">elem</span>&nbsp;<span class="op" id="1466959">=</span>&nbsp;<span class="ident" id="1466961">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466966">mysg</span><span class="op" id="1466970">.</span><span class="ident" id="1466971">waitlink</span>&nbsp;<span class="op" id="1466980">=</span>&nbsp;<span class="builtintype" id="1466982">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466988">gp</span><span class="op" id="1466990">.</span><span class="ident" id="1466991">waiting</span>&nbsp;<span class="op" id="1466999">=</span>&nbsp;<span class="ident" id="1467001">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467008">mysg</span><span class="op" id="1467012">.</span><span class="ident" id="1467013">g</span>&nbsp;<span class="op" id="1467015">=</span>&nbsp;<span class="ident" id="1467017">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467022">mysg</span><span class="op" id="1467026">.</span><span class="ident" id="1467027">selectdone</span>&nbsp;<span class="op" id="1467038">=</span>&nbsp;<span class="builtintype" id="1467040">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467046">gp</span><span class="op" id="1467048">.</span><span class="ident" id="1467049">param</span>&nbsp;<span class="op" id="1467055">=</span>&nbsp;<span class="builtintype" id="1467057">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467063">c</span><span class="op" id="1467064">.</span><span class="ident" id="1467065">recvq</span><span class="op" id="1467070">.</span><span class="ident" id="1467071">enqueue</span><span class="op" id="1467078">(</span><span class="ident" id="1467079">mysg</span><span class="op" id="1467083">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467087">goparkunlock</span><span class="op" id="1467099">(</span><span class="op" id="1467100">&amp;</span><span class="ident" id="1467101">c</span><span class="op" id="1467102">.</span><span class="ident" id="1467103">lock</span><span class="op" id="1467107">,</span>&nbsp;<span class="string" id="1467109">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1467123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467128">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467152">if</span>&nbsp;<span class="ident" id="1467155">mysg</span>&nbsp;<span class="op" id="1467160">!=</span>&nbsp;<span class="ident" id="1467163">gp</span><span class="op" id="1467165">.</span><span class="ident" id="1467166">waiting</span>&nbsp;<span class="op" id="1467174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467179">gothrow</span><span class="op" id="1467186">(</span><span class="string" id="1467187">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1467217">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467225">gp</span><span class="op" id="1467227">.</span><span class="ident" id="1467228">waiting</span>&nbsp;<span class="op" id="1467236">=</span>&nbsp;<span class="builtintype" id="1467238">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467244">if</span>&nbsp;<span class="ident" id="1467247">mysg</span><span class="op" id="1467251">.</span><span class="ident" id="1467252">releasetime</span>&nbsp;<span class="op" id="1467264">&gt;</span>&nbsp;<span class="num" id="1467266">0</span>&nbsp;<span class="op" id="1467268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467273">blockevent</span><span class="op" id="1467283">(</span><span class="ident" id="1467284">mysg</span><span class="op" id="1467288">.</span><span class="ident" id="1467289">releasetime</span><span class="op" id="1467300">-</span><span class="ident" id="1467301">t0</span><span class="op" id="1467303">,</span>&nbsp;<span class="num" id="1467305">2</span><span class="op" id="1467306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467310">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467314">haveData</span>&nbsp;<span class="op" id="1467323">:=</span>&nbsp;<span class="ident" id="1467326">gp</span><span class="op" id="1467328">.</span><span class="ident" id="1467329">param</span>&nbsp;<span class="op" id="1467335">!=</span>&nbsp;<span class="builtintype" id="1467338">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467344">gp</span><span class="op" id="1467346">.</span><span class="ident" id="1467347">param</span>&nbsp;<span class="op" id="1467353">=</span>&nbsp;<span class="builtintype" id="1467355">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467361">releaseSudog</span><span class="op" id="1467373">(</span><span class="ident" id="1467374">mysg</span><span class="op" id="1467378">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467383">if</span>&nbsp;<span class="ident" id="1467386">haveData</span>&nbsp;<span class="op" id="1467395">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467400">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467458">selected</span>&nbsp;<span class="op" id="1467467">=</span>&nbsp;<span class="builtintype" id="1467469">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467477">received</span>&nbsp;<span class="op" id="1467486">=</span>&nbsp;<span class="builtintype" id="1467488">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467496">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467505">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467510">lock</span><span class="op" id="1467514">(</span><span class="op" id="1467515">&amp;</span><span class="ident" id="1467516">c</span><span class="op" id="1467517">.</span><span class="ident" id="1467518">lock</span><span class="op" id="1467522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467526">if</span>&nbsp;<span class="ident" id="1467529">c</span><span class="op" id="1467530">.</span><span class="ident" id="1467531">closed</span>&nbsp;<span class="op" id="1467538">==</span>&nbsp;<span class="num" id="1467541">0</span>&nbsp;<span class="op" id="1467543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467548">gothrow</span><span class="op" id="1467555">(</span><span class="string" id="1467556">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1467583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467587">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467591">return</span>&nbsp;<span class="ident" id="1467598">recvclosed</span><span class="op" id="1467608">(</span><span class="ident" id="1467609">c</span><span class="op" id="1467610">,</span>&nbsp;<span class="ident" id="1467612">ep</span><span class="op" id="1467614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467621">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467646">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467679">var</span>&nbsp;<span class="ident" id="1467683">t1</span>&nbsp;<span class="ident" id="1467686">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467693">for</span>&nbsp;<span class="ident" id="1467697">c</span><span class="op" id="1467698">.</span><span class="ident" id="1467699">qcount</span>&nbsp;<span class="op" id="1467706">&lt;=</span>&nbsp;<span class="num" id="1467709">0</span>&nbsp;<span class="op" id="1467711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467715">if</span>&nbsp;<span class="ident" id="1467718">c</span><span class="op" id="1467719">.</span><span class="ident" id="1467720">closed</span>&nbsp;<span class="op" id="1467727">!=</span>&nbsp;<span class="num" id="1467730">0</span>&nbsp;<span class="op" id="1467732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467737">selected</span><span class="op" id="1467745">,</span>&nbsp;<span class="ident" id="1467747">received</span>&nbsp;<span class="op" id="1467756">=</span>&nbsp;<span class="ident" id="1467758">recvclosed</span><span class="op" id="1467768">(</span><span class="ident" id="1467769">c</span><span class="op" id="1467770">,</span>&nbsp;<span class="ident" id="1467772">ep</span><span class="op" id="1467774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467779">if</span>&nbsp;<span class="ident" id="1467782">t1</span>&nbsp;<span class="op" id="1467785">&gt;</span>&nbsp;<span class="num" id="1467787">0</span>&nbsp;<span class="op" id="1467789">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467795">blockevent</span><span class="op" id="1467805">(</span><span class="ident" id="1467806">t1</span><span class="op" id="1467808">-</span><span class="ident" id="1467809">t0</span><span class="op" id="1467811">,</span>&nbsp;<span class="num" id="1467813">2</span><span class="op" id="1467814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467824">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467838">if</span>&nbsp;<span class="op" id="1467841">!</span><span class="ident" id="1467842">block</span>&nbsp;<span class="op" id="1467848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467853">unlock</span><span class="op" id="1467859">(</span><span class="op" id="1467860">&amp;</span><span class="ident" id="1467861">c</span><span class="op" id="1467862">.</span><span class="ident" id="1467863">lock</span><span class="op" id="1467867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467872">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467886">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467927">gp</span>&nbsp;<span class="op" id="1467930">:=</span>&nbsp;<span class="ident" id="1467933">getg</span><span class="op" id="1467937">(</span><span class="op" id="1467938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467942">mysg</span>&nbsp;<span class="op" id="1467947">:=</span>&nbsp;<span class="ident" id="1467950">acquireSudog</span><span class="op" id="1467962">(</span><span class="op" id="1467963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467967">mysg</span><span class="op" id="1467971">.</span><span class="ident" id="1467972">releasetime</span>&nbsp;<span class="op" id="1467984">=</span>&nbsp;<span class="num" id="1467986">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467990">if</span>&nbsp;<span class="ident" id="1467993">t0</span>&nbsp;<span class="op" id="1467996">!=</span>&nbsp;<span class="num" id="1467999">0</span>&nbsp;<span class="op" id="1468001">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468006">mysg</span><span class="op" id="1468010">.</span><span class="ident" id="1468011">releasetime</span>&nbsp;<span class="op" id="1468023">=</span>&nbsp;<span class="op" id="1468025">-</span><span class="num" id="1468026">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468034">mysg</span><span class="op" id="1468038">.</span><span class="ident" id="1468039">elem</span>&nbsp;<span class="op" id="1468044">=</span>&nbsp;<span class="builtintype" id="1468046">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468052">mysg</span><span class="op" id="1468056">.</span><span class="ident" id="1468057">g</span>&nbsp;<span class="op" id="1468059">=</span>&nbsp;<span class="ident" id="1468061">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468066">mysg</span><span class="op" id="1468070">.</span><span class="ident" id="1468071">selectdone</span>&nbsp;<span class="op" id="1468082">=</span>&nbsp;<span class="builtintype" id="1468084">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468091">c</span><span class="op" id="1468092">.</span><span class="ident" id="1468093">recvq</span><span class="op" id="1468098">.</span><span class="ident" id="1468099">enqueue</span><span class="op" id="1468106">(</span><span class="ident" id="1468107">mysg</span><span class="op" id="1468111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468115">goparkunlock</span><span class="op" id="1468127">(</span><span class="op" id="1468128">&amp;</span><span class="ident" id="1468129">c</span><span class="op" id="1468130">.</span><span class="ident" id="1468131">lock</span><span class="op" id="1468135">,</span>&nbsp;<span class="string" id="1468137">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1468151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1468156">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468192">if</span>&nbsp;<span class="ident" id="1468195">mysg</span><span class="op" id="1468199">.</span><span class="ident" id="1468200">releasetime</span>&nbsp;<span class="op" id="1468212">&gt;</span>&nbsp;<span class="num" id="1468214">0</span>&nbsp;<span class="op" id="1468216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468221">t1</span>&nbsp;<span class="op" id="1468224">=</span>&nbsp;<span class="ident" id="1468226">mysg</span><span class="op" id="1468230">.</span><span class="ident" id="1468231">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468249">releaseSudog</span><span class="op" id="1468261">(</span><span class="ident" id="1468262">mysg</span><span class="op" id="1468266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468270">lock</span><span class="op" id="1468274">(</span><span class="op" id="1468275">&amp;</span><span class="ident" id="1468276">c</span><span class="op" id="1468277">.</span><span class="ident" id="1468278">lock</span><span class="op" id="1468282">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468289">if</span>&nbsp;<span class="ident" id="1468292">raceenabled</span>&nbsp;<span class="op" id="1468304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468308">raceacquire</span><span class="op" id="1468319">(</span><span class="ident" id="1468320">chanbuf</span><span class="op" id="1468327">(</span><span class="ident" id="1468328">c</span><span class="op" id="1468329">,</span>&nbsp;<span class="ident" id="1468331">c</span><span class="op" id="1468332">.</span><span class="ident" id="1468333">recvx</span><span class="op" id="1468338">)</span><span class="op" id="1468339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468343">racerelease</span><span class="op" id="1468354">(</span><span class="ident" id="1468355">chanbuf</span><span class="op" id="1468362">(</span><span class="ident" id="1468363">c</span><span class="op" id="1468364">,</span>&nbsp;<span class="ident" id="1468366">c</span><span class="op" id="1468367">.</span><span class="ident" id="1468368">recvx</span><span class="op" id="1468373">)</span><span class="op" id="1468374">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468380">if</span>&nbsp;<span class="ident" id="1468383">ep</span>&nbsp;<span class="op" id="1468386">!=</span>&nbsp;<span class="builtintype" id="1468389">nil</span>&nbsp;<span class="op" id="1468393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468397">memmove</span><span class="op" id="1468404">(</span><span class="ident" id="1468405">ep</span><span class="op" id="1468407">,</span>&nbsp;<span class="ident" id="1468409">chanbuf</span><span class="op" id="1468416">(</span><span class="ident" id="1468417">c</span><span class="op" id="1468418">,</span>&nbsp;<span class="ident" id="1468420">c</span><span class="op" id="1468421">.</span><span class="ident" id="1468422">recvx</span><span class="op" id="1468427">)</span><span class="op" id="1468428">,</span>&nbsp;<span class="builtintype" id="1468430">uintptr</span><span class="op" id="1468437">(</span><span class="ident" id="1468438">c</span><span class="op" id="1468439">.</span><span class="ident" id="1468440">elemsize</span><span class="op" id="1468448">)</span><span class="op" id="1468449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468455">memclr</span><span class="op" id="1468461">(</span><span class="ident" id="1468462">chanbuf</span><span class="op" id="1468469">(</span><span class="ident" id="1468470">c</span><span class="op" id="1468471">,</span>&nbsp;<span class="ident" id="1468473">c</span><span class="op" id="1468474">.</span><span class="ident" id="1468475">recvx</span><span class="op" id="1468480">)</span><span class="op" id="1468481">,</span>&nbsp;<span class="builtintype" id="1468483">uintptr</span><span class="op" id="1468490">(</span><span class="ident" id="1468491">c</span><span class="op" id="1468492">.</span><span class="ident" id="1468493">elemsize</span><span class="op" id="1468501">)</span><span class="op" id="1468502">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468506">c</span><span class="op" id="1468507">.</span><span class="ident" id="1468508">recvx</span><span class="op" id="1468513">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468517">if</span>&nbsp;<span class="ident" id="1468520">c</span><span class="op" id="1468521">.</span><span class="ident" id="1468522">recvx</span>&nbsp;<span class="op" id="1468528">==</span>&nbsp;<span class="ident" id="1468531">c</span><span class="op" id="1468532">.</span><span class="ident" id="1468533">dataqsiz</span>&nbsp;<span class="op" id="1468542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468546">c</span><span class="op" id="1468547">.</span><span class="ident" id="1468548">recvx</span>&nbsp;<span class="op" id="1468554">=</span>&nbsp;<span class="num" id="1468556">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468559">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468562">c</span><span class="op" id="1468563">.</span><span class="ident" id="1468564">qcount</span><span class="op" id="1468570">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1468575">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468617">sg</span>&nbsp;<span class="op" id="1468620">:=</span>&nbsp;<span class="ident" id="1468623">c</span><span class="op" id="1468624">.</span><span class="ident" id="1468625">sendq</span><span class="op" id="1468630">.</span><span class="ident" id="1468631">dequeue</span><span class="op" id="1468638">(</span><span class="op" id="1468639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468642">if</span>&nbsp;<span class="ident" id="1468645">sg</span>&nbsp;<span class="op" id="1468648">!=</span>&nbsp;<span class="builtintype" id="1468651">nil</span>&nbsp;<span class="op" id="1468655">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468659">gp</span>&nbsp;<span class="op" id="1468662">:=</span>&nbsp;<span class="ident" id="1468665">sg</span><span class="op" id="1468667">.</span><span class="ident" id="1468668">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468672">unlock</span><span class="op" id="1468678">(</span><span class="op" id="1468679">&amp;</span><span class="ident" id="1468680">c</span><span class="op" id="1468681">.</span><span class="ident" id="1468682">lock</span><span class="op" id="1468686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468690">if</span>&nbsp;<span class="ident" id="1468693">sg</span><span class="op" id="1468695">.</span><span class="ident" id="1468696">releasetime</span>&nbsp;<span class="op" id="1468708">!=</span>&nbsp;<span class="num" id="1468711">0</span>&nbsp;<span class="op" id="1468713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468718">sg</span><span class="op" id="1468720">.</span><span class="ident" id="1468721">releasetime</span>&nbsp;<span class="op" id="1468733">=</span>&nbsp;<span class="ident" id="1468735">cputicks</span><span class="op" id="1468743">(</span><span class="op" id="1468744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468748">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468752">goready</span><span class="op" id="1468759">(</span><span class="ident" id="1468760">gp</span><span class="op" id="1468762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468765">}</span>&nbsp;<span class="keyword" id="1468767">else</span>&nbsp;<span class="op" id="1468772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468776">unlock</span><span class="op" id="1468782">(</span><span class="op" id="1468783">&amp;</span><span class="ident" id="1468784">c</span><span class="op" id="1468785">.</span><span class="ident" id="1468786">lock</span><span class="op" id="1468790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468797">if</span>&nbsp;<span class="ident" id="1468800">t1</span>&nbsp;<span class="op" id="1468803">&gt;</span>&nbsp;<span class="num" id="1468805">0</span>&nbsp;<span class="op" id="1468807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468811">blockevent</span><span class="op" id="1468821">(</span><span class="ident" id="1468822">t1</span><span class="op" id="1468824">-</span><span class="ident" id="1468825">t0</span><span class="op" id="1468827">,</span>&nbsp;<span class="num" id="1468829">2</span><span class="op" id="1468830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468836">selected</span>&nbsp;<span class="op" id="1468845">=</span>&nbsp;<span class="builtintype" id="1468847">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468853">received</span>&nbsp;<span class="op" id="1468862">=</span>&nbsp;<span class="builtintype" id="1468864">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468870">return</span><br>
<span class="lineno"></span><span class="op" id="1468877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1468880">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1468946">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1468996">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1469058">func</span>&nbsp;<span class="ident" id="1469063">recvclosed</span><span class="op" id="1469073">(</span><span class="ident" id="1469074">c</span>&nbsp;<span class="op" id="1469076">*</span><span class="ident" id="1469077">hchan</span><span class="op" id="1469082">,</span>&nbsp;<span class="ident" id="1469084">ep</span>&nbsp;<span class="ident" id="1469087">unsafe</span><span class="op" id="1469093">.</span><span class="ident" id="1469094">Pointer</span><span class="op" id="1469101">)</span>&nbsp;<span class="op" id="1469103">(</span><span class="ident" id="1469104">selected</span><span class="op" id="1469112">,</span>&nbsp;<span class="ident" id="1469114">recevied</span>&nbsp;<span class="builtintype" id="1469123">bool</span><span class="op" id="1469127">)</span>&nbsp;<span class="op" id="1469129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469132">if</span>&nbsp;<span class="ident" id="1469135">raceenabled</span>&nbsp;<span class="op" id="1469147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469151">raceacquire</span><span class="op" id="1469162">(</span><span class="ident" id="1469163">unsafe</span><span class="op" id="1469169">.</span><span class="ident" id="1469170">Pointer</span><span class="op" id="1469177">(</span><span class="ident" id="1469178">c</span><span class="op" id="1469179">)</span><span class="op" id="1469180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1469183">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469186">unlock</span><span class="op" id="1469192">(</span><span class="op" id="1469193">&amp;</span><span class="ident" id="1469194">c</span><span class="op" id="1469195">.</span><span class="ident" id="1469196">lock</span><span class="op" id="1469200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469203">if</span>&nbsp;<span class="ident" id="1469206">ep</span>&nbsp;<span class="op" id="1469209">!=</span>&nbsp;<span class="builtintype" id="1469212">nil</span>&nbsp;<span class="op" id="1469216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469220">memclr</span><span class="op" id="1469226">(</span><span class="ident" id="1469227">ep</span><span class="op" id="1469229">,</span>&nbsp;<span class="builtintype" id="1469231">uintptr</span><span class="op" id="1469238">(</span><span class="ident" id="1469239">c</span><span class="op" id="1469240">.</span><span class="ident" id="1469241">elemsize</span><span class="op" id="1469249">)</span><span class="op" id="1469250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1469253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469256">return</span>&nbsp;<span class="builtintype" id="1469263">true</span><span class="op" id="1469267">,</span>&nbsp;<span class="builtintype" id="1469269">false</span><br>
<span class="lineno">525</span><span class="op" id="1469275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1469278">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1469301">//</span><br>
<span class="lineno"></span><span class="comment" id="1469304">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1469316">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1469332">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1469344">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1469356">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1469368">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">535</span><span class="comment" id="1469373">//</span><br>
<span class="lineno"></span><span class="comment" id="1469376">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1469382">//</span><br>
<span class="lineno"></span><span class="comment" id="1469385">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1469412">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1469424">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1469436">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1469448">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1469453">//</span><br>
<span class="lineno"></span><span class="keyword" id="1469456">func</span>&nbsp;<span class="ident" id="1469461">selectnbsend</span><span class="op" id="1469473">(</span><span class="ident" id="1469474">t</span>&nbsp;<span class="op" id="1469476">*</span><span class="ident" id="1469477">chantype</span><span class="op" id="1469485">,</span>&nbsp;<span class="ident" id="1469487">c</span>&nbsp;<span class="op" id="1469489">*</span><span class="ident" id="1469490">hchan</span><span class="op" id="1469495">,</span>&nbsp;<span class="ident" id="1469497">elem</span>&nbsp;<span class="ident" id="1469502">unsafe</span><span class="op" id="1469508">.</span><span class="ident" id="1469509">Pointer</span><span class="op" id="1469516">)</span>&nbsp;<span class="op" id="1469518">(</span><span class="ident" id="1469519">selected</span>&nbsp;<span class="builtintype" id="1469528">bool</span><span class="op" id="1469532">)</span>&nbsp;<span class="op" id="1469534">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469537">return</span>&nbsp;<span class="ident" id="1469544">chansend</span><span class="op" id="1469552">(</span><span class="ident" id="1469553">t</span><span class="op" id="1469554">,</span>&nbsp;<span class="ident" id="1469556">c</span><span class="op" id="1469557">,</span>&nbsp;<span class="ident" id="1469559">elem</span><span class="op" id="1469563">,</span>&nbsp;<span class="builtintype" id="1469565">false</span><span class="op" id="1469570">,</span>&nbsp;<span class="ident" id="1469572">getcallerpc</span><span class="op" id="1469583">(</span><span class="ident" id="1469584">unsafe</span><span class="op" id="1469590">.</span><span class="ident" id="1469591">Pointer</span><span class="op" id="1469598">(</span><span class="op" id="1469599">&amp;</span><span class="ident" id="1469600">t</span><span class="op" id="1469601">)</span><span class="op" id="1469602">)</span><span class="op" id="1469603">)</span><br>
<span class="lineno"></span><span class="op" id="1469605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1469608">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1469631">//</span><br>
<span class="lineno">550</span><span class="comment" id="1469634">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1469646">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1469663">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1469675">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1469687">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1469699">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1469704">//</span><br>
<span class="lineno"></span><span class="comment" id="1469707">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1469713">//</span><br>
<span class="lineno"></span><span class="comment" id="1469716">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1469744">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1469756">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1469768">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1469780">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1469785">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1469788">func</span>&nbsp;<span class="ident" id="1469793">selectnbrecv</span><span class="op" id="1469805">(</span><span class="ident" id="1469806">t</span>&nbsp;<span class="op" id="1469808">*</span><span class="ident" id="1469809">chantype</span><span class="op" id="1469817">,</span>&nbsp;<span class="ident" id="1469819">elem</span>&nbsp;<span class="ident" id="1469824">unsafe</span><span class="op" id="1469830">.</span><span class="ident" id="1469831">Pointer</span><span class="op" id="1469838">,</span>&nbsp;<span class="ident" id="1469840">c</span>&nbsp;<span class="op" id="1469842">*</span><span class="ident" id="1469843">hchan</span><span class="op" id="1469848">)</span>&nbsp;<span class="op" id="1469850">(</span><span class="ident" id="1469851">selected</span>&nbsp;<span class="builtintype" id="1469860">bool</span><span class="op" id="1469864">)</span>&nbsp;<span class="op" id="1469866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469869">selected</span><span class="op" id="1469877">,</span>&nbsp;<span class="ident" id="1469879">_</span>&nbsp;<span class="op" id="1469881">=</span>&nbsp;<span class="ident" id="1469883">chanrecv</span><span class="op" id="1469891">(</span><span class="ident" id="1469892">t</span><span class="op" id="1469893">,</span>&nbsp;<span class="ident" id="1469895">c</span><span class="op" id="1469896">,</span>&nbsp;<span class="ident" id="1469898">elem</span><span class="op" id="1469902">,</span>&nbsp;<span class="builtintype" id="1469904">false</span><span class="op" id="1469909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469912">return</span><br>
<span class="lineno"></span><span class="op" id="1469919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1469922">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1469945">//</span><br>
<span class="lineno"></span><span class="comment" id="1469948">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1469960">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1469981">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1469993">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1470005">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1470017">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1470022">//</span><br>
<span class="lineno"></span><span class="comment" id="1470025">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1470031">//</span><br>
<span class="lineno"></span><span class="comment" id="1470034">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1470080">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1470092">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1470104">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1470116">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1470121">//</span><br>
<span class="lineno"></span><span class="keyword" id="1470124">func</span>&nbsp;<span class="ident" id="1470129">selectnbrecv2</span><span class="op" id="1470142">(</span><span class="ident" id="1470143">t</span>&nbsp;<span class="op" id="1470145">*</span><span class="ident" id="1470146">chantype</span><span class="op" id="1470154">,</span>&nbsp;<span class="ident" id="1470156">elem</span>&nbsp;<span class="ident" id="1470161">unsafe</span><span class="op" id="1470167">.</span><span class="ident" id="1470168">Pointer</span><span class="op" id="1470175">,</span>&nbsp;<span class="ident" id="1470177">received</span>&nbsp;<span class="op" id="1470186">*</span><span class="builtintype" id="1470187">bool</span><span class="op" id="1470191">,</span>&nbsp;<span class="ident" id="1470193">c</span>&nbsp;<span class="op" id="1470195">*</span><span class="ident" id="1470196">hchan</span><span class="op" id="1470201">)</span>&nbsp;<span class="op" id="1470203">(</span><span class="ident" id="1470204">selected</span>&nbsp;<span class="builtintype" id="1470213">bool</span><span class="op" id="1470217">)</span>&nbsp;<span class="op" id="1470219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470222">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470300">selected</span><span class="op" id="1470308">,</span>&nbsp;<span class="op" id="1470310">*</span><span class="ident" id="1470311">received</span>&nbsp;<span class="op" id="1470320">=</span>&nbsp;<span class="ident" id="1470322">chanrecv</span><span class="op" id="1470330">(</span><span class="ident" id="1470331">t</span><span class="op" id="1470332">,</span>&nbsp;<span class="ident" id="1470334">c</span><span class="op" id="1470335">,</span>&nbsp;<span class="ident" id="1470337">elem</span><span class="op" id="1470341">,</span>&nbsp;<span class="builtintype" id="1470343">false</span><span class="op" id="1470348">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470351">return</span><br>
<span class="lineno"></span><span class="op" id="1470358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1470361">func</span>&nbsp;<span class="ident" id="1470366">reflect_chansend</span><span class="op" id="1470382">(</span><span class="ident" id="1470383">t</span>&nbsp;<span class="op" id="1470385">*</span><span class="ident" id="1470386">chantype</span><span class="op" id="1470394">,</span>&nbsp;<span class="ident" id="1470396">c</span>&nbsp;<span class="op" id="1470398">*</span><span class="ident" id="1470399">hchan</span><span class="op" id="1470404">,</span>&nbsp;<span class="ident" id="1470406">elem</span>&nbsp;<span class="ident" id="1470411">unsafe</span><span class="op" id="1470417">.</span><span class="ident" id="1470418">Pointer</span><span class="op" id="1470425">,</span>&nbsp;<span class="ident" id="1470427">nb</span>&nbsp;<span class="builtintype" id="1470430">bool</span><span class="op" id="1470434">)</span>&nbsp;<span class="op" id="1470436">(</span><span class="ident" id="1470437">selected</span>&nbsp;<span class="builtintype" id="1470446">bool</span><span class="op" id="1470450">)</span>&nbsp;<span class="op" id="1470452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470455">return</span>&nbsp;<span class="ident" id="1470462">chansend</span><span class="op" id="1470470">(</span><span class="ident" id="1470471">t</span><span class="op" id="1470472">,</span>&nbsp;<span class="ident" id="1470474">c</span><span class="op" id="1470475">,</span>&nbsp;<span class="ident" id="1470477">elem</span><span class="op" id="1470481">,</span>&nbsp;<span class="op" id="1470483">!</span><span class="ident" id="1470484">nb</span><span class="op" id="1470486">,</span>&nbsp;<span class="ident" id="1470488">getcallerpc</span><span class="op" id="1470499">(</span><span class="ident" id="1470500">unsafe</span><span class="op" id="1470506">.</span><span class="ident" id="1470507">Pointer</span><span class="op" id="1470514">(</span><span class="op" id="1470515">&amp;</span><span class="ident" id="1470516">t</span><span class="op" id="1470517">)</span><span class="op" id="1470518">)</span><span class="op" id="1470519">)</span><br>
<span class="lineno">595</span><span class="op" id="1470521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1470524">func</span>&nbsp;<span class="ident" id="1470529">reflect_chanrecv</span><span class="op" id="1470545">(</span><span class="ident" id="1470546">t</span>&nbsp;<span class="op" id="1470548">*</span><span class="ident" id="1470549">chantype</span><span class="op" id="1470557">,</span>&nbsp;<span class="ident" id="1470559">c</span>&nbsp;<span class="op" id="1470561">*</span><span class="ident" id="1470562">hchan</span><span class="op" id="1470567">,</span>&nbsp;<span class="ident" id="1470569">nb</span>&nbsp;<span class="builtintype" id="1470572">bool</span><span class="op" id="1470576">,</span>&nbsp;<span class="ident" id="1470578">elem</span>&nbsp;<span class="ident" id="1470583">unsafe</span><span class="op" id="1470589">.</span><span class="ident" id="1470590">Pointer</span><span class="op" id="1470597">)</span>&nbsp;<span class="op" id="1470599">(</span><span class="ident" id="1470600">selected</span>&nbsp;<span class="builtintype" id="1470609">bool</span><span class="op" id="1470613">,</span>&nbsp;<span class="ident" id="1470615">received</span>&nbsp;<span class="builtintype" id="1470624">bool</span><span class="op" id="1470628">)</span>&nbsp;<span class="op" id="1470630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470633">return</span>&nbsp;<span class="ident" id="1470640">chanrecv</span><span class="op" id="1470648">(</span><span class="ident" id="1470649">t</span><span class="op" id="1470650">,</span>&nbsp;<span class="ident" id="1470652">c</span><span class="op" id="1470653">,</span>&nbsp;<span class="ident" id="1470655">elem</span><span class="op" id="1470659">,</span>&nbsp;<span class="op" id="1470661">!</span><span class="ident" id="1470662">nb</span><span class="op" id="1470664">)</span><br>
<span class="lineno"></span><span class="op" id="1470666">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1470669">func</span>&nbsp;<span class="ident" id="1470674">reflect_chanlen</span><span class="op" id="1470689">(</span><span class="ident" id="1470690">c</span>&nbsp;<span class="op" id="1470692">*</span><span class="ident" id="1470693">hchan</span><span class="op" id="1470698">)</span>&nbsp;<span class="builtintype" id="1470700">int</span>&nbsp;<span class="op" id="1470704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470707">if</span>&nbsp;<span class="ident" id="1470710">c</span>&nbsp;<span class="op" id="1470712">==</span>&nbsp;<span class="builtintype" id="1470715">nil</span>&nbsp;<span class="op" id="1470719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470723">return</span>&nbsp;<span class="num" id="1470730">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470733">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470736">return</span>&nbsp;<span class="builtintype" id="1470743">int</span><span class="op" id="1470746">(</span><span class="ident" id="1470747">c</span><span class="op" id="1470748">.</span><span class="ident" id="1470749">qcount</span><span class="op" id="1470755">)</span><br>
<span class="lineno"></span><span class="op" id="1470757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1470760">func</span>&nbsp;<span class="ident" id="1470765">reflect_chancap</span><span class="op" id="1470780">(</span><span class="ident" id="1470781">c</span>&nbsp;<span class="op" id="1470783">*</span><span class="ident" id="1470784">hchan</span><span class="op" id="1470789">)</span>&nbsp;<span class="builtintype" id="1470791">int</span>&nbsp;<span class="op" id="1470795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470798">if</span>&nbsp;<span class="ident" id="1470801">c</span>&nbsp;<span class="op" id="1470803">==</span>&nbsp;<span class="builtintype" id="1470806">nil</span>&nbsp;<span class="op" id="1470810">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470814">return</span>&nbsp;<span class="num" id="1470821">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470827">return</span>&nbsp;<span class="builtintype" id="1470834">int</span><span class="op" id="1470837">(</span><span class="ident" id="1470838">c</span><span class="op" id="1470839">.</span><span class="ident" id="1470840">dataqsiz</span><span class="op" id="1470848">)</span><br>
<span class="lineno"></span><span class="op" id="1470850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1470853">func</span>&nbsp;<span class="op" id="1470858">(</span><span class="ident" id="1470859">q</span>&nbsp;<span class="op" id="1470861">*</span><span class="ident" id="1470862">waitq</span><span class="op" id="1470867">)</span>&nbsp;<span class="ident" id="1470869">enqueue</span><span class="op" id="1470876">(</span><span class="ident" id="1470877">sgp</span>&nbsp;<span class="op" id="1470881">*</span><span class="ident" id="1470882">sudog</span><span class="op" id="1470887">)</span>&nbsp;<span class="op" id="1470889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470892">sgp</span><span class="op" id="1470895">.</span><span class="ident" id="1470896">next</span>&nbsp;<span class="op" id="1470901">=</span>&nbsp;<span class="builtintype" id="1470903">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470908">if</span>&nbsp;<span class="ident" id="1470911">q</span><span class="op" id="1470912">.</span><span class="ident" id="1470913">first</span>&nbsp;<span class="op" id="1470919">==</span>&nbsp;<span class="builtintype" id="1470922">nil</span>&nbsp;<span class="op" id="1470926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470930">q</span><span class="op" id="1470931">.</span><span class="ident" id="1470932">first</span>&nbsp;<span class="op" id="1470938">=</span>&nbsp;<span class="ident" id="1470940">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470946">q</span><span class="op" id="1470947">.</span><span class="ident" id="1470948">last</span>&nbsp;<span class="op" id="1470953">=</span>&nbsp;<span class="ident" id="1470955">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470961">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470972">q</span><span class="op" id="1470973">.</span><span class="ident" id="1470974">last</span><span class="op" id="1470978">.</span><span class="ident" id="1470979">next</span>&nbsp;<span class="op" id="1470984">=</span>&nbsp;<span class="ident" id="1470986">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470991">q</span><span class="op" id="1470992">.</span><span class="ident" id="1470993">last</span>&nbsp;<span class="op" id="1470998">=</span>&nbsp;<span class="ident" id="1471000">sgp</span><br>
<span class="lineno"></span><span class="op" id="1471004">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1471007">func</span>&nbsp;<span class="op" id="1471012">(</span><span class="ident" id="1471013">q</span>&nbsp;<span class="op" id="1471015">*</span><span class="ident" id="1471016">waitq</span><span class="op" id="1471021">)</span>&nbsp;<span class="ident" id="1471023">dequeue</span><span class="op" id="1471030">(</span><span class="op" id="1471031">)</span>&nbsp;<span class="op" id="1471033">*</span><span class="ident" id="1471034">sudog</span>&nbsp;<span class="op" id="1471040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471043">for</span>&nbsp;<span class="op" id="1471047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471051">sgp</span>&nbsp;<span class="op" id="1471055">:=</span>&nbsp;<span class="ident" id="1471058">q</span><span class="op" id="1471059">.</span><span class="ident" id="1471060">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471068">if</span>&nbsp;<span class="ident" id="1471071">sgp</span>&nbsp;<span class="op" id="1471075">==</span>&nbsp;<span class="builtintype" id="1471078">nil</span>&nbsp;<span class="op" id="1471082">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471087">return</span>&nbsp;<span class="builtintype" id="1471094">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471104">q</span><span class="op" id="1471105">.</span><span class="ident" id="1471106">first</span>&nbsp;<span class="op" id="1471112">=</span>&nbsp;<span class="ident" id="1471114">sgp</span><span class="op" id="1471117">.</span><span class="ident" id="1471118">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471125">sgp</span><span class="op" id="1471128">.</span><span class="ident" id="1471129">next</span>&nbsp;<span class="op" id="1471134">=</span>&nbsp;<span class="builtintype" id="1471136">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471142">if</span>&nbsp;<span class="ident" id="1471145">q</span><span class="op" id="1471146">.</span><span class="ident" id="1471147">last</span>&nbsp;<span class="op" id="1471152">==</span>&nbsp;<span class="ident" id="1471155">sgp</span>&nbsp;<span class="op" id="1471159">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471164">q</span><span class="op" id="1471165">.</span><span class="ident" id="1471166">last</span>&nbsp;<span class="op" id="1471171">=</span>&nbsp;<span class="builtintype" id="1471173">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471184">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471256">if</span>&nbsp;<span class="ident" id="1471259">sgp</span><span class="op" id="1471262">.</span><span class="ident" id="1471263">selectdone</span>&nbsp;<span class="op" id="1471274">!=</span>&nbsp;<span class="builtintype" id="1471277">nil</span>&nbsp;<span class="op" id="1471281">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471286">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471318">if</span>&nbsp;<span class="op" id="1471321">*</span><span class="ident" id="1471322">sgp</span><span class="op" id="1471325">.</span><span class="ident" id="1471326">selectdone</span>&nbsp;<span class="op" id="1471337">!=</span>&nbsp;<span class="num" id="1471340">0</span>&nbsp;<span class="op" id="1471342">||</span>&nbsp;<span class="op" id="1471345">!</span><span class="ident" id="1471346">cas</span><span class="op" id="1471349">(</span><span class="ident" id="1471350">sgp</span><span class="op" id="1471353">.</span><span class="ident" id="1471354">selectdone</span><span class="op" id="1471364">,</span>&nbsp;<span class="num" id="1471366">0</span><span class="op" id="1471367">,</span>&nbsp;<span class="num" id="1471369">1</span><span class="op" id="1471370">)</span>&nbsp;<span class="op" id="1471372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471378">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471394">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471399">return</span>&nbsp;<span class="ident" id="1471406">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471411">}</span><br>
<span class="lineno"></span><span class="op" id="1471413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1471416">func</span>&nbsp;<span class="ident" id="1471421">racesync</span><span class="op" id="1471429">(</span><span class="ident" id="1471430">c</span>&nbsp;<span class="op" id="1471432">*</span><span class="ident" id="1471433">hchan</span><span class="op" id="1471438">,</span>&nbsp;<span class="ident" id="1471440">sg</span>&nbsp;<span class="op" id="1471443">*</span><span class="ident" id="1471444">sudog</span><span class="op" id="1471449">)</span>&nbsp;<span class="op" id="1471451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471454">racerelease</span><span class="op" id="1471465">(</span><span class="ident" id="1471466">chanbuf</span><span class="op" id="1471473">(</span><span class="ident" id="1471474">c</span><span class="op" id="1471475">,</span>&nbsp;<span class="num" id="1471477">0</span><span class="op" id="1471478">)</span><span class="op" id="1471479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471482">raceacquireg</span><span class="op" id="1471494">(</span><span class="ident" id="1471495">sg</span><span class="op" id="1471497">.</span><span class="ident" id="1471498">g</span><span class="op" id="1471499">,</span>&nbsp;<span class="ident" id="1471501">chanbuf</span><span class="op" id="1471508">(</span><span class="ident" id="1471509">c</span><span class="op" id="1471510">,</span>&nbsp;<span class="num" id="1471512">0</span><span class="op" id="1471513">)</span><span class="op" id="1471514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471517">racereleaseg</span><span class="op" id="1471529">(</span><span class="ident" id="1471530">sg</span><span class="op" id="1471532">.</span><span class="ident" id="1471533">g</span><span class="op" id="1471534">,</span>&nbsp;<span class="ident" id="1471536">chanbuf</span><span class="op" id="1471543">(</span><span class="ident" id="1471544">c</span><span class="op" id="1471545">,</span>&nbsp;<span class="num" id="1471547">0</span><span class="op" id="1471548">)</span><span class="op" id="1471549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471552">raceacquire</span><span class="op" id="1471563">(</span><span class="ident" id="1471564">chanbuf</span><span class="op" id="1471571">(</span><span class="ident" id="1471572">c</span><span class="op" id="1471573">,</span>&nbsp;<span class="num" id="1471575">0</span><span class="op" id="1471576">)</span><span class="op" id="1471577">)</span><br>
<span class="lineno">655</span><span class="op" id="1471579">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
