<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html" class="current">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6029208">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6029263">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6029317">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6029368">package</span>&nbsp;<span class="ident" id="6029376">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6029386">import</span>&nbsp;<span class="op" id="6029393">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6029396">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6029405">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6029415">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6029421">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6029428">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6029440">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6029457">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6029464">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6029467">var</span>&nbsp;<span class="op" id="6029471">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6029474">ErrPersistEOF</span>&nbsp;<span class="op" id="6029488">=</span>&nbsp;<span class="op" id="6029490">&amp;</span><span class="ident" id="6029491">http</span><span class="op" id="6029495">.</span><span class="ident" id="6029496">ProtocolError</span><span class="op" id="6029509">{</span><span class="ident" id="6029510">ErrorString</span><span class="op" id="6029521">:</span>&nbsp;<span class="string" id="6029523">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="6029553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6029556">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6029570">=</span>&nbsp;<span class="op" id="6029572">&amp;</span><span class="ident" id="6029573">http</span><span class="op" id="6029577">.</span><span class="ident" id="6029578">ProtocolError</span><span class="op" id="6029591">{</span><span class="ident" id="6029592">ErrorString</span><span class="op" id="6029603">:</span>&nbsp;<span class="string" id="6029605">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="6029632">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6029635">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6029649">=</span>&nbsp;<span class="op" id="6029651">&amp;</span><span class="ident" id="6029652">http</span><span class="op" id="6029656">.</span><span class="ident" id="6029657">ProtocolError</span><span class="op" id="6029670">{</span><span class="ident" id="6029671">ErrorString</span><span class="op" id="6029682">:</span>&nbsp;<span class="string" id="6029684">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="6029700">}</span><br>
<span class="lineno"></span><span class="op" id="6029702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6029705">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6029763">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="6029828">var</span>&nbsp;<span class="ident" id="6029832">errClosed</span>&nbsp;<span class="op" id="6029842">=</span>&nbsp;<span class="ident" id="6029844">errors</span><span class="op" id="6029850">.</span><span class="ident" id="6029851">New</span><span class="op" id="6029854">(</span><span class="string" id="6029855">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="6029891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6029894">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6029964">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="6030038">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="6030107">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="6030182">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6030257">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="6030291">//</span><br>
<span class="lineno"></span><span class="comment" id="6030294">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="6030369">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6030397">type</span>&nbsp;<span class="ident" id="6030402">ServerConn</span>&nbsp;<span class="keyword" id="6030413">struct</span>&nbsp;<span class="op" id="6030420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6030423">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030439">sync</span><span class="op" id="6030443">.</span><span class="ident" id="6030444">Mutex</span>&nbsp;<span class="comment" id="6030450">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6030495">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030511">net</span><span class="op" id="6030514">.</span><span class="ident" id="6030515">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6030521">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6030537">*</span><span class="ident" id="6030538">bufio</span><span class="op" id="6030543">.</span><span class="ident" id="6030544">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6030552">re</span><span class="op" id="6030554">,</span>&nbsp;<span class="ident" id="6030556">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6030568">error</span>&nbsp;<span class="comment" id="6030574">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6030596">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030612">io</span><span class="op" id="6030614">.</span><span class="ident" id="6030615">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6030627">nread</span><span class="op" id="6030632">,</span>&nbsp;<span class="ident" id="6030634">nwritten</span>&nbsp;<span class="builtintype" id="6030643">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6030648">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030664">map</span><span class="op" id="6030667">[</span><span class="op" id="6030668">*</span><span class="ident" id="6030669">http</span><span class="op" id="6030673">.</span><span class="ident" id="6030674">Request</span><span class="op" id="6030681">]</span><span class="builtintype" id="6030682">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6030689">pipe</span>&nbsp;<span class="ident" id="6030694">textproto</span><span class="op" id="6030703">.</span><span class="ident" id="6030704">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="6030713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6030716">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6030793">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="6030841">//</span><br>
<span class="lineno"></span><span class="comment" id="6030844">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="6030919">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6030947">func</span>&nbsp;<span class="ident" id="6030952">NewServerConn</span><span class="op" id="6030965">(</span><span class="ident" id="6030966">c</span>&nbsp;<span class="ident" id="6030968">net</span><span class="op" id="6030971">.</span><span class="ident" id="6030972">Conn</span><span class="op" id="6030976">,</span>&nbsp;<span class="ident" id="6030978">r</span>&nbsp;<span class="op" id="6030980">*</span><span class="ident" id="6030981">bufio</span><span class="op" id="6030986">.</span><span class="ident" id="6030987">Reader</span><span class="op" id="6030993">)</span>&nbsp;<span class="op" id="6030995">*</span><span class="ident" id="6030996">ServerConn</span>&nbsp;<span class="op" id="6031007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6031010">if</span>&nbsp;<span class="ident" id="6031013">r</span>&nbsp;<span class="op" id="6031015">==</span>&nbsp;<span class="ident" id="6031018">nil</span>&nbsp;<span class="op" id="6031022">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6031026">r</span>&nbsp;<span class="op" id="6031028">=</span>&nbsp;<span class="ident" id="6031030">bufio</span><span class="op" id="6031035">.</span><span class="ident" id="6031036">NewReader</span><span class="op" id="6031045">(</span><span class="ident" id="6031046">c</span><span class="op" id="6031047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6031050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6031053">return</span>&nbsp;<span class="op" id="6031060">&amp;</span><span class="ident" id="6031061">ServerConn</span><span class="op" id="6031071">{</span><span class="ident" id="6031072">c</span><span class="op" id="6031073">:</span>&nbsp;<span class="ident" id="6031075">c</span><span class="op" id="6031076">,</span>&nbsp;<span class="ident" id="6031078">r</span><span class="op" id="6031079">:</span>&nbsp;<span class="ident" id="6031081">r</span><span class="op" id="6031082">,</span>&nbsp;<span class="ident" id="6031084">pipereq</span><span class="op" id="6031091">:</span>&nbsp;<span class="builtinfunc" id="6031093">make</span><span class="op" id="6031097">(</span><span class="keyword" id="6031098">map</span><span class="op" id="6031101">[</span><span class="op" id="6031102">*</span><span class="ident" id="6031103">http</span><span class="op" id="6031107">.</span><span class="ident" id="6031108">Request</span><span class="op" id="6031115">]</span><span class="builtintype" id="6031116">uint</span><span class="op" id="6031120">)</span><span class="op" id="6031121">}</span><br>
<span class="lineno"></span><span class="op" id="6031123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6031126">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6031206">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6031282">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="6031359">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6031421">func</span>&nbsp;<span class="op" id="6031426">(</span><span class="ident" id="6031427">sc</span>&nbsp;<span class="op" id="6031430">*</span><span class="ident" id="6031431">ServerConn</span><span class="op" id="6031441">)</span>&nbsp;<span class="ident" id="6031443">Hijack</span><span class="op" id="6031449">(</span><span class="op" id="6031450">)</span>&nbsp;<span class="op" id="6031452">(</span><span class="ident" id="6031453">c</span>&nbsp;<span class="ident" id="6031455">net</span><span class="op" id="6031458">.</span><span class="ident" id="6031459">Conn</span><span class="op" id="6031463">,</span>&nbsp;<span class="ident" id="6031465">r</span>&nbsp;<span class="op" id="6031467">*</span><span class="ident" id="6031468">bufio</span><span class="op" id="6031473">.</span><span class="ident" id="6031474">Reader</span><span class="op" id="6031480">)</span>&nbsp;<span class="op" id="6031482">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6031485">sc</span><span class="op" id="6031487">.</span><span class="ident" id="6031488">lk</span><span class="op" id="6031490">.</span><span class="ident" id="6031491">Lock</span><span class="op" id="6031495">(</span><span class="op" id="6031496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6031499">defer</span>&nbsp;<span class="ident" id="6031505">sc</span><span class="op" id="6031507">.</span><span class="ident" id="6031508">lk</span><span class="op" id="6031510">.</span><span class="ident" id="6031511">Unlock</span><span class="op" id="6031517">(</span><span class="op" id="6031518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6031521">c</span>&nbsp;<span class="op" id="6031523">=</span>&nbsp;<span class="ident" id="6031525">sc</span><span class="op" id="6031527">.</span><span class="ident" id="6031528">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6031531">r</span>&nbsp;<span class="op" id="6031533">=</span>&nbsp;<span class="ident" id="6031535">sc</span><span class="op" id="6031537">.</span><span class="ident" id="6031538">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6031541">sc</span><span class="op" id="6031543">.</span><span class="ident" id="6031544">c</span>&nbsp;<span class="op" id="6031546">=</span>&nbsp;<span class="ident" id="6031548">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6031553">sc</span><span class="op" id="6031555">.</span><span class="ident" id="6031556">r</span>&nbsp;<span class="op" id="6031558">=</span>&nbsp;<span class="ident" id="6031560">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6031565">return</span><br>
<span class="lineno"></span><span class="op" id="6031572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6031575">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="6031644">func</span>&nbsp;<span class="op" id="6031649">(</span><span class="ident" id="6031650">sc</span>&nbsp;<span class="op" id="6031653">*</span><span class="ident" id="6031654">ServerConn</span><span class="op" id="6031664">)</span>&nbsp;<span class="ident" id="6031666">Close</span><span class="op" id="6031671">(</span><span class="op" id="6031672">)</span>&nbsp;<span class="builtintype" id="6031674">error</span>&nbsp;<span class="op" id="6031680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6031683">c</span><span class="op" id="6031684">,</span>&nbsp;<span class="ident" id="6031686">_</span>&nbsp;<span class="op" id="6031688">:=</span>&nbsp;<span class="ident" id="6031691">sc</span><span class="op" id="6031693">.</span><span class="ident" id="6031694">Hijack</span><span class="op" id="6031700">(</span><span class="op" id="6031701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6031704">if</span>&nbsp;<span class="ident" id="6031707">c</span>&nbsp;<span class="op" id="6031709">!=</span>&nbsp;<span class="ident" id="6031712">nil</span>&nbsp;<span class="op" id="6031716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6031720">return</span>&nbsp;<span class="ident" id="6031727">c</span><span class="op" id="6031728">.</span><span class="ident" id="6031729">Close</span><span class="op" id="6031734">(</span><span class="op" id="6031735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6031738">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6031741">return</span>&nbsp;<span class="ident" id="6031748">nil</span><br>
<span class="lineno"></span><span class="op" id="6031752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6031755">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="6031833">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="6031912">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6031989">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="6032014">func</span>&nbsp;<span class="op" id="6032019">(</span><span class="ident" id="6032020">sc</span>&nbsp;<span class="op" id="6032023">*</span><span class="ident" id="6032024">ServerConn</span><span class="op" id="6032034">)</span>&nbsp;<span class="ident" id="6032036">Read</span><span class="op" id="6032040">(</span><span class="op" id="6032041">)</span>&nbsp;<span class="op" id="6032043">(</span><span class="ident" id="6032044">req</span>&nbsp;<span class="op" id="6032048">*</span><span class="ident" id="6032049">http</span><span class="op" id="6032053">.</span><span class="ident" id="6032054">Request</span><span class="op" id="6032061">,</span>&nbsp;<span class="ident" id="6032063">err</span>&nbsp;<span class="builtintype" id="6032067">error</span><span class="op" id="6032072">)</span>&nbsp;<span class="op" id="6032074">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6032078">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032127">id</span>&nbsp;<span class="op" id="6032130">:=</span>&nbsp;<span class="ident" id="6032133">sc</span><span class="op" id="6032135">.</span><span class="ident" id="6032136">pipe</span><span class="op" id="6032140">.</span><span class="ident" id="6032141">Next</span><span class="op" id="6032145">(</span><span class="op" id="6032146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032149">sc</span><span class="op" id="6032151">.</span><span class="ident" id="6032152">pipe</span><span class="op" id="6032156">.</span><span class="ident" id="6032157">StartRequest</span><span class="op" id="6032169">(</span><span class="ident" id="6032170">id</span><span class="op" id="6032172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032175">defer</span>&nbsp;<span class="keyword" id="6032181">func</span><span class="op" id="6032185">(</span><span class="op" id="6032186">)</span>&nbsp;<span class="op" id="6032188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032192">sc</span><span class="op" id="6032194">.</span><span class="ident" id="6032195">pipe</span><span class="op" id="6032199">.</span><span class="ident" id="6032200">EndRequest</span><span class="op" id="6032210">(</span><span class="ident" id="6032211">id</span><span class="op" id="6032213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032217">if</span>&nbsp;<span class="ident" id="6032220">req</span>&nbsp;<span class="op" id="6032224">==</span>&nbsp;<span class="ident" id="6032227">nil</span>&nbsp;<span class="op" id="6032231">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032236">sc</span><span class="op" id="6032238">.</span><span class="ident" id="6032239">pipe</span><span class="op" id="6032243">.</span><span class="ident" id="6032244">StartResponse</span><span class="op" id="6032257">(</span><span class="ident" id="6032258">id</span><span class="op" id="6032260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032265">sc</span><span class="op" id="6032267">.</span><span class="ident" id="6032268">pipe</span><span class="op" id="6032272">.</span><span class="ident" id="6032273">EndResponse</span><span class="op" id="6032284">(</span><span class="ident" id="6032285">id</span><span class="op" id="6032287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6032291">}</span>&nbsp;<span class="keyword" id="6032293">else</span>&nbsp;<span class="op" id="6032298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6032303">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032350">sc</span><span class="op" id="6032352">.</span><span class="ident" id="6032353">lk</span><span class="op" id="6032355">.</span><span class="ident" id="6032356">Lock</span><span class="op" id="6032360">(</span><span class="op" id="6032361">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032366">sc</span><span class="op" id="6032368">.</span><span class="ident" id="6032369">pipereq</span><span class="op" id="6032376">[</span><span class="ident" id="6032377">req</span><span class="op" id="6032380">]</span>&nbsp;<span class="op" id="6032382">=</span>&nbsp;<span class="ident" id="6032384">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032390">sc</span><span class="op" id="6032392">.</span><span class="ident" id="6032393">lk</span><span class="op" id="6032395">.</span><span class="ident" id="6032396">Unlock</span><span class="op" id="6032402">(</span><span class="op" id="6032403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6032407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6032410">}</span><span class="op" id="6032411">(</span><span class="op" id="6032412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032416">sc</span><span class="op" id="6032418">.</span><span class="ident" id="6032419">lk</span><span class="op" id="6032421">.</span><span class="ident" id="6032422">Lock</span><span class="op" id="6032426">(</span><span class="op" id="6032427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032430">if</span>&nbsp;<span class="ident" id="6032433">sc</span><span class="op" id="6032435">.</span><span class="ident" id="6032436">we</span>&nbsp;<span class="op" id="6032439">!=</span>&nbsp;<span class="ident" id="6032442">nil</span>&nbsp;<span class="op" id="6032446">{</span>&nbsp;<span class="comment" id="6032448">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032503">defer</span>&nbsp;<span class="ident" id="6032509">sc</span><span class="op" id="6032511">.</span><span class="ident" id="6032512">lk</span><span class="op" id="6032514">.</span><span class="ident" id="6032515">Unlock</span><span class="op" id="6032521">(</span><span class="op" id="6032522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032526">return</span>&nbsp;<span class="ident" id="6032533">nil</span><span class="op" id="6032536">,</span>&nbsp;<span class="ident" id="6032538">sc</span><span class="op" id="6032540">.</span><span class="ident" id="6032541">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6032545">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032548">if</span>&nbsp;<span class="ident" id="6032551">sc</span><span class="op" id="6032553">.</span><span class="ident" id="6032554">re</span>&nbsp;<span class="op" id="6032557">!=</span>&nbsp;<span class="ident" id="6032560">nil</span>&nbsp;<span class="op" id="6032564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032568">defer</span>&nbsp;<span class="ident" id="6032574">sc</span><span class="op" id="6032576">.</span><span class="ident" id="6032577">lk</span><span class="op" id="6032579">.</span><span class="ident" id="6032580">Unlock</span><span class="op" id="6032586">(</span><span class="op" id="6032587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032591">return</span>&nbsp;<span class="ident" id="6032598">nil</span><span class="op" id="6032601">,</span>&nbsp;<span class="ident" id="6032603">sc</span><span class="op" id="6032605">.</span><span class="ident" id="6032606">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6032610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032613">if</span>&nbsp;<span class="ident" id="6032616">sc</span><span class="op" id="6032618">.</span><span class="ident" id="6032619">r</span>&nbsp;<span class="op" id="6032621">==</span>&nbsp;<span class="ident" id="6032624">nil</span>&nbsp;<span class="op" id="6032628">{</span>&nbsp;<span class="comment" id="6032630">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032677">defer</span>&nbsp;<span class="ident" id="6032683">sc</span><span class="op" id="6032685">.</span><span class="ident" id="6032686">lk</span><span class="op" id="6032688">.</span><span class="ident" id="6032689">Unlock</span><span class="op" id="6032695">(</span><span class="op" id="6032696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032700">return</span>&nbsp;<span class="ident" id="6032707">nil</span><span class="op" id="6032710">,</span>&nbsp;<span class="ident" id="6032712">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6032723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032726">r</span>&nbsp;<span class="op" id="6032728">:=</span>&nbsp;<span class="ident" id="6032731">sc</span><span class="op" id="6032733">.</span><span class="ident" id="6032734">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032737">lastbody</span>&nbsp;<span class="op" id="6032746">:=</span>&nbsp;<span class="ident" id="6032749">sc</span><span class="op" id="6032751">.</span><span class="ident" id="6032752">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032762">sc</span><span class="op" id="6032764">.</span><span class="ident" id="6032765">lastbody</span>&nbsp;<span class="op" id="6032774">=</span>&nbsp;<span class="ident" id="6032776">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6032781">sc</span><span class="op" id="6032783">.</span><span class="ident" id="6032784">lk</span><span class="op" id="6032786">.</span><span class="ident" id="6032787">Unlock</span><span class="op" id="6032793">(</span><span class="op" id="6032794">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6032798">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6032874">if</span>&nbsp;<span class="ident" id="6032877">lastbody</span>&nbsp;<span class="op" id="6032886">!=</span>&nbsp;<span class="ident" id="6032889">nil</span>&nbsp;<span class="op" id="6032893">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6032897">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6032963">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033021">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033036">err</span>&nbsp;<span class="op" id="6033040">=</span>&nbsp;<span class="ident" id="6033042">lastbody</span><span class="op" id="6033050">.</span><span class="ident" id="6033051">Close</span><span class="op" id="6033056">(</span><span class="op" id="6033057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033061">if</span>&nbsp;<span class="ident" id="6033064">err</span>&nbsp;<span class="op" id="6033068">!=</span>&nbsp;<span class="ident" id="6033071">nil</span>&nbsp;<span class="op" id="6033075">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033080">sc</span><span class="op" id="6033082">.</span><span class="ident" id="6033083">lk</span><span class="op" id="6033085">.</span><span class="ident" id="6033086">Lock</span><span class="op" id="6033090">(</span><span class="op" id="6033091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033096">defer</span>&nbsp;<span class="ident" id="6033102">sc</span><span class="op" id="6033104">.</span><span class="ident" id="6033105">lk</span><span class="op" id="6033107">.</span><span class="ident" id="6033108">Unlock</span><span class="op" id="6033114">(</span><span class="op" id="6033115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033120">sc</span><span class="op" id="6033122">.</span><span class="ident" id="6033123">re</span>&nbsp;<span class="op" id="6033126">=</span>&nbsp;<span class="ident" id="6033128">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033135">return</span>&nbsp;<span class="ident" id="6033142">nil</span><span class="op" id="6033145">,</span>&nbsp;<span class="ident" id="6033147">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6033153">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6033156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033160">req</span><span class="op" id="6033163">,</span>&nbsp;<span class="ident" id="6033165">err</span>&nbsp;<span class="op" id="6033169">=</span>&nbsp;<span class="ident" id="6033171">http</span><span class="op" id="6033175">.</span><span class="ident" id="6033176">ReadRequest</span><span class="op" id="6033187">(</span><span class="ident" id="6033188">r</span><span class="op" id="6033189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033192">sc</span><span class="op" id="6033194">.</span><span class="ident" id="6033195">lk</span><span class="op" id="6033197">.</span><span class="ident" id="6033198">Lock</span><span class="op" id="6033202">(</span><span class="op" id="6033203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033206">defer</span>&nbsp;<span class="ident" id="6033212">sc</span><span class="op" id="6033214">.</span><span class="ident" id="6033215">lk</span><span class="op" id="6033217">.</span><span class="ident" id="6033218">Unlock</span><span class="op" id="6033224">(</span><span class="op" id="6033225">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033228">if</span>&nbsp;<span class="ident" id="6033231">err</span>&nbsp;<span class="op" id="6033235">!=</span>&nbsp;<span class="ident" id="6033238">nil</span>&nbsp;<span class="op" id="6033242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033246">if</span>&nbsp;<span class="ident" id="6033249">err</span>&nbsp;<span class="op" id="6033253">==</span>&nbsp;<span class="ident" id="6033256">io</span><span class="op" id="6033258">.</span><span class="ident" id="6033259">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6033276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033281">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033336">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033394">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033423">sc</span><span class="op" id="6033425">.</span><span class="ident" id="6033426">re</span>&nbsp;<span class="op" id="6033429">=</span>&nbsp;<span class="ident" id="6033431">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033448">return</span>&nbsp;<span class="ident" id="6033455">nil</span><span class="op" id="6033458">,</span>&nbsp;<span class="ident" id="6033460">sc</span><span class="op" id="6033462">.</span><span class="ident" id="6033463">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6033468">}</span>&nbsp;<span class="keyword" id="6033470">else</span>&nbsp;<span class="op" id="6033475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033480">sc</span><span class="op" id="6033482">.</span><span class="ident" id="6033483">re</span>&nbsp;<span class="op" id="6033486">=</span>&nbsp;<span class="ident" id="6033488">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033495">return</span>&nbsp;<span class="ident" id="6033502">req</span><span class="op" id="6033505">,</span>&nbsp;<span class="ident" id="6033507">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6033513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6033516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033519">sc</span><span class="op" id="6033521">.</span><span class="ident" id="6033522">lastbody</span>&nbsp;<span class="op" id="6033531">=</span>&nbsp;<span class="ident" id="6033533">req</span><span class="op" id="6033536">.</span><span class="ident" id="6033537">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033543">sc</span><span class="op" id="6033545">.</span><span class="ident" id="6033546">nread</span><span class="op" id="6033551">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033555">if</span>&nbsp;<span class="ident" id="6033558">req</span><span class="op" id="6033561">.</span><span class="ident" id="6033562">Close</span>&nbsp;<span class="op" id="6033568">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033572">sc</span><span class="op" id="6033574">.</span><span class="ident" id="6033575">re</span>&nbsp;<span class="op" id="6033578">=</span>&nbsp;<span class="ident" id="6033580">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033596">return</span>&nbsp;<span class="ident" id="6033603">req</span><span class="op" id="6033606">,</span>&nbsp;<span class="ident" id="6033608">sc</span><span class="op" id="6033610">.</span><span class="ident" id="6033611">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6033615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033618">return</span>&nbsp;<span class="ident" id="6033625">req</span><span class="op" id="6033628">,</span>&nbsp;<span class="ident" id="6033630">err</span><br>
<span class="lineno"></span><span class="op" id="6033634">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="6033637">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="6033690">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6033736">func</span>&nbsp;<span class="op" id="6033741">(</span><span class="ident" id="6033742">sc</span>&nbsp;<span class="op" id="6033745">*</span><span class="ident" id="6033746">ServerConn</span><span class="op" id="6033756">)</span>&nbsp;<span class="ident" id="6033758">Pending</span><span class="op" id="6033765">(</span><span class="op" id="6033766">)</span>&nbsp;<span class="builtintype" id="6033768">int</span>&nbsp;<span class="op" id="6033772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033775">sc</span><span class="op" id="6033777">.</span><span class="ident" id="6033778">lk</span><span class="op" id="6033780">.</span><span class="ident" id="6033781">Lock</span><span class="op" id="6033785">(</span><span class="op" id="6033786">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033789">defer</span>&nbsp;<span class="ident" id="6033795">sc</span><span class="op" id="6033797">.</span><span class="ident" id="6033798">lk</span><span class="op" id="6033800">.</span><span class="ident" id="6033801">Unlock</span><span class="op" id="6033807">(</span><span class="op" id="6033808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6033811">return</span>&nbsp;<span class="ident" id="6033818">sc</span><span class="op" id="6033820">.</span><span class="ident" id="6033821">nread</span>&nbsp;<span class="op" id="6033827">-</span>&nbsp;<span class="ident" id="6033829">sc</span><span class="op" id="6033831">.</span><span class="ident" id="6033832">nwritten</span><br>
<span class="lineno"></span><span class="op" id="6033841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6033844">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="6033929">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6034007">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="6034083">func</span>&nbsp;<span class="op" id="6034088">(</span><span class="ident" id="6034089">sc</span>&nbsp;<span class="op" id="6034092">*</span><span class="ident" id="6034093">ServerConn</span><span class="op" id="6034103">)</span>&nbsp;<span class="ident" id="6034105">Write</span><span class="op" id="6034110">(</span><span class="ident" id="6034111">req</span>&nbsp;<span class="op" id="6034115">*</span><span class="ident" id="6034116">http</span><span class="op" id="6034120">.</span><span class="ident" id="6034121">Request</span><span class="op" id="6034128">,</span>&nbsp;<span class="ident" id="6034130">resp</span>&nbsp;<span class="op" id="6034135">*</span><span class="ident" id="6034136">http</span><span class="op" id="6034140">.</span><span class="ident" id="6034141">Response</span><span class="op" id="6034149">)</span>&nbsp;<span class="builtintype" id="6034151">error</span>&nbsp;<span class="op" id="6034157">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034161">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034220">sc</span><span class="op" id="6034222">.</span><span class="ident" id="6034223">lk</span><span class="op" id="6034225">.</span><span class="ident" id="6034226">Lock</span><span class="op" id="6034230">(</span><span class="op" id="6034231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034234">id</span><span class="op" id="6034236">,</span>&nbsp;<span class="ident" id="6034238">ok</span>&nbsp;<span class="op" id="6034241">:=</span>&nbsp;<span class="ident" id="6034244">sc</span><span class="op" id="6034246">.</span><span class="ident" id="6034247">pipereq</span><span class="op" id="6034254">[</span><span class="ident" id="6034255">req</span><span class="op" id="6034258">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6034261">delete</span><span class="op" id="6034267">(</span><span class="ident" id="6034268">sc</span><span class="op" id="6034270">.</span><span class="ident" id="6034271">pipereq</span><span class="op" id="6034278">,</span>&nbsp;<span class="ident" id="6034280">req</span><span class="op" id="6034283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034286">if</span>&nbsp;<span class="op" id="6034289">!</span><span class="ident" id="6034290">ok</span>&nbsp;<span class="op" id="6034293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034297">sc</span><span class="op" id="6034299">.</span><span class="ident" id="6034300">lk</span><span class="op" id="6034302">.</span><span class="ident" id="6034303">Unlock</span><span class="op" id="6034309">(</span><span class="op" id="6034310">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034314">return</span>&nbsp;<span class="ident" id="6034321">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6034334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034337">sc</span><span class="op" id="6034339">.</span><span class="ident" id="6034340">lk</span><span class="op" id="6034342">.</span><span class="ident" id="6034343">Unlock</span><span class="op" id="6034349">(</span><span class="op" id="6034350">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034354">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034380">sc</span><span class="op" id="6034382">.</span><span class="ident" id="6034383">pipe</span><span class="op" id="6034387">.</span><span class="ident" id="6034388">StartResponse</span><span class="op" id="6034401">(</span><span class="ident" id="6034402">id</span><span class="op" id="6034404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034407">defer</span>&nbsp;<span class="ident" id="6034413">sc</span><span class="op" id="6034415">.</span><span class="ident" id="6034416">pipe</span><span class="op" id="6034420">.</span><span class="ident" id="6034421">EndResponse</span><span class="op" id="6034432">(</span><span class="ident" id="6034433">id</span><span class="op" id="6034435">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034439">sc</span><span class="op" id="6034441">.</span><span class="ident" id="6034442">lk</span><span class="op" id="6034444">.</span><span class="ident" id="6034445">Lock</span><span class="op" id="6034449">(</span><span class="op" id="6034450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034453">if</span>&nbsp;<span class="ident" id="6034456">sc</span><span class="op" id="6034458">.</span><span class="ident" id="6034459">we</span>&nbsp;<span class="op" id="6034462">!=</span>&nbsp;<span class="ident" id="6034465">nil</span>&nbsp;<span class="op" id="6034469">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034473">defer</span>&nbsp;<span class="ident" id="6034479">sc</span><span class="op" id="6034481">.</span><span class="ident" id="6034482">lk</span><span class="op" id="6034484">.</span><span class="ident" id="6034485">Unlock</span><span class="op" id="6034491">(</span><span class="op" id="6034492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034496">return</span>&nbsp;<span class="ident" id="6034503">sc</span><span class="op" id="6034505">.</span><span class="ident" id="6034506">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6034510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034513">if</span>&nbsp;<span class="ident" id="6034516">sc</span><span class="op" id="6034518">.</span><span class="ident" id="6034519">c</span>&nbsp;<span class="op" id="6034521">==</span>&nbsp;<span class="ident" id="6034524">nil</span>&nbsp;<span class="op" id="6034528">{</span>&nbsp;<span class="comment" id="6034530">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034577">defer</span>&nbsp;<span class="ident" id="6034583">sc</span><span class="op" id="6034585">.</span><span class="ident" id="6034586">lk</span><span class="op" id="6034588">.</span><span class="ident" id="6034589">Unlock</span><span class="op" id="6034595">(</span><span class="op" id="6034596">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034600">return</span>&nbsp;<span class="ident" id="6034607">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6034618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034621">c</span>&nbsp;<span class="op" id="6034623">:=</span>&nbsp;<span class="ident" id="6034626">sc</span><span class="op" id="6034628">.</span><span class="ident" id="6034629">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034632">if</span>&nbsp;<span class="ident" id="6034635">sc</span><span class="op" id="6034637">.</span><span class="ident" id="6034638">nread</span>&nbsp;<span class="op" id="6034644">&lt;=</span>&nbsp;<span class="ident" id="6034647">sc</span><span class="op" id="6034649">.</span><span class="ident" id="6034650">nwritten</span>&nbsp;<span class="op" id="6034659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034663">defer</span>&nbsp;<span class="ident" id="6034669">sc</span><span class="op" id="6034671">.</span><span class="ident" id="6034672">lk</span><span class="op" id="6034674">.</span><span class="ident" id="6034675">Unlock</span><span class="op" id="6034681">(</span><span class="op" id="6034682">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034686">return</span>&nbsp;<span class="ident" id="6034693">errors</span><span class="op" id="6034699">.</span><span class="ident" id="6034700">New</span><span class="op" id="6034703">(</span><span class="string" id="6034704">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="6034731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6034734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034737">if</span>&nbsp;<span class="ident" id="6034740">resp</span><span class="op" id="6034744">.</span><span class="ident" id="6034745">Close</span>&nbsp;<span class="op" id="6034751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034755">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034817">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034880">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034903">sc</span><span class="op" id="6034905">.</span><span class="ident" id="6034906">re</span>&nbsp;<span class="op" id="6034909">=</span>&nbsp;<span class="ident" id="6034911">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6034926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034929">sc</span><span class="op" id="6034931">.</span><span class="ident" id="6034932">lk</span><span class="op" id="6034934">.</span><span class="ident" id="6034935">Unlock</span><span class="op" id="6034941">(</span><span class="op" id="6034942">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034946">err</span>&nbsp;<span class="op" id="6034950">:=</span>&nbsp;<span class="ident" id="6034953">resp</span><span class="op" id="6034957">.</span><span class="ident" id="6034958">Write</span><span class="op" id="6034963">(</span><span class="ident" id="6034964">c</span><span class="op" id="6034965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034968">sc</span><span class="op" id="6034970">.</span><span class="ident" id="6034971">lk</span><span class="op" id="6034973">.</span><span class="ident" id="6034974">Lock</span><span class="op" id="6034978">(</span><span class="op" id="6034979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034982">defer</span>&nbsp;<span class="ident" id="6034988">sc</span><span class="op" id="6034990">.</span><span class="ident" id="6034991">lk</span><span class="op" id="6034993">.</span><span class="ident" id="6034994">Unlock</span><span class="op" id="6035000">(</span><span class="op" id="6035001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035004">if</span>&nbsp;<span class="ident" id="6035007">err</span>&nbsp;<span class="op" id="6035011">!=</span>&nbsp;<span class="ident" id="6035014">nil</span>&nbsp;<span class="op" id="6035018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035022">sc</span><span class="op" id="6035024">.</span><span class="ident" id="6035025">we</span>&nbsp;<span class="op" id="6035028">=</span>&nbsp;<span class="ident" id="6035030">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035036">return</span>&nbsp;<span class="ident" id="6035043">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035051">sc</span><span class="op" id="6035053">.</span><span class="ident" id="6035054">nwritten</span><span class="op" id="6035062">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035067">return</span>&nbsp;<span class="ident" id="6035074">nil</span><br>
<span class="lineno">220</span><span class="op" id="6035078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6035081">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6035151">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="6035220">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="6035275">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="6035349">//</span><br>
<span class="lineno"></span><span class="comment" id="6035352">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="6035420">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6035468">type</span>&nbsp;<span class="ident" id="6035473">ClientConn</span>&nbsp;<span class="keyword" id="6035484">struct</span>&nbsp;<span class="op" id="6035491">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035494">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035510">sync</span><span class="op" id="6035514">.</span><span class="ident" id="6035515">Mutex</span>&nbsp;<span class="comment" id="6035521">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035566">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035582">net</span><span class="op" id="6035585">.</span><span class="ident" id="6035586">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035592">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6035608">*</span><span class="ident" id="6035609">bufio</span><span class="op" id="6035614">.</span><span class="ident" id="6035615">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035623">re</span><span class="op" id="6035625">,</span>&nbsp;<span class="ident" id="6035627">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6035639">error</span>&nbsp;<span class="comment" id="6035645">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035667">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035683">io</span><span class="op" id="6035685">.</span><span class="ident" id="6035686">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035698">nread</span><span class="op" id="6035703">,</span>&nbsp;<span class="ident" id="6035705">nwritten</span>&nbsp;<span class="builtintype" id="6035714">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035719">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035735">map</span><span class="op" id="6035738">[</span><span class="op" id="6035739">*</span><span class="ident" id="6035740">http</span><span class="op" id="6035744">.</span><span class="ident" id="6035745">Request</span><span class="op" id="6035752">]</span><span class="builtintype" id="6035753">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035760">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035769">textproto</span><span class="op" id="6035778">.</span><span class="ident" id="6035779">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035789">writeReq</span>&nbsp;<span class="keyword" id="6035798">func</span><span class="op" id="6035802">(</span><span class="op" id="6035803">*</span><span class="ident" id="6035804">http</span><span class="op" id="6035808">.</span><span class="ident" id="6035809">Request</span><span class="op" id="6035816">,</span>&nbsp;<span class="ident" id="6035818">io</span><span class="op" id="6035820">.</span><span class="ident" id="6035821">Writer</span><span class="op" id="6035827">)</span>&nbsp;<span class="builtintype" id="6035829">error</span><br>
<span class="lineno">240</span><span class="op" id="6035835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6035838">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6035916">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="6035964">//</span><br>
<span class="lineno">245</span><span class="comment" id="6035967">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6036037">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6036075">func</span>&nbsp;<span class="ident" id="6036080">NewClientConn</span><span class="op" id="6036093">(</span><span class="ident" id="6036094">c</span>&nbsp;<span class="ident" id="6036096">net</span><span class="op" id="6036099">.</span><span class="ident" id="6036100">Conn</span><span class="op" id="6036104">,</span>&nbsp;<span class="ident" id="6036106">r</span>&nbsp;<span class="op" id="6036108">*</span><span class="ident" id="6036109">bufio</span><span class="op" id="6036114">.</span><span class="ident" id="6036115">Reader</span><span class="op" id="6036121">)</span>&nbsp;<span class="op" id="6036123">*</span><span class="ident" id="6036124">ClientConn</span>&nbsp;<span class="op" id="6036135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036138">if</span>&nbsp;<span class="ident" id="6036141">r</span>&nbsp;<span class="op" id="6036143">==</span>&nbsp;<span class="ident" id="6036146">nil</span>&nbsp;<span class="op" id="6036150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036154">r</span>&nbsp;<span class="op" id="6036156">=</span>&nbsp;<span class="ident" id="6036158">bufio</span><span class="op" id="6036163">.</span><span class="ident" id="6036164">NewReader</span><span class="op" id="6036173">(</span><span class="ident" id="6036174">c</span><span class="op" id="6036175">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036181">return</span>&nbsp;<span class="op" id="6036188">&amp;</span><span class="ident" id="6036189">ClientConn</span><span class="op" id="6036199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036203">c</span><span class="op" id="6036204">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036213">c</span><span class="op" id="6036214">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036218">r</span><span class="op" id="6036219">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036228">r</span><span class="op" id="6036229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036233">pipereq</span><span class="op" id="6036240">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6036243">make</span><span class="op" id="6036247">(</span><span class="keyword" id="6036248">map</span><span class="op" id="6036251">[</span><span class="op" id="6036252">*</span><span class="ident" id="6036253">http</span><span class="op" id="6036257">.</span><span class="ident" id="6036258">Request</span><span class="op" id="6036265">]</span><span class="builtintype" id="6036266">uint</span><span class="op" id="6036270">)</span><span class="op" id="6036271">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036275">writeReq</span><span class="op" id="6036283">:</span>&nbsp;<span class="op" id="6036285">(</span><span class="op" id="6036286">*</span><span class="ident" id="6036287">http</span><span class="op" id="6036291">.</span><span class="ident" id="6036292">Request</span><span class="op" id="6036299">)</span><span class="op" id="6036300">.</span><span class="ident" id="6036301">Write</span><span class="op" id="6036306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036309">}</span><br>
<span class="lineno"></span><span class="op" id="6036311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6036314">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="6036381">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="6036419">//</span><br>
<span class="lineno"></span><span class="comment" id="6036422">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6036483">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6036529">func</span>&nbsp;<span class="ident" id="6036534">NewProxyClientConn</span><span class="op" id="6036552">(</span><span class="ident" id="6036553">c</span>&nbsp;<span class="ident" id="6036555">net</span><span class="op" id="6036558">.</span><span class="ident" id="6036559">Conn</span><span class="op" id="6036563">,</span>&nbsp;<span class="ident" id="6036565">r</span>&nbsp;<span class="op" id="6036567">*</span><span class="ident" id="6036568">bufio</span><span class="op" id="6036573">.</span><span class="ident" id="6036574">Reader</span><span class="op" id="6036580">)</span>&nbsp;<span class="op" id="6036582">*</span><span class="ident" id="6036583">ClientConn</span>&nbsp;<span class="op" id="6036594">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036597">cc</span>&nbsp;<span class="op" id="6036600">:=</span>&nbsp;<span class="ident" id="6036603">NewClientConn</span><span class="op" id="6036616">(</span><span class="ident" id="6036617">c</span><span class="op" id="6036618">,</span>&nbsp;<span class="ident" id="6036620">r</span><span class="op" id="6036621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036624">cc</span><span class="op" id="6036626">.</span><span class="ident" id="6036627">writeReq</span>&nbsp;<span class="op" id="6036636">=</span>&nbsp;<span class="op" id="6036638">(</span><span class="op" id="6036639">*</span><span class="ident" id="6036640">http</span><span class="op" id="6036644">.</span><span class="ident" id="6036645">Request</span><span class="op" id="6036652">)</span><span class="op" id="6036653">.</span><span class="ident" id="6036654">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036666">return</span>&nbsp;<span class="ident" id="6036673">cc</span><br>
<span class="lineno"></span><span class="op" id="6036676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6036679">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6036759">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6036835">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="6036909">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6036987">func</span>&nbsp;<span class="op" id="6036992">(</span><span class="ident" id="6036993">cc</span>&nbsp;<span class="op" id="6036996">*</span><span class="ident" id="6036997">ClientConn</span><span class="op" id="6037007">)</span>&nbsp;<span class="ident" id="6037009">Hijack</span><span class="op" id="6037015">(</span><span class="op" id="6037016">)</span>&nbsp;<span class="op" id="6037018">(</span><span class="ident" id="6037019">c</span>&nbsp;<span class="ident" id="6037021">net</span><span class="op" id="6037024">.</span><span class="ident" id="6037025">Conn</span><span class="op" id="6037029">,</span>&nbsp;<span class="ident" id="6037031">r</span>&nbsp;<span class="op" id="6037033">*</span><span class="ident" id="6037034">bufio</span><span class="op" id="6037039">.</span><span class="ident" id="6037040">Reader</span><span class="op" id="6037046">)</span>&nbsp;<span class="op" id="6037048">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037051">cc</span><span class="op" id="6037053">.</span><span class="ident" id="6037054">lk</span><span class="op" id="6037056">.</span><span class="ident" id="6037057">Lock</span><span class="op" id="6037061">(</span><span class="op" id="6037062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037065">defer</span>&nbsp;<span class="ident" id="6037071">cc</span><span class="op" id="6037073">.</span><span class="ident" id="6037074">lk</span><span class="op" id="6037076">.</span><span class="ident" id="6037077">Unlock</span><span class="op" id="6037083">(</span><span class="op" id="6037084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037087">c</span>&nbsp;<span class="op" id="6037089">=</span>&nbsp;<span class="ident" id="6037091">cc</span><span class="op" id="6037093">.</span><span class="ident" id="6037094">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037097">r</span>&nbsp;<span class="op" id="6037099">=</span>&nbsp;<span class="ident" id="6037101">cc</span><span class="op" id="6037103">.</span><span class="ident" id="6037104">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037107">cc</span><span class="op" id="6037109">.</span><span class="ident" id="6037110">c</span>&nbsp;<span class="op" id="6037112">=</span>&nbsp;<span class="ident" id="6037114">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037119">cc</span><span class="op" id="6037121">.</span><span class="ident" id="6037122">r</span>&nbsp;<span class="op" id="6037124">=</span>&nbsp;<span class="ident" id="6037126">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037131">return</span><br>
<span class="lineno"></span><span class="op" id="6037138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6037141">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="6037210">func</span>&nbsp;<span class="op" id="6037215">(</span><span class="ident" id="6037216">cc</span>&nbsp;<span class="op" id="6037219">*</span><span class="ident" id="6037220">ClientConn</span><span class="op" id="6037230">)</span>&nbsp;<span class="ident" id="6037232">Close</span><span class="op" id="6037237">(</span><span class="op" id="6037238">)</span>&nbsp;<span class="builtintype" id="6037240">error</span>&nbsp;<span class="op" id="6037246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037249">c</span><span class="op" id="6037250">,</span>&nbsp;<span class="ident" id="6037252">_</span>&nbsp;<span class="op" id="6037254">:=</span>&nbsp;<span class="ident" id="6037257">cc</span><span class="op" id="6037259">.</span><span class="ident" id="6037260">Hijack</span><span class="op" id="6037266">(</span><span class="op" id="6037267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037270">if</span>&nbsp;<span class="ident" id="6037273">c</span>&nbsp;<span class="op" id="6037275">!=</span>&nbsp;<span class="ident" id="6037278">nil</span>&nbsp;<span class="op" id="6037282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037286">return</span>&nbsp;<span class="ident" id="6037293">c</span><span class="op" id="6037294">.</span><span class="ident" id="6037295">Close</span><span class="op" id="6037300">(</span><span class="op" id="6037301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037304">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037307">return</span>&nbsp;<span class="ident" id="6037314">nil</span><br>
<span class="lineno"></span><span class="op" id="6037318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6037321">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6037401">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="6037478">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="6037558">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6037633">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="6037710">func</span>&nbsp;<span class="op" id="6037715">(</span><span class="ident" id="6037716">cc</span>&nbsp;<span class="op" id="6037719">*</span><span class="ident" id="6037720">ClientConn</span><span class="op" id="6037730">)</span>&nbsp;<span class="ident" id="6037732">Write</span><span class="op" id="6037737">(</span><span class="ident" id="6037738">req</span>&nbsp;<span class="op" id="6037742">*</span><span class="ident" id="6037743">http</span><span class="op" id="6037747">.</span><span class="ident" id="6037748">Request</span><span class="op" id="6037755">)</span>&nbsp;<span class="op" id="6037757">(</span><span class="ident" id="6037758">err</span>&nbsp;<span class="builtintype" id="6037762">error</span><span class="op" id="6037767">)</span>&nbsp;<span class="op" id="6037769">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6037773">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037812">id</span>&nbsp;<span class="op" id="6037815">:=</span>&nbsp;<span class="ident" id="6037818">cc</span><span class="op" id="6037820">.</span><span class="ident" id="6037821">pipe</span><span class="op" id="6037825">.</span><span class="ident" id="6037826">Next</span><span class="op" id="6037830">(</span><span class="op" id="6037831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037834">cc</span><span class="op" id="6037836">.</span><span class="ident" id="6037837">pipe</span><span class="op" id="6037841">.</span><span class="ident" id="6037842">StartRequest</span><span class="op" id="6037854">(</span><span class="ident" id="6037855">id</span><span class="op" id="6037857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037860">defer</span>&nbsp;<span class="keyword" id="6037866">func</span><span class="op" id="6037870">(</span><span class="op" id="6037871">)</span>&nbsp;<span class="op" id="6037873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037877">cc</span><span class="op" id="6037879">.</span><span class="ident" id="6037880">pipe</span><span class="op" id="6037884">.</span><span class="ident" id="6037885">EndRequest</span><span class="op" id="6037895">(</span><span class="ident" id="6037896">id</span><span class="op" id="6037898">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037902">if</span>&nbsp;<span class="ident" id="6037905">err</span>&nbsp;<span class="op" id="6037909">!=</span>&nbsp;<span class="ident" id="6037912">nil</span>&nbsp;<span class="op" id="6037916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037921">cc</span><span class="op" id="6037923">.</span><span class="ident" id="6037924">pipe</span><span class="op" id="6037928">.</span><span class="ident" id="6037929">StartResponse</span><span class="op" id="6037942">(</span><span class="ident" id="6037943">id</span><span class="op" id="6037945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037950">cc</span><span class="op" id="6037952">.</span><span class="ident" id="6037953">pipe</span><span class="op" id="6037957">.</span><span class="ident" id="6037958">EndResponse</span><span class="op" id="6037969">(</span><span class="ident" id="6037970">id</span><span class="op" id="6037972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037976">}</span>&nbsp;<span class="keyword" id="6037978">else</span>&nbsp;<span class="op" id="6037983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6037988">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038035">cc</span><span class="op" id="6038037">.</span><span class="ident" id="6038038">lk</span><span class="op" id="6038040">.</span><span class="ident" id="6038041">Lock</span><span class="op" id="6038045">(</span><span class="op" id="6038046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038051">cc</span><span class="op" id="6038053">.</span><span class="ident" id="6038054">pipereq</span><span class="op" id="6038061">[</span><span class="ident" id="6038062">req</span><span class="op" id="6038065">]</span>&nbsp;<span class="op" id="6038067">=</span>&nbsp;<span class="ident" id="6038069">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038075">cc</span><span class="op" id="6038077">.</span><span class="ident" id="6038078">lk</span><span class="op" id="6038080">.</span><span class="ident" id="6038081">Unlock</span><span class="op" id="6038087">(</span><span class="op" id="6038088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038095">}</span><span class="op" id="6038096">(</span><span class="op" id="6038097">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038101">cc</span><span class="op" id="6038103">.</span><span class="ident" id="6038104">lk</span><span class="op" id="6038106">.</span><span class="ident" id="6038107">Lock</span><span class="op" id="6038111">(</span><span class="op" id="6038112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038115">if</span>&nbsp;<span class="ident" id="6038118">cc</span><span class="op" id="6038120">.</span><span class="ident" id="6038121">re</span>&nbsp;<span class="op" id="6038124">!=</span>&nbsp;<span class="ident" id="6038127">nil</span>&nbsp;<span class="op" id="6038131">{</span>&nbsp;<span class="comment" id="6038133">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038185">defer</span>&nbsp;<span class="ident" id="6038191">cc</span><span class="op" id="6038193">.</span><span class="ident" id="6038194">lk</span><span class="op" id="6038196">.</span><span class="ident" id="6038197">Unlock</span><span class="op" id="6038203">(</span><span class="op" id="6038204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038208">return</span>&nbsp;<span class="ident" id="6038215">cc</span><span class="op" id="6038217">.</span><span class="ident" id="6038218">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038225">if</span>&nbsp;<span class="ident" id="6038228">cc</span><span class="op" id="6038230">.</span><span class="ident" id="6038231">we</span>&nbsp;<span class="op" id="6038234">!=</span>&nbsp;<span class="ident" id="6038237">nil</span>&nbsp;<span class="op" id="6038241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038245">defer</span>&nbsp;<span class="ident" id="6038251">cc</span><span class="op" id="6038253">.</span><span class="ident" id="6038254">lk</span><span class="op" id="6038256">.</span><span class="ident" id="6038257">Unlock</span><span class="op" id="6038263">(</span><span class="op" id="6038264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038268">return</span>&nbsp;<span class="ident" id="6038275">cc</span><span class="op" id="6038277">.</span><span class="ident" id="6038278">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038282">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038285">if</span>&nbsp;<span class="ident" id="6038288">cc</span><span class="op" id="6038290">.</span><span class="ident" id="6038291">c</span>&nbsp;<span class="op" id="6038293">==</span>&nbsp;<span class="ident" id="6038296">nil</span>&nbsp;<span class="op" id="6038300">{</span>&nbsp;<span class="comment" id="6038302">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038349">defer</span>&nbsp;<span class="ident" id="6038355">cc</span><span class="op" id="6038357">.</span><span class="ident" id="6038358">lk</span><span class="op" id="6038360">.</span><span class="ident" id="6038361">Unlock</span><span class="op" id="6038367">(</span><span class="op" id="6038368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038372">return</span>&nbsp;<span class="ident" id="6038379">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038393">c</span>&nbsp;<span class="op" id="6038395">:=</span>&nbsp;<span class="ident" id="6038398">cc</span><span class="op" id="6038400">.</span><span class="ident" id="6038401">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038404">if</span>&nbsp;<span class="ident" id="6038407">req</span><span class="op" id="6038410">.</span><span class="ident" id="6038411">Close</span>&nbsp;<span class="op" id="6038417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6038421">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6038482">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038523">cc</span><span class="op" id="6038525">.</span><span class="ident" id="6038526">we</span>&nbsp;<span class="op" id="6038529">=</span>&nbsp;<span class="ident" id="6038531">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038546">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038549">cc</span><span class="op" id="6038551">.</span><span class="ident" id="6038552">lk</span><span class="op" id="6038554">.</span><span class="ident" id="6038555">Unlock</span><span class="op" id="6038561">(</span><span class="op" id="6038562">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038566">err</span>&nbsp;<span class="op" id="6038570">=</span>&nbsp;<span class="ident" id="6038572">cc</span><span class="op" id="6038574">.</span><span class="ident" id="6038575">writeReq</span><span class="op" id="6038583">(</span><span class="ident" id="6038584">req</span><span class="op" id="6038587">,</span>&nbsp;<span class="ident" id="6038589">c</span><span class="op" id="6038590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038593">cc</span><span class="op" id="6038595">.</span><span class="ident" id="6038596">lk</span><span class="op" id="6038598">.</span><span class="ident" id="6038599">Lock</span><span class="op" id="6038603">(</span><span class="op" id="6038604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038607">defer</span>&nbsp;<span class="ident" id="6038613">cc</span><span class="op" id="6038615">.</span><span class="ident" id="6038616">lk</span><span class="op" id="6038618">.</span><span class="ident" id="6038619">Unlock</span><span class="op" id="6038625">(</span><span class="op" id="6038626">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038629">if</span>&nbsp;<span class="ident" id="6038632">err</span>&nbsp;<span class="op" id="6038636">!=</span>&nbsp;<span class="ident" id="6038639">nil</span>&nbsp;<span class="op" id="6038643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038647">cc</span><span class="op" id="6038649">.</span><span class="ident" id="6038650">we</span>&nbsp;<span class="op" id="6038653">=</span>&nbsp;<span class="ident" id="6038655">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038661">return</span>&nbsp;<span class="ident" id="6038668">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038676">cc</span><span class="op" id="6038678">.</span><span class="ident" id="6038679">nwritten</span><span class="op" id="6038687">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038692">return</span>&nbsp;<span class="ident" id="6038699">nil</span><br>
<span class="lineno"></span><span class="op" id="6038703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6038706">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="6038759">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6038801">func</span>&nbsp;<span class="op" id="6038806">(</span><span class="ident" id="6038807">cc</span>&nbsp;<span class="op" id="6038810">*</span><span class="ident" id="6038811">ClientConn</span><span class="op" id="6038821">)</span>&nbsp;<span class="ident" id="6038823">Pending</span><span class="op" id="6038830">(</span><span class="op" id="6038831">)</span>&nbsp;<span class="builtintype" id="6038833">int</span>&nbsp;<span class="op" id="6038837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038840">cc</span><span class="op" id="6038842">.</span><span class="ident" id="6038843">lk</span><span class="op" id="6038845">.</span><span class="ident" id="6038846">Lock</span><span class="op" id="6038850">(</span><span class="op" id="6038851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038854">defer</span>&nbsp;<span class="ident" id="6038860">cc</span><span class="op" id="6038862">.</span><span class="ident" id="6038863">lk</span><span class="op" id="6038865">.</span><span class="ident" id="6038866">Unlock</span><span class="op" id="6038872">(</span><span class="op" id="6038873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038876">return</span>&nbsp;<span class="ident" id="6038883">cc</span><span class="op" id="6038885">.</span><span class="ident" id="6038886">nwritten</span>&nbsp;<span class="op" id="6038895">-</span>&nbsp;<span class="ident" id="6038897">cc</span><span class="op" id="6038899">.</span><span class="ident" id="6038900">nread</span><br>
<span class="lineno">355</span><span class="op" id="6038906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6038909">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6038982">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="6039054">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="6039126">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="6039181">func</span>&nbsp;<span class="op" id="6039186">(</span><span class="ident" id="6039187">cc</span>&nbsp;<span class="op" id="6039190">*</span><span class="ident" id="6039191">ClientConn</span><span class="op" id="6039201">)</span>&nbsp;<span class="ident" id="6039203">Read</span><span class="op" id="6039207">(</span><span class="ident" id="6039208">req</span>&nbsp;<span class="op" id="6039212">*</span><span class="ident" id="6039213">http</span><span class="op" id="6039217">.</span><span class="ident" id="6039218">Request</span><span class="op" id="6039225">)</span>&nbsp;<span class="op" id="6039227">(</span><span class="ident" id="6039228">resp</span>&nbsp;<span class="op" id="6039233">*</span><span class="ident" id="6039234">http</span><span class="op" id="6039238">.</span><span class="ident" id="6039239">Response</span><span class="op" id="6039247">,</span>&nbsp;<span class="ident" id="6039249">err</span>&nbsp;<span class="builtintype" id="6039253">error</span><span class="op" id="6039258">)</span>&nbsp;<span class="op" id="6039260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039263">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039322">cc</span><span class="op" id="6039324">.</span><span class="ident" id="6039325">lk</span><span class="op" id="6039327">.</span><span class="ident" id="6039328">Lock</span><span class="op" id="6039332">(</span><span class="op" id="6039333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039336">id</span><span class="op" id="6039338">,</span>&nbsp;<span class="ident" id="6039340">ok</span>&nbsp;<span class="op" id="6039343">:=</span>&nbsp;<span class="ident" id="6039346">cc</span><span class="op" id="6039348">.</span><span class="ident" id="6039349">pipereq</span><span class="op" id="6039356">[</span><span class="ident" id="6039357">req</span><span class="op" id="6039360">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6039363">delete</span><span class="op" id="6039369">(</span><span class="ident" id="6039370">cc</span><span class="op" id="6039372">.</span><span class="ident" id="6039373">pipereq</span><span class="op" id="6039380">,</span>&nbsp;<span class="ident" id="6039382">req</span><span class="op" id="6039385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039388">if</span>&nbsp;<span class="op" id="6039391">!</span><span class="ident" id="6039392">ok</span>&nbsp;<span class="op" id="6039395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039399">cc</span><span class="op" id="6039401">.</span><span class="ident" id="6039402">lk</span><span class="op" id="6039404">.</span><span class="ident" id="6039405">Unlock</span><span class="op" id="6039411">(</span><span class="op" id="6039412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039416">return</span>&nbsp;<span class="ident" id="6039423">nil</span><span class="op" id="6039426">,</span>&nbsp;<span class="ident" id="6039428">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039441">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039444">cc</span><span class="op" id="6039446">.</span><span class="ident" id="6039447">lk</span><span class="op" id="6039449">.</span><span class="ident" id="6039450">Unlock</span><span class="op" id="6039456">(</span><span class="op" id="6039457">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039461">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039487">cc</span><span class="op" id="6039489">.</span><span class="ident" id="6039490">pipe</span><span class="op" id="6039494">.</span><span class="ident" id="6039495">StartResponse</span><span class="op" id="6039508">(</span><span class="ident" id="6039509">id</span><span class="op" id="6039511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039514">defer</span>&nbsp;<span class="ident" id="6039520">cc</span><span class="op" id="6039522">.</span><span class="ident" id="6039523">pipe</span><span class="op" id="6039527">.</span><span class="ident" id="6039528">EndResponse</span><span class="op" id="6039539">(</span><span class="ident" id="6039540">id</span><span class="op" id="6039542">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039546">cc</span><span class="op" id="6039548">.</span><span class="ident" id="6039549">lk</span><span class="op" id="6039551">.</span><span class="ident" id="6039552">Lock</span><span class="op" id="6039556">(</span><span class="op" id="6039557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039560">if</span>&nbsp;<span class="ident" id="6039563">cc</span><span class="op" id="6039565">.</span><span class="ident" id="6039566">re</span>&nbsp;<span class="op" id="6039569">!=</span>&nbsp;<span class="ident" id="6039572">nil</span>&nbsp;<span class="op" id="6039576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039580">defer</span>&nbsp;<span class="ident" id="6039586">cc</span><span class="op" id="6039588">.</span><span class="ident" id="6039589">lk</span><span class="op" id="6039591">.</span><span class="ident" id="6039592">Unlock</span><span class="op" id="6039598">(</span><span class="op" id="6039599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039603">return</span>&nbsp;<span class="ident" id="6039610">nil</span><span class="op" id="6039613">,</span>&nbsp;<span class="ident" id="6039615">cc</span><span class="op" id="6039617">.</span><span class="ident" id="6039618">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039625">if</span>&nbsp;<span class="ident" id="6039628">cc</span><span class="op" id="6039630">.</span><span class="ident" id="6039631">r</span>&nbsp;<span class="op" id="6039633">==</span>&nbsp;<span class="ident" id="6039636">nil</span>&nbsp;<span class="op" id="6039640">{</span>&nbsp;<span class="comment" id="6039642">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039689">defer</span>&nbsp;<span class="ident" id="6039695">cc</span><span class="op" id="6039697">.</span><span class="ident" id="6039698">lk</span><span class="op" id="6039700">.</span><span class="ident" id="6039701">Unlock</span><span class="op" id="6039707">(</span><span class="op" id="6039708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039712">return</span>&nbsp;<span class="ident" id="6039719">nil</span><span class="op" id="6039722">,</span>&nbsp;<span class="ident" id="6039724">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039735">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039738">r</span>&nbsp;<span class="op" id="6039740">:=</span>&nbsp;<span class="ident" id="6039743">cc</span><span class="op" id="6039745">.</span><span class="ident" id="6039746">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039749">lastbody</span>&nbsp;<span class="op" id="6039758">:=</span>&nbsp;<span class="ident" id="6039761">cc</span><span class="op" id="6039763">.</span><span class="ident" id="6039764">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039774">cc</span><span class="op" id="6039776">.</span><span class="ident" id="6039777">lastbody</span>&nbsp;<span class="op" id="6039786">=</span>&nbsp;<span class="ident" id="6039788">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039793">cc</span><span class="op" id="6039795">.</span><span class="ident" id="6039796">lk</span><span class="op" id="6039798">.</span><span class="ident" id="6039799">Unlock</span><span class="op" id="6039805">(</span><span class="op" id="6039806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039810">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039886">if</span>&nbsp;<span class="ident" id="6039889">lastbody</span>&nbsp;<span class="op" id="6039898">!=</span>&nbsp;<span class="ident" id="6039901">nil</span>&nbsp;<span class="op" id="6039905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039909">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039975">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6040033">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040048">err</span>&nbsp;<span class="op" id="6040052">=</span>&nbsp;<span class="ident" id="6040054">lastbody</span><span class="op" id="6040062">.</span><span class="ident" id="6040063">Close</span><span class="op" id="6040068">(</span><span class="op" id="6040069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040073">if</span>&nbsp;<span class="ident" id="6040076">err</span>&nbsp;<span class="op" id="6040080">!=</span>&nbsp;<span class="ident" id="6040083">nil</span>&nbsp;<span class="op" id="6040087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040092">cc</span><span class="op" id="6040094">.</span><span class="ident" id="6040095">lk</span><span class="op" id="6040097">.</span><span class="ident" id="6040098">Lock</span><span class="op" id="6040102">(</span><span class="op" id="6040103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040108">defer</span>&nbsp;<span class="ident" id="6040114">cc</span><span class="op" id="6040116">.</span><span class="ident" id="6040117">lk</span><span class="op" id="6040119">.</span><span class="ident" id="6040120">Unlock</span><span class="op" id="6040126">(</span><span class="op" id="6040127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040132">cc</span><span class="op" id="6040134">.</span><span class="ident" id="6040135">re</span>&nbsp;<span class="op" id="6040138">=</span>&nbsp;<span class="ident" id="6040140">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040147">return</span>&nbsp;<span class="ident" id="6040154">nil</span><span class="op" id="6040157">,</span>&nbsp;<span class="ident" id="6040159">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040172">resp</span><span class="op" id="6040176">,</span>&nbsp;<span class="ident" id="6040178">err</span>&nbsp;<span class="op" id="6040182">=</span>&nbsp;<span class="ident" id="6040184">http</span><span class="op" id="6040188">.</span><span class="ident" id="6040189">ReadResponse</span><span class="op" id="6040201">(</span><span class="ident" id="6040202">r</span><span class="op" id="6040203">,</span>&nbsp;<span class="ident" id="6040205">req</span><span class="op" id="6040208">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040211">cc</span><span class="op" id="6040213">.</span><span class="ident" id="6040214">lk</span><span class="op" id="6040216">.</span><span class="ident" id="6040217">Lock</span><span class="op" id="6040221">(</span><span class="op" id="6040222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040225">defer</span>&nbsp;<span class="ident" id="6040231">cc</span><span class="op" id="6040233">.</span><span class="ident" id="6040234">lk</span><span class="op" id="6040236">.</span><span class="ident" id="6040237">Unlock</span><span class="op" id="6040243">(</span><span class="op" id="6040244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040247">if</span>&nbsp;<span class="ident" id="6040250">err</span>&nbsp;<span class="op" id="6040254">!=</span>&nbsp;<span class="ident" id="6040257">nil</span>&nbsp;<span class="op" id="6040261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040265">cc</span><span class="op" id="6040267">.</span><span class="ident" id="6040268">re</span>&nbsp;<span class="op" id="6040271">=</span>&nbsp;<span class="ident" id="6040273">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040279">return</span>&nbsp;<span class="ident" id="6040286">resp</span><span class="op" id="6040290">,</span>&nbsp;<span class="ident" id="6040292">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040300">cc</span><span class="op" id="6040302">.</span><span class="ident" id="6040303">lastbody</span>&nbsp;<span class="op" id="6040312">=</span>&nbsp;<span class="ident" id="6040314">resp</span><span class="op" id="6040318">.</span><span class="ident" id="6040319">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040326">cc</span><span class="op" id="6040328">.</span><span class="ident" id="6040329">nread</span><span class="op" id="6040334">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040339">if</span>&nbsp;<span class="ident" id="6040342">resp</span><span class="op" id="6040346">.</span><span class="ident" id="6040347">Close</span>&nbsp;<span class="op" id="6040353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040357">cc</span><span class="op" id="6040359">.</span><span class="ident" id="6040360">re</span>&nbsp;<span class="op" id="6040363">=</span>&nbsp;<span class="ident" id="6040365">ErrPersistEOF</span>&nbsp;<span class="comment" id="6040379">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040413">return</span>&nbsp;<span class="ident" id="6040420">resp</span><span class="op" id="6040424">,</span>&nbsp;<span class="ident" id="6040426">cc</span><span class="op" id="6040428">.</span><span class="ident" id="6040429">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040436">return</span>&nbsp;<span class="ident" id="6040443">resp</span><span class="op" id="6040447">,</span>&nbsp;<span class="ident" id="6040449">err</span><br>
<span class="lineno">420</span><span class="op" id="6040453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6040456">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6040528">func</span>&nbsp;<span class="op" id="6040533">(</span><span class="ident" id="6040534">cc</span>&nbsp;<span class="op" id="6040537">*</span><span class="ident" id="6040538">ClientConn</span><span class="op" id="6040548">)</span>&nbsp;<span class="ident" id="6040550">Do</span><span class="op" id="6040552">(</span><span class="ident" id="6040553">req</span>&nbsp;<span class="op" id="6040557">*</span><span class="ident" id="6040558">http</span><span class="op" id="6040562">.</span><span class="ident" id="6040563">Request</span><span class="op" id="6040570">)</span>&nbsp;<span class="op" id="6040572">(</span><span class="ident" id="6040573">resp</span>&nbsp;<span class="op" id="6040578">*</span><span class="ident" id="6040579">http</span><span class="op" id="6040583">.</span><span class="ident" id="6040584">Response</span><span class="op" id="6040592">,</span>&nbsp;<span class="ident" id="6040594">err</span>&nbsp;<span class="builtintype" id="6040598">error</span><span class="op" id="6040603">)</span>&nbsp;<span class="op" id="6040605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040608">err</span>&nbsp;<span class="op" id="6040612">=</span>&nbsp;<span class="ident" id="6040614">cc</span><span class="op" id="6040616">.</span><span class="ident" id="6040617">Write</span><span class="op" id="6040622">(</span><span class="ident" id="6040623">req</span><span class="op" id="6040626">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040629">if</span>&nbsp;<span class="ident" id="6040632">err</span>&nbsp;<span class="op" id="6040636">!=</span>&nbsp;<span class="ident" id="6040639">nil</span>&nbsp;<span class="op" id="6040643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040647">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040658">return</span>&nbsp;<span class="ident" id="6040665">cc</span><span class="op" id="6040667">.</span><span class="ident" id="6040668">Read</span><span class="op" id="6040672">(</span><span class="ident" id="6040673">req</span><span class="op" id="6040676">)</span><br>
<span class="lineno"></span><span class="op" id="6040678">}</span>
</div>
</body>
</html>
