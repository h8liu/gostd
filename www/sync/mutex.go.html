<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1836359">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1836414">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1836468">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1836519">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1836592">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1836672">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1836747">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1836794">//</span><br>
<span class="lineno">10</span><span class="comment" id="1836797">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1836874">package</span>&nbsp;<span class="ident" id="1836882">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1836888">import</span>&nbsp;<span class="op" id="1836895">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1836898">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1836913">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1836922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1836925">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1836964">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1837019">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1837071">type</span>&nbsp;<span class="ident" id="1837076">Mutex</span>&nbsp;<span class="keyword" id="1837082">struct</span>&nbsp;<span class="op" id="1837089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837092">state</span>&nbsp;<span class="builtintype" id="1837098">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837105">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1837111">uint32</span><br>
<span class="lineno"></span><span class="op" id="1837118">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1837121">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1837187">type</span>&nbsp;<span class="ident" id="1837192">Locker</span>&nbsp;<span class="keyword" id="1837199">interface</span>&nbsp;<span class="op" id="1837209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837212">Lock</span><span class="op" id="1837216">(</span><span class="op" id="1837217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837220">Unlock</span><span class="op" id="1837226">(</span><span class="op" id="1837227">)</span><br>
<span class="lineno">30</span><span class="op" id="1837229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1837232">const</span>&nbsp;<span class="op" id="1837238">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837241">mutexLocked</span>&nbsp;<span class="op" id="1837253">=</span>&nbsp;<span class="num" id="1837255">1</span>&nbsp;<span class="op" id="1837257">&lt;&lt;</span>&nbsp;<span class="ident" id="1837260">iota</span>&nbsp;<span class="comment" id="1837265">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837285">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837297">mutexWaiterShift</span>&nbsp;<span class="op" id="1837314">=</span>&nbsp;<span class="ident" id="1837316">iota</span><br>
<span class="lineno"></span><span class="op" id="1837321">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1837324">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1837341">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1837397">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1837437">func</span>&nbsp;<span class="op" id="1837442">(</span><span class="ident" id="1837443">m</span>&nbsp;<span class="op" id="1837445">*</span><span class="ident" id="1837446"><a href="/sync/mutex.go.html#1837076">Mutex</a></span><span class="op" id="1837451">)</span>&nbsp;<span class="ident" id="1837453">Lock</span><span class="op" id="1837457">(</span><span class="op" id="1837458">)</span>&nbsp;<span class="op" id="1837460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1837463">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837499">if</span>&nbsp;<span class="ident" id="1837502"><a href="/sync/mutex.go.html#1836898">atomic</a></span><span class="op" id="1837508">.</span><span class="ident" id="1837509">CompareAndSwapInt32</span><span class="op" id="1837528">(</span><span class="op" id="1837529">&amp;</span><span class="ident" id="1837530"><a href="/sync/mutex.go.html#1837443">m</a></span><span class="op" id="1837531">.</span><span class="ident" id="1837532">state</span><span class="op" id="1837537">,</span>&nbsp;<span class="num" id="1837539">0</span><span class="op" id="1837540">,</span>&nbsp;<span class="ident" id="1837542"><a href="/sync/mutex.go.html#1837241">mutexLocked</a></span><span class="op" id="1837553">)</span>&nbsp;<span class="op" id="1837555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837559">if</span>&nbsp;<span class="ident" id="1837562"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1837574">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837579"><a href="/sync/race0.go.html#1847187">raceAcquire</a></span><span class="op" id="1837590">(</span><span class="ident" id="1837591"><a href="/sync/mutex.go.html#1836913">unsafe</a></span><span class="op" id="1837597">.</span><span class="ident" id="1837598">Pointer</span><span class="op" id="1837605">(</span><span class="ident" id="1837606"><a href="/sync/mutex.go.html#1837443">m</a></span><span class="op" id="1837607">)</span><span class="op" id="1837608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1837612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837616">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1837624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837628">awoke</span>&nbsp;<span class="op" id="1837634">:=</span>&nbsp;<span class="builtintype" id="1837637">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837644">for</span>&nbsp;<span class="op" id="1837648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837652">old</span>&nbsp;<span class="op" id="1837656">:=</span>&nbsp;<span class="ident" id="1837659"><a href="/sync/mutex.go.html#1837443">m</a></span><span class="op" id="1837660">.</span><span class="ident" id="1837661">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1837669">new</span>&nbsp;<span class="op" id="1837673">:=</span>&nbsp;<span class="ident" id="1837676"><a href="/sync/mutex.go.html#1837652">old</a></span>&nbsp;<span class="op" id="1837680">|</span>&nbsp;<span class="ident" id="1837682"><a href="/sync/mutex.go.html#1837241">mutexLocked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837696">if</span>&nbsp;<span class="ident" id="1837699"><a href="/sync/mutex.go.html#1837652">old</a></span><span class="op" id="1837702">&amp;</span><span class="ident" id="1837703"><a href="/sync/mutex.go.html#1837241">mutexLocked</a></span>&nbsp;<span class="op" id="1837715">!=</span>&nbsp;<span class="num" id="1837718">0</span>&nbsp;<span class="op" id="1837720">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1837725"><a href="/sync/mutex.go.html#1837669">new</a></span>&nbsp;<span class="op" id="1837729">=</span>&nbsp;<span class="ident" id="1837731"><a href="/sync/mutex.go.html#1837652">old</a></span>&nbsp;<span class="op" id="1837735">+</span>&nbsp;<span class="num" id="1837737">1</span><span class="op" id="1837738">&lt;&lt;</span><span class="ident" id="1837740"><a href="/sync/mutex.go.html#1837297">mutexWaiterShift</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1837759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837763">if</span>&nbsp;<span class="ident" id="1837766"><a href="/sync/mutex.go.html#1837628">awoke</a></span>&nbsp;<span class="op" id="1837772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1837777">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1837824">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1837875"><a href="/sync/mutex.go.html#1837669">new</a></span>&nbsp;<span class="op" id="1837879">&amp;^=</span>&nbsp;<span class="ident" id="1837883"><a href="/sync/mutex.go.html#1837285">mutexWoken</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1837896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837900">if</span>&nbsp;<span class="ident" id="1837903"><a href="/sync/mutex.go.html#1836898">atomic</a></span><span class="op" id="1837909">.</span><span class="ident" id="1837910">CompareAndSwapInt32</span><span class="op" id="1837929">(</span><span class="op" id="1837930">&amp;</span><span class="ident" id="1837931"><a href="/sync/mutex.go.html#1837443">m</a></span><span class="op" id="1837932">.</span><span class="ident" id="1837933">state</span><span class="op" id="1837938">,</span>&nbsp;<span class="ident" id="1837940"><a href="/sync/mutex.go.html#1837652">old</a></span><span class="op" id="1837943">,</span>&nbsp;<span class="builtinfunc" id="1837945"><a href="/sync/mutex.go.html#1837669">new</a></span><span class="op" id="1837948">)</span>&nbsp;<span class="op" id="1837950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837955">if</span>&nbsp;<span class="ident" id="1837958"><a href="/sync/mutex.go.html#1837652">old</a></span><span class="op" id="1837961">&amp;</span><span class="ident" id="1837962"><a href="/sync/mutex.go.html#1837241">mutexLocked</a></span>&nbsp;<span class="op" id="1837974">==</span>&nbsp;<span class="num" id="1837977">0</span>&nbsp;<span class="op" id="1837979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837985">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1837994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837999"><a href="/sync/runtime.go.html#1847861">runtime_Semacquire</a></span><span class="op" id="1838017">(</span><span class="op" id="1838018">&amp;</span><span class="ident" id="1838019"><a href="/sync/mutex.go.html#1837443">m</a></span><span class="op" id="1838020">.</span><span class="ident" id="1838021">sema</span><span class="op" id="1838025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838030"><a href="/sync/mutex.go.html#1837628">awoke</a></span>&nbsp;<span class="op" id="1838036">=</span>&nbsp;<span class="builtintype" id="1838038">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838048">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838052">if</span>&nbsp;<span class="ident" id="1838055"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1838067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838071"><a href="/sync/race0.go.html#1847187">raceAcquire</a></span><span class="op" id="1838082">(</span><span class="ident" id="1838083"><a href="/sync/mutex.go.html#1836913">unsafe</a></span><span class="op" id="1838089">.</span><span class="ident" id="1838090">Pointer</span><span class="op" id="1838097">(</span><span class="ident" id="1838098"><a href="/sync/mutex.go.html#1837443">m</a></span><span class="op" id="1838099">)</span><span class="op" id="1838100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838103">}</span><br>
<span class="lineno"></span><span class="op" id="1838105">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1838108">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1838129">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1838194">//</span><br>
<span class="lineno"></span><span class="comment" id="1838197">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1838262">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1838322">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1838369">func</span>&nbsp;<span class="op" id="1838374">(</span><span class="ident" id="1838375">m</span>&nbsp;<span class="op" id="1838377">*</span><span class="ident" id="1838378"><a href="/sync/mutex.go.html#1837076">Mutex</a></span><span class="op" id="1838383">)</span>&nbsp;<span class="ident" id="1838385">Unlock</span><span class="op" id="1838391">(</span><span class="op" id="1838392">)</span>&nbsp;<span class="op" id="1838394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838397">if</span>&nbsp;<span class="ident" id="1838400"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1838412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838416">_</span>&nbsp;<span class="op" id="1838418">=</span>&nbsp;<span class="ident" id="1838420"><a href="/sync/mutex.go.html#1838375">m</a></span><span class="op" id="1838421">.</span><span class="ident" id="1838422">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838430"><a href="/sync/race0.go.html#1847230">raceRelease</a></span><span class="op" id="1838441">(</span><span class="ident" id="1838442"><a href="/sync/mutex.go.html#1836913">unsafe</a></span><span class="op" id="1838448">.</span><span class="ident" id="1838449">Pointer</span><span class="op" id="1838456">(</span><span class="ident" id="1838457"><a href="/sync/mutex.go.html#1838375">m</a></span><span class="op" id="1838458">)</span><span class="op" id="1838459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1838466">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1838496">new</span>&nbsp;<span class="op" id="1838500">:=</span>&nbsp;<span class="ident" id="1838503"><a href="/sync/mutex.go.html#1836898">atomic</a></span><span class="op" id="1838509">.</span><span class="ident" id="1838510">AddInt32</span><span class="op" id="1838518">(</span><span class="op" id="1838519">&amp;</span><span class="ident" id="1838520"><a href="/sync/mutex.go.html#1838375">m</a></span><span class="op" id="1838521">.</span><span class="ident" id="1838522">state</span><span class="op" id="1838527">,</span>&nbsp;<span class="op" id="1838529">-</span><span class="ident" id="1838530"><a href="/sync/mutex.go.html#1837241">mutexLocked</a></span><span class="op" id="1838541">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838544">if</span>&nbsp;<span class="op" id="1838547">(</span><span class="builtinfunc" id="1838548"><a href="/sync/mutex.go.html#1838496">new</a></span><span class="op" id="1838551">+</span><span class="ident" id="1838552"><a href="/sync/mutex.go.html#1837241">mutexLocked</a></span><span class="op" id="1838563">)</span><span class="op" id="1838564">&amp;</span><span class="ident" id="1838565"><a href="/sync/mutex.go.html#1837241">mutexLocked</a></span>&nbsp;<span class="op" id="1838577">==</span>&nbsp;<span class="num" id="1838580">0</span>&nbsp;<span class="op" id="1838582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1838586">panic</span><span class="op" id="1838591">(</span><span class="string" id="1838592">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1838624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838631">old</span>&nbsp;<span class="op" id="1838635">:=</span>&nbsp;<span class="builtinfunc" id="1838638"><a href="/sync/mutex.go.html#1838496">new</a></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838643">for</span>&nbsp;<span class="op" id="1838647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1838651">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1838707">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838768">if</span>&nbsp;<span class="ident" id="1838771"><a href="/sync/mutex.go.html#1838631">old</a></span><span class="op" id="1838774">&gt;&gt;</span><span class="ident" id="1838776"><a href="/sync/mutex.go.html#1837297">mutexWaiterShift</a></span>&nbsp;<span class="op" id="1838793">==</span>&nbsp;<span class="num" id="1838796">0</span>&nbsp;<span class="op" id="1838798">||</span>&nbsp;<span class="ident" id="1838801"><a href="/sync/mutex.go.html#1838631">old</a></span><span class="op" id="1838804">&amp;</span><span class="op" id="1838805">(</span><span class="ident" id="1838806"><a href="/sync/mutex.go.html#1837241">mutexLocked</a></span><span class="op" id="1838817">|</span><span class="ident" id="1838818"><a href="/sync/mutex.go.html#1837285">mutexWoken</a></span><span class="op" id="1838828">)</span>&nbsp;<span class="op" id="1838830">!=</span>&nbsp;<span class="num" id="1838833">0</span>&nbsp;<span class="op" id="1838835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838840">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1838853">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1838890"><a href="/sync/mutex.go.html#1838496">new</a></span>&nbsp;<span class="op" id="1838894">=</span>&nbsp;<span class="op" id="1838896">(</span><span class="ident" id="1838897"><a href="/sync/mutex.go.html#1838631">old</a></span>&nbsp;<span class="op" id="1838901">-</span>&nbsp;<span class="num" id="1838903">1</span><span class="op" id="1838904">&lt;&lt;</span><span class="ident" id="1838906"><a href="/sync/mutex.go.html#1837297">mutexWaiterShift</a></span><span class="op" id="1838922">)</span>&nbsp;<span class="op" id="1838924">|</span>&nbsp;<span class="ident" id="1838926"><a href="/sync/mutex.go.html#1837285">mutexWoken</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838939">if</span>&nbsp;<span class="ident" id="1838942"><a href="/sync/mutex.go.html#1836898">atomic</a></span><span class="op" id="1838948">.</span><span class="ident" id="1838949">CompareAndSwapInt32</span><span class="op" id="1838968">(</span><span class="op" id="1838969">&amp;</span><span class="ident" id="1838970"><a href="/sync/mutex.go.html#1838375">m</a></span><span class="op" id="1838971">.</span><span class="ident" id="1838972">state</span><span class="op" id="1838977">,</span>&nbsp;<span class="ident" id="1838979"><a href="/sync/mutex.go.html#1838631">old</a></span><span class="op" id="1838982">,</span>&nbsp;<span class="builtinfunc" id="1838984"><a href="/sync/mutex.go.html#1838496">new</a></span><span class="op" id="1838987">)</span>&nbsp;<span class="op" id="1838989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838994"><a href="/sync/runtime.go.html#1848127">runtime_Semrelease</a></span><span class="op" id="1839012">(</span><span class="op" id="1839013">&amp;</span><span class="ident" id="1839014"><a href="/sync/mutex.go.html#1838375">m</a></span><span class="op" id="1839015">.</span><span class="ident" id="1839016">sema</span><span class="op" id="1839020">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1839025">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1839034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1839038"><a href="/sync/mutex.go.html#1838631">old</a></span>&nbsp;<span class="op" id="1839042">=</span>&nbsp;<span class="ident" id="1839044"><a href="/sync/mutex.go.html#1838375">m</a></span><span class="op" id="1839045">.</span><span class="ident" id="1839046">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1839053">}</span><br>
<span class="lineno"></span><span class="op" id="1839055">}</span>
</div>
</body>
</html>
