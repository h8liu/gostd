<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html" class="current">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6993368">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6993423">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6993477">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6993528">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6993593">package</span>&nbsp;<span class="ident" id="6993601">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6993609">import</span>&nbsp;<span class="op" id="6993616">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993619">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993627">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993640">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993646">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993657">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993668">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993679">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993690">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6993701">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6993708">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6993711">func</span>&nbsp;<span class="ident" id="6993716">waitSig</span><span class="op" id="6993723">(</span><span class="ident" id="6993724">t</span>&nbsp;<span class="op" id="6993726">*</span><span class="ident" id="6993727">testing</span><span class="op" id="6993734">.</span><span class="ident" id="6993735">T</span><span class="op" id="6993736">,</span>&nbsp;<span class="ident" id="6993738">c</span>&nbsp;<span class="op" id="6993740">&lt;-</span><span class="keyword" id="6993742">chan</span>&nbsp;<span class="ident" id="6993747">os</span><span class="op" id="6993749">.</span><span class="ident" id="6993750">Signal</span><span class="op" id="6993756">,</span>&nbsp;<span class="ident" id="6993758">sig</span>&nbsp;<span class="ident" id="6993762">os</span><span class="op" id="6993764">.</span><span class="ident" id="6993765">Signal</span><span class="op" id="6993771">)</span>&nbsp;<span class="op" id="6993773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6993776">select</span>&nbsp;<span class="op" id="6993783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6993786">case</span>&nbsp;<span class="ident" id="6993791">s</span>&nbsp;<span class="op" id="6993793">:=</span>&nbsp;<span class="op" id="6993796">&lt;-</span><span class="ident" id="6993798">c</span><span class="op" id="6993799">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6993803">if</span>&nbsp;<span class="ident" id="6993806">s</span>&nbsp;<span class="op" id="6993808">!=</span>&nbsp;<span class="ident" id="6993811">sig</span>&nbsp;<span class="op" id="6993815">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6993820">t</span><span class="op" id="6993821">.</span><span class="ident" id="6993822">Fatalf</span><span class="op" id="6993828">(</span><span class="string" id="6993829">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6993853">,</span>&nbsp;<span class="ident" id="6993855">s</span><span class="op" id="6993856">,</span>&nbsp;<span class="ident" id="6993858">sig</span><span class="op" id="6993861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6993865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6993868">case</span>&nbsp;<span class="op" id="6993873">&lt;-</span><span class="ident" id="6993875">time</span><span class="op" id="6993879">.</span><span class="ident" id="6993880">After</span><span class="op" id="6993885">(</span><span class="num" id="6993886">1</span>&nbsp;<span class="op" id="6993888">*</span>&nbsp;<span class="ident" id="6993890">time</span><span class="op" id="6993894">.</span><span class="ident" id="6993895">Second</span><span class="op" id="6993901">)</span><span class="op" id="6993902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6993906">t</span><span class="op" id="6993907">.</span><span class="ident" id="6993908">Fatalf</span><span class="op" id="6993914">(</span><span class="string" id="6993915">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="6993939">,</span>&nbsp;<span class="ident" id="6993941">sig</span><span class="op" id="6993944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6993947">}</span><br>
<span class="lineno">30</span><span class="op" id="6993949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6993952">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="6993994">func</span>&nbsp;<span class="ident" id="6993999">TestSignal</span><span class="op" id="6994009">(</span><span class="ident" id="6994010">t</span>&nbsp;<span class="op" id="6994012">*</span><span class="ident" id="6994013">testing</span><span class="op" id="6994020">.</span><span class="ident" id="6994021">T</span><span class="op" id="6994022">)</span>&nbsp;<span class="op" id="6994024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6994027">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994046">c</span>&nbsp;<span class="op" id="6994048">:=</span>&nbsp;<span class="builtinfunc" id="6994051">make</span><span class="op" id="6994055">(</span><span class="keyword" id="6994056">chan</span>&nbsp;<span class="ident" id="6994061">os</span><span class="op" id="6994063">.</span><span class="ident" id="6994064">Signal</span><span class="op" id="6994070">,</span>&nbsp;<span class="num" id="6994072">1</span><span class="op" id="6994073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994076">Notify</span><span class="op" id="6994082">(</span><span class="ident" id="6994083">c</span><span class="op" id="6994084">,</span>&nbsp;<span class="ident" id="6994086">syscall</span><span class="op" id="6994093">.</span><span class="ident" id="6994094">SIGHUP</span><span class="op" id="6994100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6994103">defer</span>&nbsp;<span class="ident" id="6994109">Stop</span><span class="op" id="6994113">(</span><span class="ident" id="6994114">c</span><span class="op" id="6994115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6994119">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994150">t</span><span class="op" id="6994151">.</span><span class="ident" id="6994152">Logf</span><span class="op" id="6994156">(</span><span class="string" id="6994157">&#34;sighup...&#34;</span><span class="op" id="6994168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994171">syscall</span><span class="op" id="6994178">.</span><span class="ident" id="6994179">Kill</span><span class="op" id="6994183">(</span><span class="ident" id="6994184">syscall</span><span class="op" id="6994191">.</span><span class="ident" id="6994192">Getpid</span><span class="op" id="6994198">(</span><span class="op" id="6994199">)</span><span class="op" id="6994200">,</span>&nbsp;<span class="ident" id="6994202">syscall</span><span class="op" id="6994209">.</span><span class="ident" id="6994210">SIGHUP</span><span class="op" id="6994216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994219">waitSig</span><span class="op" id="6994226">(</span><span class="ident" id="6994227">t</span><span class="op" id="6994228">,</span>&nbsp;<span class="ident" id="6994230">c</span><span class="op" id="6994231">,</span>&nbsp;<span class="ident" id="6994233">syscall</span><span class="op" id="6994240">.</span><span class="ident" id="6994241">SIGHUP</span><span class="op" id="6994247">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6994251">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994286">c1</span>&nbsp;<span class="op" id="6994289">:=</span>&nbsp;<span class="builtinfunc" id="6994292">make</span><span class="op" id="6994296">(</span><span class="keyword" id="6994297">chan</span>&nbsp;<span class="ident" id="6994302">os</span><span class="op" id="6994304">.</span><span class="ident" id="6994305">Signal</span><span class="op" id="6994311">,</span>&nbsp;<span class="num" id="6994313">1</span><span class="op" id="6994314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994317">Notify</span><span class="op" id="6994323">(</span><span class="ident" id="6994324">c1</span><span class="op" id="6994326">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6994330">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994363">t</span><span class="op" id="6994364">.</span><span class="ident" id="6994365">Logf</span><span class="op" id="6994369">(</span><span class="string" id="6994370">&#34;sigwinch...&#34;</span><span class="op" id="6994383">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994386">syscall</span><span class="op" id="6994393">.</span><span class="ident" id="6994394">Kill</span><span class="op" id="6994398">(</span><span class="ident" id="6994399">syscall</span><span class="op" id="6994406">.</span><span class="ident" id="6994407">Getpid</span><span class="op" id="6994413">(</span><span class="op" id="6994414">)</span><span class="op" id="6994415">,</span>&nbsp;<span class="ident" id="6994417">syscall</span><span class="op" id="6994424">.</span><span class="ident" id="6994425">SIGWINCH</span><span class="op" id="6994433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994436">waitSig</span><span class="op" id="6994443">(</span><span class="ident" id="6994444">t</span><span class="op" id="6994445">,</span>&nbsp;<span class="ident" id="6994447">c1</span><span class="op" id="6994449">,</span>&nbsp;<span class="ident" id="6994451">syscall</span><span class="op" id="6994458">.</span><span class="ident" id="6994459">SIGWINCH</span><span class="op" id="6994467">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6994471">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6994516">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6994566">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994604">t</span><span class="op" id="6994605">.</span><span class="ident" id="6994606">Logf</span><span class="op" id="6994610">(</span><span class="string" id="6994611">&#34;sighup...&#34;</span><span class="op" id="6994622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994625">syscall</span><span class="op" id="6994632">.</span><span class="ident" id="6994633">Kill</span><span class="op" id="6994637">(</span><span class="ident" id="6994638">syscall</span><span class="op" id="6994645">.</span><span class="ident" id="6994646">Getpid</span><span class="op" id="6994652">(</span><span class="op" id="6994653">)</span><span class="op" id="6994654">,</span>&nbsp;<span class="ident" id="6994656">syscall</span><span class="op" id="6994663">.</span><span class="ident" id="6994664">SIGHUP</span><span class="op" id="6994670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994673">waitSig</span><span class="op" id="6994680">(</span><span class="ident" id="6994681">t</span><span class="op" id="6994682">,</span>&nbsp;<span class="ident" id="6994684">c1</span><span class="op" id="6994686">,</span>&nbsp;<span class="ident" id="6994688">syscall</span><span class="op" id="6994695">.</span><span class="ident" id="6994696">SIGHUP</span><span class="op" id="6994702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994705">t</span><span class="op" id="6994706">.</span><span class="ident" id="6994707">Logf</span><span class="op" id="6994711">(</span><span class="string" id="6994712">&#34;sighup...&#34;</span><span class="op" id="6994723">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994726">syscall</span><span class="op" id="6994733">.</span><span class="ident" id="6994734">Kill</span><span class="op" id="6994738">(</span><span class="ident" id="6994739">syscall</span><span class="op" id="6994746">.</span><span class="ident" id="6994747">Getpid</span><span class="op" id="6994753">(</span><span class="op" id="6994754">)</span><span class="op" id="6994755">,</span>&nbsp;<span class="ident" id="6994757">syscall</span><span class="op" id="6994764">.</span><span class="ident" id="6994765">SIGHUP</span><span class="op" id="6994771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994774">waitSig</span><span class="op" id="6994781">(</span><span class="ident" id="6994782">t</span><span class="op" id="6994783">,</span>&nbsp;<span class="ident" id="6994785">c1</span><span class="op" id="6994787">,</span>&nbsp;<span class="ident" id="6994789">syscall</span><span class="op" id="6994796">.</span><span class="ident" id="6994797">SIGHUP</span><span class="op" id="6994803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6994807">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994859">waitSig</span><span class="op" id="6994866">(</span><span class="ident" id="6994867">t</span><span class="op" id="6994868">,</span>&nbsp;<span class="ident" id="6994870">c</span><span class="op" id="6994871">,</span>&nbsp;<span class="ident" id="6994873">syscall</span><span class="op" id="6994880">.</span><span class="ident" id="6994881">SIGHUP</span><span class="op" id="6994887">)</span><br>
<span class="lineno">65</span><span class="op" id="6994889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6994892">func</span>&nbsp;<span class="ident" id="6994897">TestStress</span><span class="op" id="6994907">(</span><span class="ident" id="6994908">t</span>&nbsp;<span class="op" id="6994910">*</span><span class="ident" id="6994911">testing</span><span class="op" id="6994918">.</span><span class="ident" id="6994919">T</span><span class="op" id="6994920">)</span>&nbsp;<span class="op" id="6994922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994925">dur</span>&nbsp;<span class="op" id="6994929">:=</span>&nbsp;<span class="num" id="6994932">3</span>&nbsp;<span class="op" id="6994934">*</span>&nbsp;<span class="ident" id="6994936">time</span><span class="op" id="6994940">.</span><span class="ident" id="6994941">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6994949">if</span>&nbsp;<span class="ident" id="6994952">testing</span><span class="op" id="6994959">.</span><span class="ident" id="6994960">Short</span><span class="op" id="6994965">(</span><span class="op" id="6994966">)</span>&nbsp;<span class="op" id="6994968">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6994972">dur</span>&nbsp;<span class="op" id="6994976">=</span>&nbsp;<span class="num" id="6994978">100</span>&nbsp;<span class="op" id="6994982">*</span>&nbsp;<span class="ident" id="6994984">time</span><span class="op" id="6994988">.</span><span class="ident" id="6994989">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995005">defer</span>&nbsp;<span class="ident" id="6995011">runtime</span><span class="op" id="6995018">.</span><span class="ident" id="6995019">GOMAXPROCS</span><span class="op" id="6995029">(</span><span class="ident" id="6995030">runtime</span><span class="op" id="6995037">.</span><span class="ident" id="6995038">GOMAXPROCS</span><span class="op" id="6995048">(</span><span class="num" id="6995049">4</span><span class="op" id="6995050">)</span><span class="op" id="6995051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995054">done</span>&nbsp;<span class="op" id="6995059">:=</span>&nbsp;<span class="builtinfunc" id="6995062">make</span><span class="op" id="6995066">(</span><span class="keyword" id="6995067">chan</span>&nbsp;<span class="builtintype" id="6995072">bool</span><span class="op" id="6995076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995079">finished</span>&nbsp;<span class="op" id="6995088">:=</span>&nbsp;<span class="builtinfunc" id="6995091">make</span><span class="op" id="6995095">(</span><span class="keyword" id="6995096">chan</span>&nbsp;<span class="builtintype" id="6995101">bool</span><span class="op" id="6995105">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995108">go</span>&nbsp;<span class="keyword" id="6995111">func</span><span class="op" id="6995115">(</span><span class="op" id="6995116">)</span>&nbsp;<span class="op" id="6995118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995122">sig</span>&nbsp;<span class="op" id="6995126">:=</span>&nbsp;<span class="builtinfunc" id="6995129">make</span><span class="op" id="6995133">(</span><span class="keyword" id="6995134">chan</span>&nbsp;<span class="ident" id="6995139">os</span><span class="op" id="6995141">.</span><span class="ident" id="6995142">Signal</span><span class="op" id="6995148">,</span>&nbsp;<span class="num" id="6995150">1</span><span class="op" id="6995151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995155">Notify</span><span class="op" id="6995161">(</span><span class="ident" id="6995162">sig</span><span class="op" id="6995165">,</span>&nbsp;<span class="ident" id="6995167">syscall</span><span class="op" id="6995174">.</span><span class="ident" id="6995175">SIGUSR1</span><span class="op" id="6995182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995186">defer</span>&nbsp;<span class="ident" id="6995192">Stop</span><span class="op" id="6995196">(</span><span class="ident" id="6995197">sig</span><span class="op" id="6995200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995203">Loop</span><span class="op" id="6995207">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995211">for</span>&nbsp;<span class="op" id="6995215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995220">select</span>&nbsp;<span class="op" id="6995227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995232">case</span>&nbsp;<span class="op" id="6995237">&lt;-</span><span class="ident" id="6995239">sig</span><span class="op" id="6995242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995247">case</span>&nbsp;<span class="op" id="6995252">&lt;-</span><span class="ident" id="6995254">done</span><span class="op" id="6995258">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995264">break</span>&nbsp;<span class="ident" id="6995270">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995286">finished</span>&nbsp;<span class="op" id="6995295">&lt;-</span>&nbsp;<span class="builtintype" id="6995298">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995304">}</span><span class="op" id="6995305">(</span><span class="op" id="6995306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995309">go</span>&nbsp;<span class="keyword" id="6995312">func</span><span class="op" id="6995316">(</span><span class="op" id="6995317">)</span>&nbsp;<span class="op" id="6995319">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995322">Loop</span><span class="op" id="6995326">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995330">for</span>&nbsp;<span class="op" id="6995334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995339">select</span>&nbsp;<span class="op" id="6995346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995351">case</span>&nbsp;<span class="op" id="6995356">&lt;-</span><span class="ident" id="6995358">done</span><span class="op" id="6995362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995368">break</span>&nbsp;<span class="ident" id="6995374">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6995382">default</span><span class="op" id="6995389">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995395">syscall</span><span class="op" id="6995402">.</span><span class="ident" id="6995403">Kill</span><span class="op" id="6995407">(</span><span class="ident" id="6995408">syscall</span><span class="op" id="6995415">.</span><span class="ident" id="6995416">Getpid</span><span class="op" id="6995422">(</span><span class="op" id="6995423">)</span><span class="op" id="6995424">,</span>&nbsp;<span class="ident" id="6995426">syscall</span><span class="op" id="6995433">.</span><span class="ident" id="6995434">SIGUSR1</span><span class="op" id="6995441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995447">runtime</span><span class="op" id="6995454">.</span><span class="ident" id="6995455">Gosched</span><span class="op" id="6995462">(</span><span class="op" id="6995463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995472">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995476">finished</span>&nbsp;<span class="op" id="6995485">&lt;-</span>&nbsp;<span class="builtintype" id="6995488">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995494">}</span><span class="op" id="6995495">(</span><span class="op" id="6995496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995499">time</span><span class="op" id="6995503">.</span><span class="ident" id="6995504">Sleep</span><span class="op" id="6995509">(</span><span class="ident" id="6995510">dur</span><span class="op" id="6995513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6995516">close</span><span class="op" id="6995521">(</span><span class="ident" id="6995522">done</span><span class="op" id="6995526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995529">&lt;-</span><span class="ident" id="6995531">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6995541">&lt;-</span><span class="ident" id="6995543">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6995553">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6995624">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6995674">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995738">time</span><span class="op" id="6995742">.</span><span class="ident" id="6995743">Sleep</span><span class="op" id="6995748">(</span><span class="num" id="6995749">10</span>&nbsp;<span class="op" id="6995752">*</span>&nbsp;<span class="ident" id="6995754">time</span><span class="op" id="6995758">.</span><span class="ident" id="6995759">Millisecond</span><span class="op" id="6995770">)</span><br>
<span class="lineno">110</span><span class="op" id="6995772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6995775">var</span>&nbsp;<span class="ident" id="6995779">sendUncaughtSighup</span>&nbsp;<span class="op" id="6995798">=</span>&nbsp;<span class="ident" id="6995800">flag</span><span class="op" id="6995804">.</span><span class="ident" id="6995805">Int</span><span class="op" id="6995808">(</span><span class="string" id="6995809">&#34;send_uncaught_sighup&#34;</span><span class="op" id="6995831">,</span>&nbsp;<span class="num" id="6995833">0</span><span class="op" id="6995834">,</span>&nbsp;<span class="string" id="6995836">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="6995874">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6995877">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="6995932">func</span>&nbsp;<span class="ident" id="6995937">TestStop</span><span class="op" id="6995945">(</span><span class="ident" id="6995946">t</span>&nbsp;<span class="op" id="6995948">*</span><span class="ident" id="6995949">testing</span><span class="op" id="6995956">.</span><span class="ident" id="6995957">T</span><span class="op" id="6995958">)</span>&nbsp;<span class="op" id="6995960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995963">sigs</span>&nbsp;<span class="op" id="6995968">:=</span>&nbsp;<span class="op" id="6995971">[</span><span class="op" id="6995972">]</span><span class="ident" id="6995973">syscall</span><span class="op" id="6995980">.</span><span class="ident" id="6995981">Signal</span><span class="op" id="6995987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6995991">syscall</span><span class="op" id="6995998">.</span><span class="ident" id="6995999">SIGWINCH</span><span class="op" id="6996007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996011">syscall</span><span class="op" id="6996018">.</span><span class="ident" id="6996019">SIGHUP</span><span class="op" id="6996025">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6996028">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996032">for</span>&nbsp;<span class="ident" id="6996036">_</span><span class="op" id="6996037">,</span>&nbsp;<span class="ident" id="6996039">sig</span>&nbsp;<span class="op" id="6996043">:=</span>&nbsp;<span class="keyword" id="6996046">range</span>&nbsp;<span class="ident" id="6996052">sigs</span>&nbsp;<span class="op" id="6996057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996061">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996083">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996128">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996199">if</span>&nbsp;<span class="ident" id="6996202">sig</span>&nbsp;<span class="op" id="6996206">!=</span>&nbsp;<span class="ident" id="6996209">syscall</span><span class="op" id="6996216">.</span><span class="ident" id="6996217">SIGHUP</span>&nbsp;<span class="op" id="6996224">||</span>&nbsp;<span class="op" id="6996227">*</span><span class="ident" id="6996228">sendUncaughtSighup</span>&nbsp;<span class="op" id="6996247">==</span>&nbsp;<span class="num" id="6996250">1</span>&nbsp;<span class="op" id="6996252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996257">syscall</span><span class="op" id="6996264">.</span><span class="ident" id="6996265">Kill</span><span class="op" id="6996269">(</span><span class="ident" id="6996270">syscall</span><span class="op" id="6996277">.</span><span class="ident" id="6996278">Getpid</span><span class="op" id="6996284">(</span><span class="op" id="6996285">)</span><span class="op" id="6996286">,</span>&nbsp;<span class="ident" id="6996288">sig</span><span class="op" id="6996291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6996295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996299">time</span><span class="op" id="6996303">.</span><span class="ident" id="6996304">Sleep</span><span class="op" id="6996309">(</span><span class="num" id="6996310">100</span>&nbsp;<span class="op" id="6996314">*</span>&nbsp;<span class="ident" id="6996316">time</span><span class="op" id="6996320">.</span><span class="ident" id="6996321">Millisecond</span><span class="op" id="6996332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996337">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996357">c</span>&nbsp;<span class="op" id="6996359">:=</span>&nbsp;<span class="builtinfunc" id="6996362">make</span><span class="op" id="6996366">(</span><span class="keyword" id="6996367">chan</span>&nbsp;<span class="ident" id="6996372">os</span><span class="op" id="6996374">.</span><span class="ident" id="6996375">Signal</span><span class="op" id="6996381">,</span>&nbsp;<span class="num" id="6996383">1</span><span class="op" id="6996384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996388">Notify</span><span class="op" id="6996394">(</span><span class="ident" id="6996395">c</span><span class="op" id="6996396">,</span>&nbsp;<span class="ident" id="6996398">sig</span><span class="op" id="6996401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996405">defer</span>&nbsp;<span class="ident" id="6996411">Stop</span><span class="op" id="6996415">(</span><span class="ident" id="6996416">c</span><span class="op" id="6996417">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996422">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996457">syscall</span><span class="op" id="6996464">.</span><span class="ident" id="6996465">Kill</span><span class="op" id="6996469">(</span><span class="ident" id="6996470">syscall</span><span class="op" id="6996477">.</span><span class="ident" id="6996478">Getpid</span><span class="op" id="6996484">(</span><span class="op" id="6996485">)</span><span class="op" id="6996486">,</span>&nbsp;<span class="ident" id="6996488">sig</span><span class="op" id="6996491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996495">waitSig</span><span class="op" id="6996502">(</span><span class="ident" id="6996503">t</span><span class="op" id="6996504">,</span>&nbsp;<span class="ident" id="6996506">c</span><span class="op" id="6996507">,</span>&nbsp;<span class="ident" id="6996509">sig</span><span class="op" id="6996512">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996517">Stop</span><span class="op" id="6996521">(</span><span class="ident" id="6996522">c</span><span class="op" id="6996523">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996527">select</span>&nbsp;<span class="op" id="6996534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996538">case</span>&nbsp;<span class="ident" id="6996543">s</span>&nbsp;<span class="op" id="6996545">:=</span>&nbsp;<span class="op" id="6996548">&lt;-</span><span class="ident" id="6996550">c</span><span class="op" id="6996551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996556">t</span><span class="op" id="6996557">.</span><span class="ident" id="6996558">Fatalf</span><span class="op" id="6996564">(</span><span class="string" id="6996565">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="6996587">,</span>&nbsp;<span class="ident" id="6996589">s</span><span class="op" id="6996590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996594">case</span>&nbsp;<span class="op" id="6996599">&lt;-</span><span class="ident" id="6996601">time</span><span class="op" id="6996605">.</span><span class="ident" id="6996606">After</span><span class="op" id="6996611">(</span><span class="num" id="6996612">100</span>&nbsp;<span class="op" id="6996616">*</span>&nbsp;<span class="ident" id="6996618">time</span><span class="op" id="6996622">.</span><span class="ident" id="6996623">Millisecond</span><span class="op" id="6996634">)</span><span class="op" id="6996635">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996640">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6996668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996673">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996695">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6996740">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996811">if</span>&nbsp;<span class="ident" id="6996814">sig</span>&nbsp;<span class="op" id="6996818">!=</span>&nbsp;<span class="ident" id="6996821">syscall</span><span class="op" id="6996828">.</span><span class="ident" id="6996829">SIGHUP</span>&nbsp;<span class="op" id="6996836">||</span>&nbsp;<span class="op" id="6996839">*</span><span class="ident" id="6996840">sendUncaughtSighup</span>&nbsp;<span class="op" id="6996859">==</span>&nbsp;<span class="num" id="6996862">2</span>&nbsp;<span class="op" id="6996864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996869">syscall</span><span class="op" id="6996876">.</span><span class="ident" id="6996877">Kill</span><span class="op" id="6996881">(</span><span class="ident" id="6996882">syscall</span><span class="op" id="6996889">.</span><span class="ident" id="6996890">Getpid</span><span class="op" id="6996896">(</span><span class="op" id="6996897">)</span><span class="op" id="6996898">,</span>&nbsp;<span class="ident" id="6996900">sig</span><span class="op" id="6996903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6996907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996912">select</span>&nbsp;<span class="op" id="6996919">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996923">case</span>&nbsp;<span class="ident" id="6996928">s</span>&nbsp;<span class="op" id="6996930">:=</span>&nbsp;<span class="op" id="6996933">&lt;-</span><span class="ident" id="6996935">c</span><span class="op" id="6996936">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6996941">t</span><span class="op" id="6996942">.</span><span class="ident" id="6996943">Fatalf</span><span class="op" id="6996949">(</span><span class="string" id="6996950">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="6996972">,</span>&nbsp;<span class="ident" id="6996974">s</span><span class="op" id="6996975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6996979">case</span>&nbsp;<span class="op" id="6996984">&lt;-</span><span class="ident" id="6996986">time</span><span class="op" id="6996990">.</span><span class="ident" id="6996991">After</span><span class="op" id="6996996">(</span><span class="num" id="6996997">100</span>&nbsp;<span class="op" id="6997001">*</span>&nbsp;<span class="ident" id="6997003">time</span><span class="op" id="6997007">.</span><span class="ident" id="6997008">Millisecond</span><span class="op" id="6997019">)</span><span class="op" id="6997020">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997025">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6997053">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6997056">}</span><br>
<span class="lineno"></span><span class="op" id="6997058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6997061">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="6997142">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="6997151">func</span>&nbsp;<span class="ident" id="6997156">TestNohup</span><span class="op" id="6997165">(</span><span class="ident" id="6997166">t</span>&nbsp;<span class="op" id="6997168">*</span><span class="ident" id="6997169">testing</span><span class="op" id="6997176">.</span><span class="ident" id="6997177">T</span><span class="op" id="6997178">)</span>&nbsp;<span class="op" id="6997180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997183">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997247">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997300">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6997344">c</span>&nbsp;<span class="op" id="6997346">:=</span>&nbsp;<span class="builtinfunc" id="6997349">make</span><span class="op" id="6997353">(</span><span class="keyword" id="6997354">chan</span>&nbsp;<span class="ident" id="6997359">os</span><span class="op" id="6997361">.</span><span class="ident" id="6997362">Signal</span><span class="op" id="6997368">,</span>&nbsp;<span class="num" id="6997370">1</span><span class="op" id="6997371">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6997374">Notify</span><span class="op" id="6997380">(</span><span class="ident" id="6997381">c</span><span class="op" id="6997382">,</span>&nbsp;<span class="ident" id="6997384">syscall</span><span class="op" id="6997391">.</span><span class="ident" id="6997392">SIGHUP</span><span class="op" id="6997398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997402">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997475">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997542">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997608">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997687">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997765">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997769">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997852">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997935">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6997939">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6997999">for</span>&nbsp;<span class="ident" id="6998003">i</span>&nbsp;<span class="op" id="6998005">:=</span>&nbsp;<span class="num" id="6998008">1</span><span class="op" id="6998009">;</span>&nbsp;<span class="ident" id="6998011">i</span>&nbsp;<span class="op" id="6998013">&lt;=</span>&nbsp;<span class="num" id="6998016">2</span><span class="op" id="6998017">;</span>&nbsp;<span class="ident" id="6998019">i</span><span class="op" id="6998020">++</span>&nbsp;<span class="op" id="6998023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998027">out</span><span class="op" id="6998030">,</span>&nbsp;<span class="ident" id="6998032">err</span>&nbsp;<span class="op" id="6998036">:=</span>&nbsp;<span class="ident" id="6998039">exec</span><span class="op" id="6998043">.</span><span class="ident" id="6998044">Command</span><span class="op" id="6998051">(</span><span class="ident" id="6998052">os</span><span class="op" id="6998054">.</span><span class="ident" id="6998055">Args</span><span class="op" id="6998059">[</span><span class="num" id="6998060">0</span><span class="op" id="6998061">]</span><span class="op" id="6998062">,</span>&nbsp;<span class="string" id="6998064">&#34;-test.run=TestStop&#34;</span><span class="op" id="6998084">,</span>&nbsp;<span class="string" id="6998086">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="6998110">+</span><span class="ident" id="6998111">strconv</span><span class="op" id="6998118">.</span><span class="ident" id="6998119">Itoa</span><span class="op" id="6998123">(</span><span class="ident" id="6998124">i</span><span class="op" id="6998125">)</span><span class="op" id="6998126">)</span><span class="op" id="6998127">.</span><span class="ident" id="6998128">CombinedOutput</span><span class="op" id="6998142">(</span><span class="op" id="6998143">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6998147">if</span>&nbsp;<span class="ident" id="6998150">err</span>&nbsp;<span class="op" id="6998154">==</span>&nbsp;<span class="ident" id="6998157">nil</span>&nbsp;<span class="op" id="6998161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998166">t</span><span class="op" id="6998167">.</span><span class="ident" id="6998168">Fatalf</span><span class="op" id="6998174">(</span><span class="string" id="6998175">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="6998264">,</span>&nbsp;<span class="ident" id="6998266">i</span><span class="op" id="6998267">,</span>&nbsp;<span class="ident" id="6998269">out</span><span class="op" id="6998272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6998276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6998279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998283">Stop</span><span class="op" id="6998287">(</span><span class="ident" id="6998288">c</span><span class="op" id="6998289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6998293">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998351">_</span><span class="op" id="6998352">,</span>&nbsp;<span class="ident" id="6998354">err</span>&nbsp;<span class="op" id="6998358">:=</span>&nbsp;<span class="ident" id="6998361">os</span><span class="op" id="6998363">.</span><span class="ident" id="6998364">Stat</span><span class="op" id="6998368">(</span><span class="string" id="6998369">&#34;/usr/bin/nohup&#34;</span><span class="op" id="6998385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6998388">if</span>&nbsp;<span class="ident" id="6998391">err</span>&nbsp;<span class="op" id="6998395">!=</span>&nbsp;<span class="ident" id="6998398">nil</span>&nbsp;<span class="op" id="6998402">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998406">t</span><span class="op" id="6998407">.</span><span class="ident" id="6998408">Skip</span><span class="op" id="6998412">(</span><span class="string" id="6998413">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="6998462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6998465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6998469">for</span>&nbsp;<span class="ident" id="6998473">i</span>&nbsp;<span class="op" id="6998475">:=</span>&nbsp;<span class="num" id="6998478">1</span><span class="op" id="6998479">;</span>&nbsp;<span class="ident" id="6998481">i</span>&nbsp;<span class="op" id="6998483">&lt;=</span>&nbsp;<span class="num" id="6998486">2</span><span class="op" id="6998487">;</span>&nbsp;<span class="ident" id="6998489">i</span><span class="op" id="6998490">++</span>&nbsp;<span class="op" id="6998493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998497">os</span><span class="op" id="6998499">.</span><span class="ident" id="6998500">Remove</span><span class="op" id="6998506">(</span><span class="string" id="6998507">&#34;nohup.out&#34;</span><span class="op" id="6998518">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998522">out</span><span class="op" id="6998525">,</span>&nbsp;<span class="ident" id="6998527">err</span>&nbsp;<span class="op" id="6998531">:=</span>&nbsp;<span class="ident" id="6998534">exec</span><span class="op" id="6998538">.</span><span class="ident" id="6998539">Command</span><span class="op" id="6998546">(</span><span class="string" id="6998547">&#34;/usr/bin/nohup&#34;</span><span class="op" id="6998563">,</span>&nbsp;<span class="ident" id="6998565">os</span><span class="op" id="6998567">.</span><span class="ident" id="6998568">Args</span><span class="op" id="6998572">[</span><span class="num" id="6998573">0</span><span class="op" id="6998574">]</span><span class="op" id="6998575">,</span>&nbsp;<span class="string" id="6998577">&#34;-test.run=TestStop&#34;</span><span class="op" id="6998597">,</span>&nbsp;<span class="string" id="6998599">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="6998623">+</span><span class="ident" id="6998624">strconv</span><span class="op" id="6998631">.</span><span class="ident" id="6998632">Itoa</span><span class="op" id="6998636">(</span><span class="ident" id="6998637">i</span><span class="op" id="6998638">)</span><span class="op" id="6998639">)</span><span class="op" id="6998640">.</span><span class="ident" id="6998641">CombinedOutput</span><span class="op" id="6998655">(</span><span class="op" id="6998656">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998661">data</span><span class="op" id="6998665">,</span>&nbsp;<span class="ident" id="6998667">_</span>&nbsp;<span class="op" id="6998669">:=</span>&nbsp;<span class="ident" id="6998672">ioutil</span><span class="op" id="6998678">.</span><span class="ident" id="6998679">ReadFile</span><span class="op" id="6998687">(</span><span class="string" id="6998688">&#34;nohup.out&#34;</span><span class="op" id="6998699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998703">os</span><span class="op" id="6998705">.</span><span class="ident" id="6998706">Remove</span><span class="op" id="6998712">(</span><span class="string" id="6998713">&#34;nohup.out&#34;</span><span class="op" id="6998724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6998728">if</span>&nbsp;<span class="ident" id="6998731">err</span>&nbsp;<span class="op" id="6998735">!=</span>&nbsp;<span class="ident" id="6998738">nil</span>&nbsp;<span class="op" id="6998742">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6998747">t</span><span class="op" id="6998748">.</span><span class="ident" id="6998749">Fatalf</span><span class="op" id="6998755">(</span><span class="string" id="6998756">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="6998867">,</span>&nbsp;<span class="ident" id="6998869">i</span><span class="op" id="6998870">,</span>&nbsp;<span class="ident" id="6998872">err</span><span class="op" id="6998875">,</span>&nbsp;<span class="ident" id="6998877">out</span><span class="op" id="6998880">,</span>&nbsp;<span class="ident" id="6998882">data</span><span class="op" id="6998886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6998890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6998893">}</span><br>
<span class="lineno"></span><span class="op" id="6998895">}</span>
</div>
</body>
</html>
