<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html" class="current">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5088544">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5088599">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5088653">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5088704">package</span>&nbsp;<span class="ident" id="5088712">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5088722">import</span>&nbsp;<span class="op" id="5088729">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5088732">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5088741">&#34;encoding/json&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5088758">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5088765">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5088776">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5088787">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5088802">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5088805">//&nbsp;nextJSCtx&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;determines&nbsp;whether&nbsp;a&nbsp;slash&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5088880">//&nbsp;given&nbsp;run&nbsp;of&nbsp;tokens&nbsp;starts&nbsp;a&nbsp;regular&nbsp;expression&nbsp;instead&nbsp;of&nbsp;a&nbsp;division</span><br>
<span class="lineno"></span><span class="comment" id="5088953">//&nbsp;operator:&nbsp;/&nbsp;or&nbsp;/=.</span><br>
<span class="lineno"></span><span class="comment" id="5088975">//</span><br>
<span class="lineno">20</span><span class="comment" id="5088978">//&nbsp;This&nbsp;assumes&nbsp;that&nbsp;the&nbsp;token&nbsp;run&nbsp;does&nbsp;not&nbsp;include&nbsp;any&nbsp;string&nbsp;tokens,&nbsp;comment</span><br>
<span class="lineno"></span><span class="comment" id="5089057">//&nbsp;tokens,&nbsp;regular&nbsp;expression&nbsp;literal&nbsp;tokens,&nbsp;or&nbsp;division&nbsp;operators.</span><br>
<span class="lineno"></span><span class="comment" id="5089126">//</span><br>
<span class="lineno"></span><span class="comment" id="5089129">//&nbsp;This&nbsp;fails&nbsp;on&nbsp;some&nbsp;valid&nbsp;but&nbsp;nonsensical&nbsp;JavaScript&nbsp;programs&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="5089198">//&nbsp;&#34;x&nbsp;=&nbsp;++/foo/i&#34;&nbsp;which&nbsp;is&nbsp;quite&nbsp;different&nbsp;than&nbsp;&#34;x++/foo/i&#34;,&nbsp;but&nbsp;is&nbsp;not&nbsp;known&nbsp;to</span><br>
<span class="lineno">25</span><span class="comment" id="5089279">//&nbsp;fail&nbsp;on&nbsp;any&nbsp;known&nbsp;useful&nbsp;programs.&nbsp;It&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;draft</span><br>
<span class="lineno"></span><span class="comment" id="5089342">//&nbsp;JavaScript&nbsp;2.0&nbsp;lexical&nbsp;grammar&nbsp;and&nbsp;requires&nbsp;one&nbsp;token&nbsp;of&nbsp;lookbehind:</span><br>
<span class="lineno"></span><span class="comment" id="5089414">//&nbsp;http://www.mozilla.org/js/language/js20-2000-07/rationale/syntax.html</span><br>
<span class="lineno"></span><span class="keyword" id="5089487">func</span>&nbsp;<span class="ident" id="5089492">nextJSCtx</span><span class="op" id="5089501">(</span><span class="ident" id="5089502">s</span>&nbsp;<span class="op" id="5089504">[</span><span class="op" id="5089505">]</span><span class="builtintype" id="5089506">byte</span><span class="op" id="5089510">,</span>&nbsp;<span class="ident" id="5089512">preceding</span>&nbsp;<span class="ident" id="5089522">jsCtx</span><span class="op" id="5089527">)</span>&nbsp;<span class="ident" id="5089529">jsCtx</span>&nbsp;<span class="op" id="5089535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5089538">s</span>&nbsp;<span class="op" id="5089540">=</span>&nbsp;<span class="ident" id="5089542">bytes</span><span class="op" id="5089547">.</span><span class="ident" id="5089548">TrimRight</span><span class="op" id="5089557">(</span><span class="ident" id="5089558">s</span><span class="op" id="5089559">,</span>&nbsp;<span class="string" id="5089561">&#34;\t\n\f\r&nbsp;\u2028\u2029&#34;</span><span class="op" id="5089584">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5089587">if</span>&nbsp;<span class="builtinfunc" id="5089590">len</span><span class="op" id="5089593">(</span><span class="ident" id="5089594">s</span><span class="op" id="5089595">)</span>&nbsp;<span class="op" id="5089597">==</span>&nbsp;<span class="num" id="5089600">0</span>&nbsp;<span class="op" id="5089602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5089606">return</span>&nbsp;<span class="ident" id="5089613">preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5089624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089628">//&nbsp;All&nbsp;cases&nbsp;below&nbsp;are&nbsp;in&nbsp;the&nbsp;single-byte&nbsp;UTF-8&nbsp;group.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5089684">switch</span>&nbsp;<span class="ident" id="5089691">c</span><span class="op" id="5089692">,</span>&nbsp;<span class="ident" id="5089694">n</span>&nbsp;<span class="op" id="5089696">:=</span>&nbsp;<span class="ident" id="5089699">s</span><span class="op" id="5089700">[</span><span class="builtinfunc" id="5089701">len</span><span class="op" id="5089704">(</span><span class="ident" id="5089705">s</span><span class="op" id="5089706">)</span><span class="op" id="5089707">-</span><span class="num" id="5089708">1</span><span class="op" id="5089709">]</span><span class="op" id="5089710">,</span>&nbsp;<span class="builtinfunc" id="5089712">len</span><span class="op" id="5089715">(</span><span class="ident" id="5089716">s</span><span class="op" id="5089717">)</span><span class="op" id="5089718">;</span>&nbsp;<span class="ident" id="5089720">c</span>&nbsp;<span class="op" id="5089722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5089725">case</span>&nbsp;<span class="string" id="5089730">&#39;+&#39;</span><span class="op" id="5089733">,</span>&nbsp;<span class="string" id="5089735">&#39;-&#39;</span><span class="op" id="5089738">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089742">//&nbsp;++&nbsp;and&nbsp;--&nbsp;are&nbsp;not&nbsp;regexp&nbsp;preceders,&nbsp;but&nbsp;+&nbsp;and&nbsp;-&nbsp;are&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089807">//&nbsp;they&nbsp;are&nbsp;used&nbsp;as&nbsp;infix&nbsp;or&nbsp;prefix&nbsp;operators.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5089856">start</span>&nbsp;<span class="op" id="5089862">:=</span>&nbsp;<span class="ident" id="5089865">n</span>&nbsp;<span class="op" id="5089867">-</span>&nbsp;<span class="num" id="5089869">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089873">//&nbsp;Count&nbsp;the&nbsp;number&nbsp;of&nbsp;adjacent&nbsp;dashes&nbsp;or&nbsp;pluses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5089925">for</span>&nbsp;<span class="ident" id="5089929">start</span>&nbsp;<span class="op" id="5089935">&gt;</span>&nbsp;<span class="num" id="5089937">0</span>&nbsp;<span class="op" id="5089939">&amp;&amp;</span>&nbsp;<span class="ident" id="5089942">s</span><span class="op" id="5089943">[</span><span class="ident" id="5089944">start</span><span class="op" id="5089949">-</span><span class="num" id="5089950">1</span><span class="op" id="5089951">]</span>&nbsp;<span class="op" id="5089953">==</span>&nbsp;<span class="ident" id="5089956">c</span>&nbsp;<span class="op" id="5089958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5089963">start</span><span class="op" id="5089968">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5089973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5089977">if</span>&nbsp;<span class="op" id="5089980">(</span><span class="ident" id="5089981">n</span><span class="op" id="5089982">-</span><span class="ident" id="5089983">start</span><span class="op" id="5089988">)</span><span class="op" id="5089989">&amp;</span><span class="num" id="5089990">1</span>&nbsp;<span class="op" id="5089992">==</span>&nbsp;<span class="num" id="5089995">1</span>&nbsp;<span class="op" id="5089997">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090002">//&nbsp;Reached&nbsp;for&nbsp;trailing&nbsp;minus&nbsp;signs&nbsp;since&nbsp;&#34;---&#34;&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090060">//&nbsp;same&nbsp;as&nbsp;&#34;--&nbsp;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090082">return</span>&nbsp;<span class="ident" id="5090089">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5090103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090107">return</span>&nbsp;<span class="ident" id="5090114">jsCtxDivOp</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090126">case</span>&nbsp;<span class="string" id="5090131">&#39;.&#39;</span><span class="op" id="5090134">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090138">//&nbsp;Handle&nbsp;&#34;42.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090156">if</span>&nbsp;<span class="ident" id="5090159">n</span>&nbsp;<span class="op" id="5090161">!=</span>&nbsp;<span class="num" id="5090164">1</span>&nbsp;<span class="op" id="5090166">&amp;&amp;</span>&nbsp;<span class="string" id="5090169">&#39;0&#39;</span>&nbsp;<span class="op" id="5090173">&lt;=</span>&nbsp;<span class="ident" id="5090176">s</span><span class="op" id="5090177">[</span><span class="ident" id="5090178">n</span><span class="op" id="5090179">-</span><span class="num" id="5090180">2</span><span class="op" id="5090181">]</span>&nbsp;<span class="op" id="5090183">&amp;&amp;</span>&nbsp;<span class="ident" id="5090186">s</span><span class="op" id="5090187">[</span><span class="ident" id="5090188">n</span><span class="op" id="5090189">-</span><span class="num" id="5090190">2</span><span class="op" id="5090191">]</span>&nbsp;<span class="op" id="5090193">&lt;=</span>&nbsp;<span class="string" id="5090196">&#39;9&#39;</span>&nbsp;<span class="op" id="5090200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090205">return</span>&nbsp;<span class="ident" id="5090212">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5090225">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090229">return</span>&nbsp;<span class="ident" id="5090236">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090249">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090320">//&nbsp;that&nbsp;only&nbsp;end&nbsp;binary&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090374">case</span>&nbsp;<span class="string" id="5090379">&#39;,&#39;</span><span class="op" id="5090382">,</span>&nbsp;<span class="string" id="5090384">&#39;&lt;&#39;</span><span class="op" id="5090387">,</span>&nbsp;<span class="string" id="5090389">&#39;&gt;&#39;</span><span class="op" id="5090392">,</span>&nbsp;<span class="string" id="5090394">&#39;=&#39;</span><span class="op" id="5090397">,</span>&nbsp;<span class="string" id="5090399">&#39;*&#39;</span><span class="op" id="5090402">,</span>&nbsp;<span class="string" id="5090404">&#39;%&#39;</span><span class="op" id="5090407">,</span>&nbsp;<span class="string" id="5090409">&#39;&amp;&#39;</span><span class="op" id="5090412">,</span>&nbsp;<span class="string" id="5090414">&#39;|&#39;</span><span class="op" id="5090417">,</span>&nbsp;<span class="string" id="5090419">&#39;^&#39;</span><span class="op" id="5090422">,</span>&nbsp;<span class="string" id="5090424">&#39;?&#39;</span><span class="op" id="5090427">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090431">return</span>&nbsp;<span class="ident" id="5090438">jsCtxRegexp</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090451">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090522">//&nbsp;that&nbsp;are&nbsp;prefix&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090571">case</span>&nbsp;<span class="string" id="5090576">&#39;!&#39;</span><span class="op" id="5090579">,</span>&nbsp;<span class="string" id="5090581">&#39;~&#39;</span><span class="op" id="5090584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090588">return</span>&nbsp;<span class="ident" id="5090595">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090608">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090678">//&nbsp;that&nbsp;are&nbsp;open&nbsp;brackets&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090724">case</span>&nbsp;<span class="string" id="5090729">&#39;(&#39;</span><span class="op" id="5090732">,</span>&nbsp;<span class="string" id="5090734">&#39;[&#39;</span><span class="op" id="5090737">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090741">return</span>&nbsp;<span class="ident" id="5090748">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090761">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090831">//&nbsp;that&nbsp;precede&nbsp;expression&nbsp;starts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090867">case</span>&nbsp;<span class="string" id="5090872">&#39;:&#39;</span><span class="op" id="5090875">,</span>&nbsp;<span class="string" id="5090877">&#39;;&#39;</span><span class="op" id="5090880">,</span>&nbsp;<span class="string" id="5090882">&#39;{&#39;</span><span class="op" id="5090885">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5090889">return</span>&nbsp;<span class="ident" id="5090896">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090909">//&nbsp;CAVEAT:&nbsp;the&nbsp;close&nbsp;punctuators&nbsp;(&#39;}&#39;,&nbsp;&#39;]&#39;,&nbsp;&#39;)&#39;)&nbsp;precede&nbsp;div&nbsp;ops&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5090979">//&nbsp;are&nbsp;handled&nbsp;in&nbsp;the&nbsp;default&nbsp;except&nbsp;for&nbsp;&#39;}&#39;&nbsp;which&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091045">//&nbsp;division&nbsp;op&nbsp;as&nbsp;in</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091067">//&nbsp;&nbsp;&nbsp;&nbsp;({&nbsp;valueOf:&nbsp;function&nbsp;()&nbsp;{&nbsp;return&nbsp;42&nbsp;}&nbsp;}&nbsp;/&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091118">//&nbsp;which&nbsp;is&nbsp;valid,&nbsp;but,&nbsp;in&nbsp;practice,&nbsp;developers&nbsp;don&#39;t&nbsp;divide&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091187">//&nbsp;literals,&nbsp;so&nbsp;our&nbsp;heuristic&nbsp;works&nbsp;well&nbsp;for&nbsp;code&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091243">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;()&nbsp;{&nbsp;...&nbsp;}&nbsp;&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;sideEffect();</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091302">//&nbsp;The&nbsp;&#39;)&#39;&nbsp;punctuator&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression&nbsp;as&nbsp;in</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091364">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(b)&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091400">//&nbsp;but&nbsp;this&nbsp;is&nbsp;much&nbsp;less&nbsp;likely&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091438">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(a&nbsp;+&nbsp;b)&nbsp;/&nbsp;c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5091458">case</span>&nbsp;<span class="string" id="5091463">&#39;}&#39;</span><span class="op" id="5091466">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5091470">return</span>&nbsp;<span class="ident" id="5091477">jsCtxRegexp</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5091490">default</span><span class="op" id="5091497">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091501">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;IdentifierName&nbsp;and&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;a&nbsp;keyword&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091565">//&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5091604">j</span>&nbsp;<span class="op" id="5091606">:=</span>&nbsp;<span class="ident" id="5091609">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5091613">for</span>&nbsp;<span class="ident" id="5091617">j</span>&nbsp;<span class="op" id="5091619">&gt;</span>&nbsp;<span class="num" id="5091621">0</span>&nbsp;<span class="op" id="5091623">&amp;&amp;</span>&nbsp;<span class="ident" id="5091626">isJSIdentPart</span><span class="op" id="5091639">(</span><span class="builtintype" id="5091640">rune</span><span class="op" id="5091644">(</span><span class="ident" id="5091645">s</span><span class="op" id="5091646">[</span><span class="ident" id="5091647">j</span><span class="op" id="5091648">-</span><span class="num" id="5091649">1</span><span class="op" id="5091650">]</span><span class="op" id="5091651">)</span><span class="op" id="5091652">)</span>&nbsp;<span class="op" id="5091654">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5091659">j</span><span class="op" id="5091660">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5091665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5091669">if</span>&nbsp;<span class="ident" id="5091672">regexpPrecederKeywords</span><span class="op" id="5091694">[</span><span class="builtintype" id="5091695">string</span><span class="op" id="5091701">(</span><span class="ident" id="5091702">s</span><span class="op" id="5091703">[</span><span class="ident" id="5091704">j</span><span class="op" id="5091705">:</span><span class="op" id="5091706">]</span><span class="op" id="5091707">)</span><span class="op" id="5091708">]</span>&nbsp;<span class="op" id="5091710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5091715">return</span>&nbsp;<span class="ident" id="5091722">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5091736">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5091739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091742">//&nbsp;Otherwise&nbsp;is&nbsp;a&nbsp;punctuator&nbsp;not&nbsp;listed&nbsp;above,&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091793">//&nbsp;a&nbsp;string&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op,&nbsp;or&nbsp;an&nbsp;identifier</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5091848">//&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5091877">return</span>&nbsp;<span class="ident" id="5091884">jsCtxDivOp</span><br>
<span class="lineno">100</span><span class="op" id="5091895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5091898">//&nbsp;regexpPrecederKeywords&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;reserved&nbsp;JS&nbsp;keywords&nbsp;that&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5091976">//&nbsp;regular&nbsp;expression&nbsp;in&nbsp;JS&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="5092012">var</span>&nbsp;<span class="ident" id="5092016">regexpPrecederKeywords</span>&nbsp;<span class="op" id="5092039">=</span>&nbsp;<span class="keyword" id="5092041">map</span><span class="op" id="5092044">[</span><span class="builtintype" id="5092045">string</span><span class="op" id="5092051">]</span><span class="builtintype" id="5092052">bool</span><span class="op" id="5092056">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092059">&#34;break&#34;</span><span class="op" id="5092066">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092073">true</span><span class="op" id="5092077">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092080">&#34;case&#34;</span><span class="op" id="5092086">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092094">true</span><span class="op" id="5092098">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092101">&#34;continue&#34;</span><span class="op" id="5092111">:</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092115">true</span><span class="op" id="5092119">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092122">&#34;delete&#34;</span><span class="op" id="5092130">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092136">true</span><span class="op" id="5092140">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092143">&#34;do&#34;</span><span class="op" id="5092147">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092157">true</span><span class="op" id="5092161">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092164">&#34;else&#34;</span><span class="op" id="5092170">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092178">true</span><span class="op" id="5092182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092185">&#34;finally&#34;</span><span class="op" id="5092194">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092199">true</span><span class="op" id="5092203">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092206">&#34;in&#34;</span><span class="op" id="5092210">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092220">true</span><span class="op" id="5092224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092227">&#34;instanceof&#34;</span><span class="op" id="5092239">:</span>&nbsp;<span class="builtintype" id="5092241">true</span><span class="op" id="5092245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092248">&#34;return&#34;</span><span class="op" id="5092256">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092262">true</span><span class="op" id="5092266">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092269">&#34;throw&#34;</span><span class="op" id="5092276">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092283">true</span><span class="op" id="5092287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092290">&#34;try&#34;</span><span class="op" id="5092295">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092304">true</span><span class="op" id="5092308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092311">&#34;typeof&#34;</span><span class="op" id="5092319">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092325">true</span><span class="op" id="5092329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5092332">&#34;void&#34;</span><span class="op" id="5092338">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5092346">true</span><span class="op" id="5092350">,</span><br>
<span class="lineno"></span><span class="op" id="5092352">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="5092355">var</span>&nbsp;<span class="ident" id="5092359">jsonMarshalType</span>&nbsp;<span class="op" id="5092375">=</span>&nbsp;<span class="ident" id="5092377">reflect</span><span class="op" id="5092384">.</span><span class="ident" id="5092385">TypeOf</span><span class="op" id="5092391">(</span><span class="op" id="5092392">(</span><span class="op" id="5092393">*</span><span class="ident" id="5092394">json</span><span class="op" id="5092398">.</span><span class="ident" id="5092399">Marshaler</span><span class="op" id="5092408">)</span><span class="op" id="5092409">(</span><span class="ident" id="5092410">nil</span><span class="op" id="5092413">)</span><span class="op" id="5092414">)</span><span class="op" id="5092415">.</span><span class="ident" id="5092416">Elem</span><span class="op" id="5092420">(</span><span class="op" id="5092421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5092424">//&nbsp;indirectToJSONMarshaler&nbsp;returns&nbsp;the&nbsp;value,&nbsp;after&nbsp;dereferencing&nbsp;as&nbsp;many&nbsp;times</span><br>
<span class="lineno"></span><span class="comment" id="5092504">//&nbsp;as&nbsp;necessary&nbsp;to&nbsp;reach&nbsp;the&nbsp;base&nbsp;type&nbsp;(or&nbsp;nil)&nbsp;or&nbsp;an&nbsp;implementation&nbsp;of&nbsp;json.Marshal.</span><br>
<span class="lineno">125</span><span class="keyword" id="5092590">func</span>&nbsp;<span class="ident" id="5092595">indirectToJSONMarshaler</span><span class="op" id="5092618">(</span><span class="ident" id="5092619">a</span>&nbsp;<span class="keyword" id="5092621">interface</span><span class="op" id="5092630">{</span><span class="op" id="5092631">}</span><span class="op" id="5092632">)</span>&nbsp;<span class="keyword" id="5092634">interface</span><span class="op" id="5092643">{</span><span class="op" id="5092644">}</span>&nbsp;<span class="op" id="5092646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5092649">v</span>&nbsp;<span class="op" id="5092651">:=</span>&nbsp;<span class="ident" id="5092654">reflect</span><span class="op" id="5092661">.</span><span class="ident" id="5092662">ValueOf</span><span class="op" id="5092669">(</span><span class="ident" id="5092670">a</span><span class="op" id="5092671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5092674">for</span>&nbsp;<span class="op" id="5092678">!</span><span class="ident" id="5092679">v</span><span class="op" id="5092680">.</span><span class="ident" id="5092681">Type</span><span class="op" id="5092685">(</span><span class="op" id="5092686">)</span><span class="op" id="5092687">.</span><span class="ident" id="5092688">Implements</span><span class="op" id="5092698">(</span><span class="ident" id="5092699">jsonMarshalType</span><span class="op" id="5092714">)</span>&nbsp;<span class="op" id="5092716">&amp;&amp;</span>&nbsp;<span class="ident" id="5092719">v</span><span class="op" id="5092720">.</span><span class="ident" id="5092721">Kind</span><span class="op" id="5092725">(</span><span class="op" id="5092726">)</span>&nbsp;<span class="op" id="5092728">==</span>&nbsp;<span class="ident" id="5092731">reflect</span><span class="op" id="5092738">.</span><span class="ident" id="5092739">Ptr</span>&nbsp;<span class="op" id="5092743">&amp;&amp;</span>&nbsp;<span class="op" id="5092746">!</span><span class="ident" id="5092747">v</span><span class="op" id="5092748">.</span><span class="ident" id="5092749">IsNil</span><span class="op" id="5092754">(</span><span class="op" id="5092755">)</span>&nbsp;<span class="op" id="5092757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5092761">v</span>&nbsp;<span class="op" id="5092763">=</span>&nbsp;<span class="ident" id="5092765">v</span><span class="op" id="5092766">.</span><span class="ident" id="5092767">Elem</span><span class="op" id="5092771">(</span><span class="op" id="5092772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5092775">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5092778">return</span>&nbsp;<span class="ident" id="5092785">v</span><span class="op" id="5092786">.</span><span class="ident" id="5092787">Interface</span><span class="op" id="5092796">(</span><span class="op" id="5092797">)</span><br>
<span class="lineno"></span><span class="op" id="5092799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5092802">//&nbsp;jsValEscaper&nbsp;escapes&nbsp;its&nbsp;inputs&nbsp;to&nbsp;a&nbsp;JS&nbsp;Expression&nbsp;(section&nbsp;11.14)&nbsp;that&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5092881">//&nbsp;neither&nbsp;side-effects&nbsp;nor&nbsp;free&nbsp;variables&nbsp;outside&nbsp;(NaN,&nbsp;Infinity).</span><br>
<span class="lineno">135</span><span class="keyword" id="5092949">func</span>&nbsp;<span class="ident" id="5092954">jsValEscaper</span><span class="op" id="5092966">(</span><span class="ident" id="5092967">args</span>&nbsp;<span class="op" id="5092972">...</span><span class="keyword" id="5092975">interface</span><span class="op" id="5092984">{</span><span class="op" id="5092985">}</span><span class="op" id="5092986">)</span>&nbsp;<span class="builtintype" id="5092988">string</span>&nbsp;<span class="op" id="5092995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5092998">var</span>&nbsp;<span class="ident" id="5093002">a</span>&nbsp;<span class="keyword" id="5093004">interface</span><span class="op" id="5093013">{</span><span class="op" id="5093014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093017">if</span>&nbsp;<span class="builtinfunc" id="5093020">len</span><span class="op" id="5093023">(</span><span class="ident" id="5093024">args</span><span class="op" id="5093028">)</span>&nbsp;<span class="op" id="5093030">==</span>&nbsp;<span class="num" id="5093033">1</span>&nbsp;<span class="op" id="5093035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5093039">a</span>&nbsp;<span class="op" id="5093041">=</span>&nbsp;<span class="ident" id="5093043">indirectToJSONMarshaler</span><span class="op" id="5093066">(</span><span class="ident" id="5093067">args</span><span class="op" id="5093071">[</span><span class="num" id="5093072">0</span><span class="op" id="5093073">]</span><span class="op" id="5093074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093078">switch</span>&nbsp;<span class="ident" id="5093085">t</span>&nbsp;<span class="op" id="5093087">:=</span>&nbsp;<span class="ident" id="5093090">a</span><span class="op" id="5093091">.</span><span class="op" id="5093092">(</span><span class="keyword" id="5093093">type</span><span class="op" id="5093097">)</span>&nbsp;<span class="op" id="5093099">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093103">case</span>&nbsp;<span class="ident" id="5093108">JS</span><span class="op" id="5093110">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093115">return</span>&nbsp;<span class="builtintype" id="5093122">string</span><span class="op" id="5093128">(</span><span class="ident" id="5093129">t</span><span class="op" id="5093130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093134">case</span>&nbsp;<span class="ident" id="5093139">JSStr</span><span class="op" id="5093144">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093149">//&nbsp;TODO:&nbsp;normalize&nbsp;quotes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093179">return</span>&nbsp;<span class="string" id="5093186">`&#34;`</span>&nbsp;<span class="op" id="5093190">+</span>&nbsp;<span class="builtintype" id="5093192">string</span><span class="op" id="5093198">(</span><span class="ident" id="5093199">t</span><span class="op" id="5093200">)</span>&nbsp;<span class="op" id="5093202">+</span>&nbsp;<span class="string" id="5093204">`&#34;`</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093210">case</span>&nbsp;<span class="ident" id="5093215">json</span><span class="op" id="5093219">.</span><span class="ident" id="5093220">Marshaler</span><span class="op" id="5093229">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093234">//&nbsp;Do&nbsp;not&nbsp;treat&nbsp;as&nbsp;a&nbsp;Stringer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093267">case</span>&nbsp;<span class="ident" id="5093272">fmt</span><span class="op" id="5093275">.</span><span class="ident" id="5093276">Stringer</span><span class="op" id="5093284">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5093289">a</span>&nbsp;<span class="op" id="5093291">=</span>&nbsp;<span class="ident" id="5093293">t</span><span class="op" id="5093294">.</span><span class="ident" id="5093295">String</span><span class="op" id="5093301">(</span><span class="op" id="5093302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5093306">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5093309">}</span>&nbsp;<span class="keyword" id="5093311">else</span>&nbsp;<span class="op" id="5093316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093320">for</span>&nbsp;<span class="ident" id="5093324">i</span><span class="op" id="5093325">,</span>&nbsp;<span class="ident" id="5093327">arg</span>&nbsp;<span class="op" id="5093331">:=</span>&nbsp;<span class="keyword" id="5093334">range</span>&nbsp;<span class="ident" id="5093340">args</span>&nbsp;<span class="op" id="5093345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5093350">args</span><span class="op" id="5093354">[</span><span class="ident" id="5093355">i</span><span class="op" id="5093356">]</span>&nbsp;<span class="op" id="5093358">=</span>&nbsp;<span class="ident" id="5093360">indirectToJSONMarshaler</span><span class="op" id="5093383">(</span><span class="ident" id="5093384">arg</span><span class="op" id="5093387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5093391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5093395">a</span>&nbsp;<span class="op" id="5093397">=</span>&nbsp;<span class="ident" id="5093399">fmt</span><span class="op" id="5093402">.</span><span class="ident" id="5093403">Sprint</span><span class="op" id="5093409">(</span><span class="ident" id="5093410">args</span><span class="op" id="5093414">...</span><span class="op" id="5093417">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5093420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093423">//&nbsp;TODO:&nbsp;detect&nbsp;cycles&nbsp;before&nbsp;calling&nbsp;Marshal&nbsp;which&nbsp;loops&nbsp;infinitely&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093496">//&nbsp;cyclic&nbsp;data.&nbsp;This&nbsp;may&nbsp;be&nbsp;an&nbsp;unacceptable&nbsp;DoS&nbsp;risk.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5093552">b</span><span class="op" id="5093553">,</span>&nbsp;<span class="ident" id="5093555">err</span>&nbsp;<span class="op" id="5093559">:=</span>&nbsp;<span class="ident" id="5093562">json</span><span class="op" id="5093566">.</span><span class="ident" id="5093567">Marshal</span><span class="op" id="5093574">(</span><span class="ident" id="5093575">a</span><span class="op" id="5093576">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093579">if</span>&nbsp;<span class="ident" id="5093582">err</span>&nbsp;<span class="op" id="5093586">!=</span>&nbsp;<span class="ident" id="5093589">nil</span>&nbsp;<span class="op" id="5093593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093597">//&nbsp;Put&nbsp;a&nbsp;space&nbsp;before&nbsp;comment&nbsp;so&nbsp;that&nbsp;if&nbsp;it&nbsp;is&nbsp;flush&nbsp;against</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093660">//&nbsp;a&nbsp;division&nbsp;operator&nbsp;it&nbsp;is&nbsp;not&nbsp;turned&nbsp;into&nbsp;a&nbsp;line&nbsp;comment:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093723">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x/{{y}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093740">//&nbsp;turning&nbsp;into</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093758">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x//*&nbsp;error&nbsp;marshalling&nbsp;y:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093793">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;line&nbsp;of&nbsp;error&nbsp;message&nbsp;*/null</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5093843">return</span>&nbsp;<span class="ident" id="5093850">fmt</span><span class="op" id="5093853">.</span><span class="ident" id="5093854">Sprintf</span><span class="op" id="5093861">(</span><span class="string" id="5093862">&#34;&nbsp;/*&nbsp;%s&nbsp;*/null&nbsp;&#34;</span><span class="op" id="5093878">,</span>&nbsp;<span class="ident" id="5093880">strings</span><span class="op" id="5093887">.</span><span class="ident" id="5093888">Replace</span><span class="op" id="5093895">(</span><span class="ident" id="5093896">err</span><span class="op" id="5093899">.</span><span class="ident" id="5093900">Error</span><span class="op" id="5093905">(</span><span class="op" id="5093906">)</span><span class="op" id="5093907">,</span>&nbsp;<span class="string" id="5093909">&#34;*/&#34;</span><span class="op" id="5093913">,</span>&nbsp;<span class="string" id="5093915">&#34;*&nbsp;/&#34;</span><span class="op" id="5093920">,</span>&nbsp;<span class="op" id="5093922">-</span><span class="num" id="5093923">1</span><span class="op" id="5093924">)</span><span class="op" id="5093925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5093928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093932">//&nbsp;TODO:&nbsp;maybe&nbsp;post-process&nbsp;output&nbsp;to&nbsp;prevent&nbsp;it&nbsp;from&nbsp;containing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5093998">//&nbsp;&#34;&lt;!--&#34;,&nbsp;&#34;--&gt;&#34;,&nbsp;&#34;&lt;![CDATA[&#34;,&nbsp;&#34;]]&gt;&#34;,&nbsp;or&nbsp;&#34;&lt;/script&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5094051">//&nbsp;in&nbsp;case&nbsp;custom&nbsp;marshallers&nbsp;produce&nbsp;output&nbsp;containing&nbsp;those.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5094116">//&nbsp;TODO:&nbsp;Maybe&nbsp;abbreviate&nbsp;\u00ab&nbsp;to&nbsp;\xab&nbsp;to&nbsp;produce&nbsp;more&nbsp;compact&nbsp;output.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5094190">if</span>&nbsp;<span class="builtinfunc" id="5094193">len</span><span class="op" id="5094196">(</span><span class="ident" id="5094197">b</span><span class="op" id="5094198">)</span>&nbsp;<span class="op" id="5094200">==</span>&nbsp;<span class="num" id="5094203">0</span>&nbsp;<span class="op" id="5094205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5094209">//&nbsp;In,&nbsp;`x=y/{{.}}*z`&nbsp;a&nbsp;json.Marshaler&nbsp;that&nbsp;produces&nbsp;&#34;&#34;&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5094273">//&nbsp;not&nbsp;cause&nbsp;the&nbsp;output&nbsp;`x=y/*z`.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5094309">return</span>&nbsp;<span class="string" id="5094316">&#34;&nbsp;null&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5094326">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094329">first</span><span class="op" id="5094334">,</span>&nbsp;<span class="ident" id="5094336">_</span>&nbsp;<span class="op" id="5094338">:=</span>&nbsp;<span class="ident" id="5094341">utf8</span><span class="op" id="5094345">.</span><span class="ident" id="5094346">DecodeRune</span><span class="op" id="5094356">(</span><span class="ident" id="5094357">b</span><span class="op" id="5094358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094361">last</span><span class="op" id="5094365">,</span>&nbsp;<span class="ident" id="5094367">_</span>&nbsp;<span class="op" id="5094369">:=</span>&nbsp;<span class="ident" id="5094372">utf8</span><span class="op" id="5094376">.</span><span class="ident" id="5094377">DecodeLastRune</span><span class="op" id="5094391">(</span><span class="ident" id="5094392">b</span><span class="op" id="5094393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5094396">var</span>&nbsp;<span class="ident" id="5094400">buf</span>&nbsp;<span class="ident" id="5094404">bytes</span><span class="op" id="5094409">.</span><span class="ident" id="5094410">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5094418">//&nbsp;Prevent&nbsp;IdentifierNames&nbsp;and&nbsp;NumericLiterals&nbsp;from&nbsp;running&nbsp;into</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5094484">//&nbsp;keywords:&nbsp;in,&nbsp;instanceof,&nbsp;typeof,&nbsp;void</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094527">pad</span>&nbsp;<span class="op" id="5094531">:=</span>&nbsp;<span class="ident" id="5094534">isJSIdentPart</span><span class="op" id="5094547">(</span><span class="ident" id="5094548">first</span><span class="op" id="5094553">)</span>&nbsp;<span class="op" id="5094555">||</span>&nbsp;<span class="ident" id="5094558">isJSIdentPart</span><span class="op" id="5094571">(</span><span class="ident" id="5094572">last</span><span class="op" id="5094576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5094579">if</span>&nbsp;<span class="ident" id="5094582">pad</span>&nbsp;<span class="op" id="5094586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094590">buf</span><span class="op" id="5094593">.</span><span class="ident" id="5094594">WriteByte</span><span class="op" id="5094603">(</span><span class="string" id="5094604">&#39;&nbsp;&#39;</span><span class="op" id="5094607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5094610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094613">written</span>&nbsp;<span class="op" id="5094621">:=</span>&nbsp;<span class="num" id="5094624">0</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5094627">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;json.Marshal&nbsp;escapes&nbsp;codepoints&nbsp;U+2028&nbsp;&amp;&nbsp;U+2029</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5094694">//&nbsp;so&nbsp;it&nbsp;falls&nbsp;within&nbsp;the&nbsp;subset&nbsp;of&nbsp;JSON&nbsp;which&nbsp;is&nbsp;valid&nbsp;JS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5094755">for</span>&nbsp;<span class="ident" id="5094759">i</span>&nbsp;<span class="op" id="5094761">:=</span>&nbsp;<span class="num" id="5094764">0</span><span class="op" id="5094765">;</span>&nbsp;<span class="ident" id="5094767">i</span>&nbsp;<span class="op" id="5094769">&lt;</span>&nbsp;<span class="builtinfunc" id="5094771">len</span><span class="op" id="5094774">(</span><span class="ident" id="5094775">b</span><span class="op" id="5094776">)</span><span class="op" id="5094777">;</span>&nbsp;<span class="op" id="5094779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5094783">rune</span><span class="op" id="5094787">,</span>&nbsp;<span class="ident" id="5094789">n</span>&nbsp;<span class="op" id="5094791">:=</span>&nbsp;<span class="ident" id="5094794">utf8</span><span class="op" id="5094798">.</span><span class="ident" id="5094799">DecodeRune</span><span class="op" id="5094809">(</span><span class="ident" id="5094810">b</span><span class="op" id="5094811">[</span><span class="ident" id="5094812">i</span><span class="op" id="5094813">:</span><span class="op" id="5094814">]</span><span class="op" id="5094815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094819">repl</span>&nbsp;<span class="op" id="5094824">:=</span>&nbsp;<span class="string" id="5094827">&#34;&#34;</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5094832">if</span>&nbsp;<span class="builtintype" id="5094835">rune</span>&nbsp;<span class="op" id="5094840">==</span>&nbsp;<span class="num" id="5094843">0x2028</span>&nbsp;<span class="op" id="5094850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094855">repl</span>&nbsp;<span class="op" id="5094860">=</span>&nbsp;<span class="string" id="5094862">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5094873">}</span>&nbsp;<span class="keyword" id="5094875">else</span>&nbsp;<span class="keyword" id="5094880">if</span>&nbsp;<span class="builtintype" id="5094883">rune</span>&nbsp;<span class="op" id="5094888">==</span>&nbsp;<span class="num" id="5094891">0x2029</span>&nbsp;<span class="op" id="5094898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094903">repl</span>&nbsp;<span class="op" id="5094908">=</span>&nbsp;<span class="string" id="5094910">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5094921">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5094925">if</span>&nbsp;<span class="ident" id="5094928">repl</span>&nbsp;<span class="op" id="5094933">!=</span>&nbsp;<span class="string" id="5094936">&#34;&#34;</span>&nbsp;<span class="op" id="5094939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094944">buf</span><span class="op" id="5094947">.</span><span class="ident" id="5094948">Write</span><span class="op" id="5094953">(</span><span class="ident" id="5094954">b</span><span class="op" id="5094955">[</span><span class="ident" id="5094956">written</span><span class="op" id="5094963">:</span><span class="ident" id="5094964">i</span><span class="op" id="5094965">]</span><span class="op" id="5094966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094971">buf</span><span class="op" id="5094974">.</span><span class="ident" id="5094975">WriteString</span><span class="op" id="5094986">(</span><span class="ident" id="5094987">repl</span><span class="op" id="5094991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5094996">written</span>&nbsp;<span class="op" id="5095004">=</span>&nbsp;<span class="ident" id="5095006">i</span>&nbsp;<span class="op" id="5095008">+</span>&nbsp;<span class="ident" id="5095010">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5095014">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5095018">i</span>&nbsp;<span class="op" id="5095020">+=</span>&nbsp;<span class="ident" id="5095023">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5095026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5095029">if</span>&nbsp;<span class="ident" id="5095032">buf</span><span class="op" id="5095035">.</span><span class="ident" id="5095036">Len</span><span class="op" id="5095039">(</span><span class="op" id="5095040">)</span>&nbsp;<span class="op" id="5095042">!=</span>&nbsp;<span class="num" id="5095045">0</span>&nbsp;<span class="op" id="5095047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5095051">buf</span><span class="op" id="5095054">.</span><span class="ident" id="5095055">Write</span><span class="op" id="5095060">(</span><span class="ident" id="5095061">b</span><span class="op" id="5095062">[</span><span class="ident" id="5095063">written</span><span class="op" id="5095070">:</span><span class="op" id="5095071">]</span><span class="op" id="5095072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5095076">if</span>&nbsp;<span class="ident" id="5095079">pad</span>&nbsp;<span class="op" id="5095083">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5095088">buf</span><span class="op" id="5095091">.</span><span class="ident" id="5095092">WriteByte</span><span class="op" id="5095101">(</span><span class="string" id="5095102">&#39;&nbsp;&#39;</span><span class="op" id="5095105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5095109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5095113">b</span>&nbsp;<span class="op" id="5095115">=</span>&nbsp;<span class="ident" id="5095117">buf</span><span class="op" id="5095120">.</span><span class="ident" id="5095121">Bytes</span><span class="op" id="5095126">(</span><span class="op" id="5095127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5095130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5095133">return</span>&nbsp;<span class="builtintype" id="5095140">string</span><span class="op" id="5095146">(</span><span class="ident" id="5095147">b</span><span class="op" id="5095148">)</span><br>
<span class="lineno">215</span><span class="op" id="5095150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5095153">//&nbsp;jsStrEscaper&nbsp;produces&nbsp;a&nbsp;string&nbsp;that&nbsp;can&nbsp;be&nbsp;included&nbsp;between&nbsp;quotes&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5095226">//&nbsp;JavaScript&nbsp;source,&nbsp;in&nbsp;JavaScript&nbsp;embedded&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;&lt;script&gt;&nbsp;element,</span><br>
<span class="lineno"></span><span class="comment" id="5095301">//&nbsp;or&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;event&nbsp;handler&nbsp;attribute&nbsp;such&nbsp;as&nbsp;onclick.</span><br>
<span class="lineno">220</span><span class="keyword" id="5095360">func</span>&nbsp;<span class="ident" id="5095365">jsStrEscaper</span><span class="op" id="5095377">(</span><span class="ident" id="5095378">args</span>&nbsp;<span class="op" id="5095383">...</span><span class="keyword" id="5095386">interface</span><span class="op" id="5095395">{</span><span class="op" id="5095396">}</span><span class="op" id="5095397">)</span>&nbsp;<span class="builtintype" id="5095399">string</span>&nbsp;<span class="op" id="5095406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5095409">s</span><span class="op" id="5095410">,</span>&nbsp;<span class="ident" id="5095412">t</span>&nbsp;<span class="op" id="5095414">:=</span>&nbsp;<span class="ident" id="5095417">stringify</span><span class="op" id="5095426">(</span><span class="ident" id="5095427">args</span><span class="op" id="5095431">...</span><span class="op" id="5095434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5095437">if</span>&nbsp;<span class="ident" id="5095440">t</span>&nbsp;<span class="op" id="5095442">==</span>&nbsp;<span class="ident" id="5095445">contentTypeJSStr</span>&nbsp;<span class="op" id="5095462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5095466">return</span>&nbsp;<span class="ident" id="5095473">replace</span><span class="op" id="5095480">(</span><span class="ident" id="5095481">s</span><span class="op" id="5095482">,</span>&nbsp;<span class="ident" id="5095484">jsStrNormReplacementTable</span><span class="op" id="5095509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5095512">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5095515">return</span>&nbsp;<span class="ident" id="5095522">replace</span><span class="op" id="5095529">(</span><span class="ident" id="5095530">s</span><span class="op" id="5095531">,</span>&nbsp;<span class="ident" id="5095533">jsStrReplacementTable</span><span class="op" id="5095554">)</span><br>
<span class="lineno"></span><span class="op" id="5095556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5095559">//&nbsp;jsRegexpEscaper&nbsp;behaves&nbsp;like&nbsp;jsStrEscaper&nbsp;but&nbsp;escapes&nbsp;regular&nbsp;expression</span><br>
<span class="lineno"></span><span class="comment" id="5095635">//&nbsp;specials&nbsp;so&nbsp;the&nbsp;result&nbsp;is&nbsp;treated&nbsp;literally&nbsp;when&nbsp;included&nbsp;in&nbsp;a&nbsp;regular</span><br>
<span class="lineno">230</span><span class="comment" id="5095709">//&nbsp;expression&nbsp;literal.&nbsp;/foo{{.X}}bar/&nbsp;matches&nbsp;the&nbsp;string&nbsp;&#34;foo&#34;&nbsp;followed&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5095784">//&nbsp;the&nbsp;literal&nbsp;text&nbsp;of&nbsp;{{.X}}&nbsp;followed&nbsp;by&nbsp;the&nbsp;string&nbsp;&#34;bar&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5095844">func</span>&nbsp;<span class="ident" id="5095849">jsRegexpEscaper</span><span class="op" id="5095864">(</span><span class="ident" id="5095865">args</span>&nbsp;<span class="op" id="5095870">...</span><span class="keyword" id="5095873">interface</span><span class="op" id="5095882">{</span><span class="op" id="5095883">}</span><span class="op" id="5095884">)</span>&nbsp;<span class="builtintype" id="5095886">string</span>&nbsp;<span class="op" id="5095893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5095896">s</span><span class="op" id="5095897">,</span>&nbsp;<span class="ident" id="5095899">_</span>&nbsp;<span class="op" id="5095901">:=</span>&nbsp;<span class="ident" id="5095904">stringify</span><span class="op" id="5095913">(</span><span class="ident" id="5095914">args</span><span class="op" id="5095918">...</span><span class="op" id="5095921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5095924">s</span>&nbsp;<span class="op" id="5095926">=</span>&nbsp;<span class="ident" id="5095928">replace</span><span class="op" id="5095935">(</span><span class="ident" id="5095936">s</span><span class="op" id="5095937">,</span>&nbsp;<span class="ident" id="5095939">jsRegexpReplacementTable</span><span class="op" id="5095963">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5095966">if</span>&nbsp;<span class="ident" id="5095969">s</span>&nbsp;<span class="op" id="5095971">==</span>&nbsp;<span class="string" id="5095974">&#34;&#34;</span>&nbsp;<span class="op" id="5095977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5095981">//&nbsp;/{{.X}}/&nbsp;should&nbsp;not&nbsp;produce&nbsp;a&nbsp;line&nbsp;comment&nbsp;when&nbsp;.X&nbsp;==&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096044">return</span>&nbsp;<span class="string" id="5096051">&#34;(?:)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5096059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096062">return</span>&nbsp;<span class="ident" id="5096069">s</span><br>
<span class="lineno">240</span><span class="op" id="5096071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5096074">//&nbsp;replace&nbsp;replaces&nbsp;each&nbsp;rune&nbsp;r&nbsp;of&nbsp;s&nbsp;with&nbsp;replacementTable[r],&nbsp;provided&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5096151">//&nbsp;r&nbsp;&lt;&nbsp;len(replacementTable).&nbsp;If&nbsp;replacementTable[r]&nbsp;is&nbsp;the&nbsp;empty&nbsp;string&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5096229">//&nbsp;no&nbsp;replacement&nbsp;is&nbsp;made.</span><br>
<span class="lineno">245</span><span class="comment" id="5096256">//&nbsp;It&nbsp;also&nbsp;replaces&nbsp;runes&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;with&nbsp;the&nbsp;raw&nbsp;strings&nbsp;`\u2028`&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5096334">//&nbsp;`\u2029`.</span><br>
<span class="lineno"></span><span class="keyword" id="5096347">func</span>&nbsp;<span class="ident" id="5096352">replace</span><span class="op" id="5096359">(</span><span class="ident" id="5096360">s</span>&nbsp;<span class="builtintype" id="5096362">string</span><span class="op" id="5096368">,</span>&nbsp;<span class="ident" id="5096370">replacementTable</span>&nbsp;<span class="op" id="5096387">[</span><span class="op" id="5096388">]</span><span class="builtintype" id="5096389">string</span><span class="op" id="5096395">)</span>&nbsp;<span class="builtintype" id="5096397">string</span>&nbsp;<span class="op" id="5096404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096407">var</span>&nbsp;<span class="ident" id="5096411">b</span>&nbsp;<span class="ident" id="5096413">bytes</span><span class="op" id="5096418">.</span><span class="ident" id="5096419">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5096427">written</span>&nbsp;<span class="op" id="5096435">:=</span>&nbsp;<span class="num" id="5096438">0</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096441">for</span>&nbsp;<span class="ident" id="5096445">i</span><span class="op" id="5096446">,</span>&nbsp;<span class="ident" id="5096448">r</span>&nbsp;<span class="op" id="5096450">:=</span>&nbsp;<span class="keyword" id="5096453">range</span>&nbsp;<span class="ident" id="5096459">s</span>&nbsp;<span class="op" id="5096461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096465">var</span>&nbsp;<span class="ident" id="5096469">repl</span>&nbsp;<span class="builtintype" id="5096474">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096483">switch</span>&nbsp;<span class="op" id="5096490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096494">case</span>&nbsp;<span class="builtintype" id="5096499">int</span><span class="op" id="5096502">(</span><span class="ident" id="5096503">r</span><span class="op" id="5096504">)</span>&nbsp;<span class="op" id="5096506">&lt;</span>&nbsp;<span class="builtinfunc" id="5096508">len</span><span class="op" id="5096511">(</span><span class="ident" id="5096512">replacementTable</span><span class="op" id="5096528">)</span>&nbsp;<span class="op" id="5096530">&amp;&amp;</span>&nbsp;<span class="ident" id="5096533">replacementTable</span><span class="op" id="5096549">[</span><span class="ident" id="5096550">r</span><span class="op" id="5096551">]</span>&nbsp;<span class="op" id="5096553">!=</span>&nbsp;<span class="string" id="5096556">&#34;&#34;</span><span class="op" id="5096558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5096563">repl</span>&nbsp;<span class="op" id="5096568">=</span>&nbsp;<span class="ident" id="5096570">replacementTable</span><span class="op" id="5096586">[</span><span class="ident" id="5096587">r</span><span class="op" id="5096588">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096592">case</span>&nbsp;<span class="ident" id="5096597">r</span>&nbsp;<span class="op" id="5096599">==</span>&nbsp;<span class="string" id="5096602">&#39;\u2028&#39;</span><span class="op" id="5096610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5096615">repl</span>&nbsp;<span class="op" id="5096620">=</span>&nbsp;<span class="string" id="5096622">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096633">case</span>&nbsp;<span class="ident" id="5096638">r</span>&nbsp;<span class="op" id="5096640">==</span>&nbsp;<span class="string" id="5096643">&#39;\u2029&#39;</span><span class="op" id="5096651">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5096656">repl</span>&nbsp;<span class="op" id="5096661">=</span>&nbsp;<span class="string" id="5096663">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096674">default</span><span class="op" id="5096681">:</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096686">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5096697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5096701">b</span><span class="op" id="5096702">.</span><span class="ident" id="5096703">WriteString</span><span class="op" id="5096714">(</span><span class="ident" id="5096715">s</span><span class="op" id="5096716">[</span><span class="ident" id="5096717">written</span><span class="op" id="5096724">:</span><span class="ident" id="5096725">i</span><span class="op" id="5096726">]</span><span class="op" id="5096727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5096731">b</span><span class="op" id="5096732">.</span><span class="ident" id="5096733">WriteString</span><span class="op" id="5096744">(</span><span class="ident" id="5096745">repl</span><span class="op" id="5096749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5096753">written</span>&nbsp;<span class="op" id="5096761">=</span>&nbsp;<span class="ident" id="5096763">i</span>&nbsp;<span class="op" id="5096765">+</span>&nbsp;<span class="ident" id="5096767">utf8</span><span class="op" id="5096771">.</span><span class="ident" id="5096772">RuneLen</span><span class="op" id="5096779">(</span><span class="ident" id="5096780">r</span><span class="op" id="5096781">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5096784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096787">if</span>&nbsp;<span class="ident" id="5096790">written</span>&nbsp;<span class="op" id="5096798">==</span>&nbsp;<span class="num" id="5096801">0</span>&nbsp;<span class="op" id="5096803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096807">return</span>&nbsp;<span class="ident" id="5096814">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5096817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5096820">b</span><span class="op" id="5096821">.</span><span class="ident" id="5096822">WriteString</span><span class="op" id="5096833">(</span><span class="ident" id="5096834">s</span><span class="op" id="5096835">[</span><span class="ident" id="5096836">written</span><span class="op" id="5096843">:</span><span class="op" id="5096844">]</span><span class="op" id="5096845">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5096848">return</span>&nbsp;<span class="ident" id="5096855">b</span><span class="op" id="5096856">.</span><span class="ident" id="5096857">String</span><span class="op" id="5096863">(</span><span class="op" id="5096864">)</span><br>
<span class="lineno"></span><span class="op" id="5096866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5096869">var</span>&nbsp;<span class="ident" id="5096873">jsStrReplacementTable</span>&nbsp;<span class="op" id="5096895">=</span>&nbsp;<span class="op" id="5096897">[</span><span class="op" id="5096898">]</span><span class="builtintype" id="5096899">string</span><span class="op" id="5096905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5096908">0</span><span class="op" id="5096909">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5096914">`\0`</span><span class="op" id="5096918">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5096921">&#39;\t&#39;</span><span class="op" id="5096925">:</span>&nbsp;<span class="string" id="5096927">`\t`</span><span class="op" id="5096931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5096934">&#39;\n&#39;</span><span class="op" id="5096938">:</span>&nbsp;<span class="string" id="5096940">`\n`</span><span class="op" id="5096944">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5096947">&#39;\v&#39;</span><span class="op" id="5096951">:</span>&nbsp;<span class="string" id="5096953">`\x0b`</span><span class="op" id="5096959">,</span>&nbsp;<span class="comment" id="5096961">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5096986">&#39;\f&#39;</span><span class="op" id="5096990">:</span>&nbsp;<span class="string" id="5096992">`\f`</span><span class="op" id="5096996">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5096999">&#39;\r&#39;</span><span class="op" id="5097003">:</span>&nbsp;<span class="string" id="5097005">`\r`</span><span class="op" id="5097009">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5097012">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5097074">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097123">&#39;&#34;&#39;</span><span class="op" id="5097126">:</span>&nbsp;&nbsp;<span class="string" id="5097129">`\x22`</span><span class="op" id="5097135">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097138">&#39;&amp;&#39;</span><span class="op" id="5097141">:</span>&nbsp;&nbsp;<span class="string" id="5097144">`\x26`</span><span class="op" id="5097150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097153">&#39;\&#39;&#39;</span><span class="op" id="5097157">:</span>&nbsp;<span class="string" id="5097159">`\x27`</span><span class="op" id="5097165">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097168">&#39;+&#39;</span><span class="op" id="5097171">:</span>&nbsp;&nbsp;<span class="string" id="5097174">`\x2b`</span><span class="op" id="5097180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097183">&#39;/&#39;</span><span class="op" id="5097186">:</span>&nbsp;&nbsp;<span class="string" id="5097189">`\/`</span><span class="op" id="5097193">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097196">&#39;&lt;&#39;</span><span class="op" id="5097199">:</span>&nbsp;&nbsp;<span class="string" id="5097202">`\x3c`</span><span class="op" id="5097208">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097211">&#39;&gt;&#39;</span><span class="op" id="5097214">:</span>&nbsp;&nbsp;<span class="string" id="5097217">`\x3e`</span><span class="op" id="5097223">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097226">&#39;\\&#39;</span><span class="op" id="5097230">:</span>&nbsp;<span class="string" id="5097232">`\\`</span><span class="op" id="5097236">,</span><br>
<span class="lineno">290</span><span class="op" id="5097238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5097241">//&nbsp;jsStrNormReplacementTable&nbsp;is&nbsp;like&nbsp;jsStrReplacementTable&nbsp;but&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5097313">//&nbsp;overencode&nbsp;existing&nbsp;escapes&nbsp;since&nbsp;this&nbsp;table&nbsp;has&nbsp;no&nbsp;entry&nbsp;for&nbsp;`\`.</span><br>
<span class="lineno"></span><span class="keyword" id="5097383">var</span>&nbsp;<span class="ident" id="5097387">jsStrNormReplacementTable</span>&nbsp;<span class="op" id="5097413">=</span>&nbsp;<span class="op" id="5097415">[</span><span class="op" id="5097416">]</span><span class="builtintype" id="5097417">string</span><span class="op" id="5097423">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5097426">0</span><span class="op" id="5097427">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097432">`\0`</span><span class="op" id="5097436">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097439">&#39;\t&#39;</span><span class="op" id="5097443">:</span>&nbsp;<span class="string" id="5097445">`\t`</span><span class="op" id="5097449">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097452">&#39;\n&#39;</span><span class="op" id="5097456">:</span>&nbsp;<span class="string" id="5097458">`\n`</span><span class="op" id="5097462">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097465">&#39;\v&#39;</span><span class="op" id="5097469">:</span>&nbsp;<span class="string" id="5097471">`\x0b`</span><span class="op" id="5097477">,</span>&nbsp;<span class="comment" id="5097479">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097504">&#39;\f&#39;</span><span class="op" id="5097508">:</span>&nbsp;<span class="string" id="5097510">`\f`</span><span class="op" id="5097514">,</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097517">&#39;\r&#39;</span><span class="op" id="5097521">:</span>&nbsp;<span class="string" id="5097523">`\r`</span><span class="op" id="5097527">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5097530">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5097592">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097641">&#39;&#34;&#39;</span><span class="op" id="5097644">:</span>&nbsp;&nbsp;<span class="string" id="5097647">`\x22`</span><span class="op" id="5097653">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097656">&#39;&amp;&#39;</span><span class="op" id="5097659">:</span>&nbsp;&nbsp;<span class="string" id="5097662">`\x26`</span><span class="op" id="5097668">,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097671">&#39;\&#39;&#39;</span><span class="op" id="5097675">:</span>&nbsp;<span class="string" id="5097677">`\x27`</span><span class="op" id="5097683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097686">&#39;+&#39;</span><span class="op" id="5097689">:</span>&nbsp;&nbsp;<span class="string" id="5097692">`\x2b`</span><span class="op" id="5097698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097701">&#39;/&#39;</span><span class="op" id="5097704">:</span>&nbsp;&nbsp;<span class="string" id="5097707">`\/`</span><span class="op" id="5097711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097714">&#39;&lt;&#39;</span><span class="op" id="5097717">:</span>&nbsp;&nbsp;<span class="string" id="5097720">`\x3c`</span><span class="op" id="5097726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097729">&#39;&gt;&#39;</span><span class="op" id="5097732">:</span>&nbsp;&nbsp;<span class="string" id="5097735">`\x3e`</span><span class="op" id="5097741">,</span><br>
<span class="lineno">310</span><span class="op" id="5097743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5097746">var</span>&nbsp;<span class="ident" id="5097750">jsRegexpReplacementTable</span>&nbsp;<span class="op" id="5097775">=</span>&nbsp;<span class="op" id="5097777">[</span><span class="op" id="5097778">]</span><span class="builtintype" id="5097779">string</span><span class="op" id="5097785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5097788">0</span><span class="op" id="5097789">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097794">`\0`</span><span class="op" id="5097798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097801">&#39;\t&#39;</span><span class="op" id="5097805">:</span>&nbsp;<span class="string" id="5097807">`\t`</span><span class="op" id="5097811">,</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097814">&#39;\n&#39;</span><span class="op" id="5097818">:</span>&nbsp;<span class="string" id="5097820">`\n`</span><span class="op" id="5097824">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097827">&#39;\v&#39;</span><span class="op" id="5097831">:</span>&nbsp;<span class="string" id="5097833">`\x0b`</span><span class="op" id="5097839">,</span>&nbsp;<span class="comment" id="5097841">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097866">&#39;\f&#39;</span><span class="op" id="5097870">:</span>&nbsp;<span class="string" id="5097872">`\f`</span><span class="op" id="5097876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5097879">&#39;\r&#39;</span><span class="op" id="5097883">:</span>&nbsp;<span class="string" id="5097885">`\r`</span><span class="op" id="5097889">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5097892">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5097954">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098003">&#39;&#34;&#39;</span><span class="op" id="5098006">:</span>&nbsp;&nbsp;<span class="string" id="5098009">`\x22`</span><span class="op" id="5098015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098018">&#39;$&#39;</span><span class="op" id="5098021">:</span>&nbsp;&nbsp;<span class="string" id="5098024">`\$`</span><span class="op" id="5098028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098031">&#39;&amp;&#39;</span><span class="op" id="5098034">:</span>&nbsp;&nbsp;<span class="string" id="5098037">`\x26`</span><span class="op" id="5098043">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098046">&#39;\&#39;&#39;</span><span class="op" id="5098050">:</span>&nbsp;<span class="string" id="5098052">`\x27`</span><span class="op" id="5098058">,</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098061">&#39;(&#39;</span><span class="op" id="5098064">:</span>&nbsp;&nbsp;<span class="string" id="5098067">`\(`</span><span class="op" id="5098071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098074">&#39;)&#39;</span><span class="op" id="5098077">:</span>&nbsp;&nbsp;<span class="string" id="5098080">`\)`</span><span class="op" id="5098084">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098087">&#39;*&#39;</span><span class="op" id="5098090">:</span>&nbsp;&nbsp;<span class="string" id="5098093">`\*`</span><span class="op" id="5098097">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098100">&#39;+&#39;</span><span class="op" id="5098103">:</span>&nbsp;&nbsp;<span class="string" id="5098106">`\x2b`</span><span class="op" id="5098112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098115">&#39;-&#39;</span><span class="op" id="5098118">:</span>&nbsp;&nbsp;<span class="string" id="5098121">`\-`</span><span class="op" id="5098125">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098128">&#39;.&#39;</span><span class="op" id="5098131">:</span>&nbsp;&nbsp;<span class="string" id="5098134">`\.`</span><span class="op" id="5098138">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098141">&#39;/&#39;</span><span class="op" id="5098144">:</span>&nbsp;&nbsp;<span class="string" id="5098147">`\/`</span><span class="op" id="5098151">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098154">&#39;&lt;&#39;</span><span class="op" id="5098157">:</span>&nbsp;&nbsp;<span class="string" id="5098160">`\x3c`</span><span class="op" id="5098166">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098169">&#39;&gt;&#39;</span><span class="op" id="5098172">:</span>&nbsp;&nbsp;<span class="string" id="5098175">`\x3e`</span><span class="op" id="5098181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098184">&#39;?&#39;</span><span class="op" id="5098187">:</span>&nbsp;&nbsp;<span class="string" id="5098190">`\?`</span><span class="op" id="5098194">,</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098197">&#39;[&#39;</span><span class="op" id="5098200">:</span>&nbsp;&nbsp;<span class="string" id="5098203">`\[`</span><span class="op" id="5098207">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098210">&#39;\\&#39;</span><span class="op" id="5098214">:</span>&nbsp;<span class="string" id="5098216">`\\`</span><span class="op" id="5098220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098223">&#39;]&#39;</span><span class="op" id="5098226">:</span>&nbsp;&nbsp;<span class="string" id="5098229">`\]`</span><span class="op" id="5098233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098236">&#39;^&#39;</span><span class="op" id="5098239">:</span>&nbsp;&nbsp;<span class="string" id="5098242">`\^`</span><span class="op" id="5098246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098249">&#39;{&#39;</span><span class="op" id="5098252">:</span>&nbsp;&nbsp;<span class="string" id="5098255">`\{`</span><span class="op" id="5098259">,</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098262">&#39;|&#39;</span><span class="op" id="5098265">:</span>&nbsp;&nbsp;<span class="string" id="5098268">`\|`</span><span class="op" id="5098272">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5098275">&#39;}&#39;</span><span class="op" id="5098278">:</span>&nbsp;&nbsp;<span class="string" id="5098281">`\}`</span><span class="op" id="5098285">,</span><br>
<span class="lineno"></span><span class="op" id="5098287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5098290">//&nbsp;isJSIdentPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;given&nbsp;rune&nbsp;is&nbsp;a&nbsp;JS&nbsp;identifier&nbsp;part.</span><br>
<span class="lineno">345</span><span class="comment" id="5098363">//&nbsp;It&nbsp;does&nbsp;not&nbsp;handle&nbsp;all&nbsp;the&nbsp;non-Latin&nbsp;letters,&nbsp;joiners,&nbsp;and&nbsp;combining&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="5098442">//&nbsp;but&nbsp;it&nbsp;does&nbsp;handle&nbsp;every&nbsp;codepoint&nbsp;that&nbsp;can&nbsp;occur&nbsp;in&nbsp;a&nbsp;numeric&nbsp;literal&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5098519">//&nbsp;a&nbsp;keyword.</span><br>
<span class="lineno"></span><span class="keyword" id="5098533">func</span>&nbsp;<span class="ident" id="5098538">isJSIdentPart</span><span class="op" id="5098551">(</span><span class="ident" id="5098552">r</span>&nbsp;<span class="builtintype" id="5098554">rune</span><span class="op" id="5098558">)</span>&nbsp;<span class="builtintype" id="5098560">bool</span>&nbsp;<span class="op" id="5098565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098568">switch</span>&nbsp;<span class="op" id="5098575">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098578">case</span>&nbsp;<span class="ident" id="5098583">r</span>&nbsp;<span class="op" id="5098585">==</span>&nbsp;<span class="string" id="5098588">&#39;$&#39;</span><span class="op" id="5098591">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098595">return</span>&nbsp;<span class="builtintype" id="5098602">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098608">case</span>&nbsp;<span class="string" id="5098613">&#39;0&#39;</span>&nbsp;<span class="op" id="5098617">&lt;=</span>&nbsp;<span class="ident" id="5098620">r</span>&nbsp;<span class="op" id="5098622">&amp;&amp;</span>&nbsp;<span class="ident" id="5098625">r</span>&nbsp;<span class="op" id="5098627">&lt;=</span>&nbsp;<span class="string" id="5098630">&#39;9&#39;</span><span class="op" id="5098633">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098637">return</span>&nbsp;<span class="builtintype" id="5098644">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098650">case</span>&nbsp;<span class="string" id="5098655">&#39;A&#39;</span>&nbsp;<span class="op" id="5098659">&lt;=</span>&nbsp;<span class="ident" id="5098662">r</span>&nbsp;<span class="op" id="5098664">&amp;&amp;</span>&nbsp;<span class="ident" id="5098667">r</span>&nbsp;<span class="op" id="5098669">&lt;=</span>&nbsp;<span class="string" id="5098672">&#39;Z&#39;</span><span class="op" id="5098675">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098679">return</span>&nbsp;<span class="builtintype" id="5098686">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098692">case</span>&nbsp;<span class="ident" id="5098697">r</span>&nbsp;<span class="op" id="5098699">==</span>&nbsp;<span class="string" id="5098702">&#39;_&#39;</span><span class="op" id="5098705">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098709">return</span>&nbsp;<span class="builtintype" id="5098716">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098722">case</span>&nbsp;<span class="string" id="5098727">&#39;a&#39;</span>&nbsp;<span class="op" id="5098731">&lt;=</span>&nbsp;<span class="ident" id="5098734">r</span>&nbsp;<span class="op" id="5098736">&amp;&amp;</span>&nbsp;<span class="ident" id="5098739">r</span>&nbsp;<span class="op" id="5098741">&lt;=</span>&nbsp;<span class="string" id="5098744">&#39;z&#39;</span><span class="op" id="5098747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098751">return</span>&nbsp;<span class="builtintype" id="5098758">true</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5098764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5098767">return</span>&nbsp;<span class="builtintype" id="5098774">false</span><br>
<span class="lineno"></span><span class="op" id="5098780">}</span>
</div>
</body>
</html>
