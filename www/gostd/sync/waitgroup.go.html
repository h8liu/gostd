<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html" class="current">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1406111">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1406166">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1406220">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1406271">package</span>&nbsp;<span class="ident" id="1406279">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1406285">import</span>&nbsp;<span class="op" id="1406292">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1406295">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1406310">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1406319">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1406322">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1406385">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1406438">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1406494">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1406551">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1406616">type</span>&nbsp;<span class="ident" id="1406621">WaitGroup</span>&nbsp;<span class="keyword" id="1406631">struct</span>&nbsp;<span class="op" id="1406638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1406641">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1406649">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1406656">counter</span>&nbsp;<span class="builtintype" id="1406664">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1406671">waiters</span>&nbsp;<span class="builtintype" id="1406679">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1406686">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1406694">*</span><span class="builtintype" id="1406695">uint32</span><br>
<span class="lineno"></span><span class="op" id="1406702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1406705">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1406770">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1406823">//</span><br>
<span class="lineno"></span><span class="comment" id="1406826">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1406840">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1406855">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1406927">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1407008">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1407074">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1407125">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1407140">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1407215">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1407283">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1407360">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1407405">//</span><br>
<span class="lineno">40</span><span class="comment" id="1407408">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1407485">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1407560">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1407639">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1407655">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1407732">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1407791">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1407821">func</span>&nbsp;<span class="op" id="1407826">(</span><span class="ident" id="1407827">wg</span>&nbsp;<span class="op" id="1407830">*</span><span class="ident" id="1407831">WaitGroup</span><span class="op" id="1407840">)</span>&nbsp;<span class="ident" id="1407842">Add</span><span class="op" id="1407845">(</span><span class="ident" id="1407846">delta</span>&nbsp;<span class="builtintype" id="1407852">int</span><span class="op" id="1407855">)</span>&nbsp;<span class="op" id="1407857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1407860">if</span>&nbsp;<span class="ident" id="1407863">raceenabled</span>&nbsp;<span class="op" id="1407875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1407879">_</span>&nbsp;<span class="op" id="1407881">=</span>&nbsp;<span class="ident" id="1407883">wg</span><span class="op" id="1407885">.</span><span class="ident" id="1407886">m</span><span class="op" id="1407887">.</span><span class="ident" id="1407888">state</span>&nbsp;<span class="comment" id="1407894">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1407923">if</span>&nbsp;<span class="ident" id="1407926">delta</span>&nbsp;<span class="op" id="1407932">&lt;</span>&nbsp;<span class="num" id="1407934">0</span>&nbsp;<span class="op" id="1407936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407941">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1407981">raceReleaseMerge</span><span class="op" id="1407997">(</span><span class="ident" id="1407998">unsafe</span><span class="op" id="1408004">.</span><span class="ident" id="1408005">Pointer</span><span class="op" id="1408012">(</span><span class="ident" id="1408013">wg</span><span class="op" id="1408015">)</span><span class="op" id="1408016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408024">raceDisable</span><span class="op" id="1408035">(</span><span class="op" id="1408036">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408040">defer</span>&nbsp;<span class="ident" id="1408046">raceEnable</span><span class="op" id="1408056">(</span><span class="op" id="1408057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408063">v</span>&nbsp;<span class="op" id="1408065">:=</span>&nbsp;<span class="ident" id="1408068">atomic</span><span class="op" id="1408074">.</span><span class="ident" id="1408075">AddInt32</span><span class="op" id="1408083">(</span><span class="op" id="1408084">&amp;</span><span class="ident" id="1408085">wg</span><span class="op" id="1408087">.</span><span class="ident" id="1408088">counter</span><span class="op" id="1408095">,</span>&nbsp;<span class="builtintype" id="1408097">int32</span><span class="op" id="1408102">(</span><span class="ident" id="1408103">delta</span><span class="op" id="1408108">)</span><span class="op" id="1408109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408112">if</span>&nbsp;<span class="ident" id="1408115">raceenabled</span>&nbsp;<span class="op" id="1408127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408131">if</span>&nbsp;<span class="ident" id="1408134">delta</span>&nbsp;<span class="op" id="1408140">&gt;</span>&nbsp;<span class="num" id="1408142">0</span>&nbsp;<span class="op" id="1408144">&amp;&amp;</span>&nbsp;<span class="ident" id="1408147">v</span>&nbsp;<span class="op" id="1408149">==</span>&nbsp;<span class="builtintype" id="1408152">int32</span><span class="op" id="1408157">(</span><span class="ident" id="1408158">delta</span><span class="op" id="1408163">)</span>&nbsp;<span class="op" id="1408165">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408170">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408228">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408285">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408341">raceRead</span><span class="op" id="1408349">(</span><span class="ident" id="1408350">unsafe</span><span class="op" id="1408356">.</span><span class="ident" id="1408357">Pointer</span><span class="op" id="1408364">(</span><span class="op" id="1408365">&amp;</span><span class="ident" id="1408366">wg</span><span class="op" id="1408368">.</span><span class="ident" id="1408369">sema</span><span class="op" id="1408373">)</span><span class="op" id="1408374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408378">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408384">if</span>&nbsp;<span class="ident" id="1408387">v</span>&nbsp;<span class="op" id="1408389">&lt;</span>&nbsp;<span class="num" id="1408391">0</span>&nbsp;<span class="op" id="1408393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1408397">panic</span><span class="op" id="1408402">(</span><span class="string" id="1408403">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1408437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408443">if</span>&nbsp;<span class="ident" id="1408446">v</span>&nbsp;<span class="op" id="1408448">&gt;</span>&nbsp;<span class="num" id="1408450">0</span>&nbsp;<span class="op" id="1408452">||</span>&nbsp;<span class="ident" id="1408455">atomic</span><span class="op" id="1408461">.</span><span class="ident" id="1408462">LoadInt32</span><span class="op" id="1408471">(</span><span class="op" id="1408472">&amp;</span><span class="ident" id="1408473">wg</span><span class="op" id="1408475">.</span><span class="ident" id="1408476">waiters</span><span class="op" id="1408483">)</span>&nbsp;<span class="op" id="1408485">==</span>&nbsp;<span class="num" id="1408488">0</span>&nbsp;<span class="op" id="1408490">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408494">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408505">wg</span><span class="op" id="1408507">.</span><span class="ident" id="1408508">m</span><span class="op" id="1408509">.</span><span class="ident" id="1408510">Lock</span><span class="op" id="1408514">(</span><span class="op" id="1408515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408518">if</span>&nbsp;<span class="ident" id="1408521">atomic</span><span class="op" id="1408527">.</span><span class="ident" id="1408528">LoadInt32</span><span class="op" id="1408537">(</span><span class="op" id="1408538">&amp;</span><span class="ident" id="1408539">wg</span><span class="op" id="1408541">.</span><span class="ident" id="1408542">counter</span><span class="op" id="1408549">)</span>&nbsp;<span class="op" id="1408551">==</span>&nbsp;<span class="num" id="1408554">0</span>&nbsp;<span class="op" id="1408556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408560">for</span>&nbsp;<span class="ident" id="1408564">i</span>&nbsp;<span class="op" id="1408566">:=</span>&nbsp;<span class="builtintype" id="1408569">int32</span><span class="op" id="1408574">(</span><span class="num" id="1408575">0</span><span class="op" id="1408576">)</span><span class="op" id="1408577">;</span>&nbsp;<span class="ident" id="1408579">i</span>&nbsp;<span class="op" id="1408581">&lt;</span>&nbsp;<span class="ident" id="1408583">wg</span><span class="op" id="1408585">.</span><span class="ident" id="1408586">waiters</span><span class="op" id="1408593">;</span>&nbsp;<span class="ident" id="1408595">i</span><span class="op" id="1408596">++</span>&nbsp;<span class="op" id="1408599">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408604">runtime_Semrelease</span><span class="op" id="1408622">(</span><span class="ident" id="1408623">wg</span><span class="op" id="1408625">.</span><span class="ident" id="1408626">sema</span><span class="op" id="1408630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408638">wg</span><span class="op" id="1408640">.</span><span class="ident" id="1408641">waiters</span>&nbsp;<span class="op" id="1408649">=</span>&nbsp;<span class="num" id="1408651">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408655">wg</span><span class="op" id="1408657">.</span><span class="ident" id="1408658">sema</span>&nbsp;<span class="op" id="1408663">=</span>&nbsp;<span class="ident" id="1408665">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408670">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408673">wg</span><span class="op" id="1408675">.</span><span class="ident" id="1408676">m</span><span class="op" id="1408677">.</span><span class="ident" id="1408678">Unlock</span><span class="op" id="1408684">(</span><span class="op" id="1408685">)</span><br>
<span class="lineno"></span><span class="op" id="1408687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1408690">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1408732">func</span>&nbsp;<span class="op" id="1408737">(</span><span class="ident" id="1408738">wg</span>&nbsp;<span class="op" id="1408741">*</span><span class="ident" id="1408742">WaitGroup</span><span class="op" id="1408751">)</span>&nbsp;<span class="ident" id="1408753">Done</span><span class="op" id="1408757">(</span><span class="op" id="1408758">)</span>&nbsp;<span class="op" id="1408760">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408763">wg</span><span class="op" id="1408765">.</span><span class="ident" id="1408766">Add</span><span class="op" id="1408769">(</span><span class="op" id="1408770">-</span><span class="num" id="1408771">1</span><span class="op" id="1408772">)</span><br>
<span class="lineno"></span><span class="op" id="1408774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1408777">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1408829">func</span>&nbsp;<span class="op" id="1408834">(</span><span class="ident" id="1408835">wg</span>&nbsp;<span class="op" id="1408838">*</span><span class="ident" id="1408839">WaitGroup</span><span class="op" id="1408848">)</span>&nbsp;<span class="ident" id="1408850">Wait</span><span class="op" id="1408854">(</span><span class="op" id="1408855">)</span>&nbsp;<span class="op" id="1408857">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408860">if</span>&nbsp;<span class="ident" id="1408863">raceenabled</span>&nbsp;<span class="op" id="1408875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408879">_</span>&nbsp;<span class="op" id="1408881">=</span>&nbsp;<span class="ident" id="1408883">wg</span><span class="op" id="1408885">.</span><span class="ident" id="1408886">m</span><span class="op" id="1408887">.</span><span class="ident" id="1408888">state</span>&nbsp;<span class="comment" id="1408894">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408923">raceDisable</span><span class="op" id="1408934">(</span><span class="op" id="1408935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408941">if</span>&nbsp;<span class="ident" id="1408944">atomic</span><span class="op" id="1408950">.</span><span class="ident" id="1408951">LoadInt32</span><span class="op" id="1408960">(</span><span class="op" id="1408961">&amp;</span><span class="ident" id="1408962">wg</span><span class="op" id="1408964">.</span><span class="ident" id="1408965">counter</span><span class="op" id="1408972">)</span>&nbsp;<span class="op" id="1408974">==</span>&nbsp;<span class="num" id="1408977">0</span>&nbsp;<span class="op" id="1408979">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408983">if</span>&nbsp;<span class="ident" id="1408986">raceenabled</span>&nbsp;<span class="op" id="1408998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409003">raceEnable</span><span class="op" id="1409013">(</span><span class="op" id="1409014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409019">raceAcquire</span><span class="op" id="1409030">(</span><span class="ident" id="1409031">unsafe</span><span class="op" id="1409037">.</span><span class="ident" id="1409038">Pointer</span><span class="op" id="1409045">(</span><span class="ident" id="1409046">wg</span><span class="op" id="1409048">)</span><span class="op" id="1409049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409057">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409068">wg</span><span class="op" id="1409070">.</span><span class="ident" id="1409071">m</span><span class="op" id="1409072">.</span><span class="ident" id="1409073">Lock</span><span class="op" id="1409077">(</span><span class="op" id="1409078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409081">w</span>&nbsp;<span class="op" id="1409083">:=</span>&nbsp;<span class="ident" id="1409086">atomic</span><span class="op" id="1409092">.</span><span class="ident" id="1409093">AddInt32</span><span class="op" id="1409101">(</span><span class="op" id="1409102">&amp;</span><span class="ident" id="1409103">wg</span><span class="op" id="1409105">.</span><span class="ident" id="1409106">waiters</span><span class="op" id="1409113">,</span>&nbsp;<span class="num" id="1409115">1</span><span class="op" id="1409116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409119">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409180">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409240">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409310">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409339">if</span>&nbsp;<span class="ident" id="1409342">atomic</span><span class="op" id="1409348">.</span><span class="ident" id="1409349">LoadInt32</span><span class="op" id="1409358">(</span><span class="op" id="1409359">&amp;</span><span class="ident" id="1409360">wg</span><span class="op" id="1409362">.</span><span class="ident" id="1409363">counter</span><span class="op" id="1409370">)</span>&nbsp;<span class="op" id="1409372">==</span>&nbsp;<span class="num" id="1409375">0</span>&nbsp;<span class="op" id="1409377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409381">atomic</span><span class="op" id="1409387">.</span><span class="ident" id="1409388">AddInt32</span><span class="op" id="1409396">(</span><span class="op" id="1409397">&amp;</span><span class="ident" id="1409398">wg</span><span class="op" id="1409400">.</span><span class="ident" id="1409401">waiters</span><span class="op" id="1409408">,</span>&nbsp;<span class="op" id="1409410">-</span><span class="num" id="1409411">1</span><span class="op" id="1409412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409416">if</span>&nbsp;<span class="ident" id="1409419">raceenabled</span>&nbsp;<span class="op" id="1409431">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409436">raceEnable</span><span class="op" id="1409446">(</span><span class="op" id="1409447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409452">raceAcquire</span><span class="op" id="1409463">(</span><span class="ident" id="1409464">unsafe</span><span class="op" id="1409470">.</span><span class="ident" id="1409471">Pointer</span><span class="op" id="1409478">(</span><span class="ident" id="1409479">wg</span><span class="op" id="1409481">)</span><span class="op" id="1409482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409487">raceDisable</span><span class="op" id="1409498">(</span><span class="op" id="1409499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409507">wg</span><span class="op" id="1409509">.</span><span class="ident" id="1409510">m</span><span class="op" id="1409511">.</span><span class="ident" id="1409512">Unlock</span><span class="op" id="1409518">(</span><span class="op" id="1409519">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409523">if</span>&nbsp;<span class="ident" id="1409526">raceenabled</span>&nbsp;<span class="op" id="1409538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409543">raceEnable</span><span class="op" id="1409553">(</span><span class="op" id="1409554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409562">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409570">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409573">if</span>&nbsp;<span class="ident" id="1409576">raceenabled</span>&nbsp;<span class="op" id="1409588">&amp;&amp;</span>&nbsp;<span class="ident" id="1409591">w</span>&nbsp;<span class="op" id="1409593">==</span>&nbsp;<span class="num" id="1409596">1</span>&nbsp;<span class="op" id="1409598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409602">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409653">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409721">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409788">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409847">raceWrite</span><span class="op" id="1409856">(</span><span class="ident" id="1409857">unsafe</span><span class="op" id="1409863">.</span><span class="ident" id="1409864">Pointer</span><span class="op" id="1409871">(</span><span class="op" id="1409872">&amp;</span><span class="ident" id="1409873">wg</span><span class="op" id="1409875">.</span><span class="ident" id="1409876">sema</span><span class="op" id="1409880">)</span><span class="op" id="1409881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409887">if</span>&nbsp;<span class="ident" id="1409890">wg</span><span class="op" id="1409892">.</span><span class="ident" id="1409893">sema</span>&nbsp;<span class="op" id="1409898">==</span>&nbsp;<span class="ident" id="1409901">nil</span>&nbsp;<span class="op" id="1409905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409909">wg</span><span class="op" id="1409911">.</span><span class="ident" id="1409912">sema</span>&nbsp;<span class="op" id="1409917">=</span>&nbsp;<span class="builtinfunc" id="1409919">new</span><span class="op" id="1409922">(</span><span class="builtintype" id="1409923">uint32</span><span class="op" id="1409929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409932">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409935">s</span>&nbsp;<span class="op" id="1409937">:=</span>&nbsp;<span class="ident" id="1409940">wg</span><span class="op" id="1409942">.</span><span class="ident" id="1409943">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409949">wg</span><span class="op" id="1409951">.</span><span class="ident" id="1409952">m</span><span class="op" id="1409953">.</span><span class="ident" id="1409954">Unlock</span><span class="op" id="1409960">(</span><span class="op" id="1409961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409964">runtime_Semacquire</span><span class="op" id="1409982">(</span><span class="ident" id="1409983">s</span><span class="op" id="1409984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409987">if</span>&nbsp;<span class="ident" id="1409990">raceenabled</span>&nbsp;<span class="op" id="1410002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410006">raceEnable</span><span class="op" id="1410016">(</span><span class="op" id="1410017">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410021">raceAcquire</span><span class="op" id="1410032">(</span><span class="ident" id="1410033">unsafe</span><span class="op" id="1410039">.</span><span class="ident" id="1410040">Pointer</span><span class="op" id="1410047">(</span><span class="ident" id="1410048">wg</span><span class="op" id="1410050">)</span><span class="op" id="1410051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410054">}</span><br>
<span class="lineno"></span><span class="op" id="1410056">}</span>
</div>
</body>
</html>
