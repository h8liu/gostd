<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1445434">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1445489">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1445543">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1445594">package</span>&nbsp;<span class="ident" id="1445602">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1445608">import</span>&nbsp;<span class="op" id="1445615">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1445618">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1445633">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1445642">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1445645">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1445701">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1445759">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1445782">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1445827">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1445874">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1445896">type</span>&nbsp;<span class="ident" id="1445901">RWMutex</span>&nbsp;<span class="keyword" id="1445909">struct</span>&nbsp;<span class="op" id="1445916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445919">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445931">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1445938">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445976">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1445988">uint32</span>&nbsp;<span class="comment" id="1445995">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446052">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1446064">uint32</span>&nbsp;<span class="comment" id="1446071">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446128">readerCount</span>&nbsp;<span class="builtintype" id="1446140">int32</span>&nbsp;&nbsp;<span class="comment" id="1446147">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446177">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1446189">int32</span>&nbsp;&nbsp;<span class="comment" id="1446196">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1446227">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1446230">const</span>&nbsp;<span class="ident" id="1446236">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1446254">=</span>&nbsp;<span class="num" id="1446256">1</span>&nbsp;<span class="op" id="1446258">&lt;&lt;</span>&nbsp;<span class="num" id="1446261">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1446265">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1446296">func</span>&nbsp;<span class="op" id="1446301">(</span><span class="ident" id="1446302">rw</span>&nbsp;<span class="op" id="1446305">*</span><span class="ident" id="1446306">RWMutex</span><span class="op" id="1446313">)</span>&nbsp;<span class="ident" id="1446315">RLock</span><span class="op" id="1446320">(</span><span class="op" id="1446321">)</span>&nbsp;<span class="op" id="1446323">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446326">if</span>&nbsp;<span class="ident" id="1446329">raceenabled</span>&nbsp;<span class="op" id="1446341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446345">_</span>&nbsp;<span class="op" id="1446347">=</span>&nbsp;<span class="ident" id="1446349">rw</span><span class="op" id="1446351">.</span><span class="ident" id="1446352">w</span><span class="op" id="1446353">.</span><span class="ident" id="1446354">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446362">raceDisable</span><span class="op" id="1446373">(</span><span class="op" id="1446374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446380">if</span>&nbsp;<span class="ident" id="1446383">atomic</span><span class="op" id="1446389">.</span><span class="ident" id="1446390">AddInt32</span><span class="op" id="1446398">(</span><span class="op" id="1446399">&amp;</span><span class="ident" id="1446400">rw</span><span class="op" id="1446402">.</span><span class="ident" id="1446403">readerCount</span><span class="op" id="1446414">,</span>&nbsp;<span class="num" id="1446416">1</span><span class="op" id="1446417">)</span>&nbsp;<span class="op" id="1446419">&lt;</span>&nbsp;<span class="num" id="1446421">0</span>&nbsp;<span class="op" id="1446423">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1446427">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446466">runtime_Semacquire</span><span class="op" id="1446484">(</span><span class="op" id="1446485">&amp;</span><span class="ident" id="1446486">rw</span><span class="op" id="1446488">.</span><span class="ident" id="1446489">readerSem</span><span class="op" id="1446498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446504">if</span>&nbsp;<span class="ident" id="1446507">raceenabled</span>&nbsp;<span class="op" id="1446519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446523">raceEnable</span><span class="op" id="1446533">(</span><span class="op" id="1446534">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446538">raceAcquire</span><span class="op" id="1446549">(</span><span class="ident" id="1446550">unsafe</span><span class="op" id="1446556">.</span><span class="ident" id="1446557">Pointer</span><span class="op" id="1446564">(</span><span class="op" id="1446565">&amp;</span><span class="ident" id="1446566">rw</span><span class="op" id="1446568">.</span><span class="ident" id="1446569">readerSem</span><span class="op" id="1446578">)</span><span class="op" id="1446579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446582">}</span><br>
<span class="lineno"></span><span class="op" id="1446584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1446587">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1446626">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1446676">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1446734">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1446758">func</span>&nbsp;<span class="op" id="1446763">(</span><span class="ident" id="1446764">rw</span>&nbsp;<span class="op" id="1446767">*</span><span class="ident" id="1446768">RWMutex</span><span class="op" id="1446775">)</span>&nbsp;<span class="ident" id="1446777">RUnlock</span><span class="op" id="1446784">(</span><span class="op" id="1446785">)</span>&nbsp;<span class="op" id="1446787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446790">if</span>&nbsp;<span class="ident" id="1446793">raceenabled</span>&nbsp;<span class="op" id="1446805">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446809">_</span>&nbsp;<span class="op" id="1446811">=</span>&nbsp;<span class="ident" id="1446813">rw</span><span class="op" id="1446815">.</span><span class="ident" id="1446816">w</span><span class="op" id="1446817">.</span><span class="ident" id="1446818">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446826">raceReleaseMerge</span><span class="op" id="1446842">(</span><span class="ident" id="1446843">unsafe</span><span class="op" id="1446849">.</span><span class="ident" id="1446850">Pointer</span><span class="op" id="1446857">(</span><span class="op" id="1446858">&amp;</span><span class="ident" id="1446859">rw</span><span class="op" id="1446861">.</span><span class="ident" id="1446862">writerSem</span><span class="op" id="1446871">)</span><span class="op" id="1446872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446876">raceDisable</span><span class="op" id="1446887">(</span><span class="op" id="1446888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446894">if</span>&nbsp;<span class="ident" id="1446897">r</span>&nbsp;<span class="op" id="1446899">:=</span>&nbsp;<span class="ident" id="1446902">atomic</span><span class="op" id="1446908">.</span><span class="ident" id="1446909">AddInt32</span><span class="op" id="1446917">(</span><span class="op" id="1446918">&amp;</span><span class="ident" id="1446919">rw</span><span class="op" id="1446921">.</span><span class="ident" id="1446922">readerCount</span><span class="op" id="1446933">,</span>&nbsp;<span class="op" id="1446935">-</span><span class="num" id="1446936">1</span><span class="op" id="1446937">)</span><span class="op" id="1446938">;</span>&nbsp;<span class="ident" id="1446940">r</span>&nbsp;<span class="op" id="1446942">&lt;</span>&nbsp;<span class="num" id="1446944">0</span>&nbsp;<span class="op" id="1446946">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446950">if</span>&nbsp;<span class="ident" id="1446953">r</span><span class="op" id="1446954">+</span><span class="num" id="1446955">1</span>&nbsp;<span class="op" id="1446957">==</span>&nbsp;<span class="num" id="1446960">0</span>&nbsp;<span class="op" id="1446962">||</span>&nbsp;<span class="ident" id="1446965">r</span><span class="op" id="1446966">+</span><span class="num" id="1446967">1</span>&nbsp;<span class="op" id="1446969">==</span>&nbsp;<span class="op" id="1446972">-</span><span class="ident" id="1446973">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1446991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446996">raceEnable</span><span class="op" id="1447006">(</span><span class="op" id="1447007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1447012">panic</span><span class="op" id="1447017">(</span><span class="string" id="1447018">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1447053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1447061">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447087">if</span>&nbsp;<span class="ident" id="1447090">atomic</span><span class="op" id="1447096">.</span><span class="ident" id="1447097">AddInt32</span><span class="op" id="1447105">(</span><span class="op" id="1447106">&amp;</span><span class="ident" id="1447107">rw</span><span class="op" id="1447109">.</span><span class="ident" id="1447110">readerWait</span><span class="op" id="1447120">,</span>&nbsp;<span class="op" id="1447122">-</span><span class="num" id="1447123">1</span><span class="op" id="1447124">)</span>&nbsp;<span class="op" id="1447126">==</span>&nbsp;<span class="num" id="1447129">0</span>&nbsp;<span class="op" id="1447131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1447136">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447179">runtime_Semrelease</span><span class="op" id="1447197">(</span><span class="op" id="1447198">&amp;</span><span class="ident" id="1447199">rw</span><span class="op" id="1447201">.</span><span class="ident" id="1447202">writerSem</span><span class="op" id="1447211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447218">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447221">if</span>&nbsp;<span class="ident" id="1447224">raceenabled</span>&nbsp;<span class="op" id="1447236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447240">raceEnable</span><span class="op" id="1447250">(</span><span class="op" id="1447251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447254">}</span><br>
<span class="lineno"></span><span class="op" id="1447256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1447259">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1447289">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1447346">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1447390">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1447447">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1447506">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1447519">func</span>&nbsp;<span class="op" id="1447524">(</span><span class="ident" id="1447525">rw</span>&nbsp;<span class="op" id="1447528">*</span><span class="ident" id="1447529">RWMutex</span><span class="op" id="1447536">)</span>&nbsp;<span class="ident" id="1447538">Lock</span><span class="op" id="1447542">(</span><span class="op" id="1447543">)</span>&nbsp;<span class="op" id="1447545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447548">if</span>&nbsp;<span class="ident" id="1447551">raceenabled</span>&nbsp;<span class="op" id="1447563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447567">_</span>&nbsp;<span class="op" id="1447569">=</span>&nbsp;<span class="ident" id="1447571">rw</span><span class="op" id="1447573">.</span><span class="ident" id="1447574">w</span><span class="op" id="1447575">.</span><span class="ident" id="1447576">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447584">raceDisable</span><span class="op" id="1447595">(</span><span class="op" id="1447596">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1447602">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447653">rw</span><span class="op" id="1447655">.</span><span class="ident" id="1447656">w</span><span class="op" id="1447657">.</span><span class="ident" id="1447658">Lock</span><span class="op" id="1447662">(</span><span class="op" id="1447663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1447666">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447717">r</span>&nbsp;<span class="op" id="1447719">:=</span>&nbsp;<span class="ident" id="1447722">atomic</span><span class="op" id="1447728">.</span><span class="ident" id="1447729">AddInt32</span><span class="op" id="1447737">(</span><span class="op" id="1447738">&amp;</span><span class="ident" id="1447739">rw</span><span class="op" id="1447741">.</span><span class="ident" id="1447742">readerCount</span><span class="op" id="1447753">,</span>&nbsp;<span class="op" id="1447755">-</span><span class="ident" id="1447756">rwmutexMaxReaders</span><span class="op" id="1447773">)</span>&nbsp;<span class="op" id="1447775">+</span>&nbsp;<span class="ident" id="1447777">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1447796">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447825">if</span>&nbsp;<span class="ident" id="1447828">r</span>&nbsp;<span class="op" id="1447830">!=</span>&nbsp;<span class="num" id="1447833">0</span>&nbsp;<span class="op" id="1447835">&amp;&amp;</span>&nbsp;<span class="ident" id="1447838">atomic</span><span class="op" id="1447844">.</span><span class="ident" id="1447845">AddInt32</span><span class="op" id="1447853">(</span><span class="op" id="1447854">&amp;</span><span class="ident" id="1447855">rw</span><span class="op" id="1447857">.</span><span class="ident" id="1447858">readerWait</span><span class="op" id="1447868">,</span>&nbsp;<span class="ident" id="1447870">r</span><span class="op" id="1447871">)</span>&nbsp;<span class="op" id="1447873">!=</span>&nbsp;<span class="num" id="1447876">0</span>&nbsp;<span class="op" id="1447878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447882">runtime_Semacquire</span><span class="op" id="1447900">(</span><span class="op" id="1447901">&amp;</span><span class="ident" id="1447902">rw</span><span class="op" id="1447904">.</span><span class="ident" id="1447905">writerSem</span><span class="op" id="1447914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447920">if</span>&nbsp;<span class="ident" id="1447923">raceenabled</span>&nbsp;<span class="op" id="1447935">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447939">raceEnable</span><span class="op" id="1447949">(</span><span class="op" id="1447950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447954">raceAcquire</span><span class="op" id="1447965">(</span><span class="ident" id="1447966">unsafe</span><span class="op" id="1447972">.</span><span class="ident" id="1447973">Pointer</span><span class="op" id="1447980">(</span><span class="op" id="1447981">&amp;</span><span class="ident" id="1447982">rw</span><span class="op" id="1447984">.</span><span class="ident" id="1447985">readerSem</span><span class="op" id="1447994">)</span><span class="op" id="1447995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447999">raceAcquire</span><span class="op" id="1448010">(</span><span class="ident" id="1448011">unsafe</span><span class="op" id="1448017">.</span><span class="ident" id="1448018">Pointer</span><span class="op" id="1448025">(</span><span class="op" id="1448026">&amp;</span><span class="ident" id="1448027">rw</span><span class="op" id="1448029">.</span><span class="ident" id="1448030">writerSem</span><span class="op" id="1448039">)</span><span class="op" id="1448040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448043">}</span><br>
<span class="lineno"></span><span class="op" id="1448045">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1448048">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1448115">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1448161">//</span><br>
<span class="lineno"></span><span class="comment" id="1448164">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1448237">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1448303">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1448360">func</span>&nbsp;<span class="op" id="1448365">(</span><span class="ident" id="1448366">rw</span>&nbsp;<span class="op" id="1448369">*</span><span class="ident" id="1448370">RWMutex</span><span class="op" id="1448377">)</span>&nbsp;<span class="ident" id="1448379">Unlock</span><span class="op" id="1448385">(</span><span class="op" id="1448386">)</span>&nbsp;<span class="op" id="1448388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448391">if</span>&nbsp;<span class="ident" id="1448394">raceenabled</span>&nbsp;<span class="op" id="1448406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448410">_</span>&nbsp;<span class="op" id="1448412">=</span>&nbsp;<span class="ident" id="1448414">rw</span><span class="op" id="1448416">.</span><span class="ident" id="1448417">w</span><span class="op" id="1448418">.</span><span class="ident" id="1448419">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448427">raceRelease</span><span class="op" id="1448438">(</span><span class="ident" id="1448439">unsafe</span><span class="op" id="1448445">.</span><span class="ident" id="1448446">Pointer</span><span class="op" id="1448453">(</span><span class="op" id="1448454">&amp;</span><span class="ident" id="1448455">rw</span><span class="op" id="1448457">.</span><span class="ident" id="1448458">readerSem</span><span class="op" id="1448467">)</span><span class="op" id="1448468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448472">raceRelease</span><span class="op" id="1448483">(</span><span class="ident" id="1448484">unsafe</span><span class="op" id="1448490">.</span><span class="ident" id="1448491">Pointer</span><span class="op" id="1448498">(</span><span class="op" id="1448499">&amp;</span><span class="ident" id="1448500">rw</span><span class="op" id="1448502">.</span><span class="ident" id="1448503">writerSem</span><span class="op" id="1448512">)</span><span class="op" id="1448513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448517">raceDisable</span><span class="op" id="1448528">(</span><span class="op" id="1448529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448536">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448587">r</span>&nbsp;<span class="op" id="1448589">:=</span>&nbsp;<span class="ident" id="1448592">atomic</span><span class="op" id="1448598">.</span><span class="ident" id="1448599">AddInt32</span><span class="op" id="1448607">(</span><span class="op" id="1448608">&amp;</span><span class="ident" id="1448609">rw</span><span class="op" id="1448611">.</span><span class="ident" id="1448612">readerCount</span><span class="op" id="1448623">,</span>&nbsp;<span class="ident" id="1448625">rwmutexMaxReaders</span><span class="op" id="1448642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448645">if</span>&nbsp;<span class="ident" id="1448648">r</span>&nbsp;<span class="op" id="1448650">&gt;=</span>&nbsp;<span class="ident" id="1448653">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1448671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448675">raceEnable</span><span class="op" id="1448685">(</span><span class="op" id="1448686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1448690">panic</span><span class="op" id="1448695">(</span><span class="string" id="1448696">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1448730">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448736">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448773">for</span>&nbsp;<span class="ident" id="1448777">i</span>&nbsp;<span class="op" id="1448779">:=</span>&nbsp;<span class="num" id="1448782">0</span><span class="op" id="1448783">;</span>&nbsp;<span class="ident" id="1448785">i</span>&nbsp;<span class="op" id="1448787">&lt;</span>&nbsp;<span class="builtintype" id="1448789">int</span><span class="op" id="1448792">(</span><span class="ident" id="1448793">r</span><span class="op" id="1448794">)</span><span class="op" id="1448795">;</span>&nbsp;<span class="ident" id="1448797">i</span><span class="op" id="1448798">++</span>&nbsp;<span class="op" id="1448801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448805">runtime_Semrelease</span><span class="op" id="1448823">(</span><span class="op" id="1448824">&amp;</span><span class="ident" id="1448825">rw</span><span class="op" id="1448827">.</span><span class="ident" id="1448828">readerSem</span><span class="op" id="1448837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448840">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448843">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448879">rw</span><span class="op" id="1448881">.</span><span class="ident" id="1448882">w</span><span class="op" id="1448883">.</span><span class="ident" id="1448884">Unlock</span><span class="op" id="1448890">(</span><span class="op" id="1448891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448894">if</span>&nbsp;<span class="ident" id="1448897">raceenabled</span>&nbsp;<span class="op" id="1448909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448913">raceEnable</span><span class="op" id="1448923">(</span><span class="op" id="1448924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448927">}</span><br>
<span class="lineno">125</span><span class="op" id="1448929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1448932">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1448986">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1449053">func</span>&nbsp;<span class="op" id="1449058">(</span><span class="ident" id="1449059">rw</span>&nbsp;<span class="op" id="1449062">*</span><span class="ident" id="1449063">RWMutex</span><span class="op" id="1449070">)</span>&nbsp;<span class="ident" id="1449072">RLocker</span><span class="op" id="1449079">(</span><span class="op" id="1449080">)</span>&nbsp;<span class="ident" id="1449082">Locker</span>&nbsp;<span class="op" id="1449089">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449092">return</span>&nbsp;<span class="op" id="1449099">(</span><span class="op" id="1449100">*</span><span class="ident" id="1449101">rlocker</span><span class="op" id="1449108">)</span><span class="op" id="1449109">(</span><span class="ident" id="1449110">rw</span><span class="op" id="1449112">)</span><br>
<span class="lineno"></span><span class="op" id="1449114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1449117">type</span>&nbsp;<span class="ident" id="1449122">rlocker</span>&nbsp;<span class="ident" id="1449130">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1449139">func</span>&nbsp;<span class="op" id="1449144">(</span><span class="ident" id="1449145">r</span>&nbsp;<span class="op" id="1449147">*</span><span class="ident" id="1449148">rlocker</span><span class="op" id="1449155">)</span>&nbsp;<span class="ident" id="1449157">Lock</span><span class="op" id="1449161">(</span><span class="op" id="1449162">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1449166">{</span>&nbsp;<span class="op" id="1449168">(</span><span class="op" id="1449169">*</span><span class="ident" id="1449170">RWMutex</span><span class="op" id="1449177">)</span><span class="op" id="1449178">(</span><span class="ident" id="1449179">r</span><span class="op" id="1449180">)</span><span class="op" id="1449181">.</span><span class="ident" id="1449182">RLock</span><span class="op" id="1449187">(</span><span class="op" id="1449188">)</span>&nbsp;<span class="op" id="1449190">}</span><br>
<span class="lineno"></span><span class="keyword" id="1449192">func</span>&nbsp;<span class="op" id="1449197">(</span><span class="ident" id="1449198">r</span>&nbsp;<span class="op" id="1449200">*</span><span class="ident" id="1449201">rlocker</span><span class="op" id="1449208">)</span>&nbsp;<span class="ident" id="1449210">Unlock</span><span class="op" id="1449216">(</span><span class="op" id="1449217">)</span>&nbsp;<span class="op" id="1449219">{</span>&nbsp;<span class="op" id="1449221">(</span><span class="op" id="1449222">*</span><span class="ident" id="1449223">RWMutex</span><span class="op" id="1449230">)</span><span class="op" id="1449231">(</span><span class="ident" id="1449232">r</span><span class="op" id="1449233">)</span><span class="op" id="1449234">.</span><span class="ident" id="1449235">RUnlock</span><span class="op" id="1449242">(</span><span class="op" id="1449243">)</span>&nbsp;<span class="op" id="1449245">}</span>
</div>
</body>
</html>
