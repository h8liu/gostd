<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>time</h2>
<ul>
<li><a href="/gostd/time/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/time/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/time/format.go.html">format.go</a></li>
<li><a href="/gostd/time/format_test.go.html">format_test.go</a></li>
<li><a href="/gostd/time/internal_test.go.html">internal_test.go</a></li>
<li><a href="/gostd/time/sleep.go.html">sleep.go</a></li>
<li><a href="/gostd/time/sleep_test.go.html">sleep_test.go</a></li>
<li><a href="/gostd/time/sys_unix.go.html">sys_unix.go</a></li>
<li><a href="/gostd/time/tick.go.html">tick.go</a></li>
<li><a href="/gostd/time/tick_test.go.html">tick_test.go</a></li>
<li><a href="/gostd/time/time.go.html">time.go</a></li>
<li><a href="/gostd/time/time_test.go.html">time_test.go</a></li>
<li><a href="/gostd/time/zoneinfo.go.html">zoneinfo.go</a></li>
<li><a href="/gostd/time/zoneinfo_read.go.html">zoneinfo_read.go</a></li>
<li><a href="/gostd/time/zoneinfo_test.go.html">zoneinfo_test.go</a></li>
<li><a href="/gostd/time/zoneinfo_unix.go.html">zoneinfo_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6549469">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6549524">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6549578">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6549629">package</span>&nbsp;<span class="ident" id="6549637">time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6549643">func</span>&nbsp;<span class="ident" id="6549648">init</span><span class="op" id="6549652">(</span><span class="op" id="6549653">)</span>&nbsp;<span class="op" id="6549655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6549658">//&nbsp;force&nbsp;US/Pacific&nbsp;for&nbsp;time&nbsp;zone&nbsp;tests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6549699">ForceUSPacificForTesting</span><span class="op" id="6549723">(</span><span class="op" id="6549724">)</span><br>
<span class="lineno">10</span><span class="op" id="6549726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6549729">var</span>&nbsp;<span class="ident" id="6549733">Interrupt</span>&nbsp;<span class="op" id="6549743">=</span>&nbsp;<span class="ident" id="6549745">interrupt</span><br>
<span class="lineno"></span><span class="keyword" id="6549755">var</span>&nbsp;<span class="ident" id="6549759">DaysIn</span>&nbsp;<span class="op" id="6549766">=</span>&nbsp;<span class="ident" id="6549768">daysIn</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6549776">func</span>&nbsp;<span class="ident" id="6549781">empty</span><span class="op" id="6549786">(</span><span class="ident" id="6549787">arg</span>&nbsp;<span class="keyword" id="6549791">interface</span><span class="op" id="6549800">{</span><span class="op" id="6549801">}</span><span class="op" id="6549802">,</span>&nbsp;<span class="ident" id="6549804">seq</span>&nbsp;<span class="builtintype" id="6549808">uintptr</span><span class="op" id="6549815">)</span>&nbsp;<span class="op" id="6549817">{</span><span class="op" id="6549818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6549821">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;runtimeTimer&nbsp;with&nbsp;a&nbsp;duration&nbsp;so&nbsp;large&nbsp;it&nbsp;overflows</span><br>
<span class="lineno"></span><span class="comment" id="6549887">//&nbsp;does&nbsp;not&nbsp;cause&nbsp;other&nbsp;timers&nbsp;to&nbsp;hang.</span><br>
<span class="lineno"></span><span class="comment" id="6549927">//</span><br>
<span class="lineno">20</span><span class="comment" id="6549930">//&nbsp;This&nbsp;test&nbsp;has&nbsp;to&nbsp;be&nbsp;in&nbsp;internal_test.go&nbsp;since&nbsp;it&nbsp;fiddles&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="6549995">//&nbsp;unexported&nbsp;data&nbsp;structures.</span><br>
<span class="lineno"></span><span class="keyword" id="6550026">func</span>&nbsp;<span class="ident" id="6550031">CheckRuntimeTimerOverflow</span><span class="op" id="6550056">(</span><span class="op" id="6550057">)</span>&nbsp;<span class="op" id="6550059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550062">//&nbsp;We&nbsp;manually&nbsp;create&nbsp;a&nbsp;runtimeTimer&nbsp;to&nbsp;bypass&nbsp;the&nbsp;overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550123">//&nbsp;detection&nbsp;logic&nbsp;in&nbsp;NewTimer:&nbsp;we&#39;re&nbsp;testing&nbsp;the&nbsp;underlying</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550185">//&nbsp;runtime.addtimer&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550216">r</span>&nbsp;<span class="op" id="6550218">:=</span>&nbsp;<span class="op" id="6550221">&amp;</span><span class="ident" id="6550222">runtimeTimer</span><span class="op" id="6550234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550238">when</span><span class="op" id="6550242">:</span>&nbsp;<span class="ident" id="6550244">runtimeNano</span><span class="op" id="6550255">(</span><span class="op" id="6550256">)</span>&nbsp;<span class="op" id="6550258">+</span>&nbsp;<span class="op" id="6550260">(</span><span class="num" id="6550261">1</span><span class="op" id="6550262">&lt;&lt;</span><span class="num" id="6550264">63</span>&nbsp;<span class="op" id="6550267">-</span>&nbsp;<span class="num" id="6550269">1</span><span class="op" id="6550270">)</span><span class="op" id="6550271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550275">f</span><span class="op" id="6550276">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6550281">empty</span><span class="op" id="6550286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550290">arg</span><span class="op" id="6550293">:</span>&nbsp;&nbsp;<span class="ident" id="6550296">nil</span><span class="op" id="6550299">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6550302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550305">startTimer</span><span class="op" id="6550315">(</span><span class="ident" id="6550316">r</span><span class="op" id="6550317">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550321">//&nbsp;Start&nbsp;a&nbsp;goroutine&nbsp;that&nbsp;should&nbsp;send&nbsp;on&nbsp;t.C&nbsp;right&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550379">t</span>&nbsp;<span class="op" id="6550381">:=</span>&nbsp;<span class="ident" id="6550384">NewTimer</span><span class="op" id="6550392">(</span><span class="num" id="6550393">1</span><span class="op" id="6550394">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6550398">defer</span>&nbsp;<span class="keyword" id="6550404">func</span><span class="op" id="6550408">(</span><span class="op" id="6550409">)</span>&nbsp;<span class="op" id="6550411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550415">//&nbsp;Subsequent&nbsp;tests&nbsp;won&#39;t&nbsp;work&nbsp;correctly&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;stop&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550479">//&nbsp;overflow&nbsp;timer&nbsp;and&nbsp;kick&nbsp;the&nbsp;timer&nbsp;proc&nbsp;back&nbsp;into&nbsp;service.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550542">//</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550547">//&nbsp;The&nbsp;timer&nbsp;proc&nbsp;is&nbsp;now&nbsp;sleeping&nbsp;and&nbsp;can&nbsp;only&nbsp;be&nbsp;awoken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550609">//&nbsp;adding&nbsp;a&nbsp;timer&nbsp;to&nbsp;the&nbsp;*beginning*&nbsp;of&nbsp;the&nbsp;heap.&nbsp;We&nbsp;can&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550670">//&nbsp;wake&nbsp;it&nbsp;up&nbsp;by&nbsp;calling&nbsp;NewTimer&nbsp;since&nbsp;other&nbsp;tests&nbsp;may&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550733">//&nbsp;left&nbsp;timers&nbsp;running&nbsp;that&nbsp;should&nbsp;have&nbsp;expired&nbsp;before&nbsp;ours.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550796">//&nbsp;Instead&nbsp;we&nbsp;zero&nbsp;the&nbsp;overflow&nbsp;timer&nbsp;duration&nbsp;and&nbsp;start&nbsp;it</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550858">//&nbsp;once&nbsp;more.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550874">stopTimer</span><span class="op" id="6550883">(</span><span class="ident" id="6550884">r</span><span class="op" id="6550885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550889">t</span><span class="op" id="6550890">.</span><span class="ident" id="6550891">Stop</span><span class="op" id="6550895">(</span><span class="op" id="6550896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550900">r</span><span class="op" id="6550901">.</span><span class="ident" id="6550902">when</span>&nbsp;<span class="op" id="6550907">=</span>&nbsp;<span class="num" id="6550909">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6550913">startTimer</span><span class="op" id="6550923">(</span><span class="ident" id="6550924">r</span><span class="op" id="6550925">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6550928">}</span><span class="op" id="6550929">(</span><span class="op" id="6550930">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6550934">//&nbsp;If&nbsp;the&nbsp;test&nbsp;fails,&nbsp;we&nbsp;will&nbsp;hang&nbsp;here&nbsp;until&nbsp;the&nbsp;timeout&nbsp;in&nbsp;the&nbsp;testing&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6551016">//&nbsp;fires,&nbsp;which&nbsp;is&nbsp;10&nbsp;minutes.&nbsp;It&nbsp;would&nbsp;be&nbsp;nice&nbsp;to&nbsp;catch&nbsp;the&nbsp;problem&nbsp;sooner,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6551094">//&nbsp;but&nbsp;there&nbsp;is&nbsp;no&nbsp;reliable&nbsp;way&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;timerproc&nbsp;schedules&nbsp;without</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6551173">//&nbsp;doing&nbsp;something&nbsp;involving&nbsp;timerproc&nbsp;itself.&nbsp;Previous&nbsp;failed&nbsp;attempts&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6551251">//&nbsp;tried&nbsp;calling&nbsp;runtime.Gosched&nbsp;and&nbsp;runtime.GC,&nbsp;but&nbsp;neither&nbsp;is&nbsp;reliable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6551326">//&nbsp;So&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;hope:&nbsp;We&nbsp;hope&nbsp;we&nbsp;don&#39;t&nbsp;hang&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6551383">&lt;-</span><span class="ident" id="6551385">t</span><span class="op" id="6551386">.</span><span class="ident" id="6551387">C</span><br>
<span class="lineno"></span><span class="op" id="6551389">}</span>
</div>
</body>
</html>
