<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3474606">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3474661">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3474715">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3474766">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="3474837">package</span>&nbsp;<span class="ident" id="3474845">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3474850">import</span>&nbsp;<span class="op" id="3474857">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474860">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474870">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474886">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474900">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474915">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474931">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474941">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474954">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474961">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474972">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3474979">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3474982">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3475033">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="3475076">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3475134">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="3475163">func</span>&nbsp;<span class="ident" id="3475168">Server</span><span class="op" id="3475174">(</span><span class="ident" id="3475175">conn</span>&nbsp;<span class="ident" id="3475180">net</span><span class="op" id="3475183">.</span><span class="ident" id="3475184">Conn</span><span class="op" id="3475188">,</span>&nbsp;<span class="ident" id="3475190">config</span>&nbsp;<span class="op" id="3475197">*</span><span class="ident" id="3475198">Config</span><span class="op" id="3475204">)</span>&nbsp;<span class="op" id="3475206">*</span><span class="ident" id="3475207">Conn</span>&nbsp;<span class="op" id="3475212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475215">return</span>&nbsp;<span class="op" id="3475222">&amp;</span><span class="ident" id="3475223">Conn</span><span class="op" id="3475227">{</span><span class="ident" id="3475228">conn</span><span class="op" id="3475232">:</span>&nbsp;<span class="ident" id="3475234">conn</span><span class="op" id="3475238">,</span>&nbsp;<span class="ident" id="3475240">config</span><span class="op" id="3475246">:</span>&nbsp;<span class="ident" id="3475248">config</span><span class="op" id="3475254">}</span><br>
<span class="lineno"></span><span class="op" id="3475256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3475259">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="3475310">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="3475353">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3475418">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="3475455">func</span>&nbsp;<span class="ident" id="3475460">Client</span><span class="op" id="3475466">(</span><span class="ident" id="3475467">conn</span>&nbsp;<span class="ident" id="3475472">net</span><span class="op" id="3475475">.</span><span class="ident" id="3475476">Conn</span><span class="op" id="3475480">,</span>&nbsp;<span class="ident" id="3475482">config</span>&nbsp;<span class="op" id="3475489">*</span><span class="ident" id="3475490">Config</span><span class="op" id="3475496">)</span>&nbsp;<span class="op" id="3475498">*</span><span class="ident" id="3475499">Conn</span>&nbsp;<span class="op" id="3475504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475507">return</span>&nbsp;<span class="op" id="3475514">&amp;</span><span class="ident" id="3475515">Conn</span><span class="op" id="3475519">{</span><span class="ident" id="3475520">conn</span><span class="op" id="3475524">:</span>&nbsp;<span class="ident" id="3475526">conn</span><span class="op" id="3475530">,</span>&nbsp;<span class="ident" id="3475532">config</span><span class="op" id="3475538">:</span>&nbsp;<span class="ident" id="3475540">config</span><span class="op" id="3475546">,</span>&nbsp;<span class="ident" id="3475548">isClient</span><span class="op" id="3475556">:</span>&nbsp;<span class="builtintype" id="3475558">true</span><span class="op" id="3475562">}</span><br>
<span class="lineno">35</span><span class="op" id="3475564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3475567">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3475647">type</span>&nbsp;<span class="ident" id="3475652">listener</span>&nbsp;<span class="keyword" id="3475661">struct</span>&nbsp;<span class="op" id="3475668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475671">net</span><span class="op" id="3475674">.</span><span class="ident" id="3475675">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475685">config</span>&nbsp;<span class="op" id="3475692">*</span><span class="ident" id="3475693">Config</span><br>
<span class="lineno"></span><span class="op" id="3475700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3475703">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3475769">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="3475814">func</span>&nbsp;<span class="op" id="3475819">(</span><span class="ident" id="3475820">l</span>&nbsp;<span class="op" id="3475822">*</span><span class="ident" id="3475823">listener</span><span class="op" id="3475831">)</span>&nbsp;<span class="ident" id="3475833">Accept</span><span class="op" id="3475839">(</span><span class="op" id="3475840">)</span>&nbsp;<span class="op" id="3475842">(</span><span class="ident" id="3475843">c</span>&nbsp;<span class="ident" id="3475845">net</span><span class="op" id="3475848">.</span><span class="ident" id="3475849">Conn</span><span class="op" id="3475853">,</span>&nbsp;<span class="ident" id="3475855">err</span>&nbsp;<span class="builtintype" id="3475859">error</span><span class="op" id="3475864">)</span>&nbsp;<span class="op" id="3475866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475869">c</span><span class="op" id="3475870">,</span>&nbsp;<span class="ident" id="3475872">err</span>&nbsp;<span class="op" id="3475876">=</span>&nbsp;<span class="ident" id="3475878">l</span><span class="op" id="3475879">.</span><span class="ident" id="3475880">Listener</span><span class="op" id="3475888">.</span><span class="ident" id="3475889">Accept</span><span class="op" id="3475895">(</span><span class="op" id="3475896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475899">if</span>&nbsp;<span class="ident" id="3475902">err</span>&nbsp;<span class="op" id="3475906">!=</span>&nbsp;<span class="ident" id="3475909">nil</span>&nbsp;<span class="op" id="3475913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475917">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475925">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475928">c</span>&nbsp;<span class="op" id="3475930">=</span>&nbsp;<span class="ident" id="3475932">Server</span><span class="op" id="3475938">(</span><span class="ident" id="3475939">c</span><span class="op" id="3475940">,</span>&nbsp;<span class="ident" id="3475942">l</span><span class="op" id="3475943">.</span><span class="ident" id="3475944">config</span><span class="op" id="3475950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475953">return</span><br>
<span class="lineno"></span><span class="op" id="3475960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3475963">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="3476037">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="3476088">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3476146">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3476175">func</span>&nbsp;<span class="ident" id="3476180">NewListener</span><span class="op" id="3476191">(</span><span class="ident" id="3476192">inner</span>&nbsp;<span class="ident" id="3476198">net</span><span class="op" id="3476201">.</span><span class="ident" id="3476202">Listener</span><span class="op" id="3476210">,</span>&nbsp;<span class="ident" id="3476212">config</span>&nbsp;<span class="op" id="3476219">*</span><span class="ident" id="3476220">Config</span><span class="op" id="3476226">)</span>&nbsp;<span class="ident" id="3476228">net</span><span class="op" id="3476231">.</span><span class="ident" id="3476232">Listener</span>&nbsp;<span class="op" id="3476241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476244">l</span>&nbsp;<span class="op" id="3476246">:=</span>&nbsp;<span class="builtinfunc" id="3476249">new</span><span class="op" id="3476252">(</span><span class="ident" id="3476253">listener</span><span class="op" id="3476261">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476264">l</span><span class="op" id="3476265">.</span><span class="ident" id="3476266">Listener</span>&nbsp;<span class="op" id="3476275">=</span>&nbsp;<span class="ident" id="3476277">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476284">l</span><span class="op" id="3476285">.</span><span class="ident" id="3476286">config</span>&nbsp;<span class="op" id="3476293">=</span>&nbsp;<span class="ident" id="3476295">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476303">return</span>&nbsp;<span class="ident" id="3476310">l</span><br>
<span class="lineno"></span><span class="op" id="3476312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3476315">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3476377">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="3476420">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3476478">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3476507">func</span>&nbsp;<span class="ident" id="3476512">Listen</span><span class="op" id="3476518">(</span><span class="ident" id="3476519">network</span><span class="op" id="3476526">,</span>&nbsp;<span class="ident" id="3476528">laddr</span>&nbsp;<span class="builtintype" id="3476534">string</span><span class="op" id="3476540">,</span>&nbsp;<span class="ident" id="3476542">config</span>&nbsp;<span class="op" id="3476549">*</span><span class="ident" id="3476550">Config</span><span class="op" id="3476556">)</span>&nbsp;<span class="op" id="3476558">(</span><span class="ident" id="3476559">net</span><span class="op" id="3476562">.</span><span class="ident" id="3476563">Listener</span><span class="op" id="3476571">,</span>&nbsp;<span class="builtintype" id="3476573">error</span><span class="op" id="3476578">)</span>&nbsp;<span class="op" id="3476580">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476583">if</span>&nbsp;<span class="ident" id="3476586">config</span>&nbsp;<span class="op" id="3476593">==</span>&nbsp;<span class="ident" id="3476596">nil</span>&nbsp;<span class="op" id="3476600">||</span>&nbsp;<span class="builtinfunc" id="3476603">len</span><span class="op" id="3476606">(</span><span class="ident" id="3476607">config</span><span class="op" id="3476613">.</span><span class="ident" id="3476614">Certificates</span><span class="op" id="3476626">)</span>&nbsp;<span class="op" id="3476628">==</span>&nbsp;<span class="num" id="3476631">0</span>&nbsp;<span class="op" id="3476633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476637">return</span>&nbsp;<span class="ident" id="3476644">nil</span><span class="op" id="3476647">,</span>&nbsp;<span class="ident" id="3476649">errors</span><span class="op" id="3476655">.</span><span class="ident" id="3476656">New</span><span class="op" id="3476659">(</span><span class="string" id="3476660">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="3476706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476712">l</span><span class="op" id="3476713">,</span>&nbsp;<span class="ident" id="3476715">err</span>&nbsp;<span class="op" id="3476719">:=</span>&nbsp;<span class="ident" id="3476722">net</span><span class="op" id="3476725">.</span><span class="ident" id="3476726">Listen</span><span class="op" id="3476732">(</span><span class="ident" id="3476733">network</span><span class="op" id="3476740">,</span>&nbsp;<span class="ident" id="3476742">laddr</span><span class="op" id="3476747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476750">if</span>&nbsp;<span class="ident" id="3476753">err</span>&nbsp;<span class="op" id="3476757">!=</span>&nbsp;<span class="ident" id="3476760">nil</span>&nbsp;<span class="op" id="3476764">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476768">return</span>&nbsp;<span class="ident" id="3476775">nil</span><span class="op" id="3476778">,</span>&nbsp;<span class="ident" id="3476780">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476788">return</span>&nbsp;<span class="ident" id="3476795">NewListener</span><span class="op" id="3476806">(</span><span class="ident" id="3476807">l</span><span class="op" id="3476808">,</span>&nbsp;<span class="ident" id="3476810">config</span><span class="op" id="3476816">)</span><span class="op" id="3476817">,</span>&nbsp;<span class="ident" id="3476819">nil</span><br>
<span class="lineno"></span><span class="op" id="3476823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3476826">type</span>&nbsp;<span class="ident" id="3476831">timeoutError</span>&nbsp;<span class="keyword" id="3476844">struct</span><span class="op" id="3476850">{</span><span class="op" id="3476851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3476854">func</span>&nbsp;<span class="op" id="3476859">(</span><span class="ident" id="3476860">timeoutError</span><span class="op" id="3476872">)</span>&nbsp;<span class="ident" id="3476874">Error</span><span class="op" id="3476879">(</span><span class="op" id="3476880">)</span>&nbsp;<span class="builtintype" id="3476882">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3476891">{</span>&nbsp;<span class="keyword" id="3476893">return</span>&nbsp;<span class="string" id="3476900">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="3476932">}</span><br>
<span class="lineno"></span><span class="keyword" id="3476934">func</span>&nbsp;<span class="op" id="3476939">(</span><span class="ident" id="3476940">timeoutError</span><span class="op" id="3476952">)</span>&nbsp;<span class="ident" id="3476954">Timeout</span><span class="op" id="3476961">(</span><span class="op" id="3476962">)</span>&nbsp;<span class="builtintype" id="3476964">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3476971">{</span>&nbsp;<span class="keyword" id="3476973">return</span>&nbsp;<span class="builtintype" id="3476980">true</span>&nbsp;<span class="op" id="3476985">}</span><br>
<span class="lineno"></span><span class="keyword" id="3476987">func</span>&nbsp;<span class="op" id="3476992">(</span><span class="ident" id="3476993">timeoutError</span><span class="op" id="3477005">)</span>&nbsp;<span class="ident" id="3477007">Temporary</span><span class="op" id="3477016">(</span><span class="op" id="3477017">)</span>&nbsp;<span class="builtintype" id="3477019">bool</span>&nbsp;<span class="op" id="3477024">{</span>&nbsp;<span class="keyword" id="3477026">return</span>&nbsp;<span class="builtintype" id="3477033">true</span>&nbsp;<span class="op" id="3477038">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="3477041">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3477119">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="3477198">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="3477269">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="3477294">//</span><br>
<span class="lineno"></span><span class="comment" id="3477297">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="3477372">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="3477440">func</span>&nbsp;<span class="ident" id="3477445">DialWithDialer</span><span class="op" id="3477459">(</span><span class="ident" id="3477460">dialer</span>&nbsp;<span class="op" id="3477467">*</span><span class="ident" id="3477468">net</span><span class="op" id="3477471">.</span><span class="ident" id="3477472">Dialer</span><span class="op" id="3477478">,</span>&nbsp;<span class="ident" id="3477480">network</span><span class="op" id="3477487">,</span>&nbsp;<span class="ident" id="3477489">addr</span>&nbsp;<span class="builtintype" id="3477494">string</span><span class="op" id="3477500">,</span>&nbsp;<span class="ident" id="3477502">config</span>&nbsp;<span class="op" id="3477509">*</span><span class="ident" id="3477510">Config</span><span class="op" id="3477516">)</span>&nbsp;<span class="op" id="3477518">(</span><span class="op" id="3477519">*</span><span class="ident" id="3477520">Conn</span><span class="op" id="3477524">,</span>&nbsp;<span class="builtintype" id="3477526">error</span><span class="op" id="3477531">)</span>&nbsp;<span class="op" id="3477533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477536">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477605">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477677">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477720">timeout</span>&nbsp;<span class="op" id="3477728">:=</span>&nbsp;<span class="ident" id="3477731">dialer</span><span class="op" id="3477737">.</span><span class="ident" id="3477738">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477748">if</span>&nbsp;<span class="op" id="3477751">!</span><span class="ident" id="3477752">dialer</span><span class="op" id="3477758">.</span><span class="ident" id="3477759">Deadline</span><span class="op" id="3477767">.</span><span class="ident" id="3477768">IsZero</span><span class="op" id="3477774">(</span><span class="op" id="3477775">)</span>&nbsp;<span class="op" id="3477777">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477781">deadlineTimeout</span>&nbsp;<span class="op" id="3477797">:=</span>&nbsp;<span class="ident" id="3477800">dialer</span><span class="op" id="3477806">.</span><span class="ident" id="3477807">Deadline</span><span class="op" id="3477815">.</span><span class="ident" id="3477816">Sub</span><span class="op" id="3477819">(</span><span class="ident" id="3477820">time</span><span class="op" id="3477824">.</span><span class="ident" id="3477825">Now</span><span class="op" id="3477828">(</span><span class="op" id="3477829">)</span><span class="op" id="3477830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477834">if</span>&nbsp;<span class="ident" id="3477837">timeout</span>&nbsp;<span class="op" id="3477845">==</span>&nbsp;<span class="num" id="3477848">0</span>&nbsp;<span class="op" id="3477850">||</span>&nbsp;<span class="ident" id="3477853">deadlineTimeout</span>&nbsp;<span class="op" id="3477869">&lt;</span>&nbsp;<span class="ident" id="3477871">timeout</span>&nbsp;<span class="op" id="3477879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477884">timeout</span>&nbsp;<span class="op" id="3477892">=</span>&nbsp;<span class="ident" id="3477894">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477915">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477919">var</span>&nbsp;<span class="ident" id="3477923">errChannel</span>&nbsp;<span class="keyword" id="3477934">chan</span>&nbsp;<span class="builtintype" id="3477939">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477947">if</span>&nbsp;<span class="ident" id="3477950">timeout</span>&nbsp;<span class="op" id="3477958">!=</span>&nbsp;<span class="num" id="3477961">0</span>&nbsp;<span class="op" id="3477963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477967">errChannel</span>&nbsp;<span class="op" id="3477978">=</span>&nbsp;<span class="builtinfunc" id="3477980">make</span><span class="op" id="3477984">(</span><span class="keyword" id="3477985">chan</span>&nbsp;<span class="builtintype" id="3477990">error</span><span class="op" id="3477995">,</span>&nbsp;<span class="num" id="3477997">2</span><span class="op" id="3477998">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478002">time</span><span class="op" id="3478006">.</span><span class="ident" id="3478007">AfterFunc</span><span class="op" id="3478016">(</span><span class="ident" id="3478017">timeout</span><span class="op" id="3478024">,</span>&nbsp;<span class="keyword" id="3478026">func</span><span class="op" id="3478030">(</span><span class="op" id="3478031">)</span>&nbsp;<span class="op" id="3478033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478038">errChannel</span>&nbsp;<span class="op" id="3478049">&lt;-</span>&nbsp;<span class="ident" id="3478052">timeoutError</span><span class="op" id="3478064">{</span><span class="op" id="3478065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478069">}</span><span class="op" id="3478070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478077">rawConn</span><span class="op" id="3478084">,</span>&nbsp;<span class="ident" id="3478086">err</span>&nbsp;<span class="op" id="3478090">:=</span>&nbsp;<span class="ident" id="3478093">dialer</span><span class="op" id="3478099">.</span><span class="ident" id="3478100">Dial</span><span class="op" id="3478104">(</span><span class="ident" id="3478105">network</span><span class="op" id="3478112">,</span>&nbsp;<span class="ident" id="3478114">addr</span><span class="op" id="3478118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478121">if</span>&nbsp;<span class="ident" id="3478124">err</span>&nbsp;<span class="op" id="3478128">!=</span>&nbsp;<span class="ident" id="3478131">nil</span>&nbsp;<span class="op" id="3478135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478139">return</span>&nbsp;<span class="ident" id="3478146">nil</span><span class="op" id="3478149">,</span>&nbsp;<span class="ident" id="3478151">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478160">colonPos</span>&nbsp;<span class="op" id="3478169">:=</span>&nbsp;<span class="ident" id="3478172">strings</span><span class="op" id="3478179">.</span><span class="ident" id="3478180">LastIndex</span><span class="op" id="3478189">(</span><span class="ident" id="3478190">addr</span><span class="op" id="3478194">,</span>&nbsp;<span class="string" id="3478196">&#34;:&#34;</span><span class="op" id="3478199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478202">if</span>&nbsp;<span class="ident" id="3478205">colonPos</span>&nbsp;<span class="op" id="3478214">==</span>&nbsp;<span class="op" id="3478217">-</span><span class="num" id="3478218">1</span>&nbsp;<span class="op" id="3478220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478224">colonPos</span>&nbsp;<span class="op" id="3478233">=</span>&nbsp;<span class="builtinfunc" id="3478235">len</span><span class="op" id="3478238">(</span><span class="ident" id="3478239">addr</span><span class="op" id="3478243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478249">hostname</span>&nbsp;<span class="op" id="3478258">:=</span>&nbsp;<span class="ident" id="3478261">addr</span><span class="op" id="3478265">[</span><span class="op" id="3478266">:</span><span class="ident" id="3478267">colonPos</span><span class="op" id="3478275">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478279">if</span>&nbsp;<span class="ident" id="3478282">config</span>&nbsp;<span class="op" id="3478289">==</span>&nbsp;<span class="ident" id="3478292">nil</span>&nbsp;<span class="op" id="3478296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478300">config</span>&nbsp;<span class="op" id="3478307">=</span>&nbsp;<span class="ident" id="3478309">defaultConfig</span><span class="op" id="3478322">(</span><span class="op" id="3478323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478329">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478379">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478422">if</span>&nbsp;<span class="ident" id="3478425">config</span><span class="op" id="3478431">.</span><span class="ident" id="3478432">ServerName</span>&nbsp;<span class="op" id="3478443">==</span>&nbsp;<span class="string" id="3478446">&#34;&#34;</span>&nbsp;<span class="op" id="3478449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478453">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478510">c</span>&nbsp;<span class="op" id="3478512">:=</span>&nbsp;<span class="op" id="3478515">*</span><span class="ident" id="3478516">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478525">c</span><span class="op" id="3478526">.</span><span class="ident" id="3478527">ServerName</span>&nbsp;<span class="op" id="3478538">=</span>&nbsp;<span class="ident" id="3478540">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478551">config</span>&nbsp;<span class="op" id="3478558">=</span>&nbsp;<span class="op" id="3478560">&amp;</span><span class="ident" id="3478561">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478568">conn</span>&nbsp;<span class="op" id="3478573">:=</span>&nbsp;<span class="ident" id="3478576">Client</span><span class="op" id="3478582">(</span><span class="ident" id="3478583">rawConn</span><span class="op" id="3478590">,</span>&nbsp;<span class="ident" id="3478592">config</span><span class="op" id="3478598">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478602">if</span>&nbsp;<span class="ident" id="3478605">timeout</span>&nbsp;<span class="op" id="3478613">==</span>&nbsp;<span class="num" id="3478616">0</span>&nbsp;<span class="op" id="3478618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478622">err</span>&nbsp;<span class="op" id="3478626">=</span>&nbsp;<span class="ident" id="3478628">conn</span><span class="op" id="3478632">.</span><span class="ident" id="3478633">Handshake</span><span class="op" id="3478642">(</span><span class="op" id="3478643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478646">}</span>&nbsp;<span class="keyword" id="3478648">else</span>&nbsp;<span class="op" id="3478653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478657">go</span>&nbsp;<span class="keyword" id="3478660">func</span><span class="op" id="3478664">(</span><span class="op" id="3478665">)</span>&nbsp;<span class="op" id="3478667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478672">errChannel</span>&nbsp;<span class="op" id="3478683">&lt;-</span>&nbsp;<span class="ident" id="3478686">conn</span><span class="op" id="3478690">.</span><span class="ident" id="3478691">Handshake</span><span class="op" id="3478700">(</span><span class="op" id="3478701">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478705">}</span><span class="op" id="3478706">(</span><span class="op" id="3478707">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478712">err</span>&nbsp;<span class="op" id="3478716">=</span>&nbsp;<span class="op" id="3478718">&lt;-</span><span class="ident" id="3478720">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478736">if</span>&nbsp;<span class="ident" id="3478739">err</span>&nbsp;<span class="op" id="3478743">!=</span>&nbsp;<span class="ident" id="3478746">nil</span>&nbsp;<span class="op" id="3478750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478754">rawConn</span><span class="op" id="3478761">.</span><span class="ident" id="3478762">Close</span><span class="op" id="3478767">(</span><span class="op" id="3478768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478772">return</span>&nbsp;<span class="ident" id="3478779">nil</span><span class="op" id="3478782">,</span>&nbsp;<span class="ident" id="3478784">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478793">return</span>&nbsp;<span class="ident" id="3478800">conn</span><span class="op" id="3478804">,</span>&nbsp;<span class="ident" id="3478806">nil</span><br>
<span class="lineno"></span><span class="op" id="3478810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3478813">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="3478874">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="3478937">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3478956">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3479012">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="3479071">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="3479092">func</span>&nbsp;<span class="ident" id="3479097">Dial</span><span class="op" id="3479101">(</span><span class="ident" id="3479102">network</span><span class="op" id="3479109">,</span>&nbsp;<span class="ident" id="3479111">addr</span>&nbsp;<span class="builtintype" id="3479116">string</span><span class="op" id="3479122">,</span>&nbsp;<span class="ident" id="3479124">config</span>&nbsp;<span class="op" id="3479131">*</span><span class="ident" id="3479132">Config</span><span class="op" id="3479138">)</span>&nbsp;<span class="op" id="3479140">(</span><span class="op" id="3479141">*</span><span class="ident" id="3479142">Conn</span><span class="op" id="3479146">,</span>&nbsp;<span class="builtintype" id="3479148">error</span><span class="op" id="3479153">)</span>&nbsp;<span class="op" id="3479155">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479158">return</span>&nbsp;<span class="ident" id="3479165">DialWithDialer</span><span class="op" id="3479179">(</span><span class="builtinfunc" id="3479180">new</span><span class="op" id="3479183">(</span><span class="ident" id="3479184">net</span><span class="op" id="3479187">.</span><span class="ident" id="3479188">Dialer</span><span class="op" id="3479194">)</span><span class="op" id="3479195">,</span>&nbsp;<span class="ident" id="3479197">network</span><span class="op" id="3479204">,</span>&nbsp;<span class="ident" id="3479206">addr</span><span class="op" id="3479210">,</span>&nbsp;<span class="ident" id="3479212">config</span><span class="op" id="3479218">)</span><br>
<span class="lineno"></span><span class="op" id="3479220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3479223">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3479300">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="3479351">func</span>&nbsp;<span class="ident" id="3479356">LoadX509KeyPair</span><span class="op" id="3479371">(</span><span class="ident" id="3479372">certFile</span><span class="op" id="3479380">,</span>&nbsp;<span class="ident" id="3479382">keyFile</span>&nbsp;<span class="builtintype" id="3479390">string</span><span class="op" id="3479396">)</span>&nbsp;<span class="op" id="3479398">(</span><span class="ident" id="3479399">cert</span>&nbsp;<span class="ident" id="3479404">Certificate</span><span class="op" id="3479415">,</span>&nbsp;<span class="ident" id="3479417">err</span>&nbsp;<span class="builtintype" id="3479421">error</span><span class="op" id="3479426">)</span>&nbsp;<span class="op" id="3479428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479431">certPEMBlock</span><span class="op" id="3479443">,</span>&nbsp;<span class="ident" id="3479445">err</span>&nbsp;<span class="op" id="3479449">:=</span>&nbsp;<span class="ident" id="3479452">ioutil</span><span class="op" id="3479458">.</span><span class="ident" id="3479459">ReadFile</span><span class="op" id="3479467">(</span><span class="ident" id="3479468">certFile</span><span class="op" id="3479476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479479">if</span>&nbsp;<span class="ident" id="3479482">err</span>&nbsp;<span class="op" id="3479486">!=</span>&nbsp;<span class="ident" id="3479489">nil</span>&nbsp;<span class="op" id="3479493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479497">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479505">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479508">keyPEMBlock</span><span class="op" id="3479519">,</span>&nbsp;<span class="ident" id="3479521">err</span>&nbsp;<span class="op" id="3479525">:=</span>&nbsp;<span class="ident" id="3479528">ioutil</span><span class="op" id="3479534">.</span><span class="ident" id="3479535">ReadFile</span><span class="op" id="3479543">(</span><span class="ident" id="3479544">keyFile</span><span class="op" id="3479551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479554">if</span>&nbsp;<span class="ident" id="3479557">err</span>&nbsp;<span class="op" id="3479561">!=</span>&nbsp;<span class="ident" id="3479564">nil</span>&nbsp;<span class="op" id="3479568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479572">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479583">return</span>&nbsp;<span class="ident" id="3479590">X509KeyPair</span><span class="op" id="3479601">(</span><span class="ident" id="3479602">certPEMBlock</span><span class="op" id="3479614">,</span>&nbsp;<span class="ident" id="3479616">keyPEMBlock</span><span class="op" id="3479627">)</span><br>
<span class="lineno">180</span><span class="op" id="3479629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3479632">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3479695">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3479716">func</span>&nbsp;<span class="ident" id="3479721">X509KeyPair</span><span class="op" id="3479732">(</span><span class="ident" id="3479733">certPEMBlock</span><span class="op" id="3479745">,</span>&nbsp;<span class="ident" id="3479747">keyPEMBlock</span>&nbsp;<span class="op" id="3479759">[</span><span class="op" id="3479760">]</span><span class="builtintype" id="3479761">byte</span><span class="op" id="3479765">)</span>&nbsp;<span class="op" id="3479767">(</span><span class="ident" id="3479768">cert</span>&nbsp;<span class="ident" id="3479773">Certificate</span><span class="op" id="3479784">,</span>&nbsp;<span class="ident" id="3479786">err</span>&nbsp;<span class="builtintype" id="3479790">error</span><span class="op" id="3479795">)</span>&nbsp;<span class="op" id="3479797">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479800">var</span>&nbsp;<span class="ident" id="3479804">certDERBlock</span>&nbsp;<span class="op" id="3479817">*</span><span class="ident" id="3479818">pem</span><span class="op" id="3479821">.</span><span class="ident" id="3479822">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479829">for</span>&nbsp;<span class="op" id="3479833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479837">certDERBlock</span><span class="op" id="3479849">,</span>&nbsp;<span class="ident" id="3479851">certPEMBlock</span>&nbsp;<span class="op" id="3479864">=</span>&nbsp;<span class="ident" id="3479866">pem</span><span class="op" id="3479869">.</span><span class="ident" id="3479870">Decode</span><span class="op" id="3479876">(</span><span class="ident" id="3479877">certPEMBlock</span><span class="op" id="3479889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479893">if</span>&nbsp;<span class="ident" id="3479896">certDERBlock</span>&nbsp;<span class="op" id="3479909">==</span>&nbsp;<span class="ident" id="3479912">nil</span>&nbsp;<span class="op" id="3479916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479921">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479933">if</span>&nbsp;<span class="ident" id="3479936">certDERBlock</span><span class="op" id="3479948">.</span><span class="ident" id="3479949">Type</span>&nbsp;<span class="op" id="3479954">==</span>&nbsp;<span class="string" id="3479957">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="3479971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479976">cert</span><span class="op" id="3479980">.</span><span class="ident" id="3479981">Certificate</span>&nbsp;<span class="op" id="3479993">=</span>&nbsp;<span class="builtinfunc" id="3479995">append</span><span class="op" id="3480001">(</span><span class="ident" id="3480002">cert</span><span class="op" id="3480006">.</span><span class="ident" id="3480007">Certificate</span><span class="op" id="3480018">,</span>&nbsp;<span class="ident" id="3480020">certDERBlock</span><span class="op" id="3480032">.</span><span class="ident" id="3480033">Bytes</span><span class="op" id="3480038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480045">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480049">if</span>&nbsp;<span class="builtinfunc" id="3480052">len</span><span class="op" id="3480055">(</span><span class="ident" id="3480056">cert</span><span class="op" id="3480060">.</span><span class="ident" id="3480061">Certificate</span><span class="op" id="3480072">)</span>&nbsp;<span class="op" id="3480074">==</span>&nbsp;<span class="num" id="3480077">0</span>&nbsp;<span class="op" id="3480079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480083">err</span>&nbsp;<span class="op" id="3480087">=</span>&nbsp;<span class="ident" id="3480089">errors</span><span class="op" id="3480095">.</span><span class="ident" id="3480096">New</span><span class="op" id="3480099">(</span><span class="string" id="3480100">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="3480150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480154">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480162">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480166">var</span>&nbsp;<span class="ident" id="3480170">keyDERBlock</span>&nbsp;<span class="op" id="3480182">*</span><span class="ident" id="3480183">pem</span><span class="op" id="3480186">.</span><span class="ident" id="3480187">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480194">for</span>&nbsp;<span class="op" id="3480198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480202">keyDERBlock</span><span class="op" id="3480213">,</span>&nbsp;<span class="ident" id="3480215">keyPEMBlock</span>&nbsp;<span class="op" id="3480227">=</span>&nbsp;<span class="ident" id="3480229">pem</span><span class="op" id="3480232">.</span><span class="ident" id="3480233">Decode</span><span class="op" id="3480239">(</span><span class="ident" id="3480240">keyPEMBlock</span><span class="op" id="3480251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480255">if</span>&nbsp;<span class="ident" id="3480258">keyDERBlock</span>&nbsp;<span class="op" id="3480270">==</span>&nbsp;<span class="ident" id="3480273">nil</span>&nbsp;<span class="op" id="3480277">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480282">err</span>&nbsp;<span class="op" id="3480286">=</span>&nbsp;<span class="ident" id="3480288">errors</span><span class="op" id="3480294">.</span><span class="ident" id="3480295">New</span><span class="op" id="3480298">(</span><span class="string" id="3480299">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="3480341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480346">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480359">if</span>&nbsp;<span class="ident" id="3480362">keyDERBlock</span><span class="op" id="3480373">.</span><span class="ident" id="3480374">Type</span>&nbsp;<span class="op" id="3480379">==</span>&nbsp;<span class="string" id="3480382">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="3480396">||</span>&nbsp;<span class="ident" id="3480399">strings</span><span class="op" id="3480406">.</span><span class="ident" id="3480407">HasSuffix</span><span class="op" id="3480416">(</span><span class="ident" id="3480417">keyDERBlock</span><span class="op" id="3480428">.</span><span class="ident" id="3480429">Type</span><span class="op" id="3480433">,</span>&nbsp;<span class="string" id="3480435">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="3480449">)</span>&nbsp;<span class="op" id="3480451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480456">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480471">cert</span><span class="op" id="3480475">.</span><span class="ident" id="3480476">PrivateKey</span><span class="op" id="3480486">,</span>&nbsp;<span class="ident" id="3480488">err</span>&nbsp;<span class="op" id="3480492">=</span>&nbsp;<span class="ident" id="3480494">parsePrivateKey</span><span class="op" id="3480509">(</span><span class="ident" id="3480510">keyDERBlock</span><span class="op" id="3480521">.</span><span class="ident" id="3480522">Bytes</span><span class="op" id="3480527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480530">if</span>&nbsp;<span class="ident" id="3480533">err</span>&nbsp;<span class="op" id="3480537">!=</span>&nbsp;<span class="ident" id="3480540">nil</span>&nbsp;<span class="op" id="3480544">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480548">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480560">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480631">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480692">x509Cert</span><span class="op" id="3480700">,</span>&nbsp;<span class="ident" id="3480702">err</span>&nbsp;<span class="op" id="3480706">:=</span>&nbsp;<span class="ident" id="3480709">x509</span><span class="op" id="3480713">.</span><span class="ident" id="3480714">ParseCertificate</span><span class="op" id="3480730">(</span><span class="ident" id="3480731">cert</span><span class="op" id="3480735">.</span><span class="ident" id="3480736">Certificate</span><span class="op" id="3480747">[</span><span class="num" id="3480748">0</span><span class="op" id="3480749">]</span><span class="op" id="3480750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480753">if</span>&nbsp;<span class="ident" id="3480756">err</span>&nbsp;<span class="op" id="3480760">!=</span>&nbsp;<span class="ident" id="3480763">nil</span>&nbsp;<span class="op" id="3480767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480771">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480783">switch</span>&nbsp;<span class="ident" id="3480790">pub</span>&nbsp;<span class="op" id="3480794">:=</span>&nbsp;<span class="ident" id="3480797">x509Cert</span><span class="op" id="3480805">.</span><span class="ident" id="3480806">PublicKey</span><span class="op" id="3480815">.</span><span class="op" id="3480816">(</span><span class="keyword" id="3480817">type</span><span class="op" id="3480821">)</span>&nbsp;<span class="op" id="3480823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480826">case</span>&nbsp;<span class="op" id="3480831">*</span><span class="ident" id="3480832">rsa</span><span class="op" id="3480835">.</span><span class="ident" id="3480836">PublicKey</span><span class="op" id="3480845">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480849">priv</span><span class="op" id="3480853">,</span>&nbsp;<span class="ident" id="3480855">ok</span>&nbsp;<span class="op" id="3480858">:=</span>&nbsp;<span class="ident" id="3480861">cert</span><span class="op" id="3480865">.</span><span class="ident" id="3480866">PrivateKey</span><span class="op" id="3480876">.</span><span class="op" id="3480877">(</span><span class="op" id="3480878">*</span><span class="ident" id="3480879">rsa</span><span class="op" id="3480882">.</span><span class="ident" id="3480883">PrivateKey</span><span class="op" id="3480893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480897">if</span>&nbsp;<span class="op" id="3480900">!</span><span class="ident" id="3480901">ok</span>&nbsp;<span class="op" id="3480904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480909">err</span>&nbsp;<span class="op" id="3480913">=</span>&nbsp;<span class="ident" id="3480915">errors</span><span class="op" id="3480921">.</span><span class="ident" id="3480922">New</span><span class="op" id="3480925">(</span><span class="string" id="3480926">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="3480987">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480992">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481005">if</span>&nbsp;<span class="ident" id="3481008">pub</span><span class="op" id="3481011">.</span><span class="ident" id="3481012">N</span><span class="op" id="3481013">.</span><span class="ident" id="3481014">Cmp</span><span class="op" id="3481017">(</span><span class="ident" id="3481018">priv</span><span class="op" id="3481022">.</span><span class="ident" id="3481023">N</span><span class="op" id="3481024">)</span>&nbsp;<span class="op" id="3481026">!=</span>&nbsp;<span class="num" id="3481029">0</span>&nbsp;<span class="op" id="3481031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481036">err</span>&nbsp;<span class="op" id="3481040">=</span>&nbsp;<span class="ident" id="3481042">errors</span><span class="op" id="3481048">.</span><span class="ident" id="3481049">New</span><span class="op" id="3481052">(</span><span class="string" id="3481053">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="3481104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481109">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481121">case</span>&nbsp;<span class="op" id="3481126">*</span><span class="ident" id="3481127">ecdsa</span><span class="op" id="3481132">.</span><span class="ident" id="3481133">PublicKey</span><span class="op" id="3481142">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481146">priv</span><span class="op" id="3481150">,</span>&nbsp;<span class="ident" id="3481152">ok</span>&nbsp;<span class="op" id="3481155">:=</span>&nbsp;<span class="ident" id="3481158">cert</span><span class="op" id="3481162">.</span><span class="ident" id="3481163">PrivateKey</span><span class="op" id="3481173">.</span><span class="op" id="3481174">(</span><span class="op" id="3481175">*</span><span class="ident" id="3481176">ecdsa</span><span class="op" id="3481181">.</span><span class="ident" id="3481182">PrivateKey</span><span class="op" id="3481192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481196">if</span>&nbsp;<span class="op" id="3481199">!</span><span class="ident" id="3481200">ok</span>&nbsp;<span class="op" id="3481203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481208">err</span>&nbsp;<span class="op" id="3481212">=</span>&nbsp;<span class="ident" id="3481214">errors</span><span class="op" id="3481220">.</span><span class="ident" id="3481221">New</span><span class="op" id="3481224">(</span><span class="string" id="3481225">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="3481286">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481291">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481305">if</span>&nbsp;<span class="ident" id="3481308">pub</span><span class="op" id="3481311">.</span><span class="ident" id="3481312">X</span><span class="op" id="3481313">.</span><span class="ident" id="3481314">Cmp</span><span class="op" id="3481317">(</span><span class="ident" id="3481318">priv</span><span class="op" id="3481322">.</span><span class="ident" id="3481323">X</span><span class="op" id="3481324">)</span>&nbsp;<span class="op" id="3481326">!=</span>&nbsp;<span class="num" id="3481329">0</span>&nbsp;<span class="op" id="3481331">||</span>&nbsp;<span class="ident" id="3481334">pub</span><span class="op" id="3481337">.</span><span class="ident" id="3481338">Y</span><span class="op" id="3481339">.</span><span class="ident" id="3481340">Cmp</span><span class="op" id="3481343">(</span><span class="ident" id="3481344">priv</span><span class="op" id="3481348">.</span><span class="ident" id="3481349">Y</span><span class="op" id="3481350">)</span>&nbsp;<span class="op" id="3481352">!=</span>&nbsp;<span class="num" id="3481355">0</span>&nbsp;<span class="op" id="3481357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481362">err</span>&nbsp;<span class="op" id="3481366">=</span>&nbsp;<span class="ident" id="3481368">errors</span><span class="op" id="3481374">.</span><span class="ident" id="3481375">New</span><span class="op" id="3481378">(</span><span class="string" id="3481379">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="3481430">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481435">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481447">default</span><span class="op" id="3481454">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481458">err</span>&nbsp;<span class="op" id="3481462">=</span>&nbsp;<span class="ident" id="3481464">errors</span><span class="op" id="3481470">.</span><span class="ident" id="3481471">New</span><span class="op" id="3481474">(</span><span class="string" id="3481475">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="3481517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481521">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481533">return</span><br>
<span class="lineno"></span><span class="op" id="3481540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="3481543">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="3481620">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="3481698">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="3481777">func</span>&nbsp;<span class="ident" id="3481782">parsePrivateKey</span><span class="op" id="3481797">(</span><span class="ident" id="3481798">der</span>&nbsp;<span class="op" id="3481802">[</span><span class="op" id="3481803">]</span><span class="builtintype" id="3481804">byte</span><span class="op" id="3481808">)</span>&nbsp;<span class="op" id="3481810">(</span><span class="ident" id="3481811">crypto</span><span class="op" id="3481817">.</span><span class="ident" id="3481818">PrivateKey</span><span class="op" id="3481828">,</span>&nbsp;<span class="builtintype" id="3481830">error</span><span class="op" id="3481835">)</span>&nbsp;<span class="op" id="3481837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481840">if</span>&nbsp;<span class="ident" id="3481843">key</span><span class="op" id="3481846">,</span>&nbsp;<span class="ident" id="3481848">err</span>&nbsp;<span class="op" id="3481852">:=</span>&nbsp;<span class="ident" id="3481855">x509</span><span class="op" id="3481859">.</span><span class="ident" id="3481860">ParsePKCS1PrivateKey</span><span class="op" id="3481880">(</span><span class="ident" id="3481881">der</span><span class="op" id="3481884">)</span><span class="op" id="3481885">;</span>&nbsp;<span class="ident" id="3481887">err</span>&nbsp;<span class="op" id="3481891">==</span>&nbsp;<span class="ident" id="3481894">nil</span>&nbsp;<span class="op" id="3481898">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481902">return</span>&nbsp;<span class="ident" id="3481909">key</span><span class="op" id="3481912">,</span>&nbsp;<span class="ident" id="3481914">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481922">if</span>&nbsp;<span class="ident" id="3481925">key</span><span class="op" id="3481928">,</span>&nbsp;<span class="ident" id="3481930">err</span>&nbsp;<span class="op" id="3481934">:=</span>&nbsp;<span class="ident" id="3481937">x509</span><span class="op" id="3481941">.</span><span class="ident" id="3481942">ParsePKCS8PrivateKey</span><span class="op" id="3481962">(</span><span class="ident" id="3481963">der</span><span class="op" id="3481966">)</span><span class="op" id="3481967">;</span>&nbsp;<span class="ident" id="3481969">err</span>&nbsp;<span class="op" id="3481973">==</span>&nbsp;<span class="ident" id="3481976">nil</span>&nbsp;<span class="op" id="3481980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481984">switch</span>&nbsp;<span class="ident" id="3481991">key</span>&nbsp;<span class="op" id="3481995">:=</span>&nbsp;<span class="ident" id="3481998">key</span><span class="op" id="3482001">.</span><span class="op" id="3482002">(</span><span class="keyword" id="3482003">type</span><span class="op" id="3482007">)</span>&nbsp;<span class="op" id="3482009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482013">case</span>&nbsp;<span class="op" id="3482018">*</span><span class="ident" id="3482019">rsa</span><span class="op" id="3482022">.</span><span class="ident" id="3482023">PrivateKey</span><span class="op" id="3482033">,</span>&nbsp;<span class="op" id="3482035">*</span><span class="ident" id="3482036">ecdsa</span><span class="op" id="3482041">.</span><span class="ident" id="3482042">PrivateKey</span><span class="op" id="3482052">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482057">return</span>&nbsp;<span class="ident" id="3482064">key</span><span class="op" id="3482067">,</span>&nbsp;<span class="ident" id="3482069">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482075">default</span><span class="op" id="3482082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482087">return</span>&nbsp;<span class="ident" id="3482094">nil</span><span class="op" id="3482097">,</span>&nbsp;<span class="ident" id="3482099">errors</span><span class="op" id="3482105">.</span><span class="ident" id="3482106">New</span><span class="op" id="3482109">(</span><span class="string" id="3482110">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="3482173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482180">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482183">if</span>&nbsp;<span class="ident" id="3482186">key</span><span class="op" id="3482189">,</span>&nbsp;<span class="ident" id="3482191">err</span>&nbsp;<span class="op" id="3482195">:=</span>&nbsp;<span class="ident" id="3482198">x509</span><span class="op" id="3482202">.</span><span class="ident" id="3482203">ParseECPrivateKey</span><span class="op" id="3482220">(</span><span class="ident" id="3482221">der</span><span class="op" id="3482224">)</span><span class="op" id="3482225">;</span>&nbsp;<span class="ident" id="3482227">err</span>&nbsp;<span class="op" id="3482231">==</span>&nbsp;<span class="ident" id="3482234">nil</span>&nbsp;<span class="op" id="3482238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482242">return</span>&nbsp;<span class="ident" id="3482249">key</span><span class="op" id="3482252">,</span>&nbsp;<span class="ident" id="3482254">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482263">return</span>&nbsp;<span class="ident" id="3482270">nil</span><span class="op" id="3482273">,</span>&nbsp;<span class="ident" id="3482275">errors</span><span class="op" id="3482281">.</span><span class="ident" id="3482282">New</span><span class="op" id="3482285">(</span><span class="string" id="3482286">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="3482327">)</span><br>
<span class="lineno">275</span><span class="op" id="3482329">}</span>
</div>
</body>
</html>
