<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6617392">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6617447">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6617501">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6617552">package</span>&nbsp;<span class="ident" id="6617560">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6617565">import</span>&nbsp;<span class="op" id="6617572">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617575">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617598">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617608">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617615">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617628">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617639">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617650">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617661">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617669">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6617680">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6617687">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="6617690">func</span>&nbsp;<span class="ident" id="6617695">init</span><span class="op" id="6617699">(</span><span class="op" id="6617700">)</span>&nbsp;<span class="op" id="6617702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617705">type</span>&nbsp;<span class="ident" id="6617710">dbConn</span>&nbsp;<span class="keyword" id="6617717">struct</span>&nbsp;<span class="op" id="6617724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617728">db</span>&nbsp;<span class="op" id="6617731">*</span><span class="ident" id="6617732">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617737">c</span>&nbsp;&nbsp;<span class="op" id="6617740">*</span><span class="ident" id="6617741">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617753">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617756">freedFrom</span>&nbsp;<span class="op" id="6617766">:=</span>&nbsp;<span class="builtinfunc" id="6617769">make</span><span class="op" id="6617773">(</span><span class="keyword" id="6617774">map</span><span class="op" id="6617777">[</span><span class="ident" id="6617778">dbConn</span><span class="op" id="6617784">]</span><span class="builtintype" id="6617785">string</span><span class="op" id="6617791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617794">putConnHook</span>&nbsp;<span class="op" id="6617806">=</span>&nbsp;<span class="keyword" id="6617808">func</span><span class="op" id="6617812">(</span><span class="ident" id="6617813">db</span>&nbsp;<span class="op" id="6617816">*</span><span class="ident" id="6617817">DB</span><span class="op" id="6617819">,</span>&nbsp;<span class="ident" id="6617821">c</span>&nbsp;<span class="op" id="6617823">*</span><span class="ident" id="6617824">driverConn</span><span class="op" id="6617834">)</span>&nbsp;<span class="op" id="6617836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617840">idx</span>&nbsp;<span class="op" id="6617844">:=</span>&nbsp;<span class="op" id="6617847">-</span><span class="num" id="6617848">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617852">for</span>&nbsp;<span class="ident" id="6617856">i</span><span class="op" id="6617857">,</span>&nbsp;<span class="ident" id="6617859">v</span>&nbsp;<span class="op" id="6617861">:=</span>&nbsp;<span class="keyword" id="6617864">range</span>&nbsp;<span class="ident" id="6617870">db</span><span class="op" id="6617872">.</span><span class="ident" id="6617873">freeConn</span>&nbsp;<span class="op" id="6617882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617887">if</span>&nbsp;<span class="ident" id="6617890">v</span>&nbsp;<span class="op" id="6617892">==</span>&nbsp;<span class="ident" id="6617895">c</span>&nbsp;<span class="op" id="6617897">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6617903">idx</span>&nbsp;<span class="op" id="6617907">=</span>&nbsp;<span class="ident" id="6617909">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617915">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617932">if</span>&nbsp;<span class="ident" id="6617935">idx</span>&nbsp;<span class="op" id="6617939">&gt;=</span>&nbsp;<span class="num" id="6617942">0</span>&nbsp;<span class="op" id="6617944">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6617949">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6618022">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6618089">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6618123">println</span><span class="op" id="6618130">(</span><span class="string" id="6618131">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="6618174">+</span>&nbsp;<span class="ident" id="6618176">freedFrom</span><span class="op" id="6618185">[</span><span class="ident" id="6618186">dbConn</span><span class="op" id="6618192">{</span><span class="ident" id="6618193">db</span><span class="op" id="6618195">,</span>&nbsp;<span class="ident" id="6618197">c</span><span class="op" id="6618198">}</span><span class="op" id="6618199">]</span>&nbsp;<span class="op" id="6618201">+</span>&nbsp;<span class="string" id="6618203">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="6618218">+</span>&nbsp;<span class="ident" id="6618220">stack</span><span class="op" id="6618225">(</span><span class="op" id="6618226">)</span><span class="op" id="6618227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6618232">panic</span><span class="op" id="6618237">(</span><span class="string" id="6618238">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="6618260">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6618264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618268">freedFrom</span><span class="op" id="6618277">[</span><span class="ident" id="6618278">dbConn</span><span class="op" id="6618284">{</span><span class="ident" id="6618285">db</span><span class="op" id="6618287">,</span>&nbsp;<span class="ident" id="6618289">c</span><span class="op" id="6618290">}</span><span class="op" id="6618291">]</span>&nbsp;<span class="op" id="6618293">=</span>&nbsp;<span class="ident" id="6618295">stack</span><span class="op" id="6618300">(</span><span class="op" id="6618301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6618304">}</span><br>
<span class="lineno"></span><span class="op" id="6618306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="6618309">const</span>&nbsp;<span class="ident" id="6618315">fakeDBName</span>&nbsp;<span class="op" id="6618326">=</span>&nbsp;<span class="string" id="6618328">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6618335">var</span>&nbsp;<span class="ident" id="6618339">chrisBirthday</span>&nbsp;<span class="op" id="6618353">=</span>&nbsp;<span class="ident" id="6618355">time</span><span class="op" id="6618359">.</span><span class="ident" id="6618360">Unix</span><span class="op" id="6618364">(</span><span class="num" id="6618365">123456789</span><span class="op" id="6618374">,</span>&nbsp;<span class="num" id="6618376">0</span><span class="op" id="6618377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6618380">func</span>&nbsp;<span class="ident" id="6618385">newTestDB</span><span class="op" id="6618394">(</span><span class="ident" id="6618395">t</span>&nbsp;<span class="ident" id="6618397">testing</span><span class="op" id="6618404">.</span><span class="ident" id="6618405">TB</span><span class="op" id="6618407">,</span>&nbsp;<span class="ident" id="6618409">name</span>&nbsp;<span class="builtintype" id="6618414">string</span><span class="op" id="6618420">)</span>&nbsp;<span class="op" id="6618422">*</span><span class="ident" id="6618423">DB</span>&nbsp;<span class="op" id="6618426">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618429">db</span><span class="op" id="6618431">,</span>&nbsp;<span class="ident" id="6618433">err</span>&nbsp;<span class="op" id="6618437">:=</span>&nbsp;<span class="ident" id="6618440">Open</span><span class="op" id="6618444">(</span><span class="string" id="6618445">&#34;test&#34;</span><span class="op" id="6618451">,</span>&nbsp;<span class="ident" id="6618453">fakeDBName</span><span class="op" id="6618463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618466">if</span>&nbsp;<span class="ident" id="6618469">err</span>&nbsp;<span class="op" id="6618473">!=</span>&nbsp;<span class="ident" id="6618476">nil</span>&nbsp;<span class="op" id="6618480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618484">t</span><span class="op" id="6618485">.</span><span class="ident" id="6618486">Fatalf</span><span class="op" id="6618492">(</span><span class="string" id="6618493">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="6618503">,</span>&nbsp;<span class="ident" id="6618505">err</span><span class="op" id="6618508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6618511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618514">if</span>&nbsp;<span class="ident" id="6618517">_</span><span class="op" id="6618518">,</span>&nbsp;<span class="ident" id="6618520">err</span>&nbsp;<span class="op" id="6618524">:=</span>&nbsp;<span class="ident" id="6618527">db</span><span class="op" id="6618529">.</span><span class="ident" id="6618530">Exec</span><span class="op" id="6618534">(</span><span class="string" id="6618535">&#34;WIPE&#34;</span><span class="op" id="6618541">)</span><span class="op" id="6618542">;</span>&nbsp;<span class="ident" id="6618544">err</span>&nbsp;<span class="op" id="6618548">!=</span>&nbsp;<span class="ident" id="6618551">nil</span>&nbsp;<span class="op" id="6618555">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618559">t</span><span class="op" id="6618560">.</span><span class="ident" id="6618561">Fatalf</span><span class="op" id="6618567">(</span><span class="string" id="6618568">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="6618583">,</span>&nbsp;<span class="ident" id="6618585">err</span><span class="op" id="6618588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6618591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618594">if</span>&nbsp;<span class="ident" id="6618597">name</span>&nbsp;<span class="op" id="6618602">==</span>&nbsp;<span class="string" id="6618605">&#34;people&#34;</span>&nbsp;<span class="op" id="6618614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618618">exec</span><span class="op" id="6618622">(</span><span class="ident" id="6618623">t</span><span class="op" id="6618624">,</span>&nbsp;<span class="ident" id="6618626">db</span><span class="op" id="6618628">,</span>&nbsp;<span class="string" id="6618630">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="6618703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618707">exec</span><span class="op" id="6618711">(</span><span class="ident" id="6618712">t</span><span class="op" id="6618713">,</span>&nbsp;<span class="ident" id="6618715">db</span><span class="op" id="6618717">,</span>&nbsp;<span class="string" id="6618719">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="6618764">,</span>&nbsp;<span class="num" id="6618766">1</span><span class="op" id="6618767">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618771">exec</span><span class="op" id="6618775">(</span><span class="ident" id="6618776">t</span><span class="op" id="6618777">,</span>&nbsp;<span class="ident" id="6618779">db</span><span class="op" id="6618781">,</span>&nbsp;<span class="string" id="6618783">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="6618826">,</span>&nbsp;<span class="num" id="6618828">2</span><span class="op" id="6618829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6618833">exec</span><span class="op" id="6618837">(</span><span class="ident" id="6618838">t</span><span class="op" id="6618839">,</span>&nbsp;<span class="ident" id="6618841">db</span><span class="op" id="6618843">,</span>&nbsp;<span class="string" id="6618845">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6618898">,</span>&nbsp;<span class="num" id="6618900">3</span><span class="op" id="6618901">,</span>&nbsp;<span class="ident" id="6618903">chrisBirthday</span><span class="op" id="6618916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6618919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6618922">if</span>&nbsp;<span class="ident" id="6618925">name</span>&nbsp;<span class="op" id="6618930">==</span>&nbsp;<span class="string" id="6618933">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="6618946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6618950">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619009">exec</span><span class="op" id="6619013">(</span><span class="ident" id="6619014">t</span><span class="op" id="6619015">,</span>&nbsp;<span class="ident" id="6619017">db</span><span class="op" id="6619019">,</span>&nbsp;<span class="string" id="6619021">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="6619063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619067">exec</span><span class="op" id="6619071">(</span><span class="ident" id="6619072">t</span><span class="op" id="6619073">,</span>&nbsp;<span class="ident" id="6619075">db</span><span class="op" id="6619077">,</span>&nbsp;<span class="string" id="6619079">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="6619117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619123">return</span>&nbsp;<span class="ident" id="6619130">db</span><br>
<span class="lineno"></span><span class="op" id="6619133">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="6619136">func</span>&nbsp;<span class="ident" id="6619141">exec</span><span class="op" id="6619145">(</span><span class="ident" id="6619146">t</span>&nbsp;<span class="ident" id="6619148">testing</span><span class="op" id="6619155">.</span><span class="ident" id="6619156">TB</span><span class="op" id="6619158">,</span>&nbsp;<span class="ident" id="6619160">db</span>&nbsp;<span class="op" id="6619163">*</span><span class="ident" id="6619164">DB</span><span class="op" id="6619166">,</span>&nbsp;<span class="ident" id="6619168">query</span>&nbsp;<span class="builtintype" id="6619174">string</span><span class="op" id="6619180">,</span>&nbsp;<span class="ident" id="6619182">args</span>&nbsp;<span class="op" id="6619187">...</span><span class="keyword" id="6619190">interface</span><span class="op" id="6619199">{</span><span class="op" id="6619200">}</span><span class="op" id="6619201">)</span>&nbsp;<span class="op" id="6619203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619206">_</span><span class="op" id="6619207">,</span>&nbsp;<span class="ident" id="6619209">err</span>&nbsp;<span class="op" id="6619213">:=</span>&nbsp;<span class="ident" id="6619216">db</span><span class="op" id="6619218">.</span><span class="ident" id="6619219">Exec</span><span class="op" id="6619223">(</span><span class="ident" id="6619224">query</span><span class="op" id="6619229">,</span>&nbsp;<span class="ident" id="6619231">args</span><span class="op" id="6619235">...</span><span class="op" id="6619238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619241">if</span>&nbsp;<span class="ident" id="6619244">err</span>&nbsp;<span class="op" id="6619248">!=</span>&nbsp;<span class="ident" id="6619251">nil</span>&nbsp;<span class="op" id="6619255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619259">t</span><span class="op" id="6619260">.</span><span class="ident" id="6619261">Fatalf</span><span class="op" id="6619267">(</span><span class="string" id="6619268">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="6619284">,</span>&nbsp;<span class="ident" id="6619286">query</span><span class="op" id="6619291">,</span>&nbsp;<span class="ident" id="6619293">err</span><span class="op" id="6619296">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619299">}</span><br>
<span class="lineno"></span><span class="op" id="6619301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6619304">func</span>&nbsp;<span class="ident" id="6619309">closeDB</span><span class="op" id="6619316">(</span><span class="ident" id="6619317">t</span>&nbsp;<span class="ident" id="6619319">testing</span><span class="op" id="6619326">.</span><span class="ident" id="6619327">TB</span><span class="op" id="6619329">,</span>&nbsp;<span class="ident" id="6619331">db</span>&nbsp;<span class="op" id="6619334">*</span><span class="ident" id="6619335">DB</span><span class="op" id="6619337">)</span>&nbsp;<span class="op" id="6619339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619342">if</span>&nbsp;<span class="ident" id="6619345">e</span>&nbsp;<span class="op" id="6619347">:=</span>&nbsp;<span class="builtinfunc" id="6619350">recover</span><span class="op" id="6619357">(</span><span class="op" id="6619358">)</span><span class="op" id="6619359">;</span>&nbsp;<span class="ident" id="6619361">e</span>&nbsp;<span class="op" id="6619363">!=</span>&nbsp;<span class="ident" id="6619366">nil</span>&nbsp;<span class="op" id="6619370">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619374">fmt</span><span class="op" id="6619377">.</span><span class="ident" id="6619378">Printf</span><span class="op" id="6619384">(</span><span class="string" id="6619385">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="6619398">,</span>&nbsp;<span class="ident" id="6619400">e</span><span class="op" id="6619401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6619405">panic</span><span class="op" id="6619410">(</span><span class="ident" id="6619411">e</span><span class="op" id="6619412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619418">defer</span>&nbsp;<span class="ident" id="6619424">setHookpostCloseConn</span><span class="op" id="6619444">(</span><span class="ident" id="6619445">nil</span><span class="op" id="6619448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619451">setHookpostCloseConn</span><span class="op" id="6619471">(</span><span class="keyword" id="6619472">func</span><span class="op" id="6619476">(</span><span class="ident" id="6619477">_</span>&nbsp;<span class="op" id="6619479">*</span><span class="ident" id="6619480">fakeConn</span><span class="op" id="6619488">,</span>&nbsp;<span class="ident" id="6619490">err</span>&nbsp;<span class="builtintype" id="6619494">error</span><span class="op" id="6619499">)</span>&nbsp;<span class="op" id="6619501">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619505">if</span>&nbsp;<span class="ident" id="6619508">err</span>&nbsp;<span class="op" id="6619512">!=</span>&nbsp;<span class="ident" id="6619515">nil</span>&nbsp;<span class="op" id="6619519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619524">t</span><span class="op" id="6619525">.</span><span class="ident" id="6619526">Errorf</span><span class="op" id="6619532">(</span><span class="string" id="6619533">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6619561">,</span>&nbsp;<span class="ident" id="6619563">err</span><span class="op" id="6619566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619573">}</span><span class="op" id="6619574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619577">for</span>&nbsp;<span class="ident" id="6619581">i</span><span class="op" id="6619582">,</span>&nbsp;<span class="ident" id="6619584">dc</span>&nbsp;<span class="op" id="6619587">:=</span>&nbsp;<span class="keyword" id="6619590">range</span>&nbsp;<span class="ident" id="6619596">db</span><span class="op" id="6619598">.</span><span class="ident" id="6619599">freeConn</span>&nbsp;<span class="op" id="6619608">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619612">if</span>&nbsp;<span class="ident" id="6619615">n</span>&nbsp;<span class="op" id="6619617">:=</span>&nbsp;<span class="builtinfunc" id="6619620">len</span><span class="op" id="6619623">(</span><span class="ident" id="6619624">dc</span><span class="op" id="6619626">.</span><span class="ident" id="6619627">openStmt</span><span class="op" id="6619635">)</span><span class="op" id="6619636">;</span>&nbsp;<span class="ident" id="6619638">n</span>&nbsp;<span class="op" id="6619640">&gt;</span>&nbsp;<span class="num" id="6619642">0</span>&nbsp;<span class="op" id="6619644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6619649">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6619693">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6619742">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6619791">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6619838">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619867">t</span><span class="op" id="6619868">.</span><span class="ident" id="6619869">Errorf</span><span class="op" id="6619875">(</span><span class="string" id="6619876">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6619936">,</span>&nbsp;<span class="ident" id="6619938">i</span><span class="op" id="6619939">,</span>&nbsp;<span class="builtinfunc" id="6619941">len</span><span class="op" id="6619944">(</span><span class="ident" id="6619945">db</span><span class="op" id="6619947">.</span><span class="ident" id="6619948">freeConn</span><span class="op" id="6619956">)</span><span class="op" id="6619957">,</span>&nbsp;<span class="ident" id="6619959">n</span><span class="op" id="6619960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6619967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6619970">err</span>&nbsp;<span class="op" id="6619974">:=</span>&nbsp;<span class="ident" id="6619977">db</span><span class="op" id="6619979">.</span><span class="ident" id="6619980">Close</span><span class="op" id="6619985">(</span><span class="op" id="6619986">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6619989">if</span>&nbsp;<span class="ident" id="6619992">err</span>&nbsp;<span class="op" id="6619996">!=</span>&nbsp;<span class="ident" id="6619999">nil</span>&nbsp;<span class="op" id="6620003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620007">t</span><span class="op" id="6620008">.</span><span class="ident" id="6620009">Fatalf</span><span class="op" id="6620015">(</span><span class="string" id="6620016">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="6620038">,</span>&nbsp;<span class="ident" id="6620040">err</span><span class="op" id="6620043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620049">db</span><span class="op" id="6620051">.</span><span class="ident" id="6620052">mu</span><span class="op" id="6620054">.</span><span class="ident" id="6620055">Lock</span><span class="op" id="6620059">(</span><span class="op" id="6620060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620063">count</span>&nbsp;<span class="op" id="6620069">:=</span>&nbsp;<span class="ident" id="6620072">db</span><span class="op" id="6620074">.</span><span class="ident" id="6620075">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620084">db</span><span class="op" id="6620086">.</span><span class="ident" id="6620087">mu</span><span class="op" id="6620089">.</span><span class="ident" id="6620090">Unlock</span><span class="op" id="6620096">(</span><span class="op" id="6620097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620100">if</span>&nbsp;<span class="ident" id="6620103">count</span>&nbsp;<span class="op" id="6620109">!=</span>&nbsp;<span class="num" id="6620112">0</span>&nbsp;<span class="op" id="6620114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620118">t</span><span class="op" id="6620119">.</span><span class="ident" id="6620120">Fatalf</span><span class="op" id="6620126">(</span><span class="string" id="6620127">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="6620171">,</span>&nbsp;<span class="ident" id="6620173">db</span><span class="op" id="6620175">.</span><span class="ident" id="6620176">numOpen</span><span class="op" id="6620183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620186">}</span><br>
<span class="lineno"></span><span class="op" id="6620188">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="6620191">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6620258">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="6620291">func</span>&nbsp;<span class="ident" id="6620296">numPrepares</span><span class="op" id="6620307">(</span><span class="ident" id="6620308">t</span>&nbsp;<span class="op" id="6620310">*</span><span class="ident" id="6620311">testing</span><span class="op" id="6620318">.</span><span class="ident" id="6620319">T</span><span class="op" id="6620320">,</span>&nbsp;<span class="ident" id="6620322">db</span>&nbsp;<span class="op" id="6620325">*</span><span class="ident" id="6620326">DB</span><span class="op" id="6620328">)</span>&nbsp;<span class="builtintype" id="6620330">int</span>&nbsp;<span class="op" id="6620334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620337">if</span>&nbsp;<span class="ident" id="6620340">n</span>&nbsp;<span class="op" id="6620342">:=</span>&nbsp;<span class="builtinfunc" id="6620345">len</span><span class="op" id="6620348">(</span><span class="ident" id="6620349">db</span><span class="op" id="6620351">.</span><span class="ident" id="6620352">freeConn</span><span class="op" id="6620360">)</span><span class="op" id="6620361">;</span>&nbsp;<span class="ident" id="6620363">n</span>&nbsp;<span class="op" id="6620365">!=</span>&nbsp;<span class="num" id="6620368">1</span>&nbsp;<span class="op" id="6620370">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620374">t</span><span class="op" id="6620375">.</span><span class="ident" id="6620376">Fatalf</span><span class="op" id="6620382">(</span><span class="string" id="6620383">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6620408">,</span>&nbsp;<span class="ident" id="6620410">n</span><span class="op" id="6620411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620417">return</span>&nbsp;<span class="ident" id="6620424">db</span><span class="op" id="6620426">.</span><span class="ident" id="6620427">freeConn</span><span class="op" id="6620435">[</span><span class="num" id="6620436">0</span><span class="op" id="6620437">]</span><span class="op" id="6620438">.</span><span class="ident" id="6620439">ci</span><span class="op" id="6620441">.</span><span class="op" id="6620442">(</span><span class="op" id="6620443">*</span><span class="ident" id="6620444">fakeConn</span><span class="op" id="6620452">)</span><span class="op" id="6620453">.</span><span class="ident" id="6620454">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="6620465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="6620468">func</span>&nbsp;<span class="op" id="6620473">(</span><span class="ident" id="6620474">db</span>&nbsp;<span class="op" id="6620477">*</span><span class="ident" id="6620478">DB</span><span class="op" id="6620480">)</span>&nbsp;<span class="ident" id="6620482">numDeps</span><span class="op" id="6620489">(</span><span class="op" id="6620490">)</span>&nbsp;<span class="builtintype" id="6620492">int</span>&nbsp;<span class="op" id="6620496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620499">db</span><span class="op" id="6620501">.</span><span class="ident" id="6620502">mu</span><span class="op" id="6620504">.</span><span class="ident" id="6620505">Lock</span><span class="op" id="6620509">(</span><span class="op" id="6620510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620513">defer</span>&nbsp;<span class="ident" id="6620519">db</span><span class="op" id="6620521">.</span><span class="ident" id="6620522">mu</span><span class="op" id="6620524">.</span><span class="ident" id="6620525">Unlock</span><span class="op" id="6620531">(</span><span class="op" id="6620532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620535">return</span>&nbsp;<span class="builtinfunc" id="6620542">len</span><span class="op" id="6620545">(</span><span class="ident" id="6620546">db</span><span class="op" id="6620548">.</span><span class="ident" id="6620549">dep</span><span class="op" id="6620552">)</span><br>
<span class="lineno"></span><span class="op" id="6620554">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="6620557">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6620627">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="6620672">func</span>&nbsp;<span class="op" id="6620677">(</span><span class="ident" id="6620678">db</span>&nbsp;<span class="op" id="6620681">*</span><span class="ident" id="6620682">DB</span><span class="op" id="6620684">)</span>&nbsp;<span class="ident" id="6620686">numDepsPollUntil</span><span class="op" id="6620702">(</span><span class="ident" id="6620703">want</span>&nbsp;<span class="builtintype" id="6620708">int</span><span class="op" id="6620711">,</span>&nbsp;<span class="ident" id="6620713">d</span>&nbsp;<span class="ident" id="6620715">time</span><span class="op" id="6620719">.</span><span class="ident" id="6620720">Duration</span><span class="op" id="6620728">)</span>&nbsp;<span class="builtintype" id="6620730">int</span>&nbsp;<span class="op" id="6620734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620737">deadline</span>&nbsp;<span class="op" id="6620746">:=</span>&nbsp;<span class="ident" id="6620749">time</span><span class="op" id="6620753">.</span><span class="ident" id="6620754">Now</span><span class="op" id="6620757">(</span><span class="op" id="6620758">)</span><span class="op" id="6620759">.</span><span class="ident" id="6620760">Add</span><span class="op" id="6620763">(</span><span class="ident" id="6620764">d</span><span class="op" id="6620765">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620768">for</span>&nbsp;<span class="op" id="6620772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620776">n</span>&nbsp;<span class="op" id="6620778">:=</span>&nbsp;<span class="ident" id="6620781">db</span><span class="op" id="6620783">.</span><span class="ident" id="6620784">numDeps</span><span class="op" id="6620791">(</span><span class="op" id="6620792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620796">if</span>&nbsp;<span class="ident" id="6620799">n</span>&nbsp;<span class="op" id="6620801">&lt;=</span>&nbsp;<span class="ident" id="6620804">want</span>&nbsp;<span class="op" id="6620809">||</span>&nbsp;<span class="ident" id="6620812">time</span><span class="op" id="6620816">.</span><span class="ident" id="6620817">Now</span><span class="op" id="6620820">(</span><span class="op" id="6620821">)</span><span class="op" id="6620822">.</span><span class="ident" id="6620823">After</span><span class="op" id="6620828">(</span><span class="ident" id="6620829">deadline</span><span class="op" id="6620837">)</span>&nbsp;<span class="op" id="6620839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620844">return</span>&nbsp;<span class="ident" id="6620851">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620855">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620859">time</span><span class="op" id="6620863">.</span><span class="ident" id="6620864">Sleep</span><span class="op" id="6620869">(</span><span class="num" id="6620870">50</span>&nbsp;<span class="op" id="6620873">*</span>&nbsp;<span class="ident" id="6620875">time</span><span class="op" id="6620879">.</span><span class="ident" id="6620880">Millisecond</span><span class="op" id="6620891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6620894">}</span><br>
<span class="lineno"></span><span class="op" id="6620896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6620899">func</span>&nbsp;<span class="op" id="6620904">(</span><span class="ident" id="6620905">db</span>&nbsp;<span class="op" id="6620908">*</span><span class="ident" id="6620909">DB</span><span class="op" id="6620911">)</span>&nbsp;<span class="ident" id="6620913">numFreeConns</span><span class="op" id="6620925">(</span><span class="op" id="6620926">)</span>&nbsp;<span class="builtintype" id="6620928">int</span>&nbsp;<span class="op" id="6620932">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6620935">db</span><span class="op" id="6620937">.</span><span class="ident" id="6620938">mu</span><span class="op" id="6620940">.</span><span class="ident" id="6620941">Lock</span><span class="op" id="6620945">(</span><span class="op" id="6620946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620949">defer</span>&nbsp;<span class="ident" id="6620955">db</span><span class="op" id="6620957">.</span><span class="ident" id="6620958">mu</span><span class="op" id="6620960">.</span><span class="ident" id="6620961">Unlock</span><span class="op" id="6620967">(</span><span class="op" id="6620968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6620971">return</span>&nbsp;<span class="builtinfunc" id="6620978">len</span><span class="op" id="6620981">(</span><span class="ident" id="6620982">db</span><span class="op" id="6620984">.</span><span class="ident" id="6620985">freeConn</span><span class="op" id="6620993">)</span><br>
<span class="lineno"></span><span class="op" id="6620995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6620998">func</span>&nbsp;<span class="op" id="6621003">(</span><span class="ident" id="6621004">db</span>&nbsp;<span class="op" id="6621007">*</span><span class="ident" id="6621008">DB</span><span class="op" id="6621010">)</span>&nbsp;<span class="ident" id="6621012">dumpDeps</span><span class="op" id="6621020">(</span><span class="ident" id="6621021">t</span>&nbsp;<span class="op" id="6621023">*</span><span class="ident" id="6621024">testing</span><span class="op" id="6621031">.</span><span class="ident" id="6621032">T</span><span class="op" id="6621033">)</span>&nbsp;<span class="op" id="6621035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621038">for</span>&nbsp;<span class="ident" id="6621042">fc</span>&nbsp;<span class="op" id="6621045">:=</span>&nbsp;<span class="keyword" id="6621048">range</span>&nbsp;<span class="ident" id="6621054">db</span><span class="op" id="6621056">.</span><span class="ident" id="6621057">dep</span>&nbsp;<span class="op" id="6621061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621065">db</span><span class="op" id="6621067">.</span><span class="ident" id="6621068">dumpDep</span><span class="op" id="6621075">(</span><span class="ident" id="6621076">t</span><span class="op" id="6621077">,</span>&nbsp;<span class="num" id="6621079">0</span><span class="op" id="6621080">,</span>&nbsp;<span class="ident" id="6621082">fc</span><span class="op" id="6621084">,</span>&nbsp;<span class="keyword" id="6621086">map</span><span class="op" id="6621089">[</span><span class="ident" id="6621090">finalCloser</span><span class="op" id="6621101">]</span><span class="builtintype" id="6621102">bool</span><span class="op" id="6621106">{</span><span class="op" id="6621107">}</span><span class="op" id="6621108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621111">}</span><br>
<span class="lineno"></span><span class="op" id="6621113">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="6621116">func</span>&nbsp;<span class="op" id="6621121">(</span><span class="ident" id="6621122">db</span>&nbsp;<span class="op" id="6621125">*</span><span class="ident" id="6621126">DB</span><span class="op" id="6621128">)</span>&nbsp;<span class="ident" id="6621130">dumpDep</span><span class="op" id="6621137">(</span><span class="ident" id="6621138">t</span>&nbsp;<span class="op" id="6621140">*</span><span class="ident" id="6621141">testing</span><span class="op" id="6621148">.</span><span class="ident" id="6621149">T</span><span class="op" id="6621150">,</span>&nbsp;<span class="ident" id="6621152">depth</span>&nbsp;<span class="builtintype" id="6621158">int</span><span class="op" id="6621161">,</span>&nbsp;<span class="ident" id="6621163">dep</span>&nbsp;<span class="ident" id="6621167">finalCloser</span><span class="op" id="6621178">,</span>&nbsp;<span class="ident" id="6621180">seen</span>&nbsp;<span class="keyword" id="6621185">map</span><span class="op" id="6621188">[</span><span class="ident" id="6621189">finalCloser</span><span class="op" id="6621200">]</span><span class="builtintype" id="6621201">bool</span><span class="op" id="6621205">)</span>&nbsp;<span class="op" id="6621207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621210">seen</span><span class="op" id="6621214">[</span><span class="ident" id="6621215">dep</span><span class="op" id="6621218">]</span>&nbsp;<span class="op" id="6621220">=</span>&nbsp;<span class="builtintype" id="6621222">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621228">indent</span>&nbsp;<span class="op" id="6621235">:=</span>&nbsp;<span class="ident" id="6621238">strings</span><span class="op" id="6621245">.</span><span class="ident" id="6621246">Repeat</span><span class="op" id="6621252">(</span><span class="string" id="6621253">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="6621257">,</span>&nbsp;<span class="ident" id="6621259">depth</span><span class="op" id="6621264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621267">ds</span>&nbsp;<span class="op" id="6621270">:=</span>&nbsp;<span class="ident" id="6621273">db</span><span class="op" id="6621275">.</span><span class="ident" id="6621276">dep</span><span class="op" id="6621279">[</span><span class="ident" id="6621280">dep</span><span class="op" id="6621283">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621286">for</span>&nbsp;<span class="ident" id="6621290">k</span>&nbsp;<span class="op" id="6621292">:=</span>&nbsp;<span class="keyword" id="6621295">range</span>&nbsp;<span class="ident" id="6621301">ds</span>&nbsp;<span class="op" id="6621304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621308">t</span><span class="op" id="6621309">.</span><span class="ident" id="6621310">Logf</span><span class="op" id="6621314">(</span><span class="string" id="6621315">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="6621349">,</span>&nbsp;<span class="ident" id="6621351">indent</span><span class="op" id="6621357">,</span>&nbsp;<span class="ident" id="6621359">dep</span><span class="op" id="6621362">,</span>&nbsp;<span class="ident" id="6621364">dep</span><span class="op" id="6621367">,</span>&nbsp;<span class="ident" id="6621369">k</span><span class="op" id="6621370">,</span>&nbsp;<span class="ident" id="6621372">k</span><span class="op" id="6621373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621377">if</span>&nbsp;<span class="ident" id="6621380">fc</span><span class="op" id="6621382">,</span>&nbsp;<span class="ident" id="6621384">ok</span>&nbsp;<span class="op" id="6621387">:=</span>&nbsp;<span class="ident" id="6621390">k</span><span class="op" id="6621391">.</span><span class="op" id="6621392">(</span><span class="ident" id="6621393">finalCloser</span><span class="op" id="6621404">)</span><span class="op" id="6621405">;</span>&nbsp;<span class="ident" id="6621407">ok</span>&nbsp;<span class="op" id="6621410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621415">if</span>&nbsp;<span class="op" id="6621418">!</span><span class="ident" id="6621419">seen</span><span class="op" id="6621423">[</span><span class="ident" id="6621424">fc</span><span class="op" id="6621426">]</span>&nbsp;<span class="op" id="6621428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621434">db</span><span class="op" id="6621436">.</span><span class="ident" id="6621437">dumpDep</span><span class="op" id="6621444">(</span><span class="ident" id="6621445">t</span><span class="op" id="6621446">,</span>&nbsp;<span class="ident" id="6621448">depth</span><span class="op" id="6621453">+</span><span class="num" id="6621454">1</span><span class="op" id="6621455">,</span>&nbsp;<span class="ident" id="6621457">fc</span><span class="op" id="6621459">,</span>&nbsp;<span class="ident" id="6621461">seen</span><span class="op" id="6621465">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621477">}</span><br>
<span class="lineno"></span><span class="op" id="6621479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6621482">func</span>&nbsp;<span class="ident" id="6621487">TestQuery</span><span class="op" id="6621496">(</span><span class="ident" id="6621497">t</span>&nbsp;<span class="op" id="6621499">*</span><span class="ident" id="6621500">testing</span><span class="op" id="6621507">.</span><span class="ident" id="6621508">T</span><span class="op" id="6621509">)</span>&nbsp;<span class="op" id="6621511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621514">db</span>&nbsp;<span class="op" id="6621517">:=</span>&nbsp;<span class="ident" id="6621520">newTestDB</span><span class="op" id="6621529">(</span><span class="ident" id="6621530">t</span><span class="op" id="6621531">,</span>&nbsp;<span class="string" id="6621533">&#34;people&#34;</span><span class="op" id="6621541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621544">defer</span>&nbsp;<span class="ident" id="6621550">closeDB</span><span class="op" id="6621557">(</span><span class="ident" id="6621558">t</span><span class="op" id="6621559">,</span>&nbsp;<span class="ident" id="6621561">db</span><span class="op" id="6621563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621566">prepares0</span>&nbsp;<span class="op" id="6621576">:=</span>&nbsp;<span class="ident" id="6621579">numPrepares</span><span class="op" id="6621590">(</span><span class="ident" id="6621591">t</span><span class="op" id="6621592">,</span>&nbsp;<span class="ident" id="6621594">db</span><span class="op" id="6621596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621599">rows</span><span class="op" id="6621603">,</span>&nbsp;<span class="ident" id="6621605">err</span>&nbsp;<span class="op" id="6621609">:=</span>&nbsp;<span class="ident" id="6621612">db</span><span class="op" id="6621614">.</span><span class="ident" id="6621615">Query</span><span class="op" id="6621620">(</span><span class="string" id="6621621">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6621646">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621649">if</span>&nbsp;<span class="ident" id="6621652">err</span>&nbsp;<span class="op" id="6621656">!=</span>&nbsp;<span class="ident" id="6621659">nil</span>&nbsp;<span class="op" id="6621663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621667">t</span><span class="op" id="6621668">.</span><span class="ident" id="6621669">Fatalf</span><span class="op" id="6621675">(</span><span class="string" id="6621676">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6621687">,</span>&nbsp;<span class="ident" id="6621689">err</span><span class="op" id="6621692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621698">type</span>&nbsp;<span class="ident" id="6621703">row</span>&nbsp;<span class="keyword" id="6621707">struct</span>&nbsp;<span class="op" id="6621714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621718">age</span>&nbsp;&nbsp;<span class="builtintype" id="6621723">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621729">name</span>&nbsp;<span class="builtintype" id="6621734">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621745">got</span>&nbsp;<span class="op" id="6621749">:=</span>&nbsp;<span class="op" id="6621752">[</span><span class="op" id="6621753">]</span><span class="ident" id="6621754">row</span><span class="op" id="6621757">{</span><span class="op" id="6621758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621761">for</span>&nbsp;<span class="ident" id="6621765">rows</span><span class="op" id="6621769">.</span><span class="ident" id="6621770">Next</span><span class="op" id="6621774">(</span><span class="op" id="6621775">)</span>&nbsp;<span class="op" id="6621777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621781">var</span>&nbsp;<span class="ident" id="6621785">r</span>&nbsp;<span class="ident" id="6621787">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621793">err</span>&nbsp;<span class="op" id="6621797">=</span>&nbsp;<span class="ident" id="6621799">rows</span><span class="op" id="6621803">.</span><span class="ident" id="6621804">Scan</span><span class="op" id="6621808">(</span><span class="op" id="6621809">&amp;</span><span class="ident" id="6621810">r</span><span class="op" id="6621811">.</span><span class="ident" id="6621812">age</span><span class="op" id="6621815">,</span>&nbsp;<span class="op" id="6621817">&amp;</span><span class="ident" id="6621818">r</span><span class="op" id="6621819">.</span><span class="ident" id="6621820">name</span><span class="op" id="6621824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621828">if</span>&nbsp;<span class="ident" id="6621831">err</span>&nbsp;<span class="op" id="6621835">!=</span>&nbsp;<span class="ident" id="6621838">nil</span>&nbsp;<span class="op" id="6621842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621847">t</span><span class="op" id="6621848">.</span><span class="ident" id="6621849">Fatalf</span><span class="op" id="6621855">(</span><span class="string" id="6621856">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="6621866">,</span>&nbsp;<span class="ident" id="6621868">err</span><span class="op" id="6621871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621879">got</span>&nbsp;<span class="op" id="6621883">=</span>&nbsp;<span class="builtinfunc" id="6621885">append</span><span class="op" id="6621891">(</span><span class="ident" id="6621892">got</span><span class="op" id="6621895">,</span>&nbsp;<span class="ident" id="6621897">r</span><span class="op" id="6621898">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621904">err</span>&nbsp;<span class="op" id="6621908">=</span>&nbsp;<span class="ident" id="6621910">rows</span><span class="op" id="6621914">.</span><span class="ident" id="6621915">Err</span><span class="op" id="6621918">(</span><span class="op" id="6621919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6621922">if</span>&nbsp;<span class="ident" id="6621925">err</span>&nbsp;<span class="op" id="6621929">!=</span>&nbsp;<span class="ident" id="6621932">nil</span>&nbsp;<span class="op" id="6621936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621940">t</span><span class="op" id="6621941">.</span><span class="ident" id="6621942">Fatalf</span><span class="op" id="6621948">(</span><span class="string" id="6621949">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="6621958">,</span>&nbsp;<span class="ident" id="6621960">err</span><span class="op" id="6621963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621966">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6621969">want</span>&nbsp;<span class="op" id="6621974">:=</span>&nbsp;<span class="op" id="6621977">[</span><span class="op" id="6621978">]</span><span class="ident" id="6621979">row</span><span class="op" id="6621982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6621986">{</span><span class="ident" id="6621987">age</span><span class="op" id="6621990">:</span>&nbsp;<span class="num" id="6621992">1</span><span class="op" id="6621993">,</span>&nbsp;<span class="ident" id="6621995">name</span><span class="op" id="6621999">:</span>&nbsp;<span class="string" id="6622001">&#34;Alice&#34;</span><span class="op" id="6622008">}</span><span class="op" id="6622009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622013">{</span><span class="ident" id="6622014">age</span><span class="op" id="6622017">:</span>&nbsp;<span class="num" id="6622019">2</span><span class="op" id="6622020">,</span>&nbsp;<span class="ident" id="6622022">name</span><span class="op" id="6622026">:</span>&nbsp;<span class="string" id="6622028">&#34;Bob&#34;</span><span class="op" id="6622033">}</span><span class="op" id="6622034">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622038">{</span><span class="ident" id="6622039">age</span><span class="op" id="6622042">:</span>&nbsp;<span class="num" id="6622044">3</span><span class="op" id="6622045">,</span>&nbsp;<span class="ident" id="6622047">name</span><span class="op" id="6622051">:</span>&nbsp;<span class="string" id="6622053">&#34;Chris&#34;</span><span class="op" id="6622060">}</span><span class="op" id="6622061">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622064">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622067">if</span>&nbsp;<span class="op" id="6622070">!</span><span class="ident" id="6622071">reflect</span><span class="op" id="6622078">.</span><span class="ident" id="6622079">DeepEqual</span><span class="op" id="6622088">(</span><span class="ident" id="6622089">got</span><span class="op" id="6622092">,</span>&nbsp;<span class="ident" id="6622094">want</span><span class="op" id="6622098">)</span>&nbsp;<span class="op" id="6622100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622104">t</span><span class="op" id="6622105">.</span><span class="ident" id="6622106">Errorf</span><span class="op" id="6622112">(</span><span class="string" id="6622113">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="6622146">,</span>&nbsp;<span class="ident" id="6622148">got</span><span class="op" id="6622151">,</span>&nbsp;<span class="ident" id="6622153">want</span><span class="op" id="6622157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6622164">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6622227">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622264">if</span>&nbsp;<span class="ident" id="6622267">n</span>&nbsp;<span class="op" id="6622269">:=</span>&nbsp;<span class="ident" id="6622272">db</span><span class="op" id="6622274">.</span><span class="ident" id="6622275">numFreeConns</span><span class="op" id="6622287">(</span><span class="op" id="6622288">)</span><span class="op" id="6622289">;</span>&nbsp;<span class="ident" id="6622291">n</span>&nbsp;<span class="op" id="6622293">!=</span>&nbsp;<span class="num" id="6622296">1</span>&nbsp;<span class="op" id="6622298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622302">t</span><span class="op" id="6622303">.</span><span class="ident" id="6622304">Fatalf</span><span class="op" id="6622310">(</span><span class="string" id="6622311">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6622360">,</span>&nbsp;<span class="ident" id="6622362">n</span><span class="op" id="6622363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622369">if</span>&nbsp;<span class="ident" id="6622372">prepares</span>&nbsp;<span class="op" id="6622381">:=</span>&nbsp;<span class="ident" id="6622384">numPrepares</span><span class="op" id="6622395">(</span><span class="ident" id="6622396">t</span><span class="op" id="6622397">,</span>&nbsp;<span class="ident" id="6622399">db</span><span class="op" id="6622401">)</span>&nbsp;<span class="op" id="6622403">-</span>&nbsp;<span class="ident" id="6622405">prepares0</span><span class="op" id="6622414">;</span>&nbsp;<span class="ident" id="6622416">prepares</span>&nbsp;<span class="op" id="6622425">!=</span>&nbsp;<span class="num" id="6622428">1</span>&nbsp;<span class="op" id="6622430">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622434">t</span><span class="op" id="6622435">.</span><span class="ident" id="6622436">Errorf</span><span class="op" id="6622442">(</span><span class="string" id="6622443">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6622483">,</span>&nbsp;<span class="ident" id="6622485">prepares</span><span class="op" id="6622493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622496">}</span><br>
<span class="lineno"></span><span class="op" id="6622498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6622501">func</span>&nbsp;<span class="ident" id="6622506">TestByteOwnership</span><span class="op" id="6622523">(</span><span class="ident" id="6622524">t</span>&nbsp;<span class="op" id="6622526">*</span><span class="ident" id="6622527">testing</span><span class="op" id="6622534">.</span><span class="ident" id="6622535">T</span><span class="op" id="6622536">)</span>&nbsp;<span class="op" id="6622538">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622541">db</span>&nbsp;<span class="op" id="6622544">:=</span>&nbsp;<span class="ident" id="6622547">newTestDB</span><span class="op" id="6622556">(</span><span class="ident" id="6622557">t</span><span class="op" id="6622558">,</span>&nbsp;<span class="string" id="6622560">&#34;people&#34;</span><span class="op" id="6622568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622571">defer</span>&nbsp;<span class="ident" id="6622577">closeDB</span><span class="op" id="6622584">(</span><span class="ident" id="6622585">t</span><span class="op" id="6622586">,</span>&nbsp;<span class="ident" id="6622588">db</span><span class="op" id="6622590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622593">rows</span><span class="op" id="6622597">,</span>&nbsp;<span class="ident" id="6622599">err</span>&nbsp;<span class="op" id="6622603">:=</span>&nbsp;<span class="ident" id="6622606">db</span><span class="op" id="6622608">.</span><span class="ident" id="6622609">Query</span><span class="op" id="6622614">(</span><span class="string" id="6622615">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="6622642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622645">if</span>&nbsp;<span class="ident" id="6622648">err</span>&nbsp;<span class="op" id="6622652">!=</span>&nbsp;<span class="ident" id="6622655">nil</span>&nbsp;<span class="op" id="6622659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622663">t</span><span class="op" id="6622664">.</span><span class="ident" id="6622665">Fatalf</span><span class="op" id="6622671">(</span><span class="string" id="6622672">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6622683">,</span>&nbsp;<span class="ident" id="6622685">err</span><span class="op" id="6622688">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622694">type</span>&nbsp;<span class="ident" id="6622699">row</span>&nbsp;<span class="keyword" id="6622703">struct</span>&nbsp;<span class="op" id="6622710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622714">name</span>&nbsp;&nbsp;<span class="op" id="6622720">[</span><span class="op" id="6622721">]</span><span class="builtintype" id="6622722">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622729">photo</span>&nbsp;<span class="ident" id="6622735">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622745">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622748">got</span>&nbsp;<span class="op" id="6622752">:=</span>&nbsp;<span class="op" id="6622755">[</span><span class="op" id="6622756">]</span><span class="ident" id="6622757">row</span><span class="op" id="6622760">{</span><span class="op" id="6622761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622764">for</span>&nbsp;<span class="ident" id="6622768">rows</span><span class="op" id="6622772">.</span><span class="ident" id="6622773">Next</span><span class="op" id="6622777">(</span><span class="op" id="6622778">)</span>&nbsp;<span class="op" id="6622780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622784">var</span>&nbsp;<span class="ident" id="6622788">r</span>&nbsp;<span class="ident" id="6622790">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622796">err</span>&nbsp;<span class="op" id="6622800">=</span>&nbsp;<span class="ident" id="6622802">rows</span><span class="op" id="6622806">.</span><span class="ident" id="6622807">Scan</span><span class="op" id="6622811">(</span><span class="op" id="6622812">&amp;</span><span class="ident" id="6622813">r</span><span class="op" id="6622814">.</span><span class="ident" id="6622815">name</span><span class="op" id="6622819">,</span>&nbsp;<span class="op" id="6622821">&amp;</span><span class="ident" id="6622822">r</span><span class="op" id="6622823">.</span><span class="ident" id="6622824">photo</span><span class="op" id="6622829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6622833">if</span>&nbsp;<span class="ident" id="6622836">err</span>&nbsp;<span class="op" id="6622840">!=</span>&nbsp;<span class="ident" id="6622843">nil</span>&nbsp;<span class="op" id="6622847">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622852">t</span><span class="op" id="6622853">.</span><span class="ident" id="6622854">Fatalf</span><span class="op" id="6622860">(</span><span class="string" id="6622861">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="6622871">,</span>&nbsp;<span class="ident" id="6622873">err</span><span class="op" id="6622876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622884">got</span>&nbsp;<span class="op" id="6622888">=</span>&nbsp;<span class="builtinfunc" id="6622890">append</span><span class="op" id="6622896">(</span><span class="ident" id="6622897">got</span><span class="op" id="6622900">,</span>&nbsp;<span class="ident" id="6622902">r</span><span class="op" id="6622903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622909">corruptMemory</span>&nbsp;<span class="op" id="6622923">:=</span>&nbsp;<span class="op" id="6622926">[</span><span class="op" id="6622927">]</span><span class="builtintype" id="6622928">byte</span><span class="op" id="6622932">(</span><span class="string" id="6622933">&#34;\xffPHOTO&#34;</span><span class="op" id="6622944">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6622947">want</span>&nbsp;<span class="op" id="6622952">:=</span>&nbsp;<span class="op" id="6622955">[</span><span class="op" id="6622956">]</span><span class="ident" id="6622957">row</span><span class="op" id="6622960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6622964">{</span><span class="ident" id="6622965">name</span><span class="op" id="6622969">:</span>&nbsp;<span class="op" id="6622971">[</span><span class="op" id="6622972">]</span><span class="builtintype" id="6622973">byte</span><span class="op" id="6622977">(</span><span class="string" id="6622978">&#34;Alice&#34;</span><span class="op" id="6622985">)</span><span class="op" id="6622986">,</span>&nbsp;<span class="ident" id="6622988">photo</span><span class="op" id="6622993">:</span>&nbsp;<span class="ident" id="6622995">corruptMemory</span><span class="op" id="6623008">}</span><span class="op" id="6623009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623013">{</span><span class="ident" id="6623014">name</span><span class="op" id="6623018">:</span>&nbsp;<span class="op" id="6623020">[</span><span class="op" id="6623021">]</span><span class="builtintype" id="6623022">byte</span><span class="op" id="6623026">(</span><span class="string" id="6623027">&#34;Bob&#34;</span><span class="op" id="6623032">)</span><span class="op" id="6623033">,</span>&nbsp;<span class="ident" id="6623035">photo</span><span class="op" id="6623040">:</span>&nbsp;<span class="ident" id="6623042">corruptMemory</span><span class="op" id="6623055">}</span><span class="op" id="6623056">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623060">{</span><span class="ident" id="6623061">name</span><span class="op" id="6623065">:</span>&nbsp;<span class="op" id="6623067">[</span><span class="op" id="6623068">]</span><span class="builtintype" id="6623069">byte</span><span class="op" id="6623073">(</span><span class="string" id="6623074">&#34;Chris&#34;</span><span class="op" id="6623081">)</span><span class="op" id="6623082">,</span>&nbsp;<span class="ident" id="6623084">photo</span><span class="op" id="6623089">:</span>&nbsp;<span class="ident" id="6623091">corruptMemory</span><span class="op" id="6623104">}</span><span class="op" id="6623105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623108">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623111">if</span>&nbsp;<span class="op" id="6623114">!</span><span class="ident" id="6623115">reflect</span><span class="op" id="6623122">.</span><span class="ident" id="6623123">DeepEqual</span><span class="op" id="6623132">(</span><span class="ident" id="6623133">got</span><span class="op" id="6623136">,</span>&nbsp;<span class="ident" id="6623138">want</span><span class="op" id="6623142">)</span>&nbsp;<span class="op" id="6623144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623148">t</span><span class="op" id="6623149">.</span><span class="ident" id="6623150">Errorf</span><span class="op" id="6623156">(</span><span class="string" id="6623157">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="6623190">,</span>&nbsp;<span class="ident" id="6623192">got</span><span class="op" id="6623195">,</span>&nbsp;<span class="ident" id="6623197">want</span><span class="op" id="6623201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623208">var</span>&nbsp;<span class="ident" id="6623212">photo</span>&nbsp;<span class="ident" id="6623218">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623228">err</span>&nbsp;<span class="op" id="6623232">=</span>&nbsp;<span class="ident" id="6623234">db</span><span class="op" id="6623236">.</span><span class="ident" id="6623237">QueryRow</span><span class="op" id="6623245">(</span><span class="string" id="6623246">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="6623274">,</span>&nbsp;<span class="string" id="6623276">&#34;Alice&#34;</span><span class="op" id="6623283">)</span><span class="op" id="6623284">.</span><span class="ident" id="6623285">Scan</span><span class="op" id="6623289">(</span><span class="op" id="6623290">&amp;</span><span class="ident" id="6623291">photo</span><span class="op" id="6623296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623299">if</span>&nbsp;<span class="ident" id="6623302">err</span>&nbsp;<span class="op" id="6623306">==</span>&nbsp;<span class="ident" id="6623309">nil</span>&nbsp;<span class="op" id="6623313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623317">t</span><span class="op" id="6623318">.</span><span class="ident" id="6623319">Error</span><span class="op" id="6623324">(</span><span class="string" id="6623325">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="6623374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623377">}</span><br>
<span class="lineno"></span><span class="op" id="6623379">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="6623382">func</span>&nbsp;<span class="ident" id="6623387">TestRowsColumns</span><span class="op" id="6623402">(</span><span class="ident" id="6623403">t</span>&nbsp;<span class="op" id="6623405">*</span><span class="ident" id="6623406">testing</span><span class="op" id="6623413">.</span><span class="ident" id="6623414">T</span><span class="op" id="6623415">)</span>&nbsp;<span class="op" id="6623417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623420">db</span>&nbsp;<span class="op" id="6623423">:=</span>&nbsp;<span class="ident" id="6623426">newTestDB</span><span class="op" id="6623435">(</span><span class="ident" id="6623436">t</span><span class="op" id="6623437">,</span>&nbsp;<span class="string" id="6623439">&#34;people&#34;</span><span class="op" id="6623447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623450">defer</span>&nbsp;<span class="ident" id="6623456">closeDB</span><span class="op" id="6623463">(</span><span class="ident" id="6623464">t</span><span class="op" id="6623465">,</span>&nbsp;<span class="ident" id="6623467">db</span><span class="op" id="6623469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623472">rows</span><span class="op" id="6623476">,</span>&nbsp;<span class="ident" id="6623478">err</span>&nbsp;<span class="op" id="6623482">:=</span>&nbsp;<span class="ident" id="6623485">db</span><span class="op" id="6623487">.</span><span class="ident" id="6623488">Query</span><span class="op" id="6623493">(</span><span class="string" id="6623494">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6623519">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623522">if</span>&nbsp;<span class="ident" id="6623525">err</span>&nbsp;<span class="op" id="6623529">!=</span>&nbsp;<span class="ident" id="6623532">nil</span>&nbsp;<span class="op" id="6623536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623540">t</span><span class="op" id="6623541">.</span><span class="ident" id="6623542">Fatalf</span><span class="op" id="6623548">(</span><span class="string" id="6623549">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6623560">,</span>&nbsp;<span class="ident" id="6623562">err</span><span class="op" id="6623565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623571">cols</span><span class="op" id="6623575">,</span>&nbsp;<span class="ident" id="6623577">err</span>&nbsp;<span class="op" id="6623581">:=</span>&nbsp;<span class="ident" id="6623584">rows</span><span class="op" id="6623588">.</span><span class="ident" id="6623589">Columns</span><span class="op" id="6623596">(</span><span class="op" id="6623597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623600">if</span>&nbsp;<span class="ident" id="6623603">err</span>&nbsp;<span class="op" id="6623607">!=</span>&nbsp;<span class="ident" id="6623610">nil</span>&nbsp;<span class="op" id="6623614">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623618">t</span><span class="op" id="6623619">.</span><span class="ident" id="6623620">Fatalf</span><span class="op" id="6623626">(</span><span class="string" id="6623627">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="6623640">,</span>&nbsp;<span class="ident" id="6623642">err</span><span class="op" id="6623645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623651">want</span>&nbsp;<span class="op" id="6623656">:=</span>&nbsp;<span class="op" id="6623659">[</span><span class="op" id="6623660">]</span><span class="builtintype" id="6623661">string</span><span class="op" id="6623667">{</span><span class="string" id="6623668">&#34;age&#34;</span><span class="op" id="6623673">,</span>&nbsp;<span class="string" id="6623675">&#34;name&#34;</span><span class="op" id="6623681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623684">if</span>&nbsp;<span class="op" id="6623687">!</span><span class="ident" id="6623688">reflect</span><span class="op" id="6623695">.</span><span class="ident" id="6623696">DeepEqual</span><span class="op" id="6623705">(</span><span class="ident" id="6623706">cols</span><span class="op" id="6623710">,</span>&nbsp;<span class="ident" id="6623712">want</span><span class="op" id="6623716">)</span>&nbsp;<span class="op" id="6623718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623722">t</span><span class="op" id="6623723">.</span><span class="ident" id="6623724">Errorf</span><span class="op" id="6623730">(</span><span class="string" id="6623731">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6623750">,</span>&nbsp;<span class="ident" id="6623752">cols</span><span class="op" id="6623756">,</span>&nbsp;<span class="ident" id="6623758">want</span><span class="op" id="6623762">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623768">if</span>&nbsp;<span class="ident" id="6623771">err</span>&nbsp;<span class="op" id="6623775">:=</span>&nbsp;<span class="ident" id="6623778">rows</span><span class="op" id="6623782">.</span><span class="ident" id="6623783">Close</span><span class="op" id="6623788">(</span><span class="op" id="6623789">)</span><span class="op" id="6623790">;</span>&nbsp;<span class="ident" id="6623792">err</span>&nbsp;<span class="op" id="6623796">!=</span>&nbsp;<span class="ident" id="6623799">nil</span>&nbsp;<span class="op" id="6623803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623807">t</span><span class="op" id="6623808">.</span><span class="ident" id="6623809">Errorf</span><span class="op" id="6623815">(</span><span class="string" id="6623816">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="6623840">,</span>&nbsp;<span class="ident" id="6623842">err</span><span class="op" id="6623845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6623848">}</span><br>
<span class="lineno"></span><span class="op" id="6623850">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="6623853">func</span>&nbsp;<span class="ident" id="6623858">TestQueryRow</span><span class="op" id="6623870">(</span><span class="ident" id="6623871">t</span>&nbsp;<span class="op" id="6623873">*</span><span class="ident" id="6623874">testing</span><span class="op" id="6623881">.</span><span class="ident" id="6623882">T</span><span class="op" id="6623883">)</span>&nbsp;<span class="op" id="6623885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623888">db</span>&nbsp;<span class="op" id="6623891">:=</span>&nbsp;<span class="ident" id="6623894">newTestDB</span><span class="op" id="6623903">(</span><span class="ident" id="6623904">t</span><span class="op" id="6623905">,</span>&nbsp;<span class="string" id="6623907">&#34;people&#34;</span><span class="op" id="6623915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623918">defer</span>&nbsp;<span class="ident" id="6623924">closeDB</span><span class="op" id="6623931">(</span><span class="ident" id="6623932">t</span><span class="op" id="6623933">,</span>&nbsp;<span class="ident" id="6623935">db</span><span class="op" id="6623937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623940">var</span>&nbsp;<span class="ident" id="6623944">name</span>&nbsp;<span class="builtintype" id="6623949">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623957">var</span>&nbsp;<span class="ident" id="6623961">age</span>&nbsp;<span class="builtintype" id="6623965">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6623970">var</span>&nbsp;<span class="ident" id="6623974">birthday</span>&nbsp;<span class="ident" id="6623983">time</span><span class="op" id="6623987">.</span><span class="ident" id="6623988">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6623995">err</span>&nbsp;<span class="op" id="6623999">:=</span>&nbsp;<span class="ident" id="6624002">db</span><span class="op" id="6624004">.</span><span class="ident" id="6624005">QueryRow</span><span class="op" id="6624013">(</span><span class="string" id="6624014">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6624044">,</span>&nbsp;<span class="num" id="6624046">3</span><span class="op" id="6624047">)</span><span class="op" id="6624048">.</span><span class="ident" id="6624049">Scan</span><span class="op" id="6624053">(</span><span class="op" id="6624054">&amp;</span><span class="ident" id="6624055">age</span><span class="op" id="6624058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624061">if</span>&nbsp;<span class="ident" id="6624064">err</span>&nbsp;<span class="op" id="6624068">==</span>&nbsp;<span class="ident" id="6624071">nil</span>&nbsp;<span class="op" id="6624075">||</span>&nbsp;<span class="op" id="6624078">!</span><span class="ident" id="6624079">strings</span><span class="op" id="6624086">.</span><span class="ident" id="6624087">Contains</span><span class="op" id="6624095">(</span><span class="ident" id="6624096">err</span><span class="op" id="6624099">.</span><span class="ident" id="6624100">Error</span><span class="op" id="6624105">(</span><span class="op" id="6624106">)</span><span class="op" id="6624107">,</span>&nbsp;<span class="string" id="6624109">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="6624143">)</span>&nbsp;<span class="op" id="6624145">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624149">t</span><span class="op" id="6624150">.</span><span class="ident" id="6624151">Errorf</span><span class="op" id="6624157">(</span><span class="string" id="6624158">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="6624223">,</span>&nbsp;<span class="ident" id="6624225">err</span><span class="op" id="6624228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624235">err</span>&nbsp;<span class="op" id="6624239">=</span>&nbsp;<span class="ident" id="6624241">db</span><span class="op" id="6624243">.</span><span class="ident" id="6624244">QueryRow</span><span class="op" id="6624252">(</span><span class="string" id="6624253">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="6624280">,</span>&nbsp;<span class="num" id="6624282">3</span><span class="op" id="6624283">)</span><span class="op" id="6624284">.</span><span class="ident" id="6624285">Scan</span><span class="op" id="6624289">(</span><span class="op" id="6624290">&amp;</span><span class="ident" id="6624291">birthday</span><span class="op" id="6624299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624302">if</span>&nbsp;<span class="ident" id="6624305">err</span>&nbsp;<span class="op" id="6624309">!=</span>&nbsp;<span class="ident" id="6624312">nil</span>&nbsp;<span class="op" id="6624316">||</span>&nbsp;<span class="op" id="6624319">!</span><span class="ident" id="6624320">birthday</span><span class="op" id="6624328">.</span><span class="ident" id="6624329">Equal</span><span class="op" id="6624334">(</span><span class="ident" id="6624335">chrisBirthday</span><span class="op" id="6624348">)</span>&nbsp;<span class="op" id="6624350">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624354">t</span><span class="op" id="6624355">.</span><span class="ident" id="6624356">Errorf</span><span class="op" id="6624362">(</span><span class="string" id="6624363">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6624403">,</span>&nbsp;<span class="ident" id="6624405">birthday</span><span class="op" id="6624413">,</span>&nbsp;<span class="ident" id="6624415">err</span><span class="op" id="6624418">,</span>&nbsp;<span class="ident" id="6624420">chrisBirthday</span><span class="op" id="6624433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624440">err</span>&nbsp;<span class="op" id="6624444">=</span>&nbsp;<span class="ident" id="6624446">db</span><span class="op" id="6624448">.</span><span class="ident" id="6624449">QueryRow</span><span class="op" id="6624457">(</span><span class="string" id="6624458">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6624488">,</span>&nbsp;<span class="num" id="6624490">2</span><span class="op" id="6624491">)</span><span class="op" id="6624492">.</span><span class="ident" id="6624493">Scan</span><span class="op" id="6624497">(</span><span class="op" id="6624498">&amp;</span><span class="ident" id="6624499">age</span><span class="op" id="6624502">,</span>&nbsp;<span class="op" id="6624504">&amp;</span><span class="ident" id="6624505">name</span><span class="op" id="6624509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624512">if</span>&nbsp;<span class="ident" id="6624515">err</span>&nbsp;<span class="op" id="6624519">!=</span>&nbsp;<span class="ident" id="6624522">nil</span>&nbsp;<span class="op" id="6624526">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624530">t</span><span class="op" id="6624531">.</span><span class="ident" id="6624532">Fatalf</span><span class="op" id="6624538">(</span><span class="string" id="6624539">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6624562">,</span>&nbsp;<span class="ident" id="6624564">err</span><span class="op" id="6624567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624573">if</span>&nbsp;<span class="ident" id="6624576">name</span>&nbsp;<span class="op" id="6624581">!=</span>&nbsp;<span class="string" id="6624584">&#34;Bob&#34;</span>&nbsp;<span class="op" id="6624590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624594">t</span><span class="op" id="6624595">.</span><span class="ident" id="6624596">Errorf</span><span class="op" id="6624602">(</span><span class="string" id="6624603">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6624630">,</span>&nbsp;<span class="ident" id="6624632">name</span><span class="op" id="6624636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624639">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624642">if</span>&nbsp;<span class="ident" id="6624645">age</span>&nbsp;<span class="op" id="6624649">!=</span>&nbsp;<span class="num" id="6624652">2</span>&nbsp;<span class="op" id="6624654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624658">t</span><span class="op" id="6624659">.</span><span class="ident" id="6624660">Errorf</span><span class="op" id="6624666">(</span><span class="string" id="6624667">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6624691">,</span>&nbsp;<span class="ident" id="6624693">age</span><span class="op" id="6624696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624703">err</span>&nbsp;<span class="op" id="6624707">=</span>&nbsp;<span class="ident" id="6624709">db</span><span class="op" id="6624711">.</span><span class="ident" id="6624712">QueryRow</span><span class="op" id="6624720">(</span><span class="string" id="6624721">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="6624752">,</span>&nbsp;<span class="string" id="6624754">&#34;Alice&#34;</span><span class="op" id="6624761">)</span><span class="op" id="6624762">.</span><span class="ident" id="6624763">Scan</span><span class="op" id="6624767">(</span><span class="op" id="6624768">&amp;</span><span class="ident" id="6624769">age</span><span class="op" id="6624772">,</span>&nbsp;<span class="op" id="6624774">&amp;</span><span class="ident" id="6624775">name</span><span class="op" id="6624779">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624782">if</span>&nbsp;<span class="ident" id="6624785">err</span>&nbsp;<span class="op" id="6624789">!=</span>&nbsp;<span class="ident" id="6624792">nil</span>&nbsp;<span class="op" id="6624796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624800">t</span><span class="op" id="6624801">.</span><span class="ident" id="6624802">Fatalf</span><span class="op" id="6624808">(</span><span class="string" id="6624809">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6624833">,</span>&nbsp;<span class="ident" id="6624835">err</span><span class="op" id="6624838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624844">if</span>&nbsp;<span class="ident" id="6624847">name</span>&nbsp;<span class="op" id="6624852">!=</span>&nbsp;<span class="string" id="6624855">&#34;Alice&#34;</span>&nbsp;<span class="op" id="6624863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624867">t</span><span class="op" id="6624868">.</span><span class="ident" id="6624869">Errorf</span><span class="op" id="6624875">(</span><span class="string" id="6624876">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6624905">,</span>&nbsp;<span class="ident" id="6624907">name</span><span class="op" id="6624911">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624917">if</span>&nbsp;<span class="ident" id="6624920">age</span>&nbsp;<span class="op" id="6624924">!=</span>&nbsp;<span class="num" id="6624927">1</span>&nbsp;<span class="op" id="6624929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624933">t</span><span class="op" id="6624934">.</span><span class="ident" id="6624935">Errorf</span><span class="op" id="6624941">(</span><span class="string" id="6624942">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6624966">,</span>&nbsp;<span class="ident" id="6624968">age</span><span class="op" id="6624971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6624974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6624978">var</span>&nbsp;<span class="ident" id="6624982">photo</span>&nbsp;<span class="op" id="6624988">[</span><span class="op" id="6624989">]</span><span class="builtintype" id="6624990">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6624996">err</span>&nbsp;<span class="op" id="6625000">=</span>&nbsp;<span class="ident" id="6625002">db</span><span class="op" id="6625004">.</span><span class="ident" id="6625005">QueryRow</span><span class="op" id="6625013">(</span><span class="string" id="6625014">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="6625042">,</span>&nbsp;<span class="string" id="6625044">&#34;Alice&#34;</span><span class="op" id="6625051">)</span><span class="op" id="6625052">.</span><span class="ident" id="6625053">Scan</span><span class="op" id="6625057">(</span><span class="op" id="6625058">&amp;</span><span class="ident" id="6625059">photo</span><span class="op" id="6625064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625067">if</span>&nbsp;<span class="ident" id="6625070">err</span>&nbsp;<span class="op" id="6625074">!=</span>&nbsp;<span class="ident" id="6625077">nil</span>&nbsp;<span class="op" id="6625081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625085">t</span><span class="op" id="6625086">.</span><span class="ident" id="6625087">Fatalf</span><span class="op" id="6625093">(</span><span class="string" id="6625094">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6625119">,</span>&nbsp;<span class="ident" id="6625121">err</span><span class="op" id="6625124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625127">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625130">want</span>&nbsp;<span class="op" id="6625135">:=</span>&nbsp;<span class="op" id="6625138">[</span><span class="op" id="6625139">]</span><span class="builtintype" id="6625140">byte</span><span class="op" id="6625144">(</span><span class="string" id="6625145">&#34;APHOTO&#34;</span><span class="op" id="6625153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625156">if</span>&nbsp;<span class="op" id="6625159">!</span><span class="ident" id="6625160">reflect</span><span class="op" id="6625167">.</span><span class="ident" id="6625168">DeepEqual</span><span class="op" id="6625177">(</span><span class="ident" id="6625178">photo</span><span class="op" id="6625183">,</span>&nbsp;<span class="ident" id="6625185">want</span><span class="op" id="6625189">)</span>&nbsp;<span class="op" id="6625191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625195">t</span><span class="op" id="6625196">.</span><span class="ident" id="6625197">Errorf</span><span class="op" id="6625203">(</span><span class="string" id="6625204">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6625225">,</span>&nbsp;<span class="ident" id="6625227">photo</span><span class="op" id="6625232">,</span>&nbsp;<span class="ident" id="6625234">want</span><span class="op" id="6625238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625241">}</span><br>
<span class="lineno"></span><span class="op" id="6625243">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="6625246">func</span>&nbsp;<span class="ident" id="6625251">TestStatementErrorAfterClose</span><span class="op" id="6625279">(</span><span class="ident" id="6625280">t</span>&nbsp;<span class="op" id="6625282">*</span><span class="ident" id="6625283">testing</span><span class="op" id="6625290">.</span><span class="ident" id="6625291">T</span><span class="op" id="6625292">)</span>&nbsp;<span class="op" id="6625294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625297">db</span>&nbsp;<span class="op" id="6625300">:=</span>&nbsp;<span class="ident" id="6625303">newTestDB</span><span class="op" id="6625312">(</span><span class="ident" id="6625313">t</span><span class="op" id="6625314">,</span>&nbsp;<span class="string" id="6625316">&#34;people&#34;</span><span class="op" id="6625324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625327">defer</span>&nbsp;<span class="ident" id="6625333">closeDB</span><span class="op" id="6625340">(</span><span class="ident" id="6625341">t</span><span class="op" id="6625342">,</span>&nbsp;<span class="ident" id="6625344">db</span><span class="op" id="6625346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625349">stmt</span><span class="op" id="6625353">,</span>&nbsp;<span class="ident" id="6625355">err</span>&nbsp;<span class="op" id="6625359">:=</span>&nbsp;<span class="ident" id="6625362">db</span><span class="op" id="6625364">.</span><span class="ident" id="6625365">Prepare</span><span class="op" id="6625372">(</span><span class="string" id="6625373">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6625399">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625402">if</span>&nbsp;<span class="ident" id="6625405">err</span>&nbsp;<span class="op" id="6625409">!=</span>&nbsp;<span class="ident" id="6625412">nil</span>&nbsp;<span class="op" id="6625416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625420">t</span><span class="op" id="6625421">.</span><span class="ident" id="6625422">Fatalf</span><span class="op" id="6625428">(</span><span class="string" id="6625429">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6625442">,</span>&nbsp;<span class="ident" id="6625444">err</span><span class="op" id="6625447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625453">err</span>&nbsp;<span class="op" id="6625457">=</span>&nbsp;<span class="ident" id="6625459">stmt</span><span class="op" id="6625463">.</span><span class="ident" id="6625464">Close</span><span class="op" id="6625469">(</span><span class="op" id="6625470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625473">if</span>&nbsp;<span class="ident" id="6625476">err</span>&nbsp;<span class="op" id="6625480">!=</span>&nbsp;<span class="ident" id="6625483">nil</span>&nbsp;<span class="op" id="6625487">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625491">t</span><span class="op" id="6625492">.</span><span class="ident" id="6625493">Fatalf</span><span class="op" id="6625499">(</span><span class="string" id="6625500">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="6625511">,</span>&nbsp;<span class="ident" id="6625513">err</span><span class="op" id="6625516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625522">var</span>&nbsp;<span class="ident" id="6625526">name</span>&nbsp;<span class="builtintype" id="6625531">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625539">err</span>&nbsp;<span class="op" id="6625543">=</span>&nbsp;<span class="ident" id="6625545">stmt</span><span class="op" id="6625549">.</span><span class="ident" id="6625550">QueryRow</span><span class="op" id="6625558">(</span><span class="string" id="6625559">&#34;foo&#34;</span><span class="op" id="6625564">)</span><span class="op" id="6625565">.</span><span class="ident" id="6625566">Scan</span><span class="op" id="6625570">(</span><span class="op" id="6625571">&amp;</span><span class="ident" id="6625572">name</span><span class="op" id="6625576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625579">if</span>&nbsp;<span class="ident" id="6625582">err</span>&nbsp;<span class="op" id="6625586">==</span>&nbsp;<span class="ident" id="6625589">nil</span>&nbsp;<span class="op" id="6625593">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625597">t</span><span class="op" id="6625598">.</span><span class="ident" id="6625599">Errorf</span><span class="op" id="6625605">(</span><span class="string" id="6625606">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="6625658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625661">}</span><br>
<span class="lineno"></span><span class="op" id="6625663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6625666">func</span>&nbsp;<span class="ident" id="6625671">TestStatementQueryRow</span><span class="op" id="6625692">(</span><span class="ident" id="6625693">t</span>&nbsp;<span class="op" id="6625695">*</span><span class="ident" id="6625696">testing</span><span class="op" id="6625703">.</span><span class="ident" id="6625704">T</span><span class="op" id="6625705">)</span>&nbsp;<span class="op" id="6625707">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625710">db</span>&nbsp;<span class="op" id="6625713">:=</span>&nbsp;<span class="ident" id="6625716">newTestDB</span><span class="op" id="6625725">(</span><span class="ident" id="6625726">t</span><span class="op" id="6625727">,</span>&nbsp;<span class="string" id="6625729">&#34;people&#34;</span><span class="op" id="6625737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625740">defer</span>&nbsp;<span class="ident" id="6625746">closeDB</span><span class="op" id="6625753">(</span><span class="ident" id="6625754">t</span><span class="op" id="6625755">,</span>&nbsp;<span class="ident" id="6625757">db</span><span class="op" id="6625759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625762">stmt</span><span class="op" id="6625766">,</span>&nbsp;<span class="ident" id="6625768">err</span>&nbsp;<span class="op" id="6625772">:=</span>&nbsp;<span class="ident" id="6625775">db</span><span class="op" id="6625777">.</span><span class="ident" id="6625778">Prepare</span><span class="op" id="6625785">(</span><span class="string" id="6625786">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6625812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625815">if</span>&nbsp;<span class="ident" id="6625818">err</span>&nbsp;<span class="op" id="6625822">!=</span>&nbsp;<span class="ident" id="6625825">nil</span>&nbsp;<span class="op" id="6625829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625833">t</span><span class="op" id="6625834">.</span><span class="ident" id="6625835">Fatalf</span><span class="op" id="6625841">(</span><span class="string" id="6625842">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6625855">,</span>&nbsp;<span class="ident" id="6625857">err</span><span class="op" id="6625860">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625866">defer</span>&nbsp;<span class="ident" id="6625872">stmt</span><span class="op" id="6625876">.</span><span class="ident" id="6625877">Close</span><span class="op" id="6625882">(</span><span class="op" id="6625883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625886">var</span>&nbsp;<span class="ident" id="6625890">age</span>&nbsp;<span class="builtintype" id="6625894">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6625899">for</span>&nbsp;<span class="ident" id="6625903">n</span><span class="op" id="6625904">,</span>&nbsp;<span class="ident" id="6625906">tt</span>&nbsp;<span class="op" id="6625909">:=</span>&nbsp;<span class="keyword" id="6625912">range</span>&nbsp;<span class="op" id="6625918">[</span><span class="op" id="6625919">]</span><span class="keyword" id="6625920">struct</span>&nbsp;<span class="op" id="6625927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625931">name</span>&nbsp;<span class="builtintype" id="6625936">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6625945">want</span>&nbsp;<span class="builtintype" id="6625950">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625955">}</span><span class="op" id="6625956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625960">{</span><span class="string" id="6625961">&#34;Alice&#34;</span><span class="op" id="6625968">,</span>&nbsp;<span class="num" id="6625970">1</span><span class="op" id="6625971">}</span><span class="op" id="6625972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625976">{</span><span class="string" id="6625977">&#34;Bob&#34;</span><span class="op" id="6625982">,</span>&nbsp;<span class="num" id="6625984">2</span><span class="op" id="6625985">}</span><span class="op" id="6625986">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6625990">{</span><span class="string" id="6625991">&#34;Chris&#34;</span><span class="op" id="6625998">,</span>&nbsp;<span class="num" id="6626000">3</span><span class="op" id="6626001">}</span><span class="op" id="6626002">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626005">}</span>&nbsp;<span class="op" id="6626007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626011">if</span>&nbsp;<span class="ident" id="6626014">err</span>&nbsp;<span class="op" id="6626018">:=</span>&nbsp;<span class="ident" id="6626021">stmt</span><span class="op" id="6626025">.</span><span class="ident" id="6626026">QueryRow</span><span class="op" id="6626034">(</span><span class="ident" id="6626035">tt</span><span class="op" id="6626037">.</span><span class="ident" id="6626038">name</span><span class="op" id="6626042">)</span><span class="op" id="6626043">.</span><span class="ident" id="6626044">Scan</span><span class="op" id="6626048">(</span><span class="op" id="6626049">&amp;</span><span class="ident" id="6626050">age</span><span class="op" id="6626053">)</span><span class="op" id="6626054">;</span>&nbsp;<span class="ident" id="6626056">err</span>&nbsp;<span class="op" id="6626060">!=</span>&nbsp;<span class="ident" id="6626063">nil</span>&nbsp;<span class="op" id="6626067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626072">t</span><span class="op" id="6626073">.</span><span class="ident" id="6626074">Errorf</span><span class="op" id="6626080">(</span><span class="string" id="6626081">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="6626111">,</span>&nbsp;<span class="ident" id="6626113">n</span><span class="op" id="6626114">,</span>&nbsp;<span class="ident" id="6626116">tt</span><span class="op" id="6626118">.</span><span class="ident" id="6626119">name</span><span class="op" id="6626123">,</span>&nbsp;<span class="ident" id="6626125">err</span><span class="op" id="6626128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626132">}</span>&nbsp;<span class="keyword" id="6626134">else</span>&nbsp;<span class="keyword" id="6626139">if</span>&nbsp;<span class="ident" id="6626142">age</span>&nbsp;<span class="op" id="6626146">!=</span>&nbsp;<span class="ident" id="6626149">tt</span><span class="op" id="6626151">.</span><span class="ident" id="6626152">want</span>&nbsp;<span class="op" id="6626157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626162">t</span><span class="op" id="6626163">.</span><span class="ident" id="6626164">Errorf</span><span class="op" id="6626170">(</span><span class="string" id="6626171">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6626192">,</span>&nbsp;<span class="ident" id="6626194">n</span><span class="op" id="6626195">,</span>&nbsp;<span class="ident" id="6626197">age</span><span class="op" id="6626200">,</span>&nbsp;<span class="ident" id="6626202">tt</span><span class="op" id="6626204">.</span><span class="ident" id="6626205">want</span><span class="op" id="6626209">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626216">}</span><br>
<span class="lineno"></span><span class="op" id="6626218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6626221">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="6626246">func</span>&nbsp;<span class="ident" id="6626251">TestStatementQueryRowConcurrent</span><span class="op" id="6626282">(</span><span class="ident" id="6626283">t</span>&nbsp;<span class="op" id="6626285">*</span><span class="ident" id="6626286">testing</span><span class="op" id="6626293">.</span><span class="ident" id="6626294">T</span><span class="op" id="6626295">)</span>&nbsp;<span class="op" id="6626297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626300">db</span>&nbsp;<span class="op" id="6626303">:=</span>&nbsp;<span class="ident" id="6626306">newTestDB</span><span class="op" id="6626315">(</span><span class="ident" id="6626316">t</span><span class="op" id="6626317">,</span>&nbsp;<span class="string" id="6626319">&#34;people&#34;</span><span class="op" id="6626327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626330">defer</span>&nbsp;<span class="ident" id="6626336">closeDB</span><span class="op" id="6626343">(</span><span class="ident" id="6626344">t</span><span class="op" id="6626345">,</span>&nbsp;<span class="ident" id="6626347">db</span><span class="op" id="6626349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626352">stmt</span><span class="op" id="6626356">,</span>&nbsp;<span class="ident" id="6626358">err</span>&nbsp;<span class="op" id="6626362">:=</span>&nbsp;<span class="ident" id="6626365">db</span><span class="op" id="6626367">.</span><span class="ident" id="6626368">Prepare</span><span class="op" id="6626375">(</span><span class="string" id="6626376">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6626402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626405">if</span>&nbsp;<span class="ident" id="6626408">err</span>&nbsp;<span class="op" id="6626412">!=</span>&nbsp;<span class="ident" id="6626415">nil</span>&nbsp;<span class="op" id="6626419">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626423">t</span><span class="op" id="6626424">.</span><span class="ident" id="6626425">Fatalf</span><span class="op" id="6626431">(</span><span class="string" id="6626432">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6626445">,</span>&nbsp;<span class="ident" id="6626447">err</span><span class="op" id="6626450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626456">defer</span>&nbsp;<span class="ident" id="6626462">stmt</span><span class="op" id="6626466">.</span><span class="ident" id="6626467">Close</span><span class="op" id="6626472">(</span><span class="op" id="6626473">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626477">const</span>&nbsp;<span class="ident" id="6626483">n</span>&nbsp;<span class="op" id="6626485">=</span>&nbsp;<span class="num" id="6626487">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626491">ch</span>&nbsp;<span class="op" id="6626494">:=</span>&nbsp;<span class="builtinfunc" id="6626497">make</span><span class="op" id="6626501">(</span><span class="keyword" id="6626502">chan</span>&nbsp;<span class="builtintype" id="6626507">error</span><span class="op" id="6626512">,</span>&nbsp;<span class="ident" id="6626514">n</span><span class="op" id="6626515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626518">for</span>&nbsp;<span class="ident" id="6626522">i</span>&nbsp;<span class="op" id="6626524">:=</span>&nbsp;<span class="num" id="6626527">0</span><span class="op" id="6626528">;</span>&nbsp;<span class="ident" id="6626530">i</span>&nbsp;<span class="op" id="6626532">&lt;</span>&nbsp;<span class="ident" id="6626534">n</span><span class="op" id="6626535">;</span>&nbsp;<span class="ident" id="6626537">i</span><span class="op" id="6626538">++</span>&nbsp;<span class="op" id="6626541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626545">go</span>&nbsp;<span class="keyword" id="6626548">func</span><span class="op" id="6626552">(</span><span class="op" id="6626553">)</span>&nbsp;<span class="op" id="6626555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626560">var</span>&nbsp;<span class="ident" id="6626564">age</span>&nbsp;<span class="builtintype" id="6626568">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626575">err</span>&nbsp;<span class="op" id="6626579">:=</span>&nbsp;<span class="ident" id="6626582">stmt</span><span class="op" id="6626586">.</span><span class="ident" id="6626587">QueryRow</span><span class="op" id="6626595">(</span><span class="string" id="6626596">&#34;Alice&#34;</span><span class="op" id="6626603">)</span><span class="op" id="6626604">.</span><span class="ident" id="6626605">Scan</span><span class="op" id="6626609">(</span><span class="op" id="6626610">&amp;</span><span class="ident" id="6626611">age</span><span class="op" id="6626614">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626619">if</span>&nbsp;<span class="ident" id="6626622">err</span>&nbsp;<span class="op" id="6626626">==</span>&nbsp;<span class="ident" id="6626629">nil</span>&nbsp;<span class="op" id="6626633">&amp;&amp;</span>&nbsp;<span class="ident" id="6626636">age</span>&nbsp;<span class="op" id="6626640">!=</span>&nbsp;<span class="num" id="6626643">1</span>&nbsp;<span class="op" id="6626645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626651">err</span>&nbsp;<span class="op" id="6626655">=</span>&nbsp;<span class="ident" id="6626657">fmt</span><span class="op" id="6626660">.</span><span class="ident" id="6626661">Errorf</span><span class="op" id="6626667">(</span><span class="string" id="6626668">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="6626687">,</span>&nbsp;<span class="ident" id="6626689">age</span><span class="op" id="6626692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626702">ch</span>&nbsp;<span class="op" id="6626705">&lt;-</span>&nbsp;<span class="ident" id="6626708">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626714">}</span><span class="op" id="6626715">(</span><span class="op" id="6626716">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626722">for</span>&nbsp;<span class="ident" id="6626726">i</span>&nbsp;<span class="op" id="6626728">:=</span>&nbsp;<span class="num" id="6626731">0</span><span class="op" id="6626732">;</span>&nbsp;<span class="ident" id="6626734">i</span>&nbsp;<span class="op" id="6626736">&lt;</span>&nbsp;<span class="ident" id="6626738">n</span><span class="op" id="6626739">;</span>&nbsp;<span class="ident" id="6626741">i</span><span class="op" id="6626742">++</span>&nbsp;<span class="op" id="6626745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626749">if</span>&nbsp;<span class="ident" id="6626752">err</span>&nbsp;<span class="op" id="6626756">:=</span>&nbsp;<span class="op" id="6626759">&lt;-</span><span class="ident" id="6626761">ch</span><span class="op" id="6626763">;</span>&nbsp;<span class="ident" id="6626765">err</span>&nbsp;<span class="op" id="6626769">!=</span>&nbsp;<span class="ident" id="6626772">nil</span>&nbsp;<span class="op" id="6626776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626781">t</span><span class="op" id="6626782">.</span><span class="ident" id="6626783">Error</span><span class="op" id="6626788">(</span><span class="ident" id="6626789">err</span><span class="op" id="6626792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626796">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6626799">}</span><br>
<span class="lineno"></span><span class="op" id="6626801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6626804">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="6626836">func</span>&nbsp;<span class="ident" id="6626841">TestBogusPreboundParameters</span><span class="op" id="6626868">(</span><span class="ident" id="6626869">t</span>&nbsp;<span class="op" id="6626871">*</span><span class="ident" id="6626872">testing</span><span class="op" id="6626879">.</span><span class="ident" id="6626880">T</span><span class="op" id="6626881">)</span>&nbsp;<span class="op" id="6626883">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626886">db</span>&nbsp;<span class="op" id="6626889">:=</span>&nbsp;<span class="ident" id="6626892">newTestDB</span><span class="op" id="6626901">(</span><span class="ident" id="6626902">t</span><span class="op" id="6626903">,</span>&nbsp;<span class="string" id="6626905">&#34;foo&#34;</span><span class="op" id="6626910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6626913">defer</span>&nbsp;<span class="ident" id="6626919">closeDB</span><span class="op" id="6626926">(</span><span class="ident" id="6626927">t</span><span class="op" id="6626928">,</span>&nbsp;<span class="ident" id="6626930">db</span><span class="op" id="6626932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626935">exec</span><span class="op" id="6626939">(</span><span class="ident" id="6626940">t</span><span class="op" id="6626941">,</span>&nbsp;<span class="ident" id="6626943">db</span><span class="op" id="6626945">,</span>&nbsp;<span class="string" id="6626947">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6626990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6626993">_</span><span class="op" id="6626994">,</span>&nbsp;<span class="ident" id="6626996">err</span>&nbsp;<span class="op" id="6627000">:=</span>&nbsp;<span class="ident" id="6627003">db</span><span class="op" id="6627005">.</span><span class="ident" id="6627006">Prepare</span><span class="op" id="6627013">(</span><span class="string" id="6627014">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="6627052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627055">if</span>&nbsp;<span class="ident" id="6627058">err</span>&nbsp;<span class="op" id="6627062">==</span>&nbsp;<span class="ident" id="6627065">nil</span>&nbsp;<span class="op" id="6627069">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627073">t</span><span class="op" id="6627074">.</span><span class="ident" id="6627075">Fatalf</span><span class="op" id="6627081">(</span><span class="string" id="6627082">&#34;expected&nbsp;error&#34;</span><span class="op" id="6627098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627104">if</span>&nbsp;<span class="ident" id="6627107">err</span><span class="op" id="6627110">.</span><span class="ident" id="6627111">Error</span><span class="op" id="6627116">(</span><span class="op" id="6627117">)</span>&nbsp;<span class="op" id="6627119">!=</span>&nbsp;<span class="string" id="6627122">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="6627183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627187">t</span><span class="op" id="6627188">.</span><span class="ident" id="6627189">Errorf</span><span class="op" id="6627195">(</span><span class="string" id="6627196">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6627218">,</span>&nbsp;<span class="ident" id="6627220">err</span><span class="op" id="6627223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627226">}</span><br>
<span class="lineno">400</span><span class="op" id="6627228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6627231">func</span>&nbsp;<span class="ident" id="6627236">TestExec</span><span class="op" id="6627244">(</span><span class="ident" id="6627245">t</span>&nbsp;<span class="op" id="6627247">*</span><span class="ident" id="6627248">testing</span><span class="op" id="6627255">.</span><span class="ident" id="6627256">T</span><span class="op" id="6627257">)</span>&nbsp;<span class="op" id="6627259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627262">db</span>&nbsp;<span class="op" id="6627265">:=</span>&nbsp;<span class="ident" id="6627268">newTestDB</span><span class="op" id="6627277">(</span><span class="ident" id="6627278">t</span><span class="op" id="6627279">,</span>&nbsp;<span class="string" id="6627281">&#34;foo&#34;</span><span class="op" id="6627286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627289">defer</span>&nbsp;<span class="ident" id="6627295">closeDB</span><span class="op" id="6627302">(</span><span class="ident" id="6627303">t</span><span class="op" id="6627304">,</span>&nbsp;<span class="ident" id="6627306">db</span><span class="op" id="6627308">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627311">exec</span><span class="op" id="6627315">(</span><span class="ident" id="6627316">t</span><span class="op" id="6627317">,</span>&nbsp;<span class="ident" id="6627319">db</span><span class="op" id="6627321">,</span>&nbsp;<span class="string" id="6627323">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6627366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627369">stmt</span><span class="op" id="6627373">,</span>&nbsp;<span class="ident" id="6627375">err</span>&nbsp;<span class="op" id="6627379">:=</span>&nbsp;<span class="ident" id="6627382">db</span><span class="op" id="6627384">.</span><span class="ident" id="6627385">Prepare</span><span class="op" id="6627392">(</span><span class="string" id="6627393">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6627417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627420">if</span>&nbsp;<span class="ident" id="6627423">err</span>&nbsp;<span class="op" id="6627427">!=</span>&nbsp;<span class="ident" id="6627430">nil</span>&nbsp;<span class="op" id="6627434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627438">t</span><span class="op" id="6627439">.</span><span class="ident" id="6627440">Errorf</span><span class="op" id="6627446">(</span><span class="string" id="6627447">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6627467">,</span>&nbsp;<span class="ident" id="6627469">stmt</span><span class="op" id="6627473">,</span>&nbsp;<span class="ident" id="6627475">err</span><span class="op" id="6627478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627481">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627484">defer</span>&nbsp;<span class="ident" id="6627490">stmt</span><span class="op" id="6627494">.</span><span class="ident" id="6627495">Close</span><span class="op" id="6627500">(</span><span class="op" id="6627501">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6627505">type</span>&nbsp;<span class="ident" id="6627510">execTest</span>&nbsp;<span class="keyword" id="6627519">struct</span>&nbsp;<span class="op" id="6627526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627530">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6627538">[</span><span class="op" id="6627539">]</span><span class="keyword" id="6627540">interface</span><span class="op" id="6627549">{</span><span class="op" id="6627550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627554">wantErr</span>&nbsp;<span class="builtintype" id="6627562">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6627573">execTests</span>&nbsp;<span class="op" id="6627583">:=</span>&nbsp;<span class="op" id="6627586">[</span><span class="op" id="6627587">]</span><span class="ident" id="6627588">execTest</span><span class="op" id="6627596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6627600">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627611">{</span><span class="op" id="6627612">[</span><span class="op" id="6627613">]</span><span class="keyword" id="6627614">interface</span><span class="op" id="6627623">{</span><span class="op" id="6627624">}</span><span class="op" id="6627625">{</span><span class="string" id="6627626">&#34;Brad&#34;</span><span class="op" id="6627632">,</span>&nbsp;<span class="num" id="6627634">31</span><span class="op" id="6627636">}</span><span class="op" id="6627637">,</span>&nbsp;<span class="string" id="6627639">&#34;&#34;</span><span class="op" id="6627641">}</span><span class="op" id="6627642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627646">{</span><span class="op" id="6627647">[</span><span class="op" id="6627648">]</span><span class="keyword" id="6627649">interface</span><span class="op" id="6627658">{</span><span class="op" id="6627659">}</span><span class="op" id="6627660">{</span><span class="string" id="6627661">&#34;Brad&#34;</span><span class="op" id="6627667">,</span>&nbsp;<span class="ident" id="6627669">int64</span><span class="op" id="6627674">(</span><span class="num" id="6627675">31</span><span class="op" id="6627677">)</span><span class="op" id="6627678">}</span><span class="op" id="6627679">,</span>&nbsp;<span class="string" id="6627681">&#34;&#34;</span><span class="op" id="6627683">}</span><span class="op" id="6627684">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627688">{</span><span class="op" id="6627689">[</span><span class="op" id="6627690">]</span><span class="keyword" id="6627691">interface</span><span class="op" id="6627700">{</span><span class="op" id="6627701">}</span><span class="op" id="6627702">{</span><span class="string" id="6627703">&#34;Bob&#34;</span><span class="op" id="6627708">,</span>&nbsp;<span class="string" id="6627710">&#34;32&#34;</span><span class="op" id="6627714">}</span><span class="op" id="6627715">,</span>&nbsp;<span class="string" id="6627717">&#34;&#34;</span><span class="op" id="6627719">}</span><span class="op" id="6627720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627724">{</span><span class="op" id="6627725">[</span><span class="op" id="6627726">]</span><span class="keyword" id="6627727">interface</span><span class="op" id="6627736">{</span><span class="op" id="6627737">}</span><span class="op" id="6627738">{</span><span class="num" id="6627739">7</span><span class="op" id="6627740">,</span>&nbsp;<span class="num" id="6627742">9</span><span class="op" id="6627743">}</span><span class="op" id="6627744">,</span>&nbsp;<span class="string" id="6627746">&#34;&#34;</span><span class="op" id="6627748">}</span><span class="op" id="6627749">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6627754">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627780">{</span><span class="op" id="6627781">[</span><span class="op" id="6627782">]</span><span class="keyword" id="6627783">interface</span><span class="op" id="6627792">{</span><span class="op" id="6627793">}</span><span class="op" id="6627794">{</span><span class="string" id="6627795">&#34;Brad&#34;</span><span class="op" id="6627801">,</span>&nbsp;<span class="ident" id="6627803">int64</span><span class="op" id="6627808">(</span><span class="num" id="6627809">0xFFFFFFFF</span><span class="op" id="6627819">)</span><span class="op" id="6627820">}</span><span class="op" id="6627821">,</span>&nbsp;<span class="string" id="6627823">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="6627905">}</span><span class="op" id="6627906">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6627910">{</span><span class="op" id="6627911">[</span><span class="op" id="6627912">]</span><span class="keyword" id="6627913">interface</span><span class="op" id="6627922">{</span><span class="op" id="6627923">}</span><span class="op" id="6627924">{</span><span class="string" id="6627925">&#34;Brad&#34;</span><span class="op" id="6627931">,</span>&nbsp;<span class="string" id="6627933">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="6627947">}</span><span class="op" id="6627948">,</span>&nbsp;<span class="string" id="6627950">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="6628050">}</span><span class="op" id="6628051">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6628056">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628083">{</span><span class="op" id="6628084">[</span><span class="op" id="6628085">]</span><span class="keyword" id="6628086">interface</span><span class="op" id="6628095">{</span><span class="op" id="6628096">}</span><span class="op" id="6628097">{</span><span class="op" id="6628098">}</span><span class="op" id="6628099">,</span>&nbsp;<span class="string" id="6628101">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="6628135">}</span><span class="op" id="6628136">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628140">{</span><span class="op" id="6628141">[</span><span class="op" id="6628142">]</span><span class="keyword" id="6628143">interface</span><span class="op" id="6628152">{</span><span class="op" id="6628153">}</span><span class="op" id="6628154">{</span><span class="num" id="6628155">1</span><span class="op" id="6628156">,</span>&nbsp;<span class="num" id="6628158">2</span><span class="op" id="6628159">,</span>&nbsp;<span class="num" id="6628161">3</span><span class="op" id="6628162">}</span><span class="op" id="6628163">,</span>&nbsp;<span class="string" id="6628165">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="6628199">}</span><span class="op" id="6628200">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628206">for</span>&nbsp;<span class="ident" id="6628210">n</span><span class="op" id="6628211">,</span>&nbsp;<span class="ident" id="6628213">et</span>&nbsp;<span class="op" id="6628216">:=</span>&nbsp;<span class="keyword" id="6628219">range</span>&nbsp;<span class="ident" id="6628225">execTests</span>&nbsp;<span class="op" id="6628235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628239">_</span><span class="op" id="6628240">,</span>&nbsp;<span class="ident" id="6628242">err</span>&nbsp;<span class="op" id="6628246">:=</span>&nbsp;<span class="ident" id="6628249">stmt</span><span class="op" id="6628253">.</span><span class="ident" id="6628254">Exec</span><span class="op" id="6628258">(</span><span class="ident" id="6628259">et</span><span class="op" id="6628261">.</span><span class="ident" id="6628262">args</span><span class="op" id="6628266">...</span><span class="op" id="6628269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628273">errStr</span>&nbsp;<span class="op" id="6628280">:=</span>&nbsp;<span class="string" id="6628283">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628288">if</span>&nbsp;<span class="ident" id="6628291">err</span>&nbsp;<span class="op" id="6628295">!=</span>&nbsp;<span class="ident" id="6628298">nil</span>&nbsp;<span class="op" id="6628302">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628307">errStr</span>&nbsp;<span class="op" id="6628314">=</span>&nbsp;<span class="ident" id="6628316">err</span><span class="op" id="6628319">.</span><span class="ident" id="6628320">Error</span><span class="op" id="6628325">(</span><span class="op" id="6628326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628334">if</span>&nbsp;<span class="ident" id="6628337">errStr</span>&nbsp;<span class="op" id="6628344">!=</span>&nbsp;<span class="ident" id="6628347">et</span><span class="op" id="6628349">.</span><span class="ident" id="6628350">wantErr</span>&nbsp;<span class="op" id="6628358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628363">t</span><span class="op" id="6628364">.</span><span class="ident" id="6628365">Errorf</span><span class="op" id="6628371">(</span><span class="string" id="6628372">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="6628427">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628433">n</span><span class="op" id="6628434">,</span>&nbsp;<span class="ident" id="6628436">et</span><span class="op" id="6628438">.</span><span class="ident" id="6628439">args</span><span class="op" id="6628443">,</span>&nbsp;<span class="ident" id="6628445">errStr</span><span class="op" id="6628451">,</span>&nbsp;<span class="ident" id="6628453">et</span><span class="op" id="6628455">.</span><span class="ident" id="6628456">wantErr</span><span class="op" id="6628463">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628470">}</span><br>
<span class="lineno"></span><span class="op" id="6628472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6628475">func</span>&nbsp;<span class="ident" id="6628480">TestTxPrepare</span><span class="op" id="6628493">(</span><span class="ident" id="6628494">t</span>&nbsp;<span class="op" id="6628496">*</span><span class="ident" id="6628497">testing</span><span class="op" id="6628504">.</span><span class="ident" id="6628505">T</span><span class="op" id="6628506">)</span>&nbsp;<span class="op" id="6628508">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628511">db</span>&nbsp;<span class="op" id="6628514">:=</span>&nbsp;<span class="ident" id="6628517">newTestDB</span><span class="op" id="6628526">(</span><span class="ident" id="6628527">t</span><span class="op" id="6628528">,</span>&nbsp;<span class="string" id="6628530">&#34;&#34;</span><span class="op" id="6628532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628535">defer</span>&nbsp;<span class="ident" id="6628541">closeDB</span><span class="op" id="6628548">(</span><span class="ident" id="6628549">t</span><span class="op" id="6628550">,</span>&nbsp;<span class="ident" id="6628552">db</span><span class="op" id="6628554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628557">exec</span><span class="op" id="6628561">(</span><span class="ident" id="6628562">t</span><span class="op" id="6628563">,</span>&nbsp;<span class="ident" id="6628565">db</span><span class="op" id="6628567">,</span>&nbsp;<span class="string" id="6628569">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6628612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628615">tx</span><span class="op" id="6628617">,</span>&nbsp;<span class="ident" id="6628619">err</span>&nbsp;<span class="op" id="6628623">:=</span>&nbsp;<span class="ident" id="6628626">db</span><span class="op" id="6628628">.</span><span class="ident" id="6628629">Begin</span><span class="op" id="6628634">(</span><span class="op" id="6628635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628638">if</span>&nbsp;<span class="ident" id="6628641">err</span>&nbsp;<span class="op" id="6628645">!=</span>&nbsp;<span class="ident" id="6628648">nil</span>&nbsp;<span class="op" id="6628652">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628656">t</span><span class="op" id="6628657">.</span><span class="ident" id="6628658">Fatalf</span><span class="op" id="6628664">(</span><span class="string" id="6628665">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6628677">,</span>&nbsp;<span class="ident" id="6628679">err</span><span class="op" id="6628682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628688">stmt</span><span class="op" id="6628692">,</span>&nbsp;<span class="ident" id="6628694">err</span>&nbsp;<span class="op" id="6628698">:=</span>&nbsp;<span class="ident" id="6628701">tx</span><span class="op" id="6628703">.</span><span class="ident" id="6628704">Prepare</span><span class="op" id="6628711">(</span><span class="string" id="6628712">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6628736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628739">if</span>&nbsp;<span class="ident" id="6628742">err</span>&nbsp;<span class="op" id="6628746">!=</span>&nbsp;<span class="ident" id="6628749">nil</span>&nbsp;<span class="op" id="6628753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628757">t</span><span class="op" id="6628758">.</span><span class="ident" id="6628759">Fatalf</span><span class="op" id="6628765">(</span><span class="string" id="6628766">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6628786">,</span>&nbsp;<span class="ident" id="6628788">stmt</span><span class="op" id="6628792">,</span>&nbsp;<span class="ident" id="6628794">err</span><span class="op" id="6628797">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628803">defer</span>&nbsp;<span class="ident" id="6628809">stmt</span><span class="op" id="6628813">.</span><span class="ident" id="6628814">Close</span><span class="op" id="6628819">(</span><span class="op" id="6628820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628823">_</span><span class="op" id="6628824">,</span>&nbsp;<span class="ident" id="6628826">err</span>&nbsp;<span class="op" id="6628830">=</span>&nbsp;<span class="ident" id="6628832">stmt</span><span class="op" id="6628836">.</span><span class="ident" id="6628837">Exec</span><span class="op" id="6628841">(</span><span class="string" id="6628842">&#34;Bobby&#34;</span><span class="op" id="6628849">,</span>&nbsp;<span class="num" id="6628851">7</span><span class="op" id="6628852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628855">if</span>&nbsp;<span class="ident" id="6628858">err</span>&nbsp;<span class="op" id="6628862">!=</span>&nbsp;<span class="ident" id="6628865">nil</span>&nbsp;<span class="op" id="6628869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628873">t</span><span class="op" id="6628874">.</span><span class="ident" id="6628875">Fatalf</span><span class="op" id="6628881">(</span><span class="string" id="6628882">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6628893">,</span>&nbsp;<span class="ident" id="6628895">err</span><span class="op" id="6628898">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628904">err</span>&nbsp;<span class="op" id="6628908">=</span>&nbsp;<span class="ident" id="6628910">tx</span><span class="op" id="6628912">.</span><span class="ident" id="6628913">Commit</span><span class="op" id="6628919">(</span><span class="op" id="6628920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6628923">if</span>&nbsp;<span class="ident" id="6628926">err</span>&nbsp;<span class="op" id="6628930">!=</span>&nbsp;<span class="ident" id="6628933">nil</span>&nbsp;<span class="op" id="6628937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6628941">t</span><span class="op" id="6628942">.</span><span class="ident" id="6628943">Fatalf</span><span class="op" id="6628949">(</span><span class="string" id="6628950">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6628963">,</span>&nbsp;<span class="ident" id="6628965">err</span><span class="op" id="6628968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6628971">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6628974">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629020">if</span>&nbsp;<span class="op" id="6629023">!</span><span class="ident" id="6629024">stmt</span><span class="op" id="6629028">.</span><span class="ident" id="6629029">closed</span>&nbsp;<span class="op" id="6629036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629040">t</span><span class="op" id="6629041">.</span><span class="ident" id="6629042">Fatal</span><span class="op" id="6629047">(</span><span class="string" id="6629048">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="6629078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6629081">}</span><br>
<span class="lineno"></span><span class="op" id="6629083">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="6629086">func</span>&nbsp;<span class="ident" id="6629091">TestTxStmt</span><span class="op" id="6629101">(</span><span class="ident" id="6629102">t</span>&nbsp;<span class="op" id="6629104">*</span><span class="ident" id="6629105">testing</span><span class="op" id="6629112">.</span><span class="ident" id="6629113">T</span><span class="op" id="6629114">)</span>&nbsp;<span class="op" id="6629116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629119">db</span>&nbsp;<span class="op" id="6629122">:=</span>&nbsp;<span class="ident" id="6629125">newTestDB</span><span class="op" id="6629134">(</span><span class="ident" id="6629135">t</span><span class="op" id="6629136">,</span>&nbsp;<span class="string" id="6629138">&#34;&#34;</span><span class="op" id="6629140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629143">defer</span>&nbsp;<span class="ident" id="6629149">closeDB</span><span class="op" id="6629156">(</span><span class="ident" id="6629157">t</span><span class="op" id="6629158">,</span>&nbsp;<span class="ident" id="6629160">db</span><span class="op" id="6629162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629165">exec</span><span class="op" id="6629169">(</span><span class="ident" id="6629170">t</span><span class="op" id="6629171">,</span>&nbsp;<span class="ident" id="6629173">db</span><span class="op" id="6629175">,</span>&nbsp;<span class="string" id="6629177">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6629220">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629223">stmt</span><span class="op" id="6629227">,</span>&nbsp;<span class="ident" id="6629229">err</span>&nbsp;<span class="op" id="6629233">:=</span>&nbsp;<span class="ident" id="6629236">db</span><span class="op" id="6629238">.</span><span class="ident" id="6629239">Prepare</span><span class="op" id="6629246">(</span><span class="string" id="6629247">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6629271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629274">if</span>&nbsp;<span class="ident" id="6629277">err</span>&nbsp;<span class="op" id="6629281">!=</span>&nbsp;<span class="ident" id="6629284">nil</span>&nbsp;<span class="op" id="6629288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629292">t</span><span class="op" id="6629293">.</span><span class="ident" id="6629294">Fatalf</span><span class="op" id="6629300">(</span><span class="string" id="6629301">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6629321">,</span>&nbsp;<span class="ident" id="6629323">stmt</span><span class="op" id="6629327">,</span>&nbsp;<span class="ident" id="6629329">err</span><span class="op" id="6629332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6629335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629338">defer</span>&nbsp;<span class="ident" id="6629344">stmt</span><span class="op" id="6629348">.</span><span class="ident" id="6629349">Close</span><span class="op" id="6629354">(</span><span class="op" id="6629355">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629358">tx</span><span class="op" id="6629360">,</span>&nbsp;<span class="ident" id="6629362">err</span>&nbsp;<span class="op" id="6629366">:=</span>&nbsp;<span class="ident" id="6629369">db</span><span class="op" id="6629371">.</span><span class="ident" id="6629372">Begin</span><span class="op" id="6629377">(</span><span class="op" id="6629378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629381">if</span>&nbsp;<span class="ident" id="6629384">err</span>&nbsp;<span class="op" id="6629388">!=</span>&nbsp;<span class="ident" id="6629391">nil</span>&nbsp;<span class="op" id="6629395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629399">t</span><span class="op" id="6629400">.</span><span class="ident" id="6629401">Fatalf</span><span class="op" id="6629407">(</span><span class="string" id="6629408">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6629420">,</span>&nbsp;<span class="ident" id="6629422">err</span><span class="op" id="6629425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6629428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629431">txs</span>&nbsp;<span class="op" id="6629435">:=</span>&nbsp;<span class="ident" id="6629438">tx</span><span class="op" id="6629440">.</span><span class="ident" id="6629441">Stmt</span><span class="op" id="6629445">(</span><span class="ident" id="6629446">stmt</span><span class="op" id="6629450">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629453">defer</span>&nbsp;<span class="ident" id="6629459">txs</span><span class="op" id="6629462">.</span><span class="ident" id="6629463">Close</span><span class="op" id="6629468">(</span><span class="op" id="6629469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629472">_</span><span class="op" id="6629473">,</span>&nbsp;<span class="ident" id="6629475">err</span>&nbsp;<span class="op" id="6629479">=</span>&nbsp;<span class="ident" id="6629481">txs</span><span class="op" id="6629484">.</span><span class="ident" id="6629485">Exec</span><span class="op" id="6629489">(</span><span class="string" id="6629490">&#34;Bobby&#34;</span><span class="op" id="6629497">,</span>&nbsp;<span class="num" id="6629499">7</span><span class="op" id="6629500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629503">if</span>&nbsp;<span class="ident" id="6629506">err</span>&nbsp;<span class="op" id="6629510">!=</span>&nbsp;<span class="ident" id="6629513">nil</span>&nbsp;<span class="op" id="6629517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629521">t</span><span class="op" id="6629522">.</span><span class="ident" id="6629523">Fatalf</span><span class="op" id="6629529">(</span><span class="string" id="6629530">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6629541">,</span>&nbsp;<span class="ident" id="6629543">err</span><span class="op" id="6629546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6629549">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629552">err</span>&nbsp;<span class="op" id="6629556">=</span>&nbsp;<span class="ident" id="6629558">tx</span><span class="op" id="6629560">.</span><span class="ident" id="6629561">Commit</span><span class="op" id="6629567">(</span><span class="op" id="6629568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629571">if</span>&nbsp;<span class="ident" id="6629574">err</span>&nbsp;<span class="op" id="6629578">!=</span>&nbsp;<span class="ident" id="6629581">nil</span>&nbsp;<span class="op" id="6629585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629589">t</span><span class="op" id="6629590">.</span><span class="ident" id="6629591">Fatalf</span><span class="op" id="6629597">(</span><span class="string" id="6629598">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6629611">,</span>&nbsp;<span class="ident" id="6629613">err</span><span class="op" id="6629616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6629619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6629622">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629668">if</span>&nbsp;<span class="op" id="6629671">!</span><span class="ident" id="6629672">txs</span><span class="op" id="6629675">.</span><span class="ident" id="6629676">closed</span>&nbsp;<span class="op" id="6629683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629687">t</span><span class="op" id="6629688">.</span><span class="ident" id="6629689">Fatal</span><span class="op" id="6629694">(</span><span class="string" id="6629695">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="6629725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6629728">}</span><br>
<span class="lineno"></span><span class="op" id="6629730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="6629733">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="6629772">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="6629849">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="6629916">func</span>&nbsp;<span class="ident" id="6629921">TestTxQuery</span><span class="op" id="6629932">(</span><span class="ident" id="6629933">t</span>&nbsp;<span class="op" id="6629935">*</span><span class="ident" id="6629936">testing</span><span class="op" id="6629943">.</span><span class="ident" id="6629944">T</span><span class="op" id="6629945">)</span>&nbsp;<span class="op" id="6629947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629950">db</span>&nbsp;<span class="op" id="6629953">:=</span>&nbsp;<span class="ident" id="6629956">newTestDB</span><span class="op" id="6629965">(</span><span class="ident" id="6629966">t</span><span class="op" id="6629967">,</span>&nbsp;<span class="string" id="6629969">&#34;&#34;</span><span class="op" id="6629971">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6629974">defer</span>&nbsp;<span class="ident" id="6629980">closeDB</span><span class="op" id="6629987">(</span><span class="ident" id="6629988">t</span><span class="op" id="6629989">,</span>&nbsp;<span class="ident" id="6629991">db</span><span class="op" id="6629993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6629996">exec</span><span class="op" id="6630000">(</span><span class="ident" id="6630001">t</span><span class="op" id="6630002">,</span>&nbsp;<span class="ident" id="6630004">db</span><span class="op" id="6630006">,</span>&nbsp;<span class="string" id="6630008">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6630051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630054">exec</span><span class="op" id="6630058">(</span><span class="ident" id="6630059">t</span><span class="op" id="6630060">,</span>&nbsp;<span class="ident" id="6630062">db</span><span class="op" id="6630064">,</span>&nbsp;<span class="string" id="6630066">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="6630088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630092">tx</span><span class="op" id="6630094">,</span>&nbsp;<span class="ident" id="6630096">err</span>&nbsp;<span class="op" id="6630100">:=</span>&nbsp;<span class="ident" id="6630103">db</span><span class="op" id="6630105">.</span><span class="ident" id="6630106">Begin</span><span class="op" id="6630111">(</span><span class="op" id="6630112">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630115">if</span>&nbsp;<span class="ident" id="6630118">err</span>&nbsp;<span class="op" id="6630122">!=</span>&nbsp;<span class="ident" id="6630125">nil</span>&nbsp;<span class="op" id="6630129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630133">t</span><span class="op" id="6630134">.</span><span class="ident" id="6630135">Fatal</span><span class="op" id="6630140">(</span><span class="ident" id="6630141">err</span><span class="op" id="6630144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630150">defer</span>&nbsp;<span class="ident" id="6630156">tx</span><span class="op" id="6630158">.</span><span class="ident" id="6630159">Rollback</span><span class="op" id="6630167">(</span><span class="op" id="6630168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630172">r</span><span class="op" id="6630173">,</span>&nbsp;<span class="ident" id="6630175">err</span>&nbsp;<span class="op" id="6630179">:=</span>&nbsp;<span class="ident" id="6630182">tx</span><span class="op" id="6630184">.</span><span class="ident" id="6630185">Query</span><span class="op" id="6630190">(</span><span class="string" id="6630191">&#34;SELECT|t1|name|&#34;</span><span class="op" id="6630208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630211">if</span>&nbsp;<span class="ident" id="6630214">err</span>&nbsp;<span class="op" id="6630218">!=</span>&nbsp;<span class="ident" id="6630221">nil</span>&nbsp;<span class="op" id="6630225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630229">t</span><span class="op" id="6630230">.</span><span class="ident" id="6630231">Fatal</span><span class="op" id="6630236">(</span><span class="ident" id="6630237">err</span><span class="op" id="6630240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630246">defer</span>&nbsp;<span class="ident" id="6630252">r</span><span class="op" id="6630253">.</span><span class="ident" id="6630254">Close</span><span class="op" id="6630259">(</span><span class="op" id="6630260">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630264">if</span>&nbsp;<span class="op" id="6630267">!</span><span class="ident" id="6630268">r</span><span class="op" id="6630269">.</span><span class="ident" id="6630270">Next</span><span class="op" id="6630274">(</span><span class="op" id="6630275">)</span>&nbsp;<span class="op" id="6630277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630281">if</span>&nbsp;<span class="ident" id="6630284">r</span><span class="op" id="6630285">.</span><span class="ident" id="6630286">Err</span><span class="op" id="6630289">(</span><span class="op" id="6630290">)</span>&nbsp;<span class="op" id="6630292">!=</span>&nbsp;<span class="ident" id="6630295">nil</span>&nbsp;<span class="op" id="6630299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630304">t</span><span class="op" id="6630305">.</span><span class="ident" id="6630306">Fatal</span><span class="op" id="6630311">(</span><span class="ident" id="6630312">r</span><span class="op" id="6630313">.</span><span class="ident" id="6630314">Err</span><span class="op" id="6630317">(</span><span class="op" id="6630318">)</span><span class="op" id="6630319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630323">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630327">t</span><span class="op" id="6630328">.</span><span class="ident" id="6630329">Fatal</span><span class="op" id="6630334">(</span><span class="string" id="6630335">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="6630353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630360">var</span>&nbsp;<span class="ident" id="6630364">x</span>&nbsp;<span class="builtintype" id="6630366">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630374">err</span>&nbsp;<span class="op" id="6630378">=</span>&nbsp;<span class="ident" id="6630380">r</span><span class="op" id="6630381">.</span><span class="ident" id="6630382">Scan</span><span class="op" id="6630386">(</span><span class="op" id="6630387">&amp;</span><span class="ident" id="6630388">x</span><span class="op" id="6630389">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630392">if</span>&nbsp;<span class="ident" id="6630395">err</span>&nbsp;<span class="op" id="6630399">!=</span>&nbsp;<span class="ident" id="6630402">nil</span>&nbsp;<span class="op" id="6630406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630410">t</span><span class="op" id="6630411">.</span><span class="ident" id="6630412">Fatal</span><span class="op" id="6630417">(</span><span class="ident" id="6630418">err</span><span class="op" id="6630421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630424">}</span><br>
<span class="lineno"></span><span class="op" id="6630426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="6630429">func</span>&nbsp;<span class="ident" id="6630434">TestTxQueryInvalid</span><span class="op" id="6630452">(</span><span class="ident" id="6630453">t</span>&nbsp;<span class="op" id="6630455">*</span><span class="ident" id="6630456">testing</span><span class="op" id="6630463">.</span><span class="ident" id="6630464">T</span><span class="op" id="6630465">)</span>&nbsp;<span class="op" id="6630467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630470">db</span>&nbsp;<span class="op" id="6630473">:=</span>&nbsp;<span class="ident" id="6630476">newTestDB</span><span class="op" id="6630485">(</span><span class="ident" id="6630486">t</span><span class="op" id="6630487">,</span>&nbsp;<span class="string" id="6630489">&#34;&#34;</span><span class="op" id="6630491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630494">defer</span>&nbsp;<span class="ident" id="6630500">closeDB</span><span class="op" id="6630507">(</span><span class="ident" id="6630508">t</span><span class="op" id="6630509">,</span>&nbsp;<span class="ident" id="6630511">db</span><span class="op" id="6630513">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630517">tx</span><span class="op" id="6630519">,</span>&nbsp;<span class="ident" id="6630521">err</span>&nbsp;<span class="op" id="6630525">:=</span>&nbsp;<span class="ident" id="6630528">db</span><span class="op" id="6630530">.</span><span class="ident" id="6630531">Begin</span><span class="op" id="6630536">(</span><span class="op" id="6630537">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630540">if</span>&nbsp;<span class="ident" id="6630543">err</span>&nbsp;<span class="op" id="6630547">!=</span>&nbsp;<span class="ident" id="6630550">nil</span>&nbsp;<span class="op" id="6630554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630558">t</span><span class="op" id="6630559">.</span><span class="ident" id="6630560">Fatal</span><span class="op" id="6630565">(</span><span class="ident" id="6630566">err</span><span class="op" id="6630569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630575">defer</span>&nbsp;<span class="ident" id="6630581">tx</span><span class="op" id="6630583">.</span><span class="ident" id="6630584">Rollback</span><span class="op" id="6630592">(</span><span class="op" id="6630593">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630597">_</span><span class="op" id="6630598">,</span>&nbsp;<span class="ident" id="6630600">err</span>&nbsp;<span class="op" id="6630604">=</span>&nbsp;<span class="ident" id="6630606">tx</span><span class="op" id="6630608">.</span><span class="ident" id="6630609">Query</span><span class="op" id="6630614">(</span><span class="string" id="6630615">&#34;SELECT|t1|name|&#34;</span><span class="op" id="6630632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630635">if</span>&nbsp;<span class="ident" id="6630638">err</span>&nbsp;<span class="op" id="6630642">==</span>&nbsp;<span class="ident" id="6630645">nil</span>&nbsp;<span class="op" id="6630649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630653">t</span><span class="op" id="6630654">.</span><span class="ident" id="6630655">Fatal</span><span class="op" id="6630660">(</span><span class="string" id="6630661">&#34;Error&nbsp;expected&#34;</span><span class="op" id="6630677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630680">}</span><br>
<span class="lineno"></span><span class="op" id="6630682">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="6630685">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6630748">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="6630783">func</span>&nbsp;<span class="ident" id="6630788">TestTxErrBadConn</span><span class="op" id="6630804">(</span><span class="ident" id="6630805">t</span>&nbsp;<span class="op" id="6630807">*</span><span class="ident" id="6630808">testing</span><span class="op" id="6630815">.</span><span class="ident" id="6630816">T</span><span class="op" id="6630817">)</span>&nbsp;<span class="op" id="6630819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630822">db</span><span class="op" id="6630824">,</span>&nbsp;<span class="ident" id="6630826">err</span>&nbsp;<span class="op" id="6630830">:=</span>&nbsp;<span class="ident" id="6630833">Open</span><span class="op" id="6630837">(</span><span class="string" id="6630838">&#34;test&#34;</span><span class="op" id="6630844">,</span>&nbsp;<span class="ident" id="6630846">fakeDBName</span><span class="op" id="6630856">+</span><span class="string" id="6630857">&#34;;badConn&#34;</span><span class="op" id="6630867">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630870">if</span>&nbsp;<span class="ident" id="6630873">err</span>&nbsp;<span class="op" id="6630877">!=</span>&nbsp;<span class="ident" id="6630880">nil</span>&nbsp;<span class="op" id="6630884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630888">t</span><span class="op" id="6630889">.</span><span class="ident" id="6630890">Fatalf</span><span class="op" id="6630896">(</span><span class="string" id="6630897">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="6630907">,</span>&nbsp;<span class="ident" id="6630909">err</span><span class="op" id="6630912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630918">if</span>&nbsp;<span class="ident" id="6630921">_</span><span class="op" id="6630922">,</span>&nbsp;<span class="ident" id="6630924">err</span>&nbsp;<span class="op" id="6630928">:=</span>&nbsp;<span class="ident" id="6630931">db</span><span class="op" id="6630933">.</span><span class="ident" id="6630934">Exec</span><span class="op" id="6630938">(</span><span class="string" id="6630939">&#34;WIPE&#34;</span><span class="op" id="6630945">)</span><span class="op" id="6630946">;</span>&nbsp;<span class="ident" id="6630948">err</span>&nbsp;<span class="op" id="6630952">!=</span>&nbsp;<span class="ident" id="6630955">nil</span>&nbsp;<span class="op" id="6630959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6630963">t</span><span class="op" id="6630964">.</span><span class="ident" id="6630965">Fatalf</span><span class="op" id="6630971">(</span><span class="string" id="6630972">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="6630987">,</span>&nbsp;<span class="ident" id="6630989">err</span><span class="op" id="6630992">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6630995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6630998">defer</span>&nbsp;<span class="ident" id="6631004">closeDB</span><span class="op" id="6631011">(</span><span class="ident" id="6631012">t</span><span class="op" id="6631013">,</span>&nbsp;<span class="ident" id="6631015">db</span><span class="op" id="6631017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631020">exec</span><span class="op" id="6631024">(</span><span class="ident" id="6631025">t</span><span class="op" id="6631026">,</span>&nbsp;<span class="ident" id="6631028">db</span><span class="op" id="6631030">,</span>&nbsp;<span class="string" id="6631032">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6631075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631078">stmt</span><span class="op" id="6631082">,</span>&nbsp;<span class="ident" id="6631084">err</span>&nbsp;<span class="op" id="6631088">:=</span>&nbsp;<span class="ident" id="6631091">db</span><span class="op" id="6631093">.</span><span class="ident" id="6631094">Prepare</span><span class="op" id="6631101">(</span><span class="string" id="6631102">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6631126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631129">if</span>&nbsp;<span class="ident" id="6631132">err</span>&nbsp;<span class="op" id="6631136">!=</span>&nbsp;<span class="ident" id="6631139">nil</span>&nbsp;<span class="op" id="6631143">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631147">t</span><span class="op" id="6631148">.</span><span class="ident" id="6631149">Fatalf</span><span class="op" id="6631155">(</span><span class="string" id="6631156">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6631176">,</span>&nbsp;<span class="ident" id="6631178">stmt</span><span class="op" id="6631182">,</span>&nbsp;<span class="ident" id="6631184">err</span><span class="op" id="6631187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6631190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631193">defer</span>&nbsp;<span class="ident" id="6631199">stmt</span><span class="op" id="6631203">.</span><span class="ident" id="6631204">Close</span><span class="op" id="6631209">(</span><span class="op" id="6631210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631213">tx</span><span class="op" id="6631215">,</span>&nbsp;<span class="ident" id="6631217">err</span>&nbsp;<span class="op" id="6631221">:=</span>&nbsp;<span class="ident" id="6631224">db</span><span class="op" id="6631226">.</span><span class="ident" id="6631227">Begin</span><span class="op" id="6631232">(</span><span class="op" id="6631233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631236">if</span>&nbsp;<span class="ident" id="6631239">err</span>&nbsp;<span class="op" id="6631243">!=</span>&nbsp;<span class="ident" id="6631246">nil</span>&nbsp;<span class="op" id="6631250">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631254">t</span><span class="op" id="6631255">.</span><span class="ident" id="6631256">Fatalf</span><span class="op" id="6631262">(</span><span class="string" id="6631263">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6631275">,</span>&nbsp;<span class="ident" id="6631277">err</span><span class="op" id="6631280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6631283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631286">txs</span>&nbsp;<span class="op" id="6631290">:=</span>&nbsp;<span class="ident" id="6631293">tx</span><span class="op" id="6631295">.</span><span class="ident" id="6631296">Stmt</span><span class="op" id="6631300">(</span><span class="ident" id="6631301">stmt</span><span class="op" id="6631305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631308">defer</span>&nbsp;<span class="ident" id="6631314">txs</span><span class="op" id="6631317">.</span><span class="ident" id="6631318">Close</span><span class="op" id="6631323">(</span><span class="op" id="6631324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631327">_</span><span class="op" id="6631328">,</span>&nbsp;<span class="ident" id="6631330">err</span>&nbsp;<span class="op" id="6631334">=</span>&nbsp;<span class="ident" id="6631336">txs</span><span class="op" id="6631339">.</span><span class="ident" id="6631340">Exec</span><span class="op" id="6631344">(</span><span class="string" id="6631345">&#34;Bobby&#34;</span><span class="op" id="6631352">,</span>&nbsp;<span class="num" id="6631354">7</span><span class="op" id="6631355">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631358">if</span>&nbsp;<span class="ident" id="6631361">err</span>&nbsp;<span class="op" id="6631365">!=</span>&nbsp;<span class="ident" id="6631368">nil</span>&nbsp;<span class="op" id="6631372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631376">t</span><span class="op" id="6631377">.</span><span class="ident" id="6631378">Fatalf</span><span class="op" id="6631384">(</span><span class="string" id="6631385">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6631396">,</span>&nbsp;<span class="ident" id="6631398">err</span><span class="op" id="6631401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6631404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631407">err</span>&nbsp;<span class="op" id="6631411">=</span>&nbsp;<span class="ident" id="6631413">tx</span><span class="op" id="6631415">.</span><span class="ident" id="6631416">Commit</span><span class="op" id="6631422">(</span><span class="op" id="6631423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631426">if</span>&nbsp;<span class="ident" id="6631429">err</span>&nbsp;<span class="op" id="6631433">!=</span>&nbsp;<span class="ident" id="6631436">nil</span>&nbsp;<span class="op" id="6631440">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631444">t</span><span class="op" id="6631445">.</span><span class="ident" id="6631446">Fatalf</span><span class="op" id="6631452">(</span><span class="string" id="6631453">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6631466">,</span>&nbsp;<span class="ident" id="6631468">err</span><span class="op" id="6631471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6631474">}</span><br>
<span class="lineno"></span><span class="op" id="6631476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6631479">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="6631548">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6631572">func</span>&nbsp;<span class="ident" id="6631577">TestIssue2542Deadlock</span><span class="op" id="6631598">(</span><span class="ident" id="6631599">t</span>&nbsp;<span class="op" id="6631601">*</span><span class="ident" id="6631602">testing</span><span class="op" id="6631609">.</span><span class="ident" id="6631610">T</span><span class="op" id="6631611">)</span>&nbsp;<span class="op" id="6631613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631616">db</span>&nbsp;<span class="op" id="6631619">:=</span>&nbsp;<span class="ident" id="6631622">newTestDB</span><span class="op" id="6631631">(</span><span class="ident" id="6631632">t</span><span class="op" id="6631633">,</span>&nbsp;<span class="string" id="6631635">&#34;people&#34;</span><span class="op" id="6631643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631646">closeDB</span><span class="op" id="6631653">(</span><span class="ident" id="6631654">t</span><span class="op" id="6631655">,</span>&nbsp;<span class="ident" id="6631657">db</span><span class="op" id="6631659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631662">for</span>&nbsp;<span class="ident" id="6631666">i</span>&nbsp;<span class="op" id="6631668">:=</span>&nbsp;<span class="num" id="6631671">0</span><span class="op" id="6631672">;</span>&nbsp;<span class="ident" id="6631674">i</span>&nbsp;<span class="op" id="6631676">&lt;</span>&nbsp;<span class="num" id="6631678">2</span><span class="op" id="6631679">;</span>&nbsp;<span class="ident" id="6631681">i</span><span class="op" id="6631682">++</span>&nbsp;<span class="op" id="6631685">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631689">_</span><span class="op" id="6631690">,</span>&nbsp;<span class="ident" id="6631692">err</span>&nbsp;<span class="op" id="6631696">:=</span>&nbsp;<span class="ident" id="6631699">db</span><span class="op" id="6631701">.</span><span class="ident" id="6631702">Query</span><span class="op" id="6631707">(</span><span class="string" id="6631708">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6631733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631737">if</span>&nbsp;<span class="ident" id="6631740">err</span>&nbsp;<span class="op" id="6631744">==</span>&nbsp;<span class="ident" id="6631747">nil</span>&nbsp;<span class="op" id="6631751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631756">t</span><span class="op" id="6631757">.</span><span class="ident" id="6631758">Fatalf</span><span class="op" id="6631764">(</span><span class="string" id="6631765">&#34;expected&nbsp;error&#34;</span><span class="op" id="6631781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6631785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6631788">}</span><br>
<span class="lineno">595</span><span class="op" id="6631790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6631793">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="6631823">func</span>&nbsp;<span class="ident" id="6631828">TestCloseStmtBeforeRows</span><span class="op" id="6631851">(</span><span class="ident" id="6631852">t</span>&nbsp;<span class="op" id="6631854">*</span><span class="ident" id="6631855">testing</span><span class="op" id="6631862">.</span><span class="ident" id="6631863">T</span><span class="op" id="6631864">)</span>&nbsp;<span class="op" id="6631866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631869">db</span>&nbsp;<span class="op" id="6631872">:=</span>&nbsp;<span class="ident" id="6631875">newTestDB</span><span class="op" id="6631884">(</span><span class="ident" id="6631885">t</span><span class="op" id="6631886">,</span>&nbsp;<span class="string" id="6631888">&#34;people&#34;</span><span class="op" id="6631896">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631899">defer</span>&nbsp;<span class="ident" id="6631905">closeDB</span><span class="op" id="6631912">(</span><span class="ident" id="6631913">t</span><span class="op" id="6631914">,</span>&nbsp;<span class="ident" id="6631916">db</span><span class="op" id="6631918">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631922">s</span><span class="op" id="6631923">,</span>&nbsp;<span class="ident" id="6631925">err</span>&nbsp;<span class="op" id="6631929">:=</span>&nbsp;<span class="ident" id="6631932">db</span><span class="op" id="6631934">.</span><span class="ident" id="6631935">Prepare</span><span class="op" id="6631942">(</span><span class="string" id="6631943">&#34;SELECT|people|name|&#34;</span><span class="op" id="6631964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6631967">if</span>&nbsp;<span class="ident" id="6631970">err</span>&nbsp;<span class="op" id="6631974">!=</span>&nbsp;<span class="ident" id="6631977">nil</span>&nbsp;<span class="op" id="6631981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6631985">t</span><span class="op" id="6631986">.</span><span class="ident" id="6631987">Fatal</span><span class="op" id="6631992">(</span><span class="ident" id="6631993">err</span><span class="op" id="6631996">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6631999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632003">r</span><span class="op" id="6632004">,</span>&nbsp;<span class="ident" id="6632006">err</span>&nbsp;<span class="op" id="6632010">:=</span>&nbsp;<span class="ident" id="6632013">s</span><span class="op" id="6632014">.</span><span class="ident" id="6632015">Query</span><span class="op" id="6632020">(</span><span class="op" id="6632021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632024">if</span>&nbsp;<span class="ident" id="6632027">err</span>&nbsp;<span class="op" id="6632031">!=</span>&nbsp;<span class="ident" id="6632034">nil</span>&nbsp;<span class="op" id="6632038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632042">s</span><span class="op" id="6632043">.</span><span class="ident" id="6632044">Close</span><span class="op" id="6632049">(</span><span class="op" id="6632050">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632054">t</span><span class="op" id="6632055">.</span><span class="ident" id="6632056">Fatal</span><span class="op" id="6632061">(</span><span class="ident" id="6632062">err</span><span class="op" id="6632065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6632068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632072">err</span>&nbsp;<span class="op" id="6632076">=</span>&nbsp;<span class="ident" id="6632078">s</span><span class="op" id="6632079">.</span><span class="ident" id="6632080">Close</span><span class="op" id="6632085">(</span><span class="op" id="6632086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632089">if</span>&nbsp;<span class="ident" id="6632092">err</span>&nbsp;<span class="op" id="6632096">!=</span>&nbsp;<span class="ident" id="6632099">nil</span>&nbsp;<span class="op" id="6632103">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632107">t</span><span class="op" id="6632108">.</span><span class="ident" id="6632109">Fatal</span><span class="op" id="6632114">(</span><span class="ident" id="6632115">err</span><span class="op" id="6632118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6632121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632125">r</span><span class="op" id="6632126">.</span><span class="ident" id="6632127">Close</span><span class="op" id="6632132">(</span><span class="op" id="6632133">)</span><br>
<span class="lineno"></span><span class="op" id="6632135">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="6632138">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6632203">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="6632238">func</span>&nbsp;<span class="ident" id="6632243">TestNullByteSlice</span><span class="op" id="6632260">(</span><span class="ident" id="6632261">t</span>&nbsp;<span class="op" id="6632263">*</span><span class="ident" id="6632264">testing</span><span class="op" id="6632271">.</span><span class="ident" id="6632272">T</span><span class="op" id="6632273">)</span>&nbsp;<span class="op" id="6632275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632278">db</span>&nbsp;<span class="op" id="6632281">:=</span>&nbsp;<span class="ident" id="6632284">newTestDB</span><span class="op" id="6632293">(</span><span class="ident" id="6632294">t</span><span class="op" id="6632295">,</span>&nbsp;<span class="string" id="6632297">&#34;&#34;</span><span class="op" id="6632299">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632302">defer</span>&nbsp;<span class="ident" id="6632308">closeDB</span><span class="op" id="6632315">(</span><span class="ident" id="6632316">t</span><span class="op" id="6632317">,</span>&nbsp;<span class="ident" id="6632319">db</span><span class="op" id="6632321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632324">exec</span><span class="op" id="6632328">(</span><span class="ident" id="6632329">t</span><span class="op" id="6632330">,</span>&nbsp;<span class="ident" id="6632332">db</span><span class="op" id="6632334">,</span>&nbsp;<span class="string" id="6632336">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="6632371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632374">exec</span><span class="op" id="6632378">(</span><span class="ident" id="6632379">t</span><span class="op" id="6632380">,</span>&nbsp;<span class="ident" id="6632382">db</span><span class="op" id="6632384">,</span>&nbsp;<span class="string" id="6632386">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="6632409">,</span>&nbsp;<span class="ident" id="6632411">nil</span><span class="op" id="6632414">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632418">var</span>&nbsp;<span class="ident" id="6632422">name</span>&nbsp;<span class="op" id="6632427">[</span><span class="op" id="6632428">]</span><span class="builtintype" id="6632429">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632436">err</span>&nbsp;<span class="op" id="6632440">:=</span>&nbsp;<span class="ident" id="6632443">db</span><span class="op" id="6632445">.</span><span class="ident" id="6632446">QueryRow</span><span class="op" id="6632454">(</span><span class="string" id="6632455">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6632475">,</span>&nbsp;<span class="num" id="6632477">10</span><span class="op" id="6632479">)</span><span class="op" id="6632480">.</span><span class="ident" id="6632481">Scan</span><span class="op" id="6632485">(</span><span class="op" id="6632486">&amp;</span><span class="ident" id="6632487">name</span><span class="op" id="6632491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632494">if</span>&nbsp;<span class="ident" id="6632497">err</span>&nbsp;<span class="op" id="6632501">!=</span>&nbsp;<span class="ident" id="6632504">nil</span>&nbsp;<span class="op" id="6632508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632512">t</span><span class="op" id="6632513">.</span><span class="ident" id="6632514">Fatal</span><span class="op" id="6632519">(</span><span class="ident" id="6632520">err</span><span class="op" id="6632523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6632526">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632529">if</span>&nbsp;<span class="ident" id="6632532">name</span>&nbsp;<span class="op" id="6632537">!=</span>&nbsp;<span class="ident" id="6632540">nil</span>&nbsp;<span class="op" id="6632544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632548">t</span><span class="op" id="6632549">.</span><span class="ident" id="6632550">Fatalf</span><span class="op" id="6632556">(</span><span class="string" id="6632557">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="6632616">,</span>&nbsp;<span class="ident" id="6632618">name</span><span class="op" id="6632622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6632625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632629">exec</span><span class="op" id="6632633">(</span><span class="ident" id="6632634">t</span><span class="op" id="6632635">,</span>&nbsp;<span class="ident" id="6632637">db</span><span class="op" id="6632639">,</span>&nbsp;<span class="string" id="6632641">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="6632664">,</span>&nbsp;<span class="string" id="6632666">&#34;bob&#34;</span><span class="op" id="6632671">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632674">err</span>&nbsp;<span class="op" id="6632678">=</span>&nbsp;<span class="ident" id="6632680">db</span><span class="op" id="6632682">.</span><span class="ident" id="6632683">QueryRow</span><span class="op" id="6632691">(</span><span class="string" id="6632692">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6632712">,</span>&nbsp;<span class="num" id="6632714">11</span><span class="op" id="6632716">)</span><span class="op" id="6632717">.</span><span class="ident" id="6632718">Scan</span><span class="op" id="6632722">(</span><span class="op" id="6632723">&amp;</span><span class="ident" id="6632724">name</span><span class="op" id="6632728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632731">if</span>&nbsp;<span class="ident" id="6632734">err</span>&nbsp;<span class="op" id="6632738">!=</span>&nbsp;<span class="ident" id="6632741">nil</span>&nbsp;<span class="op" id="6632745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632749">t</span><span class="op" id="6632750">.</span><span class="ident" id="6632751">Fatal</span><span class="op" id="6632756">(</span><span class="ident" id="6632757">err</span><span class="op" id="6632760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6632763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632766">if</span>&nbsp;<span class="builtintype" id="6632769">string</span><span class="op" id="6632775">(</span><span class="ident" id="6632776">name</span><span class="op" id="6632780">)</span>&nbsp;<span class="op" id="6632782">!=</span>&nbsp;<span class="string" id="6632785">&#34;bob&#34;</span>&nbsp;<span class="op" id="6632791">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632795">t</span><span class="op" id="6632796">.</span><span class="ident" id="6632797">Fatalf</span><span class="op" id="6632803">(</span><span class="string" id="6632804">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="6632840">,</span>&nbsp;<span class="builtintype" id="6632842">string</span><span class="op" id="6632848">(</span><span class="ident" id="6632849">name</span><span class="op" id="6632853">)</span><span class="op" id="6632854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6632857">}</span><br>
<span class="lineno"></span><span class="op" id="6632859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6632862">func</span>&nbsp;<span class="ident" id="6632867">TestPointerParamsAndScans</span><span class="op" id="6632892">(</span><span class="ident" id="6632893">t</span>&nbsp;<span class="op" id="6632895">*</span><span class="ident" id="6632896">testing</span><span class="op" id="6632903">.</span><span class="ident" id="6632904">T</span><span class="op" id="6632905">)</span>&nbsp;<span class="op" id="6632907">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632910">db</span>&nbsp;<span class="op" id="6632913">:=</span>&nbsp;<span class="ident" id="6632916">newTestDB</span><span class="op" id="6632925">(</span><span class="ident" id="6632926">t</span><span class="op" id="6632927">,</span>&nbsp;<span class="string" id="6632929">&#34;&#34;</span><span class="op" id="6632931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6632934">defer</span>&nbsp;<span class="ident" id="6632940">closeDB</span><span class="op" id="6632947">(</span><span class="ident" id="6632948">t</span><span class="op" id="6632949">,</span>&nbsp;<span class="ident" id="6632951">db</span><span class="op" id="6632953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6632956">exec</span><span class="op" id="6632960">(</span><span class="ident" id="6632961">t</span><span class="op" id="6632962">,</span>&nbsp;<span class="ident" id="6632964">db</span><span class="op" id="6632966">,</span>&nbsp;<span class="string" id="6632968">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="6633003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633007">bob</span>&nbsp;<span class="op" id="6633011">:=</span>&nbsp;<span class="string" id="6633014">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633021">var</span>&nbsp;<span class="ident" id="6633025">name</span>&nbsp;<span class="op" id="6633030">*</span><span class="builtintype" id="6633031">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633040">name</span>&nbsp;<span class="op" id="6633045">=</span>&nbsp;<span class="op" id="6633047">&amp;</span><span class="ident" id="6633048">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633053">exec</span><span class="op" id="6633057">(</span><span class="ident" id="6633058">t</span><span class="op" id="6633059">,</span>&nbsp;<span class="ident" id="6633061">db</span><span class="op" id="6633063">,</span>&nbsp;<span class="string" id="6633065">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="6633088">,</span>&nbsp;<span class="ident" id="6633090">name</span><span class="op" id="6633094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633097">name</span>&nbsp;<span class="op" id="6633102">=</span>&nbsp;<span class="ident" id="6633104">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633109">exec</span><span class="op" id="6633113">(</span><span class="ident" id="6633114">t</span><span class="op" id="6633115">,</span>&nbsp;<span class="ident" id="6633117">db</span><span class="op" id="6633119">,</span>&nbsp;<span class="string" id="6633121">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="6633144">,</span>&nbsp;<span class="ident" id="6633146">name</span><span class="op" id="6633150">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633154">err</span>&nbsp;<span class="op" id="6633158">:=</span>&nbsp;<span class="ident" id="6633161">db</span><span class="op" id="6633163">.</span><span class="ident" id="6633164">QueryRow</span><span class="op" id="6633172">(</span><span class="string" id="6633173">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6633193">,</span>&nbsp;<span class="num" id="6633195">10</span><span class="op" id="6633197">)</span><span class="op" id="6633198">.</span><span class="ident" id="6633199">Scan</span><span class="op" id="6633203">(</span><span class="op" id="6633204">&amp;</span><span class="ident" id="6633205">name</span><span class="op" id="6633209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633212">if</span>&nbsp;<span class="ident" id="6633215">err</span>&nbsp;<span class="op" id="6633219">!=</span>&nbsp;<span class="ident" id="6633222">nil</span>&nbsp;<span class="op" id="6633226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633230">t</span><span class="op" id="6633231">.</span><span class="ident" id="6633232">Fatalf</span><span class="op" id="6633238">(</span><span class="string" id="6633239">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="6633259">,</span>&nbsp;<span class="ident" id="6633261">err</span><span class="op" id="6633264">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6633267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633270">if</span>&nbsp;<span class="ident" id="6633273">name</span>&nbsp;<span class="op" id="6633278">==</span>&nbsp;<span class="ident" id="6633281">nil</span>&nbsp;<span class="op" id="6633285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633289">t</span><span class="op" id="6633290">.</span><span class="ident" id="6633291">Errorf</span><span class="op" id="6633297">(</span><span class="string" id="6633298">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="6633328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6633331">}</span>&nbsp;<span class="keyword" id="6633333">else</span>&nbsp;<span class="keyword" id="6633338">if</span>&nbsp;<span class="op" id="6633341">*</span><span class="ident" id="6633342">name</span>&nbsp;<span class="op" id="6633347">!=</span>&nbsp;<span class="string" id="6633350">&#34;bob&#34;</span>&nbsp;<span class="op" id="6633356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633360">t</span><span class="op" id="6633361">.</span><span class="ident" id="6633362">Errorf</span><span class="op" id="6633368">(</span><span class="string" id="6633369">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="6633398">,</span>&nbsp;<span class="op" id="6633400">*</span><span class="ident" id="6633401">name</span><span class="op" id="6633405">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6633408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633412">err</span>&nbsp;<span class="op" id="6633416">=</span>&nbsp;<span class="ident" id="6633418">db</span><span class="op" id="6633420">.</span><span class="ident" id="6633421">QueryRow</span><span class="op" id="6633429">(</span><span class="string" id="6633430">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6633450">,</span>&nbsp;<span class="num" id="6633452">20</span><span class="op" id="6633454">)</span><span class="op" id="6633455">.</span><span class="ident" id="6633456">Scan</span><span class="op" id="6633460">(</span><span class="op" id="6633461">&amp;</span><span class="ident" id="6633462">name</span><span class="op" id="6633466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633469">if</span>&nbsp;<span class="ident" id="6633472">err</span>&nbsp;<span class="op" id="6633476">!=</span>&nbsp;<span class="ident" id="6633479">nil</span>&nbsp;<span class="op" id="6633483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633487">t</span><span class="op" id="6633488">.</span><span class="ident" id="6633489">Fatalf</span><span class="op" id="6633495">(</span><span class="string" id="6633496">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="6633516">,</span>&nbsp;<span class="ident" id="6633518">err</span><span class="op" id="6633521">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6633524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633527">if</span>&nbsp;<span class="ident" id="6633530">name</span>&nbsp;<span class="op" id="6633535">!=</span>&nbsp;<span class="ident" id="6633538">nil</span>&nbsp;<span class="op" id="6633542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633546">t</span><span class="op" id="6633547">.</span><span class="ident" id="6633548">Errorf</span><span class="op" id="6633554">(</span><span class="string" id="6633555">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="6633577">,</span>&nbsp;<span class="op" id="6633579">*</span><span class="ident" id="6633580">name</span><span class="op" id="6633584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6633587">}</span><br>
<span class="lineno"></span><span class="op" id="6633589">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="6633592">func</span>&nbsp;<span class="ident" id="6633597">TestQueryRowClosingStmt</span><span class="op" id="6633620">(</span><span class="ident" id="6633621">t</span>&nbsp;<span class="op" id="6633623">*</span><span class="ident" id="6633624">testing</span><span class="op" id="6633631">.</span><span class="ident" id="6633632">T</span><span class="op" id="6633633">)</span>&nbsp;<span class="op" id="6633635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633638">db</span>&nbsp;<span class="op" id="6633641">:=</span>&nbsp;<span class="ident" id="6633644">newTestDB</span><span class="op" id="6633653">(</span><span class="ident" id="6633654">t</span><span class="op" id="6633655">,</span>&nbsp;<span class="string" id="6633657">&#34;people&#34;</span><span class="op" id="6633665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633668">defer</span>&nbsp;<span class="ident" id="6633674">closeDB</span><span class="op" id="6633681">(</span><span class="ident" id="6633682">t</span><span class="op" id="6633683">,</span>&nbsp;<span class="ident" id="6633685">db</span><span class="op" id="6633687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633690">var</span>&nbsp;<span class="ident" id="6633694">name</span>&nbsp;<span class="builtintype" id="6633699">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633707">var</span>&nbsp;<span class="ident" id="6633711">age</span>&nbsp;<span class="builtintype" id="6633715">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633720">err</span>&nbsp;<span class="op" id="6633724">:=</span>&nbsp;<span class="ident" id="6633727">db</span><span class="op" id="6633729">.</span><span class="ident" id="6633730">QueryRow</span><span class="op" id="6633738">(</span><span class="string" id="6633739">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6633769">,</span>&nbsp;<span class="num" id="6633771">3</span><span class="op" id="6633772">)</span><span class="op" id="6633773">.</span><span class="ident" id="6633774">Scan</span><span class="op" id="6633778">(</span><span class="op" id="6633779">&amp;</span><span class="ident" id="6633780">age</span><span class="op" id="6633783">,</span>&nbsp;<span class="op" id="6633785">&amp;</span><span class="ident" id="6633786">name</span><span class="op" id="6633790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633793">if</span>&nbsp;<span class="ident" id="6633796">err</span>&nbsp;<span class="op" id="6633800">!=</span>&nbsp;<span class="ident" id="6633803">nil</span>&nbsp;<span class="op" id="6633807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633811">t</span><span class="op" id="6633812">.</span><span class="ident" id="6633813">Fatal</span><span class="op" id="6633818">(</span><span class="ident" id="6633819">err</span><span class="op" id="6633822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6633825">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633828">if</span>&nbsp;<span class="builtinfunc" id="6633831">len</span><span class="op" id="6633834">(</span><span class="ident" id="6633835">db</span><span class="op" id="6633837">.</span><span class="ident" id="6633838">freeConn</span><span class="op" id="6633846">)</span>&nbsp;<span class="op" id="6633848">!=</span>&nbsp;<span class="num" id="6633851">1</span>&nbsp;<span class="op" id="6633853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633857">t</span><span class="op" id="6633858">.</span><span class="ident" id="6633859">Fatalf</span><span class="op" id="6633865">(</span><span class="string" id="6633866">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="6633888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6633891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6633894">fakeConn</span>&nbsp;<span class="op" id="6633903">:=</span>&nbsp;<span class="ident" id="6633906">db</span><span class="op" id="6633908">.</span><span class="ident" id="6633909">freeConn</span><span class="op" id="6633917">[</span><span class="num" id="6633918">0</span><span class="op" id="6633919">]</span><span class="op" id="6633920">.</span><span class="ident" id="6633921">ci</span><span class="op" id="6633923">.</span><span class="op" id="6633924">(</span><span class="op" id="6633925">*</span><span class="ident" id="6633926">fakeConn</span><span class="op" id="6633934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6633937">if</span>&nbsp;<span class="ident" id="6633940">made</span><span class="op" id="6633944">,</span>&nbsp;<span class="ident" id="6633946">closed</span>&nbsp;<span class="op" id="6633953">:=</span>&nbsp;<span class="ident" id="6633956">fakeConn</span><span class="op" id="6633964">.</span><span class="ident" id="6633965">stmtsMade</span><span class="op" id="6633974">,</span>&nbsp;<span class="ident" id="6633976">fakeConn</span><span class="op" id="6633984">.</span><span class="ident" id="6633985">stmtsClosed</span><span class="op" id="6633996">;</span>&nbsp;<span class="ident" id="6633998">made</span>&nbsp;<span class="op" id="6634003">!=</span>&nbsp;<span class="ident" id="6634006">closed</span>&nbsp;<span class="op" id="6634013">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634017">t</span><span class="op" id="6634018">.</span><span class="ident" id="6634019">Errorf</span><span class="op" id="6634025">(</span><span class="string" id="6634026">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="6634072">,</span>&nbsp;<span class="ident" id="6634074">made</span><span class="op" id="6634078">,</span>&nbsp;<span class="ident" id="6634080">closed</span><span class="op" id="6634086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6634089">}</span><br>
<span class="lineno"></span><span class="op" id="6634091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6634094">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="6634113">func</span>&nbsp;<span class="ident" id="6634118">TestIssue6651</span><span class="op" id="6634131">(</span><span class="ident" id="6634132">t</span>&nbsp;<span class="op" id="6634134">*</span><span class="ident" id="6634135">testing</span><span class="op" id="6634142">.</span><span class="ident" id="6634143">T</span><span class="op" id="6634144">)</span>&nbsp;<span class="op" id="6634146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634149">db</span>&nbsp;<span class="op" id="6634152">:=</span>&nbsp;<span class="ident" id="6634155">newTestDB</span><span class="op" id="6634164">(</span><span class="ident" id="6634165">t</span><span class="op" id="6634166">,</span>&nbsp;<span class="string" id="6634168">&#34;people&#34;</span><span class="op" id="6634176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6634179">defer</span>&nbsp;<span class="ident" id="6634185">closeDB</span><span class="op" id="6634192">(</span><span class="ident" id="6634193">t</span><span class="op" id="6634194">,</span>&nbsp;<span class="ident" id="6634196">db</span><span class="op" id="6634198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6634202">var</span>&nbsp;<span class="ident" id="6634206">v</span>&nbsp;<span class="builtintype" id="6634208">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634217">want</span>&nbsp;<span class="op" id="6634222">:=</span>&nbsp;<span class="string" id="6634225">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634247">rowsCursorNextHook</span>&nbsp;<span class="op" id="6634266">=</span>&nbsp;<span class="keyword" id="6634268">func</span><span class="op" id="6634272">(</span><span class="ident" id="6634273">dest</span>&nbsp;<span class="op" id="6634278">[</span><span class="op" id="6634279">]</span><span class="ident" id="6634280">driver</span><span class="op" id="6634286">.</span><span class="ident" id="6634287">Value</span><span class="op" id="6634292">)</span>&nbsp;<span class="builtintype" id="6634294">error</span>&nbsp;<span class="op" id="6634300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6634304">return</span>&nbsp;<span class="ident" id="6634311">fmt</span><span class="op" id="6634314">.</span><span class="ident" id="6634315">Errorf</span><span class="op" id="6634321">(</span><span class="ident" id="6634322">want</span><span class="op" id="6634326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6634329">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6634332">defer</span>&nbsp;<span class="keyword" id="6634338">func</span><span class="op" id="6634342">(</span><span class="op" id="6634343">)</span>&nbsp;<span class="op" id="6634345">{</span>&nbsp;<span class="ident" id="6634347">rowsCursorNextHook</span>&nbsp;<span class="op" id="6634366">=</span>&nbsp;<span class="ident" id="6634368">nil</span>&nbsp;<span class="op" id="6634372">}</span><span class="op" id="6634373">(</span><span class="op" id="6634374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634377">err</span>&nbsp;<span class="op" id="6634381">:=</span>&nbsp;<span class="ident" id="6634384">db</span><span class="op" id="6634386">.</span><span class="ident" id="6634387">QueryRow</span><span class="op" id="6634395">(</span><span class="string" id="6634396">&#34;SELECT|people|name|&#34;</span><span class="op" id="6634417">)</span><span class="op" id="6634418">.</span><span class="ident" id="6634419">Scan</span><span class="op" id="6634423">(</span><span class="op" id="6634424">&amp;</span><span class="ident" id="6634425">v</span><span class="op" id="6634426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6634429">if</span>&nbsp;<span class="ident" id="6634432">err</span>&nbsp;<span class="op" id="6634436">==</span>&nbsp;<span class="ident" id="6634439">nil</span>&nbsp;<span class="op" id="6634443">||</span>&nbsp;<span class="ident" id="6634446">err</span><span class="op" id="6634449">.</span><span class="ident" id="6634450">Error</span><span class="op" id="6634455">(</span><span class="op" id="6634456">)</span>&nbsp;<span class="op" id="6634458">!=</span>&nbsp;<span class="ident" id="6634461">want</span>&nbsp;<span class="op" id="6634466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634470">t</span><span class="op" id="6634471">.</span><span class="ident" id="6634472">Errorf</span><span class="op" id="6634478">(</span><span class="string" id="6634479">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6634500">,</span>&nbsp;<span class="ident" id="6634502">err</span><span class="op" id="6634505">,</span>&nbsp;<span class="ident" id="6634507">want</span><span class="op" id="6634511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6634514">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634517">rowsCursorNextHook</span>&nbsp;<span class="op" id="6634536">=</span>&nbsp;<span class="ident" id="6634538">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634544">want</span>&nbsp;<span class="op" id="6634549">=</span>&nbsp;<span class="string" id="6634551">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634574">rowsCloseHook</span>&nbsp;<span class="op" id="6634588">=</span>&nbsp;<span class="keyword" id="6634590">func</span><span class="op" id="6634594">(</span><span class="ident" id="6634595">rows</span>&nbsp;<span class="op" id="6634600">*</span><span class="ident" id="6634601">Rows</span><span class="op" id="6634605">,</span>&nbsp;<span class="ident" id="6634607">err</span>&nbsp;<span class="op" id="6634611">*</span><span class="builtintype" id="6634612">error</span><span class="op" id="6634617">)</span>&nbsp;<span class="op" id="6634619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6634623">*</span><span class="ident" id="6634624">err</span>&nbsp;<span class="op" id="6634628">=</span>&nbsp;<span class="ident" id="6634630">fmt</span><span class="op" id="6634633">.</span><span class="ident" id="6634634">Errorf</span><span class="op" id="6634640">(</span><span class="ident" id="6634641">want</span><span class="op" id="6634645">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6634648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6634651">defer</span>&nbsp;<span class="keyword" id="6634657">func</span><span class="op" id="6634661">(</span><span class="op" id="6634662">)</span>&nbsp;<span class="op" id="6634664">{</span>&nbsp;<span class="ident" id="6634666">rowsCloseHook</span>&nbsp;<span class="op" id="6634680">=</span>&nbsp;<span class="ident" id="6634682">nil</span>&nbsp;<span class="op" id="6634686">}</span><span class="op" id="6634687">(</span><span class="op" id="6634688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634691">err</span>&nbsp;<span class="op" id="6634695">=</span>&nbsp;<span class="ident" id="6634697">db</span><span class="op" id="6634699">.</span><span class="ident" id="6634700">QueryRow</span><span class="op" id="6634708">(</span><span class="string" id="6634709">&#34;SELECT|people|name|&#34;</span><span class="op" id="6634730">)</span><span class="op" id="6634731">.</span><span class="ident" id="6634732">Scan</span><span class="op" id="6634736">(</span><span class="op" id="6634737">&amp;</span><span class="ident" id="6634738">v</span><span class="op" id="6634739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6634742">if</span>&nbsp;<span class="ident" id="6634745">err</span>&nbsp;<span class="op" id="6634749">==</span>&nbsp;<span class="ident" id="6634752">nil</span>&nbsp;<span class="op" id="6634756">||</span>&nbsp;<span class="ident" id="6634759">err</span><span class="op" id="6634762">.</span><span class="ident" id="6634763">Error</span><span class="op" id="6634768">(</span><span class="op" id="6634769">)</span>&nbsp;<span class="op" id="6634771">!=</span>&nbsp;<span class="ident" id="6634774">want</span>&nbsp;<span class="op" id="6634779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634783">t</span><span class="op" id="6634784">.</span><span class="ident" id="6634785">Errorf</span><span class="op" id="6634791">(</span><span class="string" id="6634792">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6634813">,</span>&nbsp;<span class="ident" id="6634815">err</span><span class="op" id="6634818">,</span>&nbsp;<span class="ident" id="6634820">want</span><span class="op" id="6634824">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6634827">}</span><br>
<span class="lineno"></span><span class="op" id="6634829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6634832">type</span>&nbsp;<span class="ident" id="6634837">nullTestRow</span>&nbsp;<span class="keyword" id="6634849">struct</span>&nbsp;<span class="op" id="6634856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634859">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6634872">interface</span><span class="op" id="6634881">{</span><span class="op" id="6634882">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634885">notNullParam</span>&nbsp;<span class="keyword" id="6634898">interface</span><span class="op" id="6634907">{</span><span class="op" id="6634908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634911">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="6634924">interface</span><span class="op" id="6634933">{</span><span class="op" id="6634934">}</span><br>
<span class="lineno"></span><span class="op" id="6634936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6634939">type</span>&nbsp;<span class="ident" id="6634944">nullTestSpec</span>&nbsp;<span class="keyword" id="6634957">struct</span>&nbsp;<span class="op" id="6634964">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634967">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6634979">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6634987">notNullType</span>&nbsp;<span class="builtintype" id="6634999">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6635007">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6635019">[</span><span class="num" id="6635020">6</span><span class="op" id="6635021">]</span><span class="ident" id="6635022">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="6635034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="6635037">func</span>&nbsp;<span class="ident" id="6635042">TestNullStringParam</span><span class="op" id="6635061">(</span><span class="ident" id="6635062">t</span>&nbsp;<span class="op" id="6635064">*</span><span class="ident" id="6635065">testing</span><span class="op" id="6635072">.</span><span class="ident" id="6635073">T</span><span class="op" id="6635074">)</span>&nbsp;<span class="op" id="6635076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6635079">spec</span>&nbsp;<span class="op" id="6635084">:=</span>&nbsp;<span class="ident" id="6635087">nullTestSpec</span><span class="op" id="6635099">{</span><span class="string" id="6635100">&#34;nullstring&#34;</span><span class="op" id="6635112">,</span>&nbsp;<span class="string" id="6635114">&#34;string&#34;</span><span class="op" id="6635122">,</span>&nbsp;<span class="op" id="6635124">[</span><span class="num" id="6635125">6</span><span class="op" id="6635126">]</span><span class="ident" id="6635127">nullTestRow</span><span class="op" id="6635138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635142">{</span><span class="ident" id="6635143">NullString</span><span class="op" id="6635153">{</span><span class="string" id="6635154">&#34;aqua&#34;</span><span class="op" id="6635160">,</span>&nbsp;<span class="builtintype" id="6635162">true</span><span class="op" id="6635166">}</span><span class="op" id="6635167">,</span>&nbsp;<span class="string" id="6635169">&#34;&#34;</span><span class="op" id="6635171">,</span>&nbsp;<span class="ident" id="6635173">NullString</span><span class="op" id="6635183">{</span><span class="string" id="6635184">&#34;aqua&#34;</span><span class="op" id="6635190">,</span>&nbsp;<span class="builtintype" id="6635192">true</span><span class="op" id="6635196">}</span><span class="op" id="6635197">}</span><span class="op" id="6635198">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635202">{</span><span class="ident" id="6635203">NullString</span><span class="op" id="6635213">{</span><span class="string" id="6635214">&#34;brown&#34;</span><span class="op" id="6635221">,</span>&nbsp;<span class="builtintype" id="6635223">false</span><span class="op" id="6635228">}</span><span class="op" id="6635229">,</span>&nbsp;<span class="string" id="6635231">&#34;&#34;</span><span class="op" id="6635233">,</span>&nbsp;<span class="ident" id="6635235">NullString</span><span class="op" id="6635245">{</span><span class="string" id="6635246">&#34;&#34;</span><span class="op" id="6635248">,</span>&nbsp;<span class="builtintype" id="6635250">false</span><span class="op" id="6635255">}</span><span class="op" id="6635256">}</span><span class="op" id="6635257">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635261">{</span><span class="string" id="6635262">&#34;chartreuse&#34;</span><span class="op" id="6635274">,</span>&nbsp;<span class="string" id="6635276">&#34;&#34;</span><span class="op" id="6635278">,</span>&nbsp;<span class="ident" id="6635280">NullString</span><span class="op" id="6635290">{</span><span class="string" id="6635291">&#34;chartreuse&#34;</span><span class="op" id="6635303">,</span>&nbsp;<span class="builtintype" id="6635305">true</span><span class="op" id="6635309">}</span><span class="op" id="6635310">}</span><span class="op" id="6635311">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635315">{</span><span class="ident" id="6635316">NullString</span><span class="op" id="6635326">{</span><span class="string" id="6635327">&#34;darkred&#34;</span><span class="op" id="6635336">,</span>&nbsp;<span class="builtintype" id="6635338">true</span><span class="op" id="6635342">}</span><span class="op" id="6635343">,</span>&nbsp;<span class="string" id="6635345">&#34;&#34;</span><span class="op" id="6635347">,</span>&nbsp;<span class="ident" id="6635349">NullString</span><span class="op" id="6635359">{</span><span class="string" id="6635360">&#34;darkred&#34;</span><span class="op" id="6635369">,</span>&nbsp;<span class="builtintype" id="6635371">true</span><span class="op" id="6635375">}</span><span class="op" id="6635376">}</span><span class="op" id="6635377">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635381">{</span><span class="ident" id="6635382">NullString</span><span class="op" id="6635392">{</span><span class="string" id="6635393">&#34;eel&#34;</span><span class="op" id="6635398">,</span>&nbsp;<span class="builtintype" id="6635400">false</span><span class="op" id="6635405">}</span><span class="op" id="6635406">,</span>&nbsp;<span class="string" id="6635408">&#34;&#34;</span><span class="op" id="6635410">,</span>&nbsp;<span class="ident" id="6635412">NullString</span><span class="op" id="6635422">{</span><span class="string" id="6635423">&#34;&#34;</span><span class="op" id="6635425">,</span>&nbsp;<span class="builtintype" id="6635427">false</span><span class="op" id="6635432">}</span><span class="op" id="6635433">}</span><span class="op" id="6635434">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635438">{</span><span class="string" id="6635439">&#34;foo&#34;</span><span class="op" id="6635444">,</span>&nbsp;<span class="ident" id="6635446">NullString</span><span class="op" id="6635456">{</span><span class="string" id="6635457">&#34;black&#34;</span><span class="op" id="6635464">,</span>&nbsp;<span class="builtintype" id="6635466">false</span><span class="op" id="6635471">}</span><span class="op" id="6635472">,</span>&nbsp;<span class="ident" id="6635474">nil</span><span class="op" id="6635477">}</span><span class="op" id="6635478">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635481">}</span><span class="op" id="6635482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6635485">nullTestRun</span><span class="op" id="6635496">(</span><span class="ident" id="6635497">t</span><span class="op" id="6635498">,</span>&nbsp;<span class="ident" id="6635500">spec</span><span class="op" id="6635504">)</span><br>
<span class="lineno">750</span><span class="op" id="6635506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6635509">func</span>&nbsp;<span class="ident" id="6635514">TestNullInt64Param</span><span class="op" id="6635532">(</span><span class="ident" id="6635533">t</span>&nbsp;<span class="op" id="6635535">*</span><span class="ident" id="6635536">testing</span><span class="op" id="6635543">.</span><span class="ident" id="6635544">T</span><span class="op" id="6635545">)</span>&nbsp;<span class="op" id="6635547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6635550">spec</span>&nbsp;<span class="op" id="6635555">:=</span>&nbsp;<span class="ident" id="6635558">nullTestSpec</span><span class="op" id="6635570">{</span><span class="string" id="6635571">&#34;nullint64&#34;</span><span class="op" id="6635582">,</span>&nbsp;<span class="string" id="6635584">&#34;int64&#34;</span><span class="op" id="6635591">,</span>&nbsp;<span class="op" id="6635593">[</span><span class="num" id="6635594">6</span><span class="op" id="6635595">]</span><span class="ident" id="6635596">nullTestRow</span><span class="op" id="6635607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635611">{</span><span class="ident" id="6635612">NullInt64</span><span class="op" id="6635621">{</span><span class="num" id="6635622">31</span><span class="op" id="6635624">,</span>&nbsp;<span class="builtintype" id="6635626">true</span><span class="op" id="6635630">}</span><span class="op" id="6635631">,</span>&nbsp;<span class="num" id="6635633">1</span><span class="op" id="6635634">,</span>&nbsp;<span class="ident" id="6635636">NullInt64</span><span class="op" id="6635645">{</span><span class="num" id="6635646">31</span><span class="op" id="6635648">,</span>&nbsp;<span class="builtintype" id="6635650">true</span><span class="op" id="6635654">}</span><span class="op" id="6635655">}</span><span class="op" id="6635656">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635660">{</span><span class="ident" id="6635661">NullInt64</span><span class="op" id="6635670">{</span><span class="op" id="6635671">-</span><span class="num" id="6635672">22</span><span class="op" id="6635674">,</span>&nbsp;<span class="builtintype" id="6635676">false</span><span class="op" id="6635681">}</span><span class="op" id="6635682">,</span>&nbsp;<span class="num" id="6635684">1</span><span class="op" id="6635685">,</span>&nbsp;<span class="ident" id="6635687">NullInt64</span><span class="op" id="6635696">{</span><span class="num" id="6635697">0</span><span class="op" id="6635698">,</span>&nbsp;<span class="builtintype" id="6635700">false</span><span class="op" id="6635705">}</span><span class="op" id="6635706">}</span><span class="op" id="6635707">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635711">{</span><span class="num" id="6635712">22</span><span class="op" id="6635714">,</span>&nbsp;<span class="num" id="6635716">1</span><span class="op" id="6635717">,</span>&nbsp;<span class="ident" id="6635719">NullInt64</span><span class="op" id="6635728">{</span><span class="num" id="6635729">22</span><span class="op" id="6635731">,</span>&nbsp;<span class="builtintype" id="6635733">true</span><span class="op" id="6635737">}</span><span class="op" id="6635738">}</span><span class="op" id="6635739">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635743">{</span><span class="ident" id="6635744">NullInt64</span><span class="op" id="6635753">{</span><span class="num" id="6635754">33</span><span class="op" id="6635756">,</span>&nbsp;<span class="builtintype" id="6635758">true</span><span class="op" id="6635762">}</span><span class="op" id="6635763">,</span>&nbsp;<span class="num" id="6635765">1</span><span class="op" id="6635766">,</span>&nbsp;<span class="ident" id="6635768">NullInt64</span><span class="op" id="6635777">{</span><span class="num" id="6635778">33</span><span class="op" id="6635780">,</span>&nbsp;<span class="builtintype" id="6635782">true</span><span class="op" id="6635786">}</span><span class="op" id="6635787">}</span><span class="op" id="6635788">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635792">{</span><span class="ident" id="6635793">NullInt64</span><span class="op" id="6635802">{</span><span class="num" id="6635803">222</span><span class="op" id="6635806">,</span>&nbsp;<span class="builtintype" id="6635808">false</span><span class="op" id="6635813">}</span><span class="op" id="6635814">,</span>&nbsp;<span class="num" id="6635816">1</span><span class="op" id="6635817">,</span>&nbsp;<span class="ident" id="6635819">NullInt64</span><span class="op" id="6635828">{</span><span class="num" id="6635829">0</span><span class="op" id="6635830">,</span>&nbsp;<span class="builtintype" id="6635832">false</span><span class="op" id="6635837">}</span><span class="op" id="6635838">}</span><span class="op" id="6635839">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635843">{</span><span class="num" id="6635844">0</span><span class="op" id="6635845">,</span>&nbsp;<span class="ident" id="6635847">NullInt64</span><span class="op" id="6635856">{</span><span class="num" id="6635857">31</span><span class="op" id="6635859">,</span>&nbsp;<span class="builtintype" id="6635861">false</span><span class="op" id="6635866">}</span><span class="op" id="6635867">,</span>&nbsp;<span class="ident" id="6635869">nil</span><span class="op" id="6635872">}</span><span class="op" id="6635873">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6635876">}</span><span class="op" id="6635877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6635880">nullTestRun</span><span class="op" id="6635891">(</span><span class="ident" id="6635892">t</span><span class="op" id="6635893">,</span>&nbsp;<span class="ident" id="6635895">spec</span><span class="op" id="6635899">)</span><br>
<span class="lineno"></span><span class="op" id="6635901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6635904">func</span>&nbsp;<span class="ident" id="6635909">TestNullFloat64Param</span><span class="op" id="6635929">(</span><span class="ident" id="6635930">t</span>&nbsp;<span class="op" id="6635932">*</span><span class="ident" id="6635933">testing</span><span class="op" id="6635940">.</span><span class="ident" id="6635941">T</span><span class="op" id="6635942">)</span>&nbsp;<span class="op" id="6635944">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6635947">spec</span>&nbsp;<span class="op" id="6635952">:=</span>&nbsp;<span class="ident" id="6635955">nullTestSpec</span><span class="op" id="6635967">{</span><span class="string" id="6635968">&#34;nullfloat64&#34;</span><span class="op" id="6635981">,</span>&nbsp;<span class="string" id="6635983">&#34;float64&#34;</span><span class="op" id="6635992">,</span>&nbsp;<span class="op" id="6635994">[</span><span class="num" id="6635995">6</span><span class="op" id="6635996">]</span><span class="ident" id="6635997">nullTestRow</span><span class="op" id="6636008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636012">{</span><span class="ident" id="6636013">NullFloat64</span><span class="op" id="6636024">{</span><span class="num" id="6636025">31.2</span><span class="op" id="6636029">,</span>&nbsp;<span class="builtintype" id="6636031">true</span><span class="op" id="6636035">}</span><span class="op" id="6636036">,</span>&nbsp;<span class="num" id="6636038">1</span><span class="op" id="6636039">,</span>&nbsp;<span class="ident" id="6636041">NullFloat64</span><span class="op" id="6636052">{</span><span class="num" id="6636053">31.2</span><span class="op" id="6636057">,</span>&nbsp;<span class="builtintype" id="6636059">true</span><span class="op" id="6636063">}</span><span class="op" id="6636064">}</span><span class="op" id="6636065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636069">{</span><span class="ident" id="6636070">NullFloat64</span><span class="op" id="6636081">{</span><span class="num" id="6636082">13.1</span><span class="op" id="6636086">,</span>&nbsp;<span class="builtintype" id="6636088">false</span><span class="op" id="6636093">}</span><span class="op" id="6636094">,</span>&nbsp;<span class="num" id="6636096">1</span><span class="op" id="6636097">,</span>&nbsp;<span class="ident" id="6636099">NullFloat64</span><span class="op" id="6636110">{</span><span class="num" id="6636111">0</span><span class="op" id="6636112">,</span>&nbsp;<span class="builtintype" id="6636114">false</span><span class="op" id="6636119">}</span><span class="op" id="6636120">}</span><span class="op" id="6636121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636125">{</span><span class="op" id="6636126">-</span><span class="num" id="6636127">22.9</span><span class="op" id="6636131">,</span>&nbsp;<span class="num" id="6636133">1</span><span class="op" id="6636134">,</span>&nbsp;<span class="ident" id="6636136">NullFloat64</span><span class="op" id="6636147">{</span><span class="op" id="6636148">-</span><span class="num" id="6636149">22.9</span><span class="op" id="6636153">,</span>&nbsp;<span class="builtintype" id="6636155">true</span><span class="op" id="6636159">}</span><span class="op" id="6636160">}</span><span class="op" id="6636161">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636165">{</span><span class="ident" id="6636166">NullFloat64</span><span class="op" id="6636177">{</span><span class="num" id="6636178">33.81</span><span class="op" id="6636183">,</span>&nbsp;<span class="builtintype" id="6636185">true</span><span class="op" id="6636189">}</span><span class="op" id="6636190">,</span>&nbsp;<span class="num" id="6636192">1</span><span class="op" id="6636193">,</span>&nbsp;<span class="ident" id="6636195">NullFloat64</span><span class="op" id="6636206">{</span><span class="num" id="6636207">33.81</span><span class="op" id="6636212">,</span>&nbsp;<span class="builtintype" id="6636214">true</span><span class="op" id="6636218">}</span><span class="op" id="6636219">}</span><span class="op" id="6636220">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636224">{</span><span class="ident" id="6636225">NullFloat64</span><span class="op" id="6636236">{</span><span class="num" id="6636237">222</span><span class="op" id="6636240">,</span>&nbsp;<span class="builtintype" id="6636242">false</span><span class="op" id="6636247">}</span><span class="op" id="6636248">,</span>&nbsp;<span class="num" id="6636250">1</span><span class="op" id="6636251">,</span>&nbsp;<span class="ident" id="6636253">NullFloat64</span><span class="op" id="6636264">{</span><span class="num" id="6636265">0</span><span class="op" id="6636266">,</span>&nbsp;<span class="builtintype" id="6636268">false</span><span class="op" id="6636273">}</span><span class="op" id="6636274">}</span><span class="op" id="6636275">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636279">{</span><span class="num" id="6636280">10</span><span class="op" id="6636282">,</span>&nbsp;<span class="ident" id="6636284">NullFloat64</span><span class="op" id="6636295">{</span><span class="num" id="6636296">31.2</span><span class="op" id="6636300">,</span>&nbsp;<span class="builtintype" id="6636302">false</span><span class="op" id="6636307">}</span><span class="op" id="6636308">,</span>&nbsp;<span class="ident" id="6636310">nil</span><span class="op" id="6636313">}</span><span class="op" id="6636314">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636317">}</span><span class="op" id="6636318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6636321">nullTestRun</span><span class="op" id="6636332">(</span><span class="ident" id="6636333">t</span><span class="op" id="6636334">,</span>&nbsp;<span class="ident" id="6636336">spec</span><span class="op" id="6636340">)</span><br>
<span class="lineno"></span><span class="op" id="6636342">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="6636345">func</span>&nbsp;<span class="ident" id="6636350">TestNullBoolParam</span><span class="op" id="6636367">(</span><span class="ident" id="6636368">t</span>&nbsp;<span class="op" id="6636370">*</span><span class="ident" id="6636371">testing</span><span class="op" id="6636378">.</span><span class="ident" id="6636379">T</span><span class="op" id="6636380">)</span>&nbsp;<span class="op" id="6636382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6636385">spec</span>&nbsp;<span class="op" id="6636390">:=</span>&nbsp;<span class="ident" id="6636393">nullTestSpec</span><span class="op" id="6636405">{</span><span class="string" id="6636406">&#34;nullbool&#34;</span><span class="op" id="6636416">,</span>&nbsp;<span class="string" id="6636418">&#34;bool&#34;</span><span class="op" id="6636424">,</span>&nbsp;<span class="op" id="6636426">[</span><span class="num" id="6636427">6</span><span class="op" id="6636428">]</span><span class="ident" id="6636429">nullTestRow</span><span class="op" id="6636440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636444">{</span><span class="ident" id="6636445">NullBool</span><span class="op" id="6636453">{</span><span class="builtintype" id="6636454">false</span><span class="op" id="6636459">,</span>&nbsp;<span class="builtintype" id="6636461">true</span><span class="op" id="6636465">}</span><span class="op" id="6636466">,</span>&nbsp;<span class="builtintype" id="6636468">true</span><span class="op" id="6636472">,</span>&nbsp;<span class="ident" id="6636474">NullBool</span><span class="op" id="6636482">{</span><span class="builtintype" id="6636483">false</span><span class="op" id="6636488">,</span>&nbsp;<span class="builtintype" id="6636490">true</span><span class="op" id="6636494">}</span><span class="op" id="6636495">}</span><span class="op" id="6636496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636500">{</span><span class="ident" id="6636501">NullBool</span><span class="op" id="6636509">{</span><span class="builtintype" id="6636510">true</span><span class="op" id="6636514">,</span>&nbsp;<span class="builtintype" id="6636516">false</span><span class="op" id="6636521">}</span><span class="op" id="6636522">,</span>&nbsp;<span class="builtintype" id="6636524">false</span><span class="op" id="6636529">,</span>&nbsp;<span class="ident" id="6636531">NullBool</span><span class="op" id="6636539">{</span><span class="builtintype" id="6636540">false</span><span class="op" id="6636545">,</span>&nbsp;<span class="builtintype" id="6636547">false</span><span class="op" id="6636552">}</span><span class="op" id="6636553">}</span><span class="op" id="6636554">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636558">{</span><span class="builtintype" id="6636559">true</span><span class="op" id="6636563">,</span>&nbsp;<span class="builtintype" id="6636565">true</span><span class="op" id="6636569">,</span>&nbsp;<span class="ident" id="6636571">NullBool</span><span class="op" id="6636579">{</span><span class="builtintype" id="6636580">true</span><span class="op" id="6636584">,</span>&nbsp;<span class="builtintype" id="6636586">true</span><span class="op" id="6636590">}</span><span class="op" id="6636591">}</span><span class="op" id="6636592">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636596">{</span><span class="ident" id="6636597">NullBool</span><span class="op" id="6636605">{</span><span class="builtintype" id="6636606">true</span><span class="op" id="6636610">,</span>&nbsp;<span class="builtintype" id="6636612">true</span><span class="op" id="6636616">}</span><span class="op" id="6636617">,</span>&nbsp;<span class="builtintype" id="6636619">false</span><span class="op" id="6636624">,</span>&nbsp;<span class="ident" id="6636626">NullBool</span><span class="op" id="6636634">{</span><span class="builtintype" id="6636635">true</span><span class="op" id="6636639">,</span>&nbsp;<span class="builtintype" id="6636641">true</span><span class="op" id="6636645">}</span><span class="op" id="6636646">}</span><span class="op" id="6636647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636651">{</span><span class="ident" id="6636652">NullBool</span><span class="op" id="6636660">{</span><span class="builtintype" id="6636661">true</span><span class="op" id="6636665">,</span>&nbsp;<span class="builtintype" id="6636667">false</span><span class="op" id="6636672">}</span><span class="op" id="6636673">,</span>&nbsp;<span class="builtintype" id="6636675">true</span><span class="op" id="6636679">,</span>&nbsp;<span class="ident" id="6636681">NullBool</span><span class="op" id="6636689">{</span><span class="builtintype" id="6636690">false</span><span class="op" id="6636695">,</span>&nbsp;<span class="builtintype" id="6636697">false</span><span class="op" id="6636702">}</span><span class="op" id="6636703">}</span><span class="op" id="6636704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636708">{</span><span class="builtintype" id="6636709">true</span><span class="op" id="6636713">,</span>&nbsp;<span class="ident" id="6636715">NullBool</span><span class="op" id="6636723">{</span><span class="builtintype" id="6636724">true</span><span class="op" id="6636728">,</span>&nbsp;<span class="builtintype" id="6636730">false</span><span class="op" id="6636735">}</span><span class="op" id="6636736">,</span>&nbsp;<span class="ident" id="6636738">nil</span><span class="op" id="6636741">}</span><span class="op" id="6636742">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6636745">}</span><span class="op" id="6636746">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6636749">nullTestRun</span><span class="op" id="6636760">(</span><span class="ident" id="6636761">t</span><span class="op" id="6636762">,</span>&nbsp;<span class="ident" id="6636764">spec</span><span class="op" id="6636768">)</span><br>
<span class="lineno"></span><span class="op" id="6636770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6636773">func</span>&nbsp;<span class="ident" id="6636778">nullTestRun</span><span class="op" id="6636789">(</span><span class="ident" id="6636790">t</span>&nbsp;<span class="op" id="6636792">*</span><span class="ident" id="6636793">testing</span><span class="op" id="6636800">.</span><span class="ident" id="6636801">T</span><span class="op" id="6636802">,</span>&nbsp;<span class="ident" id="6636804">spec</span>&nbsp;<span class="ident" id="6636809">nullTestSpec</span><span class="op" id="6636821">)</span>&nbsp;<span class="op" id="6636823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6636826">db</span>&nbsp;<span class="op" id="6636829">:=</span>&nbsp;<span class="ident" id="6636832">newTestDB</span><span class="op" id="6636841">(</span><span class="ident" id="6636842">t</span><span class="op" id="6636843">,</span>&nbsp;<span class="string" id="6636845">&#34;&#34;</span><span class="op" id="6636847">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6636850">defer</span>&nbsp;<span class="ident" id="6636856">closeDB</span><span class="op" id="6636863">(</span><span class="ident" id="6636864">t</span><span class="op" id="6636865">,</span>&nbsp;<span class="ident" id="6636867">db</span><span class="op" id="6636869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6636872">exec</span><span class="op" id="6636876">(</span><span class="ident" id="6636877">t</span><span class="op" id="6636878">,</span>&nbsp;<span class="ident" id="6636880">db</span><span class="op" id="6636882">,</span>&nbsp;<span class="ident" id="6636884">fmt</span><span class="op" id="6636887">.</span><span class="ident" id="6636888">Sprintf</span><span class="op" id="6636895">(</span><span class="string" id="6636896">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="6636948">,</span>&nbsp;<span class="ident" id="6636950">spec</span><span class="op" id="6636954">.</span><span class="ident" id="6636955">nullType</span><span class="op" id="6636963">,</span>&nbsp;<span class="ident" id="6636965">spec</span><span class="op" id="6636969">.</span><span class="ident" id="6636970">notNullType</span><span class="op" id="6636981">)</span><span class="op" id="6636982">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6636986">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6637012">exec</span><span class="op" id="6637016">(</span><span class="ident" id="6637017">t</span><span class="op" id="6637018">,</span>&nbsp;<span class="ident" id="6637020">db</span><span class="op" id="6637022">,</span>&nbsp;<span class="string" id="6637024">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6637065">,</span>&nbsp;<span class="num" id="6637067">1</span><span class="op" id="6637068">,</span>&nbsp;<span class="string" id="6637070">&#34;alice&#34;</span><span class="op" id="6637077">,</span>&nbsp;<span class="ident" id="6637079">spec</span><span class="op" id="6637083">.</span><span class="ident" id="6637084">rows</span><span class="op" id="6637088">[</span><span class="num" id="6637089">0</span><span class="op" id="6637090">]</span><span class="op" id="6637091">.</span><span class="ident" id="6637092">nullParam</span><span class="op" id="6637101">,</span>&nbsp;<span class="ident" id="6637103">spec</span><span class="op" id="6637107">.</span><span class="ident" id="6637108">rows</span><span class="op" id="6637112">[</span><span class="num" id="6637113">0</span><span class="op" id="6637114">]</span><span class="op" id="6637115">.</span><span class="ident" id="6637116">notNullParam</span><span class="op" id="6637128">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6637131">exec</span><span class="op" id="6637135">(</span><span class="ident" id="6637136">t</span><span class="op" id="6637137">,</span>&nbsp;<span class="ident" id="6637139">db</span><span class="op" id="6637141">,</span>&nbsp;<span class="string" id="6637143">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6637184">,</span>&nbsp;<span class="num" id="6637186">2</span><span class="op" id="6637187">,</span>&nbsp;<span class="string" id="6637189">&#34;bob&#34;</span><span class="op" id="6637194">,</span>&nbsp;<span class="ident" id="6637196">spec</span><span class="op" id="6637200">.</span><span class="ident" id="6637201">rows</span><span class="op" id="6637205">[</span><span class="num" id="6637206">1</span><span class="op" id="6637207">]</span><span class="op" id="6637208">.</span><span class="ident" id="6637209">nullParam</span><span class="op" id="6637218">,</span>&nbsp;<span class="ident" id="6637220">spec</span><span class="op" id="6637224">.</span><span class="ident" id="6637225">rows</span><span class="op" id="6637229">[</span><span class="num" id="6637230">1</span><span class="op" id="6637231">]</span><span class="op" id="6637232">.</span><span class="ident" id="6637233">notNullParam</span><span class="op" id="6637245">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6637249">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6637288">stmt</span><span class="op" id="6637292">,</span>&nbsp;<span class="ident" id="6637294">err</span>&nbsp;<span class="op" id="6637298">:=</span>&nbsp;<span class="ident" id="6637301">db</span><span class="op" id="6637303">.</span><span class="ident" id="6637304">Prepare</span><span class="op" id="6637311">(</span><span class="string" id="6637312">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6637353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6637356">if</span>&nbsp;<span class="ident" id="6637359">err</span>&nbsp;<span class="op" id="6637363">!=</span>&nbsp;<span class="ident" id="6637366">nil</span>&nbsp;<span class="op" id="6637370">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6637374">t</span><span class="op" id="6637375">.</span><span class="ident" id="6637376">Fatalf</span><span class="op" id="6637382">(</span><span class="string" id="6637383">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6637396">,</span>&nbsp;<span class="ident" id="6637398">err</span><span class="op" id="6637401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6637404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6637407">defer</span>&nbsp;<span class="ident" id="6637413">stmt</span><span class="op" id="6637417">.</span><span class="ident" id="6637418">Close</span><span class="op" id="6637423">(</span><span class="op" id="6637424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6637427">if</span>&nbsp;<span class="ident" id="6637430">_</span><span class="op" id="6637431">,</span>&nbsp;<span class="ident" id="6637433">err</span>&nbsp;<span class="op" id="6637437">:=</span>&nbsp;<span class="ident" id="6637440">stmt</span><span class="op" id="6637444">.</span><span class="ident" id="6637445">Exec</span><span class="op" id="6637449">(</span><span class="num" id="6637450">3</span><span class="op" id="6637451">,</span>&nbsp;<span class="string" id="6637453">&#34;chris&#34;</span><span class="op" id="6637460">,</span>&nbsp;<span class="ident" id="6637462">spec</span><span class="op" id="6637466">.</span><span class="ident" id="6637467">rows</span><span class="op" id="6637471">[</span><span class="num" id="6637472">2</span><span class="op" id="6637473">]</span><span class="op" id="6637474">.</span><span class="ident" id="6637475">nullParam</span><span class="op" id="6637484">,</span>&nbsp;<span class="ident" id="6637486">spec</span><span class="op" id="6637490">.</span><span class="ident" id="6637491">rows</span><span class="op" id="6637495">[</span><span class="num" id="6637496">2</span><span class="op" id="6637497">]</span><span class="op" id="6637498">.</span><span class="ident" id="6637499">notNullParam</span><span class="op" id="6637511">)</span><span class="op" id="6637512">;</span>&nbsp;<span class="ident" id="6637514">err</span>&nbsp;<span class="op" id="6637518">!=</span>&nbsp;<span class="ident" id="6637521">nil</span>&nbsp;<span class="op" id="6637525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6637529">t</span><span class="op" id="6637530">.</span><span class="ident" id="6637531">Errorf</span><span class="op" id="6637537">(</span><span class="string" id="6637538">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="6637561">,</span>&nbsp;<span class="ident" id="6637563">err</span><span class="op" id="6637566">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6637569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6637572">if</span>&nbsp;<span class="ident" id="6637575">_</span><span class="op" id="6637576">,</span>&nbsp;<span class="ident" id="6637578">err</span>&nbsp;<span class="op" id="6637582">:=</span>&nbsp;<span class="ident" id="6637585">stmt</span><span class="op" id="6637589">.</span><span class="ident" id="6637590">Exec</span><span class="op" id="6637594">(</span><span class="num" id="6637595">4</span><span class="op" id="6637596">,</span>&nbsp;<span class="string" id="6637598">&#34;dave&#34;</span><span class="op" id="6637604">,</span>&nbsp;<span class="ident" id="6637606">spec</span><span class="op" id="6637610">.</span><span class="ident" id="6637611">rows</span><span class="op" id="6637615">[</span><span class="num" id="6637616">3</span><span class="op" id="6637617">]</span><span class="op" id="6637618">.</span><span class="ident" id="6637619">nullParam</span><span class="op" id="6637628">,</span>&nbsp;<span class="ident" id="6637630">spec</span><span class="op" id="6637634">.</span><span class="ident" id="6637635">rows</span><span class="op" id="6637639">[</span><span class="num" id="6637640">3</span><span class="op" id="6637641">]</span><span class="op" id="6637642">.</span><span class="ident" id="6637643">notNullParam</span><span class="op" id="6637655">)</span><span class="op" id="6637656">;</span>&nbsp;<span class="ident" id="6637658">err</span>&nbsp;<span class="op" id="6637662">!=</span>&nbsp;<span class="ident" id="6637665">nil</span>&nbsp;<span class="op" id="6637669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6637673">t</span><span class="op" id="6637674">.</span><span class="ident" id="6637675">Errorf</span><span class="op" id="6637681">(</span><span class="string" id="6637682">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="6637704">,</span>&nbsp;<span class="ident" id="6637706">err</span><span class="op" id="6637709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6637712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6637715">if</span>&nbsp;<span class="ident" id="6637718">_</span><span class="op" id="6637719">,</span>&nbsp;<span class="ident" id="6637721">err</span>&nbsp;<span class="op" id="6637725">:=</span>&nbsp;<span class="ident" id="6637728">stmt</span><span class="op" id="6637732">.</span><span class="ident" id="6637733">Exec</span><span class="op" id="6637737">(</span><span class="num" id="6637738">5</span><span class="op" id="6637739">,</span>&nbsp;<span class="string" id="6637741">&#34;eleanor&#34;</span><span class="op" id="6637750">,</span>&nbsp;<span class="ident" id="6637752">spec</span><span class="op" id="6637756">.</span><span class="ident" id="6637757">rows</span><span class="op" id="6637761">[</span><span class="num" id="6637762">4</span><span class="op" id="6637763">]</span><span class="op" id="6637764">.</span><span class="ident" id="6637765">nullParam</span><span class="op" id="6637774">,</span>&nbsp;<span class="ident" id="6637776">spec</span><span class="op" id="6637780">.</span><span class="ident" id="6637781">rows</span><span class="op" id="6637785">[</span><span class="num" id="6637786">4</span><span class="op" id="6637787">]</span><span class="op" id="6637788">.</span><span class="ident" id="6637789">notNullParam</span><span class="op" id="6637801">)</span><span class="op" id="6637802">;</span>&nbsp;<span class="ident" id="6637804">err</span>&nbsp;<span class="op" id="6637808">!=</span>&nbsp;<span class="ident" id="6637811">nil</span>&nbsp;<span class="op" id="6637815">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6637819">t</span><span class="op" id="6637820">.</span><span class="ident" id="6637821">Errorf</span><span class="op" id="6637827">(</span><span class="string" id="6637828">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="6637853">,</span>&nbsp;<span class="ident" id="6637855">err</span><span class="op" id="6637858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6637861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6637865">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6637906">if</span>&nbsp;<span class="ident" id="6637909">_</span><span class="op" id="6637910">,</span>&nbsp;<span class="ident" id="6637912">err</span>&nbsp;<span class="op" id="6637916">:=</span>&nbsp;<span class="ident" id="6637919">stmt</span><span class="op" id="6637923">.</span><span class="ident" id="6637924">Exec</span><span class="op" id="6637928">(</span><span class="num" id="6637929">6</span><span class="op" id="6637930">,</span>&nbsp;<span class="string" id="6637932">&#34;bob&#34;</span><span class="op" id="6637937">,</span>&nbsp;<span class="ident" id="6637939">spec</span><span class="op" id="6637943">.</span><span class="ident" id="6637944">rows</span><span class="op" id="6637948">[</span><span class="num" id="6637949">5</span><span class="op" id="6637950">]</span><span class="op" id="6637951">.</span><span class="ident" id="6637952">nullParam</span><span class="op" id="6637961">,</span>&nbsp;<span class="ident" id="6637963">spec</span><span class="op" id="6637967">.</span><span class="ident" id="6637968">rows</span><span class="op" id="6637972">[</span><span class="num" id="6637973">5</span><span class="op" id="6637974">]</span><span class="op" id="6637975">.</span><span class="ident" id="6637976">notNullParam</span><span class="op" id="6637988">)</span><span class="op" id="6637989">;</span>&nbsp;<span class="ident" id="6637991">err</span>&nbsp;<span class="op" id="6637995">==</span>&nbsp;<span class="ident" id="6637998">nil</span>&nbsp;<span class="op" id="6638002">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6638006">t</span><span class="op" id="6638007">.</span><span class="ident" id="6638008">Errorf</span><span class="op" id="6638014">(</span><span class="string" id="6638015">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="6638078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6638081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6638085">_</span><span class="op" id="6638086">,</span>&nbsp;<span class="ident" id="6638088">err</span>&nbsp;<span class="op" id="6638092">=</span>&nbsp;<span class="ident" id="6638094">db</span><span class="op" id="6638096">.</span><span class="ident" id="6638097">Exec</span><span class="op" id="6638101">(</span><span class="string" id="6638102">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="6638132">,</span>&nbsp;<span class="num" id="6638134">999</span><span class="op" id="6638137">,</span>&nbsp;<span class="ident" id="6638139">nil</span><span class="op" id="6638142">,</span>&nbsp;<span class="ident" id="6638144">nil</span><span class="op" id="6638147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6638150">if</span>&nbsp;<span class="ident" id="6638153">err</span>&nbsp;<span class="op" id="6638157">==</span>&nbsp;<span class="ident" id="6638160">nil</span>&nbsp;<span class="op" id="6638164">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6638168">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6638218">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6638274">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6638326">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6638374">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6638418">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6638478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6638482">paramtype</span>&nbsp;<span class="op" id="6638492">:=</span>&nbsp;<span class="ident" id="6638495">reflect</span><span class="op" id="6638502">.</span><span class="ident" id="6638503">TypeOf</span><span class="op" id="6638509">(</span><span class="ident" id="6638510">spec</span><span class="op" id="6638514">.</span><span class="ident" id="6638515">rows</span><span class="op" id="6638519">[</span><span class="num" id="6638520">0</span><span class="op" id="6638521">]</span><span class="op" id="6638522">.</span><span class="ident" id="6638523">nullParam</span><span class="op" id="6638532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6638535">bindVal</span>&nbsp;<span class="op" id="6638543">:=</span>&nbsp;<span class="ident" id="6638546">reflect</span><span class="op" id="6638553">.</span><span class="ident" id="6638554">New</span><span class="op" id="6638557">(</span><span class="ident" id="6638558">paramtype</span><span class="op" id="6638567">)</span><span class="op" id="6638568">.</span><span class="ident" id="6638569">Interface</span><span class="op" id="6638578">(</span><span class="op" id="6638579">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6638583">for</span>&nbsp;<span class="ident" id="6638587">i</span>&nbsp;<span class="op" id="6638589">:=</span>&nbsp;<span class="num" id="6638592">0</span><span class="op" id="6638593">;</span>&nbsp;<span class="ident" id="6638595">i</span>&nbsp;<span class="op" id="6638597">&lt;</span>&nbsp;<span class="num" id="6638599">5</span><span class="op" id="6638600">;</span>&nbsp;<span class="ident" id="6638602">i</span><span class="op" id="6638603">++</span>&nbsp;<span class="op" id="6638606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6638610">id</span>&nbsp;<span class="op" id="6638613">:=</span>&nbsp;<span class="ident" id="6638616">i</span>&nbsp;<span class="op" id="6638618">+</span>&nbsp;<span class="num" id="6638620">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6638624">if</span>&nbsp;<span class="ident" id="6638627">err</span>&nbsp;<span class="op" id="6638631">:=</span>&nbsp;<span class="ident" id="6638634">db</span><span class="op" id="6638636">.</span><span class="ident" id="6638637">QueryRow</span><span class="op" id="6638645">(</span><span class="string" id="6638646">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="6638667">,</span>&nbsp;<span class="ident" id="6638669">id</span><span class="op" id="6638671">)</span><span class="op" id="6638672">.</span><span class="ident" id="6638673">Scan</span><span class="op" id="6638677">(</span><span class="ident" id="6638678">bindVal</span><span class="op" id="6638685">)</span><span class="op" id="6638686">;</span>&nbsp;<span class="ident" id="6638688">err</span>&nbsp;<span class="op" id="6638692">!=</span>&nbsp;<span class="ident" id="6638695">nil</span>&nbsp;<span class="op" id="6638699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6638704">t</span><span class="op" id="6638705">.</span><span class="ident" id="6638706">Errorf</span><span class="op" id="6638712">(</span><span class="string" id="6638713">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="6638729">,</span>&nbsp;<span class="ident" id="6638731">id</span><span class="op" id="6638733">,</span>&nbsp;<span class="ident" id="6638735">err</span><span class="op" id="6638738">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6638742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6638746">bindValDeref</span>&nbsp;<span class="op" id="6638759">:=</span>&nbsp;<span class="ident" id="6638762">reflect</span><span class="op" id="6638769">.</span><span class="ident" id="6638770">ValueOf</span><span class="op" id="6638777">(</span><span class="ident" id="6638778">bindVal</span><span class="op" id="6638785">)</span><span class="op" id="6638786">.</span><span class="ident" id="6638787">Elem</span><span class="op" id="6638791">(</span><span class="op" id="6638792">)</span><span class="op" id="6638793">.</span><span class="ident" id="6638794">Interface</span><span class="op" id="6638803">(</span><span class="op" id="6638804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6638808">if</span>&nbsp;<span class="op" id="6638811">!</span><span class="ident" id="6638812">reflect</span><span class="op" id="6638819">.</span><span class="ident" id="6638820">DeepEqual</span><span class="op" id="6638829">(</span><span class="ident" id="6638830">bindValDeref</span><span class="op" id="6638842">,</span>&nbsp;<span class="ident" id="6638844">spec</span><span class="op" id="6638848">.</span><span class="ident" id="6638849">rows</span><span class="op" id="6638853">[</span><span class="ident" id="6638854">i</span><span class="op" id="6638855">]</span><span class="op" id="6638856">.</span><span class="ident" id="6638857">scanNullVal</span><span class="op" id="6638868">)</span>&nbsp;<span class="op" id="6638870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6638875">t</span><span class="op" id="6638876">.</span><span class="ident" id="6638877">Errorf</span><span class="op" id="6638883">(</span><span class="string" id="6638884">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6638909">,</span>&nbsp;<span class="ident" id="6638911">id</span><span class="op" id="6638913">,</span>&nbsp;<span class="ident" id="6638915">bindValDeref</span><span class="op" id="6638927">,</span>&nbsp;<span class="ident" id="6638929">spec</span><span class="op" id="6638933">.</span><span class="ident" id="6638934">rows</span><span class="op" id="6638938">[</span><span class="ident" id="6638939">i</span><span class="op" id="6638940">]</span><span class="op" id="6638941">.</span><span class="ident" id="6638942">scanNullVal</span><span class="op" id="6638953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6638957">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6638960">}</span><br>
<span class="lineno"></span><span class="op" id="6638962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6638965">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="6638990">func</span>&nbsp;<span class="ident" id="6638995">TestQueryRowNilScanDest</span><span class="op" id="6639018">(</span><span class="ident" id="6639019">t</span>&nbsp;<span class="op" id="6639021">*</span><span class="ident" id="6639022">testing</span><span class="op" id="6639029">.</span><span class="ident" id="6639030">T</span><span class="op" id="6639031">)</span>&nbsp;<span class="op" id="6639033">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639036">db</span>&nbsp;<span class="op" id="6639039">:=</span>&nbsp;<span class="ident" id="6639042">newTestDB</span><span class="op" id="6639051">(</span><span class="ident" id="6639052">t</span><span class="op" id="6639053">,</span>&nbsp;<span class="string" id="6639055">&#34;people&#34;</span><span class="op" id="6639063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639066">defer</span>&nbsp;<span class="ident" id="6639072">closeDB</span><span class="op" id="6639079">(</span><span class="ident" id="6639080">t</span><span class="op" id="6639081">,</span>&nbsp;<span class="ident" id="6639083">db</span><span class="op" id="6639085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639088">var</span>&nbsp;<span class="ident" id="6639092">name</span>&nbsp;<span class="op" id="6639097">*</span><span class="builtintype" id="6639098">string</span>&nbsp;<span class="comment" id="6639105">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639121">err</span>&nbsp;<span class="op" id="6639125">:=</span>&nbsp;<span class="ident" id="6639128">db</span><span class="op" id="6639130">.</span><span class="ident" id="6639131">QueryRow</span><span class="op" id="6639139">(</span><span class="string" id="6639140">&#34;SELECT|people|name|&#34;</span><span class="op" id="6639161">)</span><span class="op" id="6639162">.</span><span class="ident" id="6639163">Scan</span><span class="op" id="6639167">(</span><span class="ident" id="6639168">name</span><span class="op" id="6639172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639175">want</span>&nbsp;<span class="op" id="6639180">:=</span>&nbsp;<span class="string" id="6639183">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639248">if</span>&nbsp;<span class="ident" id="6639251">err</span>&nbsp;<span class="op" id="6639255">==</span>&nbsp;<span class="ident" id="6639258">nil</span>&nbsp;<span class="op" id="6639262">||</span>&nbsp;<span class="ident" id="6639265">err</span><span class="op" id="6639268">.</span><span class="ident" id="6639269">Error</span><span class="op" id="6639274">(</span><span class="op" id="6639275">)</span>&nbsp;<span class="op" id="6639277">!=</span>&nbsp;<span class="ident" id="6639280">want</span>&nbsp;<span class="op" id="6639285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639289">t</span><span class="op" id="6639290">.</span><span class="ident" id="6639291">Errorf</span><span class="op" id="6639297">(</span><span class="string" id="6639298">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6639319">,</span>&nbsp;<span class="ident" id="6639321">err</span><span class="op" id="6639324">.</span><span class="ident" id="6639325">Error</span><span class="op" id="6639330">(</span><span class="op" id="6639331">)</span><span class="op" id="6639332">,</span>&nbsp;<span class="ident" id="6639334">want</span><span class="op" id="6639338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6639341">}</span><br>
<span class="lineno"></span><span class="op" id="6639343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="6639346">func</span>&nbsp;<span class="ident" id="6639351">TestIssue4902</span><span class="op" id="6639364">(</span><span class="ident" id="6639365">t</span>&nbsp;<span class="op" id="6639367">*</span><span class="ident" id="6639368">testing</span><span class="op" id="6639375">.</span><span class="ident" id="6639376">T</span><span class="op" id="6639377">)</span>&nbsp;<span class="op" id="6639379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639382">db</span>&nbsp;<span class="op" id="6639385">:=</span>&nbsp;<span class="ident" id="6639388">newTestDB</span><span class="op" id="6639397">(</span><span class="ident" id="6639398">t</span><span class="op" id="6639399">,</span>&nbsp;<span class="string" id="6639401">&#34;people&#34;</span><span class="op" id="6639409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639412">defer</span>&nbsp;<span class="ident" id="6639418">closeDB</span><span class="op" id="6639425">(</span><span class="ident" id="6639426">t</span><span class="op" id="6639427">,</span>&nbsp;<span class="ident" id="6639429">db</span><span class="op" id="6639431">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639435">driver</span>&nbsp;<span class="op" id="6639442">:=</span>&nbsp;<span class="ident" id="6639445">db</span><span class="op" id="6639447">.</span><span class="ident" id="6639448">driver</span><span class="op" id="6639454">.</span><span class="op" id="6639455">(</span><span class="op" id="6639456">*</span><span class="ident" id="6639457">fakeDriver</span><span class="op" id="6639467">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639470">opens0</span>&nbsp;<span class="op" id="6639477">:=</span>&nbsp;<span class="ident" id="6639480">driver</span><span class="op" id="6639486">.</span><span class="ident" id="6639487">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639499">var</span>&nbsp;<span class="ident" id="6639503">stmt</span>&nbsp;<span class="op" id="6639508">*</span><span class="ident" id="6639509">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639515">var</span>&nbsp;<span class="ident" id="6639519">err</span>&nbsp;<span class="builtintype" id="6639523">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639530">for</span>&nbsp;<span class="ident" id="6639534">i</span>&nbsp;<span class="op" id="6639536">:=</span>&nbsp;<span class="num" id="6639539">0</span><span class="op" id="6639540">;</span>&nbsp;<span class="ident" id="6639542">i</span>&nbsp;<span class="op" id="6639544">&lt;</span>&nbsp;<span class="num" id="6639546">10</span><span class="op" id="6639548">;</span>&nbsp;<span class="ident" id="6639550">i</span><span class="op" id="6639551">++</span>&nbsp;<span class="op" id="6639554">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639558">stmt</span><span class="op" id="6639562">,</span>&nbsp;<span class="ident" id="6639564">err</span>&nbsp;<span class="op" id="6639568">=</span>&nbsp;<span class="ident" id="6639570">db</span><span class="op" id="6639572">.</span><span class="ident" id="6639573">Prepare</span><span class="op" id="6639580">(</span><span class="string" id="6639581">&#34;SELECT|people|name|&#34;</span><span class="op" id="6639602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639606">if</span>&nbsp;<span class="ident" id="6639609">err</span>&nbsp;<span class="op" id="6639613">!=</span>&nbsp;<span class="ident" id="6639616">nil</span>&nbsp;<span class="op" id="6639620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639625">t</span><span class="op" id="6639626">.</span><span class="ident" id="6639627">Fatal</span><span class="op" id="6639632">(</span><span class="ident" id="6639633">err</span><span class="op" id="6639636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6639640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639644">err</span>&nbsp;<span class="op" id="6639648">=</span>&nbsp;<span class="ident" id="6639650">stmt</span><span class="op" id="6639654">.</span><span class="ident" id="6639655">Close</span><span class="op" id="6639660">(</span><span class="op" id="6639661">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639665">if</span>&nbsp;<span class="ident" id="6639668">err</span>&nbsp;<span class="op" id="6639672">!=</span>&nbsp;<span class="ident" id="6639675">nil</span>&nbsp;<span class="op" id="6639679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639684">t</span><span class="op" id="6639685">.</span><span class="ident" id="6639686">Fatal</span><span class="op" id="6639691">(</span><span class="ident" id="6639692">err</span><span class="op" id="6639695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6639699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6639702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639706">opens</span>&nbsp;<span class="op" id="6639712">:=</span>&nbsp;<span class="ident" id="6639715">driver</span><span class="op" id="6639721">.</span><span class="ident" id="6639722">openCount</span>&nbsp;<span class="op" id="6639732">-</span>&nbsp;<span class="ident" id="6639734">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6639742">if</span>&nbsp;<span class="ident" id="6639745">opens</span>&nbsp;<span class="op" id="6639751">&gt;</span>&nbsp;<span class="num" id="6639753">1</span>&nbsp;<span class="op" id="6639755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639759">t</span><span class="op" id="6639760">.</span><span class="ident" id="6639761">Errorf</span><span class="op" id="6639767">(</span><span class="string" id="6639768">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="6639791">,</span>&nbsp;<span class="ident" id="6639793">opens</span><span class="op" id="6639798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639802">t</span><span class="op" id="6639803">.</span><span class="ident" id="6639804">Logf</span><span class="op" id="6639808">(</span><span class="string" id="6639809">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6639819">,</span>&nbsp;<span class="ident" id="6639821">db</span><span class="op" id="6639823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639827">t</span><span class="op" id="6639828">.</span><span class="ident" id="6639829">Logf</span><span class="op" id="6639833">(</span><span class="string" id="6639834">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6639848">,</span>&nbsp;<span class="ident" id="6639850">driver</span><span class="op" id="6639856">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639860">t</span><span class="op" id="6639861">.</span><span class="ident" id="6639862">Logf</span><span class="op" id="6639866">(</span><span class="string" id="6639867">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6639879">,</span>&nbsp;<span class="ident" id="6639881">stmt</span><span class="op" id="6639885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6639888">}</span><br>
<span class="lineno"></span><span class="op" id="6639890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6639893">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="6639907">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="6639933">func</span>&nbsp;<span class="ident" id="6639938">TestSimultaneousQueries</span><span class="op" id="6639961">(</span><span class="ident" id="6639962">t</span>&nbsp;<span class="op" id="6639964">*</span><span class="ident" id="6639965">testing</span><span class="op" id="6639972">.</span><span class="ident" id="6639973">T</span><span class="op" id="6639974">)</span>&nbsp;<span class="op" id="6639976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6639979">db</span>&nbsp;<span class="op" id="6639982">:=</span>&nbsp;<span class="ident" id="6639985">newTestDB</span><span class="op" id="6639994">(</span><span class="ident" id="6639995">t</span><span class="op" id="6639996">,</span>&nbsp;<span class="string" id="6639998">&#34;people&#34;</span><span class="op" id="6640006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640009">defer</span>&nbsp;<span class="ident" id="6640015">closeDB</span><span class="op" id="6640022">(</span><span class="ident" id="6640023">t</span><span class="op" id="6640024">,</span>&nbsp;<span class="ident" id="6640026">db</span><span class="op" id="6640028">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640032">tx</span><span class="op" id="6640034">,</span>&nbsp;<span class="ident" id="6640036">err</span>&nbsp;<span class="op" id="6640040">:=</span>&nbsp;<span class="ident" id="6640043">db</span><span class="op" id="6640045">.</span><span class="ident" id="6640046">Begin</span><span class="op" id="6640051">(</span><span class="op" id="6640052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640055">if</span>&nbsp;<span class="ident" id="6640058">err</span>&nbsp;<span class="op" id="6640062">!=</span>&nbsp;<span class="ident" id="6640065">nil</span>&nbsp;<span class="op" id="6640069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640073">t</span><span class="op" id="6640074">.</span><span class="ident" id="6640075">Fatal</span><span class="op" id="6640080">(</span><span class="ident" id="6640081">err</span><span class="op" id="6640084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640090">defer</span>&nbsp;<span class="ident" id="6640096">tx</span><span class="op" id="6640098">.</span><span class="ident" id="6640099">Rollback</span><span class="op" id="6640107">(</span><span class="op" id="6640108">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640112">r1</span><span class="op" id="6640114">,</span>&nbsp;<span class="ident" id="6640116">err</span>&nbsp;<span class="op" id="6640120">:=</span>&nbsp;<span class="ident" id="6640123">tx</span><span class="op" id="6640125">.</span><span class="ident" id="6640126">Query</span><span class="op" id="6640131">(</span><span class="string" id="6640132">&#34;SELECT|people|name|&#34;</span><span class="op" id="6640153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640156">if</span>&nbsp;<span class="ident" id="6640159">err</span>&nbsp;<span class="op" id="6640163">!=</span>&nbsp;<span class="ident" id="6640166">nil</span>&nbsp;<span class="op" id="6640170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640174">t</span><span class="op" id="6640175">.</span><span class="ident" id="6640176">Fatal</span><span class="op" id="6640181">(</span><span class="ident" id="6640182">err</span><span class="op" id="6640185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640188">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640191">defer</span>&nbsp;<span class="ident" id="6640197">r1</span><span class="op" id="6640199">.</span><span class="ident" id="6640200">Close</span><span class="op" id="6640205">(</span><span class="op" id="6640206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640210">r2</span><span class="op" id="6640212">,</span>&nbsp;<span class="ident" id="6640214">err</span>&nbsp;<span class="op" id="6640218">:=</span>&nbsp;<span class="ident" id="6640221">tx</span><span class="op" id="6640223">.</span><span class="ident" id="6640224">Query</span><span class="op" id="6640229">(</span><span class="string" id="6640230">&#34;SELECT|people|name|&#34;</span><span class="op" id="6640251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640254">if</span>&nbsp;<span class="ident" id="6640257">err</span>&nbsp;<span class="op" id="6640261">!=</span>&nbsp;<span class="ident" id="6640264">nil</span>&nbsp;<span class="op" id="6640268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640272">t</span><span class="op" id="6640273">.</span><span class="ident" id="6640274">Fatal</span><span class="op" id="6640279">(</span><span class="ident" id="6640280">err</span><span class="op" id="6640283">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640289">defer</span>&nbsp;<span class="ident" id="6640295">r2</span><span class="op" id="6640297">.</span><span class="ident" id="6640298">Close</span><span class="op" id="6640303">(</span><span class="op" id="6640304">)</span><br>
<span class="lineno"></span><span class="op" id="6640306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6640309">func</span>&nbsp;<span class="ident" id="6640314">TestMaxIdleConns</span><span class="op" id="6640330">(</span><span class="ident" id="6640331">t</span>&nbsp;<span class="op" id="6640333">*</span><span class="ident" id="6640334">testing</span><span class="op" id="6640341">.</span><span class="ident" id="6640342">T</span><span class="op" id="6640343">)</span>&nbsp;<span class="op" id="6640345">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640348">db</span>&nbsp;<span class="op" id="6640351">:=</span>&nbsp;<span class="ident" id="6640354">newTestDB</span><span class="op" id="6640363">(</span><span class="ident" id="6640364">t</span><span class="op" id="6640365">,</span>&nbsp;<span class="string" id="6640367">&#34;people&#34;</span><span class="op" id="6640375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640378">defer</span>&nbsp;<span class="ident" id="6640384">closeDB</span><span class="op" id="6640391">(</span><span class="ident" id="6640392">t</span><span class="op" id="6640393">,</span>&nbsp;<span class="ident" id="6640395">db</span><span class="op" id="6640397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640401">tx</span><span class="op" id="6640403">,</span>&nbsp;<span class="ident" id="6640405">err</span>&nbsp;<span class="op" id="6640409">:=</span>&nbsp;<span class="ident" id="6640412">db</span><span class="op" id="6640414">.</span><span class="ident" id="6640415">Begin</span><span class="op" id="6640420">(</span><span class="op" id="6640421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640424">if</span>&nbsp;<span class="ident" id="6640427">err</span>&nbsp;<span class="op" id="6640431">!=</span>&nbsp;<span class="ident" id="6640434">nil</span>&nbsp;<span class="op" id="6640438">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640442">t</span><span class="op" id="6640443">.</span><span class="ident" id="6640444">Fatal</span><span class="op" id="6640449">(</span><span class="ident" id="6640450">err</span><span class="op" id="6640453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640459">tx</span><span class="op" id="6640461">.</span><span class="ident" id="6640462">Commit</span><span class="op" id="6640468">(</span><span class="op" id="6640469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640472">if</span>&nbsp;<span class="ident" id="6640475">got</span>&nbsp;<span class="op" id="6640479">:=</span>&nbsp;<span class="builtinfunc" id="6640482">len</span><span class="op" id="6640485">(</span><span class="ident" id="6640486">db</span><span class="op" id="6640488">.</span><span class="ident" id="6640489">freeConn</span><span class="op" id="6640497">)</span><span class="op" id="6640498">;</span>&nbsp;<span class="ident" id="6640500">got</span>&nbsp;<span class="op" id="6640504">!=</span>&nbsp;<span class="num" id="6640507">1</span>&nbsp;<span class="op" id="6640509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640513">t</span><span class="op" id="6640514">.</span><span class="ident" id="6640515">Errorf</span><span class="op" id="6640521">(</span><span class="string" id="6640522">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6640546">,</span>&nbsp;<span class="ident" id="6640548">got</span><span class="op" id="6640551">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640558">db</span><span class="op" id="6640560">.</span><span class="ident" id="6640561">SetMaxIdleConns</span><span class="op" id="6640576">(</span><span class="num" id="6640577">0</span><span class="op" id="6640578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640582">if</span>&nbsp;<span class="ident" id="6640585">got</span>&nbsp;<span class="op" id="6640589">:=</span>&nbsp;<span class="builtinfunc" id="6640592">len</span><span class="op" id="6640595">(</span><span class="ident" id="6640596">db</span><span class="op" id="6640598">.</span><span class="ident" id="6640599">freeConn</span><span class="op" id="6640607">)</span><span class="op" id="6640608">;</span>&nbsp;<span class="ident" id="6640610">got</span>&nbsp;<span class="op" id="6640614">!=</span>&nbsp;<span class="num" id="6640617">0</span>&nbsp;<span class="op" id="6640619">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640623">t</span><span class="op" id="6640624">.</span><span class="ident" id="6640625">Errorf</span><span class="op" id="6640631">(</span><span class="string" id="6640632">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6640674">,</span>&nbsp;<span class="ident" id="6640676">got</span><span class="op" id="6640679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640686">tx</span><span class="op" id="6640688">,</span>&nbsp;<span class="ident" id="6640690">err</span>&nbsp;<span class="op" id="6640694">=</span>&nbsp;<span class="ident" id="6640696">db</span><span class="op" id="6640698">.</span><span class="ident" id="6640699">Begin</span><span class="op" id="6640704">(</span><span class="op" id="6640705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640708">if</span>&nbsp;<span class="ident" id="6640711">err</span>&nbsp;<span class="op" id="6640715">!=</span>&nbsp;<span class="ident" id="6640718">nil</span>&nbsp;<span class="op" id="6640722">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640726">t</span><span class="op" id="6640727">.</span><span class="ident" id="6640728">Fatal</span><span class="op" id="6640733">(</span><span class="ident" id="6640734">err</span><span class="op" id="6640737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640743">tx</span><span class="op" id="6640745">.</span><span class="ident" id="6640746">Commit</span><span class="op" id="6640752">(</span><span class="op" id="6640753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640756">if</span>&nbsp;<span class="ident" id="6640759">got</span>&nbsp;<span class="op" id="6640763">:=</span>&nbsp;<span class="builtinfunc" id="6640766">len</span><span class="op" id="6640769">(</span><span class="ident" id="6640770">db</span><span class="op" id="6640772">.</span><span class="ident" id="6640773">freeConn</span><span class="op" id="6640781">)</span><span class="op" id="6640782">;</span>&nbsp;<span class="ident" id="6640784">got</span>&nbsp;<span class="op" id="6640788">!=</span>&nbsp;<span class="num" id="6640791">0</span>&nbsp;<span class="op" id="6640793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640797">t</span><span class="op" id="6640798">.</span><span class="ident" id="6640799">Errorf</span><span class="op" id="6640805">(</span><span class="string" id="6640806">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6640830">,</span>&nbsp;<span class="ident" id="6640832">got</span><span class="op" id="6640835">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640838">}</span><br>
<span class="lineno"></span><span class="op" id="6640840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6640843">func</span>&nbsp;<span class="ident" id="6640848">TestMaxOpenConns</span><span class="op" id="6640864">(</span><span class="ident" id="6640865">t</span>&nbsp;<span class="op" id="6640867">*</span><span class="ident" id="6640868">testing</span><span class="op" id="6640875">.</span><span class="ident" id="6640876">T</span><span class="op" id="6640877">)</span>&nbsp;<span class="op" id="6640879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640882">if</span>&nbsp;<span class="ident" id="6640885">testing</span><span class="op" id="6640892">.</span><span class="ident" id="6640893">Short</span><span class="op" id="6640898">(</span><span class="op" id="6640899">)</span>&nbsp;<span class="op" id="6640901">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640905">t</span><span class="op" id="6640906">.</span><span class="ident" id="6640907">Skip</span><span class="op" id="6640911">(</span><span class="string" id="6640912">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6640936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6640939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6640942">defer</span>&nbsp;<span class="ident" id="6640948">setHookpostCloseConn</span><span class="op" id="6640968">(</span><span class="ident" id="6640969">nil</span><span class="op" id="6640972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6640975">setHookpostCloseConn</span><span class="op" id="6640995">(</span><span class="keyword" id="6640996">func</span><span class="op" id="6641000">(</span><span class="ident" id="6641001">_</span>&nbsp;<span class="op" id="6641003">*</span><span class="ident" id="6641004">fakeConn</span><span class="op" id="6641012">,</span>&nbsp;<span class="ident" id="6641014">err</span>&nbsp;<span class="builtintype" id="6641018">error</span><span class="op" id="6641023">)</span>&nbsp;<span class="op" id="6641025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641029">if</span>&nbsp;<span class="ident" id="6641032">err</span>&nbsp;<span class="op" id="6641036">!=</span>&nbsp;<span class="ident" id="6641039">nil</span>&nbsp;<span class="op" id="6641043">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641048">t</span><span class="op" id="6641049">.</span><span class="ident" id="6641050">Errorf</span><span class="op" id="6641056">(</span><span class="string" id="6641057">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6641085">,</span>&nbsp;<span class="ident" id="6641087">err</span><span class="op" id="6641090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6641094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6641097">}</span><span class="op" id="6641098">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641102">db</span>&nbsp;<span class="op" id="6641105">:=</span>&nbsp;<span class="ident" id="6641108">newTestDB</span><span class="op" id="6641117">(</span><span class="ident" id="6641118">t</span><span class="op" id="6641119">,</span>&nbsp;<span class="string" id="6641121">&#34;magicquery&#34;</span><span class="op" id="6641133">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641136">defer</span>&nbsp;<span class="ident" id="6641142">closeDB</span><span class="op" id="6641149">(</span><span class="ident" id="6641150">t</span><span class="op" id="6641151">,</span>&nbsp;<span class="ident" id="6641153">db</span><span class="op" id="6641155">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641159">driver</span>&nbsp;<span class="op" id="6641166">:=</span>&nbsp;<span class="ident" id="6641169">db</span><span class="op" id="6641171">.</span><span class="ident" id="6641172">driver</span><span class="op" id="6641178">.</span><span class="op" id="6641179">(</span><span class="op" id="6641180">*</span><span class="ident" id="6641181">fakeDriver</span><span class="op" id="6641191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6641195">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6641267">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641290">db</span><span class="op" id="6641292">.</span><span class="ident" id="6641293">SetMaxIdleConns</span><span class="op" id="6641308">(</span><span class="num" id="6641309">0</span><span class="op" id="6641310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641314">if</span>&nbsp;<span class="ident" id="6641317">g</span><span class="op" id="6641318">,</span>&nbsp;<span class="ident" id="6641320">w</span>&nbsp;<span class="op" id="6641322">:=</span>&nbsp;<span class="ident" id="6641325">db</span><span class="op" id="6641327">.</span><span class="ident" id="6641328">numFreeConns</span><span class="op" id="6641340">(</span><span class="op" id="6641341">)</span><span class="op" id="6641342">,</span>&nbsp;<span class="num" id="6641344">0</span><span class="op" id="6641345">;</span>&nbsp;<span class="ident" id="6641347">g</span>&nbsp;<span class="op" id="6641349">!=</span>&nbsp;<span class="ident" id="6641352">w</span>&nbsp;<span class="op" id="6641354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641358">t</span><span class="op" id="6641359">.</span><span class="ident" id="6641360">Errorf</span><span class="op" id="6641366">(</span><span class="string" id="6641367">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6641393">,</span>&nbsp;<span class="ident" id="6641395">g</span><span class="op" id="6641396">,</span>&nbsp;<span class="ident" id="6641398">w</span><span class="op" id="6641399">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6641402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641406">if</span>&nbsp;<span class="ident" id="6641409">n</span>&nbsp;<span class="op" id="6641411">:=</span>&nbsp;<span class="ident" id="6641414">db</span><span class="op" id="6641416">.</span><span class="ident" id="6641417">numDepsPollUntil</span><span class="op" id="6641433">(</span><span class="num" id="6641434">0</span><span class="op" id="6641435">,</span>&nbsp;<span class="ident" id="6641437">time</span><span class="op" id="6641441">.</span><span class="ident" id="6641442">Second</span><span class="op" id="6641448">)</span><span class="op" id="6641449">;</span>&nbsp;<span class="ident" id="6641451">n</span>&nbsp;<span class="op" id="6641453">&gt;</span>&nbsp;<span class="num" id="6641455">0</span>&nbsp;<span class="op" id="6641457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641461">t</span><span class="op" id="6641462">.</span><span class="ident" id="6641463">Errorf</span><span class="op" id="6641469">(</span><span class="string" id="6641470">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6641511">,</span>&nbsp;<span class="ident" id="6641513">n</span><span class="op" id="6641514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641518">db</span><span class="op" id="6641520">.</span><span class="ident" id="6641521">dumpDeps</span><span class="op" id="6641529">(</span><span class="ident" id="6641530">t</span><span class="op" id="6641531">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6641534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641538">driver</span><span class="op" id="6641544">.</span><span class="ident" id="6641545">mu</span><span class="op" id="6641547">.</span><span class="ident" id="6641548">Lock</span><span class="op" id="6641552">(</span><span class="op" id="6641553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641556">opens0</span>&nbsp;<span class="op" id="6641563">:=</span>&nbsp;<span class="ident" id="6641566">driver</span><span class="op" id="6641572">.</span><span class="ident" id="6641573">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641584">closes0</span>&nbsp;<span class="op" id="6641592">:=</span>&nbsp;<span class="ident" id="6641595">driver</span><span class="op" id="6641601">.</span><span class="ident" id="6641602">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641614">driver</span><span class="op" id="6641620">.</span><span class="ident" id="6641621">mu</span><span class="op" id="6641623">.</span><span class="ident" id="6641624">Unlock</span><span class="op" id="6641630">(</span><span class="op" id="6641631">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641635">db</span><span class="op" id="6641637">.</span><span class="ident" id="6641638">SetMaxIdleConns</span><span class="op" id="6641653">(</span><span class="num" id="6641654">10</span><span class="op" id="6641656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641659">db</span><span class="op" id="6641661">.</span><span class="ident" id="6641662">SetMaxOpenConns</span><span class="op" id="6641677">(</span><span class="num" id="6641678">10</span><span class="op" id="6641680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641684">stmt</span><span class="op" id="6641688">,</span>&nbsp;<span class="ident" id="6641690">err</span>&nbsp;<span class="op" id="6641694">:=</span>&nbsp;<span class="ident" id="6641697">db</span><span class="op" id="6641699">.</span><span class="ident" id="6641700">Prepare</span><span class="op" id="6641707">(</span><span class="string" id="6641708">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="6641744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641747">if</span>&nbsp;<span class="ident" id="6641750">err</span>&nbsp;<span class="op" id="6641754">!=</span>&nbsp;<span class="ident" id="6641757">nil</span>&nbsp;<span class="op" id="6641761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641765">t</span><span class="op" id="6641766">.</span><span class="ident" id="6641767">Fatal</span><span class="op" id="6641772">(</span><span class="ident" id="6641773">err</span><span class="op" id="6641776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6641779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6641783">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641819">const</span>&nbsp;<span class="op" id="6641825">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641829">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641841">=</span>&nbsp;<span class="num" id="6641843">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641848">sleepMillis</span>&nbsp;<span class="op" id="6641860">=</span>&nbsp;<span class="num" id="6641862">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641867">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641879">=</span>&nbsp;<span class="num" id="6641881">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6641884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641887">var</span>&nbsp;<span class="ident" id="6641891">wg</span>&nbsp;<span class="ident" id="6641894">sync</span><span class="op" id="6641898">.</span><span class="ident" id="6641899">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641910">for</span>&nbsp;<span class="ident" id="6641914">batch</span>&nbsp;<span class="op" id="6641920">:=</span>&nbsp;<span class="num" id="6641923">0</span><span class="op" id="6641924">;</span>&nbsp;<span class="ident" id="6641926">batch</span>&nbsp;<span class="op" id="6641932">&lt;</span>&nbsp;<span class="ident" id="6641934">nbatch</span><span class="op" id="6641940">;</span>&nbsp;<span class="ident" id="6641942">batch</span><span class="op" id="6641947">++</span>&nbsp;<span class="op" id="6641950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6641954">for</span>&nbsp;<span class="ident" id="6641958">i</span>&nbsp;<span class="op" id="6641960">:=</span>&nbsp;<span class="num" id="6641963">0</span><span class="op" id="6641964">;</span>&nbsp;<span class="ident" id="6641966">i</span>&nbsp;<span class="op" id="6641968">&lt;</span>&nbsp;<span class="ident" id="6641970">nquery</span><span class="op" id="6641976">;</span>&nbsp;<span class="ident" id="6641978">i</span><span class="op" id="6641979">++</span>&nbsp;<span class="op" id="6641982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6641987">wg</span><span class="op" id="6641989">.</span><span class="ident" id="6641990">Add</span><span class="op" id="6641993">(</span><span class="num" id="6641994">1</span><span class="op" id="6641995">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642000">go</span>&nbsp;<span class="keyword" id="6642003">func</span><span class="op" id="6642007">(</span><span class="op" id="6642008">)</span>&nbsp;<span class="op" id="6642010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642016">defer</span>&nbsp;<span class="ident" id="6642022">wg</span><span class="op" id="6642024">.</span><span class="ident" id="6642025">Done</span><span class="op" id="6642029">(</span><span class="op" id="6642030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642036">var</span>&nbsp;<span class="ident" id="6642040">op</span>&nbsp;<span class="builtintype" id="6642043">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642054">if</span>&nbsp;<span class="ident" id="6642057">err</span>&nbsp;<span class="op" id="6642061">:=</span>&nbsp;<span class="ident" id="6642064">stmt</span><span class="op" id="6642068">.</span><span class="ident" id="6642069">QueryRow</span><span class="op" id="6642077">(</span><span class="string" id="6642078">&#34;sleep&#34;</span><span class="op" id="6642085">,</span>&nbsp;<span class="ident" id="6642087">sleepMillis</span><span class="op" id="6642098">)</span><span class="op" id="6642099">.</span><span class="ident" id="6642100">Scan</span><span class="op" id="6642104">(</span><span class="op" id="6642105">&amp;</span><span class="ident" id="6642106">op</span><span class="op" id="6642108">)</span><span class="op" id="6642109">;</span>&nbsp;<span class="ident" id="6642111">err</span>&nbsp;<span class="op" id="6642115">!=</span>&nbsp;<span class="ident" id="6642118">nil</span>&nbsp;<span class="op" id="6642122">&amp;&amp;</span>&nbsp;<span class="ident" id="6642125">err</span>&nbsp;<span class="op" id="6642129">!=</span>&nbsp;<span class="ident" id="6642132">ErrNoRows</span>&nbsp;<span class="op" id="6642142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642149">t</span><span class="op" id="6642150">.</span><span class="ident" id="6642151">Error</span><span class="op" id="6642156">(</span><span class="ident" id="6642157">err</span><span class="op" id="6642160">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6642166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6642171">}</span><span class="op" id="6642172">(</span><span class="op" id="6642173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6642177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6642181">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6642238">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6642295">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642316">time</span><span class="op" id="6642320">.</span><span class="ident" id="6642321">Sleep</span><span class="op" id="6642326">(</span><span class="num" id="6642327">2</span>&nbsp;<span class="op" id="6642329">*</span>&nbsp;<span class="ident" id="6642331">sleepMillis</span>&nbsp;<span class="op" id="6642343">*</span>&nbsp;<span class="ident" id="6642345">time</span><span class="op" id="6642349">.</span><span class="ident" id="6642350">Millisecond</span><span class="op" id="6642361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6642364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642367">wg</span><span class="op" id="6642369">.</span><span class="ident" id="6642370">Wait</span><span class="op" id="6642374">(</span><span class="op" id="6642375">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642379">if</span>&nbsp;<span class="ident" id="6642382">g</span><span class="op" id="6642383">,</span>&nbsp;<span class="ident" id="6642385">w</span>&nbsp;<span class="op" id="6642387">:=</span>&nbsp;<span class="ident" id="6642390">db</span><span class="op" id="6642392">.</span><span class="ident" id="6642393">numFreeConns</span><span class="op" id="6642405">(</span><span class="op" id="6642406">)</span><span class="op" id="6642407">,</span>&nbsp;<span class="num" id="6642409">10</span><span class="op" id="6642411">;</span>&nbsp;<span class="ident" id="6642413">g</span>&nbsp;<span class="op" id="6642415">!=</span>&nbsp;<span class="ident" id="6642418">w</span>&nbsp;<span class="op" id="6642420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642424">t</span><span class="op" id="6642425">.</span><span class="ident" id="6642426">Errorf</span><span class="op" id="6642432">(</span><span class="string" id="6642433">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6642459">,</span>&nbsp;<span class="ident" id="6642461">g</span><span class="op" id="6642462">,</span>&nbsp;<span class="ident" id="6642464">w</span><span class="op" id="6642465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6642468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642472">if</span>&nbsp;<span class="ident" id="6642475">n</span>&nbsp;<span class="op" id="6642477">:=</span>&nbsp;<span class="ident" id="6642480">db</span><span class="op" id="6642482">.</span><span class="ident" id="6642483">numDepsPollUntil</span><span class="op" id="6642499">(</span><span class="num" id="6642500">20</span><span class="op" id="6642502">,</span>&nbsp;<span class="ident" id="6642504">time</span><span class="op" id="6642508">.</span><span class="ident" id="6642509">Second</span><span class="op" id="6642515">)</span><span class="op" id="6642516">;</span>&nbsp;<span class="ident" id="6642518">n</span>&nbsp;<span class="op" id="6642520">&gt;</span>&nbsp;<span class="num" id="6642522">20</span>&nbsp;<span class="op" id="6642525">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642529">t</span><span class="op" id="6642530">.</span><span class="ident" id="6642531">Errorf</span><span class="op" id="6642537">(</span><span class="string" id="6642538">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="6642583">,</span>&nbsp;<span class="ident" id="6642585">n</span><span class="op" id="6642586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642590">db</span><span class="op" id="6642592">.</span><span class="ident" id="6642593">dumpDeps</span><span class="op" id="6642601">(</span><span class="ident" id="6642602">t</span><span class="op" id="6642603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6642606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642610">driver</span><span class="op" id="6642616">.</span><span class="ident" id="6642617">mu</span><span class="op" id="6642619">.</span><span class="ident" id="6642620">Lock</span><span class="op" id="6642624">(</span><span class="op" id="6642625">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642628">opens</span>&nbsp;<span class="op" id="6642634">:=</span>&nbsp;<span class="ident" id="6642637">driver</span><span class="op" id="6642643">.</span><span class="ident" id="6642644">openCount</span>&nbsp;<span class="op" id="6642654">-</span>&nbsp;<span class="ident" id="6642656">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642664">closes</span>&nbsp;<span class="op" id="6642671">:=</span>&nbsp;<span class="ident" id="6642674">driver</span><span class="op" id="6642680">.</span><span class="ident" id="6642681">closeCount</span>&nbsp;<span class="op" id="6642692">-</span>&nbsp;<span class="ident" id="6642694">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642703">driver</span><span class="op" id="6642709">.</span><span class="ident" id="6642710">mu</span><span class="op" id="6642712">.</span><span class="ident" id="6642713">Unlock</span><span class="op" id="6642719">(</span><span class="op" id="6642720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642724">if</span>&nbsp;<span class="ident" id="6642727">opens</span>&nbsp;<span class="op" id="6642733">&gt;</span>&nbsp;<span class="num" id="6642735">10</span>&nbsp;<span class="op" id="6642738">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642742">t</span><span class="op" id="6642743">.</span><span class="ident" id="6642744">Logf</span><span class="op" id="6642748">(</span><span class="string" id="6642749">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6642766">,</span>&nbsp;<span class="ident" id="6642768">opens</span><span class="op" id="6642773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642777">t</span><span class="op" id="6642778">.</span><span class="ident" id="6642779">Logf</span><span class="op" id="6642783">(</span><span class="string" id="6642784">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6642802">,</span>&nbsp;<span class="ident" id="6642804">closes</span><span class="op" id="6642810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642814">t</span><span class="op" id="6642815">.</span><span class="ident" id="6642816">Errorf</span><span class="op" id="6642822">(</span><span class="string" id="6642823">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="6642863">,</span>&nbsp;<span class="ident" id="6642865">opens</span><span class="op" id="6642870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642874">db</span><span class="op" id="6642876">.</span><span class="ident" id="6642877">dumpDeps</span><span class="op" id="6642885">(</span><span class="ident" id="6642886">t</span><span class="op" id="6642887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6642890">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642894">if</span>&nbsp;<span class="ident" id="6642897">err</span>&nbsp;<span class="op" id="6642901">:=</span>&nbsp;<span class="ident" id="6642904">stmt</span><span class="op" id="6642908">.</span><span class="ident" id="6642909">Close</span><span class="op" id="6642914">(</span><span class="op" id="6642915">)</span><span class="op" id="6642916">;</span>&nbsp;<span class="ident" id="6642918">err</span>&nbsp;<span class="op" id="6642922">!=</span>&nbsp;<span class="ident" id="6642925">nil</span>&nbsp;<span class="op" id="6642929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642933">t</span><span class="op" id="6642934">.</span><span class="ident" id="6642935">Fatal</span><span class="op" id="6642940">(</span><span class="ident" id="6642941">err</span><span class="op" id="6642944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6642947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6642951">if</span>&nbsp;<span class="ident" id="6642954">g</span><span class="op" id="6642955">,</span>&nbsp;<span class="ident" id="6642957">w</span>&nbsp;<span class="op" id="6642959">:=</span>&nbsp;<span class="ident" id="6642962">db</span><span class="op" id="6642964">.</span><span class="ident" id="6642965">numFreeConns</span><span class="op" id="6642977">(</span><span class="op" id="6642978">)</span><span class="op" id="6642979">,</span>&nbsp;<span class="num" id="6642981">10</span><span class="op" id="6642983">;</span>&nbsp;<span class="ident" id="6642985">g</span>&nbsp;<span class="op" id="6642987">!=</span>&nbsp;<span class="ident" id="6642990">w</span>&nbsp;<span class="op" id="6642992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6642996">t</span><span class="op" id="6642997">.</span><span class="ident" id="6642998">Errorf</span><span class="op" id="6643004">(</span><span class="string" id="6643005">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6643031">,</span>&nbsp;<span class="ident" id="6643033">g</span><span class="op" id="6643034">,</span>&nbsp;<span class="ident" id="6643036">w</span><span class="op" id="6643037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6643040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6643044">if</span>&nbsp;<span class="ident" id="6643047">n</span>&nbsp;<span class="op" id="6643049">:=</span>&nbsp;<span class="ident" id="6643052">db</span><span class="op" id="6643054">.</span><span class="ident" id="6643055">numDepsPollUntil</span><span class="op" id="6643071">(</span><span class="num" id="6643072">10</span><span class="op" id="6643074">,</span>&nbsp;<span class="ident" id="6643076">time</span><span class="op" id="6643080">.</span><span class="ident" id="6643081">Second</span><span class="op" id="6643087">)</span><span class="op" id="6643088">;</span>&nbsp;<span class="ident" id="6643090">n</span>&nbsp;<span class="op" id="6643092">&gt;</span>&nbsp;<span class="num" id="6643094">10</span>&nbsp;<span class="op" id="6643097">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643101">t</span><span class="op" id="6643102">.</span><span class="ident" id="6643103">Errorf</span><span class="op" id="6643109">(</span><span class="string" id="6643110">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="6643155">,</span>&nbsp;<span class="ident" id="6643157">n</span><span class="op" id="6643158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643162">db</span><span class="op" id="6643164">.</span><span class="ident" id="6643165">dumpDeps</span><span class="op" id="6643173">(</span><span class="ident" id="6643174">t</span><span class="op" id="6643175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6643178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643182">db</span><span class="op" id="6643184">.</span><span class="ident" id="6643185">SetMaxOpenConns</span><span class="op" id="6643200">(</span><span class="num" id="6643201">5</span><span class="op" id="6643202">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6643206">if</span>&nbsp;<span class="ident" id="6643209">g</span><span class="op" id="6643210">,</span>&nbsp;<span class="ident" id="6643212">w</span>&nbsp;<span class="op" id="6643214">:=</span>&nbsp;<span class="ident" id="6643217">db</span><span class="op" id="6643219">.</span><span class="ident" id="6643220">numFreeConns</span><span class="op" id="6643232">(</span><span class="op" id="6643233">)</span><span class="op" id="6643234">,</span>&nbsp;<span class="num" id="6643236">5</span><span class="op" id="6643237">;</span>&nbsp;<span class="ident" id="6643239">g</span>&nbsp;<span class="op" id="6643241">!=</span>&nbsp;<span class="ident" id="6643244">w</span>&nbsp;<span class="op" id="6643246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643250">t</span><span class="op" id="6643251">.</span><span class="ident" id="6643252">Errorf</span><span class="op" id="6643258">(</span><span class="string" id="6643259">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6643285">,</span>&nbsp;<span class="ident" id="6643287">g</span><span class="op" id="6643288">,</span>&nbsp;<span class="ident" id="6643290">w</span><span class="op" id="6643291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6643294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6643298">if</span>&nbsp;<span class="ident" id="6643301">n</span>&nbsp;<span class="op" id="6643303">:=</span>&nbsp;<span class="ident" id="6643306">db</span><span class="op" id="6643308">.</span><span class="ident" id="6643309">numDepsPollUntil</span><span class="op" id="6643325">(</span><span class="num" id="6643326">5</span><span class="op" id="6643327">,</span>&nbsp;<span class="ident" id="6643329">time</span><span class="op" id="6643333">.</span><span class="ident" id="6643334">Second</span><span class="op" id="6643340">)</span><span class="op" id="6643341">;</span>&nbsp;<span class="ident" id="6643343">n</span>&nbsp;<span class="op" id="6643345">&gt;</span>&nbsp;<span class="num" id="6643347">5</span>&nbsp;<span class="op" id="6643349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643353">t</span><span class="op" id="6643354">.</span><span class="ident" id="6643355">Errorf</span><span class="op" id="6643361">(</span><span class="string" id="6643362">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6643403">,</span>&nbsp;<span class="ident" id="6643405">n</span><span class="op" id="6643406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643410">db</span><span class="op" id="6643412">.</span><span class="ident" id="6643413">dumpDeps</span><span class="op" id="6643421">(</span><span class="ident" id="6643422">t</span><span class="op" id="6643423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6643426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643430">db</span><span class="op" id="6643432">.</span><span class="ident" id="6643433">SetMaxOpenConns</span><span class="op" id="6643448">(</span><span class="num" id="6643449">0</span><span class="op" id="6643450">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6643454">if</span>&nbsp;<span class="ident" id="6643457">g</span><span class="op" id="6643458">,</span>&nbsp;<span class="ident" id="6643460">w</span>&nbsp;<span class="op" id="6643462">:=</span>&nbsp;<span class="ident" id="6643465">db</span><span class="op" id="6643467">.</span><span class="ident" id="6643468">numFreeConns</span><span class="op" id="6643480">(</span><span class="op" id="6643481">)</span><span class="op" id="6643482">,</span>&nbsp;<span class="num" id="6643484">5</span><span class="op" id="6643485">;</span>&nbsp;<span class="ident" id="6643487">g</span>&nbsp;<span class="op" id="6643489">!=</span>&nbsp;<span class="ident" id="6643492">w</span>&nbsp;<span class="op" id="6643494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643498">t</span><span class="op" id="6643499">.</span><span class="ident" id="6643500">Errorf</span><span class="op" id="6643506">(</span><span class="string" id="6643507">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6643533">,</span>&nbsp;<span class="ident" id="6643535">g</span><span class="op" id="6643536">,</span>&nbsp;<span class="ident" id="6643538">w</span><span class="op" id="6643539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6643542">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6643546">if</span>&nbsp;<span class="ident" id="6643549">n</span>&nbsp;<span class="op" id="6643551">:=</span>&nbsp;<span class="ident" id="6643554">db</span><span class="op" id="6643556">.</span><span class="ident" id="6643557">numDepsPollUntil</span><span class="op" id="6643573">(</span><span class="num" id="6643574">5</span><span class="op" id="6643575">,</span>&nbsp;<span class="ident" id="6643577">time</span><span class="op" id="6643581">.</span><span class="ident" id="6643582">Second</span><span class="op" id="6643588">)</span><span class="op" id="6643589">;</span>&nbsp;<span class="ident" id="6643591">n</span>&nbsp;<span class="op" id="6643593">&gt;</span>&nbsp;<span class="num" id="6643595">5</span>&nbsp;<span class="op" id="6643597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643601">t</span><span class="op" id="6643602">.</span><span class="ident" id="6643603">Errorf</span><span class="op" id="6643609">(</span><span class="string" id="6643610">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6643651">,</span>&nbsp;<span class="ident" id="6643653">n</span><span class="op" id="6643654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643658">db</span><span class="op" id="6643660">.</span><span class="ident" id="6643661">dumpDeps</span><span class="op" id="6643669">(</span><span class="ident" id="6643670">t</span><span class="op" id="6643671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6643674">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643678">db</span><span class="op" id="6643680">.</span><span class="ident" id="6643681">SetMaxIdleConns</span><span class="op" id="6643696">(</span><span class="num" id="6643697">0</span><span class="op" id="6643698">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6643702">if</span>&nbsp;<span class="ident" id="6643705">g</span><span class="op" id="6643706">,</span>&nbsp;<span class="ident" id="6643708">w</span>&nbsp;<span class="op" id="6643710">:=</span>&nbsp;<span class="ident" id="6643713">db</span><span class="op" id="6643715">.</span><span class="ident" id="6643716">numFreeConns</span><span class="op" id="6643728">(</span><span class="op" id="6643729">)</span><span class="op" id="6643730">,</span>&nbsp;<span class="num" id="6643732">0</span><span class="op" id="6643733">;</span>&nbsp;<span class="ident" id="6643735">g</span>&nbsp;<span class="op" id="6643737">!=</span>&nbsp;<span class="ident" id="6643740">w</span>&nbsp;<span class="op" id="6643742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643746">t</span><span class="op" id="6643747">.</span><span class="ident" id="6643748">Errorf</span><span class="op" id="6643754">(</span><span class="string" id="6643755">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6643781">,</span>&nbsp;<span class="ident" id="6643783">g</span><span class="op" id="6643784">,</span>&nbsp;<span class="ident" id="6643786">w</span><span class="op" id="6643787">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6643790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6643794">if</span>&nbsp;<span class="ident" id="6643797">n</span>&nbsp;<span class="op" id="6643799">:=</span>&nbsp;<span class="ident" id="6643802">db</span><span class="op" id="6643804">.</span><span class="ident" id="6643805">numDepsPollUntil</span><span class="op" id="6643821">(</span><span class="num" id="6643822">0</span><span class="op" id="6643823">,</span>&nbsp;<span class="ident" id="6643825">time</span><span class="op" id="6643829">.</span><span class="ident" id="6643830">Second</span><span class="op" id="6643836">)</span><span class="op" id="6643837">;</span>&nbsp;<span class="ident" id="6643839">n</span>&nbsp;<span class="op" id="6643841">&gt;</span>&nbsp;<span class="num" id="6643843">0</span>&nbsp;<span class="op" id="6643845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643849">t</span><span class="op" id="6643850">.</span><span class="ident" id="6643851">Errorf</span><span class="op" id="6643857">(</span><span class="string" id="6643858">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6643899">,</span>&nbsp;<span class="ident" id="6643901">n</span><span class="op" id="6643902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643906">db</span><span class="op" id="6643908">.</span><span class="ident" id="6643909">dumpDeps</span><span class="op" id="6643917">(</span><span class="ident" id="6643918">t</span><span class="op" id="6643919">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6643922">}</span><br>
<span class="lineno"></span><span class="op" id="6643924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6643927">func</span>&nbsp;<span class="ident" id="6643932">TestSingleOpenConn</span><span class="op" id="6643950">(</span><span class="ident" id="6643951">t</span>&nbsp;<span class="op" id="6643953">*</span><span class="ident" id="6643954">testing</span><span class="op" id="6643961">.</span><span class="ident" id="6643962">T</span><span class="op" id="6643963">)</span>&nbsp;<span class="op" id="6643965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6643968">db</span>&nbsp;<span class="op" id="6643971">:=</span>&nbsp;<span class="ident" id="6643974">newTestDB</span><span class="op" id="6643983">(</span><span class="ident" id="6643984">t</span><span class="op" id="6643985">,</span>&nbsp;<span class="string" id="6643987">&#34;people&#34;</span><span class="op" id="6643995">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6643998">defer</span>&nbsp;<span class="ident" id="6644004">closeDB</span><span class="op" id="6644011">(</span><span class="ident" id="6644012">t</span><span class="op" id="6644013">,</span>&nbsp;<span class="ident" id="6644015">db</span><span class="op" id="6644017">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644021">db</span><span class="op" id="6644023">.</span><span class="ident" id="6644024">SetMaxOpenConns</span><span class="op" id="6644039">(</span><span class="num" id="6644040">1</span><span class="op" id="6644041">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644045">rows</span><span class="op" id="6644049">,</span>&nbsp;<span class="ident" id="6644051">err</span>&nbsp;<span class="op" id="6644055">:=</span>&nbsp;<span class="ident" id="6644058">db</span><span class="op" id="6644060">.</span><span class="ident" id="6644061">Query</span><span class="op" id="6644066">(</span><span class="string" id="6644067">&#34;SELECT|people|name|&#34;</span><span class="op" id="6644088">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644091">if</span>&nbsp;<span class="ident" id="6644094">err</span>&nbsp;<span class="op" id="6644098">!=</span>&nbsp;<span class="ident" id="6644101">nil</span>&nbsp;<span class="op" id="6644105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644109">t</span><span class="op" id="6644110">.</span><span class="ident" id="6644111">Fatal</span><span class="op" id="6644116">(</span><span class="ident" id="6644117">err</span><span class="op" id="6644120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6644123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644126">if</span>&nbsp;<span class="ident" id="6644129">err</span>&nbsp;<span class="op" id="6644133">=</span>&nbsp;<span class="ident" id="6644135">rows</span><span class="op" id="6644139">.</span><span class="ident" id="6644140">Close</span><span class="op" id="6644145">(</span><span class="op" id="6644146">)</span><span class="op" id="6644147">;</span>&nbsp;<span class="ident" id="6644149">err</span>&nbsp;<span class="op" id="6644153">!=</span>&nbsp;<span class="ident" id="6644156">nil</span>&nbsp;<span class="op" id="6644160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644164">t</span><span class="op" id="6644165">.</span><span class="ident" id="6644166">Fatal</span><span class="op" id="6644171">(</span><span class="ident" id="6644172">err</span><span class="op" id="6644175">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6644178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6644181">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644204">rows</span><span class="op" id="6644208">,</span>&nbsp;<span class="ident" id="6644210">err</span>&nbsp;<span class="op" id="6644214">=</span>&nbsp;<span class="ident" id="6644216">db</span><span class="op" id="6644218">.</span><span class="ident" id="6644219">Query</span><span class="op" id="6644224">(</span><span class="string" id="6644225">&#34;SELECT|people|name|&#34;</span><span class="op" id="6644246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644249">if</span>&nbsp;<span class="ident" id="6644252">err</span>&nbsp;<span class="op" id="6644256">!=</span>&nbsp;<span class="ident" id="6644259">nil</span>&nbsp;<span class="op" id="6644263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644267">t</span><span class="op" id="6644268">.</span><span class="ident" id="6644269">Fatal</span><span class="op" id="6644274">(</span><span class="ident" id="6644275">err</span><span class="op" id="6644278">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6644281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644284">if</span>&nbsp;<span class="ident" id="6644287">err</span>&nbsp;<span class="op" id="6644291">=</span>&nbsp;<span class="ident" id="6644293">rows</span><span class="op" id="6644297">.</span><span class="ident" id="6644298">Close</span><span class="op" id="6644303">(</span><span class="op" id="6644304">)</span><span class="op" id="6644305">;</span>&nbsp;<span class="ident" id="6644307">err</span>&nbsp;<span class="op" id="6644311">!=</span>&nbsp;<span class="ident" id="6644314">nil</span>&nbsp;<span class="op" id="6644318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644322">t</span><span class="op" id="6644323">.</span><span class="ident" id="6644324">Fatal</span><span class="op" id="6644329">(</span><span class="ident" id="6644330">err</span><span class="op" id="6644333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6644336">}</span><br>
<span class="lineno"></span><span class="op" id="6644338">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="6644341">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="6644366">func</span>&nbsp;<span class="ident" id="6644371">TestStmtCloseDeps</span><span class="op" id="6644388">(</span><span class="ident" id="6644389">t</span>&nbsp;<span class="op" id="6644391">*</span><span class="ident" id="6644392">testing</span><span class="op" id="6644399">.</span><span class="ident" id="6644400">T</span><span class="op" id="6644401">)</span>&nbsp;<span class="op" id="6644403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644406">if</span>&nbsp;<span class="ident" id="6644409">testing</span><span class="op" id="6644416">.</span><span class="ident" id="6644417">Short</span><span class="op" id="6644422">(</span><span class="op" id="6644423">)</span>&nbsp;<span class="op" id="6644425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644429">t</span><span class="op" id="6644430">.</span><span class="ident" id="6644431">Skip</span><span class="op" id="6644435">(</span><span class="string" id="6644436">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6644460">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6644463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644466">defer</span>&nbsp;<span class="ident" id="6644472">setHookpostCloseConn</span><span class="op" id="6644492">(</span><span class="ident" id="6644493">nil</span><span class="op" id="6644496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644499">setHookpostCloseConn</span><span class="op" id="6644519">(</span><span class="keyword" id="6644520">func</span><span class="op" id="6644524">(</span><span class="ident" id="6644525">_</span>&nbsp;<span class="op" id="6644527">*</span><span class="ident" id="6644528">fakeConn</span><span class="op" id="6644536">,</span>&nbsp;<span class="ident" id="6644538">err</span>&nbsp;<span class="builtintype" id="6644542">error</span><span class="op" id="6644547">)</span>&nbsp;<span class="op" id="6644549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644553">if</span>&nbsp;<span class="ident" id="6644556">err</span>&nbsp;<span class="op" id="6644560">!=</span>&nbsp;<span class="ident" id="6644563">nil</span>&nbsp;<span class="op" id="6644567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644572">t</span><span class="op" id="6644573">.</span><span class="ident" id="6644574">Errorf</span><span class="op" id="6644580">(</span><span class="string" id="6644581">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6644609">,</span>&nbsp;<span class="ident" id="6644611">err</span><span class="op" id="6644614">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6644618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6644621">}</span><span class="op" id="6644622">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644626">db</span>&nbsp;<span class="op" id="6644629">:=</span>&nbsp;<span class="ident" id="6644632">newTestDB</span><span class="op" id="6644641">(</span><span class="ident" id="6644642">t</span><span class="op" id="6644643">,</span>&nbsp;<span class="string" id="6644645">&#34;magicquery&#34;</span><span class="op" id="6644657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644660">defer</span>&nbsp;<span class="ident" id="6644666">closeDB</span><span class="op" id="6644673">(</span><span class="ident" id="6644674">t</span><span class="op" id="6644675">,</span>&nbsp;<span class="ident" id="6644677">db</span><span class="op" id="6644679">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644683">driver</span>&nbsp;<span class="op" id="6644690">:=</span>&nbsp;<span class="ident" id="6644693">db</span><span class="op" id="6644695">.</span><span class="ident" id="6644696">driver</span><span class="op" id="6644702">.</span><span class="op" id="6644703">(</span><span class="op" id="6644704">*</span><span class="ident" id="6644705">fakeDriver</span><span class="op" id="6644715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644719">driver</span><span class="op" id="6644725">.</span><span class="ident" id="6644726">mu</span><span class="op" id="6644728">.</span><span class="ident" id="6644729">Lock</span><span class="op" id="6644733">(</span><span class="op" id="6644734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644737">opens0</span>&nbsp;<span class="op" id="6644744">:=</span>&nbsp;<span class="ident" id="6644747">driver</span><span class="op" id="6644753">.</span><span class="ident" id="6644754">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644765">closes0</span>&nbsp;<span class="op" id="6644773">:=</span>&nbsp;<span class="ident" id="6644776">driver</span><span class="op" id="6644782">.</span><span class="ident" id="6644783">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644795">driver</span><span class="op" id="6644801">.</span><span class="ident" id="6644802">mu</span><span class="op" id="6644804">.</span><span class="ident" id="6644805">Unlock</span><span class="op" id="6644811">(</span><span class="op" id="6644812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644815">openDelta0</span>&nbsp;<span class="op" id="6644826">:=</span>&nbsp;<span class="ident" id="6644829">opens0</span>&nbsp;<span class="op" id="6644836">-</span>&nbsp;<span class="ident" id="6644838">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644848">stmt</span><span class="op" id="6644852">,</span>&nbsp;<span class="ident" id="6644854">err</span>&nbsp;<span class="op" id="6644858">:=</span>&nbsp;<span class="ident" id="6644861">db</span><span class="op" id="6644863">.</span><span class="ident" id="6644864">Prepare</span><span class="op" id="6644871">(</span><span class="string" id="6644872">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="6644908">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644911">if</span>&nbsp;<span class="ident" id="6644914">err</span>&nbsp;<span class="op" id="6644918">!=</span>&nbsp;<span class="ident" id="6644921">nil</span>&nbsp;<span class="op" id="6644925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644929">t</span><span class="op" id="6644930">.</span><span class="ident" id="6644931">Fatal</span><span class="op" id="6644936">(</span><span class="ident" id="6644937">err</span><span class="op" id="6644940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6644943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6644947">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6644983">const</span>&nbsp;<span class="op" id="6644989">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6644993">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645005">=</span>&nbsp;<span class="num" id="6645007">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645012">sleepMillis</span>&nbsp;<span class="op" id="6645024">=</span>&nbsp;<span class="num" id="6645026">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645031">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645043">=</span>&nbsp;<span class="num" id="6645045">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6645048">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645051">var</span>&nbsp;<span class="ident" id="6645055">wg</span>&nbsp;<span class="ident" id="6645058">sync</span><span class="op" id="6645062">.</span><span class="ident" id="6645063">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645074">for</span>&nbsp;<span class="ident" id="6645078">batch</span>&nbsp;<span class="op" id="6645084">:=</span>&nbsp;<span class="num" id="6645087">0</span><span class="op" id="6645088">;</span>&nbsp;<span class="ident" id="6645090">batch</span>&nbsp;<span class="op" id="6645096">&lt;</span>&nbsp;<span class="ident" id="6645098">nbatch</span><span class="op" id="6645104">;</span>&nbsp;<span class="ident" id="6645106">batch</span><span class="op" id="6645111">++</span>&nbsp;<span class="op" id="6645114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645118">for</span>&nbsp;<span class="ident" id="6645122">i</span>&nbsp;<span class="op" id="6645124">:=</span>&nbsp;<span class="num" id="6645127">0</span><span class="op" id="6645128">;</span>&nbsp;<span class="ident" id="6645130">i</span>&nbsp;<span class="op" id="6645132">&lt;</span>&nbsp;<span class="ident" id="6645134">nquery</span><span class="op" id="6645140">;</span>&nbsp;<span class="ident" id="6645142">i</span><span class="op" id="6645143">++</span>&nbsp;<span class="op" id="6645146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645151">wg</span><span class="op" id="6645153">.</span><span class="ident" id="6645154">Add</span><span class="op" id="6645157">(</span><span class="num" id="6645158">1</span><span class="op" id="6645159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645164">go</span>&nbsp;<span class="keyword" id="6645167">func</span><span class="op" id="6645171">(</span><span class="op" id="6645172">)</span>&nbsp;<span class="op" id="6645174">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645180">defer</span>&nbsp;<span class="ident" id="6645186">wg</span><span class="op" id="6645188">.</span><span class="ident" id="6645189">Done</span><span class="op" id="6645193">(</span><span class="op" id="6645194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645200">var</span>&nbsp;<span class="ident" id="6645204">op</span>&nbsp;<span class="builtintype" id="6645207">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645218">if</span>&nbsp;<span class="ident" id="6645221">err</span>&nbsp;<span class="op" id="6645225">:=</span>&nbsp;<span class="ident" id="6645228">stmt</span><span class="op" id="6645232">.</span><span class="ident" id="6645233">QueryRow</span><span class="op" id="6645241">(</span><span class="string" id="6645242">&#34;sleep&#34;</span><span class="op" id="6645249">,</span>&nbsp;<span class="ident" id="6645251">sleepMillis</span><span class="op" id="6645262">)</span><span class="op" id="6645263">.</span><span class="ident" id="6645264">Scan</span><span class="op" id="6645268">(</span><span class="op" id="6645269">&amp;</span><span class="ident" id="6645270">op</span><span class="op" id="6645272">)</span><span class="op" id="6645273">;</span>&nbsp;<span class="ident" id="6645275">err</span>&nbsp;<span class="op" id="6645279">!=</span>&nbsp;<span class="ident" id="6645282">nil</span>&nbsp;<span class="op" id="6645286">&amp;&amp;</span>&nbsp;<span class="ident" id="6645289">err</span>&nbsp;<span class="op" id="6645293">!=</span>&nbsp;<span class="ident" id="6645296">ErrNoRows</span>&nbsp;<span class="op" id="6645306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645313">t</span><span class="op" id="6645314">.</span><span class="ident" id="6645315">Error</span><span class="op" id="6645320">(</span><span class="ident" id="6645321">err</span><span class="op" id="6645324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6645330">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6645335">}</span><span class="op" id="6645336">(</span><span class="op" id="6645337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6645341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6645345">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6645402">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6645459">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645480">time</span><span class="op" id="6645484">.</span><span class="ident" id="6645485">Sleep</span><span class="op" id="6645490">(</span><span class="num" id="6645491">2</span>&nbsp;<span class="op" id="6645493">*</span>&nbsp;<span class="ident" id="6645495">sleepMillis</span>&nbsp;<span class="op" id="6645507">*</span>&nbsp;<span class="ident" id="6645509">time</span><span class="op" id="6645513">.</span><span class="ident" id="6645514">Millisecond</span><span class="op" id="6645525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6645528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645531">wg</span><span class="op" id="6645533">.</span><span class="ident" id="6645534">Wait</span><span class="op" id="6645538">(</span><span class="op" id="6645539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645543">if</span>&nbsp;<span class="ident" id="6645546">g</span><span class="op" id="6645547">,</span>&nbsp;<span class="ident" id="6645549">w</span>&nbsp;<span class="op" id="6645551">:=</span>&nbsp;<span class="ident" id="6645554">db</span><span class="op" id="6645556">.</span><span class="ident" id="6645557">numFreeConns</span><span class="op" id="6645569">(</span><span class="op" id="6645570">)</span><span class="op" id="6645571">,</span>&nbsp;<span class="num" id="6645573">2</span><span class="op" id="6645574">;</span>&nbsp;<span class="ident" id="6645576">g</span>&nbsp;<span class="op" id="6645578">!=</span>&nbsp;<span class="ident" id="6645581">w</span>&nbsp;<span class="op" id="6645583">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645587">t</span><span class="op" id="6645588">.</span><span class="ident" id="6645589">Errorf</span><span class="op" id="6645595">(</span><span class="string" id="6645596">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6645622">,</span>&nbsp;<span class="ident" id="6645624">g</span><span class="op" id="6645625">,</span>&nbsp;<span class="ident" id="6645627">w</span><span class="op" id="6645628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6645631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645635">if</span>&nbsp;<span class="ident" id="6645638">n</span>&nbsp;<span class="op" id="6645640">:=</span>&nbsp;<span class="ident" id="6645643">db</span><span class="op" id="6645645">.</span><span class="ident" id="6645646">numDepsPollUntil</span><span class="op" id="6645662">(</span><span class="num" id="6645663">4</span><span class="op" id="6645664">,</span>&nbsp;<span class="ident" id="6645666">time</span><span class="op" id="6645670">.</span><span class="ident" id="6645671">Second</span><span class="op" id="6645677">)</span><span class="op" id="6645678">;</span>&nbsp;<span class="ident" id="6645680">n</span>&nbsp;<span class="op" id="6645682">&gt;</span>&nbsp;<span class="num" id="6645684">4</span>&nbsp;<span class="op" id="6645686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645690">t</span><span class="op" id="6645691">.</span><span class="ident" id="6645692">Errorf</span><span class="op" id="6645698">(</span><span class="string" id="6645699">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="6645743">,</span>&nbsp;<span class="ident" id="6645745">n</span><span class="op" id="6645746">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645750">db</span><span class="op" id="6645752">.</span><span class="ident" id="6645753">dumpDeps</span><span class="op" id="6645761">(</span><span class="ident" id="6645762">t</span><span class="op" id="6645763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6645766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645770">driver</span><span class="op" id="6645776">.</span><span class="ident" id="6645777">mu</span><span class="op" id="6645779">.</span><span class="ident" id="6645780">Lock</span><span class="op" id="6645784">(</span><span class="op" id="6645785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645788">opens</span>&nbsp;<span class="op" id="6645794">:=</span>&nbsp;<span class="ident" id="6645797">driver</span><span class="op" id="6645803">.</span><span class="ident" id="6645804">openCount</span>&nbsp;<span class="op" id="6645814">-</span>&nbsp;<span class="ident" id="6645816">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645824">closes</span>&nbsp;<span class="op" id="6645831">:=</span>&nbsp;<span class="ident" id="6645834">driver</span><span class="op" id="6645840">.</span><span class="ident" id="6645841">closeCount</span>&nbsp;<span class="op" id="6645852">-</span>&nbsp;<span class="ident" id="6645854">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645863">openDelta</span>&nbsp;<span class="op" id="6645873">:=</span>&nbsp;<span class="op" id="6645876">(</span><span class="ident" id="6645877">driver</span><span class="op" id="6645883">.</span><span class="ident" id="6645884">openCount</span>&nbsp;<span class="op" id="6645894">-</span>&nbsp;<span class="ident" id="6645896">driver</span><span class="op" id="6645902">.</span><span class="ident" id="6645903">closeCount</span><span class="op" id="6645913">)</span>&nbsp;<span class="op" id="6645915">-</span>&nbsp;<span class="ident" id="6645917">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645929">driver</span><span class="op" id="6645935">.</span><span class="ident" id="6645936">mu</span><span class="op" id="6645938">.</span><span class="ident" id="6645939">Unlock</span><span class="op" id="6645945">(</span><span class="op" id="6645946">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6645950">if</span>&nbsp;<span class="ident" id="6645953">openDelta</span>&nbsp;<span class="op" id="6645963">&gt;</span>&nbsp;<span class="num" id="6645965">2</span>&nbsp;<span class="op" id="6645967">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6645971">t</span><span class="op" id="6645972">.</span><span class="ident" id="6645973">Logf</span><span class="op" id="6645977">(</span><span class="string" id="6645978">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6645995">,</span>&nbsp;<span class="ident" id="6645997">opens</span><span class="op" id="6646002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646006">t</span><span class="op" id="6646007">.</span><span class="ident" id="6646008">Logf</span><span class="op" id="6646012">(</span><span class="string" id="6646013">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6646031">,</span>&nbsp;<span class="ident" id="6646033">closes</span><span class="op" id="6646039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646043">t</span><span class="op" id="6646044">.</span><span class="ident" id="6646045">Logf</span><span class="op" id="6646049">(</span><span class="string" id="6646050">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6646067">,</span>&nbsp;<span class="ident" id="6646069">openDelta</span><span class="op" id="6646078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646082">t</span><span class="op" id="6646083">.</span><span class="ident" id="6646084">Errorf</span><span class="op" id="6646090">(</span><span class="string" id="6646091">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="6646130">,</span>&nbsp;<span class="ident" id="6646132">openDelta</span><span class="op" id="6646141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646145">db</span><span class="op" id="6646147">.</span><span class="ident" id="6646148">dumpDeps</span><span class="op" id="6646156">(</span><span class="ident" id="6646157">t</span><span class="op" id="6646158">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6646161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6646165">if</span>&nbsp;<span class="builtinfunc" id="6646168">len</span><span class="op" id="6646171">(</span><span class="ident" id="6646172">stmt</span><span class="op" id="6646176">.</span><span class="ident" id="6646177">css</span><span class="op" id="6646180">)</span>&nbsp;<span class="op" id="6646182">&gt;</span>&nbsp;<span class="ident" id="6646184">nquery</span>&nbsp;<span class="op" id="6646191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646195">t</span><span class="op" id="6646196">.</span><span class="ident" id="6646197">Errorf</span><span class="op" id="6646203">(</span><span class="string" id="6646204">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="6646236">,</span>&nbsp;<span class="builtinfunc" id="6646238">len</span><span class="op" id="6646241">(</span><span class="ident" id="6646242">stmt</span><span class="op" id="6646246">.</span><span class="ident" id="6646247">css</span><span class="op" id="6646250">)</span><span class="op" id="6646251">,</span>&nbsp;<span class="ident" id="6646253">nquery</span><span class="op" id="6646259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6646262">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6646266">if</span>&nbsp;<span class="ident" id="6646269">err</span>&nbsp;<span class="op" id="6646273">:=</span>&nbsp;<span class="ident" id="6646276">stmt</span><span class="op" id="6646280">.</span><span class="ident" id="6646281">Close</span><span class="op" id="6646286">(</span><span class="op" id="6646287">)</span><span class="op" id="6646288">;</span>&nbsp;<span class="ident" id="6646290">err</span>&nbsp;<span class="op" id="6646294">!=</span>&nbsp;<span class="ident" id="6646297">nil</span>&nbsp;<span class="op" id="6646301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646305">t</span><span class="op" id="6646306">.</span><span class="ident" id="6646307">Fatal</span><span class="op" id="6646312">(</span><span class="ident" id="6646313">err</span><span class="op" id="6646316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6646319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6646323">if</span>&nbsp;<span class="ident" id="6646326">g</span><span class="op" id="6646327">,</span>&nbsp;<span class="ident" id="6646329">w</span>&nbsp;<span class="op" id="6646331">:=</span>&nbsp;<span class="ident" id="6646334">db</span><span class="op" id="6646336">.</span><span class="ident" id="6646337">numFreeConns</span><span class="op" id="6646349">(</span><span class="op" id="6646350">)</span><span class="op" id="6646351">,</span>&nbsp;<span class="num" id="6646353">2</span><span class="op" id="6646354">;</span>&nbsp;<span class="ident" id="6646356">g</span>&nbsp;<span class="op" id="6646358">!=</span>&nbsp;<span class="ident" id="6646361">w</span>&nbsp;<span class="op" id="6646363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646367">t</span><span class="op" id="6646368">.</span><span class="ident" id="6646369">Errorf</span><span class="op" id="6646375">(</span><span class="string" id="6646376">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6646402">,</span>&nbsp;<span class="ident" id="6646404">g</span><span class="op" id="6646405">,</span>&nbsp;<span class="ident" id="6646407">w</span><span class="op" id="6646408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6646411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6646415">if</span>&nbsp;<span class="ident" id="6646418">n</span>&nbsp;<span class="op" id="6646420">:=</span>&nbsp;<span class="ident" id="6646423">db</span><span class="op" id="6646425">.</span><span class="ident" id="6646426">numDepsPollUntil</span><span class="op" id="6646442">(</span><span class="num" id="6646443">2</span><span class="op" id="6646444">,</span>&nbsp;<span class="ident" id="6646446">time</span><span class="op" id="6646450">.</span><span class="ident" id="6646451">Second</span><span class="op" id="6646457">)</span><span class="op" id="6646458">;</span>&nbsp;<span class="ident" id="6646460">n</span>&nbsp;<span class="op" id="6646462">&gt;</span>&nbsp;<span class="num" id="6646464">2</span>&nbsp;<span class="op" id="6646466">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646470">t</span><span class="op" id="6646471">.</span><span class="ident" id="6646472">Errorf</span><span class="op" id="6646478">(</span><span class="string" id="6646479">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="6646523">,</span>&nbsp;<span class="ident" id="6646525">n</span><span class="op" id="6646526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646530">db</span><span class="op" id="6646532">.</span><span class="ident" id="6646533">dumpDeps</span><span class="op" id="6646541">(</span><span class="ident" id="6646542">t</span><span class="op" id="6646543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6646546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646550">db</span><span class="op" id="6646552">.</span><span class="ident" id="6646553">SetMaxIdleConns</span><span class="op" id="6646568">(</span><span class="num" id="6646569">0</span><span class="op" id="6646570">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6646574">if</span>&nbsp;<span class="ident" id="6646577">g</span><span class="op" id="6646578">,</span>&nbsp;<span class="ident" id="6646580">w</span>&nbsp;<span class="op" id="6646582">:=</span>&nbsp;<span class="ident" id="6646585">db</span><span class="op" id="6646587">.</span><span class="ident" id="6646588">numFreeConns</span><span class="op" id="6646600">(</span><span class="op" id="6646601">)</span><span class="op" id="6646602">,</span>&nbsp;<span class="num" id="6646604">0</span><span class="op" id="6646605">;</span>&nbsp;<span class="ident" id="6646607">g</span>&nbsp;<span class="op" id="6646609">!=</span>&nbsp;<span class="ident" id="6646612">w</span>&nbsp;<span class="op" id="6646614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646618">t</span><span class="op" id="6646619">.</span><span class="ident" id="6646620">Errorf</span><span class="op" id="6646626">(</span><span class="string" id="6646627">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6646653">,</span>&nbsp;<span class="ident" id="6646655">g</span><span class="op" id="6646656">,</span>&nbsp;<span class="ident" id="6646658">w</span><span class="op" id="6646659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6646662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6646666">if</span>&nbsp;<span class="ident" id="6646669">n</span>&nbsp;<span class="op" id="6646671">:=</span>&nbsp;<span class="ident" id="6646674">db</span><span class="op" id="6646676">.</span><span class="ident" id="6646677">numDepsPollUntil</span><span class="op" id="6646693">(</span><span class="num" id="6646694">0</span><span class="op" id="6646695">,</span>&nbsp;<span class="ident" id="6646697">time</span><span class="op" id="6646701">.</span><span class="ident" id="6646702">Second</span><span class="op" id="6646708">)</span><span class="op" id="6646709">;</span>&nbsp;<span class="ident" id="6646711">n</span>&nbsp;<span class="op" id="6646713">&gt;</span>&nbsp;<span class="num" id="6646715">0</span>&nbsp;<span class="op" id="6646717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646721">t</span><span class="op" id="6646722">.</span><span class="ident" id="6646723">Errorf</span><span class="op" id="6646729">(</span><span class="string" id="6646730">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6646771">,</span>&nbsp;<span class="ident" id="6646773">n</span><span class="op" id="6646774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646778">db</span><span class="op" id="6646780">.</span><span class="ident" id="6646781">dumpDeps</span><span class="op" id="6646789">(</span><span class="ident" id="6646790">t</span><span class="op" id="6646791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6646794">}</span><br>
<span class="lineno"></span><span class="op" id="6646796">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="6646799">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="6646824">func</span>&nbsp;<span class="ident" id="6646829">TestCloseConnBeforeStmts</span><span class="op" id="6646853">(</span><span class="ident" id="6646854">t</span>&nbsp;<span class="op" id="6646856">*</span><span class="ident" id="6646857">testing</span><span class="op" id="6646864">.</span><span class="ident" id="6646865">T</span><span class="op" id="6646866">)</span>&nbsp;<span class="op" id="6646868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646871">db</span>&nbsp;<span class="op" id="6646874">:=</span>&nbsp;<span class="ident" id="6646877">newTestDB</span><span class="op" id="6646886">(</span><span class="ident" id="6646887">t</span><span class="op" id="6646888">,</span>&nbsp;<span class="string" id="6646890">&#34;people&#34;</span><span class="op" id="6646898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6646901">defer</span>&nbsp;<span class="ident" id="6646907">closeDB</span><span class="op" id="6646914">(</span><span class="ident" id="6646915">t</span><span class="op" id="6646916">,</span>&nbsp;<span class="ident" id="6646918">db</span><span class="op" id="6646920">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6646924">defer</span>&nbsp;<span class="ident" id="6646930">setHookpostCloseConn</span><span class="op" id="6646950">(</span><span class="ident" id="6646951">nil</span><span class="op" id="6646954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6646957">setHookpostCloseConn</span><span class="op" id="6646977">(</span><span class="keyword" id="6646978">func</span><span class="op" id="6646982">(</span><span class="ident" id="6646983">_</span>&nbsp;<span class="op" id="6646985">*</span><span class="ident" id="6646986">fakeConn</span><span class="op" id="6646994">,</span>&nbsp;<span class="ident" id="6646996">err</span>&nbsp;<span class="builtintype" id="6647000">error</span><span class="op" id="6647005">)</span>&nbsp;<span class="op" id="6647007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647011">if</span>&nbsp;<span class="ident" id="6647014">err</span>&nbsp;<span class="op" id="6647018">!=</span>&nbsp;<span class="ident" id="6647021">nil</span>&nbsp;<span class="op" id="6647025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647030">t</span><span class="op" id="6647031">.</span><span class="ident" id="6647032">Errorf</span><span class="op" id="6647038">(</span><span class="string" id="6647039">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="6647076">,</span>&nbsp;<span class="ident" id="6647078">err</span><span class="op" id="6647081">,</span>&nbsp;<span class="ident" id="6647083">stack</span><span class="op" id="6647088">(</span><span class="op" id="6647089">)</span><span class="op" id="6647090">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647095">db</span><span class="op" id="6647097">.</span><span class="ident" id="6647098">dumpDeps</span><span class="op" id="6647106">(</span><span class="ident" id="6647107">t</span><span class="op" id="6647108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647113">t</span><span class="op" id="6647114">.</span><span class="ident" id="6647115">Errorf</span><span class="op" id="6647121">(</span><span class="string" id="6647122">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6647132">,</span>&nbsp;<span class="ident" id="6647134">db</span><span class="op" id="6647136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647143">}</span><span class="op" id="6647144">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647148">stmt</span><span class="op" id="6647152">,</span>&nbsp;<span class="ident" id="6647154">err</span>&nbsp;<span class="op" id="6647158">:=</span>&nbsp;<span class="ident" id="6647161">db</span><span class="op" id="6647163">.</span><span class="ident" id="6647164">Prepare</span><span class="op" id="6647171">(</span><span class="string" id="6647172">&#34;SELECT|people|name|&#34;</span><span class="op" id="6647193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647196">if</span>&nbsp;<span class="ident" id="6647199">err</span>&nbsp;<span class="op" id="6647203">!=</span>&nbsp;<span class="ident" id="6647206">nil</span>&nbsp;<span class="op" id="6647210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647214">t</span><span class="op" id="6647215">.</span><span class="ident" id="6647216">Fatal</span><span class="op" id="6647221">(</span><span class="ident" id="6647222">err</span><span class="op" id="6647225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647232">if</span>&nbsp;<span class="builtinfunc" id="6647235">len</span><span class="op" id="6647238">(</span><span class="ident" id="6647239">db</span><span class="op" id="6647241">.</span><span class="ident" id="6647242">freeConn</span><span class="op" id="6647250">)</span>&nbsp;<span class="op" id="6647252">!=</span>&nbsp;<span class="num" id="6647255">1</span>&nbsp;<span class="op" id="6647257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647261">t</span><span class="op" id="6647262">.</span><span class="ident" id="6647263">Fatalf</span><span class="op" id="6647269">(</span><span class="string" id="6647270">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6647299">,</span>&nbsp;<span class="builtinfunc" id="6647301">len</span><span class="op" id="6647304">(</span><span class="ident" id="6647305">db</span><span class="op" id="6647307">.</span><span class="ident" id="6647308">freeConn</span><span class="op" id="6647316">)</span><span class="op" id="6647317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647323">dc</span>&nbsp;<span class="op" id="6647326">:=</span>&nbsp;<span class="ident" id="6647329">db</span><span class="op" id="6647331">.</span><span class="ident" id="6647332">freeConn</span><span class="op" id="6647340">[</span><span class="num" id="6647341">0</span><span class="op" id="6647342">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647345">if</span>&nbsp;<span class="ident" id="6647348">dc</span><span class="op" id="6647350">.</span><span class="ident" id="6647351">closed</span>&nbsp;<span class="op" id="6647358">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647362">t</span><span class="op" id="6647363">.</span><span class="ident" id="6647364">Errorf</span><span class="op" id="6647370">(</span><span class="string" id="6647371">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6647397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647404">if</span>&nbsp;<span class="ident" id="6647407">n</span>&nbsp;<span class="op" id="6647409">:=</span>&nbsp;<span class="builtinfunc" id="6647412">len</span><span class="op" id="6647415">(</span><span class="ident" id="6647416">dc</span><span class="op" id="6647418">.</span><span class="ident" id="6647419">openStmt</span><span class="op" id="6647427">)</span><span class="op" id="6647428">;</span>&nbsp;<span class="ident" id="6647430">n</span>&nbsp;<span class="op" id="6647432">!=</span>&nbsp;<span class="num" id="6647435">1</span>&nbsp;<span class="op" id="6647437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647441">t</span><span class="op" id="6647442">.</span><span class="ident" id="6647443">Errorf</span><span class="op" id="6647449">(</span><span class="string" id="6647450">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6647488">,</span>&nbsp;<span class="ident" id="6647490">n</span><span class="op" id="6647491">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647497">err</span>&nbsp;<span class="op" id="6647501">=</span>&nbsp;<span class="ident" id="6647503">db</span><span class="op" id="6647505">.</span><span class="ident" id="6647506">Close</span><span class="op" id="6647511">(</span><span class="op" id="6647512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647515">if</span>&nbsp;<span class="ident" id="6647518">err</span>&nbsp;<span class="op" id="6647522">!=</span>&nbsp;<span class="ident" id="6647525">nil</span>&nbsp;<span class="op" id="6647529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647533">t</span><span class="op" id="6647534">.</span><span class="ident" id="6647535">Errorf</span><span class="op" id="6647541">(</span><span class="string" id="6647542">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6647557">,</span>&nbsp;<span class="ident" id="6647559">err</span><span class="op" id="6647562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647565">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647568">if</span>&nbsp;<span class="op" id="6647571">!</span><span class="ident" id="6647572">dc</span><span class="op" id="6647574">.</span><span class="ident" id="6647575">closed</span>&nbsp;<span class="op" id="6647582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647586">t</span><span class="op" id="6647587">.</span><span class="ident" id="6647588">Errorf</span><span class="op" id="6647594">(</span><span class="string" id="6647595">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6647640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647646">if</span>&nbsp;<span class="ident" id="6647649">n</span>&nbsp;<span class="op" id="6647651">:=</span>&nbsp;<span class="builtinfunc" id="6647654">len</span><span class="op" id="6647657">(</span><span class="ident" id="6647658">dc</span><span class="op" id="6647660">.</span><span class="ident" id="6647661">openStmt</span><span class="op" id="6647669">)</span><span class="op" id="6647670">;</span>&nbsp;<span class="ident" id="6647672">n</span>&nbsp;<span class="op" id="6647674">!=</span>&nbsp;<span class="num" id="6647677">0</span>&nbsp;<span class="op" id="6647679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647683">t</span><span class="op" id="6647684">.</span><span class="ident" id="6647685">Errorf</span><span class="op" id="6647691">(</span><span class="string" id="6647692">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6647730">,</span>&nbsp;<span class="ident" id="6647732">n</span><span class="op" id="6647733">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647740">err</span>&nbsp;<span class="op" id="6647744">=</span>&nbsp;<span class="ident" id="6647746">stmt</span><span class="op" id="6647750">.</span><span class="ident" id="6647751">Close</span><span class="op" id="6647756">(</span><span class="op" id="6647757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647760">if</span>&nbsp;<span class="ident" id="6647763">err</span>&nbsp;<span class="op" id="6647767">!=</span>&nbsp;<span class="ident" id="6647770">nil</span>&nbsp;<span class="op" id="6647774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647778">t</span><span class="op" id="6647779">.</span><span class="ident" id="6647780">Errorf</span><span class="op" id="6647786">(</span><span class="string" id="6647787">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6647804">,</span>&nbsp;<span class="ident" id="6647806">err</span><span class="op" id="6647809">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647816">if</span>&nbsp;<span class="op" id="6647819">!</span><span class="ident" id="6647820">dc</span><span class="op" id="6647822">.</span><span class="ident" id="6647823">closed</span>&nbsp;<span class="op" id="6647830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647834">t</span><span class="op" id="6647835">.</span><span class="ident" id="6647836">Errorf</span><span class="op" id="6647842">(</span><span class="string" id="6647843">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6647866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647869">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6647872">if</span>&nbsp;<span class="ident" id="6647875">dc</span><span class="op" id="6647877">.</span><span class="ident" id="6647878">ci</span>&nbsp;<span class="op" id="6647881">!=</span>&nbsp;<span class="ident" id="6647884">nil</span>&nbsp;<span class="op" id="6647888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6647892">t</span><span class="op" id="6647893">.</span><span class="ident" id="6647894">Errorf</span><span class="op" id="6647900">(</span><span class="string" id="6647901">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="6647962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6647965">}</span><br>
<span class="lineno"></span><span class="op" id="6647967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="6647970">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="6648040">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6648070">func</span>&nbsp;<span class="ident" id="6648075">TestRowsCloseOrder</span><span class="op" id="6648093">(</span><span class="ident" id="6648094">t</span>&nbsp;<span class="op" id="6648096">*</span><span class="ident" id="6648097">testing</span><span class="op" id="6648104">.</span><span class="ident" id="6648105">T</span><span class="op" id="6648106">)</span>&nbsp;<span class="op" id="6648108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648111">db</span>&nbsp;<span class="op" id="6648114">:=</span>&nbsp;<span class="ident" id="6648117">newTestDB</span><span class="op" id="6648126">(</span><span class="ident" id="6648127">t</span><span class="op" id="6648128">,</span>&nbsp;<span class="string" id="6648130">&#34;people&#34;</span><span class="op" id="6648138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648141">defer</span>&nbsp;<span class="ident" id="6648147">closeDB</span><span class="op" id="6648154">(</span><span class="ident" id="6648155">t</span><span class="op" id="6648156">,</span>&nbsp;<span class="ident" id="6648158">db</span><span class="op" id="6648160">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648164">db</span><span class="op" id="6648166">.</span><span class="ident" id="6648167">SetMaxIdleConns</span><span class="op" id="6648182">(</span><span class="num" id="6648183">0</span><span class="op" id="6648184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648187">setStrictFakeConnClose</span><span class="op" id="6648209">(</span><span class="ident" id="6648210">t</span><span class="op" id="6648211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648214">defer</span>&nbsp;<span class="ident" id="6648220">setStrictFakeConnClose</span><span class="op" id="6648242">(</span><span class="ident" id="6648243">nil</span><span class="op" id="6648246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648250">rows</span><span class="op" id="6648254">,</span>&nbsp;<span class="ident" id="6648256">err</span>&nbsp;<span class="op" id="6648260">:=</span>&nbsp;<span class="ident" id="6648263">db</span><span class="op" id="6648265">.</span><span class="ident" id="6648266">Query</span><span class="op" id="6648271">(</span><span class="string" id="6648272">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6648297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648300">if</span>&nbsp;<span class="ident" id="6648303">err</span>&nbsp;<span class="op" id="6648307">!=</span>&nbsp;<span class="ident" id="6648310">nil</span>&nbsp;<span class="op" id="6648314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648318">t</span><span class="op" id="6648319">.</span><span class="ident" id="6648320">Fatal</span><span class="op" id="6648325">(</span><span class="ident" id="6648326">err</span><span class="op" id="6648329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6648332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648335">err</span>&nbsp;<span class="op" id="6648339">=</span>&nbsp;<span class="ident" id="6648341">rows</span><span class="op" id="6648345">.</span><span class="ident" id="6648346">Close</span><span class="op" id="6648351">(</span><span class="op" id="6648352">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648355">if</span>&nbsp;<span class="ident" id="6648358">err</span>&nbsp;<span class="op" id="6648362">!=</span>&nbsp;<span class="ident" id="6648365">nil</span>&nbsp;<span class="op" id="6648369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648373">t</span><span class="op" id="6648374">.</span><span class="ident" id="6648375">Fatal</span><span class="op" id="6648380">(</span><span class="ident" id="6648381">err</span><span class="op" id="6648384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6648387">}</span><br>
<span class="lineno"></span><span class="op" id="6648389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="6648392">func</span>&nbsp;<span class="ident" id="6648397">TestRowsImplicitClose</span><span class="op" id="6648418">(</span><span class="ident" id="6648419">t</span>&nbsp;<span class="op" id="6648421">*</span><span class="ident" id="6648422">testing</span><span class="op" id="6648429">.</span><span class="ident" id="6648430">T</span><span class="op" id="6648431">)</span>&nbsp;<span class="op" id="6648433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648436">db</span>&nbsp;<span class="op" id="6648439">:=</span>&nbsp;<span class="ident" id="6648442">newTestDB</span><span class="op" id="6648451">(</span><span class="ident" id="6648452">t</span><span class="op" id="6648453">,</span>&nbsp;<span class="string" id="6648455">&#34;people&#34;</span><span class="op" id="6648463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648466">defer</span>&nbsp;<span class="ident" id="6648472">closeDB</span><span class="op" id="6648479">(</span><span class="ident" id="6648480">t</span><span class="op" id="6648481">,</span>&nbsp;<span class="ident" id="6648483">db</span><span class="op" id="6648485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648489">rows</span><span class="op" id="6648493">,</span>&nbsp;<span class="ident" id="6648495">err</span>&nbsp;<span class="op" id="6648499">:=</span>&nbsp;<span class="ident" id="6648502">db</span><span class="op" id="6648504">.</span><span class="ident" id="6648505">Query</span><span class="op" id="6648510">(</span><span class="string" id="6648511">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6648536">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648539">if</span>&nbsp;<span class="ident" id="6648542">err</span>&nbsp;<span class="op" id="6648546">!=</span>&nbsp;<span class="ident" id="6648549">nil</span>&nbsp;<span class="op" id="6648553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648557">t</span><span class="op" id="6648558">.</span><span class="ident" id="6648559">Fatal</span><span class="op" id="6648564">(</span><span class="ident" id="6648565">err</span><span class="op" id="6648568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6648571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648575">want</span><span class="op" id="6648579">,</span>&nbsp;<span class="ident" id="6648581">fail</span>&nbsp;<span class="op" id="6648586">:=</span>&nbsp;<span class="num" id="6648589">2</span><span class="op" id="6648590">,</span>&nbsp;<span class="ident" id="6648592">errors</span><span class="op" id="6648598">.</span><span class="ident" id="6648599">New</span><span class="op" id="6648602">(</span><span class="string" id="6648603">&#34;fail&#34;</span><span class="op" id="6648609">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648612">r</span>&nbsp;<span class="op" id="6648614">:=</span>&nbsp;<span class="ident" id="6648617">rows</span><span class="op" id="6648621">.</span><span class="ident" id="6648622">rowsi</span><span class="op" id="6648627">.</span><span class="op" id="6648628">(</span><span class="op" id="6648629">*</span><span class="ident" id="6648630">rowsCursor</span><span class="op" id="6648640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648643">r</span><span class="op" id="6648644">.</span><span class="ident" id="6648645">errPos</span><span class="op" id="6648651">,</span>&nbsp;<span class="ident" id="6648653">r</span><span class="op" id="6648654">.</span><span class="ident" id="6648655">err</span>&nbsp;<span class="op" id="6648659">=</span>&nbsp;<span class="ident" id="6648661">want</span><span class="op" id="6648665">,</span>&nbsp;<span class="ident" id="6648667">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648674">got</span>&nbsp;<span class="op" id="6648678">:=</span>&nbsp;<span class="num" id="6648681">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648684">for</span>&nbsp;<span class="ident" id="6648688">rows</span><span class="op" id="6648692">.</span><span class="ident" id="6648693">Next</span><span class="op" id="6648697">(</span><span class="op" id="6648698">)</span>&nbsp;<span class="op" id="6648700">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648704">got</span><span class="op" id="6648707">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6648711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648714">if</span>&nbsp;<span class="ident" id="6648717">got</span>&nbsp;<span class="op" id="6648721">!=</span>&nbsp;<span class="ident" id="6648724">want</span>&nbsp;<span class="op" id="6648729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648733">t</span><span class="op" id="6648734">.</span><span class="ident" id="6648735">Errorf</span><span class="op" id="6648741">(</span><span class="string" id="6648742">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6648764">,</span>&nbsp;<span class="ident" id="6648766">got</span><span class="op" id="6648769">,</span>&nbsp;<span class="ident" id="6648771">want</span><span class="op" id="6648775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6648778">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648781">if</span>&nbsp;<span class="ident" id="6648784">err</span>&nbsp;<span class="op" id="6648788">:=</span>&nbsp;<span class="ident" id="6648791">rows</span><span class="op" id="6648795">.</span><span class="ident" id="6648796">Err</span><span class="op" id="6648799">(</span><span class="op" id="6648800">)</span><span class="op" id="6648801">;</span>&nbsp;<span class="ident" id="6648803">err</span>&nbsp;<span class="op" id="6648807">!=</span>&nbsp;<span class="ident" id="6648810">fail</span>&nbsp;<span class="op" id="6648815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648819">t</span><span class="op" id="6648820">.</span><span class="ident" id="6648821">Errorf</span><span class="op" id="6648827">(</span><span class="string" id="6648828">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6648851">,</span>&nbsp;<span class="ident" id="6648853">err</span><span class="op" id="6648856">,</span>&nbsp;<span class="ident" id="6648858">fail</span><span class="op" id="6648862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6648865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6648868">if</span>&nbsp;<span class="op" id="6648871">!</span><span class="ident" id="6648872">r</span><span class="op" id="6648873">.</span><span class="ident" id="6648874">closed</span>&nbsp;<span class="op" id="6648881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648885">t</span><span class="op" id="6648886">.</span><span class="ident" id="6648887">Errorf</span><span class="op" id="6648893">(</span><span class="string" id="6648894">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="6648924">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6648927">}</span><br>
<span class="lineno"></span><span class="op" id="6648929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6648932">func</span>&nbsp;<span class="ident" id="6648937">TestStmtCloseOrder</span><span class="op" id="6648955">(</span><span class="ident" id="6648956">t</span>&nbsp;<span class="op" id="6648958">*</span><span class="ident" id="6648959">testing</span><span class="op" id="6648966">.</span><span class="ident" id="6648967">T</span><span class="op" id="6648968">)</span>&nbsp;<span class="op" id="6648970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6648973">db</span>&nbsp;<span class="op" id="6648976">:=</span>&nbsp;<span class="ident" id="6648979">newTestDB</span><span class="op" id="6648988">(</span><span class="ident" id="6648989">t</span><span class="op" id="6648990">,</span>&nbsp;<span class="string" id="6648992">&#34;people&#34;</span><span class="op" id="6649000">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649003">defer</span>&nbsp;<span class="ident" id="6649009">closeDB</span><span class="op" id="6649016">(</span><span class="ident" id="6649017">t</span><span class="op" id="6649018">,</span>&nbsp;<span class="ident" id="6649020">db</span><span class="op" id="6649022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649026">db</span><span class="op" id="6649028">.</span><span class="ident" id="6649029">SetMaxIdleConns</span><span class="op" id="6649044">(</span><span class="num" id="6649045">0</span><span class="op" id="6649046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649049">setStrictFakeConnClose</span><span class="op" id="6649071">(</span><span class="ident" id="6649072">t</span><span class="op" id="6649073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649076">defer</span>&nbsp;<span class="ident" id="6649082">setStrictFakeConnClose</span><span class="op" id="6649104">(</span><span class="ident" id="6649105">nil</span><span class="op" id="6649108">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649112">_</span><span class="op" id="6649113">,</span>&nbsp;<span class="ident" id="6649115">err</span>&nbsp;<span class="op" id="6649119">:=</span>&nbsp;<span class="ident" id="6649122">db</span><span class="op" id="6649124">.</span><span class="ident" id="6649125">Query</span><span class="op" id="6649130">(</span><span class="string" id="6649131">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="6649158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649161">if</span>&nbsp;<span class="ident" id="6649164">err</span>&nbsp;<span class="op" id="6649168">==</span>&nbsp;<span class="ident" id="6649171">nil</span>&nbsp;<span class="op" id="6649175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649179">t</span><span class="op" id="6649180">.</span><span class="ident" id="6649181">Fatal</span><span class="op" id="6649186">(</span><span class="string" id="6649187">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="6649227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6649230">}</span><br>
<span class="lineno">1315</span><span class="op" id="6649232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6649235">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="6649260">func</span>&nbsp;<span class="ident" id="6649265">TestErrBadConnReconnect</span><span class="op" id="6649288">(</span><span class="ident" id="6649289">t</span>&nbsp;<span class="op" id="6649291">*</span><span class="ident" id="6649292">testing</span><span class="op" id="6649299">.</span><span class="ident" id="6649300">T</span><span class="op" id="6649301">)</span>&nbsp;<span class="op" id="6649303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649306">db</span>&nbsp;<span class="op" id="6649309">:=</span>&nbsp;<span class="ident" id="6649312">newTestDB</span><span class="op" id="6649321">(</span><span class="ident" id="6649322">t</span><span class="op" id="6649323">,</span>&nbsp;<span class="string" id="6649325">&#34;foo&#34;</span><span class="op" id="6649330">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649333">defer</span>&nbsp;<span class="ident" id="6649339">closeDB</span><span class="op" id="6649346">(</span><span class="ident" id="6649347">t</span><span class="op" id="6649348">,</span>&nbsp;<span class="ident" id="6649350">db</span><span class="op" id="6649352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649355">exec</span><span class="op" id="6649359">(</span><span class="ident" id="6649360">t</span><span class="op" id="6649361">,</span>&nbsp;<span class="ident" id="6649363">db</span><span class="op" id="6649365">,</span>&nbsp;<span class="string" id="6649367">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6649410">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649414">simulateBadConn</span>&nbsp;<span class="op" id="6649430">:=</span>&nbsp;<span class="keyword" id="6649433">func</span><span class="op" id="6649437">(</span><span class="ident" id="6649438">name</span>&nbsp;<span class="builtintype" id="6649443">string</span><span class="op" id="6649449">,</span>&nbsp;<span class="ident" id="6649451">hook</span>&nbsp;<span class="op" id="6649456">*</span><span class="keyword" id="6649457">func</span><span class="op" id="6649461">(</span><span class="op" id="6649462">)</span>&nbsp;<span class="builtintype" id="6649464">bool</span><span class="op" id="6649468">,</span>&nbsp;<span class="ident" id="6649470">op</span>&nbsp;<span class="keyword" id="6649473">func</span><span class="op" id="6649477">(</span><span class="op" id="6649478">)</span>&nbsp;<span class="builtintype" id="6649480">error</span><span class="op" id="6649485">)</span>&nbsp;<span class="op" id="6649487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649491">broken</span><span class="op" id="6649497">,</span>&nbsp;<span class="ident" id="6649499">retried</span>&nbsp;<span class="op" id="6649507">:=</span>&nbsp;<span class="builtintype" id="6649510">false</span><span class="op" id="6649515">,</span>&nbsp;<span class="builtintype" id="6649517">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649525">numOpen</span>&nbsp;<span class="op" id="6649533">:=</span>&nbsp;<span class="ident" id="6649536">db</span><span class="op" id="6649538">.</span><span class="ident" id="6649539">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6649550">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6649601">*</span><span class="ident" id="6649602">hook</span>&nbsp;<span class="op" id="6649607">=</span>&nbsp;<span class="keyword" id="6649609">func</span><span class="op" id="6649613">(</span><span class="op" id="6649614">)</span>&nbsp;<span class="builtintype" id="6649616">bool</span>&nbsp;<span class="op" id="6649621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649626">if</span>&nbsp;<span class="op" id="6649629">!</span><span class="ident" id="6649630">broken</span>&nbsp;<span class="op" id="6649637">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649643">broken</span>&nbsp;<span class="op" id="6649650">=</span>&nbsp;<span class="builtintype" id="6649652">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649661">return</span>&nbsp;<span class="builtintype" id="6649668">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6649676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649681">retried</span>&nbsp;<span class="op" id="6649689">=</span>&nbsp;<span class="builtintype" id="6649691">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649699">return</span>&nbsp;<span class="builtintype" id="6649706">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6649714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649719">if</span>&nbsp;<span class="ident" id="6649722">err</span>&nbsp;<span class="op" id="6649726">:=</span>&nbsp;<span class="ident" id="6649729">op</span><span class="op" id="6649731">(</span><span class="op" id="6649732">)</span><span class="op" id="6649733">;</span>&nbsp;<span class="ident" id="6649735">err</span>&nbsp;<span class="op" id="6649739">!=</span>&nbsp;<span class="ident" id="6649742">nil</span>&nbsp;<span class="op" id="6649746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649751">t</span><span class="op" id="6649752">.</span><span class="ident" id="6649753">Errorf</span><span class="op" id="6649759">(</span><span class="ident" id="6649760">name</span><span class="op" id="6649764">+</span><span class="string" id="6649765">&#34;:&nbsp;%v&#34;</span><span class="op" id="6649771">,</span>&nbsp;<span class="ident" id="6649773">err</span><span class="op" id="6649776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649781">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6649790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649795">if</span>&nbsp;<span class="op" id="6649798">!</span><span class="ident" id="6649799">broken</span>&nbsp;<span class="op" id="6649806">||</span>&nbsp;<span class="op" id="6649809">!</span><span class="ident" id="6649810">retried</span>&nbsp;<span class="op" id="6649818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649823">t</span><span class="op" id="6649824">.</span><span class="ident" id="6649825">Error</span><span class="op" id="6649830">(</span><span class="ident" id="6649831">name</span>&nbsp;<span class="op" id="6649836">+</span>&nbsp;<span class="string" id="6649838">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="6649878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6649882">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6649886">*</span><span class="ident" id="6649887">hook</span>&nbsp;<span class="op" id="6649892">=</span>&nbsp;<span class="ident" id="6649894">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6649901">if</span>&nbsp;<span class="ident" id="6649904">numOpen</span>&nbsp;<span class="op" id="6649912">!=</span>&nbsp;<span class="ident" id="6649915">db</span><span class="op" id="6649917">.</span><span class="ident" id="6649918">numOpen</span>&nbsp;<span class="op" id="6649926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649931">t</span><span class="op" id="6649932">.</span><span class="ident" id="6649933">Errorf</span><span class="op" id="6649939">(</span><span class="ident" id="6649940">name</span><span class="op" id="6649944">+</span><span class="string" id="6649945">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="6649973">,</span>&nbsp;<span class="ident" id="6649975">db</span><span class="op" id="6649977">.</span><span class="ident" id="6649978">numOpen</span><span class="op" id="6649985">-</span><span class="ident" id="6649986">numOpen</span><span class="op" id="6649993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6649998">numOpen</span>&nbsp;<span class="op" id="6650006">=</span>&nbsp;<span class="ident" id="6650008">db</span><span class="op" id="6650010">.</span><span class="ident" id="6650011">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6650021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6650024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6650028">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650040">dbExec</span>&nbsp;<span class="op" id="6650047">:=</span>&nbsp;<span class="keyword" id="6650050">func</span><span class="op" id="6650054">(</span><span class="op" id="6650055">)</span>&nbsp;<span class="builtintype" id="6650057">error</span>&nbsp;<span class="op" id="6650063">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650067">_</span><span class="op" id="6650068">,</span>&nbsp;<span class="ident" id="6650070">err</span>&nbsp;<span class="op" id="6650074">:=</span>&nbsp;<span class="ident" id="6650077">db</span><span class="op" id="6650079">.</span><span class="ident" id="6650080">Exec</span><span class="op" id="6650084">(</span><span class="string" id="6650085">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6650116">,</span>&nbsp;<span class="string" id="6650118">&#34;Gordon&#34;</span><span class="op" id="6650126">,</span>&nbsp;<span class="num" id="6650128">3</span><span class="op" id="6650129">,</span>&nbsp;<span class="builtintype" id="6650131">true</span><span class="op" id="6650135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6650139">return</span>&nbsp;<span class="ident" id="6650146">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6650151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650154">simulateBadConn</span><span class="op" id="6650169">(</span><span class="string" id="6650170">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="6650187">,</span>&nbsp;<span class="op" id="6650189">&amp;</span><span class="ident" id="6650190">hookPrepareBadConn</span><span class="op" id="6650208">,</span>&nbsp;<span class="ident" id="6650210">dbExec</span><span class="op" id="6650216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650219">simulateBadConn</span><span class="op" id="6650234">(</span><span class="string" id="6650235">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="6650249">,</span>&nbsp;<span class="op" id="6650251">&amp;</span><span class="ident" id="6650252">hookExecBadConn</span><span class="op" id="6650267">,</span>&nbsp;<span class="ident" id="6650269">dbExec</span><span class="op" id="6650275">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6650279">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650292">dbQuery</span>&nbsp;<span class="op" id="6650300">:=</span>&nbsp;<span class="keyword" id="6650303">func</span><span class="op" id="6650307">(</span><span class="op" id="6650308">)</span>&nbsp;<span class="builtintype" id="6650310">error</span>&nbsp;<span class="op" id="6650316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650320">rows</span><span class="op" id="6650324">,</span>&nbsp;<span class="ident" id="6650326">err</span>&nbsp;<span class="op" id="6650330">:=</span>&nbsp;<span class="ident" id="6650333">db</span><span class="op" id="6650335">.</span><span class="ident" id="6650336">Query</span><span class="op" id="6650341">(</span><span class="string" id="6650342">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="6650363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6650367">if</span>&nbsp;<span class="ident" id="6650370">err</span>&nbsp;<span class="op" id="6650374">==</span>&nbsp;<span class="ident" id="6650377">nil</span>&nbsp;<span class="op" id="6650381">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650386">err</span>&nbsp;<span class="op" id="6650390">=</span>&nbsp;<span class="ident" id="6650392">rows</span><span class="op" id="6650396">.</span><span class="ident" id="6650397">Close</span><span class="op" id="6650402">(</span><span class="op" id="6650403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6650407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6650411">return</span>&nbsp;<span class="ident" id="6650418">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6650423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650426">simulateBadConn</span><span class="op" id="6650441">(</span><span class="string" id="6650442">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="6650460">,</span>&nbsp;<span class="op" id="6650462">&amp;</span><span class="ident" id="6650463">hookPrepareBadConn</span><span class="op" id="6650481">,</span>&nbsp;<span class="ident" id="6650483">dbQuery</span><span class="op" id="6650490">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650493">simulateBadConn</span><span class="op" id="6650508">(</span><span class="string" id="6650509">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="6650525">,</span>&nbsp;<span class="op" id="6650527">&amp;</span><span class="ident" id="6650528">hookQueryBadConn</span><span class="op" id="6650544">,</span>&nbsp;<span class="ident" id="6650546">dbQuery</span><span class="op" id="6650553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6650557">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650572">simulateBadConn</span><span class="op" id="6650587">(</span><span class="string" id="6650588">&#34;db.Prepare&#34;</span><span class="op" id="6650600">,</span>&nbsp;<span class="op" id="6650602">&amp;</span><span class="ident" id="6650603">hookPrepareBadConn</span><span class="op" id="6650621">,</span>&nbsp;<span class="keyword" id="6650623">func</span><span class="op" id="6650627">(</span><span class="op" id="6650628">)</span>&nbsp;<span class="builtintype" id="6650630">error</span>&nbsp;<span class="op" id="6650636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650640">stmt</span><span class="op" id="6650644">,</span>&nbsp;<span class="ident" id="6650646">err</span>&nbsp;<span class="op" id="6650650">:=</span>&nbsp;<span class="ident" id="6650653">db</span><span class="op" id="6650655">.</span><span class="ident" id="6650656">Prepare</span><span class="op" id="6650663">(</span><span class="string" id="6650664">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6650695">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6650699">if</span>&nbsp;<span class="ident" id="6650702">err</span>&nbsp;<span class="op" id="6650706">!=</span>&nbsp;<span class="ident" id="6650709">nil</span>&nbsp;<span class="op" id="6650713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6650718">return</span>&nbsp;<span class="ident" id="6650725">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6650731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650735">stmt</span><span class="op" id="6650739">.</span><span class="ident" id="6650740">Close</span><span class="op" id="6650745">(</span><span class="op" id="6650746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6650750">return</span>&nbsp;<span class="ident" id="6650757">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6650762">}</span><span class="op" id="6650763">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6650767">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650840">forcePrepare</span>&nbsp;<span class="op" id="6650853">:=</span>&nbsp;<span class="keyword" id="6650856">func</span><span class="op" id="6650860">(</span><span class="ident" id="6650861">stmt</span>&nbsp;<span class="op" id="6650866">*</span><span class="ident" id="6650867">Stmt</span><span class="op" id="6650871">)</span>&nbsp;<span class="op" id="6650873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650877">stmt</span><span class="op" id="6650881">.</span><span class="ident" id="6650882">css</span>&nbsp;<span class="op" id="6650886">=</span>&nbsp;<span class="ident" id="6650888">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6650893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6650897">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650911">stmt1</span><span class="op" id="6650916">,</span>&nbsp;<span class="ident" id="6650918">err</span>&nbsp;<span class="op" id="6650922">:=</span>&nbsp;<span class="ident" id="6650925">db</span><span class="op" id="6650927">.</span><span class="ident" id="6650928">Prepare</span><span class="op" id="6650935">(</span><span class="string" id="6650936">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6650967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6650970">if</span>&nbsp;<span class="ident" id="6650973">err</span>&nbsp;<span class="op" id="6650977">!=</span>&nbsp;<span class="ident" id="6650980">nil</span>&nbsp;<span class="op" id="6650984">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6650988">t</span><span class="op" id="6650989">.</span><span class="ident" id="6650990">Fatalf</span><span class="op" id="6650996">(</span><span class="string" id="6650997">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6651010">,</span>&nbsp;<span class="ident" id="6651012">err</span><span class="op" id="6651015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6651018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6651021">defer</span>&nbsp;<span class="ident" id="6651027">stmt1</span><span class="op" id="6651032">.</span><span class="ident" id="6651033">Close</span><span class="op" id="6651038">(</span><span class="op" id="6651039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6651042">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651087">forcePrepare</span><span class="op" id="6651099">(</span><span class="ident" id="6651100">stmt1</span><span class="op" id="6651105">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651109">stmtExec</span>&nbsp;<span class="op" id="6651118">:=</span>&nbsp;<span class="keyword" id="6651121">func</span><span class="op" id="6651125">(</span><span class="op" id="6651126">)</span>&nbsp;<span class="builtintype" id="6651128">error</span>&nbsp;<span class="op" id="6651134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651138">_</span><span class="op" id="6651139">,</span>&nbsp;<span class="ident" id="6651141">err</span>&nbsp;<span class="op" id="6651145">:=</span>&nbsp;<span class="ident" id="6651148">stmt1</span><span class="op" id="6651153">.</span><span class="ident" id="6651154">Exec</span><span class="op" id="6651158">(</span><span class="string" id="6651159">&#34;Gopher&#34;</span><span class="op" id="6651167">,</span>&nbsp;<span class="num" id="6651169">3</span><span class="op" id="6651170">,</span>&nbsp;<span class="builtintype" id="6651172">false</span><span class="op" id="6651177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6651181">return</span>&nbsp;<span class="ident" id="6651188">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6651193">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651196">simulateBadConn</span><span class="op" id="6651211">(</span><span class="string" id="6651212">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="6651231">,</span>&nbsp;<span class="op" id="6651233">&amp;</span><span class="ident" id="6651234">hookPrepareBadConn</span><span class="op" id="6651252">,</span>&nbsp;<span class="ident" id="6651254">stmtExec</span><span class="op" id="6651262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651265">simulateBadConn</span><span class="op" id="6651280">(</span><span class="string" id="6651281">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="6651297">,</span>&nbsp;<span class="op" id="6651299">&amp;</span><span class="ident" id="6651300">hookExecBadConn</span><span class="op" id="6651315">,</span>&nbsp;<span class="ident" id="6651317">stmtExec</span><span class="op" id="6651325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6651329">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651344">stmt2</span><span class="op" id="6651349">,</span>&nbsp;<span class="ident" id="6651351">err</span>&nbsp;<span class="op" id="6651355">:=</span>&nbsp;<span class="ident" id="6651358">db</span><span class="op" id="6651360">.</span><span class="ident" id="6651361">Prepare</span><span class="op" id="6651368">(</span><span class="string" id="6651369">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="6651390">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6651393">if</span>&nbsp;<span class="ident" id="6651396">err</span>&nbsp;<span class="op" id="6651400">!=</span>&nbsp;<span class="ident" id="6651403">nil</span>&nbsp;<span class="op" id="6651407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651411">t</span><span class="op" id="6651412">.</span><span class="ident" id="6651413">Fatalf</span><span class="op" id="6651419">(</span><span class="string" id="6651420">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6651433">,</span>&nbsp;<span class="ident" id="6651435">err</span><span class="op" id="6651438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6651441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6651444">defer</span>&nbsp;<span class="ident" id="6651450">stmt2</span><span class="op" id="6651455">.</span><span class="ident" id="6651456">Close</span><span class="op" id="6651461">(</span><span class="op" id="6651462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6651465">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651510">forcePrepare</span><span class="op" id="6651522">(</span><span class="ident" id="6651523">stmt2</span><span class="op" id="6651528">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651532">stmtQuery</span>&nbsp;<span class="op" id="6651542">:=</span>&nbsp;<span class="keyword" id="6651545">func</span><span class="op" id="6651549">(</span><span class="op" id="6651550">)</span>&nbsp;<span class="builtintype" id="6651552">error</span>&nbsp;<span class="op" id="6651558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651562">rows</span><span class="op" id="6651566">,</span>&nbsp;<span class="ident" id="6651568">err</span>&nbsp;<span class="op" id="6651572">:=</span>&nbsp;<span class="ident" id="6651575">stmt2</span><span class="op" id="6651580">.</span><span class="ident" id="6651581">Query</span><span class="op" id="6651586">(</span><span class="op" id="6651587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6651591">if</span>&nbsp;<span class="ident" id="6651594">err</span>&nbsp;<span class="op" id="6651598">==</span>&nbsp;<span class="ident" id="6651601">nil</span>&nbsp;<span class="op" id="6651605">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651610">err</span>&nbsp;<span class="op" id="6651614">=</span>&nbsp;<span class="ident" id="6651616">rows</span><span class="op" id="6651620">.</span><span class="ident" id="6651621">Close</span><span class="op" id="6651626">(</span><span class="op" id="6651627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6651631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6651635">return</span>&nbsp;<span class="ident" id="6651642">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6651647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651650">simulateBadConn</span><span class="op" id="6651665">(</span><span class="string" id="6651666">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="6651686">,</span>&nbsp;<span class="op" id="6651688">&amp;</span><span class="ident" id="6651689">hookPrepareBadConn</span><span class="op" id="6651707">,</span>&nbsp;<span class="ident" id="6651709">stmtQuery</span><span class="op" id="6651718">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651721">simulateBadConn</span><span class="op" id="6651736">(</span><span class="string" id="6651737">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="6651754">,</span>&nbsp;<span class="op" id="6651756">&amp;</span><span class="ident" id="6651757">hookQueryBadConn</span><span class="op" id="6651773">,</span>&nbsp;<span class="ident" id="6651775">stmtQuery</span><span class="op" id="6651784">)</span><br>
<span class="lineno"></span><span class="op" id="6651786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6651789">type</span>&nbsp;<span class="ident" id="6651794">concurrentTest</span>&nbsp;<span class="keyword" id="6651809">interface</span>&nbsp;<span class="op" id="6651819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651822">init</span><span class="op" id="6651826">(</span><span class="ident" id="6651827">t</span>&nbsp;<span class="ident" id="6651829">testing</span><span class="op" id="6651836">.</span><span class="ident" id="6651837">TB</span><span class="op" id="6651839">,</span>&nbsp;<span class="ident" id="6651841">db</span>&nbsp;<span class="op" id="6651844">*</span><span class="ident" id="6651845">DB</span><span class="op" id="6651847">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651850">finish</span><span class="op" id="6651856">(</span><span class="ident" id="6651857">t</span>&nbsp;<span class="ident" id="6651859">testing</span><span class="op" id="6651866">.</span><span class="ident" id="6651867">TB</span><span class="op" id="6651869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651872">test</span><span class="op" id="6651876">(</span><span class="ident" id="6651877">t</span>&nbsp;<span class="ident" id="6651879">testing</span><span class="op" id="6651886">.</span><span class="ident" id="6651887">TB</span><span class="op" id="6651889">)</span>&nbsp;<span class="builtintype" id="6651891">error</span><br>
<span class="lineno"></span><span class="op" id="6651897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6651900">type</span>&nbsp;<span class="ident" id="6651905">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="6651927">struct</span>&nbsp;<span class="op" id="6651934">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6651937">db</span>&nbsp;<span class="op" id="6651940">*</span><span class="ident" id="6651941">DB</span><br>
<span class="lineno"></span><span class="op" id="6651944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6651947">func</span>&nbsp;<span class="op" id="6651952">(</span><span class="ident" id="6651953">c</span>&nbsp;<span class="op" id="6651955">*</span><span class="ident" id="6651956">concurrentDBQueryTest</span><span class="op" id="6651977">)</span>&nbsp;<span class="ident" id="6651979">init</span><span class="op" id="6651983">(</span><span class="ident" id="6651984">t</span>&nbsp;<span class="ident" id="6651986">testing</span><span class="op" id="6651993">.</span><span class="ident" id="6651994">TB</span><span class="op" id="6651996">,</span>&nbsp;<span class="ident" id="6651998">db</span>&nbsp;<span class="op" id="6652001">*</span><span class="ident" id="6652002">DB</span><span class="op" id="6652004">)</span>&nbsp;<span class="op" id="6652006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652009">c</span><span class="op" id="6652010">.</span><span class="ident" id="6652011">db</span>&nbsp;<span class="op" id="6652014">=</span>&nbsp;<span class="ident" id="6652016">db</span><br>
<span class="lineno">1435</span><span class="op" id="6652019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6652022">func</span>&nbsp;<span class="op" id="6652027">(</span><span class="ident" id="6652028">c</span>&nbsp;<span class="op" id="6652030">*</span><span class="ident" id="6652031">concurrentDBQueryTest</span><span class="op" id="6652052">)</span>&nbsp;<span class="ident" id="6652054">finish</span><span class="op" id="6652060">(</span><span class="ident" id="6652061">t</span>&nbsp;<span class="ident" id="6652063">testing</span><span class="op" id="6652070">.</span><span class="ident" id="6652071">TB</span><span class="op" id="6652073">)</span>&nbsp;<span class="op" id="6652075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652078">c</span><span class="op" id="6652079">.</span><span class="ident" id="6652080">db</span>&nbsp;<span class="op" id="6652083">=</span>&nbsp;<span class="ident" id="6652085">nil</span><br>
<span class="lineno"></span><span class="op" id="6652089">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="6652092">func</span>&nbsp;<span class="op" id="6652097">(</span><span class="ident" id="6652098">c</span>&nbsp;<span class="op" id="6652100">*</span><span class="ident" id="6652101">concurrentDBQueryTest</span><span class="op" id="6652122">)</span>&nbsp;<span class="ident" id="6652124">test</span><span class="op" id="6652128">(</span><span class="ident" id="6652129">t</span>&nbsp;<span class="ident" id="6652131">testing</span><span class="op" id="6652138">.</span><span class="ident" id="6652139">TB</span><span class="op" id="6652141">)</span>&nbsp;<span class="builtintype" id="6652143">error</span>&nbsp;<span class="op" id="6652149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652152">rows</span><span class="op" id="6652156">,</span>&nbsp;<span class="ident" id="6652158">err</span>&nbsp;<span class="op" id="6652162">:=</span>&nbsp;<span class="ident" id="6652165">c</span><span class="op" id="6652166">.</span><span class="ident" id="6652167">db</span><span class="op" id="6652169">.</span><span class="ident" id="6652170">Query</span><span class="op" id="6652175">(</span><span class="string" id="6652176">&#34;SELECT|people|name|&#34;</span><span class="op" id="6652197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652200">if</span>&nbsp;<span class="ident" id="6652203">err</span>&nbsp;<span class="op" id="6652207">!=</span>&nbsp;<span class="ident" id="6652210">nil</span>&nbsp;<span class="op" id="6652214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652218">t</span><span class="op" id="6652219">.</span><span class="ident" id="6652220">Error</span><span class="op" id="6652225">(</span><span class="ident" id="6652226">err</span><span class="op" id="6652229">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652233">return</span>&nbsp;<span class="ident" id="6652240">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6652245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652248">var</span>&nbsp;<span class="ident" id="6652252">name</span>&nbsp;<span class="builtintype" id="6652257">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652265">for</span>&nbsp;<span class="ident" id="6652269">rows</span><span class="op" id="6652273">.</span><span class="ident" id="6652274">Next</span><span class="op" id="6652278">(</span><span class="op" id="6652279">)</span>&nbsp;<span class="op" id="6652281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652285">rows</span><span class="op" id="6652289">.</span><span class="ident" id="6652290">Scan</span><span class="op" id="6652294">(</span><span class="op" id="6652295">&amp;</span><span class="ident" id="6652296">name</span><span class="op" id="6652300">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6652303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652306">rows</span><span class="op" id="6652310">.</span><span class="ident" id="6652311">Close</span><span class="op" id="6652316">(</span><span class="op" id="6652317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652320">return</span>&nbsp;<span class="ident" id="6652327">nil</span><br>
<span class="lineno"></span><span class="op" id="6652331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="6652334">type</span>&nbsp;<span class="ident" id="6652339">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="6652360">struct</span>&nbsp;<span class="op" id="6652367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652370">db</span>&nbsp;<span class="op" id="6652373">*</span><span class="ident" id="6652374">DB</span><br>
<span class="lineno"></span><span class="op" id="6652377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6652380">func</span>&nbsp;<span class="op" id="6652385">(</span><span class="ident" id="6652386">c</span>&nbsp;<span class="op" id="6652388">*</span><span class="ident" id="6652389">concurrentDBExecTest</span><span class="op" id="6652409">)</span>&nbsp;<span class="ident" id="6652411">init</span><span class="op" id="6652415">(</span><span class="ident" id="6652416">t</span>&nbsp;<span class="ident" id="6652418">testing</span><span class="op" id="6652425">.</span><span class="ident" id="6652426">TB</span><span class="op" id="6652428">,</span>&nbsp;<span class="ident" id="6652430">db</span>&nbsp;<span class="op" id="6652433">*</span><span class="ident" id="6652434">DB</span><span class="op" id="6652436">)</span>&nbsp;<span class="op" id="6652438">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652441">c</span><span class="op" id="6652442">.</span><span class="ident" id="6652443">db</span>&nbsp;<span class="op" id="6652446">=</span>&nbsp;<span class="ident" id="6652448">db</span><br>
<span class="lineno"></span><span class="op" id="6652451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6652454">func</span>&nbsp;<span class="op" id="6652459">(</span><span class="ident" id="6652460">c</span>&nbsp;<span class="op" id="6652462">*</span><span class="ident" id="6652463">concurrentDBExecTest</span><span class="op" id="6652483">)</span>&nbsp;<span class="ident" id="6652485">finish</span><span class="op" id="6652491">(</span><span class="ident" id="6652492">t</span>&nbsp;<span class="ident" id="6652494">testing</span><span class="op" id="6652501">.</span><span class="ident" id="6652502">TB</span><span class="op" id="6652504">)</span>&nbsp;<span class="op" id="6652506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652509">c</span><span class="op" id="6652510">.</span><span class="ident" id="6652511">db</span>&nbsp;<span class="op" id="6652514">=</span>&nbsp;<span class="ident" id="6652516">nil</span><br>
<span class="lineno">1465</span><span class="op" id="6652520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6652523">func</span>&nbsp;<span class="op" id="6652528">(</span><span class="ident" id="6652529">c</span>&nbsp;<span class="op" id="6652531">*</span><span class="ident" id="6652532">concurrentDBExecTest</span><span class="op" id="6652552">)</span>&nbsp;<span class="ident" id="6652554">test</span><span class="op" id="6652558">(</span><span class="ident" id="6652559">t</span>&nbsp;<span class="ident" id="6652561">testing</span><span class="op" id="6652568">.</span><span class="ident" id="6652569">TB</span><span class="op" id="6652571">)</span>&nbsp;<span class="builtintype" id="6652573">error</span>&nbsp;<span class="op" id="6652579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652582">_</span><span class="op" id="6652583">,</span>&nbsp;<span class="ident" id="6652585">err</span>&nbsp;<span class="op" id="6652589">:=</span>&nbsp;<span class="ident" id="6652592">c</span><span class="op" id="6652593">.</span><span class="ident" id="6652594">db</span><span class="op" id="6652596">.</span><span class="ident" id="6652597">Exec</span><span class="op" id="6652601">(</span><span class="string" id="6652602">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6652655">,</span>&nbsp;<span class="num" id="6652657">3</span><span class="op" id="6652658">,</span>&nbsp;<span class="ident" id="6652660">chrisBirthday</span><span class="op" id="6652673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652676">if</span>&nbsp;<span class="ident" id="6652679">err</span>&nbsp;<span class="op" id="6652683">!=</span>&nbsp;<span class="ident" id="6652686">nil</span>&nbsp;<span class="op" id="6652690">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652694">t</span><span class="op" id="6652695">.</span><span class="ident" id="6652696">Error</span><span class="op" id="6652701">(</span><span class="ident" id="6652702">err</span><span class="op" id="6652705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652709">return</span>&nbsp;<span class="ident" id="6652716">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6652721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652724">return</span>&nbsp;<span class="ident" id="6652731">nil</span><br>
<span class="lineno"></span><span class="op" id="6652735">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="6652738">type</span>&nbsp;<span class="ident" id="6652743">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="6652767">struct</span>&nbsp;<span class="op" id="6652774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652777">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6652782">*</span><span class="ident" id="6652783">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652787">stmt</span>&nbsp;<span class="op" id="6652792">*</span><span class="ident" id="6652793">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6652798">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="6652801">func</span>&nbsp;<span class="op" id="6652806">(</span><span class="ident" id="6652807">c</span>&nbsp;<span class="op" id="6652809">*</span><span class="ident" id="6652810">concurrentStmtQueryTest</span><span class="op" id="6652833">)</span>&nbsp;<span class="ident" id="6652835">init</span><span class="op" id="6652839">(</span><span class="ident" id="6652840">t</span>&nbsp;<span class="ident" id="6652842">testing</span><span class="op" id="6652849">.</span><span class="ident" id="6652850">TB</span><span class="op" id="6652852">,</span>&nbsp;<span class="ident" id="6652854">db</span>&nbsp;<span class="op" id="6652857">*</span><span class="ident" id="6652858">DB</span><span class="op" id="6652860">)</span>&nbsp;<span class="op" id="6652862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652865">c</span><span class="op" id="6652866">.</span><span class="ident" id="6652867">db</span>&nbsp;<span class="op" id="6652870">=</span>&nbsp;<span class="ident" id="6652872">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652876">var</span>&nbsp;<span class="ident" id="6652880">err</span>&nbsp;<span class="builtintype" id="6652884">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652891">c</span><span class="op" id="6652892">.</span><span class="ident" id="6652893">stmt</span><span class="op" id="6652897">,</span>&nbsp;<span class="ident" id="6652899">err</span>&nbsp;<span class="op" id="6652903">=</span>&nbsp;<span class="ident" id="6652905">db</span><span class="op" id="6652907">.</span><span class="ident" id="6652908">Prepare</span><span class="op" id="6652915">(</span><span class="string" id="6652916">&#34;SELECT|people|name|&#34;</span><span class="op" id="6652937">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6652940">if</span>&nbsp;<span class="ident" id="6652943">err</span>&nbsp;<span class="op" id="6652947">!=</span>&nbsp;<span class="ident" id="6652950">nil</span>&nbsp;<span class="op" id="6652954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6652958">t</span><span class="op" id="6652959">.</span><span class="ident" id="6652960">Fatal</span><span class="op" id="6652965">(</span><span class="ident" id="6652966">err</span><span class="op" id="6652969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6652972">}</span><br>
<span class="lineno"></span><span class="op" id="6652974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="6652977">func</span>&nbsp;<span class="op" id="6652982">(</span><span class="ident" id="6652983">c</span>&nbsp;<span class="op" id="6652985">*</span><span class="ident" id="6652986">concurrentStmtQueryTest</span><span class="op" id="6653009">)</span>&nbsp;<span class="ident" id="6653011">finish</span><span class="op" id="6653017">(</span><span class="ident" id="6653018">t</span>&nbsp;<span class="ident" id="6653020">testing</span><span class="op" id="6653027">.</span><span class="ident" id="6653028">TB</span><span class="op" id="6653030">)</span>&nbsp;<span class="op" id="6653032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653035">if</span>&nbsp;<span class="ident" id="6653038">c</span><span class="op" id="6653039">.</span><span class="ident" id="6653040">stmt</span>&nbsp;<span class="op" id="6653045">!=</span>&nbsp;<span class="ident" id="6653048">nil</span>&nbsp;<span class="op" id="6653052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653056">c</span><span class="op" id="6653057">.</span><span class="ident" id="6653058">stmt</span><span class="op" id="6653062">.</span><span class="ident" id="6653063">Close</span><span class="op" id="6653068">(</span><span class="op" id="6653069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653073">c</span><span class="op" id="6653074">.</span><span class="ident" id="6653075">stmt</span>&nbsp;<span class="op" id="6653080">=</span>&nbsp;<span class="ident" id="6653082">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6653087">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653090">c</span><span class="op" id="6653091">.</span><span class="ident" id="6653092">db</span>&nbsp;<span class="op" id="6653095">=</span>&nbsp;<span class="ident" id="6653097">nil</span><br>
<span class="lineno"></span><span class="op" id="6653101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6653104">func</span>&nbsp;<span class="op" id="6653109">(</span><span class="ident" id="6653110">c</span>&nbsp;<span class="op" id="6653112">*</span><span class="ident" id="6653113">concurrentStmtQueryTest</span><span class="op" id="6653136">)</span>&nbsp;<span class="ident" id="6653138">test</span><span class="op" id="6653142">(</span><span class="ident" id="6653143">t</span>&nbsp;<span class="ident" id="6653145">testing</span><span class="op" id="6653152">.</span><span class="ident" id="6653153">TB</span><span class="op" id="6653155">)</span>&nbsp;<span class="builtintype" id="6653157">error</span>&nbsp;<span class="op" id="6653163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653166">rows</span><span class="op" id="6653170">,</span>&nbsp;<span class="ident" id="6653172">err</span>&nbsp;<span class="op" id="6653176">:=</span>&nbsp;<span class="ident" id="6653179">c</span><span class="op" id="6653180">.</span><span class="ident" id="6653181">stmt</span><span class="op" id="6653185">.</span><span class="ident" id="6653186">Query</span><span class="op" id="6653191">(</span><span class="op" id="6653192">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653195">if</span>&nbsp;<span class="ident" id="6653198">err</span>&nbsp;<span class="op" id="6653202">!=</span>&nbsp;<span class="ident" id="6653205">nil</span>&nbsp;<span class="op" id="6653209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653213">t</span><span class="op" id="6653214">.</span><span class="ident" id="6653215">Errorf</span><span class="op" id="6653221">(</span><span class="string" id="6653222">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6653243">,</span>&nbsp;<span class="ident" id="6653245">err</span><span class="op" id="6653248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653252">return</span>&nbsp;<span class="ident" id="6653259">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6653264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653268">var</span>&nbsp;<span class="ident" id="6653272">name</span>&nbsp;<span class="builtintype" id="6653277">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653285">for</span>&nbsp;<span class="ident" id="6653289">rows</span><span class="op" id="6653293">.</span><span class="ident" id="6653294">Next</span><span class="op" id="6653298">(</span><span class="op" id="6653299">)</span>&nbsp;<span class="op" id="6653301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653305">rows</span><span class="op" id="6653309">.</span><span class="ident" id="6653310">Scan</span><span class="op" id="6653314">(</span><span class="op" id="6653315">&amp;</span><span class="ident" id="6653316">name</span><span class="op" id="6653320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6653323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653326">rows</span><span class="op" id="6653330">.</span><span class="ident" id="6653331">Close</span><span class="op" id="6653336">(</span><span class="op" id="6653337">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653340">return</span>&nbsp;<span class="ident" id="6653347">nil</span><br>
<span class="lineno"></span><span class="op" id="6653351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6653354">type</span>&nbsp;<span class="ident" id="6653359">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="6653382">struct</span>&nbsp;<span class="op" id="6653389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653392">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6653397">*</span><span class="ident" id="6653398">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653402">stmt</span>&nbsp;<span class="op" id="6653407">*</span><span class="ident" id="6653408">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6653413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6653416">func</span>&nbsp;<span class="op" id="6653421">(</span><span class="ident" id="6653422">c</span>&nbsp;<span class="op" id="6653424">*</span><span class="ident" id="6653425">concurrentStmtExecTest</span><span class="op" id="6653447">)</span>&nbsp;<span class="ident" id="6653449">init</span><span class="op" id="6653453">(</span><span class="ident" id="6653454">t</span>&nbsp;<span class="ident" id="6653456">testing</span><span class="op" id="6653463">.</span><span class="ident" id="6653464">TB</span><span class="op" id="6653466">,</span>&nbsp;<span class="ident" id="6653468">db</span>&nbsp;<span class="op" id="6653471">*</span><span class="ident" id="6653472">DB</span><span class="op" id="6653474">)</span>&nbsp;<span class="op" id="6653476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653479">c</span><span class="op" id="6653480">.</span><span class="ident" id="6653481">db</span>&nbsp;<span class="op" id="6653484">=</span>&nbsp;<span class="ident" id="6653486">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653490">var</span>&nbsp;<span class="ident" id="6653494">err</span>&nbsp;<span class="builtintype" id="6653498">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653505">c</span><span class="op" id="6653506">.</span><span class="ident" id="6653507">stmt</span><span class="op" id="6653511">,</span>&nbsp;<span class="ident" id="6653513">err</span>&nbsp;<span class="op" id="6653517">=</span>&nbsp;<span class="ident" id="6653519">db</span><span class="op" id="6653521">.</span><span class="ident" id="6653522">Prepare</span><span class="op" id="6653529">(</span><span class="string" id="6653530">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6653583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653586">if</span>&nbsp;<span class="ident" id="6653589">err</span>&nbsp;<span class="op" id="6653593">!=</span>&nbsp;<span class="ident" id="6653596">nil</span>&nbsp;<span class="op" id="6653600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653604">t</span><span class="op" id="6653605">.</span><span class="ident" id="6653606">Fatal</span><span class="op" id="6653611">(</span><span class="ident" id="6653612">err</span><span class="op" id="6653615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6653618">}</span><br>
<span class="lineno">1525</span><span class="op" id="6653620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6653623">func</span>&nbsp;<span class="op" id="6653628">(</span><span class="ident" id="6653629">c</span>&nbsp;<span class="op" id="6653631">*</span><span class="ident" id="6653632">concurrentStmtExecTest</span><span class="op" id="6653654">)</span>&nbsp;<span class="ident" id="6653656">finish</span><span class="op" id="6653662">(</span><span class="ident" id="6653663">t</span>&nbsp;<span class="ident" id="6653665">testing</span><span class="op" id="6653672">.</span><span class="ident" id="6653673">TB</span><span class="op" id="6653675">)</span>&nbsp;<span class="op" id="6653677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653680">if</span>&nbsp;<span class="ident" id="6653683">c</span><span class="op" id="6653684">.</span><span class="ident" id="6653685">stmt</span>&nbsp;<span class="op" id="6653690">!=</span>&nbsp;<span class="ident" id="6653693">nil</span>&nbsp;<span class="op" id="6653697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653701">c</span><span class="op" id="6653702">.</span><span class="ident" id="6653703">stmt</span><span class="op" id="6653707">.</span><span class="ident" id="6653708">Close</span><span class="op" id="6653713">(</span><span class="op" id="6653714">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653718">c</span><span class="op" id="6653719">.</span><span class="ident" id="6653720">stmt</span>&nbsp;<span class="op" id="6653725">=</span>&nbsp;<span class="ident" id="6653727">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6653732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653735">c</span><span class="op" id="6653736">.</span><span class="ident" id="6653737">db</span>&nbsp;<span class="op" id="6653740">=</span>&nbsp;<span class="ident" id="6653742">nil</span><br>
<span class="lineno"></span><span class="op" id="6653746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="6653749">func</span>&nbsp;<span class="op" id="6653754">(</span><span class="ident" id="6653755">c</span>&nbsp;<span class="op" id="6653757">*</span><span class="ident" id="6653758">concurrentStmtExecTest</span><span class="op" id="6653780">)</span>&nbsp;<span class="ident" id="6653782">test</span><span class="op" id="6653786">(</span><span class="ident" id="6653787">t</span>&nbsp;<span class="ident" id="6653789">testing</span><span class="op" id="6653796">.</span><span class="ident" id="6653797">TB</span><span class="op" id="6653799">)</span>&nbsp;<span class="builtintype" id="6653801">error</span>&nbsp;<span class="op" id="6653807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653810">_</span><span class="op" id="6653811">,</span>&nbsp;<span class="ident" id="6653813">err</span>&nbsp;<span class="op" id="6653817">:=</span>&nbsp;<span class="ident" id="6653820">c</span><span class="op" id="6653821">.</span><span class="ident" id="6653822">stmt</span><span class="op" id="6653826">.</span><span class="ident" id="6653827">Exec</span><span class="op" id="6653831">(</span><span class="num" id="6653832">3</span><span class="op" id="6653833">,</span>&nbsp;<span class="ident" id="6653835">chrisBirthday</span><span class="op" id="6653848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653851">if</span>&nbsp;<span class="ident" id="6653854">err</span>&nbsp;<span class="op" id="6653858">!=</span>&nbsp;<span class="ident" id="6653861">nil</span>&nbsp;<span class="op" id="6653865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653869">t</span><span class="op" id="6653870">.</span><span class="ident" id="6653871">Errorf</span><span class="op" id="6653877">(</span><span class="string" id="6653878">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6653898">,</span>&nbsp;<span class="ident" id="6653900">err</span><span class="op" id="6653903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653907">return</span>&nbsp;<span class="ident" id="6653914">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6653919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6653922">return</span>&nbsp;<span class="ident" id="6653929">nil</span><br>
<span class="lineno"></span><span class="op" id="6653933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6653936">type</span>&nbsp;<span class="ident" id="6653941">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="6653963">struct</span>&nbsp;<span class="op" id="6653970">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653973">db</span>&nbsp;<span class="op" id="6653976">*</span><span class="ident" id="6653977">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6653981">tx</span>&nbsp;<span class="op" id="6653984">*</span><span class="ident" id="6653985">Tx</span><br>
<span class="lineno"></span><span class="op" id="6653988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6653991">func</span>&nbsp;<span class="op" id="6653996">(</span><span class="ident" id="6653997">c</span>&nbsp;<span class="op" id="6653999">*</span><span class="ident" id="6654000">concurrentTxQueryTest</span><span class="op" id="6654021">)</span>&nbsp;<span class="ident" id="6654023">init</span><span class="op" id="6654027">(</span><span class="ident" id="6654028">t</span>&nbsp;<span class="ident" id="6654030">testing</span><span class="op" id="6654037">.</span><span class="ident" id="6654038">TB</span><span class="op" id="6654040">,</span>&nbsp;<span class="ident" id="6654042">db</span>&nbsp;<span class="op" id="6654045">*</span><span class="ident" id="6654046">DB</span><span class="op" id="6654048">)</span>&nbsp;<span class="op" id="6654050">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654053">c</span><span class="op" id="6654054">.</span><span class="ident" id="6654055">db</span>&nbsp;<span class="op" id="6654058">=</span>&nbsp;<span class="ident" id="6654060">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654064">var</span>&nbsp;<span class="ident" id="6654068">err</span>&nbsp;<span class="builtintype" id="6654072">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654079">c</span><span class="op" id="6654080">.</span><span class="ident" id="6654081">tx</span><span class="op" id="6654083">,</span>&nbsp;<span class="ident" id="6654085">err</span>&nbsp;<span class="op" id="6654089">=</span>&nbsp;<span class="ident" id="6654091">c</span><span class="op" id="6654092">.</span><span class="ident" id="6654093">db</span><span class="op" id="6654095">.</span><span class="ident" id="6654096">Begin</span><span class="op" id="6654101">(</span><span class="op" id="6654102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654105">if</span>&nbsp;<span class="ident" id="6654108">err</span>&nbsp;<span class="op" id="6654112">!=</span>&nbsp;<span class="ident" id="6654115">nil</span>&nbsp;<span class="op" id="6654119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654123">t</span><span class="op" id="6654124">.</span><span class="ident" id="6654125">Fatal</span><span class="op" id="6654130">(</span><span class="ident" id="6654131">err</span><span class="op" id="6654134">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6654137">}</span><br>
<span class="lineno"></span><span class="op" id="6654139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6654142">func</span>&nbsp;<span class="op" id="6654147">(</span><span class="ident" id="6654148">c</span>&nbsp;<span class="op" id="6654150">*</span><span class="ident" id="6654151">concurrentTxQueryTest</span><span class="op" id="6654172">)</span>&nbsp;<span class="ident" id="6654174">finish</span><span class="op" id="6654180">(</span><span class="ident" id="6654181">t</span>&nbsp;<span class="ident" id="6654183">testing</span><span class="op" id="6654190">.</span><span class="ident" id="6654191">TB</span><span class="op" id="6654193">)</span>&nbsp;<span class="op" id="6654195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654198">if</span>&nbsp;<span class="ident" id="6654201">c</span><span class="op" id="6654202">.</span><span class="ident" id="6654203">tx</span>&nbsp;<span class="op" id="6654206">!=</span>&nbsp;<span class="ident" id="6654209">nil</span>&nbsp;<span class="op" id="6654213">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654217">c</span><span class="op" id="6654218">.</span><span class="ident" id="6654219">tx</span><span class="op" id="6654221">.</span><span class="ident" id="6654222">Rollback</span><span class="op" id="6654230">(</span><span class="op" id="6654231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654235">c</span><span class="op" id="6654236">.</span><span class="ident" id="6654237">tx</span>&nbsp;<span class="op" id="6654240">=</span>&nbsp;<span class="ident" id="6654242">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6654247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654250">c</span><span class="op" id="6654251">.</span><span class="ident" id="6654252">db</span>&nbsp;<span class="op" id="6654255">=</span>&nbsp;<span class="ident" id="6654257">nil</span><br>
<span class="lineno"></span><span class="op" id="6654261">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="6654264">func</span>&nbsp;<span class="op" id="6654269">(</span><span class="ident" id="6654270">c</span>&nbsp;<span class="op" id="6654272">*</span><span class="ident" id="6654273">concurrentTxQueryTest</span><span class="op" id="6654294">)</span>&nbsp;<span class="ident" id="6654296">test</span><span class="op" id="6654300">(</span><span class="ident" id="6654301">t</span>&nbsp;<span class="ident" id="6654303">testing</span><span class="op" id="6654310">.</span><span class="ident" id="6654311">TB</span><span class="op" id="6654313">)</span>&nbsp;<span class="builtintype" id="6654315">error</span>&nbsp;<span class="op" id="6654321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654324">rows</span><span class="op" id="6654328">,</span>&nbsp;<span class="ident" id="6654330">err</span>&nbsp;<span class="op" id="6654334">:=</span>&nbsp;<span class="ident" id="6654337">c</span><span class="op" id="6654338">.</span><span class="ident" id="6654339">db</span><span class="op" id="6654341">.</span><span class="ident" id="6654342">Query</span><span class="op" id="6654347">(</span><span class="string" id="6654348">&#34;SELECT|people|name|&#34;</span><span class="op" id="6654369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654372">if</span>&nbsp;<span class="ident" id="6654375">err</span>&nbsp;<span class="op" id="6654379">!=</span>&nbsp;<span class="ident" id="6654382">nil</span>&nbsp;<span class="op" id="6654386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654390">t</span><span class="op" id="6654391">.</span><span class="ident" id="6654392">Error</span><span class="op" id="6654397">(</span><span class="ident" id="6654398">err</span><span class="op" id="6654401">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654405">return</span>&nbsp;<span class="ident" id="6654412">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6654417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654420">var</span>&nbsp;<span class="ident" id="6654424">name</span>&nbsp;<span class="builtintype" id="6654429">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654437">for</span>&nbsp;<span class="ident" id="6654441">rows</span><span class="op" id="6654445">.</span><span class="ident" id="6654446">Next</span><span class="op" id="6654450">(</span><span class="op" id="6654451">)</span>&nbsp;<span class="op" id="6654453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654457">rows</span><span class="op" id="6654461">.</span><span class="ident" id="6654462">Scan</span><span class="op" id="6654466">(</span><span class="op" id="6654467">&amp;</span><span class="ident" id="6654468">name</span><span class="op" id="6654472">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6654475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654478">rows</span><span class="op" id="6654482">.</span><span class="ident" id="6654483">Close</span><span class="op" id="6654488">(</span><span class="op" id="6654489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654492">return</span>&nbsp;<span class="ident" id="6654499">nil</span><br>
<span class="lineno"></span><span class="op" id="6654503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="6654506">type</span>&nbsp;<span class="ident" id="6654511">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="6654532">struct</span>&nbsp;<span class="op" id="6654539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654542">db</span>&nbsp;<span class="op" id="6654545">*</span><span class="ident" id="6654546">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654550">tx</span>&nbsp;<span class="op" id="6654553">*</span><span class="ident" id="6654554">Tx</span><br>
<span class="lineno"></span><span class="op" id="6654557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="6654560">func</span>&nbsp;<span class="op" id="6654565">(</span><span class="ident" id="6654566">c</span>&nbsp;<span class="op" id="6654568">*</span><span class="ident" id="6654569">concurrentTxExecTest</span><span class="op" id="6654589">)</span>&nbsp;<span class="ident" id="6654591">init</span><span class="op" id="6654595">(</span><span class="ident" id="6654596">t</span>&nbsp;<span class="ident" id="6654598">testing</span><span class="op" id="6654605">.</span><span class="ident" id="6654606">TB</span><span class="op" id="6654608">,</span>&nbsp;<span class="ident" id="6654610">db</span>&nbsp;<span class="op" id="6654613">*</span><span class="ident" id="6654614">DB</span><span class="op" id="6654616">)</span>&nbsp;<span class="op" id="6654618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654621">c</span><span class="op" id="6654622">.</span><span class="ident" id="6654623">db</span>&nbsp;<span class="op" id="6654626">=</span>&nbsp;<span class="ident" id="6654628">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654632">var</span>&nbsp;<span class="ident" id="6654636">err</span>&nbsp;<span class="builtintype" id="6654640">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654647">c</span><span class="op" id="6654648">.</span><span class="ident" id="6654649">tx</span><span class="op" id="6654651">,</span>&nbsp;<span class="ident" id="6654653">err</span>&nbsp;<span class="op" id="6654657">=</span>&nbsp;<span class="ident" id="6654659">c</span><span class="op" id="6654660">.</span><span class="ident" id="6654661">db</span><span class="op" id="6654663">.</span><span class="ident" id="6654664">Begin</span><span class="op" id="6654669">(</span><span class="op" id="6654670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654673">if</span>&nbsp;<span class="ident" id="6654676">err</span>&nbsp;<span class="op" id="6654680">!=</span>&nbsp;<span class="ident" id="6654683">nil</span>&nbsp;<span class="op" id="6654687">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654691">t</span><span class="op" id="6654692">.</span><span class="ident" id="6654693">Fatal</span><span class="op" id="6654698">(</span><span class="ident" id="6654699">err</span><span class="op" id="6654702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6654705">}</span><br>
<span class="lineno"></span><span class="op" id="6654707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6654710">func</span>&nbsp;<span class="op" id="6654715">(</span><span class="ident" id="6654716">c</span>&nbsp;<span class="op" id="6654718">*</span><span class="ident" id="6654719">concurrentTxExecTest</span><span class="op" id="6654739">)</span>&nbsp;<span class="ident" id="6654741">finish</span><span class="op" id="6654747">(</span><span class="ident" id="6654748">t</span>&nbsp;<span class="ident" id="6654750">testing</span><span class="op" id="6654757">.</span><span class="ident" id="6654758">TB</span><span class="op" id="6654760">)</span>&nbsp;<span class="op" id="6654762">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654765">if</span>&nbsp;<span class="ident" id="6654768">c</span><span class="op" id="6654769">.</span><span class="ident" id="6654770">tx</span>&nbsp;<span class="op" id="6654773">!=</span>&nbsp;<span class="ident" id="6654776">nil</span>&nbsp;<span class="op" id="6654780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654784">c</span><span class="op" id="6654785">.</span><span class="ident" id="6654786">tx</span><span class="op" id="6654788">.</span><span class="ident" id="6654789">Rollback</span><span class="op" id="6654797">(</span><span class="op" id="6654798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654802">c</span><span class="op" id="6654803">.</span><span class="ident" id="6654804">tx</span>&nbsp;<span class="op" id="6654807">=</span>&nbsp;<span class="ident" id="6654809">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6654814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654817">c</span><span class="op" id="6654818">.</span><span class="ident" id="6654819">db</span>&nbsp;<span class="op" id="6654822">=</span>&nbsp;<span class="ident" id="6654824">nil</span><br>
<span class="lineno">1600</span><span class="op" id="6654828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6654831">func</span>&nbsp;<span class="op" id="6654836">(</span><span class="ident" id="6654837">c</span>&nbsp;<span class="op" id="6654839">*</span><span class="ident" id="6654840">concurrentTxExecTest</span><span class="op" id="6654860">)</span>&nbsp;<span class="ident" id="6654862">test</span><span class="op" id="6654866">(</span><span class="ident" id="6654867">t</span>&nbsp;<span class="ident" id="6654869">testing</span><span class="op" id="6654876">.</span><span class="ident" id="6654877">TB</span><span class="op" id="6654879">)</span>&nbsp;<span class="builtintype" id="6654881">error</span>&nbsp;<span class="op" id="6654887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6654890">_</span><span class="op" id="6654891">,</span>&nbsp;<span class="ident" id="6654893">err</span>&nbsp;<span class="op" id="6654897">:=</span>&nbsp;<span class="ident" id="6654900">c</span><span class="op" id="6654901">.</span><span class="ident" id="6654902">tx</span><span class="op" id="6654904">.</span><span class="ident" id="6654905">Exec</span><span class="op" id="6654909">(</span><span class="string" id="6654910">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6654963">,</span>&nbsp;<span class="num" id="6654965">3</span><span class="op" id="6654966">,</span>&nbsp;<span class="ident" id="6654968">chrisBirthday</span><span class="op" id="6654981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6654984">if</span>&nbsp;<span class="ident" id="6654987">err</span>&nbsp;<span class="op" id="6654991">!=</span>&nbsp;<span class="ident" id="6654994">nil</span>&nbsp;<span class="op" id="6654998">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655002">t</span><span class="op" id="6655003">.</span><span class="ident" id="6655004">Error</span><span class="op" id="6655009">(</span><span class="ident" id="6655010">err</span><span class="op" id="6655013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655017">return</span>&nbsp;<span class="ident" id="6655024">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6655029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655032">return</span>&nbsp;<span class="ident" id="6655039">nil</span><br>
<span class="lineno"></span><span class="op" id="6655043">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="6655046">type</span>&nbsp;<span class="ident" id="6655051">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="6655077">struct</span>&nbsp;<span class="op" id="6655084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655087">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6655092">*</span><span class="ident" id="6655093">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655097">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6655102">*</span><span class="ident" id="6655103">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655107">stmt</span>&nbsp;<span class="op" id="6655112">*</span><span class="ident" id="6655113">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="6655118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6655121">func</span>&nbsp;<span class="op" id="6655126">(</span><span class="ident" id="6655127">c</span>&nbsp;<span class="op" id="6655129">*</span><span class="ident" id="6655130">concurrentTxStmtQueryTest</span><span class="op" id="6655155">)</span>&nbsp;<span class="ident" id="6655157">init</span><span class="op" id="6655161">(</span><span class="ident" id="6655162">t</span>&nbsp;<span class="ident" id="6655164">testing</span><span class="op" id="6655171">.</span><span class="ident" id="6655172">TB</span><span class="op" id="6655174">,</span>&nbsp;<span class="ident" id="6655176">db</span>&nbsp;<span class="op" id="6655179">*</span><span class="ident" id="6655180">DB</span><span class="op" id="6655182">)</span>&nbsp;<span class="op" id="6655184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655187">c</span><span class="op" id="6655188">.</span><span class="ident" id="6655189">db</span>&nbsp;<span class="op" id="6655192">=</span>&nbsp;<span class="ident" id="6655194">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655198">var</span>&nbsp;<span class="ident" id="6655202">err</span>&nbsp;<span class="builtintype" id="6655206">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655213">c</span><span class="op" id="6655214">.</span><span class="ident" id="6655215">tx</span><span class="op" id="6655217">,</span>&nbsp;<span class="ident" id="6655219">err</span>&nbsp;<span class="op" id="6655223">=</span>&nbsp;<span class="ident" id="6655225">c</span><span class="op" id="6655226">.</span><span class="ident" id="6655227">db</span><span class="op" id="6655229">.</span><span class="ident" id="6655230">Begin</span><span class="op" id="6655235">(</span><span class="op" id="6655236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655239">if</span>&nbsp;<span class="ident" id="6655242">err</span>&nbsp;<span class="op" id="6655246">!=</span>&nbsp;<span class="ident" id="6655249">nil</span>&nbsp;<span class="op" id="6655253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655257">t</span><span class="op" id="6655258">.</span><span class="ident" id="6655259">Fatal</span><span class="op" id="6655264">(</span><span class="ident" id="6655265">err</span><span class="op" id="6655268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6655271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655274">c</span><span class="op" id="6655275">.</span><span class="ident" id="6655276">stmt</span><span class="op" id="6655280">,</span>&nbsp;<span class="ident" id="6655282">err</span>&nbsp;<span class="op" id="6655286">=</span>&nbsp;<span class="ident" id="6655288">c</span><span class="op" id="6655289">.</span><span class="ident" id="6655290">tx</span><span class="op" id="6655292">.</span><span class="ident" id="6655293">Prepare</span><span class="op" id="6655300">(</span><span class="string" id="6655301">&#34;SELECT|people|name|&#34;</span><span class="op" id="6655322">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655325">if</span>&nbsp;<span class="ident" id="6655328">err</span>&nbsp;<span class="op" id="6655332">!=</span>&nbsp;<span class="ident" id="6655335">nil</span>&nbsp;<span class="op" id="6655339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655343">t</span><span class="op" id="6655344">.</span><span class="ident" id="6655345">Fatal</span><span class="op" id="6655350">(</span><span class="ident" id="6655351">err</span><span class="op" id="6655354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6655357">}</span><br>
<span class="lineno"></span><span class="op" id="6655359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="6655362">func</span>&nbsp;<span class="op" id="6655367">(</span><span class="ident" id="6655368">c</span>&nbsp;<span class="op" id="6655370">*</span><span class="ident" id="6655371">concurrentTxStmtQueryTest</span><span class="op" id="6655396">)</span>&nbsp;<span class="ident" id="6655398">finish</span><span class="op" id="6655404">(</span><span class="ident" id="6655405">t</span>&nbsp;<span class="ident" id="6655407">testing</span><span class="op" id="6655414">.</span><span class="ident" id="6655415">TB</span><span class="op" id="6655417">)</span>&nbsp;<span class="op" id="6655419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655422">if</span>&nbsp;<span class="ident" id="6655425">c</span><span class="op" id="6655426">.</span><span class="ident" id="6655427">stmt</span>&nbsp;<span class="op" id="6655432">!=</span>&nbsp;<span class="ident" id="6655435">nil</span>&nbsp;<span class="op" id="6655439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655443">c</span><span class="op" id="6655444">.</span><span class="ident" id="6655445">stmt</span><span class="op" id="6655449">.</span><span class="ident" id="6655450">Close</span><span class="op" id="6655455">(</span><span class="op" id="6655456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655460">c</span><span class="op" id="6655461">.</span><span class="ident" id="6655462">stmt</span>&nbsp;<span class="op" id="6655467">=</span>&nbsp;<span class="ident" id="6655469">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6655474">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655477">if</span>&nbsp;<span class="ident" id="6655480">c</span><span class="op" id="6655481">.</span><span class="ident" id="6655482">tx</span>&nbsp;<span class="op" id="6655485">!=</span>&nbsp;<span class="ident" id="6655488">nil</span>&nbsp;<span class="op" id="6655492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655496">c</span><span class="op" id="6655497">.</span><span class="ident" id="6655498">tx</span><span class="op" id="6655500">.</span><span class="ident" id="6655501">Rollback</span><span class="op" id="6655509">(</span><span class="op" id="6655510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655514">c</span><span class="op" id="6655515">.</span><span class="ident" id="6655516">tx</span>&nbsp;<span class="op" id="6655519">=</span>&nbsp;<span class="ident" id="6655521">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6655526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655529">c</span><span class="op" id="6655530">.</span><span class="ident" id="6655531">db</span>&nbsp;<span class="op" id="6655534">=</span>&nbsp;<span class="ident" id="6655536">nil</span><br>
<span class="lineno">1640</span><span class="op" id="6655540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6655543">func</span>&nbsp;<span class="op" id="6655548">(</span><span class="ident" id="6655549">c</span>&nbsp;<span class="op" id="6655551">*</span><span class="ident" id="6655552">concurrentTxStmtQueryTest</span><span class="op" id="6655577">)</span>&nbsp;<span class="ident" id="6655579">test</span><span class="op" id="6655583">(</span><span class="ident" id="6655584">t</span>&nbsp;<span class="ident" id="6655586">testing</span><span class="op" id="6655593">.</span><span class="ident" id="6655594">TB</span><span class="op" id="6655596">)</span>&nbsp;<span class="builtintype" id="6655598">error</span>&nbsp;<span class="op" id="6655604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655607">rows</span><span class="op" id="6655611">,</span>&nbsp;<span class="ident" id="6655613">err</span>&nbsp;<span class="op" id="6655617">:=</span>&nbsp;<span class="ident" id="6655620">c</span><span class="op" id="6655621">.</span><span class="ident" id="6655622">stmt</span><span class="op" id="6655626">.</span><span class="ident" id="6655627">Query</span><span class="op" id="6655632">(</span><span class="op" id="6655633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655636">if</span>&nbsp;<span class="ident" id="6655639">err</span>&nbsp;<span class="op" id="6655643">!=</span>&nbsp;<span class="ident" id="6655646">nil</span>&nbsp;<span class="op" id="6655650">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655654">t</span><span class="op" id="6655655">.</span><span class="ident" id="6655656">Errorf</span><span class="op" id="6655662">(</span><span class="string" id="6655663">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6655684">,</span>&nbsp;<span class="ident" id="6655686">err</span><span class="op" id="6655689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655693">return</span>&nbsp;<span class="ident" id="6655700">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6655705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655709">var</span>&nbsp;<span class="ident" id="6655713">name</span>&nbsp;<span class="builtintype" id="6655718">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655726">for</span>&nbsp;<span class="ident" id="6655730">rows</span><span class="op" id="6655734">.</span><span class="ident" id="6655735">Next</span><span class="op" id="6655739">(</span><span class="op" id="6655740">)</span>&nbsp;<span class="op" id="6655742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655746">rows</span><span class="op" id="6655750">.</span><span class="ident" id="6655751">Scan</span><span class="op" id="6655755">(</span><span class="op" id="6655756">&amp;</span><span class="ident" id="6655757">name</span><span class="op" id="6655761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6655764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655767">rows</span><span class="op" id="6655771">.</span><span class="ident" id="6655772">Close</span><span class="op" id="6655777">(</span><span class="op" id="6655778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655781">return</span>&nbsp;<span class="ident" id="6655788">nil</span><br>
<span class="lineno">1655</span><span class="op" id="6655792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6655795">type</span>&nbsp;<span class="ident" id="6655800">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="6655825">struct</span>&nbsp;<span class="op" id="6655832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655835">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6655840">*</span><span class="ident" id="6655841">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655845">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6655850">*</span><span class="ident" id="6655851">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655855">stmt</span>&nbsp;<span class="op" id="6655860">*</span><span class="ident" id="6655861">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6655866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6655869">func</span>&nbsp;<span class="op" id="6655874">(</span><span class="ident" id="6655875">c</span>&nbsp;<span class="op" id="6655877">*</span><span class="ident" id="6655878">concurrentTxStmtExecTest</span><span class="op" id="6655902">)</span>&nbsp;<span class="ident" id="6655904">init</span><span class="op" id="6655908">(</span><span class="ident" id="6655909">t</span>&nbsp;<span class="ident" id="6655911">testing</span><span class="op" id="6655918">.</span><span class="ident" id="6655919">TB</span><span class="op" id="6655921">,</span>&nbsp;<span class="ident" id="6655923">db</span>&nbsp;<span class="op" id="6655926">*</span><span class="ident" id="6655927">DB</span><span class="op" id="6655929">)</span>&nbsp;<span class="op" id="6655931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655934">c</span><span class="op" id="6655935">.</span><span class="ident" id="6655936">db</span>&nbsp;<span class="op" id="6655939">=</span>&nbsp;<span class="ident" id="6655941">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655945">var</span>&nbsp;<span class="ident" id="6655949">err</span>&nbsp;<span class="builtintype" id="6655953">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6655960">c</span><span class="op" id="6655961">.</span><span class="ident" id="6655962">tx</span><span class="op" id="6655964">,</span>&nbsp;<span class="ident" id="6655966">err</span>&nbsp;<span class="op" id="6655970">=</span>&nbsp;<span class="ident" id="6655972">c</span><span class="op" id="6655973">.</span><span class="ident" id="6655974">db</span><span class="op" id="6655976">.</span><span class="ident" id="6655977">Begin</span><span class="op" id="6655982">(</span><span class="op" id="6655983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6655986">if</span>&nbsp;<span class="ident" id="6655989">err</span>&nbsp;<span class="op" id="6655993">!=</span>&nbsp;<span class="ident" id="6655996">nil</span>&nbsp;<span class="op" id="6656000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656004">t</span><span class="op" id="6656005">.</span><span class="ident" id="6656006">Fatal</span><span class="op" id="6656011">(</span><span class="ident" id="6656012">err</span><span class="op" id="6656015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6656018">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656021">c</span><span class="op" id="6656022">.</span><span class="ident" id="6656023">stmt</span><span class="op" id="6656027">,</span>&nbsp;<span class="ident" id="6656029">err</span>&nbsp;<span class="op" id="6656033">=</span>&nbsp;<span class="ident" id="6656035">c</span><span class="op" id="6656036">.</span><span class="ident" id="6656037">tx</span><span class="op" id="6656039">.</span><span class="ident" id="6656040">Prepare</span><span class="op" id="6656047">(</span><span class="string" id="6656048">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6656101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6656104">if</span>&nbsp;<span class="ident" id="6656107">err</span>&nbsp;<span class="op" id="6656111">!=</span>&nbsp;<span class="ident" id="6656114">nil</span>&nbsp;<span class="op" id="6656118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656122">t</span><span class="op" id="6656123">.</span><span class="ident" id="6656124">Fatal</span><span class="op" id="6656129">(</span><span class="ident" id="6656130">err</span><span class="op" id="6656133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6656136">}</span><br>
<span class="lineno"></span><span class="op" id="6656138">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="6656141">func</span>&nbsp;<span class="op" id="6656146">(</span><span class="ident" id="6656147">c</span>&nbsp;<span class="op" id="6656149">*</span><span class="ident" id="6656150">concurrentTxStmtExecTest</span><span class="op" id="6656174">)</span>&nbsp;<span class="ident" id="6656176">finish</span><span class="op" id="6656182">(</span><span class="ident" id="6656183">t</span>&nbsp;<span class="ident" id="6656185">testing</span><span class="op" id="6656192">.</span><span class="ident" id="6656193">TB</span><span class="op" id="6656195">)</span>&nbsp;<span class="op" id="6656197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6656200">if</span>&nbsp;<span class="ident" id="6656203">c</span><span class="op" id="6656204">.</span><span class="ident" id="6656205">stmt</span>&nbsp;<span class="op" id="6656210">!=</span>&nbsp;<span class="ident" id="6656213">nil</span>&nbsp;<span class="op" id="6656217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656221">c</span><span class="op" id="6656222">.</span><span class="ident" id="6656223">stmt</span><span class="op" id="6656227">.</span><span class="ident" id="6656228">Close</span><span class="op" id="6656233">(</span><span class="op" id="6656234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656238">c</span><span class="op" id="6656239">.</span><span class="ident" id="6656240">stmt</span>&nbsp;<span class="op" id="6656245">=</span>&nbsp;<span class="ident" id="6656247">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6656252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6656255">if</span>&nbsp;<span class="ident" id="6656258">c</span><span class="op" id="6656259">.</span><span class="ident" id="6656260">tx</span>&nbsp;<span class="op" id="6656263">!=</span>&nbsp;<span class="ident" id="6656266">nil</span>&nbsp;<span class="op" id="6656270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656274">c</span><span class="op" id="6656275">.</span><span class="ident" id="6656276">tx</span><span class="op" id="6656278">.</span><span class="ident" id="6656279">Rollback</span><span class="op" id="6656287">(</span><span class="op" id="6656288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656292">c</span><span class="op" id="6656293">.</span><span class="ident" id="6656294">tx</span>&nbsp;<span class="op" id="6656297">=</span>&nbsp;<span class="ident" id="6656299">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6656304">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656307">c</span><span class="op" id="6656308">.</span><span class="ident" id="6656309">db</span>&nbsp;<span class="op" id="6656312">=</span>&nbsp;<span class="ident" id="6656314">nil</span><br>
<span class="lineno"></span><span class="op" id="6656318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6656321">func</span>&nbsp;<span class="op" id="6656326">(</span><span class="ident" id="6656327">c</span>&nbsp;<span class="op" id="6656329">*</span><span class="ident" id="6656330">concurrentTxStmtExecTest</span><span class="op" id="6656354">)</span>&nbsp;<span class="ident" id="6656356">test</span><span class="op" id="6656360">(</span><span class="ident" id="6656361">t</span>&nbsp;<span class="ident" id="6656363">testing</span><span class="op" id="6656370">.</span><span class="ident" id="6656371">TB</span><span class="op" id="6656373">)</span>&nbsp;<span class="builtintype" id="6656375">error</span>&nbsp;<span class="op" id="6656381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656384">_</span><span class="op" id="6656385">,</span>&nbsp;<span class="ident" id="6656387">err</span>&nbsp;<span class="op" id="6656391">:=</span>&nbsp;<span class="ident" id="6656394">c</span><span class="op" id="6656395">.</span><span class="ident" id="6656396">stmt</span><span class="op" id="6656400">.</span><span class="ident" id="6656401">Exec</span><span class="op" id="6656405">(</span><span class="num" id="6656406">3</span><span class="op" id="6656407">,</span>&nbsp;<span class="ident" id="6656409">chrisBirthday</span><span class="op" id="6656422">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6656425">if</span>&nbsp;<span class="ident" id="6656428">err</span>&nbsp;<span class="op" id="6656432">!=</span>&nbsp;<span class="ident" id="6656435">nil</span>&nbsp;<span class="op" id="6656439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656443">t</span><span class="op" id="6656444">.</span><span class="ident" id="6656445">Errorf</span><span class="op" id="6656451">(</span><span class="string" id="6656452">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6656472">,</span>&nbsp;<span class="ident" id="6656474">err</span><span class="op" id="6656477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6656481">return</span>&nbsp;<span class="ident" id="6656488">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6656493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6656496">return</span>&nbsp;<span class="ident" id="6656503">nil</span><br>
<span class="lineno">1695</span><span class="op" id="6656507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6656510">type</span>&nbsp;<span class="ident" id="6656515">concurrentRandomTest</span>&nbsp;<span class="keyword" id="6656536">struct</span>&nbsp;<span class="op" id="6656543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656546">tests</span>&nbsp;<span class="op" id="6656552">[</span><span class="op" id="6656553">]</span><span class="ident" id="6656554">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="6656569">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="6656572">func</span>&nbsp;<span class="op" id="6656577">(</span><span class="ident" id="6656578">c</span>&nbsp;<span class="op" id="6656580">*</span><span class="ident" id="6656581">concurrentRandomTest</span><span class="op" id="6656601">)</span>&nbsp;<span class="ident" id="6656603">init</span><span class="op" id="6656607">(</span><span class="ident" id="6656608">t</span>&nbsp;<span class="ident" id="6656610">testing</span><span class="op" id="6656617">.</span><span class="ident" id="6656618">TB</span><span class="op" id="6656620">,</span>&nbsp;<span class="ident" id="6656622">db</span>&nbsp;<span class="op" id="6656625">*</span><span class="ident" id="6656626">DB</span><span class="op" id="6656628">)</span>&nbsp;<span class="op" id="6656630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656633">c</span><span class="op" id="6656634">.</span><span class="ident" id="6656635">tests</span>&nbsp;<span class="op" id="6656641">=</span>&nbsp;<span class="op" id="6656643">[</span><span class="op" id="6656644">]</span><span class="ident" id="6656645">concurrentTest</span><span class="op" id="6656659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6656663">new</span><span class="op" id="6656666">(</span><span class="ident" id="6656667">concurrentDBQueryTest</span><span class="op" id="6656688">)</span><span class="op" id="6656689">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6656693">new</span><span class="op" id="6656696">(</span><span class="ident" id="6656697">concurrentDBExecTest</span><span class="op" id="6656717">)</span><span class="op" id="6656718">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6656722">new</span><span class="op" id="6656725">(</span><span class="ident" id="6656726">concurrentStmtQueryTest</span><span class="op" id="6656749">)</span><span class="op" id="6656750">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6656754">new</span><span class="op" id="6656757">(</span><span class="ident" id="6656758">concurrentStmtExecTest</span><span class="op" id="6656780">)</span><span class="op" id="6656781">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6656785">new</span><span class="op" id="6656788">(</span><span class="ident" id="6656789">concurrentTxQueryTest</span><span class="op" id="6656810">)</span><span class="op" id="6656811">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6656815">new</span><span class="op" id="6656818">(</span><span class="ident" id="6656819">concurrentTxExecTest</span><span class="op" id="6656839">)</span><span class="op" id="6656840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6656844">new</span><span class="op" id="6656847">(</span><span class="ident" id="6656848">concurrentTxStmtQueryTest</span><span class="op" id="6656873">)</span><span class="op" id="6656874">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6656878">new</span><span class="op" id="6656881">(</span><span class="ident" id="6656882">concurrentTxStmtExecTest</span><span class="op" id="6656906">)</span><span class="op" id="6656907">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6656910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6656913">for</span>&nbsp;<span class="ident" id="6656917">_</span><span class="op" id="6656918">,</span>&nbsp;<span class="ident" id="6656920">ct</span>&nbsp;<span class="op" id="6656923">:=</span>&nbsp;<span class="keyword" id="6656926">range</span>&nbsp;<span class="ident" id="6656932">c</span><span class="op" id="6656933">.</span><span class="ident" id="6656934">tests</span>&nbsp;<span class="op" id="6656940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6656944">ct</span><span class="op" id="6656946">.</span><span class="ident" id="6656947">init</span><span class="op" id="6656951">(</span><span class="ident" id="6656952">t</span><span class="op" id="6656953">,</span>&nbsp;<span class="ident" id="6656955">db</span><span class="op" id="6656957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6656960">}</span><br>
<span class="lineno">1715</span><span class="op" id="6656962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6656965">func</span>&nbsp;<span class="op" id="6656970">(</span><span class="ident" id="6656971">c</span>&nbsp;<span class="op" id="6656973">*</span><span class="ident" id="6656974">concurrentRandomTest</span><span class="op" id="6656994">)</span>&nbsp;<span class="ident" id="6656996">finish</span><span class="op" id="6657002">(</span><span class="ident" id="6657003">t</span>&nbsp;<span class="ident" id="6657005">testing</span><span class="op" id="6657012">.</span><span class="ident" id="6657013">TB</span><span class="op" id="6657015">)</span>&nbsp;<span class="op" id="6657017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657020">for</span>&nbsp;<span class="ident" id="6657024">_</span><span class="op" id="6657025">,</span>&nbsp;<span class="ident" id="6657027">ct</span>&nbsp;<span class="op" id="6657030">:=</span>&nbsp;<span class="keyword" id="6657033">range</span>&nbsp;<span class="ident" id="6657039">c</span><span class="op" id="6657040">.</span><span class="ident" id="6657041">tests</span>&nbsp;<span class="op" id="6657047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657051">ct</span><span class="op" id="6657053">.</span><span class="ident" id="6657054">finish</span><span class="op" id="6657060">(</span><span class="ident" id="6657061">t</span><span class="op" id="6657062">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6657065">}</span><br>
<span class="lineno"></span><span class="op" id="6657067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6657070">func</span>&nbsp;<span class="op" id="6657075">(</span><span class="ident" id="6657076">c</span>&nbsp;<span class="op" id="6657078">*</span><span class="ident" id="6657079">concurrentRandomTest</span><span class="op" id="6657099">)</span>&nbsp;<span class="ident" id="6657101">test</span><span class="op" id="6657105">(</span><span class="ident" id="6657106">t</span>&nbsp;<span class="ident" id="6657108">testing</span><span class="op" id="6657115">.</span><span class="ident" id="6657116">TB</span><span class="op" id="6657118">)</span>&nbsp;<span class="builtintype" id="6657120">error</span>&nbsp;<span class="op" id="6657126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657129">ct</span>&nbsp;<span class="op" id="6657132">:=</span>&nbsp;<span class="ident" id="6657135">c</span><span class="op" id="6657136">.</span><span class="ident" id="6657137">tests</span><span class="op" id="6657142">[</span><span class="ident" id="6657143">rand</span><span class="op" id="6657147">.</span><span class="ident" id="6657148">Intn</span><span class="op" id="6657152">(</span><span class="builtinfunc" id="6657153">len</span><span class="op" id="6657156">(</span><span class="ident" id="6657157">c</span><span class="op" id="6657158">.</span><span class="ident" id="6657159">tests</span><span class="op" id="6657164">)</span><span class="op" id="6657165">)</span><span class="op" id="6657166">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657169">return</span>&nbsp;<span class="ident" id="6657176">ct</span><span class="op" id="6657178">.</span><span class="ident" id="6657179">test</span><span class="op" id="6657183">(</span><span class="ident" id="6657184">t</span><span class="op" id="6657185">)</span><br>
<span class="lineno"></span><span class="op" id="6657187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6657190">func</span>&nbsp;<span class="ident" id="6657195">doConcurrentTest</span><span class="op" id="6657211">(</span><span class="ident" id="6657212">t</span>&nbsp;<span class="ident" id="6657214">testing</span><span class="op" id="6657221">.</span><span class="ident" id="6657222">TB</span><span class="op" id="6657224">,</span>&nbsp;<span class="ident" id="6657226">ct</span>&nbsp;<span class="ident" id="6657229">concurrentTest</span><span class="op" id="6657243">)</span>&nbsp;<span class="op" id="6657245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657248">maxProcs</span><span class="op" id="6657256">,</span>&nbsp;<span class="ident" id="6657258">numReqs</span>&nbsp;<span class="op" id="6657266">:=</span>&nbsp;<span class="num" id="6657269">1</span><span class="op" id="6657270">,</span>&nbsp;<span class="num" id="6657272">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657277">if</span>&nbsp;<span class="ident" id="6657280">testing</span><span class="op" id="6657287">.</span><span class="ident" id="6657288">Short</span><span class="op" id="6657293">(</span><span class="op" id="6657294">)</span>&nbsp;<span class="op" id="6657296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657300">maxProcs</span><span class="op" id="6657308">,</span>&nbsp;<span class="ident" id="6657310">numReqs</span>&nbsp;<span class="op" id="6657318">=</span>&nbsp;<span class="num" id="6657320">4</span><span class="op" id="6657321">,</span>&nbsp;<span class="num" id="6657323">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6657327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657330">defer</span>&nbsp;<span class="ident" id="6657336">runtime</span><span class="op" id="6657343">.</span><span class="ident" id="6657344">GOMAXPROCS</span><span class="op" id="6657354">(</span><span class="ident" id="6657355">runtime</span><span class="op" id="6657362">.</span><span class="ident" id="6657363">GOMAXPROCS</span><span class="op" id="6657373">(</span><span class="ident" id="6657374">maxProcs</span><span class="op" id="6657382">)</span><span class="op" id="6657383">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657387">db</span>&nbsp;<span class="op" id="6657390">:=</span>&nbsp;<span class="ident" id="6657393">newTestDB</span><span class="op" id="6657402">(</span><span class="ident" id="6657403">t</span><span class="op" id="6657404">,</span>&nbsp;<span class="string" id="6657406">&#34;people&#34;</span><span class="op" id="6657414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657417">defer</span>&nbsp;<span class="ident" id="6657423">closeDB</span><span class="op" id="6657430">(</span><span class="ident" id="6657431">t</span><span class="op" id="6657432">,</span>&nbsp;<span class="ident" id="6657434">db</span><span class="op" id="6657436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657440">ct</span><span class="op" id="6657442">.</span><span class="ident" id="6657443">init</span><span class="op" id="6657447">(</span><span class="ident" id="6657448">t</span><span class="op" id="6657449">,</span>&nbsp;<span class="ident" id="6657451">db</span><span class="op" id="6657453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657456">defer</span>&nbsp;<span class="ident" id="6657462">ct</span><span class="op" id="6657464">.</span><span class="ident" id="6657465">finish</span><span class="op" id="6657471">(</span><span class="ident" id="6657472">t</span><span class="op" id="6657473">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657477">var</span>&nbsp;<span class="ident" id="6657481">wg</span>&nbsp;<span class="ident" id="6657484">sync</span><span class="op" id="6657488">.</span><span class="ident" id="6657489">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657500">wg</span><span class="op" id="6657502">.</span><span class="ident" id="6657503">Add</span><span class="op" id="6657506">(</span><span class="ident" id="6657507">numReqs</span><span class="op" id="6657514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657518">reqs</span>&nbsp;<span class="op" id="6657523">:=</span>&nbsp;<span class="builtinfunc" id="6657526">make</span><span class="op" id="6657530">(</span><span class="keyword" id="6657531">chan</span>&nbsp;<span class="builtintype" id="6657536">bool</span><span class="op" id="6657540">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657543">defer</span>&nbsp;<span class="builtinfunc" id="6657549">close</span><span class="op" id="6657554">(</span><span class="ident" id="6657555">reqs</span><span class="op" id="6657559">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657563">for</span>&nbsp;<span class="ident" id="6657567">i</span>&nbsp;<span class="op" id="6657569">:=</span>&nbsp;<span class="num" id="6657572">0</span><span class="op" id="6657573">;</span>&nbsp;<span class="ident" id="6657575">i</span>&nbsp;<span class="op" id="6657577">&lt;</span>&nbsp;<span class="ident" id="6657579">maxProcs</span><span class="op" id="6657587">*</span><span class="num" id="6657588">2</span><span class="op" id="6657589">;</span>&nbsp;<span class="ident" id="6657591">i</span><span class="op" id="6657592">++</span>&nbsp;<span class="op" id="6657595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657599">go</span>&nbsp;<span class="keyword" id="6657602">func</span><span class="op" id="6657606">(</span><span class="op" id="6657607">)</span>&nbsp;<span class="op" id="6657609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657614">for</span>&nbsp;<span class="keyword" id="6657618">range</span>&nbsp;<span class="ident" id="6657624">reqs</span>&nbsp;<span class="op" id="6657629">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657635">err</span>&nbsp;<span class="op" id="6657639">:=</span>&nbsp;<span class="ident" id="6657642">ct</span><span class="op" id="6657644">.</span><span class="ident" id="6657645">test</span><span class="op" id="6657649">(</span><span class="ident" id="6657650">t</span><span class="op" id="6657651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657657">if</span>&nbsp;<span class="ident" id="6657660">err</span>&nbsp;<span class="op" id="6657664">!=</span>&nbsp;<span class="ident" id="6657667">nil</span>&nbsp;<span class="op" id="6657671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657678">wg</span><span class="op" id="6657680">.</span><span class="ident" id="6657681">Done</span><span class="op" id="6657685">(</span><span class="op" id="6657686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657693">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6657706">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657712">wg</span><span class="op" id="6657714">.</span><span class="ident" id="6657715">Done</span><span class="op" id="6657719">(</span><span class="op" id="6657720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6657725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6657729">}</span><span class="op" id="6657730">(</span><span class="op" id="6657731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6657734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657738">for</span>&nbsp;<span class="ident" id="6657742">i</span>&nbsp;<span class="op" id="6657744">:=</span>&nbsp;<span class="num" id="6657747">0</span><span class="op" id="6657748">;</span>&nbsp;<span class="ident" id="6657750">i</span>&nbsp;<span class="op" id="6657752">&lt;</span>&nbsp;<span class="ident" id="6657754">numReqs</span><span class="op" id="6657761">;</span>&nbsp;<span class="ident" id="6657763">i</span><span class="op" id="6657764">++</span>&nbsp;<span class="op" id="6657767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657771">reqs</span>&nbsp;<span class="op" id="6657776">&lt;-</span>&nbsp;<span class="builtintype" id="6657779">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6657785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657789">wg</span><span class="op" id="6657791">.</span><span class="ident" id="6657792">Wait</span><span class="op" id="6657796">(</span><span class="op" id="6657797">)</span><br>
<span class="lineno">1765</span><span class="op" id="6657799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6657802">func</span>&nbsp;<span class="ident" id="6657807">manyConcurrentQueries</span><span class="op" id="6657828">(</span><span class="ident" id="6657829">t</span>&nbsp;<span class="ident" id="6657831">testing</span><span class="op" id="6657838">.</span><span class="ident" id="6657839">TB</span><span class="op" id="6657841">)</span>&nbsp;<span class="op" id="6657843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657846">maxProcs</span><span class="op" id="6657854">,</span>&nbsp;<span class="ident" id="6657856">numReqs</span>&nbsp;<span class="op" id="6657864">:=</span>&nbsp;<span class="num" id="6657867">16</span><span class="op" id="6657869">,</span>&nbsp;<span class="num" id="6657871">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657876">if</span>&nbsp;<span class="ident" id="6657879">testing</span><span class="op" id="6657886">.</span><span class="ident" id="6657887">Short</span><span class="op" id="6657892">(</span><span class="op" id="6657893">)</span>&nbsp;<span class="op" id="6657895">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657899">maxProcs</span><span class="op" id="6657907">,</span>&nbsp;<span class="ident" id="6657909">numReqs</span>&nbsp;<span class="op" id="6657917">=</span>&nbsp;<span class="num" id="6657919">4</span><span class="op" id="6657920">,</span>&nbsp;<span class="num" id="6657922">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6657926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6657929">defer</span>&nbsp;<span class="ident" id="6657935">runtime</span><span class="op" id="6657942">.</span><span class="ident" id="6657943">GOMAXPROCS</span><span class="op" id="6657953">(</span><span class="ident" id="6657954">runtime</span><span class="op" id="6657961">.</span><span class="ident" id="6657962">GOMAXPROCS</span><span class="op" id="6657972">(</span><span class="ident" id="6657973">maxProcs</span><span class="op" id="6657981">)</span><span class="op" id="6657982">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6657986">db</span>&nbsp;<span class="op" id="6657989">:=</span>&nbsp;<span class="ident" id="6657992">newTestDB</span><span class="op" id="6658001">(</span><span class="ident" id="6658002">t</span><span class="op" id="6658003">,</span>&nbsp;<span class="string" id="6658005">&#34;people&#34;</span><span class="op" id="6658013">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658016">defer</span>&nbsp;<span class="ident" id="6658022">closeDB</span><span class="op" id="6658029">(</span><span class="ident" id="6658030">t</span><span class="op" id="6658031">,</span>&nbsp;<span class="ident" id="6658033">db</span><span class="op" id="6658035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658039">stmt</span><span class="op" id="6658043">,</span>&nbsp;<span class="ident" id="6658045">err</span>&nbsp;<span class="op" id="6658049">:=</span>&nbsp;<span class="ident" id="6658052">db</span><span class="op" id="6658054">.</span><span class="ident" id="6658055">Prepare</span><span class="op" id="6658062">(</span><span class="string" id="6658063">&#34;SELECT|people|name|&#34;</span><span class="op" id="6658084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658087">if</span>&nbsp;<span class="ident" id="6658090">err</span>&nbsp;<span class="op" id="6658094">!=</span>&nbsp;<span class="ident" id="6658097">nil</span>&nbsp;<span class="op" id="6658101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658105">t</span><span class="op" id="6658106">.</span><span class="ident" id="6658107">Fatal</span><span class="op" id="6658112">(</span><span class="ident" id="6658113">err</span><span class="op" id="6658116">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658122">defer</span>&nbsp;<span class="ident" id="6658128">stmt</span><span class="op" id="6658132">.</span><span class="ident" id="6658133">Close</span><span class="op" id="6658138">(</span><span class="op" id="6658139">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658143">var</span>&nbsp;<span class="ident" id="6658147">wg</span>&nbsp;<span class="ident" id="6658150">sync</span><span class="op" id="6658154">.</span><span class="ident" id="6658155">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658166">wg</span><span class="op" id="6658168">.</span><span class="ident" id="6658169">Add</span><span class="op" id="6658172">(</span><span class="ident" id="6658173">numReqs</span><span class="op" id="6658180">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658184">reqs</span>&nbsp;<span class="op" id="6658189">:=</span>&nbsp;<span class="builtinfunc" id="6658192">make</span><span class="op" id="6658196">(</span><span class="keyword" id="6658197">chan</span>&nbsp;<span class="builtintype" id="6658202">bool</span><span class="op" id="6658206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658209">defer</span>&nbsp;<span class="builtinfunc" id="6658215">close</span><span class="op" id="6658220">(</span><span class="ident" id="6658221">reqs</span><span class="op" id="6658225">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658229">for</span>&nbsp;<span class="ident" id="6658233">i</span>&nbsp;<span class="op" id="6658235">:=</span>&nbsp;<span class="num" id="6658238">0</span><span class="op" id="6658239">;</span>&nbsp;<span class="ident" id="6658241">i</span>&nbsp;<span class="op" id="6658243">&lt;</span>&nbsp;<span class="ident" id="6658245">maxProcs</span><span class="op" id="6658253">*</span><span class="num" id="6658254">2</span><span class="op" id="6658255">;</span>&nbsp;<span class="ident" id="6658257">i</span><span class="op" id="6658258">++</span>&nbsp;<span class="op" id="6658261">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658265">go</span>&nbsp;<span class="keyword" id="6658268">func</span><span class="op" id="6658272">(</span><span class="op" id="6658273">)</span>&nbsp;<span class="op" id="6658275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658280">for</span>&nbsp;<span class="keyword" id="6658284">range</span>&nbsp;<span class="ident" id="6658290">reqs</span>&nbsp;<span class="op" id="6658295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658301">rows</span><span class="op" id="6658305">,</span>&nbsp;<span class="ident" id="6658307">err</span>&nbsp;<span class="op" id="6658311">:=</span>&nbsp;<span class="ident" id="6658314">stmt</span><span class="op" id="6658318">.</span><span class="ident" id="6658319">Query</span><span class="op" id="6658324">(</span><span class="op" id="6658325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658331">if</span>&nbsp;<span class="ident" id="6658334">err</span>&nbsp;<span class="op" id="6658338">!=</span>&nbsp;<span class="ident" id="6658341">nil</span>&nbsp;<span class="op" id="6658345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658352">t</span><span class="op" id="6658353">.</span><span class="ident" id="6658354">Errorf</span><span class="op" id="6658360">(</span><span class="string" id="6658361">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6658382">,</span>&nbsp;<span class="ident" id="6658384">err</span><span class="op" id="6658387">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658394">wg</span><span class="op" id="6658396">.</span><span class="ident" id="6658397">Done</span><span class="op" id="6658401">(</span><span class="op" id="6658402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658409">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658429">var</span>&nbsp;<span class="ident" id="6658433">name</span>&nbsp;<span class="builtintype" id="6658438">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658449">for</span>&nbsp;<span class="ident" id="6658453">rows</span><span class="op" id="6658457">.</span><span class="ident" id="6658458">Next</span><span class="op" id="6658462">(</span><span class="op" id="6658463">)</span>&nbsp;<span class="op" id="6658465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658472">rows</span><span class="op" id="6658476">.</span><span class="ident" id="6658477">Scan</span><span class="op" id="6658481">(</span><span class="op" id="6658482">&amp;</span><span class="ident" id="6658483">name</span><span class="op" id="6658487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658499">rows</span><span class="op" id="6658503">.</span><span class="ident" id="6658504">Close</span><span class="op" id="6658509">(</span><span class="op" id="6658510">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658517">wg</span><span class="op" id="6658519">.</span><span class="ident" id="6658520">Done</span><span class="op" id="6658524">(</span><span class="op" id="6658525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658534">}</span><span class="op" id="6658535">(</span><span class="op" id="6658536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658543">for</span>&nbsp;<span class="ident" id="6658547">i</span>&nbsp;<span class="op" id="6658549">:=</span>&nbsp;<span class="num" id="6658552">0</span><span class="op" id="6658553">;</span>&nbsp;<span class="ident" id="6658555">i</span>&nbsp;<span class="op" id="6658557">&lt;</span>&nbsp;<span class="ident" id="6658559">numReqs</span><span class="op" id="6658566">;</span>&nbsp;<span class="ident" id="6658568">i</span><span class="op" id="6658569">++</span>&nbsp;<span class="op" id="6658572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658576">reqs</span>&nbsp;<span class="op" id="6658581">&lt;-</span>&nbsp;<span class="builtintype" id="6658584">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658594">wg</span><span class="op" id="6658596">.</span><span class="ident" id="6658597">Wait</span><span class="op" id="6658601">(</span><span class="op" id="6658602">)</span><br>
<span class="lineno">1815</span><span class="op" id="6658604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6658607">func</span>&nbsp;<span class="ident" id="6658612">TestIssue6081</span><span class="op" id="6658625">(</span><span class="ident" id="6658626">t</span>&nbsp;<span class="op" id="6658628">*</span><span class="ident" id="6658629">testing</span><span class="op" id="6658636">.</span><span class="ident" id="6658637">T</span><span class="op" id="6658638">)</span>&nbsp;<span class="op" id="6658640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658643">db</span>&nbsp;<span class="op" id="6658646">:=</span>&nbsp;<span class="ident" id="6658649">newTestDB</span><span class="op" id="6658658">(</span><span class="ident" id="6658659">t</span><span class="op" id="6658660">,</span>&nbsp;<span class="string" id="6658662">&#34;people&#34;</span><span class="op" id="6658670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658673">defer</span>&nbsp;<span class="ident" id="6658679">closeDB</span><span class="op" id="6658686">(</span><span class="ident" id="6658687">t</span><span class="op" id="6658688">,</span>&nbsp;<span class="ident" id="6658690">db</span><span class="op" id="6658692">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658696">drv</span>&nbsp;<span class="op" id="6658700">:=</span>&nbsp;<span class="ident" id="6658703">db</span><span class="op" id="6658705">.</span><span class="ident" id="6658706">driver</span><span class="op" id="6658712">.</span><span class="op" id="6658713">(</span><span class="op" id="6658714">*</span><span class="ident" id="6658715">fakeDriver</span><span class="op" id="6658725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658728">drv</span><span class="op" id="6658731">.</span><span class="ident" id="6658732">mu</span><span class="op" id="6658734">.</span><span class="ident" id="6658735">Lock</span><span class="op" id="6658739">(</span><span class="op" id="6658740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658743">opens0</span>&nbsp;<span class="op" id="6658750">:=</span>&nbsp;<span class="ident" id="6658753">drv</span><span class="op" id="6658756">.</span><span class="ident" id="6658757">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658768">closes0</span>&nbsp;<span class="op" id="6658776">:=</span>&nbsp;<span class="ident" id="6658779">drv</span><span class="op" id="6658782">.</span><span class="ident" id="6658783">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658795">drv</span><span class="op" id="6658798">.</span><span class="ident" id="6658799">mu</span><span class="op" id="6658801">.</span><span class="ident" id="6658802">Unlock</span><span class="op" id="6658808">(</span><span class="op" id="6658809">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658813">stmt</span><span class="op" id="6658817">,</span>&nbsp;<span class="ident" id="6658819">err</span>&nbsp;<span class="op" id="6658823">:=</span>&nbsp;<span class="ident" id="6658826">db</span><span class="op" id="6658828">.</span><span class="ident" id="6658829">Prepare</span><span class="op" id="6658836">(</span><span class="string" id="6658837">&#34;SELECT|people|name|&#34;</span><span class="op" id="6658858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658861">if</span>&nbsp;<span class="ident" id="6658864">err</span>&nbsp;<span class="op" id="6658868">!=</span>&nbsp;<span class="ident" id="6658871">nil</span>&nbsp;<span class="op" id="6658875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658879">t</span><span class="op" id="6658880">.</span><span class="ident" id="6658881">Fatal</span><span class="op" id="6658886">(</span><span class="ident" id="6658887">err</span><span class="op" id="6658890">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6658896">rowsCloseHook</span>&nbsp;<span class="op" id="6658910">=</span>&nbsp;<span class="keyword" id="6658912">func</span><span class="op" id="6658916">(</span><span class="ident" id="6658917">rows</span>&nbsp;<span class="op" id="6658922">*</span><span class="ident" id="6658923">Rows</span><span class="op" id="6658927">,</span>&nbsp;<span class="ident" id="6658929">err</span>&nbsp;<span class="op" id="6658933">*</span><span class="builtintype" id="6658934">error</span><span class="op" id="6658939">)</span>&nbsp;<span class="op" id="6658941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658945">*</span><span class="ident" id="6658946">err</span>&nbsp;<span class="op" id="6658950">=</span>&nbsp;<span class="ident" id="6658952">driver</span><span class="op" id="6658958">.</span><span class="ident" id="6658959">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6658971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6658974">defer</span>&nbsp;<span class="keyword" id="6658980">func</span><span class="op" id="6658984">(</span><span class="op" id="6658985">)</span>&nbsp;<span class="op" id="6658987">{</span>&nbsp;<span class="ident" id="6658989">rowsCloseHook</span>&nbsp;<span class="op" id="6659003">=</span>&nbsp;<span class="ident" id="6659005">nil</span>&nbsp;<span class="op" id="6659009">}</span><span class="op" id="6659010">(</span><span class="op" id="6659011">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6659014">for</span>&nbsp;<span class="ident" id="6659018">i</span>&nbsp;<span class="op" id="6659020">:=</span>&nbsp;<span class="num" id="6659023">0</span><span class="op" id="6659024">;</span>&nbsp;<span class="ident" id="6659026">i</span>&nbsp;<span class="op" id="6659028">&lt;</span>&nbsp;<span class="num" id="6659030">10</span><span class="op" id="6659032">;</span>&nbsp;<span class="ident" id="6659034">i</span><span class="op" id="6659035">++</span>&nbsp;<span class="op" id="6659038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659042">rows</span><span class="op" id="6659046">,</span>&nbsp;<span class="ident" id="6659048">err</span>&nbsp;<span class="op" id="6659052">:=</span>&nbsp;<span class="ident" id="6659055">stmt</span><span class="op" id="6659059">.</span><span class="ident" id="6659060">Query</span><span class="op" id="6659065">(</span><span class="op" id="6659066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6659070">if</span>&nbsp;<span class="ident" id="6659073">err</span>&nbsp;<span class="op" id="6659077">!=</span>&nbsp;<span class="ident" id="6659080">nil</span>&nbsp;<span class="op" id="6659084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659089">t</span><span class="op" id="6659090">.</span><span class="ident" id="6659091">Fatal</span><span class="op" id="6659096">(</span><span class="ident" id="6659097">err</span><span class="op" id="6659100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6659104">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659108">rows</span><span class="op" id="6659112">.</span><span class="ident" id="6659113">Close</span><span class="op" id="6659118">(</span><span class="op" id="6659119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6659122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6659125">if</span>&nbsp;<span class="ident" id="6659128">n</span>&nbsp;<span class="op" id="6659130">:=</span>&nbsp;<span class="builtinfunc" id="6659133">len</span><span class="op" id="6659136">(</span><span class="ident" id="6659137">stmt</span><span class="op" id="6659141">.</span><span class="ident" id="6659142">css</span><span class="op" id="6659145">)</span><span class="op" id="6659146">;</span>&nbsp;<span class="ident" id="6659148">n</span>&nbsp;<span class="op" id="6659150">&gt;</span>&nbsp;<span class="num" id="6659152">1</span>&nbsp;<span class="op" id="6659154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659158">t</span><span class="op" id="6659159">.</span><span class="ident" id="6659160">Errorf</span><span class="op" id="6659166">(</span><span class="string" id="6659167">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="6659199">,</span>&nbsp;<span class="ident" id="6659201">n</span><span class="op" id="6659202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6659205">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659208">stmt</span><span class="op" id="6659212">.</span><span class="ident" id="6659213">Close</span><span class="op" id="6659218">(</span><span class="op" id="6659219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6659222">if</span>&nbsp;<span class="ident" id="6659225">n</span>&nbsp;<span class="op" id="6659227">:=</span>&nbsp;<span class="builtinfunc" id="6659230">len</span><span class="op" id="6659233">(</span><span class="ident" id="6659234">stmt</span><span class="op" id="6659238">.</span><span class="ident" id="6659239">css</span><span class="op" id="6659242">)</span><span class="op" id="6659243">;</span>&nbsp;<span class="ident" id="6659245">n</span>&nbsp;<span class="op" id="6659247">!=</span>&nbsp;<span class="num" id="6659250">0</span>&nbsp;<span class="op" id="6659252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659256">t</span><span class="op" id="6659257">.</span><span class="ident" id="6659258">Errorf</span><span class="op" id="6659264">(</span><span class="string" id="6659265">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6659306">,</span>&nbsp;<span class="ident" id="6659308">n</span><span class="op" id="6659309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6659312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659316">drv</span><span class="op" id="6659319">.</span><span class="ident" id="6659320">mu</span><span class="op" id="6659322">.</span><span class="ident" id="6659323">Lock</span><span class="op" id="6659327">(</span><span class="op" id="6659328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659331">opens</span>&nbsp;<span class="op" id="6659337">:=</span>&nbsp;<span class="ident" id="6659340">drv</span><span class="op" id="6659343">.</span><span class="ident" id="6659344">openCount</span>&nbsp;<span class="op" id="6659354">-</span>&nbsp;<span class="ident" id="6659356">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659364">closes</span>&nbsp;<span class="op" id="6659371">:=</span>&nbsp;<span class="ident" id="6659374">drv</span><span class="op" id="6659377">.</span><span class="ident" id="6659378">closeCount</span>&nbsp;<span class="op" id="6659389">-</span>&nbsp;<span class="ident" id="6659391">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659400">drv</span><span class="op" id="6659403">.</span><span class="ident" id="6659404">mu</span><span class="op" id="6659406">.</span><span class="ident" id="6659407">Unlock</span><span class="op" id="6659413">(</span><span class="op" id="6659414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6659417">if</span>&nbsp;<span class="ident" id="6659420">opens</span>&nbsp;<span class="op" id="6659426">&lt;</span>&nbsp;<span class="num" id="6659428">9</span>&nbsp;<span class="op" id="6659430">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659434">t</span><span class="op" id="6659435">.</span><span class="ident" id="6659436">Errorf</span><span class="op" id="6659442">(</span><span class="string" id="6659443">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="6659466">,</span>&nbsp;<span class="ident" id="6659468">opens</span><span class="op" id="6659473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6659476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6659479">if</span>&nbsp;<span class="ident" id="6659482">closes</span>&nbsp;<span class="op" id="6659489">&lt;</span>&nbsp;<span class="num" id="6659491">9</span>&nbsp;<span class="op" id="6659493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659497">t</span><span class="op" id="6659498">.</span><span class="ident" id="6659499">Errorf</span><span class="op" id="6659505">(</span><span class="string" id="6659506">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="6659530">,</span>&nbsp;<span class="ident" id="6659532">closes</span><span class="op" id="6659538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6659541">}</span><br>
<span class="lineno">1860</span><span class="op" id="6659543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6659546">func</span>&nbsp;<span class="ident" id="6659551">TestConcurrency</span><span class="op" id="6659566">(</span><span class="ident" id="6659567">t</span>&nbsp;<span class="op" id="6659569">*</span><span class="ident" id="6659570">testing</span><span class="op" id="6659577">.</span><span class="ident" id="6659578">T</span><span class="op" id="6659579">)</span>&nbsp;<span class="op" id="6659581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659584">doConcurrentTest</span><span class="op" id="6659600">(</span><span class="ident" id="6659601">t</span><span class="op" id="6659602">,</span>&nbsp;<span class="builtinfunc" id="6659604">new</span><span class="op" id="6659607">(</span><span class="ident" id="6659608">concurrentDBQueryTest</span><span class="op" id="6659629">)</span><span class="op" id="6659630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659633">doConcurrentTest</span><span class="op" id="6659649">(</span><span class="ident" id="6659650">t</span><span class="op" id="6659651">,</span>&nbsp;<span class="builtinfunc" id="6659653">new</span><span class="op" id="6659656">(</span><span class="ident" id="6659657">concurrentDBExecTest</span><span class="op" id="6659677">)</span><span class="op" id="6659678">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659681">doConcurrentTest</span><span class="op" id="6659697">(</span><span class="ident" id="6659698">t</span><span class="op" id="6659699">,</span>&nbsp;<span class="builtinfunc" id="6659701">new</span><span class="op" id="6659704">(</span><span class="ident" id="6659705">concurrentStmtQueryTest</span><span class="op" id="6659728">)</span><span class="op" id="6659729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659732">doConcurrentTest</span><span class="op" id="6659748">(</span><span class="ident" id="6659749">t</span><span class="op" id="6659750">,</span>&nbsp;<span class="builtinfunc" id="6659752">new</span><span class="op" id="6659755">(</span><span class="ident" id="6659756">concurrentStmtExecTest</span><span class="op" id="6659778">)</span><span class="op" id="6659779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659782">doConcurrentTest</span><span class="op" id="6659798">(</span><span class="ident" id="6659799">t</span><span class="op" id="6659800">,</span>&nbsp;<span class="builtinfunc" id="6659802">new</span><span class="op" id="6659805">(</span><span class="ident" id="6659806">concurrentTxQueryTest</span><span class="op" id="6659827">)</span><span class="op" id="6659828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659831">doConcurrentTest</span><span class="op" id="6659847">(</span><span class="ident" id="6659848">t</span><span class="op" id="6659849">,</span>&nbsp;<span class="builtinfunc" id="6659851">new</span><span class="op" id="6659854">(</span><span class="ident" id="6659855">concurrentTxExecTest</span><span class="op" id="6659875">)</span><span class="op" id="6659876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659879">doConcurrentTest</span><span class="op" id="6659895">(</span><span class="ident" id="6659896">t</span><span class="op" id="6659897">,</span>&nbsp;<span class="builtinfunc" id="6659899">new</span><span class="op" id="6659902">(</span><span class="ident" id="6659903">concurrentTxStmtQueryTest</span><span class="op" id="6659928">)</span><span class="op" id="6659929">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659932">doConcurrentTest</span><span class="op" id="6659948">(</span><span class="ident" id="6659949">t</span><span class="op" id="6659950">,</span>&nbsp;<span class="builtinfunc" id="6659952">new</span><span class="op" id="6659955">(</span><span class="ident" id="6659956">concurrentTxStmtExecTest</span><span class="op" id="6659980">)</span><span class="op" id="6659981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6659984">doConcurrentTest</span><span class="op" id="6660000">(</span><span class="ident" id="6660001">t</span><span class="op" id="6660002">,</span>&nbsp;<span class="builtinfunc" id="6660004">new</span><span class="op" id="6660007">(</span><span class="ident" id="6660008">concurrentRandomTest</span><span class="op" id="6660028">)</span><span class="op" id="6660029">)</span><br>
<span class="lineno"></span><span class="op" id="6660031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6660034">func</span>&nbsp;<span class="ident" id="6660039">TestConnectionLeak</span><span class="op" id="6660057">(</span><span class="ident" id="6660058">t</span>&nbsp;<span class="op" id="6660060">*</span><span class="ident" id="6660061">testing</span><span class="op" id="6660068">.</span><span class="ident" id="6660069">T</span><span class="op" id="6660070">)</span>&nbsp;<span class="op" id="6660072">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660075">db</span>&nbsp;<span class="op" id="6660078">:=</span>&nbsp;<span class="ident" id="6660081">newTestDB</span><span class="op" id="6660090">(</span><span class="ident" id="6660091">t</span><span class="op" id="6660092">,</span>&nbsp;<span class="string" id="6660094">&#34;people&#34;</span><span class="op" id="6660102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6660105">defer</span>&nbsp;<span class="ident" id="6660111">closeDB</span><span class="op" id="6660118">(</span><span class="ident" id="6660119">t</span><span class="op" id="6660120">,</span>&nbsp;<span class="ident" id="6660122">db</span><span class="op" id="6660124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6660127">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660168">rows</span>&nbsp;<span class="op" id="6660173">:=</span>&nbsp;<span class="builtinfunc" id="6660176">make</span><span class="op" id="6660180">(</span><span class="op" id="6660181">[</span><span class="op" id="6660182">]</span><span class="op" id="6660183">*</span><span class="ident" id="6660184">Rows</span><span class="op" id="6660188">,</span>&nbsp;<span class="ident" id="6660190">defaultMaxIdleConns</span><span class="op" id="6660209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6660212">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6660278">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6660348">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660365">db</span><span class="op" id="6660367">.</span><span class="ident" id="6660368">SetMaxOpenConns</span><span class="op" id="6660383">(</span><span class="builtinfunc" id="6660384">len</span><span class="op" id="6660387">(</span><span class="ident" id="6660388">rows</span><span class="op" id="6660392">)</span>&nbsp;<span class="op" id="6660394">+</span>&nbsp;<span class="num" id="6660396">1</span><span class="op" id="6660397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6660400">for</span>&nbsp;<span class="ident" id="6660404">ii</span>&nbsp;<span class="op" id="6660407">:=</span>&nbsp;<span class="keyword" id="6660410">range</span>&nbsp;<span class="ident" id="6660416">rows</span>&nbsp;<span class="op" id="6660421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660425">r</span><span class="op" id="6660426">,</span>&nbsp;<span class="ident" id="6660428">err</span>&nbsp;<span class="op" id="6660432">:=</span>&nbsp;<span class="ident" id="6660435">db</span><span class="op" id="6660437">.</span><span class="ident" id="6660438">Query</span><span class="op" id="6660443">(</span><span class="string" id="6660444">&#34;SELECT|people|name|&#34;</span><span class="op" id="6660465">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6660469">if</span>&nbsp;<span class="ident" id="6660472">err</span>&nbsp;<span class="op" id="6660476">!=</span>&nbsp;<span class="ident" id="6660479">nil</span>&nbsp;<span class="op" id="6660483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660488">t</span><span class="op" id="6660489">.</span><span class="ident" id="6660490">Fatal</span><span class="op" id="6660495">(</span><span class="ident" id="6660496">err</span><span class="op" id="6660499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6660503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660507">r</span><span class="op" id="6660508">.</span><span class="ident" id="6660509">Next</span><span class="op" id="6660513">(</span><span class="op" id="6660514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6660518">if</span>&nbsp;<span class="ident" id="6660521">err</span>&nbsp;<span class="op" id="6660525">:=</span>&nbsp;<span class="ident" id="6660528">r</span><span class="op" id="6660529">.</span><span class="ident" id="6660530">Err</span><span class="op" id="6660533">(</span><span class="op" id="6660534">)</span><span class="op" id="6660535">;</span>&nbsp;<span class="ident" id="6660537">err</span>&nbsp;<span class="op" id="6660541">!=</span>&nbsp;<span class="ident" id="6660544">nil</span>&nbsp;<span class="op" id="6660548">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660553">t</span><span class="op" id="6660554">.</span><span class="ident" id="6660555">Fatal</span><span class="op" id="6660560">(</span><span class="ident" id="6660561">err</span><span class="op" id="6660564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6660568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660572">rows</span><span class="op" id="6660576">[</span><span class="ident" id="6660577">ii</span><span class="op" id="6660579">]</span>&nbsp;<span class="op" id="6660581">=</span>&nbsp;<span class="ident" id="6660583">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6660586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6660589">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6660648">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6660712">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660748">drv</span>&nbsp;<span class="op" id="6660752">:=</span>&nbsp;<span class="ident" id="6660755">db</span><span class="op" id="6660757">.</span><span class="ident" id="6660758">driver</span><span class="op" id="6660764">.</span><span class="op" id="6660765">(</span><span class="op" id="6660766">*</span><span class="ident" id="6660767">fakeDriver</span><span class="op" id="6660777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660780">drv</span><span class="op" id="6660783">.</span><span class="ident" id="6660784">waitCh</span>&nbsp;<span class="op" id="6660791">=</span>&nbsp;<span class="builtinfunc" id="6660793">make</span><span class="op" id="6660797">(</span><span class="keyword" id="6660798">chan</span>&nbsp;<span class="keyword" id="6660803">struct</span><span class="op" id="6660809">{</span><span class="op" id="6660810">}</span><span class="op" id="6660811">,</span>&nbsp;<span class="num" id="6660813">1</span><span class="op" id="6660814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660817">drv</span><span class="op" id="6660820">.</span><span class="ident" id="6660821">waitingCh</span>&nbsp;<span class="op" id="6660831">=</span>&nbsp;<span class="builtinfunc" id="6660833">make</span><span class="op" id="6660837">(</span><span class="keyword" id="6660838">chan</span>&nbsp;<span class="keyword" id="6660843">struct</span><span class="op" id="6660849">{</span><span class="op" id="6660850">}</span><span class="op" id="6660851">,</span>&nbsp;<span class="num" id="6660853">1</span><span class="op" id="6660854">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6660857">var</span>&nbsp;<span class="ident" id="6660861">wg</span>&nbsp;<span class="ident" id="6660864">sync</span><span class="op" id="6660868">.</span><span class="ident" id="6660869">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660880">wg</span><span class="op" id="6660882">.</span><span class="ident" id="6660883">Add</span><span class="op" id="6660886">(</span><span class="num" id="6660887">1</span><span class="op" id="6660888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6660891">go</span>&nbsp;<span class="keyword" id="6660894">func</span><span class="op" id="6660898">(</span><span class="op" id="6660899">)</span>&nbsp;<span class="op" id="6660901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660905">r</span><span class="op" id="6660906">,</span>&nbsp;<span class="ident" id="6660908">err</span>&nbsp;<span class="op" id="6660912">:=</span>&nbsp;<span class="ident" id="6660915">db</span><span class="op" id="6660917">.</span><span class="ident" id="6660918">Query</span><span class="op" id="6660923">(</span><span class="string" id="6660924">&#34;SELECT|people|name|&#34;</span><span class="op" id="6660945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6660949">if</span>&nbsp;<span class="ident" id="6660952">err</span>&nbsp;<span class="op" id="6660956">!=</span>&nbsp;<span class="ident" id="6660959">nil</span>&nbsp;<span class="op" id="6660963">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660968">t</span><span class="op" id="6660969">.</span><span class="ident" id="6660970">Fatal</span><span class="op" id="6660975">(</span><span class="ident" id="6660976">err</span><span class="op" id="6660979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6660983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660987">r</span><span class="op" id="6660988">.</span><span class="ident" id="6660989">Close</span><span class="op" id="6660994">(</span><span class="op" id="6660995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6660999">wg</span><span class="op" id="6661001">.</span><span class="ident" id="6661002">Done</span><span class="op" id="6661006">(</span><span class="op" id="6661007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6661010">}</span><span class="op" id="6661011">(</span><span class="op" id="6661012">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6661015">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6661084">&lt;-</span><span class="ident" id="6661086">drv</span><span class="op" id="6661089">.</span><span class="ident" id="6661090">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6661101">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6661168">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6661228">for</span>&nbsp;<span class="ident" id="6661232">_</span><span class="op" id="6661233">,</span>&nbsp;<span class="ident" id="6661235">v</span>&nbsp;<span class="op" id="6661237">:=</span>&nbsp;<span class="keyword" id="6661240">range</span>&nbsp;<span class="ident" id="6661246">rows</span>&nbsp;<span class="op" id="6661251">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661255">v</span><span class="op" id="6661256">.</span><span class="ident" id="6661257">Close</span><span class="op" id="6661262">(</span><span class="op" id="6661263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6661266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6661269">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6661340">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6661411">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6661480">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661496">drv</span><span class="op" id="6661499">.</span><span class="ident" id="6661500">waitCh</span>&nbsp;<span class="op" id="6661507">&lt;-</span>&nbsp;<span class="keyword" id="6661510">struct</span><span class="op" id="6661516">{</span><span class="op" id="6661517">}</span><span class="op" id="6661518">{</span><span class="op" id="6661519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661522">wg</span><span class="op" id="6661524">.</span><span class="ident" id="6661525">Wait</span><span class="op" id="6661529">(</span><span class="op" id="6661530">)</span><br>
<span class="lineno"></span><span class="op" id="6661532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="6661535">func</span>&nbsp;<span class="ident" id="6661540">BenchmarkConcurrentDBExec</span><span class="op" id="6661565">(</span><span class="ident" id="6661566">b</span>&nbsp;<span class="op" id="6661568">*</span><span class="ident" id="6661569">testing</span><span class="op" id="6661576">.</span><span class="ident" id="6661577">B</span><span class="op" id="6661578">)</span>&nbsp;<span class="op" id="6661580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661583">b</span><span class="op" id="6661584">.</span><span class="ident" id="6661585">ReportAllocs</span><span class="op" id="6661597">(</span><span class="op" id="6661598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661601">ct</span>&nbsp;<span class="op" id="6661604">:=</span>&nbsp;<span class="builtinfunc" id="6661607">new</span><span class="op" id="6661610">(</span><span class="ident" id="6661611">concurrentDBExecTest</span><span class="op" id="6661631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6661634">for</span>&nbsp;<span class="ident" id="6661638">i</span>&nbsp;<span class="op" id="6661640">:=</span>&nbsp;<span class="num" id="6661643">0</span><span class="op" id="6661644">;</span>&nbsp;<span class="ident" id="6661646">i</span>&nbsp;<span class="op" id="6661648">&lt;</span>&nbsp;<span class="ident" id="6661650">b</span><span class="op" id="6661651">.</span><span class="ident" id="6661652">N</span><span class="op" id="6661653">;</span>&nbsp;<span class="ident" id="6661655">i</span><span class="op" id="6661656">++</span>&nbsp;<span class="op" id="6661659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661663">doConcurrentTest</span><span class="op" id="6661679">(</span><span class="ident" id="6661680">b</span><span class="op" id="6661681">,</span>&nbsp;<span class="ident" id="6661683">ct</span><span class="op" id="6661685">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6661688">}</span><br>
<span class="lineno"></span><span class="op" id="6661690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6661693">func</span>&nbsp;<span class="ident" id="6661698">BenchmarkConcurrentStmtQuery</span><span class="op" id="6661726">(</span><span class="ident" id="6661727">b</span>&nbsp;<span class="op" id="6661729">*</span><span class="ident" id="6661730">testing</span><span class="op" id="6661737">.</span><span class="ident" id="6661738">B</span><span class="op" id="6661739">)</span>&nbsp;<span class="op" id="6661741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661744">b</span><span class="op" id="6661745">.</span><span class="ident" id="6661746">ReportAllocs</span><span class="op" id="6661758">(</span><span class="op" id="6661759">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661762">ct</span>&nbsp;<span class="op" id="6661765">:=</span>&nbsp;<span class="builtinfunc" id="6661768">new</span><span class="op" id="6661771">(</span><span class="ident" id="6661772">concurrentStmtQueryTest</span><span class="op" id="6661795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6661798">for</span>&nbsp;<span class="ident" id="6661802">i</span>&nbsp;<span class="op" id="6661804">:=</span>&nbsp;<span class="num" id="6661807">0</span><span class="op" id="6661808">;</span>&nbsp;<span class="ident" id="6661810">i</span>&nbsp;<span class="op" id="6661812">&lt;</span>&nbsp;<span class="ident" id="6661814">b</span><span class="op" id="6661815">.</span><span class="ident" id="6661816">N</span><span class="op" id="6661817">;</span>&nbsp;<span class="ident" id="6661819">i</span><span class="op" id="6661820">++</span>&nbsp;<span class="op" id="6661823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661827">doConcurrentTest</span><span class="op" id="6661843">(</span><span class="ident" id="6661844">b</span><span class="op" id="6661845">,</span>&nbsp;<span class="ident" id="6661847">ct</span><span class="op" id="6661849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6661852">}</span><br>
<span class="lineno"></span><span class="op" id="6661854">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="6661857">func</span>&nbsp;<span class="ident" id="6661862">BenchmarkConcurrentStmtExec</span><span class="op" id="6661889">(</span><span class="ident" id="6661890">b</span>&nbsp;<span class="op" id="6661892">*</span><span class="ident" id="6661893">testing</span><span class="op" id="6661900">.</span><span class="ident" id="6661901">B</span><span class="op" id="6661902">)</span>&nbsp;<span class="op" id="6661904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661907">b</span><span class="op" id="6661908">.</span><span class="ident" id="6661909">ReportAllocs</span><span class="op" id="6661921">(</span><span class="op" id="6661922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661925">ct</span>&nbsp;<span class="op" id="6661928">:=</span>&nbsp;<span class="builtinfunc" id="6661931">new</span><span class="op" id="6661934">(</span><span class="ident" id="6661935">concurrentStmtExecTest</span><span class="op" id="6661957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6661960">for</span>&nbsp;<span class="ident" id="6661964">i</span>&nbsp;<span class="op" id="6661966">:=</span>&nbsp;<span class="num" id="6661969">0</span><span class="op" id="6661970">;</span>&nbsp;<span class="ident" id="6661972">i</span>&nbsp;<span class="op" id="6661974">&lt;</span>&nbsp;<span class="ident" id="6661976">b</span><span class="op" id="6661977">.</span><span class="ident" id="6661978">N</span><span class="op" id="6661979">;</span>&nbsp;<span class="ident" id="6661981">i</span><span class="op" id="6661982">++</span>&nbsp;<span class="op" id="6661985">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6661989">doConcurrentTest</span><span class="op" id="6662005">(</span><span class="ident" id="6662006">b</span><span class="op" id="6662007">,</span>&nbsp;<span class="ident" id="6662009">ct</span><span class="op" id="6662011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6662014">}</span><br>
<span class="lineno"></span><span class="op" id="6662016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6662019">func</span>&nbsp;<span class="ident" id="6662024">BenchmarkConcurrentTxQuery</span><span class="op" id="6662050">(</span><span class="ident" id="6662051">b</span>&nbsp;<span class="op" id="6662053">*</span><span class="ident" id="6662054">testing</span><span class="op" id="6662061">.</span><span class="ident" id="6662062">B</span><span class="op" id="6662063">)</span>&nbsp;<span class="op" id="6662065">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662068">b</span><span class="op" id="6662069">.</span><span class="ident" id="6662070">ReportAllocs</span><span class="op" id="6662082">(</span><span class="op" id="6662083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662086">ct</span>&nbsp;<span class="op" id="6662089">:=</span>&nbsp;<span class="builtinfunc" id="6662092">new</span><span class="op" id="6662095">(</span><span class="ident" id="6662096">concurrentTxQueryTest</span><span class="op" id="6662117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6662120">for</span>&nbsp;<span class="ident" id="6662124">i</span>&nbsp;<span class="op" id="6662126">:=</span>&nbsp;<span class="num" id="6662129">0</span><span class="op" id="6662130">;</span>&nbsp;<span class="ident" id="6662132">i</span>&nbsp;<span class="op" id="6662134">&lt;</span>&nbsp;<span class="ident" id="6662136">b</span><span class="op" id="6662137">.</span><span class="ident" id="6662138">N</span><span class="op" id="6662139">;</span>&nbsp;<span class="ident" id="6662141">i</span><span class="op" id="6662142">++</span>&nbsp;<span class="op" id="6662145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662149">doConcurrentTest</span><span class="op" id="6662165">(</span><span class="ident" id="6662166">b</span><span class="op" id="6662167">,</span>&nbsp;<span class="ident" id="6662169">ct</span><span class="op" id="6662171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6662174">}</span><br>
<span class="lineno">1955</span><span class="op" id="6662176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6662179">func</span>&nbsp;<span class="ident" id="6662184">BenchmarkConcurrentTxExec</span><span class="op" id="6662209">(</span><span class="ident" id="6662210">b</span>&nbsp;<span class="op" id="6662212">*</span><span class="ident" id="6662213">testing</span><span class="op" id="6662220">.</span><span class="ident" id="6662221">B</span><span class="op" id="6662222">)</span>&nbsp;<span class="op" id="6662224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662227">b</span><span class="op" id="6662228">.</span><span class="ident" id="6662229">ReportAllocs</span><span class="op" id="6662241">(</span><span class="op" id="6662242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662245">ct</span>&nbsp;<span class="op" id="6662248">:=</span>&nbsp;<span class="builtinfunc" id="6662251">new</span><span class="op" id="6662254">(</span><span class="ident" id="6662255">concurrentTxExecTest</span><span class="op" id="6662275">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6662278">for</span>&nbsp;<span class="ident" id="6662282">i</span>&nbsp;<span class="op" id="6662284">:=</span>&nbsp;<span class="num" id="6662287">0</span><span class="op" id="6662288">;</span>&nbsp;<span class="ident" id="6662290">i</span>&nbsp;<span class="op" id="6662292">&lt;</span>&nbsp;<span class="ident" id="6662294">b</span><span class="op" id="6662295">.</span><span class="ident" id="6662296">N</span><span class="op" id="6662297">;</span>&nbsp;<span class="ident" id="6662299">i</span><span class="op" id="6662300">++</span>&nbsp;<span class="op" id="6662303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662307">doConcurrentTest</span><span class="op" id="6662323">(</span><span class="ident" id="6662324">b</span><span class="op" id="6662325">,</span>&nbsp;<span class="ident" id="6662327">ct</span><span class="op" id="6662329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6662332">}</span><br>
<span class="lineno"></span><span class="op" id="6662334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="6662337">func</span>&nbsp;<span class="ident" id="6662342">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="6662372">(</span><span class="ident" id="6662373">b</span>&nbsp;<span class="op" id="6662375">*</span><span class="ident" id="6662376">testing</span><span class="op" id="6662383">.</span><span class="ident" id="6662384">B</span><span class="op" id="6662385">)</span>&nbsp;<span class="op" id="6662387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662390">b</span><span class="op" id="6662391">.</span><span class="ident" id="6662392">ReportAllocs</span><span class="op" id="6662404">(</span><span class="op" id="6662405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662408">ct</span>&nbsp;<span class="op" id="6662411">:=</span>&nbsp;<span class="builtinfunc" id="6662414">new</span><span class="op" id="6662417">(</span><span class="ident" id="6662418">concurrentTxStmtQueryTest</span><span class="op" id="6662443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6662446">for</span>&nbsp;<span class="ident" id="6662450">i</span>&nbsp;<span class="op" id="6662452">:=</span>&nbsp;<span class="num" id="6662455">0</span><span class="op" id="6662456">;</span>&nbsp;<span class="ident" id="6662458">i</span>&nbsp;<span class="op" id="6662460">&lt;</span>&nbsp;<span class="ident" id="6662462">b</span><span class="op" id="6662463">.</span><span class="ident" id="6662464">N</span><span class="op" id="6662465">;</span>&nbsp;<span class="ident" id="6662467">i</span><span class="op" id="6662468">++</span>&nbsp;<span class="op" id="6662471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662475">doConcurrentTest</span><span class="op" id="6662491">(</span><span class="ident" id="6662492">b</span><span class="op" id="6662493">,</span>&nbsp;<span class="ident" id="6662495">ct</span><span class="op" id="6662497">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6662500">}</span><br>
<span class="lineno"></span><span class="op" id="6662502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6662505">func</span>&nbsp;<span class="ident" id="6662510">BenchmarkConcurrentTxStmtExec</span><span class="op" id="6662539">(</span><span class="ident" id="6662540">b</span>&nbsp;<span class="op" id="6662542">*</span><span class="ident" id="6662543">testing</span><span class="op" id="6662550">.</span><span class="ident" id="6662551">B</span><span class="op" id="6662552">)</span>&nbsp;<span class="op" id="6662554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662557">b</span><span class="op" id="6662558">.</span><span class="ident" id="6662559">ReportAllocs</span><span class="op" id="6662571">(</span><span class="op" id="6662572">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662575">ct</span>&nbsp;<span class="op" id="6662578">:=</span>&nbsp;<span class="builtinfunc" id="6662581">new</span><span class="op" id="6662584">(</span><span class="ident" id="6662585">concurrentTxStmtExecTest</span><span class="op" id="6662609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6662612">for</span>&nbsp;<span class="ident" id="6662616">i</span>&nbsp;<span class="op" id="6662618">:=</span>&nbsp;<span class="num" id="6662621">0</span><span class="op" id="6662622">;</span>&nbsp;<span class="ident" id="6662624">i</span>&nbsp;<span class="op" id="6662626">&lt;</span>&nbsp;<span class="ident" id="6662628">b</span><span class="op" id="6662629">.</span><span class="ident" id="6662630">N</span><span class="op" id="6662631">;</span>&nbsp;<span class="ident" id="6662633">i</span><span class="op" id="6662634">++</span>&nbsp;<span class="op" id="6662637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662641">doConcurrentTest</span><span class="op" id="6662657">(</span><span class="ident" id="6662658">b</span><span class="op" id="6662659">,</span>&nbsp;<span class="ident" id="6662661">ct</span><span class="op" id="6662663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6662666">}</span><br>
<span class="lineno"></span><span class="op" id="6662668">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="6662671">func</span>&nbsp;<span class="ident" id="6662676">BenchmarkConcurrentRandom</span><span class="op" id="6662701">(</span><span class="ident" id="6662702">b</span>&nbsp;<span class="op" id="6662704">*</span><span class="ident" id="6662705">testing</span><span class="op" id="6662712">.</span><span class="ident" id="6662713">B</span><span class="op" id="6662714">)</span>&nbsp;<span class="op" id="6662716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662719">b</span><span class="op" id="6662720">.</span><span class="ident" id="6662721">ReportAllocs</span><span class="op" id="6662733">(</span><span class="op" id="6662734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662737">ct</span>&nbsp;<span class="op" id="6662740">:=</span>&nbsp;<span class="builtinfunc" id="6662743">new</span><span class="op" id="6662746">(</span><span class="ident" id="6662747">concurrentRandomTest</span><span class="op" id="6662767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6662770">for</span>&nbsp;<span class="ident" id="6662774">i</span>&nbsp;<span class="op" id="6662776">:=</span>&nbsp;<span class="num" id="6662779">0</span><span class="op" id="6662780">;</span>&nbsp;<span class="ident" id="6662782">i</span>&nbsp;<span class="op" id="6662784">&lt;</span>&nbsp;<span class="ident" id="6662786">b</span><span class="op" id="6662787">.</span><span class="ident" id="6662788">N</span><span class="op" id="6662789">;</span>&nbsp;<span class="ident" id="6662791">i</span><span class="op" id="6662792">++</span>&nbsp;<span class="op" id="6662795">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6662799">doConcurrentTest</span><span class="op" id="6662815">(</span><span class="ident" id="6662816">b</span><span class="op" id="6662817">,</span>&nbsp;<span class="ident" id="6662819">ct</span><span class="op" id="6662821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6662824">}</span><br>
<span class="lineno"></span><span class="op" id="6662826">}</span>
</div>
</body>
</html>
