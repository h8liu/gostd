<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html" class="current">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6143670">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6143725">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6143779">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6143830">package</span>&nbsp;<span class="ident" id="6143838">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6143848">import</span>&nbsp;<span class="op" id="6143855">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143858">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143867">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143876">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143886">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143893">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143899">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143912">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143919">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143931">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143942">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6143953">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6143960">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6143963">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="6144036">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="6144115">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6144192">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="6144211">func</span>&nbsp;<span class="ident" id="6144216">drainBody</span><span class="op" id="6144225">(</span><span class="ident" id="6144226">b</span>&nbsp;<span class="ident" id="6144228">io</span><span class="op" id="6144230">.</span><span class="ident" id="6144231">ReadCloser</span><span class="op" id="6144241">)</span>&nbsp;<span class="op" id="6144243">(</span><span class="ident" id="6144244">r1</span><span class="op" id="6144246">,</span>&nbsp;<span class="ident" id="6144248">r2</span>&nbsp;<span class="ident" id="6144251">io</span><span class="op" id="6144253">.</span><span class="ident" id="6144254">ReadCloser</span><span class="op" id="6144264">,</span>&nbsp;<span class="ident" id="6144266">err</span>&nbsp;<span class="builtintype" id="6144270">error</span><span class="op" id="6144275">)</span>&nbsp;<span class="op" id="6144277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144280">var</span>&nbsp;<span class="ident" id="6144284">buf</span>&nbsp;<span class="ident" id="6144288">bytes</span><span class="op" id="6144293">.</span><span class="ident" id="6144294">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144302">if</span>&nbsp;<span class="ident" id="6144305">_</span><span class="op" id="6144306">,</span>&nbsp;<span class="ident" id="6144308">err</span>&nbsp;<span class="op" id="6144312">=</span>&nbsp;<span class="ident" id="6144314">buf</span><span class="op" id="6144317">.</span><span class="ident" id="6144318">ReadFrom</span><span class="op" id="6144326">(</span><span class="ident" id="6144327">b</span><span class="op" id="6144328">)</span><span class="op" id="6144329">;</span>&nbsp;<span class="ident" id="6144331">err</span>&nbsp;<span class="op" id="6144335">!=</span>&nbsp;<span class="ident" id="6144338">nil</span>&nbsp;<span class="op" id="6144342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144346">return</span>&nbsp;<span class="ident" id="6144353">nil</span><span class="op" id="6144356">,</span>&nbsp;<span class="ident" id="6144358">nil</span><span class="op" id="6144361">,</span>&nbsp;<span class="ident" id="6144363">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6144368">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144371">if</span>&nbsp;<span class="ident" id="6144374">err</span>&nbsp;<span class="op" id="6144378">=</span>&nbsp;<span class="ident" id="6144380">b</span><span class="op" id="6144381">.</span><span class="ident" id="6144382">Close</span><span class="op" id="6144387">(</span><span class="op" id="6144388">)</span><span class="op" id="6144389">;</span>&nbsp;<span class="ident" id="6144391">err</span>&nbsp;<span class="op" id="6144395">!=</span>&nbsp;<span class="ident" id="6144398">nil</span>&nbsp;<span class="op" id="6144402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144406">return</span>&nbsp;<span class="ident" id="6144413">nil</span><span class="op" id="6144416">,</span>&nbsp;<span class="ident" id="6144418">nil</span><span class="op" id="6144421">,</span>&nbsp;<span class="ident" id="6144423">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6144428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144431">return</span>&nbsp;<span class="ident" id="6144438">ioutil</span><span class="op" id="6144444">.</span><span class="ident" id="6144445">NopCloser</span><span class="op" id="6144454">(</span><span class="op" id="6144455">&amp;</span><span class="ident" id="6144456">buf</span><span class="op" id="6144459">)</span><span class="op" id="6144460">,</span>&nbsp;<span class="ident" id="6144462">ioutil</span><span class="op" id="6144468">.</span><span class="ident" id="6144469">NopCloser</span><span class="op" id="6144478">(</span><span class="ident" id="6144479">bytes</span><span class="op" id="6144484">.</span><span class="ident" id="6144485">NewReader</span><span class="op" id="6144494">(</span><span class="ident" id="6144495">buf</span><span class="op" id="6144498">.</span><span class="ident" id="6144499">Bytes</span><span class="op" id="6144504">(</span><span class="op" id="6144505">)</span><span class="op" id="6144506">)</span><span class="op" id="6144507">)</span><span class="op" id="6144508">,</span>&nbsp;<span class="ident" id="6144510">nil</span><br>
<span class="lineno"></span><span class="op" id="6144514">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6144517">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="6144588">type</span>&nbsp;<span class="ident" id="6144593">dumpConn</span>&nbsp;<span class="keyword" id="6144602">struct</span>&nbsp;<span class="op" id="6144609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144612">io</span><span class="op" id="6144614">.</span><span class="ident" id="6144615">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144623">io</span><span class="op" id="6144625">.</span><span class="ident" id="6144626">Reader</span><br>
<span class="lineno">40</span><span class="op" id="6144633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6144636">func</span>&nbsp;<span class="op" id="6144641">(</span><span class="ident" id="6144642">c</span>&nbsp;<span class="op" id="6144644">*</span><span class="ident" id="6144645">dumpConn</span><span class="op" id="6144653">)</span>&nbsp;<span class="ident" id="6144655">Close</span><span class="op" id="6144660">(</span><span class="op" id="6144661">)</span>&nbsp;<span class="builtintype" id="6144663">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144691">{</span>&nbsp;<span class="keyword" id="6144693">return</span>&nbsp;<span class="ident" id="6144700">nil</span>&nbsp;<span class="op" id="6144704">}</span><br>
<span class="lineno"></span><span class="keyword" id="6144706">func</span>&nbsp;<span class="op" id="6144711">(</span><span class="ident" id="6144712">c</span>&nbsp;<span class="op" id="6144714">*</span><span class="ident" id="6144715">dumpConn</span><span class="op" id="6144723">)</span>&nbsp;<span class="ident" id="6144725">LocalAddr</span><span class="op" id="6144734">(</span><span class="op" id="6144735">)</span>&nbsp;<span class="ident" id="6144737">net</span><span class="op" id="6144740">.</span><span class="ident" id="6144741">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144761">{</span>&nbsp;<span class="keyword" id="6144763">return</span>&nbsp;<span class="ident" id="6144770">nil</span>&nbsp;<span class="op" id="6144774">}</span><br>
<span class="lineno"></span><span class="keyword" id="6144776">func</span>&nbsp;<span class="op" id="6144781">(</span><span class="ident" id="6144782">c</span>&nbsp;<span class="op" id="6144784">*</span><span class="ident" id="6144785">dumpConn</span><span class="op" id="6144793">)</span>&nbsp;<span class="ident" id="6144795">RemoteAddr</span><span class="op" id="6144805">(</span><span class="op" id="6144806">)</span>&nbsp;<span class="ident" id="6144808">net</span><span class="op" id="6144811">.</span><span class="ident" id="6144812">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144831">{</span>&nbsp;<span class="keyword" id="6144833">return</span>&nbsp;<span class="ident" id="6144840">nil</span>&nbsp;<span class="op" id="6144844">}</span><br>
<span class="lineno">45</span><span class="keyword" id="6144846">func</span>&nbsp;<span class="op" id="6144851">(</span><span class="ident" id="6144852">c</span>&nbsp;<span class="op" id="6144854">*</span><span class="ident" id="6144855">dumpConn</span><span class="op" id="6144863">)</span>&nbsp;<span class="ident" id="6144865">SetDeadline</span><span class="op" id="6144876">(</span><span class="ident" id="6144877">t</span>&nbsp;<span class="ident" id="6144879">time</span><span class="op" id="6144883">.</span><span class="ident" id="6144884">Time</span><span class="op" id="6144888">)</span>&nbsp;<span class="builtintype" id="6144890">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6144901">{</span>&nbsp;<span class="keyword" id="6144903">return</span>&nbsp;<span class="ident" id="6144910">nil</span>&nbsp;<span class="op" id="6144914">}</span><br>
<span class="lineno"></span><span class="keyword" id="6144916">func</span>&nbsp;<span class="op" id="6144921">(</span><span class="ident" id="6144922">c</span>&nbsp;<span class="op" id="6144924">*</span><span class="ident" id="6144925">dumpConn</span><span class="op" id="6144933">)</span>&nbsp;<span class="ident" id="6144935">SetReadDeadline</span><span class="op" id="6144950">(</span><span class="ident" id="6144951">t</span>&nbsp;<span class="ident" id="6144953">time</span><span class="op" id="6144957">.</span><span class="ident" id="6144958">Time</span><span class="op" id="6144962">)</span>&nbsp;<span class="builtintype" id="6144964">error</span>&nbsp;&nbsp;<span class="op" id="6144971">{</span>&nbsp;<span class="keyword" id="6144973">return</span>&nbsp;<span class="ident" id="6144980">nil</span>&nbsp;<span class="op" id="6144984">}</span><br>
<span class="lineno"></span><span class="keyword" id="6144986">func</span>&nbsp;<span class="op" id="6144991">(</span><span class="ident" id="6144992">c</span>&nbsp;<span class="op" id="6144994">*</span><span class="ident" id="6144995">dumpConn</span><span class="op" id="6145003">)</span>&nbsp;<span class="ident" id="6145005">SetWriteDeadline</span><span class="op" id="6145021">(</span><span class="ident" id="6145022">t</span>&nbsp;<span class="ident" id="6145024">time</span><span class="op" id="6145028">.</span><span class="ident" id="6145029">Time</span><span class="op" id="6145033">)</span>&nbsp;<span class="builtintype" id="6145035">error</span>&nbsp;<span class="op" id="6145041">{</span>&nbsp;<span class="keyword" id="6145043">return</span>&nbsp;<span class="ident" id="6145050">nil</span>&nbsp;<span class="op" id="6145054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6145057">type</span>&nbsp;<span class="ident" id="6145062">neverEnding</span>&nbsp;<span class="builtintype" id="6145074">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6145080">func</span>&nbsp;<span class="op" id="6145085">(</span><span class="ident" id="6145086">b</span>&nbsp;<span class="ident" id="6145088">neverEnding</span><span class="op" id="6145099">)</span>&nbsp;<span class="ident" id="6145101">Read</span><span class="op" id="6145105">(</span><span class="ident" id="6145106">p</span>&nbsp;<span class="op" id="6145108">[</span><span class="op" id="6145109">]</span><span class="builtintype" id="6145110">byte</span><span class="op" id="6145114">)</span>&nbsp;<span class="op" id="6145116">(</span><span class="ident" id="6145117">n</span>&nbsp;<span class="builtintype" id="6145119">int</span><span class="op" id="6145122">,</span>&nbsp;<span class="ident" id="6145124">err</span>&nbsp;<span class="builtintype" id="6145128">error</span><span class="op" id="6145133">)</span>&nbsp;<span class="op" id="6145135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145138">for</span>&nbsp;<span class="ident" id="6145142">i</span>&nbsp;<span class="op" id="6145144">:=</span>&nbsp;<span class="keyword" id="6145147">range</span>&nbsp;<span class="ident" id="6145153">p</span>&nbsp;<span class="op" id="6145155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145159">p</span><span class="op" id="6145160">[</span><span class="ident" id="6145161">i</span><span class="op" id="6145162">]</span>&nbsp;<span class="op" id="6145164">=</span>&nbsp;<span class="builtintype" id="6145166">byte</span><span class="op" id="6145170">(</span><span class="ident" id="6145171">b</span><span class="op" id="6145172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6145175">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145178">return</span>&nbsp;<span class="builtinfunc" id="6145185">len</span><span class="op" id="6145188">(</span><span class="ident" id="6145189">p</span><span class="op" id="6145190">)</span><span class="op" id="6145191">,</span>&nbsp;<span class="ident" id="6145193">nil</span><br>
<span class="lineno"></span><span class="op" id="6145197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6145200">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="6145251">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="6145301">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="6145324">func</span>&nbsp;<span class="ident" id="6145329">DumpRequestOut</span><span class="op" id="6145343">(</span><span class="ident" id="6145344">req</span>&nbsp;<span class="op" id="6145348">*</span><span class="ident" id="6145349">http</span><span class="op" id="6145353">.</span><span class="ident" id="6145354">Request</span><span class="op" id="6145361">,</span>&nbsp;<span class="ident" id="6145363">body</span>&nbsp;<span class="builtintype" id="6145368">bool</span><span class="op" id="6145372">)</span>&nbsp;<span class="op" id="6145374">(</span><span class="op" id="6145375">[</span><span class="op" id="6145376">]</span><span class="builtintype" id="6145377">byte</span><span class="op" id="6145381">,</span>&nbsp;<span class="builtintype" id="6145383">error</span><span class="op" id="6145388">)</span>&nbsp;<span class="op" id="6145390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145393">save</span>&nbsp;<span class="op" id="6145398">:=</span>&nbsp;<span class="ident" id="6145401">req</span><span class="op" id="6145404">.</span><span class="ident" id="6145405">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145411">dummyBody</span>&nbsp;<span class="op" id="6145421">:=</span>&nbsp;<span class="builtintype" id="6145424">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145431">if</span>&nbsp;<span class="op" id="6145434">!</span><span class="ident" id="6145435">body</span>&nbsp;<span class="op" id="6145440">||</span>&nbsp;<span class="ident" id="6145443">req</span><span class="op" id="6145446">.</span><span class="ident" id="6145447">Body</span>&nbsp;<span class="op" id="6145452">==</span>&nbsp;<span class="ident" id="6145455">nil</span>&nbsp;<span class="op" id="6145459">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145463">req</span><span class="op" id="6145466">.</span><span class="ident" id="6145467">Body</span>&nbsp;<span class="op" id="6145472">=</span>&nbsp;<span class="ident" id="6145474">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145480">if</span>&nbsp;<span class="ident" id="6145483">req</span><span class="op" id="6145486">.</span><span class="ident" id="6145487">ContentLength</span>&nbsp;<span class="op" id="6145501">!=</span>&nbsp;<span class="num" id="6145504">0</span>&nbsp;<span class="op" id="6145506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145511">req</span><span class="op" id="6145514">.</span><span class="ident" id="6145515">Body</span>&nbsp;<span class="op" id="6145520">=</span>&nbsp;<span class="ident" id="6145522">ioutil</span><span class="op" id="6145528">.</span><span class="ident" id="6145529">NopCloser</span><span class="op" id="6145538">(</span><span class="ident" id="6145539">io</span><span class="op" id="6145541">.</span><span class="ident" id="6145542">LimitReader</span><span class="op" id="6145553">(</span><span class="ident" id="6145554">neverEnding</span><span class="op" id="6145565">(</span><span class="string" id="6145566">&#39;x&#39;</span><span class="op" id="6145569">)</span><span class="op" id="6145570">,</span>&nbsp;<span class="ident" id="6145572">req</span><span class="op" id="6145575">.</span><span class="ident" id="6145576">ContentLength</span><span class="op" id="6145589">)</span><span class="op" id="6145590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145595">dummyBody</span>&nbsp;<span class="op" id="6145605">=</span>&nbsp;<span class="builtintype" id="6145607">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6145614">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6145617">}</span>&nbsp;<span class="keyword" id="6145619">else</span>&nbsp;<span class="op" id="6145624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145628">var</span>&nbsp;<span class="ident" id="6145632">err</span>&nbsp;<span class="builtintype" id="6145636">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145644">save</span><span class="op" id="6145648">,</span>&nbsp;<span class="ident" id="6145650">req</span><span class="op" id="6145653">.</span><span class="ident" id="6145654">Body</span><span class="op" id="6145658">,</span>&nbsp;<span class="ident" id="6145660">err</span>&nbsp;<span class="op" id="6145664">=</span>&nbsp;<span class="ident" id="6145666">drainBody</span><span class="op" id="6145675">(</span><span class="ident" id="6145676">req</span><span class="op" id="6145679">.</span><span class="ident" id="6145680">Body</span><span class="op" id="6145684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145688">if</span>&nbsp;<span class="ident" id="6145691">err</span>&nbsp;<span class="op" id="6145695">!=</span>&nbsp;<span class="ident" id="6145698">nil</span>&nbsp;<span class="op" id="6145702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145707">return</span>&nbsp;<span class="ident" id="6145714">nil</span><span class="op" id="6145717">,</span>&nbsp;<span class="ident" id="6145719">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6145725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6145728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145732">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145802">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145863">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145926">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145987">reqSend</span>&nbsp;<span class="op" id="6145995">:=</span>&nbsp;<span class="ident" id="6145998">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146003">if</span>&nbsp;<span class="ident" id="6146006">req</span><span class="op" id="6146009">.</span><span class="ident" id="6146010">URL</span><span class="op" id="6146013">.</span><span class="ident" id="6146014">Scheme</span>&nbsp;<span class="op" id="6146021">==</span>&nbsp;<span class="string" id="6146024">&#34;https&#34;</span>&nbsp;<span class="op" id="6146032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146036">reqSend</span>&nbsp;<span class="op" id="6146044">=</span>&nbsp;<span class="builtinfunc" id="6146046">new</span><span class="op" id="6146049">(</span><span class="ident" id="6146050">http</span><span class="op" id="6146054">.</span><span class="ident" id="6146055">Request</span><span class="op" id="6146062">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146066">*</span><span class="ident" id="6146067">reqSend</span>&nbsp;<span class="op" id="6146075">=</span>&nbsp;<span class="op" id="6146077">*</span><span class="ident" id="6146078">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146084">reqSend</span><span class="op" id="6146091">.</span><span class="ident" id="6146092">URL</span>&nbsp;<span class="op" id="6146096">=</span>&nbsp;<span class="builtinfunc" id="6146098">new</span><span class="op" id="6146101">(</span><span class="ident" id="6146102">url</span><span class="op" id="6146105">.</span><span class="ident" id="6146106">URL</span><span class="op" id="6146109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146113">*</span><span class="ident" id="6146114">reqSend</span><span class="op" id="6146121">.</span><span class="ident" id="6146122">URL</span>&nbsp;<span class="op" id="6146126">=</span>&nbsp;<span class="op" id="6146128">*</span><span class="ident" id="6146129">req</span><span class="op" id="6146132">.</span><span class="ident" id="6146133">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146139">reqSend</span><span class="op" id="6146146">.</span><span class="ident" id="6146147">URL</span><span class="op" id="6146150">.</span><span class="ident" id="6146151">Scheme</span>&nbsp;<span class="op" id="6146158">=</span>&nbsp;<span class="string" id="6146160">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146168">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146172">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146235">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146295">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146353">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146414">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146441">var</span>&nbsp;<span class="ident" id="6146445">buf</span>&nbsp;<span class="ident" id="6146449">bytes</span><span class="op" id="6146454">.</span><span class="ident" id="6146455">Buffer</span>&nbsp;<span class="comment" id="6146462">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146485">pr</span><span class="op" id="6146487">,</span>&nbsp;<span class="ident" id="6146489">pw</span>&nbsp;<span class="op" id="6146492">:=</span>&nbsp;<span class="ident" id="6146495">io</span><span class="op" id="6146497">.</span><span class="ident" id="6146498">Pipe</span><span class="op" id="6146502">(</span><span class="op" id="6146503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146506">defer</span>&nbsp;<span class="ident" id="6146512">pr</span><span class="op" id="6146514">.</span><span class="ident" id="6146515">Close</span><span class="op" id="6146520">(</span><span class="op" id="6146521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146524">defer</span>&nbsp;<span class="ident" id="6146530">pw</span><span class="op" id="6146532">.</span><span class="ident" id="6146533">Close</span><span class="op" id="6146538">(</span><span class="op" id="6146539">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146542">dr</span>&nbsp;<span class="op" id="6146545">:=</span>&nbsp;<span class="op" id="6146548">&amp;</span><span class="ident" id="6146549">delegateReader</span><span class="op" id="6146563">{</span><span class="ident" id="6146564">c</span><span class="op" id="6146565">:</span>&nbsp;<span class="builtinfunc" id="6146567">make</span><span class="op" id="6146571">(</span><span class="keyword" id="6146572">chan</span>&nbsp;<span class="ident" id="6146577">io</span><span class="op" id="6146579">.</span><span class="ident" id="6146580">Reader</span><span class="op" id="6146586">)</span><span class="op" id="6146587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146590">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146654">go</span>&nbsp;<span class="keyword" id="6146657">func</span><span class="op" id="6146661">(</span><span class="op" id="6146662">)</span>&nbsp;<span class="op" id="6146664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146668">req</span><span class="op" id="6146671">,</span>&nbsp;<span class="ident" id="6146673">err</span>&nbsp;<span class="op" id="6146677">:=</span>&nbsp;<span class="ident" id="6146680">http</span><span class="op" id="6146684">.</span><span class="ident" id="6146685">ReadRequest</span><span class="op" id="6146696">(</span><span class="ident" id="6146697">bufio</span><span class="op" id="6146702">.</span><span class="ident" id="6146703">NewReader</span><span class="op" id="6146712">(</span><span class="ident" id="6146713">pr</span><span class="op" id="6146715">)</span><span class="op" id="6146716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146720">if</span>&nbsp;<span class="ident" id="6146723">err</span>&nbsp;<span class="op" id="6146727">==</span>&nbsp;<span class="ident" id="6146730">nil</span>&nbsp;<span class="op" id="6146734">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146739">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146784">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146816">io</span><span class="op" id="6146818">.</span><span class="ident" id="6146819">Copy</span><span class="op" id="6146823">(</span><span class="ident" id="6146824">ioutil</span><span class="op" id="6146830">.</span><span class="ident" id="6146831">Discard</span><span class="op" id="6146838">,</span>&nbsp;<span class="ident" id="6146840">req</span><span class="op" id="6146843">.</span><span class="ident" id="6146844">Body</span><span class="op" id="6146848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146853">req</span><span class="op" id="6146856">.</span><span class="ident" id="6146857">Body</span><span class="op" id="6146861">.</span><span class="ident" id="6146862">Close</span><span class="op" id="6146867">(</span><span class="op" id="6146868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146872">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146876">dr</span><span class="op" id="6146878">.</span><span class="ident" id="6146879">c</span>&nbsp;<span class="op" id="6146881">&lt;-</span>&nbsp;<span class="ident" id="6146884">strings</span><span class="op" id="6146891">.</span><span class="ident" id="6146892">NewReader</span><span class="op" id="6146901">(</span><span class="string" id="6146902">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="6146935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146938">}</span><span class="op" id="6146939">(</span><span class="op" id="6146940">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146944">t</span>&nbsp;<span class="op" id="6146946">:=</span>&nbsp;<span class="op" id="6146949">&amp;</span><span class="ident" id="6146950">http</span><span class="op" id="6146954">.</span><span class="ident" id="6146955">Transport</span><span class="op" id="6146964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146968">DisableKeepAlives</span><span class="op" id="6146985">:</span>&nbsp;<span class="builtintype" id="6146987">true</span><span class="op" id="6146991">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146995">Dial</span><span class="op" id="6146999">:</span>&nbsp;<span class="keyword" id="6147001">func</span><span class="op" id="6147005">(</span><span class="ident" id="6147006">net</span><span class="op" id="6147009">,</span>&nbsp;<span class="ident" id="6147011">addr</span>&nbsp;<span class="builtintype" id="6147016">string</span><span class="op" id="6147022">)</span>&nbsp;<span class="op" id="6147024">(</span><span class="ident" id="6147025">net</span><span class="op" id="6147028">.</span><span class="ident" id="6147029">Conn</span><span class="op" id="6147033">,</span>&nbsp;<span class="builtintype" id="6147035">error</span><span class="op" id="6147040">)</span>&nbsp;<span class="op" id="6147042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147047">return</span>&nbsp;<span class="op" id="6147054">&amp;</span><span class="ident" id="6147055">dumpConn</span><span class="op" id="6147063">{</span><span class="ident" id="6147064">io</span><span class="op" id="6147066">.</span><span class="ident" id="6147067">MultiWriter</span><span class="op" id="6147078">(</span><span class="op" id="6147079">&amp;</span><span class="ident" id="6147080">buf</span><span class="op" id="6147083">,</span>&nbsp;<span class="ident" id="6147085">pw</span><span class="op" id="6147087">)</span><span class="op" id="6147088">,</span>&nbsp;<span class="ident" id="6147090">dr</span><span class="op" id="6147092">}</span><span class="op" id="6147093">,</span>&nbsp;<span class="ident" id="6147095">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147101">}</span><span class="op" id="6147102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147109">_</span><span class="op" id="6147110">,</span>&nbsp;<span class="ident" id="6147112">err</span>&nbsp;<span class="op" id="6147116">:=</span>&nbsp;<span class="ident" id="6147119">t</span><span class="op" id="6147120">.</span><span class="ident" id="6147121">RoundTrip</span><span class="op" id="6147130">(</span><span class="ident" id="6147131">reqSend</span><span class="op" id="6147138">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147142">req</span><span class="op" id="6147145">.</span><span class="ident" id="6147146">Body</span>&nbsp;<span class="op" id="6147151">=</span>&nbsp;<span class="ident" id="6147153">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147159">if</span>&nbsp;<span class="ident" id="6147162">err</span>&nbsp;<span class="op" id="6147166">!=</span>&nbsp;<span class="ident" id="6147169">nil</span>&nbsp;<span class="op" id="6147173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147177">return</span>&nbsp;<span class="ident" id="6147184">nil</span><span class="op" id="6147187">,</span>&nbsp;<span class="ident" id="6147189">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147197">dump</span>&nbsp;<span class="op" id="6147202">:=</span>&nbsp;<span class="ident" id="6147205">buf</span><span class="op" id="6147208">.</span><span class="ident" id="6147209">Bytes</span><span class="op" id="6147214">(</span><span class="op" id="6147215">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6147219">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6147269">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6147333">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6147396">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6147458">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147504">if</span>&nbsp;<span class="ident" id="6147507">dummyBody</span>&nbsp;<span class="op" id="6147517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147521">if</span>&nbsp;<span class="ident" id="6147524">i</span>&nbsp;<span class="op" id="6147526">:=</span>&nbsp;<span class="ident" id="6147529">bytes</span><span class="op" id="6147534">.</span><span class="ident" id="6147535">Index</span><span class="op" id="6147540">(</span><span class="ident" id="6147541">dump</span><span class="op" id="6147545">,</span>&nbsp;<span class="op" id="6147547">[</span><span class="op" id="6147548">]</span><span class="builtintype" id="6147549">byte</span><span class="op" id="6147553">(</span><span class="string" id="6147554">&#34;\r\n\r\n&#34;</span><span class="op" id="6147564">)</span><span class="op" id="6147565">)</span><span class="op" id="6147566">;</span>&nbsp;<span class="ident" id="6147568">i</span>&nbsp;<span class="op" id="6147570">&gt;=</span>&nbsp;<span class="num" id="6147573">0</span>&nbsp;<span class="op" id="6147575">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147580">dump</span>&nbsp;<span class="op" id="6147585">=</span>&nbsp;<span class="ident" id="6147587">dump</span><span class="op" id="6147591">[</span><span class="op" id="6147592">:</span><span class="ident" id="6147593">i</span><span class="op" id="6147594">+</span><span class="num" id="6147595">4</span><span class="op" id="6147596">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147606">return</span>&nbsp;<span class="ident" id="6147613">dump</span><span class="op" id="6147617">,</span>&nbsp;<span class="ident" id="6147619">nil</span><br>
<span class="lineno"></span><span class="op" id="6147623">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="6147626">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="6147690">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="6147723">type</span>&nbsp;<span class="ident" id="6147728">delegateReader</span>&nbsp;<span class="keyword" id="6147743">struct</span>&nbsp;<span class="op" id="6147750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147753">c</span>&nbsp;<span class="keyword" id="6147755">chan</span>&nbsp;<span class="ident" id="6147760">io</span><span class="op" id="6147762">.</span><span class="ident" id="6147763">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147771">r</span>&nbsp;<span class="ident" id="6147773">io</span><span class="op" id="6147775">.</span><span class="ident" id="6147776">Reader</span>&nbsp;<span class="comment" id="6147783">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="6147812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6147815">func</span>&nbsp;<span class="op" id="6147820">(</span><span class="ident" id="6147821">r</span>&nbsp;<span class="op" id="6147823">*</span><span class="ident" id="6147824">delegateReader</span><span class="op" id="6147838">)</span>&nbsp;<span class="ident" id="6147840">Read</span><span class="op" id="6147844">(</span><span class="ident" id="6147845">p</span>&nbsp;<span class="op" id="6147847">[</span><span class="op" id="6147848">]</span><span class="builtintype" id="6147849">byte</span><span class="op" id="6147853">)</span>&nbsp;<span class="op" id="6147855">(</span><span class="builtintype" id="6147856">int</span><span class="op" id="6147859">,</span>&nbsp;<span class="builtintype" id="6147861">error</span><span class="op" id="6147866">)</span>&nbsp;<span class="op" id="6147868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147871">if</span>&nbsp;<span class="ident" id="6147874">r</span><span class="op" id="6147875">.</span><span class="ident" id="6147876">r</span>&nbsp;<span class="op" id="6147878">==</span>&nbsp;<span class="ident" id="6147881">nil</span>&nbsp;<span class="op" id="6147885">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147889">r</span><span class="op" id="6147890">.</span><span class="ident" id="6147891">r</span>&nbsp;<span class="op" id="6147893">=</span>&nbsp;<span class="op" id="6147895">&lt;-</span><span class="ident" id="6147897">r</span><span class="op" id="6147898">.</span><span class="ident" id="6147899">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147905">return</span>&nbsp;<span class="ident" id="6147912">r</span><span class="op" id="6147913">.</span><span class="ident" id="6147914">r</span><span class="op" id="6147915">.</span><span class="ident" id="6147916">Read</span><span class="op" id="6147920">(</span><span class="ident" id="6147921">p</span><span class="op" id="6147922">)</span><br>
<span class="lineno"></span><span class="op" id="6147924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="6147927">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="6147971">func</span>&nbsp;<span class="ident" id="6147976">valueOrDefault</span><span class="op" id="6147990">(</span><span class="ident" id="6147991">value</span><span class="op" id="6147996">,</span>&nbsp;<span class="ident" id="6147998">def</span>&nbsp;<span class="builtintype" id="6148002">string</span><span class="op" id="6148008">)</span>&nbsp;<span class="builtintype" id="6148010">string</span>&nbsp;<span class="op" id="6148017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6148020">if</span>&nbsp;<span class="ident" id="6148023">value</span>&nbsp;<span class="op" id="6148029">!=</span>&nbsp;<span class="string" id="6148032">&#34;&#34;</span>&nbsp;<span class="op" id="6148035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6148039">return</span>&nbsp;<span class="ident" id="6148046">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6148053">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6148056">return</span>&nbsp;<span class="ident" id="6148063">def</span><br>
<span class="lineno"></span><span class="op" id="6148067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6148070">var</span>&nbsp;<span class="ident" id="6148074">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="6148100">=</span>&nbsp;<span class="keyword" id="6148102">map</span><span class="op" id="6148105">[</span><span class="builtintype" id="6148106">string</span><span class="op" id="6148112">]</span><span class="builtintype" id="6148113">bool</span><span class="op" id="6148117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6148120">&#34;Host&#34;</span><span class="op" id="6148126">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6148141">true</span><span class="op" id="6148145">,</span>&nbsp;<span class="comment" id="6148147">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6148176">&#34;Content-Length&#34;</span><span class="op" id="6148192">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6148197">true</span><span class="op" id="6148201">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6148204">&#34;Transfer-Encoding&#34;</span><span class="op" id="6148223">:</span>&nbsp;<span class="builtintype" id="6148225">true</span><span class="op" id="6148229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6148232">&#34;Trailer&#34;</span><span class="op" id="6148241">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6148253">true</span><span class="op" id="6148257">,</span><br>
<span class="lineno"></span><span class="op" id="6148259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6148262">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6148331">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6148402">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="6148418">func</span>&nbsp;<span class="ident" id="6148423">dumpAsReceived</span><span class="op" id="6148437">(</span><span class="ident" id="6148438">req</span>&nbsp;<span class="op" id="6148442">*</span><span class="ident" id="6148443">http</span><span class="op" id="6148447">.</span><span class="ident" id="6148448">Request</span><span class="op" id="6148455">,</span>&nbsp;<span class="ident" id="6148457">w</span>&nbsp;<span class="ident" id="6148459">io</span><span class="op" id="6148461">.</span><span class="ident" id="6148462">Writer</span><span class="op" id="6148468">)</span>&nbsp;<span class="builtintype" id="6148470">error</span>&nbsp;<span class="op" id="6148476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6148479">return</span>&nbsp;<span class="ident" id="6148486">nil</span><br>
<span class="lineno">175</span><span class="op" id="6148490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6148493">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="6148560">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="6148617">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="6148673">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6148730">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="6148782">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="6148847">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="6148867">func</span>&nbsp;<span class="ident" id="6148872">DumpRequest</span><span class="op" id="6148883">(</span><span class="ident" id="6148884">req</span>&nbsp;<span class="op" id="6148888">*</span><span class="ident" id="6148889">http</span><span class="op" id="6148893">.</span><span class="ident" id="6148894">Request</span><span class="op" id="6148901">,</span>&nbsp;<span class="ident" id="6148903">body</span>&nbsp;<span class="builtintype" id="6148908">bool</span><span class="op" id="6148912">)</span>&nbsp;<span class="op" id="6148914">(</span><span class="ident" id="6148915">dump</span>&nbsp;<span class="op" id="6148920">[</span><span class="op" id="6148921">]</span><span class="builtintype" id="6148922">byte</span><span class="op" id="6148926">,</span>&nbsp;<span class="ident" id="6148928">err</span>&nbsp;<span class="builtintype" id="6148932">error</span><span class="op" id="6148937">)</span>&nbsp;<span class="op" id="6148939">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6148942">save</span>&nbsp;<span class="op" id="6148947">:=</span>&nbsp;<span class="ident" id="6148950">req</span><span class="op" id="6148953">.</span><span class="ident" id="6148954">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6148960">if</span>&nbsp;<span class="op" id="6148963">!</span><span class="ident" id="6148964">body</span>&nbsp;<span class="op" id="6148969">||</span>&nbsp;<span class="ident" id="6148972">req</span><span class="op" id="6148975">.</span><span class="ident" id="6148976">Body</span>&nbsp;<span class="op" id="6148981">==</span>&nbsp;<span class="ident" id="6148984">nil</span>&nbsp;<span class="op" id="6148988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6148992">req</span><span class="op" id="6148995">.</span><span class="ident" id="6148996">Body</span>&nbsp;<span class="op" id="6149001">=</span>&nbsp;<span class="ident" id="6149003">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149008">}</span>&nbsp;<span class="keyword" id="6149010">else</span>&nbsp;<span class="op" id="6149015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149019">save</span><span class="op" id="6149023">,</span>&nbsp;<span class="ident" id="6149025">req</span><span class="op" id="6149028">.</span><span class="ident" id="6149029">Body</span><span class="op" id="6149033">,</span>&nbsp;<span class="ident" id="6149035">err</span>&nbsp;<span class="op" id="6149039">=</span>&nbsp;<span class="ident" id="6149041">drainBody</span><span class="op" id="6149050">(</span><span class="ident" id="6149051">req</span><span class="op" id="6149054">.</span><span class="ident" id="6149055">Body</span><span class="op" id="6149059">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149063">if</span>&nbsp;<span class="ident" id="6149066">err</span>&nbsp;<span class="op" id="6149070">!=</span>&nbsp;<span class="ident" id="6149073">nil</span>&nbsp;<span class="op" id="6149077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149082">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149098">var</span>&nbsp;<span class="ident" id="6149102">b</span>&nbsp;<span class="ident" id="6149104">bytes</span><span class="op" id="6149109">.</span><span class="ident" id="6149110">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149119">fmt</span><span class="op" id="6149122">.</span><span class="ident" id="6149123">Fprintf</span><span class="op" id="6149130">(</span><span class="op" id="6149131">&amp;</span><span class="ident" id="6149132">b</span><span class="op" id="6149133">,</span>&nbsp;<span class="string" id="6149135">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="6149157">,</span>&nbsp;<span class="ident" id="6149159">valueOrDefault</span><span class="op" id="6149173">(</span><span class="ident" id="6149174">req</span><span class="op" id="6149177">.</span><span class="ident" id="6149178">Method</span><span class="op" id="6149184">,</span>&nbsp;<span class="string" id="6149186">&#34;GET&#34;</span><span class="op" id="6149191">)</span><span class="op" id="6149192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149196">req</span><span class="op" id="6149199">.</span><span class="ident" id="6149200">URL</span><span class="op" id="6149203">.</span><span class="ident" id="6149204">RequestURI</span><span class="op" id="6149214">(</span><span class="op" id="6149215">)</span><span class="op" id="6149216">,</span>&nbsp;<span class="ident" id="6149218">req</span><span class="op" id="6149221">.</span><span class="ident" id="6149222">ProtoMajor</span><span class="op" id="6149232">,</span>&nbsp;<span class="ident" id="6149234">req</span><span class="op" id="6149237">.</span><span class="ident" id="6149238">ProtoMinor</span><span class="op" id="6149248">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149252">host</span>&nbsp;<span class="op" id="6149257">:=</span>&nbsp;<span class="ident" id="6149260">req</span><span class="op" id="6149263">.</span><span class="ident" id="6149264">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149270">if</span>&nbsp;<span class="ident" id="6149273">host</span>&nbsp;<span class="op" id="6149278">==</span>&nbsp;<span class="string" id="6149281">&#34;&#34;</span>&nbsp;<span class="op" id="6149284">&amp;&amp;</span>&nbsp;<span class="ident" id="6149287">req</span><span class="op" id="6149290">.</span><span class="ident" id="6149291">URL</span>&nbsp;<span class="op" id="6149295">!=</span>&nbsp;<span class="ident" id="6149298">nil</span>&nbsp;<span class="op" id="6149302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149306">host</span>&nbsp;<span class="op" id="6149311">=</span>&nbsp;<span class="ident" id="6149313">req</span><span class="op" id="6149316">.</span><span class="ident" id="6149317">URL</span><span class="op" id="6149320">.</span><span class="ident" id="6149321">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149330">if</span>&nbsp;<span class="ident" id="6149333">host</span>&nbsp;<span class="op" id="6149338">!=</span>&nbsp;<span class="string" id="6149341">&#34;&#34;</span>&nbsp;<span class="op" id="6149344">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149348">fmt</span><span class="op" id="6149351">.</span><span class="ident" id="6149352">Fprintf</span><span class="op" id="6149359">(</span><span class="op" id="6149360">&amp;</span><span class="ident" id="6149361">b</span><span class="op" id="6149362">,</span>&nbsp;<span class="string" id="6149364">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="6149378">,</span>&nbsp;<span class="ident" id="6149380">host</span><span class="op" id="6149384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149391">chunked</span>&nbsp;<span class="op" id="6149399">:=</span>&nbsp;<span class="builtinfunc" id="6149402">len</span><span class="op" id="6149405">(</span><span class="ident" id="6149406">req</span><span class="op" id="6149409">.</span><span class="ident" id="6149410">TransferEncoding</span><span class="op" id="6149426">)</span>&nbsp;<span class="op" id="6149428">&gt;</span>&nbsp;<span class="num" id="6149430">0</span>&nbsp;<span class="op" id="6149432">&amp;&amp;</span>&nbsp;<span class="ident" id="6149435">req</span><span class="op" id="6149438">.</span><span class="ident" id="6149439">TransferEncoding</span><span class="op" id="6149455">[</span><span class="num" id="6149456">0</span><span class="op" id="6149457">]</span>&nbsp;<span class="op" id="6149459">==</span>&nbsp;<span class="string" id="6149462">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149473">if</span>&nbsp;<span class="builtinfunc" id="6149476">len</span><span class="op" id="6149479">(</span><span class="ident" id="6149480">req</span><span class="op" id="6149483">.</span><span class="ident" id="6149484">TransferEncoding</span><span class="op" id="6149500">)</span>&nbsp;<span class="op" id="6149502">&gt;</span>&nbsp;<span class="num" id="6149504">0</span>&nbsp;<span class="op" id="6149506">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149510">fmt</span><span class="op" id="6149513">.</span><span class="ident" id="6149514">Fprintf</span><span class="op" id="6149521">(</span><span class="op" id="6149522">&amp;</span><span class="ident" id="6149523">b</span><span class="op" id="6149524">,</span>&nbsp;<span class="string" id="6149526">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="6149553">,</span>&nbsp;<span class="ident" id="6149555">strings</span><span class="op" id="6149562">.</span><span class="ident" id="6149563">Join</span><span class="op" id="6149567">(</span><span class="ident" id="6149568">req</span><span class="op" id="6149571">.</span><span class="ident" id="6149572">TransferEncoding</span><span class="op" id="6149588">,</span>&nbsp;<span class="string" id="6149590">&#34;,&#34;</span><span class="op" id="6149593">)</span><span class="op" id="6149594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149600">if</span>&nbsp;<span class="ident" id="6149603">req</span><span class="op" id="6149606">.</span><span class="ident" id="6149607">Close</span>&nbsp;<span class="op" id="6149613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149617">fmt</span><span class="op" id="6149620">.</span><span class="ident" id="6149621">Fprintf</span><span class="op" id="6149628">(</span><span class="op" id="6149629">&amp;</span><span class="ident" id="6149630">b</span><span class="op" id="6149631">,</span>&nbsp;<span class="string" id="6149633">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="6149656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149659">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149663">err</span>&nbsp;<span class="op" id="6149667">=</span>&nbsp;<span class="ident" id="6149669">req</span><span class="op" id="6149672">.</span><span class="ident" id="6149673">Header</span><span class="op" id="6149679">.</span><span class="ident" id="6149680">WriteSubset</span><span class="op" id="6149691">(</span><span class="op" id="6149692">&amp;</span><span class="ident" id="6149693">b</span><span class="op" id="6149694">,</span>&nbsp;<span class="ident" id="6149696">reqWriteExcludeHeaderDump</span><span class="op" id="6149721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149724">if</span>&nbsp;<span class="ident" id="6149727">err</span>&nbsp;<span class="op" id="6149731">!=</span>&nbsp;<span class="ident" id="6149734">nil</span>&nbsp;<span class="op" id="6149738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149742">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149750">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149754">io</span><span class="op" id="6149756">.</span><span class="ident" id="6149757">WriteString</span><span class="op" id="6149768">(</span><span class="op" id="6149769">&amp;</span><span class="ident" id="6149770">b</span><span class="op" id="6149771">,</span>&nbsp;<span class="string" id="6149773">&#34;\r\n&#34;</span><span class="op" id="6149779">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149783">if</span>&nbsp;<span class="ident" id="6149786">req</span><span class="op" id="6149789">.</span><span class="ident" id="6149790">Body</span>&nbsp;<span class="op" id="6149795">!=</span>&nbsp;<span class="ident" id="6149798">nil</span>&nbsp;<span class="op" id="6149802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149806">var</span>&nbsp;<span class="ident" id="6149810">dest</span>&nbsp;<span class="ident" id="6149815">io</span><span class="op" id="6149817">.</span><span class="ident" id="6149818">Writer</span>&nbsp;<span class="op" id="6149825">=</span>&nbsp;<span class="op" id="6149827">&amp;</span><span class="ident" id="6149828">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149832">if</span>&nbsp;<span class="ident" id="6149835">chunked</span>&nbsp;<span class="op" id="6149843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149848">dest</span>&nbsp;<span class="op" id="6149853">=</span>&nbsp;<span class="ident" id="6149855">NewChunkedWriter</span><span class="op" id="6149871">(</span><span class="ident" id="6149872">dest</span><span class="op" id="6149876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149884">_</span><span class="op" id="6149885">,</span>&nbsp;<span class="ident" id="6149887">err</span>&nbsp;<span class="op" id="6149891">=</span>&nbsp;<span class="ident" id="6149893">io</span><span class="op" id="6149895">.</span><span class="ident" id="6149896">Copy</span><span class="op" id="6149900">(</span><span class="ident" id="6149901">dest</span><span class="op" id="6149905">,</span>&nbsp;<span class="ident" id="6149907">req</span><span class="op" id="6149910">.</span><span class="ident" id="6149911">Body</span><span class="op" id="6149915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6149919">if</span>&nbsp;<span class="ident" id="6149922">chunked</span>&nbsp;<span class="op" id="6149930">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149935">dest</span><span class="op" id="6149939">.</span><span class="op" id="6149940">(</span><span class="ident" id="6149941">io</span><span class="op" id="6149943">.</span><span class="ident" id="6149944">Closer</span><span class="op" id="6149950">)</span><span class="op" id="6149951">.</span><span class="ident" id="6149952">Close</span><span class="op" id="6149957">(</span><span class="op" id="6149958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149963">io</span><span class="op" id="6149965">.</span><span class="ident" id="6149966">WriteString</span><span class="op" id="6149977">(</span><span class="op" id="6149978">&amp;</span><span class="ident" id="6149979">b</span><span class="op" id="6149980">,</span>&nbsp;<span class="string" id="6149982">&#34;\r\n&#34;</span><span class="op" id="6149988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6149995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6149999">req</span><span class="op" id="6150002">.</span><span class="ident" id="6150003">Body</span>&nbsp;<span class="op" id="6150008">=</span>&nbsp;<span class="ident" id="6150010">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6150016">if</span>&nbsp;<span class="ident" id="6150019">err</span>&nbsp;<span class="op" id="6150023">!=</span>&nbsp;<span class="ident" id="6150026">nil</span>&nbsp;<span class="op" id="6150030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6150034">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6150042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6150045">dump</span>&nbsp;<span class="op" id="6150050">=</span>&nbsp;<span class="ident" id="6150052">b</span><span class="op" id="6150053">.</span><span class="ident" id="6150054">Bytes</span><span class="op" id="6150059">(</span><span class="op" id="6150060">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6150063">return</span><br>
<span class="lineno"></span><span class="op" id="6150070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6150073">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="6150155">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="6150197">var</span>&nbsp;<span class="ident" id="6150201">errNoBody</span>&nbsp;<span class="op" id="6150211">=</span>&nbsp;<span class="ident" id="6150213">errors</span><span class="op" id="6150219">.</span><span class="ident" id="6150220">New</span><span class="op" id="6150223">(</span><span class="string" id="6150224">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="6150246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6150249">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6150320">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6150389">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="6150456">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="6150488">type</span>&nbsp;<span class="ident" id="6150493">failureToReadBody</span>&nbsp;<span class="keyword" id="6150511">struct</span><span class="op" id="6150517">{</span><span class="op" id="6150518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6150521">func</span>&nbsp;<span class="op" id="6150526">(</span><span class="ident" id="6150527">failureToReadBody</span><span class="op" id="6150544">)</span>&nbsp;<span class="ident" id="6150546">Read</span><span class="op" id="6150550">(</span><span class="op" id="6150551">[</span><span class="op" id="6150552">]</span><span class="builtintype" id="6150553">byte</span><span class="op" id="6150557">)</span>&nbsp;<span class="op" id="6150559">(</span><span class="builtintype" id="6150560">int</span><span class="op" id="6150563">,</span>&nbsp;<span class="builtintype" id="6150565">error</span><span class="op" id="6150570">)</span>&nbsp;<span class="op" id="6150572">{</span>&nbsp;<span class="keyword" id="6150574">return</span>&nbsp;<span class="num" id="6150581">0</span><span class="op" id="6150582">,</span>&nbsp;<span class="ident" id="6150584">errNoBody</span>&nbsp;<span class="op" id="6150594">}</span><br>
<span class="lineno"></span><span class="keyword" id="6150596">func</span>&nbsp;<span class="op" id="6150601">(</span><span class="ident" id="6150602">failureToReadBody</span><span class="op" id="6150619">)</span>&nbsp;<span class="ident" id="6150621">Close</span><span class="op" id="6150626">(</span><span class="op" id="6150627">)</span>&nbsp;<span class="builtintype" id="6150629">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6150647">{</span>&nbsp;<span class="keyword" id="6150649">return</span>&nbsp;<span class="ident" id="6150656">nil</span>&nbsp;<span class="op" id="6150660">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6150663">var</span>&nbsp;<span class="ident" id="6150667">emptyBody</span>&nbsp;<span class="op" id="6150677">=</span>&nbsp;<span class="ident" id="6150679">ioutil</span><span class="op" id="6150685">.</span><span class="ident" id="6150686">NopCloser</span><span class="op" id="6150695">(</span><span class="ident" id="6150696">strings</span><span class="op" id="6150703">.</span><span class="ident" id="6150704">NewReader</span><span class="op" id="6150713">(</span><span class="string" id="6150714">&#34;&#34;</span><span class="op" id="6150716">)</span><span class="op" id="6150717">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6150720">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6150778">func</span>&nbsp;<span class="ident" id="6150783">DumpResponse</span><span class="op" id="6150795">(</span><span class="ident" id="6150796">resp</span>&nbsp;<span class="op" id="6150801">*</span><span class="ident" id="6150802">http</span><span class="op" id="6150806">.</span><span class="ident" id="6150807">Response</span><span class="op" id="6150815">,</span>&nbsp;<span class="ident" id="6150817">body</span>&nbsp;<span class="builtintype" id="6150822">bool</span><span class="op" id="6150826">)</span>&nbsp;<span class="op" id="6150828">(</span><span class="ident" id="6150829">dump</span>&nbsp;<span class="op" id="6150834">[</span><span class="op" id="6150835">]</span><span class="builtintype" id="6150836">byte</span><span class="op" id="6150840">,</span>&nbsp;<span class="ident" id="6150842">err</span>&nbsp;<span class="builtintype" id="6150846">error</span><span class="op" id="6150851">)</span>&nbsp;<span class="op" id="6150853">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6150856">var</span>&nbsp;<span class="ident" id="6150860">b</span>&nbsp;<span class="ident" id="6150862">bytes</span><span class="op" id="6150867">.</span><span class="ident" id="6150868">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6150876">save</span>&nbsp;<span class="op" id="6150881">:=</span>&nbsp;<span class="ident" id="6150884">resp</span><span class="op" id="6150888">.</span><span class="ident" id="6150889">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6150895">savecl</span>&nbsp;<span class="op" id="6150902">:=</span>&nbsp;<span class="ident" id="6150905">resp</span><span class="op" id="6150909">.</span><span class="ident" id="6150910">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6150926">if</span>&nbsp;<span class="op" id="6150929">!</span><span class="ident" id="6150930">body</span>&nbsp;<span class="op" id="6150935">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6150939">resp</span><span class="op" id="6150943">.</span><span class="ident" id="6150944">Body</span>&nbsp;<span class="op" id="6150949">=</span>&nbsp;<span class="ident" id="6150951">failureToReadBody</span><span class="op" id="6150968">{</span><span class="op" id="6150969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6150972">}</span>&nbsp;<span class="keyword" id="6150974">else</span>&nbsp;<span class="keyword" id="6150979">if</span>&nbsp;<span class="ident" id="6150982">resp</span><span class="op" id="6150986">.</span><span class="ident" id="6150987">Body</span>&nbsp;<span class="op" id="6150992">==</span>&nbsp;<span class="ident" id="6150995">nil</span>&nbsp;<span class="op" id="6150999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6151003">resp</span><span class="op" id="6151007">.</span><span class="ident" id="6151008">Body</span>&nbsp;<span class="op" id="6151013">=</span>&nbsp;<span class="ident" id="6151015">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6151026">}</span>&nbsp;<span class="keyword" id="6151028">else</span>&nbsp;<span class="op" id="6151033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6151037">save</span><span class="op" id="6151041">,</span>&nbsp;<span class="ident" id="6151043">resp</span><span class="op" id="6151047">.</span><span class="ident" id="6151048">Body</span><span class="op" id="6151052">,</span>&nbsp;<span class="ident" id="6151054">err</span>&nbsp;<span class="op" id="6151058">=</span>&nbsp;<span class="ident" id="6151060">drainBody</span><span class="op" id="6151069">(</span><span class="ident" id="6151070">resp</span><span class="op" id="6151074">.</span><span class="ident" id="6151075">Body</span><span class="op" id="6151079">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6151083">if</span>&nbsp;<span class="ident" id="6151086">err</span>&nbsp;<span class="op" id="6151090">!=</span>&nbsp;<span class="ident" id="6151093">nil</span>&nbsp;<span class="op" id="6151097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6151102">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6151111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6151114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6151117">err</span>&nbsp;<span class="op" id="6151121">=</span>&nbsp;<span class="ident" id="6151123">resp</span><span class="op" id="6151127">.</span><span class="ident" id="6151128">Write</span><span class="op" id="6151133">(</span><span class="op" id="6151134">&amp;</span><span class="ident" id="6151135">b</span><span class="op" id="6151136">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6151139">if</span>&nbsp;<span class="ident" id="6151142">err</span>&nbsp;<span class="op" id="6151146">==</span>&nbsp;<span class="ident" id="6151149">errNoBody</span>&nbsp;<span class="op" id="6151159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6151163">err</span>&nbsp;<span class="op" id="6151167">=</span>&nbsp;<span class="ident" id="6151169">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6151174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6151177">resp</span><span class="op" id="6151181">.</span><span class="ident" id="6151182">Body</span>&nbsp;<span class="op" id="6151187">=</span>&nbsp;<span class="ident" id="6151189">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6151195">resp</span><span class="op" id="6151199">.</span><span class="ident" id="6151200">ContentLength</span>&nbsp;<span class="op" id="6151214">=</span>&nbsp;<span class="ident" id="6151216">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6151224">if</span>&nbsp;<span class="ident" id="6151227">err</span>&nbsp;<span class="op" id="6151231">!=</span>&nbsp;<span class="ident" id="6151234">nil</span>&nbsp;<span class="op" id="6151238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6151242">return</span>&nbsp;<span class="ident" id="6151249">nil</span><span class="op" id="6151252">,</span>&nbsp;<span class="ident" id="6151254">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6151259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6151262">return</span>&nbsp;<span class="ident" id="6151269">b</span><span class="op" id="6151270">.</span><span class="ident" id="6151271">Bytes</span><span class="op" id="6151276">(</span><span class="op" id="6151277">)</span><span class="op" id="6151278">,</span>&nbsp;<span class="ident" id="6151280">nil</span><br>
<span class="lineno"></span><span class="op" id="6151284">}</span>
</div>
</body>
</html>
