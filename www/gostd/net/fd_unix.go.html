<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3140270">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3140325">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3140379">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3140430">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3140500">package</span>&nbsp;<span class="ident" id="3140508">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3140513">import</span>&nbsp;<span class="op" id="3140520">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3140523">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3140529">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3140535">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3140546">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3140561">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3140572">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3140579">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3140582">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3140610">type</span>&nbsp;<span class="ident" id="3140615">netFD</span>&nbsp;<span class="keyword" id="3140621">struct</span>&nbsp;<span class="op" id="3140628">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3140631">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140706">fdmu</span>&nbsp;<span class="ident" id="3140711">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3140721">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140747">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3140759">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140764">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3140776">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140781">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3140793">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140798">isConnected</span>&nbsp;<span class="builtintype" id="3140810">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140816">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3140828">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140836">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3140848">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140854">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3140866">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3140873">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140889">pd</span>&nbsp;<span class="ident" id="3140892">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3140901">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3140904">func</span>&nbsp;<span class="ident" id="3140909">sysInit</span><span class="op" id="3140916">(</span><span class="op" id="3140917">)</span>&nbsp;<span class="op" id="3140919">{</span><br>
<span class="lineno"></span><span class="op" id="3140921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3140924">func</span>&nbsp;<span class="ident" id="3140929">dial</span><span class="op" id="3140933">(</span><span class="ident" id="3140934">network</span>&nbsp;<span class="builtintype" id="3140942">string</span><span class="op" id="3140948">,</span>&nbsp;<span class="ident" id="3140950">ra</span>&nbsp;<span class="ident" id="3140953">Addr</span><span class="op" id="3140957">,</span>&nbsp;<span class="ident" id="3140959">dialer</span>&nbsp;<span class="keyword" id="3140966">func</span><span class="op" id="3140970">(</span><span class="ident" id="3140971">time</span><span class="op" id="3140975">.</span><span class="ident" id="3140976">Time</span><span class="op" id="3140980">)</span>&nbsp;<span class="op" id="3140982">(</span><span class="ident" id="3140983">Conn</span><span class="op" id="3140987">,</span>&nbsp;<span class="builtintype" id="3140989">error</span><span class="op" id="3140994">)</span><span class="op" id="3140995">,</span>&nbsp;<span class="ident" id="3140997">deadline</span>&nbsp;<span class="ident" id="3141006">time</span><span class="op" id="3141010">.</span><span class="ident" id="3141011">Time</span><span class="op" id="3141015">)</span>&nbsp;<span class="op" id="3141017">(</span><span class="ident" id="3141018">Conn</span><span class="op" id="3141022">,</span>&nbsp;<span class="builtintype" id="3141024">error</span><span class="op" id="3141029">)</span>&nbsp;<span class="op" id="3141031">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141034">return</span>&nbsp;<span class="ident" id="3141041">dialer</span><span class="op" id="3141047">(</span><span class="ident" id="3141048">deadline</span><span class="op" id="3141056">)</span><br>
<span class="lineno"></span><span class="op" id="3141058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3141061">func</span>&nbsp;<span class="ident" id="3141066">newFD</span><span class="op" id="3141071">(</span><span class="ident" id="3141072">sysfd</span><span class="op" id="3141077">,</span>&nbsp;<span class="ident" id="3141079">family</span><span class="op" id="3141085">,</span>&nbsp;<span class="ident" id="3141087">sotype</span>&nbsp;<span class="builtintype" id="3141094">int</span><span class="op" id="3141097">,</span>&nbsp;<span class="ident" id="3141099">net</span>&nbsp;<span class="builtintype" id="3141103">string</span><span class="op" id="3141109">)</span>&nbsp;<span class="op" id="3141111">(</span><span class="op" id="3141112">*</span><span class="ident" id="3141113">netFD</span><span class="op" id="3141118">,</span>&nbsp;<span class="builtintype" id="3141120">error</span><span class="op" id="3141125">)</span>&nbsp;<span class="op" id="3141127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141130">return</span>&nbsp;<span class="op" id="3141137">&amp;</span><span class="ident" id="3141138">netFD</span><span class="op" id="3141143">{</span><span class="ident" id="3141144">sysfd</span><span class="op" id="3141149">:</span>&nbsp;<span class="ident" id="3141151">sysfd</span><span class="op" id="3141156">,</span>&nbsp;<span class="ident" id="3141158">family</span><span class="op" id="3141164">:</span>&nbsp;<span class="ident" id="3141166">family</span><span class="op" id="3141172">,</span>&nbsp;<span class="ident" id="3141174">sotype</span><span class="op" id="3141180">:</span>&nbsp;<span class="ident" id="3141182">sotype</span><span class="op" id="3141188">,</span>&nbsp;<span class="ident" id="3141190">net</span><span class="op" id="3141193">:</span>&nbsp;<span class="ident" id="3141195">net</span><span class="op" id="3141198">}</span><span class="op" id="3141199">,</span>&nbsp;<span class="ident" id="3141201">nil</span><br>
<span class="lineno">45</span><span class="op" id="3141205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3141208">func</span>&nbsp;<span class="op" id="3141213">(</span><span class="ident" id="3141214">fd</span>&nbsp;<span class="op" id="3141217">*</span><span class="ident" id="3141218">netFD</span><span class="op" id="3141223">)</span>&nbsp;<span class="ident" id="3141225">init</span><span class="op" id="3141229">(</span><span class="op" id="3141230">)</span>&nbsp;<span class="builtintype" id="3141232">error</span>&nbsp;<span class="op" id="3141238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141241">if</span>&nbsp;<span class="ident" id="3141244">err</span>&nbsp;<span class="op" id="3141248">:=</span>&nbsp;<span class="ident" id="3141251">fd</span><span class="op" id="3141253">.</span><span class="ident" id="3141254">pd</span><span class="op" id="3141256">.</span><span class="ident" id="3141257">Init</span><span class="op" id="3141261">(</span><span class="ident" id="3141262">fd</span><span class="op" id="3141264">)</span><span class="op" id="3141265">;</span>&nbsp;<span class="ident" id="3141267">err</span>&nbsp;<span class="op" id="3141271">!=</span>&nbsp;<span class="ident" id="3141274">nil</span>&nbsp;<span class="op" id="3141278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141282">return</span>&nbsp;<span class="ident" id="3141289">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141297">return</span>&nbsp;<span class="ident" id="3141304">nil</span><br>
<span class="lineno"></span><span class="op" id="3141308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3141311">func</span>&nbsp;<span class="op" id="3141316">(</span><span class="ident" id="3141317">fd</span>&nbsp;<span class="op" id="3141320">*</span><span class="ident" id="3141321">netFD</span><span class="op" id="3141326">)</span>&nbsp;<span class="ident" id="3141328">setAddr</span><span class="op" id="3141335">(</span><span class="ident" id="3141336">laddr</span><span class="op" id="3141341">,</span>&nbsp;<span class="ident" id="3141343">raddr</span>&nbsp;<span class="ident" id="3141349">Addr</span><span class="op" id="3141353">)</span>&nbsp;<span class="op" id="3141355">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141358">fd</span><span class="op" id="3141360">.</span><span class="ident" id="3141361">laddr</span>&nbsp;<span class="op" id="3141367">=</span>&nbsp;<span class="ident" id="3141369">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141376">fd</span><span class="op" id="3141378">.</span><span class="ident" id="3141379">raddr</span>&nbsp;<span class="op" id="3141385">=</span>&nbsp;<span class="ident" id="3141387">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141394">runtime</span><span class="op" id="3141401">.</span><span class="ident" id="3141402">SetFinalizer</span><span class="op" id="3141414">(</span><span class="ident" id="3141415">fd</span><span class="op" id="3141417">,</span>&nbsp;<span class="op" id="3141419">(</span><span class="op" id="3141420">*</span><span class="ident" id="3141421">netFD</span><span class="op" id="3141426">)</span><span class="op" id="3141427">.</span><span class="ident" id="3141428">Close</span><span class="op" id="3141433">)</span><br>
<span class="lineno"></span><span class="op" id="3141435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3141438">func</span>&nbsp;<span class="op" id="3141443">(</span><span class="ident" id="3141444">fd</span>&nbsp;<span class="op" id="3141447">*</span><span class="ident" id="3141448">netFD</span><span class="op" id="3141453">)</span>&nbsp;<span class="ident" id="3141455">name</span><span class="op" id="3141459">(</span><span class="op" id="3141460">)</span>&nbsp;<span class="builtintype" id="3141462">string</span>&nbsp;<span class="op" id="3141469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141472">var</span>&nbsp;<span class="ident" id="3141476">ls</span><span class="op" id="3141478">,</span>&nbsp;<span class="ident" id="3141480">rs</span>&nbsp;<span class="builtintype" id="3141483">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141491">if</span>&nbsp;<span class="ident" id="3141494">fd</span><span class="op" id="3141496">.</span><span class="ident" id="3141497">laddr</span>&nbsp;<span class="op" id="3141503">!=</span>&nbsp;<span class="ident" id="3141506">nil</span>&nbsp;<span class="op" id="3141510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141514">ls</span>&nbsp;<span class="op" id="3141517">=</span>&nbsp;<span class="ident" id="3141519">fd</span><span class="op" id="3141521">.</span><span class="ident" id="3141522">laddr</span><span class="op" id="3141527">.</span><span class="ident" id="3141528">String</span><span class="op" id="3141534">(</span><span class="op" id="3141535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141538">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141541">if</span>&nbsp;<span class="ident" id="3141544">fd</span><span class="op" id="3141546">.</span><span class="ident" id="3141547">raddr</span>&nbsp;<span class="op" id="3141553">!=</span>&nbsp;<span class="ident" id="3141556">nil</span>&nbsp;<span class="op" id="3141560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141564">rs</span>&nbsp;<span class="op" id="3141567">=</span>&nbsp;<span class="ident" id="3141569">fd</span><span class="op" id="3141571">.</span><span class="ident" id="3141572">raddr</span><span class="op" id="3141577">.</span><span class="ident" id="3141578">String</span><span class="op" id="3141584">(</span><span class="op" id="3141585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141591">return</span>&nbsp;<span class="ident" id="3141598">fd</span><span class="op" id="3141600">.</span><span class="ident" id="3141601">net</span>&nbsp;<span class="op" id="3141605">+</span>&nbsp;<span class="string" id="3141607">&#34;:&#34;</span>&nbsp;<span class="op" id="3141611">+</span>&nbsp;<span class="ident" id="3141613">ls</span>&nbsp;<span class="op" id="3141616">+</span>&nbsp;<span class="string" id="3141618">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3141623">+</span>&nbsp;<span class="ident" id="3141625">rs</span><br>
<span class="lineno"></span><span class="op" id="3141628">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3141631">func</span>&nbsp;<span class="op" id="3141636">(</span><span class="ident" id="3141637">fd</span>&nbsp;<span class="op" id="3141640">*</span><span class="ident" id="3141641">netFD</span><span class="op" id="3141646">)</span>&nbsp;<span class="ident" id="3141648">connect</span><span class="op" id="3141655">(</span><span class="ident" id="3141656">la</span><span class="op" id="3141658">,</span>&nbsp;<span class="ident" id="3141660">ra</span>&nbsp;<span class="ident" id="3141663">syscall</span><span class="op" id="3141670">.</span><span class="ident" id="3141671">Sockaddr</span><span class="op" id="3141679">,</span>&nbsp;<span class="ident" id="3141681">deadline</span>&nbsp;<span class="ident" id="3141690">time</span><span class="op" id="3141694">.</span><span class="ident" id="3141695">Time</span><span class="op" id="3141699">)</span>&nbsp;<span class="builtintype" id="3141701">error</span>&nbsp;<span class="op" id="3141707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141710">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141753">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141799">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141845">switch</span>&nbsp;<span class="ident" id="3141852">err</span>&nbsp;<span class="op" id="3141856">:=</span>&nbsp;<span class="ident" id="3141859">syscall</span><span class="op" id="3141866">.</span><span class="ident" id="3141867">Connect</span><span class="op" id="3141874">(</span><span class="ident" id="3141875">fd</span><span class="op" id="3141877">.</span><span class="ident" id="3141878">sysfd</span><span class="op" id="3141883">,</span>&nbsp;<span class="ident" id="3141885">ra</span><span class="op" id="3141887">)</span><span class="op" id="3141888">;</span>&nbsp;<span class="ident" id="3141890">err</span>&nbsp;<span class="op" id="3141894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141897">case</span>&nbsp;<span class="ident" id="3141902">syscall</span><span class="op" id="3141909">.</span><span class="ident" id="3141910">EINPROGRESS</span><span class="op" id="3141921">,</span>&nbsp;<span class="ident" id="3141923">syscall</span><span class="op" id="3141930">.</span><span class="ident" id="3141931">EALREADY</span><span class="op" id="3141939">,</span>&nbsp;<span class="ident" id="3141941">syscall</span><span class="op" id="3141948">.</span><span class="ident" id="3141949">EINTR</span><span class="op" id="3141954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141957">case</span>&nbsp;<span class="ident" id="3141962">nil</span><span class="op" id="3141965">,</span>&nbsp;<span class="ident" id="3141967">syscall</span><span class="op" id="3141974">.</span><span class="ident" id="3141975">EISCONN</span><span class="op" id="3141982">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141986">if</span>&nbsp;<span class="op" id="3141989">!</span><span class="ident" id="3141990">deadline</span><span class="op" id="3141998">.</span><span class="ident" id="3141999">IsZero</span><span class="op" id="3142005">(</span><span class="op" id="3142006">)</span>&nbsp;<span class="op" id="3142008">&amp;&amp;</span>&nbsp;<span class="ident" id="3142011">deadline</span><span class="op" id="3142019">.</span><span class="ident" id="3142020">Before</span><span class="op" id="3142026">(</span><span class="ident" id="3142027">time</span><span class="op" id="3142031">.</span><span class="ident" id="3142032">Now</span><span class="op" id="3142035">(</span><span class="op" id="3142036">)</span><span class="op" id="3142037">)</span>&nbsp;<span class="op" id="3142039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142044">return</span>&nbsp;<span class="ident" id="3142051">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142068">if</span>&nbsp;<span class="ident" id="3142071">err</span>&nbsp;<span class="op" id="3142075">:=</span>&nbsp;<span class="ident" id="3142078">fd</span><span class="op" id="3142080">.</span><span class="ident" id="3142081">init</span><span class="op" id="3142085">(</span><span class="op" id="3142086">)</span><span class="op" id="3142087">;</span>&nbsp;<span class="ident" id="3142089">err</span>&nbsp;<span class="op" id="3142093">!=</span>&nbsp;<span class="ident" id="3142096">nil</span>&nbsp;<span class="op" id="3142100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142105">return</span>&nbsp;<span class="ident" id="3142112">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142122">return</span>&nbsp;<span class="ident" id="3142129">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142134">case</span>&nbsp;<span class="ident" id="3142139">syscall</span><span class="op" id="3142146">.</span><span class="ident" id="3142147">EINVAL</span><span class="op" id="3142153">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142157">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142209">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142262">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142316">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142370">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142419">if</span>&nbsp;<span class="ident" id="3142422">runtime</span><span class="op" id="3142429">.</span><span class="ident" id="3142430">GOOS</span>&nbsp;<span class="op" id="3142435">==</span>&nbsp;<span class="string" id="3142438">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3142448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142453">return</span>&nbsp;<span class="ident" id="3142460">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142470">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142483">default</span><span class="op" id="3142490">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142494">return</span>&nbsp;<span class="ident" id="3142501">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142509">if</span>&nbsp;<span class="ident" id="3142512">err</span>&nbsp;<span class="op" id="3142516">:=</span>&nbsp;<span class="ident" id="3142519">fd</span><span class="op" id="3142521">.</span><span class="ident" id="3142522">init</span><span class="op" id="3142526">(</span><span class="op" id="3142527">)</span><span class="op" id="3142528">;</span>&nbsp;<span class="ident" id="3142530">err</span>&nbsp;<span class="op" id="3142534">!=</span>&nbsp;<span class="ident" id="3142537">nil</span>&nbsp;<span class="op" id="3142541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142545">return</span>&nbsp;<span class="ident" id="3142552">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142560">if</span>&nbsp;<span class="op" id="3142563">!</span><span class="ident" id="3142564">deadline</span><span class="op" id="3142572">.</span><span class="ident" id="3142573">IsZero</span><span class="op" id="3142579">(</span><span class="op" id="3142580">)</span>&nbsp;<span class="op" id="3142582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142586">fd</span><span class="op" id="3142588">.</span><span class="ident" id="3142589">setWriteDeadline</span><span class="op" id="3142605">(</span><span class="ident" id="3142606">deadline</span><span class="op" id="3142614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142618">defer</span>&nbsp;<span class="ident" id="3142624">fd</span><span class="op" id="3142626">.</span><span class="ident" id="3142627">setWriteDeadline</span><span class="op" id="3142643">(</span><span class="ident" id="3142644">noDeadline</span><span class="op" id="3142654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142657">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142660">for</span>&nbsp;<span class="op" id="3142664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142668">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142719">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142773">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142821">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142877">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142932">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142985">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3143038">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143052">if</span>&nbsp;<span class="ident" id="3143055">err</span>&nbsp;<span class="op" id="3143059">:=</span>&nbsp;<span class="ident" id="3143062">fd</span><span class="op" id="3143064">.</span><span class="ident" id="3143065">pd</span><span class="op" id="3143067">.</span><span class="ident" id="3143068">WaitWrite</span><span class="op" id="3143077">(</span><span class="op" id="3143078">)</span><span class="op" id="3143079">;</span>&nbsp;<span class="ident" id="3143081">err</span>&nbsp;<span class="op" id="3143085">!=</span>&nbsp;<span class="ident" id="3143088">nil</span>&nbsp;<span class="op" id="3143092">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143097">return</span>&nbsp;<span class="ident" id="3143104">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143114">nerr</span><span class="op" id="3143118">,</span>&nbsp;<span class="ident" id="3143120">err</span>&nbsp;<span class="op" id="3143124">:=</span>&nbsp;<span class="ident" id="3143127">syscall</span><span class="op" id="3143134">.</span><span class="ident" id="3143135">GetsockoptInt</span><span class="op" id="3143148">(</span><span class="ident" id="3143149">fd</span><span class="op" id="3143151">.</span><span class="ident" id="3143152">sysfd</span><span class="op" id="3143157">,</span>&nbsp;<span class="ident" id="3143159">syscall</span><span class="op" id="3143166">.</span><span class="ident" id="3143167">SOL_SOCKET</span><span class="op" id="3143177">,</span>&nbsp;<span class="ident" id="3143179">syscall</span><span class="op" id="3143186">.</span><span class="ident" id="3143187">SO_ERROR</span><span class="op" id="3143195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143199">if</span>&nbsp;<span class="ident" id="3143202">err</span>&nbsp;<span class="op" id="3143206">!=</span>&nbsp;<span class="ident" id="3143209">nil</span>&nbsp;<span class="op" id="3143213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143218">return</span>&nbsp;<span class="ident" id="3143225">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143235">switch</span>&nbsp;<span class="ident" id="3143242">err</span>&nbsp;<span class="op" id="3143246">:=</span>&nbsp;<span class="ident" id="3143249">syscall</span><span class="op" id="3143256">.</span><span class="ident" id="3143257">Errno</span><span class="op" id="3143262">(</span><span class="ident" id="3143263">nerr</span><span class="op" id="3143267">)</span><span class="op" id="3143268">;</span>&nbsp;<span class="ident" id="3143270">err</span>&nbsp;<span class="op" id="3143274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143278">case</span>&nbsp;<span class="ident" id="3143283">syscall</span><span class="op" id="3143290">.</span><span class="ident" id="3143291">EINPROGRESS</span><span class="op" id="3143302">,</span>&nbsp;<span class="ident" id="3143304">syscall</span><span class="op" id="3143311">.</span><span class="ident" id="3143312">EALREADY</span><span class="op" id="3143320">,</span>&nbsp;<span class="ident" id="3143322">syscall</span><span class="op" id="3143329">.</span><span class="ident" id="3143330">EINTR</span><span class="op" id="3143335">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143339">case</span>&nbsp;<span class="ident" id="3143344">syscall</span><span class="op" id="3143351">.</span><span class="ident" id="3143352">Errno</span><span class="op" id="3143357">(</span><span class="num" id="3143358">0</span><span class="op" id="3143359">)</span><span class="op" id="3143360">,</span>&nbsp;<span class="ident" id="3143362">syscall</span><span class="op" id="3143369">.</span><span class="ident" id="3143370">EISCONN</span><span class="op" id="3143377">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143382">return</span>&nbsp;<span class="ident" id="3143389">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143395">default</span><span class="op" id="3143402">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143407">return</span>&nbsp;<span class="ident" id="3143414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143423">}</span><br>
<span class="lineno"></span><span class="op" id="3143425">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3143428">func</span>&nbsp;<span class="op" id="3143433">(</span><span class="ident" id="3143434">fd</span>&nbsp;<span class="op" id="3143437">*</span><span class="ident" id="3143438">netFD</span><span class="op" id="3143443">)</span>&nbsp;<span class="ident" id="3143445">destroy</span><span class="op" id="3143452">(</span><span class="op" id="3143453">)</span>&nbsp;<span class="op" id="3143455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3143458">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3143532">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143581">fd</span><span class="op" id="3143583">.</span><span class="ident" id="3143584">pd</span><span class="op" id="3143586">.</span><span class="ident" id="3143587">Close</span><span class="op" id="3143592">(</span><span class="op" id="3143593">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143596">closesocket</span><span class="op" id="3143607">(</span><span class="ident" id="3143608">fd</span><span class="op" id="3143610">.</span><span class="ident" id="3143611">sysfd</span><span class="op" id="3143616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143619">fd</span><span class="op" id="3143621">.</span><span class="ident" id="3143622">sysfd</span>&nbsp;<span class="op" id="3143628">=</span>&nbsp;<span class="op" id="3143630">-</span><span class="num" id="3143631">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143634">runtime</span><span class="op" id="3143641">.</span><span class="ident" id="3143642">SetFinalizer</span><span class="op" id="3143654">(</span><span class="ident" id="3143655">fd</span><span class="op" id="3143657">,</span>&nbsp;<span class="ident" id="3143659">nil</span><span class="op" id="3143662">)</span><br>
<span class="lineno"></span><span class="op" id="3143664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3143667">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3143698">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3143744">func</span>&nbsp;<span class="op" id="3143749">(</span><span class="ident" id="3143750">fd</span>&nbsp;<span class="op" id="3143753">*</span><span class="ident" id="3143754">netFD</span><span class="op" id="3143759">)</span>&nbsp;<span class="ident" id="3143761">incref</span><span class="op" id="3143767">(</span><span class="op" id="3143768">)</span>&nbsp;<span class="builtintype" id="3143770">error</span>&nbsp;<span class="op" id="3143776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143779">if</span>&nbsp;<span class="op" id="3143782">!</span><span class="ident" id="3143783">fd</span><span class="op" id="3143785">.</span><span class="ident" id="3143786">fdmu</span><span class="op" id="3143790">.</span><span class="ident" id="3143791">Incref</span><span class="op" id="3143797">(</span><span class="op" id="3143798">)</span>&nbsp;<span class="op" id="3143800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143804">return</span>&nbsp;<span class="ident" id="3143811">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143826">return</span>&nbsp;<span class="ident" id="3143833">nil</span><br>
<span class="lineno"></span><span class="op" id="3143837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3143840">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3143912">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3143951">func</span>&nbsp;<span class="op" id="3143956">(</span><span class="ident" id="3143957">fd</span>&nbsp;<span class="op" id="3143960">*</span><span class="ident" id="3143961">netFD</span><span class="op" id="3143966">)</span>&nbsp;<span class="ident" id="3143968">decref</span><span class="op" id="3143974">(</span><span class="op" id="3143975">)</span>&nbsp;<span class="op" id="3143977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143980">if</span>&nbsp;<span class="ident" id="3143983">fd</span><span class="op" id="3143985">.</span><span class="ident" id="3143986">fdmu</span><span class="op" id="3143990">.</span><span class="ident" id="3143991">Decref</span><span class="op" id="3143997">(</span><span class="op" id="3143998">)</span>&nbsp;<span class="op" id="3144000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144004">fd</span><span class="op" id="3144006">.</span><span class="ident" id="3144007">destroy</span><span class="op" id="3144014">(</span><span class="op" id="3144015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144018">}</span><br>
<span class="lineno">155</span><span class="op" id="3144020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3144023">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3144075">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3144121">func</span>&nbsp;<span class="op" id="3144126">(</span><span class="ident" id="3144127">fd</span>&nbsp;<span class="op" id="3144130">*</span><span class="ident" id="3144131">netFD</span><span class="op" id="3144136">)</span>&nbsp;<span class="ident" id="3144138">readLock</span><span class="op" id="3144146">(</span><span class="op" id="3144147">)</span>&nbsp;<span class="builtintype" id="3144149">error</span>&nbsp;<span class="op" id="3144155">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144158">if</span>&nbsp;<span class="op" id="3144161">!</span><span class="ident" id="3144162">fd</span><span class="op" id="3144164">.</span><span class="ident" id="3144165">fdmu</span><span class="op" id="3144169">.</span><span class="ident" id="3144170">RWLock</span><span class="op" id="3144176">(</span><span class="builtintype" id="3144177">true</span><span class="op" id="3144181">)</span>&nbsp;<span class="op" id="3144183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144187">return</span>&nbsp;<span class="ident" id="3144194">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144209">return</span>&nbsp;<span class="ident" id="3144216">nil</span><br>
<span class="lineno"></span><span class="op" id="3144220">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3144223">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3144280">func</span>&nbsp;<span class="op" id="3144285">(</span><span class="ident" id="3144286">fd</span>&nbsp;<span class="op" id="3144289">*</span><span class="ident" id="3144290">netFD</span><span class="op" id="3144295">)</span>&nbsp;<span class="ident" id="3144297">readUnlock</span><span class="op" id="3144307">(</span><span class="op" id="3144308">)</span>&nbsp;<span class="op" id="3144310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144313">if</span>&nbsp;<span class="ident" id="3144316">fd</span><span class="op" id="3144318">.</span><span class="ident" id="3144319">fdmu</span><span class="op" id="3144323">.</span><span class="ident" id="3144324">RWUnlock</span><span class="op" id="3144332">(</span><span class="builtintype" id="3144333">true</span><span class="op" id="3144337">)</span>&nbsp;<span class="op" id="3144339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144343">fd</span><span class="op" id="3144345">.</span><span class="ident" id="3144346">destroy</span><span class="op" id="3144353">(</span><span class="op" id="3144354">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144357">}</span><br>
<span class="lineno"></span><span class="op" id="3144359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3144362">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3144414">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3144460">func</span>&nbsp;<span class="op" id="3144465">(</span><span class="ident" id="3144466">fd</span>&nbsp;<span class="op" id="3144469">*</span><span class="ident" id="3144470">netFD</span><span class="op" id="3144475">)</span>&nbsp;<span class="ident" id="3144477">writeLock</span><span class="op" id="3144486">(</span><span class="op" id="3144487">)</span>&nbsp;<span class="builtintype" id="3144489">error</span>&nbsp;<span class="op" id="3144495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144498">if</span>&nbsp;<span class="op" id="3144501">!</span><span class="ident" id="3144502">fd</span><span class="op" id="3144504">.</span><span class="ident" id="3144505">fdmu</span><span class="op" id="3144509">.</span><span class="ident" id="3144510">RWLock</span><span class="op" id="3144516">(</span><span class="builtintype" id="3144517">false</span><span class="op" id="3144522">)</span>&nbsp;<span class="op" id="3144524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144528">return</span>&nbsp;<span class="ident" id="3144535">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144550">return</span>&nbsp;<span class="ident" id="3144557">nil</span><br>
<span class="lineno">180</span><span class="op" id="3144561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3144564">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3144621">func</span>&nbsp;<span class="op" id="3144626">(</span><span class="ident" id="3144627">fd</span>&nbsp;<span class="op" id="3144630">*</span><span class="ident" id="3144631">netFD</span><span class="op" id="3144636">)</span>&nbsp;<span class="ident" id="3144638">writeUnlock</span><span class="op" id="3144649">(</span><span class="op" id="3144650">)</span>&nbsp;<span class="op" id="3144652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144655">if</span>&nbsp;<span class="ident" id="3144658">fd</span><span class="op" id="3144660">.</span><span class="ident" id="3144661">fdmu</span><span class="op" id="3144665">.</span><span class="ident" id="3144666">RWUnlock</span><span class="op" id="3144674">(</span><span class="builtintype" id="3144675">false</span><span class="op" id="3144680">)</span>&nbsp;<span class="op" id="3144682">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144686">fd</span><span class="op" id="3144688">.</span><span class="ident" id="3144689">destroy</span><span class="op" id="3144696">(</span><span class="op" id="3144697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144700">}</span><br>
<span class="lineno"></span><span class="op" id="3144702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3144705">func</span>&nbsp;<span class="op" id="3144710">(</span><span class="ident" id="3144711">fd</span>&nbsp;<span class="op" id="3144714">*</span><span class="ident" id="3144715">netFD</span><span class="op" id="3144720">)</span>&nbsp;<span class="ident" id="3144722">Close</span><span class="op" id="3144727">(</span><span class="op" id="3144728">)</span>&nbsp;<span class="builtintype" id="3144730">error</span>&nbsp;<span class="op" id="3144736">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144739">fd</span><span class="op" id="3144741">.</span><span class="ident" id="3144742">pd</span><span class="op" id="3144744">.</span><span class="ident" id="3144745">Lock</span><span class="op" id="3144749">(</span><span class="op" id="3144750">)</span>&nbsp;<span class="comment" id="3144752">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144807">if</span>&nbsp;<span class="op" id="3144810">!</span><span class="ident" id="3144811">fd</span><span class="op" id="3144813">.</span><span class="ident" id="3144814">fdmu</span><span class="op" id="3144818">.</span><span class="ident" id="3144819">IncrefAndClose</span><span class="op" id="3144833">(</span><span class="op" id="3144834">)</span>&nbsp;<span class="op" id="3144836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144840">fd</span><span class="op" id="3144842">.</span><span class="ident" id="3144843">pd</span><span class="op" id="3144845">.</span><span class="ident" id="3144846">Unlock</span><span class="op" id="3144852">(</span><span class="op" id="3144853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144857">return</span>&nbsp;<span class="ident" id="3144864">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144876">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3144879">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3144935">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3144991">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3145053">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3145116">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145178">doWakeup</span>&nbsp;<span class="op" id="3145187">:=</span>&nbsp;<span class="ident" id="3145190">fd</span><span class="op" id="3145192">.</span><span class="ident" id="3145193">pd</span><span class="op" id="3145195">.</span><span class="ident" id="3145196">Evict</span><span class="op" id="3145201">(</span><span class="op" id="3145202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145205">fd</span><span class="op" id="3145207">.</span><span class="ident" id="3145208">pd</span><span class="op" id="3145210">.</span><span class="ident" id="3145211">Unlock</span><span class="op" id="3145217">(</span><span class="op" id="3145218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145221">fd</span><span class="op" id="3145223">.</span><span class="ident" id="3145224">decref</span><span class="op" id="3145230">(</span><span class="op" id="3145231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145234">if</span>&nbsp;<span class="ident" id="3145237">doWakeup</span>&nbsp;<span class="op" id="3145246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145250">fd</span><span class="op" id="3145252">.</span><span class="ident" id="3145253">pd</span><span class="op" id="3145255">.</span><span class="ident" id="3145256">Wakeup</span><span class="op" id="3145262">(</span><span class="op" id="3145263">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145269">return</span>&nbsp;<span class="ident" id="3145276">nil</span><br>
<span class="lineno"></span><span class="op" id="3145280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3145283">func</span>&nbsp;<span class="op" id="3145288">(</span><span class="ident" id="3145289">fd</span>&nbsp;<span class="op" id="3145292">*</span><span class="ident" id="3145293">netFD</span><span class="op" id="3145298">)</span>&nbsp;<span class="ident" id="3145300">shutdown</span><span class="op" id="3145308">(</span><span class="ident" id="3145309">how</span>&nbsp;<span class="builtintype" id="3145313">int</span><span class="op" id="3145316">)</span>&nbsp;<span class="builtintype" id="3145318">error</span>&nbsp;<span class="op" id="3145324">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145327">if</span>&nbsp;<span class="ident" id="3145330">err</span>&nbsp;<span class="op" id="3145334">:=</span>&nbsp;<span class="ident" id="3145337">fd</span><span class="op" id="3145339">.</span><span class="ident" id="3145340">incref</span><span class="op" id="3145346">(</span><span class="op" id="3145347">)</span><span class="op" id="3145348">;</span>&nbsp;<span class="ident" id="3145350">err</span>&nbsp;<span class="op" id="3145354">!=</span>&nbsp;<span class="ident" id="3145357">nil</span>&nbsp;<span class="op" id="3145361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145365">return</span>&nbsp;<span class="ident" id="3145372">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145380">defer</span>&nbsp;<span class="ident" id="3145386">fd</span><span class="op" id="3145388">.</span><span class="ident" id="3145389">decref</span><span class="op" id="3145395">(</span><span class="op" id="3145396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145399">err</span>&nbsp;<span class="op" id="3145403">:=</span>&nbsp;<span class="ident" id="3145406">syscall</span><span class="op" id="3145413">.</span><span class="ident" id="3145414">Shutdown</span><span class="op" id="3145422">(</span><span class="ident" id="3145423">fd</span><span class="op" id="3145425">.</span><span class="ident" id="3145426">sysfd</span><span class="op" id="3145431">,</span>&nbsp;<span class="ident" id="3145433">how</span><span class="op" id="3145436">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145439">if</span>&nbsp;<span class="ident" id="3145442">err</span>&nbsp;<span class="op" id="3145446">!=</span>&nbsp;<span class="ident" id="3145449">nil</span>&nbsp;<span class="op" id="3145453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145457">return</span>&nbsp;<span class="op" id="3145464">&amp;</span><span class="ident" id="3145465">OpError</span><span class="op" id="3145472">{</span><span class="string" id="3145473">&#34;shutdown&#34;</span><span class="op" id="3145483">,</span>&nbsp;<span class="ident" id="3145485">fd</span><span class="op" id="3145487">.</span><span class="ident" id="3145488">net</span><span class="op" id="3145491">,</span>&nbsp;<span class="ident" id="3145493">fd</span><span class="op" id="3145495">.</span><span class="ident" id="3145496">laddr</span><span class="op" id="3145501">,</span>&nbsp;<span class="ident" id="3145503">err</span><span class="op" id="3145506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145512">return</span>&nbsp;<span class="ident" id="3145519">nil</span><br>
<span class="lineno"></span><span class="op" id="3145523">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3145526">func</span>&nbsp;<span class="op" id="3145531">(</span><span class="ident" id="3145532">fd</span>&nbsp;<span class="op" id="3145535">*</span><span class="ident" id="3145536">netFD</span><span class="op" id="3145541">)</span>&nbsp;<span class="ident" id="3145543">closeRead</span><span class="op" id="3145552">(</span><span class="op" id="3145553">)</span>&nbsp;<span class="builtintype" id="3145555">error</span>&nbsp;<span class="op" id="3145561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145564">return</span>&nbsp;<span class="ident" id="3145571">fd</span><span class="op" id="3145573">.</span><span class="ident" id="3145574">shutdown</span><span class="op" id="3145582">(</span><span class="ident" id="3145583">syscall</span><span class="op" id="3145590">.</span><span class="ident" id="3145591">SHUT_RD</span><span class="op" id="3145598">)</span><br>
<span class="lineno"></span><span class="op" id="3145600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3145603">func</span>&nbsp;<span class="op" id="3145608">(</span><span class="ident" id="3145609">fd</span>&nbsp;<span class="op" id="3145612">*</span><span class="ident" id="3145613">netFD</span><span class="op" id="3145618">)</span>&nbsp;<span class="ident" id="3145620">closeWrite</span><span class="op" id="3145630">(</span><span class="op" id="3145631">)</span>&nbsp;<span class="builtintype" id="3145633">error</span>&nbsp;<span class="op" id="3145639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145642">return</span>&nbsp;<span class="ident" id="3145649">fd</span><span class="op" id="3145651">.</span><span class="ident" id="3145652">shutdown</span><span class="op" id="3145660">(</span><span class="ident" id="3145661">syscall</span><span class="op" id="3145668">.</span><span class="ident" id="3145669">SHUT_WR</span><span class="op" id="3145676">)</span><br>
<span class="lineno"></span><span class="op" id="3145678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3145681">func</span>&nbsp;<span class="op" id="3145686">(</span><span class="ident" id="3145687">fd</span>&nbsp;<span class="op" id="3145690">*</span><span class="ident" id="3145691">netFD</span><span class="op" id="3145696">)</span>&nbsp;<span class="ident" id="3145698">Read</span><span class="op" id="3145702">(</span><span class="ident" id="3145703">p</span>&nbsp;<span class="op" id="3145705">[</span><span class="op" id="3145706">]</span><span class="builtintype" id="3145707">byte</span><span class="op" id="3145711">)</span>&nbsp;<span class="op" id="3145713">(</span><span class="ident" id="3145714">n</span>&nbsp;<span class="builtintype" id="3145716">int</span><span class="op" id="3145719">,</span>&nbsp;<span class="ident" id="3145721">err</span>&nbsp;<span class="builtintype" id="3145725">error</span><span class="op" id="3145730">)</span>&nbsp;<span class="op" id="3145732">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145735">if</span>&nbsp;<span class="ident" id="3145738">err</span>&nbsp;<span class="op" id="3145742">:=</span>&nbsp;<span class="ident" id="3145745">fd</span><span class="op" id="3145747">.</span><span class="ident" id="3145748">readLock</span><span class="op" id="3145756">(</span><span class="op" id="3145757">)</span><span class="op" id="3145758">;</span>&nbsp;<span class="ident" id="3145760">err</span>&nbsp;<span class="op" id="3145764">!=</span>&nbsp;<span class="ident" id="3145767">nil</span>&nbsp;<span class="op" id="3145771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145775">return</span>&nbsp;<span class="num" id="3145782">0</span><span class="op" id="3145783">,</span>&nbsp;<span class="ident" id="3145785">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145793">defer</span>&nbsp;<span class="ident" id="3145799">fd</span><span class="op" id="3145801">.</span><span class="ident" id="3145802">readUnlock</span><span class="op" id="3145812">(</span><span class="op" id="3145813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145816">if</span>&nbsp;<span class="ident" id="3145819">err</span>&nbsp;<span class="op" id="3145823">:=</span>&nbsp;<span class="ident" id="3145826">fd</span><span class="op" id="3145828">.</span><span class="ident" id="3145829">pd</span><span class="op" id="3145831">.</span><span class="ident" id="3145832">PrepareRead</span><span class="op" id="3145843">(</span><span class="op" id="3145844">)</span><span class="op" id="3145845">;</span>&nbsp;<span class="ident" id="3145847">err</span>&nbsp;<span class="op" id="3145851">!=</span>&nbsp;<span class="ident" id="3145854">nil</span>&nbsp;<span class="op" id="3145858">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145862">return</span>&nbsp;<span class="num" id="3145869">0</span><span class="op" id="3145870">,</span>&nbsp;<span class="op" id="3145872">&amp;</span><span class="ident" id="3145873">OpError</span><span class="op" id="3145880">{</span><span class="string" id="3145881">&#34;read&#34;</span><span class="op" id="3145887">,</span>&nbsp;<span class="ident" id="3145889">fd</span><span class="op" id="3145891">.</span><span class="ident" id="3145892">net</span><span class="op" id="3145895">,</span>&nbsp;<span class="ident" id="3145897">fd</span><span class="op" id="3145899">.</span><span class="ident" id="3145900">raddr</span><span class="op" id="3145905">,</span>&nbsp;<span class="ident" id="3145907">err</span><span class="op" id="3145910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145916">for</span>&nbsp;<span class="op" id="3145920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145924">n</span><span class="op" id="3145925">,</span>&nbsp;<span class="ident" id="3145927">err</span>&nbsp;<span class="op" id="3145931">=</span>&nbsp;<span class="ident" id="3145933">syscall</span><span class="op" id="3145940">.</span><span class="ident" id="3145941">Read</span><span class="op" id="3145945">(</span><span class="builtintype" id="3145946">int</span><span class="op" id="3145949">(</span><span class="ident" id="3145950">fd</span><span class="op" id="3145952">.</span><span class="ident" id="3145953">sysfd</span><span class="op" id="3145958">)</span><span class="op" id="3145959">,</span>&nbsp;<span class="ident" id="3145961">p</span><span class="op" id="3145962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145966">if</span>&nbsp;<span class="ident" id="3145969">err</span>&nbsp;<span class="op" id="3145973">!=</span>&nbsp;<span class="ident" id="3145976">nil</span>&nbsp;<span class="op" id="3145980">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145985">n</span>&nbsp;<span class="op" id="3145987">=</span>&nbsp;<span class="num" id="3145989">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145994">if</span>&nbsp;<span class="ident" id="3145997">err</span>&nbsp;<span class="op" id="3146001">==</span>&nbsp;<span class="ident" id="3146004">syscall</span><span class="op" id="3146011">.</span><span class="ident" id="3146012">EAGAIN</span>&nbsp;<span class="op" id="3146019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146025">if</span>&nbsp;<span class="ident" id="3146028">err</span>&nbsp;<span class="op" id="3146032">=</span>&nbsp;<span class="ident" id="3146034">fd</span><span class="op" id="3146036">.</span><span class="ident" id="3146037">pd</span><span class="op" id="3146039">.</span><span class="ident" id="3146040">WaitRead</span><span class="op" id="3146048">(</span><span class="op" id="3146049">)</span><span class="op" id="3146050">;</span>&nbsp;<span class="ident" id="3146052">err</span>&nbsp;<span class="op" id="3146056">==</span>&nbsp;<span class="ident" id="3146059">nil</span>&nbsp;<span class="op" id="3146063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146070">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146083">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146096">err</span>&nbsp;<span class="op" id="3146100">=</span>&nbsp;<span class="ident" id="3146102">chkReadErr</span><span class="op" id="3146112">(</span><span class="ident" id="3146113">n</span><span class="op" id="3146114">,</span>&nbsp;<span class="ident" id="3146116">err</span><span class="op" id="3146119">,</span>&nbsp;<span class="ident" id="3146121">fd</span><span class="op" id="3146123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146127">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146134">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146137">if</span>&nbsp;<span class="ident" id="3146140">err</span>&nbsp;<span class="op" id="3146144">!=</span>&nbsp;<span class="ident" id="3146147">nil</span>&nbsp;<span class="op" id="3146151">&amp;&amp;</span>&nbsp;<span class="ident" id="3146154">err</span>&nbsp;<span class="op" id="3146158">!=</span>&nbsp;<span class="ident" id="3146161">io</span><span class="op" id="3146163">.</span><span class="ident" id="3146164">EOF</span>&nbsp;<span class="op" id="3146168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146172">err</span>&nbsp;<span class="op" id="3146176">=</span>&nbsp;<span class="op" id="3146178">&amp;</span><span class="ident" id="3146179">OpError</span><span class="op" id="3146186">{</span><span class="string" id="3146187">&#34;read&#34;</span><span class="op" id="3146193">,</span>&nbsp;<span class="ident" id="3146195">fd</span><span class="op" id="3146197">.</span><span class="ident" id="3146198">net</span><span class="op" id="3146201">,</span>&nbsp;<span class="ident" id="3146203">fd</span><span class="op" id="3146205">.</span><span class="ident" id="3146206">raddr</span><span class="op" id="3146211">,</span>&nbsp;<span class="ident" id="3146213">err</span><span class="op" id="3146216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146222">return</span><br>
<span class="lineno"></span><span class="op" id="3146229">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3146232">func</span>&nbsp;<span class="op" id="3146237">(</span><span class="ident" id="3146238">fd</span>&nbsp;<span class="op" id="3146241">*</span><span class="ident" id="3146242">netFD</span><span class="op" id="3146247">)</span>&nbsp;<span class="ident" id="3146249">readFrom</span><span class="op" id="3146257">(</span><span class="ident" id="3146258">p</span>&nbsp;<span class="op" id="3146260">[</span><span class="op" id="3146261">]</span><span class="builtintype" id="3146262">byte</span><span class="op" id="3146266">)</span>&nbsp;<span class="op" id="3146268">(</span><span class="ident" id="3146269">n</span>&nbsp;<span class="builtintype" id="3146271">int</span><span class="op" id="3146274">,</span>&nbsp;<span class="ident" id="3146276">sa</span>&nbsp;<span class="ident" id="3146279">syscall</span><span class="op" id="3146286">.</span><span class="ident" id="3146287">Sockaddr</span><span class="op" id="3146295">,</span>&nbsp;<span class="ident" id="3146297">err</span>&nbsp;<span class="builtintype" id="3146301">error</span><span class="op" id="3146306">)</span>&nbsp;<span class="op" id="3146308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146311">if</span>&nbsp;<span class="ident" id="3146314">err</span>&nbsp;<span class="op" id="3146318">:=</span>&nbsp;<span class="ident" id="3146321">fd</span><span class="op" id="3146323">.</span><span class="ident" id="3146324">readLock</span><span class="op" id="3146332">(</span><span class="op" id="3146333">)</span><span class="op" id="3146334">;</span>&nbsp;<span class="ident" id="3146336">err</span>&nbsp;<span class="op" id="3146340">!=</span>&nbsp;<span class="ident" id="3146343">nil</span>&nbsp;<span class="op" id="3146347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146351">return</span>&nbsp;<span class="num" id="3146358">0</span><span class="op" id="3146359">,</span>&nbsp;<span class="ident" id="3146361">nil</span><span class="op" id="3146364">,</span>&nbsp;<span class="ident" id="3146366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146371">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146374">defer</span>&nbsp;<span class="ident" id="3146380">fd</span><span class="op" id="3146382">.</span><span class="ident" id="3146383">readUnlock</span><span class="op" id="3146393">(</span><span class="op" id="3146394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146397">if</span>&nbsp;<span class="ident" id="3146400">err</span>&nbsp;<span class="op" id="3146404">:=</span>&nbsp;<span class="ident" id="3146407">fd</span><span class="op" id="3146409">.</span><span class="ident" id="3146410">pd</span><span class="op" id="3146412">.</span><span class="ident" id="3146413">PrepareRead</span><span class="op" id="3146424">(</span><span class="op" id="3146425">)</span><span class="op" id="3146426">;</span>&nbsp;<span class="ident" id="3146428">err</span>&nbsp;<span class="op" id="3146432">!=</span>&nbsp;<span class="ident" id="3146435">nil</span>&nbsp;<span class="op" id="3146439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146443">return</span>&nbsp;<span class="num" id="3146450">0</span><span class="op" id="3146451">,</span>&nbsp;<span class="ident" id="3146453">nil</span><span class="op" id="3146456">,</span>&nbsp;<span class="op" id="3146458">&amp;</span><span class="ident" id="3146459">OpError</span><span class="op" id="3146466">{</span><span class="string" id="3146467">&#34;read&#34;</span><span class="op" id="3146473">,</span>&nbsp;<span class="ident" id="3146475">fd</span><span class="op" id="3146477">.</span><span class="ident" id="3146478">net</span><span class="op" id="3146481">,</span>&nbsp;<span class="ident" id="3146483">fd</span><span class="op" id="3146485">.</span><span class="ident" id="3146486">laddr</span><span class="op" id="3146491">,</span>&nbsp;<span class="ident" id="3146493">err</span><span class="op" id="3146496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146502">for</span>&nbsp;<span class="op" id="3146506">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146510">n</span><span class="op" id="3146511">,</span>&nbsp;<span class="ident" id="3146513">sa</span><span class="op" id="3146515">,</span>&nbsp;<span class="ident" id="3146517">err</span>&nbsp;<span class="op" id="3146521">=</span>&nbsp;<span class="ident" id="3146523">syscall</span><span class="op" id="3146530">.</span><span class="ident" id="3146531">Recvfrom</span><span class="op" id="3146539">(</span><span class="ident" id="3146540">fd</span><span class="op" id="3146542">.</span><span class="ident" id="3146543">sysfd</span><span class="op" id="3146548">,</span>&nbsp;<span class="ident" id="3146550">p</span><span class="op" id="3146551">,</span>&nbsp;<span class="num" id="3146553">0</span><span class="op" id="3146554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146558">if</span>&nbsp;<span class="ident" id="3146561">err</span>&nbsp;<span class="op" id="3146565">!=</span>&nbsp;<span class="ident" id="3146568">nil</span>&nbsp;<span class="op" id="3146572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146577">n</span>&nbsp;<span class="op" id="3146579">=</span>&nbsp;<span class="num" id="3146581">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146586">if</span>&nbsp;<span class="ident" id="3146589">err</span>&nbsp;<span class="op" id="3146593">==</span>&nbsp;<span class="ident" id="3146596">syscall</span><span class="op" id="3146603">.</span><span class="ident" id="3146604">EAGAIN</span>&nbsp;<span class="op" id="3146611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146617">if</span>&nbsp;<span class="ident" id="3146620">err</span>&nbsp;<span class="op" id="3146624">=</span>&nbsp;<span class="ident" id="3146626">fd</span><span class="op" id="3146628">.</span><span class="ident" id="3146629">pd</span><span class="op" id="3146631">.</span><span class="ident" id="3146632">WaitRead</span><span class="op" id="3146640">(</span><span class="op" id="3146641">)</span><span class="op" id="3146642">;</span>&nbsp;<span class="ident" id="3146644">err</span>&nbsp;<span class="op" id="3146648">==</span>&nbsp;<span class="ident" id="3146651">nil</span>&nbsp;<span class="op" id="3146655">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146662">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146688">err</span>&nbsp;<span class="op" id="3146692">=</span>&nbsp;<span class="ident" id="3146694">chkReadErr</span><span class="op" id="3146704">(</span><span class="ident" id="3146705">n</span><span class="op" id="3146706">,</span>&nbsp;<span class="ident" id="3146708">err</span><span class="op" id="3146711">,</span>&nbsp;<span class="ident" id="3146713">fd</span><span class="op" id="3146715">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146719">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146729">if</span>&nbsp;<span class="ident" id="3146732">err</span>&nbsp;<span class="op" id="3146736">!=</span>&nbsp;<span class="ident" id="3146739">nil</span>&nbsp;<span class="op" id="3146743">&amp;&amp;</span>&nbsp;<span class="ident" id="3146746">err</span>&nbsp;<span class="op" id="3146750">!=</span>&nbsp;<span class="ident" id="3146753">io</span><span class="op" id="3146755">.</span><span class="ident" id="3146756">EOF</span>&nbsp;<span class="op" id="3146760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146764">err</span>&nbsp;<span class="op" id="3146768">=</span>&nbsp;<span class="op" id="3146770">&amp;</span><span class="ident" id="3146771">OpError</span><span class="op" id="3146778">{</span><span class="string" id="3146779">&#34;read&#34;</span><span class="op" id="3146785">,</span>&nbsp;<span class="ident" id="3146787">fd</span><span class="op" id="3146789">.</span><span class="ident" id="3146790">net</span><span class="op" id="3146793">,</span>&nbsp;<span class="ident" id="3146795">fd</span><span class="op" id="3146797">.</span><span class="ident" id="3146798">laddr</span><span class="op" id="3146803">,</span>&nbsp;<span class="ident" id="3146805">err</span><span class="op" id="3146808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146811">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146814">return</span><br>
<span class="lineno"></span><span class="op" id="3146821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3146824">func</span>&nbsp;<span class="op" id="3146829">(</span><span class="ident" id="3146830">fd</span>&nbsp;<span class="op" id="3146833">*</span><span class="ident" id="3146834">netFD</span><span class="op" id="3146839">)</span>&nbsp;<span class="ident" id="3146841">readMsg</span><span class="op" id="3146848">(</span><span class="ident" id="3146849">p</span>&nbsp;<span class="op" id="3146851">[</span><span class="op" id="3146852">]</span><span class="builtintype" id="3146853">byte</span><span class="op" id="3146857">,</span>&nbsp;<span class="ident" id="3146859">oob</span>&nbsp;<span class="op" id="3146863">[</span><span class="op" id="3146864">]</span><span class="builtintype" id="3146865">byte</span><span class="op" id="3146869">)</span>&nbsp;<span class="op" id="3146871">(</span><span class="ident" id="3146872">n</span><span class="op" id="3146873">,</span>&nbsp;<span class="ident" id="3146875">oobn</span><span class="op" id="3146879">,</span>&nbsp;<span class="ident" id="3146881">flags</span>&nbsp;<span class="builtintype" id="3146887">int</span><span class="op" id="3146890">,</span>&nbsp;<span class="ident" id="3146892">sa</span>&nbsp;<span class="ident" id="3146895">syscall</span><span class="op" id="3146902">.</span><span class="ident" id="3146903">Sockaddr</span><span class="op" id="3146911">,</span>&nbsp;<span class="ident" id="3146913">err</span>&nbsp;<span class="builtintype" id="3146917">error</span><span class="op" id="3146922">)</span>&nbsp;<span class="op" id="3146924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146927">if</span>&nbsp;<span class="ident" id="3146930">err</span>&nbsp;<span class="op" id="3146934">:=</span>&nbsp;<span class="ident" id="3146937">fd</span><span class="op" id="3146939">.</span><span class="ident" id="3146940">readLock</span><span class="op" id="3146948">(</span><span class="op" id="3146949">)</span><span class="op" id="3146950">;</span>&nbsp;<span class="ident" id="3146952">err</span>&nbsp;<span class="op" id="3146956">!=</span>&nbsp;<span class="ident" id="3146959">nil</span>&nbsp;<span class="op" id="3146963">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146967">return</span>&nbsp;<span class="num" id="3146974">0</span><span class="op" id="3146975">,</span>&nbsp;<span class="num" id="3146977">0</span><span class="op" id="3146978">,</span>&nbsp;<span class="num" id="3146980">0</span><span class="op" id="3146981">,</span>&nbsp;<span class="ident" id="3146983">nil</span><span class="op" id="3146986">,</span>&nbsp;<span class="ident" id="3146988">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3146993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146996">defer</span>&nbsp;<span class="ident" id="3147002">fd</span><span class="op" id="3147004">.</span><span class="ident" id="3147005">readUnlock</span><span class="op" id="3147015">(</span><span class="op" id="3147016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147019">if</span>&nbsp;<span class="ident" id="3147022">err</span>&nbsp;<span class="op" id="3147026">:=</span>&nbsp;<span class="ident" id="3147029">fd</span><span class="op" id="3147031">.</span><span class="ident" id="3147032">pd</span><span class="op" id="3147034">.</span><span class="ident" id="3147035">PrepareRead</span><span class="op" id="3147046">(</span><span class="op" id="3147047">)</span><span class="op" id="3147048">;</span>&nbsp;<span class="ident" id="3147050">err</span>&nbsp;<span class="op" id="3147054">!=</span>&nbsp;<span class="ident" id="3147057">nil</span>&nbsp;<span class="op" id="3147061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147065">return</span>&nbsp;<span class="num" id="3147072">0</span><span class="op" id="3147073">,</span>&nbsp;<span class="num" id="3147075">0</span><span class="op" id="3147076">,</span>&nbsp;<span class="num" id="3147078">0</span><span class="op" id="3147079">,</span>&nbsp;<span class="ident" id="3147081">nil</span><span class="op" id="3147084">,</span>&nbsp;<span class="op" id="3147086">&amp;</span><span class="ident" id="3147087">OpError</span><span class="op" id="3147094">{</span><span class="string" id="3147095">&#34;read&#34;</span><span class="op" id="3147101">,</span>&nbsp;<span class="ident" id="3147103">fd</span><span class="op" id="3147105">.</span><span class="ident" id="3147106">net</span><span class="op" id="3147109">,</span>&nbsp;<span class="ident" id="3147111">fd</span><span class="op" id="3147113">.</span><span class="ident" id="3147114">laddr</span><span class="op" id="3147119">,</span>&nbsp;<span class="ident" id="3147121">err</span><span class="op" id="3147124">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147130">for</span>&nbsp;<span class="op" id="3147134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147138">n</span><span class="op" id="3147139">,</span>&nbsp;<span class="ident" id="3147141">oobn</span><span class="op" id="3147145">,</span>&nbsp;<span class="ident" id="3147147">flags</span><span class="op" id="3147152">,</span>&nbsp;<span class="ident" id="3147154">sa</span><span class="op" id="3147156">,</span>&nbsp;<span class="ident" id="3147158">err</span>&nbsp;<span class="op" id="3147162">=</span>&nbsp;<span class="ident" id="3147164">syscall</span><span class="op" id="3147171">.</span><span class="ident" id="3147172">Recvmsg</span><span class="op" id="3147179">(</span><span class="ident" id="3147180">fd</span><span class="op" id="3147182">.</span><span class="ident" id="3147183">sysfd</span><span class="op" id="3147188">,</span>&nbsp;<span class="ident" id="3147190">p</span><span class="op" id="3147191">,</span>&nbsp;<span class="ident" id="3147193">oob</span><span class="op" id="3147196">,</span>&nbsp;<span class="num" id="3147198">0</span><span class="op" id="3147199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147203">if</span>&nbsp;<span class="ident" id="3147206">err</span>&nbsp;<span class="op" id="3147210">!=</span>&nbsp;<span class="ident" id="3147213">nil</span>&nbsp;<span class="op" id="3147217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147222">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147268">if</span>&nbsp;<span class="ident" id="3147271">err</span>&nbsp;<span class="op" id="3147275">==</span>&nbsp;<span class="ident" id="3147278">syscall</span><span class="op" id="3147285">.</span><span class="ident" id="3147286">EAGAIN</span>&nbsp;<span class="op" id="3147293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147299">if</span>&nbsp;<span class="ident" id="3147302">err</span>&nbsp;<span class="op" id="3147306">=</span>&nbsp;<span class="ident" id="3147308">fd</span><span class="op" id="3147310">.</span><span class="ident" id="3147311">pd</span><span class="op" id="3147313">.</span><span class="ident" id="3147314">WaitRead</span><span class="op" id="3147322">(</span><span class="op" id="3147323">)</span><span class="op" id="3147324">;</span>&nbsp;<span class="ident" id="3147326">err</span>&nbsp;<span class="op" id="3147330">==</span>&nbsp;<span class="ident" id="3147333">nil</span>&nbsp;<span class="op" id="3147337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147344">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147362">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147370">err</span>&nbsp;<span class="op" id="3147374">=</span>&nbsp;<span class="ident" id="3147376">chkReadErr</span><span class="op" id="3147386">(</span><span class="ident" id="3147387">n</span><span class="op" id="3147388">,</span>&nbsp;<span class="ident" id="3147390">err</span><span class="op" id="3147393">,</span>&nbsp;<span class="ident" id="3147395">fd</span><span class="op" id="3147397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147401">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147411">if</span>&nbsp;<span class="ident" id="3147414">err</span>&nbsp;<span class="op" id="3147418">!=</span>&nbsp;<span class="ident" id="3147421">nil</span>&nbsp;<span class="op" id="3147425">&amp;&amp;</span>&nbsp;<span class="ident" id="3147428">err</span>&nbsp;<span class="op" id="3147432">!=</span>&nbsp;<span class="ident" id="3147435">io</span><span class="op" id="3147437">.</span><span class="ident" id="3147438">EOF</span>&nbsp;<span class="op" id="3147442">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147446">err</span>&nbsp;<span class="op" id="3147450">=</span>&nbsp;<span class="op" id="3147452">&amp;</span><span class="ident" id="3147453">OpError</span><span class="op" id="3147460">{</span><span class="string" id="3147461">&#34;read&#34;</span><span class="op" id="3147467">,</span>&nbsp;<span class="ident" id="3147469">fd</span><span class="op" id="3147471">.</span><span class="ident" id="3147472">net</span><span class="op" id="3147475">,</span>&nbsp;<span class="ident" id="3147477">fd</span><span class="op" id="3147479">.</span><span class="ident" id="3147480">laddr</span><span class="op" id="3147485">,</span>&nbsp;<span class="ident" id="3147487">err</span><span class="op" id="3147490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147496">return</span><br>
<span class="lineno"></span><span class="op" id="3147503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3147506">func</span>&nbsp;<span class="ident" id="3147511">chkReadErr</span><span class="op" id="3147521">(</span><span class="ident" id="3147522">n</span>&nbsp;<span class="builtintype" id="3147524">int</span><span class="op" id="3147527">,</span>&nbsp;<span class="ident" id="3147529">err</span>&nbsp;<span class="builtintype" id="3147533">error</span><span class="op" id="3147538">,</span>&nbsp;<span class="ident" id="3147540">fd</span>&nbsp;<span class="op" id="3147543">*</span><span class="ident" id="3147544">netFD</span><span class="op" id="3147549">)</span>&nbsp;<span class="builtintype" id="3147551">error</span>&nbsp;<span class="op" id="3147557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147560">if</span>&nbsp;<span class="ident" id="3147563">n</span>&nbsp;<span class="op" id="3147565">==</span>&nbsp;<span class="num" id="3147568">0</span>&nbsp;<span class="op" id="3147570">&amp;&amp;</span>&nbsp;<span class="ident" id="3147573">err</span>&nbsp;<span class="op" id="3147577">==</span>&nbsp;<span class="ident" id="3147580">nil</span>&nbsp;<span class="op" id="3147584">&amp;&amp;</span>&nbsp;<span class="ident" id="3147587">fd</span><span class="op" id="3147589">.</span><span class="ident" id="3147590">sotype</span>&nbsp;<span class="op" id="3147597">!=</span>&nbsp;<span class="ident" id="3147600">syscall</span><span class="op" id="3147607">.</span><span class="ident" id="3147608">SOCK_DGRAM</span>&nbsp;<span class="op" id="3147619">&amp;&amp;</span>&nbsp;<span class="ident" id="3147622">fd</span><span class="op" id="3147624">.</span><span class="ident" id="3147625">sotype</span>&nbsp;<span class="op" id="3147632">!=</span>&nbsp;<span class="ident" id="3147635">syscall</span><span class="op" id="3147642">.</span><span class="ident" id="3147643">SOCK_RAW</span>&nbsp;<span class="op" id="3147652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147656">return</span>&nbsp;<span class="ident" id="3147663">io</span><span class="op" id="3147665">.</span><span class="ident" id="3147666">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147674">return</span>&nbsp;<span class="ident" id="3147681">err</span><br>
<span class="lineno">315</span><span class="op" id="3147685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3147688">func</span>&nbsp;<span class="op" id="3147693">(</span><span class="ident" id="3147694">fd</span>&nbsp;<span class="op" id="3147697">*</span><span class="ident" id="3147698">netFD</span><span class="op" id="3147703">)</span>&nbsp;<span class="ident" id="3147705">Write</span><span class="op" id="3147710">(</span><span class="ident" id="3147711">p</span>&nbsp;<span class="op" id="3147713">[</span><span class="op" id="3147714">]</span><span class="builtintype" id="3147715">byte</span><span class="op" id="3147719">)</span>&nbsp;<span class="op" id="3147721">(</span><span class="ident" id="3147722">nn</span>&nbsp;<span class="builtintype" id="3147725">int</span><span class="op" id="3147728">,</span>&nbsp;<span class="ident" id="3147730">err</span>&nbsp;<span class="builtintype" id="3147734">error</span><span class="op" id="3147739">)</span>&nbsp;<span class="op" id="3147741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147744">if</span>&nbsp;<span class="ident" id="3147747">err</span>&nbsp;<span class="op" id="3147751">:=</span>&nbsp;<span class="ident" id="3147754">fd</span><span class="op" id="3147756">.</span><span class="ident" id="3147757">writeLock</span><span class="op" id="3147766">(</span><span class="op" id="3147767">)</span><span class="op" id="3147768">;</span>&nbsp;<span class="ident" id="3147770">err</span>&nbsp;<span class="op" id="3147774">!=</span>&nbsp;<span class="ident" id="3147777">nil</span>&nbsp;<span class="op" id="3147781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147785">return</span>&nbsp;<span class="num" id="3147792">0</span><span class="op" id="3147793">,</span>&nbsp;<span class="ident" id="3147795">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147803">defer</span>&nbsp;<span class="ident" id="3147809">fd</span><span class="op" id="3147811">.</span><span class="ident" id="3147812">writeUnlock</span><span class="op" id="3147823">(</span><span class="op" id="3147824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147827">if</span>&nbsp;<span class="ident" id="3147830">err</span>&nbsp;<span class="op" id="3147834">:=</span>&nbsp;<span class="ident" id="3147837">fd</span><span class="op" id="3147839">.</span><span class="ident" id="3147840">pd</span><span class="op" id="3147842">.</span><span class="ident" id="3147843">PrepareWrite</span><span class="op" id="3147855">(</span><span class="op" id="3147856">)</span><span class="op" id="3147857">;</span>&nbsp;<span class="ident" id="3147859">err</span>&nbsp;<span class="op" id="3147863">!=</span>&nbsp;<span class="ident" id="3147866">nil</span>&nbsp;<span class="op" id="3147870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147874">return</span>&nbsp;<span class="num" id="3147881">0</span><span class="op" id="3147882">,</span>&nbsp;<span class="op" id="3147884">&amp;</span><span class="ident" id="3147885">OpError</span><span class="op" id="3147892">{</span><span class="string" id="3147893">&#34;write&#34;</span><span class="op" id="3147900">,</span>&nbsp;<span class="ident" id="3147902">fd</span><span class="op" id="3147904">.</span><span class="ident" id="3147905">net</span><span class="op" id="3147908">,</span>&nbsp;<span class="ident" id="3147910">fd</span><span class="op" id="3147912">.</span><span class="ident" id="3147913">raddr</span><span class="op" id="3147918">,</span>&nbsp;<span class="ident" id="3147920">err</span><span class="op" id="3147923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147926">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147929">for</span>&nbsp;<span class="op" id="3147933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147937">var</span>&nbsp;<span class="ident" id="3147941">n</span>&nbsp;<span class="builtintype" id="3147943">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147949">n</span><span class="op" id="3147950">,</span>&nbsp;<span class="ident" id="3147952">err</span>&nbsp;<span class="op" id="3147956">=</span>&nbsp;<span class="ident" id="3147958">syscall</span><span class="op" id="3147965">.</span><span class="ident" id="3147966">Write</span><span class="op" id="3147971">(</span><span class="builtintype" id="3147972">int</span><span class="op" id="3147975">(</span><span class="ident" id="3147976">fd</span><span class="op" id="3147978">.</span><span class="ident" id="3147979">sysfd</span><span class="op" id="3147984">)</span><span class="op" id="3147985">,</span>&nbsp;<span class="ident" id="3147987">p</span><span class="op" id="3147988">[</span><span class="ident" id="3147989">nn</span><span class="op" id="3147991">:</span><span class="op" id="3147992">]</span><span class="op" id="3147993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147997">if</span>&nbsp;<span class="ident" id="3148000">n</span>&nbsp;<span class="op" id="3148002">&gt;</span>&nbsp;<span class="num" id="3148004">0</span>&nbsp;<span class="op" id="3148006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148011">nn</span>&nbsp;<span class="op" id="3148014">+=</span>&nbsp;<span class="ident" id="3148017">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148025">if</span>&nbsp;<span class="ident" id="3148028">nn</span>&nbsp;<span class="op" id="3148031">==</span>&nbsp;<span class="builtinfunc" id="3148034">len</span><span class="op" id="3148037">(</span><span class="ident" id="3148038">p</span><span class="op" id="3148039">)</span>&nbsp;<span class="op" id="3148041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148046">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148058">if</span>&nbsp;<span class="ident" id="3148061">err</span>&nbsp;<span class="op" id="3148065">==</span>&nbsp;<span class="ident" id="3148068">syscall</span><span class="op" id="3148075">.</span><span class="ident" id="3148076">EAGAIN</span>&nbsp;<span class="op" id="3148083">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148088">if</span>&nbsp;<span class="ident" id="3148091">err</span>&nbsp;<span class="op" id="3148095">=</span>&nbsp;<span class="ident" id="3148097">fd</span><span class="op" id="3148099">.</span><span class="ident" id="3148100">pd</span><span class="op" id="3148102">.</span><span class="ident" id="3148103">WaitWrite</span><span class="op" id="3148112">(</span><span class="op" id="3148113">)</span><span class="op" id="3148114">;</span>&nbsp;<span class="ident" id="3148116">err</span>&nbsp;<span class="op" id="3148120">==</span>&nbsp;<span class="ident" id="3148123">nil</span>&nbsp;<span class="op" id="3148127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148133">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148153">if</span>&nbsp;<span class="ident" id="3148156">err</span>&nbsp;<span class="op" id="3148160">!=</span>&nbsp;<span class="ident" id="3148163">nil</span>&nbsp;<span class="op" id="3148167">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148172">n</span>&nbsp;<span class="op" id="3148174">=</span>&nbsp;<span class="num" id="3148176">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148181">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148193">if</span>&nbsp;<span class="ident" id="3148196">n</span>&nbsp;<span class="op" id="3148198">==</span>&nbsp;<span class="num" id="3148201">0</span>&nbsp;<span class="op" id="3148203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148208">err</span>&nbsp;<span class="op" id="3148212">=</span>&nbsp;<span class="ident" id="3148214">io</span><span class="op" id="3148216">.</span><span class="ident" id="3148217">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148237">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148251">if</span>&nbsp;<span class="ident" id="3148254">err</span>&nbsp;<span class="op" id="3148258">!=</span>&nbsp;<span class="ident" id="3148261">nil</span>&nbsp;<span class="op" id="3148265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148269">err</span>&nbsp;<span class="op" id="3148273">=</span>&nbsp;<span class="op" id="3148275">&amp;</span><span class="ident" id="3148276">OpError</span><span class="op" id="3148283">{</span><span class="string" id="3148284">&#34;write&#34;</span><span class="op" id="3148291">,</span>&nbsp;<span class="ident" id="3148293">fd</span><span class="op" id="3148295">.</span><span class="ident" id="3148296">net</span><span class="op" id="3148299">,</span>&nbsp;<span class="ident" id="3148301">fd</span><span class="op" id="3148303">.</span><span class="ident" id="3148304">raddr</span><span class="op" id="3148309">,</span>&nbsp;<span class="ident" id="3148311">err</span><span class="op" id="3148314">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148320">return</span>&nbsp;<span class="ident" id="3148327">nn</span><span class="op" id="3148329">,</span>&nbsp;<span class="ident" id="3148331">err</span><br>
<span class="lineno"></span><span class="op" id="3148335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3148338">func</span>&nbsp;<span class="op" id="3148343">(</span><span class="ident" id="3148344">fd</span>&nbsp;<span class="op" id="3148347">*</span><span class="ident" id="3148348">netFD</span><span class="op" id="3148353">)</span>&nbsp;<span class="ident" id="3148355">writeTo</span><span class="op" id="3148362">(</span><span class="ident" id="3148363">p</span>&nbsp;<span class="op" id="3148365">[</span><span class="op" id="3148366">]</span><span class="builtintype" id="3148367">byte</span><span class="op" id="3148371">,</span>&nbsp;<span class="ident" id="3148373">sa</span>&nbsp;<span class="ident" id="3148376">syscall</span><span class="op" id="3148383">.</span><span class="ident" id="3148384">Sockaddr</span><span class="op" id="3148392">)</span>&nbsp;<span class="op" id="3148394">(</span><span class="ident" id="3148395">n</span>&nbsp;<span class="builtintype" id="3148397">int</span><span class="op" id="3148400">,</span>&nbsp;<span class="ident" id="3148402">err</span>&nbsp;<span class="builtintype" id="3148406">error</span><span class="op" id="3148411">)</span>&nbsp;<span class="op" id="3148413">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148416">if</span>&nbsp;<span class="ident" id="3148419">err</span>&nbsp;<span class="op" id="3148423">:=</span>&nbsp;<span class="ident" id="3148426">fd</span><span class="op" id="3148428">.</span><span class="ident" id="3148429">writeLock</span><span class="op" id="3148438">(</span><span class="op" id="3148439">)</span><span class="op" id="3148440">;</span>&nbsp;<span class="ident" id="3148442">err</span>&nbsp;<span class="op" id="3148446">!=</span>&nbsp;<span class="ident" id="3148449">nil</span>&nbsp;<span class="op" id="3148453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148457">return</span>&nbsp;<span class="num" id="3148464">0</span><span class="op" id="3148465">,</span>&nbsp;<span class="ident" id="3148467">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148475">defer</span>&nbsp;<span class="ident" id="3148481">fd</span><span class="op" id="3148483">.</span><span class="ident" id="3148484">writeUnlock</span><span class="op" id="3148495">(</span><span class="op" id="3148496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148499">if</span>&nbsp;<span class="ident" id="3148502">err</span>&nbsp;<span class="op" id="3148506">:=</span>&nbsp;<span class="ident" id="3148509">fd</span><span class="op" id="3148511">.</span><span class="ident" id="3148512">pd</span><span class="op" id="3148514">.</span><span class="ident" id="3148515">PrepareWrite</span><span class="op" id="3148527">(</span><span class="op" id="3148528">)</span><span class="op" id="3148529">;</span>&nbsp;<span class="ident" id="3148531">err</span>&nbsp;<span class="op" id="3148535">!=</span>&nbsp;<span class="ident" id="3148538">nil</span>&nbsp;<span class="op" id="3148542">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148546">return</span>&nbsp;<span class="num" id="3148553">0</span><span class="op" id="3148554">,</span>&nbsp;<span class="op" id="3148556">&amp;</span><span class="ident" id="3148557">OpError</span><span class="op" id="3148564">{</span><span class="string" id="3148565">&#34;write&#34;</span><span class="op" id="3148572">,</span>&nbsp;<span class="ident" id="3148574">fd</span><span class="op" id="3148576">.</span><span class="ident" id="3148577">net</span><span class="op" id="3148580">,</span>&nbsp;<span class="ident" id="3148582">fd</span><span class="op" id="3148584">.</span><span class="ident" id="3148585">raddr</span><span class="op" id="3148590">,</span>&nbsp;<span class="ident" id="3148592">err</span><span class="op" id="3148595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148601">for</span>&nbsp;<span class="op" id="3148605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148609">err</span>&nbsp;<span class="op" id="3148613">=</span>&nbsp;<span class="ident" id="3148615">syscall</span><span class="op" id="3148622">.</span><span class="ident" id="3148623">Sendto</span><span class="op" id="3148629">(</span><span class="ident" id="3148630">fd</span><span class="op" id="3148632">.</span><span class="ident" id="3148633">sysfd</span><span class="op" id="3148638">,</span>&nbsp;<span class="ident" id="3148640">p</span><span class="op" id="3148641">,</span>&nbsp;<span class="num" id="3148643">0</span><span class="op" id="3148644">,</span>&nbsp;<span class="ident" id="3148646">sa</span><span class="op" id="3148648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148652">if</span>&nbsp;<span class="ident" id="3148655">err</span>&nbsp;<span class="op" id="3148659">==</span>&nbsp;<span class="ident" id="3148662">syscall</span><span class="op" id="3148669">.</span><span class="ident" id="3148670">EAGAIN</span>&nbsp;<span class="op" id="3148677">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148682">if</span>&nbsp;<span class="ident" id="3148685">err</span>&nbsp;<span class="op" id="3148689">=</span>&nbsp;<span class="ident" id="3148691">fd</span><span class="op" id="3148693">.</span><span class="ident" id="3148694">pd</span><span class="op" id="3148696">.</span><span class="ident" id="3148697">WaitWrite</span><span class="op" id="3148706">(</span><span class="op" id="3148707">)</span><span class="op" id="3148708">;</span>&nbsp;<span class="ident" id="3148710">err</span>&nbsp;<span class="op" id="3148714">==</span>&nbsp;<span class="ident" id="3148717">nil</span>&nbsp;<span class="op" id="3148721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148727">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148747">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148757">if</span>&nbsp;<span class="ident" id="3148760">err</span>&nbsp;<span class="op" id="3148764">==</span>&nbsp;<span class="ident" id="3148767">nil</span>&nbsp;<span class="op" id="3148771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148775">n</span>&nbsp;<span class="op" id="3148777">=</span>&nbsp;<span class="builtinfunc" id="3148779">len</span><span class="op" id="3148782">(</span><span class="ident" id="3148783">p</span><span class="op" id="3148784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148787">}</span>&nbsp;<span class="keyword" id="3148789">else</span>&nbsp;<span class="op" id="3148794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148798">err</span>&nbsp;<span class="op" id="3148802">=</span>&nbsp;<span class="op" id="3148804">&amp;</span><span class="ident" id="3148805">OpError</span><span class="op" id="3148812">{</span><span class="string" id="3148813">&#34;write&#34;</span><span class="op" id="3148820">,</span>&nbsp;<span class="ident" id="3148822">fd</span><span class="op" id="3148824">.</span><span class="ident" id="3148825">net</span><span class="op" id="3148828">,</span>&nbsp;<span class="ident" id="3148830">fd</span><span class="op" id="3148832">.</span><span class="ident" id="3148833">raddr</span><span class="op" id="3148838">,</span>&nbsp;<span class="ident" id="3148840">err</span><span class="op" id="3148843">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148849">return</span><br>
<span class="lineno"></span><span class="op" id="3148856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3148859">func</span>&nbsp;<span class="op" id="3148864">(</span><span class="ident" id="3148865">fd</span>&nbsp;<span class="op" id="3148868">*</span><span class="ident" id="3148869">netFD</span><span class="op" id="3148874">)</span>&nbsp;<span class="ident" id="3148876">writeMsg</span><span class="op" id="3148884">(</span><span class="ident" id="3148885">p</span>&nbsp;<span class="op" id="3148887">[</span><span class="op" id="3148888">]</span><span class="builtintype" id="3148889">byte</span><span class="op" id="3148893">,</span>&nbsp;<span class="ident" id="3148895">oob</span>&nbsp;<span class="op" id="3148899">[</span><span class="op" id="3148900">]</span><span class="builtintype" id="3148901">byte</span><span class="op" id="3148905">,</span>&nbsp;<span class="ident" id="3148907">sa</span>&nbsp;<span class="ident" id="3148910">syscall</span><span class="op" id="3148917">.</span><span class="ident" id="3148918">Sockaddr</span><span class="op" id="3148926">)</span>&nbsp;<span class="op" id="3148928">(</span><span class="ident" id="3148929">n</span>&nbsp;<span class="builtintype" id="3148931">int</span><span class="op" id="3148934">,</span>&nbsp;<span class="ident" id="3148936">oobn</span>&nbsp;<span class="builtintype" id="3148941">int</span><span class="op" id="3148944">,</span>&nbsp;<span class="ident" id="3148946">err</span>&nbsp;<span class="builtintype" id="3148950">error</span><span class="op" id="3148955">)</span>&nbsp;<span class="op" id="3148957">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148960">if</span>&nbsp;<span class="ident" id="3148963">err</span>&nbsp;<span class="op" id="3148967">:=</span>&nbsp;<span class="ident" id="3148970">fd</span><span class="op" id="3148972">.</span><span class="ident" id="3148973">writeLock</span><span class="op" id="3148982">(</span><span class="op" id="3148983">)</span><span class="op" id="3148984">;</span>&nbsp;<span class="ident" id="3148986">err</span>&nbsp;<span class="op" id="3148990">!=</span>&nbsp;<span class="ident" id="3148993">nil</span>&nbsp;<span class="op" id="3148997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149001">return</span>&nbsp;<span class="num" id="3149008">0</span><span class="op" id="3149009">,</span>&nbsp;<span class="num" id="3149011">0</span><span class="op" id="3149012">,</span>&nbsp;<span class="ident" id="3149014">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149022">defer</span>&nbsp;<span class="ident" id="3149028">fd</span><span class="op" id="3149030">.</span><span class="ident" id="3149031">writeUnlock</span><span class="op" id="3149042">(</span><span class="op" id="3149043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149046">if</span>&nbsp;<span class="ident" id="3149049">err</span>&nbsp;<span class="op" id="3149053">:=</span>&nbsp;<span class="ident" id="3149056">fd</span><span class="op" id="3149058">.</span><span class="ident" id="3149059">pd</span><span class="op" id="3149061">.</span><span class="ident" id="3149062">PrepareWrite</span><span class="op" id="3149074">(</span><span class="op" id="3149075">)</span><span class="op" id="3149076">;</span>&nbsp;<span class="ident" id="3149078">err</span>&nbsp;<span class="op" id="3149082">!=</span>&nbsp;<span class="ident" id="3149085">nil</span>&nbsp;<span class="op" id="3149089">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149093">return</span>&nbsp;<span class="num" id="3149100">0</span><span class="op" id="3149101">,</span>&nbsp;<span class="num" id="3149103">0</span><span class="op" id="3149104">,</span>&nbsp;<span class="op" id="3149106">&amp;</span><span class="ident" id="3149107">OpError</span><span class="op" id="3149114">{</span><span class="string" id="3149115">&#34;write&#34;</span><span class="op" id="3149122">,</span>&nbsp;<span class="ident" id="3149124">fd</span><span class="op" id="3149126">.</span><span class="ident" id="3149127">net</span><span class="op" id="3149130">,</span>&nbsp;<span class="ident" id="3149132">fd</span><span class="op" id="3149134">.</span><span class="ident" id="3149135">raddr</span><span class="op" id="3149140">,</span>&nbsp;<span class="ident" id="3149142">err</span><span class="op" id="3149145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149151">for</span>&nbsp;<span class="op" id="3149155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3149159">n</span><span class="op" id="3149160">,</span>&nbsp;<span class="ident" id="3149162">err</span>&nbsp;<span class="op" id="3149166">=</span>&nbsp;<span class="ident" id="3149168">syscall</span><span class="op" id="3149175">.</span><span class="ident" id="3149176">SendmsgN</span><span class="op" id="3149184">(</span><span class="ident" id="3149185">fd</span><span class="op" id="3149187">.</span><span class="ident" id="3149188">sysfd</span><span class="op" id="3149193">,</span>&nbsp;<span class="ident" id="3149195">p</span><span class="op" id="3149196">,</span>&nbsp;<span class="ident" id="3149198">oob</span><span class="op" id="3149201">,</span>&nbsp;<span class="ident" id="3149203">sa</span><span class="op" id="3149205">,</span>&nbsp;<span class="num" id="3149207">0</span><span class="op" id="3149208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149212">if</span>&nbsp;<span class="ident" id="3149215">err</span>&nbsp;<span class="op" id="3149219">==</span>&nbsp;<span class="ident" id="3149222">syscall</span><span class="op" id="3149229">.</span><span class="ident" id="3149230">EAGAIN</span>&nbsp;<span class="op" id="3149237">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149242">if</span>&nbsp;<span class="ident" id="3149245">err</span>&nbsp;<span class="op" id="3149249">=</span>&nbsp;<span class="ident" id="3149251">fd</span><span class="op" id="3149253">.</span><span class="ident" id="3149254">pd</span><span class="op" id="3149256">.</span><span class="ident" id="3149257">WaitWrite</span><span class="op" id="3149266">(</span><span class="op" id="3149267">)</span><span class="op" id="3149268">;</span>&nbsp;<span class="ident" id="3149270">err</span>&nbsp;<span class="op" id="3149274">==</span>&nbsp;<span class="ident" id="3149277">nil</span>&nbsp;<span class="op" id="3149281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149287">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149307">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149317">if</span>&nbsp;<span class="ident" id="3149320">err</span>&nbsp;<span class="op" id="3149324">==</span>&nbsp;<span class="ident" id="3149327">nil</span>&nbsp;<span class="op" id="3149331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3149335">oobn</span>&nbsp;<span class="op" id="3149340">=</span>&nbsp;<span class="builtinfunc" id="3149342">len</span><span class="op" id="3149345">(</span><span class="ident" id="3149346">oob</span><span class="op" id="3149349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149352">}</span>&nbsp;<span class="keyword" id="3149354">else</span>&nbsp;<span class="op" id="3149359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3149363">err</span>&nbsp;<span class="op" id="3149367">=</span>&nbsp;<span class="op" id="3149369">&amp;</span><span class="ident" id="3149370">OpError</span><span class="op" id="3149377">{</span><span class="string" id="3149378">&#34;write&#34;</span><span class="op" id="3149385">,</span>&nbsp;<span class="ident" id="3149387">fd</span><span class="op" id="3149389">.</span><span class="ident" id="3149390">net</span><span class="op" id="3149393">,</span>&nbsp;<span class="ident" id="3149395">fd</span><span class="op" id="3149397">.</span><span class="ident" id="3149398">raddr</span><span class="op" id="3149403">,</span>&nbsp;<span class="ident" id="3149405">err</span><span class="op" id="3149408">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149414">return</span><br>
<span class="lineno"></span><span class="op" id="3149421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3149424">func</span>&nbsp;<span class="op" id="3149429">(</span><span class="ident" id="3149430">fd</span>&nbsp;<span class="op" id="3149433">*</span><span class="ident" id="3149434">netFD</span><span class="op" id="3149439">)</span>&nbsp;<span class="ident" id="3149441">accept</span><span class="op" id="3149447">(</span><span class="op" id="3149448">)</span>&nbsp;<span class="op" id="3149450">(</span><span class="ident" id="3149451">netfd</span>&nbsp;<span class="op" id="3149457">*</span><span class="ident" id="3149458">netFD</span><span class="op" id="3149463">,</span>&nbsp;<span class="ident" id="3149465">err</span>&nbsp;<span class="builtintype" id="3149469">error</span><span class="op" id="3149474">)</span>&nbsp;<span class="op" id="3149476">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149479">if</span>&nbsp;<span class="ident" id="3149482">err</span>&nbsp;<span class="op" id="3149486">:=</span>&nbsp;<span class="ident" id="3149489">fd</span><span class="op" id="3149491">.</span><span class="ident" id="3149492">readLock</span><span class="op" id="3149500">(</span><span class="op" id="3149501">)</span><span class="op" id="3149502">;</span>&nbsp;<span class="ident" id="3149504">err</span>&nbsp;<span class="op" id="3149508">!=</span>&nbsp;<span class="ident" id="3149511">nil</span>&nbsp;<span class="op" id="3149515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149519">return</span>&nbsp;<span class="ident" id="3149526">nil</span><span class="op" id="3149529">,</span>&nbsp;<span class="ident" id="3149531">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149539">defer</span>&nbsp;<span class="ident" id="3149545">fd</span><span class="op" id="3149547">.</span><span class="ident" id="3149548">readUnlock</span><span class="op" id="3149558">(</span><span class="op" id="3149559">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149563">var</span>&nbsp;<span class="ident" id="3149567">s</span>&nbsp;<span class="builtintype" id="3149569">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149574">var</span>&nbsp;<span class="ident" id="3149578">rsa</span>&nbsp;<span class="ident" id="3149582">syscall</span><span class="op" id="3149589">.</span><span class="ident" id="3149590">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149600">if</span>&nbsp;<span class="ident" id="3149603">err</span>&nbsp;<span class="op" id="3149607">=</span>&nbsp;<span class="ident" id="3149609">fd</span><span class="op" id="3149611">.</span><span class="ident" id="3149612">pd</span><span class="op" id="3149614">.</span><span class="ident" id="3149615">PrepareRead</span><span class="op" id="3149626">(</span><span class="op" id="3149627">)</span><span class="op" id="3149628">;</span>&nbsp;<span class="ident" id="3149630">err</span>&nbsp;<span class="op" id="3149634">!=</span>&nbsp;<span class="ident" id="3149637">nil</span>&nbsp;<span class="op" id="3149641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149645">return</span>&nbsp;<span class="ident" id="3149652">nil</span><span class="op" id="3149655">,</span>&nbsp;<span class="op" id="3149657">&amp;</span><span class="ident" id="3149658">OpError</span><span class="op" id="3149665">{</span><span class="string" id="3149666">&#34;accept&#34;</span><span class="op" id="3149674">,</span>&nbsp;<span class="ident" id="3149676">fd</span><span class="op" id="3149678">.</span><span class="ident" id="3149679">net</span><span class="op" id="3149682">,</span>&nbsp;<span class="ident" id="3149684">fd</span><span class="op" id="3149686">.</span><span class="ident" id="3149687">laddr</span><span class="op" id="3149692">,</span>&nbsp;<span class="ident" id="3149694">err</span><span class="op" id="3149697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149700">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149703">for</span>&nbsp;<span class="op" id="3149707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3149711">s</span><span class="op" id="3149712">,</span>&nbsp;<span class="ident" id="3149714">rsa</span><span class="op" id="3149717">,</span>&nbsp;<span class="ident" id="3149719">err</span>&nbsp;<span class="op" id="3149723">=</span>&nbsp;<span class="ident" id="3149725">accept</span><span class="op" id="3149731">(</span><span class="ident" id="3149732">fd</span><span class="op" id="3149734">.</span><span class="ident" id="3149735">sysfd</span><span class="op" id="3149740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149744">if</span>&nbsp;<span class="ident" id="3149747">err</span>&nbsp;<span class="op" id="3149751">!=</span>&nbsp;<span class="ident" id="3149754">nil</span>&nbsp;<span class="op" id="3149758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149763">if</span>&nbsp;<span class="ident" id="3149766">err</span>&nbsp;<span class="op" id="3149770">==</span>&nbsp;<span class="ident" id="3149773">syscall</span><span class="op" id="3149780">.</span><span class="ident" id="3149781">EAGAIN</span>&nbsp;<span class="op" id="3149788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149794">if</span>&nbsp;<span class="ident" id="3149797">err</span>&nbsp;<span class="op" id="3149801">=</span>&nbsp;<span class="ident" id="3149803">fd</span><span class="op" id="3149805">.</span><span class="ident" id="3149806">pd</span><span class="op" id="3149808">.</span><span class="ident" id="3149809">WaitRead</span><span class="op" id="3149817">(</span><span class="op" id="3149818">)</span><span class="op" id="3149819">;</span>&nbsp;<span class="ident" id="3149821">err</span>&nbsp;<span class="op" id="3149825">==</span>&nbsp;<span class="ident" id="3149828">nil</span>&nbsp;<span class="op" id="3149832">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149839">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149857">}</span>&nbsp;<span class="keyword" id="3149859">else</span>&nbsp;<span class="keyword" id="3149864">if</span>&nbsp;<span class="ident" id="3149867">err</span>&nbsp;<span class="op" id="3149871">==</span>&nbsp;<span class="ident" id="3149874">syscall</span><span class="op" id="3149881">.</span><span class="ident" id="3149882">ECONNABORTED</span>&nbsp;<span class="op" id="3149895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149901">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149964">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150030">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150047">return</span>&nbsp;<span class="ident" id="3150054">nil</span><span class="op" id="3150057">,</span>&nbsp;<span class="op" id="3150059">&amp;</span><span class="ident" id="3150060">OpError</span><span class="op" id="3150067">{</span><span class="string" id="3150068">&#34;accept&#34;</span><span class="op" id="3150076">,</span>&nbsp;<span class="ident" id="3150078">fd</span><span class="op" id="3150080">.</span><span class="ident" id="3150081">net</span><span class="op" id="3150084">,</span>&nbsp;<span class="ident" id="3150086">fd</span><span class="op" id="3150088">.</span><span class="ident" id="3150089">laddr</span><span class="op" id="3150094">,</span>&nbsp;<span class="ident" id="3150096">err</span><span class="op" id="3150099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150107">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150118">if</span>&nbsp;<span class="ident" id="3150121">netfd</span><span class="op" id="3150126">,</span>&nbsp;<span class="ident" id="3150128">err</span>&nbsp;<span class="op" id="3150132">=</span>&nbsp;<span class="ident" id="3150134">newFD</span><span class="op" id="3150139">(</span><span class="ident" id="3150140">s</span><span class="op" id="3150141">,</span>&nbsp;<span class="ident" id="3150143">fd</span><span class="op" id="3150145">.</span><span class="ident" id="3150146">family</span><span class="op" id="3150152">,</span>&nbsp;<span class="ident" id="3150154">fd</span><span class="op" id="3150156">.</span><span class="ident" id="3150157">sotype</span><span class="op" id="3150163">,</span>&nbsp;<span class="ident" id="3150165">fd</span><span class="op" id="3150167">.</span><span class="ident" id="3150168">net</span><span class="op" id="3150171">)</span><span class="op" id="3150172">;</span>&nbsp;<span class="ident" id="3150174">err</span>&nbsp;<span class="op" id="3150178">!=</span>&nbsp;<span class="ident" id="3150181">nil</span>&nbsp;<span class="op" id="3150185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150189">closesocket</span><span class="op" id="3150200">(</span><span class="ident" id="3150201">s</span><span class="op" id="3150202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150206">return</span>&nbsp;<span class="ident" id="3150213">nil</span><span class="op" id="3150216">,</span>&nbsp;<span class="ident" id="3150218">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150226">if</span>&nbsp;<span class="ident" id="3150229">err</span>&nbsp;<span class="op" id="3150233">=</span>&nbsp;<span class="ident" id="3150235">netfd</span><span class="op" id="3150240">.</span><span class="ident" id="3150241">init</span><span class="op" id="3150245">(</span><span class="op" id="3150246">)</span><span class="op" id="3150247">;</span>&nbsp;<span class="ident" id="3150249">err</span>&nbsp;<span class="op" id="3150253">!=</span>&nbsp;<span class="ident" id="3150256">nil</span>&nbsp;<span class="op" id="3150260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150264">fd</span><span class="op" id="3150266">.</span><span class="ident" id="3150267">Close</span><span class="op" id="3150272">(</span><span class="op" id="3150273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150277">return</span>&nbsp;<span class="ident" id="3150284">nil</span><span class="op" id="3150287">,</span>&nbsp;<span class="ident" id="3150289">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150294">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150297">lsa</span><span class="op" id="3150300">,</span>&nbsp;<span class="ident" id="3150302">_</span>&nbsp;<span class="op" id="3150304">:=</span>&nbsp;<span class="ident" id="3150307">syscall</span><span class="op" id="3150314">.</span><span class="ident" id="3150315">Getsockname</span><span class="op" id="3150326">(</span><span class="ident" id="3150327">netfd</span><span class="op" id="3150332">.</span><span class="ident" id="3150333">sysfd</span><span class="op" id="3150338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150341">netfd</span><span class="op" id="3150346">.</span><span class="ident" id="3150347">setAddr</span><span class="op" id="3150354">(</span><span class="ident" id="3150355">netfd</span><span class="op" id="3150360">.</span><span class="ident" id="3150361">addrFunc</span><span class="op" id="3150369">(</span><span class="op" id="3150370">)</span><span class="op" id="3150371">(</span><span class="ident" id="3150372">lsa</span><span class="op" id="3150375">)</span><span class="op" id="3150376">,</span>&nbsp;<span class="ident" id="3150378">netfd</span><span class="op" id="3150383">.</span><span class="ident" id="3150384">addrFunc</span><span class="op" id="3150392">(</span><span class="op" id="3150393">)</span><span class="op" id="3150394">(</span><span class="ident" id="3150395">rsa</span><span class="op" id="3150398">)</span><span class="op" id="3150399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150402">return</span>&nbsp;<span class="ident" id="3150409">netfd</span><span class="op" id="3150414">,</span>&nbsp;<span class="ident" id="3150416">nil</span><br>
<span class="lineno"></span><span class="op" id="3150420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3150423">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3150490">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3150545">var</span>&nbsp;<span class="ident" id="3150549">tryDupCloexec</span>&nbsp;<span class="op" id="3150563">=</span>&nbsp;<span class="builtintype" id="3150565">int32</span><span class="op" id="3150570">(</span><span class="num" id="3150571">1</span><span class="op" id="3150572">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3150575">func</span>&nbsp;<span class="ident" id="3150580">dupCloseOnExec</span><span class="op" id="3150594">(</span><span class="ident" id="3150595">fd</span>&nbsp;<span class="builtintype" id="3150598">int</span><span class="op" id="3150601">)</span>&nbsp;<span class="op" id="3150603">(</span><span class="ident" id="3150604">newfd</span>&nbsp;<span class="builtintype" id="3150610">int</span><span class="op" id="3150613">,</span>&nbsp;<span class="ident" id="3150615">err</span>&nbsp;<span class="builtintype" id="3150619">error</span><span class="op" id="3150624">)</span>&nbsp;<span class="op" id="3150626">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150629">if</span>&nbsp;<span class="ident" id="3150632">atomic</span><span class="op" id="3150638">.</span><span class="ident" id="3150639">LoadInt32</span><span class="op" id="3150648">(</span><span class="op" id="3150649">&amp;</span><span class="ident" id="3150650">tryDupCloexec</span><span class="op" id="3150663">)</span>&nbsp;<span class="op" id="3150665">==</span>&nbsp;<span class="num" id="3150668">1</span>&nbsp;<span class="op" id="3150670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150674">r0</span><span class="op" id="3150676">,</span>&nbsp;<span class="ident" id="3150678">_</span><span class="op" id="3150679">,</span>&nbsp;<span class="ident" id="3150681">e1</span>&nbsp;<span class="op" id="3150684">:=</span>&nbsp;<span class="ident" id="3150687">syscall</span><span class="op" id="3150694">.</span><span class="ident" id="3150695">Syscall</span><span class="op" id="3150702">(</span><span class="ident" id="3150703">syscall</span><span class="op" id="3150710">.</span><span class="ident" id="3150711">SYS_FCNTL</span><span class="op" id="3150720">,</span>&nbsp;<span class="builtintype" id="3150722">uintptr</span><span class="op" id="3150729">(</span><span class="ident" id="3150730">fd</span><span class="op" id="3150732">)</span><span class="op" id="3150733">,</span>&nbsp;<span class="ident" id="3150735">syscall</span><span class="op" id="3150742">.</span><span class="ident" id="3150743">F_DUPFD_CLOEXEC</span><span class="op" id="3150758">,</span>&nbsp;<span class="num" id="3150760">0</span><span class="op" id="3150761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150765">if</span>&nbsp;<span class="ident" id="3150768">runtime</span><span class="op" id="3150775">.</span><span class="ident" id="3150776">GOOS</span>&nbsp;<span class="op" id="3150781">==</span>&nbsp;<span class="string" id="3150784">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3150793">&amp;&amp;</span>&nbsp;<span class="ident" id="3150796">e1</span>&nbsp;<span class="op" id="3150799">==</span>&nbsp;<span class="ident" id="3150802">syscall</span><span class="op" id="3150809">.</span><span class="ident" id="3150810">EBADF</span>&nbsp;<span class="op" id="3150816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150821">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150871">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150918">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150966">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151015">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151059">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151103">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151148">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151171">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151226">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151241">e1</span>&nbsp;<span class="op" id="3151244">=</span>&nbsp;<span class="ident" id="3151246">syscall</span><span class="op" id="3151253">.</span><span class="ident" id="3151254">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151263">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151267">switch</span>&nbsp;<span class="ident" id="3151274">e1</span>&nbsp;<span class="op" id="3151277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151281">case</span>&nbsp;<span class="num" id="3151286">0</span><span class="op" id="3151287">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151292">return</span>&nbsp;<span class="builtintype" id="3151299">int</span><span class="op" id="3151302">(</span><span class="ident" id="3151303">r0</span><span class="op" id="3151305">)</span><span class="op" id="3151306">,</span>&nbsp;<span class="ident" id="3151308">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151314">case</span>&nbsp;<span class="ident" id="3151319">syscall</span><span class="op" id="3151326">.</span><span class="ident" id="3151327">EINVAL</span><span class="op" id="3151333">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151338">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151386">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151405">atomic</span><span class="op" id="3151411">.</span><span class="ident" id="3151412">StoreInt32</span><span class="op" id="3151422">(</span><span class="op" id="3151423">&amp;</span><span class="ident" id="3151424">tryDupCloexec</span><span class="op" id="3151437">,</span>&nbsp;<span class="num" id="3151439">0</span><span class="op" id="3151440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151444">default</span><span class="op" id="3151451">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151456">return</span>&nbsp;<span class="op" id="3151463">-</span><span class="num" id="3151464">1</span><span class="op" id="3151465">,</span>&nbsp;<span class="ident" id="3151467">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151472">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151478">return</span>&nbsp;<span class="ident" id="3151485">dupCloseOnExecOld</span><span class="op" id="3151502">(</span><span class="ident" id="3151503">fd</span><span class="op" id="3151505">)</span><br>
<span class="lineno"></span><span class="op" id="3151507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3151510">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3151575">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3151625">func</span>&nbsp;<span class="ident" id="3151630">dupCloseOnExecOld</span><span class="op" id="3151647">(</span><span class="ident" id="3151648">fd</span>&nbsp;<span class="builtintype" id="3151651">int</span><span class="op" id="3151654">)</span>&nbsp;<span class="op" id="3151656">(</span><span class="ident" id="3151657">newfd</span>&nbsp;<span class="builtintype" id="3151663">int</span><span class="op" id="3151666">,</span>&nbsp;<span class="ident" id="3151668">err</span>&nbsp;<span class="builtintype" id="3151672">error</span><span class="op" id="3151677">)</span>&nbsp;<span class="op" id="3151679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151682">syscall</span><span class="op" id="3151689">.</span><span class="ident" id="3151690">ForkLock</span><span class="op" id="3151698">.</span><span class="ident" id="3151699">RLock</span><span class="op" id="3151704">(</span><span class="op" id="3151705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151708">defer</span>&nbsp;<span class="ident" id="3151714">syscall</span><span class="op" id="3151721">.</span><span class="ident" id="3151722">ForkLock</span><span class="op" id="3151730">.</span><span class="ident" id="3151731">RUnlock</span><span class="op" id="3151738">(</span><span class="op" id="3151739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151742">newfd</span><span class="op" id="3151747">,</span>&nbsp;<span class="ident" id="3151749">err</span>&nbsp;<span class="op" id="3151753">=</span>&nbsp;<span class="ident" id="3151755">syscall</span><span class="op" id="3151762">.</span><span class="ident" id="3151763">Dup</span><span class="op" id="3151766">(</span><span class="ident" id="3151767">fd</span><span class="op" id="3151769">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151772">if</span>&nbsp;<span class="ident" id="3151775">err</span>&nbsp;<span class="op" id="3151779">!=</span>&nbsp;<span class="ident" id="3151782">nil</span>&nbsp;<span class="op" id="3151786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151790">return</span>&nbsp;<span class="op" id="3151797">-</span><span class="num" id="3151798">1</span><span class="op" id="3151799">,</span>&nbsp;<span class="ident" id="3151801">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151809">syscall</span><span class="op" id="3151816">.</span><span class="ident" id="3151817">CloseOnExec</span><span class="op" id="3151828">(</span><span class="ident" id="3151829">newfd</span><span class="op" id="3151834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151837">return</span><br>
<span class="lineno">490</span><span class="op" id="3151844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3151847">func</span>&nbsp;<span class="op" id="3151852">(</span><span class="ident" id="3151853">fd</span>&nbsp;<span class="op" id="3151856">*</span><span class="ident" id="3151857">netFD</span><span class="op" id="3151862">)</span>&nbsp;<span class="ident" id="3151864">dup</span><span class="op" id="3151867">(</span><span class="op" id="3151868">)</span>&nbsp;<span class="op" id="3151870">(</span><span class="ident" id="3151871">f</span>&nbsp;<span class="op" id="3151873">*</span><span class="ident" id="3151874">os</span><span class="op" id="3151876">.</span><span class="ident" id="3151877">File</span><span class="op" id="3151881">,</span>&nbsp;<span class="ident" id="3151883">err</span>&nbsp;<span class="builtintype" id="3151887">error</span><span class="op" id="3151892">)</span>&nbsp;<span class="op" id="3151894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151897">ns</span><span class="op" id="3151899">,</span>&nbsp;<span class="ident" id="3151901">err</span>&nbsp;<span class="op" id="3151905">:=</span>&nbsp;<span class="ident" id="3151908">dupCloseOnExec</span><span class="op" id="3151922">(</span><span class="ident" id="3151923">fd</span><span class="op" id="3151925">.</span><span class="ident" id="3151926">sysfd</span><span class="op" id="3151931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151934">if</span>&nbsp;<span class="ident" id="3151937">err</span>&nbsp;<span class="op" id="3151941">!=</span>&nbsp;<span class="ident" id="3151944">nil</span>&nbsp;<span class="op" id="3151948">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151952">return</span>&nbsp;<span class="ident" id="3151959">nil</span><span class="op" id="3151962">,</span>&nbsp;<span class="op" id="3151964">&amp;</span><span class="ident" id="3151965">OpError</span><span class="op" id="3151972">{</span><span class="string" id="3151973">&#34;dup&#34;</span><span class="op" id="3151978">,</span>&nbsp;<span class="ident" id="3151980">fd</span><span class="op" id="3151982">.</span><span class="ident" id="3151983">net</span><span class="op" id="3151986">,</span>&nbsp;<span class="ident" id="3151988">fd</span><span class="op" id="3151990">.</span><span class="ident" id="3151991">laddr</span><span class="op" id="3151996">,</span>&nbsp;<span class="ident" id="3151998">err</span><span class="op" id="3152001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152008">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152077">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152140">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152214">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152270">if</span>&nbsp;<span class="ident" id="3152273">err</span>&nbsp;<span class="op" id="3152277">=</span>&nbsp;<span class="ident" id="3152279">syscall</span><span class="op" id="3152286">.</span><span class="ident" id="3152287">SetNonblock</span><span class="op" id="3152298">(</span><span class="ident" id="3152299">ns</span><span class="op" id="3152301">,</span>&nbsp;<span class="builtintype" id="3152303">false</span><span class="op" id="3152308">)</span><span class="op" id="3152309">;</span>&nbsp;<span class="ident" id="3152311">err</span>&nbsp;<span class="op" id="3152315">!=</span>&nbsp;<span class="ident" id="3152318">nil</span>&nbsp;<span class="op" id="3152322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152326">return</span>&nbsp;<span class="ident" id="3152333">nil</span><span class="op" id="3152336">,</span>&nbsp;<span class="op" id="3152338">&amp;</span><span class="ident" id="3152339">OpError</span><span class="op" id="3152346">{</span><span class="string" id="3152347">&#34;setnonblock&#34;</span><span class="op" id="3152360">,</span>&nbsp;<span class="ident" id="3152362">fd</span><span class="op" id="3152364">.</span><span class="ident" id="3152365">net</span><span class="op" id="3152368">,</span>&nbsp;<span class="ident" id="3152370">fd</span><span class="op" id="3152372">.</span><span class="ident" id="3152373">laddr</span><span class="op" id="3152378">,</span>&nbsp;<span class="ident" id="3152380">err</span><span class="op" id="3152383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152386">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152390">return</span>&nbsp;<span class="ident" id="3152397">os</span><span class="op" id="3152399">.</span><span class="ident" id="3152400">NewFile</span><span class="op" id="3152407">(</span><span class="builtintype" id="3152408">uintptr</span><span class="op" id="3152415">(</span><span class="ident" id="3152416">ns</span><span class="op" id="3152418">)</span><span class="op" id="3152419">,</span>&nbsp;<span class="ident" id="3152421">fd</span><span class="op" id="3152423">.</span><span class="ident" id="3152424">name</span><span class="op" id="3152428">(</span><span class="op" id="3152429">)</span><span class="op" id="3152430">)</span><span class="op" id="3152431">,</span>&nbsp;<span class="ident" id="3152433">nil</span><br>
<span class="lineno"></span><span class="op" id="3152437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3152440">func</span>&nbsp;<span class="ident" id="3152445">closesocket</span><span class="op" id="3152456">(</span><span class="ident" id="3152457">s</span>&nbsp;<span class="builtintype" id="3152459">int</span><span class="op" id="3152462">)</span>&nbsp;<span class="builtintype" id="3152464">error</span>&nbsp;<span class="op" id="3152470">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152473">return</span>&nbsp;<span class="ident" id="3152480">syscall</span><span class="op" id="3152487">.</span><span class="ident" id="3152488">Close</span><span class="op" id="3152493">(</span><span class="ident" id="3152494">s</span><span class="op" id="3152495">)</span><br>
<span class="lineno"></span><span class="op" id="3152497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3152500">func</span>&nbsp;<span class="ident" id="3152505">skipRawSocketTests</span><span class="op" id="3152523">(</span><span class="op" id="3152524">)</span>&nbsp;<span class="op" id="3152526">(</span><span class="ident" id="3152527">skip</span>&nbsp;<span class="builtintype" id="3152532">bool</span><span class="op" id="3152536">,</span>&nbsp;<span class="ident" id="3152538">skipmsg</span>&nbsp;<span class="builtintype" id="3152546">string</span><span class="op" id="3152552">,</span>&nbsp;<span class="ident" id="3152554">err</span>&nbsp;<span class="builtintype" id="3152558">error</span><span class="op" id="3152563">)</span>&nbsp;<span class="op" id="3152565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152568">if</span>&nbsp;<span class="ident" id="3152571">os</span><span class="op" id="3152573">.</span><span class="ident" id="3152574">Getuid</span><span class="op" id="3152580">(</span><span class="op" id="3152581">)</span>&nbsp;<span class="op" id="3152583">!=</span>&nbsp;<span class="num" id="3152586">0</span>&nbsp;<span class="op" id="3152588">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152592">return</span>&nbsp;<span class="builtintype" id="3152599">true</span><span class="op" id="3152603">,</span>&nbsp;<span class="string" id="3152605">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3152634">,</span>&nbsp;<span class="ident" id="3152636">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152644">return</span>&nbsp;<span class="builtintype" id="3152651">false</span><span class="op" id="3152656">,</span>&nbsp;<span class="string" id="3152658">&#34;&#34;</span><span class="op" id="3152660">,</span>&nbsp;<span class="ident" id="3152662">nil</span><br>
<span class="lineno"></span><span class="op" id="3152666">}</span>
</div>
</body>
</html>
