<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5598216">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5598271">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5598325">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5598376">package</span>&nbsp;<span class="ident" id="5598384">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5598389">import</span>&nbsp;<span class="op" id="5598396">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5598399">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5598408">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5598425">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5598439">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5598448">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5598463">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5598469">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5598479">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5598482">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="5598525">type</span>&nbsp;<span class="ident" id="5598530">Encoder</span>&nbsp;<span class="keyword" id="5598538">struct</span>&nbsp;<span class="op" id="5598545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598548">CompressionLevel</span>&nbsp;<span class="ident" id="5598565">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="5598582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5598585">type</span>&nbsp;<span class="ident" id="5598590">encoder</span>&nbsp;<span class="keyword" id="5598598">struct</span>&nbsp;<span class="op" id="5598605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598608">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5598615">*</span><span class="ident" id="5598616">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598625">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5598632">io</span><span class="op" id="5598634">.</span><span class="ident" id="5598635">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598643">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5598650">image</span><span class="op" id="5598655">.</span><span class="ident" id="5598656">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598663">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5598670">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598675">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5598682">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598689">header</span>&nbsp;<span class="op" id="5598696">[</span><span class="num" id="5598697">8</span><span class="op" id="5598698">]</span><span class="builtintype" id="5598699">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598705">footer</span>&nbsp;<span class="op" id="5598712">[</span><span class="num" id="5598713">4</span><span class="op" id="5598714">]</span><span class="builtintype" id="5598715">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598721">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5598728">[</span><span class="num" id="5598729">4</span>&nbsp;<span class="op" id="5598731">*</span>&nbsp;<span class="num" id="5598733">256</span><span class="op" id="5598736">]</span><span class="builtintype" id="5598737">byte</span><br>
<span class="lineno"></span><span class="op" id="5598742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5598745">type</span>&nbsp;<span class="ident" id="5598750">CompressionLevel</span>&nbsp;<span class="builtintype" id="5598767">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5598772">const</span>&nbsp;<span class="op" id="5598778">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598781">DefaultCompression</span>&nbsp;<span class="ident" id="5598800">CompressionLevel</span>&nbsp;<span class="op" id="5598817">=</span>&nbsp;<span class="num" id="5598819">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598822">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5598841">CompressionLevel</span>&nbsp;<span class="op" id="5598858">=</span>&nbsp;<span class="op" id="5598860">-</span><span class="num" id="5598861">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598864">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5598883">CompressionLevel</span>&nbsp;<span class="op" id="5598900">=</span>&nbsp;<span class="op" id="5598902">-</span><span class="num" id="5598903">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598906">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5598925">CompressionLevel</span>&nbsp;<span class="op" id="5598942">=</span>&nbsp;<span class="op" id="5598944">-</span><span class="num" id="5598945">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598949">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5599022">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="5599082">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5599085">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5599100">func</span>&nbsp;<span class="ident" id="5599105">writeUint32</span><span class="op" id="5599116">(</span><span class="ident" id="5599117">b</span>&nbsp;<span class="op" id="5599119">[</span><span class="op" id="5599120">]</span><span class="builtintype" id="5599121">uint8</span><span class="op" id="5599126">,</span>&nbsp;<span class="ident" id="5599128">u</span>&nbsp;<span class="builtintype" id="5599130">uint32</span><span class="op" id="5599136">)</span>&nbsp;<span class="op" id="5599138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599141">b</span><span class="op" id="5599142">[</span><span class="num" id="5599143">0</span><span class="op" id="5599144">]</span>&nbsp;<span class="op" id="5599146">=</span>&nbsp;<span class="builtintype" id="5599148">uint8</span><span class="op" id="5599153">(</span><span class="ident" id="5599154">u</span>&nbsp;<span class="op" id="5599156">&gt;&gt;</span>&nbsp;<span class="num" id="5599159">24</span><span class="op" id="5599161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599164">b</span><span class="op" id="5599165">[</span><span class="num" id="5599166">1</span><span class="op" id="5599167">]</span>&nbsp;<span class="op" id="5599169">=</span>&nbsp;<span class="builtintype" id="5599171">uint8</span><span class="op" id="5599176">(</span><span class="ident" id="5599177">u</span>&nbsp;<span class="op" id="5599179">&gt;&gt;</span>&nbsp;<span class="num" id="5599182">16</span><span class="op" id="5599184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599187">b</span><span class="op" id="5599188">[</span><span class="num" id="5599189">2</span><span class="op" id="5599190">]</span>&nbsp;<span class="op" id="5599192">=</span>&nbsp;<span class="builtintype" id="5599194">uint8</span><span class="op" id="5599199">(</span><span class="ident" id="5599200">u</span>&nbsp;<span class="op" id="5599202">&gt;&gt;</span>&nbsp;<span class="num" id="5599205">8</span><span class="op" id="5599206">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599209">b</span><span class="op" id="5599210">[</span><span class="num" id="5599211">3</span><span class="op" id="5599212">]</span>&nbsp;<span class="op" id="5599214">=</span>&nbsp;<span class="builtintype" id="5599216">uint8</span><span class="op" id="5599221">(</span><span class="ident" id="5599222">u</span>&nbsp;<span class="op" id="5599224">&gt;&gt;</span>&nbsp;<span class="num" id="5599227">0</span><span class="op" id="5599228">)</span><br>
<span class="lineno"></span><span class="op" id="5599230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5599233">type</span>&nbsp;<span class="ident" id="5599238">opaquer</span>&nbsp;<span class="keyword" id="5599246">interface</span>&nbsp;<span class="op" id="5599256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599259">Opaque</span><span class="op" id="5599265">(</span><span class="op" id="5599266">)</span>&nbsp;<span class="builtintype" id="5599268">bool</span><br>
<span class="lineno">55</span><span class="op" id="5599273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5599276">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5599329">func</span>&nbsp;<span class="ident" id="5599334">opaque</span><span class="op" id="5599340">(</span><span class="ident" id="5599341">m</span>&nbsp;<span class="ident" id="5599343">image</span><span class="op" id="5599348">.</span><span class="ident" id="5599349">Image</span><span class="op" id="5599354">)</span>&nbsp;<span class="builtintype" id="5599356">bool</span>&nbsp;<span class="op" id="5599361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599364">if</span>&nbsp;<span class="ident" id="5599367">o</span><span class="op" id="5599368">,</span>&nbsp;<span class="ident" id="5599370">ok</span>&nbsp;<span class="op" id="5599373">:=</span>&nbsp;<span class="ident" id="5599376">m</span><span class="op" id="5599377">.</span><span class="op" id="5599378">(</span><span class="ident" id="5599379">opaquer</span><span class="op" id="5599386">)</span><span class="op" id="5599387">;</span>&nbsp;<span class="ident" id="5599389">ok</span>&nbsp;<span class="op" id="5599392">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599396">return</span>&nbsp;<span class="ident" id="5599403">o</span><span class="op" id="5599404">.</span><span class="ident" id="5599405">Opaque</span><span class="op" id="5599411">(</span><span class="op" id="5599412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599418">b</span>&nbsp;<span class="op" id="5599420">:=</span>&nbsp;<span class="ident" id="5599423">m</span><span class="op" id="5599424">.</span><span class="ident" id="5599425">Bounds</span><span class="op" id="5599431">(</span><span class="op" id="5599432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599435">for</span>&nbsp;<span class="ident" id="5599439">y</span>&nbsp;<span class="op" id="5599441">:=</span>&nbsp;<span class="ident" id="5599444">b</span><span class="op" id="5599445">.</span><span class="ident" id="5599446">Min</span><span class="op" id="5599449">.</span><span class="ident" id="5599450">Y</span><span class="op" id="5599451">;</span>&nbsp;<span class="ident" id="5599453">y</span>&nbsp;<span class="op" id="5599455">&lt;</span>&nbsp;<span class="ident" id="5599457">b</span><span class="op" id="5599458">.</span><span class="ident" id="5599459">Max</span><span class="op" id="5599462">.</span><span class="ident" id="5599463">Y</span><span class="op" id="5599464">;</span>&nbsp;<span class="ident" id="5599466">y</span><span class="op" id="5599467">++</span>&nbsp;<span class="op" id="5599470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599474">for</span>&nbsp;<span class="ident" id="5599478">x</span>&nbsp;<span class="op" id="5599480">:=</span>&nbsp;<span class="ident" id="5599483">b</span><span class="op" id="5599484">.</span><span class="ident" id="5599485">Min</span><span class="op" id="5599488">.</span><span class="ident" id="5599489">X</span><span class="op" id="5599490">;</span>&nbsp;<span class="ident" id="5599492">x</span>&nbsp;<span class="op" id="5599494">&lt;</span>&nbsp;<span class="ident" id="5599496">b</span><span class="op" id="5599497">.</span><span class="ident" id="5599498">Max</span><span class="op" id="5599501">.</span><span class="ident" id="5599502">X</span><span class="op" id="5599503">;</span>&nbsp;<span class="ident" id="5599505">x</span><span class="op" id="5599506">++</span>&nbsp;<span class="op" id="5599509">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599514">_</span><span class="op" id="5599515">,</span>&nbsp;<span class="ident" id="5599517">_</span><span class="op" id="5599518">,</span>&nbsp;<span class="ident" id="5599520">_</span><span class="op" id="5599521">,</span>&nbsp;<span class="ident" id="5599523">a</span>&nbsp;<span class="op" id="5599525">:=</span>&nbsp;<span class="ident" id="5599528">m</span><span class="op" id="5599529">.</span><span class="ident" id="5599530">At</span><span class="op" id="5599532">(</span><span class="ident" id="5599533">x</span><span class="op" id="5599534">,</span>&nbsp;<span class="ident" id="5599536">y</span><span class="op" id="5599537">)</span><span class="op" id="5599538">.</span><span class="ident" id="5599539">RGBA</span><span class="op" id="5599543">(</span><span class="op" id="5599544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599549">if</span>&nbsp;<span class="ident" id="5599552">a</span>&nbsp;<span class="op" id="5599554">!=</span>&nbsp;<span class="num" id="5599557">0xffff</span>&nbsp;<span class="op" id="5599564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599570">return</span>&nbsp;<span class="builtintype" id="5599577">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599590">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599596">return</span>&nbsp;<span class="builtintype" id="5599603">true</span><br>
<span class="lineno"></span><span class="op" id="5599608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5599611">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="5599673">func</span>&nbsp;<span class="ident" id="5599678">abs8</span><span class="op" id="5599682">(</span><span class="ident" id="5599683">d</span>&nbsp;<span class="builtintype" id="5599685">uint8</span><span class="op" id="5599690">)</span>&nbsp;<span class="builtintype" id="5599692">int</span>&nbsp;<span class="op" id="5599696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599699">if</span>&nbsp;<span class="ident" id="5599702">d</span>&nbsp;<span class="op" id="5599704">&lt;</span>&nbsp;<span class="num" id="5599706">128</span>&nbsp;<span class="op" id="5599710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599714">return</span>&nbsp;<span class="builtintype" id="5599721">int</span><span class="op" id="5599724">(</span><span class="ident" id="5599725">d</span><span class="op" id="5599726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599732">return</span>&nbsp;<span class="num" id="5599739">256</span>&nbsp;<span class="op" id="5599743">-</span>&nbsp;<span class="builtintype" id="5599745">int</span><span class="op" id="5599748">(</span><span class="ident" id="5599749">d</span><span class="op" id="5599750">)</span><br>
<span class="lineno">80</span><span class="op" id="5599752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5599755">func</span>&nbsp;<span class="op" id="5599760">(</span><span class="ident" id="5599761">e</span>&nbsp;<span class="op" id="5599763">*</span><span class="ident" id="5599764">encoder</span><span class="op" id="5599771">)</span>&nbsp;<span class="ident" id="5599773">writeChunk</span><span class="op" id="5599783">(</span><span class="ident" id="5599784">b</span>&nbsp;<span class="op" id="5599786">[</span><span class="op" id="5599787">]</span><span class="builtintype" id="5599788">byte</span><span class="op" id="5599792">,</span>&nbsp;<span class="ident" id="5599794">name</span>&nbsp;<span class="builtintype" id="5599799">string</span><span class="op" id="5599805">)</span>&nbsp;<span class="op" id="5599807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599810">if</span>&nbsp;<span class="ident" id="5599813">e</span><span class="op" id="5599814">.</span><span class="ident" id="5599815">err</span>&nbsp;<span class="op" id="5599819">!=</span>&nbsp;<span class="ident" id="5599822">nil</span>&nbsp;<span class="op" id="5599826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599830">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599841">n</span>&nbsp;<span class="op" id="5599843">:=</span>&nbsp;<span class="builtintype" id="5599846">uint32</span><span class="op" id="5599852">(</span><span class="builtinfunc" id="5599853">len</span><span class="op" id="5599856">(</span><span class="ident" id="5599857">b</span><span class="op" id="5599858">)</span><span class="op" id="5599859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599862">if</span>&nbsp;<span class="builtintype" id="5599865">int</span><span class="op" id="5599868">(</span><span class="ident" id="5599869">n</span><span class="op" id="5599870">)</span>&nbsp;<span class="op" id="5599872">!=</span>&nbsp;<span class="builtinfunc" id="5599875">len</span><span class="op" id="5599878">(</span><span class="ident" id="5599879">b</span><span class="op" id="5599880">)</span>&nbsp;<span class="op" id="5599882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599886">e</span><span class="op" id="5599887">.</span><span class="ident" id="5599888">err</span>&nbsp;<span class="op" id="5599892">=</span>&nbsp;<span class="ident" id="5599894">UnsupportedError</span><span class="op" id="5599910">(</span><span class="ident" id="5599911">name</span>&nbsp;<span class="op" id="5599916">+</span>&nbsp;<span class="string" id="5599918">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="5599942">+</span>&nbsp;<span class="ident" id="5599944">strconv</span><span class="op" id="5599951">.</span><span class="ident" id="5599952">Itoa</span><span class="op" id="5599956">(</span><span class="builtinfunc" id="5599957">len</span><span class="op" id="5599960">(</span><span class="ident" id="5599961">b</span><span class="op" id="5599962">)</span><span class="op" id="5599963">)</span><span class="op" id="5599964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5599968">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599979">writeUint32</span><span class="op" id="5599990">(</span><span class="ident" id="5599991">e</span><span class="op" id="5599992">.</span><span class="ident" id="5599993">header</span><span class="op" id="5599999">[</span><span class="op" id="5600000">:</span><span class="num" id="5600001">4</span><span class="op" id="5600002">]</span><span class="op" id="5600003">,</span>&nbsp;<span class="ident" id="5600005">n</span><span class="op" id="5600006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600009">e</span><span class="op" id="5600010">.</span><span class="ident" id="5600011">header</span><span class="op" id="5600017">[</span><span class="num" id="5600018">4</span><span class="op" id="5600019">]</span>&nbsp;<span class="op" id="5600021">=</span>&nbsp;<span class="ident" id="5600023">name</span><span class="op" id="5600027">[</span><span class="num" id="5600028">0</span><span class="op" id="5600029">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600032">e</span><span class="op" id="5600033">.</span><span class="ident" id="5600034">header</span><span class="op" id="5600040">[</span><span class="num" id="5600041">5</span><span class="op" id="5600042">]</span>&nbsp;<span class="op" id="5600044">=</span>&nbsp;<span class="ident" id="5600046">name</span><span class="op" id="5600050">[</span><span class="num" id="5600051">1</span><span class="op" id="5600052">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600055">e</span><span class="op" id="5600056">.</span><span class="ident" id="5600057">header</span><span class="op" id="5600063">[</span><span class="num" id="5600064">6</span><span class="op" id="5600065">]</span>&nbsp;<span class="op" id="5600067">=</span>&nbsp;<span class="ident" id="5600069">name</span><span class="op" id="5600073">[</span><span class="num" id="5600074">2</span><span class="op" id="5600075">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600078">e</span><span class="op" id="5600079">.</span><span class="ident" id="5600080">header</span><span class="op" id="5600086">[</span><span class="num" id="5600087">7</span><span class="op" id="5600088">]</span>&nbsp;<span class="op" id="5600090">=</span>&nbsp;<span class="ident" id="5600092">name</span><span class="op" id="5600096">[</span><span class="num" id="5600097">3</span><span class="op" id="5600098">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600101">crc</span>&nbsp;<span class="op" id="5600105">:=</span>&nbsp;<span class="ident" id="5600108">crc32</span><span class="op" id="5600113">.</span><span class="ident" id="5600114">NewIEEE</span><span class="op" id="5600121">(</span><span class="op" id="5600122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600125">crc</span><span class="op" id="5600128">.</span><span class="ident" id="5600129">Write</span><span class="op" id="5600134">(</span><span class="ident" id="5600135">e</span><span class="op" id="5600136">.</span><span class="ident" id="5600137">header</span><span class="op" id="5600143">[</span><span class="num" id="5600144">4</span><span class="op" id="5600145">:</span><span class="num" id="5600146">8</span><span class="op" id="5600147">]</span><span class="op" id="5600148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600151">crc</span><span class="op" id="5600154">.</span><span class="ident" id="5600155">Write</span><span class="op" id="5600160">(</span><span class="ident" id="5600161">b</span><span class="op" id="5600162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600165">writeUint32</span><span class="op" id="5600176">(</span><span class="ident" id="5600177">e</span><span class="op" id="5600178">.</span><span class="ident" id="5600179">footer</span><span class="op" id="5600185">[</span><span class="op" id="5600186">:</span><span class="num" id="5600187">4</span><span class="op" id="5600188">]</span><span class="op" id="5600189">,</span>&nbsp;<span class="ident" id="5600191">crc</span><span class="op" id="5600194">.</span><span class="ident" id="5600195">Sum32</span><span class="op" id="5600200">(</span><span class="op" id="5600201">)</span><span class="op" id="5600202">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600206">_</span><span class="op" id="5600207">,</span>&nbsp;<span class="ident" id="5600209">e</span><span class="op" id="5600210">.</span><span class="ident" id="5600211">err</span>&nbsp;<span class="op" id="5600215">=</span>&nbsp;<span class="ident" id="5600217">e</span><span class="op" id="5600218">.</span><span class="ident" id="5600219">w</span><span class="op" id="5600220">.</span><span class="ident" id="5600221">Write</span><span class="op" id="5600226">(</span><span class="ident" id="5600227">e</span><span class="op" id="5600228">.</span><span class="ident" id="5600229">header</span><span class="op" id="5600235">[</span><span class="op" id="5600236">:</span><span class="num" id="5600237">8</span><span class="op" id="5600238">]</span><span class="op" id="5600239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600242">if</span>&nbsp;<span class="ident" id="5600245">e</span><span class="op" id="5600246">.</span><span class="ident" id="5600247">err</span>&nbsp;<span class="op" id="5600251">!=</span>&nbsp;<span class="ident" id="5600254">nil</span>&nbsp;<span class="op" id="5600258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600262">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600270">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600273">_</span><span class="op" id="5600274">,</span>&nbsp;<span class="ident" id="5600276">e</span><span class="op" id="5600277">.</span><span class="ident" id="5600278">err</span>&nbsp;<span class="op" id="5600282">=</span>&nbsp;<span class="ident" id="5600284">e</span><span class="op" id="5600285">.</span><span class="ident" id="5600286">w</span><span class="op" id="5600287">.</span><span class="ident" id="5600288">Write</span><span class="op" id="5600293">(</span><span class="ident" id="5600294">b</span><span class="op" id="5600295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600298">if</span>&nbsp;<span class="ident" id="5600301">e</span><span class="op" id="5600302">.</span><span class="ident" id="5600303">err</span>&nbsp;<span class="op" id="5600307">!=</span>&nbsp;<span class="ident" id="5600310">nil</span>&nbsp;<span class="op" id="5600314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600318">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600329">_</span><span class="op" id="5600330">,</span>&nbsp;<span class="ident" id="5600332">e</span><span class="op" id="5600333">.</span><span class="ident" id="5600334">err</span>&nbsp;<span class="op" id="5600338">=</span>&nbsp;<span class="ident" id="5600340">e</span><span class="op" id="5600341">.</span><span class="ident" id="5600342">w</span><span class="op" id="5600343">.</span><span class="ident" id="5600344">Write</span><span class="op" id="5600349">(</span><span class="ident" id="5600350">e</span><span class="op" id="5600351">.</span><span class="ident" id="5600352">footer</span><span class="op" id="5600358">[</span><span class="op" id="5600359">:</span><span class="num" id="5600360">4</span><span class="op" id="5600361">]</span><span class="op" id="5600362">)</span><br>
<span class="lineno">110</span><span class="op" id="5600364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5600367">func</span>&nbsp;<span class="op" id="5600372">(</span><span class="ident" id="5600373">e</span>&nbsp;<span class="op" id="5600375">*</span><span class="ident" id="5600376">encoder</span><span class="op" id="5600383">)</span>&nbsp;<span class="ident" id="5600385">writeIHDR</span><span class="op" id="5600394">(</span><span class="op" id="5600395">)</span>&nbsp;<span class="op" id="5600397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600400">b</span>&nbsp;<span class="op" id="5600402">:=</span>&nbsp;<span class="ident" id="5600405">e</span><span class="op" id="5600406">.</span><span class="ident" id="5600407">m</span><span class="op" id="5600408">.</span><span class="ident" id="5600409">Bounds</span><span class="op" id="5600415">(</span><span class="op" id="5600416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600419">writeUint32</span><span class="op" id="5600430">(</span><span class="ident" id="5600431">e</span><span class="op" id="5600432">.</span><span class="ident" id="5600433">tmp</span><span class="op" id="5600436">[</span><span class="num" id="5600437">0</span><span class="op" id="5600438">:</span><span class="num" id="5600439">4</span><span class="op" id="5600440">]</span><span class="op" id="5600441">,</span>&nbsp;<span class="builtintype" id="5600443">uint32</span><span class="op" id="5600449">(</span><span class="ident" id="5600450">b</span><span class="op" id="5600451">.</span><span class="ident" id="5600452">Dx</span><span class="op" id="5600454">(</span><span class="op" id="5600455">)</span><span class="op" id="5600456">)</span><span class="op" id="5600457">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600460">writeUint32</span><span class="op" id="5600471">(</span><span class="ident" id="5600472">e</span><span class="op" id="5600473">.</span><span class="ident" id="5600474">tmp</span><span class="op" id="5600477">[</span><span class="num" id="5600478">4</span><span class="op" id="5600479">:</span><span class="num" id="5600480">8</span><span class="op" id="5600481">]</span><span class="op" id="5600482">,</span>&nbsp;<span class="builtintype" id="5600484">uint32</span><span class="op" id="5600490">(</span><span class="ident" id="5600491">b</span><span class="op" id="5600492">.</span><span class="ident" id="5600493">Dy</span><span class="op" id="5600495">(</span><span class="op" id="5600496">)</span><span class="op" id="5600497">)</span><span class="op" id="5600498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5600501">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600535">switch</span>&nbsp;<span class="ident" id="5600542">e</span><span class="op" id="5600543">.</span><span class="ident" id="5600544">cb</span>&nbsp;<span class="op" id="5600547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600550">case</span>&nbsp;<span class="ident" id="5600555">cbG8</span><span class="op" id="5600559">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600563">e</span><span class="op" id="5600564">.</span><span class="ident" id="5600565">tmp</span><span class="op" id="5600568">[</span><span class="num" id="5600569">8</span><span class="op" id="5600570">]</span>&nbsp;<span class="op" id="5600572">=</span>&nbsp;<span class="num" id="5600574">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600578">e</span><span class="op" id="5600579">.</span><span class="ident" id="5600580">tmp</span><span class="op" id="5600583">[</span><span class="num" id="5600584">9</span><span class="op" id="5600585">]</span>&nbsp;<span class="op" id="5600587">=</span>&nbsp;<span class="ident" id="5600589">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600602">case</span>&nbsp;<span class="ident" id="5600607">cbTC8</span><span class="op" id="5600612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600616">e</span><span class="op" id="5600617">.</span><span class="ident" id="5600618">tmp</span><span class="op" id="5600621">[</span><span class="num" id="5600622">8</span><span class="op" id="5600623">]</span>&nbsp;<span class="op" id="5600625">=</span>&nbsp;<span class="num" id="5600627">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600631">e</span><span class="op" id="5600632">.</span><span class="ident" id="5600633">tmp</span><span class="op" id="5600636">[</span><span class="num" id="5600637">9</span><span class="op" id="5600638">]</span>&nbsp;<span class="op" id="5600640">=</span>&nbsp;<span class="ident" id="5600642">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600655">case</span>&nbsp;<span class="ident" id="5600660">cbP8</span><span class="op" id="5600664">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600668">e</span><span class="op" id="5600669">.</span><span class="ident" id="5600670">tmp</span><span class="op" id="5600673">[</span><span class="num" id="5600674">8</span><span class="op" id="5600675">]</span>&nbsp;<span class="op" id="5600677">=</span>&nbsp;<span class="num" id="5600679">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600683">e</span><span class="op" id="5600684">.</span><span class="ident" id="5600685">tmp</span><span class="op" id="5600688">[</span><span class="num" id="5600689">9</span><span class="op" id="5600690">]</span>&nbsp;<span class="op" id="5600692">=</span>&nbsp;<span class="ident" id="5600694">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600706">case</span>&nbsp;<span class="ident" id="5600711">cbTCA8</span><span class="op" id="5600717">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600721">e</span><span class="op" id="5600722">.</span><span class="ident" id="5600723">tmp</span><span class="op" id="5600726">[</span><span class="num" id="5600727">8</span><span class="op" id="5600728">]</span>&nbsp;<span class="op" id="5600730">=</span>&nbsp;<span class="num" id="5600732">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600736">e</span><span class="op" id="5600737">.</span><span class="ident" id="5600738">tmp</span><span class="op" id="5600741">[</span><span class="num" id="5600742">9</span><span class="op" id="5600743">]</span>&nbsp;<span class="op" id="5600745">=</span>&nbsp;<span class="ident" id="5600747">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600765">case</span>&nbsp;<span class="ident" id="5600770">cbG16</span><span class="op" id="5600775">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600779">e</span><span class="op" id="5600780">.</span><span class="ident" id="5600781">tmp</span><span class="op" id="5600784">[</span><span class="num" id="5600785">8</span><span class="op" id="5600786">]</span>&nbsp;<span class="op" id="5600788">=</span>&nbsp;<span class="num" id="5600790">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600795">e</span><span class="op" id="5600796">.</span><span class="ident" id="5600797">tmp</span><span class="op" id="5600800">[</span><span class="num" id="5600801">9</span><span class="op" id="5600802">]</span>&nbsp;<span class="op" id="5600804">=</span>&nbsp;<span class="ident" id="5600806">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600819">case</span>&nbsp;<span class="ident" id="5600824">cbTC16</span><span class="op" id="5600830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600834">e</span><span class="op" id="5600835">.</span><span class="ident" id="5600836">tmp</span><span class="op" id="5600839">[</span><span class="num" id="5600840">8</span><span class="op" id="5600841">]</span>&nbsp;<span class="op" id="5600843">=</span>&nbsp;<span class="num" id="5600845">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600850">e</span><span class="op" id="5600851">.</span><span class="ident" id="5600852">tmp</span><span class="op" id="5600855">[</span><span class="num" id="5600856">9</span><span class="op" id="5600857">]</span>&nbsp;<span class="op" id="5600859">=</span>&nbsp;<span class="ident" id="5600861">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5600874">case</span>&nbsp;<span class="ident" id="5600879">cbTCA16</span><span class="op" id="5600886">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600890">e</span><span class="op" id="5600891">.</span><span class="ident" id="5600892">tmp</span><span class="op" id="5600895">[</span><span class="num" id="5600896">8</span><span class="op" id="5600897">]</span>&nbsp;<span class="op" id="5600899">=</span>&nbsp;<span class="num" id="5600901">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600906">e</span><span class="op" id="5600907">.</span><span class="ident" id="5600908">tmp</span><span class="op" id="5600911">[</span><span class="num" id="5600912">9</span><span class="op" id="5600913">]</span>&nbsp;<span class="op" id="5600915">=</span>&nbsp;<span class="ident" id="5600917">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5600935">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600938">e</span><span class="op" id="5600939">.</span><span class="ident" id="5600940">tmp</span><span class="op" id="5600943">[</span><span class="num" id="5600944">10</span><span class="op" id="5600946">]</span>&nbsp;<span class="op" id="5600948">=</span>&nbsp;<span class="num" id="5600950">0</span>&nbsp;<span class="comment" id="5600952">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5600983">e</span><span class="op" id="5600984">.</span><span class="ident" id="5600985">tmp</span><span class="op" id="5600988">[</span><span class="num" id="5600989">11</span><span class="op" id="5600991">]</span>&nbsp;<span class="op" id="5600993">=</span>&nbsp;<span class="num" id="5600995">0</span>&nbsp;<span class="comment" id="5600997">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601023">e</span><span class="op" id="5601024">.</span><span class="ident" id="5601025">tmp</span><span class="op" id="5601028">[</span><span class="num" id="5601029">12</span><span class="op" id="5601031">]</span>&nbsp;<span class="op" id="5601033">=</span>&nbsp;<span class="num" id="5601035">0</span>&nbsp;<span class="comment" id="5601037">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601056">e</span><span class="op" id="5601057">.</span><span class="ident" id="5601058">writeChunk</span><span class="op" id="5601068">(</span><span class="ident" id="5601069">e</span><span class="op" id="5601070">.</span><span class="ident" id="5601071">tmp</span><span class="op" id="5601074">[</span><span class="op" id="5601075">:</span><span class="num" id="5601076">13</span><span class="op" id="5601078">]</span><span class="op" id="5601079">,</span>&nbsp;<span class="string" id="5601081">&#34;IHDR&#34;</span><span class="op" id="5601087">)</span><br>
<span class="lineno"></span><span class="op" id="5601089">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="5601092">func</span>&nbsp;<span class="op" id="5601097">(</span><span class="ident" id="5601098">e</span>&nbsp;<span class="op" id="5601100">*</span><span class="ident" id="5601101">encoder</span><span class="op" id="5601108">)</span>&nbsp;<span class="ident" id="5601110">writePLTEAndTRNS</span><span class="op" id="5601126">(</span><span class="ident" id="5601127">p</span>&nbsp;<span class="ident" id="5601129">color</span><span class="op" id="5601134">.</span><span class="ident" id="5601135">Palette</span><span class="op" id="5601142">)</span>&nbsp;<span class="op" id="5601144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601147">if</span>&nbsp;<span class="builtinfunc" id="5601150">len</span><span class="op" id="5601153">(</span><span class="ident" id="5601154">p</span><span class="op" id="5601155">)</span>&nbsp;<span class="op" id="5601157">&lt;</span>&nbsp;<span class="num" id="5601159">1</span>&nbsp;<span class="op" id="5601161">||</span>&nbsp;<span class="builtinfunc" id="5601164">len</span><span class="op" id="5601167">(</span><span class="ident" id="5601168">p</span><span class="op" id="5601169">)</span>&nbsp;<span class="op" id="5601171">&gt;</span>&nbsp;<span class="num" id="5601173">256</span>&nbsp;<span class="op" id="5601177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601181">e</span><span class="op" id="5601182">.</span><span class="ident" id="5601183">err</span>&nbsp;<span class="op" id="5601187">=</span>&nbsp;<span class="ident" id="5601189">FormatError</span><span class="op" id="5601200">(</span><span class="string" id="5601201">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="5601224">+</span>&nbsp;<span class="ident" id="5601226">strconv</span><span class="op" id="5601233">.</span><span class="ident" id="5601234">Itoa</span><span class="op" id="5601238">(</span><span class="builtinfunc" id="5601239">len</span><span class="op" id="5601242">(</span><span class="ident" id="5601243">p</span><span class="op" id="5601244">)</span><span class="op" id="5601245">)</span><span class="op" id="5601246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601250">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601261">last</span>&nbsp;<span class="op" id="5601266">:=</span>&nbsp;<span class="op" id="5601269">-</span><span class="num" id="5601270">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601273">for</span>&nbsp;<span class="ident" id="5601277">i</span><span class="op" id="5601278">,</span>&nbsp;<span class="ident" id="5601280">c</span>&nbsp;<span class="op" id="5601282">:=</span>&nbsp;<span class="keyword" id="5601285">range</span>&nbsp;<span class="ident" id="5601291">p</span>&nbsp;<span class="op" id="5601293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601297">c1</span>&nbsp;<span class="op" id="5601300">:=</span>&nbsp;<span class="ident" id="5601303">color</span><span class="op" id="5601308">.</span><span class="ident" id="5601309">NRGBAModel</span><span class="op" id="5601319">.</span><span class="ident" id="5601320">Convert</span><span class="op" id="5601327">(</span><span class="ident" id="5601328">c</span><span class="op" id="5601329">)</span><span class="op" id="5601330">.</span><span class="op" id="5601331">(</span><span class="ident" id="5601332">color</span><span class="op" id="5601337">.</span><span class="ident" id="5601338">NRGBA</span><span class="op" id="5601343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601347">e</span><span class="op" id="5601348">.</span><span class="ident" id="5601349">tmp</span><span class="op" id="5601352">[</span><span class="num" id="5601353">3</span><span class="op" id="5601354">*</span><span class="ident" id="5601355">i</span><span class="op" id="5601356">+</span><span class="num" id="5601357">0</span><span class="op" id="5601358">]</span>&nbsp;<span class="op" id="5601360">=</span>&nbsp;<span class="ident" id="5601362">c1</span><span class="op" id="5601364">.</span><span class="ident" id="5601365">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601369">e</span><span class="op" id="5601370">.</span><span class="ident" id="5601371">tmp</span><span class="op" id="5601374">[</span><span class="num" id="5601375">3</span><span class="op" id="5601376">*</span><span class="ident" id="5601377">i</span><span class="op" id="5601378">+</span><span class="num" id="5601379">1</span><span class="op" id="5601380">]</span>&nbsp;<span class="op" id="5601382">=</span>&nbsp;<span class="ident" id="5601384">c1</span><span class="op" id="5601386">.</span><span class="ident" id="5601387">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601391">e</span><span class="op" id="5601392">.</span><span class="ident" id="5601393">tmp</span><span class="op" id="5601396">[</span><span class="num" id="5601397">3</span><span class="op" id="5601398">*</span><span class="ident" id="5601399">i</span><span class="op" id="5601400">+</span><span class="num" id="5601401">2</span><span class="op" id="5601402">]</span>&nbsp;<span class="op" id="5601404">=</span>&nbsp;<span class="ident" id="5601406">c1</span><span class="op" id="5601408">.</span><span class="ident" id="5601409">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601413">if</span>&nbsp;<span class="ident" id="5601416">c1</span><span class="op" id="5601418">.</span><span class="ident" id="5601419">A</span>&nbsp;<span class="op" id="5601421">!=</span>&nbsp;<span class="num" id="5601424">0xff</span>&nbsp;<span class="op" id="5601429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601434">last</span>&nbsp;<span class="op" id="5601439">=</span>&nbsp;<span class="ident" id="5601441">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601445">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601449">e</span><span class="op" id="5601450">.</span><span class="ident" id="5601451">tmp</span><span class="op" id="5601454">[</span><span class="num" id="5601455">3</span><span class="op" id="5601456">*</span><span class="num" id="5601457">256</span><span class="op" id="5601460">+</span><span class="ident" id="5601461">i</span><span class="op" id="5601462">]</span>&nbsp;<span class="op" id="5601464">=</span>&nbsp;<span class="ident" id="5601466">c1</span><span class="op" id="5601468">.</span><span class="ident" id="5601469">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601475">e</span><span class="op" id="5601476">.</span><span class="ident" id="5601477">writeChunk</span><span class="op" id="5601487">(</span><span class="ident" id="5601488">e</span><span class="op" id="5601489">.</span><span class="ident" id="5601490">tmp</span><span class="op" id="5601493">[</span><span class="op" id="5601494">:</span><span class="num" id="5601495">3</span><span class="op" id="5601496">*</span><span class="builtinfunc" id="5601497">len</span><span class="op" id="5601500">(</span><span class="ident" id="5601501">p</span><span class="op" id="5601502">)</span><span class="op" id="5601503">]</span><span class="op" id="5601504">,</span>&nbsp;<span class="string" id="5601506">&#34;PLTE&#34;</span><span class="op" id="5601512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5601515">if</span>&nbsp;<span class="ident" id="5601518">last</span>&nbsp;<span class="op" id="5601523">!=</span>&nbsp;<span class="op" id="5601526">-</span><span class="num" id="5601527">1</span>&nbsp;<span class="op" id="5601529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5601533">e</span><span class="op" id="5601534">.</span><span class="ident" id="5601535">writeChunk</span><span class="op" id="5601545">(</span><span class="ident" id="5601546">e</span><span class="op" id="5601547">.</span><span class="ident" id="5601548">tmp</span><span class="op" id="5601551">[</span><span class="num" id="5601552">3</span><span class="op" id="5601553">*</span><span class="num" id="5601554">256</span><span class="op" id="5601557">:</span><span class="num" id="5601558">3</span><span class="op" id="5601559">*</span><span class="num" id="5601560">256</span><span class="op" id="5601563">+</span><span class="num" id="5601564">1</span><span class="op" id="5601565">+</span><span class="ident" id="5601566">last</span><span class="op" id="5601570">]</span><span class="op" id="5601571">,</span>&nbsp;<span class="string" id="5601573">&#34;tRNS&#34;</span><span class="op" id="5601579">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5601582">}</span><br>
<span class="lineno"></span><span class="op" id="5601584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5601587">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="5601667">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="5601748">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="5601822">//</span><br>
<span class="lineno"></span><span class="comment" id="5601825">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="5601896">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5601954">func</span>&nbsp;<span class="op" id="5601959">(</span><span class="ident" id="5601960">e</span>&nbsp;<span class="op" id="5601962">*</span><span class="ident" id="5601963">encoder</span><span class="op" id="5601970">)</span>&nbsp;<span class="ident" id="5601972">Write</span><span class="op" id="5601977">(</span><span class="ident" id="5601978">b</span>&nbsp;<span class="op" id="5601980">[</span><span class="op" id="5601981">]</span><span class="builtintype" id="5601982">byte</span><span class="op" id="5601986">)</span>&nbsp;<span class="op" id="5601988">(</span><span class="builtintype" id="5601989">int</span><span class="op" id="5601992">,</span>&nbsp;<span class="builtintype" id="5601994">error</span><span class="op" id="5601999">)</span>&nbsp;<span class="op" id="5602001">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602004">e</span><span class="op" id="5602005">.</span><span class="ident" id="5602006">writeChunk</span><span class="op" id="5602016">(</span><span class="ident" id="5602017">b</span><span class="op" id="5602018">,</span>&nbsp;<span class="string" id="5602020">&#34;IDAT&#34;</span><span class="op" id="5602026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602029">if</span>&nbsp;<span class="ident" id="5602032">e</span><span class="op" id="5602033">.</span><span class="ident" id="5602034">err</span>&nbsp;<span class="op" id="5602038">!=</span>&nbsp;<span class="ident" id="5602041">nil</span>&nbsp;<span class="op" id="5602045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602049">return</span>&nbsp;<span class="num" id="5602056">0</span><span class="op" id="5602057">,</span>&nbsp;<span class="ident" id="5602059">e</span><span class="op" id="5602060">.</span><span class="ident" id="5602061">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5602066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602069">return</span>&nbsp;<span class="builtinfunc" id="5602076">len</span><span class="op" id="5602079">(</span><span class="ident" id="5602080">b</span><span class="op" id="5602081">)</span><span class="op" id="5602082">,</span>&nbsp;<span class="ident" id="5602084">nil</span><br>
<span class="lineno">180</span><span class="op" id="5602088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5602091">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5602166">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="5602264">func</span>&nbsp;<span class="ident" id="5602269">filter</span><span class="op" id="5602275">(</span><span class="ident" id="5602276">cr</span>&nbsp;<span class="op" id="5602279">*</span><span class="op" id="5602280">[</span><span class="ident" id="5602281">nFilter</span><span class="op" id="5602288">]</span><span class="op" id="5602289">[</span><span class="op" id="5602290">]</span><span class="builtintype" id="5602291">byte</span><span class="op" id="5602295">,</span>&nbsp;<span class="ident" id="5602297">pr</span>&nbsp;<span class="op" id="5602300">[</span><span class="op" id="5602301">]</span><span class="builtintype" id="5602302">byte</span><span class="op" id="5602306">,</span>&nbsp;<span class="ident" id="5602308">bpp</span>&nbsp;<span class="builtintype" id="5602312">int</span><span class="op" id="5602315">)</span>&nbsp;<span class="builtintype" id="5602317">int</span>&nbsp;<span class="op" id="5602321">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602324">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602423">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602519">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602614">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602688">cdat0</span>&nbsp;<span class="op" id="5602694">:=</span>&nbsp;<span class="ident" id="5602697">cr</span><span class="op" id="5602699">[</span><span class="num" id="5602700">0</span><span class="op" id="5602701">]</span><span class="op" id="5602702">[</span><span class="num" id="5602703">1</span><span class="op" id="5602704">:</span><span class="op" id="5602705">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602708">cdat1</span>&nbsp;<span class="op" id="5602714">:=</span>&nbsp;<span class="ident" id="5602717">cr</span><span class="op" id="5602719">[</span><span class="num" id="5602720">1</span><span class="op" id="5602721">]</span><span class="op" id="5602722">[</span><span class="num" id="5602723">1</span><span class="op" id="5602724">:</span><span class="op" id="5602725">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602728">cdat2</span>&nbsp;<span class="op" id="5602734">:=</span>&nbsp;<span class="ident" id="5602737">cr</span><span class="op" id="5602739">[</span><span class="num" id="5602740">2</span><span class="op" id="5602741">]</span><span class="op" id="5602742">[</span><span class="num" id="5602743">1</span><span class="op" id="5602744">:</span><span class="op" id="5602745">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602748">cdat3</span>&nbsp;<span class="op" id="5602754">:=</span>&nbsp;<span class="ident" id="5602757">cr</span><span class="op" id="5602759">[</span><span class="num" id="5602760">3</span><span class="op" id="5602761">]</span><span class="op" id="5602762">[</span><span class="num" id="5602763">1</span><span class="op" id="5602764">:</span><span class="op" id="5602765">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602768">cdat4</span>&nbsp;<span class="op" id="5602774">:=</span>&nbsp;<span class="ident" id="5602777">cr</span><span class="op" id="5602779">[</span><span class="num" id="5602780">4</span><span class="op" id="5602781">]</span><span class="op" id="5602782">[</span><span class="num" id="5602783">1</span><span class="op" id="5602784">:</span><span class="op" id="5602785">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602788">pdat</span>&nbsp;<span class="op" id="5602793">:=</span>&nbsp;<span class="ident" id="5602796">pr</span><span class="op" id="5602798">[</span><span class="num" id="5602799">1</span><span class="op" id="5602800">:</span><span class="op" id="5602801">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602804">n</span>&nbsp;<span class="op" id="5602806">:=</span>&nbsp;<span class="builtinfunc" id="5602809">len</span><span class="op" id="5602812">(</span><span class="ident" id="5602813">cdat0</span><span class="op" id="5602818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602822">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602841">sum</span>&nbsp;<span class="op" id="5602845">:=</span>&nbsp;<span class="num" id="5602848">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602851">for</span>&nbsp;<span class="ident" id="5602855">i</span>&nbsp;<span class="op" id="5602857">:=</span>&nbsp;<span class="num" id="5602860">0</span><span class="op" id="5602861">;</span>&nbsp;<span class="ident" id="5602863">i</span>&nbsp;<span class="op" id="5602865">&lt;</span>&nbsp;<span class="ident" id="5602867">n</span><span class="op" id="5602868">;</span>&nbsp;<span class="ident" id="5602870">i</span><span class="op" id="5602871">++</span>&nbsp;<span class="op" id="5602874">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602878">cdat2</span><span class="op" id="5602883">[</span><span class="ident" id="5602884">i</span><span class="op" id="5602885">]</span>&nbsp;<span class="op" id="5602887">=</span>&nbsp;<span class="ident" id="5602889">cdat0</span><span class="op" id="5602894">[</span><span class="ident" id="5602895">i</span><span class="op" id="5602896">]</span>&nbsp;<span class="op" id="5602898">-</span>&nbsp;<span class="ident" id="5602900">pdat</span><span class="op" id="5602904">[</span><span class="ident" id="5602905">i</span><span class="op" id="5602906">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602910">sum</span>&nbsp;<span class="op" id="5602914">+=</span>&nbsp;<span class="ident" id="5602917">abs8</span><span class="op" id="5602921">(</span><span class="ident" id="5602922">cdat2</span><span class="op" id="5602927">[</span><span class="ident" id="5602928">i</span><span class="op" id="5602929">]</span><span class="op" id="5602930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5602933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602936">best</span>&nbsp;<span class="op" id="5602941">:=</span>&nbsp;<span class="ident" id="5602944">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602949">filter</span>&nbsp;<span class="op" id="5602956">:=</span>&nbsp;<span class="ident" id="5602959">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5602966">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5602988">sum</span>&nbsp;<span class="op" id="5602992">=</span>&nbsp;<span class="num" id="5602994">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5602997">for</span>&nbsp;<span class="ident" id="5603001">i</span>&nbsp;<span class="op" id="5603003">:=</span>&nbsp;<span class="num" id="5603006">0</span><span class="op" id="5603007">;</span>&nbsp;<span class="ident" id="5603009">i</span>&nbsp;<span class="op" id="5603011">&lt;</span>&nbsp;<span class="ident" id="5603013">bpp</span><span class="op" id="5603016">;</span>&nbsp;<span class="ident" id="5603018">i</span><span class="op" id="5603019">++</span>&nbsp;<span class="op" id="5603022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603026">cdat4</span><span class="op" id="5603031">[</span><span class="ident" id="5603032">i</span><span class="op" id="5603033">]</span>&nbsp;<span class="op" id="5603035">=</span>&nbsp;<span class="ident" id="5603037">cdat0</span><span class="op" id="5603042">[</span><span class="ident" id="5603043">i</span><span class="op" id="5603044">]</span>&nbsp;<span class="op" id="5603046">-</span>&nbsp;<span class="ident" id="5603048">pdat</span><span class="op" id="5603052">[</span><span class="ident" id="5603053">i</span><span class="op" id="5603054">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603058">sum</span>&nbsp;<span class="op" id="5603062">+=</span>&nbsp;<span class="ident" id="5603065">abs8</span><span class="op" id="5603069">(</span><span class="ident" id="5603070">cdat4</span><span class="op" id="5603075">[</span><span class="ident" id="5603076">i</span><span class="op" id="5603077">]</span><span class="op" id="5603078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603084">for</span>&nbsp;<span class="ident" id="5603088">i</span>&nbsp;<span class="op" id="5603090">:=</span>&nbsp;<span class="ident" id="5603093">bpp</span><span class="op" id="5603096">;</span>&nbsp;<span class="ident" id="5603098">i</span>&nbsp;<span class="op" id="5603100">&lt;</span>&nbsp;<span class="ident" id="5603102">n</span><span class="op" id="5603103">;</span>&nbsp;<span class="ident" id="5603105">i</span><span class="op" id="5603106">++</span>&nbsp;<span class="op" id="5603109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603113">cdat4</span><span class="op" id="5603118">[</span><span class="ident" id="5603119">i</span><span class="op" id="5603120">]</span>&nbsp;<span class="op" id="5603122">=</span>&nbsp;<span class="ident" id="5603124">cdat0</span><span class="op" id="5603129">[</span><span class="ident" id="5603130">i</span><span class="op" id="5603131">]</span>&nbsp;<span class="op" id="5603133">-</span>&nbsp;<span class="ident" id="5603135">paeth</span><span class="op" id="5603140">(</span><span class="ident" id="5603141">cdat0</span><span class="op" id="5603146">[</span><span class="ident" id="5603147">i</span><span class="op" id="5603148">-</span><span class="ident" id="5603149">bpp</span><span class="op" id="5603152">]</span><span class="op" id="5603153">,</span>&nbsp;<span class="ident" id="5603155">pdat</span><span class="op" id="5603159">[</span><span class="ident" id="5603160">i</span><span class="op" id="5603161">]</span><span class="op" id="5603162">,</span>&nbsp;<span class="ident" id="5603164">pdat</span><span class="op" id="5603168">[</span><span class="ident" id="5603169">i</span><span class="op" id="5603170">-</span><span class="ident" id="5603171">bpp</span><span class="op" id="5603174">]</span><span class="op" id="5603175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603179">sum</span>&nbsp;<span class="op" id="5603183">+=</span>&nbsp;<span class="ident" id="5603186">abs8</span><span class="op" id="5603190">(</span><span class="ident" id="5603191">cdat4</span><span class="op" id="5603196">[</span><span class="ident" id="5603197">i</span><span class="op" id="5603198">]</span><span class="op" id="5603199">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603203">if</span>&nbsp;<span class="ident" id="5603206">sum</span>&nbsp;<span class="op" id="5603210">&gt;=</span>&nbsp;<span class="ident" id="5603213">best</span>&nbsp;<span class="op" id="5603218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603223">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603237">if</span>&nbsp;<span class="ident" id="5603240">sum</span>&nbsp;<span class="op" id="5603244">&lt;</span>&nbsp;<span class="ident" id="5603246">best</span>&nbsp;<span class="op" id="5603251">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603255">best</span>&nbsp;<span class="op" id="5603260">=</span>&nbsp;<span class="ident" id="5603262">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603268">filter</span>&nbsp;<span class="op" id="5603275">=</span>&nbsp;<span class="ident" id="5603277">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5603290">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603311">sum</span>&nbsp;<span class="op" id="5603315">=</span>&nbsp;<span class="num" id="5603317">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603320">for</span>&nbsp;<span class="ident" id="5603324">i</span>&nbsp;<span class="op" id="5603326">:=</span>&nbsp;<span class="num" id="5603329">0</span><span class="op" id="5603330">;</span>&nbsp;<span class="ident" id="5603332">i</span>&nbsp;<span class="op" id="5603334">&lt;</span>&nbsp;<span class="ident" id="5603336">n</span><span class="op" id="5603337">;</span>&nbsp;<span class="ident" id="5603339">i</span><span class="op" id="5603340">++</span>&nbsp;<span class="op" id="5603343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603347">sum</span>&nbsp;<span class="op" id="5603351">+=</span>&nbsp;<span class="ident" id="5603354">abs8</span><span class="op" id="5603358">(</span><span class="ident" id="5603359">cdat0</span><span class="op" id="5603364">[</span><span class="ident" id="5603365">i</span><span class="op" id="5603366">]</span><span class="op" id="5603367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603371">if</span>&nbsp;<span class="ident" id="5603374">sum</span>&nbsp;<span class="op" id="5603378">&gt;=</span>&nbsp;<span class="ident" id="5603381">best</span>&nbsp;<span class="op" id="5603386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603391">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603405">if</span>&nbsp;<span class="ident" id="5603408">sum</span>&nbsp;<span class="op" id="5603412">&lt;</span>&nbsp;<span class="ident" id="5603414">best</span>&nbsp;<span class="op" id="5603419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603423">best</span>&nbsp;<span class="op" id="5603428">=</span>&nbsp;<span class="ident" id="5603430">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603436">filter</span>&nbsp;<span class="op" id="5603443">=</span>&nbsp;<span class="ident" id="5603445">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5603457">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603477">sum</span>&nbsp;<span class="op" id="5603481">=</span>&nbsp;<span class="num" id="5603483">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603486">for</span>&nbsp;<span class="ident" id="5603490">i</span>&nbsp;<span class="op" id="5603492">:=</span>&nbsp;<span class="num" id="5603495">0</span><span class="op" id="5603496">;</span>&nbsp;<span class="ident" id="5603498">i</span>&nbsp;<span class="op" id="5603500">&lt;</span>&nbsp;<span class="ident" id="5603502">bpp</span><span class="op" id="5603505">;</span>&nbsp;<span class="ident" id="5603507">i</span><span class="op" id="5603508">++</span>&nbsp;<span class="op" id="5603511">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603515">cdat1</span><span class="op" id="5603520">[</span><span class="ident" id="5603521">i</span><span class="op" id="5603522">]</span>&nbsp;<span class="op" id="5603524">=</span>&nbsp;<span class="ident" id="5603526">cdat0</span><span class="op" id="5603531">[</span><span class="ident" id="5603532">i</span><span class="op" id="5603533">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603537">sum</span>&nbsp;<span class="op" id="5603541">+=</span>&nbsp;<span class="ident" id="5603544">abs8</span><span class="op" id="5603548">(</span><span class="ident" id="5603549">cdat1</span><span class="op" id="5603554">[</span><span class="ident" id="5603555">i</span><span class="op" id="5603556">]</span><span class="op" id="5603557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603563">for</span>&nbsp;<span class="ident" id="5603567">i</span>&nbsp;<span class="op" id="5603569">:=</span>&nbsp;<span class="ident" id="5603572">bpp</span><span class="op" id="5603575">;</span>&nbsp;<span class="ident" id="5603577">i</span>&nbsp;<span class="op" id="5603579">&lt;</span>&nbsp;<span class="ident" id="5603581">n</span><span class="op" id="5603582">;</span>&nbsp;<span class="ident" id="5603584">i</span><span class="op" id="5603585">++</span>&nbsp;<span class="op" id="5603588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603592">cdat1</span><span class="op" id="5603597">[</span><span class="ident" id="5603598">i</span><span class="op" id="5603599">]</span>&nbsp;<span class="op" id="5603601">=</span>&nbsp;<span class="ident" id="5603603">cdat0</span><span class="op" id="5603608">[</span><span class="ident" id="5603609">i</span><span class="op" id="5603610">]</span>&nbsp;<span class="op" id="5603612">-</span>&nbsp;<span class="ident" id="5603614">cdat0</span><span class="op" id="5603619">[</span><span class="ident" id="5603620">i</span><span class="op" id="5603621">-</span><span class="ident" id="5603622">bpp</span><span class="op" id="5603625">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603629">sum</span>&nbsp;<span class="op" id="5603633">+=</span>&nbsp;<span class="ident" id="5603636">abs8</span><span class="op" id="5603640">(</span><span class="ident" id="5603641">cdat1</span><span class="op" id="5603646">[</span><span class="ident" id="5603647">i</span><span class="op" id="5603648">]</span><span class="op" id="5603649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603653">if</span>&nbsp;<span class="ident" id="5603656">sum</span>&nbsp;<span class="op" id="5603660">&gt;=</span>&nbsp;<span class="ident" id="5603663">best</span>&nbsp;<span class="op" id="5603668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603673">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603684">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603687">if</span>&nbsp;<span class="ident" id="5603690">sum</span>&nbsp;<span class="op" id="5603694">&lt;</span>&nbsp;<span class="ident" id="5603696">best</span>&nbsp;<span class="op" id="5603701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603705">best</span>&nbsp;<span class="op" id="5603710">=</span>&nbsp;<span class="ident" id="5603712">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603718">filter</span>&nbsp;<span class="op" id="5603725">=</span>&nbsp;<span class="ident" id="5603727">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5603738">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603762">sum</span>&nbsp;<span class="op" id="5603766">=</span>&nbsp;<span class="num" id="5603768">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603771">for</span>&nbsp;<span class="ident" id="5603775">i</span>&nbsp;<span class="op" id="5603777">:=</span>&nbsp;<span class="num" id="5603780">0</span><span class="op" id="5603781">;</span>&nbsp;<span class="ident" id="5603783">i</span>&nbsp;<span class="op" id="5603785">&lt;</span>&nbsp;<span class="ident" id="5603787">bpp</span><span class="op" id="5603790">;</span>&nbsp;<span class="ident" id="5603792">i</span><span class="op" id="5603793">++</span>&nbsp;<span class="op" id="5603796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603800">cdat3</span><span class="op" id="5603805">[</span><span class="ident" id="5603806">i</span><span class="op" id="5603807">]</span>&nbsp;<span class="op" id="5603809">=</span>&nbsp;<span class="ident" id="5603811">cdat0</span><span class="op" id="5603816">[</span><span class="ident" id="5603817">i</span><span class="op" id="5603818">]</span>&nbsp;<span class="op" id="5603820">-</span>&nbsp;<span class="ident" id="5603822">pdat</span><span class="op" id="5603826">[</span><span class="ident" id="5603827">i</span><span class="op" id="5603828">]</span><span class="op" id="5603829">/</span><span class="num" id="5603830">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603834">sum</span>&nbsp;<span class="op" id="5603838">+=</span>&nbsp;<span class="ident" id="5603841">abs8</span><span class="op" id="5603845">(</span><span class="ident" id="5603846">cdat3</span><span class="op" id="5603851">[</span><span class="ident" id="5603852">i</span><span class="op" id="5603853">]</span><span class="op" id="5603854">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5603857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603860">for</span>&nbsp;<span class="ident" id="5603864">i</span>&nbsp;<span class="op" id="5603866">:=</span>&nbsp;<span class="ident" id="5603869">bpp</span><span class="op" id="5603872">;</span>&nbsp;<span class="ident" id="5603874">i</span>&nbsp;<span class="op" id="5603876">&lt;</span>&nbsp;<span class="ident" id="5603878">n</span><span class="op" id="5603879">;</span>&nbsp;<span class="ident" id="5603881">i</span><span class="op" id="5603882">++</span>&nbsp;<span class="op" id="5603885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603889">cdat3</span><span class="op" id="5603894">[</span><span class="ident" id="5603895">i</span><span class="op" id="5603896">]</span>&nbsp;<span class="op" id="5603898">=</span>&nbsp;<span class="ident" id="5603900">cdat0</span><span class="op" id="5603905">[</span><span class="ident" id="5603906">i</span><span class="op" id="5603907">]</span>&nbsp;<span class="op" id="5603909">-</span>&nbsp;<span class="builtintype" id="5603911">uint8</span><span class="op" id="5603916">(</span><span class="op" id="5603917">(</span><span class="builtintype" id="5603918">int</span><span class="op" id="5603921">(</span><span class="ident" id="5603922">cdat0</span><span class="op" id="5603927">[</span><span class="ident" id="5603928">i</span><span class="op" id="5603929">-</span><span class="ident" id="5603930">bpp</span><span class="op" id="5603933">]</span><span class="op" id="5603934">)</span><span class="op" id="5603935">+</span><span class="builtintype" id="5603936">int</span><span class="op" id="5603939">(</span><span class="ident" id="5603940">pdat</span><span class="op" id="5603944">[</span><span class="ident" id="5603945">i</span><span class="op" id="5603946">]</span><span class="op" id="5603947">)</span><span class="op" id="5603948">)</span><span class="op" id="5603949">/</span><span class="num" id="5603950">2</span><span class="op" id="5603951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5603955">sum</span>&nbsp;<span class="op" id="5603959">+=</span>&nbsp;<span class="ident" id="5603962">abs8</span><span class="op" id="5603966">(</span><span class="ident" id="5603967">cdat3</span><span class="op" id="5603972">[</span><span class="ident" id="5603973">i</span><span class="op" id="5603974">]</span><span class="op" id="5603975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603979">if</span>&nbsp;<span class="ident" id="5603982">sum</span>&nbsp;<span class="op" id="5603986">&gt;=</span>&nbsp;<span class="ident" id="5603989">best</span>&nbsp;<span class="op" id="5603994">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5603999">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604013">if</span>&nbsp;<span class="ident" id="5604016">sum</span>&nbsp;<span class="op" id="5604020">&lt;</span>&nbsp;<span class="ident" id="5604022">best</span>&nbsp;<span class="op" id="5604027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604031">best</span>&nbsp;<span class="op" id="5604036">=</span>&nbsp;<span class="ident" id="5604038">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604044">filter</span>&nbsp;<span class="op" id="5604051">=</span>&nbsp;<span class="ident" id="5604053">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604068">return</span>&nbsp;<span class="ident" id="5604075">filter</span><br>
<span class="lineno"></span><span class="op" id="5604082">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="5604085">func</span>&nbsp;<span class="ident" id="5604090">writeImage</span><span class="op" id="5604100">(</span><span class="ident" id="5604101">w</span>&nbsp;<span class="ident" id="5604103">io</span><span class="op" id="5604105">.</span><span class="ident" id="5604106">Writer</span><span class="op" id="5604112">,</span>&nbsp;<span class="ident" id="5604114">m</span>&nbsp;<span class="ident" id="5604116">image</span><span class="op" id="5604121">.</span><span class="ident" id="5604122">Image</span><span class="op" id="5604127">,</span>&nbsp;<span class="ident" id="5604129">cb</span>&nbsp;<span class="builtintype" id="5604132">int</span><span class="op" id="5604135">,</span>&nbsp;<span class="ident" id="5604137">level</span>&nbsp;<span class="builtintype" id="5604143">int</span><span class="op" id="5604146">)</span>&nbsp;<span class="builtintype" id="5604148">error</span>&nbsp;<span class="op" id="5604154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604157">zw</span><span class="op" id="5604159">,</span>&nbsp;<span class="ident" id="5604161">err</span>&nbsp;<span class="op" id="5604165">:=</span>&nbsp;<span class="ident" id="5604168">zlib</span><span class="op" id="5604172">.</span><span class="ident" id="5604173">NewWriterLevel</span><span class="op" id="5604187">(</span><span class="ident" id="5604188">w</span><span class="op" id="5604189">,</span>&nbsp;<span class="ident" id="5604191">level</span><span class="op" id="5604196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604199">if</span>&nbsp;<span class="ident" id="5604202">err</span>&nbsp;<span class="op" id="5604206">!=</span>&nbsp;<span class="ident" id="5604209">nil</span>&nbsp;<span class="op" id="5604213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604217">return</span>&nbsp;<span class="ident" id="5604224">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604232">defer</span>&nbsp;<span class="ident" id="5604238">zw</span><span class="op" id="5604240">.</span><span class="ident" id="5604241">Close</span><span class="op" id="5604246">(</span><span class="op" id="5604247">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604251">bpp</span>&nbsp;<span class="op" id="5604255">:=</span>&nbsp;<span class="num" id="5604258">0</span>&nbsp;<span class="comment" id="5604260">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604282">switch</span>&nbsp;<span class="ident" id="5604289">cb</span>&nbsp;<span class="op" id="5604292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604295">case</span>&nbsp;<span class="ident" id="5604300">cbG8</span><span class="op" id="5604304">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604308">bpp</span>&nbsp;<span class="op" id="5604312">=</span>&nbsp;<span class="num" id="5604314">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604317">case</span>&nbsp;<span class="ident" id="5604322">cbTC8</span><span class="op" id="5604327">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604331">bpp</span>&nbsp;<span class="op" id="5604335">=</span>&nbsp;<span class="num" id="5604337">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604340">case</span>&nbsp;<span class="ident" id="5604345">cbP8</span><span class="op" id="5604349">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604353">bpp</span>&nbsp;<span class="op" id="5604357">=</span>&nbsp;<span class="num" id="5604359">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604362">case</span>&nbsp;<span class="ident" id="5604367">cbTCA8</span><span class="op" id="5604373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604377">bpp</span>&nbsp;<span class="op" id="5604381">=</span>&nbsp;<span class="num" id="5604383">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604386">case</span>&nbsp;<span class="ident" id="5604391">cbTC16</span><span class="op" id="5604397">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604401">bpp</span>&nbsp;<span class="op" id="5604405">=</span>&nbsp;<span class="num" id="5604407">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604410">case</span>&nbsp;<span class="ident" id="5604415">cbTCA16</span><span class="op" id="5604422">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604426">bpp</span>&nbsp;<span class="op" id="5604430">=</span>&nbsp;<span class="num" id="5604432">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604435">case</span>&nbsp;<span class="ident" id="5604440">cbG16</span><span class="op" id="5604445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604449">bpp</span>&nbsp;<span class="op" id="5604453">=</span>&nbsp;<span class="num" id="5604455">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5604461">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5604526">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5604602">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5604689">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5604776">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604841">b</span>&nbsp;<span class="op" id="5604843">:=</span>&nbsp;<span class="ident" id="5604846">m</span><span class="op" id="5604847">.</span><span class="ident" id="5604848">Bounds</span><span class="op" id="5604854">(</span><span class="op" id="5604855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604858">var</span>&nbsp;<span class="ident" id="5604862">cr</span>&nbsp;<span class="op" id="5604865">[</span><span class="ident" id="5604866">nFilter</span><span class="op" id="5604873">]</span><span class="op" id="5604874">[</span><span class="op" id="5604875">]</span><span class="builtintype" id="5604876">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5604883">for</span>&nbsp;<span class="ident" id="5604887">i</span>&nbsp;<span class="op" id="5604889">:=</span>&nbsp;<span class="keyword" id="5604892">range</span>&nbsp;<span class="ident" id="5604898">cr</span>&nbsp;<span class="op" id="5604901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604905">cr</span><span class="op" id="5604907">[</span><span class="ident" id="5604908">i</span><span class="op" id="5604909">]</span>&nbsp;<span class="op" id="5604911">=</span>&nbsp;<span class="builtinfunc" id="5604913">make</span><span class="op" id="5604917">(</span><span class="op" id="5604918">[</span><span class="op" id="5604919">]</span><span class="builtintype" id="5604920">uint8</span><span class="op" id="5604925">,</span>&nbsp;<span class="num" id="5604927">1</span><span class="op" id="5604928">+</span><span class="ident" id="5604929">bpp</span><span class="op" id="5604932">*</span><span class="ident" id="5604933">b</span><span class="op" id="5604934">.</span><span class="ident" id="5604935">Dx</span><span class="op" id="5604937">(</span><span class="op" id="5604938">)</span><span class="op" id="5604939">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604943">cr</span><span class="op" id="5604945">[</span><span class="ident" id="5604946">i</span><span class="op" id="5604947">]</span><span class="op" id="5604948">[</span><span class="num" id="5604949">0</span><span class="op" id="5604950">]</span>&nbsp;<span class="op" id="5604952">=</span>&nbsp;<span class="builtintype" id="5604954">uint8</span><span class="op" id="5604959">(</span><span class="ident" id="5604960">i</span><span class="op" id="5604961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5604964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5604967">pr</span>&nbsp;<span class="op" id="5604970">:=</span>&nbsp;<span class="builtinfunc" id="5604973">make</span><span class="op" id="5604977">(</span><span class="op" id="5604978">[</span><span class="op" id="5604979">]</span><span class="builtintype" id="5604980">uint8</span><span class="op" id="5604985">,</span>&nbsp;<span class="num" id="5604987">1</span><span class="op" id="5604988">+</span><span class="ident" id="5604989">bpp</span><span class="op" id="5604992">*</span><span class="ident" id="5604993">b</span><span class="op" id="5604994">.</span><span class="ident" id="5604995">Dx</span><span class="op" id="5604997">(</span><span class="op" id="5604998">)</span><span class="op" id="5604999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605003">gray</span><span class="op" id="5605007">,</span>&nbsp;<span class="ident" id="5605009">_</span>&nbsp;<span class="op" id="5605011">:=</span>&nbsp;<span class="ident" id="5605014">m</span><span class="op" id="5605015">.</span><span class="op" id="5605016">(</span><span class="op" id="5605017">*</span><span class="ident" id="5605018">image</span><span class="op" id="5605023">.</span><span class="ident" id="5605024">Gray</span><span class="op" id="5605028">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605031">rgba</span><span class="op" id="5605035">,</span>&nbsp;<span class="ident" id="5605037">_</span>&nbsp;<span class="op" id="5605039">:=</span>&nbsp;<span class="ident" id="5605042">m</span><span class="op" id="5605043">.</span><span class="op" id="5605044">(</span><span class="op" id="5605045">*</span><span class="ident" id="5605046">image</span><span class="op" id="5605051">.</span><span class="ident" id="5605052">RGBA</span><span class="op" id="5605056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605059">paletted</span><span class="op" id="5605067">,</span>&nbsp;<span class="ident" id="5605069">_</span>&nbsp;<span class="op" id="5605071">:=</span>&nbsp;<span class="ident" id="5605074">m</span><span class="op" id="5605075">.</span><span class="op" id="5605076">(</span><span class="op" id="5605077">*</span><span class="ident" id="5605078">image</span><span class="op" id="5605083">.</span><span class="ident" id="5605084">Paletted</span><span class="op" id="5605092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605095">nrgba</span><span class="op" id="5605100">,</span>&nbsp;<span class="ident" id="5605102">_</span>&nbsp;<span class="op" id="5605104">:=</span>&nbsp;<span class="ident" id="5605107">m</span><span class="op" id="5605108">.</span><span class="op" id="5605109">(</span><span class="op" id="5605110">*</span><span class="ident" id="5605111">image</span><span class="op" id="5605116">.</span><span class="ident" id="5605117">NRGBA</span><span class="op" id="5605122">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605126">for</span>&nbsp;<span class="ident" id="5605130">y</span>&nbsp;<span class="op" id="5605132">:=</span>&nbsp;<span class="ident" id="5605135">b</span><span class="op" id="5605136">.</span><span class="ident" id="5605137">Min</span><span class="op" id="5605140">.</span><span class="ident" id="5605141">Y</span><span class="op" id="5605142">;</span>&nbsp;<span class="ident" id="5605144">y</span>&nbsp;<span class="op" id="5605146">&lt;</span>&nbsp;<span class="ident" id="5605148">b</span><span class="op" id="5605149">.</span><span class="ident" id="5605150">Max</span><span class="op" id="5605153">.</span><span class="ident" id="5605154">Y</span><span class="op" id="5605155">;</span>&nbsp;<span class="ident" id="5605157">y</span><span class="op" id="5605158">++</span>&nbsp;<span class="op" id="5605161">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5605165">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605200">i</span>&nbsp;<span class="op" id="5605202">:=</span>&nbsp;<span class="num" id="5605205">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605209">switch</span>&nbsp;<span class="ident" id="5605216">cb</span>&nbsp;<span class="op" id="5605219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605223">case</span>&nbsp;<span class="ident" id="5605228">cbG8</span><span class="op" id="5605232">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605237">if</span>&nbsp;<span class="ident" id="5605240">gray</span>&nbsp;<span class="op" id="5605245">!=</span>&nbsp;<span class="ident" id="5605248">nil</span>&nbsp;<span class="op" id="5605252">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605258">offset</span>&nbsp;<span class="op" id="5605265">:=</span>&nbsp;<span class="op" id="5605268">(</span><span class="ident" id="5605269">y</span>&nbsp;<span class="op" id="5605271">-</span>&nbsp;<span class="ident" id="5605273">b</span><span class="op" id="5605274">.</span><span class="ident" id="5605275">Min</span><span class="op" id="5605278">.</span><span class="ident" id="5605279">Y</span><span class="op" id="5605280">)</span>&nbsp;<span class="op" id="5605282">*</span>&nbsp;<span class="ident" id="5605284">gray</span><span class="op" id="5605288">.</span><span class="ident" id="5605289">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5605300">copy</span><span class="op" id="5605304">(</span><span class="ident" id="5605305">cr</span><span class="op" id="5605307">[</span><span class="num" id="5605308">0</span><span class="op" id="5605309">]</span><span class="op" id="5605310">[</span><span class="num" id="5605311">1</span><span class="op" id="5605312">:</span><span class="op" id="5605313">]</span><span class="op" id="5605314">,</span>&nbsp;<span class="ident" id="5605316">gray</span><span class="op" id="5605320">.</span><span class="ident" id="5605321">Pix</span><span class="op" id="5605324">[</span><span class="ident" id="5605325">offset</span><span class="op" id="5605331">:</span><span class="ident" id="5605332">offset</span><span class="op" id="5605338">+</span><span class="ident" id="5605339">b</span><span class="op" id="5605340">.</span><span class="ident" id="5605341">Dx</span><span class="op" id="5605343">(</span><span class="op" id="5605344">)</span><span class="op" id="5605345">]</span><span class="op" id="5605346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605351">}</span>&nbsp;<span class="keyword" id="5605353">else</span>&nbsp;<span class="op" id="5605358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605364">for</span>&nbsp;<span class="ident" id="5605368">x</span>&nbsp;<span class="op" id="5605370">:=</span>&nbsp;<span class="ident" id="5605373">b</span><span class="op" id="5605374">.</span><span class="ident" id="5605375">Min</span><span class="op" id="5605378">.</span><span class="ident" id="5605379">X</span><span class="op" id="5605380">;</span>&nbsp;<span class="ident" id="5605382">x</span>&nbsp;<span class="op" id="5605384">&lt;</span>&nbsp;<span class="ident" id="5605386">b</span><span class="op" id="5605387">.</span><span class="ident" id="5605388">Max</span><span class="op" id="5605391">.</span><span class="ident" id="5605392">X</span><span class="op" id="5605393">;</span>&nbsp;<span class="ident" id="5605395">x</span><span class="op" id="5605396">++</span>&nbsp;<span class="op" id="5605399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605406">c</span>&nbsp;<span class="op" id="5605408">:=</span>&nbsp;<span class="ident" id="5605411">color</span><span class="op" id="5605416">.</span><span class="ident" id="5605417">GrayModel</span><span class="op" id="5605426">.</span><span class="ident" id="5605427">Convert</span><span class="op" id="5605434">(</span><span class="ident" id="5605435">m</span><span class="op" id="5605436">.</span><span class="ident" id="5605437">At</span><span class="op" id="5605439">(</span><span class="ident" id="5605440">x</span><span class="op" id="5605441">,</span>&nbsp;<span class="ident" id="5605443">y</span><span class="op" id="5605444">)</span><span class="op" id="5605445">)</span><span class="op" id="5605446">.</span><span class="op" id="5605447">(</span><span class="ident" id="5605448">color</span><span class="op" id="5605453">.</span><span class="ident" id="5605454">Gray</span><span class="op" id="5605458">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605465">cr</span><span class="op" id="5605467">[</span><span class="num" id="5605468">0</span><span class="op" id="5605469">]</span><span class="op" id="5605470">[</span><span class="ident" id="5605471">i</span><span class="op" id="5605472">]</span>&nbsp;<span class="op" id="5605474">=</span>&nbsp;<span class="ident" id="5605476">c</span><span class="op" id="5605477">.</span><span class="ident" id="5605478">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605485">i</span><span class="op" id="5605486">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605502">case</span>&nbsp;<span class="ident" id="5605507">cbTC8</span><span class="op" id="5605512">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5605517">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605589">cr0</span>&nbsp;<span class="op" id="5605593">:=</span>&nbsp;<span class="ident" id="5605596">cr</span><span class="op" id="5605598">[</span><span class="num" id="5605599">0</span><span class="op" id="5605600">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605605">stride</span><span class="op" id="5605611">,</span>&nbsp;<span class="ident" id="5605613">pix</span>&nbsp;<span class="op" id="5605617">:=</span>&nbsp;<span class="num" id="5605620">0</span><span class="op" id="5605621">,</span>&nbsp;<span class="op" id="5605623">[</span><span class="op" id="5605624">]</span><span class="builtintype" id="5605625">byte</span><span class="op" id="5605629">(</span><span class="ident" id="5605630">nil</span><span class="op" id="5605633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605638">if</span>&nbsp;<span class="ident" id="5605641">rgba</span>&nbsp;<span class="op" id="5605646">!=</span>&nbsp;<span class="ident" id="5605649">nil</span>&nbsp;<span class="op" id="5605653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605659">stride</span><span class="op" id="5605665">,</span>&nbsp;<span class="ident" id="5605667">pix</span>&nbsp;<span class="op" id="5605671">=</span>&nbsp;<span class="ident" id="5605673">rgba</span><span class="op" id="5605677">.</span><span class="ident" id="5605678">Stride</span><span class="op" id="5605684">,</span>&nbsp;<span class="ident" id="5605686">rgba</span><span class="op" id="5605690">.</span><span class="ident" id="5605691">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605698">}</span>&nbsp;<span class="keyword" id="5605700">else</span>&nbsp;<span class="keyword" id="5605705">if</span>&nbsp;<span class="ident" id="5605708">nrgba</span>&nbsp;<span class="op" id="5605714">!=</span>&nbsp;<span class="ident" id="5605717">nil</span>&nbsp;<span class="op" id="5605721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605727">stride</span><span class="op" id="5605733">,</span>&nbsp;<span class="ident" id="5605735">pix</span>&nbsp;<span class="op" id="5605739">=</span>&nbsp;<span class="ident" id="5605741">nrgba</span><span class="op" id="5605746">.</span><span class="ident" id="5605747">Stride</span><span class="op" id="5605753">,</span>&nbsp;<span class="ident" id="5605755">nrgba</span><span class="op" id="5605760">.</span><span class="ident" id="5605761">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605773">if</span>&nbsp;<span class="ident" id="5605776">stride</span>&nbsp;<span class="op" id="5605783">!=</span>&nbsp;<span class="num" id="5605786">0</span>&nbsp;<span class="op" id="5605788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605794">j0</span>&nbsp;<span class="op" id="5605797">:=</span>&nbsp;<span class="op" id="5605800">(</span><span class="ident" id="5605801">y</span>&nbsp;<span class="op" id="5605803">-</span>&nbsp;<span class="ident" id="5605805">b</span><span class="op" id="5605806">.</span><span class="ident" id="5605807">Min</span><span class="op" id="5605810">.</span><span class="ident" id="5605811">Y</span><span class="op" id="5605812">)</span>&nbsp;<span class="op" id="5605814">*</span>&nbsp;<span class="ident" id="5605816">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605827">j1</span>&nbsp;<span class="op" id="5605830">:=</span>&nbsp;<span class="ident" id="5605833">j0</span>&nbsp;<span class="op" id="5605836">+</span>&nbsp;<span class="ident" id="5605838">b</span><span class="op" id="5605839">.</span><span class="ident" id="5605840">Dx</span><span class="op" id="5605842">(</span><span class="op" id="5605843">)</span><span class="op" id="5605844">*</span><span class="num" id="5605845">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605851">for</span>&nbsp;<span class="ident" id="5605855">j</span>&nbsp;<span class="op" id="5605857">:=</span>&nbsp;<span class="ident" id="5605860">j0</span><span class="op" id="5605862">;</span>&nbsp;<span class="ident" id="5605864">j</span>&nbsp;<span class="op" id="5605866">&lt;</span>&nbsp;<span class="ident" id="5605868">j1</span><span class="op" id="5605870">;</span>&nbsp;<span class="ident" id="5605872">j</span>&nbsp;<span class="op" id="5605874">+=</span>&nbsp;<span class="num" id="5605877">4</span>&nbsp;<span class="op" id="5605879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605886">cr0</span><span class="op" id="5605889">[</span><span class="ident" id="5605890">i</span><span class="op" id="5605891">+</span><span class="num" id="5605892">0</span><span class="op" id="5605893">]</span>&nbsp;<span class="op" id="5605895">=</span>&nbsp;<span class="ident" id="5605897">pix</span><span class="op" id="5605900">[</span><span class="ident" id="5605901">j</span><span class="op" id="5605902">+</span><span class="num" id="5605903">0</span><span class="op" id="5605904">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605911">cr0</span><span class="op" id="5605914">[</span><span class="ident" id="5605915">i</span><span class="op" id="5605916">+</span><span class="num" id="5605917">1</span><span class="op" id="5605918">]</span>&nbsp;<span class="op" id="5605920">=</span>&nbsp;<span class="ident" id="5605922">pix</span><span class="op" id="5605925">[</span><span class="ident" id="5605926">j</span><span class="op" id="5605927">+</span><span class="num" id="5605928">1</span><span class="op" id="5605929">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605936">cr0</span><span class="op" id="5605939">[</span><span class="ident" id="5605940">i</span><span class="op" id="5605941">+</span><span class="num" id="5605942">2</span><span class="op" id="5605943">]</span>&nbsp;<span class="op" id="5605945">=</span>&nbsp;<span class="ident" id="5605947">pix</span><span class="op" id="5605950">[</span><span class="ident" id="5605951">j</span><span class="op" id="5605952">+</span><span class="num" id="5605953">2</span><span class="op" id="5605954">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5605961">i</span>&nbsp;<span class="op" id="5605963">+=</span>&nbsp;<span class="num" id="5605966">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5605977">}</span>&nbsp;<span class="keyword" id="5605979">else</span>&nbsp;<span class="op" id="5605984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5605990">for</span>&nbsp;<span class="ident" id="5605994">x</span>&nbsp;<span class="op" id="5605996">:=</span>&nbsp;<span class="ident" id="5605999">b</span><span class="op" id="5606000">.</span><span class="ident" id="5606001">Min</span><span class="op" id="5606004">.</span><span class="ident" id="5606005">X</span><span class="op" id="5606006">;</span>&nbsp;<span class="ident" id="5606008">x</span>&nbsp;<span class="op" id="5606010">&lt;</span>&nbsp;<span class="ident" id="5606012">b</span><span class="op" id="5606013">.</span><span class="ident" id="5606014">Max</span><span class="op" id="5606017">.</span><span class="ident" id="5606018">X</span><span class="op" id="5606019">;</span>&nbsp;<span class="ident" id="5606021">x</span><span class="op" id="5606022">++</span>&nbsp;<span class="op" id="5606025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606032">r</span><span class="op" id="5606033">,</span>&nbsp;<span class="ident" id="5606035">g</span><span class="op" id="5606036">,</span>&nbsp;<span class="ident" id="5606038">b</span><span class="op" id="5606039">,</span>&nbsp;<span class="ident" id="5606041">_</span>&nbsp;<span class="op" id="5606043">:=</span>&nbsp;<span class="ident" id="5606046">m</span><span class="op" id="5606047">.</span><span class="ident" id="5606048">At</span><span class="op" id="5606050">(</span><span class="ident" id="5606051">x</span><span class="op" id="5606052">,</span>&nbsp;<span class="ident" id="5606054">y</span><span class="op" id="5606055">)</span><span class="op" id="5606056">.</span><span class="ident" id="5606057">RGBA</span><span class="op" id="5606061">(</span><span class="op" id="5606062">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606069">cr0</span><span class="op" id="5606072">[</span><span class="ident" id="5606073">i</span><span class="op" id="5606074">+</span><span class="num" id="5606075">0</span><span class="op" id="5606076">]</span>&nbsp;<span class="op" id="5606078">=</span>&nbsp;<span class="builtintype" id="5606080">uint8</span><span class="op" id="5606085">(</span><span class="ident" id="5606086">r</span>&nbsp;<span class="op" id="5606088">&gt;&gt;</span>&nbsp;<span class="num" id="5606091">8</span><span class="op" id="5606092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606099">cr0</span><span class="op" id="5606102">[</span><span class="ident" id="5606103">i</span><span class="op" id="5606104">+</span><span class="num" id="5606105">1</span><span class="op" id="5606106">]</span>&nbsp;<span class="op" id="5606108">=</span>&nbsp;<span class="builtintype" id="5606110">uint8</span><span class="op" id="5606115">(</span><span class="ident" id="5606116">g</span>&nbsp;<span class="op" id="5606118">&gt;&gt;</span>&nbsp;<span class="num" id="5606121">8</span><span class="op" id="5606122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606129">cr0</span><span class="op" id="5606132">[</span><span class="ident" id="5606133">i</span><span class="op" id="5606134">+</span><span class="num" id="5606135">2</span><span class="op" id="5606136">]</span>&nbsp;<span class="op" id="5606138">=</span>&nbsp;<span class="builtintype" id="5606140">uint8</span><span class="op" id="5606145">(</span><span class="ident" id="5606146">b</span>&nbsp;<span class="op" id="5606148">&gt;&gt;</span>&nbsp;<span class="num" id="5606151">8</span><span class="op" id="5606152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606159">i</span>&nbsp;<span class="op" id="5606161">+=</span>&nbsp;<span class="num" id="5606164">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606170">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606179">case</span>&nbsp;<span class="ident" id="5606184">cbP8</span><span class="op" id="5606188">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606193">if</span>&nbsp;<span class="ident" id="5606196">paletted</span>&nbsp;<span class="op" id="5606205">!=</span>&nbsp;<span class="ident" id="5606208">nil</span>&nbsp;<span class="op" id="5606212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606218">offset</span>&nbsp;<span class="op" id="5606225">:=</span>&nbsp;<span class="op" id="5606228">(</span><span class="ident" id="5606229">y</span>&nbsp;<span class="op" id="5606231">-</span>&nbsp;<span class="ident" id="5606233">b</span><span class="op" id="5606234">.</span><span class="ident" id="5606235">Min</span><span class="op" id="5606238">.</span><span class="ident" id="5606239">Y</span><span class="op" id="5606240">)</span>&nbsp;<span class="op" id="5606242">*</span>&nbsp;<span class="ident" id="5606244">paletted</span><span class="op" id="5606252">.</span><span class="ident" id="5606253">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5606264">copy</span><span class="op" id="5606268">(</span><span class="ident" id="5606269">cr</span><span class="op" id="5606271">[</span><span class="num" id="5606272">0</span><span class="op" id="5606273">]</span><span class="op" id="5606274">[</span><span class="num" id="5606275">1</span><span class="op" id="5606276">:</span><span class="op" id="5606277">]</span><span class="op" id="5606278">,</span>&nbsp;<span class="ident" id="5606280">paletted</span><span class="op" id="5606288">.</span><span class="ident" id="5606289">Pix</span><span class="op" id="5606292">[</span><span class="ident" id="5606293">offset</span><span class="op" id="5606299">:</span><span class="ident" id="5606300">offset</span><span class="op" id="5606306">+</span><span class="ident" id="5606307">b</span><span class="op" id="5606308">.</span><span class="ident" id="5606309">Dx</span><span class="op" id="5606311">(</span><span class="op" id="5606312">)</span><span class="op" id="5606313">]</span><span class="op" id="5606314">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606319">}</span>&nbsp;<span class="keyword" id="5606321">else</span>&nbsp;<span class="op" id="5606326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606332">pi</span>&nbsp;<span class="op" id="5606335">:=</span>&nbsp;<span class="ident" id="5606338">m</span><span class="op" id="5606339">.</span><span class="op" id="5606340">(</span><span class="ident" id="5606341">image</span><span class="op" id="5606346">.</span><span class="ident" id="5606347">PalettedImage</span><span class="op" id="5606360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606366">for</span>&nbsp;<span class="ident" id="5606370">x</span>&nbsp;<span class="op" id="5606372">:=</span>&nbsp;<span class="ident" id="5606375">b</span><span class="op" id="5606376">.</span><span class="ident" id="5606377">Min</span><span class="op" id="5606380">.</span><span class="ident" id="5606381">X</span><span class="op" id="5606382">;</span>&nbsp;<span class="ident" id="5606384">x</span>&nbsp;<span class="op" id="5606386">&lt;</span>&nbsp;<span class="ident" id="5606388">b</span><span class="op" id="5606389">.</span><span class="ident" id="5606390">Max</span><span class="op" id="5606393">.</span><span class="ident" id="5606394">X</span><span class="op" id="5606395">;</span>&nbsp;<span class="ident" id="5606397">x</span><span class="op" id="5606398">++</span>&nbsp;<span class="op" id="5606401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606408">cr</span><span class="op" id="5606410">[</span><span class="num" id="5606411">0</span><span class="op" id="5606412">]</span><span class="op" id="5606413">[</span><span class="ident" id="5606414">i</span><span class="op" id="5606415">]</span>&nbsp;<span class="op" id="5606417">=</span>&nbsp;<span class="ident" id="5606419">pi</span><span class="op" id="5606421">.</span><span class="ident" id="5606422">ColorIndexAt</span><span class="op" id="5606434">(</span><span class="ident" id="5606435">x</span><span class="op" id="5606436">,</span>&nbsp;<span class="ident" id="5606438">y</span><span class="op" id="5606439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606446">i</span>&nbsp;<span class="op" id="5606448">+=</span>&nbsp;<span class="num" id="5606451">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606466">case</span>&nbsp;<span class="ident" id="5606471">cbTCA8</span><span class="op" id="5606477">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606482">if</span>&nbsp;<span class="ident" id="5606485">nrgba</span>&nbsp;<span class="op" id="5606491">!=</span>&nbsp;<span class="ident" id="5606494">nil</span>&nbsp;<span class="op" id="5606498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606504">offset</span>&nbsp;<span class="op" id="5606511">:=</span>&nbsp;<span class="op" id="5606514">(</span><span class="ident" id="5606515">y</span>&nbsp;<span class="op" id="5606517">-</span>&nbsp;<span class="ident" id="5606519">b</span><span class="op" id="5606520">.</span><span class="ident" id="5606521">Min</span><span class="op" id="5606524">.</span><span class="ident" id="5606525">Y</span><span class="op" id="5606526">)</span>&nbsp;<span class="op" id="5606528">*</span>&nbsp;<span class="ident" id="5606530">nrgba</span><span class="op" id="5606535">.</span><span class="ident" id="5606536">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5606547">copy</span><span class="op" id="5606551">(</span><span class="ident" id="5606552">cr</span><span class="op" id="5606554">[</span><span class="num" id="5606555">0</span><span class="op" id="5606556">]</span><span class="op" id="5606557">[</span><span class="num" id="5606558">1</span><span class="op" id="5606559">:</span><span class="op" id="5606560">]</span><span class="op" id="5606561">,</span>&nbsp;<span class="ident" id="5606563">nrgba</span><span class="op" id="5606568">.</span><span class="ident" id="5606569">Pix</span><span class="op" id="5606572">[</span><span class="ident" id="5606573">offset</span><span class="op" id="5606579">:</span><span class="ident" id="5606580">offset</span><span class="op" id="5606586">+</span><span class="ident" id="5606587">b</span><span class="op" id="5606588">.</span><span class="ident" id="5606589">Dx</span><span class="op" id="5606591">(</span><span class="op" id="5606592">)</span><span class="op" id="5606593">*</span><span class="num" id="5606594">4</span><span class="op" id="5606595">]</span><span class="op" id="5606596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606601">}</span>&nbsp;<span class="keyword" id="5606603">else</span>&nbsp;<span class="op" id="5606608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5606614">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606711">for</span>&nbsp;<span class="ident" id="5606715">x</span>&nbsp;<span class="op" id="5606717">:=</span>&nbsp;<span class="ident" id="5606720">b</span><span class="op" id="5606721">.</span><span class="ident" id="5606722">Min</span><span class="op" id="5606725">.</span><span class="ident" id="5606726">X</span><span class="op" id="5606727">;</span>&nbsp;<span class="ident" id="5606729">x</span>&nbsp;<span class="op" id="5606731">&lt;</span>&nbsp;<span class="ident" id="5606733">b</span><span class="op" id="5606734">.</span><span class="ident" id="5606735">Max</span><span class="op" id="5606738">.</span><span class="ident" id="5606739">X</span><span class="op" id="5606740">;</span>&nbsp;<span class="ident" id="5606742">x</span><span class="op" id="5606743">++</span>&nbsp;<span class="op" id="5606746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606753">c</span>&nbsp;<span class="op" id="5606755">:=</span>&nbsp;<span class="ident" id="5606758">color</span><span class="op" id="5606763">.</span><span class="ident" id="5606764">NRGBAModel</span><span class="op" id="5606774">.</span><span class="ident" id="5606775">Convert</span><span class="op" id="5606782">(</span><span class="ident" id="5606783">m</span><span class="op" id="5606784">.</span><span class="ident" id="5606785">At</span><span class="op" id="5606787">(</span><span class="ident" id="5606788">x</span><span class="op" id="5606789">,</span>&nbsp;<span class="ident" id="5606791">y</span><span class="op" id="5606792">)</span><span class="op" id="5606793">)</span><span class="op" id="5606794">.</span><span class="op" id="5606795">(</span><span class="ident" id="5606796">color</span><span class="op" id="5606801">.</span><span class="ident" id="5606802">NRGBA</span><span class="op" id="5606807">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606814">cr</span><span class="op" id="5606816">[</span><span class="num" id="5606817">0</span><span class="op" id="5606818">]</span><span class="op" id="5606819">[</span><span class="ident" id="5606820">i</span><span class="op" id="5606821">+</span><span class="num" id="5606822">0</span><span class="op" id="5606823">]</span>&nbsp;<span class="op" id="5606825">=</span>&nbsp;<span class="ident" id="5606827">c</span><span class="op" id="5606828">.</span><span class="ident" id="5606829">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606836">cr</span><span class="op" id="5606838">[</span><span class="num" id="5606839">0</span><span class="op" id="5606840">]</span><span class="op" id="5606841">[</span><span class="ident" id="5606842">i</span><span class="op" id="5606843">+</span><span class="num" id="5606844">1</span><span class="op" id="5606845">]</span>&nbsp;<span class="op" id="5606847">=</span>&nbsp;<span class="ident" id="5606849">c</span><span class="op" id="5606850">.</span><span class="ident" id="5606851">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606858">cr</span><span class="op" id="5606860">[</span><span class="num" id="5606861">0</span><span class="op" id="5606862">]</span><span class="op" id="5606863">[</span><span class="ident" id="5606864">i</span><span class="op" id="5606865">+</span><span class="num" id="5606866">2</span><span class="op" id="5606867">]</span>&nbsp;<span class="op" id="5606869">=</span>&nbsp;<span class="ident" id="5606871">c</span><span class="op" id="5606872">.</span><span class="ident" id="5606873">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606880">cr</span><span class="op" id="5606882">[</span><span class="num" id="5606883">0</span><span class="op" id="5606884">]</span><span class="op" id="5606885">[</span><span class="ident" id="5606886">i</span><span class="op" id="5606887">+</span><span class="num" id="5606888">3</span><span class="op" id="5606889">]</span>&nbsp;<span class="op" id="5606891">=</span>&nbsp;<span class="ident" id="5606893">c</span><span class="op" id="5606894">.</span><span class="ident" id="5606895">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606902">i</span>&nbsp;<span class="op" id="5606904">+=</span>&nbsp;<span class="num" id="5606907">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606922">case</span>&nbsp;<span class="ident" id="5606927">cbG16</span><span class="op" id="5606932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606937">for</span>&nbsp;<span class="ident" id="5606941">x</span>&nbsp;<span class="op" id="5606943">:=</span>&nbsp;<span class="ident" id="5606946">b</span><span class="op" id="5606947">.</span><span class="ident" id="5606948">Min</span><span class="op" id="5606951">.</span><span class="ident" id="5606952">X</span><span class="op" id="5606953">;</span>&nbsp;<span class="ident" id="5606955">x</span>&nbsp;<span class="op" id="5606957">&lt;</span>&nbsp;<span class="ident" id="5606959">b</span><span class="op" id="5606960">.</span><span class="ident" id="5606961">Max</span><span class="op" id="5606964">.</span><span class="ident" id="5606965">X</span><span class="op" id="5606966">;</span>&nbsp;<span class="ident" id="5606968">x</span><span class="op" id="5606969">++</span>&nbsp;<span class="op" id="5606972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606978">c</span>&nbsp;<span class="op" id="5606980">:=</span>&nbsp;<span class="ident" id="5606983">color</span><span class="op" id="5606988">.</span><span class="ident" id="5606989">Gray16Model</span><span class="op" id="5607000">.</span><span class="ident" id="5607001">Convert</span><span class="op" id="5607008">(</span><span class="ident" id="5607009">m</span><span class="op" id="5607010">.</span><span class="ident" id="5607011">At</span><span class="op" id="5607013">(</span><span class="ident" id="5607014">x</span><span class="op" id="5607015">,</span>&nbsp;<span class="ident" id="5607017">y</span><span class="op" id="5607018">)</span><span class="op" id="5607019">)</span><span class="op" id="5607020">.</span><span class="op" id="5607021">(</span><span class="ident" id="5607022">color</span><span class="op" id="5607027">.</span><span class="ident" id="5607028">Gray16</span><span class="op" id="5607034">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607040">cr</span><span class="op" id="5607042">[</span><span class="num" id="5607043">0</span><span class="op" id="5607044">]</span><span class="op" id="5607045">[</span><span class="ident" id="5607046">i</span><span class="op" id="5607047">+</span><span class="num" id="5607048">0</span><span class="op" id="5607049">]</span>&nbsp;<span class="op" id="5607051">=</span>&nbsp;<span class="builtintype" id="5607053">uint8</span><span class="op" id="5607058">(</span><span class="ident" id="5607059">c</span><span class="op" id="5607060">.</span><span class="ident" id="5607061">Y</span>&nbsp;<span class="op" id="5607063">&gt;&gt;</span>&nbsp;<span class="num" id="5607066">8</span><span class="op" id="5607067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607073">cr</span><span class="op" id="5607075">[</span><span class="num" id="5607076">0</span><span class="op" id="5607077">]</span><span class="op" id="5607078">[</span><span class="ident" id="5607079">i</span><span class="op" id="5607080">+</span><span class="num" id="5607081">1</span><span class="op" id="5607082">]</span>&nbsp;<span class="op" id="5607084">=</span>&nbsp;<span class="builtintype" id="5607086">uint8</span><span class="op" id="5607091">(</span><span class="ident" id="5607092">c</span><span class="op" id="5607093">.</span><span class="ident" id="5607094">Y</span><span class="op" id="5607095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607101">i</span>&nbsp;<span class="op" id="5607103">+=</span>&nbsp;<span class="num" id="5607106">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607115">case</span>&nbsp;<span class="ident" id="5607120">cbTC16</span><span class="op" id="5607126">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5607131">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607203">for</span>&nbsp;<span class="ident" id="5607207">x</span>&nbsp;<span class="op" id="5607209">:=</span>&nbsp;<span class="ident" id="5607212">b</span><span class="op" id="5607213">.</span><span class="ident" id="5607214">Min</span><span class="op" id="5607217">.</span><span class="ident" id="5607218">X</span><span class="op" id="5607219">;</span>&nbsp;<span class="ident" id="5607221">x</span>&nbsp;<span class="op" id="5607223">&lt;</span>&nbsp;<span class="ident" id="5607225">b</span><span class="op" id="5607226">.</span><span class="ident" id="5607227">Max</span><span class="op" id="5607230">.</span><span class="ident" id="5607231">X</span><span class="op" id="5607232">;</span>&nbsp;<span class="ident" id="5607234">x</span><span class="op" id="5607235">++</span>&nbsp;<span class="op" id="5607238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607244">r</span><span class="op" id="5607245">,</span>&nbsp;<span class="ident" id="5607247">g</span><span class="op" id="5607248">,</span>&nbsp;<span class="ident" id="5607250">b</span><span class="op" id="5607251">,</span>&nbsp;<span class="ident" id="5607253">_</span>&nbsp;<span class="op" id="5607255">:=</span>&nbsp;<span class="ident" id="5607258">m</span><span class="op" id="5607259">.</span><span class="ident" id="5607260">At</span><span class="op" id="5607262">(</span><span class="ident" id="5607263">x</span><span class="op" id="5607264">,</span>&nbsp;<span class="ident" id="5607266">y</span><span class="op" id="5607267">)</span><span class="op" id="5607268">.</span><span class="ident" id="5607269">RGBA</span><span class="op" id="5607273">(</span><span class="op" id="5607274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607280">cr</span><span class="op" id="5607282">[</span><span class="num" id="5607283">0</span><span class="op" id="5607284">]</span><span class="op" id="5607285">[</span><span class="ident" id="5607286">i</span><span class="op" id="5607287">+</span><span class="num" id="5607288">0</span><span class="op" id="5607289">]</span>&nbsp;<span class="op" id="5607291">=</span>&nbsp;<span class="builtintype" id="5607293">uint8</span><span class="op" id="5607298">(</span><span class="ident" id="5607299">r</span>&nbsp;<span class="op" id="5607301">&gt;&gt;</span>&nbsp;<span class="num" id="5607304">8</span><span class="op" id="5607305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607311">cr</span><span class="op" id="5607313">[</span><span class="num" id="5607314">0</span><span class="op" id="5607315">]</span><span class="op" id="5607316">[</span><span class="ident" id="5607317">i</span><span class="op" id="5607318">+</span><span class="num" id="5607319">1</span><span class="op" id="5607320">]</span>&nbsp;<span class="op" id="5607322">=</span>&nbsp;<span class="builtintype" id="5607324">uint8</span><span class="op" id="5607329">(</span><span class="ident" id="5607330">r</span><span class="op" id="5607331">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607337">cr</span><span class="op" id="5607339">[</span><span class="num" id="5607340">0</span><span class="op" id="5607341">]</span><span class="op" id="5607342">[</span><span class="ident" id="5607343">i</span><span class="op" id="5607344">+</span><span class="num" id="5607345">2</span><span class="op" id="5607346">]</span>&nbsp;<span class="op" id="5607348">=</span>&nbsp;<span class="builtintype" id="5607350">uint8</span><span class="op" id="5607355">(</span><span class="ident" id="5607356">g</span>&nbsp;<span class="op" id="5607358">&gt;&gt;</span>&nbsp;<span class="num" id="5607361">8</span><span class="op" id="5607362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607368">cr</span><span class="op" id="5607370">[</span><span class="num" id="5607371">0</span><span class="op" id="5607372">]</span><span class="op" id="5607373">[</span><span class="ident" id="5607374">i</span><span class="op" id="5607375">+</span><span class="num" id="5607376">3</span><span class="op" id="5607377">]</span>&nbsp;<span class="op" id="5607379">=</span>&nbsp;<span class="builtintype" id="5607381">uint8</span><span class="op" id="5607386">(</span><span class="ident" id="5607387">g</span><span class="op" id="5607388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607394">cr</span><span class="op" id="5607396">[</span><span class="num" id="5607397">0</span><span class="op" id="5607398">]</span><span class="op" id="5607399">[</span><span class="ident" id="5607400">i</span><span class="op" id="5607401">+</span><span class="num" id="5607402">4</span><span class="op" id="5607403">]</span>&nbsp;<span class="op" id="5607405">=</span>&nbsp;<span class="builtintype" id="5607407">uint8</span><span class="op" id="5607412">(</span><span class="ident" id="5607413">b</span>&nbsp;<span class="op" id="5607415">&gt;&gt;</span>&nbsp;<span class="num" id="5607418">8</span><span class="op" id="5607419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607425">cr</span><span class="op" id="5607427">[</span><span class="num" id="5607428">0</span><span class="op" id="5607429">]</span><span class="op" id="5607430">[</span><span class="ident" id="5607431">i</span><span class="op" id="5607432">+</span><span class="num" id="5607433">5</span><span class="op" id="5607434">]</span>&nbsp;<span class="op" id="5607436">=</span>&nbsp;<span class="builtintype" id="5607438">uint8</span><span class="op" id="5607443">(</span><span class="ident" id="5607444">b</span><span class="op" id="5607445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607451">i</span>&nbsp;<span class="op" id="5607453">+=</span>&nbsp;<span class="num" id="5607456">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607465">case</span>&nbsp;<span class="ident" id="5607470">cbTCA16</span><span class="op" id="5607477">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5607482">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607578">for</span>&nbsp;<span class="ident" id="5607582">x</span>&nbsp;<span class="op" id="5607584">:=</span>&nbsp;<span class="ident" id="5607587">b</span><span class="op" id="5607588">.</span><span class="ident" id="5607589">Min</span><span class="op" id="5607592">.</span><span class="ident" id="5607593">X</span><span class="op" id="5607594">;</span>&nbsp;<span class="ident" id="5607596">x</span>&nbsp;<span class="op" id="5607598">&lt;</span>&nbsp;<span class="ident" id="5607600">b</span><span class="op" id="5607601">.</span><span class="ident" id="5607602">Max</span><span class="op" id="5607605">.</span><span class="ident" id="5607606">X</span><span class="op" id="5607607">;</span>&nbsp;<span class="ident" id="5607609">x</span><span class="op" id="5607610">++</span>&nbsp;<span class="op" id="5607613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607619">c</span>&nbsp;<span class="op" id="5607621">:=</span>&nbsp;<span class="ident" id="5607624">color</span><span class="op" id="5607629">.</span><span class="ident" id="5607630">NRGBA64Model</span><span class="op" id="5607642">.</span><span class="ident" id="5607643">Convert</span><span class="op" id="5607650">(</span><span class="ident" id="5607651">m</span><span class="op" id="5607652">.</span><span class="ident" id="5607653">At</span><span class="op" id="5607655">(</span><span class="ident" id="5607656">x</span><span class="op" id="5607657">,</span>&nbsp;<span class="ident" id="5607659">y</span><span class="op" id="5607660">)</span><span class="op" id="5607661">)</span><span class="op" id="5607662">.</span><span class="op" id="5607663">(</span><span class="ident" id="5607664">color</span><span class="op" id="5607669">.</span><span class="ident" id="5607670">NRGBA64</span><span class="op" id="5607677">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607683">cr</span><span class="op" id="5607685">[</span><span class="num" id="5607686">0</span><span class="op" id="5607687">]</span><span class="op" id="5607688">[</span><span class="ident" id="5607689">i</span><span class="op" id="5607690">+</span><span class="num" id="5607691">0</span><span class="op" id="5607692">]</span>&nbsp;<span class="op" id="5607694">=</span>&nbsp;<span class="builtintype" id="5607696">uint8</span><span class="op" id="5607701">(</span><span class="ident" id="5607702">c</span><span class="op" id="5607703">.</span><span class="ident" id="5607704">R</span>&nbsp;<span class="op" id="5607706">&gt;&gt;</span>&nbsp;<span class="num" id="5607709">8</span><span class="op" id="5607710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607716">cr</span><span class="op" id="5607718">[</span><span class="num" id="5607719">0</span><span class="op" id="5607720">]</span><span class="op" id="5607721">[</span><span class="ident" id="5607722">i</span><span class="op" id="5607723">+</span><span class="num" id="5607724">1</span><span class="op" id="5607725">]</span>&nbsp;<span class="op" id="5607727">=</span>&nbsp;<span class="builtintype" id="5607729">uint8</span><span class="op" id="5607734">(</span><span class="ident" id="5607735">c</span><span class="op" id="5607736">.</span><span class="ident" id="5607737">R</span><span class="op" id="5607738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607744">cr</span><span class="op" id="5607746">[</span><span class="num" id="5607747">0</span><span class="op" id="5607748">]</span><span class="op" id="5607749">[</span><span class="ident" id="5607750">i</span><span class="op" id="5607751">+</span><span class="num" id="5607752">2</span><span class="op" id="5607753">]</span>&nbsp;<span class="op" id="5607755">=</span>&nbsp;<span class="builtintype" id="5607757">uint8</span><span class="op" id="5607762">(</span><span class="ident" id="5607763">c</span><span class="op" id="5607764">.</span><span class="ident" id="5607765">G</span>&nbsp;<span class="op" id="5607767">&gt;&gt;</span>&nbsp;<span class="num" id="5607770">8</span><span class="op" id="5607771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607777">cr</span><span class="op" id="5607779">[</span><span class="num" id="5607780">0</span><span class="op" id="5607781">]</span><span class="op" id="5607782">[</span><span class="ident" id="5607783">i</span><span class="op" id="5607784">+</span><span class="num" id="5607785">3</span><span class="op" id="5607786">]</span>&nbsp;<span class="op" id="5607788">=</span>&nbsp;<span class="builtintype" id="5607790">uint8</span><span class="op" id="5607795">(</span><span class="ident" id="5607796">c</span><span class="op" id="5607797">.</span><span class="ident" id="5607798">G</span><span class="op" id="5607799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607805">cr</span><span class="op" id="5607807">[</span><span class="num" id="5607808">0</span><span class="op" id="5607809">]</span><span class="op" id="5607810">[</span><span class="ident" id="5607811">i</span><span class="op" id="5607812">+</span><span class="num" id="5607813">4</span><span class="op" id="5607814">]</span>&nbsp;<span class="op" id="5607816">=</span>&nbsp;<span class="builtintype" id="5607818">uint8</span><span class="op" id="5607823">(</span><span class="ident" id="5607824">c</span><span class="op" id="5607825">.</span><span class="ident" id="5607826">B</span>&nbsp;<span class="op" id="5607828">&gt;&gt;</span>&nbsp;<span class="num" id="5607831">8</span><span class="op" id="5607832">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607838">cr</span><span class="op" id="5607840">[</span><span class="num" id="5607841">0</span><span class="op" id="5607842">]</span><span class="op" id="5607843">[</span><span class="ident" id="5607844">i</span><span class="op" id="5607845">+</span><span class="num" id="5607846">5</span><span class="op" id="5607847">]</span>&nbsp;<span class="op" id="5607849">=</span>&nbsp;<span class="builtintype" id="5607851">uint8</span><span class="op" id="5607856">(</span><span class="ident" id="5607857">c</span><span class="op" id="5607858">.</span><span class="ident" id="5607859">B</span><span class="op" id="5607860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607866">cr</span><span class="op" id="5607868">[</span><span class="num" id="5607869">0</span><span class="op" id="5607870">]</span><span class="op" id="5607871">[</span><span class="ident" id="5607872">i</span><span class="op" id="5607873">+</span><span class="num" id="5607874">6</span><span class="op" id="5607875">]</span>&nbsp;<span class="op" id="5607877">=</span>&nbsp;<span class="builtintype" id="5607879">uint8</span><span class="op" id="5607884">(</span><span class="ident" id="5607885">c</span><span class="op" id="5607886">.</span><span class="ident" id="5607887">A</span>&nbsp;<span class="op" id="5607889">&gt;&gt;</span>&nbsp;<span class="num" id="5607892">8</span><span class="op" id="5607893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607899">cr</span><span class="op" id="5607901">[</span><span class="num" id="5607902">0</span><span class="op" id="5607903">]</span><span class="op" id="5607904">[</span><span class="ident" id="5607905">i</span><span class="op" id="5607906">+</span><span class="num" id="5607907">7</span><span class="op" id="5607908">]</span>&nbsp;<span class="op" id="5607910">=</span>&nbsp;<span class="builtintype" id="5607912">uint8</span><span class="op" id="5607917">(</span><span class="ident" id="5607918">c</span><span class="op" id="5607919">.</span><span class="ident" id="5607920">A</span><span class="op" id="5607921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607927">i</span>&nbsp;<span class="op" id="5607929">+=</span>&nbsp;<span class="num" id="5607932">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607937">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5607946">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607969">f</span>&nbsp;<span class="op" id="5607971">:=</span>&nbsp;<span class="ident" id="5607974">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607983">if</span>&nbsp;<span class="ident" id="5607986">level</span>&nbsp;<span class="op" id="5607992">!=</span>&nbsp;<span class="ident" id="5607995">zlib</span><span class="op" id="5607999">.</span><span class="ident" id="5608000">NoCompression</span>&nbsp;<span class="op" id="5608014">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608019">f</span>&nbsp;<span class="op" id="5608021">=</span>&nbsp;<span class="ident" id="5608023">filter</span><span class="op" id="5608029">(</span><span class="op" id="5608030">&amp;</span><span class="ident" id="5608031">cr</span><span class="op" id="5608033">,</span>&nbsp;<span class="ident" id="5608035">pr</span><span class="op" id="5608037">,</span>&nbsp;<span class="ident" id="5608039">bpp</span><span class="op" id="5608042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5608046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5608051">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608084">if</span>&nbsp;<span class="ident" id="5608087">_</span><span class="op" id="5608088">,</span>&nbsp;<span class="ident" id="5608090">err</span>&nbsp;<span class="op" id="5608094">:=</span>&nbsp;<span class="ident" id="5608097">zw</span><span class="op" id="5608099">.</span><span class="ident" id="5608100">Write</span><span class="op" id="5608105">(</span><span class="ident" id="5608106">cr</span><span class="op" id="5608108">[</span><span class="ident" id="5608109">f</span><span class="op" id="5608110">]</span><span class="op" id="5608111">)</span><span class="op" id="5608112">;</span>&nbsp;<span class="ident" id="5608114">err</span>&nbsp;<span class="op" id="5608118">!=</span>&nbsp;<span class="ident" id="5608121">nil</span>&nbsp;<span class="op" id="5608125">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608130">return</span>&nbsp;<span class="ident" id="5608137">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5608143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5608148">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608204">pr</span><span class="op" id="5608206">,</span>&nbsp;<span class="ident" id="5608208">cr</span><span class="op" id="5608210">[</span><span class="num" id="5608211">0</span><span class="op" id="5608212">]</span>&nbsp;<span class="op" id="5608214">=</span>&nbsp;<span class="ident" id="5608216">cr</span><span class="op" id="5608218">[</span><span class="num" id="5608219">0</span><span class="op" id="5608220">]</span><span class="op" id="5608221">,</span>&nbsp;<span class="ident" id="5608223">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5608227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608230">return</span>&nbsp;<span class="ident" id="5608237">nil</span><br>
<span class="lineno"></span><span class="op" id="5608241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5608244">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="5608303">func</span>&nbsp;<span class="op" id="5608308">(</span><span class="ident" id="5608309">e</span>&nbsp;<span class="op" id="5608311">*</span><span class="ident" id="5608312">encoder</span><span class="op" id="5608319">)</span>&nbsp;<span class="ident" id="5608321">writeIDATs</span><span class="op" id="5608331">(</span><span class="op" id="5608332">)</span>&nbsp;<span class="op" id="5608334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608337">if</span>&nbsp;<span class="ident" id="5608340">e</span><span class="op" id="5608341">.</span><span class="ident" id="5608342">err</span>&nbsp;<span class="op" id="5608346">!=</span>&nbsp;<span class="ident" id="5608349">nil</span>&nbsp;<span class="op" id="5608353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608357">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5608365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608368">var</span>&nbsp;<span class="ident" id="5608372">bw</span>&nbsp;<span class="op" id="5608375">*</span><span class="ident" id="5608376">bufio</span><span class="op" id="5608381">.</span><span class="ident" id="5608382">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608390">bw</span>&nbsp;<span class="op" id="5608393">=</span>&nbsp;<span class="ident" id="5608395">bufio</span><span class="op" id="5608400">.</span><span class="ident" id="5608401">NewWriterSize</span><span class="op" id="5608414">(</span><span class="ident" id="5608415">e</span><span class="op" id="5608416">,</span>&nbsp;<span class="num" id="5608418">1</span><span class="op" id="5608419">&lt;&lt;</span><span class="num" id="5608421">15</span><span class="op" id="5608423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608426">e</span><span class="op" id="5608427">.</span><span class="ident" id="5608428">err</span>&nbsp;<span class="op" id="5608432">=</span>&nbsp;<span class="ident" id="5608434">writeImage</span><span class="op" id="5608444">(</span><span class="ident" id="5608445">bw</span><span class="op" id="5608447">,</span>&nbsp;<span class="ident" id="5608449">e</span><span class="op" id="5608450">.</span><span class="ident" id="5608451">m</span><span class="op" id="5608452">,</span>&nbsp;<span class="ident" id="5608454">e</span><span class="op" id="5608455">.</span><span class="ident" id="5608456">cb</span><span class="op" id="5608458">,</span>&nbsp;<span class="ident" id="5608460">levelToZlib</span><span class="op" id="5608471">(</span><span class="ident" id="5608472">e</span><span class="op" id="5608473">.</span><span class="ident" id="5608474">enc</span><span class="op" id="5608477">.</span><span class="ident" id="5608478">CompressionLevel</span><span class="op" id="5608494">)</span><span class="op" id="5608495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608498">if</span>&nbsp;<span class="ident" id="5608501">e</span><span class="op" id="5608502">.</span><span class="ident" id="5608503">err</span>&nbsp;<span class="op" id="5608507">!=</span>&nbsp;<span class="ident" id="5608510">nil</span>&nbsp;<span class="op" id="5608514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608518">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5608526">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608529">e</span><span class="op" id="5608530">.</span><span class="ident" id="5608531">err</span>&nbsp;<span class="op" id="5608535">=</span>&nbsp;<span class="ident" id="5608537">bw</span><span class="op" id="5608539">.</span><span class="ident" id="5608540">Flush</span><span class="op" id="5608545">(</span><span class="op" id="5608546">)</span><br>
<span class="lineno"></span><span class="op" id="5608548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5608551">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5608614">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="5608677">func</span>&nbsp;<span class="ident" id="5608682">levelToZlib</span><span class="op" id="5608693">(</span><span class="ident" id="5608694">l</span>&nbsp;<span class="ident" id="5608696">CompressionLevel</span><span class="op" id="5608712">)</span>&nbsp;<span class="builtintype" id="5608714">int</span>&nbsp;<span class="op" id="5608718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608721">switch</span>&nbsp;<span class="ident" id="5608728">l</span>&nbsp;<span class="op" id="5608730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608733">case</span>&nbsp;<span class="ident" id="5608738">DefaultCompression</span><span class="op" id="5608756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608760">return</span>&nbsp;<span class="ident" id="5608767">zlib</span><span class="op" id="5608771">.</span><span class="ident" id="5608772">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608792">case</span>&nbsp;<span class="ident" id="5608797">NoCompression</span><span class="op" id="5608810">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608814">return</span>&nbsp;<span class="ident" id="5608821">zlib</span><span class="op" id="5608825">.</span><span class="ident" id="5608826">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608841">case</span>&nbsp;<span class="ident" id="5608846">BestSpeed</span><span class="op" id="5608855">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608859">return</span>&nbsp;<span class="ident" id="5608866">zlib</span><span class="op" id="5608870">.</span><span class="ident" id="5608871">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608882">case</span>&nbsp;<span class="ident" id="5608887">BestCompression</span><span class="op" id="5608902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608906">return</span>&nbsp;<span class="ident" id="5608913">zlib</span><span class="op" id="5608917">.</span><span class="ident" id="5608918">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608935">default</span><span class="op" id="5608942">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608946">return</span>&nbsp;<span class="ident" id="5608953">zlib</span><span class="op" id="5608957">.</span><span class="ident" id="5608958">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5608978">}</span><br>
<span class="lineno"></span><span class="op" id="5608980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="5608983">func</span>&nbsp;<span class="op" id="5608988">(</span><span class="ident" id="5608989">e</span>&nbsp;<span class="op" id="5608991">*</span><span class="ident" id="5608992">encoder</span><span class="op" id="5608999">)</span>&nbsp;<span class="ident" id="5609001">writeIEND</span><span class="op" id="5609010">(</span><span class="op" id="5609011">)</span>&nbsp;<span class="op" id="5609013">{</span>&nbsp;<span class="ident" id="5609015">e</span><span class="op" id="5609016">.</span><span class="ident" id="5609017">writeChunk</span><span class="op" id="5609027">(</span><span class="ident" id="5609028">nil</span><span class="op" id="5609031">,</span>&nbsp;<span class="string" id="5609033">&#34;IEND&#34;</span><span class="op" id="5609039">)</span>&nbsp;<span class="op" id="5609041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5609044">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5609110">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="5609184">func</span>&nbsp;<span class="ident" id="5609189">Encode</span><span class="op" id="5609195">(</span><span class="ident" id="5609196">w</span>&nbsp;<span class="ident" id="5609198">io</span><span class="op" id="5609200">.</span><span class="ident" id="5609201">Writer</span><span class="op" id="5609207">,</span>&nbsp;<span class="ident" id="5609209">m</span>&nbsp;<span class="ident" id="5609211">image</span><span class="op" id="5609216">.</span><span class="ident" id="5609217">Image</span><span class="op" id="5609222">)</span>&nbsp;<span class="builtintype" id="5609224">error</span>&nbsp;<span class="op" id="5609230">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609233">var</span>&nbsp;<span class="ident" id="5609237">e</span>&nbsp;<span class="ident" id="5609239">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609248">return</span>&nbsp;<span class="ident" id="5609255">e</span><span class="op" id="5609256">.</span><span class="ident" id="5609257">Encode</span><span class="op" id="5609263">(</span><span class="ident" id="5609264">w</span><span class="op" id="5609265">,</span>&nbsp;<span class="ident" id="5609267">m</span><span class="op" id="5609268">)</span><br>
<span class="lineno"></span><span class="op" id="5609270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5609273">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="5609322">func</span>&nbsp;<span class="op" id="5609327">(</span><span class="ident" id="5609328">enc</span>&nbsp;<span class="op" id="5609332">*</span><span class="ident" id="5609333">Encoder</span><span class="op" id="5609340">)</span>&nbsp;<span class="ident" id="5609342">Encode</span><span class="op" id="5609348">(</span><span class="ident" id="5609349">w</span>&nbsp;<span class="ident" id="5609351">io</span><span class="op" id="5609353">.</span><span class="ident" id="5609354">Writer</span><span class="op" id="5609360">,</span>&nbsp;<span class="ident" id="5609362">m</span>&nbsp;<span class="ident" id="5609364">image</span><span class="op" id="5609369">.</span><span class="ident" id="5609370">Image</span><span class="op" id="5609375">)</span>&nbsp;<span class="builtintype" id="5609377">error</span>&nbsp;<span class="op" id="5609383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5609386">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5609463">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5609543">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609562">mw</span><span class="op" id="5609564">,</span>&nbsp;<span class="ident" id="5609566">mh</span>&nbsp;<span class="op" id="5609569">:=</span>&nbsp;<span class="ident" id="5609572">int64</span><span class="op" id="5609577">(</span><span class="ident" id="5609578">m</span><span class="op" id="5609579">.</span><span class="ident" id="5609580">Bounds</span><span class="op" id="5609586">(</span><span class="op" id="5609587">)</span><span class="op" id="5609588">.</span><span class="ident" id="5609589">Dx</span><span class="op" id="5609591">(</span><span class="op" id="5609592">)</span><span class="op" id="5609593">)</span><span class="op" id="5609594">,</span>&nbsp;<span class="ident" id="5609596">int64</span><span class="op" id="5609601">(</span><span class="ident" id="5609602">m</span><span class="op" id="5609603">.</span><span class="ident" id="5609604">Bounds</span><span class="op" id="5609610">(</span><span class="op" id="5609611">)</span><span class="op" id="5609612">.</span><span class="ident" id="5609613">Dy</span><span class="op" id="5609615">(</span><span class="op" id="5609616">)</span><span class="op" id="5609617">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609620">if</span>&nbsp;<span class="ident" id="5609623">mw</span>&nbsp;<span class="op" id="5609626">&lt;=</span>&nbsp;<span class="num" id="5609629">0</span>&nbsp;<span class="op" id="5609631">||</span>&nbsp;<span class="ident" id="5609634">mh</span>&nbsp;<span class="op" id="5609637">&lt;=</span>&nbsp;<span class="num" id="5609640">0</span>&nbsp;<span class="op" id="5609642">||</span>&nbsp;<span class="ident" id="5609645">mw</span>&nbsp;<span class="op" id="5609648">&gt;=</span>&nbsp;<span class="num" id="5609651">1</span><span class="op" id="5609652">&lt;&lt;</span><span class="num" id="5609654">32</span>&nbsp;<span class="op" id="5609657">||</span>&nbsp;<span class="ident" id="5609660">mh</span>&nbsp;<span class="op" id="5609663">&gt;=</span>&nbsp;<span class="num" id="5609666">1</span><span class="op" id="5609667">&lt;&lt;</span><span class="num" id="5609669">32</span>&nbsp;<span class="op" id="5609672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609676">return</span>&nbsp;<span class="ident" id="5609683">FormatError</span><span class="op" id="5609694">(</span><span class="string" id="5609695">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="5609718">+</span>&nbsp;<span class="ident" id="5609720">strconv</span><span class="op" id="5609727">.</span><span class="ident" id="5609728">FormatInt</span><span class="op" id="5609737">(</span><span class="ident" id="5609738">mw</span><span class="op" id="5609740">,</span>&nbsp;<span class="num" id="5609742">10</span><span class="op" id="5609744">)</span>&nbsp;<span class="op" id="5609746">+</span>&nbsp;<span class="string" id="5609748">&#34;x&#34;</span>&nbsp;<span class="op" id="5609752">+</span>&nbsp;<span class="ident" id="5609754">strconv</span><span class="op" id="5609761">.</span><span class="ident" id="5609762">FormatInt</span><span class="op" id="5609771">(</span><span class="ident" id="5609772">mh</span><span class="op" id="5609774">,</span>&nbsp;<span class="num" id="5609776">10</span><span class="op" id="5609778">)</span><span class="op" id="5609779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5609782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609786">var</span>&nbsp;<span class="ident" id="5609790">e</span>&nbsp;<span class="ident" id="5609792">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609801">e</span><span class="op" id="5609802">.</span><span class="ident" id="5609803">enc</span>&nbsp;<span class="op" id="5609807">=</span>&nbsp;<span class="ident" id="5609809">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609814">e</span><span class="op" id="5609815">.</span><span class="ident" id="5609816">w</span>&nbsp;<span class="op" id="5609818">=</span>&nbsp;<span class="ident" id="5609820">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609823">e</span><span class="op" id="5609824">.</span><span class="ident" id="5609825">m</span>&nbsp;<span class="op" id="5609827">=</span>&nbsp;<span class="ident" id="5609829">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609833">var</span>&nbsp;<span class="ident" id="5609837">pal</span>&nbsp;<span class="ident" id="5609841">color</span><span class="op" id="5609846">.</span><span class="ident" id="5609847">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5609856">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609917">if</span>&nbsp;<span class="ident" id="5609920">_</span><span class="op" id="5609921">,</span>&nbsp;<span class="ident" id="5609923">ok</span>&nbsp;<span class="op" id="5609926">:=</span>&nbsp;<span class="ident" id="5609929">m</span><span class="op" id="5609930">.</span><span class="op" id="5609931">(</span><span class="ident" id="5609932">image</span><span class="op" id="5609937">.</span><span class="ident" id="5609938">PalettedImage</span><span class="op" id="5609951">)</span><span class="op" id="5609952">;</span>&nbsp;<span class="ident" id="5609954">ok</span>&nbsp;<span class="op" id="5609957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609961">pal</span><span class="op" id="5609964">,</span>&nbsp;<span class="ident" id="5609966">_</span>&nbsp;<span class="op" id="5609968">=</span>&nbsp;<span class="ident" id="5609970">m</span><span class="op" id="5609971">.</span><span class="ident" id="5609972">ColorModel</span><span class="op" id="5609982">(</span><span class="op" id="5609983">)</span><span class="op" id="5609984">.</span><span class="op" id="5609985">(</span><span class="ident" id="5609986">color</span><span class="op" id="5609991">.</span><span class="ident" id="5609992">Palette</span><span class="op" id="5609999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610005">if</span>&nbsp;<span class="ident" id="5610008">pal</span>&nbsp;<span class="op" id="5610012">!=</span>&nbsp;<span class="ident" id="5610015">nil</span>&nbsp;<span class="op" id="5610019">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610023">e</span><span class="op" id="5610024">.</span><span class="ident" id="5610025">cb</span>&nbsp;<span class="op" id="5610028">=</span>&nbsp;<span class="ident" id="5610030">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610036">}</span>&nbsp;<span class="keyword" id="5610038">else</span>&nbsp;<span class="op" id="5610043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610047">switch</span>&nbsp;<span class="ident" id="5610054">m</span><span class="op" id="5610055">.</span><span class="ident" id="5610056">ColorModel</span><span class="op" id="5610066">(</span><span class="op" id="5610067">)</span>&nbsp;<span class="op" id="5610069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610073">case</span>&nbsp;<span class="ident" id="5610078">color</span><span class="op" id="5610083">.</span><span class="ident" id="5610084">GrayModel</span><span class="op" id="5610093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610098">e</span><span class="op" id="5610099">.</span><span class="ident" id="5610100">cb</span>&nbsp;<span class="op" id="5610103">=</span>&nbsp;<span class="ident" id="5610105">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610112">case</span>&nbsp;<span class="ident" id="5610117">color</span><span class="op" id="5610122">.</span><span class="ident" id="5610123">Gray16Model</span><span class="op" id="5610134">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610139">e</span><span class="op" id="5610140">.</span><span class="ident" id="5610141">cb</span>&nbsp;<span class="op" id="5610144">=</span>&nbsp;<span class="ident" id="5610146">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610154">case</span>&nbsp;<span class="ident" id="5610159">color</span><span class="op" id="5610164">.</span><span class="ident" id="5610165">RGBAModel</span><span class="op" id="5610174">,</span>&nbsp;<span class="ident" id="5610176">color</span><span class="op" id="5610181">.</span><span class="ident" id="5610182">NRGBAModel</span><span class="op" id="5610192">,</span>&nbsp;<span class="ident" id="5610194">color</span><span class="op" id="5610199">.</span><span class="ident" id="5610200">AlphaModel</span><span class="op" id="5610210">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610215">if</span>&nbsp;<span class="ident" id="5610218">opaque</span><span class="op" id="5610224">(</span><span class="ident" id="5610225">m</span><span class="op" id="5610226">)</span>&nbsp;<span class="op" id="5610228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610234">e</span><span class="op" id="5610235">.</span><span class="ident" id="5610236">cb</span>&nbsp;<span class="op" id="5610239">=</span>&nbsp;<span class="ident" id="5610241">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610250">}</span>&nbsp;<span class="keyword" id="5610252">else</span>&nbsp;<span class="op" id="5610257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610263">e</span><span class="op" id="5610264">.</span><span class="ident" id="5610265">cb</span>&nbsp;<span class="op" id="5610268">=</span>&nbsp;<span class="ident" id="5610270">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610284">default</span><span class="op" id="5610291">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610296">if</span>&nbsp;<span class="ident" id="5610299">opaque</span><span class="op" id="5610305">(</span><span class="ident" id="5610306">m</span><span class="op" id="5610307">)</span>&nbsp;<span class="op" id="5610309">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610315">e</span><span class="op" id="5610316">.</span><span class="ident" id="5610317">cb</span>&nbsp;<span class="op" id="5610320">=</span>&nbsp;<span class="ident" id="5610322">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610332">}</span>&nbsp;<span class="keyword" id="5610334">else</span>&nbsp;<span class="op" id="5610339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610345">e</span><span class="op" id="5610346">.</span><span class="ident" id="5610347">cb</span>&nbsp;<span class="op" id="5610350">=</span>&nbsp;<span class="ident" id="5610352">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610367">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610374">_</span><span class="op" id="5610375">,</span>&nbsp;<span class="ident" id="5610377">e</span><span class="op" id="5610378">.</span><span class="ident" id="5610379">err</span>&nbsp;<span class="op" id="5610383">=</span>&nbsp;<span class="ident" id="5610385">io</span><span class="op" id="5610387">.</span><span class="ident" id="5610388">WriteString</span><span class="op" id="5610399">(</span><span class="ident" id="5610400">w</span><span class="op" id="5610401">,</span>&nbsp;<span class="ident" id="5610403">pngHeader</span><span class="op" id="5610412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610415">e</span><span class="op" id="5610416">.</span><span class="ident" id="5610417">writeIHDR</span><span class="op" id="5610426">(</span><span class="op" id="5610427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610430">if</span>&nbsp;<span class="ident" id="5610433">pal</span>&nbsp;<span class="op" id="5610437">!=</span>&nbsp;<span class="ident" id="5610440">nil</span>&nbsp;<span class="op" id="5610444">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610448">e</span><span class="op" id="5610449">.</span><span class="ident" id="5610450">writePLTEAndTRNS</span><span class="op" id="5610466">(</span><span class="ident" id="5610467">pal</span><span class="op" id="5610470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610476">e</span><span class="op" id="5610477">.</span><span class="ident" id="5610478">writeIDATs</span><span class="op" id="5610488">(</span><span class="op" id="5610489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610492">e</span><span class="op" id="5610493">.</span><span class="ident" id="5610494">writeIEND</span><span class="op" id="5610503">(</span><span class="op" id="5610504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610507">return</span>&nbsp;<span class="ident" id="5610514">e</span><span class="op" id="5610515">.</span><span class="ident" id="5610516">err</span><br>
<span class="lineno">530</span><span class="op" id="5610520">}</span>
</div>
</body>
</html>
