<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html" class="current">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3731636">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3731691">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3731745">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3731796">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3731834">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3731908">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3731981">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3732015">package</span>&nbsp;<span class="ident" id="3732023">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3732031">type</span>&nbsp;<span class="ident" id="3732036">cbc</span>&nbsp;<span class="keyword" id="3732040">struct</span>&nbsp;<span class="op" id="3732047">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732050">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732060">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732067">blockSize</span>&nbsp;<span class="builtintype" id="3732077">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732082">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3732092">[</span><span class="op" id="3732093">]</span><span class="builtintype" id="3732094">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732100">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3732110">[</span><span class="op" id="3732111">]</span><span class="builtintype" id="3732112">byte</span><br>
<span class="lineno"></span><span class="op" id="3732117">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3732120">func</span>&nbsp;<span class="ident" id="3732125">newCBC</span><span class="op" id="3732131">(</span><span class="ident" id="3732132">b</span>&nbsp;<span class="ident" id="3732134">Block</span><span class="op" id="3732139">,</span>&nbsp;<span class="ident" id="3732141">iv</span>&nbsp;<span class="op" id="3732144">[</span><span class="op" id="3732145">]</span><span class="builtintype" id="3732146">byte</span><span class="op" id="3732150">)</span>&nbsp;<span class="op" id="3732152">*</span><span class="ident" id="3732153">cbc</span>&nbsp;<span class="op" id="3732157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3732160">return</span>&nbsp;<span class="op" id="3732167">&amp;</span><span class="ident" id="3732168">cbc</span><span class="op" id="3732171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732175">b</span><span class="op" id="3732176">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732186">b</span><span class="op" id="3732187">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732191">blockSize</span><span class="op" id="3732200">:</span>&nbsp;<span class="ident" id="3732202">b</span><span class="op" id="3732203">.</span><span class="ident" id="3732204">BlockSize</span><span class="op" id="3732213">(</span><span class="op" id="3732214">)</span><span class="op" id="3732215">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732219">iv</span><span class="op" id="3732221">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732230">dup</span><span class="op" id="3732233">(</span><span class="ident" id="3732234">iv</span><span class="op" id="3732236">)</span><span class="op" id="3732237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732241">tmp</span><span class="op" id="3732244">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3732252">make</span><span class="op" id="3732256">(</span><span class="op" id="3732257">[</span><span class="op" id="3732258">]</span><span class="builtintype" id="3732259">byte</span><span class="op" id="3732263">,</span>&nbsp;<span class="ident" id="3732265">b</span><span class="op" id="3732266">.</span><span class="ident" id="3732267">BlockSize</span><span class="op" id="3732276">(</span><span class="op" id="3732277">)</span><span class="op" id="3732278">)</span><span class="op" id="3732279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3732282">}</span><br>
<span class="lineno"></span><span class="op" id="3732284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3732287">type</span>&nbsp;<span class="ident" id="3732292">cbcEncrypter</span>&nbsp;<span class="ident" id="3732305">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3732310">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3732389">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3732462">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3732485">func</span>&nbsp;<span class="ident" id="3732490">NewCBCEncrypter</span><span class="op" id="3732505">(</span><span class="ident" id="3732506">b</span>&nbsp;<span class="ident" id="3732508">Block</span><span class="op" id="3732513">,</span>&nbsp;<span class="ident" id="3732515">iv</span>&nbsp;<span class="op" id="3732518">[</span><span class="op" id="3732519">]</span><span class="builtintype" id="3732520">byte</span><span class="op" id="3732524">)</span>&nbsp;<span class="ident" id="3732526">BlockMode</span>&nbsp;<span class="op" id="3732536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3732539">if</span>&nbsp;<span class="builtinfunc" id="3732542">len</span><span class="op" id="3732545">(</span><span class="ident" id="3732546">iv</span><span class="op" id="3732548">)</span>&nbsp;<span class="op" id="3732550">!=</span>&nbsp;<span class="ident" id="3732553">b</span><span class="op" id="3732554">.</span><span class="ident" id="3732555">BlockSize</span><span class="op" id="3732564">(</span><span class="op" id="3732565">)</span>&nbsp;<span class="op" id="3732567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3732571">panic</span><span class="op" id="3732576">(</span><span class="string" id="3732577">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3732634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3732637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3732640">return</span>&nbsp;<span class="op" id="3732647">(</span><span class="op" id="3732648">*</span><span class="ident" id="3732649">cbcEncrypter</span><span class="op" id="3732661">)</span><span class="op" id="3732662">(</span><span class="ident" id="3732663">newCBC</span><span class="op" id="3732669">(</span><span class="ident" id="3732670">b</span><span class="op" id="3732671">,</span>&nbsp;<span class="ident" id="3732673">iv</span><span class="op" id="3732675">)</span><span class="op" id="3732676">)</span><br>
<span class="lineno">40</span><span class="op" id="3732678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3732681">func</span>&nbsp;<span class="op" id="3732686">(</span><span class="ident" id="3732687">x</span>&nbsp;<span class="op" id="3732689">*</span><span class="ident" id="3732690">cbcEncrypter</span><span class="op" id="3732702">)</span>&nbsp;<span class="ident" id="3732704">BlockSize</span><span class="op" id="3732713">(</span><span class="op" id="3732714">)</span>&nbsp;<span class="builtintype" id="3732716">int</span>&nbsp;<span class="op" id="3732720">{</span>&nbsp;<span class="keyword" id="3732722">return</span>&nbsp;<span class="ident" id="3732729">x</span><span class="op" id="3732730">.</span><span class="ident" id="3732731">blockSize</span>&nbsp;<span class="op" id="3732741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3732744">func</span>&nbsp;<span class="op" id="3732749">(</span><span class="ident" id="3732750">x</span>&nbsp;<span class="op" id="3732752">*</span><span class="ident" id="3732753">cbcEncrypter</span><span class="op" id="3732765">)</span>&nbsp;<span class="ident" id="3732767">CryptBlocks</span><span class="op" id="3732778">(</span><span class="ident" id="3732779">dst</span><span class="op" id="3732782">,</span>&nbsp;<span class="ident" id="3732784">src</span>&nbsp;<span class="op" id="3732788">[</span><span class="op" id="3732789">]</span><span class="builtintype" id="3732790">byte</span><span class="op" id="3732794">)</span>&nbsp;<span class="op" id="3732796">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3732799">if</span>&nbsp;<span class="builtinfunc" id="3732802">len</span><span class="op" id="3732805">(</span><span class="ident" id="3732806">src</span><span class="op" id="3732809">)</span><span class="op" id="3732810">%</span><span class="ident" id="3732811">x</span><span class="op" id="3732812">.</span><span class="ident" id="3732813">blockSize</span>&nbsp;<span class="op" id="3732823">!=</span>&nbsp;<span class="num" id="3732826">0</span>&nbsp;<span class="op" id="3732828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3732832">panic</span><span class="op" id="3732837">(</span><span class="string" id="3732838">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3732876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3732879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3732882">if</span>&nbsp;<span class="builtinfunc" id="3732885">len</span><span class="op" id="3732888">(</span><span class="ident" id="3732889">dst</span><span class="op" id="3732892">)</span>&nbsp;<span class="op" id="3732894">&lt;</span>&nbsp;<span class="builtinfunc" id="3732896">len</span><span class="op" id="3732899">(</span><span class="ident" id="3732900">src</span><span class="op" id="3732903">)</span>&nbsp;<span class="op" id="3732905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3732909">panic</span><span class="op" id="3732914">(</span><span class="string" id="3732915">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3732957">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3732960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3732964">iv</span>&nbsp;<span class="op" id="3732967">:=</span>&nbsp;<span class="ident" id="3732970">x</span><span class="op" id="3732971">.</span><span class="ident" id="3732972">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3732977">for</span>&nbsp;<span class="builtinfunc" id="3732981">len</span><span class="op" id="3732984">(</span><span class="ident" id="3732985">src</span><span class="op" id="3732988">)</span>&nbsp;<span class="op" id="3732990">&gt;</span>&nbsp;<span class="num" id="3732992">0</span>&nbsp;<span class="op" id="3732994">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3732998">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733048">xorBytes</span><span class="op" id="3733056">(</span><span class="ident" id="3733057">dst</span><span class="op" id="3733060">[</span><span class="op" id="3733061">:</span><span class="ident" id="3733062">x</span><span class="op" id="3733063">.</span><span class="ident" id="3733064">blockSize</span><span class="op" id="3733073">]</span><span class="op" id="3733074">,</span>&nbsp;<span class="ident" id="3733076">src</span><span class="op" id="3733079">[</span><span class="op" id="3733080">:</span><span class="ident" id="3733081">x</span><span class="op" id="3733082">.</span><span class="ident" id="3733083">blockSize</span><span class="op" id="3733092">]</span><span class="op" id="3733093">,</span>&nbsp;<span class="ident" id="3733095">iv</span><span class="op" id="3733097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733101">x</span><span class="op" id="3733102">.</span><span class="ident" id="3733103">b</span><span class="op" id="3733104">.</span><span class="ident" id="3733105">Encrypt</span><span class="op" id="3733112">(</span><span class="ident" id="3733113">dst</span><span class="op" id="3733116">[</span><span class="op" id="3733117">:</span><span class="ident" id="3733118">x</span><span class="op" id="3733119">.</span><span class="ident" id="3733120">blockSize</span><span class="op" id="3733129">]</span><span class="op" id="3733130">,</span>&nbsp;<span class="ident" id="3733132">dst</span><span class="op" id="3733135">[</span><span class="op" id="3733136">:</span><span class="ident" id="3733137">x</span><span class="op" id="3733138">.</span><span class="ident" id="3733139">blockSize</span><span class="op" id="3733148">]</span><span class="op" id="3733149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3733154">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733214">iv</span>&nbsp;<span class="op" id="3733217">=</span>&nbsp;<span class="ident" id="3733219">dst</span><span class="op" id="3733222">[</span><span class="op" id="3733223">:</span><span class="ident" id="3733224">x</span><span class="op" id="3733225">.</span><span class="ident" id="3733226">blockSize</span><span class="op" id="3733235">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733239">src</span>&nbsp;<span class="op" id="3733243">=</span>&nbsp;<span class="ident" id="3733245">src</span><span class="op" id="3733248">[</span><span class="ident" id="3733249">x</span><span class="op" id="3733250">.</span><span class="ident" id="3733251">blockSize</span><span class="op" id="3733260">:</span><span class="op" id="3733261">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733265">dst</span>&nbsp;<span class="op" id="3733269">=</span>&nbsp;<span class="ident" id="3733271">dst</span><span class="op" id="3733274">[</span><span class="ident" id="3733275">x</span><span class="op" id="3733276">.</span><span class="ident" id="3733277">blockSize</span><span class="op" id="3733286">:</span><span class="op" id="3733287">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3733290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3733294">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3733341">copy</span><span class="op" id="3733345">(</span><span class="ident" id="3733346">x</span><span class="op" id="3733347">.</span><span class="ident" id="3733348">iv</span><span class="op" id="3733350">,</span>&nbsp;<span class="ident" id="3733352">iv</span><span class="op" id="3733354">)</span><br>
<span class="lineno"></span><span class="op" id="3733356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733359">func</span>&nbsp;<span class="op" id="3733364">(</span><span class="ident" id="3733365">x</span>&nbsp;<span class="op" id="3733367">*</span><span class="ident" id="3733368">cbcEncrypter</span><span class="op" id="3733380">)</span>&nbsp;<span class="ident" id="3733382">SetIV</span><span class="op" id="3733387">(</span><span class="ident" id="3733388">iv</span>&nbsp;<span class="op" id="3733391">[</span><span class="op" id="3733392">]</span><span class="builtintype" id="3733393">byte</span><span class="op" id="3733397">)</span>&nbsp;<span class="op" id="3733399">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3733402">if</span>&nbsp;<span class="builtinfunc" id="3733405">len</span><span class="op" id="3733408">(</span><span class="ident" id="3733409">iv</span><span class="op" id="3733411">)</span>&nbsp;<span class="op" id="3733413">!=</span>&nbsp;<span class="builtinfunc" id="3733416">len</span><span class="op" id="3733419">(</span><span class="ident" id="3733420">x</span><span class="op" id="3733421">.</span><span class="ident" id="3733422">iv</span><span class="op" id="3733424">)</span>&nbsp;<span class="op" id="3733426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3733430">panic</span><span class="op" id="3733435">(</span><span class="string" id="3733436">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3733465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3733468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3733471">copy</span><span class="op" id="3733475">(</span><span class="ident" id="3733476">x</span><span class="op" id="3733477">.</span><span class="ident" id="3733478">iv</span><span class="op" id="3733480">,</span>&nbsp;<span class="ident" id="3733482">iv</span><span class="op" id="3733484">)</span><br>
<span class="lineno"></span><span class="op" id="3733486">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3733489">type</span>&nbsp;<span class="ident" id="3733494">cbcDecrypter</span>&nbsp;<span class="ident" id="3733507">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3733512">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3733591">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3733664">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3733734">func</span>&nbsp;<span class="ident" id="3733739">NewCBCDecrypter</span><span class="op" id="3733754">(</span><span class="ident" id="3733755">b</span>&nbsp;<span class="ident" id="3733757">Block</span><span class="op" id="3733762">,</span>&nbsp;<span class="ident" id="3733764">iv</span>&nbsp;<span class="op" id="3733767">[</span><span class="op" id="3733768">]</span><span class="builtintype" id="3733769">byte</span><span class="op" id="3733773">)</span>&nbsp;<span class="ident" id="3733775">BlockMode</span>&nbsp;<span class="op" id="3733785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3733788">if</span>&nbsp;<span class="builtinfunc" id="3733791">len</span><span class="op" id="3733794">(</span><span class="ident" id="3733795">iv</span><span class="op" id="3733797">)</span>&nbsp;<span class="op" id="3733799">!=</span>&nbsp;<span class="ident" id="3733802">b</span><span class="op" id="3733803">.</span><span class="ident" id="3733804">BlockSize</span><span class="op" id="3733813">(</span><span class="op" id="3733814">)</span>&nbsp;<span class="op" id="3733816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3733820">panic</span><span class="op" id="3733825">(</span><span class="string" id="3733826">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3733883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3733886">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3733889">return</span>&nbsp;<span class="op" id="3733896">(</span><span class="op" id="3733897">*</span><span class="ident" id="3733898">cbcDecrypter</span><span class="op" id="3733910">)</span><span class="op" id="3733911">(</span><span class="ident" id="3733912">newCBC</span><span class="op" id="3733918">(</span><span class="ident" id="3733919">b</span><span class="op" id="3733920">,</span>&nbsp;<span class="ident" id="3733922">iv</span><span class="op" id="3733924">)</span><span class="op" id="3733925">)</span><br>
<span class="lineno"></span><span class="op" id="3733927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733930">func</span>&nbsp;<span class="op" id="3733935">(</span><span class="ident" id="3733936">x</span>&nbsp;<span class="op" id="3733938">*</span><span class="ident" id="3733939">cbcDecrypter</span><span class="op" id="3733951">)</span>&nbsp;<span class="ident" id="3733953">BlockSize</span><span class="op" id="3733962">(</span><span class="op" id="3733963">)</span>&nbsp;<span class="builtintype" id="3733965">int</span>&nbsp;<span class="op" id="3733969">{</span>&nbsp;<span class="keyword" id="3733971">return</span>&nbsp;<span class="ident" id="3733978">x</span><span class="op" id="3733979">.</span><span class="ident" id="3733980">blockSize</span>&nbsp;<span class="op" id="3733990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3733993">func</span>&nbsp;<span class="op" id="3733998">(</span><span class="ident" id="3733999">x</span>&nbsp;<span class="op" id="3734001">*</span><span class="ident" id="3734002">cbcDecrypter</span><span class="op" id="3734014">)</span>&nbsp;<span class="ident" id="3734016">CryptBlocks</span><span class="op" id="3734027">(</span><span class="ident" id="3734028">dst</span><span class="op" id="3734031">,</span>&nbsp;<span class="ident" id="3734033">src</span>&nbsp;<span class="op" id="3734037">[</span><span class="op" id="3734038">]</span><span class="builtintype" id="3734039">byte</span><span class="op" id="3734043">)</span>&nbsp;<span class="op" id="3734045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734048">if</span>&nbsp;<span class="builtinfunc" id="3734051">len</span><span class="op" id="3734054">(</span><span class="ident" id="3734055">src</span><span class="op" id="3734058">)</span><span class="op" id="3734059">%</span><span class="ident" id="3734060">x</span><span class="op" id="3734061">.</span><span class="ident" id="3734062">blockSize</span>&nbsp;<span class="op" id="3734072">!=</span>&nbsp;<span class="num" id="3734075">0</span>&nbsp;<span class="op" id="3734077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3734081">panic</span><span class="op" id="3734086">(</span><span class="string" id="3734087">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3734125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3734128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734131">if</span>&nbsp;<span class="builtinfunc" id="3734134">len</span><span class="op" id="3734137">(</span><span class="ident" id="3734138">dst</span><span class="op" id="3734141">)</span>&nbsp;<span class="op" id="3734143">&lt;</span>&nbsp;<span class="builtinfunc" id="3734145">len</span><span class="op" id="3734148">(</span><span class="ident" id="3734149">src</span><span class="op" id="3734152">)</span>&nbsp;<span class="op" id="3734154">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3734158">panic</span><span class="op" id="3734163">(</span><span class="string" id="3734164">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3734206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3734209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734212">if</span>&nbsp;<span class="builtinfunc" id="3734215">len</span><span class="op" id="3734218">(</span><span class="ident" id="3734219">src</span><span class="op" id="3734222">)</span>&nbsp;<span class="op" id="3734224">==</span>&nbsp;<span class="num" id="3734227">0</span>&nbsp;<span class="op" id="3734229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734233">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3734241">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734245">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734346">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734419">end</span>&nbsp;<span class="op" id="3734423">:=</span>&nbsp;<span class="builtinfunc" id="3734426">len</span><span class="op" id="3734429">(</span><span class="ident" id="3734430">src</span><span class="op" id="3734433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734436">start</span>&nbsp;<span class="op" id="3734442">:=</span>&nbsp;<span class="ident" id="3734445">end</span>&nbsp;<span class="op" id="3734449">-</span>&nbsp;<span class="ident" id="3734451">x</span><span class="op" id="3734452">.</span><span class="ident" id="3734453">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734464">prev</span>&nbsp;<span class="op" id="3734469">:=</span>&nbsp;<span class="ident" id="3734472">start</span>&nbsp;<span class="op" id="3734478">-</span>&nbsp;<span class="ident" id="3734480">x</span><span class="op" id="3734481">.</span><span class="ident" id="3734482">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734494">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3734562">copy</span><span class="op" id="3734566">(</span><span class="ident" id="3734567">x</span><span class="op" id="3734568">.</span><span class="ident" id="3734569">tmp</span><span class="op" id="3734572">,</span>&nbsp;<span class="ident" id="3734574">src</span><span class="op" id="3734577">[</span><span class="ident" id="3734578">start</span><span class="op" id="3734583">:</span><span class="ident" id="3734584">end</span><span class="op" id="3734587">]</span><span class="op" id="3734588">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734592">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734631">for</span>&nbsp;<span class="ident" id="3734635">start</span>&nbsp;<span class="op" id="3734641">&gt;</span>&nbsp;<span class="num" id="3734643">0</span>&nbsp;<span class="op" id="3734645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734649">x</span><span class="op" id="3734650">.</span><span class="ident" id="3734651">b</span><span class="op" id="3734652">.</span><span class="ident" id="3734653">Decrypt</span><span class="op" id="3734660">(</span><span class="ident" id="3734661">dst</span><span class="op" id="3734664">[</span><span class="ident" id="3734665">start</span><span class="op" id="3734670">:</span><span class="ident" id="3734671">end</span><span class="op" id="3734674">]</span><span class="op" id="3734675">,</span>&nbsp;<span class="ident" id="3734677">src</span><span class="op" id="3734680">[</span><span class="ident" id="3734681">start</span><span class="op" id="3734686">:</span><span class="ident" id="3734687">end</span><span class="op" id="3734690">]</span><span class="op" id="3734691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734695">xorBytes</span><span class="op" id="3734703">(</span><span class="ident" id="3734704">dst</span><span class="op" id="3734707">[</span><span class="ident" id="3734708">start</span><span class="op" id="3734713">:</span><span class="ident" id="3734714">end</span><span class="op" id="3734717">]</span><span class="op" id="3734718">,</span>&nbsp;<span class="ident" id="3734720">dst</span><span class="op" id="3734723">[</span><span class="ident" id="3734724">start</span><span class="op" id="3734729">:</span><span class="ident" id="3734730">end</span><span class="op" id="3734733">]</span><span class="op" id="3734734">,</span>&nbsp;<span class="ident" id="3734736">src</span><span class="op" id="3734739">[</span><span class="ident" id="3734740">prev</span><span class="op" id="3734744">:</span><span class="ident" id="3734745">start</span><span class="op" id="3734750">]</span><span class="op" id="3734751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734756">end</span>&nbsp;<span class="op" id="3734760">=</span>&nbsp;<span class="ident" id="3734762">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734770">start</span>&nbsp;<span class="op" id="3734776">=</span>&nbsp;<span class="ident" id="3734778">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734785">prev</span>&nbsp;<span class="op" id="3734790">-=</span>&nbsp;<span class="ident" id="3734793">x</span><span class="op" id="3734794">.</span><span class="ident" id="3734795">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3734806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734810">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734871">x</span><span class="op" id="3734872">.</span><span class="ident" id="3734873">b</span><span class="op" id="3734874">.</span><span class="ident" id="3734875">Decrypt</span><span class="op" id="3734882">(</span><span class="ident" id="3734883">dst</span><span class="op" id="3734886">[</span><span class="ident" id="3734887">start</span><span class="op" id="3734892">:</span><span class="ident" id="3734893">end</span><span class="op" id="3734896">]</span><span class="op" id="3734897">,</span>&nbsp;<span class="ident" id="3734899">src</span><span class="op" id="3734902">[</span><span class="ident" id="3734903">start</span><span class="op" id="3734908">:</span><span class="ident" id="3734909">end</span><span class="op" id="3734912">]</span><span class="op" id="3734913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734916">xorBytes</span><span class="op" id="3734924">(</span><span class="ident" id="3734925">dst</span><span class="op" id="3734928">[</span><span class="ident" id="3734929">start</span><span class="op" id="3734934">:</span><span class="ident" id="3734935">end</span><span class="op" id="3734938">]</span><span class="op" id="3734939">,</span>&nbsp;<span class="ident" id="3734941">dst</span><span class="op" id="3734944">[</span><span class="ident" id="3734945">start</span><span class="op" id="3734950">:</span><span class="ident" id="3734951">end</span><span class="op" id="3734954">]</span><span class="op" id="3734955">,</span>&nbsp;<span class="ident" id="3734957">x</span><span class="op" id="3734958">.</span><span class="ident" id="3734959">iv</span><span class="op" id="3734961">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734965">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3735022">x</span><span class="op" id="3735023">.</span><span class="ident" id="3735024">iv</span><span class="op" id="3735026">,</span>&nbsp;<span class="ident" id="3735028">x</span><span class="op" id="3735029">.</span><span class="ident" id="3735030">tmp</span>&nbsp;<span class="op" id="3735034">=</span>&nbsp;<span class="ident" id="3735036">x</span><span class="op" id="3735037">.</span><span class="ident" id="3735038">tmp</span><span class="op" id="3735041">,</span>&nbsp;<span class="ident" id="3735043">x</span><span class="op" id="3735044">.</span><span class="ident" id="3735045">iv</span><br>
<span class="lineno"></span><span class="op" id="3735048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3735051">func</span>&nbsp;<span class="op" id="3735056">(</span><span class="ident" id="3735057">x</span>&nbsp;<span class="op" id="3735059">*</span><span class="ident" id="3735060">cbcDecrypter</span><span class="op" id="3735072">)</span>&nbsp;<span class="ident" id="3735074">SetIV</span><span class="op" id="3735079">(</span><span class="ident" id="3735080">iv</span>&nbsp;<span class="op" id="3735083">[</span><span class="op" id="3735084">]</span><span class="builtintype" id="3735085">byte</span><span class="op" id="3735089">)</span>&nbsp;<span class="op" id="3735091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735094">if</span>&nbsp;<span class="builtinfunc" id="3735097">len</span><span class="op" id="3735100">(</span><span class="ident" id="3735101">iv</span><span class="op" id="3735103">)</span>&nbsp;<span class="op" id="3735105">!=</span>&nbsp;<span class="builtinfunc" id="3735108">len</span><span class="op" id="3735111">(</span><span class="ident" id="3735112">x</span><span class="op" id="3735113">.</span><span class="ident" id="3735114">iv</span><span class="op" id="3735116">)</span>&nbsp;<span class="op" id="3735118">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3735122">panic</span><span class="op" id="3735127">(</span><span class="string" id="3735128">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3735157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3735163">copy</span><span class="op" id="3735167">(</span><span class="ident" id="3735168">x</span><span class="op" id="3735169">.</span><span class="ident" id="3735170">iv</span><span class="op" id="3735172">,</span>&nbsp;<span class="ident" id="3735174">iv</span><span class="op" id="3735176">)</span><br>
<span class="lineno"></span><span class="op" id="3735178">}</span>
</div>
</body>
</html>
