<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html" class="current">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1678177">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1678233">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1678287">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1678338">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1678356">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1678407">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1678454">//</span><br>
<span class="lineno"></span><span class="comment" id="1678457">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1678523">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1678594">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1678663">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1678702">//</span><br>
<span class="lineno"></span><span class="comment" id="1678705">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1678779">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1678851">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1678920">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1678992">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1679059">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1679135">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1679207">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1679281">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1679359">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1679437">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1679517">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1679588">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1679666">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1679739">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1679761">//</span><br>
<span class="lineno">30</span><span class="comment" id="1679764">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1679836">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1679917">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1679994">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1680064">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1680137">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1680213">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1680287">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1680368">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1680452">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1680534">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1680573">//</span><br>
<span class="lineno"></span><span class="comment" id="1680576">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1680637">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1680715">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1680781">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1680854">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1680928">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1681001">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1681077">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1681142">package</span>&nbsp;<span class="ident" id="1681150">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1681159">import</span>&nbsp;<span class="string" id="1681166">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1681176">const</span>&nbsp;<span class="op" id="1681182">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681185">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681201">=</span>&nbsp;<span class="num" id="1681203">1</span>&nbsp;<span class="op" id="1681205">&lt;&lt;</span>&nbsp;<span class="num" id="1681208">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681212">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681228">=</span>&nbsp;<span class="num" id="1681230">1</span>&nbsp;<span class="op" id="1681232">&lt;&lt;</span>&nbsp;<span class="num" id="1681235">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681239">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681255">=</span>&nbsp;<span class="num" id="1681257">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681260">maxCPUProfStack</span>&nbsp;<span class="op" id="1681276">=</span>&nbsp;<span class="num" id="1681278">64</span><br>
<span class="lineno">60</span><span class="op" id="1681281">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1681284">type</span>&nbsp;<span class="ident" id="1681289">cpuprofEntry</span>&nbsp;<span class="keyword" id="1681302">struct</span>&nbsp;<span class="op" id="1681309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681312">count</span>&nbsp;<span class="builtintype" id="1681318">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681327">depth</span>&nbsp;<span class="builtintype" id="1681333">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681342">stack</span>&nbsp;<span class="op" id="1681348">[</span><span class="ident" id="1681349">maxCPUProfStack</span><span class="op" id="1681364">]</span><span class="builtintype" id="1681365">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1681373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1681376">type</span>&nbsp;<span class="ident" id="1681381">cpuProfile</span>&nbsp;<span class="keyword" id="1681392">struct</span>&nbsp;<span class="op" id="1681399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681402">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1681409">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681417">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681437">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1681444">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681452">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681477">count</span>&nbsp;&nbsp;<span class="builtintype" id="1681484">uintptr</span>&nbsp;<span class="comment" id="1681492">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681507">evicts</span>&nbsp;<span class="builtintype" id="1681514">uintptr</span>&nbsp;<span class="comment" id="1681522">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681541">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1681548">uintptr</span>&nbsp;<span class="comment" id="1681556">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681595">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681627">hash</span>&nbsp;<span class="op" id="1681632">[</span><span class="ident" id="1681633">numBuckets</span><span class="op" id="1681643">]</span><span class="keyword" id="1681644">struct</span>&nbsp;<span class="op" id="1681651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681655">entry</span>&nbsp;<span class="op" id="1681661">[</span><span class="ident" id="1681662">assoc</span><span class="op" id="1681667">]</span><span class="ident" id="1681668">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681686">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681723">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681773">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681823">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681831">[</span><span class="num" id="1681832">2</span><span class="op" id="1681833">]</span><span class="op" id="1681834">[</span><span class="ident" id="1681835">logSize</span>&nbsp;<span class="op" id="1681843">/</span>&nbsp;<span class="num" id="1681845">2</span><span class="op" id="1681846">]</span><span class="builtintype" id="1681847">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681856">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1681864">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681873">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1681881">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681888">handoff</span>&nbsp;<span class="builtintype" id="1681896">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681905">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681923">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681974">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682014">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1682023">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682031">wholding</span>&nbsp;<span class="builtintype" id="1682040">bool</span>&nbsp;<span class="comment" id="1682045">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682086">flushing</span>&nbsp;<span class="builtintype" id="1682095">bool</span>&nbsp;<span class="comment" id="1682100">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682142">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1682151">bool</span>&nbsp;<span class="comment" id="1682156">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1682204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1682207">var</span>&nbsp;<span class="op" id="1682211">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682214">cpuprofLock</span>&nbsp;<span class="ident" id="1682226">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682233">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682245">*</span><span class="ident" id="1682246">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682259">eod</span>&nbsp;<span class="op" id="1682263">=</span>&nbsp;<span class="op" id="1682265">[</span><span class="num" id="1682266">3</span><span class="op" id="1682267">]</span><span class="builtintype" id="1682268">uintptr</span><span class="op" id="1682275">{</span><span class="num" id="1682276">0</span><span class="op" id="1682277">,</span>&nbsp;<span class="num" id="1682279">1</span><span class="op" id="1682280">,</span>&nbsp;<span class="num" id="1682282">0</span><span class="op" id="1682283">}</span><br>
<span class="lineno"></span><span class="op" id="1682285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1682288">func</span>&nbsp;<span class="ident" id="1682293">setcpuprofilerate_m</span><span class="op" id="1682312">(</span><span class="op" id="1682313">)</span>&nbsp;<span class="comment" id="1682315">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1682326">func</span>&nbsp;<span class="ident" id="1682331">setcpuprofilerate</span><span class="op" id="1682348">(</span><span class="ident" id="1682349">hz</span>&nbsp;<span class="builtintype" id="1682352">int32</span><span class="op" id="1682357">)</span>&nbsp;<span class="op" id="1682359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682362">g</span>&nbsp;<span class="op" id="1682364">:=</span>&nbsp;<span class="ident" id="1682367">getg</span><span class="op" id="1682371">(</span><span class="op" id="1682372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682375">g</span><span class="op" id="1682376">.</span><span class="ident" id="1682377">m</span><span class="op" id="1682378">.</span><span class="ident" id="1682379">scalararg</span><span class="op" id="1682388">[</span><span class="num" id="1682389">0</span><span class="op" id="1682390">]</span>&nbsp;<span class="op" id="1682392">=</span>&nbsp;<span class="builtintype" id="1682394">uintptr</span><span class="op" id="1682401">(</span><span class="ident" id="1682402">hz</span><span class="op" id="1682404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682407">onM</span><span class="op" id="1682410">(</span><span class="ident" id="1682411">setcpuprofilerate_m</span><span class="op" id="1682430">)</span><br>
<span class="lineno">110</span><span class="op" id="1682432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1682435">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1682491">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1682549">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1682588">func</span>&nbsp;<span class="ident" id="1682593">lostProfileData</span><span class="op" id="1682608">(</span><span class="op" id="1682609">)</span>&nbsp;<span class="op" id="1682611">{</span><span class="op" id="1682612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1682615">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1682690">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1682744">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1682827">//</span><br>
<span class="lineno"></span><span class="comment" id="1682830">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1682886">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1682952">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1682983">func</span>&nbsp;<span class="ident" id="1682988">SetCPUProfileRate</span><span class="op" id="1683005">(</span><span class="ident" id="1683006">hz</span>&nbsp;<span class="builtintype" id="1683009">int</span><span class="op" id="1683012">)</span>&nbsp;<span class="op" id="1683014">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683017">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683055">if</span>&nbsp;<span class="ident" id="1683058">hz</span>&nbsp;<span class="op" id="1683061">&lt;</span>&nbsp;<span class="num" id="1683063">0</span>&nbsp;<span class="op" id="1683065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683069">hz</span>&nbsp;<span class="op" id="1683072">=</span>&nbsp;<span class="num" id="1683074">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683080">if</span>&nbsp;<span class="ident" id="1683083">hz</span>&nbsp;<span class="op" id="1683086">&gt;</span>&nbsp;<span class="num" id="1683088">1000000</span>&nbsp;<span class="op" id="1683096">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683100">hz</span>&nbsp;<span class="op" id="1683103">=</span>&nbsp;<span class="num" id="1683105">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683118">lock</span><span class="op" id="1683122">(</span><span class="op" id="1683123">&amp;</span><span class="ident" id="1683124">cpuprofLock</span><span class="op" id="1683135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683138">if</span>&nbsp;<span class="ident" id="1683141">hz</span>&nbsp;<span class="op" id="1683144">&gt;</span>&nbsp;<span class="num" id="1683146">0</span>&nbsp;<span class="op" id="1683148">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683152">if</span>&nbsp;<span class="ident" id="1683155">cpuprof</span>&nbsp;<span class="op" id="1683163">==</span>&nbsp;<span class="ident" id="1683166">nil</span>&nbsp;<span class="op" id="1683170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683175">cpuprof</span>&nbsp;<span class="op" id="1683183">=</span>&nbsp;<span class="op" id="1683185">(</span><span class="op" id="1683186">*</span><span class="ident" id="1683187">cpuProfile</span><span class="op" id="1683197">)</span><span class="op" id="1683198">(</span><span class="ident" id="1683199">sysAlloc</span><span class="op" id="1683207">(</span><span class="ident" id="1683208">unsafe</span><span class="op" id="1683214">.</span><span class="ident" id="1683215">Sizeof</span><span class="op" id="1683221">(</span><span class="ident" id="1683222">cpuProfile</span><span class="op" id="1683232">{</span><span class="op" id="1683233">}</span><span class="op" id="1683234">)</span><span class="op" id="1683235">,</span>&nbsp;<span class="op" id="1683237">&amp;</span><span class="ident" id="1683238">memstats</span><span class="op" id="1683246">.</span><span class="ident" id="1683247">other_sys</span><span class="op" id="1683256">)</span><span class="op" id="1683257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683262">if</span>&nbsp;<span class="ident" id="1683265">cpuprof</span>&nbsp;<span class="op" id="1683273">==</span>&nbsp;<span class="ident" id="1683276">nil</span>&nbsp;<span class="op" id="1683280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1683286">print</span><span class="op" id="1683291">(</span><span class="string" id="1683292">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1683341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683347">unlock</span><span class="op" id="1683353">(</span><span class="op" id="1683354">&amp;</span><span class="ident" id="1683355">cpuprofLock</span><span class="op" id="1683366">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683372">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683390">if</span>&nbsp;<span class="ident" id="1683393">cpuprof</span><span class="op" id="1683400">.</span><span class="ident" id="1683401">on</span>&nbsp;<span class="op" id="1683404">||</span>&nbsp;<span class="ident" id="1683407">cpuprof</span><span class="op" id="1683414">.</span><span class="ident" id="1683415">handoff</span>&nbsp;<span class="op" id="1683423">!=</span>&nbsp;<span class="num" id="1683426">0</span>&nbsp;<span class="op" id="1683428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1683433">print</span><span class="op" id="1683438">(</span><span class="string" id="1683439">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1683516">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683521">unlock</span><span class="op" id="1683527">(</span><span class="op" id="1683528">&amp;</span><span class="ident" id="1683529">cpuprofLock</span><span class="op" id="1683540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683545">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683559">cpuprof</span><span class="op" id="1683566">.</span><span class="ident" id="1683567">on</span>&nbsp;<span class="op" id="1683570">=</span>&nbsp;<span class="builtintype" id="1683572">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683579">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683612">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683702">p</span>&nbsp;<span class="op" id="1683704">:=</span>&nbsp;<span class="op" id="1683707">&amp;</span><span class="ident" id="1683708">cpuprof</span><span class="op" id="1683715">.</span><span class="ident" id="1683716">log</span><span class="op" id="1683719">[</span><span class="num" id="1683720">0</span><span class="op" id="1683721">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683725">p</span><span class="op" id="1683726">[</span><span class="num" id="1683727">0</span><span class="op" id="1683728">]</span>&nbsp;<span class="op" id="1683730">=</span>&nbsp;<span class="num" id="1683732">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683750">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683772">p</span><span class="op" id="1683773">[</span><span class="num" id="1683774">1</span><span class="op" id="1683775">]</span>&nbsp;<span class="op" id="1683777">=</span>&nbsp;<span class="num" id="1683779">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683797">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683819">p</span><span class="op" id="1683820">[</span><span class="num" id="1683821">2</span><span class="op" id="1683822">]</span>&nbsp;<span class="op" id="1683824">=</span>&nbsp;<span class="num" id="1683826">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683844">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683864">p</span><span class="op" id="1683865">[</span><span class="num" id="1683866">3</span><span class="op" id="1683867">]</span>&nbsp;<span class="op" id="1683869">=</span>&nbsp;<span class="builtintype" id="1683871">uintptr</span><span class="op" id="1683878">(</span><span class="num" id="1683879">1e6</span>&nbsp;<span class="op" id="1683883">/</span>&nbsp;<span class="ident" id="1683885">hz</span><span class="op" id="1683887">)</span>&nbsp;<span class="comment" id="1683889">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683916">p</span><span class="op" id="1683917">[</span><span class="num" id="1683918">4</span><span class="op" id="1683919">]</span>&nbsp;<span class="op" id="1683921">=</span>&nbsp;<span class="num" id="1683923">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683927">cpuprof</span><span class="op" id="1683934">.</span><span class="ident" id="1683935">nlog</span>&nbsp;<span class="op" id="1683940">=</span>&nbsp;<span class="num" id="1683942">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683946">cpuprof</span><span class="op" id="1683953">.</span><span class="ident" id="1683954">toggle</span>&nbsp;<span class="op" id="1683961">=</span>&nbsp;<span class="num" id="1683963">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683967">cpuprof</span><span class="op" id="1683974">.</span><span class="ident" id="1683975">wholding</span>&nbsp;<span class="op" id="1683984">=</span>&nbsp;<span class="builtintype" id="1683986">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683994">cpuprof</span><span class="op" id="1684001">.</span><span class="ident" id="1684002">wtoggle</span>&nbsp;<span class="op" id="1684010">=</span>&nbsp;<span class="num" id="1684012">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684016">cpuprof</span><span class="op" id="1684023">.</span><span class="ident" id="1684024">flushing</span>&nbsp;<span class="op" id="1684033">=</span>&nbsp;<span class="builtintype" id="1684035">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684043">cpuprof</span><span class="op" id="1684050">.</span><span class="ident" id="1684051">eodSent</span>&nbsp;<span class="op" id="1684059">=</span>&nbsp;<span class="builtintype" id="1684061">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684069">noteclear</span><span class="op" id="1684078">(</span><span class="op" id="1684079">&amp;</span><span class="ident" id="1684080">cpuprof</span><span class="op" id="1684087">.</span><span class="ident" id="1684088">wait</span><span class="op" id="1684092">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684097">setcpuprofilerate</span><span class="op" id="1684114">(</span><span class="builtintype" id="1684115">int32</span><span class="op" id="1684120">(</span><span class="ident" id="1684121">hz</span><span class="op" id="1684123">)</span><span class="op" id="1684124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684127">}</span>&nbsp;<span class="keyword" id="1684129">else</span>&nbsp;<span class="keyword" id="1684134">if</span>&nbsp;<span class="ident" id="1684137">cpuprof</span>&nbsp;<span class="op" id="1684145">!=</span>&nbsp;<span class="ident" id="1684148">nil</span>&nbsp;<span class="op" id="1684152">&amp;&amp;</span>&nbsp;<span class="ident" id="1684155">cpuprof</span><span class="op" id="1684162">.</span><span class="ident" id="1684163">on</span>&nbsp;<span class="op" id="1684166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684170">setcpuprofilerate</span><span class="op" id="1684187">(</span><span class="num" id="1684188">0</span><span class="op" id="1684189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684193">cpuprof</span><span class="op" id="1684200">.</span><span class="ident" id="1684201">on</span>&nbsp;<span class="op" id="1684204">=</span>&nbsp;<span class="builtintype" id="1684206">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1684215">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1684288">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684347">for</span>&nbsp;<span class="op" id="1684351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684356">n</span>&nbsp;<span class="op" id="1684358">:=</span>&nbsp;<span class="ident" id="1684361">cpuprof</span><span class="op" id="1684368">.</span><span class="ident" id="1684369">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684380">if</span>&nbsp;<span class="ident" id="1684383">n</span><span class="op" id="1684384">&amp;</span><span class="num" id="1684385">0x80000000</span>&nbsp;<span class="op" id="1684396">!=</span>&nbsp;<span class="num" id="1684399">0</span>&nbsp;<span class="op" id="1684401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1684407">print</span><span class="op" id="1684412">(</span><span class="string" id="1684413">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1684450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684460">if</span>&nbsp;<span class="ident" id="1684463">cas</span><span class="op" id="1684466">(</span><span class="op" id="1684467">&amp;</span><span class="ident" id="1684468">cpuprof</span><span class="op" id="1684475">.</span><span class="ident" id="1684476">handoff</span><span class="op" id="1684483">,</span>&nbsp;<span class="ident" id="1684485">n</span><span class="op" id="1684486">,</span>&nbsp;<span class="ident" id="1684488">n</span><span class="op" id="1684489">|</span><span class="num" id="1684490">0x80000000</span><span class="op" id="1684500">)</span>&nbsp;<span class="op" id="1684502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684508">if</span>&nbsp;<span class="ident" id="1684511">n</span>&nbsp;<span class="op" id="1684513">==</span>&nbsp;<span class="num" id="1684516">0</span>&nbsp;<span class="op" id="1684518">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1684525">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684595">notewakeup</span><span class="op" id="1684605">(</span><span class="op" id="1684606">&amp;</span><span class="ident" id="1684607">cpuprof</span><span class="op" id="1684614">.</span><span class="ident" id="1684615">wait</span><span class="op" id="1684619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684631">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684640">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684650">unlock</span><span class="op" id="1684656">(</span><span class="op" id="1684657">&amp;</span><span class="ident" id="1684658">cpuprofLock</span><span class="op" id="1684669">)</span><br>
<span class="lineno"></span><span class="op" id="1684671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1684674">func</span>&nbsp;<span class="ident" id="1684679">cpuproftick</span><span class="op" id="1684690">(</span><span class="ident" id="1684691">pc</span>&nbsp;<span class="op" id="1684694">*</span><span class="builtintype" id="1684695">uintptr</span><span class="op" id="1684702">,</span>&nbsp;<span class="ident" id="1684704">n</span>&nbsp;<span class="builtintype" id="1684706">int32</span><span class="op" id="1684711">)</span>&nbsp;<span class="op" id="1684713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684716">if</span>&nbsp;<span class="ident" id="1684719">n</span>&nbsp;<span class="op" id="1684721">&gt;</span>&nbsp;<span class="ident" id="1684723">maxCPUProfStack</span>&nbsp;<span class="op" id="1684739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684743">n</span>&nbsp;<span class="op" id="1684745">=</span>&nbsp;<span class="ident" id="1684747">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684767">s</span>&nbsp;<span class="op" id="1684769">:=</span>&nbsp;<span class="op" id="1684772">(</span><span class="op" id="1684773">*</span><span class="op" id="1684774">[</span><span class="ident" id="1684775">maxCPUProfStack</span><span class="op" id="1684790">]</span><span class="builtintype" id="1684791">uintptr</span><span class="op" id="1684798">)</span><span class="op" id="1684799">(</span><span class="ident" id="1684800">unsafe</span><span class="op" id="1684806">.</span><span class="ident" id="1684807">Pointer</span><span class="op" id="1684814">(</span><span class="ident" id="1684815">pc</span><span class="op" id="1684817">)</span><span class="op" id="1684818">)</span><span class="op" id="1684819">[</span><span class="op" id="1684820">:</span><span class="ident" id="1684821">n</span><span class="op" id="1684822">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684825">cpuprof</span><span class="op" id="1684832">.</span><span class="ident" id="1684833">add</span><span class="op" id="1684836">(</span><span class="ident" id="1684837">s</span><span class="op" id="1684838">)</span><br>
<span class="lineno"></span><span class="op" id="1684840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1684843">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1684887">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1684955">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1685016">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1685086">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1685129">func</span>&nbsp;<span class="op" id="1685134">(</span><span class="ident" id="1685135">p</span>&nbsp;<span class="op" id="1685137">*</span><span class="ident" id="1685138">cpuProfile</span><span class="op" id="1685148">)</span>&nbsp;<span class="ident" id="1685150">add</span><span class="op" id="1685153">(</span><span class="ident" id="1685154">pc</span>&nbsp;<span class="op" id="1685157">[</span><span class="op" id="1685158">]</span><span class="builtintype" id="1685159">uintptr</span><span class="op" id="1685166">)</span>&nbsp;<span class="op" id="1685168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685171">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685189">h</span>&nbsp;<span class="op" id="1685191">:=</span>&nbsp;<span class="builtintype" id="1685194">uintptr</span><span class="op" id="1685201">(</span><span class="num" id="1685202">0</span><span class="op" id="1685203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685206">for</span>&nbsp;<span class="ident" id="1685210">_</span><span class="op" id="1685211">,</span>&nbsp;<span class="ident" id="1685213">x</span>&nbsp;<span class="op" id="1685215">:=</span>&nbsp;<span class="keyword" id="1685218">range</span>&nbsp;<span class="ident" id="1685224">pc</span>&nbsp;<span class="op" id="1685227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685231">h</span>&nbsp;<span class="op" id="1685233">=</span>&nbsp;<span class="ident" id="1685235">h</span><span class="op" id="1685236">&lt;&lt;</span><span class="num" id="1685238">8</span>&nbsp;<span class="op" id="1685240">|</span>&nbsp;<span class="op" id="1685242">(</span><span class="ident" id="1685243">h</span>&nbsp;<span class="op" id="1685245">&gt;&gt;</span>&nbsp;<span class="op" id="1685248">(</span><span class="num" id="1685249">8</span>&nbsp;<span class="op" id="1685251">*</span>&nbsp;<span class="op" id="1685253">(</span><span class="ident" id="1685254">unsafe</span><span class="op" id="1685260">.</span><span class="ident" id="1685261">Sizeof</span><span class="op" id="1685267">(</span><span class="ident" id="1685268">h</span><span class="op" id="1685269">)</span>&nbsp;<span class="op" id="1685271">-</span>&nbsp;<span class="num" id="1685273">1</span><span class="op" id="1685274">)</span><span class="op" id="1685275">)</span><span class="op" id="1685276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685280">h</span>&nbsp;<span class="op" id="1685282">+=</span>&nbsp;<span class="ident" id="1685285">x</span><span class="op" id="1685286">*</span><span class="num" id="1685287">31</span>&nbsp;<span class="op" id="1685290">+</span>&nbsp;<span class="ident" id="1685292">x</span><span class="op" id="1685293">*</span><span class="num" id="1685294">7</span>&nbsp;<span class="op" id="1685296">+</span>&nbsp;<span class="ident" id="1685298">x</span><span class="op" id="1685299">*</span><span class="num" id="1685300">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685303">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685306">p</span><span class="op" id="1685307">.</span><span class="ident" id="1685308">count</span><span class="op" id="1685313">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685318">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685370">b</span>&nbsp;<span class="op" id="1685372">:=</span>&nbsp;<span class="op" id="1685375">&amp;</span><span class="ident" id="1685376">p</span><span class="op" id="1685377">.</span><span class="ident" id="1685378">hash</span><span class="op" id="1685382">[</span><span class="ident" id="1685383">h</span><span class="op" id="1685384">%</span><span class="ident" id="1685385">numBuckets</span><span class="op" id="1685395">]</span><br>
<span class="lineno"></span><span class="ident" id="1685397">Assoc</span><span class="op" id="1685402">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685405">for</span>&nbsp;<span class="ident" id="1685409">i</span>&nbsp;<span class="op" id="1685411">:=</span>&nbsp;<span class="keyword" id="1685414">range</span>&nbsp;<span class="ident" id="1685420">b</span><span class="op" id="1685421">.</span><span class="ident" id="1685422">entry</span>&nbsp;<span class="op" id="1685428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685432">e</span>&nbsp;<span class="op" id="1685434">:=</span>&nbsp;<span class="op" id="1685437">&amp;</span><span class="ident" id="1685438">b</span><span class="op" id="1685439">.</span><span class="ident" id="1685440">entry</span><span class="op" id="1685445">[</span><span class="ident" id="1685446">i</span><span class="op" id="1685447">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685451">if</span>&nbsp;<span class="ident" id="1685454">e</span><span class="op" id="1685455">.</span><span class="ident" id="1685456">depth</span>&nbsp;<span class="op" id="1685462">!=</span>&nbsp;<span class="builtintype" id="1685465">uintptr</span><span class="op" id="1685472">(</span><span class="builtinfunc" id="1685473">len</span><span class="op" id="1685476">(</span><span class="ident" id="1685477">pc</span><span class="op" id="1685479">)</span><span class="op" id="1685480">)</span>&nbsp;<span class="op" id="1685482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685487">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685498">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685502">for</span>&nbsp;<span class="ident" id="1685506">j</span>&nbsp;<span class="op" id="1685508">:=</span>&nbsp;<span class="keyword" id="1685511">range</span>&nbsp;<span class="ident" id="1685517">pc</span>&nbsp;<span class="op" id="1685520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685525">if</span>&nbsp;<span class="ident" id="1685528">e</span><span class="op" id="1685529">.</span><span class="ident" id="1685530">stack</span><span class="op" id="1685535">[</span><span class="ident" id="1685536">j</span><span class="op" id="1685537">]</span>&nbsp;<span class="op" id="1685539">!=</span>&nbsp;<span class="ident" id="1685542">pc</span><span class="op" id="1685544">[</span><span class="ident" id="1685545">j</span><span class="op" id="1685546">]</span>&nbsp;<span class="op" id="1685548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685554">continue</span>&nbsp;<span class="ident" id="1685563">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685576">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685580">e</span><span class="op" id="1685581">.</span><span class="ident" id="1685582">count</span><span class="op" id="1685587">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685592">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685604">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685641">var</span>&nbsp;<span class="ident" id="1685645">e</span>&nbsp;<span class="op" id="1685647">*</span><span class="ident" id="1685648">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685662">for</span>&nbsp;<span class="ident" id="1685666">i</span>&nbsp;<span class="op" id="1685668">:=</span>&nbsp;<span class="keyword" id="1685671">range</span>&nbsp;<span class="ident" id="1685677">b</span><span class="op" id="1685678">.</span><span class="ident" id="1685679">entry</span>&nbsp;<span class="op" id="1685685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685689">if</span>&nbsp;<span class="ident" id="1685692">e</span>&nbsp;<span class="op" id="1685694">==</span>&nbsp;<span class="ident" id="1685697">nil</span>&nbsp;<span class="op" id="1685701">||</span>&nbsp;<span class="ident" id="1685704">b</span><span class="op" id="1685705">.</span><span class="ident" id="1685706">entry</span><span class="op" id="1685711">[</span><span class="ident" id="1685712">i</span><span class="op" id="1685713">]</span><span class="op" id="1685714">.</span><span class="ident" id="1685715">count</span>&nbsp;<span class="op" id="1685721">&lt;</span>&nbsp;<span class="ident" id="1685723">e</span><span class="op" id="1685724">.</span><span class="ident" id="1685725">count</span>&nbsp;<span class="op" id="1685731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685736">e</span>&nbsp;<span class="op" id="1685738">=</span>&nbsp;<span class="op" id="1685740">&amp;</span><span class="ident" id="1685741">b</span><span class="op" id="1685742">.</span><span class="ident" id="1685743">entry</span><span class="op" id="1685748">[</span><span class="ident" id="1685749">i</span><span class="op" id="1685750">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685754">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685760">if</span>&nbsp;<span class="ident" id="1685763">e</span><span class="op" id="1685764">.</span><span class="ident" id="1685765">count</span>&nbsp;<span class="op" id="1685771">&gt;</span>&nbsp;<span class="num" id="1685773">0</span>&nbsp;<span class="op" id="1685775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685779">if</span>&nbsp;<span class="op" id="1685782">!</span><span class="ident" id="1685783">p</span><span class="op" id="1685784">.</span><span class="ident" id="1685785">evict</span><span class="op" id="1685790">(</span><span class="ident" id="1685791">e</span><span class="op" id="1685792">)</span>&nbsp;<span class="op" id="1685794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685799">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685848">p</span><span class="op" id="1685849">.</span><span class="ident" id="1685850">lost</span><span class="op" id="1685854">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685860">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685873">p</span><span class="op" id="1685874">.</span><span class="ident" id="1685875">evicts</span><span class="op" id="1685881">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685889">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685924">e</span><span class="op" id="1685925">.</span><span class="ident" id="1685926">depth</span>&nbsp;<span class="op" id="1685932">=</span>&nbsp;<span class="builtintype" id="1685934">uintptr</span><span class="op" id="1685941">(</span><span class="builtinfunc" id="1685942">len</span><span class="op" id="1685945">(</span><span class="ident" id="1685946">pc</span><span class="op" id="1685948">)</span><span class="op" id="1685949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685952">e</span><span class="op" id="1685953">.</span><span class="ident" id="1685954">count</span>&nbsp;<span class="op" id="1685960">=</span>&nbsp;<span class="num" id="1685962">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1685965">copy</span><span class="op" id="1685969">(</span><span class="ident" id="1685970">e</span><span class="op" id="1685971">.</span><span class="ident" id="1685972">stack</span><span class="op" id="1685977">[</span><span class="op" id="1685978">:</span><span class="op" id="1685979">]</span><span class="op" id="1685980">,</span>&nbsp;<span class="ident" id="1685982">pc</span><span class="op" id="1685984">)</span><br>
<span class="lineno"></span><span class="op" id="1685986">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1685989">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1686050">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1686111">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1686174">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1686233">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1686291">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1686332">func</span>&nbsp;<span class="op" id="1686337">(</span><span class="ident" id="1686338">p</span>&nbsp;<span class="op" id="1686340">*</span><span class="ident" id="1686341">cpuProfile</span><span class="op" id="1686351">)</span>&nbsp;<span class="ident" id="1686353">evict</span><span class="op" id="1686358">(</span><span class="ident" id="1686359">e</span>&nbsp;<span class="op" id="1686361">*</span><span class="ident" id="1686362">cpuprofEntry</span><span class="op" id="1686374">)</span>&nbsp;<span class="builtintype" id="1686376">bool</span>&nbsp;<span class="op" id="1686381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686384">d</span>&nbsp;<span class="op" id="1686386">:=</span>&nbsp;<span class="ident" id="1686389">e</span><span class="op" id="1686390">.</span><span class="ident" id="1686391">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686398">nslot</span>&nbsp;<span class="op" id="1686404">:=</span>&nbsp;<span class="ident" id="1686407">d</span>&nbsp;<span class="op" id="1686409">+</span>&nbsp;<span class="num" id="1686411">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686414">log</span>&nbsp;<span class="op" id="1686418">:=</span>&nbsp;<span class="op" id="1686421">&amp;</span><span class="ident" id="1686422">p</span><span class="op" id="1686423">.</span><span class="ident" id="1686424">log</span><span class="op" id="1686427">[</span><span class="ident" id="1686428">p</span><span class="op" id="1686429">.</span><span class="ident" id="1686430">toggle</span><span class="op" id="1686436">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686439">if</span>&nbsp;<span class="ident" id="1686442">p</span><span class="op" id="1686443">.</span><span class="ident" id="1686444">nlog</span><span class="op" id="1686448">+</span><span class="ident" id="1686449">nslot</span>&nbsp;<span class="op" id="1686455">&gt;</span>&nbsp;<span class="builtintype" id="1686457">uintptr</span><span class="op" id="1686464">(</span><span class="builtinfunc" id="1686465">len</span><span class="op" id="1686468">(</span><span class="ident" id="1686469">p</span><span class="op" id="1686470">.</span><span class="ident" id="1686471">log</span><span class="op" id="1686474">[</span><span class="num" id="1686475">0</span><span class="op" id="1686476">]</span><span class="op" id="1686477">)</span><span class="op" id="1686478">)</span>&nbsp;<span class="op" id="1686480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686484">if</span>&nbsp;<span class="op" id="1686487">!</span><span class="ident" id="1686488">p</span><span class="op" id="1686489">.</span><span class="ident" id="1686490">flushlog</span><span class="op" id="1686498">(</span><span class="op" id="1686499">)</span>&nbsp;<span class="op" id="1686501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686506">return</span>&nbsp;<span class="builtintype" id="1686513">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686521">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686525">log</span>&nbsp;<span class="op" id="1686529">=</span>&nbsp;<span class="op" id="1686531">&amp;</span><span class="ident" id="1686532">p</span><span class="op" id="1686533">.</span><span class="ident" id="1686534">log</span><span class="op" id="1686537">[</span><span class="ident" id="1686538">p</span><span class="op" id="1686539">.</span><span class="ident" id="1686540">toggle</span><span class="op" id="1686546">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686553">q</span>&nbsp;<span class="op" id="1686555">:=</span>&nbsp;<span class="ident" id="1686558">p</span><span class="op" id="1686559">.</span><span class="ident" id="1686560">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686566">log</span><span class="op" id="1686569">[</span><span class="ident" id="1686570">q</span><span class="op" id="1686571">]</span>&nbsp;<span class="op" id="1686573">=</span>&nbsp;<span class="ident" id="1686575">e</span><span class="op" id="1686576">.</span><span class="ident" id="1686577">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686584">q</span><span class="op" id="1686585">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686589">log</span><span class="op" id="1686592">[</span><span class="ident" id="1686593">q</span><span class="op" id="1686594">]</span>&nbsp;<span class="op" id="1686596">=</span>&nbsp;<span class="ident" id="1686598">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686601">q</span><span class="op" id="1686602">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1686606">copy</span><span class="op" id="1686610">(</span><span class="ident" id="1686611">log</span><span class="op" id="1686614">[</span><span class="ident" id="1686615">q</span><span class="op" id="1686616">:</span><span class="op" id="1686617">]</span><span class="op" id="1686618">,</span>&nbsp;<span class="ident" id="1686620">e</span><span class="op" id="1686621">.</span><span class="ident" id="1686622">stack</span><span class="op" id="1686627">[</span><span class="op" id="1686628">:</span><span class="ident" id="1686629">d</span><span class="op" id="1686630">]</span><span class="op" id="1686631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686634">q</span>&nbsp;<span class="op" id="1686636">+=</span>&nbsp;<span class="ident" id="1686639">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686642">p</span><span class="op" id="1686643">.</span><span class="ident" id="1686644">nlog</span>&nbsp;<span class="op" id="1686649">=</span>&nbsp;<span class="ident" id="1686651">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686654">e</span><span class="op" id="1686655">.</span><span class="ident" id="1686656">count</span>&nbsp;<span class="op" id="1686662">=</span>&nbsp;<span class="num" id="1686664">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686667">return</span>&nbsp;<span class="builtintype" id="1686674">true</span><br>
<span class="lineno"></span><span class="op" id="1686679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1686682">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1686754">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1686837">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1686909">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1686988">func</span>&nbsp;<span class="op" id="1686993">(</span><span class="ident" id="1686994">p</span>&nbsp;<span class="op" id="1686996">*</span><span class="ident" id="1686997">cpuProfile</span><span class="op" id="1687007">)</span>&nbsp;<span class="ident" id="1687009">flushlog</span><span class="op" id="1687017">(</span><span class="op" id="1687018">)</span>&nbsp;<span class="builtintype" id="1687020">bool</span>&nbsp;<span class="op" id="1687025">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687028">if</span>&nbsp;<span class="op" id="1687031">!</span><span class="ident" id="1687032">cas</span><span class="op" id="1687035">(</span><span class="op" id="1687036">&amp;</span><span class="ident" id="1687037">p</span><span class="op" id="1687038">.</span><span class="ident" id="1687039">handoff</span><span class="op" id="1687046">,</span>&nbsp;<span class="num" id="1687048">0</span><span class="op" id="1687049">,</span>&nbsp;<span class="builtintype" id="1687051">uint32</span><span class="op" id="1687057">(</span><span class="ident" id="1687058">p</span><span class="op" id="1687059">.</span><span class="ident" id="1687060">nlog</span><span class="op" id="1687064">)</span><span class="op" id="1687065">)</span>&nbsp;<span class="op" id="1687067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687071">return</span>&nbsp;<span class="builtintype" id="1687078">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687088">notewakeup</span><span class="op" id="1687098">(</span><span class="op" id="1687099">&amp;</span><span class="ident" id="1687100">p</span><span class="op" id="1687101">.</span><span class="ident" id="1687102">wait</span><span class="op" id="1687106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687110">p</span><span class="op" id="1687111">.</span><span class="ident" id="1687112">toggle</span>&nbsp;<span class="op" id="1687119">=</span>&nbsp;<span class="num" id="1687121">1</span>&nbsp;<span class="op" id="1687123">-</span>&nbsp;<span class="ident" id="1687125">p</span><span class="op" id="1687126">.</span><span class="ident" id="1687127">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687135">log</span>&nbsp;<span class="op" id="1687139">:=</span>&nbsp;<span class="op" id="1687142">&amp;</span><span class="ident" id="1687143">p</span><span class="op" id="1687144">.</span><span class="ident" id="1687145">log</span><span class="op" id="1687148">[</span><span class="ident" id="1687149">p</span><span class="op" id="1687150">.</span><span class="ident" id="1687151">toggle</span><span class="op" id="1687157">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687160">q</span>&nbsp;<span class="op" id="1687162">:=</span>&nbsp;<span class="builtintype" id="1687165">uintptr</span><span class="op" id="1687172">(</span><span class="num" id="1687173">0</span><span class="op" id="1687174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687177">if</span>&nbsp;<span class="ident" id="1687180">p</span><span class="op" id="1687181">.</span><span class="ident" id="1687182">lost</span>&nbsp;<span class="op" id="1687187">&gt;</span>&nbsp;<span class="num" id="1687189">0</span>&nbsp;<span class="op" id="1687191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687195">lostPC</span>&nbsp;<span class="op" id="1687202">:=</span>&nbsp;<span class="ident" id="1687205">funcPC</span><span class="op" id="1687211">(</span><span class="ident" id="1687212">lostProfileData</span><span class="op" id="1687227">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687231">log</span><span class="op" id="1687234">[</span><span class="num" id="1687235">0</span><span class="op" id="1687236">]</span>&nbsp;<span class="op" id="1687238">=</span>&nbsp;<span class="ident" id="1687240">p</span><span class="op" id="1687241">.</span><span class="ident" id="1687242">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687249">log</span><span class="op" id="1687252">[</span><span class="num" id="1687253">1</span><span class="op" id="1687254">]</span>&nbsp;<span class="op" id="1687256">=</span>&nbsp;<span class="num" id="1687258">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687262">log</span><span class="op" id="1687265">[</span><span class="num" id="1687266">2</span><span class="op" id="1687267">]</span>&nbsp;<span class="op" id="1687269">=</span>&nbsp;<span class="ident" id="1687271">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687280">q</span>&nbsp;<span class="op" id="1687282">=</span>&nbsp;<span class="num" id="1687284">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687288">p</span><span class="op" id="1687289">.</span><span class="ident" id="1687290">lost</span>&nbsp;<span class="op" id="1687295">=</span>&nbsp;<span class="num" id="1687297">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687303">p</span><span class="op" id="1687304">.</span><span class="ident" id="1687305">nlog</span>&nbsp;<span class="op" id="1687310">=</span>&nbsp;<span class="ident" id="1687312">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687315">return</span>&nbsp;<span class="builtintype" id="1687322">true</span><br>
<span class="lineno"></span><span class="op" id="1687327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1687330">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1687403">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1687476">func</span>&nbsp;<span class="op" id="1687481">(</span><span class="ident" id="1687482">p</span>&nbsp;<span class="op" id="1687484">*</span><span class="ident" id="1687485">cpuProfile</span><span class="op" id="1687495">)</span>&nbsp;<span class="ident" id="1687497">getprofile</span><span class="op" id="1687507">(</span><span class="op" id="1687508">)</span>&nbsp;<span class="op" id="1687510">[</span><span class="op" id="1687511">]</span><span class="builtintype" id="1687512">byte</span>&nbsp;<span class="op" id="1687517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687520">if</span>&nbsp;<span class="ident" id="1687523">p</span>&nbsp;<span class="op" id="1687525">==</span>&nbsp;<span class="ident" id="1687528">nil</span>&nbsp;<span class="op" id="1687532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687536">return</span>&nbsp;<span class="ident" id="1687543">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687552">if</span>&nbsp;<span class="ident" id="1687555">p</span><span class="op" id="1687556">.</span><span class="ident" id="1687557">wholding</span>&nbsp;<span class="op" id="1687566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687570">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687621">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687683">for</span>&nbsp;<span class="op" id="1687687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687692">n</span>&nbsp;<span class="op" id="1687694">:=</span>&nbsp;<span class="ident" id="1687697">p</span><span class="op" id="1687698">.</span><span class="ident" id="1687699">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687710">if</span>&nbsp;<span class="ident" id="1687713">n</span>&nbsp;<span class="op" id="1687715">==</span>&nbsp;<span class="num" id="1687718">0</span>&nbsp;<span class="op" id="1687720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1687726">print</span><span class="op" id="1687731">(</span><span class="string" id="1687732">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1687783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687789">return</span>&nbsp;<span class="ident" id="1687796">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687808">if</span>&nbsp;<span class="ident" id="1687811">n</span><span class="op" id="1687812">&amp;</span><span class="num" id="1687813">0x80000000</span>&nbsp;<span class="op" id="1687824">!=</span>&nbsp;<span class="num" id="1687827">0</span>&nbsp;<span class="op" id="1687829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687835">p</span><span class="op" id="1687836">.</span><span class="ident" id="1687837">wtoggle</span>&nbsp;<span class="op" id="1687845">=</span>&nbsp;<span class="num" id="1687847">1</span>&nbsp;<span class="op" id="1687849">-</span>&nbsp;<span class="ident" id="1687851">p</span><span class="op" id="1687852">.</span><span class="ident" id="1687853">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687865">p</span><span class="op" id="1687866">.</span><span class="ident" id="1687867">wholding</span>&nbsp;<span class="op" id="1687876">=</span>&nbsp;<span class="builtintype" id="1687878">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687888">p</span><span class="op" id="1687889">.</span><span class="ident" id="1687890">flushing</span>&nbsp;<span class="op" id="1687899">=</span>&nbsp;<span class="builtintype" id="1687901">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687910">goto</span>&nbsp;<span class="ident" id="1687915">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687929">if</span>&nbsp;<span class="ident" id="1687932">cas</span><span class="op" id="1687935">(</span><span class="op" id="1687936">&amp;</span><span class="ident" id="1687937">p</span><span class="op" id="1687938">.</span><span class="ident" id="1687939">handoff</span><span class="op" id="1687946">,</span>&nbsp;<span class="ident" id="1687948">n</span><span class="op" id="1687949">,</span>&nbsp;<span class="num" id="1687951">0</span><span class="op" id="1687952">)</span>&nbsp;<span class="op" id="1687954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687960">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687969">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687977">p</span><span class="op" id="1687978">.</span><span class="ident" id="1687979">wtoggle</span>&nbsp;<span class="op" id="1687987">=</span>&nbsp;<span class="num" id="1687989">1</span>&nbsp;<span class="op" id="1687991">-</span>&nbsp;<span class="ident" id="1687993">p</span><span class="op" id="1687994">.</span><span class="ident" id="1687995">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688005">p</span><span class="op" id="1688006">.</span><span class="ident" id="1688007">wholding</span>&nbsp;<span class="op" id="1688016">=</span>&nbsp;<span class="builtintype" id="1688018">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688029">if</span>&nbsp;<span class="ident" id="1688032">p</span><span class="op" id="1688033">.</span><span class="ident" id="1688034">flushing</span>&nbsp;<span class="op" id="1688043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688047">goto</span>&nbsp;<span class="ident" id="1688052">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688063">if</span>&nbsp;<span class="op" id="1688066">!</span><span class="ident" id="1688067">p</span><span class="op" id="1688068">.</span><span class="ident" id="1688069">on</span>&nbsp;<span class="op" id="1688072">&amp;&amp;</span>&nbsp;<span class="ident" id="1688075">p</span><span class="op" id="1688076">.</span><span class="ident" id="1688077">handoff</span>&nbsp;<span class="op" id="1688085">==</span>&nbsp;<span class="num" id="1688088">0</span>&nbsp;<span class="op" id="1688090">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688094">return</span>&nbsp;<span class="ident" id="1688101">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688110">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688132">notetsleepg</span><span class="op" id="1688143">(</span><span class="op" id="1688144">&amp;</span><span class="ident" id="1688145">p</span><span class="op" id="1688146">.</span><span class="ident" id="1688147">wait</span><span class="op" id="1688151">,</span>&nbsp;<span class="op" id="1688153">-</span><span class="num" id="1688154">1</span><span class="op" id="1688155">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688158">noteclear</span><span class="op" id="1688167">(</span><span class="op" id="1688168">&amp;</span><span class="ident" id="1688169">p</span><span class="op" id="1688170">.</span><span class="ident" id="1688171">wait</span><span class="op" id="1688175">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688179">switch</span>&nbsp;<span class="ident" id="1688186">n</span>&nbsp;<span class="op" id="1688188">:=</span>&nbsp;<span class="ident" id="1688191">p</span><span class="op" id="1688192">.</span><span class="ident" id="1688193">handoff</span><span class="op" id="1688200">;</span>&nbsp;<span class="op" id="1688202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688205">case</span>&nbsp;<span class="ident" id="1688210">n</span>&nbsp;<span class="op" id="1688212">==</span>&nbsp;<span class="num" id="1688215">0</span><span class="op" id="1688216">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1688220">print</span><span class="op" id="1688225">(</span><span class="string" id="1688226">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1688274">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688278">return</span>&nbsp;<span class="ident" id="1688285">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688290">case</span>&nbsp;<span class="ident" id="1688295">n</span>&nbsp;<span class="op" id="1688297">==</span>&nbsp;<span class="num" id="1688300">0x80000000</span><span class="op" id="1688310">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688314">p</span><span class="op" id="1688315">.</span><span class="ident" id="1688316">flushing</span>&nbsp;<span class="op" id="1688325">=</span>&nbsp;<span class="builtintype" id="1688327">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688334">goto</span>&nbsp;<span class="ident" id="1688339">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688346">default</span><span class="op" id="1688353">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688357">n</span>&nbsp;<span class="op" id="1688359">&amp;^=</span>&nbsp;<span class="num" id="1688363">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688377">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688408">p</span><span class="op" id="1688409">.</span><span class="ident" id="1688410">wholding</span>&nbsp;<span class="op" id="1688419">=</span>&nbsp;<span class="builtintype" id="1688421">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688429">return</span>&nbsp;<span class="ident" id="1688436">uintptrBytes</span><span class="op" id="1688448">(</span><span class="ident" id="1688449">p</span><span class="op" id="1688450">.</span><span class="ident" id="1688451">log</span><span class="op" id="1688454">[</span><span class="ident" id="1688455">p</span><span class="op" id="1688456">.</span><span class="ident" id="1688457">wtoggle</span><span class="op" id="1688464">]</span><span class="op" id="1688465">[</span><span class="op" id="1688466">:</span><span class="ident" id="1688467">n</span><span class="op" id="1688468">]</span><span class="op" id="1688469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688476">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688495">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688547">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688612">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1688664">Flush</span><span class="op" id="1688669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688672">for</span>&nbsp;<span class="ident" id="1688676">i</span>&nbsp;<span class="op" id="1688678">:=</span>&nbsp;<span class="keyword" id="1688681">range</span>&nbsp;<span class="ident" id="1688687">p</span><span class="op" id="1688688">.</span><span class="ident" id="1688689">hash</span>&nbsp;<span class="op" id="1688694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688698">b</span>&nbsp;<span class="op" id="1688700">:=</span>&nbsp;<span class="op" id="1688703">&amp;</span><span class="ident" id="1688704">p</span><span class="op" id="1688705">.</span><span class="ident" id="1688706">hash</span><span class="op" id="1688710">[</span><span class="ident" id="1688711">i</span><span class="op" id="1688712">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688716">for</span>&nbsp;<span class="ident" id="1688720">j</span>&nbsp;<span class="op" id="1688722">:=</span>&nbsp;<span class="keyword" id="1688725">range</span>&nbsp;<span class="ident" id="1688731">b</span><span class="op" id="1688732">.</span><span class="ident" id="1688733">entry</span>&nbsp;<span class="op" id="1688739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688744">e</span>&nbsp;<span class="op" id="1688746">:=</span>&nbsp;<span class="op" id="1688749">&amp;</span><span class="ident" id="1688750">b</span><span class="op" id="1688751">.</span><span class="ident" id="1688752">entry</span><span class="op" id="1688757">[</span><span class="ident" id="1688758">j</span><span class="op" id="1688759">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688764">if</span>&nbsp;<span class="ident" id="1688767">e</span><span class="op" id="1688768">.</span><span class="ident" id="1688769">count</span>&nbsp;<span class="op" id="1688775">&gt;</span>&nbsp;<span class="num" id="1688777">0</span>&nbsp;<span class="op" id="1688779">&amp;&amp;</span>&nbsp;<span class="op" id="1688782">!</span><span class="ident" id="1688783">p</span><span class="op" id="1688784">.</span><span class="ident" id="1688785">evict</span><span class="op" id="1688790">(</span><span class="ident" id="1688791">e</span><span class="op" id="1688792">)</span>&nbsp;<span class="op" id="1688794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688800">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688865">break</span>&nbsp;<span class="ident" id="1688871">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688891">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688920">if</span>&nbsp;<span class="ident" id="1688923">p</span><span class="op" id="1688924">.</span><span class="ident" id="1688925">nlog</span>&nbsp;<span class="op" id="1688930">&gt;</span>&nbsp;<span class="num" id="1688932">0</span>&nbsp;<span class="op" id="1688934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688938">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688990">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689038">n</span>&nbsp;<span class="op" id="1689040">:=</span>&nbsp;<span class="ident" id="1689043">p</span><span class="op" id="1689044">.</span><span class="ident" id="1689045">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689052">p</span><span class="op" id="1689053">.</span><span class="ident" id="1689054">nlog</span>&nbsp;<span class="op" id="1689059">=</span>&nbsp;<span class="num" id="1689061">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689065">return</span>&nbsp;<span class="ident" id="1689072">uintptrBytes</span><span class="op" id="1689084">(</span><span class="ident" id="1689085">p</span><span class="op" id="1689086">.</span><span class="ident" id="1689087">log</span><span class="op" id="1689090">[</span><span class="ident" id="1689091">p</span><span class="op" id="1689092">.</span><span class="ident" id="1689093">toggle</span><span class="op" id="1689099">]</span><span class="op" id="1689100">[</span><span class="op" id="1689101">:</span><span class="ident" id="1689102">n</span><span class="op" id="1689103">]</span><span class="op" id="1689104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689111">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689174">if</span>&nbsp;<span class="op" id="1689177">!</span><span class="ident" id="1689178">p</span><span class="op" id="1689179">.</span><span class="ident" id="1689180">eodSent</span>&nbsp;<span class="op" id="1689188">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689192">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689258">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689323">p</span><span class="op" id="1689324">.</span><span class="ident" id="1689325">eodSent</span>&nbsp;<span class="op" id="1689333">=</span>&nbsp;<span class="builtintype" id="1689335">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689342">return</span>&nbsp;<span class="ident" id="1689349">uintptrBytes</span><span class="op" id="1689361">(</span><span class="ident" id="1689362">eod</span><span class="op" id="1689365">[</span><span class="op" id="1689366">:</span><span class="op" id="1689367">]</span><span class="op" id="1689368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689371">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689375">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689419">p</span><span class="op" id="1689420">.</span><span class="ident" id="1689421">flushing</span>&nbsp;<span class="op" id="1689430">=</span>&nbsp;<span class="builtintype" id="1689432">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689439">if</span>&nbsp;<span class="op" id="1689442">!</span><span class="ident" id="1689443">cas</span><span class="op" id="1689446">(</span><span class="op" id="1689447">&amp;</span><span class="ident" id="1689448">p</span><span class="op" id="1689449">.</span><span class="ident" id="1689450">handoff</span><span class="op" id="1689457">,</span>&nbsp;<span class="ident" id="1689459">p</span><span class="op" id="1689460">.</span><span class="ident" id="1689461">handoff</span><span class="op" id="1689468">,</span>&nbsp;<span class="num" id="1689470">0</span><span class="op" id="1689471">)</span>&nbsp;<span class="op" id="1689473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1689477">print</span><span class="op" id="1689482">(</span><span class="string" id="1689483">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1689531">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689537">return</span>&nbsp;<span class="ident" id="1689544">nil</span><br>
<span class="lineno"></span><span class="op" id="1689548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1689551">func</span>&nbsp;<span class="ident" id="1689556">uintptrBytes</span><span class="op" id="1689568">(</span><span class="ident" id="1689569">p</span>&nbsp;<span class="op" id="1689571">[</span><span class="op" id="1689572">]</span><span class="builtintype" id="1689573">uintptr</span><span class="op" id="1689580">)</span>&nbsp;<span class="op" id="1689582">(</span><span class="ident" id="1689583">ret</span>&nbsp;<span class="op" id="1689587">[</span><span class="op" id="1689588">]</span><span class="builtintype" id="1689589">byte</span><span class="op" id="1689593">)</span>&nbsp;<span class="op" id="1689595">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689598">pp</span>&nbsp;<span class="op" id="1689601">:=</span>&nbsp;<span class="op" id="1689604">(</span><span class="op" id="1689605">*</span><span class="ident" id="1689606">sliceStruct</span><span class="op" id="1689617">)</span><span class="op" id="1689618">(</span><span class="ident" id="1689619">unsafe</span><span class="op" id="1689625">.</span><span class="ident" id="1689626">Pointer</span><span class="op" id="1689633">(</span><span class="op" id="1689634">&amp;</span><span class="ident" id="1689635">p</span><span class="op" id="1689636">)</span><span class="op" id="1689637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689640">rp</span>&nbsp;<span class="op" id="1689643">:=</span>&nbsp;<span class="op" id="1689646">(</span><span class="op" id="1689647">*</span><span class="ident" id="1689648">sliceStruct</span><span class="op" id="1689659">)</span><span class="op" id="1689660">(</span><span class="ident" id="1689661">unsafe</span><span class="op" id="1689667">.</span><span class="ident" id="1689668">Pointer</span><span class="op" id="1689675">(</span><span class="op" id="1689676">&amp;</span><span class="ident" id="1689677">ret</span><span class="op" id="1689680">)</span><span class="op" id="1689681">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689685">rp</span><span class="op" id="1689687">.</span><span class="ident" id="1689688">array</span>&nbsp;<span class="op" id="1689694">=</span>&nbsp;<span class="ident" id="1689696">pp</span><span class="op" id="1689698">.</span><span class="ident" id="1689699">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689706">rp</span><span class="op" id="1689708">.</span><span class="builtinfunc" id="1689709">len</span>&nbsp;<span class="op" id="1689713">=</span>&nbsp;<span class="ident" id="1689715">pp</span><span class="op" id="1689717">.</span><span class="builtinfunc" id="1689718">len</span>&nbsp;<span class="op" id="1689722">*</span>&nbsp;<span class="builtintype" id="1689724">int</span><span class="op" id="1689727">(</span><span class="ident" id="1689728">unsafe</span><span class="op" id="1689734">.</span><span class="ident" id="1689735">Sizeof</span><span class="op" id="1689741">(</span><span class="ident" id="1689742">p</span><span class="op" id="1689743">[</span><span class="num" id="1689744">0</span><span class="op" id="1689745">]</span><span class="op" id="1689746">)</span><span class="op" id="1689747">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689750">rp</span><span class="op" id="1689752">.</span><span class="builtinfunc" id="1689753">cap</span>&nbsp;<span class="op" id="1689757">=</span>&nbsp;<span class="ident" id="1689759">rp</span><span class="op" id="1689761">.</span><span class="builtinfunc" id="1689762">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689768">return</span><br>
<span class="lineno"></span><span class="op" id="1689775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1689778">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1689857">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1689942">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1690021">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1690096">//</span><br>
<span class="lineno">420</span><span class="comment" id="1690099">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1690155">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1690221">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1690245">func</span>&nbsp;<span class="ident" id="1690250">CPUProfile</span><span class="op" id="1690260">(</span><span class="op" id="1690261">)</span>&nbsp;<span class="op" id="1690263">[</span><span class="op" id="1690264">]</span><span class="builtintype" id="1690265">byte</span>&nbsp;<span class="op" id="1690270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690273">return</span>&nbsp;<span class="ident" id="1690280">cpuprof</span><span class="op" id="1690287">.</span><span class="ident" id="1690288">getprofile</span><span class="op" id="1690298">(</span><span class="op" id="1690299">)</span><br>
<span class="lineno">425</span><span class="op" id="1690301">}</span>
</div>
</body>
</html>
