<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html" class="current">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7331957">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7332012">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7332066">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7332117">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7332142">package</span>&nbsp;<span class="ident" id="7332150">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7332160">import</span>&nbsp;<span class="op" id="7332167">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7332170">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7332183">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7332195">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7332216">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7332227">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7332238">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7332249">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7332256">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7332259">const</span>&nbsp;<span class="ident" id="7332265">fakeHopHeader</span>&nbsp;<span class="op" id="7332279">=</span>&nbsp;<span class="string" id="7332281">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7332311">func</span>&nbsp;<span class="ident" id="7332316">init</span><span class="op" id="7332320">(</span><span class="op" id="7332321">)</span>&nbsp;<span class="op" id="7332323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7332326">hopHeaders</span>&nbsp;<span class="op" id="7332337">=</span>&nbsp;<span class="builtinfunc" id="7332339">append</span><span class="op" id="7332345">(</span><span class="ident" id="7332346">hopHeaders</span><span class="op" id="7332356">,</span>&nbsp;<span class="ident" id="7332358">fakeHopHeader</span><span class="op" id="7332371">)</span><br>
<span class="lineno"></span><span class="op" id="7332373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7332376">func</span>&nbsp;<span class="ident" id="7332381">TestReverseProxy</span><span class="op" id="7332397">(</span><span class="ident" id="7332398">t</span>&nbsp;<span class="op" id="7332400">*</span><span class="ident" id="7332401">testing</span><span class="op" id="7332408">.</span><span class="ident" id="7332409">T</span><span class="op" id="7332410">)</span>&nbsp;<span class="op" id="7332412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7332415">const</span>&nbsp;<span class="ident" id="7332421">backendResponse</span>&nbsp;<span class="op" id="7332437">=</span>&nbsp;<span class="string" id="7332439">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7332459">const</span>&nbsp;<span class="ident" id="7332465">backendStatus</span>&nbsp;<span class="op" id="7332479">=</span>&nbsp;<span class="num" id="7332481">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7332486">backend</span>&nbsp;<span class="op" id="7332494">:=</span>&nbsp;<span class="ident" id="7332497">httptest</span><span class="op" id="7332505">.</span><span class="ident" id="7332506">NewServer</span><span class="op" id="7332515">(</span><span class="ident" id="7332516">http</span><span class="op" id="7332520">.</span><span class="ident" id="7332521">HandlerFunc</span><span class="op" id="7332532">(</span><span class="keyword" id="7332533">func</span><span class="op" id="7332537">(</span><span class="ident" id="7332538">w</span>&nbsp;<span class="ident" id="7332540">http</span><span class="op" id="7332544">.</span><span class="ident" id="7332545">ResponseWriter</span><span class="op" id="7332559">,</span>&nbsp;<span class="ident" id="7332561">r</span>&nbsp;<span class="op" id="7332563">*</span><span class="ident" id="7332564">http</span><span class="op" id="7332568">.</span><span class="ident" id="7332569">Request</span><span class="op" id="7332576">)</span>&nbsp;<span class="op" id="7332578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7332582">if</span>&nbsp;<span class="builtinfunc" id="7332585">len</span><span class="op" id="7332588">(</span><span class="ident" id="7332589">r</span><span class="op" id="7332590">.</span><span class="ident" id="7332591">TransferEncoding</span><span class="op" id="7332607">)</span>&nbsp;<span class="op" id="7332609">&gt;</span>&nbsp;<span class="num" id="7332611">0</span>&nbsp;<span class="op" id="7332613">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7332618">t</span><span class="op" id="7332619">.</span><span class="ident" id="7332620">Errorf</span><span class="op" id="7332626">(</span><span class="string" id="7332627">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7332672">,</span>&nbsp;<span class="ident" id="7332674">r</span><span class="op" id="7332675">.</span><span class="ident" id="7332676">TransferEncoding</span><span class="op" id="7332692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7332696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7332700">if</span>&nbsp;<span class="ident" id="7332703">r</span><span class="op" id="7332704">.</span><span class="ident" id="7332705">Header</span><span class="op" id="7332711">.</span><span class="ident" id="7332712">Get</span><span class="op" id="7332715">(</span><span class="string" id="7332716">&#34;X-Forwarded-For&#34;</span><span class="op" id="7332733">)</span>&nbsp;<span class="op" id="7332735">==</span>&nbsp;<span class="string" id="7332738">&#34;&#34;</span>&nbsp;<span class="op" id="7332741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7332746">t</span><span class="op" id="7332747">.</span><span class="ident" id="7332748">Errorf</span><span class="op" id="7332754">(</span><span class="string" id="7332755">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7332790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7332794">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7332798">if</span>&nbsp;<span class="ident" id="7332801">c</span>&nbsp;<span class="op" id="7332803">:=</span>&nbsp;<span class="ident" id="7332806">r</span><span class="op" id="7332807">.</span><span class="ident" id="7332808">Header</span><span class="op" id="7332814">.</span><span class="ident" id="7332815">Get</span><span class="op" id="7332818">(</span><span class="string" id="7332819">&#34;Connection&#34;</span><span class="op" id="7332831">)</span><span class="op" id="7332832">;</span>&nbsp;<span class="ident" id="7332834">c</span>&nbsp;<span class="op" id="7332836">!=</span>&nbsp;<span class="string" id="7332839">&#34;&#34;</span>&nbsp;<span class="op" id="7332842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7332847">t</span><span class="op" id="7332848">.</span><span class="ident" id="7332849">Errorf</span><span class="op" id="7332855">(</span><span class="string" id="7332856">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7332896">,</span>&nbsp;<span class="ident" id="7332898">c</span><span class="op" id="7332899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7332903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7332907">if</span>&nbsp;<span class="ident" id="7332910">c</span>&nbsp;<span class="op" id="7332912">:=</span>&nbsp;<span class="ident" id="7332915">r</span><span class="op" id="7332916">.</span><span class="ident" id="7332917">Header</span><span class="op" id="7332923">.</span><span class="ident" id="7332924">Get</span><span class="op" id="7332927">(</span><span class="string" id="7332928">&#34;Upgrade&#34;</span><span class="op" id="7332937">)</span><span class="op" id="7332938">;</span>&nbsp;<span class="ident" id="7332940">c</span>&nbsp;<span class="op" id="7332942">!=</span>&nbsp;<span class="string" id="7332945">&#34;&#34;</span>&nbsp;<span class="op" id="7332948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7332953">t</span><span class="op" id="7332954">.</span><span class="ident" id="7332955">Errorf</span><span class="op" id="7332961">(</span><span class="string" id="7332962">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7332999">,</span>&nbsp;<span class="ident" id="7333001">c</span><span class="op" id="7333002">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7333006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7333010">if</span>&nbsp;<span class="ident" id="7333013">g</span><span class="op" id="7333014">,</span>&nbsp;<span class="ident" id="7333016">e</span>&nbsp;<span class="op" id="7333018">:=</span>&nbsp;<span class="ident" id="7333021">r</span><span class="op" id="7333022">.</span><span class="ident" id="7333023">Host</span><span class="op" id="7333027">,</span>&nbsp;<span class="string" id="7333029">&#34;some-name&#34;</span><span class="op" id="7333040">;</span>&nbsp;<span class="ident" id="7333042">g</span>&nbsp;<span class="op" id="7333044">!=</span>&nbsp;<span class="ident" id="7333047">e</span>&nbsp;<span class="op" id="7333049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333054">t</span><span class="op" id="7333055">.</span><span class="ident" id="7333056">Errorf</span><span class="op" id="7333062">(</span><span class="string" id="7333063">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7333100">,</span>&nbsp;<span class="ident" id="7333102">g</span><span class="op" id="7333103">,</span>&nbsp;<span class="ident" id="7333105">e</span><span class="op" id="7333106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7333110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333114">w</span><span class="op" id="7333115">.</span><span class="ident" id="7333116">Header</span><span class="op" id="7333122">(</span><span class="op" id="7333123">)</span><span class="op" id="7333124">.</span><span class="ident" id="7333125">Set</span><span class="op" id="7333128">(</span><span class="string" id="7333129">&#34;X-Foo&#34;</span><span class="op" id="7333136">,</span>&nbsp;<span class="string" id="7333138">&#34;bar&#34;</span><span class="op" id="7333143">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333147">w</span><span class="op" id="7333148">.</span><span class="ident" id="7333149">Header</span><span class="op" id="7333155">(</span><span class="op" id="7333156">)</span><span class="op" id="7333157">.</span><span class="ident" id="7333158">Set</span><span class="op" id="7333161">(</span><span class="string" id="7333162">&#34;Upgrade&#34;</span><span class="op" id="7333171">,</span>&nbsp;<span class="string" id="7333173">&#34;foo&#34;</span><span class="op" id="7333178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333182">w</span><span class="op" id="7333183">.</span><span class="ident" id="7333184">Header</span><span class="op" id="7333190">(</span><span class="op" id="7333191">)</span><span class="op" id="7333192">.</span><span class="ident" id="7333193">Set</span><span class="op" id="7333196">(</span><span class="ident" id="7333197">fakeHopHeader</span><span class="op" id="7333210">,</span>&nbsp;<span class="string" id="7333212">&#34;foo&#34;</span><span class="op" id="7333217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333221">w</span><span class="op" id="7333222">.</span><span class="ident" id="7333223">Header</span><span class="op" id="7333229">(</span><span class="op" id="7333230">)</span><span class="op" id="7333231">.</span><span class="ident" id="7333232">Add</span><span class="op" id="7333235">(</span><span class="string" id="7333236">&#34;X-Multi-Value&#34;</span><span class="op" id="7333251">,</span>&nbsp;<span class="string" id="7333253">&#34;foo&#34;</span><span class="op" id="7333258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333262">w</span><span class="op" id="7333263">.</span><span class="ident" id="7333264">Header</span><span class="op" id="7333270">(</span><span class="op" id="7333271">)</span><span class="op" id="7333272">.</span><span class="ident" id="7333273">Add</span><span class="op" id="7333276">(</span><span class="string" id="7333277">&#34;X-Multi-Value&#34;</span><span class="op" id="7333292">,</span>&nbsp;<span class="string" id="7333294">&#34;bar&#34;</span><span class="op" id="7333299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333303">http</span><span class="op" id="7333307">.</span><span class="ident" id="7333308">SetCookie</span><span class="op" id="7333317">(</span><span class="ident" id="7333318">w</span><span class="op" id="7333319">,</span>&nbsp;<span class="op" id="7333321">&amp;</span><span class="ident" id="7333322">http</span><span class="op" id="7333326">.</span><span class="ident" id="7333327">Cookie</span><span class="op" id="7333333">{</span><span class="ident" id="7333334">Name</span><span class="op" id="7333338">:</span>&nbsp;<span class="string" id="7333340">&#34;flavor&#34;</span><span class="op" id="7333348">,</span>&nbsp;<span class="ident" id="7333350">Value</span><span class="op" id="7333355">:</span>&nbsp;<span class="string" id="7333357">&#34;chocolateChip&#34;</span><span class="op" id="7333372">}</span><span class="op" id="7333373">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333377">w</span><span class="op" id="7333378">.</span><span class="ident" id="7333379">WriteHeader</span><span class="op" id="7333390">(</span><span class="ident" id="7333391">backendStatus</span><span class="op" id="7333404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333408">w</span><span class="op" id="7333409">.</span><span class="ident" id="7333410">Write</span><span class="op" id="7333415">(</span><span class="op" id="7333416">[</span><span class="op" id="7333417">]</span><span class="builtintype" id="7333418">byte</span><span class="op" id="7333422">(</span><span class="ident" id="7333423">backendResponse</span><span class="op" id="7333438">)</span><span class="op" id="7333439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7333442">}</span><span class="op" id="7333443">)</span><span class="op" id="7333444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7333447">defer</span>&nbsp;<span class="ident" id="7333453">backend</span><span class="op" id="7333460">.</span><span class="ident" id="7333461">Close</span><span class="op" id="7333466">(</span><span class="op" id="7333467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333470">backendURL</span><span class="op" id="7333480">,</span>&nbsp;<span class="ident" id="7333482">err</span>&nbsp;<span class="op" id="7333486">:=</span>&nbsp;<span class="ident" id="7333489">url</span><span class="op" id="7333492">.</span><span class="ident" id="7333493">Parse</span><span class="op" id="7333498">(</span><span class="ident" id="7333499">backend</span><span class="op" id="7333506">.</span><span class="ident" id="7333507">URL</span><span class="op" id="7333510">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7333513">if</span>&nbsp;<span class="ident" id="7333516">err</span>&nbsp;<span class="op" id="7333520">!=</span>&nbsp;<span class="ident" id="7333523">nil</span>&nbsp;<span class="op" id="7333527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333531">t</span><span class="op" id="7333532">.</span><span class="ident" id="7333533">Fatal</span><span class="op" id="7333538">(</span><span class="ident" id="7333539">err</span><span class="op" id="7333542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7333545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333548">proxyHandler</span>&nbsp;<span class="op" id="7333561">:=</span>&nbsp;<span class="ident" id="7333564">NewSingleHostReverseProxy</span><span class="op" id="7333589">(</span><span class="ident" id="7333590">backendURL</span><span class="op" id="7333600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333603">frontend</span>&nbsp;<span class="op" id="7333612">:=</span>&nbsp;<span class="ident" id="7333615">httptest</span><span class="op" id="7333623">.</span><span class="ident" id="7333624">NewServer</span><span class="op" id="7333633">(</span><span class="ident" id="7333634">proxyHandler</span><span class="op" id="7333646">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7333649">defer</span>&nbsp;<span class="ident" id="7333655">frontend</span><span class="op" id="7333663">.</span><span class="ident" id="7333664">Close</span><span class="op" id="7333669">(</span><span class="op" id="7333670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333674">getReq</span><span class="op" id="7333680">,</span>&nbsp;<span class="ident" id="7333682">_</span>&nbsp;<span class="op" id="7333684">:=</span>&nbsp;<span class="ident" id="7333687">http</span><span class="op" id="7333691">.</span><span class="ident" id="7333692">NewRequest</span><span class="op" id="7333702">(</span><span class="string" id="7333703">&#34;GET&#34;</span><span class="op" id="7333708">,</span>&nbsp;<span class="ident" id="7333710">frontend</span><span class="op" id="7333718">.</span><span class="ident" id="7333719">URL</span><span class="op" id="7333722">,</span>&nbsp;<span class="ident" id="7333724">nil</span><span class="op" id="7333727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333730">getReq</span><span class="op" id="7333736">.</span><span class="ident" id="7333737">Host</span>&nbsp;<span class="op" id="7333742">=</span>&nbsp;<span class="string" id="7333744">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333757">getReq</span><span class="op" id="7333763">.</span><span class="ident" id="7333764">Header</span><span class="op" id="7333770">.</span><span class="ident" id="7333771">Set</span><span class="op" id="7333774">(</span><span class="string" id="7333775">&#34;Connection&#34;</span><span class="op" id="7333787">,</span>&nbsp;<span class="string" id="7333789">&#34;close&#34;</span><span class="op" id="7333796">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333799">getReq</span><span class="op" id="7333805">.</span><span class="ident" id="7333806">Header</span><span class="op" id="7333812">.</span><span class="ident" id="7333813">Set</span><span class="op" id="7333816">(</span><span class="string" id="7333817">&#34;Upgrade&#34;</span><span class="op" id="7333826">,</span>&nbsp;<span class="string" id="7333828">&#34;foo&#34;</span><span class="op" id="7333833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333836">getReq</span><span class="op" id="7333842">.</span><span class="ident" id="7333843">Close</span>&nbsp;<span class="op" id="7333849">=</span>&nbsp;<span class="builtintype" id="7333851">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333857">res</span><span class="op" id="7333860">,</span>&nbsp;<span class="ident" id="7333862">err</span>&nbsp;<span class="op" id="7333866">:=</span>&nbsp;<span class="ident" id="7333869">http</span><span class="op" id="7333873">.</span><span class="ident" id="7333874">DefaultClient</span><span class="op" id="7333887">.</span><span class="ident" id="7333888">Do</span><span class="op" id="7333890">(</span><span class="ident" id="7333891">getReq</span><span class="op" id="7333897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7333900">if</span>&nbsp;<span class="ident" id="7333903">err</span>&nbsp;<span class="op" id="7333907">!=</span>&nbsp;<span class="ident" id="7333910">nil</span>&nbsp;<span class="op" id="7333914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7333918">t</span><span class="op" id="7333919">.</span><span class="ident" id="7333920">Fatalf</span><span class="op" id="7333926">(</span><span class="string" id="7333927">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7333936">,</span>&nbsp;<span class="ident" id="7333938">err</span><span class="op" id="7333941">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7333944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7333947">if</span>&nbsp;<span class="ident" id="7333950">g</span><span class="op" id="7333951">,</span>&nbsp;<span class="ident" id="7333953">e</span>&nbsp;<span class="op" id="7333955">:=</span>&nbsp;<span class="ident" id="7333958">res</span><span class="op" id="7333961">.</span><span class="ident" id="7333962">StatusCode</span><span class="op" id="7333972">,</span>&nbsp;<span class="ident" id="7333974">backendStatus</span><span class="op" id="7333987">;</span>&nbsp;<span class="ident" id="7333989">g</span>&nbsp;<span class="op" id="7333991">!=</span>&nbsp;<span class="ident" id="7333994">e</span>&nbsp;<span class="op" id="7333996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334000">t</span><span class="op" id="7334001">.</span><span class="ident" id="7334002">Errorf</span><span class="op" id="7334008">(</span><span class="string" id="7334009">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7334045">,</span>&nbsp;<span class="ident" id="7334047">g</span><span class="op" id="7334048">,</span>&nbsp;<span class="ident" id="7334050">e</span><span class="op" id="7334051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7334054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334057">if</span>&nbsp;<span class="ident" id="7334060">g</span><span class="op" id="7334061">,</span>&nbsp;<span class="ident" id="7334063">e</span>&nbsp;<span class="op" id="7334065">:=</span>&nbsp;<span class="ident" id="7334068">res</span><span class="op" id="7334071">.</span><span class="ident" id="7334072">Header</span><span class="op" id="7334078">.</span><span class="ident" id="7334079">Get</span><span class="op" id="7334082">(</span><span class="string" id="7334083">&#34;X-Foo&#34;</span><span class="op" id="7334090">)</span><span class="op" id="7334091">,</span>&nbsp;<span class="string" id="7334093">&#34;bar&#34;</span><span class="op" id="7334098">;</span>&nbsp;<span class="ident" id="7334100">g</span>&nbsp;<span class="op" id="7334102">!=</span>&nbsp;<span class="ident" id="7334105">e</span>&nbsp;<span class="op" id="7334107">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334111">t</span><span class="op" id="7334112">.</span><span class="ident" id="7334113">Errorf</span><span class="op" id="7334119">(</span><span class="string" id="7334120">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7334147">,</span>&nbsp;<span class="ident" id="7334149">g</span><span class="op" id="7334150">,</span>&nbsp;<span class="ident" id="7334152">e</span><span class="op" id="7334153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7334156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334159">if</span>&nbsp;<span class="ident" id="7334162">c</span>&nbsp;<span class="op" id="7334164">:=</span>&nbsp;<span class="ident" id="7334167">res</span><span class="op" id="7334170">.</span><span class="ident" id="7334171">Header</span><span class="op" id="7334177">.</span><span class="ident" id="7334178">Get</span><span class="op" id="7334181">(</span><span class="ident" id="7334182">fakeHopHeader</span><span class="op" id="7334195">)</span><span class="op" id="7334196">;</span>&nbsp;<span class="ident" id="7334198">c</span>&nbsp;<span class="op" id="7334200">!=</span>&nbsp;<span class="string" id="7334203">&#34;&#34;</span>&nbsp;<span class="op" id="7334206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334210">t</span><span class="op" id="7334211">.</span><span class="ident" id="7334212">Errorf</span><span class="op" id="7334218">(</span><span class="string" id="7334219">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7334243">,</span>&nbsp;<span class="ident" id="7334245">fakeHopHeader</span><span class="op" id="7334258">,</span>&nbsp;<span class="ident" id="7334260">c</span><span class="op" id="7334261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7334264">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334267">if</span>&nbsp;<span class="ident" id="7334270">g</span><span class="op" id="7334271">,</span>&nbsp;<span class="ident" id="7334273">e</span>&nbsp;<span class="op" id="7334275">:=</span>&nbsp;<span class="builtinfunc" id="7334278">len</span><span class="op" id="7334281">(</span><span class="ident" id="7334282">res</span><span class="op" id="7334285">.</span><span class="ident" id="7334286">Header</span><span class="op" id="7334292">[</span><span class="string" id="7334293">&#34;X-Multi-Value&#34;</span><span class="op" id="7334308">]</span><span class="op" id="7334309">)</span><span class="op" id="7334310">,</span>&nbsp;<span class="num" id="7334312">2</span><span class="op" id="7334313">;</span>&nbsp;<span class="ident" id="7334315">g</span>&nbsp;<span class="op" id="7334317">!=</span>&nbsp;<span class="ident" id="7334320">e</span>&nbsp;<span class="op" id="7334322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334326">t</span><span class="op" id="7334327">.</span><span class="ident" id="7334328">Errorf</span><span class="op" id="7334334">(</span><span class="string" id="7334335">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7334384">,</span>&nbsp;<span class="ident" id="7334386">g</span><span class="op" id="7334387">,</span>&nbsp;<span class="ident" id="7334389">e</span><span class="op" id="7334390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7334393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334396">if</span>&nbsp;<span class="ident" id="7334399">g</span><span class="op" id="7334400">,</span>&nbsp;<span class="ident" id="7334402">e</span>&nbsp;<span class="op" id="7334404">:=</span>&nbsp;<span class="builtinfunc" id="7334407">len</span><span class="op" id="7334410">(</span><span class="ident" id="7334411">res</span><span class="op" id="7334414">.</span><span class="ident" id="7334415">Header</span><span class="op" id="7334421">[</span><span class="string" id="7334422">&#34;Set-Cookie&#34;</span><span class="op" id="7334434">]</span><span class="op" id="7334435">)</span><span class="op" id="7334436">,</span>&nbsp;<span class="num" id="7334438">1</span><span class="op" id="7334439">;</span>&nbsp;<span class="ident" id="7334441">g</span>&nbsp;<span class="op" id="7334443">!=</span>&nbsp;<span class="ident" id="7334446">e</span>&nbsp;<span class="op" id="7334448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334452">t</span><span class="op" id="7334453">.</span><span class="ident" id="7334454">Fatalf</span><span class="op" id="7334460">(</span><span class="string" id="7334461">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7334489">,</span>&nbsp;<span class="ident" id="7334491">g</span><span class="op" id="7334492">,</span>&nbsp;<span class="ident" id="7334494">e</span><span class="op" id="7334495">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7334498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334501">if</span>&nbsp;<span class="ident" id="7334504">cookie</span>&nbsp;<span class="op" id="7334511">:=</span>&nbsp;<span class="ident" id="7334514">res</span><span class="op" id="7334517">.</span><span class="ident" id="7334518">Cookies</span><span class="op" id="7334525">(</span><span class="op" id="7334526">)</span><span class="op" id="7334527">[</span><span class="num" id="7334528">0</span><span class="op" id="7334529">]</span><span class="op" id="7334530">;</span>&nbsp;<span class="ident" id="7334532">cookie</span><span class="op" id="7334538">.</span><span class="ident" id="7334539">Name</span>&nbsp;<span class="op" id="7334544">!=</span>&nbsp;<span class="string" id="7334547">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7334556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334560">t</span><span class="op" id="7334561">.</span><span class="ident" id="7334562">Errorf</span><span class="op" id="7334568">(</span><span class="string" id="7334569">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7334591">,</span>&nbsp;<span class="ident" id="7334593">cookie</span><span class="op" id="7334599">.</span><span class="ident" id="7334600">Name</span><span class="op" id="7334604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7334607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334610">bodyBytes</span><span class="op" id="7334619">,</span>&nbsp;<span class="ident" id="7334621">_</span>&nbsp;<span class="op" id="7334623">:=</span>&nbsp;<span class="ident" id="7334626">ioutil</span><span class="op" id="7334632">.</span><span class="ident" id="7334633">ReadAll</span><span class="op" id="7334640">(</span><span class="ident" id="7334641">res</span><span class="op" id="7334644">.</span><span class="ident" id="7334645">Body</span><span class="op" id="7334649">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334652">if</span>&nbsp;<span class="ident" id="7334655">g</span><span class="op" id="7334656">,</span>&nbsp;<span class="ident" id="7334658">e</span>&nbsp;<span class="op" id="7334660">:=</span>&nbsp;<span class="builtintype" id="7334663">string</span><span class="op" id="7334669">(</span><span class="ident" id="7334670">bodyBytes</span><span class="op" id="7334679">)</span><span class="op" id="7334680">,</span>&nbsp;<span class="ident" id="7334682">backendResponse</span><span class="op" id="7334697">;</span>&nbsp;<span class="ident" id="7334699">g</span>&nbsp;<span class="op" id="7334701">!=</span>&nbsp;<span class="ident" id="7334704">e</span>&nbsp;<span class="op" id="7334706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334710">t</span><span class="op" id="7334711">.</span><span class="ident" id="7334712">Errorf</span><span class="op" id="7334718">(</span><span class="string" id="7334719">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7334745">,</span>&nbsp;<span class="ident" id="7334747">g</span><span class="op" id="7334748">,</span>&nbsp;<span class="ident" id="7334750">e</span><span class="op" id="7334751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7334754">}</span><br>
<span class="lineno"></span><span class="op" id="7334756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7334759">func</span>&nbsp;<span class="ident" id="7334764">TestXForwardedFor</span><span class="op" id="7334781">(</span><span class="ident" id="7334782">t</span>&nbsp;<span class="op" id="7334784">*</span><span class="ident" id="7334785">testing</span><span class="op" id="7334792">.</span><span class="ident" id="7334793">T</span><span class="op" id="7334794">)</span>&nbsp;<span class="op" id="7334796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334799">const</span>&nbsp;<span class="ident" id="7334805">prevForwardedFor</span>&nbsp;<span class="op" id="7334822">=</span>&nbsp;<span class="string" id="7334824">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334837">const</span>&nbsp;<span class="ident" id="7334843">backendResponse</span>&nbsp;<span class="op" id="7334859">=</span>&nbsp;<span class="string" id="7334861">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7334881">const</span>&nbsp;<span class="ident" id="7334887">backendStatus</span>&nbsp;<span class="op" id="7334901">=</span>&nbsp;<span class="num" id="7334903">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7334908">backend</span>&nbsp;<span class="op" id="7334916">:=</span>&nbsp;<span class="ident" id="7334919">httptest</span><span class="op" id="7334927">.</span><span class="ident" id="7334928">NewServer</span><span class="op" id="7334937">(</span><span class="ident" id="7334938">http</span><span class="op" id="7334942">.</span><span class="ident" id="7334943">HandlerFunc</span><span class="op" id="7334954">(</span><span class="keyword" id="7334955">func</span><span class="op" id="7334959">(</span><span class="ident" id="7334960">w</span>&nbsp;<span class="ident" id="7334962">http</span><span class="op" id="7334966">.</span><span class="ident" id="7334967">ResponseWriter</span><span class="op" id="7334981">,</span>&nbsp;<span class="ident" id="7334983">r</span>&nbsp;<span class="op" id="7334985">*</span><span class="ident" id="7334986">http</span><span class="op" id="7334990">.</span><span class="ident" id="7334991">Request</span><span class="op" id="7334998">)</span>&nbsp;<span class="op" id="7335000">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7335004">if</span>&nbsp;<span class="ident" id="7335007">r</span><span class="op" id="7335008">.</span><span class="ident" id="7335009">Header</span><span class="op" id="7335015">.</span><span class="ident" id="7335016">Get</span><span class="op" id="7335019">(</span><span class="string" id="7335020">&#34;X-Forwarded-For&#34;</span><span class="op" id="7335037">)</span>&nbsp;<span class="op" id="7335039">==</span>&nbsp;<span class="string" id="7335042">&#34;&#34;</span>&nbsp;<span class="op" id="7335045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335050">t</span><span class="op" id="7335051">.</span><span class="ident" id="7335052">Errorf</span><span class="op" id="7335058">(</span><span class="string" id="7335059">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7335094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7335098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7335102">if</span>&nbsp;<span class="op" id="7335105">!</span><span class="ident" id="7335106">strings</span><span class="op" id="7335113">.</span><span class="ident" id="7335114">Contains</span><span class="op" id="7335122">(</span><span class="ident" id="7335123">r</span><span class="op" id="7335124">.</span><span class="ident" id="7335125">Header</span><span class="op" id="7335131">.</span><span class="ident" id="7335132">Get</span><span class="op" id="7335135">(</span><span class="string" id="7335136">&#34;X-Forwarded-For&#34;</span><span class="op" id="7335153">)</span><span class="op" id="7335154">,</span>&nbsp;<span class="ident" id="7335156">prevForwardedFor</span><span class="op" id="7335172">)</span>&nbsp;<span class="op" id="7335174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335179">t</span><span class="op" id="7335180">.</span><span class="ident" id="7335181">Errorf</span><span class="op" id="7335187">(</span><span class="string" id="7335188">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7335231">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7335235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335239">w</span><span class="op" id="7335240">.</span><span class="ident" id="7335241">WriteHeader</span><span class="op" id="7335252">(</span><span class="ident" id="7335253">backendStatus</span><span class="op" id="7335266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335270">w</span><span class="op" id="7335271">.</span><span class="ident" id="7335272">Write</span><span class="op" id="7335277">(</span><span class="op" id="7335278">[</span><span class="op" id="7335279">]</span><span class="builtintype" id="7335280">byte</span><span class="op" id="7335284">(</span><span class="ident" id="7335285">backendResponse</span><span class="op" id="7335300">)</span><span class="op" id="7335301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7335304">}</span><span class="op" id="7335305">)</span><span class="op" id="7335306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7335309">defer</span>&nbsp;<span class="ident" id="7335315">backend</span><span class="op" id="7335322">.</span><span class="ident" id="7335323">Close</span><span class="op" id="7335328">(</span><span class="op" id="7335329">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335332">backendURL</span><span class="op" id="7335342">,</span>&nbsp;<span class="ident" id="7335344">err</span>&nbsp;<span class="op" id="7335348">:=</span>&nbsp;<span class="ident" id="7335351">url</span><span class="op" id="7335354">.</span><span class="ident" id="7335355">Parse</span><span class="op" id="7335360">(</span><span class="ident" id="7335361">backend</span><span class="op" id="7335368">.</span><span class="ident" id="7335369">URL</span><span class="op" id="7335372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7335375">if</span>&nbsp;<span class="ident" id="7335378">err</span>&nbsp;<span class="op" id="7335382">!=</span>&nbsp;<span class="ident" id="7335385">nil</span>&nbsp;<span class="op" id="7335389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335393">t</span><span class="op" id="7335394">.</span><span class="ident" id="7335395">Fatal</span><span class="op" id="7335400">(</span><span class="ident" id="7335401">err</span><span class="op" id="7335404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7335407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335410">proxyHandler</span>&nbsp;<span class="op" id="7335423">:=</span>&nbsp;<span class="ident" id="7335426">NewSingleHostReverseProxy</span><span class="op" id="7335451">(</span><span class="ident" id="7335452">backendURL</span><span class="op" id="7335462">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335465">frontend</span>&nbsp;<span class="op" id="7335474">:=</span>&nbsp;<span class="ident" id="7335477">httptest</span><span class="op" id="7335485">.</span><span class="ident" id="7335486">NewServer</span><span class="op" id="7335495">(</span><span class="ident" id="7335496">proxyHandler</span><span class="op" id="7335508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7335511">defer</span>&nbsp;<span class="ident" id="7335517">frontend</span><span class="op" id="7335525">.</span><span class="ident" id="7335526">Close</span><span class="op" id="7335531">(</span><span class="op" id="7335532">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335536">getReq</span><span class="op" id="7335542">,</span>&nbsp;<span class="ident" id="7335544">_</span>&nbsp;<span class="op" id="7335546">:=</span>&nbsp;<span class="ident" id="7335549">http</span><span class="op" id="7335553">.</span><span class="ident" id="7335554">NewRequest</span><span class="op" id="7335564">(</span><span class="string" id="7335565">&#34;GET&#34;</span><span class="op" id="7335570">,</span>&nbsp;<span class="ident" id="7335572">frontend</span><span class="op" id="7335580">.</span><span class="ident" id="7335581">URL</span><span class="op" id="7335584">,</span>&nbsp;<span class="ident" id="7335586">nil</span><span class="op" id="7335589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335592">getReq</span><span class="op" id="7335598">.</span><span class="ident" id="7335599">Host</span>&nbsp;<span class="op" id="7335604">=</span>&nbsp;<span class="string" id="7335606">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335619">getReq</span><span class="op" id="7335625">.</span><span class="ident" id="7335626">Header</span><span class="op" id="7335632">.</span><span class="ident" id="7335633">Set</span><span class="op" id="7335636">(</span><span class="string" id="7335637">&#34;Connection&#34;</span><span class="op" id="7335649">,</span>&nbsp;<span class="string" id="7335651">&#34;close&#34;</span><span class="op" id="7335658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335661">getReq</span><span class="op" id="7335667">.</span><span class="ident" id="7335668">Header</span><span class="op" id="7335674">.</span><span class="ident" id="7335675">Set</span><span class="op" id="7335678">(</span><span class="string" id="7335679">&#34;X-Forwarded-For&#34;</span><span class="op" id="7335696">,</span>&nbsp;<span class="ident" id="7335698">prevForwardedFor</span><span class="op" id="7335714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335717">getReq</span><span class="op" id="7335723">.</span><span class="ident" id="7335724">Close</span>&nbsp;<span class="op" id="7335730">=</span>&nbsp;<span class="builtintype" id="7335732">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335738">res</span><span class="op" id="7335741">,</span>&nbsp;<span class="ident" id="7335743">err</span>&nbsp;<span class="op" id="7335747">:=</span>&nbsp;<span class="ident" id="7335750">http</span><span class="op" id="7335754">.</span><span class="ident" id="7335755">DefaultClient</span><span class="op" id="7335768">.</span><span class="ident" id="7335769">Do</span><span class="op" id="7335771">(</span><span class="ident" id="7335772">getReq</span><span class="op" id="7335778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7335781">if</span>&nbsp;<span class="ident" id="7335784">err</span>&nbsp;<span class="op" id="7335788">!=</span>&nbsp;<span class="ident" id="7335791">nil</span>&nbsp;<span class="op" id="7335795">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335799">t</span><span class="op" id="7335800">.</span><span class="ident" id="7335801">Fatalf</span><span class="op" id="7335807">(</span><span class="string" id="7335808">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7335817">,</span>&nbsp;<span class="ident" id="7335819">err</span><span class="op" id="7335822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7335825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7335828">if</span>&nbsp;<span class="ident" id="7335831">g</span><span class="op" id="7335832">,</span>&nbsp;<span class="ident" id="7335834">e</span>&nbsp;<span class="op" id="7335836">:=</span>&nbsp;<span class="ident" id="7335839">res</span><span class="op" id="7335842">.</span><span class="ident" id="7335843">StatusCode</span><span class="op" id="7335853">,</span>&nbsp;<span class="ident" id="7335855">backendStatus</span><span class="op" id="7335868">;</span>&nbsp;<span class="ident" id="7335870">g</span>&nbsp;<span class="op" id="7335872">!=</span>&nbsp;<span class="ident" id="7335875">e</span>&nbsp;<span class="op" id="7335877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335881">t</span><span class="op" id="7335882">.</span><span class="ident" id="7335883">Errorf</span><span class="op" id="7335889">(</span><span class="string" id="7335890">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7335926">,</span>&nbsp;<span class="ident" id="7335928">g</span><span class="op" id="7335929">,</span>&nbsp;<span class="ident" id="7335931">e</span><span class="op" id="7335932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7335935">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7335938">bodyBytes</span><span class="op" id="7335947">,</span>&nbsp;<span class="ident" id="7335949">_</span>&nbsp;<span class="op" id="7335951">:=</span>&nbsp;<span class="ident" id="7335954">ioutil</span><span class="op" id="7335960">.</span><span class="ident" id="7335961">ReadAll</span><span class="op" id="7335968">(</span><span class="ident" id="7335969">res</span><span class="op" id="7335972">.</span><span class="ident" id="7335973">Body</span><span class="op" id="7335977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7335980">if</span>&nbsp;<span class="ident" id="7335983">g</span><span class="op" id="7335984">,</span>&nbsp;<span class="ident" id="7335986">e</span>&nbsp;<span class="op" id="7335988">:=</span>&nbsp;<span class="builtintype" id="7335991">string</span><span class="op" id="7335997">(</span><span class="ident" id="7335998">bodyBytes</span><span class="op" id="7336007">)</span><span class="op" id="7336008">,</span>&nbsp;<span class="ident" id="7336010">backendResponse</span><span class="op" id="7336025">;</span>&nbsp;<span class="ident" id="7336027">g</span>&nbsp;<span class="op" id="7336029">!=</span>&nbsp;<span class="ident" id="7336032">e</span>&nbsp;<span class="op" id="7336034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336038">t</span><span class="op" id="7336039">.</span><span class="ident" id="7336040">Errorf</span><span class="op" id="7336046">(</span><span class="string" id="7336047">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7336073">,</span>&nbsp;<span class="ident" id="7336075">g</span><span class="op" id="7336076">,</span>&nbsp;<span class="ident" id="7336078">e</span><span class="op" id="7336079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7336082">}</span><br>
<span class="lineno"></span><span class="op" id="7336084">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7336087">var</span>&nbsp;<span class="ident" id="7336091">proxyQueryTests</span>&nbsp;<span class="op" id="7336107">=</span>&nbsp;<span class="op" id="7336109">[</span><span class="op" id="7336110">]</span><span class="keyword" id="7336111">struct</span>&nbsp;<span class="op" id="7336118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336121">baseSuffix</span>&nbsp;<span class="builtintype" id="7336132">string</span>&nbsp;<span class="comment" id="7336139">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336172">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7336183">string</span>&nbsp;<span class="comment" id="7336190">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336234">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7336245">string</span>&nbsp;<span class="comment" id="7336252">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7336313">}</span><span class="op" id="7336314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7336317">{</span><span class="string" id="7336318">&#34;&#34;</span><span class="op" id="7336320">,</span>&nbsp;<span class="string" id="7336322">&#34;&#34;</span><span class="op" id="7336324">,</span>&nbsp;<span class="string" id="7336326">&#34;&#34;</span><span class="op" id="7336328">}</span><span class="op" id="7336329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7336332">{</span><span class="string" id="7336333">&#34;?sta=tic&#34;</span><span class="op" id="7336343">,</span>&nbsp;<span class="string" id="7336345">&#34;?us=er&#34;</span><span class="op" id="7336353">,</span>&nbsp;<span class="string" id="7336355">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7336370">}</span><span class="op" id="7336371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7336374">{</span><span class="string" id="7336375">&#34;&#34;</span><span class="op" id="7336377">,</span>&nbsp;<span class="string" id="7336379">&#34;?us=er&#34;</span><span class="op" id="7336387">,</span>&nbsp;<span class="string" id="7336389">&#34;us=er&#34;</span><span class="op" id="7336396">}</span><span class="op" id="7336397">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7336400">{</span><span class="string" id="7336401">&#34;?sta=tic&#34;</span><span class="op" id="7336411">,</span>&nbsp;<span class="string" id="7336413">&#34;&#34;</span><span class="op" id="7336415">,</span>&nbsp;<span class="string" id="7336417">&#34;sta=tic&#34;</span><span class="op" id="7336426">}</span><span class="op" id="7336427">,</span><br>
<span class="lineno">145</span><span class="op" id="7336429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7336432">func</span>&nbsp;<span class="ident" id="7336437">TestReverseProxyQuery</span><span class="op" id="7336458">(</span><span class="ident" id="7336459">t</span>&nbsp;<span class="op" id="7336461">*</span><span class="ident" id="7336462">testing</span><span class="op" id="7336469">.</span><span class="ident" id="7336470">T</span><span class="op" id="7336471">)</span>&nbsp;<span class="op" id="7336473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336476">backend</span>&nbsp;<span class="op" id="7336484">:=</span>&nbsp;<span class="ident" id="7336487">httptest</span><span class="op" id="7336495">.</span><span class="ident" id="7336496">NewServer</span><span class="op" id="7336505">(</span><span class="ident" id="7336506">http</span><span class="op" id="7336510">.</span><span class="ident" id="7336511">HandlerFunc</span><span class="op" id="7336522">(</span><span class="keyword" id="7336523">func</span><span class="op" id="7336527">(</span><span class="ident" id="7336528">w</span>&nbsp;<span class="ident" id="7336530">http</span><span class="op" id="7336534">.</span><span class="ident" id="7336535">ResponseWriter</span><span class="op" id="7336549">,</span>&nbsp;<span class="ident" id="7336551">r</span>&nbsp;<span class="op" id="7336553">*</span><span class="ident" id="7336554">http</span><span class="op" id="7336558">.</span><span class="ident" id="7336559">Request</span><span class="op" id="7336566">)</span>&nbsp;<span class="op" id="7336568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336572">w</span><span class="op" id="7336573">.</span><span class="ident" id="7336574">Header</span><span class="op" id="7336580">(</span><span class="op" id="7336581">)</span><span class="op" id="7336582">.</span><span class="ident" id="7336583">Set</span><span class="op" id="7336586">(</span><span class="string" id="7336587">&#34;X-Got-Query&#34;</span><span class="op" id="7336600">,</span>&nbsp;<span class="ident" id="7336602">r</span><span class="op" id="7336603">.</span><span class="ident" id="7336604">URL</span><span class="op" id="7336607">.</span><span class="ident" id="7336608">RawQuery</span><span class="op" id="7336616">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336620">w</span><span class="op" id="7336621">.</span><span class="ident" id="7336622">Write</span><span class="op" id="7336627">(</span><span class="op" id="7336628">[</span><span class="op" id="7336629">]</span><span class="builtintype" id="7336630">byte</span><span class="op" id="7336634">(</span><span class="string" id="7336635">&#34;hi&#34;</span><span class="op" id="7336639">)</span><span class="op" id="7336640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7336643">}</span><span class="op" id="7336644">)</span><span class="op" id="7336645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7336648">defer</span>&nbsp;<span class="ident" id="7336654">backend</span><span class="op" id="7336661">.</span><span class="ident" id="7336662">Close</span><span class="op" id="7336667">(</span><span class="op" id="7336668">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7336672">for</span>&nbsp;<span class="ident" id="7336676">i</span><span class="op" id="7336677">,</span>&nbsp;<span class="ident" id="7336679">tt</span>&nbsp;<span class="op" id="7336682">:=</span>&nbsp;<span class="keyword" id="7336685">range</span>&nbsp;<span class="ident" id="7336691">proxyQueryTests</span>&nbsp;<span class="op" id="7336707">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336711">backendURL</span><span class="op" id="7336721">,</span>&nbsp;<span class="ident" id="7336723">err</span>&nbsp;<span class="op" id="7336727">:=</span>&nbsp;<span class="ident" id="7336730">url</span><span class="op" id="7336733">.</span><span class="ident" id="7336734">Parse</span><span class="op" id="7336739">(</span><span class="ident" id="7336740">backend</span><span class="op" id="7336747">.</span><span class="ident" id="7336748">URL</span>&nbsp;<span class="op" id="7336752">+</span>&nbsp;<span class="ident" id="7336754">tt</span><span class="op" id="7336756">.</span><span class="ident" id="7336757">baseSuffix</span><span class="op" id="7336767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7336771">if</span>&nbsp;<span class="ident" id="7336774">err</span>&nbsp;<span class="op" id="7336778">!=</span>&nbsp;<span class="ident" id="7336781">nil</span>&nbsp;<span class="op" id="7336785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336790">t</span><span class="op" id="7336791">.</span><span class="ident" id="7336792">Fatal</span><span class="op" id="7336797">(</span><span class="ident" id="7336798">err</span><span class="op" id="7336801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7336805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336809">frontend</span>&nbsp;<span class="op" id="7336818">:=</span>&nbsp;<span class="ident" id="7336821">httptest</span><span class="op" id="7336829">.</span><span class="ident" id="7336830">NewServer</span><span class="op" id="7336839">(</span><span class="ident" id="7336840">NewSingleHostReverseProxy</span><span class="op" id="7336865">(</span><span class="ident" id="7336866">backendURL</span><span class="op" id="7336876">)</span><span class="op" id="7336877">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336881">req</span><span class="op" id="7336884">,</span>&nbsp;<span class="ident" id="7336886">_</span>&nbsp;<span class="op" id="7336888">:=</span>&nbsp;<span class="ident" id="7336891">http</span><span class="op" id="7336895">.</span><span class="ident" id="7336896">NewRequest</span><span class="op" id="7336906">(</span><span class="string" id="7336907">&#34;GET&#34;</span><span class="op" id="7336912">,</span>&nbsp;<span class="ident" id="7336914">frontend</span><span class="op" id="7336922">.</span><span class="ident" id="7336923">URL</span><span class="op" id="7336926">+</span><span class="ident" id="7336927">tt</span><span class="op" id="7336929">.</span><span class="ident" id="7336930">reqSuffix</span><span class="op" id="7336939">,</span>&nbsp;<span class="ident" id="7336941">nil</span><span class="op" id="7336944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336948">req</span><span class="op" id="7336951">.</span><span class="ident" id="7336952">Close</span>&nbsp;<span class="op" id="7336958">=</span>&nbsp;<span class="builtintype" id="7336960">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7336967">res</span><span class="op" id="7336970">,</span>&nbsp;<span class="ident" id="7336972">err</span>&nbsp;<span class="op" id="7336976">:=</span>&nbsp;<span class="ident" id="7336979">http</span><span class="op" id="7336983">.</span><span class="ident" id="7336984">DefaultClient</span><span class="op" id="7336997">.</span><span class="ident" id="7336998">Do</span><span class="op" id="7337000">(</span><span class="ident" id="7337001">req</span><span class="op" id="7337004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337008">if</span>&nbsp;<span class="ident" id="7337011">err</span>&nbsp;<span class="op" id="7337015">!=</span>&nbsp;<span class="ident" id="7337018">nil</span>&nbsp;<span class="op" id="7337022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337027">t</span><span class="op" id="7337028">.</span><span class="ident" id="7337029">Fatalf</span><span class="op" id="7337035">(</span><span class="string" id="7337036">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7337049">,</span>&nbsp;<span class="ident" id="7337051">i</span><span class="op" id="7337052">,</span>&nbsp;<span class="ident" id="7337054">err</span><span class="op" id="7337057">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7337061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337065">if</span>&nbsp;<span class="ident" id="7337068">g</span><span class="op" id="7337069">,</span>&nbsp;<span class="ident" id="7337071">e</span>&nbsp;<span class="op" id="7337073">:=</span>&nbsp;<span class="ident" id="7337076">res</span><span class="op" id="7337079">.</span><span class="ident" id="7337080">Header</span><span class="op" id="7337086">.</span><span class="ident" id="7337087">Get</span><span class="op" id="7337090">(</span><span class="string" id="7337091">&#34;X-Got-Query&#34;</span><span class="op" id="7337104">)</span><span class="op" id="7337105">,</span>&nbsp;<span class="ident" id="7337107">tt</span><span class="op" id="7337109">.</span><span class="ident" id="7337110">want</span><span class="op" id="7337114">;</span>&nbsp;<span class="ident" id="7337116">g</span>&nbsp;<span class="op" id="7337118">!=</span>&nbsp;<span class="ident" id="7337121">e</span>&nbsp;<span class="op" id="7337123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337128">t</span><span class="op" id="7337129">.</span><span class="ident" id="7337130">Errorf</span><span class="op" id="7337136">(</span><span class="string" id="7337137">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7337168">,</span>&nbsp;<span class="ident" id="7337170">i</span><span class="op" id="7337171">,</span>&nbsp;<span class="ident" id="7337173">g</span><span class="op" id="7337174">,</span>&nbsp;<span class="ident" id="7337176">e</span><span class="op" id="7337177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7337181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337185">res</span><span class="op" id="7337188">.</span><span class="ident" id="7337189">Body</span><span class="op" id="7337193">.</span><span class="ident" id="7337194">Close</span><span class="op" id="7337199">(</span><span class="op" id="7337200">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337204">frontend</span><span class="op" id="7337212">.</span><span class="ident" id="7337213">Close</span><span class="op" id="7337218">(</span><span class="op" id="7337219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7337222">}</span><br>
<span class="lineno"></span><span class="op" id="7337224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7337227">func</span>&nbsp;<span class="ident" id="7337232">TestReverseProxyFlushInterval</span><span class="op" id="7337261">(</span><span class="ident" id="7337262">t</span>&nbsp;<span class="op" id="7337264">*</span><span class="ident" id="7337265">testing</span><span class="op" id="7337272">.</span><span class="ident" id="7337273">T</span><span class="op" id="7337274">)</span>&nbsp;<span class="op" id="7337276">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337279">const</span>&nbsp;<span class="ident" id="7337285">expected</span>&nbsp;<span class="op" id="7337294">=</span>&nbsp;<span class="string" id="7337296">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337302">backend</span>&nbsp;<span class="op" id="7337310">:=</span>&nbsp;<span class="ident" id="7337313">httptest</span><span class="op" id="7337321">.</span><span class="ident" id="7337322">NewServer</span><span class="op" id="7337331">(</span><span class="ident" id="7337332">http</span><span class="op" id="7337336">.</span><span class="ident" id="7337337">HandlerFunc</span><span class="op" id="7337348">(</span><span class="keyword" id="7337349">func</span><span class="op" id="7337353">(</span><span class="ident" id="7337354">w</span>&nbsp;<span class="ident" id="7337356">http</span><span class="op" id="7337360">.</span><span class="ident" id="7337361">ResponseWriter</span><span class="op" id="7337375">,</span>&nbsp;<span class="ident" id="7337377">r</span>&nbsp;<span class="op" id="7337379">*</span><span class="ident" id="7337380">http</span><span class="op" id="7337384">.</span><span class="ident" id="7337385">Request</span><span class="op" id="7337392">)</span>&nbsp;<span class="op" id="7337394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337398">w</span><span class="op" id="7337399">.</span><span class="ident" id="7337400">Write</span><span class="op" id="7337405">(</span><span class="op" id="7337406">[</span><span class="op" id="7337407">]</span><span class="builtintype" id="7337408">byte</span><span class="op" id="7337412">(</span><span class="ident" id="7337413">expected</span><span class="op" id="7337421">)</span><span class="op" id="7337422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7337425">}</span><span class="op" id="7337426">)</span><span class="op" id="7337427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337430">defer</span>&nbsp;<span class="ident" id="7337436">backend</span><span class="op" id="7337443">.</span><span class="ident" id="7337444">Close</span><span class="op" id="7337449">(</span><span class="op" id="7337450">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337454">backendURL</span><span class="op" id="7337464">,</span>&nbsp;<span class="ident" id="7337466">err</span>&nbsp;<span class="op" id="7337470">:=</span>&nbsp;<span class="ident" id="7337473">url</span><span class="op" id="7337476">.</span><span class="ident" id="7337477">Parse</span><span class="op" id="7337482">(</span><span class="ident" id="7337483">backend</span><span class="op" id="7337490">.</span><span class="ident" id="7337491">URL</span><span class="op" id="7337494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337497">if</span>&nbsp;<span class="ident" id="7337500">err</span>&nbsp;<span class="op" id="7337504">!=</span>&nbsp;<span class="ident" id="7337507">nil</span>&nbsp;<span class="op" id="7337511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337515">t</span><span class="op" id="7337516">.</span><span class="ident" id="7337517">Fatal</span><span class="op" id="7337522">(</span><span class="ident" id="7337523">err</span><span class="op" id="7337526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7337529">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337533">proxyHandler</span>&nbsp;<span class="op" id="7337546">:=</span>&nbsp;<span class="ident" id="7337549">NewSingleHostReverseProxy</span><span class="op" id="7337574">(</span><span class="ident" id="7337575">backendURL</span><span class="op" id="7337585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337588">proxyHandler</span><span class="op" id="7337600">.</span><span class="ident" id="7337601">FlushInterval</span>&nbsp;<span class="op" id="7337615">=</span>&nbsp;<span class="ident" id="7337617">time</span><span class="op" id="7337621">.</span><span class="ident" id="7337622">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337636">done</span>&nbsp;<span class="op" id="7337641">:=</span>&nbsp;<span class="builtinfunc" id="7337644">make</span><span class="op" id="7337648">(</span><span class="keyword" id="7337649">chan</span>&nbsp;<span class="builtintype" id="7337654">bool</span><span class="op" id="7337658">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337661">onExitFlushLoop</span>&nbsp;<span class="op" id="7337677">=</span>&nbsp;<span class="keyword" id="7337679">func</span><span class="op" id="7337683">(</span><span class="op" id="7337684">)</span>&nbsp;<span class="op" id="7337686">{</span>&nbsp;<span class="ident" id="7337688">done</span>&nbsp;<span class="op" id="7337693">&lt;-</span>&nbsp;<span class="builtintype" id="7337696">true</span>&nbsp;<span class="op" id="7337701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337704">defer</span>&nbsp;<span class="keyword" id="7337710">func</span><span class="op" id="7337714">(</span><span class="op" id="7337715">)</span>&nbsp;<span class="op" id="7337717">{</span>&nbsp;<span class="ident" id="7337719">onExitFlushLoop</span>&nbsp;<span class="op" id="7337735">=</span>&nbsp;<span class="ident" id="7337737">nil</span>&nbsp;<span class="op" id="7337741">}</span><span class="op" id="7337742">(</span><span class="op" id="7337743">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337747">frontend</span>&nbsp;<span class="op" id="7337756">:=</span>&nbsp;<span class="ident" id="7337759">httptest</span><span class="op" id="7337767">.</span><span class="ident" id="7337768">NewServer</span><span class="op" id="7337777">(</span><span class="ident" id="7337778">proxyHandler</span><span class="op" id="7337790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337793">defer</span>&nbsp;<span class="ident" id="7337799">frontend</span><span class="op" id="7337807">.</span><span class="ident" id="7337808">Close</span><span class="op" id="7337813">(</span><span class="op" id="7337814">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337818">req</span><span class="op" id="7337821">,</span>&nbsp;<span class="ident" id="7337823">_</span>&nbsp;<span class="op" id="7337825">:=</span>&nbsp;<span class="ident" id="7337828">http</span><span class="op" id="7337832">.</span><span class="ident" id="7337833">NewRequest</span><span class="op" id="7337843">(</span><span class="string" id="7337844">&#34;GET&#34;</span><span class="op" id="7337849">,</span>&nbsp;<span class="ident" id="7337851">frontend</span><span class="op" id="7337859">.</span><span class="ident" id="7337860">URL</span><span class="op" id="7337863">,</span>&nbsp;<span class="ident" id="7337865">nil</span><span class="op" id="7337868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337871">req</span><span class="op" id="7337874">.</span><span class="ident" id="7337875">Close</span>&nbsp;<span class="op" id="7337881">=</span>&nbsp;<span class="builtintype" id="7337883">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337889">res</span><span class="op" id="7337892">,</span>&nbsp;<span class="ident" id="7337894">err</span>&nbsp;<span class="op" id="7337898">:=</span>&nbsp;<span class="ident" id="7337901">http</span><span class="op" id="7337905">.</span><span class="ident" id="7337906">DefaultClient</span><span class="op" id="7337919">.</span><span class="ident" id="7337920">Do</span><span class="op" id="7337922">(</span><span class="ident" id="7337923">req</span><span class="op" id="7337926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337929">if</span>&nbsp;<span class="ident" id="7337932">err</span>&nbsp;<span class="op" id="7337936">!=</span>&nbsp;<span class="ident" id="7337939">nil</span>&nbsp;<span class="op" id="7337943">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7337947">t</span><span class="op" id="7337948">.</span><span class="ident" id="7337949">Fatalf</span><span class="op" id="7337955">(</span><span class="string" id="7337956">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7337965">,</span>&nbsp;<span class="ident" id="7337967">err</span><span class="op" id="7337970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7337973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7337976">defer</span>&nbsp;<span class="ident" id="7337982">res</span><span class="op" id="7337985">.</span><span class="ident" id="7337986">Body</span><span class="op" id="7337990">.</span><span class="ident" id="7337991">Close</span><span class="op" id="7337996">(</span><span class="op" id="7337997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7338000">if</span>&nbsp;<span class="ident" id="7338003">bodyBytes</span><span class="op" id="7338012">,</span>&nbsp;<span class="ident" id="7338014">_</span>&nbsp;<span class="op" id="7338016">:=</span>&nbsp;<span class="ident" id="7338019">ioutil</span><span class="op" id="7338025">.</span><span class="ident" id="7338026">ReadAll</span><span class="op" id="7338033">(</span><span class="ident" id="7338034">res</span><span class="op" id="7338037">.</span><span class="ident" id="7338038">Body</span><span class="op" id="7338042">)</span><span class="op" id="7338043">;</span>&nbsp;<span class="builtintype" id="7338045">string</span><span class="op" id="7338051">(</span><span class="ident" id="7338052">bodyBytes</span><span class="op" id="7338061">)</span>&nbsp;<span class="op" id="7338063">!=</span>&nbsp;<span class="ident" id="7338066">expected</span>&nbsp;<span class="op" id="7338075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7338079">t</span><span class="op" id="7338080">.</span><span class="ident" id="7338081">Errorf</span><span class="op" id="7338087">(</span><span class="string" id="7338088">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7338114">,</span>&nbsp;<span class="ident" id="7338116">bodyBytes</span><span class="op" id="7338125">,</span>&nbsp;<span class="ident" id="7338127">expected</span><span class="op" id="7338135">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7338138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7338142">select</span>&nbsp;<span class="op" id="7338149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7338152">case</span>&nbsp;<span class="op" id="7338157">&lt;-</span><span class="ident" id="7338159">done</span><span class="op" id="7338163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7338167">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7338174">case</span>&nbsp;<span class="op" id="7338179">&lt;-</span><span class="ident" id="7338181">time</span><span class="op" id="7338185">.</span><span class="ident" id="7338186">After</span><span class="op" id="7338191">(</span><span class="num" id="7338192">5</span>&nbsp;<span class="op" id="7338194">*</span>&nbsp;<span class="ident" id="7338196">time</span><span class="op" id="7338200">.</span><span class="ident" id="7338201">Second</span><span class="op" id="7338207">)</span><span class="op" id="7338208">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7338212">t</span><span class="op" id="7338213">.</span><span class="ident" id="7338214">Error</span><span class="op" id="7338219">(</span><span class="string" id="7338220">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7338263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7338266">}</span><br>
<span class="lineno"></span><span class="op" id="7338268">}</span>
</div>
</body>
</html>
