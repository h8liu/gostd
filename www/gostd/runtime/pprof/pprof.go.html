<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/pprof</h2>
<ul>
<li><a href="/gostd/runtime/pprof/mprof_test.go.html">mprof_test.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof.go.html">pprof.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof_test.go.html">pprof_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5862070">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5862126">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5862180">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5862231">//&nbsp;Package&nbsp;pprof&nbsp;writes&nbsp;runtime&nbsp;profiling&nbsp;data&nbsp;in&nbsp;the&nbsp;format&nbsp;expected</span><br>
<span class="lineno"></span><span class="comment" id="5862301">//&nbsp;by&nbsp;the&nbsp;pprof&nbsp;visualization&nbsp;tool.</span><br>
<span class="lineno"></span><span class="comment" id="5862337">//&nbsp;For&nbsp;more&nbsp;information&nbsp;about&nbsp;pprof,&nbsp;see</span><br>
<span class="lineno"></span><span class="comment" id="5862378">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="keyword" id="5862425">package</span>&nbsp;<span class="ident" id="5862433">pprof</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5862440">import</span>&nbsp;<span class="op" id="5862447">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862450">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862459">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862468">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862475">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862481">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862492">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862500">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862511">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5862519">&#34;text/tabwriter&#34;</span><br>
<span class="lineno"></span><span class="op" id="5862536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5862539">//&nbsp;BUG(rsc):&nbsp;Profiles&nbsp;are&nbsp;incomplete&nbsp;and&nbsp;inaccurate&nbsp;on&nbsp;NetBSD&nbsp;and&nbsp;OS&nbsp;X.</span><br>
<span class="lineno"></span><span class="comment" id="5862611">//&nbsp;See&nbsp;http://golang.org/issue/6047&nbsp;for&nbsp;details.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="5862661">//&nbsp;A&nbsp;Profile&nbsp;is&nbsp;a&nbsp;collection&nbsp;of&nbsp;stack&nbsp;traces&nbsp;showing&nbsp;the&nbsp;call&nbsp;sequences</span><br>
<span class="lineno"></span><span class="comment" id="5862733">//&nbsp;that&nbsp;led&nbsp;to&nbsp;instances&nbsp;of&nbsp;a&nbsp;particular&nbsp;event,&nbsp;such&nbsp;as&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="comment" id="5862801">//&nbsp;Packages&nbsp;can&nbsp;create&nbsp;and&nbsp;maintain&nbsp;their&nbsp;own&nbsp;profiles;&nbsp;the&nbsp;most&nbsp;common</span><br>
<span class="lineno"></span><span class="comment" id="5862873">//&nbsp;use&nbsp;is&nbsp;for&nbsp;tracking&nbsp;resources&nbsp;that&nbsp;must&nbsp;be&nbsp;explicitly&nbsp;closed,&nbsp;such&nbsp;as&nbsp;files</span><br>
<span class="lineno">30</span><span class="comment" id="5862952">//&nbsp;or&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="5862979">//</span><br>
<span class="lineno"></span><span class="comment" id="5862982">//&nbsp;A&nbsp;Profile&#39;s&nbsp;methods&nbsp;can&nbsp;be&nbsp;called&nbsp;from&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="5863060">//</span><br>
<span class="lineno"></span><span class="comment" id="5863063">//&nbsp;Each&nbsp;Profile&nbsp;has&nbsp;a&nbsp;unique&nbsp;name.&nbsp;&nbsp;A&nbsp;few&nbsp;profiles&nbsp;are&nbsp;predefined:</span><br>
<span class="lineno">35</span><span class="comment" id="5863130">//</span><br>
<span class="lineno"></span><span class="comment" id="5863133">//&nbsp;&nbsp;&nbsp;&nbspgoroutine&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;current&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5863190">//&nbsp;&nbsp;&nbsp;&nbspheap&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;a&nbsp;sampling&nbsp;of&nbsp;all&nbsp;heap&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="5863243">//&nbsp;&nbsp;&nbsp;&nbspthreadcreate&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;the&nbsp;creation&nbsp;of&nbsp;new&nbsp;OS&nbsp;threads</span><br>
<span class="lineno"></span><span class="comment" id="5863317">//&nbsp;&nbsp;&nbsp;&nbspblock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;blocking&nbsp;on&nbsp;synchronization&nbsp;primitives</span><br>
<span class="lineno">40</span><span class="comment" id="5863399">//</span><br>
<span class="lineno"></span><span class="comment" id="5863402">//&nbsp;These&nbsp;predefined&nbsp;profiles&nbsp;maintain&nbsp;themselves&nbsp;and&nbsp;panic&nbsp;on&nbsp;an&nbsp;explicit</span><br>
<span class="lineno"></span><span class="comment" id="5863476">//&nbsp;Add&nbsp;or&nbsp;Remove&nbsp;method&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="5863506">//</span><br>
<span class="lineno"></span><span class="comment" id="5863509">//&nbsp;The&nbsp;CPU&nbsp;profile&nbsp;is&nbsp;not&nbsp;available&nbsp;as&nbsp;a&nbsp;Profile.&nbsp;&nbsp;It&nbsp;has&nbsp;a&nbsp;special&nbsp;API,</span><br>
<span class="lineno">45</span><span class="comment" id="5863582">//&nbsp;the&nbsp;StartCPUProfile&nbsp;and&nbsp;StopCPUProfile&nbsp;functions,&nbsp;because&nbsp;it&nbsp;streams</span><br>
<span class="lineno"></span><span class="comment" id="5863654">//&nbsp;output&nbsp;to&nbsp;a&nbsp;writer&nbsp;during&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="5863694">//</span><br>
<span class="lineno"></span><span class="keyword" id="5863697">type</span>&nbsp;<span class="ident" id="5863702">Profile</span>&nbsp;<span class="keyword" id="5863710">struct</span>&nbsp;<span class="op" id="5863717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863720">name</span>&nbsp;&nbsp;<span class="builtintype" id="5863726">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863734">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5863740">sync</span><span class="op" id="5863744">.</span><span class="ident" id="5863745">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863752">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5863758">map</span><span class="op" id="5863761">[</span><span class="keyword" id="5863762">interface</span><span class="op" id="5863771">{</span><span class="op" id="5863772">}</span><span class="op" id="5863773">]</span><span class="op" id="5863774">[</span><span class="op" id="5863775">]</span><span class="builtintype" id="5863776">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863785">count</span>&nbsp;<span class="keyword" id="5863791">func</span><span class="op" id="5863795">(</span><span class="op" id="5863796">)</span>&nbsp;<span class="builtintype" id="5863798">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863803">write</span>&nbsp;<span class="keyword" id="5863809">func</span><span class="op" id="5863813">(</span><span class="ident" id="5863814">io</span><span class="op" id="5863816">.</span><span class="ident" id="5863817">Writer</span><span class="op" id="5863823">,</span>&nbsp;<span class="builtintype" id="5863825">int</span><span class="op" id="5863828">)</span>&nbsp;<span class="builtintype" id="5863830">error</span><br>
<span class="lineno"></span><span class="op" id="5863836">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="5863839">//&nbsp;profiles&nbsp;records&nbsp;all&nbsp;registered&nbsp;profiles.</span><br>
<span class="lineno"></span><span class="keyword" id="5863884">var</span>&nbsp;<span class="ident" id="5863888">profiles</span>&nbsp;<span class="keyword" id="5863897">struct</span>&nbsp;<span class="op" id="5863904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863907">mu</span>&nbsp;<span class="ident" id="5863910">sync</span><span class="op" id="5863914">.</span><span class="ident" id="5863915">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863922">m</span>&nbsp;&nbsp;<span class="keyword" id="5863925">map</span><span class="op" id="5863928">[</span><span class="builtintype" id="5863929">string</span><span class="op" id="5863935">]</span><span class="op" id="5863936">*</span><span class="ident" id="5863937">Profile</span><br>
<span class="lineno">60</span><span class="op" id="5863945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5863948">var</span>&nbsp;<span class="ident" id="5863952">goroutineProfile</span>&nbsp;<span class="op" id="5863969">=</span>&nbsp;<span class="op" id="5863971">&amp;</span><span class="ident" id="5863972">Profile</span><span class="op" id="5863979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5863982">name</span><span class="op" id="5863986">:</span>&nbsp;&nbsp;<span class="string" id="5863989">&#34;goroutine&#34;</span><span class="op" id="5864000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864003">count</span><span class="op" id="5864008">:</span>&nbsp;<span class="ident" id="5864010">countGoroutine</span><span class="op" id="5864024">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864027">write</span><span class="op" id="5864032">:</span>&nbsp;<span class="ident" id="5864034">writeGoroutine</span><span class="op" id="5864048">,</span><br>
<span class="lineno"></span><span class="op" id="5864050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5864053">var</span>&nbsp;<span class="ident" id="5864057">threadcreateProfile</span>&nbsp;<span class="op" id="5864077">=</span>&nbsp;<span class="op" id="5864079">&amp;</span><span class="ident" id="5864080">Profile</span><span class="op" id="5864087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864090">name</span><span class="op" id="5864094">:</span>&nbsp;&nbsp;<span class="string" id="5864097">&#34;threadcreate&#34;</span><span class="op" id="5864111">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864114">count</span><span class="op" id="5864119">:</span>&nbsp;<span class="ident" id="5864121">countThreadCreate</span><span class="op" id="5864138">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864141">write</span><span class="op" id="5864146">:</span>&nbsp;<span class="ident" id="5864148">writeThreadCreate</span><span class="op" id="5864165">,</span><br>
<span class="lineno"></span><span class="op" id="5864167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5864170">var</span>&nbsp;<span class="ident" id="5864174">heapProfile</span>&nbsp;<span class="op" id="5864186">=</span>&nbsp;<span class="op" id="5864188">&amp;</span><span class="ident" id="5864189">Profile</span><span class="op" id="5864196">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864199">name</span><span class="op" id="5864203">:</span>&nbsp;&nbsp;<span class="string" id="5864206">&#34;heap&#34;</span><span class="op" id="5864212">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864215">count</span><span class="op" id="5864220">:</span>&nbsp;<span class="ident" id="5864222">countHeap</span><span class="op" id="5864231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864234">write</span><span class="op" id="5864239">:</span>&nbsp;<span class="ident" id="5864241">writeHeap</span><span class="op" id="5864250">,</span><br>
<span class="lineno"></span><span class="op" id="5864252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5864255">var</span>&nbsp;<span class="ident" id="5864259">blockProfile</span>&nbsp;<span class="op" id="5864272">=</span>&nbsp;<span class="op" id="5864274">&amp;</span><span class="ident" id="5864275">Profile</span><span class="op" id="5864282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864285">name</span><span class="op" id="5864289">:</span>&nbsp;&nbsp;<span class="string" id="5864292">&#34;block&#34;</span><span class="op" id="5864299">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864302">count</span><span class="op" id="5864307">:</span>&nbsp;<span class="ident" id="5864309">countBlock</span><span class="op" id="5864319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864322">write</span><span class="op" id="5864327">:</span>&nbsp;<span class="ident" id="5864329">writeBlock</span><span class="op" id="5864339">,</span><br>
<span class="lineno"></span><span class="op" id="5864341">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5864344">func</span>&nbsp;<span class="ident" id="5864349">lockProfiles</span><span class="op" id="5864361">(</span><span class="op" id="5864362">)</span>&nbsp;<span class="op" id="5864364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864367">profiles</span><span class="op" id="5864375">.</span><span class="ident" id="5864376">mu</span><span class="op" id="5864378">.</span><span class="ident" id="5864379">Lock</span><span class="op" id="5864383">(</span><span class="op" id="5864384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864387">if</span>&nbsp;<span class="ident" id="5864390">profiles</span><span class="op" id="5864398">.</span><span class="ident" id="5864399">m</span>&nbsp;<span class="op" id="5864401">==</span>&nbsp;<span class="ident" id="5864404">nil</span>&nbsp;<span class="op" id="5864408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5864412">//&nbsp;Initial&nbsp;built-in&nbsp;profiles.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864444">profiles</span><span class="op" id="5864452">.</span><span class="ident" id="5864453">m</span>&nbsp;<span class="op" id="5864455">=</span>&nbsp;<span class="keyword" id="5864457">map</span><span class="op" id="5864460">[</span><span class="builtintype" id="5864461">string</span><span class="op" id="5864467">]</span><span class="op" id="5864468">*</span><span class="ident" id="5864469">Profile</span><span class="op" id="5864476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5864481">&#34;goroutine&#34;</span><span class="op" id="5864492">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5864497">goroutineProfile</span><span class="op" id="5864513">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5864518">&#34;threadcreate&#34;</span><span class="op" id="5864532">:</span>&nbsp;<span class="ident" id="5864534">threadcreateProfile</span><span class="op" id="5864553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5864558">&#34;heap&#34;</span><span class="op" id="5864564">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5864574">heapProfile</span><span class="op" id="5864585">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5864590">&#34;block&#34;</span><span class="op" id="5864597">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5864606">blockProfile</span><span class="op" id="5864618">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5864625">}</span><br>
<span class="lineno"></span><span class="op" id="5864627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5864630">func</span>&nbsp;<span class="ident" id="5864635">unlockProfiles</span><span class="op" id="5864649">(</span><span class="op" id="5864650">)</span>&nbsp;<span class="op" id="5864652">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864655">profiles</span><span class="op" id="5864663">.</span><span class="ident" id="5864664">mu</span><span class="op" id="5864666">.</span><span class="ident" id="5864667">Unlock</span><span class="op" id="5864673">(</span><span class="op" id="5864674">)</span><br>
<span class="lineno"></span><span class="op" id="5864676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5864679">//&nbsp;NewProfile&nbsp;creates&nbsp;a&nbsp;new&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5864736">//&nbsp;If&nbsp;a&nbsp;profile&nbsp;with&nbsp;that&nbsp;name&nbsp;already&nbsp;exists,&nbsp;NewProfile&nbsp;panics.</span><br>
<span class="lineno">105</span><span class="comment" id="5864802">//&nbsp;The&nbsp;convention&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;&#39;import/path.&#39;&nbsp;prefix&nbsp;to&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5864864">//&nbsp;separate&nbsp;name&nbsp;spaces&nbsp;for&nbsp;each&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5864906">func</span>&nbsp;<span class="ident" id="5864911">NewProfile</span><span class="op" id="5864921">(</span><span class="ident" id="5864922">name</span>&nbsp;<span class="builtintype" id="5864927">string</span><span class="op" id="5864933">)</span>&nbsp;<span class="op" id="5864935">*</span><span class="ident" id="5864936">Profile</span>&nbsp;<span class="op" id="5864944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5864947">lockProfiles</span><span class="op" id="5864959">(</span><span class="op" id="5864960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864963">defer</span>&nbsp;<span class="ident" id="5864969">unlockProfiles</span><span class="op" id="5864983">(</span><span class="op" id="5864984">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5864987">if</span>&nbsp;<span class="ident" id="5864990">name</span>&nbsp;<span class="op" id="5864995">==</span>&nbsp;<span class="string" id="5864998">&#34;&#34;</span>&nbsp;<span class="op" id="5865001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5865005">panic</span><span class="op" id="5865010">(</span><span class="string" id="5865011">&#34;pprof:&nbsp;NewProfile&nbsp;with&nbsp;empty&nbsp;name&#34;</span><span class="op" id="5865046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865052">if</span>&nbsp;<span class="ident" id="5865055">profiles</span><span class="op" id="5865063">.</span><span class="ident" id="5865064">m</span><span class="op" id="5865065">[</span><span class="ident" id="5865066">name</span><span class="op" id="5865070">]</span>&nbsp;<span class="op" id="5865072">!=</span>&nbsp;<span class="ident" id="5865075">nil</span>&nbsp;<span class="op" id="5865079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5865083">panic</span><span class="op" id="5865088">(</span><span class="string" id="5865089">&#34;pprof:&nbsp;NewProfile&nbsp;name&nbsp;already&nbsp;in&nbsp;use:&nbsp;&#34;</span>&nbsp;<span class="op" id="5865131">+</span>&nbsp;<span class="ident" id="5865133">name</span><span class="op" id="5865137">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865143">p</span>&nbsp;<span class="op" id="5865145">:=</span>&nbsp;<span class="op" id="5865148">&amp;</span><span class="ident" id="5865149">Profile</span><span class="op" id="5865156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865160">name</span><span class="op" id="5865164">:</span>&nbsp;<span class="ident" id="5865166">name</span><span class="op" id="5865170">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865174">m</span><span class="op" id="5865175">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865180">map</span><span class="op" id="5865183">[</span><span class="keyword" id="5865184">interface</span><span class="op" id="5865193">{</span><span class="op" id="5865194">}</span><span class="op" id="5865195">]</span><span class="op" id="5865196">[</span><span class="op" id="5865197">]</span><span class="builtintype" id="5865198">uintptr</span><span class="op" id="5865205">{</span><span class="op" id="5865206">}</span><span class="op" id="5865207">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865210">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865213">profiles</span><span class="op" id="5865221">.</span><span class="ident" id="5865222">m</span><span class="op" id="5865223">[</span><span class="ident" id="5865224">name</span><span class="op" id="5865228">]</span>&nbsp;<span class="op" id="5865230">=</span>&nbsp;<span class="ident" id="5865232">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865235">return</span>&nbsp;<span class="ident" id="5865242">p</span><br>
<span class="lineno"></span><span class="op" id="5865244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5865247">//&nbsp;Lookup&nbsp;returns&nbsp;the&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name,&nbsp;or&nbsp;nil&nbsp;if&nbsp;no&nbsp;such&nbsp;profile&nbsp;exists.</span><br>
<span class="lineno">125</span><span class="keyword" id="5865332">func</span>&nbsp;<span class="ident" id="5865337">Lookup</span><span class="op" id="5865343">(</span><span class="ident" id="5865344">name</span>&nbsp;<span class="builtintype" id="5865349">string</span><span class="op" id="5865355">)</span>&nbsp;<span class="op" id="5865357">*</span><span class="ident" id="5865358">Profile</span>&nbsp;<span class="op" id="5865366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865369">lockProfiles</span><span class="op" id="5865381">(</span><span class="op" id="5865382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865385">defer</span>&nbsp;<span class="ident" id="5865391">unlockProfiles</span><span class="op" id="5865405">(</span><span class="op" id="5865406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865409">return</span>&nbsp;<span class="ident" id="5865416">profiles</span><span class="op" id="5865424">.</span><span class="ident" id="5865425">m</span><span class="op" id="5865426">[</span><span class="ident" id="5865427">name</span><span class="op" id="5865431">]</span><br>
<span class="lineno"></span><span class="op" id="5865433">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5865436">//&nbsp;Profiles&nbsp;returns&nbsp;a&nbsp;slice&nbsp;of&nbsp;all&nbsp;the&nbsp;known&nbsp;profiles,&nbsp;sorted&nbsp;by&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="5865507">func</span>&nbsp;<span class="ident" id="5865512">Profiles</span><span class="op" id="5865520">(</span><span class="op" id="5865521">)</span>&nbsp;<span class="op" id="5865523">[</span><span class="op" id="5865524">]</span><span class="op" id="5865525">*</span><span class="ident" id="5865526">Profile</span>&nbsp;<span class="op" id="5865534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865537">lockProfiles</span><span class="op" id="5865549">(</span><span class="op" id="5865550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865553">defer</span>&nbsp;<span class="ident" id="5865559">unlockProfiles</span><span class="op" id="5865573">(</span><span class="op" id="5865574">)</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865578">var</span>&nbsp;<span class="ident" id="5865582">all</span>&nbsp;<span class="op" id="5865586">[</span><span class="op" id="5865587">]</span><span class="op" id="5865588">*</span><span class="ident" id="5865589">Profile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865598">for</span>&nbsp;<span class="ident" id="5865602">_</span><span class="op" id="5865603">,</span>&nbsp;<span class="ident" id="5865605">p</span>&nbsp;<span class="op" id="5865607">:=</span>&nbsp;<span class="keyword" id="5865610">range</span>&nbsp;<span class="ident" id="5865616">profiles</span><span class="op" id="5865624">.</span><span class="ident" id="5865625">m</span>&nbsp;<span class="op" id="5865627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865631">all</span>&nbsp;<span class="op" id="5865635">=</span>&nbsp;<span class="builtinfunc" id="5865637">append</span><span class="op" id="5865643">(</span><span class="ident" id="5865644">all</span><span class="op" id="5865647">,</span>&nbsp;<span class="ident" id="5865649">p</span><span class="op" id="5865650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5865653">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5865657">sort</span><span class="op" id="5865661">.</span><span class="ident" id="5865662">Sort</span><span class="op" id="5865666">(</span><span class="ident" id="5865667">byName</span><span class="op" id="5865673">(</span><span class="ident" id="5865674">all</span><span class="op" id="5865677">)</span><span class="op" id="5865678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5865681">return</span>&nbsp;<span class="ident" id="5865688">all</span><br>
<span class="lineno"></span><span class="op" id="5865692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5865695">type</span>&nbsp;<span class="ident" id="5865700">byName</span>&nbsp;<span class="op" id="5865707">[</span><span class="op" id="5865708">]</span><span class="op" id="5865709">*</span><span class="ident" id="5865710">Profile</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5865719">func</span>&nbsp;<span class="op" id="5865724">(</span><span class="ident" id="5865725">x</span>&nbsp;<span class="ident" id="5865727">byName</span><span class="op" id="5865733">)</span>&nbsp;<span class="ident" id="5865735">Len</span><span class="op" id="5865738">(</span><span class="op" id="5865739">)</span>&nbsp;<span class="builtintype" id="5865741">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5865755">{</span>&nbsp;<span class="keyword" id="5865757">return</span>&nbsp;<span class="builtinfunc" id="5865764">len</span><span class="op" id="5865767">(</span><span class="ident" id="5865768">x</span><span class="op" id="5865769">)</span>&nbsp;<span class="op" id="5865771">}</span><br>
<span class="lineno"></span><span class="keyword" id="5865773">func</span>&nbsp;<span class="op" id="5865778">(</span><span class="ident" id="5865779">x</span>&nbsp;<span class="ident" id="5865781">byName</span><span class="op" id="5865787">)</span>&nbsp;<span class="ident" id="5865789">Swap</span><span class="op" id="5865793">(</span><span class="ident" id="5865794">i</span><span class="op" id="5865795">,</span>&nbsp;<span class="ident" id="5865797">j</span>&nbsp;<span class="builtintype" id="5865799">int</span><span class="op" id="5865802">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5865809">{</span>&nbsp;<span class="ident" id="5865811">x</span><span class="op" id="5865812">[</span><span class="ident" id="5865813">i</span><span class="op" id="5865814">]</span><span class="op" id="5865815">,</span>&nbsp;<span class="ident" id="5865817">x</span><span class="op" id="5865818">[</span><span class="ident" id="5865819">j</span><span class="op" id="5865820">]</span>&nbsp;<span class="op" id="5865822">=</span>&nbsp;<span class="ident" id="5865824">x</span><span class="op" id="5865825">[</span><span class="ident" id="5865826">j</span><span class="op" id="5865827">]</span><span class="op" id="5865828">,</span>&nbsp;<span class="ident" id="5865830">x</span><span class="op" id="5865831">[</span><span class="ident" id="5865832">i</span><span class="op" id="5865833">]</span>&nbsp;<span class="op" id="5865835">}</span><br>
<span class="lineno"></span><span class="keyword" id="5865837">func</span>&nbsp;<span class="op" id="5865842">(</span><span class="ident" id="5865843">x</span>&nbsp;<span class="ident" id="5865845">byName</span><span class="op" id="5865851">)</span>&nbsp;<span class="ident" id="5865853">Less</span><span class="op" id="5865857">(</span><span class="ident" id="5865858">i</span><span class="op" id="5865859">,</span>&nbsp;<span class="ident" id="5865861">j</span>&nbsp;<span class="builtintype" id="5865863">int</span><span class="op" id="5865866">)</span>&nbsp;<span class="builtintype" id="5865868">bool</span>&nbsp;<span class="op" id="5865873">{</span>&nbsp;<span class="keyword" id="5865875">return</span>&nbsp;<span class="ident" id="5865882">x</span><span class="op" id="5865883">[</span><span class="ident" id="5865884">i</span><span class="op" id="5865885">]</span><span class="op" id="5865886">.</span><span class="ident" id="5865887">name</span>&nbsp;<span class="op" id="5865892">&lt;</span>&nbsp;<span class="ident" id="5865894">x</span><span class="op" id="5865895">[</span><span class="ident" id="5865896">j</span><span class="op" id="5865897">]</span><span class="op" id="5865898">.</span><span class="ident" id="5865899">name</span>&nbsp;<span class="op" id="5865904">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="5865907">//&nbsp;Name&nbsp;returns&nbsp;this&nbsp;profile&#39;s&nbsp;name,&nbsp;which&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;Lookup&nbsp;to&nbsp;reobtain&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5865999">func</span>&nbsp;<span class="op" id="5866004">(</span><span class="ident" id="5866005">p</span>&nbsp;<span class="op" id="5866007">*</span><span class="ident" id="5866008">Profile</span><span class="op" id="5866015">)</span>&nbsp;<span class="ident" id="5866017">Name</span><span class="op" id="5866021">(</span><span class="op" id="5866022">)</span>&nbsp;<span class="builtintype" id="5866024">string</span>&nbsp;<span class="op" id="5866031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866034">return</span>&nbsp;<span class="ident" id="5866041">p</span><span class="op" id="5866042">.</span><span class="ident" id="5866043">name</span><br>
<span class="lineno"></span><span class="op" id="5866048">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5866051">//&nbsp;Count&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;execution&nbsp;stacks&nbsp;currently&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5866125">func</span>&nbsp;<span class="op" id="5866130">(</span><span class="ident" id="5866131">p</span>&nbsp;<span class="op" id="5866133">*</span><span class="ident" id="5866134">Profile</span><span class="op" id="5866141">)</span>&nbsp;<span class="ident" id="5866143">Count</span><span class="op" id="5866148">(</span><span class="op" id="5866149">)</span>&nbsp;<span class="builtintype" id="5866151">int</span>&nbsp;<span class="op" id="5866155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5866158">p</span><span class="op" id="5866159">.</span><span class="ident" id="5866160">mu</span><span class="op" id="5866162">.</span><span class="ident" id="5866163">Lock</span><span class="op" id="5866167">(</span><span class="op" id="5866168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866171">defer</span>&nbsp;<span class="ident" id="5866177">p</span><span class="op" id="5866178">.</span><span class="ident" id="5866179">mu</span><span class="op" id="5866181">.</span><span class="ident" id="5866182">Unlock</span><span class="op" id="5866188">(</span><span class="op" id="5866189">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866192">if</span>&nbsp;<span class="ident" id="5866195">p</span><span class="op" id="5866196">.</span><span class="ident" id="5866197">count</span>&nbsp;<span class="op" id="5866203">!=</span>&nbsp;<span class="ident" id="5866206">nil</span>&nbsp;<span class="op" id="5866210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866214">return</span>&nbsp;<span class="ident" id="5866221">p</span><span class="op" id="5866222">.</span><span class="ident" id="5866223">count</span><span class="op" id="5866228">(</span><span class="op" id="5866229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5866232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5866235">return</span>&nbsp;<span class="builtinfunc" id="5866242">len</span><span class="op" id="5866245">(</span><span class="ident" id="5866246">p</span><span class="op" id="5866247">.</span><span class="ident" id="5866248">m</span><span class="op" id="5866249">)</span><br>
<span class="lineno"></span><span class="op" id="5866251">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5866254">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;current&nbsp;execution&nbsp;stack&nbsp;to&nbsp;the&nbsp;profile,&nbsp;associated&nbsp;with&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="5866333">//&nbsp;Add&nbsp;stores&nbsp;value&nbsp;in&nbsp;an&nbsp;internal&nbsp;map,&nbsp;so&nbsp;value&nbsp;must&nbsp;be&nbsp;suitable&nbsp;for&nbsp;use&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5866410">//&nbsp;a&nbsp;map&nbsp;key&nbsp;and&nbsp;will&nbsp;not&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;until&nbsp;the&nbsp;corresponding</span><br>
<span class="lineno"></span><span class="comment" id="5866481">//&nbsp;call&nbsp;to&nbsp;Remove.&nbsp;&nbsp;Add&nbsp;panics&nbsp;if&nbsp;the&nbsp;profile&nbsp;already&nbsp;contains&nbsp;a&nbsp;stack&nbsp;for&nbsp;value.</span><br>
<span class="lineno">170</span><span class="comment" id="5866563">//</span><br>
<span class="lineno"></span><span class="comment" id="5866566">//&nbsp;The&nbsp;skip&nbsp;parameter&nbsp;has&nbsp;the&nbsp;same&nbsp;meaning&nbsp;as&nbsp;runtime.Caller&#39;s&nbsp;skip</span><br>
<span class="lineno"></span><span class="comment" id="5866634">//&nbsp;and&nbsp;controls&nbsp;where&nbsp;the&nbsp;stack&nbsp;trace&nbsp;begins.&nbsp;&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5866707">//&nbsp;trace&nbsp;in&nbsp;the&nbsp;function&nbsp;calling&nbsp;Add.&nbsp;&nbsp;For&nbsp;example,&nbsp;given&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5866770">//&nbsp;execution&nbsp;stack:</span><br>
<span class="lineno">175</span><span class="comment" id="5866790">//</span><br>
<span class="lineno"></span><span class="comment" id="5866793">//&nbsp;&nbsp;&nbsp;&nbspAdd</span><br>
<span class="lineno"></span><span class="comment" id="5866800">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;rpc.NewClient</span><br>
<span class="lineno"></span><span class="comment" id="5866829">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;mypkg.Run</span><br>
<span class="lineno"></span><span class="comment" id="5866854">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;main.main</span><br>
<span class="lineno">180</span><span class="comment" id="5866879">//</span><br>
<span class="lineno"></span><span class="comment" id="5866882">//&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;Add&nbsp;inside&nbsp;rpc.NewClient.</span><br>
<span class="lineno"></span><span class="comment" id="5866964">//&nbsp;Passing&nbsp;skip=1&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;NewClient&nbsp;inside&nbsp;mypkg.Run.</span><br>
<span class="lineno"></span><span class="comment" id="5867048">//</span><br>
<span class="lineno"></span><span class="keyword" id="5867051">func</span>&nbsp;<span class="op" id="5867056">(</span><span class="ident" id="5867057">p</span>&nbsp;<span class="op" id="5867059">*</span><span class="ident" id="5867060">Profile</span><span class="op" id="5867067">)</span>&nbsp;<span class="ident" id="5867069">Add</span><span class="op" id="5867072">(</span><span class="ident" id="5867073">value</span>&nbsp;<span class="keyword" id="5867079">interface</span><span class="op" id="5867088">{</span><span class="op" id="5867089">}</span><span class="op" id="5867090">,</span>&nbsp;<span class="ident" id="5867092">skip</span>&nbsp;<span class="builtintype" id="5867097">int</span><span class="op" id="5867100">)</span>&nbsp;<span class="op" id="5867102">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867105">if</span>&nbsp;<span class="ident" id="5867108">p</span><span class="op" id="5867109">.</span><span class="ident" id="5867110">name</span>&nbsp;<span class="op" id="5867115">==</span>&nbsp;<span class="string" id="5867118">&#34;&#34;</span>&nbsp;<span class="op" id="5867121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5867125">panic</span><span class="op" id="5867130">(</span><span class="string" id="5867131">&#34;pprof:&nbsp;use&nbsp;of&nbsp;uninitialized&nbsp;Profile&#34;</span><span class="op" id="5867168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5867171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867174">if</span>&nbsp;<span class="ident" id="5867177">p</span><span class="op" id="5867178">.</span><span class="ident" id="5867179">write</span>&nbsp;<span class="op" id="5867185">!=</span>&nbsp;<span class="ident" id="5867188">nil</span>&nbsp;<span class="op" id="5867192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5867196">panic</span><span class="op" id="5867201">(</span><span class="string" id="5867202">&#34;pprof:&nbsp;Add&nbsp;called&nbsp;on&nbsp;built-in&nbsp;Profile&nbsp;&#34;</span>&nbsp;<span class="op" id="5867243">+</span>&nbsp;<span class="ident" id="5867245">p</span><span class="op" id="5867246">.</span><span class="ident" id="5867247">name</span><span class="op" id="5867251">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5867254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867258">stk</span>&nbsp;<span class="op" id="5867262">:=</span>&nbsp;<span class="builtinfunc" id="5867265">make</span><span class="op" id="5867269">(</span><span class="op" id="5867270">[</span><span class="op" id="5867271">]</span><span class="builtintype" id="5867272">uintptr</span><span class="op" id="5867279">,</span>&nbsp;<span class="num" id="5867281">32</span><span class="op" id="5867283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867286">n</span>&nbsp;<span class="op" id="5867288">:=</span>&nbsp;<span class="ident" id="5867291">runtime</span><span class="op" id="5867298">.</span><span class="ident" id="5867299">Callers</span><span class="op" id="5867306">(</span><span class="ident" id="5867307">skip</span><span class="op" id="5867311">+</span><span class="num" id="5867312">1</span><span class="op" id="5867313">,</span>&nbsp;<span class="ident" id="5867315">stk</span><span class="op" id="5867318">[</span><span class="op" id="5867319">:</span><span class="op" id="5867320">]</span><span class="op" id="5867321">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867325">p</span><span class="op" id="5867326">.</span><span class="ident" id="5867327">mu</span><span class="op" id="5867329">.</span><span class="ident" id="5867330">Lock</span><span class="op" id="5867334">(</span><span class="op" id="5867335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867338">defer</span>&nbsp;<span class="ident" id="5867344">p</span><span class="op" id="5867345">.</span><span class="ident" id="5867346">mu</span><span class="op" id="5867348">.</span><span class="ident" id="5867349">Unlock</span><span class="op" id="5867355">(</span><span class="op" id="5867356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867359">if</span>&nbsp;<span class="ident" id="5867362">p</span><span class="op" id="5867363">.</span><span class="ident" id="5867364">m</span><span class="op" id="5867365">[</span><span class="ident" id="5867366">value</span><span class="op" id="5867371">]</span>&nbsp;<span class="op" id="5867373">!=</span>&nbsp;<span class="ident" id="5867376">nil</span>&nbsp;<span class="op" id="5867380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5867384">panic</span><span class="op" id="5867389">(</span><span class="string" id="5867390">&#34;pprof:&nbsp;Profile.Add&nbsp;of&nbsp;duplicate&nbsp;value&#34;</span><span class="op" id="5867429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5867432">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867435">p</span><span class="op" id="5867436">.</span><span class="ident" id="5867437">m</span><span class="op" id="5867438">[</span><span class="ident" id="5867439">value</span><span class="op" id="5867444">]</span>&nbsp;<span class="op" id="5867446">=</span>&nbsp;<span class="ident" id="5867448">stk</span><span class="op" id="5867451">[</span><span class="op" id="5867452">:</span><span class="ident" id="5867453">n</span><span class="op" id="5867454">]</span><br>
<span class="lineno"></span><span class="op" id="5867456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5867459">//&nbsp;Remove&nbsp;removes&nbsp;the&nbsp;execution&nbsp;stack&nbsp;associated&nbsp;with&nbsp;value&nbsp;from&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="5867537">//&nbsp;It&nbsp;is&nbsp;a&nbsp;no-op&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno">205</span><span class="keyword" id="5867590">func</span>&nbsp;<span class="op" id="5867595">(</span><span class="ident" id="5867596">p</span>&nbsp;<span class="op" id="5867598">*</span><span class="ident" id="5867599">Profile</span><span class="op" id="5867606">)</span>&nbsp;<span class="ident" id="5867608">Remove</span><span class="op" id="5867614">(</span><span class="ident" id="5867615">value</span>&nbsp;<span class="keyword" id="5867621">interface</span><span class="op" id="5867630">{</span><span class="op" id="5867631">}</span><span class="op" id="5867632">)</span>&nbsp;<span class="op" id="5867634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5867637">p</span><span class="op" id="5867638">.</span><span class="ident" id="5867639">mu</span><span class="op" id="5867641">.</span><span class="ident" id="5867642">Lock</span><span class="op" id="5867646">(</span><span class="op" id="5867647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5867650">defer</span>&nbsp;<span class="ident" id="5867656">p</span><span class="op" id="5867657">.</span><span class="ident" id="5867658">mu</span><span class="op" id="5867660">.</span><span class="ident" id="5867661">Unlock</span><span class="op" id="5867667">(</span><span class="op" id="5867668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5867671">delete</span><span class="op" id="5867677">(</span><span class="ident" id="5867678">p</span><span class="op" id="5867679">.</span><span class="ident" id="5867680">m</span><span class="op" id="5867681">,</span>&nbsp;<span class="ident" id="5867683">value</span><span class="op" id="5867688">)</span><br>
<span class="lineno"></span><span class="op" id="5867690">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="comment" id="5867693">//&nbsp;WriteTo&nbsp;writes&nbsp;a&nbsp;pprof-formatted&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5867759">//&nbsp;If&nbsp;a&nbsp;write&nbsp;to&nbsp;w&nbsp;returns&nbsp;an&nbsp;error,&nbsp;WriteTo&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="5867824">//&nbsp;Otherwise,&nbsp;WriteTo&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5867859">//</span><br>
<span class="lineno">215</span><span class="comment" id="5867862">//&nbsp;The&nbsp;debug&nbsp;parameter&nbsp;enables&nbsp;additional&nbsp;output.</span><br>
<span class="lineno"></span><span class="comment" id="5867912">//&nbsp;Passing&nbsp;debug=0&nbsp;prints&nbsp;only&nbsp;the&nbsp;hexadecimal&nbsp;addresses&nbsp;that&nbsp;pprof&nbsp;needs.</span><br>
<span class="lineno"></span><span class="comment" id="5867987">//&nbsp;Passing&nbsp;debug=1&nbsp;adds&nbsp;comments&nbsp;translating&nbsp;addresses&nbsp;to&nbsp;function&nbsp;names</span><br>
<span class="lineno"></span><span class="comment" id="5868060">//&nbsp;and&nbsp;line&nbsp;numbers,&nbsp;so&nbsp;that&nbsp;a&nbsp;programmer&nbsp;can&nbsp;read&nbsp;the&nbsp;profile&nbsp;without&nbsp;tools.</span><br>
<span class="lineno"></span><span class="comment" id="5868138">//</span><br>
<span class="lineno">220</span><span class="comment" id="5868141">//&nbsp;The&nbsp;predefined&nbsp;profiles&nbsp;may&nbsp;assign&nbsp;meaning&nbsp;to&nbsp;other&nbsp;debug&nbsp;values;</span><br>
<span class="lineno"></span><span class="comment" id="5868210">//&nbsp;for&nbsp;example,&nbsp;when&nbsp;printing&nbsp;the&nbsp;&#34;goroutine&#34;&nbsp;profile,&nbsp;debug=2&nbsp;means&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5868282">//&nbsp;print&nbsp;the&nbsp;goroutine&nbsp;stacks&nbsp;in&nbsp;the&nbsp;same&nbsp;form&nbsp;that&nbsp;a&nbsp;Go&nbsp;program&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="5868352">//&nbsp;when&nbsp;dying&nbsp;due&nbsp;to&nbsp;an&nbsp;unrecovered&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5868395">func</span>&nbsp;<span class="op" id="5868400">(</span><span class="ident" id="5868401">p</span>&nbsp;<span class="op" id="5868403">*</span><span class="ident" id="5868404">Profile</span><span class="op" id="5868411">)</span>&nbsp;<span class="ident" id="5868413">WriteTo</span><span class="op" id="5868420">(</span><span class="ident" id="5868421">w</span>&nbsp;<span class="ident" id="5868423">io</span><span class="op" id="5868425">.</span><span class="ident" id="5868426">Writer</span><span class="op" id="5868432">,</span>&nbsp;<span class="ident" id="5868434">debug</span>&nbsp;<span class="builtintype" id="5868440">int</span><span class="op" id="5868443">)</span>&nbsp;<span class="builtintype" id="5868445">error</span>&nbsp;<span class="op" id="5868451">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868454">if</span>&nbsp;<span class="ident" id="5868457">p</span><span class="op" id="5868458">.</span><span class="ident" id="5868459">name</span>&nbsp;<span class="op" id="5868464">==</span>&nbsp;<span class="string" id="5868467">&#34;&#34;</span>&nbsp;<span class="op" id="5868470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5868474">panic</span><span class="op" id="5868479">(</span><span class="string" id="5868480">&#34;pprof:&nbsp;use&nbsp;of&nbsp;zero&nbsp;Profile&#34;</span><span class="op" id="5868508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868514">if</span>&nbsp;<span class="ident" id="5868517">p</span><span class="op" id="5868518">.</span><span class="ident" id="5868519">write</span>&nbsp;<span class="op" id="5868525">!=</span>&nbsp;<span class="ident" id="5868528">nil</span>&nbsp;<span class="op" id="5868532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868536">return</span>&nbsp;<span class="ident" id="5868543">p</span><span class="op" id="5868544">.</span><span class="ident" id="5868545">write</span><span class="op" id="5868550">(</span><span class="ident" id="5868551">w</span><span class="op" id="5868552">,</span>&nbsp;<span class="ident" id="5868554">debug</span><span class="op" id="5868559">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5868566">//&nbsp;Obtain&nbsp;consistent&nbsp;snapshot&nbsp;under&nbsp;lock;&nbsp;then&nbsp;process&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868636">var</span>&nbsp;<span class="ident" id="5868640">all</span>&nbsp;<span class="op" id="5868644">[</span><span class="op" id="5868645">]</span><span class="op" id="5868646">[</span><span class="op" id="5868647">]</span><span class="builtintype" id="5868648">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868657">p</span><span class="op" id="5868658">.</span><span class="ident" id="5868659">mu</span><span class="op" id="5868661">.</span><span class="ident" id="5868662">Lock</span><span class="op" id="5868666">(</span><span class="op" id="5868667">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868670">for</span>&nbsp;<span class="ident" id="5868674">_</span><span class="op" id="5868675">,</span>&nbsp;<span class="ident" id="5868677">stk</span>&nbsp;<span class="op" id="5868681">:=</span>&nbsp;<span class="keyword" id="5868684">range</span>&nbsp;<span class="ident" id="5868690">p</span><span class="op" id="5868691">.</span><span class="ident" id="5868692">m</span>&nbsp;<span class="op" id="5868694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868698">all</span>&nbsp;<span class="op" id="5868702">=</span>&nbsp;<span class="builtinfunc" id="5868704">append</span><span class="op" id="5868710">(</span><span class="ident" id="5868711">all</span><span class="op" id="5868714">,</span>&nbsp;<span class="ident" id="5868716">stk</span><span class="op" id="5868719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5868722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868725">p</span><span class="op" id="5868726">.</span><span class="ident" id="5868727">mu</span><span class="op" id="5868729">.</span><span class="ident" id="5868730">Unlock</span><span class="op" id="5868736">(</span><span class="op" id="5868737">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5868741">//&nbsp;Map&nbsp;order&nbsp;is&nbsp;non-deterministic;&nbsp;make&nbsp;output&nbsp;deterministic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868804">sort</span><span class="op" id="5868808">.</span><span class="ident" id="5868809">Sort</span><span class="op" id="5868813">(</span><span class="ident" id="5868814">stackProfile</span><span class="op" id="5868826">(</span><span class="ident" id="5868827">all</span><span class="op" id="5868830">)</span><span class="op" id="5868831">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5868835">return</span>&nbsp;<span class="ident" id="5868842">printCountProfile</span><span class="op" id="5868859">(</span><span class="ident" id="5868860">w</span><span class="op" id="5868861">,</span>&nbsp;<span class="ident" id="5868863">debug</span><span class="op" id="5868868">,</span>&nbsp;<span class="ident" id="5868870">p</span><span class="op" id="5868871">.</span><span class="ident" id="5868872">name</span><span class="op" id="5868876">,</span>&nbsp;<span class="ident" id="5868878">stackProfile</span><span class="op" id="5868890">(</span><span class="ident" id="5868891">all</span><span class="op" id="5868894">)</span><span class="op" id="5868895">)</span><br>
<span class="lineno"></span><span class="op" id="5868897">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="5868900">type</span>&nbsp;<span class="ident" id="5868905">stackProfile</span>&nbsp;<span class="op" id="5868918">[</span><span class="op" id="5868919">]</span><span class="op" id="5868920">[</span><span class="op" id="5868921">]</span><span class="builtintype" id="5868922">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5868931">func</span>&nbsp;<span class="op" id="5868936">(</span><span class="ident" id="5868937">x</span>&nbsp;<span class="ident" id="5868939">stackProfile</span><span class="op" id="5868951">)</span>&nbsp;<span class="ident" id="5868953">Len</span><span class="op" id="5868956">(</span><span class="op" id="5868957">)</span>&nbsp;<span class="builtintype" id="5868959">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5868976">{</span>&nbsp;<span class="keyword" id="5868978">return</span>&nbsp;<span class="builtinfunc" id="5868985">len</span><span class="op" id="5868988">(</span><span class="ident" id="5868989">x</span><span class="op" id="5868990">)</span>&nbsp;<span class="op" id="5868992">}</span><br>
<span class="lineno"></span><span class="keyword" id="5868994">func</span>&nbsp;<span class="op" id="5868999">(</span><span class="ident" id="5869000">x</span>&nbsp;<span class="ident" id="5869002">stackProfile</span><span class="op" id="5869014">)</span>&nbsp;<span class="ident" id="5869016">Stack</span><span class="op" id="5869021">(</span><span class="ident" id="5869022">i</span>&nbsp;<span class="builtintype" id="5869024">int</span><span class="op" id="5869027">)</span>&nbsp;<span class="op" id="5869029">[</span><span class="op" id="5869030">]</span><span class="builtintype" id="5869031">uintptr</span>&nbsp;<span class="op" id="5869039">{</span>&nbsp;<span class="keyword" id="5869041">return</span>&nbsp;<span class="ident" id="5869048">x</span><span class="op" id="5869049">[</span><span class="ident" id="5869050">i</span><span class="op" id="5869051">]</span>&nbsp;<span class="op" id="5869053">}</span><br>
<span class="lineno">250</span><span class="keyword" id="5869055">func</span>&nbsp;<span class="op" id="5869060">(</span><span class="ident" id="5869061">x</span>&nbsp;<span class="ident" id="5869063">stackProfile</span><span class="op" id="5869075">)</span>&nbsp;<span class="ident" id="5869077">Swap</span><span class="op" id="5869081">(</span><span class="ident" id="5869082">i</span><span class="op" id="5869083">,</span>&nbsp;<span class="ident" id="5869085">j</span>&nbsp;<span class="builtintype" id="5869087">int</span><span class="op" id="5869090">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869100">{</span>&nbsp;<span class="ident" id="5869102">x</span><span class="op" id="5869103">[</span><span class="ident" id="5869104">i</span><span class="op" id="5869105">]</span><span class="op" id="5869106">,</span>&nbsp;<span class="ident" id="5869108">x</span><span class="op" id="5869109">[</span><span class="ident" id="5869110">j</span><span class="op" id="5869111">]</span>&nbsp;<span class="op" id="5869113">=</span>&nbsp;<span class="ident" id="5869115">x</span><span class="op" id="5869116">[</span><span class="ident" id="5869117">j</span><span class="op" id="5869118">]</span><span class="op" id="5869119">,</span>&nbsp;<span class="ident" id="5869121">x</span><span class="op" id="5869122">[</span><span class="ident" id="5869123">i</span><span class="op" id="5869124">]</span>&nbsp;<span class="op" id="5869126">}</span><br>
<span class="lineno"></span><span class="keyword" id="5869128">func</span>&nbsp;<span class="op" id="5869133">(</span><span class="ident" id="5869134">x</span>&nbsp;<span class="ident" id="5869136">stackProfile</span><span class="op" id="5869148">)</span>&nbsp;<span class="ident" id="5869150">Less</span><span class="op" id="5869154">(</span><span class="ident" id="5869155">i</span><span class="op" id="5869156">,</span>&nbsp;<span class="ident" id="5869158">j</span>&nbsp;<span class="builtintype" id="5869160">int</span><span class="op" id="5869163">)</span>&nbsp;<span class="builtintype" id="5869165">bool</span>&nbsp;<span class="op" id="5869170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869173">t</span><span class="op" id="5869174">,</span>&nbsp;<span class="ident" id="5869176">u</span>&nbsp;<span class="op" id="5869178">:=</span>&nbsp;<span class="ident" id="5869181">x</span><span class="op" id="5869182">[</span><span class="ident" id="5869183">i</span><span class="op" id="5869184">]</span><span class="op" id="5869185">,</span>&nbsp;<span class="ident" id="5869187">x</span><span class="op" id="5869188">[</span><span class="ident" id="5869189">j</span><span class="op" id="5869190">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869193">for</span>&nbsp;<span class="ident" id="5869197">k</span>&nbsp;<span class="op" id="5869199">:=</span>&nbsp;<span class="num" id="5869202">0</span><span class="op" id="5869203">;</span>&nbsp;<span class="ident" id="5869205">k</span>&nbsp;<span class="op" id="5869207">&lt;</span>&nbsp;<span class="builtinfunc" id="5869209">len</span><span class="op" id="5869212">(</span><span class="ident" id="5869213">t</span><span class="op" id="5869214">)</span>&nbsp;<span class="op" id="5869216">&amp;&amp;</span>&nbsp;<span class="ident" id="5869219">k</span>&nbsp;<span class="op" id="5869221">&lt;</span>&nbsp;<span class="builtinfunc" id="5869223">len</span><span class="op" id="5869226">(</span><span class="ident" id="5869227">u</span><span class="op" id="5869228">)</span><span class="op" id="5869229">;</span>&nbsp;<span class="ident" id="5869231">k</span><span class="op" id="5869232">++</span>&nbsp;<span class="op" id="5869235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869239">if</span>&nbsp;<span class="ident" id="5869242">t</span><span class="op" id="5869243">[</span><span class="ident" id="5869244">k</span><span class="op" id="5869245">]</span>&nbsp;<span class="op" id="5869247">!=</span>&nbsp;<span class="ident" id="5869250">u</span><span class="op" id="5869251">[</span><span class="ident" id="5869252">k</span><span class="op" id="5869253">]</span>&nbsp;<span class="op" id="5869255">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869260">return</span>&nbsp;<span class="ident" id="5869267">t</span><span class="op" id="5869268">[</span><span class="ident" id="5869269">k</span><span class="op" id="5869270">]</span>&nbsp;<span class="op" id="5869272">&lt;</span>&nbsp;<span class="ident" id="5869274">u</span><span class="op" id="5869275">[</span><span class="ident" id="5869276">k</span><span class="op" id="5869277">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869287">return</span>&nbsp;<span class="builtinfunc" id="5869294">len</span><span class="op" id="5869297">(</span><span class="ident" id="5869298">t</span><span class="op" id="5869299">)</span>&nbsp;<span class="op" id="5869301">&lt;</span>&nbsp;<span class="builtinfunc" id="5869303">len</span><span class="op" id="5869306">(</span><span class="ident" id="5869307">u</span><span class="op" id="5869308">)</span><br>
<span class="lineno"></span><span class="op" id="5869310">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5869313">//&nbsp;A&nbsp;countProfile&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;stack&nbsp;traces&nbsp;to&nbsp;be&nbsp;printed&nbsp;as&nbsp;counts</span><br>
<span class="lineno"></span><span class="comment" id="5869380">//&nbsp;grouped&nbsp;by&nbsp;stack&nbsp;trace.&nbsp;&nbsp;There&nbsp;are&nbsp;multiple&nbsp;implementations:</span><br>
<span class="lineno"></span><span class="comment" id="5869444">//&nbsp;all&nbsp;that&nbsp;matters&nbsp;is&nbsp;that&nbsp;we&nbsp;can&nbsp;find&nbsp;out&nbsp;how&nbsp;many&nbsp;traces&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5869514">//&nbsp;and&nbsp;obtain&nbsp;each&nbsp;trace&nbsp;in&nbsp;turn.</span><br>
<span class="lineno">265</span><span class="keyword" id="5869548">type</span>&nbsp;<span class="ident" id="5869553">countProfile</span>&nbsp;<span class="keyword" id="5869566">interface</span>&nbsp;<span class="op" id="5869576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869579">Len</span><span class="op" id="5869582">(</span><span class="op" id="5869583">)</span>&nbsp;<span class="builtintype" id="5869585">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869590">Stack</span><span class="op" id="5869595">(</span><span class="ident" id="5869596">i</span>&nbsp;<span class="builtintype" id="5869598">int</span><span class="op" id="5869601">)</span>&nbsp;<span class="op" id="5869603">[</span><span class="op" id="5869604">]</span><span class="builtintype" id="5869605">uintptr</span><br>
<span class="lineno"></span><span class="op" id="5869613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5869616">//&nbsp;printCountProfile&nbsp;prints&nbsp;a&nbsp;countProfile&nbsp;at&nbsp;the&nbsp;specified&nbsp;debug&nbsp;level.</span><br>
<span class="lineno"></span><span class="keyword" id="5869689">func</span>&nbsp;<span class="ident" id="5869694">printCountProfile</span><span class="op" id="5869711">(</span><span class="ident" id="5869712">w</span>&nbsp;<span class="ident" id="5869714">io</span><span class="op" id="5869716">.</span><span class="ident" id="5869717">Writer</span><span class="op" id="5869723">,</span>&nbsp;<span class="ident" id="5869725">debug</span>&nbsp;<span class="builtintype" id="5869731">int</span><span class="op" id="5869734">,</span>&nbsp;<span class="ident" id="5869736">name</span>&nbsp;<span class="builtintype" id="5869741">string</span><span class="op" id="5869747">,</span>&nbsp;<span class="ident" id="5869749">p</span>&nbsp;<span class="ident" id="5869751">countProfile</span><span class="op" id="5869763">)</span>&nbsp;<span class="builtintype" id="5869765">error</span>&nbsp;<span class="op" id="5869771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869774">b</span>&nbsp;<span class="op" id="5869776">:=</span>&nbsp;<span class="ident" id="5869779">bufio</span><span class="op" id="5869784">.</span><span class="ident" id="5869785">NewWriter</span><span class="op" id="5869794">(</span><span class="ident" id="5869795">w</span><span class="op" id="5869796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869799">var</span>&nbsp;<span class="ident" id="5869803">tw</span>&nbsp;<span class="op" id="5869806">*</span><span class="ident" id="5869807">tabwriter</span><span class="op" id="5869816">.</span><span class="ident" id="5869817">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869825">w</span>&nbsp;<span class="op" id="5869827">=</span>&nbsp;<span class="ident" id="5869829">b</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869832">if</span>&nbsp;<span class="ident" id="5869835">debug</span>&nbsp;<span class="op" id="5869841">&gt;</span>&nbsp;<span class="num" id="5869843">0</span>&nbsp;<span class="op" id="5869845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869849">tw</span>&nbsp;<span class="op" id="5869852">=</span>&nbsp;<span class="ident" id="5869854">tabwriter</span><span class="op" id="5869863">.</span><span class="ident" id="5869864">NewWriter</span><span class="op" id="5869873">(</span><span class="ident" id="5869874">w</span><span class="op" id="5869875">,</span>&nbsp;<span class="num" id="5869877">1</span><span class="op" id="5869878">,</span>&nbsp;<span class="num" id="5869880">8</span><span class="op" id="5869881">,</span>&nbsp;<span class="num" id="5869883">1</span><span class="op" id="5869884">,</span>&nbsp;<span class="string" id="5869886">&#39;\t&#39;</span><span class="op" id="5869890">,</span>&nbsp;<span class="num" id="5869892">0</span><span class="op" id="5869893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869897">w</span>&nbsp;<span class="op" id="5869899">=</span>&nbsp;<span class="ident" id="5869901">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5869905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869909">fmt</span><span class="op" id="5869912">.</span><span class="ident" id="5869913">Fprintf</span><span class="op" id="5869920">(</span><span class="ident" id="5869921">w</span><span class="op" id="5869922">,</span>&nbsp;<span class="string" id="5869924">&#34;%s&nbsp;profile:&nbsp;total&nbsp;%d\n&#34;</span><span class="op" id="5869948">,</span>&nbsp;<span class="ident" id="5869950">name</span><span class="op" id="5869954">,</span>&nbsp;<span class="ident" id="5869956">p</span><span class="op" id="5869957">.</span><span class="ident" id="5869958">Len</span><span class="op" id="5869961">(</span><span class="op" id="5869962">)</span><span class="op" id="5869963">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5869967">//&nbsp;Build&nbsp;count&nbsp;of&nbsp;each&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869998">var</span>&nbsp;<span class="ident" id="5870002">buf</span>&nbsp;<span class="ident" id="5870006">bytes</span><span class="op" id="5870011">.</span><span class="ident" id="5870012">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870020">key</span>&nbsp;<span class="op" id="5870024">:=</span>&nbsp;<span class="keyword" id="5870027">func</span><span class="op" id="5870031">(</span><span class="ident" id="5870032">stk</span>&nbsp;<span class="op" id="5870036">[</span><span class="op" id="5870037">]</span><span class="builtintype" id="5870038">uintptr</span><span class="op" id="5870045">)</span>&nbsp;<span class="builtintype" id="5870047">string</span>&nbsp;<span class="op" id="5870054">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870058">buf</span><span class="op" id="5870061">.</span><span class="ident" id="5870062">Reset</span><span class="op" id="5870067">(</span><span class="op" id="5870068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870072">fmt</span><span class="op" id="5870075">.</span><span class="ident" id="5870076">Fprintf</span><span class="op" id="5870083">(</span><span class="op" id="5870084">&amp;</span><span class="ident" id="5870085">buf</span><span class="op" id="5870088">,</span>&nbsp;<span class="string" id="5870090">&#34;@&#34;</span><span class="op" id="5870093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870097">for</span>&nbsp;<span class="ident" id="5870101">_</span><span class="op" id="5870102">,</span>&nbsp;<span class="ident" id="5870104">pc</span>&nbsp;<span class="op" id="5870107">:=</span>&nbsp;<span class="keyword" id="5870110">range</span>&nbsp;<span class="ident" id="5870116">stk</span>&nbsp;<span class="op" id="5870120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870125">fmt</span><span class="op" id="5870128">.</span><span class="ident" id="5870129">Fprintf</span><span class="op" id="5870136">(</span><span class="op" id="5870137">&amp;</span><span class="ident" id="5870138">buf</span><span class="op" id="5870141">,</span>&nbsp;<span class="string" id="5870143">&#34;&nbsp;%#x&#34;</span><span class="op" id="5870149">,</span>&nbsp;<span class="ident" id="5870151">pc</span><span class="op" id="5870153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870157">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870161">return</span>&nbsp;<span class="ident" id="5870168">buf</span><span class="op" id="5870171">.</span><span class="ident" id="5870172">String</span><span class="op" id="5870178">(</span><span class="op" id="5870179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870185">m</span>&nbsp;<span class="op" id="5870187">:=</span>&nbsp;<span class="keyword" id="5870190">map</span><span class="op" id="5870193">[</span><span class="builtintype" id="5870194">string</span><span class="op" id="5870200">]</span><span class="builtintype" id="5870201">int</span><span class="op" id="5870204">{</span><span class="op" id="5870205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870208">n</span>&nbsp;<span class="op" id="5870210">:=</span>&nbsp;<span class="ident" id="5870213">p</span><span class="op" id="5870214">.</span><span class="ident" id="5870215">Len</span><span class="op" id="5870218">(</span><span class="op" id="5870219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870222">for</span>&nbsp;<span class="ident" id="5870226">i</span>&nbsp;<span class="op" id="5870228">:=</span>&nbsp;<span class="num" id="5870231">0</span><span class="op" id="5870232">;</span>&nbsp;<span class="ident" id="5870234">i</span>&nbsp;<span class="op" id="5870236">&lt;</span>&nbsp;<span class="ident" id="5870238">n</span><span class="op" id="5870239">;</span>&nbsp;<span class="ident" id="5870241">i</span><span class="op" id="5870242">++</span>&nbsp;<span class="op" id="5870245">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870249">m</span><span class="op" id="5870250">[</span><span class="ident" id="5870251">key</span><span class="op" id="5870254">(</span><span class="ident" id="5870255">p</span><span class="op" id="5870256">.</span><span class="ident" id="5870257">Stack</span><span class="op" id="5870262">(</span><span class="ident" id="5870263">i</span><span class="op" id="5870264">)</span><span class="op" id="5870265">)</span><span class="op" id="5870266">]</span><span class="op" id="5870267">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5870275">//&nbsp;Print&nbsp;stacks,&nbsp;listing&nbsp;count&nbsp;on&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;a&nbsp;unique&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870346">for</span>&nbsp;<span class="ident" id="5870350">i</span>&nbsp;<span class="op" id="5870352">:=</span>&nbsp;<span class="num" id="5870355">0</span><span class="op" id="5870356">;</span>&nbsp;<span class="ident" id="5870358">i</span>&nbsp;<span class="op" id="5870360">&lt;</span>&nbsp;<span class="ident" id="5870362">n</span><span class="op" id="5870363">;</span>&nbsp;<span class="ident" id="5870365">i</span><span class="op" id="5870366">++</span>&nbsp;<span class="op" id="5870369">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870373">stk</span>&nbsp;<span class="op" id="5870377">:=</span>&nbsp;<span class="ident" id="5870380">p</span><span class="op" id="5870381">.</span><span class="ident" id="5870382">Stack</span><span class="op" id="5870387">(</span><span class="ident" id="5870388">i</span><span class="op" id="5870389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870393">s</span>&nbsp;<span class="op" id="5870395">:=</span>&nbsp;<span class="ident" id="5870398">key</span><span class="op" id="5870401">(</span><span class="ident" id="5870402">stk</span><span class="op" id="5870405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870409">if</span>&nbsp;<span class="ident" id="5870412">count</span>&nbsp;<span class="op" id="5870418">:=</span>&nbsp;<span class="ident" id="5870421">m</span><span class="op" id="5870422">[</span><span class="ident" id="5870423">s</span><span class="op" id="5870424">]</span><span class="op" id="5870425">;</span>&nbsp;<span class="ident" id="5870427">count</span>&nbsp;<span class="op" id="5870433">!=</span>&nbsp;<span class="num" id="5870436">0</span>&nbsp;<span class="op" id="5870438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870443">fmt</span><span class="op" id="5870446">.</span><span class="ident" id="5870447">Fprintf</span><span class="op" id="5870454">(</span><span class="ident" id="5870455">w</span><span class="op" id="5870456">,</span>&nbsp;<span class="string" id="5870458">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5870467">,</span>&nbsp;<span class="ident" id="5870469">count</span><span class="op" id="5870474">,</span>&nbsp;<span class="ident" id="5870476">s</span><span class="op" id="5870477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870482">if</span>&nbsp;<span class="ident" id="5870485">debug</span>&nbsp;<span class="op" id="5870491">&gt;</span>&nbsp;<span class="num" id="5870493">0</span>&nbsp;<span class="op" id="5870495">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870501">printStackRecord</span><span class="op" id="5870517">(</span><span class="ident" id="5870518">w</span><span class="op" id="5870519">,</span>&nbsp;<span class="ident" id="5870521">stk</span><span class="op" id="5870524">,</span>&nbsp;<span class="builtintype" id="5870526">false</span><span class="op" id="5870531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5870541">delete</span><span class="op" id="5870547">(</span><span class="ident" id="5870548">m</span><span class="op" id="5870549">,</span>&nbsp;<span class="ident" id="5870551">s</span><span class="op" id="5870552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870559">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870563">if</span>&nbsp;<span class="ident" id="5870566">tw</span>&nbsp;<span class="op" id="5870569">!=</span>&nbsp;<span class="ident" id="5870572">nil</span>&nbsp;<span class="op" id="5870576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870580">tw</span><span class="op" id="5870582">.</span><span class="ident" id="5870583">Flush</span><span class="op" id="5870588">(</span><span class="op" id="5870589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870595">return</span>&nbsp;<span class="ident" id="5870602">b</span><span class="op" id="5870603">.</span><span class="ident" id="5870604">Flush</span><span class="op" id="5870609">(</span><span class="op" id="5870610">)</span><br>
<span class="lineno">315</span><span class="op" id="5870612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5870615">//&nbsp;printStackRecord&nbsp;prints&nbsp;the&nbsp;function&nbsp;+&nbsp;source&nbsp;line&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="5870681">//&nbsp;for&nbsp;a&nbsp;single&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span><span class="keyword" id="5870710">func</span>&nbsp;<span class="ident" id="5870715">printStackRecord</span><span class="op" id="5870731">(</span><span class="ident" id="5870732">w</span>&nbsp;<span class="ident" id="5870734">io</span><span class="op" id="5870736">.</span><span class="ident" id="5870737">Writer</span><span class="op" id="5870743">,</span>&nbsp;<span class="ident" id="5870745">stk</span>&nbsp;<span class="op" id="5870749">[</span><span class="op" id="5870750">]</span><span class="builtintype" id="5870751">uintptr</span><span class="op" id="5870758">,</span>&nbsp;<span class="ident" id="5870760">allFrames</span>&nbsp;<span class="builtintype" id="5870770">bool</span><span class="op" id="5870774">)</span>&nbsp;<span class="op" id="5870776">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870779">show</span>&nbsp;<span class="op" id="5870784">:=</span>&nbsp;<span class="ident" id="5870787">allFrames</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870798">wasPanic</span>&nbsp;<span class="op" id="5870807">:=</span>&nbsp;<span class="builtintype" id="5870810">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870817">for</span>&nbsp;<span class="ident" id="5870821">i</span><span class="op" id="5870822">,</span>&nbsp;<span class="ident" id="5870824">pc</span>&nbsp;<span class="op" id="5870827">:=</span>&nbsp;<span class="keyword" id="5870830">range</span>&nbsp;<span class="ident" id="5870836">stk</span>&nbsp;<span class="op" id="5870840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870844">f</span>&nbsp;<span class="op" id="5870846">:=</span>&nbsp;<span class="ident" id="5870849">runtime</span><span class="op" id="5870856">.</span><span class="ident" id="5870857">FuncForPC</span><span class="op" id="5870866">(</span><span class="ident" id="5870867">pc</span><span class="op" id="5870869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870873">if</span>&nbsp;<span class="ident" id="5870876">f</span>&nbsp;<span class="op" id="5870878">==</span>&nbsp;<span class="ident" id="5870881">nil</span>&nbsp;<span class="op" id="5870885">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870890">show</span>&nbsp;<span class="op" id="5870895">=</span>&nbsp;<span class="builtintype" id="5870897">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870905">fmt</span><span class="op" id="5870908">.</span><span class="ident" id="5870909">Fprintf</span><span class="op" id="5870916">(</span><span class="ident" id="5870917">w</span><span class="op" id="5870918">,</span>&nbsp;<span class="string" id="5870920">&#34;#\t%#x\n&#34;</span><span class="op" id="5870930">,</span>&nbsp;<span class="ident" id="5870932">pc</span><span class="op" id="5870934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870939">wasPanic</span>&nbsp;<span class="op" id="5870948">=</span>&nbsp;<span class="builtintype" id="5870950">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870958">}</span>&nbsp;<span class="keyword" id="5870960">else</span>&nbsp;<span class="op" id="5870965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870970">tracepc</span>&nbsp;<span class="op" id="5870978">:=</span>&nbsp;<span class="ident" id="5870981">pc</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5870987">//&nbsp;Back&nbsp;up&nbsp;to&nbsp;call&nbsp;instruction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871022">if</span>&nbsp;<span class="ident" id="5871025">i</span>&nbsp;<span class="op" id="5871027">&gt;</span>&nbsp;<span class="num" id="5871029">0</span>&nbsp;<span class="op" id="5871031">&amp;&amp;</span>&nbsp;<span class="ident" id="5871034">pc</span>&nbsp;<span class="op" id="5871037">&gt;</span>&nbsp;<span class="ident" id="5871039">f</span><span class="op" id="5871040">.</span><span class="ident" id="5871041">Entry</span><span class="op" id="5871046">(</span><span class="op" id="5871047">)</span>&nbsp;<span class="op" id="5871049">&amp;&amp;</span>&nbsp;<span class="op" id="5871052">!</span><span class="ident" id="5871053">wasPanic</span>&nbsp;<span class="op" id="5871062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871068">if</span>&nbsp;<span class="ident" id="5871071">runtime</span><span class="op" id="5871078">.</span><span class="ident" id="5871079">GOARCH</span>&nbsp;<span class="op" id="5871086">==</span>&nbsp;<span class="string" id="5871089">&#34;386&#34;</span>&nbsp;<span class="op" id="5871095">||</span>&nbsp;<span class="ident" id="5871098">runtime</span><span class="op" id="5871105">.</span><span class="ident" id="5871106">GOARCH</span>&nbsp;<span class="op" id="5871113">==</span>&nbsp;<span class="string" id="5871116">&#34;amd64&#34;</span>&nbsp;<span class="op" id="5871124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871131">tracepc</span><span class="op" id="5871138">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871145">}</span>&nbsp;<span class="keyword" id="5871147">else</span>&nbsp;<span class="op" id="5871152">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871159">tracepc</span>&nbsp;<span class="op" id="5871167">-=</span>&nbsp;<span class="num" id="5871170">4</span>&nbsp;<span class="comment" id="5871172">//&nbsp;arm,&nbsp;etc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871198">file</span><span class="op" id="5871202">,</span>&nbsp;<span class="ident" id="5871204">line</span>&nbsp;<span class="op" id="5871209">:=</span>&nbsp;<span class="ident" id="5871212">f</span><span class="op" id="5871213">.</span><span class="ident" id="5871214">FileLine</span><span class="op" id="5871222">(</span><span class="ident" id="5871223">tracepc</span><span class="op" id="5871230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871235">name</span>&nbsp;<span class="op" id="5871240">:=</span>&nbsp;<span class="ident" id="5871243">f</span><span class="op" id="5871244">.</span><span class="ident" id="5871245">Name</span><span class="op" id="5871249">(</span><span class="op" id="5871250">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5871255">//&nbsp;Hide&nbsp;runtime.goexit&nbsp;and&nbsp;any&nbsp;runtime&nbsp;functions&nbsp;at&nbsp;the&nbsp;beginning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5871325">//&nbsp;This&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;allocation&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871376">wasPanic</span>&nbsp;<span class="op" id="5871385">=</span>&nbsp;<span class="ident" id="5871387">name</span>&nbsp;<span class="op" id="5871392">==</span>&nbsp;<span class="string" id="5871395">&#34;runtime.panic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871414">if</span>&nbsp;<span class="ident" id="5871417">name</span>&nbsp;<span class="op" id="5871422">==</span>&nbsp;<span class="string" id="5871425">&#34;runtime.goexit&#34;</span>&nbsp;<span class="op" id="5871442">||</span>&nbsp;<span class="op" id="5871445">!</span><span class="ident" id="5871446">show</span>&nbsp;<span class="op" id="5871451">&amp;&amp;</span>&nbsp;<span class="ident" id="5871454">strings</span><span class="op" id="5871461">.</span><span class="ident" id="5871462">HasPrefix</span><span class="op" id="5871471">(</span><span class="ident" id="5871472">name</span><span class="op" id="5871476">,</span>&nbsp;<span class="string" id="5871478">&#34;runtime.&#34;</span><span class="op" id="5871488">)</span>&nbsp;<span class="op" id="5871490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871496">continue</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871513">show</span>&nbsp;<span class="op" id="5871518">=</span>&nbsp;<span class="builtintype" id="5871520">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871528">fmt</span><span class="op" id="5871531">.</span><span class="ident" id="5871532">Fprintf</span><span class="op" id="5871539">(</span><span class="ident" id="5871540">w</span><span class="op" id="5871541">,</span>&nbsp;<span class="string" id="5871543">&#34;#\t%#x\t%s+%#x\t%s:%d\n&#34;</span><span class="op" id="5871568">,</span>&nbsp;<span class="ident" id="5871570">pc</span><span class="op" id="5871572">,</span>&nbsp;<span class="ident" id="5871574">name</span><span class="op" id="5871578">,</span>&nbsp;<span class="ident" id="5871580">pc</span><span class="op" id="5871582">-</span><span class="ident" id="5871583">f</span><span class="op" id="5871584">.</span><span class="ident" id="5871585">Entry</span><span class="op" id="5871590">(</span><span class="op" id="5871591">)</span><span class="op" id="5871592">,</span>&nbsp;<span class="ident" id="5871594">file</span><span class="op" id="5871598">,</span>&nbsp;<span class="ident" id="5871600">line</span><span class="op" id="5871604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871611">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871614">if</span>&nbsp;<span class="op" id="5871617">!</span><span class="ident" id="5871618">show</span>&nbsp;<span class="op" id="5871623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5871627">//&nbsp;We&nbsp;didn&#39;t&nbsp;print&nbsp;anything;&nbsp;do&nbsp;it&nbsp;again,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5871671">//&nbsp;and&nbsp;this&nbsp;time&nbsp;include&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871717">printStackRecord</span><span class="op" id="5871733">(</span><span class="ident" id="5871734">w</span><span class="op" id="5871735">,</span>&nbsp;<span class="ident" id="5871737">stk</span><span class="op" id="5871740">,</span>&nbsp;<span class="builtintype" id="5871742">true</span><span class="op" id="5871746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871750">return</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871761">fmt</span><span class="op" id="5871764">.</span><span class="ident" id="5871765">Fprintf</span><span class="op" id="5871772">(</span><span class="ident" id="5871773">w</span><span class="op" id="5871774">,</span>&nbsp;<span class="string" id="5871776">&#34;\n&#34;</span><span class="op" id="5871780">)</span><br>
<span class="lineno"></span><span class="op" id="5871782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5871785">//&nbsp;Interface&nbsp;to&nbsp;system&nbsp;profiles.</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="5871819">type</span>&nbsp;<span class="ident" id="5871824">byInUseBytes</span>&nbsp;<span class="op" id="5871837">[</span><span class="op" id="5871838">]</span><span class="ident" id="5871839">runtime</span><span class="op" id="5871846">.</span><span class="ident" id="5871847">MemProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5871865">func</span>&nbsp;<span class="op" id="5871870">(</span><span class="ident" id="5871871">x</span>&nbsp;<span class="ident" id="5871873">byInUseBytes</span><span class="op" id="5871885">)</span>&nbsp;<span class="ident" id="5871887">Len</span><span class="op" id="5871890">(</span><span class="op" id="5871891">)</span>&nbsp;<span class="builtintype" id="5871893">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871907">{</span>&nbsp;<span class="keyword" id="5871909">return</span>&nbsp;<span class="builtinfunc" id="5871916">len</span><span class="op" id="5871919">(</span><span class="ident" id="5871920">x</span><span class="op" id="5871921">)</span>&nbsp;<span class="op" id="5871923">}</span><br>
<span class="lineno"></span><span class="keyword" id="5871925">func</span>&nbsp;<span class="op" id="5871930">(</span><span class="ident" id="5871931">x</span>&nbsp;<span class="ident" id="5871933">byInUseBytes</span><span class="op" id="5871945">)</span>&nbsp;<span class="ident" id="5871947">Swap</span><span class="op" id="5871951">(</span><span class="ident" id="5871952">i</span><span class="op" id="5871953">,</span>&nbsp;<span class="ident" id="5871955">j</span>&nbsp;<span class="builtintype" id="5871957">int</span><span class="op" id="5871960">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871967">{</span>&nbsp;<span class="ident" id="5871969">x</span><span class="op" id="5871970">[</span><span class="ident" id="5871971">i</span><span class="op" id="5871972">]</span><span class="op" id="5871973">,</span>&nbsp;<span class="ident" id="5871975">x</span><span class="op" id="5871976">[</span><span class="ident" id="5871977">j</span><span class="op" id="5871978">]</span>&nbsp;<span class="op" id="5871980">=</span>&nbsp;<span class="ident" id="5871982">x</span><span class="op" id="5871983">[</span><span class="ident" id="5871984">j</span><span class="op" id="5871985">]</span><span class="op" id="5871986">,</span>&nbsp;<span class="ident" id="5871988">x</span><span class="op" id="5871989">[</span><span class="ident" id="5871990">i</span><span class="op" id="5871991">]</span>&nbsp;<span class="op" id="5871993">}</span><br>
<span class="lineno">365</span><span class="keyword" id="5871995">func</span>&nbsp;<span class="op" id="5872000">(</span><span class="ident" id="5872001">x</span>&nbsp;<span class="ident" id="5872003">byInUseBytes</span><span class="op" id="5872015">)</span>&nbsp;<span class="ident" id="5872017">Less</span><span class="op" id="5872021">(</span><span class="ident" id="5872022">i</span><span class="op" id="5872023">,</span>&nbsp;<span class="ident" id="5872025">j</span>&nbsp;<span class="builtintype" id="5872027">int</span><span class="op" id="5872030">)</span>&nbsp;<span class="builtintype" id="5872032">bool</span>&nbsp;<span class="op" id="5872037">{</span>&nbsp;<span class="keyword" id="5872039">return</span>&nbsp;<span class="ident" id="5872046">x</span><span class="op" id="5872047">[</span><span class="ident" id="5872048">i</span><span class="op" id="5872049">]</span><span class="op" id="5872050">.</span><span class="ident" id="5872051">InUseBytes</span><span class="op" id="5872061">(</span><span class="op" id="5872062">)</span>&nbsp;<span class="op" id="5872064">&gt;</span>&nbsp;<span class="ident" id="5872066">x</span><span class="op" id="5872067">[</span><span class="ident" id="5872068">j</span><span class="op" id="5872069">]</span><span class="op" id="5872070">.</span><span class="ident" id="5872071">InUseBytes</span><span class="op" id="5872081">(</span><span class="op" id="5872082">)</span>&nbsp;<span class="op" id="5872084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5872087">//&nbsp;WriteHeapProfile&nbsp;is&nbsp;shorthand&nbsp;for&nbsp;Lookup(&#34;heap&#34;).WriteTo(w,&nbsp;0).</span><br>
<span class="lineno"></span><span class="comment" id="5872154">//&nbsp;It&nbsp;is&nbsp;preserved&nbsp;for&nbsp;backwards&nbsp;compatibility.</span><br>
<span class="lineno"></span><span class="keyword" id="5872202">func</span>&nbsp;<span class="ident" id="5872207">WriteHeapProfile</span><span class="op" id="5872223">(</span><span class="ident" id="5872224">w</span>&nbsp;<span class="ident" id="5872226">io</span><span class="op" id="5872228">.</span><span class="ident" id="5872229">Writer</span><span class="op" id="5872235">)</span>&nbsp;<span class="builtintype" id="5872237">error</span>&nbsp;<span class="op" id="5872243">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872246">return</span>&nbsp;<span class="ident" id="5872253">writeHeap</span><span class="op" id="5872262">(</span><span class="ident" id="5872263">w</span><span class="op" id="5872264">,</span>&nbsp;<span class="num" id="5872266">0</span><span class="op" id="5872267">)</span><br>
<span class="lineno"></span><span class="op" id="5872269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5872272">//&nbsp;countHeap&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;heap&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5872336">func</span>&nbsp;<span class="ident" id="5872341">countHeap</span><span class="op" id="5872350">(</span><span class="op" id="5872351">)</span>&nbsp;<span class="builtintype" id="5872353">int</span>&nbsp;<span class="op" id="5872357">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872360">n</span><span class="op" id="5872361">,</span>&nbsp;<span class="ident" id="5872363">_</span>&nbsp;<span class="op" id="5872365">:=</span>&nbsp;<span class="ident" id="5872368">runtime</span><span class="op" id="5872375">.</span><span class="ident" id="5872376">MemProfile</span><span class="op" id="5872386">(</span><span class="ident" id="5872387">nil</span><span class="op" id="5872390">,</span>&nbsp;<span class="builtintype" id="5872392">true</span><span class="op" id="5872396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872399">return</span>&nbsp;<span class="ident" id="5872406">n</span><br>
<span class="lineno"></span><span class="op" id="5872408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5872411">//&nbsp;writeHeap&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;heap&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno">380</span><span class="keyword" id="5872470">func</span>&nbsp;<span class="ident" id="5872475">writeHeap</span><span class="op" id="5872484">(</span><span class="ident" id="5872485">w</span>&nbsp;<span class="ident" id="5872487">io</span><span class="op" id="5872489">.</span><span class="ident" id="5872490">Writer</span><span class="op" id="5872496">,</span>&nbsp;<span class="ident" id="5872498">debug</span>&nbsp;<span class="builtintype" id="5872504">int</span><span class="op" id="5872507">)</span>&nbsp;<span class="builtintype" id="5872509">error</span>&nbsp;<span class="op" id="5872515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872518">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(MemProfile(nil,&nbsp;true)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872583">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872633">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872690">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872753">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872799">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872866">var</span>&nbsp;<span class="ident" id="5872870">p</span>&nbsp;<span class="op" id="5872872">[</span><span class="op" id="5872873">]</span><span class="ident" id="5872874">runtime</span><span class="op" id="5872881">.</span><span class="ident" id="5872882">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872900">n</span><span class="op" id="5872901">,</span>&nbsp;<span class="ident" id="5872903">ok</span>&nbsp;<span class="op" id="5872906">:=</span>&nbsp;<span class="ident" id="5872909">runtime</span><span class="op" id="5872916">.</span><span class="ident" id="5872917">MemProfile</span><span class="op" id="5872927">(</span><span class="ident" id="5872928">nil</span><span class="op" id="5872931">,</span>&nbsp;<span class="builtintype" id="5872933">true</span><span class="op" id="5872937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872940">for</span>&nbsp;<span class="op" id="5872944">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872948">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872998">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873046">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;MemProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873081">p</span>&nbsp;<span class="op" id="5873083">=</span>&nbsp;<span class="builtinfunc" id="5873085">make</span><span class="op" id="5873089">(</span><span class="op" id="5873090">[</span><span class="op" id="5873091">]</span><span class="ident" id="5873092">runtime</span><span class="op" id="5873099">.</span><span class="ident" id="5873100">MemProfileRecord</span><span class="op" id="5873116">,</span>&nbsp;<span class="ident" id="5873118">n</span><span class="op" id="5873119">+</span><span class="num" id="5873120">50</span><span class="op" id="5873122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873126">n</span><span class="op" id="5873127">,</span>&nbsp;<span class="ident" id="5873129">ok</span>&nbsp;<span class="op" id="5873132">=</span>&nbsp;<span class="ident" id="5873134">runtime</span><span class="op" id="5873141">.</span><span class="ident" id="5873142">MemProfile</span><span class="op" id="5873152">(</span><span class="ident" id="5873153">p</span><span class="op" id="5873154">,</span>&nbsp;<span class="builtintype" id="5873156">true</span><span class="op" id="5873160">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873164">if</span>&nbsp;<span class="ident" id="5873167">ok</span>&nbsp;<span class="op" id="5873170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873175">p</span>&nbsp;<span class="op" id="5873177">=</span>&nbsp;<span class="ident" id="5873179">p</span><span class="op" id="5873180">[</span><span class="num" id="5873181">0</span><span class="op" id="5873182">:</span><span class="ident" id="5873183">n</span><span class="op" id="5873184">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873189">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873201">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873234">sort</span><span class="op" id="5873238">.</span><span class="ident" id="5873239">Sort</span><span class="op" id="5873243">(</span><span class="ident" id="5873244">byInUseBytes</span><span class="op" id="5873256">(</span><span class="ident" id="5873257">p</span><span class="op" id="5873258">)</span><span class="op" id="5873259">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873263">b</span>&nbsp;<span class="op" id="5873265">:=</span>&nbsp;<span class="ident" id="5873268">bufio</span><span class="op" id="5873273">.</span><span class="ident" id="5873274">NewWriter</span><span class="op" id="5873283">(</span><span class="ident" id="5873284">w</span><span class="op" id="5873285">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873288">var</span>&nbsp;<span class="ident" id="5873292">tw</span>&nbsp;<span class="op" id="5873295">*</span><span class="ident" id="5873296">tabwriter</span><span class="op" id="5873305">.</span><span class="ident" id="5873306">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873314">w</span>&nbsp;<span class="op" id="5873316">=</span>&nbsp;<span class="ident" id="5873318">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873321">if</span>&nbsp;<span class="ident" id="5873324">debug</span>&nbsp;<span class="op" id="5873330">&gt;</span>&nbsp;<span class="num" id="5873332">0</span>&nbsp;<span class="op" id="5873334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873338">tw</span>&nbsp;<span class="op" id="5873341">=</span>&nbsp;<span class="ident" id="5873343">tabwriter</span><span class="op" id="5873352">.</span><span class="ident" id="5873353">NewWriter</span><span class="op" id="5873362">(</span><span class="ident" id="5873363">w</span><span class="op" id="5873364">,</span>&nbsp;<span class="num" id="5873366">1</span><span class="op" id="5873367">,</span>&nbsp;<span class="num" id="5873369">8</span><span class="op" id="5873370">,</span>&nbsp;<span class="num" id="5873372">1</span><span class="op" id="5873373">,</span>&nbsp;<span class="string" id="5873375">&#39;\t&#39;</span><span class="op" id="5873379">,</span>&nbsp;<span class="num" id="5873381">0</span><span class="op" id="5873382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873386">w</span>&nbsp;<span class="op" id="5873388">=</span>&nbsp;<span class="ident" id="5873390">tw</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873398">var</span>&nbsp;<span class="ident" id="5873402">total</span>&nbsp;<span class="ident" id="5873408">runtime</span><span class="op" id="5873415">.</span><span class="ident" id="5873416">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873434">for</span>&nbsp;<span class="ident" id="5873438">i</span>&nbsp;<span class="op" id="5873440">:=</span>&nbsp;<span class="keyword" id="5873443">range</span>&nbsp;<span class="ident" id="5873449">p</span>&nbsp;<span class="op" id="5873451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873455">r</span>&nbsp;<span class="op" id="5873457">:=</span>&nbsp;<span class="op" id="5873460">&amp;</span><span class="ident" id="5873461">p</span><span class="op" id="5873462">[</span><span class="ident" id="5873463">i</span><span class="op" id="5873464">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873468">total</span><span class="op" id="5873473">.</span><span class="ident" id="5873474">AllocBytes</span>&nbsp;<span class="op" id="5873485">+=</span>&nbsp;<span class="ident" id="5873488">r</span><span class="op" id="5873489">.</span><span class="ident" id="5873490">AllocBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873503">total</span><span class="op" id="5873508">.</span><span class="ident" id="5873509">AllocObjects</span>&nbsp;<span class="op" id="5873522">+=</span>&nbsp;<span class="ident" id="5873525">r</span><span class="op" id="5873526">.</span><span class="ident" id="5873527">AllocObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873542">total</span><span class="op" id="5873547">.</span><span class="ident" id="5873548">FreeBytes</span>&nbsp;<span class="op" id="5873558">+=</span>&nbsp;<span class="ident" id="5873561">r</span><span class="op" id="5873562">.</span><span class="ident" id="5873563">FreeBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873575">total</span><span class="op" id="5873580">.</span><span class="ident" id="5873581">FreeObjects</span>&nbsp;<span class="op" id="5873593">+=</span>&nbsp;<span class="ident" id="5873596">r</span><span class="op" id="5873597">.</span><span class="ident" id="5873598">FreeObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873611">}</span><br>
<span class="lineno">420</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873615">//&nbsp;Technically&nbsp;the&nbsp;rate&nbsp;is&nbsp;MemProfileRate&nbsp;not&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873680">//&nbsp;but&nbsp;early&nbsp;versions&nbsp;of&nbsp;the&nbsp;C++&nbsp;heap&nbsp;profiler&nbsp;reported&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873755">//&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;pprof&nbsp;has&nbsp;come&nbsp;to&nbsp;expect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873800">fmt</span><span class="op" id="5873803">.</span><span class="ident" id="5873804">Fprintf</span><span class="op" id="5873811">(</span><span class="ident" id="5873812">w</span><span class="op" id="5873813">,</span>&nbsp;<span class="string" id="5873815">&#34;heap&nbsp;profile:&nbsp;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&nbsp;heap/%d\n&#34;</span><span class="op" id="5873858">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873862">total</span><span class="op" id="5873867">.</span><span class="ident" id="5873868">InUseObjects</span><span class="op" id="5873880">(</span><span class="op" id="5873881">)</span><span class="op" id="5873882">,</span>&nbsp;<span class="ident" id="5873884">total</span><span class="op" id="5873889">.</span><span class="ident" id="5873890">InUseBytes</span><span class="op" id="5873900">(</span><span class="op" id="5873901">)</span><span class="op" id="5873902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873906">total</span><span class="op" id="5873911">.</span><span class="ident" id="5873912">AllocObjects</span><span class="op" id="5873924">,</span>&nbsp;<span class="ident" id="5873926">total</span><span class="op" id="5873931">.</span><span class="ident" id="5873932">AllocBytes</span><span class="op" id="5873942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5873946">2</span><span class="op" id="5873947">*</span><span class="ident" id="5873948">runtime</span><span class="op" id="5873955">.</span><span class="ident" id="5873956">MemProfileRate</span><span class="op" id="5873970">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873974">for</span>&nbsp;<span class="ident" id="5873978">i</span>&nbsp;<span class="op" id="5873980">:=</span>&nbsp;<span class="keyword" id="5873983">range</span>&nbsp;<span class="ident" id="5873989">p</span>&nbsp;<span class="op" id="5873991">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873995">r</span>&nbsp;<span class="op" id="5873997">:=</span>&nbsp;<span class="op" id="5874000">&amp;</span><span class="ident" id="5874001">p</span><span class="op" id="5874002">[</span><span class="ident" id="5874003">i</span><span class="op" id="5874004">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874008">fmt</span><span class="op" id="5874011">.</span><span class="ident" id="5874012">Fprintf</span><span class="op" id="5874019">(</span><span class="ident" id="5874020">w</span><span class="op" id="5874021">,</span>&nbsp;<span class="string" id="5874023">&#34;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&#34;</span><span class="op" id="5874042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874047">r</span><span class="op" id="5874048">.</span><span class="ident" id="5874049">InUseObjects</span><span class="op" id="5874061">(</span><span class="op" id="5874062">)</span><span class="op" id="5874063">,</span>&nbsp;<span class="ident" id="5874065">r</span><span class="op" id="5874066">.</span><span class="ident" id="5874067">InUseBytes</span><span class="op" id="5874077">(</span><span class="op" id="5874078">)</span><span class="op" id="5874079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874084">r</span><span class="op" id="5874085">.</span><span class="ident" id="5874086">AllocObjects</span><span class="op" id="5874098">,</span>&nbsp;<span class="ident" id="5874100">r</span><span class="op" id="5874101">.</span><span class="ident" id="5874102">AllocBytes</span><span class="op" id="5874112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874116">for</span>&nbsp;<span class="ident" id="5874120">_</span><span class="op" id="5874121">,</span>&nbsp;<span class="ident" id="5874123">pc</span>&nbsp;<span class="op" id="5874126">:=</span>&nbsp;<span class="keyword" id="5874129">range</span>&nbsp;<span class="ident" id="5874135">r</span><span class="op" id="5874136">.</span><span class="ident" id="5874137">Stack</span><span class="op" id="5874142">(</span><span class="op" id="5874143">)</span>&nbsp;<span class="op" id="5874145">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874150">fmt</span><span class="op" id="5874153">.</span><span class="ident" id="5874154">Fprintf</span><span class="op" id="5874161">(</span><span class="ident" id="5874162">w</span><span class="op" id="5874163">,</span>&nbsp;<span class="string" id="5874165">&#34;&nbsp;%#x&#34;</span><span class="op" id="5874171">,</span>&nbsp;<span class="ident" id="5874173">pc</span><span class="op" id="5874175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874183">fmt</span><span class="op" id="5874186">.</span><span class="ident" id="5874187">Fprintf</span><span class="op" id="5874194">(</span><span class="ident" id="5874195">w</span><span class="op" id="5874196">,</span>&nbsp;<span class="string" id="5874198">&#34;\n&#34;</span><span class="op" id="5874202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874206">if</span>&nbsp;<span class="ident" id="5874209">debug</span>&nbsp;<span class="op" id="5874215">&gt;</span>&nbsp;<span class="num" id="5874217">0</span>&nbsp;<span class="op" id="5874219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874224">printStackRecord</span><span class="op" id="5874240">(</span><span class="ident" id="5874241">w</span><span class="op" id="5874242">,</span>&nbsp;<span class="ident" id="5874244">r</span><span class="op" id="5874245">.</span><span class="ident" id="5874246">Stack</span><span class="op" id="5874251">(</span><span class="op" id="5874252">)</span><span class="op" id="5874253">,</span>&nbsp;<span class="builtintype" id="5874255">false</span><span class="op" id="5874260">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5874271">//&nbsp;Print&nbsp;memstats&nbsp;information&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5874307">//&nbsp;Pprof&nbsp;will&nbsp;ignore,&nbsp;but&nbsp;useful&nbsp;for&nbsp;people</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874352">if</span>&nbsp;<span class="ident" id="5874355">debug</span>&nbsp;<span class="op" id="5874361">&gt;</span>&nbsp;<span class="num" id="5874363">0</span>&nbsp;<span class="op" id="5874365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874369">s</span>&nbsp;<span class="op" id="5874371">:=</span>&nbsp;<span class="builtinfunc" id="5874374">new</span><span class="op" id="5874377">(</span><span class="ident" id="5874378">runtime</span><span class="op" id="5874385">.</span><span class="ident" id="5874386">MemStats</span><span class="op" id="5874394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874398">runtime</span><span class="op" id="5874405">.</span><span class="ident" id="5874406">ReadMemStats</span><span class="op" id="5874418">(</span><span class="ident" id="5874419">s</span><span class="op" id="5874420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874424">fmt</span><span class="op" id="5874427">.</span><span class="ident" id="5874428">Fprintf</span><span class="op" id="5874435">(</span><span class="ident" id="5874436">w</span><span class="op" id="5874437">,</span>&nbsp;<span class="string" id="5874439">&#34;\n#&nbsp;runtime.MemStats\n&#34;</span><span class="op" id="5874463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874467">fmt</span><span class="op" id="5874470">.</span><span class="ident" id="5874471">Fprintf</span><span class="op" id="5874478">(</span><span class="ident" id="5874479">w</span><span class="op" id="5874480">,</span>&nbsp;<span class="string" id="5874482">&#34;#&nbsp;Alloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874498">,</span>&nbsp;<span class="ident" id="5874500">s</span><span class="op" id="5874501">.</span><span class="ident" id="5874502">Alloc</span><span class="op" id="5874507">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874511">fmt</span><span class="op" id="5874514">.</span><span class="ident" id="5874515">Fprintf</span><span class="op" id="5874522">(</span><span class="ident" id="5874523">w</span><span class="op" id="5874524">,</span>&nbsp;<span class="string" id="5874526">&#34;#&nbsp;TotalAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874547">,</span>&nbsp;<span class="ident" id="5874549">s</span><span class="op" id="5874550">.</span><span class="ident" id="5874551">TotalAlloc</span><span class="op" id="5874561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874565">fmt</span><span class="op" id="5874568">.</span><span class="ident" id="5874569">Fprintf</span><span class="op" id="5874576">(</span><span class="ident" id="5874577">w</span><span class="op" id="5874578">,</span>&nbsp;<span class="string" id="5874580">&#34;#&nbsp;Sys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874594">,</span>&nbsp;<span class="ident" id="5874596">s</span><span class="op" id="5874597">.</span><span class="ident" id="5874598">Sys</span><span class="op" id="5874601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874605">fmt</span><span class="op" id="5874608">.</span><span class="ident" id="5874609">Fprintf</span><span class="op" id="5874616">(</span><span class="ident" id="5874617">w</span><span class="op" id="5874618">,</span>&nbsp;<span class="string" id="5874620">&#34;#&nbsp;Lookups&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874638">,</span>&nbsp;<span class="ident" id="5874640">s</span><span class="op" id="5874641">.</span><span class="ident" id="5874642">Lookups</span><span class="op" id="5874649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874653">fmt</span><span class="op" id="5874656">.</span><span class="ident" id="5874657">Fprintf</span><span class="op" id="5874664">(</span><span class="ident" id="5874665">w</span><span class="op" id="5874666">,</span>&nbsp;<span class="string" id="5874668">&#34;#&nbsp;Mallocs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874686">,</span>&nbsp;<span class="ident" id="5874688">s</span><span class="op" id="5874689">.</span><span class="ident" id="5874690">Mallocs</span><span class="op" id="5874697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874701">fmt</span><span class="op" id="5874704">.</span><span class="ident" id="5874705">Fprintf</span><span class="op" id="5874712">(</span><span class="ident" id="5874713">w</span><span class="op" id="5874714">,</span>&nbsp;<span class="string" id="5874716">&#34;#&nbsp;Frees&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874732">,</span>&nbsp;<span class="ident" id="5874734">s</span><span class="op" id="5874735">.</span><span class="ident" id="5874736">Frees</span><span class="op" id="5874741">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874746">fmt</span><span class="op" id="5874749">.</span><span class="ident" id="5874750">Fprintf</span><span class="op" id="5874757">(</span><span class="ident" id="5874758">w</span><span class="op" id="5874759">,</span>&nbsp;<span class="string" id="5874761">&#34;#&nbsp;HeapAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874781">,</span>&nbsp;<span class="ident" id="5874783">s</span><span class="op" id="5874784">.</span><span class="ident" id="5874785">HeapAlloc</span><span class="op" id="5874794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874798">fmt</span><span class="op" id="5874801">.</span><span class="ident" id="5874802">Fprintf</span><span class="op" id="5874809">(</span><span class="ident" id="5874810">w</span><span class="op" id="5874811">,</span>&nbsp;<span class="string" id="5874813">&#34;#&nbsp;HeapSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874831">,</span>&nbsp;<span class="ident" id="5874833">s</span><span class="op" id="5874834">.</span><span class="ident" id="5874835">HeapSys</span><span class="op" id="5874842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874846">fmt</span><span class="op" id="5874849">.</span><span class="ident" id="5874850">Fprintf</span><span class="op" id="5874857">(</span><span class="ident" id="5874858">w</span><span class="op" id="5874859">,</span>&nbsp;<span class="string" id="5874861">&#34;#&nbsp;HeapIdle&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874880">,</span>&nbsp;<span class="ident" id="5874882">s</span><span class="op" id="5874883">.</span><span class="ident" id="5874884">HeapIdle</span><span class="op" id="5874892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874896">fmt</span><span class="op" id="5874899">.</span><span class="ident" id="5874900">Fprintf</span><span class="op" id="5874907">(</span><span class="ident" id="5874908">w</span><span class="op" id="5874909">,</span>&nbsp;<span class="string" id="5874911">&#34;#&nbsp;HeapInuse&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874931">,</span>&nbsp;<span class="ident" id="5874933">s</span><span class="op" id="5874934">.</span><span class="ident" id="5874935">HeapInuse</span><span class="op" id="5874944">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874948">fmt</span><span class="op" id="5874951">.</span><span class="ident" id="5874952">Fprintf</span><span class="op" id="5874959">(</span><span class="ident" id="5874960">w</span><span class="op" id="5874961">,</span>&nbsp;<span class="string" id="5874963">&#34;#&nbsp;HeapReleased&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5874986">,</span>&nbsp;<span class="ident" id="5874988">s</span><span class="op" id="5874989">.</span><span class="ident" id="5874990">HeapReleased</span><span class="op" id="5875002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875006">fmt</span><span class="op" id="5875009">.</span><span class="ident" id="5875010">Fprintf</span><span class="op" id="5875017">(</span><span class="ident" id="5875018">w</span><span class="op" id="5875019">,</span>&nbsp;<span class="string" id="5875021">&#34;#&nbsp;HeapObjects&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5875043">,</span>&nbsp;<span class="ident" id="5875045">s</span><span class="op" id="5875046">.</span><span class="ident" id="5875047">HeapObjects</span><span class="op" id="5875058">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875063">fmt</span><span class="op" id="5875066">.</span><span class="ident" id="5875067">Fprintf</span><span class="op" id="5875074">(</span><span class="ident" id="5875075">w</span><span class="op" id="5875076">,</span>&nbsp;<span class="string" id="5875078">&#34;#&nbsp;Stack&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5875099">,</span>&nbsp;<span class="ident" id="5875101">s</span><span class="op" id="5875102">.</span><span class="ident" id="5875103">StackInuse</span><span class="op" id="5875113">,</span>&nbsp;<span class="ident" id="5875115">s</span><span class="op" id="5875116">.</span><span class="ident" id="5875117">StackSys</span><span class="op" id="5875125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875129">fmt</span><span class="op" id="5875132">.</span><span class="ident" id="5875133">Fprintf</span><span class="op" id="5875140">(</span><span class="ident" id="5875141">w</span><span class="op" id="5875142">,</span>&nbsp;<span class="string" id="5875144">&#34;#&nbsp;MSpan&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5875165">,</span>&nbsp;<span class="ident" id="5875167">s</span><span class="op" id="5875168">.</span><span class="ident" id="5875169">MSpanInuse</span><span class="op" id="5875179">,</span>&nbsp;<span class="ident" id="5875181">s</span><span class="op" id="5875182">.</span><span class="ident" id="5875183">MSpanSys</span><span class="op" id="5875191">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875195">fmt</span><span class="op" id="5875198">.</span><span class="ident" id="5875199">Fprintf</span><span class="op" id="5875206">(</span><span class="ident" id="5875207">w</span><span class="op" id="5875208">,</span>&nbsp;<span class="string" id="5875210">&#34;#&nbsp;MCache&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5875232">,</span>&nbsp;<span class="ident" id="5875234">s</span><span class="op" id="5875235">.</span><span class="ident" id="5875236">MCacheInuse</span><span class="op" id="5875247">,</span>&nbsp;<span class="ident" id="5875249">s</span><span class="op" id="5875250">.</span><span class="ident" id="5875251">MCacheSys</span><span class="op" id="5875260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875264">fmt</span><span class="op" id="5875267">.</span><span class="ident" id="5875268">Fprintf</span><span class="op" id="5875275">(</span><span class="ident" id="5875276">w</span><span class="op" id="5875277">,</span>&nbsp;<span class="string" id="5875279">&#34;#&nbsp;BuckHashSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5875301">,</span>&nbsp;<span class="ident" id="5875303">s</span><span class="op" id="5875304">.</span><span class="ident" id="5875305">BuckHashSys</span><span class="op" id="5875316">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875321">fmt</span><span class="op" id="5875324">.</span><span class="ident" id="5875325">Fprintf</span><span class="op" id="5875332">(</span><span class="ident" id="5875333">w</span><span class="op" id="5875334">,</span>&nbsp;<span class="string" id="5875336">&#34;#&nbsp;NextGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5875353">,</span>&nbsp;<span class="ident" id="5875355">s</span><span class="op" id="5875356">.</span><span class="ident" id="5875357">NextGC</span><span class="op" id="5875363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875367">fmt</span><span class="op" id="5875370">.</span><span class="ident" id="5875371">Fprintf</span><span class="op" id="5875378">(</span><span class="ident" id="5875379">w</span><span class="op" id="5875380">,</span>&nbsp;<span class="string" id="5875382">&#34;#&nbsp;PauseNs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5875400">,</span>&nbsp;<span class="ident" id="5875402">s</span><span class="op" id="5875403">.</span><span class="ident" id="5875404">PauseNs</span><span class="op" id="5875411">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875415">fmt</span><span class="op" id="5875418">.</span><span class="ident" id="5875419">Fprintf</span><span class="op" id="5875426">(</span><span class="ident" id="5875427">w</span><span class="op" id="5875428">,</span>&nbsp;<span class="string" id="5875430">&#34;#&nbsp;NumGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5875446">,</span>&nbsp;<span class="ident" id="5875448">s</span><span class="op" id="5875449">.</span><span class="ident" id="5875450">NumGC</span><span class="op" id="5875455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875459">fmt</span><span class="op" id="5875462">.</span><span class="ident" id="5875463">Fprintf</span><span class="op" id="5875470">(</span><span class="ident" id="5875471">w</span><span class="op" id="5875472">,</span>&nbsp;<span class="string" id="5875474">&#34;#&nbsp;EnableGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5875493">,</span>&nbsp;<span class="ident" id="5875495">s</span><span class="op" id="5875496">.</span><span class="ident" id="5875497">EnableGC</span><span class="op" id="5875505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875509">fmt</span><span class="op" id="5875512">.</span><span class="ident" id="5875513">Fprintf</span><span class="op" id="5875520">(</span><span class="ident" id="5875521">w</span><span class="op" id="5875522">,</span>&nbsp;<span class="string" id="5875524">&#34;#&nbsp;DebugGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5875542">,</span>&nbsp;<span class="ident" id="5875544">s</span><span class="op" id="5875545">.</span><span class="ident" id="5875546">DebugGC</span><span class="op" id="5875553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875560">if</span>&nbsp;<span class="ident" id="5875563">tw</span>&nbsp;<span class="op" id="5875566">!=</span>&nbsp;<span class="ident" id="5875569">nil</span>&nbsp;<span class="op" id="5875573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875577">tw</span><span class="op" id="5875579">.</span><span class="ident" id="5875580">Flush</span><span class="op" id="5875585">(</span><span class="op" id="5875586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875592">return</span>&nbsp;<span class="ident" id="5875599">b</span><span class="op" id="5875600">.</span><span class="ident" id="5875601">Flush</span><span class="op" id="5875606">(</span><span class="op" id="5875607">)</span><br>
<span class="lineno"></span><span class="op" id="5875609">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5875612">//&nbsp;countThreadCreate&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;current&nbsp;ThreadCreateProfile.</span><br>
<span class="lineno"></span><span class="keyword" id="5875686">func</span>&nbsp;<span class="ident" id="5875691">countThreadCreate</span><span class="op" id="5875708">(</span><span class="op" id="5875709">)</span>&nbsp;<span class="builtintype" id="5875711">int</span>&nbsp;<span class="op" id="5875715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875718">n</span><span class="op" id="5875719">,</span>&nbsp;<span class="ident" id="5875721">_</span>&nbsp;<span class="op" id="5875723">:=</span>&nbsp;<span class="ident" id="5875726">runtime</span><span class="op" id="5875733">.</span><span class="ident" id="5875734">ThreadCreateProfile</span><span class="op" id="5875753">(</span><span class="ident" id="5875754">nil</span><span class="op" id="5875757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875760">return</span>&nbsp;<span class="ident" id="5875767">n</span><br>
<span class="lineno">485</span><span class="op" id="5875769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5875772">//&nbsp;writeThreadCreate&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;ThreadCreateProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5875846">func</span>&nbsp;<span class="ident" id="5875851">writeThreadCreate</span><span class="op" id="5875868">(</span><span class="ident" id="5875869">w</span>&nbsp;<span class="ident" id="5875871">io</span><span class="op" id="5875873">.</span><span class="ident" id="5875874">Writer</span><span class="op" id="5875880">,</span>&nbsp;<span class="ident" id="5875882">debug</span>&nbsp;<span class="builtintype" id="5875888">int</span><span class="op" id="5875891">)</span>&nbsp;<span class="builtintype" id="5875893">error</span>&nbsp;<span class="op" id="5875899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875902">return</span>&nbsp;<span class="ident" id="5875909">writeRuntimeProfile</span><span class="op" id="5875928">(</span><span class="ident" id="5875929">w</span><span class="op" id="5875930">,</span>&nbsp;<span class="ident" id="5875932">debug</span><span class="op" id="5875937">,</span>&nbsp;<span class="string" id="5875939">&#34;threadcreate&#34;</span><span class="op" id="5875953">,</span>&nbsp;<span class="ident" id="5875955">runtime</span><span class="op" id="5875962">.</span><span class="ident" id="5875963">ThreadCreateProfile</span><span class="op" id="5875982">)</span><br>
<span class="lineno">490</span><span class="op" id="5875984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5875987">//&nbsp;countGoroutine&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5876039">func</span>&nbsp;<span class="ident" id="5876044">countGoroutine</span><span class="op" id="5876058">(</span><span class="op" id="5876059">)</span>&nbsp;<span class="builtintype" id="5876061">int</span>&nbsp;<span class="op" id="5876065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876068">return</span>&nbsp;<span class="ident" id="5876075">runtime</span><span class="op" id="5876082">.</span><span class="ident" id="5876083">NumGoroutine</span><span class="op" id="5876095">(</span><span class="op" id="5876096">)</span><br>
<span class="lineno">495</span><span class="op" id="5876098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5876101">//&nbsp;writeGoroutine&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;GoroutineProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5876169">func</span>&nbsp;<span class="ident" id="5876174">writeGoroutine</span><span class="op" id="5876188">(</span><span class="ident" id="5876189">w</span>&nbsp;<span class="ident" id="5876191">io</span><span class="op" id="5876193">.</span><span class="ident" id="5876194">Writer</span><span class="op" id="5876200">,</span>&nbsp;<span class="ident" id="5876202">debug</span>&nbsp;<span class="builtintype" id="5876208">int</span><span class="op" id="5876211">)</span>&nbsp;<span class="builtintype" id="5876213">error</span>&nbsp;<span class="op" id="5876219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876222">if</span>&nbsp;<span class="ident" id="5876225">debug</span>&nbsp;<span class="op" id="5876231">&gt;=</span>&nbsp;<span class="num" id="5876234">2</span>&nbsp;<span class="op" id="5876236">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876240">return</span>&nbsp;<span class="ident" id="5876247">writeGoroutineStacks</span><span class="op" id="5876267">(</span><span class="ident" id="5876268">w</span><span class="op" id="5876269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876275">return</span>&nbsp;<span class="ident" id="5876282">writeRuntimeProfile</span><span class="op" id="5876301">(</span><span class="ident" id="5876302">w</span><span class="op" id="5876303">,</span>&nbsp;<span class="ident" id="5876305">debug</span><span class="op" id="5876310">,</span>&nbsp;<span class="string" id="5876312">&#34;goroutine&#34;</span><span class="op" id="5876323">,</span>&nbsp;<span class="ident" id="5876325">runtime</span><span class="op" id="5876332">.</span><span class="ident" id="5876333">GoroutineProfile</span><span class="op" id="5876349">)</span><br>
<span class="lineno"></span><span class="op" id="5876351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="keyword" id="5876354">func</span>&nbsp;<span class="ident" id="5876359">writeGoroutineStacks</span><span class="op" id="5876379">(</span><span class="ident" id="5876380">w</span>&nbsp;<span class="ident" id="5876382">io</span><span class="op" id="5876384">.</span><span class="ident" id="5876385">Writer</span><span class="op" id="5876391">)</span>&nbsp;<span class="builtintype" id="5876393">error</span>&nbsp;<span class="op" id="5876399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876402">//&nbsp;We&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;big&nbsp;the&nbsp;buffer&nbsp;needs&nbsp;to&nbsp;be&nbsp;to&nbsp;collect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876462">//&nbsp;all&nbsp;the&nbsp;goroutines.&nbsp;&nbsp;Start&nbsp;with&nbsp;1&nbsp;MB&nbsp;and&nbsp;try&nbsp;a&nbsp;few&nbsp;times,&nbsp;doubling&nbsp;each&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876544">//&nbsp;Give&nbsp;up&nbsp;and&nbsp;use&nbsp;a&nbsp;truncated&nbsp;trace&nbsp;if&nbsp;64&nbsp;MB&nbsp;is&nbsp;not&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876606">buf</span>&nbsp;<span class="op" id="5876610">:=</span>&nbsp;<span class="builtinfunc" id="5876613">make</span><span class="op" id="5876617">(</span><span class="op" id="5876618">[</span><span class="op" id="5876619">]</span><span class="builtintype" id="5876620">byte</span><span class="op" id="5876624">,</span>&nbsp;<span class="num" id="5876626">1</span><span class="op" id="5876627">&lt;&lt;</span><span class="num" id="5876629">20</span><span class="op" id="5876631">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876634">for</span>&nbsp;<span class="ident" id="5876638">i</span>&nbsp;<span class="op" id="5876640">:=</span>&nbsp;<span class="num" id="5876643">0</span><span class="op" id="5876644">;</span>&nbsp;<span class="op" id="5876646">;</span>&nbsp;<span class="ident" id="5876648">i</span><span class="op" id="5876649">++</span>&nbsp;<span class="op" id="5876652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876656">n</span>&nbsp;<span class="op" id="5876658">:=</span>&nbsp;<span class="ident" id="5876661">runtime</span><span class="op" id="5876668">.</span><span class="ident" id="5876669">Stack</span><span class="op" id="5876674">(</span><span class="ident" id="5876675">buf</span><span class="op" id="5876678">,</span>&nbsp;<span class="builtintype" id="5876680">true</span><span class="op" id="5876684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876688">if</span>&nbsp;<span class="ident" id="5876691">n</span>&nbsp;<span class="op" id="5876693">&lt;</span>&nbsp;<span class="builtinfunc" id="5876695">len</span><span class="op" id="5876698">(</span><span class="ident" id="5876699">buf</span><span class="op" id="5876702">)</span>&nbsp;<span class="op" id="5876704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876709">buf</span>&nbsp;<span class="op" id="5876713">=</span>&nbsp;<span class="ident" id="5876715">buf</span><span class="op" id="5876718">[</span><span class="op" id="5876719">:</span><span class="ident" id="5876720">n</span><span class="op" id="5876721">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876726">break</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876738">if</span>&nbsp;<span class="builtinfunc" id="5876741">len</span><span class="op" id="5876744">(</span><span class="ident" id="5876745">buf</span><span class="op" id="5876748">)</span>&nbsp;<span class="op" id="5876750">&gt;=</span>&nbsp;<span class="num" id="5876753">64</span><span class="op" id="5876755">&lt;&lt;</span><span class="num" id="5876757">20</span>&nbsp;<span class="op" id="5876760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876765">//&nbsp;Filled&nbsp;64&nbsp;MB&nbsp;-&nbsp;stop&nbsp;there.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876798">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876806">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876810">buf</span>&nbsp;<span class="op" id="5876814">=</span>&nbsp;<span class="builtinfunc" id="5876816">make</span><span class="op" id="5876820">(</span><span class="op" id="5876821">[</span><span class="op" id="5876822">]</span><span class="builtintype" id="5876823">byte</span><span class="op" id="5876827">,</span>&nbsp;<span class="num" id="5876829">2</span><span class="op" id="5876830">*</span><span class="builtinfunc" id="5876831">len</span><span class="op" id="5876834">(</span><span class="ident" id="5876835">buf</span><span class="op" id="5876838">)</span><span class="op" id="5876839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876845">_</span><span class="op" id="5876846">,</span>&nbsp;<span class="ident" id="5876848">err</span>&nbsp;<span class="op" id="5876852">:=</span>&nbsp;<span class="ident" id="5876855">w</span><span class="op" id="5876856">.</span><span class="ident" id="5876857">Write</span><span class="op" id="5876862">(</span><span class="ident" id="5876863">buf</span><span class="op" id="5876866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876869">return</span>&nbsp;<span class="ident" id="5876876">err</span><br>
<span class="lineno"></span><span class="op" id="5876880">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="keyword" id="5876883">func</span>&nbsp;<span class="ident" id="5876888">writeRuntimeProfile</span><span class="op" id="5876907">(</span><span class="ident" id="5876908">w</span>&nbsp;<span class="ident" id="5876910">io</span><span class="op" id="5876912">.</span><span class="ident" id="5876913">Writer</span><span class="op" id="5876919">,</span>&nbsp;<span class="ident" id="5876921">debug</span>&nbsp;<span class="builtintype" id="5876927">int</span><span class="op" id="5876930">,</span>&nbsp;<span class="ident" id="5876932">name</span>&nbsp;<span class="builtintype" id="5876937">string</span><span class="op" id="5876943">,</span>&nbsp;<span class="ident" id="5876945">fetch</span>&nbsp;<span class="keyword" id="5876951">func</span><span class="op" id="5876955">(</span><span class="op" id="5876956">[</span><span class="op" id="5876957">]</span><span class="ident" id="5876958">runtime</span><span class="op" id="5876965">.</span><span class="ident" id="5876966">StackRecord</span><span class="op" id="5876977">)</span>&nbsp;<span class="op" id="5876979">(</span><span class="builtintype" id="5876980">int</span><span class="op" id="5876983">,</span>&nbsp;<span class="builtintype" id="5876985">bool</span><span class="op" id="5876989">)</span><span class="op" id="5876990">)</span>&nbsp;<span class="builtintype" id="5876992">error</span>&nbsp;<span class="op" id="5876998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877001">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(fetch(nil)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877055">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877105">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877162">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877225">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877271">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877338">var</span>&nbsp;<span class="ident" id="5877342">p</span>&nbsp;<span class="op" id="5877344">[</span><span class="op" id="5877345">]</span><span class="ident" id="5877346">runtime</span><span class="op" id="5877353">.</span><span class="ident" id="5877354">StackRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877367">n</span><span class="op" id="5877368">,</span>&nbsp;<span class="ident" id="5877370">ok</span>&nbsp;<span class="op" id="5877373">:=</span>&nbsp;<span class="ident" id="5877376">fetch</span><span class="op" id="5877381">(</span><span class="ident" id="5877382">nil</span><span class="op" id="5877385">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877388">for</span>&nbsp;<span class="op" id="5877392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877396">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877446">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877494">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;ThreadProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877532">p</span>&nbsp;<span class="op" id="5877534">=</span>&nbsp;<span class="builtinfunc" id="5877536">make</span><span class="op" id="5877540">(</span><span class="op" id="5877541">[</span><span class="op" id="5877542">]</span><span class="ident" id="5877543">runtime</span><span class="op" id="5877550">.</span><span class="ident" id="5877551">StackRecord</span><span class="op" id="5877562">,</span>&nbsp;<span class="ident" id="5877564">n</span><span class="op" id="5877565">+</span><span class="num" id="5877566">10</span><span class="op" id="5877568">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877572">n</span><span class="op" id="5877573">,</span>&nbsp;<span class="ident" id="5877575">ok</span>&nbsp;<span class="op" id="5877578">=</span>&nbsp;<span class="ident" id="5877580">fetch</span><span class="op" id="5877585">(</span><span class="ident" id="5877586">p</span><span class="op" id="5877587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877591">if</span>&nbsp;<span class="ident" id="5877594">ok</span>&nbsp;<span class="op" id="5877597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877602">p</span>&nbsp;<span class="op" id="5877604">=</span>&nbsp;<span class="ident" id="5877606">p</span><span class="op" id="5877607">[</span><span class="num" id="5877608">0</span><span class="op" id="5877609">:</span><span class="ident" id="5877610">n</span><span class="op" id="5877611">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877616">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5877624">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877628">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5877657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877661">return</span>&nbsp;<span class="ident" id="5877668">printCountProfile</span><span class="op" id="5877685">(</span><span class="ident" id="5877686">w</span><span class="op" id="5877687">,</span>&nbsp;<span class="ident" id="5877689">debug</span><span class="op" id="5877694">,</span>&nbsp;<span class="ident" id="5877696">name</span><span class="op" id="5877700">,</span>&nbsp;<span class="ident" id="5877702">runtimeProfile</span><span class="op" id="5877716">(</span><span class="ident" id="5877717">p</span><span class="op" id="5877718">)</span><span class="op" id="5877719">)</span><br>
<span class="lineno"></span><span class="op" id="5877721">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="5877724">type</span>&nbsp;<span class="ident" id="5877729">runtimeProfile</span>&nbsp;<span class="op" id="5877744">[</span><span class="op" id="5877745">]</span><span class="ident" id="5877746">runtime</span><span class="op" id="5877753">.</span><span class="ident" id="5877754">StackRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5877767">func</span>&nbsp;<span class="op" id="5877772">(</span><span class="ident" id="5877773">p</span>&nbsp;<span class="ident" id="5877775">runtimeProfile</span><span class="op" id="5877789">)</span>&nbsp;<span class="ident" id="5877791">Len</span><span class="op" id="5877794">(</span><span class="op" id="5877795">)</span>&nbsp;<span class="builtintype" id="5877797">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5877814">{</span>&nbsp;<span class="keyword" id="5877816">return</span>&nbsp;<span class="builtinfunc" id="5877823">len</span><span class="op" id="5877826">(</span><span class="ident" id="5877827">p</span><span class="op" id="5877828">)</span>&nbsp;<span class="op" id="5877830">}</span><br>
<span class="lineno"></span><span class="keyword" id="5877832">func</span>&nbsp;<span class="op" id="5877837">(</span><span class="ident" id="5877838">p</span>&nbsp;<span class="ident" id="5877840">runtimeProfile</span><span class="op" id="5877854">)</span>&nbsp;<span class="ident" id="5877856">Stack</span><span class="op" id="5877861">(</span><span class="ident" id="5877862">i</span>&nbsp;<span class="builtintype" id="5877864">int</span><span class="op" id="5877867">)</span>&nbsp;<span class="op" id="5877869">[</span><span class="op" id="5877870">]</span><span class="builtintype" id="5877871">uintptr</span>&nbsp;<span class="op" id="5877879">{</span>&nbsp;<span class="keyword" id="5877881">return</span>&nbsp;<span class="ident" id="5877888">p</span><span class="op" id="5877889">[</span><span class="ident" id="5877890">i</span><span class="op" id="5877891">]</span><span class="op" id="5877892">.</span><span class="ident" id="5877893">Stack</span><span class="op" id="5877898">(</span><span class="op" id="5877899">)</span>&nbsp;<span class="op" id="5877901">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span><span class="keyword" id="5877904">var</span>&nbsp;<span class="ident" id="5877908">cpu</span>&nbsp;<span class="keyword" id="5877912">struct</span>&nbsp;<span class="op" id="5877919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877922">sync</span><span class="op" id="5877926">.</span><span class="ident" id="5877927">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877934">profiling</span>&nbsp;<span class="builtintype" id="5877944">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877950">done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5877960">chan</span>&nbsp;<span class="builtintype" id="5877965">bool</span><br>
<span class="lineno">560</span><span class="op" id="5877970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5877973">//&nbsp;StartCPUProfile&nbsp;enables&nbsp;CPU&nbsp;profiling&nbsp;for&nbsp;the&nbsp;current&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="5878039">//&nbsp;While&nbsp;profiling,&nbsp;the&nbsp;profile&nbsp;will&nbsp;be&nbsp;buffered&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5878106">//&nbsp;StartCPUProfile&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;profiling&nbsp;is&nbsp;already&nbsp;enabled.</span><br>
<span class="lineno">565</span><span class="keyword" id="5878175">func</span>&nbsp;<span class="ident" id="5878180">StartCPUProfile</span><span class="op" id="5878195">(</span><span class="ident" id="5878196">w</span>&nbsp;<span class="ident" id="5878198">io</span><span class="op" id="5878200">.</span><span class="ident" id="5878201">Writer</span><span class="op" id="5878207">)</span>&nbsp;<span class="builtintype" id="5878209">error</span>&nbsp;<span class="op" id="5878215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878218">//&nbsp;The&nbsp;runtime&nbsp;routines&nbsp;allow&nbsp;a&nbsp;variable&nbsp;profiling&nbsp;rate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878276">//&nbsp;but&nbsp;in&nbsp;practice&nbsp;operating&nbsp;systems&nbsp;cannot&nbsp;trigger&nbsp;signals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878337">//&nbsp;at&nbsp;more&nbsp;than&nbsp;about&nbsp;500&nbsp;Hz,&nbsp;and&nbsp;our&nbsp;processing&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878394">//&nbsp;signal&nbsp;is&nbsp;not&nbsp;cheap&nbsp;(mostly&nbsp;getting&nbsp;the&nbsp;stack&nbsp;trace).</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878452">//&nbsp;100&nbsp;Hz&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;choice:&nbsp;it&nbsp;is&nbsp;frequent&nbsp;enough&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878512">//&nbsp;produce&nbsp;useful&nbsp;data,&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bog&nbsp;down&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878569">//&nbsp;system,&nbsp;and&nbsp;a&nbsp;nice&nbsp;round&nbsp;number&nbsp;to&nbsp;make&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878624">//&nbsp;convert&nbsp;sample&nbsp;counts&nbsp;to&nbsp;seconds.&nbsp;&nbsp;Instead&nbsp;of&nbsp;requiring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878684">//&nbsp;each&nbsp;client&nbsp;to&nbsp;specify&nbsp;the&nbsp;frequency,&nbsp;we&nbsp;hard&nbsp;code&nbsp;it.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878743">const</span>&nbsp;<span class="ident" id="5878749">hz</span>&nbsp;<span class="op" id="5878752">=</span>&nbsp;<span class="num" id="5878754">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878760">cpu</span><span class="op" id="5878763">.</span><span class="ident" id="5878764">Lock</span><span class="op" id="5878768">(</span><span class="op" id="5878769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878772">defer</span>&nbsp;<span class="ident" id="5878778">cpu</span><span class="op" id="5878781">.</span><span class="ident" id="5878782">Unlock</span><span class="op" id="5878788">(</span><span class="op" id="5878789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878792">if</span>&nbsp;<span class="ident" id="5878795">cpu</span><span class="op" id="5878798">.</span><span class="ident" id="5878799">done</span>&nbsp;<span class="op" id="5878804">==</span>&nbsp;<span class="ident" id="5878807">nil</span>&nbsp;<span class="op" id="5878811">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878815">cpu</span><span class="op" id="5878818">.</span><span class="ident" id="5878819">done</span>&nbsp;<span class="op" id="5878824">=</span>&nbsp;<span class="builtinfunc" id="5878826">make</span><span class="op" id="5878830">(</span><span class="keyword" id="5878831">chan</span>&nbsp;<span class="builtintype" id="5878836">bool</span><span class="op" id="5878840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878846">//&nbsp;Double-check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878864">if</span>&nbsp;<span class="ident" id="5878867">cpu</span><span class="op" id="5878870">.</span><span class="ident" id="5878871">profiling</span>&nbsp;<span class="op" id="5878881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878885">return</span>&nbsp;<span class="ident" id="5878892">fmt</span><span class="op" id="5878895">.</span><span class="ident" id="5878896">Errorf</span><span class="op" id="5878902">(</span><span class="string" id="5878903">&#34;cpu&nbsp;profiling&nbsp;already&nbsp;in&nbsp;use&#34;</span><span class="op" id="5878933">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878939">cpu</span><span class="op" id="5878942">.</span><span class="ident" id="5878943">profiling</span>&nbsp;<span class="op" id="5878953">=</span>&nbsp;<span class="builtintype" id="5878955">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878961">runtime</span><span class="op" id="5878968">.</span><span class="ident" id="5878969">SetCPUProfileRate</span><span class="op" id="5878986">(</span><span class="ident" id="5878987">hz</span><span class="op" id="5878989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878992">go</span>&nbsp;<span class="ident" id="5878995">profileWriter</span><span class="op" id="5879008">(</span><span class="ident" id="5879009">w</span><span class="op" id="5879010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879013">return</span>&nbsp;<span class="ident" id="5879020">nil</span><br>
<span class="lineno">590</span><span class="op" id="5879024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5879027">func</span>&nbsp;<span class="ident" id="5879032">profileWriter</span><span class="op" id="5879045">(</span><span class="ident" id="5879046">w</span>&nbsp;<span class="ident" id="5879048">io</span><span class="op" id="5879050">.</span><span class="ident" id="5879051">Writer</span><span class="op" id="5879057">)</span>&nbsp;<span class="op" id="5879059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879062">for</span>&nbsp;<span class="op" id="5879066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879070">data</span>&nbsp;<span class="op" id="5879075">:=</span>&nbsp;<span class="ident" id="5879078">runtime</span><span class="op" id="5879085">.</span><span class="ident" id="5879086">CPUProfile</span><span class="op" id="5879096">(</span><span class="op" id="5879097">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879101">if</span>&nbsp;<span class="ident" id="5879104">data</span>&nbsp;<span class="op" id="5879109">==</span>&nbsp;<span class="ident" id="5879112">nil</span>&nbsp;<span class="op" id="5879116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879121">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879133">w</span><span class="op" id="5879134">.</span><span class="ident" id="5879135">Write</span><span class="op" id="5879140">(</span><span class="ident" id="5879141">data</span><span class="op" id="5879145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879148">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879151">cpu</span><span class="op" id="5879154">.</span><span class="ident" id="5879155">done</span>&nbsp;<span class="op" id="5879160">&lt;-</span>&nbsp;<span class="builtintype" id="5879163">true</span><br>
<span class="lineno"></span><span class="op" id="5879168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5879171">//&nbsp;StopCPUProfile&nbsp;stops&nbsp;the&nbsp;current&nbsp;CPU&nbsp;profile,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="5879228">//&nbsp;StopCPUProfile&nbsp;only&nbsp;returns&nbsp;after&nbsp;all&nbsp;the&nbsp;writes&nbsp;for&nbsp;the</span><br>
<span class="lineno">605</span><span class="comment" id="5879288">//&nbsp;profile&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5879315">func</span>&nbsp;<span class="ident" id="5879320">StopCPUProfile</span><span class="op" id="5879334">(</span><span class="op" id="5879335">)</span>&nbsp;<span class="op" id="5879337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879340">cpu</span><span class="op" id="5879343">.</span><span class="ident" id="5879344">Lock</span><span class="op" id="5879348">(</span><span class="op" id="5879349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879352">defer</span>&nbsp;<span class="ident" id="5879358">cpu</span><span class="op" id="5879361">.</span><span class="ident" id="5879362">Unlock</span><span class="op" id="5879368">(</span><span class="op" id="5879369">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879373">if</span>&nbsp;<span class="op" id="5879376">!</span><span class="ident" id="5879377">cpu</span><span class="op" id="5879380">.</span><span class="ident" id="5879381">profiling</span>&nbsp;<span class="op" id="5879391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879395">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879406">cpu</span><span class="op" id="5879409">.</span><span class="ident" id="5879410">profiling</span>&nbsp;<span class="op" id="5879420">=</span>&nbsp;<span class="builtintype" id="5879422">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879429">runtime</span><span class="op" id="5879436">.</span><span class="ident" id="5879437">SetCPUProfileRate</span><span class="op" id="5879454">(</span><span class="num" id="5879455">0</span><span class="op" id="5879456">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879459">&lt;-</span><span class="ident" id="5879461">cpu</span><span class="op" id="5879464">.</span><span class="ident" id="5879465">done</span><br>
<span class="lineno"></span><span class="op" id="5879470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5879473">type</span>&nbsp;<span class="ident" id="5879478">byCycles</span>&nbsp;<span class="op" id="5879487">[</span><span class="op" id="5879488">]</span><span class="ident" id="5879489">runtime</span><span class="op" id="5879496">.</span><span class="ident" id="5879497">BlockProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="5879517">func</span>&nbsp;<span class="op" id="5879522">(</span><span class="ident" id="5879523">x</span>&nbsp;<span class="ident" id="5879525">byCycles</span><span class="op" id="5879533">)</span>&nbsp;<span class="ident" id="5879535">Len</span><span class="op" id="5879538">(</span><span class="op" id="5879539">)</span>&nbsp;<span class="builtintype" id="5879541">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5879555">{</span>&nbsp;<span class="keyword" id="5879557">return</span>&nbsp;<span class="builtinfunc" id="5879564">len</span><span class="op" id="5879567">(</span><span class="ident" id="5879568">x</span><span class="op" id="5879569">)</span>&nbsp;<span class="op" id="5879571">}</span><br>
<span class="lineno"></span><span class="keyword" id="5879573">func</span>&nbsp;<span class="op" id="5879578">(</span><span class="ident" id="5879579">x</span>&nbsp;<span class="ident" id="5879581">byCycles</span><span class="op" id="5879589">)</span>&nbsp;<span class="ident" id="5879591">Swap</span><span class="op" id="5879595">(</span><span class="ident" id="5879596">i</span><span class="op" id="5879597">,</span>&nbsp;<span class="ident" id="5879599">j</span>&nbsp;<span class="builtintype" id="5879601">int</span><span class="op" id="5879604">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5879611">{</span>&nbsp;<span class="ident" id="5879613">x</span><span class="op" id="5879614">[</span><span class="ident" id="5879615">i</span><span class="op" id="5879616">]</span><span class="op" id="5879617">,</span>&nbsp;<span class="ident" id="5879619">x</span><span class="op" id="5879620">[</span><span class="ident" id="5879621">j</span><span class="op" id="5879622">]</span>&nbsp;<span class="op" id="5879624">=</span>&nbsp;<span class="ident" id="5879626">x</span><span class="op" id="5879627">[</span><span class="ident" id="5879628">j</span><span class="op" id="5879629">]</span><span class="op" id="5879630">,</span>&nbsp;<span class="ident" id="5879632">x</span><span class="op" id="5879633">[</span><span class="ident" id="5879634">i</span><span class="op" id="5879635">]</span>&nbsp;<span class="op" id="5879637">}</span><br>
<span class="lineno"></span><span class="keyword" id="5879639">func</span>&nbsp;<span class="op" id="5879644">(</span><span class="ident" id="5879645">x</span>&nbsp;<span class="ident" id="5879647">byCycles</span><span class="op" id="5879655">)</span>&nbsp;<span class="ident" id="5879657">Less</span><span class="op" id="5879661">(</span><span class="ident" id="5879662">i</span><span class="op" id="5879663">,</span>&nbsp;<span class="ident" id="5879665">j</span>&nbsp;<span class="builtintype" id="5879667">int</span><span class="op" id="5879670">)</span>&nbsp;<span class="builtintype" id="5879672">bool</span>&nbsp;<span class="op" id="5879677">{</span>&nbsp;<span class="keyword" id="5879679">return</span>&nbsp;<span class="ident" id="5879686">x</span><span class="op" id="5879687">[</span><span class="ident" id="5879688">i</span><span class="op" id="5879689">]</span><span class="op" id="5879690">.</span><span class="ident" id="5879691">Cycles</span>&nbsp;<span class="op" id="5879698">&gt;</span>&nbsp;<span class="ident" id="5879700">x</span><span class="op" id="5879701">[</span><span class="ident" id="5879702">j</span><span class="op" id="5879703">]</span><span class="op" id="5879704">.</span><span class="ident" id="5879705">Cycles</span>&nbsp;<span class="op" id="5879712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5879715">//&nbsp;countBlock&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno">625</span><span class="keyword" id="5879784">func</span>&nbsp;<span class="ident" id="5879789">countBlock</span><span class="op" id="5879799">(</span><span class="op" id="5879800">)</span>&nbsp;<span class="builtintype" id="5879802">int</span>&nbsp;<span class="op" id="5879806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879809">n</span><span class="op" id="5879810">,</span>&nbsp;<span class="ident" id="5879812">_</span>&nbsp;<span class="op" id="5879814">:=</span>&nbsp;<span class="ident" id="5879817">runtime</span><span class="op" id="5879824">.</span><span class="ident" id="5879825">BlockProfile</span><span class="op" id="5879837">(</span><span class="ident" id="5879838">nil</span><span class="op" id="5879841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879844">return</span>&nbsp;<span class="ident" id="5879851">n</span><br>
<span class="lineno"></span><span class="op" id="5879853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="comment" id="5879856">//&nbsp;writeBlock&nbsp;writes&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5879912">func</span>&nbsp;<span class="ident" id="5879917">writeBlock</span><span class="op" id="5879927">(</span><span class="ident" id="5879928">w</span>&nbsp;<span class="ident" id="5879930">io</span><span class="op" id="5879932">.</span><span class="ident" id="5879933">Writer</span><span class="op" id="5879939">,</span>&nbsp;<span class="ident" id="5879941">debug</span>&nbsp;<span class="builtintype" id="5879947">int</span><span class="op" id="5879950">)</span>&nbsp;<span class="builtintype" id="5879952">error</span>&nbsp;<span class="op" id="5879958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879961">var</span>&nbsp;<span class="ident" id="5879965">p</span>&nbsp;<span class="op" id="5879967">[</span><span class="op" id="5879968">]</span><span class="ident" id="5879969">runtime</span><span class="op" id="5879976">.</span><span class="ident" id="5879977">BlockProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879997">n</span><span class="op" id="5879998">,</span>&nbsp;<span class="ident" id="5880000">ok</span>&nbsp;<span class="op" id="5880003">:=</span>&nbsp;<span class="ident" id="5880006">runtime</span><span class="op" id="5880013">.</span><span class="ident" id="5880014">BlockProfile</span><span class="op" id="5880026">(</span><span class="ident" id="5880027">nil</span><span class="op" id="5880030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880033">for</span>&nbsp;<span class="op" id="5880037">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880041">p</span>&nbsp;<span class="op" id="5880043">=</span>&nbsp;<span class="builtinfunc" id="5880045">make</span><span class="op" id="5880049">(</span><span class="op" id="5880050">[</span><span class="op" id="5880051">]</span><span class="ident" id="5880052">runtime</span><span class="op" id="5880059">.</span><span class="ident" id="5880060">BlockProfileRecord</span><span class="op" id="5880078">,</span>&nbsp;<span class="ident" id="5880080">n</span><span class="op" id="5880081">+</span><span class="num" id="5880082">50</span><span class="op" id="5880084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880088">n</span><span class="op" id="5880089">,</span>&nbsp;<span class="ident" id="5880091">ok</span>&nbsp;<span class="op" id="5880094">=</span>&nbsp;<span class="ident" id="5880096">runtime</span><span class="op" id="5880103">.</span><span class="ident" id="5880104">BlockProfile</span><span class="op" id="5880116">(</span><span class="ident" id="5880117">p</span><span class="op" id="5880118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880122">if</span>&nbsp;<span class="ident" id="5880125">ok</span>&nbsp;<span class="op" id="5880128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880133">p</span>&nbsp;<span class="op" id="5880135">=</span>&nbsp;<span class="ident" id="5880137">p</span><span class="op" id="5880138">[</span><span class="op" id="5880139">:</span><span class="ident" id="5880140">n</span><span class="op" id="5880141">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880146">break</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880161">sort</span><span class="op" id="5880165">.</span><span class="ident" id="5880166">Sort</span><span class="op" id="5880170">(</span><span class="ident" id="5880171">byCycles</span><span class="op" id="5880179">(</span><span class="ident" id="5880180">p</span><span class="op" id="5880181">)</span><span class="op" id="5880182">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880186">b</span>&nbsp;<span class="op" id="5880188">:=</span>&nbsp;<span class="ident" id="5880191">bufio</span><span class="op" id="5880196">.</span><span class="ident" id="5880197">NewWriter</span><span class="op" id="5880206">(</span><span class="ident" id="5880207">w</span><span class="op" id="5880208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880211">var</span>&nbsp;<span class="ident" id="5880215">tw</span>&nbsp;<span class="op" id="5880218">*</span><span class="ident" id="5880219">tabwriter</span><span class="op" id="5880228">.</span><span class="ident" id="5880229">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880237">w</span>&nbsp;<span class="op" id="5880239">=</span>&nbsp;<span class="ident" id="5880241">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880244">if</span>&nbsp;<span class="ident" id="5880247">debug</span>&nbsp;<span class="op" id="5880253">&gt;</span>&nbsp;<span class="num" id="5880255">0</span>&nbsp;<span class="op" id="5880257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880261">tw</span>&nbsp;<span class="op" id="5880264">=</span>&nbsp;<span class="ident" id="5880266">tabwriter</span><span class="op" id="5880275">.</span><span class="ident" id="5880276">NewWriter</span><span class="op" id="5880285">(</span><span class="ident" id="5880286">w</span><span class="op" id="5880287">,</span>&nbsp;<span class="num" id="5880289">1</span><span class="op" id="5880290">,</span>&nbsp;<span class="num" id="5880292">8</span><span class="op" id="5880293">,</span>&nbsp;<span class="num" id="5880295">1</span><span class="op" id="5880296">,</span>&nbsp;<span class="string" id="5880298">&#39;\t&#39;</span><span class="op" id="5880302">,</span>&nbsp;<span class="num" id="5880304">0</span><span class="op" id="5880305">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880309">w</span>&nbsp;<span class="op" id="5880311">=</span>&nbsp;<span class="ident" id="5880313">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880321">fmt</span><span class="op" id="5880324">.</span><span class="ident" id="5880325">Fprintf</span><span class="op" id="5880332">(</span><span class="ident" id="5880333">w</span><span class="op" id="5880334">,</span>&nbsp;<span class="string" id="5880336">&#34;---&nbsp;contention:\n&#34;</span><span class="op" id="5880355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880358">fmt</span><span class="op" id="5880361">.</span><span class="ident" id="5880362">Fprintf</span><span class="op" id="5880369">(</span><span class="ident" id="5880370">w</span><span class="op" id="5880371">,</span>&nbsp;<span class="string" id="5880373">&#34;cycles/second=%v\n&#34;</span><span class="op" id="5880393">,</span>&nbsp;<span class="ident" id="5880395">runtime_cyclesPerSecond</span><span class="op" id="5880418">(</span><span class="op" id="5880419">)</span><span class="op" id="5880420">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880423">for</span>&nbsp;<span class="ident" id="5880427">i</span>&nbsp;<span class="op" id="5880429">:=</span>&nbsp;<span class="keyword" id="5880432">range</span>&nbsp;<span class="ident" id="5880438">p</span>&nbsp;<span class="op" id="5880440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880444">r</span>&nbsp;<span class="op" id="5880446">:=</span>&nbsp;<span class="op" id="5880449">&amp;</span><span class="ident" id="5880450">p</span><span class="op" id="5880451">[</span><span class="ident" id="5880452">i</span><span class="op" id="5880453">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880457">fmt</span><span class="op" id="5880460">.</span><span class="ident" id="5880461">Fprintf</span><span class="op" id="5880468">(</span><span class="ident" id="5880469">w</span><span class="op" id="5880470">,</span>&nbsp;<span class="string" id="5880472">&#34;%v&nbsp;%v&nbsp;@&#34;</span><span class="op" id="5880481">,</span>&nbsp;<span class="ident" id="5880483">r</span><span class="op" id="5880484">.</span><span class="ident" id="5880485">Cycles</span><span class="op" id="5880491">,</span>&nbsp;<span class="ident" id="5880493">r</span><span class="op" id="5880494">.</span><span class="ident" id="5880495">Count</span><span class="op" id="5880500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880504">for</span>&nbsp;<span class="ident" id="5880508">_</span><span class="op" id="5880509">,</span>&nbsp;<span class="ident" id="5880511">pc</span>&nbsp;<span class="op" id="5880514">:=</span>&nbsp;<span class="keyword" id="5880517">range</span>&nbsp;<span class="ident" id="5880523">r</span><span class="op" id="5880524">.</span><span class="ident" id="5880525">Stack</span><span class="op" id="5880530">(</span><span class="op" id="5880531">)</span>&nbsp;<span class="op" id="5880533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880538">fmt</span><span class="op" id="5880541">.</span><span class="ident" id="5880542">Fprintf</span><span class="op" id="5880549">(</span><span class="ident" id="5880550">w</span><span class="op" id="5880551">,</span>&nbsp;<span class="string" id="5880553">&#34;&nbsp;%#x&#34;</span><span class="op" id="5880559">,</span>&nbsp;<span class="ident" id="5880561">pc</span><span class="op" id="5880563">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880571">fmt</span><span class="op" id="5880574">.</span><span class="ident" id="5880575">Fprint</span><span class="op" id="5880581">(</span><span class="ident" id="5880582">w</span><span class="op" id="5880583">,</span>&nbsp;<span class="string" id="5880585">&#34;\n&#34;</span><span class="op" id="5880589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880593">if</span>&nbsp;<span class="ident" id="5880596">debug</span>&nbsp;<span class="op" id="5880602">&gt;</span>&nbsp;<span class="num" id="5880604">0</span>&nbsp;<span class="op" id="5880606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880611">printStackRecord</span><span class="op" id="5880627">(</span><span class="ident" id="5880628">w</span><span class="op" id="5880629">,</span>&nbsp;<span class="ident" id="5880631">r</span><span class="op" id="5880632">.</span><span class="ident" id="5880633">Stack</span><span class="op" id="5880638">(</span><span class="op" id="5880639">)</span><span class="op" id="5880640">,</span>&nbsp;<span class="builtintype" id="5880642">true</span><span class="op" id="5880646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880650">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880657">if</span>&nbsp;<span class="ident" id="5880660">tw</span>&nbsp;<span class="op" id="5880663">!=</span>&nbsp;<span class="ident" id="5880666">nil</span>&nbsp;<span class="op" id="5880670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880674">tw</span><span class="op" id="5880676">.</span><span class="ident" id="5880677">Flush</span><span class="op" id="5880682">(</span><span class="op" id="5880683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880686">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880689">return</span>&nbsp;<span class="ident" id="5880696">b</span><span class="op" id="5880697">.</span><span class="ident" id="5880698">Flush</span><span class="op" id="5880703">(</span><span class="op" id="5880704">)</span><br>
<span class="lineno"></span><span class="op" id="5880706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5880709">func</span>&nbsp;<span class="ident" id="5880714">runtime_cyclesPerSecond</span><span class="op" id="5880737">(</span><span class="op" id="5880738">)</span>&nbsp;<span class="ident" id="5880740">int64</span>
</div>
</body>
</html>
