<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3760040">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3760096">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3760150">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3760201">package</span>&nbsp;<span class="ident" id="3760209">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3760220">import</span>&nbsp;<span class="op" id="3760227">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3760230">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3760237">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="3760240">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="3760310">//</span><br>
<span class="lineno"></span><span class="comment" id="3760313">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="3760380">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="3760407">//</span><br>
<span class="lineno"></span><span class="comment" id="3760410">//&nbsp;&nbsp;&nbsp;&nbspid&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="3760445">//</span><br>
<span class="lineno"></span><span class="comment" id="3760448">//&nbsp;&nbsp;&nbsp;&nbspp.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3760503">//&nbsp;&nbsp;&nbsp;&nbsp«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="3760523">//&nbsp;&nbsp;&nbsp;&nbspp.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3760583">//</span><br>
<span class="lineno"></span><span class="comment" id="3760586">//&nbsp;&nbsp;&nbsp;&nbspp.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3760643">//&nbsp;&nbsp;&nbsp;&nbsp«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="3760664">//&nbsp;&nbsp;&nbsp;&nbspp.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="3760726">//</span><br>
<span class="lineno"></span><span class="comment" id="3760729">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3760789">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="3760857">type</span>&nbsp;<span class="ident" id="3760862">Pipeline</span>&nbsp;<span class="keyword" id="3760871">struct</span>&nbsp;<span class="op" id="3760878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3760881">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3760890">sync</span><span class="op" id="3760894">.</span><span class="ident" id="3760895">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3760902">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3760911">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3760917">request</span>&nbsp;&nbsp;<span class="ident" id="3760926">sequencer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3760937">response</span>&nbsp;<span class="ident" id="3760946">sequencer</span><br>
<span class="lineno"></span><span class="op" id="3760956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3760959">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="3761016">func</span>&nbsp;<span class="op" id="3761021">(</span><span class="ident" id="3761022">p</span>&nbsp;<span class="op" id="3761024">*</span><span class="ident" id="3761025">Pipeline</span><span class="op" id="3761033">)</span>&nbsp;<span class="ident" id="3761035">Next</span><span class="op" id="3761039">(</span><span class="op" id="3761040">)</span>&nbsp;<span class="builtintype" id="3761042">uint</span>&nbsp;<span class="op" id="3761047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3761050">p</span><span class="op" id="3761051">.</span><span class="ident" id="3761052">mu</span><span class="op" id="3761054">.</span><span class="ident" id="3761055">Lock</span><span class="op" id="3761059">(</span><span class="op" id="3761060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3761063">id</span>&nbsp;<span class="op" id="3761066">:=</span>&nbsp;<span class="ident" id="3761069">p</span><span class="op" id="3761070">.</span><span class="ident" id="3761071">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3761075">p</span><span class="op" id="3761076">.</span><span class="ident" id="3761077">id</span><span class="op" id="3761079">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3761083">p</span><span class="op" id="3761084">.</span><span class="ident" id="3761085">mu</span><span class="op" id="3761087">.</span><span class="ident" id="3761088">Unlock</span><span class="op" id="3761094">(</span><span class="op" id="3761095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3761098">return</span>&nbsp;<span class="ident" id="3761105">id</span><br>
<span class="lineno"></span><span class="op" id="3761108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3761111">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="3761194">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3761228">func</span>&nbsp;<span class="op" id="3761233">(</span><span class="ident" id="3761234">p</span>&nbsp;<span class="op" id="3761236">*</span><span class="ident" id="3761237">Pipeline</span><span class="op" id="3761245">)</span>&nbsp;<span class="ident" id="3761247">StartRequest</span><span class="op" id="3761259">(</span><span class="ident" id="3761260">id</span>&nbsp;<span class="builtintype" id="3761263">uint</span><span class="op" id="3761267">)</span>&nbsp;<span class="op" id="3761269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3761272">p</span><span class="op" id="3761273">.</span><span class="ident" id="3761274">request</span><span class="op" id="3761281">.</span><span class="ident" id="3761282">Start</span><span class="op" id="3761287">(</span><span class="ident" id="3761288">id</span><span class="op" id="3761290">)</span><br>
<span class="lineno"></span><span class="op" id="3761292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3761295">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3761369">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="3761409">func</span>&nbsp;<span class="op" id="3761414">(</span><span class="ident" id="3761415">p</span>&nbsp;<span class="op" id="3761417">*</span><span class="ident" id="3761418">Pipeline</span><span class="op" id="3761426">)</span>&nbsp;<span class="ident" id="3761428">EndRequest</span><span class="op" id="3761438">(</span><span class="ident" id="3761439">id</span>&nbsp;<span class="builtintype" id="3761442">uint</span><span class="op" id="3761446">)</span>&nbsp;<span class="op" id="3761448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3761451">p</span><span class="op" id="3761452">.</span><span class="ident" id="3761453">request</span><span class="op" id="3761460">.</span><span class="ident" id="3761461">End</span><span class="op" id="3761464">(</span><span class="ident" id="3761465">id</span><span class="op" id="3761467">)</span><br>
<span class="lineno"></span><span class="op" id="3761469">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="3761472">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="3761556">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3761590">func</span>&nbsp;<span class="op" id="3761595">(</span><span class="ident" id="3761596">p</span>&nbsp;<span class="op" id="3761598">*</span><span class="ident" id="3761599">Pipeline</span><span class="op" id="3761607">)</span>&nbsp;<span class="ident" id="3761609">StartResponse</span><span class="op" id="3761622">(</span><span class="ident" id="3761623">id</span>&nbsp;<span class="builtintype" id="3761626">uint</span><span class="op" id="3761630">)</span>&nbsp;<span class="op" id="3761632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3761635">p</span><span class="op" id="3761636">.</span><span class="ident" id="3761637">response</span><span class="op" id="3761645">.</span><span class="ident" id="3761646">Start</span><span class="op" id="3761651">(</span><span class="ident" id="3761652">id</span><span class="op" id="3761654">)</span><br>
<span class="lineno">60</span><span class="op" id="3761656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3761659">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="3761739">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="3761775">func</span>&nbsp;<span class="op" id="3761780">(</span><span class="ident" id="3761781">p</span>&nbsp;<span class="op" id="3761783">*</span><span class="ident" id="3761784">Pipeline</span><span class="op" id="3761792">)</span>&nbsp;<span class="ident" id="3761794">EndResponse</span><span class="op" id="3761805">(</span><span class="ident" id="3761806">id</span>&nbsp;<span class="builtintype" id="3761809">uint</span><span class="op" id="3761813">)</span>&nbsp;<span class="op" id="3761815">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3761818">p</span><span class="op" id="3761819">.</span><span class="ident" id="3761820">response</span><span class="op" id="3761828">.</span><span class="ident" id="3761829">End</span><span class="op" id="3761832">(</span><span class="ident" id="3761833">id</span><span class="op" id="3761835">)</span><br>
<span class="lineno"></span><span class="op" id="3761837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3761840">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3761905">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="3761978">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="3762049">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="3762118">type</span>&nbsp;<span class="ident" id="3762123">sequencer</span>&nbsp;<span class="keyword" id="3762133">struct</span>&nbsp;<span class="op" id="3762140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762143">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3762148">sync</span><span class="op" id="3762152">.</span><span class="ident" id="3762153">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762160">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3762165">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762171">wait</span>&nbsp;<span class="keyword" id="3762176">map</span><span class="op" id="3762179">[</span><span class="builtintype" id="3762180">uint</span><span class="op" id="3762184">]</span><span class="keyword" id="3762185">chan</span>&nbsp;<span class="builtintype" id="3762190">uint</span><br>
<span class="lineno"></span><span class="op" id="3762195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3762198">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="3762266">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="3762335">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="3762351">func</span>&nbsp;<span class="op" id="3762356">(</span><span class="ident" id="3762357">s</span>&nbsp;<span class="op" id="3762359">*</span><span class="ident" id="3762360">sequencer</span><span class="op" id="3762369">)</span>&nbsp;<span class="ident" id="3762371">Start</span><span class="op" id="3762376">(</span><span class="ident" id="3762377">id</span>&nbsp;<span class="builtintype" id="3762380">uint</span><span class="op" id="3762384">)</span>&nbsp;<span class="op" id="3762386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762389">s</span><span class="op" id="3762390">.</span><span class="ident" id="3762391">mu</span><span class="op" id="3762393">.</span><span class="ident" id="3762394">Lock</span><span class="op" id="3762398">(</span><span class="op" id="3762399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3762402">if</span>&nbsp;<span class="ident" id="3762405">s</span><span class="op" id="3762406">.</span><span class="ident" id="3762407">id</span>&nbsp;<span class="op" id="3762410">==</span>&nbsp;<span class="ident" id="3762413">id</span>&nbsp;<span class="op" id="3762416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762420">s</span><span class="op" id="3762421">.</span><span class="ident" id="3762422">mu</span><span class="op" id="3762424">.</span><span class="ident" id="3762425">Unlock</span><span class="op" id="3762431">(</span><span class="op" id="3762432">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3762436">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3762444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762447">c</span>&nbsp;<span class="op" id="3762449">:=</span>&nbsp;<span class="builtinfunc" id="3762452">make</span><span class="op" id="3762456">(</span><span class="keyword" id="3762457">chan</span>&nbsp;<span class="builtintype" id="3762462">uint</span><span class="op" id="3762466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3762469">if</span>&nbsp;<span class="ident" id="3762472">s</span><span class="op" id="3762473">.</span><span class="ident" id="3762474">wait</span>&nbsp;<span class="op" id="3762479">==</span>&nbsp;<span class="ident" id="3762482">nil</span>&nbsp;<span class="op" id="3762486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762490">s</span><span class="op" id="3762491">.</span><span class="ident" id="3762492">wait</span>&nbsp;<span class="op" id="3762497">=</span>&nbsp;<span class="builtinfunc" id="3762499">make</span><span class="op" id="3762503">(</span><span class="keyword" id="3762504">map</span><span class="op" id="3762507">[</span><span class="builtintype" id="3762508">uint</span><span class="op" id="3762512">]</span><span class="keyword" id="3762513">chan</span>&nbsp;<span class="builtintype" id="3762518">uint</span><span class="op" id="3762522">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3762525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762528">s</span><span class="op" id="3762529">.</span><span class="ident" id="3762530">wait</span><span class="op" id="3762534">[</span><span class="ident" id="3762535">id</span><span class="op" id="3762537">]</span>&nbsp;<span class="op" id="3762539">=</span>&nbsp;<span class="ident" id="3762541">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762544">s</span><span class="op" id="3762545">.</span><span class="ident" id="3762546">mu</span><span class="op" id="3762548">.</span><span class="ident" id="3762549">Unlock</span><span class="op" id="3762555">(</span><span class="op" id="3762556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3762559">&lt;-</span><span class="ident" id="3762561">c</span><br>
<span class="lineno"></span><span class="op" id="3762563">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="3762566">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="3762638">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3762714">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="3762784">func</span>&nbsp;<span class="op" id="3762789">(</span><span class="ident" id="3762790">s</span>&nbsp;<span class="op" id="3762792">*</span><span class="ident" id="3762793">sequencer</span><span class="op" id="3762802">)</span>&nbsp;<span class="ident" id="3762804">End</span><span class="op" id="3762807">(</span><span class="ident" id="3762808">id</span>&nbsp;<span class="builtintype" id="3762811">uint</span><span class="op" id="3762815">)</span>&nbsp;<span class="op" id="3762817">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762820">s</span><span class="op" id="3762821">.</span><span class="ident" id="3762822">mu</span><span class="op" id="3762824">.</span><span class="ident" id="3762825">Lock</span><span class="op" id="3762829">(</span><span class="op" id="3762830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3762833">if</span>&nbsp;<span class="ident" id="3762836">s</span><span class="op" id="3762837">.</span><span class="ident" id="3762838">id</span>&nbsp;<span class="op" id="3762841">!=</span>&nbsp;<span class="ident" id="3762844">id</span>&nbsp;<span class="op" id="3762847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3762851">panic</span><span class="op" id="3762856">(</span><span class="string" id="3762857">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="3762870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3762873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762876">id</span><span class="op" id="3762878">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762882">s</span><span class="op" id="3762883">.</span><span class="ident" id="3762884">id</span>&nbsp;<span class="op" id="3762887">=</span>&nbsp;<span class="ident" id="3762889">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3762893">if</span>&nbsp;<span class="ident" id="3762896">s</span><span class="op" id="3762897">.</span><span class="ident" id="3762898">wait</span>&nbsp;<span class="op" id="3762903">==</span>&nbsp;<span class="ident" id="3762906">nil</span>&nbsp;<span class="op" id="3762910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762914">s</span><span class="op" id="3762915">.</span><span class="ident" id="3762916">wait</span>&nbsp;<span class="op" id="3762921">=</span>&nbsp;<span class="builtinfunc" id="3762923">make</span><span class="op" id="3762927">(</span><span class="keyword" id="3762928">map</span><span class="op" id="3762931">[</span><span class="builtintype" id="3762932">uint</span><span class="op" id="3762936">]</span><span class="keyword" id="3762937">chan</span>&nbsp;<span class="builtintype" id="3762942">uint</span><span class="op" id="3762946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3762949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3762952">c</span><span class="op" id="3762953">,</span>&nbsp;<span class="ident" id="3762955">ok</span>&nbsp;<span class="op" id="3762958">:=</span>&nbsp;<span class="ident" id="3762961">s</span><span class="op" id="3762962">.</span><span class="ident" id="3762963">wait</span><span class="op" id="3762967">[</span><span class="ident" id="3762968">id</span><span class="op" id="3762970">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3762973">if</span>&nbsp;<span class="ident" id="3762976">ok</span>&nbsp;<span class="op" id="3762979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3762983">delete</span><span class="op" id="3762989">(</span><span class="ident" id="3762990">s</span><span class="op" id="3762991">.</span><span class="ident" id="3762992">wait</span><span class="op" id="3762996">,</span>&nbsp;<span class="ident" id="3762998">id</span><span class="op" id="3763000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3763003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3763006">s</span><span class="op" id="3763007">.</span><span class="ident" id="3763008">mu</span><span class="op" id="3763010">.</span><span class="ident" id="3763011">Unlock</span><span class="op" id="3763017">(</span><span class="op" id="3763018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3763021">if</span>&nbsp;<span class="ident" id="3763024">ok</span>&nbsp;<span class="op" id="3763027">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3763031">c</span>&nbsp;<span class="op" id="3763033">&lt;-</span>&nbsp;<span class="num" id="3763036">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3763039">}</span><br>
<span class="lineno"></span><span class="op" id="3763041">}</span>
</div>
</body>
</html>
