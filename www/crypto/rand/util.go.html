<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3790766">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3790822">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3790876">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3790927">package</span>&nbsp;<span class="ident" id="3790935">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3790941">import</span>&nbsp;<span class="op" id="3790948">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3790951">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3790961">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3790967">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3790978">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3790981">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3791056">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3791133">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3791212">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3791291">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3791315">var</span>&nbsp;<span class="ident" id="3791319">smallPrimes</span>&nbsp;<span class="op" id="3791331">=</span>&nbsp;<span class="op" id="3791333">[</span><span class="op" id="3791334">]</span><span class="builtintype" id="3791335">uint8</span><span class="op" id="3791340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3791343">3</span><span class="op" id="3791344">,</span>&nbsp;<span class="num" id="3791346">5</span><span class="op" id="3791347">,</span>&nbsp;<span class="num" id="3791349">7</span><span class="op" id="3791350">,</span>&nbsp;<span class="num" id="3791352">11</span><span class="op" id="3791354">,</span>&nbsp;<span class="num" id="3791356">13</span><span class="op" id="3791358">,</span>&nbsp;<span class="num" id="3791360">17</span><span class="op" id="3791362">,</span>&nbsp;<span class="num" id="3791364">19</span><span class="op" id="3791366">,</span>&nbsp;<span class="num" id="3791368">23</span><span class="op" id="3791370">,</span>&nbsp;<span class="num" id="3791372">29</span><span class="op" id="3791374">,</span>&nbsp;<span class="num" id="3791376">31</span><span class="op" id="3791378">,</span>&nbsp;<span class="num" id="3791380">37</span><span class="op" id="3791382">,</span>&nbsp;<span class="num" id="3791384">41</span><span class="op" id="3791386">,</span>&nbsp;<span class="num" id="3791388">43</span><span class="op" id="3791390">,</span>&nbsp;<span class="num" id="3791392">47</span><span class="op" id="3791394">,</span>&nbsp;<span class="num" id="3791396">53</span><span class="op" id="3791398">,</span><br>
<span class="lineno">20</span><span class="op" id="3791400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3791403">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3791483">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3791561">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3791631">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3791646">var</span>&nbsp;<span class="ident" id="3791650">smallPrimesProduct</span>&nbsp;<span class="op" id="3791669">=</span>&nbsp;<span class="builtinfunc" id="3791671">new</span><span class="op" id="3791674">(</span><span class="ident" id="3791675">big</span><span class="op" id="3791678">.</span><span class="ident" id="3791679">Int</span><span class="op" id="3791682">)</span><span class="op" id="3791683">.</span><span class="ident" id="3791684">SetUint64</span><span class="op" id="3791693">(</span><span class="num" id="3791694">16294579238595022365</span><span class="op" id="3791714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3791717">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3791787">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3791813">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3791892">func</span>&nbsp;<span class="ident" id="3791897">Prime</span><span class="op" id="3791902">(</span><span class="ident" id="3791903">rand</span>&nbsp;<span class="ident" id="3791908">io</span><span class="op" id="3791910">.</span><span class="ident" id="3791911">Reader</span><span class="op" id="3791917">,</span>&nbsp;<span class="ident" id="3791919">bits</span>&nbsp;<span class="builtintype" id="3791924">int</span><span class="op" id="3791927">)</span>&nbsp;<span class="op" id="3791929">(</span><span class="ident" id="3791930">p</span>&nbsp;<span class="op" id="3791932">*</span><span class="ident" id="3791933">big</span><span class="op" id="3791936">.</span><span class="ident" id="3791937">Int</span><span class="op" id="3791940">,</span>&nbsp;<span class="ident" id="3791942">err</span>&nbsp;<span class="builtintype" id="3791946">error</span><span class="op" id="3791951">)</span>&nbsp;<span class="op" id="3791953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3791956">if</span>&nbsp;<span class="ident" id="3791959">bits</span>&nbsp;<span class="op" id="3791964">&lt;</span>&nbsp;<span class="num" id="3791966">2</span>&nbsp;<span class="op" id="3791968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791972">err</span>&nbsp;<span class="op" id="3791976">=</span>&nbsp;<span class="ident" id="3791978">errors</span><span class="op" id="3791984">.</span><span class="ident" id="3791985">New</span><span class="op" id="3791988">(</span><span class="string" id="3791989">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3792037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792041">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3792049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792053">b</span>&nbsp;<span class="op" id="3792055">:=</span>&nbsp;<span class="builtintype" id="3792058">uint</span><span class="op" id="3792062">(</span><span class="ident" id="3792063">bits</span>&nbsp;<span class="op" id="3792068">%</span>&nbsp;<span class="num" id="3792070">8</span><span class="op" id="3792071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792074">if</span>&nbsp;<span class="ident" id="3792077">b</span>&nbsp;<span class="op" id="3792079">==</span>&nbsp;<span class="num" id="3792082">0</span>&nbsp;<span class="op" id="3792084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792088">b</span>&nbsp;<span class="op" id="3792090">=</span>&nbsp;<span class="num" id="3792092">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3792095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792099">bytes</span>&nbsp;<span class="op" id="3792105">:=</span>&nbsp;<span class="builtinfunc" id="3792108">make</span><span class="op" id="3792112">(</span><span class="op" id="3792113">[</span><span class="op" id="3792114">]</span><span class="builtintype" id="3792115">byte</span><span class="op" id="3792119">,</span>&nbsp;<span class="op" id="3792121">(</span><span class="ident" id="3792122">bits</span><span class="op" id="3792126">+</span><span class="num" id="3792127">7</span><span class="op" id="3792128">)</span><span class="op" id="3792129">/</span><span class="num" id="3792130">8</span><span class="op" id="3792131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792134">p</span>&nbsp;<span class="op" id="3792136">=</span>&nbsp;<span class="builtinfunc" id="3792138">new</span><span class="op" id="3792141">(</span><span class="ident" id="3792142">big</span><span class="op" id="3792145">.</span><span class="ident" id="3792146">Int</span><span class="op" id="3792149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792153">bigMod</span>&nbsp;<span class="op" id="3792160">:=</span>&nbsp;<span class="builtinfunc" id="3792163">new</span><span class="op" id="3792166">(</span><span class="ident" id="3792167">big</span><span class="op" id="3792170">.</span><span class="ident" id="3792171">Int</span><span class="op" id="3792174">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792178">for</span>&nbsp;<span class="op" id="3792182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792186">_</span><span class="op" id="3792187">,</span>&nbsp;<span class="ident" id="3792189">err</span>&nbsp;<span class="op" id="3792193">=</span>&nbsp;<span class="ident" id="3792195">io</span><span class="op" id="3792197">.</span><span class="ident" id="3792198">ReadFull</span><span class="op" id="3792206">(</span><span class="ident" id="3792207">rand</span><span class="op" id="3792211">,</span>&nbsp;<span class="ident" id="3792213">bytes</span><span class="op" id="3792218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792222">if</span>&nbsp;<span class="ident" id="3792225">err</span>&nbsp;<span class="op" id="3792229">!=</span>&nbsp;<span class="ident" id="3792232">nil</span>&nbsp;<span class="op" id="3792236">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792241">return</span>&nbsp;<span class="ident" id="3792248">nil</span><span class="op" id="3792251">,</span>&nbsp;<span class="ident" id="3792253">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3792259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792264">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792345">bytes</span><span class="op" id="3792350">[</span><span class="num" id="3792351">0</span><span class="op" id="3792352">]</span>&nbsp;<span class="op" id="3792354">&amp;=</span>&nbsp;<span class="builtintype" id="3792357">uint8</span><span class="op" id="3792362">(</span><span class="builtintype" id="3792363">int</span><span class="op" id="3792366">(</span><span class="num" id="3792367">1</span><span class="op" id="3792368">&lt;&lt;</span><span class="ident" id="3792370">b</span><span class="op" id="3792371">)</span>&nbsp;<span class="op" id="3792373">-</span>&nbsp;<span class="num" id="3792375">1</span><span class="op" id="3792376">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792380">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792459">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792520">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792586">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792628">if</span>&nbsp;<span class="ident" id="3792631">b</span>&nbsp;<span class="op" id="3792633">&gt;=</span>&nbsp;<span class="num" id="3792636">2</span>&nbsp;<span class="op" id="3792638">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792643">bytes</span><span class="op" id="3792648">[</span><span class="num" id="3792649">0</span><span class="op" id="3792650">]</span>&nbsp;<span class="op" id="3792652">|=</span>&nbsp;<span class="num" id="3792655">3</span>&nbsp;<span class="op" id="3792657">&lt;&lt;</span>&nbsp;<span class="op" id="3792660">(</span><span class="ident" id="3792661">b</span>&nbsp;<span class="op" id="3792663">-</span>&nbsp;<span class="num" id="3792665">2</span><span class="op" id="3792666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3792670">}</span>&nbsp;<span class="keyword" id="3792672">else</span>&nbsp;<span class="op" id="3792677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792682">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792725">bytes</span><span class="op" id="3792730">[</span><span class="num" id="3792731">0</span><span class="op" id="3792732">]</span>&nbsp;<span class="op" id="3792734">|=</span>&nbsp;<span class="num" id="3792737">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792742">if</span>&nbsp;<span class="builtinfunc" id="3792745">len</span><span class="op" id="3792748">(</span><span class="ident" id="3792749">bytes</span><span class="op" id="3792754">)</span>&nbsp;<span class="op" id="3792756">&gt;</span>&nbsp;<span class="num" id="3792758">1</span>&nbsp;<span class="op" id="3792760">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792766">bytes</span><span class="op" id="3792771">[</span><span class="num" id="3792772">1</span><span class="op" id="3792773">]</span>&nbsp;<span class="op" id="3792775">|=</span>&nbsp;<span class="num" id="3792778">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3792786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3792790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792794">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792873">bytes</span><span class="op" id="3792878">[</span><span class="builtinfunc" id="3792879">len</span><span class="op" id="3792882">(</span><span class="ident" id="3792883">bytes</span><span class="op" id="3792888">)</span><span class="op" id="3792889">-</span><span class="num" id="3792890">1</span><span class="op" id="3792891">]</span>&nbsp;<span class="op" id="3792893">|=</span>&nbsp;<span class="num" id="3792896">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792901">p</span><span class="op" id="3792902">.</span><span class="ident" id="3792903">SetBytes</span><span class="op" id="3792911">(</span><span class="ident" id="3792912">bytes</span><span class="op" id="3792917">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792922">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792988">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3793054">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3793120">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793184">bigMod</span><span class="op" id="3793190">.</span><span class="ident" id="3793191">Mod</span><span class="op" id="3793194">(</span><span class="ident" id="3793195">p</span><span class="op" id="3793196">,</span>&nbsp;<span class="ident" id="3793198">smallPrimesProduct</span><span class="op" id="3793216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793220">mod</span>&nbsp;<span class="op" id="3793224">:=</span>&nbsp;<span class="ident" id="3793227">bigMod</span><span class="op" id="3793233">.</span><span class="ident" id="3793234">Uint64</span><span class="op" id="3793240">(</span><span class="op" id="3793241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793245">NextDelta</span><span class="op" id="3793254">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793258">for</span>&nbsp;<span class="ident" id="3793262">delta</span>&nbsp;<span class="op" id="3793268">:=</span>&nbsp;<span class="ident" id="3793271">uint64</span><span class="op" id="3793277">(</span><span class="num" id="3793278">0</span><span class="op" id="3793279">)</span><span class="op" id="3793280">;</span>&nbsp;<span class="ident" id="3793282">delta</span>&nbsp;<span class="op" id="3793288">&lt;</span>&nbsp;<span class="num" id="3793290">1</span><span class="op" id="3793291">&lt;&lt;</span><span class="num" id="3793293">20</span><span class="op" id="3793295">;</span>&nbsp;<span class="ident" id="3793297">delta</span>&nbsp;<span class="op" id="3793303">+=</span>&nbsp;<span class="num" id="3793306">2</span>&nbsp;<span class="op" id="3793308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793313">m</span>&nbsp;<span class="op" id="3793315">:=</span>&nbsp;<span class="ident" id="3793318">mod</span>&nbsp;<span class="op" id="3793322">+</span>&nbsp;<span class="ident" id="3793324">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793333">for</span>&nbsp;<span class="ident" id="3793337">_</span><span class="op" id="3793338">,</span>&nbsp;<span class="ident" id="3793340">prime</span>&nbsp;<span class="op" id="3793346">:=</span>&nbsp;<span class="keyword" id="3793349">range</span>&nbsp;<span class="ident" id="3793355">smallPrimes</span>&nbsp;<span class="op" id="3793367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793373">if</span>&nbsp;<span class="ident" id="3793376">m</span><span class="op" id="3793377">%</span><span class="ident" id="3793378">uint64</span><span class="op" id="3793384">(</span><span class="ident" id="3793385">prime</span><span class="op" id="3793390">)</span>&nbsp;<span class="op" id="3793392">==</span>&nbsp;<span class="num" id="3793395">0</span>&nbsp;<span class="op" id="3793397">&amp;&amp;</span>&nbsp;<span class="op" id="3793400">(</span><span class="ident" id="3793401">bits</span>&nbsp;<span class="op" id="3793406">&gt;</span>&nbsp;<span class="num" id="3793408">6</span>&nbsp;<span class="op" id="3793410">||</span>&nbsp;<span class="ident" id="3793413">m</span>&nbsp;<span class="op" id="3793415">!=</span>&nbsp;<span class="ident" id="3793418">uint64</span><span class="op" id="3793424">(</span><span class="ident" id="3793425">prime</span><span class="op" id="3793430">)</span><span class="op" id="3793431">)</span>&nbsp;<span class="op" id="3793433">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793440">continue</span>&nbsp;<span class="ident" id="3793449">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3793463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3793468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793474">if</span>&nbsp;<span class="ident" id="3793477">delta</span>&nbsp;<span class="op" id="3793483">&gt;</span>&nbsp;<span class="num" id="3793485">0</span>&nbsp;<span class="op" id="3793487">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793493">bigMod</span><span class="op" id="3793499">.</span><span class="ident" id="3793500">SetUint64</span><span class="op" id="3793509">(</span><span class="ident" id="3793510">delta</span><span class="op" id="3793515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793521">p</span><span class="op" id="3793522">.</span><span class="ident" id="3793523">Add</span><span class="op" id="3793526">(</span><span class="ident" id="3793527">p</span><span class="op" id="3793528">,</span>&nbsp;<span class="ident" id="3793530">bigMod</span><span class="op" id="3793536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3793541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793546">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3793554">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3793559">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3793625">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3793686">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793697">if</span>&nbsp;<span class="ident" id="3793700">p</span><span class="op" id="3793701">.</span><span class="ident" id="3793702">ProbablyPrime</span><span class="op" id="3793715">(</span><span class="num" id="3793716">20</span><span class="op" id="3793718">)</span>&nbsp;<span class="op" id="3793720">&amp;&amp;</span>&nbsp;<span class="ident" id="3793723">p</span><span class="op" id="3793724">.</span><span class="ident" id="3793725">BitLen</span><span class="op" id="3793731">(</span><span class="op" id="3793732">)</span>&nbsp;<span class="op" id="3793734">==</span>&nbsp;<span class="ident" id="3793737">bits</span>&nbsp;<span class="op" id="3793742">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793747">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3793756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3793759">}</span><br>
<span class="lineno"></span><span class="op" id="3793761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3793764">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3793838">func</span>&nbsp;<span class="ident" id="3793843">Int</span><span class="op" id="3793846">(</span><span class="ident" id="3793847">rand</span>&nbsp;<span class="ident" id="3793852">io</span><span class="op" id="3793854">.</span><span class="ident" id="3793855">Reader</span><span class="op" id="3793861">,</span>&nbsp;<span class="ident" id="3793863">max</span>&nbsp;<span class="op" id="3793867">*</span><span class="ident" id="3793868">big</span><span class="op" id="3793871">.</span><span class="ident" id="3793872">Int</span><span class="op" id="3793875">)</span>&nbsp;<span class="op" id="3793877">(</span><span class="ident" id="3793878">n</span>&nbsp;<span class="op" id="3793880">*</span><span class="ident" id="3793881">big</span><span class="op" id="3793884">.</span><span class="ident" id="3793885">Int</span><span class="op" id="3793888">,</span>&nbsp;<span class="ident" id="3793890">err</span>&nbsp;<span class="builtintype" id="3793894">error</span><span class="op" id="3793899">)</span>&nbsp;<span class="op" id="3793901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793904">if</span>&nbsp;<span class="ident" id="3793907">max</span><span class="op" id="3793910">.</span><span class="ident" id="3793911">Sign</span><span class="op" id="3793915">(</span><span class="op" id="3793916">)</span>&nbsp;<span class="op" id="3793918">&lt;=</span>&nbsp;<span class="num" id="3793921">0</span>&nbsp;<span class="op" id="3793923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3793927">panic</span><span class="op" id="3793932">(</span><span class="string" id="3793933">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3793971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3793974">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793977">k</span>&nbsp;<span class="op" id="3793979">:=</span>&nbsp;<span class="op" id="3793982">(</span><span class="ident" id="3793983">max</span><span class="op" id="3793986">.</span><span class="ident" id="3793987">BitLen</span><span class="op" id="3793993">(</span><span class="op" id="3793994">)</span>&nbsp;<span class="op" id="3793996">+</span>&nbsp;<span class="num" id="3793998">7</span><span class="op" id="3793999">)</span>&nbsp;<span class="op" id="3794001">/</span>&nbsp;<span class="num" id="3794003">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3794007">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794072">b</span>&nbsp;<span class="op" id="3794074">:=</span>&nbsp;<span class="builtintype" id="3794077">uint</span><span class="op" id="3794081">(</span><span class="ident" id="3794082">max</span><span class="op" id="3794085">.</span><span class="ident" id="3794086">BitLen</span><span class="op" id="3794092">(</span><span class="op" id="3794093">)</span>&nbsp;<span class="op" id="3794095">%</span>&nbsp;<span class="num" id="3794097">8</span><span class="op" id="3794098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794101">if</span>&nbsp;<span class="ident" id="3794104">b</span>&nbsp;<span class="op" id="3794106">==</span>&nbsp;<span class="num" id="3794109">0</span>&nbsp;<span class="op" id="3794111">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794115">b</span>&nbsp;<span class="op" id="3794117">=</span>&nbsp;<span class="num" id="3794119">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794126">bytes</span>&nbsp;<span class="op" id="3794132">:=</span>&nbsp;<span class="builtinfunc" id="3794135">make</span><span class="op" id="3794139">(</span><span class="op" id="3794140">[</span><span class="op" id="3794141">]</span><span class="builtintype" id="3794142">byte</span><span class="op" id="3794146">,</span>&nbsp;<span class="ident" id="3794148">k</span><span class="op" id="3794149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794152">n</span>&nbsp;<span class="op" id="3794154">=</span>&nbsp;<span class="builtinfunc" id="3794156">new</span><span class="op" id="3794159">(</span><span class="ident" id="3794160">big</span><span class="op" id="3794163">.</span><span class="ident" id="3794164">Int</span><span class="op" id="3794167">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794171">for</span>&nbsp;<span class="op" id="3794175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794179">_</span><span class="op" id="3794180">,</span>&nbsp;<span class="ident" id="3794182">err</span>&nbsp;<span class="op" id="3794186">=</span>&nbsp;<span class="ident" id="3794188">io</span><span class="op" id="3794190">.</span><span class="ident" id="3794191">ReadFull</span><span class="op" id="3794199">(</span><span class="ident" id="3794200">rand</span><span class="op" id="3794204">,</span>&nbsp;<span class="ident" id="3794206">bytes</span><span class="op" id="3794211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794215">if</span>&nbsp;<span class="ident" id="3794218">err</span>&nbsp;<span class="op" id="3794222">!=</span>&nbsp;<span class="ident" id="3794225">nil</span>&nbsp;<span class="op" id="3794229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794234">return</span>&nbsp;<span class="ident" id="3794241">nil</span><span class="op" id="3794244">,</span>&nbsp;<span class="ident" id="3794246">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3794257">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3794319">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794353">bytes</span><span class="op" id="3794358">[</span><span class="num" id="3794359">0</span><span class="op" id="3794360">]</span>&nbsp;<span class="op" id="3794362">&amp;=</span>&nbsp;<span class="builtintype" id="3794365">uint8</span><span class="op" id="3794370">(</span><span class="builtintype" id="3794371">int</span><span class="op" id="3794374">(</span><span class="num" id="3794375">1</span><span class="op" id="3794376">&lt;&lt;</span><span class="ident" id="3794378">b</span><span class="op" id="3794379">)</span>&nbsp;<span class="op" id="3794381">-</span>&nbsp;<span class="num" id="3794383">1</span><span class="op" id="3794384">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794389">n</span><span class="op" id="3794390">.</span><span class="ident" id="3794391">SetBytes</span><span class="op" id="3794399">(</span><span class="ident" id="3794400">bytes</span><span class="op" id="3794405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794409">if</span>&nbsp;<span class="ident" id="3794412">n</span><span class="op" id="3794413">.</span><span class="ident" id="3794414">Cmp</span><span class="op" id="3794417">(</span><span class="ident" id="3794418">max</span><span class="op" id="3794421">)</span>&nbsp;<span class="op" id="3794423">&lt;</span>&nbsp;<span class="num" id="3794425">0</span>&nbsp;<span class="op" id="3794427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794432">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794441">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794444">}</span><br>
<span class="lineno"></span><span class="op" id="3794446">}</span>
</div>
</body>
</html>
