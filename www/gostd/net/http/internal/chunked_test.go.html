<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7701758">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7701813">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7701867">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7701918">package</span>&nbsp;<span class="ident" id="7701926">internal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7701936">import</span>&nbsp;<span class="op" id="7701943">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7701946">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7701955">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7701964">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7701971">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7701977">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7701990">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7702001">&#34;testing&#34;</span><br>
<span class="lineno">15</span><span class="op" id="7702011">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7702014">func</span>&nbsp;<span class="ident" id="7702019">TestChunk</span><span class="op" id="7702028">(</span><span class="ident" id="7702029">t</span>&nbsp;<span class="op" id="7702031">*</span><span class="ident" id="7702032">testing</span><span class="op" id="7702039">.</span><span class="ident" id="7702040">T</span><span class="op" id="7702041">)</span>&nbsp;<span class="op" id="7702043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7702046">var</span>&nbsp;<span class="ident" id="7702050">b</span>&nbsp;<span class="ident" id="7702052">bytes</span><span class="op" id="7702057">.</span><span class="ident" id="7702058">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702067">w</span>&nbsp;<span class="op" id="7702069">:=</span>&nbsp;<span class="ident" id="7702072">NewChunkedWriter</span><span class="op" id="7702088">(</span><span class="op" id="7702089">&amp;</span><span class="ident" id="7702090">b</span><span class="op" id="7702091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7702094">const</span>&nbsp;<span class="ident" id="7702100">chunk1</span>&nbsp;<span class="op" id="7702107">=</span>&nbsp;<span class="string" id="7702109">&#34;hello,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7702120">const</span>&nbsp;<span class="ident" id="7702126">chunk2</span>&nbsp;<span class="op" id="7702133">=</span>&nbsp;<span class="string" id="7702135">&#34;world!&nbsp;0123456789abcdef&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702162">w</span><span class="op" id="7702163">.</span><span class="ident" id="7702164">Write</span><span class="op" id="7702169">(</span><span class="op" id="7702170">[</span><span class="op" id="7702171">]</span><span class="builtintype" id="7702172">byte</span><span class="op" id="7702176">(</span><span class="ident" id="7702177">chunk1</span><span class="op" id="7702183">)</span><span class="op" id="7702184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702187">w</span><span class="op" id="7702188">.</span><span class="ident" id="7702189">Write</span><span class="op" id="7702194">(</span><span class="op" id="7702195">[</span><span class="op" id="7702196">]</span><span class="builtintype" id="7702197">byte</span><span class="op" id="7702201">(</span><span class="ident" id="7702202">chunk2</span><span class="op" id="7702208">)</span><span class="op" id="7702209">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702212">w</span><span class="op" id="7702213">.</span><span class="ident" id="7702214">Close</span><span class="op" id="7702219">(</span><span class="op" id="7702220">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7702224">if</span>&nbsp;<span class="ident" id="7702227">g</span><span class="op" id="7702228">,</span>&nbsp;<span class="ident" id="7702230">e</span>&nbsp;<span class="op" id="7702232">:=</span>&nbsp;<span class="ident" id="7702235">b</span><span class="op" id="7702236">.</span><span class="ident" id="7702237">String</span><span class="op" id="7702243">(</span><span class="op" id="7702244">)</span><span class="op" id="7702245">,</span>&nbsp;<span class="string" id="7702247">&#34;7\r\nhello,&nbsp;\r\n17\r\nworld!&nbsp;0123456789abcdef\r\n0\r\n&#34;</span><span class="op" id="7702303">;</span>&nbsp;<span class="ident" id="7702305">g</span>&nbsp;<span class="op" id="7702307">!=</span>&nbsp;<span class="ident" id="7702310">e</span>&nbsp;<span class="op" id="7702312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702316">t</span><span class="op" id="7702317">.</span><span class="ident" id="7702318">Fatalf</span><span class="op" id="7702324">(</span><span class="string" id="7702325">&#34;chunk&nbsp;writer&nbsp;wrote&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7702357">,</span>&nbsp;<span class="ident" id="7702359">g</span><span class="op" id="7702360">,</span>&nbsp;<span class="ident" id="7702362">e</span><span class="op" id="7702363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7702366">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702370">r</span>&nbsp;<span class="op" id="7702372">:=</span>&nbsp;<span class="ident" id="7702375">NewChunkedReader</span><span class="op" id="7702391">(</span><span class="op" id="7702392">&amp;</span><span class="ident" id="7702393">b</span><span class="op" id="7702394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702397">data</span><span class="op" id="7702401">,</span>&nbsp;<span class="ident" id="7702403">err</span>&nbsp;<span class="op" id="7702407">:=</span>&nbsp;<span class="ident" id="7702410">ioutil</span><span class="op" id="7702416">.</span><span class="ident" id="7702417">ReadAll</span><span class="op" id="7702424">(</span><span class="ident" id="7702425">r</span><span class="op" id="7702426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7702429">if</span>&nbsp;<span class="ident" id="7702432">err</span>&nbsp;<span class="op" id="7702436">!=</span>&nbsp;<span class="ident" id="7702439">nil</span>&nbsp;<span class="op" id="7702443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702447">t</span><span class="op" id="7702448">.</span><span class="ident" id="7702449">Logf</span><span class="op" id="7702453">(</span><span class="string" id="7702454">`data:&nbsp;&#34;%s&#34;`</span><span class="op" id="7702466">,</span>&nbsp;<span class="ident" id="7702468">data</span><span class="op" id="7702472">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702476">t</span><span class="op" id="7702477">.</span><span class="ident" id="7702478">Fatalf</span><span class="op" id="7702484">(</span><span class="string" id="7702485">&#34;ReadAll&nbsp;from&nbsp;reader:&nbsp;%v&#34;</span><span class="op" id="7702510">,</span>&nbsp;<span class="ident" id="7702512">err</span><span class="op" id="7702515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7702518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7702521">if</span>&nbsp;<span class="ident" id="7702524">g</span><span class="op" id="7702525">,</span>&nbsp;<span class="ident" id="7702527">e</span>&nbsp;<span class="op" id="7702529">:=</span>&nbsp;<span class="builtintype" id="7702532">string</span><span class="op" id="7702538">(</span><span class="ident" id="7702539">data</span><span class="op" id="7702543">)</span><span class="op" id="7702544">,</span>&nbsp;<span class="ident" id="7702546">chunk1</span><span class="op" id="7702552">+</span><span class="ident" id="7702553">chunk2</span><span class="op" id="7702559">;</span>&nbsp;<span class="ident" id="7702561">g</span>&nbsp;<span class="op" id="7702563">!=</span>&nbsp;<span class="ident" id="7702566">e</span>&nbsp;<span class="op" id="7702568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702572">t</span><span class="op" id="7702573">.</span><span class="ident" id="7702574">Errorf</span><span class="op" id="7702580">(</span><span class="string" id="7702581">&#34;chunk&nbsp;reader&nbsp;read&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7702612">,</span>&nbsp;<span class="ident" id="7702614">g</span><span class="op" id="7702615">,</span>&nbsp;<span class="ident" id="7702617">e</span><span class="op" id="7702618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7702621">}</span><br>
<span class="lineno">40</span><span class="op" id="7702623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7702626">func</span>&nbsp;<span class="ident" id="7702631">TestChunkReadMultiple</span><span class="op" id="7702652">(</span><span class="ident" id="7702653">t</span>&nbsp;<span class="op" id="7702655">*</span><span class="ident" id="7702656">testing</span><span class="op" id="7702663">.</span><span class="ident" id="7702664">T</span><span class="op" id="7702665">)</span>&nbsp;<span class="op" id="7702667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7702670">//&nbsp;Bunch&nbsp;of&nbsp;small&nbsp;chunks,&nbsp;all&nbsp;read&nbsp;together.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7702716">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7702720">var</span>&nbsp;<span class="ident" id="7702724">b</span>&nbsp;<span class="ident" id="7702726">bytes</span><span class="op" id="7702731">.</span><span class="ident" id="7702732">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702741">w</span>&nbsp;<span class="op" id="7702743">:=</span>&nbsp;<span class="ident" id="7702746">NewChunkedWriter</span><span class="op" id="7702762">(</span><span class="op" id="7702763">&amp;</span><span class="ident" id="7702764">b</span><span class="op" id="7702765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702769">w</span><span class="op" id="7702770">.</span><span class="ident" id="7702771">Write</span><span class="op" id="7702776">(</span><span class="op" id="7702777">[</span><span class="op" id="7702778">]</span><span class="builtintype" id="7702779">byte</span><span class="op" id="7702783">(</span><span class="string" id="7702784">&#34;foo&#34;</span><span class="op" id="7702789">)</span><span class="op" id="7702790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702794">w</span><span class="op" id="7702795">.</span><span class="ident" id="7702796">Write</span><span class="op" id="7702801">(</span><span class="op" id="7702802">[</span><span class="op" id="7702803">]</span><span class="builtintype" id="7702804">byte</span><span class="op" id="7702808">(</span><span class="string" id="7702809">&#34;bar&#34;</span><span class="op" id="7702814">)</span><span class="op" id="7702815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702819">w</span><span class="op" id="7702820">.</span><span class="ident" id="7702821">Close</span><span class="op" id="7702826">(</span><span class="op" id="7702827">)</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702832">r</span>&nbsp;<span class="op" id="7702834">:=</span>&nbsp;<span class="ident" id="7702837">NewChunkedReader</span><span class="op" id="7702853">(</span><span class="op" id="7702854">&amp;</span><span class="ident" id="7702855">b</span><span class="op" id="7702856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702860">buf</span>&nbsp;<span class="op" id="7702864">:=</span>&nbsp;<span class="builtinfunc" id="7702867">make</span><span class="op" id="7702871">(</span><span class="op" id="7702872">[</span><span class="op" id="7702873">]</span><span class="builtintype" id="7702874">byte</span><span class="op" id="7702878">,</span>&nbsp;<span class="num" id="7702880">10</span><span class="op" id="7702882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702886">n</span><span class="op" id="7702887">,</span>&nbsp;<span class="ident" id="7702889">err</span>&nbsp;<span class="op" id="7702893">:=</span>&nbsp;<span class="ident" id="7702896">r</span><span class="op" id="7702897">.</span><span class="ident" id="7702898">Read</span><span class="op" id="7702902">(</span><span class="ident" id="7702903">buf</span><span class="op" id="7702906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7702910">if</span>&nbsp;<span class="ident" id="7702913">n</span>&nbsp;<span class="op" id="7702915">!=</span>&nbsp;<span class="num" id="7702918">6</span>&nbsp;<span class="op" id="7702920">||</span>&nbsp;<span class="ident" id="7702923">err</span>&nbsp;<span class="op" id="7702927">!=</span>&nbsp;<span class="ident" id="7702930">io</span><span class="op" id="7702932">.</span><span class="ident" id="7702933">EOF</span>&nbsp;<span class="op" id="7702937">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702942">t</span><span class="op" id="7702943">.</span><span class="ident" id="7702944">Errorf</span><span class="op" id="7702950">(</span><span class="string" id="7702951">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;6,&nbsp;EOF&#34;</span><span class="op" id="7702979">,</span>&nbsp;<span class="ident" id="7702981">n</span><span class="op" id="7702982">,</span>&nbsp;<span class="ident" id="7702984">err</span><span class="op" id="7702987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7702991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7702995">buf</span>&nbsp;<span class="op" id="7702999">=</span>&nbsp;<span class="ident" id="7703001">buf</span><span class="op" id="7703004">[</span><span class="op" id="7703005">:</span><span class="ident" id="7703006">n</span><span class="op" id="7703007">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7703011">if</span>&nbsp;<span class="builtintype" id="7703014">string</span><span class="op" id="7703020">(</span><span class="ident" id="7703021">buf</span><span class="op" id="7703024">)</span>&nbsp;<span class="op" id="7703026">!=</span>&nbsp;<span class="string" id="7703029">&#34;foobar&#34;</span>&nbsp;<span class="op" id="7703038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703043">t</span><span class="op" id="7703044">.</span><span class="ident" id="7703045">Errorf</span><span class="op" id="7703051">(</span><span class="string" id="7703052">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7703072">,</span>&nbsp;<span class="ident" id="7703074">buf</span><span class="op" id="7703077">,</span>&nbsp;<span class="string" id="7703079">&#34;foobar&#34;</span><span class="op" id="7703087">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7703091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7703094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7703098">//&nbsp;One&nbsp;big&nbsp;chunk&nbsp;followed&nbsp;by&nbsp;a&nbsp;little&nbsp;chunk,&nbsp;but&nbsp;the&nbsp;small&nbsp;bufio.Reader&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7703176">//&nbsp;should&nbsp;prevent&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;from&nbsp;being&nbsp;read.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7703236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7703240">var</span>&nbsp;<span class="ident" id="7703244">b</span>&nbsp;<span class="ident" id="7703246">bytes</span><span class="op" id="7703251">.</span><span class="ident" id="7703252">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703261">w</span>&nbsp;<span class="op" id="7703263">:=</span>&nbsp;<span class="ident" id="7703266">NewChunkedWriter</span><span class="op" id="7703282">(</span><span class="op" id="7703283">&amp;</span><span class="ident" id="7703284">b</span><span class="op" id="7703285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7703289">//&nbsp;fillBufChunk&nbsp;is&nbsp;11&nbsp;bytes&nbsp;+&nbsp;3&nbsp;bytes&nbsp;header&nbsp;+&nbsp;2&nbsp;bytes&nbsp;footer&nbsp;=&nbsp;16&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7703365">//&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;bufio&nbsp;ReaderSize&nbsp;below&nbsp;(the&nbsp;minimum),&nbsp;so&nbsp;even</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7703432">//&nbsp;though&nbsp;we&#39;re&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;Read&nbsp;with&nbsp;a&nbsp;buffer&nbsp;larger&nbsp;enough&nbsp;to&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7703507">//&nbsp;receive&nbsp;&#34;foo&#34;,&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;won&#39;t&nbsp;be&nbsp;read&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7703570">const</span>&nbsp;<span class="ident" id="7703576">fillBufChunk</span>&nbsp;<span class="op" id="7703589">=</span>&nbsp;<span class="string" id="7703591">&#34;0123456789a&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7703607">const</span>&nbsp;<span class="ident" id="7703613">shortChunk</span>&nbsp;<span class="op" id="7703624">=</span>&nbsp;<span class="string" id="7703626">&#34;foo&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703634">w</span><span class="op" id="7703635">.</span><span class="ident" id="7703636">Write</span><span class="op" id="7703641">(</span><span class="op" id="7703642">[</span><span class="op" id="7703643">]</span><span class="builtintype" id="7703644">byte</span><span class="op" id="7703648">(</span><span class="ident" id="7703649">fillBufChunk</span><span class="op" id="7703661">)</span><span class="op" id="7703662">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703666">w</span><span class="op" id="7703667">.</span><span class="ident" id="7703668">Write</span><span class="op" id="7703673">(</span><span class="op" id="7703674">[</span><span class="op" id="7703675">]</span><span class="builtintype" id="7703676">byte</span><span class="op" id="7703680">(</span><span class="ident" id="7703681">shortChunk</span><span class="op" id="7703691">)</span><span class="op" id="7703692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703696">w</span><span class="op" id="7703697">.</span><span class="ident" id="7703698">Close</span><span class="op" id="7703703">(</span><span class="op" id="7703704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703709">r</span>&nbsp;<span class="op" id="7703711">:=</span>&nbsp;<span class="ident" id="7703714">NewChunkedReader</span><span class="op" id="7703730">(</span><span class="ident" id="7703731">bufio</span><span class="op" id="7703736">.</span><span class="ident" id="7703737">NewReaderSize</span><span class="op" id="7703750">(</span><span class="op" id="7703751">&amp;</span><span class="ident" id="7703752">b</span><span class="op" id="7703753">,</span>&nbsp;<span class="num" id="7703755">16</span><span class="op" id="7703757">)</span><span class="op" id="7703758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703762">buf</span>&nbsp;<span class="op" id="7703766">:=</span>&nbsp;<span class="builtinfunc" id="7703769">make</span><span class="op" id="7703773">(</span><span class="op" id="7703774">[</span><span class="op" id="7703775">]</span><span class="builtintype" id="7703776">byte</span><span class="op" id="7703780">,</span>&nbsp;<span class="builtinfunc" id="7703782">len</span><span class="op" id="7703785">(</span><span class="ident" id="7703786">fillBufChunk</span><span class="op" id="7703798">)</span><span class="op" id="7703799">+</span><span class="builtinfunc" id="7703800">len</span><span class="op" id="7703803">(</span><span class="ident" id="7703804">shortChunk</span><span class="op" id="7703814">)</span><span class="op" id="7703815">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703819">n</span><span class="op" id="7703820">,</span>&nbsp;<span class="ident" id="7703822">err</span>&nbsp;<span class="op" id="7703826">:=</span>&nbsp;<span class="ident" id="7703829">r</span><span class="op" id="7703830">.</span><span class="ident" id="7703831">Read</span><span class="op" id="7703835">(</span><span class="ident" id="7703836">buf</span><span class="op" id="7703839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7703843">if</span>&nbsp;<span class="ident" id="7703846">n</span>&nbsp;<span class="op" id="7703848">!=</span>&nbsp;<span class="builtinfunc" id="7703851">len</span><span class="op" id="7703854">(</span><span class="ident" id="7703855">fillBufChunk</span><span class="op" id="7703867">)</span>&nbsp;<span class="op" id="7703869">||</span>&nbsp;<span class="ident" id="7703872">err</span>&nbsp;<span class="op" id="7703876">!=</span>&nbsp;<span class="ident" id="7703879">nil</span>&nbsp;<span class="op" id="7703883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703888">t</span><span class="op" id="7703889">.</span><span class="ident" id="7703890">Errorf</span><span class="op" id="7703896">(</span><span class="string" id="7703897">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="7703926">,</span>&nbsp;<span class="ident" id="7703928">n</span><span class="op" id="7703929">,</span>&nbsp;<span class="ident" id="7703931">err</span><span class="op" id="7703934">,</span>&nbsp;<span class="builtinfunc" id="7703936">len</span><span class="op" id="7703939">(</span><span class="ident" id="7703940">fillBufChunk</span><span class="op" id="7703952">)</span><span class="op" id="7703953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7703957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7703961">buf</span>&nbsp;<span class="op" id="7703965">=</span>&nbsp;<span class="ident" id="7703967">buf</span><span class="op" id="7703970">[</span><span class="op" id="7703971">:</span><span class="ident" id="7703972">n</span><span class="op" id="7703973">]</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7703977">if</span>&nbsp;<span class="builtintype" id="7703980">string</span><span class="op" id="7703986">(</span><span class="ident" id="7703987">buf</span><span class="op" id="7703990">)</span>&nbsp;<span class="op" id="7703992">!=</span>&nbsp;<span class="ident" id="7703995">fillBufChunk</span>&nbsp;<span class="op" id="7704008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704013">t</span><span class="op" id="7704014">.</span><span class="ident" id="7704015">Errorf</span><span class="op" id="7704021">(</span><span class="string" id="7704022">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7704042">,</span>&nbsp;<span class="ident" id="7704044">buf</span><span class="op" id="7704047">,</span>&nbsp;<span class="ident" id="7704049">fillBufChunk</span><span class="op" id="7704061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7704065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704070">n</span><span class="op" id="7704071">,</span>&nbsp;<span class="ident" id="7704073">err</span>&nbsp;<span class="op" id="7704077">=</span>&nbsp;<span class="ident" id="7704079">r</span><span class="op" id="7704080">.</span><span class="ident" id="7704081">Read</span><span class="op" id="7704085">(</span><span class="ident" id="7704086">buf</span><span class="op" id="7704089">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7704093">if</span>&nbsp;<span class="ident" id="7704096">n</span>&nbsp;<span class="op" id="7704098">!=</span>&nbsp;<span class="builtinfunc" id="7704101">len</span><span class="op" id="7704104">(</span><span class="ident" id="7704105">shortChunk</span><span class="op" id="7704115">)</span>&nbsp;<span class="op" id="7704117">||</span>&nbsp;<span class="ident" id="7704120">err</span>&nbsp;<span class="op" id="7704124">!=</span>&nbsp;<span class="ident" id="7704127">io</span><span class="op" id="7704129">.</span><span class="ident" id="7704130">EOF</span>&nbsp;<span class="op" id="7704134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704139">t</span><span class="op" id="7704140">.</span><span class="ident" id="7704141">Errorf</span><span class="op" id="7704147">(</span><span class="string" id="7704148">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;EOF&#34;</span><span class="op" id="7704177">,</span>&nbsp;<span class="ident" id="7704179">n</span><span class="op" id="7704180">,</span>&nbsp;<span class="ident" id="7704182">err</span><span class="op" id="7704185">,</span>&nbsp;<span class="builtinfunc" id="7704187">len</span><span class="op" id="7704190">(</span><span class="ident" id="7704191">shortChunk</span><span class="op" id="7704201">)</span><span class="op" id="7704202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7704206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7704209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7704213">//&nbsp;And&nbsp;test&nbsp;that&nbsp;we&nbsp;see&nbsp;an&nbsp;EOF&nbsp;chunk,&nbsp;even&nbsp;though&nbsp;our&nbsp;buffer&nbsp;is&nbsp;already&nbsp;full:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7704292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704296">r</span>&nbsp;<span class="op" id="7704298">:=</span>&nbsp;<span class="ident" id="7704301">NewChunkedReader</span><span class="op" id="7704317">(</span><span class="ident" id="7704318">bufio</span><span class="op" id="7704323">.</span><span class="ident" id="7704324">NewReader</span><span class="op" id="7704333">(</span><span class="ident" id="7704334">strings</span><span class="op" id="7704341">.</span><span class="ident" id="7704342">NewReader</span><span class="op" id="7704351">(</span><span class="string" id="7704352">&#34;3\r\nfoo\r\n0\r\n&#34;</span><span class="op" id="7704371">)</span><span class="op" id="7704372">)</span><span class="op" id="7704373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704377">buf</span>&nbsp;<span class="op" id="7704381">:=</span>&nbsp;<span class="builtinfunc" id="7704384">make</span><span class="op" id="7704388">(</span><span class="op" id="7704389">[</span><span class="op" id="7704390">]</span><span class="builtintype" id="7704391">byte</span><span class="op" id="7704395">,</span>&nbsp;<span class="num" id="7704397">3</span><span class="op" id="7704398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704402">n</span><span class="op" id="7704403">,</span>&nbsp;<span class="ident" id="7704405">err</span>&nbsp;<span class="op" id="7704409">:=</span>&nbsp;<span class="ident" id="7704412">r</span><span class="op" id="7704413">.</span><span class="ident" id="7704414">Read</span><span class="op" id="7704418">(</span><span class="ident" id="7704419">buf</span><span class="op" id="7704422">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7704426">if</span>&nbsp;<span class="ident" id="7704429">n</span>&nbsp;<span class="op" id="7704431">!=</span>&nbsp;<span class="num" id="7704434">3</span>&nbsp;<span class="op" id="7704436">||</span>&nbsp;<span class="ident" id="7704439">err</span>&nbsp;<span class="op" id="7704443">!=</span>&nbsp;<span class="ident" id="7704446">io</span><span class="op" id="7704448">.</span><span class="ident" id="7704449">EOF</span>&nbsp;<span class="op" id="7704453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704458">t</span><span class="op" id="7704459">.</span><span class="ident" id="7704460">Errorf</span><span class="op" id="7704466">(</span><span class="string" id="7704467">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;3,&nbsp;EOF&#34;</span><span class="op" id="7704495">,</span>&nbsp;<span class="ident" id="7704497">n</span><span class="op" id="7704498">,</span>&nbsp;<span class="ident" id="7704500">err</span><span class="op" id="7704503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7704507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7704511">if</span>&nbsp;<span class="builtintype" id="7704514">string</span><span class="op" id="7704520">(</span><span class="ident" id="7704521">buf</span><span class="op" id="7704524">)</span>&nbsp;<span class="op" id="7704526">!=</span>&nbsp;<span class="string" id="7704529">&#34;foo&#34;</span>&nbsp;<span class="op" id="7704535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704540">t</span><span class="op" id="7704541">.</span><span class="ident" id="7704542">Errorf</span><span class="op" id="7704548">(</span><span class="string" id="7704549">&#34;buf&nbsp;=&nbsp;%q;&nbsp;want&nbsp;foo&#34;</span><span class="op" id="7704569">,</span>&nbsp;<span class="ident" id="7704571">buf</span><span class="op" id="7704574">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7704578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7704581">}</span><br>
<span class="lineno"></span><span class="op" id="7704583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7704586">func</span>&nbsp;<span class="ident" id="7704591">TestChunkReaderAllocs</span><span class="op" id="7704612">(</span><span class="ident" id="7704613">t</span>&nbsp;<span class="op" id="7704615">*</span><span class="ident" id="7704616">testing</span><span class="op" id="7704623">.</span><span class="ident" id="7704624">T</span><span class="op" id="7704625">)</span>&nbsp;<span class="op" id="7704627">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7704630">if</span>&nbsp;<span class="ident" id="7704633">testing</span><span class="op" id="7704640">.</span><span class="ident" id="7704641">Short</span><span class="op" id="7704646">(</span><span class="op" id="7704647">)</span>&nbsp;<span class="op" id="7704649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704653">t</span><span class="op" id="7704654">.</span><span class="ident" id="7704655">Skip</span><span class="op" id="7704659">(</span><span class="string" id="7704660">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7704684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7704687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7704690">var</span>&nbsp;<span class="ident" id="7704694">buf</span>&nbsp;<span class="ident" id="7704698">bytes</span><span class="op" id="7704703">.</span><span class="ident" id="7704704">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704712">w</span>&nbsp;<span class="op" id="7704714">:=</span>&nbsp;<span class="ident" id="7704717">NewChunkedWriter</span><span class="op" id="7704733">(</span><span class="op" id="7704734">&amp;</span><span class="ident" id="7704735">buf</span><span class="op" id="7704738">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704741">a</span><span class="op" id="7704742">,</span>&nbsp;<span class="ident" id="7704744">b</span><span class="op" id="7704745">,</span>&nbsp;<span class="ident" id="7704747">c</span>&nbsp;<span class="op" id="7704749">:=</span>&nbsp;<span class="op" id="7704752">[</span><span class="op" id="7704753">]</span><span class="builtintype" id="7704754">byte</span><span class="op" id="7704758">(</span><span class="string" id="7704759">&#34;aaaaaa&#34;</span><span class="op" id="7704767">)</span><span class="op" id="7704768">,</span>&nbsp;<span class="op" id="7704770">[</span><span class="op" id="7704771">]</span><span class="builtintype" id="7704772">byte</span><span class="op" id="7704776">(</span><span class="string" id="7704777">&#34;bbbbbbbbbbbb&#34;</span><span class="op" id="7704791">)</span><span class="op" id="7704792">,</span>&nbsp;<span class="op" id="7704794">[</span><span class="op" id="7704795">]</span><span class="builtintype" id="7704796">byte</span><span class="op" id="7704800">(</span><span class="string" id="7704801">&#34;cccccccccccccccccccccccc&#34;</span><span class="op" id="7704827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704830">w</span><span class="op" id="7704831">.</span><span class="ident" id="7704832">Write</span><span class="op" id="7704837">(</span><span class="ident" id="7704838">a</span><span class="op" id="7704839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704842">w</span><span class="op" id="7704843">.</span><span class="ident" id="7704844">Write</span><span class="op" id="7704849">(</span><span class="ident" id="7704850">b</span><span class="op" id="7704851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704854">w</span><span class="op" id="7704855">.</span><span class="ident" id="7704856">Write</span><span class="op" id="7704861">(</span><span class="ident" id="7704862">c</span><span class="op" id="7704863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704866">w</span><span class="op" id="7704867">.</span><span class="ident" id="7704868">Close</span><span class="op" id="7704873">(</span><span class="op" id="7704874">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704878">readBuf</span>&nbsp;<span class="op" id="7704886">:=</span>&nbsp;<span class="builtinfunc" id="7704889">make</span><span class="op" id="7704893">(</span><span class="op" id="7704894">[</span><span class="op" id="7704895">]</span><span class="builtintype" id="7704896">byte</span><span class="op" id="7704900">,</span>&nbsp;<span class="builtinfunc" id="7704902">len</span><span class="op" id="7704905">(</span><span class="ident" id="7704906">a</span><span class="op" id="7704907">)</span><span class="op" id="7704908">+</span><span class="builtinfunc" id="7704909">len</span><span class="op" id="7704912">(</span><span class="ident" id="7704913">b</span><span class="op" id="7704914">)</span><span class="op" id="7704915">+</span><span class="builtinfunc" id="7704916">len</span><span class="op" id="7704919">(</span><span class="ident" id="7704920">c</span><span class="op" id="7704921">)</span><span class="op" id="7704922">+</span><span class="num" id="7704923">1</span><span class="op" id="7704924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704927">byter</span>&nbsp;<span class="op" id="7704933">:=</span>&nbsp;<span class="ident" id="7704936">bytes</span><span class="op" id="7704941">.</span><span class="ident" id="7704942">NewReader</span><span class="op" id="7704951">(</span><span class="ident" id="7704952">buf</span><span class="op" id="7704955">.</span><span class="ident" id="7704956">Bytes</span><span class="op" id="7704961">(</span><span class="op" id="7704962">)</span><span class="op" id="7704963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704966">bufr</span>&nbsp;<span class="op" id="7704971">:=</span>&nbsp;<span class="ident" id="7704974">bufio</span><span class="op" id="7704979">.</span><span class="ident" id="7704980">NewReader</span><span class="op" id="7704989">(</span><span class="ident" id="7704990">byter</span><span class="op" id="7704995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7704998">mallocs</span>&nbsp;<span class="op" id="7705006">:=</span>&nbsp;<span class="ident" id="7705009">testing</span><span class="op" id="7705016">.</span><span class="ident" id="7705017">AllocsPerRun</span><span class="op" id="7705029">(</span><span class="num" id="7705030">100</span><span class="op" id="7705033">,</span>&nbsp;<span class="keyword" id="7705035">func</span><span class="op" id="7705039">(</span><span class="op" id="7705040">)</span>&nbsp;<span class="op" id="7705042">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705046">byter</span><span class="op" id="7705051">.</span><span class="ident" id="7705052">Seek</span><span class="op" id="7705056">(</span><span class="num" id="7705057">0</span><span class="op" id="7705058">,</span>&nbsp;<span class="num" id="7705060">0</span><span class="op" id="7705061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705065">bufr</span><span class="op" id="7705069">.</span><span class="ident" id="7705070">Reset</span><span class="op" id="7705075">(</span><span class="ident" id="7705076">byter</span><span class="op" id="7705081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705085">r</span>&nbsp;<span class="op" id="7705087">:=</span>&nbsp;<span class="ident" id="7705090">NewChunkedReader</span><span class="op" id="7705106">(</span><span class="ident" id="7705107">bufr</span><span class="op" id="7705111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705115">n</span><span class="op" id="7705116">,</span>&nbsp;<span class="ident" id="7705118">err</span>&nbsp;<span class="op" id="7705122">:=</span>&nbsp;<span class="ident" id="7705125">io</span><span class="op" id="7705127">.</span><span class="ident" id="7705128">ReadFull</span><span class="op" id="7705136">(</span><span class="ident" id="7705137">r</span><span class="op" id="7705138">,</span>&nbsp;<span class="ident" id="7705140">readBuf</span><span class="op" id="7705147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7705151">if</span>&nbsp;<span class="ident" id="7705154">n</span>&nbsp;<span class="op" id="7705156">!=</span>&nbsp;<span class="builtinfunc" id="7705159">len</span><span class="op" id="7705162">(</span><span class="ident" id="7705163">readBuf</span><span class="op" id="7705170">)</span><span class="op" id="7705171">-</span><span class="num" id="7705172">1</span>&nbsp;<span class="op" id="7705174">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705179">t</span><span class="op" id="7705180">.</span><span class="ident" id="7705181">Fatalf</span><span class="op" id="7705187">(</span><span class="string" id="7705188">&#34;read&nbsp;%d&nbsp;bytes;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7705212">,</span>&nbsp;<span class="ident" id="7705214">n</span><span class="op" id="7705215">,</span>&nbsp;<span class="builtinfunc" id="7705217">len</span><span class="op" id="7705220">(</span><span class="ident" id="7705221">readBuf</span><span class="op" id="7705228">)</span><span class="op" id="7705229">-</span><span class="num" id="7705230">1</span><span class="op" id="7705231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7705235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7705239">if</span>&nbsp;<span class="ident" id="7705242">err</span>&nbsp;<span class="op" id="7705246">!=</span>&nbsp;<span class="ident" id="7705249">io</span><span class="op" id="7705251">.</span><span class="ident" id="7705252">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="7705269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705274">t</span><span class="op" id="7705275">.</span><span class="ident" id="7705276">Fatalf</span><span class="op" id="7705282">(</span><span class="string" id="7705283">&#34;read&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;ErrUnexpectedEOF&#34;</span><span class="op" id="7705323">,</span>&nbsp;<span class="ident" id="7705325">err</span><span class="op" id="7705328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7705332">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7705335">}</span><span class="op" id="7705336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7705339">if</span>&nbsp;<span class="ident" id="7705342">mallocs</span>&nbsp;<span class="op" id="7705350">&gt;</span>&nbsp;<span class="num" id="7705352">1.5</span>&nbsp;<span class="op" id="7705356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705360">t</span><span class="op" id="7705361">.</span><span class="ident" id="7705362">Errorf</span><span class="op" id="7705368">(</span><span class="string" id="7705369">&#34;mallocs&nbsp;=&nbsp;%v;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7705391">,</span>&nbsp;<span class="ident" id="7705393">mallocs</span><span class="op" id="7705400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7705403">}</span><br>
<span class="lineno"></span><span class="op" id="7705405">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="7705408">func</span>&nbsp;<span class="ident" id="7705413">TestParseHexUint</span><span class="op" id="7705429">(</span><span class="ident" id="7705430">t</span>&nbsp;<span class="op" id="7705432">*</span><span class="ident" id="7705433">testing</span><span class="op" id="7705440">.</span><span class="ident" id="7705441">T</span><span class="op" id="7705442">)</span>&nbsp;<span class="op" id="7705444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7705447">for</span>&nbsp;<span class="ident" id="7705451">i</span>&nbsp;<span class="op" id="7705453">:=</span>&nbsp;<span class="ident" id="7705456">uint64</span><span class="op" id="7705462">(</span><span class="num" id="7705463">0</span><span class="op" id="7705464">)</span><span class="op" id="7705465">;</span>&nbsp;<span class="ident" id="7705467">i</span>&nbsp;<span class="op" id="7705469">&lt;=</span>&nbsp;<span class="num" id="7705472">1234</span><span class="op" id="7705476">;</span>&nbsp;<span class="ident" id="7705478">i</span><span class="op" id="7705479">++</span>&nbsp;<span class="op" id="7705482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705486">line</span>&nbsp;<span class="op" id="7705491">:=</span>&nbsp;<span class="op" id="7705494">[</span><span class="op" id="7705495">]</span><span class="builtintype" id="7705496">byte</span><span class="op" id="7705500">(</span><span class="ident" id="7705501">fmt</span><span class="op" id="7705504">.</span><span class="ident" id="7705505">Sprintf</span><span class="op" id="7705512">(</span><span class="string" id="7705513">&#34;%x&#34;</span><span class="op" id="7705517">,</span>&nbsp;<span class="ident" id="7705519">i</span><span class="op" id="7705520">)</span><span class="op" id="7705521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705525">got</span><span class="op" id="7705528">,</span>&nbsp;<span class="ident" id="7705530">err</span>&nbsp;<span class="op" id="7705534">:=</span>&nbsp;<span class="ident" id="7705537">parseHexUint</span><span class="op" id="7705549">(</span><span class="ident" id="7705550">line</span><span class="op" id="7705554">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7705558">if</span>&nbsp;<span class="ident" id="7705561">err</span>&nbsp;<span class="op" id="7705565">!=</span>&nbsp;<span class="ident" id="7705568">nil</span>&nbsp;<span class="op" id="7705572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705577">t</span><span class="op" id="7705578">.</span><span class="ident" id="7705579">Fatalf</span><span class="op" id="7705585">(</span><span class="string" id="7705586">&#34;on&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="7705597">,</span>&nbsp;<span class="ident" id="7705599">i</span><span class="op" id="7705600">,</span>&nbsp;<span class="ident" id="7705602">err</span><span class="op" id="7705605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7705609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7705613">if</span>&nbsp;<span class="ident" id="7705616">got</span>&nbsp;<span class="op" id="7705620">!=</span>&nbsp;<span class="ident" id="7705623">i</span>&nbsp;<span class="op" id="7705625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705630">t</span><span class="op" id="7705631">.</span><span class="ident" id="7705632">Errorf</span><span class="op" id="7705638">(</span><span class="string" id="7705639">&#34;for&nbsp;input&nbsp;%q&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7705667">,</span>&nbsp;<span class="ident" id="7705669">line</span><span class="op" id="7705673">,</span>&nbsp;<span class="ident" id="7705675">got</span><span class="op" id="7705678">,</span>&nbsp;<span class="ident" id="7705680">i</span><span class="op" id="7705681">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7705685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7705688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705691">_</span><span class="op" id="7705692">,</span>&nbsp;<span class="ident" id="7705694">err</span>&nbsp;<span class="op" id="7705698">:=</span>&nbsp;<span class="ident" id="7705701">parseHexUint</span><span class="op" id="7705713">(</span><span class="op" id="7705714">[</span><span class="op" id="7705715">]</span><span class="builtintype" id="7705716">byte</span><span class="op" id="7705720">(</span><span class="string" id="7705721">&#34;bogus&#34;</span><span class="op" id="7705728">)</span><span class="op" id="7705729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7705732">if</span>&nbsp;<span class="ident" id="7705735">err</span>&nbsp;<span class="op" id="7705739">==</span>&nbsp;<span class="ident" id="7705742">nil</span>&nbsp;<span class="op" id="7705746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7705750">t</span><span class="op" id="7705751">.</span><span class="ident" id="7705752">Error</span><span class="op" id="7705757">(</span><span class="string" id="7705758">&#34;expected&nbsp;error&nbsp;on&nbsp;bogus&nbsp;input&#34;</span><span class="op" id="7705789">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7705792">}</span><br>
<span class="lineno"></span><span class="op" id="7705794">}</span>
</div>
</body>
</html>
