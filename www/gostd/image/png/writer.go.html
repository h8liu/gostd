<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5577218">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5577273">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5577327">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5577378">package</span>&nbsp;<span class="ident" id="5577386">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5577391">import</span>&nbsp;<span class="op" id="5577398">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577401">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577410">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577427">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577441">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577450">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577465">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577471">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5577481">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5577484">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="5577527">type</span>&nbsp;<span class="ident" id="5577532">Encoder</span>&nbsp;<span class="keyword" id="5577540">struct</span>&nbsp;<span class="op" id="5577547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577550">CompressionLevel</span>&nbsp;<span class="ident" id="5577567">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="5577584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5577587">type</span>&nbsp;<span class="ident" id="5577592">encoder</span>&nbsp;<span class="keyword" id="5577600">struct</span>&nbsp;<span class="op" id="5577607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577610">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5577617">*</span><span class="ident" id="5577618">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577627">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5577634">io</span><span class="op" id="5577636">.</span><span class="ident" id="5577637">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577645">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5577652">image</span><span class="op" id="5577657">.</span><span class="ident" id="5577658">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577665">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5577672">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577677">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5577684">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577691">header</span>&nbsp;<span class="op" id="5577698">[</span><span class="num" id="5577699">8</span><span class="op" id="5577700">]</span><span class="builtintype" id="5577701">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577707">footer</span>&nbsp;<span class="op" id="5577714">[</span><span class="num" id="5577715">4</span><span class="op" id="5577716">]</span><span class="builtintype" id="5577717">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577723">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5577730">[</span><span class="num" id="5577731">4</span>&nbsp;<span class="op" id="5577733">*</span>&nbsp;<span class="num" id="5577735">256</span><span class="op" id="5577738">]</span><span class="builtintype" id="5577739">byte</span><br>
<span class="lineno"></span><span class="op" id="5577744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5577747">type</span>&nbsp;<span class="ident" id="5577752">CompressionLevel</span>&nbsp;<span class="builtintype" id="5577769">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5577774">const</span>&nbsp;<span class="op" id="5577780">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577783">DefaultCompression</span>&nbsp;<span class="ident" id="5577802">CompressionLevel</span>&nbsp;<span class="op" id="5577819">=</span>&nbsp;<span class="num" id="5577821">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577824">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5577843">CompressionLevel</span>&nbsp;<span class="op" id="5577860">=</span>&nbsp;<span class="op" id="5577862">-</span><span class="num" id="5577863">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577866">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5577885">CompressionLevel</span>&nbsp;<span class="op" id="5577902">=</span>&nbsp;<span class="op" id="5577904">-</span><span class="num" id="5577905">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577908">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5577927">CompressionLevel</span>&nbsp;<span class="op" id="5577944">=</span>&nbsp;<span class="op" id="5577946">-</span><span class="num" id="5577947">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5577951">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5578024">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="5578084">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5578087">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5578102">func</span>&nbsp;<span class="ident" id="5578107">writeUint32</span><span class="op" id="5578118">(</span><span class="ident" id="5578119">b</span>&nbsp;<span class="op" id="5578121">[</span><span class="op" id="5578122">]</span><span class="builtintype" id="5578123">uint8</span><span class="op" id="5578128">,</span>&nbsp;<span class="ident" id="5578130">u</span>&nbsp;<span class="builtintype" id="5578132">uint32</span><span class="op" id="5578138">)</span>&nbsp;<span class="op" id="5578140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578143">b</span><span class="op" id="5578144">[</span><span class="num" id="5578145">0</span><span class="op" id="5578146">]</span>&nbsp;<span class="op" id="5578148">=</span>&nbsp;<span class="builtintype" id="5578150">uint8</span><span class="op" id="5578155">(</span><span class="ident" id="5578156">u</span>&nbsp;<span class="op" id="5578158">&gt;&gt;</span>&nbsp;<span class="num" id="5578161">24</span><span class="op" id="5578163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578166">b</span><span class="op" id="5578167">[</span><span class="num" id="5578168">1</span><span class="op" id="5578169">]</span>&nbsp;<span class="op" id="5578171">=</span>&nbsp;<span class="builtintype" id="5578173">uint8</span><span class="op" id="5578178">(</span><span class="ident" id="5578179">u</span>&nbsp;<span class="op" id="5578181">&gt;&gt;</span>&nbsp;<span class="num" id="5578184">16</span><span class="op" id="5578186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578189">b</span><span class="op" id="5578190">[</span><span class="num" id="5578191">2</span><span class="op" id="5578192">]</span>&nbsp;<span class="op" id="5578194">=</span>&nbsp;<span class="builtintype" id="5578196">uint8</span><span class="op" id="5578201">(</span><span class="ident" id="5578202">u</span>&nbsp;<span class="op" id="5578204">&gt;&gt;</span>&nbsp;<span class="num" id="5578207">8</span><span class="op" id="5578208">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578211">b</span><span class="op" id="5578212">[</span><span class="num" id="5578213">3</span><span class="op" id="5578214">]</span>&nbsp;<span class="op" id="5578216">=</span>&nbsp;<span class="builtintype" id="5578218">uint8</span><span class="op" id="5578223">(</span><span class="ident" id="5578224">u</span>&nbsp;<span class="op" id="5578226">&gt;&gt;</span>&nbsp;<span class="num" id="5578229">0</span><span class="op" id="5578230">)</span><br>
<span class="lineno"></span><span class="op" id="5578232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5578235">type</span>&nbsp;<span class="ident" id="5578240">opaquer</span>&nbsp;<span class="keyword" id="5578248">interface</span>&nbsp;<span class="op" id="5578258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578261">Opaque</span><span class="op" id="5578267">(</span><span class="op" id="5578268">)</span>&nbsp;<span class="builtintype" id="5578270">bool</span><br>
<span class="lineno">55</span><span class="op" id="5578275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5578278">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5578331">func</span>&nbsp;<span class="ident" id="5578336">opaque</span><span class="op" id="5578342">(</span><span class="ident" id="5578343">m</span>&nbsp;<span class="ident" id="5578345">image</span><span class="op" id="5578350">.</span><span class="ident" id="5578351">Image</span><span class="op" id="5578356">)</span>&nbsp;<span class="builtintype" id="5578358">bool</span>&nbsp;<span class="op" id="5578363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578366">if</span>&nbsp;<span class="ident" id="5578369">o</span><span class="op" id="5578370">,</span>&nbsp;<span class="ident" id="5578372">ok</span>&nbsp;<span class="op" id="5578375">:=</span>&nbsp;<span class="ident" id="5578378">m</span><span class="op" id="5578379">.</span><span class="op" id="5578380">(</span><span class="ident" id="5578381">opaquer</span><span class="op" id="5578388">)</span><span class="op" id="5578389">;</span>&nbsp;<span class="ident" id="5578391">ok</span>&nbsp;<span class="op" id="5578394">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578398">return</span>&nbsp;<span class="ident" id="5578405">o</span><span class="op" id="5578406">.</span><span class="ident" id="5578407">Opaque</span><span class="op" id="5578413">(</span><span class="op" id="5578414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578420">b</span>&nbsp;<span class="op" id="5578422">:=</span>&nbsp;<span class="ident" id="5578425">m</span><span class="op" id="5578426">.</span><span class="ident" id="5578427">Bounds</span><span class="op" id="5578433">(</span><span class="op" id="5578434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578437">for</span>&nbsp;<span class="ident" id="5578441">y</span>&nbsp;<span class="op" id="5578443">:=</span>&nbsp;<span class="ident" id="5578446">b</span><span class="op" id="5578447">.</span><span class="ident" id="5578448">Min</span><span class="op" id="5578451">.</span><span class="ident" id="5578452">Y</span><span class="op" id="5578453">;</span>&nbsp;<span class="ident" id="5578455">y</span>&nbsp;<span class="op" id="5578457">&lt;</span>&nbsp;<span class="ident" id="5578459">b</span><span class="op" id="5578460">.</span><span class="ident" id="5578461">Max</span><span class="op" id="5578464">.</span><span class="ident" id="5578465">Y</span><span class="op" id="5578466">;</span>&nbsp;<span class="ident" id="5578468">y</span><span class="op" id="5578469">++</span>&nbsp;<span class="op" id="5578472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578476">for</span>&nbsp;<span class="ident" id="5578480">x</span>&nbsp;<span class="op" id="5578482">:=</span>&nbsp;<span class="ident" id="5578485">b</span><span class="op" id="5578486">.</span><span class="ident" id="5578487">Min</span><span class="op" id="5578490">.</span><span class="ident" id="5578491">X</span><span class="op" id="5578492">;</span>&nbsp;<span class="ident" id="5578494">x</span>&nbsp;<span class="op" id="5578496">&lt;</span>&nbsp;<span class="ident" id="5578498">b</span><span class="op" id="5578499">.</span><span class="ident" id="5578500">Max</span><span class="op" id="5578503">.</span><span class="ident" id="5578504">X</span><span class="op" id="5578505">;</span>&nbsp;<span class="ident" id="5578507">x</span><span class="op" id="5578508">++</span>&nbsp;<span class="op" id="5578511">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578516">_</span><span class="op" id="5578517">,</span>&nbsp;<span class="ident" id="5578519">_</span><span class="op" id="5578520">,</span>&nbsp;<span class="ident" id="5578522">_</span><span class="op" id="5578523">,</span>&nbsp;<span class="ident" id="5578525">a</span>&nbsp;<span class="op" id="5578527">:=</span>&nbsp;<span class="ident" id="5578530">m</span><span class="op" id="5578531">.</span><span class="ident" id="5578532">At</span><span class="op" id="5578534">(</span><span class="ident" id="5578535">x</span><span class="op" id="5578536">,</span>&nbsp;<span class="ident" id="5578538">y</span><span class="op" id="5578539">)</span><span class="op" id="5578540">.</span><span class="ident" id="5578541">RGBA</span><span class="op" id="5578545">(</span><span class="op" id="5578546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578551">if</span>&nbsp;<span class="ident" id="5578554">a</span>&nbsp;<span class="op" id="5578556">!=</span>&nbsp;<span class="num" id="5578559">0xffff</span>&nbsp;<span class="op" id="5578566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578572">return</span>&nbsp;<span class="builtintype" id="5578579">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578592">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578598">return</span>&nbsp;<span class="builtintype" id="5578605">true</span><br>
<span class="lineno"></span><span class="op" id="5578610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5578613">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="5578675">func</span>&nbsp;<span class="ident" id="5578680">abs8</span><span class="op" id="5578684">(</span><span class="ident" id="5578685">d</span>&nbsp;<span class="builtintype" id="5578687">uint8</span><span class="op" id="5578692">)</span>&nbsp;<span class="builtintype" id="5578694">int</span>&nbsp;<span class="op" id="5578698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578701">if</span>&nbsp;<span class="ident" id="5578704">d</span>&nbsp;<span class="op" id="5578706">&lt;</span>&nbsp;<span class="num" id="5578708">128</span>&nbsp;<span class="op" id="5578712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578716">return</span>&nbsp;<span class="builtintype" id="5578723">int</span><span class="op" id="5578726">(</span><span class="ident" id="5578727">d</span><span class="op" id="5578728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578734">return</span>&nbsp;<span class="num" id="5578741">256</span>&nbsp;<span class="op" id="5578745">-</span>&nbsp;<span class="builtintype" id="5578747">int</span><span class="op" id="5578750">(</span><span class="ident" id="5578751">d</span><span class="op" id="5578752">)</span><br>
<span class="lineno">80</span><span class="op" id="5578754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5578757">func</span>&nbsp;<span class="op" id="5578762">(</span><span class="ident" id="5578763">e</span>&nbsp;<span class="op" id="5578765">*</span><span class="ident" id="5578766">encoder</span><span class="op" id="5578773">)</span>&nbsp;<span class="ident" id="5578775">writeChunk</span><span class="op" id="5578785">(</span><span class="ident" id="5578786">b</span>&nbsp;<span class="op" id="5578788">[</span><span class="op" id="5578789">]</span><span class="builtintype" id="5578790">byte</span><span class="op" id="5578794">,</span>&nbsp;<span class="ident" id="5578796">name</span>&nbsp;<span class="builtintype" id="5578801">string</span><span class="op" id="5578807">)</span>&nbsp;<span class="op" id="5578809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578812">if</span>&nbsp;<span class="ident" id="5578815">e</span><span class="op" id="5578816">.</span><span class="ident" id="5578817">err</span>&nbsp;<span class="op" id="5578821">!=</span>&nbsp;<span class="ident" id="5578824">nil</span>&nbsp;<span class="op" id="5578828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578832">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578843">n</span>&nbsp;<span class="op" id="5578845">:=</span>&nbsp;<span class="builtintype" id="5578848">uint32</span><span class="op" id="5578854">(</span><span class="builtinfunc" id="5578855">len</span><span class="op" id="5578858">(</span><span class="ident" id="5578859">b</span><span class="op" id="5578860">)</span><span class="op" id="5578861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578864">if</span>&nbsp;<span class="builtintype" id="5578867">int</span><span class="op" id="5578870">(</span><span class="ident" id="5578871">n</span><span class="op" id="5578872">)</span>&nbsp;<span class="op" id="5578874">!=</span>&nbsp;<span class="builtinfunc" id="5578877">len</span><span class="op" id="5578880">(</span><span class="ident" id="5578881">b</span><span class="op" id="5578882">)</span>&nbsp;<span class="op" id="5578884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578888">e</span><span class="op" id="5578889">.</span><span class="ident" id="5578890">err</span>&nbsp;<span class="op" id="5578894">=</span>&nbsp;<span class="ident" id="5578896">UnsupportedError</span><span class="op" id="5578912">(</span><span class="ident" id="5578913">name</span>&nbsp;<span class="op" id="5578918">+</span>&nbsp;<span class="string" id="5578920">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="5578944">+</span>&nbsp;<span class="ident" id="5578946">strconv</span><span class="op" id="5578953">.</span><span class="ident" id="5578954">Itoa</span><span class="op" id="5578958">(</span><span class="builtinfunc" id="5578959">len</span><span class="op" id="5578962">(</span><span class="ident" id="5578963">b</span><span class="op" id="5578964">)</span><span class="op" id="5578965">)</span><span class="op" id="5578966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578970">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578981">writeUint32</span><span class="op" id="5578992">(</span><span class="ident" id="5578993">e</span><span class="op" id="5578994">.</span><span class="ident" id="5578995">header</span><span class="op" id="5579001">[</span><span class="op" id="5579002">:</span><span class="num" id="5579003">4</span><span class="op" id="5579004">]</span><span class="op" id="5579005">,</span>&nbsp;<span class="ident" id="5579007">n</span><span class="op" id="5579008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579011">e</span><span class="op" id="5579012">.</span><span class="ident" id="5579013">header</span><span class="op" id="5579019">[</span><span class="num" id="5579020">4</span><span class="op" id="5579021">]</span>&nbsp;<span class="op" id="5579023">=</span>&nbsp;<span class="ident" id="5579025">name</span><span class="op" id="5579029">[</span><span class="num" id="5579030">0</span><span class="op" id="5579031">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579034">e</span><span class="op" id="5579035">.</span><span class="ident" id="5579036">header</span><span class="op" id="5579042">[</span><span class="num" id="5579043">5</span><span class="op" id="5579044">]</span>&nbsp;<span class="op" id="5579046">=</span>&nbsp;<span class="ident" id="5579048">name</span><span class="op" id="5579052">[</span><span class="num" id="5579053">1</span><span class="op" id="5579054">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579057">e</span><span class="op" id="5579058">.</span><span class="ident" id="5579059">header</span><span class="op" id="5579065">[</span><span class="num" id="5579066">6</span><span class="op" id="5579067">]</span>&nbsp;<span class="op" id="5579069">=</span>&nbsp;<span class="ident" id="5579071">name</span><span class="op" id="5579075">[</span><span class="num" id="5579076">2</span><span class="op" id="5579077">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579080">e</span><span class="op" id="5579081">.</span><span class="ident" id="5579082">header</span><span class="op" id="5579088">[</span><span class="num" id="5579089">7</span><span class="op" id="5579090">]</span>&nbsp;<span class="op" id="5579092">=</span>&nbsp;<span class="ident" id="5579094">name</span><span class="op" id="5579098">[</span><span class="num" id="5579099">3</span><span class="op" id="5579100">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579103">crc</span>&nbsp;<span class="op" id="5579107">:=</span>&nbsp;<span class="ident" id="5579110">crc32</span><span class="op" id="5579115">.</span><span class="ident" id="5579116">NewIEEE</span><span class="op" id="5579123">(</span><span class="op" id="5579124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579127">crc</span><span class="op" id="5579130">.</span><span class="ident" id="5579131">Write</span><span class="op" id="5579136">(</span><span class="ident" id="5579137">e</span><span class="op" id="5579138">.</span><span class="ident" id="5579139">header</span><span class="op" id="5579145">[</span><span class="num" id="5579146">4</span><span class="op" id="5579147">:</span><span class="num" id="5579148">8</span><span class="op" id="5579149">]</span><span class="op" id="5579150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579153">crc</span><span class="op" id="5579156">.</span><span class="ident" id="5579157">Write</span><span class="op" id="5579162">(</span><span class="ident" id="5579163">b</span><span class="op" id="5579164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579167">writeUint32</span><span class="op" id="5579178">(</span><span class="ident" id="5579179">e</span><span class="op" id="5579180">.</span><span class="ident" id="5579181">footer</span><span class="op" id="5579187">[</span><span class="op" id="5579188">:</span><span class="num" id="5579189">4</span><span class="op" id="5579190">]</span><span class="op" id="5579191">,</span>&nbsp;<span class="ident" id="5579193">crc</span><span class="op" id="5579196">.</span><span class="ident" id="5579197">Sum32</span><span class="op" id="5579202">(</span><span class="op" id="5579203">)</span><span class="op" id="5579204">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579208">_</span><span class="op" id="5579209">,</span>&nbsp;<span class="ident" id="5579211">e</span><span class="op" id="5579212">.</span><span class="ident" id="5579213">err</span>&nbsp;<span class="op" id="5579217">=</span>&nbsp;<span class="ident" id="5579219">e</span><span class="op" id="5579220">.</span><span class="ident" id="5579221">w</span><span class="op" id="5579222">.</span><span class="ident" id="5579223">Write</span><span class="op" id="5579228">(</span><span class="ident" id="5579229">e</span><span class="op" id="5579230">.</span><span class="ident" id="5579231">header</span><span class="op" id="5579237">[</span><span class="op" id="5579238">:</span><span class="num" id="5579239">8</span><span class="op" id="5579240">]</span><span class="op" id="5579241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579244">if</span>&nbsp;<span class="ident" id="5579247">e</span><span class="op" id="5579248">.</span><span class="ident" id="5579249">err</span>&nbsp;<span class="op" id="5579253">!=</span>&nbsp;<span class="ident" id="5579256">nil</span>&nbsp;<span class="op" id="5579260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579264">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579272">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579275">_</span><span class="op" id="5579276">,</span>&nbsp;<span class="ident" id="5579278">e</span><span class="op" id="5579279">.</span><span class="ident" id="5579280">err</span>&nbsp;<span class="op" id="5579284">=</span>&nbsp;<span class="ident" id="5579286">e</span><span class="op" id="5579287">.</span><span class="ident" id="5579288">w</span><span class="op" id="5579289">.</span><span class="ident" id="5579290">Write</span><span class="op" id="5579295">(</span><span class="ident" id="5579296">b</span><span class="op" id="5579297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579300">if</span>&nbsp;<span class="ident" id="5579303">e</span><span class="op" id="5579304">.</span><span class="ident" id="5579305">err</span>&nbsp;<span class="op" id="5579309">!=</span>&nbsp;<span class="ident" id="5579312">nil</span>&nbsp;<span class="op" id="5579316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579320">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579331">_</span><span class="op" id="5579332">,</span>&nbsp;<span class="ident" id="5579334">e</span><span class="op" id="5579335">.</span><span class="ident" id="5579336">err</span>&nbsp;<span class="op" id="5579340">=</span>&nbsp;<span class="ident" id="5579342">e</span><span class="op" id="5579343">.</span><span class="ident" id="5579344">w</span><span class="op" id="5579345">.</span><span class="ident" id="5579346">Write</span><span class="op" id="5579351">(</span><span class="ident" id="5579352">e</span><span class="op" id="5579353">.</span><span class="ident" id="5579354">footer</span><span class="op" id="5579360">[</span><span class="op" id="5579361">:</span><span class="num" id="5579362">4</span><span class="op" id="5579363">]</span><span class="op" id="5579364">)</span><br>
<span class="lineno">110</span><span class="op" id="5579366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5579369">func</span>&nbsp;<span class="op" id="5579374">(</span><span class="ident" id="5579375">e</span>&nbsp;<span class="op" id="5579377">*</span><span class="ident" id="5579378">encoder</span><span class="op" id="5579385">)</span>&nbsp;<span class="ident" id="5579387">writeIHDR</span><span class="op" id="5579396">(</span><span class="op" id="5579397">)</span>&nbsp;<span class="op" id="5579399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579402">b</span>&nbsp;<span class="op" id="5579404">:=</span>&nbsp;<span class="ident" id="5579407">e</span><span class="op" id="5579408">.</span><span class="ident" id="5579409">m</span><span class="op" id="5579410">.</span><span class="ident" id="5579411">Bounds</span><span class="op" id="5579417">(</span><span class="op" id="5579418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579421">writeUint32</span><span class="op" id="5579432">(</span><span class="ident" id="5579433">e</span><span class="op" id="5579434">.</span><span class="ident" id="5579435">tmp</span><span class="op" id="5579438">[</span><span class="num" id="5579439">0</span><span class="op" id="5579440">:</span><span class="num" id="5579441">4</span><span class="op" id="5579442">]</span><span class="op" id="5579443">,</span>&nbsp;<span class="builtintype" id="5579445">uint32</span><span class="op" id="5579451">(</span><span class="ident" id="5579452">b</span><span class="op" id="5579453">.</span><span class="ident" id="5579454">Dx</span><span class="op" id="5579456">(</span><span class="op" id="5579457">)</span><span class="op" id="5579458">)</span><span class="op" id="5579459">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579462">writeUint32</span><span class="op" id="5579473">(</span><span class="ident" id="5579474">e</span><span class="op" id="5579475">.</span><span class="ident" id="5579476">tmp</span><span class="op" id="5579479">[</span><span class="num" id="5579480">4</span><span class="op" id="5579481">:</span><span class="num" id="5579482">8</span><span class="op" id="5579483">]</span><span class="op" id="5579484">,</span>&nbsp;<span class="builtintype" id="5579486">uint32</span><span class="op" id="5579492">(</span><span class="ident" id="5579493">b</span><span class="op" id="5579494">.</span><span class="ident" id="5579495">Dy</span><span class="op" id="5579497">(</span><span class="op" id="5579498">)</span><span class="op" id="5579499">)</span><span class="op" id="5579500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579503">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579537">switch</span>&nbsp;<span class="ident" id="5579544">e</span><span class="op" id="5579545">.</span><span class="ident" id="5579546">cb</span>&nbsp;<span class="op" id="5579549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579552">case</span>&nbsp;<span class="ident" id="5579557">cbG8</span><span class="op" id="5579561">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579565">e</span><span class="op" id="5579566">.</span><span class="ident" id="5579567">tmp</span><span class="op" id="5579570">[</span><span class="num" id="5579571">8</span><span class="op" id="5579572">]</span>&nbsp;<span class="op" id="5579574">=</span>&nbsp;<span class="num" id="5579576">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579580">e</span><span class="op" id="5579581">.</span><span class="ident" id="5579582">tmp</span><span class="op" id="5579585">[</span><span class="num" id="5579586">9</span><span class="op" id="5579587">]</span>&nbsp;<span class="op" id="5579589">=</span>&nbsp;<span class="ident" id="5579591">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579604">case</span>&nbsp;<span class="ident" id="5579609">cbTC8</span><span class="op" id="5579614">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579618">e</span><span class="op" id="5579619">.</span><span class="ident" id="5579620">tmp</span><span class="op" id="5579623">[</span><span class="num" id="5579624">8</span><span class="op" id="5579625">]</span>&nbsp;<span class="op" id="5579627">=</span>&nbsp;<span class="num" id="5579629">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579633">e</span><span class="op" id="5579634">.</span><span class="ident" id="5579635">tmp</span><span class="op" id="5579638">[</span><span class="num" id="5579639">9</span><span class="op" id="5579640">]</span>&nbsp;<span class="op" id="5579642">=</span>&nbsp;<span class="ident" id="5579644">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579657">case</span>&nbsp;<span class="ident" id="5579662">cbP8</span><span class="op" id="5579666">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579670">e</span><span class="op" id="5579671">.</span><span class="ident" id="5579672">tmp</span><span class="op" id="5579675">[</span><span class="num" id="5579676">8</span><span class="op" id="5579677">]</span>&nbsp;<span class="op" id="5579679">=</span>&nbsp;<span class="num" id="5579681">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579685">e</span><span class="op" id="5579686">.</span><span class="ident" id="5579687">tmp</span><span class="op" id="5579690">[</span><span class="num" id="5579691">9</span><span class="op" id="5579692">]</span>&nbsp;<span class="op" id="5579694">=</span>&nbsp;<span class="ident" id="5579696">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579708">case</span>&nbsp;<span class="ident" id="5579713">cbTCA8</span><span class="op" id="5579719">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579723">e</span><span class="op" id="5579724">.</span><span class="ident" id="5579725">tmp</span><span class="op" id="5579728">[</span><span class="num" id="5579729">8</span><span class="op" id="5579730">]</span>&nbsp;<span class="op" id="5579732">=</span>&nbsp;<span class="num" id="5579734">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579738">e</span><span class="op" id="5579739">.</span><span class="ident" id="5579740">tmp</span><span class="op" id="5579743">[</span><span class="num" id="5579744">9</span><span class="op" id="5579745">]</span>&nbsp;<span class="op" id="5579747">=</span>&nbsp;<span class="ident" id="5579749">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579767">case</span>&nbsp;<span class="ident" id="5579772">cbG16</span><span class="op" id="5579777">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579781">e</span><span class="op" id="5579782">.</span><span class="ident" id="5579783">tmp</span><span class="op" id="5579786">[</span><span class="num" id="5579787">8</span><span class="op" id="5579788">]</span>&nbsp;<span class="op" id="5579790">=</span>&nbsp;<span class="num" id="5579792">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579797">e</span><span class="op" id="5579798">.</span><span class="ident" id="5579799">tmp</span><span class="op" id="5579802">[</span><span class="num" id="5579803">9</span><span class="op" id="5579804">]</span>&nbsp;<span class="op" id="5579806">=</span>&nbsp;<span class="ident" id="5579808">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579821">case</span>&nbsp;<span class="ident" id="5579826">cbTC16</span><span class="op" id="5579832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579836">e</span><span class="op" id="5579837">.</span><span class="ident" id="5579838">tmp</span><span class="op" id="5579841">[</span><span class="num" id="5579842">8</span><span class="op" id="5579843">]</span>&nbsp;<span class="op" id="5579845">=</span>&nbsp;<span class="num" id="5579847">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579852">e</span><span class="op" id="5579853">.</span><span class="ident" id="5579854">tmp</span><span class="op" id="5579857">[</span><span class="num" id="5579858">9</span><span class="op" id="5579859">]</span>&nbsp;<span class="op" id="5579861">=</span>&nbsp;<span class="ident" id="5579863">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579876">case</span>&nbsp;<span class="ident" id="5579881">cbTCA16</span><span class="op" id="5579888">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579892">e</span><span class="op" id="5579893">.</span><span class="ident" id="5579894">tmp</span><span class="op" id="5579897">[</span><span class="num" id="5579898">8</span><span class="op" id="5579899">]</span>&nbsp;<span class="op" id="5579901">=</span>&nbsp;<span class="num" id="5579903">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579908">e</span><span class="op" id="5579909">.</span><span class="ident" id="5579910">tmp</span><span class="op" id="5579913">[</span><span class="num" id="5579914">9</span><span class="op" id="5579915">]</span>&nbsp;<span class="op" id="5579917">=</span>&nbsp;<span class="ident" id="5579919">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579937">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579940">e</span><span class="op" id="5579941">.</span><span class="ident" id="5579942">tmp</span><span class="op" id="5579945">[</span><span class="num" id="5579946">10</span><span class="op" id="5579948">]</span>&nbsp;<span class="op" id="5579950">=</span>&nbsp;<span class="num" id="5579952">0</span>&nbsp;<span class="comment" id="5579954">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579985">e</span><span class="op" id="5579986">.</span><span class="ident" id="5579987">tmp</span><span class="op" id="5579990">[</span><span class="num" id="5579991">11</span><span class="op" id="5579993">]</span>&nbsp;<span class="op" id="5579995">=</span>&nbsp;<span class="num" id="5579997">0</span>&nbsp;<span class="comment" id="5579999">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580025">e</span><span class="op" id="5580026">.</span><span class="ident" id="5580027">tmp</span><span class="op" id="5580030">[</span><span class="num" id="5580031">12</span><span class="op" id="5580033">]</span>&nbsp;<span class="op" id="5580035">=</span>&nbsp;<span class="num" id="5580037">0</span>&nbsp;<span class="comment" id="5580039">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580058">e</span><span class="op" id="5580059">.</span><span class="ident" id="5580060">writeChunk</span><span class="op" id="5580070">(</span><span class="ident" id="5580071">e</span><span class="op" id="5580072">.</span><span class="ident" id="5580073">tmp</span><span class="op" id="5580076">[</span><span class="op" id="5580077">:</span><span class="num" id="5580078">13</span><span class="op" id="5580080">]</span><span class="op" id="5580081">,</span>&nbsp;<span class="string" id="5580083">&#34;IHDR&#34;</span><span class="op" id="5580089">)</span><br>
<span class="lineno"></span><span class="op" id="5580091">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="5580094">func</span>&nbsp;<span class="op" id="5580099">(</span><span class="ident" id="5580100">e</span>&nbsp;<span class="op" id="5580102">*</span><span class="ident" id="5580103">encoder</span><span class="op" id="5580110">)</span>&nbsp;<span class="ident" id="5580112">writePLTEAndTRNS</span><span class="op" id="5580128">(</span><span class="ident" id="5580129">p</span>&nbsp;<span class="ident" id="5580131">color</span><span class="op" id="5580136">.</span><span class="ident" id="5580137">Palette</span><span class="op" id="5580144">)</span>&nbsp;<span class="op" id="5580146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580149">if</span>&nbsp;<span class="builtinfunc" id="5580152">len</span><span class="op" id="5580155">(</span><span class="ident" id="5580156">p</span><span class="op" id="5580157">)</span>&nbsp;<span class="op" id="5580159">&lt;</span>&nbsp;<span class="num" id="5580161">1</span>&nbsp;<span class="op" id="5580163">||</span>&nbsp;<span class="builtinfunc" id="5580166">len</span><span class="op" id="5580169">(</span><span class="ident" id="5580170">p</span><span class="op" id="5580171">)</span>&nbsp;<span class="op" id="5580173">&gt;</span>&nbsp;<span class="num" id="5580175">256</span>&nbsp;<span class="op" id="5580179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580183">e</span><span class="op" id="5580184">.</span><span class="ident" id="5580185">err</span>&nbsp;<span class="op" id="5580189">=</span>&nbsp;<span class="ident" id="5580191">FormatError</span><span class="op" id="5580202">(</span><span class="string" id="5580203">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="5580226">+</span>&nbsp;<span class="ident" id="5580228">strconv</span><span class="op" id="5580235">.</span><span class="ident" id="5580236">Itoa</span><span class="op" id="5580240">(</span><span class="builtinfunc" id="5580241">len</span><span class="op" id="5580244">(</span><span class="ident" id="5580245">p</span><span class="op" id="5580246">)</span><span class="op" id="5580247">)</span><span class="op" id="5580248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580252">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580263">last</span>&nbsp;<span class="op" id="5580268">:=</span>&nbsp;<span class="op" id="5580271">-</span><span class="num" id="5580272">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580275">for</span>&nbsp;<span class="ident" id="5580279">i</span><span class="op" id="5580280">,</span>&nbsp;<span class="ident" id="5580282">c</span>&nbsp;<span class="op" id="5580284">:=</span>&nbsp;<span class="keyword" id="5580287">range</span>&nbsp;<span class="ident" id="5580293">p</span>&nbsp;<span class="op" id="5580295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580299">c1</span>&nbsp;<span class="op" id="5580302">:=</span>&nbsp;<span class="ident" id="5580305">color</span><span class="op" id="5580310">.</span><span class="ident" id="5580311">NRGBAModel</span><span class="op" id="5580321">.</span><span class="ident" id="5580322">Convert</span><span class="op" id="5580329">(</span><span class="ident" id="5580330">c</span><span class="op" id="5580331">)</span><span class="op" id="5580332">.</span><span class="op" id="5580333">(</span><span class="ident" id="5580334">color</span><span class="op" id="5580339">.</span><span class="ident" id="5580340">NRGBA</span><span class="op" id="5580345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580349">e</span><span class="op" id="5580350">.</span><span class="ident" id="5580351">tmp</span><span class="op" id="5580354">[</span><span class="num" id="5580355">3</span><span class="op" id="5580356">*</span><span class="ident" id="5580357">i</span><span class="op" id="5580358">+</span><span class="num" id="5580359">0</span><span class="op" id="5580360">]</span>&nbsp;<span class="op" id="5580362">=</span>&nbsp;<span class="ident" id="5580364">c1</span><span class="op" id="5580366">.</span><span class="ident" id="5580367">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580371">e</span><span class="op" id="5580372">.</span><span class="ident" id="5580373">tmp</span><span class="op" id="5580376">[</span><span class="num" id="5580377">3</span><span class="op" id="5580378">*</span><span class="ident" id="5580379">i</span><span class="op" id="5580380">+</span><span class="num" id="5580381">1</span><span class="op" id="5580382">]</span>&nbsp;<span class="op" id="5580384">=</span>&nbsp;<span class="ident" id="5580386">c1</span><span class="op" id="5580388">.</span><span class="ident" id="5580389">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580393">e</span><span class="op" id="5580394">.</span><span class="ident" id="5580395">tmp</span><span class="op" id="5580398">[</span><span class="num" id="5580399">3</span><span class="op" id="5580400">*</span><span class="ident" id="5580401">i</span><span class="op" id="5580402">+</span><span class="num" id="5580403">2</span><span class="op" id="5580404">]</span>&nbsp;<span class="op" id="5580406">=</span>&nbsp;<span class="ident" id="5580408">c1</span><span class="op" id="5580410">.</span><span class="ident" id="5580411">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580415">if</span>&nbsp;<span class="ident" id="5580418">c1</span><span class="op" id="5580420">.</span><span class="ident" id="5580421">A</span>&nbsp;<span class="op" id="5580423">!=</span>&nbsp;<span class="num" id="5580426">0xff</span>&nbsp;<span class="op" id="5580431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580436">last</span>&nbsp;<span class="op" id="5580441">=</span>&nbsp;<span class="ident" id="5580443">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580447">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580451">e</span><span class="op" id="5580452">.</span><span class="ident" id="5580453">tmp</span><span class="op" id="5580456">[</span><span class="num" id="5580457">3</span><span class="op" id="5580458">*</span><span class="num" id="5580459">256</span><span class="op" id="5580462">+</span><span class="ident" id="5580463">i</span><span class="op" id="5580464">]</span>&nbsp;<span class="op" id="5580466">=</span>&nbsp;<span class="ident" id="5580468">c1</span><span class="op" id="5580470">.</span><span class="ident" id="5580471">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580477">e</span><span class="op" id="5580478">.</span><span class="ident" id="5580479">writeChunk</span><span class="op" id="5580489">(</span><span class="ident" id="5580490">e</span><span class="op" id="5580491">.</span><span class="ident" id="5580492">tmp</span><span class="op" id="5580495">[</span><span class="op" id="5580496">:</span><span class="num" id="5580497">3</span><span class="op" id="5580498">*</span><span class="builtinfunc" id="5580499">len</span><span class="op" id="5580502">(</span><span class="ident" id="5580503">p</span><span class="op" id="5580504">)</span><span class="op" id="5580505">]</span><span class="op" id="5580506">,</span>&nbsp;<span class="string" id="5580508">&#34;PLTE&#34;</span><span class="op" id="5580514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580517">if</span>&nbsp;<span class="ident" id="5580520">last</span>&nbsp;<span class="op" id="5580525">!=</span>&nbsp;<span class="op" id="5580528">-</span><span class="num" id="5580529">1</span>&nbsp;<span class="op" id="5580531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580535">e</span><span class="op" id="5580536">.</span><span class="ident" id="5580537">writeChunk</span><span class="op" id="5580547">(</span><span class="ident" id="5580548">e</span><span class="op" id="5580549">.</span><span class="ident" id="5580550">tmp</span><span class="op" id="5580553">[</span><span class="num" id="5580554">3</span><span class="op" id="5580555">*</span><span class="num" id="5580556">256</span><span class="op" id="5580559">:</span><span class="num" id="5580560">3</span><span class="op" id="5580561">*</span><span class="num" id="5580562">256</span><span class="op" id="5580565">+</span><span class="num" id="5580566">1</span><span class="op" id="5580567">+</span><span class="ident" id="5580568">last</span><span class="op" id="5580572">]</span><span class="op" id="5580573">,</span>&nbsp;<span class="string" id="5580575">&#34;tRNS&#34;</span><span class="op" id="5580581">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580584">}</span><br>
<span class="lineno"></span><span class="op" id="5580586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5580589">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="5580669">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="5580750">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="5580824">//</span><br>
<span class="lineno"></span><span class="comment" id="5580827">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="5580898">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5580956">func</span>&nbsp;<span class="op" id="5580961">(</span><span class="ident" id="5580962">e</span>&nbsp;<span class="op" id="5580964">*</span><span class="ident" id="5580965">encoder</span><span class="op" id="5580972">)</span>&nbsp;<span class="ident" id="5580974">Write</span><span class="op" id="5580979">(</span><span class="ident" id="5580980">b</span>&nbsp;<span class="op" id="5580982">[</span><span class="op" id="5580983">]</span><span class="builtintype" id="5580984">byte</span><span class="op" id="5580988">)</span>&nbsp;<span class="op" id="5580990">(</span><span class="builtintype" id="5580991">int</span><span class="op" id="5580994">,</span>&nbsp;<span class="builtintype" id="5580996">error</span><span class="op" id="5581001">)</span>&nbsp;<span class="op" id="5581003">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581006">e</span><span class="op" id="5581007">.</span><span class="ident" id="5581008">writeChunk</span><span class="op" id="5581018">(</span><span class="ident" id="5581019">b</span><span class="op" id="5581020">,</span>&nbsp;<span class="string" id="5581022">&#34;IDAT&#34;</span><span class="op" id="5581028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581031">if</span>&nbsp;<span class="ident" id="5581034">e</span><span class="op" id="5581035">.</span><span class="ident" id="5581036">err</span>&nbsp;<span class="op" id="5581040">!=</span>&nbsp;<span class="ident" id="5581043">nil</span>&nbsp;<span class="op" id="5581047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581051">return</span>&nbsp;<span class="num" id="5581058">0</span><span class="op" id="5581059">,</span>&nbsp;<span class="ident" id="5581061">e</span><span class="op" id="5581062">.</span><span class="ident" id="5581063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581071">return</span>&nbsp;<span class="builtinfunc" id="5581078">len</span><span class="op" id="5581081">(</span><span class="ident" id="5581082">b</span><span class="op" id="5581083">)</span><span class="op" id="5581084">,</span>&nbsp;<span class="ident" id="5581086">nil</span><br>
<span class="lineno">180</span><span class="op" id="5581090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5581093">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5581168">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="5581266">func</span>&nbsp;<span class="ident" id="5581271">filter</span><span class="op" id="5581277">(</span><span class="ident" id="5581278">cr</span>&nbsp;<span class="op" id="5581281">*</span><span class="op" id="5581282">[</span><span class="ident" id="5581283">nFilter</span><span class="op" id="5581290">]</span><span class="op" id="5581291">[</span><span class="op" id="5581292">]</span><span class="builtintype" id="5581293">byte</span><span class="op" id="5581297">,</span>&nbsp;<span class="ident" id="5581299">pr</span>&nbsp;<span class="op" id="5581302">[</span><span class="op" id="5581303">]</span><span class="builtintype" id="5581304">byte</span><span class="op" id="5581308">,</span>&nbsp;<span class="ident" id="5581310">bpp</span>&nbsp;<span class="builtintype" id="5581314">int</span><span class="op" id="5581317">)</span>&nbsp;<span class="builtintype" id="5581319">int</span>&nbsp;<span class="op" id="5581323">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581326">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581425">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581521">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581616">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581690">cdat0</span>&nbsp;<span class="op" id="5581696">:=</span>&nbsp;<span class="ident" id="5581699">cr</span><span class="op" id="5581701">[</span><span class="num" id="5581702">0</span><span class="op" id="5581703">]</span><span class="op" id="5581704">[</span><span class="num" id="5581705">1</span><span class="op" id="5581706">:</span><span class="op" id="5581707">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581710">cdat1</span>&nbsp;<span class="op" id="5581716">:=</span>&nbsp;<span class="ident" id="5581719">cr</span><span class="op" id="5581721">[</span><span class="num" id="5581722">1</span><span class="op" id="5581723">]</span><span class="op" id="5581724">[</span><span class="num" id="5581725">1</span><span class="op" id="5581726">:</span><span class="op" id="5581727">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581730">cdat2</span>&nbsp;<span class="op" id="5581736">:=</span>&nbsp;<span class="ident" id="5581739">cr</span><span class="op" id="5581741">[</span><span class="num" id="5581742">2</span><span class="op" id="5581743">]</span><span class="op" id="5581744">[</span><span class="num" id="5581745">1</span><span class="op" id="5581746">:</span><span class="op" id="5581747">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581750">cdat3</span>&nbsp;<span class="op" id="5581756">:=</span>&nbsp;<span class="ident" id="5581759">cr</span><span class="op" id="5581761">[</span><span class="num" id="5581762">3</span><span class="op" id="5581763">]</span><span class="op" id="5581764">[</span><span class="num" id="5581765">1</span><span class="op" id="5581766">:</span><span class="op" id="5581767">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581770">cdat4</span>&nbsp;<span class="op" id="5581776">:=</span>&nbsp;<span class="ident" id="5581779">cr</span><span class="op" id="5581781">[</span><span class="num" id="5581782">4</span><span class="op" id="5581783">]</span><span class="op" id="5581784">[</span><span class="num" id="5581785">1</span><span class="op" id="5581786">:</span><span class="op" id="5581787">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581790">pdat</span>&nbsp;<span class="op" id="5581795">:=</span>&nbsp;<span class="ident" id="5581798">pr</span><span class="op" id="5581800">[</span><span class="num" id="5581801">1</span><span class="op" id="5581802">:</span><span class="op" id="5581803">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581806">n</span>&nbsp;<span class="op" id="5581808">:=</span>&nbsp;<span class="builtinfunc" id="5581811">len</span><span class="op" id="5581814">(</span><span class="ident" id="5581815">cdat0</span><span class="op" id="5581820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581824">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581843">sum</span>&nbsp;<span class="op" id="5581847">:=</span>&nbsp;<span class="num" id="5581850">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581853">for</span>&nbsp;<span class="ident" id="5581857">i</span>&nbsp;<span class="op" id="5581859">:=</span>&nbsp;<span class="num" id="5581862">0</span><span class="op" id="5581863">;</span>&nbsp;<span class="ident" id="5581865">i</span>&nbsp;<span class="op" id="5581867">&lt;</span>&nbsp;<span class="ident" id="5581869">n</span><span class="op" id="5581870">;</span>&nbsp;<span class="ident" id="5581872">i</span><span class="op" id="5581873">++</span>&nbsp;<span class="op" id="5581876">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581880">cdat2</span><span class="op" id="5581885">[</span><span class="ident" id="5581886">i</span><span class="op" id="5581887">]</span>&nbsp;<span class="op" id="5581889">=</span>&nbsp;<span class="ident" id="5581891">cdat0</span><span class="op" id="5581896">[</span><span class="ident" id="5581897">i</span><span class="op" id="5581898">]</span>&nbsp;<span class="op" id="5581900">-</span>&nbsp;<span class="ident" id="5581902">pdat</span><span class="op" id="5581906">[</span><span class="ident" id="5581907">i</span><span class="op" id="5581908">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581912">sum</span>&nbsp;<span class="op" id="5581916">+=</span>&nbsp;<span class="ident" id="5581919">abs8</span><span class="op" id="5581923">(</span><span class="ident" id="5581924">cdat2</span><span class="op" id="5581929">[</span><span class="ident" id="5581930">i</span><span class="op" id="5581931">]</span><span class="op" id="5581932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581938">best</span>&nbsp;<span class="op" id="5581943">:=</span>&nbsp;<span class="ident" id="5581946">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581951">filter</span>&nbsp;<span class="op" id="5581958">:=</span>&nbsp;<span class="ident" id="5581961">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581968">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581990">sum</span>&nbsp;<span class="op" id="5581994">=</span>&nbsp;<span class="num" id="5581996">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581999">for</span>&nbsp;<span class="ident" id="5582003">i</span>&nbsp;<span class="op" id="5582005">:=</span>&nbsp;<span class="num" id="5582008">0</span><span class="op" id="5582009">;</span>&nbsp;<span class="ident" id="5582011">i</span>&nbsp;<span class="op" id="5582013">&lt;</span>&nbsp;<span class="ident" id="5582015">bpp</span><span class="op" id="5582018">;</span>&nbsp;<span class="ident" id="5582020">i</span><span class="op" id="5582021">++</span>&nbsp;<span class="op" id="5582024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582028">cdat4</span><span class="op" id="5582033">[</span><span class="ident" id="5582034">i</span><span class="op" id="5582035">]</span>&nbsp;<span class="op" id="5582037">=</span>&nbsp;<span class="ident" id="5582039">cdat0</span><span class="op" id="5582044">[</span><span class="ident" id="5582045">i</span><span class="op" id="5582046">]</span>&nbsp;<span class="op" id="5582048">-</span>&nbsp;<span class="ident" id="5582050">pdat</span><span class="op" id="5582054">[</span><span class="ident" id="5582055">i</span><span class="op" id="5582056">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582060">sum</span>&nbsp;<span class="op" id="5582064">+=</span>&nbsp;<span class="ident" id="5582067">abs8</span><span class="op" id="5582071">(</span><span class="ident" id="5582072">cdat4</span><span class="op" id="5582077">[</span><span class="ident" id="5582078">i</span><span class="op" id="5582079">]</span><span class="op" id="5582080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582086">for</span>&nbsp;<span class="ident" id="5582090">i</span>&nbsp;<span class="op" id="5582092">:=</span>&nbsp;<span class="ident" id="5582095">bpp</span><span class="op" id="5582098">;</span>&nbsp;<span class="ident" id="5582100">i</span>&nbsp;<span class="op" id="5582102">&lt;</span>&nbsp;<span class="ident" id="5582104">n</span><span class="op" id="5582105">;</span>&nbsp;<span class="ident" id="5582107">i</span><span class="op" id="5582108">++</span>&nbsp;<span class="op" id="5582111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582115">cdat4</span><span class="op" id="5582120">[</span><span class="ident" id="5582121">i</span><span class="op" id="5582122">]</span>&nbsp;<span class="op" id="5582124">=</span>&nbsp;<span class="ident" id="5582126">cdat0</span><span class="op" id="5582131">[</span><span class="ident" id="5582132">i</span><span class="op" id="5582133">]</span>&nbsp;<span class="op" id="5582135">-</span>&nbsp;<span class="ident" id="5582137">paeth</span><span class="op" id="5582142">(</span><span class="ident" id="5582143">cdat0</span><span class="op" id="5582148">[</span><span class="ident" id="5582149">i</span><span class="op" id="5582150">-</span><span class="ident" id="5582151">bpp</span><span class="op" id="5582154">]</span><span class="op" id="5582155">,</span>&nbsp;<span class="ident" id="5582157">pdat</span><span class="op" id="5582161">[</span><span class="ident" id="5582162">i</span><span class="op" id="5582163">]</span><span class="op" id="5582164">,</span>&nbsp;<span class="ident" id="5582166">pdat</span><span class="op" id="5582170">[</span><span class="ident" id="5582171">i</span><span class="op" id="5582172">-</span><span class="ident" id="5582173">bpp</span><span class="op" id="5582176">]</span><span class="op" id="5582177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582181">sum</span>&nbsp;<span class="op" id="5582185">+=</span>&nbsp;<span class="ident" id="5582188">abs8</span><span class="op" id="5582192">(</span><span class="ident" id="5582193">cdat4</span><span class="op" id="5582198">[</span><span class="ident" id="5582199">i</span><span class="op" id="5582200">]</span><span class="op" id="5582201">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582205">if</span>&nbsp;<span class="ident" id="5582208">sum</span>&nbsp;<span class="op" id="5582212">&gt;=</span>&nbsp;<span class="ident" id="5582215">best</span>&nbsp;<span class="op" id="5582220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582225">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582239">if</span>&nbsp;<span class="ident" id="5582242">sum</span>&nbsp;<span class="op" id="5582246">&lt;</span>&nbsp;<span class="ident" id="5582248">best</span>&nbsp;<span class="op" id="5582253">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582257">best</span>&nbsp;<span class="op" id="5582262">=</span>&nbsp;<span class="ident" id="5582264">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582270">filter</span>&nbsp;<span class="op" id="5582277">=</span>&nbsp;<span class="ident" id="5582279">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582292">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582313">sum</span>&nbsp;<span class="op" id="5582317">=</span>&nbsp;<span class="num" id="5582319">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582322">for</span>&nbsp;<span class="ident" id="5582326">i</span>&nbsp;<span class="op" id="5582328">:=</span>&nbsp;<span class="num" id="5582331">0</span><span class="op" id="5582332">;</span>&nbsp;<span class="ident" id="5582334">i</span>&nbsp;<span class="op" id="5582336">&lt;</span>&nbsp;<span class="ident" id="5582338">n</span><span class="op" id="5582339">;</span>&nbsp;<span class="ident" id="5582341">i</span><span class="op" id="5582342">++</span>&nbsp;<span class="op" id="5582345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582349">sum</span>&nbsp;<span class="op" id="5582353">+=</span>&nbsp;<span class="ident" id="5582356">abs8</span><span class="op" id="5582360">(</span><span class="ident" id="5582361">cdat0</span><span class="op" id="5582366">[</span><span class="ident" id="5582367">i</span><span class="op" id="5582368">]</span><span class="op" id="5582369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582373">if</span>&nbsp;<span class="ident" id="5582376">sum</span>&nbsp;<span class="op" id="5582380">&gt;=</span>&nbsp;<span class="ident" id="5582383">best</span>&nbsp;<span class="op" id="5582388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582393">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582407">if</span>&nbsp;<span class="ident" id="5582410">sum</span>&nbsp;<span class="op" id="5582414">&lt;</span>&nbsp;<span class="ident" id="5582416">best</span>&nbsp;<span class="op" id="5582421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582425">best</span>&nbsp;<span class="op" id="5582430">=</span>&nbsp;<span class="ident" id="5582432">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582438">filter</span>&nbsp;<span class="op" id="5582445">=</span>&nbsp;<span class="ident" id="5582447">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582459">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582479">sum</span>&nbsp;<span class="op" id="5582483">=</span>&nbsp;<span class="num" id="5582485">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582488">for</span>&nbsp;<span class="ident" id="5582492">i</span>&nbsp;<span class="op" id="5582494">:=</span>&nbsp;<span class="num" id="5582497">0</span><span class="op" id="5582498">;</span>&nbsp;<span class="ident" id="5582500">i</span>&nbsp;<span class="op" id="5582502">&lt;</span>&nbsp;<span class="ident" id="5582504">bpp</span><span class="op" id="5582507">;</span>&nbsp;<span class="ident" id="5582509">i</span><span class="op" id="5582510">++</span>&nbsp;<span class="op" id="5582513">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582517">cdat1</span><span class="op" id="5582522">[</span><span class="ident" id="5582523">i</span><span class="op" id="5582524">]</span>&nbsp;<span class="op" id="5582526">=</span>&nbsp;<span class="ident" id="5582528">cdat0</span><span class="op" id="5582533">[</span><span class="ident" id="5582534">i</span><span class="op" id="5582535">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582539">sum</span>&nbsp;<span class="op" id="5582543">+=</span>&nbsp;<span class="ident" id="5582546">abs8</span><span class="op" id="5582550">(</span><span class="ident" id="5582551">cdat1</span><span class="op" id="5582556">[</span><span class="ident" id="5582557">i</span><span class="op" id="5582558">]</span><span class="op" id="5582559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582565">for</span>&nbsp;<span class="ident" id="5582569">i</span>&nbsp;<span class="op" id="5582571">:=</span>&nbsp;<span class="ident" id="5582574">bpp</span><span class="op" id="5582577">;</span>&nbsp;<span class="ident" id="5582579">i</span>&nbsp;<span class="op" id="5582581">&lt;</span>&nbsp;<span class="ident" id="5582583">n</span><span class="op" id="5582584">;</span>&nbsp;<span class="ident" id="5582586">i</span><span class="op" id="5582587">++</span>&nbsp;<span class="op" id="5582590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582594">cdat1</span><span class="op" id="5582599">[</span><span class="ident" id="5582600">i</span><span class="op" id="5582601">]</span>&nbsp;<span class="op" id="5582603">=</span>&nbsp;<span class="ident" id="5582605">cdat0</span><span class="op" id="5582610">[</span><span class="ident" id="5582611">i</span><span class="op" id="5582612">]</span>&nbsp;<span class="op" id="5582614">-</span>&nbsp;<span class="ident" id="5582616">cdat0</span><span class="op" id="5582621">[</span><span class="ident" id="5582622">i</span><span class="op" id="5582623">-</span><span class="ident" id="5582624">bpp</span><span class="op" id="5582627">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582631">sum</span>&nbsp;<span class="op" id="5582635">+=</span>&nbsp;<span class="ident" id="5582638">abs8</span><span class="op" id="5582642">(</span><span class="ident" id="5582643">cdat1</span><span class="op" id="5582648">[</span><span class="ident" id="5582649">i</span><span class="op" id="5582650">]</span><span class="op" id="5582651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582655">if</span>&nbsp;<span class="ident" id="5582658">sum</span>&nbsp;<span class="op" id="5582662">&gt;=</span>&nbsp;<span class="ident" id="5582665">best</span>&nbsp;<span class="op" id="5582670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582675">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582686">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582689">if</span>&nbsp;<span class="ident" id="5582692">sum</span>&nbsp;<span class="op" id="5582696">&lt;</span>&nbsp;<span class="ident" id="5582698">best</span>&nbsp;<span class="op" id="5582703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582707">best</span>&nbsp;<span class="op" id="5582712">=</span>&nbsp;<span class="ident" id="5582714">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582720">filter</span>&nbsp;<span class="op" id="5582727">=</span>&nbsp;<span class="ident" id="5582729">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582740">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582764">sum</span>&nbsp;<span class="op" id="5582768">=</span>&nbsp;<span class="num" id="5582770">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582773">for</span>&nbsp;<span class="ident" id="5582777">i</span>&nbsp;<span class="op" id="5582779">:=</span>&nbsp;<span class="num" id="5582782">0</span><span class="op" id="5582783">;</span>&nbsp;<span class="ident" id="5582785">i</span>&nbsp;<span class="op" id="5582787">&lt;</span>&nbsp;<span class="ident" id="5582789">bpp</span><span class="op" id="5582792">;</span>&nbsp;<span class="ident" id="5582794">i</span><span class="op" id="5582795">++</span>&nbsp;<span class="op" id="5582798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582802">cdat3</span><span class="op" id="5582807">[</span><span class="ident" id="5582808">i</span><span class="op" id="5582809">]</span>&nbsp;<span class="op" id="5582811">=</span>&nbsp;<span class="ident" id="5582813">cdat0</span><span class="op" id="5582818">[</span><span class="ident" id="5582819">i</span><span class="op" id="5582820">]</span>&nbsp;<span class="op" id="5582822">-</span>&nbsp;<span class="ident" id="5582824">pdat</span><span class="op" id="5582828">[</span><span class="ident" id="5582829">i</span><span class="op" id="5582830">]</span><span class="op" id="5582831">/</span><span class="num" id="5582832">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582836">sum</span>&nbsp;<span class="op" id="5582840">+=</span>&nbsp;<span class="ident" id="5582843">abs8</span><span class="op" id="5582847">(</span><span class="ident" id="5582848">cdat3</span><span class="op" id="5582853">[</span><span class="ident" id="5582854">i</span><span class="op" id="5582855">]</span><span class="op" id="5582856">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582862">for</span>&nbsp;<span class="ident" id="5582866">i</span>&nbsp;<span class="op" id="5582868">:=</span>&nbsp;<span class="ident" id="5582871">bpp</span><span class="op" id="5582874">;</span>&nbsp;<span class="ident" id="5582876">i</span>&nbsp;<span class="op" id="5582878">&lt;</span>&nbsp;<span class="ident" id="5582880">n</span><span class="op" id="5582881">;</span>&nbsp;<span class="ident" id="5582883">i</span><span class="op" id="5582884">++</span>&nbsp;<span class="op" id="5582887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582891">cdat3</span><span class="op" id="5582896">[</span><span class="ident" id="5582897">i</span><span class="op" id="5582898">]</span>&nbsp;<span class="op" id="5582900">=</span>&nbsp;<span class="ident" id="5582902">cdat0</span><span class="op" id="5582907">[</span><span class="ident" id="5582908">i</span><span class="op" id="5582909">]</span>&nbsp;<span class="op" id="5582911">-</span>&nbsp;<span class="builtintype" id="5582913">uint8</span><span class="op" id="5582918">(</span><span class="op" id="5582919">(</span><span class="builtintype" id="5582920">int</span><span class="op" id="5582923">(</span><span class="ident" id="5582924">cdat0</span><span class="op" id="5582929">[</span><span class="ident" id="5582930">i</span><span class="op" id="5582931">-</span><span class="ident" id="5582932">bpp</span><span class="op" id="5582935">]</span><span class="op" id="5582936">)</span><span class="op" id="5582937">+</span><span class="builtintype" id="5582938">int</span><span class="op" id="5582941">(</span><span class="ident" id="5582942">pdat</span><span class="op" id="5582946">[</span><span class="ident" id="5582947">i</span><span class="op" id="5582948">]</span><span class="op" id="5582949">)</span><span class="op" id="5582950">)</span><span class="op" id="5582951">/</span><span class="num" id="5582952">2</span><span class="op" id="5582953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582957">sum</span>&nbsp;<span class="op" id="5582961">+=</span>&nbsp;<span class="ident" id="5582964">abs8</span><span class="op" id="5582968">(</span><span class="ident" id="5582969">cdat3</span><span class="op" id="5582974">[</span><span class="ident" id="5582975">i</span><span class="op" id="5582976">]</span><span class="op" id="5582977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582981">if</span>&nbsp;<span class="ident" id="5582984">sum</span>&nbsp;<span class="op" id="5582988">&gt;=</span>&nbsp;<span class="ident" id="5582991">best</span>&nbsp;<span class="op" id="5582996">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583001">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583015">if</span>&nbsp;<span class="ident" id="5583018">sum</span>&nbsp;<span class="op" id="5583022">&lt;</span>&nbsp;<span class="ident" id="5583024">best</span>&nbsp;<span class="op" id="5583029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583033">best</span>&nbsp;<span class="op" id="5583038">=</span>&nbsp;<span class="ident" id="5583040">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583046">filter</span>&nbsp;<span class="op" id="5583053">=</span>&nbsp;<span class="ident" id="5583055">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583070">return</span>&nbsp;<span class="ident" id="5583077">filter</span><br>
<span class="lineno"></span><span class="op" id="5583084">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="5583087">func</span>&nbsp;<span class="ident" id="5583092">writeImage</span><span class="op" id="5583102">(</span><span class="ident" id="5583103">w</span>&nbsp;<span class="ident" id="5583105">io</span><span class="op" id="5583107">.</span><span class="ident" id="5583108">Writer</span><span class="op" id="5583114">,</span>&nbsp;<span class="ident" id="5583116">m</span>&nbsp;<span class="ident" id="5583118">image</span><span class="op" id="5583123">.</span><span class="ident" id="5583124">Image</span><span class="op" id="5583129">,</span>&nbsp;<span class="ident" id="5583131">cb</span>&nbsp;<span class="builtintype" id="5583134">int</span><span class="op" id="5583137">,</span>&nbsp;<span class="ident" id="5583139">level</span>&nbsp;<span class="builtintype" id="5583145">int</span><span class="op" id="5583148">)</span>&nbsp;<span class="builtintype" id="5583150">error</span>&nbsp;<span class="op" id="5583156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583159">zw</span><span class="op" id="5583161">,</span>&nbsp;<span class="ident" id="5583163">err</span>&nbsp;<span class="op" id="5583167">:=</span>&nbsp;<span class="ident" id="5583170">zlib</span><span class="op" id="5583174">.</span><span class="ident" id="5583175">NewWriterLevel</span><span class="op" id="5583189">(</span><span class="ident" id="5583190">w</span><span class="op" id="5583191">,</span>&nbsp;<span class="ident" id="5583193">level</span><span class="op" id="5583198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583201">if</span>&nbsp;<span class="ident" id="5583204">err</span>&nbsp;<span class="op" id="5583208">!=</span>&nbsp;<span class="ident" id="5583211">nil</span>&nbsp;<span class="op" id="5583215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583219">return</span>&nbsp;<span class="ident" id="5583226">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583234">defer</span>&nbsp;<span class="ident" id="5583240">zw</span><span class="op" id="5583242">.</span><span class="ident" id="5583243">Close</span><span class="op" id="5583248">(</span><span class="op" id="5583249">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583253">bpp</span>&nbsp;<span class="op" id="5583257">:=</span>&nbsp;<span class="num" id="5583260">0</span>&nbsp;<span class="comment" id="5583262">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583284">switch</span>&nbsp;<span class="ident" id="5583291">cb</span>&nbsp;<span class="op" id="5583294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583297">case</span>&nbsp;<span class="ident" id="5583302">cbG8</span><span class="op" id="5583306">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583310">bpp</span>&nbsp;<span class="op" id="5583314">=</span>&nbsp;<span class="num" id="5583316">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583319">case</span>&nbsp;<span class="ident" id="5583324">cbTC8</span><span class="op" id="5583329">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583333">bpp</span>&nbsp;<span class="op" id="5583337">=</span>&nbsp;<span class="num" id="5583339">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583342">case</span>&nbsp;<span class="ident" id="5583347">cbP8</span><span class="op" id="5583351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583355">bpp</span>&nbsp;<span class="op" id="5583359">=</span>&nbsp;<span class="num" id="5583361">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583364">case</span>&nbsp;<span class="ident" id="5583369">cbTCA8</span><span class="op" id="5583375">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583379">bpp</span>&nbsp;<span class="op" id="5583383">=</span>&nbsp;<span class="num" id="5583385">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583388">case</span>&nbsp;<span class="ident" id="5583393">cbTC16</span><span class="op" id="5583399">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583403">bpp</span>&nbsp;<span class="op" id="5583407">=</span>&nbsp;<span class="num" id="5583409">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583412">case</span>&nbsp;<span class="ident" id="5583417">cbTCA16</span><span class="op" id="5583424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583428">bpp</span>&nbsp;<span class="op" id="5583432">=</span>&nbsp;<span class="num" id="5583434">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583437">case</span>&nbsp;<span class="ident" id="5583442">cbG16</span><span class="op" id="5583447">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583451">bpp</span>&nbsp;<span class="op" id="5583455">=</span>&nbsp;<span class="num" id="5583457">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583463">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583528">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583604">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583691">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583778">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583843">b</span>&nbsp;<span class="op" id="5583845">:=</span>&nbsp;<span class="ident" id="5583848">m</span><span class="op" id="5583849">.</span><span class="ident" id="5583850">Bounds</span><span class="op" id="5583856">(</span><span class="op" id="5583857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583860">var</span>&nbsp;<span class="ident" id="5583864">cr</span>&nbsp;<span class="op" id="5583867">[</span><span class="ident" id="5583868">nFilter</span><span class="op" id="5583875">]</span><span class="op" id="5583876">[</span><span class="op" id="5583877">]</span><span class="builtintype" id="5583878">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583885">for</span>&nbsp;<span class="ident" id="5583889">i</span>&nbsp;<span class="op" id="5583891">:=</span>&nbsp;<span class="keyword" id="5583894">range</span>&nbsp;<span class="ident" id="5583900">cr</span>&nbsp;<span class="op" id="5583903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583907">cr</span><span class="op" id="5583909">[</span><span class="ident" id="5583910">i</span><span class="op" id="5583911">]</span>&nbsp;<span class="op" id="5583913">=</span>&nbsp;<span class="builtinfunc" id="5583915">make</span><span class="op" id="5583919">(</span><span class="op" id="5583920">[</span><span class="op" id="5583921">]</span><span class="builtintype" id="5583922">uint8</span><span class="op" id="5583927">,</span>&nbsp;<span class="num" id="5583929">1</span><span class="op" id="5583930">+</span><span class="ident" id="5583931">bpp</span><span class="op" id="5583934">*</span><span class="ident" id="5583935">b</span><span class="op" id="5583936">.</span><span class="ident" id="5583937">Dx</span><span class="op" id="5583939">(</span><span class="op" id="5583940">)</span><span class="op" id="5583941">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583945">cr</span><span class="op" id="5583947">[</span><span class="ident" id="5583948">i</span><span class="op" id="5583949">]</span><span class="op" id="5583950">[</span><span class="num" id="5583951">0</span><span class="op" id="5583952">]</span>&nbsp;<span class="op" id="5583954">=</span>&nbsp;<span class="builtintype" id="5583956">uint8</span><span class="op" id="5583961">(</span><span class="ident" id="5583962">i</span><span class="op" id="5583963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583969">pr</span>&nbsp;<span class="op" id="5583972">:=</span>&nbsp;<span class="builtinfunc" id="5583975">make</span><span class="op" id="5583979">(</span><span class="op" id="5583980">[</span><span class="op" id="5583981">]</span><span class="builtintype" id="5583982">uint8</span><span class="op" id="5583987">,</span>&nbsp;<span class="num" id="5583989">1</span><span class="op" id="5583990">+</span><span class="ident" id="5583991">bpp</span><span class="op" id="5583994">*</span><span class="ident" id="5583995">b</span><span class="op" id="5583996">.</span><span class="ident" id="5583997">Dx</span><span class="op" id="5583999">(</span><span class="op" id="5584000">)</span><span class="op" id="5584001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584005">gray</span><span class="op" id="5584009">,</span>&nbsp;<span class="ident" id="5584011">_</span>&nbsp;<span class="op" id="5584013">:=</span>&nbsp;<span class="ident" id="5584016">m</span><span class="op" id="5584017">.</span><span class="op" id="5584018">(</span><span class="op" id="5584019">*</span><span class="ident" id="5584020">image</span><span class="op" id="5584025">.</span><span class="ident" id="5584026">Gray</span><span class="op" id="5584030">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584033">rgba</span><span class="op" id="5584037">,</span>&nbsp;<span class="ident" id="5584039">_</span>&nbsp;<span class="op" id="5584041">:=</span>&nbsp;<span class="ident" id="5584044">m</span><span class="op" id="5584045">.</span><span class="op" id="5584046">(</span><span class="op" id="5584047">*</span><span class="ident" id="5584048">image</span><span class="op" id="5584053">.</span><span class="ident" id="5584054">RGBA</span><span class="op" id="5584058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584061">paletted</span><span class="op" id="5584069">,</span>&nbsp;<span class="ident" id="5584071">_</span>&nbsp;<span class="op" id="5584073">:=</span>&nbsp;<span class="ident" id="5584076">m</span><span class="op" id="5584077">.</span><span class="op" id="5584078">(</span><span class="op" id="5584079">*</span><span class="ident" id="5584080">image</span><span class="op" id="5584085">.</span><span class="ident" id="5584086">Paletted</span><span class="op" id="5584094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584097">nrgba</span><span class="op" id="5584102">,</span>&nbsp;<span class="ident" id="5584104">_</span>&nbsp;<span class="op" id="5584106">:=</span>&nbsp;<span class="ident" id="5584109">m</span><span class="op" id="5584110">.</span><span class="op" id="5584111">(</span><span class="op" id="5584112">*</span><span class="ident" id="5584113">image</span><span class="op" id="5584118">.</span><span class="ident" id="5584119">NRGBA</span><span class="op" id="5584124">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584128">for</span>&nbsp;<span class="ident" id="5584132">y</span>&nbsp;<span class="op" id="5584134">:=</span>&nbsp;<span class="ident" id="5584137">b</span><span class="op" id="5584138">.</span><span class="ident" id="5584139">Min</span><span class="op" id="5584142">.</span><span class="ident" id="5584143">Y</span><span class="op" id="5584144">;</span>&nbsp;<span class="ident" id="5584146">y</span>&nbsp;<span class="op" id="5584148">&lt;</span>&nbsp;<span class="ident" id="5584150">b</span><span class="op" id="5584151">.</span><span class="ident" id="5584152">Max</span><span class="op" id="5584155">.</span><span class="ident" id="5584156">Y</span><span class="op" id="5584157">;</span>&nbsp;<span class="ident" id="5584159">y</span><span class="op" id="5584160">++</span>&nbsp;<span class="op" id="5584163">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584167">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584202">i</span>&nbsp;<span class="op" id="5584204">:=</span>&nbsp;<span class="num" id="5584207">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584211">switch</span>&nbsp;<span class="ident" id="5584218">cb</span>&nbsp;<span class="op" id="5584221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584225">case</span>&nbsp;<span class="ident" id="5584230">cbG8</span><span class="op" id="5584234">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584239">if</span>&nbsp;<span class="ident" id="5584242">gray</span>&nbsp;<span class="op" id="5584247">!=</span>&nbsp;<span class="ident" id="5584250">nil</span>&nbsp;<span class="op" id="5584254">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584260">offset</span>&nbsp;<span class="op" id="5584267">:=</span>&nbsp;<span class="op" id="5584270">(</span><span class="ident" id="5584271">y</span>&nbsp;<span class="op" id="5584273">-</span>&nbsp;<span class="ident" id="5584275">b</span><span class="op" id="5584276">.</span><span class="ident" id="5584277">Min</span><span class="op" id="5584280">.</span><span class="ident" id="5584281">Y</span><span class="op" id="5584282">)</span>&nbsp;<span class="op" id="5584284">*</span>&nbsp;<span class="ident" id="5584286">gray</span><span class="op" id="5584290">.</span><span class="ident" id="5584291">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5584302">copy</span><span class="op" id="5584306">(</span><span class="ident" id="5584307">cr</span><span class="op" id="5584309">[</span><span class="num" id="5584310">0</span><span class="op" id="5584311">]</span><span class="op" id="5584312">[</span><span class="num" id="5584313">1</span><span class="op" id="5584314">:</span><span class="op" id="5584315">]</span><span class="op" id="5584316">,</span>&nbsp;<span class="ident" id="5584318">gray</span><span class="op" id="5584322">.</span><span class="ident" id="5584323">Pix</span><span class="op" id="5584326">[</span><span class="ident" id="5584327">offset</span><span class="op" id="5584333">:</span><span class="ident" id="5584334">offset</span><span class="op" id="5584340">+</span><span class="ident" id="5584341">b</span><span class="op" id="5584342">.</span><span class="ident" id="5584343">Dx</span><span class="op" id="5584345">(</span><span class="op" id="5584346">)</span><span class="op" id="5584347">]</span><span class="op" id="5584348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584353">}</span>&nbsp;<span class="keyword" id="5584355">else</span>&nbsp;<span class="op" id="5584360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584366">for</span>&nbsp;<span class="ident" id="5584370">x</span>&nbsp;<span class="op" id="5584372">:=</span>&nbsp;<span class="ident" id="5584375">b</span><span class="op" id="5584376">.</span><span class="ident" id="5584377">Min</span><span class="op" id="5584380">.</span><span class="ident" id="5584381">X</span><span class="op" id="5584382">;</span>&nbsp;<span class="ident" id="5584384">x</span>&nbsp;<span class="op" id="5584386">&lt;</span>&nbsp;<span class="ident" id="5584388">b</span><span class="op" id="5584389">.</span><span class="ident" id="5584390">Max</span><span class="op" id="5584393">.</span><span class="ident" id="5584394">X</span><span class="op" id="5584395">;</span>&nbsp;<span class="ident" id="5584397">x</span><span class="op" id="5584398">++</span>&nbsp;<span class="op" id="5584401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584408">c</span>&nbsp;<span class="op" id="5584410">:=</span>&nbsp;<span class="ident" id="5584413">color</span><span class="op" id="5584418">.</span><span class="ident" id="5584419">GrayModel</span><span class="op" id="5584428">.</span><span class="ident" id="5584429">Convert</span><span class="op" id="5584436">(</span><span class="ident" id="5584437">m</span><span class="op" id="5584438">.</span><span class="ident" id="5584439">At</span><span class="op" id="5584441">(</span><span class="ident" id="5584442">x</span><span class="op" id="5584443">,</span>&nbsp;<span class="ident" id="5584445">y</span><span class="op" id="5584446">)</span><span class="op" id="5584447">)</span><span class="op" id="5584448">.</span><span class="op" id="5584449">(</span><span class="ident" id="5584450">color</span><span class="op" id="5584455">.</span><span class="ident" id="5584456">Gray</span><span class="op" id="5584460">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584467">cr</span><span class="op" id="5584469">[</span><span class="num" id="5584470">0</span><span class="op" id="5584471">]</span><span class="op" id="5584472">[</span><span class="ident" id="5584473">i</span><span class="op" id="5584474">]</span>&nbsp;<span class="op" id="5584476">=</span>&nbsp;<span class="ident" id="5584478">c</span><span class="op" id="5584479">.</span><span class="ident" id="5584480">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584487">i</span><span class="op" id="5584488">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584504">case</span>&nbsp;<span class="ident" id="5584509">cbTC8</span><span class="op" id="5584514">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584519">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584591">cr0</span>&nbsp;<span class="op" id="5584595">:=</span>&nbsp;<span class="ident" id="5584598">cr</span><span class="op" id="5584600">[</span><span class="num" id="5584601">0</span><span class="op" id="5584602">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584607">stride</span><span class="op" id="5584613">,</span>&nbsp;<span class="ident" id="5584615">pix</span>&nbsp;<span class="op" id="5584619">:=</span>&nbsp;<span class="num" id="5584622">0</span><span class="op" id="5584623">,</span>&nbsp;<span class="op" id="5584625">[</span><span class="op" id="5584626">]</span><span class="builtintype" id="5584627">byte</span><span class="op" id="5584631">(</span><span class="ident" id="5584632">nil</span><span class="op" id="5584635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584640">if</span>&nbsp;<span class="ident" id="5584643">rgba</span>&nbsp;<span class="op" id="5584648">!=</span>&nbsp;<span class="ident" id="5584651">nil</span>&nbsp;<span class="op" id="5584655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584661">stride</span><span class="op" id="5584667">,</span>&nbsp;<span class="ident" id="5584669">pix</span>&nbsp;<span class="op" id="5584673">=</span>&nbsp;<span class="ident" id="5584675">rgba</span><span class="op" id="5584679">.</span><span class="ident" id="5584680">Stride</span><span class="op" id="5584686">,</span>&nbsp;<span class="ident" id="5584688">rgba</span><span class="op" id="5584692">.</span><span class="ident" id="5584693">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584700">}</span>&nbsp;<span class="keyword" id="5584702">else</span>&nbsp;<span class="keyword" id="5584707">if</span>&nbsp;<span class="ident" id="5584710">nrgba</span>&nbsp;<span class="op" id="5584716">!=</span>&nbsp;<span class="ident" id="5584719">nil</span>&nbsp;<span class="op" id="5584723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584729">stride</span><span class="op" id="5584735">,</span>&nbsp;<span class="ident" id="5584737">pix</span>&nbsp;<span class="op" id="5584741">=</span>&nbsp;<span class="ident" id="5584743">nrgba</span><span class="op" id="5584748">.</span><span class="ident" id="5584749">Stride</span><span class="op" id="5584755">,</span>&nbsp;<span class="ident" id="5584757">nrgba</span><span class="op" id="5584762">.</span><span class="ident" id="5584763">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584775">if</span>&nbsp;<span class="ident" id="5584778">stride</span>&nbsp;<span class="op" id="5584785">!=</span>&nbsp;<span class="num" id="5584788">0</span>&nbsp;<span class="op" id="5584790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584796">j0</span>&nbsp;<span class="op" id="5584799">:=</span>&nbsp;<span class="op" id="5584802">(</span><span class="ident" id="5584803">y</span>&nbsp;<span class="op" id="5584805">-</span>&nbsp;<span class="ident" id="5584807">b</span><span class="op" id="5584808">.</span><span class="ident" id="5584809">Min</span><span class="op" id="5584812">.</span><span class="ident" id="5584813">Y</span><span class="op" id="5584814">)</span>&nbsp;<span class="op" id="5584816">*</span>&nbsp;<span class="ident" id="5584818">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584829">j1</span>&nbsp;<span class="op" id="5584832">:=</span>&nbsp;<span class="ident" id="5584835">j0</span>&nbsp;<span class="op" id="5584838">+</span>&nbsp;<span class="ident" id="5584840">b</span><span class="op" id="5584841">.</span><span class="ident" id="5584842">Dx</span><span class="op" id="5584844">(</span><span class="op" id="5584845">)</span><span class="op" id="5584846">*</span><span class="num" id="5584847">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584853">for</span>&nbsp;<span class="ident" id="5584857">j</span>&nbsp;<span class="op" id="5584859">:=</span>&nbsp;<span class="ident" id="5584862">j0</span><span class="op" id="5584864">;</span>&nbsp;<span class="ident" id="5584866">j</span>&nbsp;<span class="op" id="5584868">&lt;</span>&nbsp;<span class="ident" id="5584870">j1</span><span class="op" id="5584872">;</span>&nbsp;<span class="ident" id="5584874">j</span>&nbsp;<span class="op" id="5584876">+=</span>&nbsp;<span class="num" id="5584879">4</span>&nbsp;<span class="op" id="5584881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584888">cr0</span><span class="op" id="5584891">[</span><span class="ident" id="5584892">i</span><span class="op" id="5584893">+</span><span class="num" id="5584894">0</span><span class="op" id="5584895">]</span>&nbsp;<span class="op" id="5584897">=</span>&nbsp;<span class="ident" id="5584899">pix</span><span class="op" id="5584902">[</span><span class="ident" id="5584903">j</span><span class="op" id="5584904">+</span><span class="num" id="5584905">0</span><span class="op" id="5584906">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584913">cr0</span><span class="op" id="5584916">[</span><span class="ident" id="5584917">i</span><span class="op" id="5584918">+</span><span class="num" id="5584919">1</span><span class="op" id="5584920">]</span>&nbsp;<span class="op" id="5584922">=</span>&nbsp;<span class="ident" id="5584924">pix</span><span class="op" id="5584927">[</span><span class="ident" id="5584928">j</span><span class="op" id="5584929">+</span><span class="num" id="5584930">1</span><span class="op" id="5584931">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584938">cr0</span><span class="op" id="5584941">[</span><span class="ident" id="5584942">i</span><span class="op" id="5584943">+</span><span class="num" id="5584944">2</span><span class="op" id="5584945">]</span>&nbsp;<span class="op" id="5584947">=</span>&nbsp;<span class="ident" id="5584949">pix</span><span class="op" id="5584952">[</span><span class="ident" id="5584953">j</span><span class="op" id="5584954">+</span><span class="num" id="5584955">2</span><span class="op" id="5584956">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584963">i</span>&nbsp;<span class="op" id="5584965">+=</span>&nbsp;<span class="num" id="5584968">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584979">}</span>&nbsp;<span class="keyword" id="5584981">else</span>&nbsp;<span class="op" id="5584986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584992">for</span>&nbsp;<span class="ident" id="5584996">x</span>&nbsp;<span class="op" id="5584998">:=</span>&nbsp;<span class="ident" id="5585001">b</span><span class="op" id="5585002">.</span><span class="ident" id="5585003">Min</span><span class="op" id="5585006">.</span><span class="ident" id="5585007">X</span><span class="op" id="5585008">;</span>&nbsp;<span class="ident" id="5585010">x</span>&nbsp;<span class="op" id="5585012">&lt;</span>&nbsp;<span class="ident" id="5585014">b</span><span class="op" id="5585015">.</span><span class="ident" id="5585016">Max</span><span class="op" id="5585019">.</span><span class="ident" id="5585020">X</span><span class="op" id="5585021">;</span>&nbsp;<span class="ident" id="5585023">x</span><span class="op" id="5585024">++</span>&nbsp;<span class="op" id="5585027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585034">r</span><span class="op" id="5585035">,</span>&nbsp;<span class="ident" id="5585037">g</span><span class="op" id="5585038">,</span>&nbsp;<span class="ident" id="5585040">b</span><span class="op" id="5585041">,</span>&nbsp;<span class="ident" id="5585043">_</span>&nbsp;<span class="op" id="5585045">:=</span>&nbsp;<span class="ident" id="5585048">m</span><span class="op" id="5585049">.</span><span class="ident" id="5585050">At</span><span class="op" id="5585052">(</span><span class="ident" id="5585053">x</span><span class="op" id="5585054">,</span>&nbsp;<span class="ident" id="5585056">y</span><span class="op" id="5585057">)</span><span class="op" id="5585058">.</span><span class="ident" id="5585059">RGBA</span><span class="op" id="5585063">(</span><span class="op" id="5585064">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585071">cr0</span><span class="op" id="5585074">[</span><span class="ident" id="5585075">i</span><span class="op" id="5585076">+</span><span class="num" id="5585077">0</span><span class="op" id="5585078">]</span>&nbsp;<span class="op" id="5585080">=</span>&nbsp;<span class="builtintype" id="5585082">uint8</span><span class="op" id="5585087">(</span><span class="ident" id="5585088">r</span>&nbsp;<span class="op" id="5585090">&gt;&gt;</span>&nbsp;<span class="num" id="5585093">8</span><span class="op" id="5585094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585101">cr0</span><span class="op" id="5585104">[</span><span class="ident" id="5585105">i</span><span class="op" id="5585106">+</span><span class="num" id="5585107">1</span><span class="op" id="5585108">]</span>&nbsp;<span class="op" id="5585110">=</span>&nbsp;<span class="builtintype" id="5585112">uint8</span><span class="op" id="5585117">(</span><span class="ident" id="5585118">g</span>&nbsp;<span class="op" id="5585120">&gt;&gt;</span>&nbsp;<span class="num" id="5585123">8</span><span class="op" id="5585124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585131">cr0</span><span class="op" id="5585134">[</span><span class="ident" id="5585135">i</span><span class="op" id="5585136">+</span><span class="num" id="5585137">2</span><span class="op" id="5585138">]</span>&nbsp;<span class="op" id="5585140">=</span>&nbsp;<span class="builtintype" id="5585142">uint8</span><span class="op" id="5585147">(</span><span class="ident" id="5585148">b</span>&nbsp;<span class="op" id="5585150">&gt;&gt;</span>&nbsp;<span class="num" id="5585153">8</span><span class="op" id="5585154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585161">i</span>&nbsp;<span class="op" id="5585163">+=</span>&nbsp;<span class="num" id="5585166">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585172">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585181">case</span>&nbsp;<span class="ident" id="5585186">cbP8</span><span class="op" id="5585190">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585195">if</span>&nbsp;<span class="ident" id="5585198">paletted</span>&nbsp;<span class="op" id="5585207">!=</span>&nbsp;<span class="ident" id="5585210">nil</span>&nbsp;<span class="op" id="5585214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585220">offset</span>&nbsp;<span class="op" id="5585227">:=</span>&nbsp;<span class="op" id="5585230">(</span><span class="ident" id="5585231">y</span>&nbsp;<span class="op" id="5585233">-</span>&nbsp;<span class="ident" id="5585235">b</span><span class="op" id="5585236">.</span><span class="ident" id="5585237">Min</span><span class="op" id="5585240">.</span><span class="ident" id="5585241">Y</span><span class="op" id="5585242">)</span>&nbsp;<span class="op" id="5585244">*</span>&nbsp;<span class="ident" id="5585246">paletted</span><span class="op" id="5585254">.</span><span class="ident" id="5585255">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5585266">copy</span><span class="op" id="5585270">(</span><span class="ident" id="5585271">cr</span><span class="op" id="5585273">[</span><span class="num" id="5585274">0</span><span class="op" id="5585275">]</span><span class="op" id="5585276">[</span><span class="num" id="5585277">1</span><span class="op" id="5585278">:</span><span class="op" id="5585279">]</span><span class="op" id="5585280">,</span>&nbsp;<span class="ident" id="5585282">paletted</span><span class="op" id="5585290">.</span><span class="ident" id="5585291">Pix</span><span class="op" id="5585294">[</span><span class="ident" id="5585295">offset</span><span class="op" id="5585301">:</span><span class="ident" id="5585302">offset</span><span class="op" id="5585308">+</span><span class="ident" id="5585309">b</span><span class="op" id="5585310">.</span><span class="ident" id="5585311">Dx</span><span class="op" id="5585313">(</span><span class="op" id="5585314">)</span><span class="op" id="5585315">]</span><span class="op" id="5585316">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585321">}</span>&nbsp;<span class="keyword" id="5585323">else</span>&nbsp;<span class="op" id="5585328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585334">pi</span>&nbsp;<span class="op" id="5585337">:=</span>&nbsp;<span class="ident" id="5585340">m</span><span class="op" id="5585341">.</span><span class="op" id="5585342">(</span><span class="ident" id="5585343">image</span><span class="op" id="5585348">.</span><span class="ident" id="5585349">PalettedImage</span><span class="op" id="5585362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585368">for</span>&nbsp;<span class="ident" id="5585372">x</span>&nbsp;<span class="op" id="5585374">:=</span>&nbsp;<span class="ident" id="5585377">b</span><span class="op" id="5585378">.</span><span class="ident" id="5585379">Min</span><span class="op" id="5585382">.</span><span class="ident" id="5585383">X</span><span class="op" id="5585384">;</span>&nbsp;<span class="ident" id="5585386">x</span>&nbsp;<span class="op" id="5585388">&lt;</span>&nbsp;<span class="ident" id="5585390">b</span><span class="op" id="5585391">.</span><span class="ident" id="5585392">Max</span><span class="op" id="5585395">.</span><span class="ident" id="5585396">X</span><span class="op" id="5585397">;</span>&nbsp;<span class="ident" id="5585399">x</span><span class="op" id="5585400">++</span>&nbsp;<span class="op" id="5585403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585410">cr</span><span class="op" id="5585412">[</span><span class="num" id="5585413">0</span><span class="op" id="5585414">]</span><span class="op" id="5585415">[</span><span class="ident" id="5585416">i</span><span class="op" id="5585417">]</span>&nbsp;<span class="op" id="5585419">=</span>&nbsp;<span class="ident" id="5585421">pi</span><span class="op" id="5585423">.</span><span class="ident" id="5585424">ColorIndexAt</span><span class="op" id="5585436">(</span><span class="ident" id="5585437">x</span><span class="op" id="5585438">,</span>&nbsp;<span class="ident" id="5585440">y</span><span class="op" id="5585441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585448">i</span>&nbsp;<span class="op" id="5585450">+=</span>&nbsp;<span class="num" id="5585453">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585468">case</span>&nbsp;<span class="ident" id="5585473">cbTCA8</span><span class="op" id="5585479">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585484">if</span>&nbsp;<span class="ident" id="5585487">nrgba</span>&nbsp;<span class="op" id="5585493">!=</span>&nbsp;<span class="ident" id="5585496">nil</span>&nbsp;<span class="op" id="5585500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585506">offset</span>&nbsp;<span class="op" id="5585513">:=</span>&nbsp;<span class="op" id="5585516">(</span><span class="ident" id="5585517">y</span>&nbsp;<span class="op" id="5585519">-</span>&nbsp;<span class="ident" id="5585521">b</span><span class="op" id="5585522">.</span><span class="ident" id="5585523">Min</span><span class="op" id="5585526">.</span><span class="ident" id="5585527">Y</span><span class="op" id="5585528">)</span>&nbsp;<span class="op" id="5585530">*</span>&nbsp;<span class="ident" id="5585532">nrgba</span><span class="op" id="5585537">.</span><span class="ident" id="5585538">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5585549">copy</span><span class="op" id="5585553">(</span><span class="ident" id="5585554">cr</span><span class="op" id="5585556">[</span><span class="num" id="5585557">0</span><span class="op" id="5585558">]</span><span class="op" id="5585559">[</span><span class="num" id="5585560">1</span><span class="op" id="5585561">:</span><span class="op" id="5585562">]</span><span class="op" id="5585563">,</span>&nbsp;<span class="ident" id="5585565">nrgba</span><span class="op" id="5585570">.</span><span class="ident" id="5585571">Pix</span><span class="op" id="5585574">[</span><span class="ident" id="5585575">offset</span><span class="op" id="5585581">:</span><span class="ident" id="5585582">offset</span><span class="op" id="5585588">+</span><span class="ident" id="5585589">b</span><span class="op" id="5585590">.</span><span class="ident" id="5585591">Dx</span><span class="op" id="5585593">(</span><span class="op" id="5585594">)</span><span class="op" id="5585595">*</span><span class="num" id="5585596">4</span><span class="op" id="5585597">]</span><span class="op" id="5585598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585603">}</span>&nbsp;<span class="keyword" id="5585605">else</span>&nbsp;<span class="op" id="5585610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5585616">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585713">for</span>&nbsp;<span class="ident" id="5585717">x</span>&nbsp;<span class="op" id="5585719">:=</span>&nbsp;<span class="ident" id="5585722">b</span><span class="op" id="5585723">.</span><span class="ident" id="5585724">Min</span><span class="op" id="5585727">.</span><span class="ident" id="5585728">X</span><span class="op" id="5585729">;</span>&nbsp;<span class="ident" id="5585731">x</span>&nbsp;<span class="op" id="5585733">&lt;</span>&nbsp;<span class="ident" id="5585735">b</span><span class="op" id="5585736">.</span><span class="ident" id="5585737">Max</span><span class="op" id="5585740">.</span><span class="ident" id="5585741">X</span><span class="op" id="5585742">;</span>&nbsp;<span class="ident" id="5585744">x</span><span class="op" id="5585745">++</span>&nbsp;<span class="op" id="5585748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585755">c</span>&nbsp;<span class="op" id="5585757">:=</span>&nbsp;<span class="ident" id="5585760">color</span><span class="op" id="5585765">.</span><span class="ident" id="5585766">NRGBAModel</span><span class="op" id="5585776">.</span><span class="ident" id="5585777">Convert</span><span class="op" id="5585784">(</span><span class="ident" id="5585785">m</span><span class="op" id="5585786">.</span><span class="ident" id="5585787">At</span><span class="op" id="5585789">(</span><span class="ident" id="5585790">x</span><span class="op" id="5585791">,</span>&nbsp;<span class="ident" id="5585793">y</span><span class="op" id="5585794">)</span><span class="op" id="5585795">)</span><span class="op" id="5585796">.</span><span class="op" id="5585797">(</span><span class="ident" id="5585798">color</span><span class="op" id="5585803">.</span><span class="ident" id="5585804">NRGBA</span><span class="op" id="5585809">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585816">cr</span><span class="op" id="5585818">[</span><span class="num" id="5585819">0</span><span class="op" id="5585820">]</span><span class="op" id="5585821">[</span><span class="ident" id="5585822">i</span><span class="op" id="5585823">+</span><span class="num" id="5585824">0</span><span class="op" id="5585825">]</span>&nbsp;<span class="op" id="5585827">=</span>&nbsp;<span class="ident" id="5585829">c</span><span class="op" id="5585830">.</span><span class="ident" id="5585831">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585838">cr</span><span class="op" id="5585840">[</span><span class="num" id="5585841">0</span><span class="op" id="5585842">]</span><span class="op" id="5585843">[</span><span class="ident" id="5585844">i</span><span class="op" id="5585845">+</span><span class="num" id="5585846">1</span><span class="op" id="5585847">]</span>&nbsp;<span class="op" id="5585849">=</span>&nbsp;<span class="ident" id="5585851">c</span><span class="op" id="5585852">.</span><span class="ident" id="5585853">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585860">cr</span><span class="op" id="5585862">[</span><span class="num" id="5585863">0</span><span class="op" id="5585864">]</span><span class="op" id="5585865">[</span><span class="ident" id="5585866">i</span><span class="op" id="5585867">+</span><span class="num" id="5585868">2</span><span class="op" id="5585869">]</span>&nbsp;<span class="op" id="5585871">=</span>&nbsp;<span class="ident" id="5585873">c</span><span class="op" id="5585874">.</span><span class="ident" id="5585875">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585882">cr</span><span class="op" id="5585884">[</span><span class="num" id="5585885">0</span><span class="op" id="5585886">]</span><span class="op" id="5585887">[</span><span class="ident" id="5585888">i</span><span class="op" id="5585889">+</span><span class="num" id="5585890">3</span><span class="op" id="5585891">]</span>&nbsp;<span class="op" id="5585893">=</span>&nbsp;<span class="ident" id="5585895">c</span><span class="op" id="5585896">.</span><span class="ident" id="5585897">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585904">i</span>&nbsp;<span class="op" id="5585906">+=</span>&nbsp;<span class="num" id="5585909">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585924">case</span>&nbsp;<span class="ident" id="5585929">cbG16</span><span class="op" id="5585934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585939">for</span>&nbsp;<span class="ident" id="5585943">x</span>&nbsp;<span class="op" id="5585945">:=</span>&nbsp;<span class="ident" id="5585948">b</span><span class="op" id="5585949">.</span><span class="ident" id="5585950">Min</span><span class="op" id="5585953">.</span><span class="ident" id="5585954">X</span><span class="op" id="5585955">;</span>&nbsp;<span class="ident" id="5585957">x</span>&nbsp;<span class="op" id="5585959">&lt;</span>&nbsp;<span class="ident" id="5585961">b</span><span class="op" id="5585962">.</span><span class="ident" id="5585963">Max</span><span class="op" id="5585966">.</span><span class="ident" id="5585967">X</span><span class="op" id="5585968">;</span>&nbsp;<span class="ident" id="5585970">x</span><span class="op" id="5585971">++</span>&nbsp;<span class="op" id="5585974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585980">c</span>&nbsp;<span class="op" id="5585982">:=</span>&nbsp;<span class="ident" id="5585985">color</span><span class="op" id="5585990">.</span><span class="ident" id="5585991">Gray16Model</span><span class="op" id="5586002">.</span><span class="ident" id="5586003">Convert</span><span class="op" id="5586010">(</span><span class="ident" id="5586011">m</span><span class="op" id="5586012">.</span><span class="ident" id="5586013">At</span><span class="op" id="5586015">(</span><span class="ident" id="5586016">x</span><span class="op" id="5586017">,</span>&nbsp;<span class="ident" id="5586019">y</span><span class="op" id="5586020">)</span><span class="op" id="5586021">)</span><span class="op" id="5586022">.</span><span class="op" id="5586023">(</span><span class="ident" id="5586024">color</span><span class="op" id="5586029">.</span><span class="ident" id="5586030">Gray16</span><span class="op" id="5586036">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586042">cr</span><span class="op" id="5586044">[</span><span class="num" id="5586045">0</span><span class="op" id="5586046">]</span><span class="op" id="5586047">[</span><span class="ident" id="5586048">i</span><span class="op" id="5586049">+</span><span class="num" id="5586050">0</span><span class="op" id="5586051">]</span>&nbsp;<span class="op" id="5586053">=</span>&nbsp;<span class="builtintype" id="5586055">uint8</span><span class="op" id="5586060">(</span><span class="ident" id="5586061">c</span><span class="op" id="5586062">.</span><span class="ident" id="5586063">Y</span>&nbsp;<span class="op" id="5586065">&gt;&gt;</span>&nbsp;<span class="num" id="5586068">8</span><span class="op" id="5586069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586075">cr</span><span class="op" id="5586077">[</span><span class="num" id="5586078">0</span><span class="op" id="5586079">]</span><span class="op" id="5586080">[</span><span class="ident" id="5586081">i</span><span class="op" id="5586082">+</span><span class="num" id="5586083">1</span><span class="op" id="5586084">]</span>&nbsp;<span class="op" id="5586086">=</span>&nbsp;<span class="builtintype" id="5586088">uint8</span><span class="op" id="5586093">(</span><span class="ident" id="5586094">c</span><span class="op" id="5586095">.</span><span class="ident" id="5586096">Y</span><span class="op" id="5586097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586103">i</span>&nbsp;<span class="op" id="5586105">+=</span>&nbsp;<span class="num" id="5586108">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5586113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586117">case</span>&nbsp;<span class="ident" id="5586122">cbTC16</span><span class="op" id="5586128">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5586133">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586205">for</span>&nbsp;<span class="ident" id="5586209">x</span>&nbsp;<span class="op" id="5586211">:=</span>&nbsp;<span class="ident" id="5586214">b</span><span class="op" id="5586215">.</span><span class="ident" id="5586216">Min</span><span class="op" id="5586219">.</span><span class="ident" id="5586220">X</span><span class="op" id="5586221">;</span>&nbsp;<span class="ident" id="5586223">x</span>&nbsp;<span class="op" id="5586225">&lt;</span>&nbsp;<span class="ident" id="5586227">b</span><span class="op" id="5586228">.</span><span class="ident" id="5586229">Max</span><span class="op" id="5586232">.</span><span class="ident" id="5586233">X</span><span class="op" id="5586234">;</span>&nbsp;<span class="ident" id="5586236">x</span><span class="op" id="5586237">++</span>&nbsp;<span class="op" id="5586240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586246">r</span><span class="op" id="5586247">,</span>&nbsp;<span class="ident" id="5586249">g</span><span class="op" id="5586250">,</span>&nbsp;<span class="ident" id="5586252">b</span><span class="op" id="5586253">,</span>&nbsp;<span class="ident" id="5586255">_</span>&nbsp;<span class="op" id="5586257">:=</span>&nbsp;<span class="ident" id="5586260">m</span><span class="op" id="5586261">.</span><span class="ident" id="5586262">At</span><span class="op" id="5586264">(</span><span class="ident" id="5586265">x</span><span class="op" id="5586266">,</span>&nbsp;<span class="ident" id="5586268">y</span><span class="op" id="5586269">)</span><span class="op" id="5586270">.</span><span class="ident" id="5586271">RGBA</span><span class="op" id="5586275">(</span><span class="op" id="5586276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586282">cr</span><span class="op" id="5586284">[</span><span class="num" id="5586285">0</span><span class="op" id="5586286">]</span><span class="op" id="5586287">[</span><span class="ident" id="5586288">i</span><span class="op" id="5586289">+</span><span class="num" id="5586290">0</span><span class="op" id="5586291">]</span>&nbsp;<span class="op" id="5586293">=</span>&nbsp;<span class="builtintype" id="5586295">uint8</span><span class="op" id="5586300">(</span><span class="ident" id="5586301">r</span>&nbsp;<span class="op" id="5586303">&gt;&gt;</span>&nbsp;<span class="num" id="5586306">8</span><span class="op" id="5586307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586313">cr</span><span class="op" id="5586315">[</span><span class="num" id="5586316">0</span><span class="op" id="5586317">]</span><span class="op" id="5586318">[</span><span class="ident" id="5586319">i</span><span class="op" id="5586320">+</span><span class="num" id="5586321">1</span><span class="op" id="5586322">]</span>&nbsp;<span class="op" id="5586324">=</span>&nbsp;<span class="builtintype" id="5586326">uint8</span><span class="op" id="5586331">(</span><span class="ident" id="5586332">r</span><span class="op" id="5586333">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586339">cr</span><span class="op" id="5586341">[</span><span class="num" id="5586342">0</span><span class="op" id="5586343">]</span><span class="op" id="5586344">[</span><span class="ident" id="5586345">i</span><span class="op" id="5586346">+</span><span class="num" id="5586347">2</span><span class="op" id="5586348">]</span>&nbsp;<span class="op" id="5586350">=</span>&nbsp;<span class="builtintype" id="5586352">uint8</span><span class="op" id="5586357">(</span><span class="ident" id="5586358">g</span>&nbsp;<span class="op" id="5586360">&gt;&gt;</span>&nbsp;<span class="num" id="5586363">8</span><span class="op" id="5586364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586370">cr</span><span class="op" id="5586372">[</span><span class="num" id="5586373">0</span><span class="op" id="5586374">]</span><span class="op" id="5586375">[</span><span class="ident" id="5586376">i</span><span class="op" id="5586377">+</span><span class="num" id="5586378">3</span><span class="op" id="5586379">]</span>&nbsp;<span class="op" id="5586381">=</span>&nbsp;<span class="builtintype" id="5586383">uint8</span><span class="op" id="5586388">(</span><span class="ident" id="5586389">g</span><span class="op" id="5586390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586396">cr</span><span class="op" id="5586398">[</span><span class="num" id="5586399">0</span><span class="op" id="5586400">]</span><span class="op" id="5586401">[</span><span class="ident" id="5586402">i</span><span class="op" id="5586403">+</span><span class="num" id="5586404">4</span><span class="op" id="5586405">]</span>&nbsp;<span class="op" id="5586407">=</span>&nbsp;<span class="builtintype" id="5586409">uint8</span><span class="op" id="5586414">(</span><span class="ident" id="5586415">b</span>&nbsp;<span class="op" id="5586417">&gt;&gt;</span>&nbsp;<span class="num" id="5586420">8</span><span class="op" id="5586421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586427">cr</span><span class="op" id="5586429">[</span><span class="num" id="5586430">0</span><span class="op" id="5586431">]</span><span class="op" id="5586432">[</span><span class="ident" id="5586433">i</span><span class="op" id="5586434">+</span><span class="num" id="5586435">5</span><span class="op" id="5586436">]</span>&nbsp;<span class="op" id="5586438">=</span>&nbsp;<span class="builtintype" id="5586440">uint8</span><span class="op" id="5586445">(</span><span class="ident" id="5586446">b</span><span class="op" id="5586447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586453">i</span>&nbsp;<span class="op" id="5586455">+=</span>&nbsp;<span class="num" id="5586458">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5586463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586467">case</span>&nbsp;<span class="ident" id="5586472">cbTCA16</span><span class="op" id="5586479">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5586484">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586580">for</span>&nbsp;<span class="ident" id="5586584">x</span>&nbsp;<span class="op" id="5586586">:=</span>&nbsp;<span class="ident" id="5586589">b</span><span class="op" id="5586590">.</span><span class="ident" id="5586591">Min</span><span class="op" id="5586594">.</span><span class="ident" id="5586595">X</span><span class="op" id="5586596">;</span>&nbsp;<span class="ident" id="5586598">x</span>&nbsp;<span class="op" id="5586600">&lt;</span>&nbsp;<span class="ident" id="5586602">b</span><span class="op" id="5586603">.</span><span class="ident" id="5586604">Max</span><span class="op" id="5586607">.</span><span class="ident" id="5586608">X</span><span class="op" id="5586609">;</span>&nbsp;<span class="ident" id="5586611">x</span><span class="op" id="5586612">++</span>&nbsp;<span class="op" id="5586615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586621">c</span>&nbsp;<span class="op" id="5586623">:=</span>&nbsp;<span class="ident" id="5586626">color</span><span class="op" id="5586631">.</span><span class="ident" id="5586632">NRGBA64Model</span><span class="op" id="5586644">.</span><span class="ident" id="5586645">Convert</span><span class="op" id="5586652">(</span><span class="ident" id="5586653">m</span><span class="op" id="5586654">.</span><span class="ident" id="5586655">At</span><span class="op" id="5586657">(</span><span class="ident" id="5586658">x</span><span class="op" id="5586659">,</span>&nbsp;<span class="ident" id="5586661">y</span><span class="op" id="5586662">)</span><span class="op" id="5586663">)</span><span class="op" id="5586664">.</span><span class="op" id="5586665">(</span><span class="ident" id="5586666">color</span><span class="op" id="5586671">.</span><span class="ident" id="5586672">NRGBA64</span><span class="op" id="5586679">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586685">cr</span><span class="op" id="5586687">[</span><span class="num" id="5586688">0</span><span class="op" id="5586689">]</span><span class="op" id="5586690">[</span><span class="ident" id="5586691">i</span><span class="op" id="5586692">+</span><span class="num" id="5586693">0</span><span class="op" id="5586694">]</span>&nbsp;<span class="op" id="5586696">=</span>&nbsp;<span class="builtintype" id="5586698">uint8</span><span class="op" id="5586703">(</span><span class="ident" id="5586704">c</span><span class="op" id="5586705">.</span><span class="ident" id="5586706">R</span>&nbsp;<span class="op" id="5586708">&gt;&gt;</span>&nbsp;<span class="num" id="5586711">8</span><span class="op" id="5586712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586718">cr</span><span class="op" id="5586720">[</span><span class="num" id="5586721">0</span><span class="op" id="5586722">]</span><span class="op" id="5586723">[</span><span class="ident" id="5586724">i</span><span class="op" id="5586725">+</span><span class="num" id="5586726">1</span><span class="op" id="5586727">]</span>&nbsp;<span class="op" id="5586729">=</span>&nbsp;<span class="builtintype" id="5586731">uint8</span><span class="op" id="5586736">(</span><span class="ident" id="5586737">c</span><span class="op" id="5586738">.</span><span class="ident" id="5586739">R</span><span class="op" id="5586740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586746">cr</span><span class="op" id="5586748">[</span><span class="num" id="5586749">0</span><span class="op" id="5586750">]</span><span class="op" id="5586751">[</span><span class="ident" id="5586752">i</span><span class="op" id="5586753">+</span><span class="num" id="5586754">2</span><span class="op" id="5586755">]</span>&nbsp;<span class="op" id="5586757">=</span>&nbsp;<span class="builtintype" id="5586759">uint8</span><span class="op" id="5586764">(</span><span class="ident" id="5586765">c</span><span class="op" id="5586766">.</span><span class="ident" id="5586767">G</span>&nbsp;<span class="op" id="5586769">&gt;&gt;</span>&nbsp;<span class="num" id="5586772">8</span><span class="op" id="5586773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586779">cr</span><span class="op" id="5586781">[</span><span class="num" id="5586782">0</span><span class="op" id="5586783">]</span><span class="op" id="5586784">[</span><span class="ident" id="5586785">i</span><span class="op" id="5586786">+</span><span class="num" id="5586787">3</span><span class="op" id="5586788">]</span>&nbsp;<span class="op" id="5586790">=</span>&nbsp;<span class="builtintype" id="5586792">uint8</span><span class="op" id="5586797">(</span><span class="ident" id="5586798">c</span><span class="op" id="5586799">.</span><span class="ident" id="5586800">G</span><span class="op" id="5586801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586807">cr</span><span class="op" id="5586809">[</span><span class="num" id="5586810">0</span><span class="op" id="5586811">]</span><span class="op" id="5586812">[</span><span class="ident" id="5586813">i</span><span class="op" id="5586814">+</span><span class="num" id="5586815">4</span><span class="op" id="5586816">]</span>&nbsp;<span class="op" id="5586818">=</span>&nbsp;<span class="builtintype" id="5586820">uint8</span><span class="op" id="5586825">(</span><span class="ident" id="5586826">c</span><span class="op" id="5586827">.</span><span class="ident" id="5586828">B</span>&nbsp;<span class="op" id="5586830">&gt;&gt;</span>&nbsp;<span class="num" id="5586833">8</span><span class="op" id="5586834">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586840">cr</span><span class="op" id="5586842">[</span><span class="num" id="5586843">0</span><span class="op" id="5586844">]</span><span class="op" id="5586845">[</span><span class="ident" id="5586846">i</span><span class="op" id="5586847">+</span><span class="num" id="5586848">5</span><span class="op" id="5586849">]</span>&nbsp;<span class="op" id="5586851">=</span>&nbsp;<span class="builtintype" id="5586853">uint8</span><span class="op" id="5586858">(</span><span class="ident" id="5586859">c</span><span class="op" id="5586860">.</span><span class="ident" id="5586861">B</span><span class="op" id="5586862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586868">cr</span><span class="op" id="5586870">[</span><span class="num" id="5586871">0</span><span class="op" id="5586872">]</span><span class="op" id="5586873">[</span><span class="ident" id="5586874">i</span><span class="op" id="5586875">+</span><span class="num" id="5586876">6</span><span class="op" id="5586877">]</span>&nbsp;<span class="op" id="5586879">=</span>&nbsp;<span class="builtintype" id="5586881">uint8</span><span class="op" id="5586886">(</span><span class="ident" id="5586887">c</span><span class="op" id="5586888">.</span><span class="ident" id="5586889">A</span>&nbsp;<span class="op" id="5586891">&gt;&gt;</span>&nbsp;<span class="num" id="5586894">8</span><span class="op" id="5586895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586901">cr</span><span class="op" id="5586903">[</span><span class="num" id="5586904">0</span><span class="op" id="5586905">]</span><span class="op" id="5586906">[</span><span class="ident" id="5586907">i</span><span class="op" id="5586908">+</span><span class="num" id="5586909">7</span><span class="op" id="5586910">]</span>&nbsp;<span class="op" id="5586912">=</span>&nbsp;<span class="builtintype" id="5586914">uint8</span><span class="op" id="5586919">(</span><span class="ident" id="5586920">c</span><span class="op" id="5586921">.</span><span class="ident" id="5586922">A</span><span class="op" id="5586923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586929">i</span>&nbsp;<span class="op" id="5586931">+=</span>&nbsp;<span class="num" id="5586934">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5586939">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5586943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5586948">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586971">f</span>&nbsp;<span class="op" id="5586973">:=</span>&nbsp;<span class="ident" id="5586976">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586985">if</span>&nbsp;<span class="ident" id="5586988">level</span>&nbsp;<span class="op" id="5586994">!=</span>&nbsp;<span class="ident" id="5586997">zlib</span><span class="op" id="5587001">.</span><span class="ident" id="5587002">NoCompression</span>&nbsp;<span class="op" id="5587016">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587021">f</span>&nbsp;<span class="op" id="5587023">=</span>&nbsp;<span class="ident" id="5587025">filter</span><span class="op" id="5587031">(</span><span class="op" id="5587032">&amp;</span><span class="ident" id="5587033">cr</span><span class="op" id="5587035">,</span>&nbsp;<span class="ident" id="5587037">pr</span><span class="op" id="5587039">,</span>&nbsp;<span class="ident" id="5587041">bpp</span><span class="op" id="5587044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5587053">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587086">if</span>&nbsp;<span class="ident" id="5587089">_</span><span class="op" id="5587090">,</span>&nbsp;<span class="ident" id="5587092">err</span>&nbsp;<span class="op" id="5587096">:=</span>&nbsp;<span class="ident" id="5587099">zw</span><span class="op" id="5587101">.</span><span class="ident" id="5587102">Write</span><span class="op" id="5587107">(</span><span class="ident" id="5587108">cr</span><span class="op" id="5587110">[</span><span class="ident" id="5587111">f</span><span class="op" id="5587112">]</span><span class="op" id="5587113">)</span><span class="op" id="5587114">;</span>&nbsp;<span class="ident" id="5587116">err</span>&nbsp;<span class="op" id="5587120">!=</span>&nbsp;<span class="ident" id="5587123">nil</span>&nbsp;<span class="op" id="5587127">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587132">return</span>&nbsp;<span class="ident" id="5587139">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5587150">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587206">pr</span><span class="op" id="5587208">,</span>&nbsp;<span class="ident" id="5587210">cr</span><span class="op" id="5587212">[</span><span class="num" id="5587213">0</span><span class="op" id="5587214">]</span>&nbsp;<span class="op" id="5587216">=</span>&nbsp;<span class="ident" id="5587218">cr</span><span class="op" id="5587220">[</span><span class="num" id="5587221">0</span><span class="op" id="5587222">]</span><span class="op" id="5587223">,</span>&nbsp;<span class="ident" id="5587225">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587232">return</span>&nbsp;<span class="ident" id="5587239">nil</span><br>
<span class="lineno"></span><span class="op" id="5587243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5587246">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="5587305">func</span>&nbsp;<span class="op" id="5587310">(</span><span class="ident" id="5587311">e</span>&nbsp;<span class="op" id="5587313">*</span><span class="ident" id="5587314">encoder</span><span class="op" id="5587321">)</span>&nbsp;<span class="ident" id="5587323">writeIDATs</span><span class="op" id="5587333">(</span><span class="op" id="5587334">)</span>&nbsp;<span class="op" id="5587336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587339">if</span>&nbsp;<span class="ident" id="5587342">e</span><span class="op" id="5587343">.</span><span class="ident" id="5587344">err</span>&nbsp;<span class="op" id="5587348">!=</span>&nbsp;<span class="ident" id="5587351">nil</span>&nbsp;<span class="op" id="5587355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587359">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587370">var</span>&nbsp;<span class="ident" id="5587374">bw</span>&nbsp;<span class="op" id="5587377">*</span><span class="ident" id="5587378">bufio</span><span class="op" id="5587383">.</span><span class="ident" id="5587384">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587392">bw</span>&nbsp;<span class="op" id="5587395">=</span>&nbsp;<span class="ident" id="5587397">bufio</span><span class="op" id="5587402">.</span><span class="ident" id="5587403">NewWriterSize</span><span class="op" id="5587416">(</span><span class="ident" id="5587417">e</span><span class="op" id="5587418">,</span>&nbsp;<span class="num" id="5587420">1</span><span class="op" id="5587421">&lt;&lt;</span><span class="num" id="5587423">15</span><span class="op" id="5587425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587428">e</span><span class="op" id="5587429">.</span><span class="ident" id="5587430">err</span>&nbsp;<span class="op" id="5587434">=</span>&nbsp;<span class="ident" id="5587436">writeImage</span><span class="op" id="5587446">(</span><span class="ident" id="5587447">bw</span><span class="op" id="5587449">,</span>&nbsp;<span class="ident" id="5587451">e</span><span class="op" id="5587452">.</span><span class="ident" id="5587453">m</span><span class="op" id="5587454">,</span>&nbsp;<span class="ident" id="5587456">e</span><span class="op" id="5587457">.</span><span class="ident" id="5587458">cb</span><span class="op" id="5587460">,</span>&nbsp;<span class="ident" id="5587462">levelToZlib</span><span class="op" id="5587473">(</span><span class="ident" id="5587474">e</span><span class="op" id="5587475">.</span><span class="ident" id="5587476">enc</span><span class="op" id="5587479">.</span><span class="ident" id="5587480">CompressionLevel</span><span class="op" id="5587496">)</span><span class="op" id="5587497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587500">if</span>&nbsp;<span class="ident" id="5587503">e</span><span class="op" id="5587504">.</span><span class="ident" id="5587505">err</span>&nbsp;<span class="op" id="5587509">!=</span>&nbsp;<span class="ident" id="5587512">nil</span>&nbsp;<span class="op" id="5587516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587520">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587528">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587531">e</span><span class="op" id="5587532">.</span><span class="ident" id="5587533">err</span>&nbsp;<span class="op" id="5587537">=</span>&nbsp;<span class="ident" id="5587539">bw</span><span class="op" id="5587541">.</span><span class="ident" id="5587542">Flush</span><span class="op" id="5587547">(</span><span class="op" id="5587548">)</span><br>
<span class="lineno"></span><span class="op" id="5587550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5587553">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5587616">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="5587679">func</span>&nbsp;<span class="ident" id="5587684">levelToZlib</span><span class="op" id="5587695">(</span><span class="ident" id="5587696">l</span>&nbsp;<span class="ident" id="5587698">CompressionLevel</span><span class="op" id="5587714">)</span>&nbsp;<span class="builtintype" id="5587716">int</span>&nbsp;<span class="op" id="5587720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587723">switch</span>&nbsp;<span class="ident" id="5587730">l</span>&nbsp;<span class="op" id="5587732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587735">case</span>&nbsp;<span class="ident" id="5587740">DefaultCompression</span><span class="op" id="5587758">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587762">return</span>&nbsp;<span class="ident" id="5587769">zlib</span><span class="op" id="5587773">.</span><span class="ident" id="5587774">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587794">case</span>&nbsp;<span class="ident" id="5587799">NoCompression</span><span class="op" id="5587812">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587816">return</span>&nbsp;<span class="ident" id="5587823">zlib</span><span class="op" id="5587827">.</span><span class="ident" id="5587828">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587843">case</span>&nbsp;<span class="ident" id="5587848">BestSpeed</span><span class="op" id="5587857">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587861">return</span>&nbsp;<span class="ident" id="5587868">zlib</span><span class="op" id="5587872">.</span><span class="ident" id="5587873">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587884">case</span>&nbsp;<span class="ident" id="5587889">BestCompression</span><span class="op" id="5587904">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587908">return</span>&nbsp;<span class="ident" id="5587915">zlib</span><span class="op" id="5587919">.</span><span class="ident" id="5587920">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587937">default</span><span class="op" id="5587944">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587948">return</span>&nbsp;<span class="ident" id="5587955">zlib</span><span class="op" id="5587959">.</span><span class="ident" id="5587960">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587980">}</span><br>
<span class="lineno"></span><span class="op" id="5587982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="5587985">func</span>&nbsp;<span class="op" id="5587990">(</span><span class="ident" id="5587991">e</span>&nbsp;<span class="op" id="5587993">*</span><span class="ident" id="5587994">encoder</span><span class="op" id="5588001">)</span>&nbsp;<span class="ident" id="5588003">writeIEND</span><span class="op" id="5588012">(</span><span class="op" id="5588013">)</span>&nbsp;<span class="op" id="5588015">{</span>&nbsp;<span class="ident" id="5588017">e</span><span class="op" id="5588018">.</span><span class="ident" id="5588019">writeChunk</span><span class="op" id="5588029">(</span><span class="ident" id="5588030">nil</span><span class="op" id="5588033">,</span>&nbsp;<span class="string" id="5588035">&#34;IEND&#34;</span><span class="op" id="5588041">)</span>&nbsp;<span class="op" id="5588043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5588046">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5588112">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="5588186">func</span>&nbsp;<span class="ident" id="5588191">Encode</span><span class="op" id="5588197">(</span><span class="ident" id="5588198">w</span>&nbsp;<span class="ident" id="5588200">io</span><span class="op" id="5588202">.</span><span class="ident" id="5588203">Writer</span><span class="op" id="5588209">,</span>&nbsp;<span class="ident" id="5588211">m</span>&nbsp;<span class="ident" id="5588213">image</span><span class="op" id="5588218">.</span><span class="ident" id="5588219">Image</span><span class="op" id="5588224">)</span>&nbsp;<span class="builtintype" id="5588226">error</span>&nbsp;<span class="op" id="5588232">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588235">var</span>&nbsp;<span class="ident" id="5588239">e</span>&nbsp;<span class="ident" id="5588241">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588250">return</span>&nbsp;<span class="ident" id="5588257">e</span><span class="op" id="5588258">.</span><span class="ident" id="5588259">Encode</span><span class="op" id="5588265">(</span><span class="ident" id="5588266">w</span><span class="op" id="5588267">,</span>&nbsp;<span class="ident" id="5588269">m</span><span class="op" id="5588270">)</span><br>
<span class="lineno"></span><span class="op" id="5588272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5588275">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="5588324">func</span>&nbsp;<span class="op" id="5588329">(</span><span class="ident" id="5588330">enc</span>&nbsp;<span class="op" id="5588334">*</span><span class="ident" id="5588335">Encoder</span><span class="op" id="5588342">)</span>&nbsp;<span class="ident" id="5588344">Encode</span><span class="op" id="5588350">(</span><span class="ident" id="5588351">w</span>&nbsp;<span class="ident" id="5588353">io</span><span class="op" id="5588355">.</span><span class="ident" id="5588356">Writer</span><span class="op" id="5588362">,</span>&nbsp;<span class="ident" id="5588364">m</span>&nbsp;<span class="ident" id="5588366">image</span><span class="op" id="5588371">.</span><span class="ident" id="5588372">Image</span><span class="op" id="5588377">)</span>&nbsp;<span class="builtintype" id="5588379">error</span>&nbsp;<span class="op" id="5588385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5588388">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5588465">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5588545">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588564">mw</span><span class="op" id="5588566">,</span>&nbsp;<span class="ident" id="5588568">mh</span>&nbsp;<span class="op" id="5588571">:=</span>&nbsp;<span class="ident" id="5588574">int64</span><span class="op" id="5588579">(</span><span class="ident" id="5588580">m</span><span class="op" id="5588581">.</span><span class="ident" id="5588582">Bounds</span><span class="op" id="5588588">(</span><span class="op" id="5588589">)</span><span class="op" id="5588590">.</span><span class="ident" id="5588591">Dx</span><span class="op" id="5588593">(</span><span class="op" id="5588594">)</span><span class="op" id="5588595">)</span><span class="op" id="5588596">,</span>&nbsp;<span class="ident" id="5588598">int64</span><span class="op" id="5588603">(</span><span class="ident" id="5588604">m</span><span class="op" id="5588605">.</span><span class="ident" id="5588606">Bounds</span><span class="op" id="5588612">(</span><span class="op" id="5588613">)</span><span class="op" id="5588614">.</span><span class="ident" id="5588615">Dy</span><span class="op" id="5588617">(</span><span class="op" id="5588618">)</span><span class="op" id="5588619">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588622">if</span>&nbsp;<span class="ident" id="5588625">mw</span>&nbsp;<span class="op" id="5588628">&lt;=</span>&nbsp;<span class="num" id="5588631">0</span>&nbsp;<span class="op" id="5588633">||</span>&nbsp;<span class="ident" id="5588636">mh</span>&nbsp;<span class="op" id="5588639">&lt;=</span>&nbsp;<span class="num" id="5588642">0</span>&nbsp;<span class="op" id="5588644">||</span>&nbsp;<span class="ident" id="5588647">mw</span>&nbsp;<span class="op" id="5588650">&gt;=</span>&nbsp;<span class="num" id="5588653">1</span><span class="op" id="5588654">&lt;&lt;</span><span class="num" id="5588656">32</span>&nbsp;<span class="op" id="5588659">||</span>&nbsp;<span class="ident" id="5588662">mh</span>&nbsp;<span class="op" id="5588665">&gt;=</span>&nbsp;<span class="num" id="5588668">1</span><span class="op" id="5588669">&lt;&lt;</span><span class="num" id="5588671">32</span>&nbsp;<span class="op" id="5588674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588678">return</span>&nbsp;<span class="ident" id="5588685">FormatError</span><span class="op" id="5588696">(</span><span class="string" id="5588697">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="5588720">+</span>&nbsp;<span class="ident" id="5588722">strconv</span><span class="op" id="5588729">.</span><span class="ident" id="5588730">FormatInt</span><span class="op" id="5588739">(</span><span class="ident" id="5588740">mw</span><span class="op" id="5588742">,</span>&nbsp;<span class="num" id="5588744">10</span><span class="op" id="5588746">)</span>&nbsp;<span class="op" id="5588748">+</span>&nbsp;<span class="string" id="5588750">&#34;x&#34;</span>&nbsp;<span class="op" id="5588754">+</span>&nbsp;<span class="ident" id="5588756">strconv</span><span class="op" id="5588763">.</span><span class="ident" id="5588764">FormatInt</span><span class="op" id="5588773">(</span><span class="ident" id="5588774">mh</span><span class="op" id="5588776">,</span>&nbsp;<span class="num" id="5588778">10</span><span class="op" id="5588780">)</span><span class="op" id="5588781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5588784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588788">var</span>&nbsp;<span class="ident" id="5588792">e</span>&nbsp;<span class="ident" id="5588794">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588803">e</span><span class="op" id="5588804">.</span><span class="ident" id="5588805">enc</span>&nbsp;<span class="op" id="5588809">=</span>&nbsp;<span class="ident" id="5588811">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588816">e</span><span class="op" id="5588817">.</span><span class="ident" id="5588818">w</span>&nbsp;<span class="op" id="5588820">=</span>&nbsp;<span class="ident" id="5588822">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588825">e</span><span class="op" id="5588826">.</span><span class="ident" id="5588827">m</span>&nbsp;<span class="op" id="5588829">=</span>&nbsp;<span class="ident" id="5588831">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588835">var</span>&nbsp;<span class="ident" id="5588839">pal</span>&nbsp;<span class="ident" id="5588843">color</span><span class="op" id="5588848">.</span><span class="ident" id="5588849">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5588858">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588919">if</span>&nbsp;<span class="ident" id="5588922">_</span><span class="op" id="5588923">,</span>&nbsp;<span class="ident" id="5588925">ok</span>&nbsp;<span class="op" id="5588928">:=</span>&nbsp;<span class="ident" id="5588931">m</span><span class="op" id="5588932">.</span><span class="op" id="5588933">(</span><span class="ident" id="5588934">image</span><span class="op" id="5588939">.</span><span class="ident" id="5588940">PalettedImage</span><span class="op" id="5588953">)</span><span class="op" id="5588954">;</span>&nbsp;<span class="ident" id="5588956">ok</span>&nbsp;<span class="op" id="5588959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588963">pal</span><span class="op" id="5588966">,</span>&nbsp;<span class="ident" id="5588968">_</span>&nbsp;<span class="op" id="5588970">=</span>&nbsp;<span class="ident" id="5588972">m</span><span class="op" id="5588973">.</span><span class="ident" id="5588974">ColorModel</span><span class="op" id="5588984">(</span><span class="op" id="5588985">)</span><span class="op" id="5588986">.</span><span class="op" id="5588987">(</span><span class="ident" id="5588988">color</span><span class="op" id="5588993">.</span><span class="ident" id="5588994">Palette</span><span class="op" id="5589001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589007">if</span>&nbsp;<span class="ident" id="5589010">pal</span>&nbsp;<span class="op" id="5589014">!=</span>&nbsp;<span class="ident" id="5589017">nil</span>&nbsp;<span class="op" id="5589021">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589025">e</span><span class="op" id="5589026">.</span><span class="ident" id="5589027">cb</span>&nbsp;<span class="op" id="5589030">=</span>&nbsp;<span class="ident" id="5589032">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589038">}</span>&nbsp;<span class="keyword" id="5589040">else</span>&nbsp;<span class="op" id="5589045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589049">switch</span>&nbsp;<span class="ident" id="5589056">m</span><span class="op" id="5589057">.</span><span class="ident" id="5589058">ColorModel</span><span class="op" id="5589068">(</span><span class="op" id="5589069">)</span>&nbsp;<span class="op" id="5589071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589075">case</span>&nbsp;<span class="ident" id="5589080">color</span><span class="op" id="5589085">.</span><span class="ident" id="5589086">GrayModel</span><span class="op" id="5589095">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589100">e</span><span class="op" id="5589101">.</span><span class="ident" id="5589102">cb</span>&nbsp;<span class="op" id="5589105">=</span>&nbsp;<span class="ident" id="5589107">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589114">case</span>&nbsp;<span class="ident" id="5589119">color</span><span class="op" id="5589124">.</span><span class="ident" id="5589125">Gray16Model</span><span class="op" id="5589136">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589141">e</span><span class="op" id="5589142">.</span><span class="ident" id="5589143">cb</span>&nbsp;<span class="op" id="5589146">=</span>&nbsp;<span class="ident" id="5589148">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589156">case</span>&nbsp;<span class="ident" id="5589161">color</span><span class="op" id="5589166">.</span><span class="ident" id="5589167">RGBAModel</span><span class="op" id="5589176">,</span>&nbsp;<span class="ident" id="5589178">color</span><span class="op" id="5589183">.</span><span class="ident" id="5589184">NRGBAModel</span><span class="op" id="5589194">,</span>&nbsp;<span class="ident" id="5589196">color</span><span class="op" id="5589201">.</span><span class="ident" id="5589202">AlphaModel</span><span class="op" id="5589212">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589217">if</span>&nbsp;<span class="ident" id="5589220">opaque</span><span class="op" id="5589226">(</span><span class="ident" id="5589227">m</span><span class="op" id="5589228">)</span>&nbsp;<span class="op" id="5589230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589236">e</span><span class="op" id="5589237">.</span><span class="ident" id="5589238">cb</span>&nbsp;<span class="op" id="5589241">=</span>&nbsp;<span class="ident" id="5589243">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589252">}</span>&nbsp;<span class="keyword" id="5589254">else</span>&nbsp;<span class="op" id="5589259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589265">e</span><span class="op" id="5589266">.</span><span class="ident" id="5589267">cb</span>&nbsp;<span class="op" id="5589270">=</span>&nbsp;<span class="ident" id="5589272">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589286">default</span><span class="op" id="5589293">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589298">if</span>&nbsp;<span class="ident" id="5589301">opaque</span><span class="op" id="5589307">(</span><span class="ident" id="5589308">m</span><span class="op" id="5589309">)</span>&nbsp;<span class="op" id="5589311">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589317">e</span><span class="op" id="5589318">.</span><span class="ident" id="5589319">cb</span>&nbsp;<span class="op" id="5589322">=</span>&nbsp;<span class="ident" id="5589324">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589334">}</span>&nbsp;<span class="keyword" id="5589336">else</span>&nbsp;<span class="op" id="5589341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589347">e</span><span class="op" id="5589348">.</span><span class="ident" id="5589349">cb</span>&nbsp;<span class="op" id="5589352">=</span>&nbsp;<span class="ident" id="5589354">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589369">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589376">_</span><span class="op" id="5589377">,</span>&nbsp;<span class="ident" id="5589379">e</span><span class="op" id="5589380">.</span><span class="ident" id="5589381">err</span>&nbsp;<span class="op" id="5589385">=</span>&nbsp;<span class="ident" id="5589387">io</span><span class="op" id="5589389">.</span><span class="ident" id="5589390">WriteString</span><span class="op" id="5589401">(</span><span class="ident" id="5589402">w</span><span class="op" id="5589403">,</span>&nbsp;<span class="ident" id="5589405">pngHeader</span><span class="op" id="5589414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589417">e</span><span class="op" id="5589418">.</span><span class="ident" id="5589419">writeIHDR</span><span class="op" id="5589428">(</span><span class="op" id="5589429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589432">if</span>&nbsp;<span class="ident" id="5589435">pal</span>&nbsp;<span class="op" id="5589439">!=</span>&nbsp;<span class="ident" id="5589442">nil</span>&nbsp;<span class="op" id="5589446">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589450">e</span><span class="op" id="5589451">.</span><span class="ident" id="5589452">writePLTEAndTRNS</span><span class="op" id="5589468">(</span><span class="ident" id="5589469">pal</span><span class="op" id="5589472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589478">e</span><span class="op" id="5589479">.</span><span class="ident" id="5589480">writeIDATs</span><span class="op" id="5589490">(</span><span class="op" id="5589491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589494">e</span><span class="op" id="5589495">.</span><span class="ident" id="5589496">writeIEND</span><span class="op" id="5589505">(</span><span class="op" id="5589506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589509">return</span>&nbsp;<span class="ident" id="5589516">e</span><span class="op" id="5589517">.</span><span class="ident" id="5589518">err</span><br>
<span class="lineno">530</span><span class="op" id="5589522">}</span>
</div>
</body>
</html>
