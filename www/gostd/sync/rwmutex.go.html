<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html" class="current">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1402297">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1402352">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1402406">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1402457">package</span>&nbsp;<span class="ident" id="1402465">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1402471">import</span>&nbsp;<span class="op" id="1402478">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1402481">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1402496">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1402505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1402508">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1402564">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1402622">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1402645">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1402690">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1402737">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1402759">type</span>&nbsp;<span class="ident" id="1402764">RWMutex</span>&nbsp;<span class="keyword" id="1402772">struct</span>&nbsp;<span class="op" id="1402779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402782">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402794">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1402801">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402839">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1402851">uint32</span>&nbsp;<span class="comment" id="1402858">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402915">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1402927">uint32</span>&nbsp;<span class="comment" id="1402934">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402991">readerCount</span>&nbsp;<span class="builtintype" id="1403003">int32</span>&nbsp;&nbsp;<span class="comment" id="1403010">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403040">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1403052">int32</span>&nbsp;&nbsp;<span class="comment" id="1403059">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1403090">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1403093">const</span>&nbsp;<span class="ident" id="1403099">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1403117">=</span>&nbsp;<span class="num" id="1403119">1</span>&nbsp;<span class="op" id="1403121">&lt;&lt;</span>&nbsp;<span class="num" id="1403124">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403128">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1403159">func</span>&nbsp;<span class="op" id="1403164">(</span><span class="ident" id="1403165">rw</span>&nbsp;<span class="op" id="1403168">*</span><span class="ident" id="1403169">RWMutex</span><span class="op" id="1403176">)</span>&nbsp;<span class="ident" id="1403178">RLock</span><span class="op" id="1403183">(</span><span class="op" id="1403184">)</span>&nbsp;<span class="op" id="1403186">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403189">if</span>&nbsp;<span class="ident" id="1403192">raceenabled</span>&nbsp;<span class="op" id="1403204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403208">_</span>&nbsp;<span class="op" id="1403210">=</span>&nbsp;<span class="ident" id="1403212">rw</span><span class="op" id="1403214">.</span><span class="ident" id="1403215">w</span><span class="op" id="1403216">.</span><span class="ident" id="1403217">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403225">raceDisable</span><span class="op" id="1403236">(</span><span class="op" id="1403237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403243">if</span>&nbsp;<span class="ident" id="1403246">atomic</span><span class="op" id="1403252">.</span><span class="ident" id="1403253">AddInt32</span><span class="op" id="1403261">(</span><span class="op" id="1403262">&amp;</span><span class="ident" id="1403263">rw</span><span class="op" id="1403265">.</span><span class="ident" id="1403266">readerCount</span><span class="op" id="1403277">,</span>&nbsp;<span class="num" id="1403279">1</span><span class="op" id="1403280">)</span>&nbsp;<span class="op" id="1403282">&lt;</span>&nbsp;<span class="num" id="1403284">0</span>&nbsp;<span class="op" id="1403286">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1403290">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403329">runtime_Semacquire</span><span class="op" id="1403347">(</span><span class="op" id="1403348">&amp;</span><span class="ident" id="1403349">rw</span><span class="op" id="1403351">.</span><span class="ident" id="1403352">readerSem</span><span class="op" id="1403361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403367">if</span>&nbsp;<span class="ident" id="1403370">raceenabled</span>&nbsp;<span class="op" id="1403382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403386">raceEnable</span><span class="op" id="1403396">(</span><span class="op" id="1403397">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403401">raceAcquire</span><span class="op" id="1403412">(</span><span class="ident" id="1403413">unsafe</span><span class="op" id="1403419">.</span><span class="ident" id="1403420">Pointer</span><span class="op" id="1403427">(</span><span class="op" id="1403428">&amp;</span><span class="ident" id="1403429">rw</span><span class="op" id="1403431">.</span><span class="ident" id="1403432">readerSem</span><span class="op" id="1403441">)</span><span class="op" id="1403442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403445">}</span><br>
<span class="lineno"></span><span class="op" id="1403447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403450">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1403489">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1403539">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1403597">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1403621">func</span>&nbsp;<span class="op" id="1403626">(</span><span class="ident" id="1403627">rw</span>&nbsp;<span class="op" id="1403630">*</span><span class="ident" id="1403631">RWMutex</span><span class="op" id="1403638">)</span>&nbsp;<span class="ident" id="1403640">RUnlock</span><span class="op" id="1403647">(</span><span class="op" id="1403648">)</span>&nbsp;<span class="op" id="1403650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403653">if</span>&nbsp;<span class="ident" id="1403656">raceenabled</span>&nbsp;<span class="op" id="1403668">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403672">_</span>&nbsp;<span class="op" id="1403674">=</span>&nbsp;<span class="ident" id="1403676">rw</span><span class="op" id="1403678">.</span><span class="ident" id="1403679">w</span><span class="op" id="1403680">.</span><span class="ident" id="1403681">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403689">raceReleaseMerge</span><span class="op" id="1403705">(</span><span class="ident" id="1403706">unsafe</span><span class="op" id="1403712">.</span><span class="ident" id="1403713">Pointer</span><span class="op" id="1403720">(</span><span class="op" id="1403721">&amp;</span><span class="ident" id="1403722">rw</span><span class="op" id="1403724">.</span><span class="ident" id="1403725">writerSem</span><span class="op" id="1403734">)</span><span class="op" id="1403735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403739">raceDisable</span><span class="op" id="1403750">(</span><span class="op" id="1403751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403757">if</span>&nbsp;<span class="ident" id="1403760">r</span>&nbsp;<span class="op" id="1403762">:=</span>&nbsp;<span class="ident" id="1403765">atomic</span><span class="op" id="1403771">.</span><span class="ident" id="1403772">AddInt32</span><span class="op" id="1403780">(</span><span class="op" id="1403781">&amp;</span><span class="ident" id="1403782">rw</span><span class="op" id="1403784">.</span><span class="ident" id="1403785">readerCount</span><span class="op" id="1403796">,</span>&nbsp;<span class="op" id="1403798">-</span><span class="num" id="1403799">1</span><span class="op" id="1403800">)</span><span class="op" id="1403801">;</span>&nbsp;<span class="ident" id="1403803">r</span>&nbsp;<span class="op" id="1403805">&lt;</span>&nbsp;<span class="num" id="1403807">0</span>&nbsp;<span class="op" id="1403809">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403813">if</span>&nbsp;<span class="ident" id="1403816">r</span><span class="op" id="1403817">+</span><span class="num" id="1403818">1</span>&nbsp;<span class="op" id="1403820">==</span>&nbsp;<span class="num" id="1403823">0</span>&nbsp;<span class="op" id="1403825">||</span>&nbsp;<span class="ident" id="1403828">r</span><span class="op" id="1403829">+</span><span class="num" id="1403830">1</span>&nbsp;<span class="op" id="1403832">==</span>&nbsp;<span class="op" id="1403835">-</span><span class="ident" id="1403836">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1403854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403859">raceEnable</span><span class="op" id="1403869">(</span><span class="op" id="1403870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1403875">panic</span><span class="op" id="1403880">(</span><span class="string" id="1403881">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1403916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1403924">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403950">if</span>&nbsp;<span class="ident" id="1403953">atomic</span><span class="op" id="1403959">.</span><span class="ident" id="1403960">AddInt32</span><span class="op" id="1403968">(</span><span class="op" id="1403969">&amp;</span><span class="ident" id="1403970">rw</span><span class="op" id="1403972">.</span><span class="ident" id="1403973">readerWait</span><span class="op" id="1403983">,</span>&nbsp;<span class="op" id="1403985">-</span><span class="num" id="1403986">1</span><span class="op" id="1403987">)</span>&nbsp;<span class="op" id="1403989">==</span>&nbsp;<span class="num" id="1403992">0</span>&nbsp;<span class="op" id="1403994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1403999">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404042">runtime_Semrelease</span><span class="op" id="1404060">(</span><span class="op" id="1404061">&amp;</span><span class="ident" id="1404062">rw</span><span class="op" id="1404064">.</span><span class="ident" id="1404065">writerSem</span><span class="op" id="1404074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404081">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404084">if</span>&nbsp;<span class="ident" id="1404087">raceenabled</span>&nbsp;<span class="op" id="1404099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404103">raceEnable</span><span class="op" id="1404113">(</span><span class="op" id="1404114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404117">}</span><br>
<span class="lineno"></span><span class="op" id="1404119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1404122">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1404152">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1404209">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1404253">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1404310">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1404369">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1404382">func</span>&nbsp;<span class="op" id="1404387">(</span><span class="ident" id="1404388">rw</span>&nbsp;<span class="op" id="1404391">*</span><span class="ident" id="1404392">RWMutex</span><span class="op" id="1404399">)</span>&nbsp;<span class="ident" id="1404401">Lock</span><span class="op" id="1404405">(</span><span class="op" id="1404406">)</span>&nbsp;<span class="op" id="1404408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404411">if</span>&nbsp;<span class="ident" id="1404414">raceenabled</span>&nbsp;<span class="op" id="1404426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404430">_</span>&nbsp;<span class="op" id="1404432">=</span>&nbsp;<span class="ident" id="1404434">rw</span><span class="op" id="1404436">.</span><span class="ident" id="1404437">w</span><span class="op" id="1404438">.</span><span class="ident" id="1404439">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404447">raceDisable</span><span class="op" id="1404458">(</span><span class="op" id="1404459">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404465">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404516">rw</span><span class="op" id="1404518">.</span><span class="ident" id="1404519">w</span><span class="op" id="1404520">.</span><span class="ident" id="1404521">Lock</span><span class="op" id="1404525">(</span><span class="op" id="1404526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404529">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404580">r</span>&nbsp;<span class="op" id="1404582">:=</span>&nbsp;<span class="ident" id="1404585">atomic</span><span class="op" id="1404591">.</span><span class="ident" id="1404592">AddInt32</span><span class="op" id="1404600">(</span><span class="op" id="1404601">&amp;</span><span class="ident" id="1404602">rw</span><span class="op" id="1404604">.</span><span class="ident" id="1404605">readerCount</span><span class="op" id="1404616">,</span>&nbsp;<span class="op" id="1404618">-</span><span class="ident" id="1404619">rwmutexMaxReaders</span><span class="op" id="1404636">)</span>&nbsp;<span class="op" id="1404638">+</span>&nbsp;<span class="ident" id="1404640">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404659">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404688">if</span>&nbsp;<span class="ident" id="1404691">r</span>&nbsp;<span class="op" id="1404693">!=</span>&nbsp;<span class="num" id="1404696">0</span>&nbsp;<span class="op" id="1404698">&amp;&amp;</span>&nbsp;<span class="ident" id="1404701">atomic</span><span class="op" id="1404707">.</span><span class="ident" id="1404708">AddInt32</span><span class="op" id="1404716">(</span><span class="op" id="1404717">&amp;</span><span class="ident" id="1404718">rw</span><span class="op" id="1404720">.</span><span class="ident" id="1404721">readerWait</span><span class="op" id="1404731">,</span>&nbsp;<span class="ident" id="1404733">r</span><span class="op" id="1404734">)</span>&nbsp;<span class="op" id="1404736">!=</span>&nbsp;<span class="num" id="1404739">0</span>&nbsp;<span class="op" id="1404741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404745">runtime_Semacquire</span><span class="op" id="1404763">(</span><span class="op" id="1404764">&amp;</span><span class="ident" id="1404765">rw</span><span class="op" id="1404767">.</span><span class="ident" id="1404768">writerSem</span><span class="op" id="1404777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404783">if</span>&nbsp;<span class="ident" id="1404786">raceenabled</span>&nbsp;<span class="op" id="1404798">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404802">raceEnable</span><span class="op" id="1404812">(</span><span class="op" id="1404813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404817">raceAcquire</span><span class="op" id="1404828">(</span><span class="ident" id="1404829">unsafe</span><span class="op" id="1404835">.</span><span class="ident" id="1404836">Pointer</span><span class="op" id="1404843">(</span><span class="op" id="1404844">&amp;</span><span class="ident" id="1404845">rw</span><span class="op" id="1404847">.</span><span class="ident" id="1404848">readerSem</span><span class="op" id="1404857">)</span><span class="op" id="1404858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404862">raceAcquire</span><span class="op" id="1404873">(</span><span class="ident" id="1404874">unsafe</span><span class="op" id="1404880">.</span><span class="ident" id="1404881">Pointer</span><span class="op" id="1404888">(</span><span class="op" id="1404889">&amp;</span><span class="ident" id="1404890">rw</span><span class="op" id="1404892">.</span><span class="ident" id="1404893">writerSem</span><span class="op" id="1404902">)</span><span class="op" id="1404903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404906">}</span><br>
<span class="lineno"></span><span class="op" id="1404908">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1404911">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1404978">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1405024">//</span><br>
<span class="lineno"></span><span class="comment" id="1405027">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1405100">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1405166">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1405223">func</span>&nbsp;<span class="op" id="1405228">(</span><span class="ident" id="1405229">rw</span>&nbsp;<span class="op" id="1405232">*</span><span class="ident" id="1405233">RWMutex</span><span class="op" id="1405240">)</span>&nbsp;<span class="ident" id="1405242">Unlock</span><span class="op" id="1405248">(</span><span class="op" id="1405249">)</span>&nbsp;<span class="op" id="1405251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405254">if</span>&nbsp;<span class="ident" id="1405257">raceenabled</span>&nbsp;<span class="op" id="1405269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405273">_</span>&nbsp;<span class="op" id="1405275">=</span>&nbsp;<span class="ident" id="1405277">rw</span><span class="op" id="1405279">.</span><span class="ident" id="1405280">w</span><span class="op" id="1405281">.</span><span class="ident" id="1405282">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405290">raceRelease</span><span class="op" id="1405301">(</span><span class="ident" id="1405302">unsafe</span><span class="op" id="1405308">.</span><span class="ident" id="1405309">Pointer</span><span class="op" id="1405316">(</span><span class="op" id="1405317">&amp;</span><span class="ident" id="1405318">rw</span><span class="op" id="1405320">.</span><span class="ident" id="1405321">readerSem</span><span class="op" id="1405330">)</span><span class="op" id="1405331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405335">raceRelease</span><span class="op" id="1405346">(</span><span class="ident" id="1405347">unsafe</span><span class="op" id="1405353">.</span><span class="ident" id="1405354">Pointer</span><span class="op" id="1405361">(</span><span class="op" id="1405362">&amp;</span><span class="ident" id="1405363">rw</span><span class="op" id="1405365">.</span><span class="ident" id="1405366">writerSem</span><span class="op" id="1405375">)</span><span class="op" id="1405376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405380">raceDisable</span><span class="op" id="1405391">(</span><span class="op" id="1405392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405399">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405450">r</span>&nbsp;<span class="op" id="1405452">:=</span>&nbsp;<span class="ident" id="1405455">atomic</span><span class="op" id="1405461">.</span><span class="ident" id="1405462">AddInt32</span><span class="op" id="1405470">(</span><span class="op" id="1405471">&amp;</span><span class="ident" id="1405472">rw</span><span class="op" id="1405474">.</span><span class="ident" id="1405475">readerCount</span><span class="op" id="1405486">,</span>&nbsp;<span class="ident" id="1405488">rwmutexMaxReaders</span><span class="op" id="1405505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405508">if</span>&nbsp;<span class="ident" id="1405511">r</span>&nbsp;<span class="op" id="1405513">&gt;=</span>&nbsp;<span class="ident" id="1405516">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1405534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405538">raceEnable</span><span class="op" id="1405548">(</span><span class="op" id="1405549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1405553">panic</span><span class="op" id="1405558">(</span><span class="string" id="1405559">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1405593">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405599">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405636">for</span>&nbsp;<span class="ident" id="1405640">i</span>&nbsp;<span class="op" id="1405642">:=</span>&nbsp;<span class="num" id="1405645">0</span><span class="op" id="1405646">;</span>&nbsp;<span class="ident" id="1405648">i</span>&nbsp;<span class="op" id="1405650">&lt;</span>&nbsp;<span class="builtintype" id="1405652">int</span><span class="op" id="1405655">(</span><span class="ident" id="1405656">r</span><span class="op" id="1405657">)</span><span class="op" id="1405658">;</span>&nbsp;<span class="ident" id="1405660">i</span><span class="op" id="1405661">++</span>&nbsp;<span class="op" id="1405664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405668">runtime_Semrelease</span><span class="op" id="1405686">(</span><span class="op" id="1405687">&amp;</span><span class="ident" id="1405688">rw</span><span class="op" id="1405690">.</span><span class="ident" id="1405691">readerSem</span><span class="op" id="1405700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405703">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405706">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405742">rw</span><span class="op" id="1405744">.</span><span class="ident" id="1405745">w</span><span class="op" id="1405746">.</span><span class="ident" id="1405747">Unlock</span><span class="op" id="1405753">(</span><span class="op" id="1405754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405757">if</span>&nbsp;<span class="ident" id="1405760">raceenabled</span>&nbsp;<span class="op" id="1405772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405776">raceEnable</span><span class="op" id="1405786">(</span><span class="op" id="1405787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405790">}</span><br>
<span class="lineno">125</span><span class="op" id="1405792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1405795">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1405849">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1405916">func</span>&nbsp;<span class="op" id="1405921">(</span><span class="ident" id="1405922">rw</span>&nbsp;<span class="op" id="1405925">*</span><span class="ident" id="1405926">RWMutex</span><span class="op" id="1405933">)</span>&nbsp;<span class="ident" id="1405935">RLocker</span><span class="op" id="1405942">(</span><span class="op" id="1405943">)</span>&nbsp;<span class="ident" id="1405945">Locker</span>&nbsp;<span class="op" id="1405952">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405955">return</span>&nbsp;<span class="op" id="1405962">(</span><span class="op" id="1405963">*</span><span class="ident" id="1405964">rlocker</span><span class="op" id="1405971">)</span><span class="op" id="1405972">(</span><span class="ident" id="1405973">rw</span><span class="op" id="1405975">)</span><br>
<span class="lineno"></span><span class="op" id="1405977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1405980">type</span>&nbsp;<span class="ident" id="1405985">rlocker</span>&nbsp;<span class="ident" id="1405993">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1406002">func</span>&nbsp;<span class="op" id="1406007">(</span><span class="ident" id="1406008">r</span>&nbsp;<span class="op" id="1406010">*</span><span class="ident" id="1406011">rlocker</span><span class="op" id="1406018">)</span>&nbsp;<span class="ident" id="1406020">Lock</span><span class="op" id="1406024">(</span><span class="op" id="1406025">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1406029">{</span>&nbsp;<span class="op" id="1406031">(</span><span class="op" id="1406032">*</span><span class="ident" id="1406033">RWMutex</span><span class="op" id="1406040">)</span><span class="op" id="1406041">(</span><span class="ident" id="1406042">r</span><span class="op" id="1406043">)</span><span class="op" id="1406044">.</span><span class="ident" id="1406045">RLock</span><span class="op" id="1406050">(</span><span class="op" id="1406051">)</span>&nbsp;<span class="op" id="1406053">}</span><br>
<span class="lineno"></span><span class="keyword" id="1406055">func</span>&nbsp;<span class="op" id="1406060">(</span><span class="ident" id="1406061">r</span>&nbsp;<span class="op" id="1406063">*</span><span class="ident" id="1406064">rlocker</span><span class="op" id="1406071">)</span>&nbsp;<span class="ident" id="1406073">Unlock</span><span class="op" id="1406079">(</span><span class="op" id="1406080">)</span>&nbsp;<span class="op" id="1406082">{</span>&nbsp;<span class="op" id="1406084">(</span><span class="op" id="1406085">*</span><span class="ident" id="1406086">RWMutex</span><span class="op" id="1406093">)</span><span class="op" id="1406094">(</span><span class="ident" id="1406095">r</span><span class="op" id="1406096">)</span><span class="op" id="1406097">.</span><span class="ident" id="1406098">RUnlock</span><span class="op" id="1406105">(</span><span class="op" id="1406106">)</span>&nbsp;<span class="op" id="1406108">}</span>
</div>
</body>
</html>
