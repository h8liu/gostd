<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3786325">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3786381">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3786435">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3786486">package</span>&nbsp;<span class="ident" id="3786494">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3786500">import</span>&nbsp;<span class="op" id="3786507">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3786510">&#34;internal/syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3786530">&#34;sync&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3786537">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3786540">func</span>&nbsp;<span class="ident" id="3786545">init</span><span class="op" id="3786549">(</span><span class="op" id="3786550">)</span>&nbsp;<span class="op" id="3786552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786555">altGetRandom</span>&nbsp;<span class="op" id="3786568">=</span>&nbsp;<span class="ident" id="3786570">getRandomLinux</span><br>
<span class="lineno"></span><span class="op" id="3786585">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3786588">var</span>&nbsp;<span class="op" id="3786592">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786595">once</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3786606">sync</span><span class="op" id="3786610">.</span><span class="ident" id="3786611">Once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786617">useSyscall</span>&nbsp;<span class="builtintype" id="3786628">bool</span><br>
<span class="lineno"></span><span class="op" id="3786633">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3786636">func</span>&nbsp;<span class="ident" id="3786641">pickStrategy</span><span class="op" id="3786653">(</span><span class="op" id="3786654">)</span>&nbsp;<span class="op" id="3786656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3786659">//&nbsp;Test&nbsp;whether&nbsp;we&nbsp;should&nbsp;use&nbsp;the&nbsp;system&nbsp;call&nbsp;or&nbsp;/dev/urandom.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3786723">//&nbsp;We&#39;ll&nbsp;fall&nbsp;back&nbsp;to&nbsp;urandom&nbsp;if:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3786758">//&nbsp;-&nbsp;the&nbsp;kernel&nbsp;is&nbsp;too&nbsp;old&nbsp;(before&nbsp;3.17)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3786800">//&nbsp;-&nbsp;the&nbsp;machine&nbsp;has&nbsp;no&nbsp;entropy&nbsp;available&nbsp;(early&nbsp;boot&nbsp;+&nbsp;no&nbsp;hardware</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3786869">//&nbsp;&nbsp;&nbsp;entropy&nbsp;source?)&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;avoid&nbsp;blocking&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786929">var</span>&nbsp;<span class="ident" id="3786933">buf</span>&nbsp;<span class="op" id="3786937">[</span><span class="num" id="3786938">1</span><span class="op" id="3786939">]</span><span class="builtintype" id="3786940">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786946">n</span><span class="op" id="3786947">,</span>&nbsp;<span class="ident" id="3786949">err</span>&nbsp;<span class="op" id="3786953">:=</span>&nbsp;<span class="ident" id="3786956">syscall</span><span class="op" id="3786963">.</span><span class="ident" id="3786964">GetRandom</span><span class="op" id="3786973">(</span><span class="ident" id="3786974">buf</span><span class="op" id="3786977">[</span><span class="op" id="3786978">:</span><span class="op" id="3786979">]</span><span class="op" id="3786980">,</span>&nbsp;<span class="ident" id="3786982">syscall</span><span class="op" id="3786989">.</span><span class="ident" id="3786990">GRND_NONBLOCK</span><span class="op" id="3787003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787006">useSyscall</span>&nbsp;<span class="op" id="3787017">=</span>&nbsp;<span class="ident" id="3787019">n</span>&nbsp;<span class="op" id="3787021">==</span>&nbsp;<span class="num" id="3787024">1</span>&nbsp;<span class="op" id="3787026">&amp;&amp;</span>&nbsp;<span class="ident" id="3787029">err</span>&nbsp;<span class="op" id="3787033">==</span>&nbsp;<span class="ident" id="3787036">nil</span><br>
<span class="lineno">30</span><span class="op" id="3787040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3787043">func</span>&nbsp;<span class="ident" id="3787048">getRandomLinux</span><span class="op" id="3787062">(</span><span class="ident" id="3787063">p</span>&nbsp;<span class="op" id="3787065">[</span><span class="op" id="3787066">]</span><span class="builtintype" id="3787067">byte</span><span class="op" id="3787071">)</span>&nbsp;<span class="op" id="3787073">(</span><span class="ident" id="3787074">ok</span>&nbsp;<span class="builtintype" id="3787077">bool</span><span class="op" id="3787081">)</span>&nbsp;<span class="op" id="3787083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787086">once</span><span class="op" id="3787090">.</span><span class="ident" id="3787091">Do</span><span class="op" id="3787093">(</span><span class="ident" id="3787094">pickStrategy</span><span class="op" id="3787106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3787109">if</span>&nbsp;<span class="op" id="3787112">!</span><span class="ident" id="3787113">useSyscall</span>&nbsp;<span class="op" id="3787124">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3787128">return</span>&nbsp;<span class="ident" id="3787135">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3787142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787145">n</span><span class="op" id="3787146">,</span>&nbsp;<span class="ident" id="3787148">err</span>&nbsp;<span class="op" id="3787152">:=</span>&nbsp;<span class="ident" id="3787155">syscall</span><span class="op" id="3787162">.</span><span class="ident" id="3787163">GetRandom</span><span class="op" id="3787172">(</span><span class="ident" id="3787173">p</span><span class="op" id="3787174">,</span>&nbsp;<span class="num" id="3787176">0</span><span class="op" id="3787177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3787180">return</span>&nbsp;<span class="ident" id="3787187">n</span>&nbsp;<span class="op" id="3787189">==</span>&nbsp;<span class="builtinfunc" id="3787192">len</span><span class="op" id="3787195">(</span><span class="ident" id="3787196">p</span><span class="op" id="3787197">)</span>&nbsp;<span class="op" id="3787199">&amp;&amp;</span>&nbsp;<span class="ident" id="3787202">err</span>&nbsp;<span class="op" id="3787206">==</span>&nbsp;<span class="ident" id="3787209">nil</span><br>
<span class="lineno"></span><span class="op" id="3787213">}</span>
</div>
</body>
</html>
